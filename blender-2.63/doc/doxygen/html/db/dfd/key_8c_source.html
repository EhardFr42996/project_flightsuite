<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: key.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">key.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/dfd/key_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d86/BLI__math__vector_8h.html">BLI_math_vector.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d5e/BKE__customdata_8h.html" title="CustomData interface, see also DNA_customdata_types.h.">BKE_customdata.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8f/BKE__lattice_8h.html">BKE_lattice.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">00068</a> <span class="preprocessor">#define KEY_MODE_DUMMY      0 </span><span class="comment">/* use where mode isn&#39;t checked for */</span>
<a name="l00069"></a><a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">00069</a> <span class="preprocessor">#define KEY_MODE_BPOINT     1</span>
<a name="l00070"></a><a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_MODE_BEZTRIPLE  2</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a>00072 <span class="comment">/* old defines from DNA_ipo_types.h for data-type, stored in DNA - don&#39;t modify! */</span>
<a name="l00073"></a><a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">00073</a> <span class="preprocessor">#define IPO_FLOAT       4</span>
<a name="l00074"></a><a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define IPO_BEZTRIPLE   100</span>
<a name="l00075"></a><a class="code" href="../../db/dfd/key_8c.html#aff7a69eecef466496dacdc7a8b656799">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define IPO_BPOINT      101</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="comment">/* extern, not threadsafe */</span>
<a name="l00078"></a><a class="code" href="../../db/dfd/key_8c.html#a0215bf9aa271a28383bf20f1b135e1f6">00078</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a> = 1;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="../../db/dfd/key_8c.html#a7fb995dfe6cd94107fe0c744a6b707ce">00081</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a0fbd53478c90d90e72e93775bd6dde4b">free_key</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00084"></a>00084     
<a name="l00085"></a>00085     <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a186ce67df8bf9873cc945eed480eaa49">BKE_free_animdata</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)key);
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     <span class="keywordflow">while</span> ( (kb = key-&gt;block.first) ) {
<a name="l00088"></a>00088         
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;key-&gt;block, kb);
<a name="l00092"></a>00092         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb);
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../db/dfd/key_8c.html#a558a1ca6552ad3cbf1b833153bfe11c0">00097</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a7b5fded3f8331caad47110847d5d0fde">free_key_nolib</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00100"></a>00100     
<a name="l00101"></a>00101     <span class="keywordflow">while</span> ( (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) ) {
<a name="l00102"></a>00102         
<a name="l00103"></a>00103         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00104"></a>00104         
<a name="l00105"></a>00105         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb);
<a name="l00106"></a>00106         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb);
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108     
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/* GS reads the memory pointed at in a specific ordering. There are,</span>
<a name="l00112"></a>00112 <span class="comment"> * however two definitions for it. I have jotted them down here, both,</span>
<a name="l00113"></a>00113 <span class="comment"> * but I think the first one is actually used. The thing is that</span>
<a name="l00114"></a>00114 <span class="comment"> * big-endian systems might read this the wrong way round. OTOH, we</span>
<a name="l00115"></a>00115 <span class="comment"> * constructed the IDs that are read out with this macro explicitly as</span>
<a name="l00116"></a>00116 <span class="comment"> * well. I expect we&#39;ll sort it out soon... */</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">/* from blendef: */</span>
<a name="l00119"></a><a class="code" href="../../db/dfd/key_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">00119</a> <span class="preprocessor">#define GS(a)   (*((short *)(a)))</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121 <span class="comment">/* from misc_util: flip the bytes from x  */</span>
<a name="l00122"></a>00122 <span class="comment">/*  #define GS(x) (((unsigned char *)(x))[0] &lt;&lt; 8 | ((unsigned char *)(x))[1]) */</span>
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="../../db/dfd/key_8c.html#a178b456d48099772a4cacc28fe1f6022">00124</a> <a class="code" href="../../d1/d9e/structKey.html">Key</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a572a6d784e2dc2f6a88ad40435a7ddb5">add_key</a>(<a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>)    <span class="comment">/* common function */</span>
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key;
<a name="l00127"></a>00127     <span class="keywordtype">char</span> *el;
<a name="l00128"></a>00128     
<a name="l00129"></a>00129     key = <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;key, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a46c0b029a6e8fc3d7ebb18311b83397d">ID_KE</a>, <span class="stringliteral">&quot;Key&quot;</span>);
<a name="l00130"></a>00130     
<a name="l00131"></a>00131     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> = <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a23075998601db3db65e14a8a752f2b61">KEY_NORMAL</a>;
<a name="l00132"></a>00132     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a> = id;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a56223c7671e8b6a1be37882e473de9c2">uidgen</a> = 1;
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="comment">/* XXX the code here uses some defines which will soon be depreceated... */</span>
<a name="l00137"></a>00137     <span class="keywordflow">switch</span> (<a class="code" href="../../db/dfd/key_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)) {
<a name="l00138"></a>00138         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a2e6c796d1f9370e5fd552166098cdd27">ID_ME</a>:
<a name="l00139"></a>00139             el = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141             el[0] = 3;
<a name="l00142"></a>00142             el[1] = <a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">IPO_FLOAT</a>;
<a name="l00143"></a>00143             el[2] = 0;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145             key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> = 12;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147             <span class="keywordflow">break</span>;
<a name="l00148"></a>00148         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ad058b07954b2795eadc855a7a354578b">ID_LT</a>:
<a name="l00149"></a>00149             el = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151             el[0] = 3;
<a name="l00152"></a>00152             el[1] = <a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">IPO_FLOAT</a>;
<a name="l00153"></a>00153             el[2] = 0;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155             key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> = 12;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157             <span class="keywordflow">break</span>;
<a name="l00158"></a>00158         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ace150506eaf644d92a5110cf45978379">ID_CU</a>:
<a name="l00159"></a>00159             el = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161             el[0] = 4;
<a name="l00162"></a>00162             el[1] = <a class="code" href="../../db/dfd/key_8c.html#aff7a69eecef466496dacdc7a8b656799">IPO_BPOINT</a>;
<a name="l00163"></a>00163             el[2] = 0;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165             key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> = 16;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167             <span class="keywordflow">break</span>;
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     <span class="keywordflow">return</span> key;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="../../db/dfd/key_8c.html#aa20a1665f2ba42a8effcf9dd15a73cf6">00173</a> <a class="code" href="../../d1/d9e/structKey.html">Key</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a8fb643b558a887ed5f9b5020491e54aa">copy_key</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *keyn;
<a name="l00176"></a>00176     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kbn, *kb;
<a name="l00177"></a>00177     
<a name="l00178"></a>00178     <span class="keywordflow">if</span> (key == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     keyn = <a class="code" href="../../d8/db1/BKE__library_8h.html#a0c0c1987364874c73cda326eace31efd">copy_libblock</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>);
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>);
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00185"></a>00185     kbn = keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00186"></a>00186     <span class="keywordflow">while</span> (kbn) {
<a name="l00187"></a>00187         
<a name="l00188"></a>00188         <span class="keywordflow">if</span> (kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00189"></a>00189         <span class="keywordflow">if</span> (kb == key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>) keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a> = kbn;
<a name="l00190"></a>00190         
<a name="l00191"></a>00191         kbn = kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00192"></a>00192         kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     <span class="keywordflow">return</span> keyn;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 
<a name="l00199"></a><a class="code" href="../../db/dfd/key_8c.html#a9f3df1ea61e2ba9966cf94f48cc946d3">00199</a> <a class="code" href="../../d1/d9e/structKey.html">Key</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#aa9736a2e6a013f517a05414ae65cdb37">copy_key_nolib</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *keyn;
<a name="l00202"></a>00202     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kbn, *kb;
<a name="l00203"></a>00203     
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (key == 0) <span class="keywordflow">return</span> 0;
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     keyn = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(key);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#a9e6219935b7f5b387610055b81705180">adt</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>);
<a name="l00211"></a>00211     
<a name="l00212"></a>00212     kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00213"></a>00213     kbn = keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00214"></a>00214     <span class="keywordflow">while</span> (kbn) {
<a name="l00215"></a>00215         
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00217"></a>00217         <span class="keywordflow">if</span> (kb == key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>) keyn-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a> = kbn;
<a name="l00218"></a>00218         
<a name="l00219"></a>00219         kbn = kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00220"></a>00220         kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <span class="keywordflow">return</span> keyn;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="../../db/dfd/key_8c.html#a3691db909541a9ead308294b19e0e719">00226</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a52bfdd774d1f95f9a90f4401d81620ba">make_local_key</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">/* - only lib users: do nothing</span>
<a name="l00230"></a>00230 <span class="comment">     * - only local users: set flag</span>
<a name="l00231"></a>00231 <span class="comment">     * - mixed: make copy</span>
<a name="l00232"></a>00232 <span class="comment">     */</span>
<a name="l00233"></a>00233     <span class="keywordflow">if</span> (key == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00236"></a>00236     <a class="code" href="../../d8/db1/BKE__library_8h.html#a03950f3c19795a949723a1069015d10d">new_id</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="comment">/* Sort shape keys and Ipo curves after a change.  This assumes that at most</span>
<a name="l00240"></a>00240 <span class="comment"> * one key was moved, which is a valid assumption for the places it&#39;s</span>
<a name="l00241"></a>00241 <span class="comment"> * currently being called.</span>
<a name="l00242"></a>00242 <span class="comment"> */</span>
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="../../db/dfd/key_8c.html#a01c2a48a2d5cf73d0553099190c2ab10">00244</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a461870559eb59936b3057cbed2b105ac">sort_keys</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00247"></a>00247     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb2;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">/* locate the key which is out of position */</span> 
<a name="l00250"></a>00250     <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>)
<a name="l00251"></a>00251         <span class="keywordflow">if</span> ((kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) &amp;&amp; (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> &gt; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>))
<a name="l00252"></a>00252             <span class="keywordflow">break</span>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="comment">/* if we find a key, move it */</span>
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (kb) {
<a name="l00256"></a>00256         kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>; <span class="comment">/* next key is the out-of-order one */</span>
<a name="l00257"></a>00257         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb);
<a name="l00258"></a>00258         
<a name="l00259"></a>00259         <span class="comment">/* find the right location and insert before */</span>
<a name="l00260"></a>00260         <span class="keywordflow">for</span> (kb2 = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb2; kb2 = kb2-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00261"></a>00261             <span class="keywordflow">if</span> (kb2-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> &gt; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>) {
<a name="l00262"></a>00262                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a99b54e021279f92d4a31afd7ade4153c">BLI_insertlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb2-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a1b6ca93b4a4aaba67a6871533a843392">prev</a>, kb);
<a name="l00263"></a>00263                 <span class="keywordflow">break</span>;
<a name="l00264"></a>00264             }
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">/* new rule; first key is refkey, this to match drawing channels... */</span>
<a name="l00269"></a>00269     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a> = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="comment">/**************** do the key ****************/</span>
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="../../db/dfd/key_8c.html#a77a9ae696ecfa7f2645fc4a6b72fe928">00274</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(<span class="keywordtype">float</span> t, <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> type)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="keywordtype">float</span> t2, t3, fc;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa6deed7f50e33ee925ec5b60255b97cb5">KEY_LINEAR</a>) {
<a name="l00279"></a>00279         data[0] =          0.0f;
<a name="l00280"></a>00280         data[1] = -t     + 1.0f;
<a name="l00281"></a>00281         data[2] =  t;
<a name="l00282"></a>00282         data[3] =          0.0f;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa7d099df7300f79faa4419f6a0cc18a61">KEY_CARDINAL</a>) {
<a name="l00285"></a>00285         t2 = t * t;
<a name="l00286"></a>00286         t3 = t2 * t;
<a name="l00287"></a>00287         fc = 0.71f;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         data[0] = -fc          * t3  + 2.0f * fc          * t2 - fc * t;
<a name="l00290"></a>00290         data[1] =  (2.0f - fc) * t3  + (fc - 3.0f)        * t2 + 1.0f;
<a name="l00291"></a>00291         data[2] =  (fc - 2.0f) * t3  + (3.0f - 2.0f * fc) * t2 + fc * t;
<a name="l00292"></a>00292         data[3] =  fc          * t3  - fc * t2;
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>) {
<a name="l00295"></a>00295         t2 = t * t;
<a name="l00296"></a>00296         t3 = t2 * t;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         data[0] = -0.16666666f * t3  + 0.5f * t2   - 0.5f * t    + 0.16666666f;
<a name="l00299"></a>00299         data[1] =  0.5f        * t3  - t2                        + 0.66666666f;
<a name="l00300"></a>00300         data[2] = -0.5f        * t3  + 0.5f * t2   + 0.5f * t    + 0.16666666f;
<a name="l00301"></a>00301         data[3] =  0.16666666f * t3;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="comment">/* first derivative */</span>
<a name="l00306"></a><a class="code" href="../../db/dfd/key_8c.html#a944ba18f6851fa2404cabac072de0469">00306</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a944ba18f6851fa2404cabac072de0469">key_curve_tangent_weights</a>(<span class="keywordtype">float</span> t, <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> type)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308     <span class="keywordtype">float</span> t2, fc;
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa6deed7f50e33ee925ec5b60255b97cb5">KEY_LINEAR</a>) {
<a name="l00311"></a>00311         data[0] = 0.0f;
<a name="l00312"></a>00312         data[1] = -1.0f;
<a name="l00313"></a>00313         data[2] = 1.0f;
<a name="l00314"></a>00314         data[3] = 0.0f;
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa7d099df7300f79faa4419f6a0cc18a61">KEY_CARDINAL</a>) {
<a name="l00317"></a>00317         t2 = t * t;
<a name="l00318"></a>00318         fc = 0.71f;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         data[0] = -3.0f * fc          * t2  + 4.0f * fc * t                  - fc;
<a name="l00321"></a>00321         data[1] =  3.0f * (2.0f - fc) * t2  + 2.0f * (fc - 3.0f) * t;
<a name="l00322"></a>00322         data[2] =  3.0f * (fc - 2.0f) * t2  + 2.0f * (3.0f - 2.0f * fc) * t  + fc;
<a name="l00323"></a>00323         data[3] =  3.0f * fc          * t2  - 2.0f * fc * t;
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>) {
<a name="l00326"></a>00326         t2 = t * t;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         data[0] = -0.5f * t2  + t         - 0.5f;
<a name="l00329"></a>00329         data[1] =  1.5f * t2  - t * 2.0f;
<a name="l00330"></a>00330         data[2] = -1.5f * t2  + t         + 0.5f;
<a name="l00331"></a>00331         data[3] =  0.5f * t2;
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="comment">/* second derivative */</span>
<a name="l00336"></a><a class="code" href="../../db/dfd/key_8c.html#a58ec6f6c53283668d8f3fa4e76c8c34c">00336</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a58ec6f6c53283668d8f3fa4e76c8c34c">key_curve_normal_weights</a>(<span class="keywordtype">float</span> t, <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> type)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338     <span class="keywordtype">float</span> fc;
<a name="l00339"></a>00339     
<a name="l00340"></a>00340     <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa6deed7f50e33ee925ec5b60255b97cb5">KEY_LINEAR</a>) {
<a name="l00341"></a>00341         data[0] = 0.0f;
<a name="l00342"></a>00342         data[1] = 0.0f;
<a name="l00343"></a>00343         data[2] = 0.0f;
<a name="l00344"></a>00344         data[3] = 0.0f;
<a name="l00345"></a>00345     }
<a name="l00346"></a>00346     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa7d099df7300f79faa4419f6a0cc18a61">KEY_CARDINAL</a>) {
<a name="l00347"></a>00347         fc = 0.71f;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         data[0] = -6.0f * fc          * t  + 4.0f * fc;
<a name="l00350"></a>00350         data[1] =  6.0f * (2.0f - fc) * t  + 2.0f * (fc - 3.0f);
<a name="l00351"></a>00351         data[2] =  6.0f * (fc - 2.0f) * t  + 2.0f * (3.0f - 2.0f * fc);
<a name="l00352"></a>00352         data[3] =  6.0f * fc          * t  - 2.0f * fc;
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>) {
<a name="l00355"></a>00355         data[0] = -1.0f * t  + 1.0f;
<a name="l00356"></a>00356         data[1] =  3.0f * t  - 2.0f;
<a name="l00357"></a>00357         data[2] = -3.0f * t  + 1.0f;
<a name="l00358"></a>00358         data[3] =  1.0f * t;
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">00362</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(<span class="keywordtype">float</span> fac, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *k[], <span class="keywordtype">float</span> *t, <span class="keywordtype">int</span> cycl)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364     <span class="comment">/* return 1 means k[2] is the position, return 0 means interpolate */</span>
<a name="l00365"></a>00365     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *k1, *firstkey;
<a name="l00366"></a>00366     <span class="keywordtype">float</span> d, dpos, ofs = 0, lastpos, temp, fval[4];
<a name="l00367"></a>00367     <span class="keywordtype">short</span> bsplinetype;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     firstkey = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00370"></a>00370     k1 = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00371"></a>00371     lastpos = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00372"></a>00372     dpos = lastpos - firstkey-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">if</span> (fac &lt; firstkey-&gt;pos) fac = firstkey-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00375"></a>00375     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt; k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>) fac = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     k1 = k[0] = k[1] = k[2] = k[3] = firstkey;
<a name="l00378"></a>00378     t[0] = t[1] = t[2] = t[3] = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="comment">/* if (fac&lt;0.0 || fac&gt;1.0) return 1; */</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> 1;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (cycl) { <span class="comment">/* pre-sort */</span>
<a name="l00385"></a>00385         k[2] = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00386"></a>00386         k[3] = k[2]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (k[3] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) k[3] = k1;
<a name="l00388"></a>00388         <span class="keywordflow">while</span> (k1) {
<a name="l00389"></a>00389             <span class="keywordflow">if</span> (k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) k[0] = k1;
<a name="l00390"></a>00390             k1 = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392         <span class="comment">/* k1= k[1]; */</span> <span class="comment">/* UNUSED */</span>
<a name="l00393"></a>00393         t[0] = k[0]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00394"></a>00394         t[1] += dpos;
<a name="l00395"></a>00395         t[2] = k[2]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> + dpos;
<a name="l00396"></a>00396         t[3] = k[3]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> + dpos;
<a name="l00397"></a>00397         fac += dpos;
<a name="l00398"></a>00398         ofs = dpos;
<a name="l00399"></a>00399         <span class="keywordflow">if</span> (k[3] == k[1]) {
<a name="l00400"></a>00400             t[3] += dpos;
<a name="l00401"></a>00401             ofs = 2.0f * dpos;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="keywordflow">if</span> (fac &lt; t[1]) fac += dpos;
<a name="l00404"></a>00404         k1 = k[3];
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     <span class="keywordflow">else</span> {  <span class="comment">/* pre-sort */</span>
<a name="l00407"></a>00407         k[2] = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00408"></a>00408         t[2] = k[2]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00409"></a>00409         k[3] = k[2]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (k[3] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) k[3] = k[2];
<a name="l00411"></a>00411         t[3] = k[3]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l00412"></a>00412         k1 = k[3];
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414     
<a name="l00415"></a>00415     <span class="keywordflow">while</span> (t[2] &lt; fac) {    <span class="comment">/* find correct location */</span>
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00417"></a>00417             <span class="keywordflow">if</span> (cycl) {
<a name="l00418"></a>00418                 k1 = firstkey;
<a name="l00419"></a>00419                 ofs += dpos;
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t[2] == t[3]) <span class="keywordflow">break</span>;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         <span class="keywordflow">else</span> k1 = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         t[0] = t[1];
<a name="l00426"></a>00426         k[0] = k[1];
<a name="l00427"></a>00427         t[1] = t[2];
<a name="l00428"></a>00428         k[1] = k[2];
<a name="l00429"></a>00429         t[2] = t[3];
<a name="l00430"></a>00430         k[2] = k[3];
<a name="l00431"></a>00431         t[3] = k1-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> + ofs;
<a name="l00432"></a>00432         k[3] = k1;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <span class="keywordflow">if</span> (ofs &gt; 2.1f + lastpos) <span class="keywordflow">break</span>;
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     
<a name="l00437"></a>00437     bsplinetype = 0;
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (k[1]-&gt;type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a> || k[2]-&gt;type == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>) bsplinetype = 1;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (cycl == 0) {
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (bsplinetype == 0) {   <span class="comment">/* B spline doesn&#39;t go through the control points */</span>
<a name="l00443"></a>00443             <span class="keywordflow">if</span> (fac &lt;= t[1]) {  <span class="comment">/* fac for 1st key */</span>
<a name="l00444"></a>00444                 t[2] = t[1];
<a name="l00445"></a>00445                 k[2] = k[1];
<a name="l00446"></a>00446                 <span class="keywordflow">return</span> 1;
<a name="l00447"></a>00447             }
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (fac &gt;= t[2]) {  <span class="comment">/* fac after 2nd key */</span>
<a name="l00449"></a>00449                 <span class="keywordflow">return</span> 1;
<a name="l00450"></a>00450             }
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt; t[2]) {  <span class="comment">/* last key */</span>
<a name="l00453"></a>00453             fac = t[2];
<a name="l00454"></a>00454             k[3] = k[2];
<a name="l00455"></a>00455             t[3] = t[2];
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     d = t[2] - t[1];
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (d == 0.0f) {
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (bsplinetype == 0) {
<a name="l00462"></a>00462             <span class="keywordflow">return</span> 1;  <span class="comment">/* both keys equal */</span>
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     <span class="keywordflow">else</span> {
<a name="l00466"></a>00466         d = (fac - t[1]) / d;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <span class="comment">/* interpolation */</span>
<a name="l00470"></a>00470     
<a name="l00471"></a>00471     <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(d, t, k[1]-&gt;type);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="keywordflow">if</span> (k[1]-&gt;type != k[2]-&gt;type) {
<a name="l00474"></a>00474         <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(d, fval, k[2]-&gt;type);
<a name="l00475"></a>00475         
<a name="l00476"></a>00476         temp = 1.0f - d;
<a name="l00477"></a>00477         t[0] = temp * t[0] + d * fval[0];
<a name="l00478"></a>00478         t[1] = temp * t[1] + d * fval[1];
<a name="l00479"></a>00479         t[2] = temp * t[2] + d * fval[2];
<a name="l00480"></a>00480         t[3] = temp * t[3] + d * fval[3];
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordflow">return</span> 0;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="../../db/dfd/key_8c.html#aeb8b93002db031fa1146c07aeebe821f">00487</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#aeb8b93002db031fa1146c07aeebe821f">flerp</a>(<span class="keywordtype">int</span> tot, <span class="keywordtype">float</span> *in, <span class="keywordtype">float</span> *f0, <span class="keywordtype">float</span> *f1, <span class="keywordtype">float</span> *f2, <span class="keywordtype">float</span> *f3, <span class="keywordtype">float</span> *t)
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489     <span class="keywordtype">int</span> a;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++) {
<a name="l00492"></a>00492         in[a] = t[0] * f0[a] + t[1] * f1[a] + t[2] * f2[a] + t[3] * f3[a];
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a><a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">00496</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">rel_flerp</a>(<span class="keywordtype">int</span> tot, <span class="keywordtype">float</span> *in, <span class="keywordtype">float</span> *ref, <span class="keywordtype">float</span> *out, <span class="keywordtype">float</span> fac)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498     <span class="keywordtype">int</span> a;
<a name="l00499"></a>00499     
<a name="l00500"></a>00500     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++) {
<a name="l00501"></a>00501         in[a] -= fac * (ref[a] - out[a]);
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">00505</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <span class="keywordtype">char</span> **freedata)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (kb == actkb) {
<a name="l00508"></a>00508         <span class="comment">/* this hack makes it possible to edit shape keys in</span>
<a name="l00509"></a>00509 <span class="comment">         * edit mode with shape keys blending applied */</span>
<a name="l00510"></a>00510         <span class="keywordflow">if</span> (<a class="code" href="../../db/dfd/key_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a>-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) == <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a2e6c796d1f9370e5fd552166098cdd27">ID_ME</a>) {
<a name="l00511"></a>00511             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00512"></a>00512             <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l00513"></a>00513             <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l00514"></a>00514             float (*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)[3];
<a name="l00515"></a>00515             <span class="keywordtype">int</span> a;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a>;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a> &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a> == kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>) {
<a name="l00520"></a>00520                 a = 0;
<a name="l00521"></a>00521                 <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a>, <span class="stringliteral">&quot;key_block_get_data&quot;</span>);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523                 <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (eve, &amp;iter, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>) {
<a name="l00524"></a>00524                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[a], eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>);
<a name="l00525"></a>00525                     a++;
<a name="l00526"></a>00526                 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528                 *freedata = (<span class="keywordtype">char</span> *)<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00529"></a>00529                 <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     *freedata = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00535"></a>00535     <span class="keywordflow">return</span> kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 <span class="comment">/* currently only the first value of &#39;ofs&#39; may be set. */</span>
<a name="l00540"></a><a class="code" href="../../db/dfd/key_8c.html#a8bc6057ca70bf1509727f201c0cbf7ac">00540</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/dfd/key_8c.html#a8bc6057ca70bf1509727f201c0cbf7ac">key_pointer_size</a>(<span class="keyword">const</span> <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> *poinsize, <span class="keywordtype">int</span> *ofs)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00543"></a>00543         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordflow">switch</span> (<a class="code" href="../../db/dfd/key_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a>-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)) {
<a name="l00547"></a>00547         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a2e6c796d1f9370e5fd552166098cdd27">ID_ME</a>:
<a name="l00548"></a>00548             *ofs = <span class="keyword">sizeof</span>(float) * 3;
<a name="l00549"></a>00549             *poinsize = *ofs;
<a name="l00550"></a>00550             <span class="keywordflow">break</span>;
<a name="l00551"></a>00551         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ad058b07954b2795eadc855a7a354578b">ID_LT</a>:
<a name="l00552"></a>00552             *ofs = <span class="keyword">sizeof</span>(float) * 3;
<a name="l00553"></a>00553             *poinsize = *ofs;
<a name="l00554"></a>00554             <span class="keywordflow">break</span>;
<a name="l00555"></a>00555         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ace150506eaf644d92a5110cf45978379">ID_CU</a>:
<a name="l00556"></a>00556             <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">KEY_MODE_BPOINT</a>) {
<a name="l00557"></a>00557                 *ofs = <span class="keyword">sizeof</span>(float) * 4;
<a name="l00558"></a>00558                 *poinsize = *ofs;
<a name="l00559"></a>00559             }
<a name="l00560"></a>00560             <span class="keywordflow">else</span> {
<a name="l00561"></a>00561                 ofs[0] = <span class="keyword">sizeof</span>(float) * 12;
<a name="l00562"></a>00562                 *poinsize = (*ofs) / 3;
<a name="l00563"></a>00563             }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565             <span class="keywordflow">break</span>;
<a name="l00566"></a>00566         <span class="keywordflow">default</span>:
<a name="l00567"></a>00567             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;invalid &#39;key-&gt;from&#39; ID type&quot;</span>);
<a name="l00568"></a>00568             <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a><a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">00574</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keyword">const</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">char</span> *poin, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <span class="keywordtype">float</span> *weights, <span class="keyword">const</span> <span class="keywordtype">int</span> mode)
<a name="l00575"></a>00575 {
<a name="l00576"></a>00576     <span class="keywordtype">float</span> ktot = 0.0, kd = 0.0;
<a name="l00577"></a>00577     <span class="keywordtype">int</span> elemsize, poinsize = 0, a, *ofsp, ofs[32], flagflo = 0;
<a name="l00578"></a>00578     <span class="keywordtype">char</span> *k1, *kref, *freek1, *freekref;
<a name="l00579"></a>00579     <span class="keywordtype">char</span> *cp, elemstr[8];
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <span class="comment">/* currently always 0, in future key_pointer_size may assign */</span>
<a name="l00582"></a>00582     ofs[1] = 0;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (!<a class="code" href="../../db/dfd/key_8c.html#a8bc6057ca70bf1509727f201c0cbf7ac">key_pointer_size</a>(key, mode, &amp;poinsize, &amp;ofs[0]))
<a name="l00585"></a>00585         <span class="keywordflow">return</span>;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (end &gt; tot) end = tot;
<a name="l00588"></a>00588     
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (tot != kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>) {
<a name="l00590"></a>00590         ktot = 0.0;
<a name="l00591"></a>00591         flagflo = 1;
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>) {
<a name="l00593"></a>00593             kd = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> / (float)tot;
<a name="l00594"></a>00594         }
<a name="l00595"></a>00595         <span class="keywordflow">else</span> {
<a name="l00596"></a>00596             <span class="keywordflow">return</span>;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     k1 = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, kb, &amp;freek1);
<a name="l00601"></a>00601     kref = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>, &amp;freekref);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="comment">/* this exception is needed for slurphing */</span>
<a name="l00604"></a>00604     <span class="keywordflow">if</span> (start != 0) {
<a name="l00605"></a>00605         
<a name="l00606"></a>00606         poin += poinsize * start;
<a name="l00607"></a>00607         
<a name="l00608"></a>00608         <span class="keywordflow">if</span> (flagflo) {
<a name="l00609"></a>00609             ktot += start * kd;
<a name="l00610"></a>00610             a = (int)floor(ktot);
<a name="l00611"></a>00611             <span class="keywordflow">if</span> (a) {
<a name="l00612"></a>00612                 ktot -= a;
<a name="l00613"></a>00613                 k1 += a * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00614"></a>00614             }
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         <span class="keywordflow">else</span> k1 += start * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00617"></a>00617     }   
<a name="l00618"></a>00618     
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) {
<a name="l00620"></a>00620         elemstr[0] = 1;
<a name="l00621"></a>00621         elemstr[1] = <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>;
<a name="l00622"></a>00622         elemstr[2] = 0;
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624     
<a name="l00625"></a>00625     <span class="comment">/* just do it here, not above! */</span>
<a name="l00626"></a>00626     elemsize = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) elemsize *= 3;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     <span class="keywordflow">for</span> (a = start; a &lt; end; a++) {
<a name="l00630"></a>00630         cp = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) cp = elemstr;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         ofsp = ofs;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         <span class="keywordflow">while</span> (cp[0]) {
<a name="l00636"></a>00636 
<a name="l00637"></a>00637             <span class="keywordflow">switch</span> (cp[1]) {
<a name="l00638"></a>00638                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">IPO_FLOAT</a>:
<a name="l00639"></a>00639                     <span class="keywordflow">if</span> (weights) {
<a name="l00640"></a>00640                         memcpy(poin, kref, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3);
<a name="l00641"></a>00641                         <span class="keywordflow">if</span> (*weights != 0.0f)
<a name="l00642"></a>00642                             <a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">rel_flerp</a>(cp[0], (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)kref, (<span class="keywordtype">float</span> *)k1, *weights);
<a name="l00643"></a>00643                         weights++;
<a name="l00644"></a>00644                     }
<a name="l00645"></a>00645                     <span class="keywordflow">else</span> {
<a name="l00646"></a>00646                         memcpy(poin, k1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3);
<a name="l00647"></a>00647                     }
<a name="l00648"></a>00648                     <span class="keywordflow">break</span>;
<a name="l00649"></a>00649                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#aff7a69eecef466496dacdc7a8b656799">IPO_BPOINT</a>:
<a name="l00650"></a>00650                     memcpy(poin, k1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 4);
<a name="l00651"></a>00651                     <span class="keywordflow">break</span>;
<a name="l00652"></a>00652                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>:
<a name="l00653"></a>00653                     memcpy(poin, k1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 12);
<a name="l00654"></a>00654                     <span class="keywordflow">break</span>;
<a name="l00655"></a>00655                 <span class="keywordflow">default</span>:
<a name="l00656"></a>00656                     <span class="comment">/* should never happen */</span>
<a name="l00657"></a>00657                     <span class="keywordflow">if</span> (freek1) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek1);
<a name="l00658"></a>00658                     <span class="keywordflow">if</span> (freekref) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freekref);
<a name="l00659"></a>00659                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;invalid &#39;cp[1]&#39;&quot;</span>);
<a name="l00660"></a>00660                     <span class="keywordflow">return</span>;
<a name="l00661"></a>00661             }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663             poin += *ofsp;
<a name="l00664"></a>00664             cp += 2; ofsp++;
<a name="l00665"></a>00665         }
<a name="l00666"></a>00666         
<a name="l00667"></a>00667         <span class="comment">/* are we going to be nasty? */</span>
<a name="l00668"></a>00668         <span class="keywordflow">if</span> (flagflo) {
<a name="l00669"></a>00669             ktot += kd;
<a name="l00670"></a>00670             <span class="keywordflow">while</span> (ktot &gt;= 1.0f) {
<a name="l00671"></a>00671                 ktot -= 1.0f;
<a name="l00672"></a>00672                 k1 += elemsize;
<a name="l00673"></a>00673                 kref += elemsize;
<a name="l00674"></a>00674             }
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676         <span class="keywordflow">else</span> {
<a name="l00677"></a>00677             k1 += elemsize;
<a name="l00678"></a>00678             kref += elemsize;
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         
<a name="l00681"></a>00681         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) {
<a name="l00682"></a>00682             a += 2;
<a name="l00683"></a>00683         }
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (freek1) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek1);
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (freekref) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freekref);
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="../../db/dfd/key_8c.html#aee016abb3d9e1e716790e6c14292b376">00690</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#aee016abb3d9e1e716790e6c14292b376">cp_cu_key</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <span class="keyword">const</span> <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l00693"></a>00693     <span class="keywordtype">int</span> a, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, a1, a2;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordflow">for</span> (a = 0, nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>, a += step) {
<a name="l00696"></a>00696         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>) {
<a name="l00697"></a>00697             step = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699             a1 = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(a, start);
<a name="l00700"></a>00700             a2 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(a + step, end);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702             <span class="keywordflow">if</span> (a1 &lt; a2) <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(a1, a2, tot, out, key, actkb, kb, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">KEY_MODE_BPOINT</a>);
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l00705"></a>00705             step = 3 * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707             <span class="comment">/* exception because keys prefer to work with complete blocks */</span>
<a name="l00708"></a>00708             a1 = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(a, start);
<a name="l00709"></a>00709             a2 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(a + step, end);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711             <span class="keywordflow">if</span> (a1 &lt; a2) <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(a1, a2, tot, out, key, actkb, kb, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>);
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713         <span class="keywordflow">else</span> {
<a name="l00714"></a>00714             step = 0;
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a><a class="code" href="../../db/dfd/key_8c.html#aad3163b5c5e07940be352232e8214261">00719</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a52493fc3f81d3c3c943a4773e4a3bf75">do_rel_key</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keyword">const</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">char</span> *basispoin, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <span class="keyword">const</span> <span class="keywordtype">int</span> mode)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00722"></a>00722     <span class="keywordtype">int</span> *ofsp, ofs[3], elemsize, b;
<a name="l00723"></a>00723     <span class="keywordtype">char</span> *cp, *poin, *reffrom, *from, elemstr[8];
<a name="l00724"></a>00724     <span class="keywordtype">char</span> *freefrom, *freereffrom;
<a name="l00725"></a>00725     <span class="keywordtype">int</span> poinsize;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="comment">/* currently always 0, in future key_pointer_size may assign */</span>
<a name="l00728"></a>00728     ofs[1] = 0;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (!<a class="code" href="../../db/dfd/key_8c.html#a8bc6057ca70bf1509727f201c0cbf7ac">key_pointer_size</a>(key, mode, &amp;poinsize, &amp;ofs[0]))
<a name="l00731"></a>00731         <span class="keywordflow">return</span>;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (end &gt; tot) end = tot;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="comment">/* in case of beztriple */</span>
<a name="l00736"></a>00736     elemstr[0] = 1;              <span class="comment">/* nr of ipofloats */</span>
<a name="l00737"></a>00737     elemstr[1] = <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>;
<a name="l00738"></a>00738     elemstr[2] = 0;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <span class="comment">/* just here, not above! */</span>
<a name="l00741"></a>00741     elemsize = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) elemsize *= 3;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">/* step 1 init */</span>
<a name="l00745"></a>00745     <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(start, end, tot, basispoin, key, actkb, key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mode);
<a name="l00746"></a>00746     
<a name="l00747"></a>00747     <span class="comment">/* step 2: do it */</span>
<a name="l00748"></a>00748     
<a name="l00749"></a>00749     <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (kb != key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>) {
<a name="l00751"></a>00751             <span class="keywordtype">float</span> icuval = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ab3603099b09736fe07e177c53a44dc6d">curval</a>;
<a name="l00752"></a>00752             
<a name="l00753"></a>00753             <span class="comment">/* only with value, and no difference allowed */</span>
<a name="l00754"></a>00754             <span class="keywordflow">if</span> (!(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a293ff458065155efca63b30b33387982">flag</a> &amp; <a class="code" href="../../de/d41/DNA__key__types_8h.html#af77d65ab56b38a820b1efc0bcafbd4fba985fc22c3c56f56ac76bbc3328d20350">KEYBLOCK_MUTE</a>) &amp;&amp; icuval != 0.0f &amp;&amp; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> == tot) {
<a name="l00755"></a>00755                 <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *refb;
<a name="l00756"></a>00756                 <span class="keywordtype">float</span> weight, *weights = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758                 <span class="comment">/* reference now can be any block */</span>
<a name="l00759"></a>00759                 refb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#adc3b6e3b0dcc4c2d4c0334b339913508">relative</a>);
<a name="l00760"></a>00760                 <span class="keywordflow">if</span> (refb == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l00761"></a>00761                 
<a name="l00762"></a>00762                 poin = basispoin;
<a name="l00763"></a>00763                 from = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, kb, &amp;freefrom);
<a name="l00764"></a>00764                 reffrom = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, refb, &amp;freereffrom);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766                 poin += start * poinsize;
<a name="l00767"></a>00767                 reffrom += key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> * start;  <span class="comment">// key elemsize yes!</span>
<a name="l00768"></a>00768                 from += key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> * start;
<a name="l00769"></a>00769                 
<a name="l00770"></a>00770                 <span class="keywordflow">for</span> (b = start; b &lt; end; b++) {
<a name="l00771"></a>00771                 
<a name="l00772"></a>00772                     weight = weights ? (*weights * icuval) : icuval;
<a name="l00773"></a>00773                     
<a name="l00774"></a>00774                     cp = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00775"></a>00775                     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) cp = elemstr;
<a name="l00776"></a>00776                     
<a name="l00777"></a>00777                     ofsp = ofs;
<a name="l00778"></a>00778                     
<a name="l00779"></a>00779                     <span class="keywordflow">while</span> (cp[0]) {     <span class="comment">/* cp[0]==amount */</span>
<a name="l00780"></a>00780                         
<a name="l00781"></a>00781                         <span class="keywordflow">switch</span> (cp[1]) {
<a name="l00782"></a>00782                             <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">IPO_FLOAT</a>:
<a name="l00783"></a>00783                                 <a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">rel_flerp</a>(3, (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)reffrom, (<span class="keywordtype">float</span> *)from, weight);
<a name="l00784"></a>00784                                 <span class="keywordflow">break</span>;
<a name="l00785"></a>00785                             <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#aff7a69eecef466496dacdc7a8b656799">IPO_BPOINT</a>:
<a name="l00786"></a>00786                                 <a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">rel_flerp</a>(4, (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)reffrom, (<span class="keywordtype">float</span> *)from, weight);
<a name="l00787"></a>00787                                 <span class="keywordflow">break</span>;
<a name="l00788"></a>00788                             <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>:
<a name="l00789"></a>00789                                 <a class="code" href="../../db/dfd/key_8c.html#a8cdf9c047093fa7c5e8bf07818ea69fb">rel_flerp</a>(12, (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)reffrom, (<span class="keywordtype">float</span> *)from, weight);
<a name="l00790"></a>00790                                 <span class="keywordflow">break</span>;
<a name="l00791"></a>00791                             <span class="keywordflow">default</span>:
<a name="l00792"></a>00792                                 <span class="comment">/* should never happen */</span>
<a name="l00793"></a>00793                                 <span class="keywordflow">if</span> (freefrom) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freefrom);
<a name="l00794"></a>00794                                 <span class="keywordflow">if</span> (freereffrom) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freereffrom);
<a name="l00795"></a>00795                                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;invalid &#39;cp[1]&#39;&quot;</span>);
<a name="l00796"></a>00796                                 <span class="keywordflow">return</span>;
<a name="l00797"></a>00797                         }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799                         poin += *ofsp;
<a name="l00800"></a>00800                         
<a name="l00801"></a>00801                         cp += 2;
<a name="l00802"></a>00802                         ofsp++;
<a name="l00803"></a>00803                     }
<a name="l00804"></a>00804                     
<a name="l00805"></a>00805                     reffrom += elemsize;
<a name="l00806"></a>00806                     from += elemsize;
<a name="l00807"></a>00807                     
<a name="l00808"></a>00808                     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) b += 2;
<a name="l00809"></a>00809                     <span class="keywordflow">if</span> (weights) weights++;
<a name="l00810"></a>00810                 }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812                 <span class="keywordflow">if</span> (freefrom) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freefrom);
<a name="l00813"></a>00813                 <span class="keywordflow">if</span> (freereffrom) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freereffrom);
<a name="l00814"></a>00814             }
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816     }
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 
<a name="l00820"></a><a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">00820</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <span class="keyword">const</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">char</span> *poin, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> **k, <span class="keywordtype">float</span> *t, <span class="keyword">const</span> <span class="keywordtype">int</span> mode)
<a name="l00821"></a>00821 {
<a name="l00822"></a>00822     <span class="keywordtype">float</span> k1tot = 0.0, k2tot = 0.0, k3tot = 0.0, k4tot = 0.0;
<a name="l00823"></a>00823     <span class="keywordtype">float</span> k1d = 0.0, k2d = 0.0, k3d = 0.0, k4d = 0.0;
<a name="l00824"></a>00824     <span class="keywordtype">int</span> a, ofs[32], *ofsp;
<a name="l00825"></a>00825     <span class="keywordtype">int</span> flagdo = 15, flagflo = 0, elemsize, poinsize = 0;
<a name="l00826"></a>00826     <span class="keywordtype">char</span> *k1, *k2, *k3, *k4, *freek1, *freek2, *freek3, *freek4;
<a name="l00827"></a>00827     <span class="keywordtype">char</span> *cp, elemstr[8];
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="comment">/* currently always 0, in future key_pointer_size may assign */</span>
<a name="l00830"></a>00830     ofs[1] = 0;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (!<a class="code" href="../../db/dfd/key_8c.html#a8bc6057ca70bf1509727f201c0cbf7ac">key_pointer_size</a>(key, mode, &amp;poinsize, &amp;ofs[0]))
<a name="l00833"></a>00833         <span class="keywordflow">return</span>;
<a name="l00834"></a>00834     
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (end &gt; tot) end = tot;
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     k1 = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, k[0], &amp;freek1);
<a name="l00838"></a>00838     k2 = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, k[1], &amp;freek2);
<a name="l00839"></a>00839     k3 = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, k[2], &amp;freek3);
<a name="l00840"></a>00840     k4 = <a class="code" href="../../db/dfd/key_8c.html#ac12a7212f5e4ba70937c28c1e5761451">key_block_get_data</a>(key, actkb, k[3], &amp;freek4);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842     <span class="comment">/*  test for more or less points (per key!) */</span>
<a name="l00843"></a>00843     <span class="keywordflow">if</span> (tot != k[0]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00844"></a>00844         k1tot = 0.0;
<a name="l00845"></a>00845         flagflo |= 1;
<a name="l00846"></a>00846         <span class="keywordflow">if</span> (k[0]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00847"></a>00847             k1d = k[0]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> / (float)tot;
<a name="l00848"></a>00848         }
<a name="l00849"></a>00849         <span class="keywordflow">else</span> flagdo -= 1;
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (tot != k[1]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00852"></a>00852         k2tot = 0.0;
<a name="l00853"></a>00853         flagflo |= 2;
<a name="l00854"></a>00854         <span class="keywordflow">if</span> (k[0]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00855"></a>00855             k2d = k[1]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> / (float)tot;
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857         <span class="keywordflow">else</span> flagdo -= 2;
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (tot != k[2]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00860"></a>00860         k3tot = 0.0;
<a name="l00861"></a>00861         flagflo |= 4;
<a name="l00862"></a>00862         <span class="keywordflow">if</span> (k[0]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00863"></a>00863             k3d = k[2]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> / (float)tot;
<a name="l00864"></a>00864         }
<a name="l00865"></a>00865         <span class="keywordflow">else</span> flagdo -= 4;
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867     <span class="keywordflow">if</span> (tot != k[3]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00868"></a>00868         k4tot = 0.0;
<a name="l00869"></a>00869         flagflo |= 8;
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (k[0]-&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>) {
<a name="l00871"></a>00871             k4d = k[3]-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> / (float)tot;
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873         <span class="keywordflow">else</span> flagdo -= 8;
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="comment">/* this exception needed for slurphing */</span>
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (start != 0) {
<a name="l00878"></a>00878 
<a name="l00879"></a>00879         poin += poinsize * start;
<a name="l00880"></a>00880         
<a name="l00881"></a>00881         <span class="keywordflow">if</span> (flagdo &amp; 1) {
<a name="l00882"></a>00882             <span class="keywordflow">if</span> (flagflo &amp; 1) {
<a name="l00883"></a>00883                 k1tot += start * k1d;
<a name="l00884"></a>00884                 a = (int)floor(k1tot);
<a name="l00885"></a>00885                 <span class="keywordflow">if</span> (a) {
<a name="l00886"></a>00886                     k1tot -= a;
<a name="l00887"></a>00887                     k1 += a * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00888"></a>00888                 }
<a name="l00889"></a>00889             }
<a name="l00890"></a>00890             <span class="keywordflow">else</span> k1 += start * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00891"></a>00891         }
<a name="l00892"></a>00892         <span class="keywordflow">if</span> (flagdo &amp; 2) {
<a name="l00893"></a>00893             <span class="keywordflow">if</span> (flagflo &amp; 2) {
<a name="l00894"></a>00894                 k2tot += start * k2d;
<a name="l00895"></a>00895                 a = (int)floor(k2tot);
<a name="l00896"></a>00896                 <span class="keywordflow">if</span> (a) {
<a name="l00897"></a>00897                     k2tot -= a;
<a name="l00898"></a>00898                     k2 += a * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00899"></a>00899                 }
<a name="l00900"></a>00900             }
<a name="l00901"></a>00901             <span class="keywordflow">else</span> k2 += start * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00902"></a>00902         }
<a name="l00903"></a>00903         <span class="keywordflow">if</span> (flagdo &amp; 4) {
<a name="l00904"></a>00904             <span class="keywordflow">if</span> (flagflo &amp; 4) {
<a name="l00905"></a>00905                 k3tot += start * k3d;
<a name="l00906"></a>00906                 a = (int)floor(k3tot);
<a name="l00907"></a>00907                 <span class="keywordflow">if</span> (a) {
<a name="l00908"></a>00908                     k3tot -= a;
<a name="l00909"></a>00909                     k3 += a * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00910"></a>00910                 }
<a name="l00911"></a>00911             }
<a name="l00912"></a>00912             <span class="keywordflow">else</span> k3 += start * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914         <span class="keywordflow">if</span> (flagdo &amp; 8) {
<a name="l00915"></a>00915             <span class="keywordflow">if</span> (flagflo &amp; 8) {
<a name="l00916"></a>00916                 k4tot += start * k4d;
<a name="l00917"></a>00917                 a = (int)floor(k4tot);
<a name="l00918"></a>00918                 <span class="keywordflow">if</span> (a) {
<a name="l00919"></a>00919                     k4tot -= a;
<a name="l00920"></a>00920                     k4 += a * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00921"></a>00921                 }
<a name="l00922"></a>00922             }
<a name="l00923"></a>00923             <span class="keywordflow">else</span> k4 += start * key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00924"></a>00924         }
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="comment">/* in case of beztriple */</span>
<a name="l00929"></a>00929     elemstr[0] = 1;              <span class="comment">/* nr of ipofloats */</span>
<a name="l00930"></a>00930     elemstr[1] = <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>;
<a name="l00931"></a>00931     elemstr[2] = 0;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="comment">/* only here, not above! */</span>
<a name="l00934"></a>00934     elemsize = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) elemsize *= 3;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">for</span> (a = start; a &lt; end; a++) {
<a name="l00938"></a>00938     
<a name="l00939"></a>00939         cp = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a3fb147668e7b13100f57d4e548eaf5e6">elemstr</a>;
<a name="l00940"></a>00940         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) cp = elemstr;
<a name="l00941"></a>00941         
<a name="l00942"></a>00942         ofsp = ofs;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         <span class="keywordflow">while</span> (cp[0]) {     <span class="comment">/* cp[0]==amount */</span>
<a name="l00945"></a>00945 
<a name="l00946"></a>00946             <span class="keywordflow">switch</span> (cp[1]) {
<a name="l00947"></a>00947                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a0b1707e97ce1a784fceb99ec5b5c5799">IPO_FLOAT</a>:
<a name="l00948"></a>00948                     <a class="code" href="../../db/dfd/key_8c.html#aeb8b93002db031fa1146c07aeebe821f">flerp</a>(3, (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)k1, (<span class="keywordtype">float</span> *)k2, (<span class="keywordtype">float</span> *)k3, (<span class="keywordtype">float</span> *)k4, t);
<a name="l00949"></a>00949                     <span class="keywordflow">break</span>;
<a name="l00950"></a>00950                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#aff7a69eecef466496dacdc7a8b656799">IPO_BPOINT</a>:
<a name="l00951"></a>00951                     <a class="code" href="../../db/dfd/key_8c.html#aeb8b93002db031fa1146c07aeebe821f">flerp</a>(4, (<span class="keywordtype">float</span> *)poin, (<span class="keywordtype">float</span> *)k1, (<span class="keywordtype">float</span> *)k2, (<span class="keywordtype">float</span> *)k3, (<span class="keywordtype">float</span> *)k4, t);
<a name="l00952"></a>00952                     <span class="keywordflow">break</span>;
<a name="l00953"></a>00953                 <span class="keywordflow">case</span> <a class="code" href="../../db/dfd/key_8c.html#a46843e0a422a245d3fa7404f5f990b53">IPO_BEZTRIPLE</a>:
<a name="l00954"></a>00954                     <a class="code" href="../../db/dfd/key_8c.html#aeb8b93002db031fa1146c07aeebe821f">flerp</a>(12, (<span class="keywordtype">void</span> *)poin, (<span class="keywordtype">void</span> *)k1, (<span class="keywordtype">void</span> *)k2, (<span class="keywordtype">void</span> *)k3, (<span class="keywordtype">void</span> *)k4, t);
<a name="l00955"></a>00955                     <span class="keywordflow">break</span>;
<a name="l00956"></a>00956                 <span class="keywordflow">default</span>:
<a name="l00957"></a>00957                     <span class="comment">/* should never happen */</span>
<a name="l00958"></a>00958                     <span class="keywordflow">if</span> (freek1) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek1);
<a name="l00959"></a>00959                     <span class="keywordflow">if</span> (freek2) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek2);
<a name="l00960"></a>00960                     <span class="keywordflow">if</span> (freek3) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek3);
<a name="l00961"></a>00961                     <span class="keywordflow">if</span> (freek4) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek4);
<a name="l00962"></a>00962                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;invalid &#39;cp[1]&#39;&quot;</span>);
<a name="l00963"></a>00963                     <span class="keywordflow">return</span>;
<a name="l00964"></a>00964             }
<a name="l00965"></a>00965             
<a name="l00966"></a>00966             poin += *ofsp;
<a name="l00967"></a>00967             cp += 2;
<a name="l00968"></a>00968             ofsp++;
<a name="l00969"></a>00969         }
<a name="l00970"></a>00970         <span class="comment">/* lets do it the difficult way: when keys have a different size */</span>
<a name="l00971"></a>00971         <span class="keywordflow">if</span> (flagdo &amp; 1) {
<a name="l00972"></a>00972             <span class="keywordflow">if</span> (flagflo &amp; 1) {
<a name="l00973"></a>00973                 k1tot += k1d;
<a name="l00974"></a>00974                 <span class="keywordflow">while</span> (k1tot &gt;= 1.0f) {
<a name="l00975"></a>00975                     k1tot -= 1.0f;
<a name="l00976"></a>00976                     k1 += elemsize;
<a name="l00977"></a>00977                 }
<a name="l00978"></a>00978             }
<a name="l00979"></a>00979             <span class="keywordflow">else</span> k1 += elemsize;
<a name="l00980"></a>00980         }
<a name="l00981"></a>00981         <span class="keywordflow">if</span> (flagdo &amp; 2) {
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (flagflo &amp; 2) {
<a name="l00983"></a>00983                 k2tot += k2d;
<a name="l00984"></a>00984                 <span class="keywordflow">while</span> (k2tot &gt;= 1.0f) {
<a name="l00985"></a>00985                     k2tot -= 1.0f;
<a name="l00986"></a>00986                     k2 += elemsize;
<a name="l00987"></a>00987                 }
<a name="l00988"></a>00988             }
<a name="l00989"></a>00989             <span class="keywordflow">else</span> k2 += elemsize;
<a name="l00990"></a>00990         }
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (flagdo &amp; 4) {
<a name="l00992"></a>00992             <span class="keywordflow">if</span> (flagflo &amp; 4) {
<a name="l00993"></a>00993                 k3tot += k3d;
<a name="l00994"></a>00994                 <span class="keywordflow">while</span> (k3tot &gt;= 1.0f) {
<a name="l00995"></a>00995                     k3tot -= 1.0f;
<a name="l00996"></a>00996                     k3 += elemsize;
<a name="l00997"></a>00997                 }
<a name="l00998"></a>00998             }
<a name="l00999"></a>00999             <span class="keywordflow">else</span> k3 += elemsize;
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001         <span class="keywordflow">if</span> (flagdo &amp; 8) {
<a name="l01002"></a>01002             <span class="keywordflow">if</span> (flagflo &amp; 8) {
<a name="l01003"></a>01003                 k4tot += k4d;
<a name="l01004"></a>01004                 <span class="keywordflow">while</span> (k4tot &gt;= 1.0f) {
<a name="l01005"></a>01005                     k4tot -= 1.0f;
<a name="l01006"></a>01006                     k4 += elemsize;
<a name="l01007"></a>01007                 }
<a name="l01008"></a>01008             }
<a name="l01009"></a>01009             <span class="keywordflow">else</span> k4 += elemsize;
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011         
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) a += 2;
<a name="l01013"></a>01013     }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="keywordflow">if</span> (freek1) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek1);
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (freek2) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek2);
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (freek3) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek3);
<a name="l01018"></a>01018     <span class="keywordflow">if</span> (freek4) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(freek4);
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a><a class="code" href="../../db/dfd/key_8c.html#ad0d85858070b1056ae4ad65949e6d9ad">01021</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../db/dfd/key_8c.html#ad0d85858070b1056ae4ad65949e6d9ad">get_weights_array</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">char</span> *vgroup)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01024"></a>01024     <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01025"></a>01025     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l01026"></a>01026     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l01027"></a>01027     <span class="keywordtype">int</span> totvert = 0, defgrp_index = 0;
<a name="l01028"></a>01028     
<a name="l01029"></a>01029     <span class="comment">/* no vgroup string set? */</span>
<a name="l01030"></a>01030     <span class="keywordflow">if</span> (vgroup[0] == 0) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01031"></a>01031     
<a name="l01032"></a>01032     <span class="comment">/* gather dvert and totvert */</span>
<a name="l01033"></a>01033     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01034"></a>01034         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01035"></a>01035         dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l01036"></a>01036         totvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a> &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a> == totvert)
<a name="l01039"></a>01039             em = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>;
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l01042"></a>01042         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01043"></a>01043         dvert = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>;
<a name="l01044"></a>01044         totvert = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046     
<a name="l01047"></a>01047     <span class="keywordflow">if</span> (dvert == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01048"></a>01048     
<a name="l01049"></a>01049     <span class="comment">/* find the group (weak loop-in-loop) */</span>
<a name="l01050"></a>01050     defgrp_index = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a>(ob, vgroup);
<a name="l01051"></a>01051     <span class="keywordflow">if</span> (defgrp_index &gt;= 0) {
<a name="l01052"></a>01052         <span class="keywordtype">float</span> *weights;
<a name="l01053"></a>01053         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01054"></a>01054         
<a name="l01055"></a>01055         weights = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totvert * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;weights&quot;</span>);
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (em) {
<a name="l01058"></a>01058             eve = <a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#aba8c82365003c5fcbb34bbcb4e50f8f6" title="Iterator New.">BM_iter_new</a>(&amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01059"></a>01059             <span class="keywordflow">for</span> (i = 0; eve; eve = <a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#a0fc839bb30650592541b47e20669a995" title="Iterator Step.">BM_iter_step</a>(&amp;iter), i++) {
<a name="l01060"></a>01060                 dvert = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abd885f96566fa49036c6219d971cc809">CustomData_bmesh_get</a>(&amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a3d10124795ce1025cd86a29fb3c8819c">vdata</a>, eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#ae60b9e519f421cdd79d5e3309853d7f5">head</a>.<a class="code" href="../../d5/d3a/structBMHeader.html#aab6fc118de69cdb678fe6aaba4ec75be">data</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                 <span class="keywordflow">if</span> (dvert) {
<a name="l01063"></a>01063                     weights[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, defgrp_index);
<a name="l01064"></a>01064                 }
<a name="l01065"></a>01065             }
<a name="l01066"></a>01066         }
<a name="l01067"></a>01067         <span class="keywordflow">else</span> {
<a name="l01068"></a>01068             <span class="keywordflow">for</span> (i = 0; i &lt; totvert; i++, dvert++) {
<a name="l01069"></a>01069                 weights[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, defgrp_index);
<a name="l01070"></a>01070             }
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073         <span class="keywordflow">return</span> weights;
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01076"></a>01076 }
<a name="l01077"></a>01077 
<a name="l01078"></a><a class="code" href="../../db/dfd/key_8c.html#ad9f020a575251ebb23284bb7a855e26b">01078</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#ad9f020a575251ebb23284bb7a855e26b">do_mesh_key</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l01079"></a>01079 {
<a name="l01080"></a>01080     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *k[4], *actkb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a26244a6d5d7d9e93fd37f59e56fd075d">ob_get_keyblock</a>(ob);
<a name="l01081"></a>01081     <span class="keywordtype">float</span> t[4];
<a name="l01082"></a>01082     <span class="keywordtype">int</span> flag = 0;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a> &amp;&amp; key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> != <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01085"></a>01085         <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01086"></a>01086         <span class="keywordtype">float</span> delta = (float)key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a> / tot;
<a name="l01087"></a>01087         <span class="keywordtype">float</span> cfra = (<span class="keywordtype">float</span>)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l01088"></a>01088         <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, a;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (tot &gt; 100 &amp;&amp; <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a>) {
<a name="l01091"></a>01091             step = tot / 50;
<a name="l01092"></a>01092             delta *= <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01093"></a>01093             <span class="comment">/* in do_key and cp_key the case a&gt;tot is handled */</span>
<a name="l01094"></a>01094         }
<a name="l01095"></a>01095         <span class="keywordflow">else</span> {
<a name="l01096"></a>01096             step = 1;
<a name="l01097"></a>01097         }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099         <span class="keywordflow">for</span> (a = 0; a &lt; tot; a += <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, cfra += delta) {
<a name="l01100"></a>01100             flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01101"></a>01101 
<a name="l01102"></a>01102             <span class="keywordflow">if</span> (flag == 0)
<a name="l01103"></a>01103                 <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(a, a + step, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01104"></a>01104             <span class="keywordflow">else</span>
<a name="l01105"></a>01105                 <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(a, a + step, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01106"></a>01106         }
<a name="l01107"></a>01107     }
<a name="l01108"></a>01108     <span class="keywordflow">else</span> {
<a name="l01109"></a>01109         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01110"></a>01110             <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01111"></a>01111             <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l01112"></a>01112                 kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../db/dfd/key_8c.html#ad0d85858070b1056ae4ad65949e6d9ad">get_weights_array</a>(ob, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac81e208e863f96a52e3ac4e6814e2318">vgroup</a>);
<a name="l01113"></a>01113             }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115             <a class="code" href="../../d5/d17/BKE__key_8h.html#a52493fc3f81d3c3c943a4773e4a3bf75">do_rel_key</a>(0, tot, tot, (<span class="keywordtype">char</span> *)out, key, actkb, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01116"></a>01116             
<a name="l01117"></a>01117             <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l01118"></a>01118                 <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a>);
<a name="l01119"></a>01119                 kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01120"></a>01120             }
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122         <span class="keywordflow">else</span> {
<a name="l01123"></a>01123             <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127             <span class="keywordflow">if</span> (flag == 0)
<a name="l01128"></a>01128                 <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(0, tot, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01129"></a>01129             <span class="keywordflow">else</span>
<a name="l01130"></a>01130                 <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(0, tot, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133 }
<a name="l01134"></a>01134 
<a name="l01135"></a><a class="code" href="../../db/dfd/key_8c.html#ad8d17ae3c982fc1ba8c19321e45b1838">01135</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#ad8d17ae3c982fc1ba8c19321e45b1838">do_cu_key</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> **k, <span class="keywordtype">float</span> *t, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01138"></a>01138     <span class="keywordtype">int</span> a, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01139"></a>01139     
<a name="l01140"></a>01140     <span class="keywordflow">for</span> (a = 0, nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>, a += step) {
<a name="l01141"></a>01141         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>) {
<a name="l01142"></a>01142             step = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01143"></a>01143             <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(a, a + step, tot, out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">KEY_MODE_BPOINT</a>);
<a name="l01144"></a>01144         }
<a name="l01145"></a>01145         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01146"></a>01146             step = 3 * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01147"></a>01147             <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(a, a + step, tot, out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>);
<a name="l01148"></a>01148         }
<a name="l01149"></a>01149         <span class="keywordflow">else</span> {
<a name="l01150"></a>01150             step = 0;
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153 }
<a name="l01154"></a>01154 
<a name="l01155"></a><a class="code" href="../../db/dfd/key_8c.html#a7caabe788889226379389c9236a2a27b">01155</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#a7caabe788889226379389c9236a2a27b">do_rel_cu_key</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l01156"></a>01156 {
<a name="l01157"></a>01157     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01158"></a>01158     <span class="keywordtype">int</span> a, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01159"></a>01159     
<a name="l01160"></a>01160     <span class="keywordflow">for</span> (a = 0, nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>, a += step) {
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>) {
<a name="l01162"></a>01162             step = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01163"></a>01163             <a class="code" href="../../d5/d17/BKE__key_8h.html#a52493fc3f81d3c3c943a4773e4a3bf75">do_rel_key</a>(a, a + step, tot, out, key, actkb, <a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">KEY_MODE_BPOINT</a>);
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01166"></a>01166             step = 3 * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01167"></a>01167             <a class="code" href="../../d5/d17/BKE__key_8h.html#a52493fc3f81d3c3c943a4773e4a3bf75">do_rel_key</a>(a, a + step, tot, out, key, actkb, <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>);
<a name="l01168"></a>01168         }
<a name="l01169"></a>01169         <span class="keywordflow">else</span> {
<a name="l01170"></a>01170             step = 0;
<a name="l01171"></a>01171         }
<a name="l01172"></a>01172     }
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a><a class="code" href="../../db/dfd/key_8c.html#a916245d4b854935546e5acabb5ad4f1b">01175</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#a916245d4b854935546e5acabb5ad4f1b">do_curve_key</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l01176"></a>01176 {
<a name="l01177"></a>01177     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01178"></a>01178     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *k[4], *actkb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a26244a6d5d7d9e93fd37f59e56fd075d">ob_get_keyblock</a>(ob);
<a name="l01179"></a>01179     <span class="keywordtype">float</span> t[4];
<a name="l01180"></a>01180     <span class="keywordtype">int</span> flag = 0;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a> &amp;&amp; key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> != <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01183"></a>01183         <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01184"></a>01184         <span class="keywordtype">float</span> delta = (float)key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a> / tot;
<a name="l01185"></a>01185         <span class="keywordtype">float</span> cfra = (<span class="keywordtype">float</span>)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l01186"></a>01186         <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01187"></a>01187         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, remain = 0;
<a name="l01188"></a>01188         <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>, a;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="keywordflow">if</span> (tot &gt; 100 &amp;&amp; <a class="code" href="../../d5/d17/BKE__key_8h.html#a0215bf9aa271a28383bf20f1b135e1f6">slurph_opt</a>) {
<a name="l01191"></a>01191             step = tot / 50;
<a name="l01192"></a>01192             delta *= <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01193"></a>01193             <span class="comment">/* in do_key and cp_key the case a&gt;tot has been handled */</span>
<a name="l01194"></a>01194         }
<a name="l01195"></a>01195         <span class="keywordflow">else</span> {
<a name="l01196"></a>01196             step = 1;
<a name="l01197"></a>01197         }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199         <span class="keywordflow">for</span> (nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>) {
<a name="l01200"></a>01200             <span class="keywordtype">int</span> estep, mode;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202             <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>) {
<a name="l01203"></a>01203                 mode = <a class="code" href="../../db/dfd/key_8c.html#a51e068ab6aa477a510fea1b083b86dc5">KEY_MODE_BPOINT</a>;
<a name="l01204"></a>01204                 estep = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01205"></a>01205             }
<a name="l01206"></a>01206             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01207"></a>01207                 mode = <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>;
<a name="l01208"></a>01208                 estep = 3 * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01209"></a>01209             }
<a name="l01210"></a>01210             <span class="keywordflow">else</span> {
<a name="l01211"></a>01211                 mode = 0;
<a name="l01212"></a>01212                 estep = 0;
<a name="l01213"></a>01213             }
<a name="l01214"></a>01214 
<a name="l01215"></a>01215             a = 0;
<a name="l01216"></a>01216             <span class="keywordflow">while</span> (a &lt; estep) {
<a name="l01217"></a>01217                 <span class="keywordtype">int</span> count;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219                 <span class="keywordflow">if</span> (remain &lt;= 0) {
<a name="l01220"></a>01220                     cfra += delta;
<a name="l01221"></a>01221                     flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223                     remain = <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01224"></a>01224                 }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226                 count = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(remain, estep);
<a name="l01227"></a>01227                 <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dfd/key_8c.html#ab0fd4cc2652e119dd35ad3a2c789db8c">KEY_MODE_BEZTRIPLE</a>) {
<a name="l01228"></a>01228                     count += 3 - count % 3;
<a name="l01229"></a>01229                 }
<a name="l01230"></a>01230 
<a name="l01231"></a>01231                 <span class="keywordflow">if</span> (flag == 0)
<a name="l01232"></a>01232                     <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(i, i + count, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k, t, mode);
<a name="l01233"></a>01233                 <span class="keywordflow">else</span>
<a name="l01234"></a>01234                     <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(i, i + count, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mode);
<a name="l01235"></a>01235 
<a name="l01236"></a>01236                 a += count;
<a name="l01237"></a>01237                 i += count;
<a name="l01238"></a>01238                 remain -= count;
<a name="l01239"></a>01239             }
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242     <span class="keywordflow">else</span> {
<a name="l01243"></a>01243         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01244"></a>01244             <a class="code" href="../../db/dfd/key_8c.html#a7caabe788889226379389c9236a2a27b">do_rel_cu_key</a>(cu, cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a8d1d301aab8386698526ed56362ff284">key</a>, actkb, out, tot);
<a name="l01245"></a>01245         }
<a name="l01246"></a>01246         <span class="keywordflow">else</span> {
<a name="l01247"></a>01247             <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249             flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01250"></a>01250 
<a name="l01251"></a>01251             <span class="keywordflow">if</span> (flag == 0) <a class="code" href="../../db/dfd/key_8c.html#ad8d17ae3c982fc1ba8c19321e45b1838">do_cu_key</a>(cu, key, actkb, k, t, out, tot);
<a name="l01252"></a>01252             <span class="keywordflow">else</span> <a class="code" href="../../db/dfd/key_8c.html#aee016abb3d9e1e716790e6c14292b376">cp_cu_key</a>(cu, key, actkb, k[2], 0, tot, out, tot);
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a><a class="code" href="../../db/dfd/key_8c.html#a26d3789d52f1bc7b694cf6e3be494970">01257</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dfd/key_8c.html#a26d3789d52f1bc7b694cf6e3be494970">do_latt_key</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keywordtype">char</span> *out, <span class="keyword">const</span> <span class="keywordtype">int</span> tot)
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259     <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01260"></a>01260     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *k[4], *actkb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a26244a6d5d7d9e93fd37f59e56fd075d">ob_get_keyblock</a>(ob);
<a name="l01261"></a>01261     <span class="keywordtype">float</span> t[4];
<a name="l01262"></a>01262     <span class="keywordtype">int</span> flag;
<a name="l01263"></a>01263     
<a name="l01264"></a>01264     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a>  &amp;&amp; key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> != <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01265"></a>01265         <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01266"></a>01266         <span class="keywordtype">float</span> delta = (float)key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a2f924c527393143d62af4b2f82758504">slurph</a> / tot;
<a name="l01267"></a>01267         <span class="keywordtype">float</span> cfra = (<span class="keywordtype">float</span>)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l01268"></a>01268         <span class="keywordtype">int</span> a;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270         <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++, cfra += delta) {
<a name="l01271"></a>01271             flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01272"></a>01272 
<a name="l01273"></a>01273             <span class="keywordflow">if</span> (flag == 0)
<a name="l01274"></a>01274                 <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(a, a + 1, tot, out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01275"></a>01275             <span class="keywordflow">else</span>
<a name="l01276"></a>01276                 <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(a, a + 1, tot, out, key, actkb, k[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01277"></a>01277         }       
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279     <span class="keywordflow">else</span> {
<a name="l01280"></a>01280         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>) {
<a name="l01281"></a>01281             <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01282"></a>01282             
<a name="l01283"></a>01283             <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>)
<a name="l01284"></a>01284                 kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../db/dfd/key_8c.html#ad0d85858070b1056ae4ad65949e6d9ad">get_weights_array</a>(ob, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac81e208e863f96a52e3ac4e6814e2318">vgroup</a>);
<a name="l01285"></a>01285             
<a name="l01286"></a>01286             <a class="code" href="../../d5/d17/BKE__key_8h.html#a52493fc3f81d3c3c943a4773e4a3bf75">do_rel_key</a>(0, tot, tot, out, key, actkb, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01287"></a>01287             
<a name="l01288"></a>01288             <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l01289"></a>01289                 <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a>);
<a name="l01290"></a>01290                 kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01291"></a>01291             }
<a name="l01292"></a>01292         }
<a name="l01293"></a>01293         <span class="keywordflow">else</span> {
<a name="l01294"></a>01294             <span class="keyword">const</span> <span class="keywordtype">float</span> ctime_scaled = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01295"></a>01295             
<a name="l01296"></a>01296             flag = <a class="code" href="../../db/dfd/key_8c.html#ad1c4e12eba4572ac457ecfd8d2cf818a">setkeys</a>(ctime_scaled, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, k, t, 0);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298             <span class="keywordflow">if</span> (flag == 0)
<a name="l01299"></a>01299                 <a class="code" href="../../db/dfd/key_8c.html#a86f4e3ce89bfefc80ab38650355fe608">do_key</a>(0, tot, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k, t, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01300"></a>01300             <span class="keywordflow">else</span>
<a name="l01301"></a>01301                 <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(0, tot, tot, (<span class="keywordtype">char</span> *)out, key, actkb, k[2], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dfd/key_8c.html#ac75d64c0261362951f89a586da6dc593">KEY_MODE_DUMMY</a>);
<a name="l01302"></a>01302         }
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304     
<a name="l01305"></a>01305     <span class="keywordflow">if</span> (lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a63710ce306e2b866557d2af57fe75329">flag</a> &amp; <a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html#a88fd8efda477754bb80253fa2c1dbcfa">LT_OUTSIDE</a>) <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#af8fa82e4d9685bebc121ed33dad3d8c1">outside_lattice</a>(lt);
<a name="l01306"></a>01306 }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308 <span class="comment">/* returns key coordinates (+ tilt) when key applied, NULL otherwise */</span>
<a name="l01309"></a><a class="code" href="../../db/dfd/key_8c.html#af6fa4d9cce2e51183f99e3f3a331abb6">01309</a> <span class="keywordtype">float</span> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a00aef18c696764e52dc4d919812c90b2">do_ob_key</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01310"></a>01310 {
<a name="l01311"></a>01311     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l01312"></a>01312     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *actkb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a26244a6d5d7d9e93fd37f59e56fd075d">ob_get_keyblock</a>(ob);
<a name="l01313"></a>01313     <span class="keywordtype">char</span> *out;
<a name="l01314"></a>01314     <span class="keywordtype">int</span> tot = 0, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = 0;
<a name="l01315"></a>01315     
<a name="l01316"></a>01316     <span class="keywordflow">if</span> (key == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01317"></a>01317         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="comment">/* compute size of output array */</span>
<a name="l01320"></a>01320     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01321"></a>01321         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323         tot = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01324"></a>01324         <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = tot * 3 * <span class="keyword">sizeof</span>(float);
<a name="l01325"></a>01325     }
<a name="l01326"></a>01326     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l01327"></a>01327         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         tot = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01330"></a>01330         <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = tot * 3 * <span class="keyword">sizeof</span>(float);
<a name="l01331"></a>01331     }
<a name="l01332"></a>01332     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01333"></a>01333         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01334"></a>01334         <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336         <span class="keywordflow">for</span> (nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nu; nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>) {
<a name="l01337"></a>01337             <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01338"></a>01338                 tot += 3 * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01339"></a>01339                 <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> += nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * 12 * <span class="keyword">sizeof</span>(float);
<a name="l01340"></a>01340             }
<a name="l01341"></a>01341             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>) {
<a name="l01342"></a>01342                 tot += nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01343"></a>01343                 <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> += nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a> * 12 * <span class="keyword">sizeof</span>(float);
<a name="l01344"></a>01344             }
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="comment">/* if nothing to interpolate, cancel */</span>
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (tot == 0 || <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> == 0)
<a name="l01350"></a>01350         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01351"></a>01351     
<a name="l01352"></a>01352     <span class="comment">/* allocate array */</span>
<a name="l01353"></a>01353     out = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="stringliteral">&quot;do_ob_key out&quot;</span>);
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <span class="comment">/* prevent python from screwing this up? anyhoo, the from pointer could be dropped */</span>
<a name="l01356"></a>01356     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a10821be2b17cc3b647d74f40c307e75f">from</a> = (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01357"></a>01357         
<a name="l01358"></a>01358     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af406445af536997110fc334c24854005">shapeflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ad1667fc11fcfbed9a6bef142eeae94ee">OB_SHAPE_LOCK</a>) {
<a name="l01359"></a>01359         <span class="comment">/* shape locked, copy the locked shape instead of blending */</span>
<a name="l01360"></a>01360         <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a> - 1);
<a name="l01361"></a>01361         
<a name="l01362"></a>01362         <span class="keywordflow">if</span> (kb &amp;&amp; (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a293ff458065155efca63b30b33387982">flag</a> &amp; <a class="code" href="../../de/d41/DNA__key__types_8h.html#af77d65ab56b38a820b1efc0bcafbd4fba985fc22c3c56f56ac76bbc3328d20350">KEYBLOCK_MUTE</a>))
<a name="l01363"></a>01363             kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (kb == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01366"></a>01366             kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01367"></a>01367             ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a> = 1;
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369         
<a name="l01370"></a>01370         <span class="keywordflow">if</span> (<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#adc5de6700d88c01f86b3edca9daea011">OB_TYPE_SUPPORT_VGROUP</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>)) {
<a name="l01371"></a>01371             <span class="keywordtype">float</span> *weights = <a class="code" href="../../db/dfd/key_8c.html#ad0d85858070b1056ae4ad65949e6d9ad">get_weights_array</a>(ob, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac81e208e863f96a52e3ac4e6814e2318">vgroup</a>);
<a name="l01372"></a>01372 
<a name="l01373"></a>01373             <a class="code" href="../../db/dfd/key_8c.html#ac325c0b1b6107c5d4b7422da10330eb5">cp_key</a>(0, tot, tot, out, key, actkb, kb, weights, 0);
<a name="l01374"></a>01374 
<a name="l01375"></a>01375             <span class="keywordflow">if</span> (weights) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(weights);
<a name="l01376"></a>01376         }
<a name="l01377"></a>01377         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>))
<a name="l01378"></a>01378             <a class="code" href="../../db/dfd/key_8c.html#aee016abb3d9e1e716790e6c14292b376">cp_cu_key</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, key, actkb, kb, 0, tot, out, tot);
<a name="l01379"></a>01379     }
<a name="l01380"></a>01380     <span class="keywordflow">else</span> {
<a name="l01381"></a>01381         <span class="comment">/* do shapekey local drivers */</span>
<a name="l01382"></a>01382         <span class="keywordtype">float</span> ctime = (float)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>; <span class="comment">// XXX this needs to be checked</span>
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>, key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a9e6219935b7f5b387610055b81705180">adt</a>, ctime, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8af8b60644f7baff691944ebfdb8b39d03">ADT_RECALC_DRIVERS</a>);
<a name="l01385"></a>01385         
<a name="l01386"></a>01386         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) <a class="code" href="../../db/dfd/key_8c.html#ad9f020a575251ebb23284bb7a855e26b">do_mesh_key</a>(scene, ob, key, out, tot);
<a name="l01387"></a>01387         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) <a class="code" href="../../db/dfd/key_8c.html#a26d3789d52f1bc7b694cf6e3be494970">do_latt_key</a>(scene, ob, key, out, tot);
<a name="l01388"></a>01388         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>) <a class="code" href="../../db/dfd/key_8c.html#a916245d4b854935546e5acabb5ad4f1b">do_curve_key</a>(scene, ob, key, out, tot);
<a name="l01389"></a>01389         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>) <a class="code" href="../../db/dfd/key_8c.html#a916245d4b854935546e5acabb5ad4f1b">do_curve_key</a>(scene, ob, key, out, tot);
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391     
<a name="l01392"></a>01392     <span class="keywordflow">return</span> (<span class="keywordtype">float</span> *)out;
<a name="l01393"></a>01393 }
<a name="l01394"></a>01394 
<a name="l01395"></a><a class="code" href="../../db/dfd/key_8c.html#a970e4c1d99ed8dbe152a4b3f93347bb4">01395</a> <a class="code" href="../../d1/d9e/structKey.html">Key</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01396"></a>01396 {
<a name="l01397"></a>01397     <span class="keywordflow">if</span> (ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01398"></a>01398     
<a name="l01399"></a>01399     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01400"></a>01400         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01401"></a>01401         <span class="keywordflow">return</span> me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>;
<a name="l01402"></a>01402     }
<a name="l01403"></a>01403     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01404"></a>01404         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01405"></a>01405         <span class="keywordflow">return</span> cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a8d1d301aab8386698526ed56362ff284">key</a>;
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l01408"></a>01408         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01409"></a>01409         <span class="keywordflow">return</span> lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>;
<a name="l01410"></a>01410     }
<a name="l01411"></a>01411     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a><a class="code" href="../../db/dfd/key_8c.html#a82c0c71b19a5a186f0d043777d860593">01414</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a118d62c847e0e2e8423ee54247fd3128">add_keyblock</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l01415"></a>01415 {
<a name="l01416"></a>01416     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01417"></a>01417     <span class="keywordtype">float</span> curpos = -0.1;
<a name="l01418"></a>01418     <span class="keywordtype">int</span> tot;
<a name="l01419"></a>01419     
<a name="l01420"></a>01420     kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (kb) curpos = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a>;
<a name="l01422"></a>01422     
<a name="l01423"></a>01423     kb = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a>), <span class="stringliteral">&quot;Keyblock&quot;</span>);
<a name="l01424"></a>01424     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb);
<a name="l01425"></a>01425     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ae8b1e5e50e83d51fab75b15ae7bbfc83">type</a> = <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa7d099df7300f79faa4419f6a0cc18a61">KEY_CARDINAL</a>;
<a name="l01426"></a>01426     
<a name="l01427"></a>01427     tot = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>);
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (name) {
<a name="l01429"></a>01429         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, name, <span class="keyword">sizeof</span>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>));
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431     <span class="keywordflow">else</span> {
<a name="l01432"></a>01432         <span class="keywordflow">if</span> (tot == 1) <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, <span class="stringliteral">&quot;Basis&quot;</span>, <span class="keyword">sizeof</span>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>));
<a name="l01433"></a>01433         <span class="keywordflow">else</span> <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, <span class="keyword">sizeof</span>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>), <span class="stringliteral">&quot;Key %d&quot;</span>, tot - 1);
<a name="l01434"></a>01434     }
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb, <span class="stringliteral">&quot;Key&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, offsetof(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a>, name), <span class="keyword">sizeof</span>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>));
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a> = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a56223c7671e8b6a1be37882e473de9c2">uidgen</a>++;
<a name="l01439"></a>01439 
<a name="l01440"></a>01440     key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a21e6fccec22d25490e947c74e127f2e7">totkey</a>++;
<a name="l01441"></a>01441     <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a21e6fccec22d25490e947c74e127f2e7">totkey</a> == 1) key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a> = kb;
<a name="l01442"></a>01442     
<a name="l01443"></a>01443     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a8e5b8c77a2cd0917bec223fe2c95700d">slidermin</a> = 0.0f;
<a name="l01444"></a>01444     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a6988c26f75f263effa622fcac6a2b618">slidermax</a> = 1.0f;
<a name="l01445"></a>01445 
<a name="l01449"></a>01449     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> = curpos + 0.1f; <span class="comment">/* only used for absolute shape keys */</span>
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="keywordflow">return</span> kb;
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01460"></a><a class="code" href="../../db/dfd/key_8c.html#a8ac8878543381e9c93c7cf07006246eb">01460</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#ab40da3682111d17ee24a4829b0cceea8">add_keyblock_ctime</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">short</span> do_force)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a118d62c847e0e2e8423ee54247fd3128">add_keyblock</a>(key, name);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (do_force || (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> != <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>)) {
<a name="l01465"></a>01465         kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a30d1c415748a559e944e1bc6bb69b064">ctime</a> / 100.0f;
<a name="l01466"></a>01466         <a class="code" href="../../d5/d17/BKE__key_8h.html#a461870559eb59936b3057cbed2b105ac">sort_keys</a>(key);
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="keywordflow">return</span> kb;
<a name="l01470"></a>01470 }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472 <span class="comment">/* only the active keyblock */</span>
<a name="l01473"></a><a class="code" href="../../db/dfd/key_8c.html#a33fd8dd1e7a7898f28fbdb30d8e455ea">01473</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a26244a6d5d7d9e93fd37f59e56fd075d">ob_get_keyblock</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob) 
<a name="l01474"></a>01474 {
<a name="l01475"></a>01475     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l01476"></a>01476     
<a name="l01477"></a>01477     <span class="keywordflow">if</span> (key) {
<a name="l01478"></a>01478         <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a> - 1);
<a name="l01479"></a>01479         <span class="keywordflow">return</span> kb;
<a name="l01480"></a>01480     }
<a name="l01481"></a>01481 
<a name="l01482"></a>01482     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01483"></a>01483 }
<a name="l01484"></a>01484 
<a name="l01485"></a><a class="code" href="../../db/dfd/key_8c.html#a09bb0be5889b750af252a5e0d7863f0d">01485</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#af936a6b9eee029705fe5f02f54bf9f3d">ob_get_reference_keyblock</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l01488"></a>01488     
<a name="l01489"></a>01489     <span class="keywordflow">if</span> (key)
<a name="l01490"></a>01490         <span class="keywordflow">return</span> key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a>;
<a name="l01491"></a>01491 
<a name="l01492"></a>01492     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01493"></a>01493 }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 <span class="comment">/* get the appropriate KeyBlock given an index */</span>
<a name="l01496"></a><a class="code" href="../../db/dfd/key_8c.html#a5b7807e2004fc005949dc3ed92f91cbc">01496</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a73a6a2a7acd66ef711953753e3df14a5">key_get_keyblock</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keywordtype">int</span> index)
<a name="l01497"></a>01497 {
<a name="l01498"></a>01498     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01499"></a>01499     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01500"></a>01500     
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (key) {
<a name="l01502"></a>01502         kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01503"></a>01503         
<a name="l01504"></a>01504         <span class="keywordflow">for</span> (i = 1; i &lt; key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a21e6fccec22d25490e947c74e127f2e7">totkey</a>; i++) {
<a name="l01505"></a>01505             kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>;
<a name="l01506"></a>01506             
<a name="l01507"></a>01507             <span class="keywordflow">if</span> (index == i)
<a name="l01508"></a>01508                 <span class="keywordflow">return</span> kb;
<a name="l01509"></a>01509         }
<a name="l01510"></a>01510     }
<a name="l01511"></a>01511     
<a name="l01512"></a>01512     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01513"></a>01513 }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515 <span class="comment">/* get the appropriate KeyBlock given a name to search for */</span>
<a name="l01516"></a><a class="code" href="../../db/dfd/key_8c.html#a931bfe7775737b0cfdaab4f1c1002f62">01516</a> <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *<a class="code" href="../../d5/d17/BKE__key_8h.html#a0b9d3a0e7ee3c7208fac589ebed998a8">key_get_named_keyblock</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> name[])
<a name="l01517"></a>01517 {
<a name="l01518"></a>01518     <span class="keywordflow">if</span> (key &amp;&amp; name)
<a name="l01519"></a>01519         <span class="keywordflow">return</span> <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a07f40c87b9211c9d5fef01d4a4e9054d">BLI_findstring</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, name, offsetof(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a>, name));
<a name="l01520"></a>01520     
<a name="l01521"></a>01521     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01522"></a>01522 }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524 <span class="comment">/* Get RNA-Path for &#39;value&#39; setting of the given ShapeKey </span>
<a name="l01525"></a>01525 <span class="comment"> * NOTE: the user needs to free the returned string once they&#39;re finish with it</span>
<a name="l01526"></a>01526 <span class="comment"> */</span>
<a name="l01527"></a><a class="code" href="../../db/dfd/key_8c.html#afa1765bd6b92d47182d636701edcc148">01527</a> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d17/BKE__key_8h.html#ab9ddd1a6f395165723cfe02451d3e19a">key_get_curValue_rnaPath</a>(<a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb)
<a name="l01528"></a>01528 {
<a name="l01529"></a>01529     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr;
<a name="l01530"></a>01530     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01531"></a>01531     
<a name="l01532"></a>01532     <span class="comment">/* sanity checks */</span>
<a name="l01533"></a>01533     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, key, kb))
<a name="l01534"></a>01534         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01535"></a>01535     
<a name="l01536"></a>01536     <span class="comment">/* create the RNA pointer */</span>
<a name="l01537"></a>01537     <a class="code" href="../../d3/d10/rna__access_8c.html#a1f8fb80da9a6450a51ab2e9b97264f01">RNA_pointer_create</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a243b6055ad9f91e7878cead653cf50d9">RNA_ShapeKey</a>, kb, &amp;ptr);
<a name="l01538"></a>01538     <span class="comment">/* get pointer to the property too */</span>
<a name="l01539"></a>01539     prop = <a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(&amp;ptr, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01540"></a>01540     
<a name="l01541"></a>01541     <span class="comment">/* return the path */</span>
<a name="l01542"></a>01542     <span class="keywordflow">return</span> <a class="code" href="../../d3/d10/rna__access_8c.html#a66bdb30aeb21c0607ca3a0453e1d99eb">RNA_path_from_ID_to_property</a>(&amp;ptr, prop);
<a name="l01543"></a>01543 }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="comment">/* conversion functions */</span>
<a name="l01547"></a>01547 
<a name="l01548"></a>01548 <span class="comment">/************************* Lattice ************************/</span>
<a name="l01549"></a><a class="code" href="../../db/dfd/key_8c.html#a6017a0b98c131cc992cacd863bdeb9e8">01549</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a32fe55ad95f50fddba3ba9163c0a6f2f">latt_to_key</a>(<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01552"></a>01552     <span class="keywordtype">float</span> *fp;
<a name="l01553"></a>01553     <span class="keywordtype">int</span> a, tot;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     tot = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01556"></a>01556     <span class="keywordflow">if</span> (tot == 0) <span class="keywordflow">return</span>;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558     <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> * tot, <span class="stringliteral">&quot;kb-&gt;data&quot;</span>);
<a name="l01561"></a>01561     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = tot;
<a name="l01562"></a>01562 
<a name="l01563"></a>01563     bp = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l01564"></a>01564     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01565"></a>01565     <span class="keywordflow">for</span> (a = 0; a &lt; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>; a++, fp += 3, bp++) {
<a name="l01566"></a>01566         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>);
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568 }
<a name="l01569"></a>01569 
<a name="l01570"></a><a class="code" href="../../db/dfd/key_8c.html#aee9e1c0db37ac9264b9a752e0a5e1915">01570</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a9c9042802c9c906c8f886bec8b8089d3">key_to_latt</a>(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt)
<a name="l01571"></a>01571 {
<a name="l01572"></a>01572     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01573"></a>01573     <span class="keywordtype">float</span> *fp;
<a name="l01574"></a>01574     <span class="keywordtype">int</span> a, tot;
<a name="l01575"></a>01575 
<a name="l01576"></a>01576     bp = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#ae3dc9dd9304be3f153fa96f155d9c7de">def</a>;
<a name="l01577"></a>01577     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01578"></a>01578 
<a name="l01579"></a>01579     tot = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01580"></a>01580     tot = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>, tot);
<a name="l01581"></a>01581 
<a name="l01582"></a>01582     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++, fp += 3, bp++) {
<a name="l01583"></a>01583         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>, fp);
<a name="l01584"></a>01584     }
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="comment">/************************* Curve ************************/</span>
<a name="l01588"></a><a class="code" href="../../db/dfd/key_8c.html#acec08e55bcfaf2f5713c28409048fc0a">01588</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a2a958e06a37b6bb9ee0b4c49002a3d07">curve_to_key</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *nurb)
<a name="l01589"></a>01589 {
<a name="l01590"></a>01590     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01591"></a>01591     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l01592"></a>01592     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01593"></a>01593     <span class="keywordtype">float</span> *fp;
<a name="l01594"></a>01594     <span class="keywordtype">int</span> a, tot;
<a name="l01595"></a>01595 
<a name="l01596"></a>01596     <span class="comment">/* count */</span>
<a name="l01597"></a>01597     tot = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#acbc43d8687324817662e3f0e713b514a">count_curveverts</a>(nurb);
<a name="l01598"></a>01598     <span class="keywordflow">if</span> (tot == 0) <span class="keywordflow">return</span>;
<a name="l01599"></a>01599 
<a name="l01600"></a>01600     <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a8d1d301aab8386698526ed56362ff284">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> * tot, <span class="stringliteral">&quot;kb-&gt;data&quot;</span>);
<a name="l01603"></a>01603     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = tot;
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     nu = nurb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01606"></a>01606     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01607"></a>01607     <span class="keywordflow">while</span> (nu) {
<a name="l01608"></a>01608 
<a name="l01609"></a>01609         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01610"></a>01610             bezt = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>;
<a name="l01611"></a>01611             a = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01612"></a>01612             <span class="keywordflow">while</span> (a--) {
<a name="l01613"></a>01613                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0]);
<a name="l01614"></a>01614                 fp += 3;
<a name="l01615"></a>01615                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1]);
<a name="l01616"></a>01616                 fp += 3;
<a name="l01617"></a>01617                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2]);
<a name="l01618"></a>01618                 fp += 3;
<a name="l01619"></a>01619                 fp[0] = bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a57809f14651bb33bfe7e564ea864cde6">alfa</a>;
<a name="l01620"></a>01620                 fp += 3; <span class="comment">/* alphas */</span>
<a name="l01621"></a>01621                 bezt++;
<a name="l01622"></a>01622             }
<a name="l01623"></a>01623         }
<a name="l01624"></a>01624         <span class="keywordflow">else</span> {
<a name="l01625"></a>01625             bp = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>;
<a name="l01626"></a>01626             a = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01627"></a>01627             <span class="keywordflow">while</span> (a--) {
<a name="l01628"></a>01628                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>);
<a name="l01629"></a>01629                 fp[3] = bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a1210ec737d6ced5cf276e22e8ca277f8">alfa</a>;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631                 fp += 4;
<a name="l01632"></a>01632                 bp++;
<a name="l01633"></a>01633             }
<a name="l01634"></a>01634         }
<a name="l01635"></a>01635         nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>;
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637 }
<a name="l01638"></a>01638 
<a name="l01639"></a><a class="code" href="../../db/dfd/key_8c.html#afef037c5197e9065da161dac343bcfb3">01639</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#ad7a0f070f892507a7feacf533d1bcb82">key_to_curve</a>(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <a class="code" href="../../da/d10/structCurve.html">Curve</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cu), <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *nurb)
<a name="l01640"></a>01640 {
<a name="l01641"></a>01641     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu;
<a name="l01642"></a>01642     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l01643"></a>01643     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01644"></a>01644     <span class="keywordtype">float</span> *fp;
<a name="l01645"></a>01645     <span class="keywordtype">int</span> a, tot;
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     nu = nurb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01648"></a>01648     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     tot = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#acbc43d8687324817662e3f0e713b514a">count_curveverts</a>(nurb);
<a name="l01651"></a>01651 
<a name="l01652"></a>01652     tot = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>, tot);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     <span class="keywordflow">while</span> (nu &amp;&amp; tot &gt; 0) {
<a name="l01655"></a>01655 
<a name="l01656"></a>01656         <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) {
<a name="l01657"></a>01657             bezt = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>;
<a name="l01658"></a>01658             a = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a>;
<a name="l01659"></a>01659             <span class="keywordflow">while</span> (a-- &amp;&amp; tot &gt; 0) {
<a name="l01660"></a>01660                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0], fp);
<a name="l01661"></a>01661                 fp += 3;
<a name="l01662"></a>01662                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1], fp);
<a name="l01663"></a>01663                 fp += 3;
<a name="l01664"></a>01664                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2], fp);
<a name="l01665"></a>01665                 fp += 3;
<a name="l01666"></a>01666                 bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a57809f14651bb33bfe7e564ea864cde6">alfa</a> = fp[0];
<a name="l01667"></a>01667                 fp += 3; <span class="comment">/* alphas */</span>
<a name="l01668"></a>01668 
<a name="l01669"></a>01669                 tot -= 3;
<a name="l01670"></a>01670                 bezt++;
<a name="l01671"></a>01671             }
<a name="l01672"></a>01672         }
<a name="l01673"></a>01673         <span class="keywordflow">else</span> {
<a name="l01674"></a>01674             bp = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>;
<a name="l01675"></a>01675             a = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> * nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a>;
<a name="l01676"></a>01676             <span class="keywordflow">while</span> (a-- &amp;&amp; tot &gt; 0) {
<a name="l01677"></a>01677                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>, fp);
<a name="l01678"></a>01678                 bp-&gt;<a class="code" href="../../d9/d51/structBPoint.html#a1210ec737d6ced5cf276e22e8ca277f8">alfa</a> = fp[3];
<a name="l01679"></a>01679 
<a name="l01680"></a>01680                 fp += 4;
<a name="l01681"></a>01681                 tot--;
<a name="l01682"></a>01682                 bp++;
<a name="l01683"></a>01683             }
<a name="l01684"></a>01684         }
<a name="l01685"></a>01685         nu = nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>;
<a name="l01686"></a>01686     }
<a name="l01687"></a>01687 }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689 <span class="comment">/************************* Mesh ************************/</span>
<a name="l01690"></a><a class="code" href="../../db/dfd/key_8c.html#ad0fe7f5079ddcb4bb5a95b5ce6d8ef7c">01690</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a8ec9247863e7792c9cb12f6e075341f6">mesh_to_key</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb)
<a name="l01691"></a>01691 {
<a name="l01692"></a>01692     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l01693"></a>01693     <span class="keywordtype">float</span> *fp;
<a name="l01694"></a>01694     <span class="keywordtype">int</span> a;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> == 0) <span class="keywordflow">return</span>;
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a> * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;kb-&gt;data&quot;</span>);
<a name="l01701"></a>01701     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l01704"></a>01704     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01705"></a>01705     <span class="keywordflow">for</span> (a = 0; a &lt; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>; a++, fp += 3, mvert++) {
<a name="l01706"></a>01706         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01707"></a>01707 
<a name="l01708"></a>01708     }
<a name="l01709"></a>01709 }
<a name="l01710"></a>01710 
<a name="l01711"></a><a class="code" href="../../db/dfd/key_8c.html#a454f00314d2042a97f17691545f25e34">01711</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#aa638210d1b5a527144f7eee9dd8c5a47">key_to_mesh</a>(<a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l01712"></a>01712 {
<a name="l01713"></a>01713     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l01714"></a>01714     <span class="keywordtype">float</span> *fp;
<a name="l01715"></a>01715     <span class="keywordtype">int</span> a, tot;
<a name="l01716"></a>01716 
<a name="l01717"></a>01717     mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l01718"></a>01718     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01719"></a>01719 
<a name="l01720"></a>01720     tot = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++, fp += 3, mvert++) {
<a name="l01723"></a>01723         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, fp);
<a name="l01724"></a>01724     }
<a name="l01725"></a>01725 }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727 <span class="comment">/************************* vert coords ************************/</span>
<a name="l01728"></a><a class="code" href="../../db/dfd/key_8c.html#a8ee653663df9607da2903692910b8ad1">01728</a> float (*<a class="code" href="../../d5/d17/BKE__key_8h.html#a2eb2d4e471ef54f5c5e20ed84cd1fde4">key_to_vertcos</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> * ob, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> * kb))[3]
<a name="l01729"></a>01729 {
<a name="l01730"></a>01730     float (*vertCos)[3], *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l01731"></a>01731     <span class="keywordtype">float</span> *fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01732"></a>01732     <span class="keywordtype">int</span> tot = 0, a;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734     <span class="comment">/* Count of vertex coords in array */</span>
<a name="l01735"></a>01735     <span class="keywordflow">if</span> (ob-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01736"></a>01736         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;data;
<a name="l01737"></a>01737         tot = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01738"></a>01738     }
<a name="l01739"></a>01739     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l01740"></a>01740         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = (<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *)ob-&gt;data;
<a name="l01741"></a>01741         tot = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01742"></a>01742     }
<a name="l01743"></a>01743     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;type, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01744"></a>01744         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ob-&gt;data;
<a name="l01745"></a>01745         tot = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#acbc43d8687324817662e3f0e713b514a">count_curveverts</a>(&amp;cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>);
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="keywordflow">if</span> (tot == 0) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01749"></a>01749 
<a name="l01750"></a>01750     vertCos = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(tot * <span class="keyword">sizeof</span>(*vertCos), <span class="stringliteral">&quot;key_to_vertcos vertCos&quot;</span>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752     <span class="comment">/* Copy coords to array */</span>
<a name="l01753"></a>01753     <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = (<span class="keywordtype">float</span> *)vertCos;
<a name="l01754"></a>01754 
<a name="l01755"></a>01755     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;type, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) {
<a name="l01756"></a>01756         <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++, fp += 3, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> += 3) {
<a name="l01757"></a>01757             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, fp);
<a name="l01758"></a>01758         }
<a name="l01759"></a>01759     }
<a name="l01760"></a>01760     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;type, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01761"></a>01761         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ob-&gt;data;
<a name="l01762"></a>01762         <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01763"></a>01763         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l01764"></a>01764         <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766         while (nu) {
<a name="l01767"></a>01767             <span class="keywordflow">if</span> (nu-&gt;bezt) {
<a name="l01768"></a>01768                 <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01769"></a>01769                 bezt = nu-&gt;bezt;
<a name="l01770"></a>01770                 a = nu-&gt;pntsu;
<a name="l01771"></a>01771 
<a name="l01772"></a>01772                 <span class="keywordflow">while</span> (a--) {
<a name="l01773"></a>01773                     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l01774"></a>01774                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, fp);
<a name="l01775"></a>01775                         fp += 3; <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> += 3;
<a name="l01776"></a>01776                     }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778                     fp += 3; <span class="comment">/* skip alphas */</span>
<a name="l01779"></a>01779 
<a name="l01780"></a>01780                     bezt++;
<a name="l01781"></a>01781                 }
<a name="l01782"></a>01782             }
<a name="l01783"></a>01783             <span class="keywordflow">else</span> {
<a name="l01784"></a>01784                 bp = nu-&gt;bp;
<a name="l01785"></a>01785                 a = nu-&gt;pntsu * nu-&gt;pntsv;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787                 <span class="keywordflow">while</span> (a--) {
<a name="l01788"></a>01788                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, fp);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790                     fp += 4;
<a name="l01791"></a>01791                     <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> += 3;
<a name="l01792"></a>01792 
<a name="l01793"></a>01793                     bp++;
<a name="l01794"></a>01794                 }
<a name="l01795"></a>01795             }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797             nu = nu-&gt;next;
<a name="l01798"></a>01798         }
<a name="l01799"></a>01799     }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <span class="keywordflow">return</span> vertCos;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a><a class="code" href="../../db/dfd/key_8c.html#a1869ac1d2b9181e6c7e0a32eacef3a63">01804</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a7be3f9f64a261eb6e167e4aaa1a8c72e">vertcos_to_key</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <span class="keywordtype">float</span> (*vertCos)[3])
<a name="l01805"></a>01805 {
<a name="l01806"></a>01806     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = (<span class="keywordtype">float</span> *)vertCos, *fp;
<a name="l01807"></a>01807     <span class="keywordtype">int</span> tot = 0, a, elemsize;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809     <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01810"></a>01810 
<a name="l01811"></a>01811     <span class="comment">/* Count of vertex coords in array */</span>
<a name="l01812"></a>01812     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l01813"></a>01813         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01814"></a>01814         tot = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01815"></a>01815         elemsize = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l01816"></a>01816     }
<a name="l01817"></a>01817     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>) {
<a name="l01818"></a>01818         <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = (<a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01819"></a>01819         tot = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a> * lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l01820"></a>01820         elemsize = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a17c6975adcc7144ed734252d6038b7d5">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l01821"></a>01821     }
<a name="l01822"></a>01822     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01823"></a>01823         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01824"></a>01824         elemsize = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a8d1d301aab8386698526ed56362ff284">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>;
<a name="l01825"></a>01825         tot = <a class="code" href="../../d7/dfc/BKE__curve_8h.html#acbc43d8687324817662e3f0e713b514a">count_curveverts</a>(&amp;cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>);
<a name="l01826"></a>01826     }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828     <span class="keywordflow">if</span> (tot == 0) {
<a name="l01829"></a>01829         kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01830"></a>01830         <span class="keywordflow">return</span>;
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(tot * elemsize, <span class="stringliteral">&quot;key_to_vertcos vertCos&quot;</span>);
<a name="l01834"></a>01834 
<a name="l01835"></a>01835     <span class="comment">/* Copy coords to keyblock */</span>
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) {
<a name="l01838"></a>01838         <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++, fp += 3, co += 3) {
<a name="l01839"></a>01839             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, co);
<a name="l01840"></a>01840         }
<a name="l01841"></a>01841     }
<a name="l01842"></a>01842     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01843"></a>01843         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01844"></a>01844         <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01845"></a>01845         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l01846"></a>01846         <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01847"></a>01847 
<a name="l01848"></a>01848         while (nu) {
<a name="l01849"></a>01849             <span class="keywordflow">if</span> (nu-&gt;bezt) {
<a name="l01850"></a>01850                 <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01851"></a>01851                 bezt = nu-&gt;bezt;
<a name="l01852"></a>01852                 a = nu-&gt;pntsu;
<a name="l01853"></a>01853 
<a name="l01854"></a>01854                 <span class="keywordflow">while</span> (a--) {
<a name="l01855"></a>01855                     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l01856"></a>01856                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, co);
<a name="l01857"></a>01857                         fp += 3; co += 3;
<a name="l01858"></a>01858                     }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860                     fp += 3; <span class="comment">/* skip alphas */</span>
<a name="l01861"></a>01861 
<a name="l01862"></a>01862                     bezt++;
<a name="l01863"></a>01863                 }
<a name="l01864"></a>01864             }
<a name="l01865"></a>01865             <span class="keywordflow">else</span> {
<a name="l01866"></a>01866                 bp = nu-&gt;bp;
<a name="l01867"></a>01867                 a = nu-&gt;pntsu * nu-&gt;pntsv;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869                 <span class="keywordflow">while</span> (a--) {
<a name="l01870"></a>01870                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, co);
<a name="l01871"></a>01871 
<a name="l01872"></a>01872                     fp += 4;
<a name="l01873"></a>01873                     co += 3;
<a name="l01874"></a>01874 
<a name="l01875"></a>01875                     bp++;
<a name="l01876"></a>01876                 }
<a name="l01877"></a>01877             }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879             nu = nu-&gt;next;
<a name="l01880"></a>01880         }
<a name="l01881"></a>01881     }
<a name="l01882"></a>01882 }
<a name="l01883"></a>01883 
<a name="l01884"></a><a class="code" href="../../db/dfd/key_8c.html#ae26872cb82a8ef2142bb2b3124454d40">01884</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d17/BKE__key_8h.html#a3d08fecd31d9c7b74c8d5a544bb8e693">offset_to_key</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, <span class="keywordtype">float</span> (*ofs)[3])
<a name="l01885"></a>01885 {
<a name="l01886"></a>01886     <span class="keywordtype">int</span> a;
<a name="l01887"></a>01887     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = (<span class="keywordtype">float</span> *)ofs, *fp = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) {
<a name="l01890"></a>01890         <span class="keywordflow">for</span> (a = 0; a &lt; kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>; a++, fp += 3, co += 3) {
<a name="l01891"></a>01891             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(fp, co);
<a name="l01892"></a>01892         }
<a name="l01893"></a>01893     }
<a name="l01894"></a>01894     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ae247d3ec6e691b7752d8a90065428ecb">OB_SURF</a>)) {
<a name="l01895"></a>01895         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01896"></a>01896         <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01897"></a>01897         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l01898"></a>01898         <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l01899"></a>01899 
<a name="l01900"></a>01900         while (nu) {
<a name="l01901"></a>01901             <span class="keywordflow">if</span> (nu-&gt;bezt) {
<a name="l01902"></a>01902                 <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01903"></a>01903                 bezt = nu-&gt;bezt;
<a name="l01904"></a>01904                 a = nu-&gt;pntsu;
<a name="l01905"></a>01905 
<a name="l01906"></a>01906                 <span class="keywordflow">while</span> (a--) {
<a name="l01907"></a>01907                     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l01908"></a>01908                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(fp, co);
<a name="l01909"></a>01909                         fp += 3; co += 3;
<a name="l01910"></a>01910                     }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912                     fp += 3; <span class="comment">/* skip alphas */</span>
<a name="l01913"></a>01913 
<a name="l01914"></a>01914                     bezt++;
<a name="l01915"></a>01915                 }
<a name="l01916"></a>01916             }
<a name="l01917"></a>01917             <span class="keywordflow">else</span> {
<a name="l01918"></a>01918                 bp = nu-&gt;bp;
<a name="l01919"></a>01919                 a = nu-&gt;pntsu * nu-&gt;pntsv;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921                 <span class="keywordflow">while</span> (a--) {
<a name="l01922"></a>01922                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(fp, co);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924                     fp += 4;
<a name="l01925"></a>01925                     co += 3;
<a name="l01926"></a>01926 
<a name="l01927"></a>01927                     bp++;
<a name="l01928"></a>01928                 }
<a name="l01929"></a>01929             }
<a name="l01930"></a>01930 
<a name="l01931"></a>01931             nu = nu-&gt;next;
<a name="l01932"></a>01932         }
<a name="l01933"></a>01933     }
<a name="l01934"></a>01934 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:27 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
