<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: nla.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">nla.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/dee/nla_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2009 Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Joshua Leung (full recode)</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dd9/BLI__path__util_8h.html">BLI_path_util.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d3e/BLI__listbase_8h.html">BLI_listbase.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db3/BLI__string_8h.html">BLI_string.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d66/DNA__sound__types_8h.html">DNA_sound_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../da/de4/DNA__speaker__types_8h.html">DNA_speaker_types.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dba/BKE__fcurve_8h.html">BKE_fcurve.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/de6/BKE__nla_8h.html">BKE_nla.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#ifdef WITH_AUDASPACE</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#  include &quot;<a class="code" href="../../da/d82/AUD__C-API_8h.html">AUD_C-API.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dcb/nla__private_8h.html">nla_private.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/* *************************************************** */</span>
<a name="l00069"></a>00069 <span class="comment">/* Data Management */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* Freeing ------------------------------------------- */</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">/* Remove the given NLA strip from the NLA track it occupies, free the strip&#39;s data,</span>
<a name="l00074"></a>00074 <span class="comment"> * and the strip itself. </span>
<a name="l00075"></a>00075 <span class="comment"> */</span>
<a name="l00076"></a><a class="code" href="../../db/dee/nla_8c.html#a9cad790cd112707db72bbd7669138c00">00076</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9c17a5e4c234227445423938413224a2">free_nlastrip</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l00077"></a>00077 {
<a name="l00078"></a>00078     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *cs, *csn;
<a name="l00079"></a>00079     
<a name="l00080"></a>00080     <span class="comment">/* sanity checks */</span>
<a name="l00081"></a>00081     <span class="keywordflow">if</span> (strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00082"></a>00082         <span class="keywordflow">return</span>;
<a name="l00083"></a>00083         
<a name="l00084"></a>00084     <span class="comment">/* free child-strips */</span>
<a name="l00085"></a>00085     <span class="keywordflow">for</span> (cs= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; cs; cs= csn) {
<a name="l00086"></a>00086         csn= cs-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00087"></a>00087         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9c17a5e4c234227445423938413224a2">free_nlastrip</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, cs);
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089         
<a name="l00090"></a>00090     <span class="comment">/* remove reference to action */</span>
<a name="l00091"></a>00091     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>)
<a name="l00092"></a>00092         <a class="code" href="../../d8/db1/BKE__library_8h.html#a2caead3c3bda9441d1a4affbbe0d328b">id_us_min</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>);
<a name="l00093"></a>00093         
<a name="l00094"></a>00094     <span class="comment">/* free remapping info */</span>
<a name="l00095"></a>00095     <span class="comment">//if (strip-&gt;remap)</span>
<a name="l00096"></a>00096     <span class="comment">//  BKE_animremap_free();</span>
<a name="l00097"></a>00097     
<a name="l00098"></a>00098     <span class="comment">/* free own F-Curves */</span>
<a name="l00099"></a>00099     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab62d82f0242ead6ce4d83cf4e5d26774">free_fcurves</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>);
<a name="l00100"></a>00100     
<a name="l00101"></a>00101     <span class="comment">/* free own F-Modifiers */</span>
<a name="l00102"></a>00102     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ada226703127f86a28c14e4fcc807b0e6">free_fmodifiers</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac5ddce08df422b81dfa7a65674b5b296">modifiers</a>);
<a name="l00103"></a>00103     
<a name="l00104"></a>00104     <span class="comment">/* free the strip itself */</span>
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (strips)
<a name="l00106"></a>00106         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(strips, strip);
<a name="l00107"></a>00107     <span class="keywordflow">else</span>
<a name="l00108"></a>00108         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(strip);
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/* Remove the given NLA track from the set of NLA tracks, free the track&#39;s data,</span>
<a name="l00112"></a>00112 <span class="comment"> * and the track itself.</span>
<a name="l00113"></a>00113 <span class="comment"> */</span>
<a name="l00114"></a><a class="code" href="../../db/dee/nla_8c.html#a6ba602c746464f05d48a7b7d140799ed">00114</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9effeb926203dc7a7a0bdd5a725fbd21">free_nlatrack</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>, <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *stripn;
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <span class="comment">/* sanity checks */</span>
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (nlt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00120"></a>00120         <span class="keywordflow">return</span>;
<a name="l00121"></a>00121         
<a name="l00122"></a>00122     <span class="comment">/* free strips */</span>
<a name="l00123"></a>00123     <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= stripn) {
<a name="l00124"></a>00124         stripn= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00125"></a>00125         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9c17a5e4c234227445423938413224a2">free_nlastrip</a>(&amp;nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>, strip);
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     <span class="comment">/* free NLA track itself now */</span>
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (tracks)
<a name="l00130"></a>00130         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(tracks, nlt);
<a name="l00131"></a>00131     <span class="keywordflow">else</span>
<a name="l00132"></a>00132         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nlt);
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">/* Free the elements of type NLA Tracks provided in the given list, but do not free</span>
<a name="l00136"></a>00136 <span class="comment"> * the list itself since that is not free-standing</span>
<a name="l00137"></a>00137 <span class="comment"> */</span>
<a name="l00138"></a><a class="code" href="../../db/dee/nla_8c.html#aae3aa682cc0c34da60be6b69f059ae3f">00138</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#aae3aa682cc0c34da60be6b69f059ae3f">free_nladata</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, *nltn;
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     <span class="comment">/* sanity checks */</span>
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tracks, tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00144"></a>00144         <span class="keywordflow">return</span>;
<a name="l00145"></a>00145         
<a name="l00146"></a>00146     <span class="comment">/* free tracks one by one */</span>
<a name="l00147"></a>00147     <span class="keywordflow">for</span> (nlt= tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nltn) {
<a name="l00148"></a>00148         nltn= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>;
<a name="l00149"></a>00149         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9effeb926203dc7a7a0bdd5a725fbd21">free_nlatrack</a>(tracks, nlt);
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151     
<a name="l00152"></a>00152     <span class="comment">/* clear the list&#39;s pointers to be safe */</span>
<a name="l00153"></a>00153     tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/* Copying ------------------------------------------- */</span>
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">/* Copy NLA strip */</span>
<a name="l00159"></a><a class="code" href="../../db/dee/nla_8c.html#a41cde6212981b985e537ed50fbbbd3b1">00159</a> <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#ab724547257209551fc5a46059f73fec1">copy_nlastrip</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip_d;
<a name="l00162"></a>00162     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *cs, *cs_d;
<a name="l00163"></a>00163     
<a name="l00164"></a>00164     <span class="comment">/* sanity check */</span>
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00166"></a>00166         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00167"></a>00167         
<a name="l00168"></a>00168     <span class="comment">/* make a copy */</span>
<a name="l00169"></a>00169     strip_d= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(strip);
<a name="l00170"></a>00170     strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>= strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00171"></a>00171     
<a name="l00172"></a>00172     <span class="comment">/* increase user-count of action */</span>
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>)
<a name="l00174"></a>00174         <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>);
<a name="l00175"></a>00175         
<a name="l00176"></a>00176     <span class="comment">/* copy F-Curves and modifiers */</span>
<a name="l00177"></a>00177     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a73ae7909c6fa074a6ac39cf13cfa27c5">copy_fcurves</a>(&amp;strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, &amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>);
<a name="l00178"></a>00178     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a95962d86693b5a728216f9e2ba797cdc">copy_fmodifiers</a>(&amp;strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac5ddce08df422b81dfa7a65674b5b296">modifiers</a>, &amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac5ddce08df422b81dfa7a65674b5b296">modifiers</a>);
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     <span class="comment">/* make a copy of all the child-strips, one at a time */</span>
<a name="l00181"></a>00181     strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00182"></a>00182     
<a name="l00183"></a>00183     <span class="keywordflow">for</span> (cs= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; cs; cs= cs-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00184"></a>00184         cs_d= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab724547257209551fc5a46059f73fec1">copy_nlastrip</a>(cs);
<a name="l00185"></a>00185         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;strip_d-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, cs_d);
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     
<a name="l00188"></a>00188     <span class="comment">/* return the strip */</span>
<a name="l00189"></a>00189     <span class="keywordflow">return</span> strip_d;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 <span class="comment">/* Copy NLA Track */</span>
<a name="l00193"></a><a class="code" href="../../db/dee/nla_8c.html#aa8aeaec6dffbbcd456ffd9109bc0a952">00193</a> <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#a5b510acae70622b4398cecddbedcf596">copy_nlatrack</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *strip_d;
<a name="l00196"></a>00196     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt_d;
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     <span class="comment">/* sanity check */</span>
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (nlt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00200"></a>00200         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00201"></a>00201         
<a name="l00202"></a>00202     <span class="comment">/* make a copy */</span>
<a name="l00203"></a>00203     nlt_d= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(nlt);
<a name="l00204"></a>00204     nlt_d-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>= nlt_d-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     <span class="comment">/* make a copy of all the strips, one at a time */</span>
<a name="l00207"></a>00207     nlt_d-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= nlt_d-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00208"></a>00208     
<a name="l00209"></a>00209     <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00210"></a>00210         strip_d= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab724547257209551fc5a46059f73fec1">copy_nlastrip</a>(strip);
<a name="l00211"></a>00211         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;nlt_d-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>, strip_d);
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     
<a name="l00214"></a>00214     <span class="comment">/* return the copy */</span>
<a name="l00215"></a>00215     <span class="keywordflow">return</span> nlt_d;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">/* Copy all NLA data */</span>
<a name="l00219"></a><a class="code" href="../../db/dee/nla_8c.html#a25f60371c63dda53214fd6bfc4f13374">00219</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a25f60371c63dda53214fd6bfc4f13374">copy_nladata</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *dst, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *src)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, *nlt_d;
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <span class="comment">/* sanity checks */</span>
<a name="l00224"></a>00224     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dst, src))
<a name="l00225"></a>00225         <span class="keywordflow">return</span>;
<a name="l00226"></a>00226         
<a name="l00227"></a>00227     <span class="comment">/* clear out the destination list first for precautions... */</span>
<a name="l00228"></a>00228     dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00229"></a>00229         
<a name="l00230"></a>00230     <span class="comment">/* copy each NLA-track, one at a time */</span>
<a name="l00231"></a>00231     <span class="keywordflow">for</span> (nlt= src-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l00232"></a>00232         <span class="comment">/* make a copy, and add the copy to the destination list */</span>
<a name="l00233"></a>00233         nlt_d= <a class="code" href="../../d9/de6/BKE__nla_8h.html#a5b510acae70622b4398cecddbedcf596">copy_nlatrack</a>(nlt);
<a name="l00234"></a>00234         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(dst, nlt_d);
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238 <span class="comment">/* Adding ------------------------------------------- */</span>
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="comment">/* Add a NLA Track to the given AnimData </span>
<a name="l00241"></a>00241 <span class="comment"> *  - prev: NLA-Track to add the new one after</span>
<a name="l00242"></a>00242 <span class="comment"> */</span>
<a name="l00243"></a><a class="code" href="../../db/dee/nla_8c.html#a87141fb2c1983b4f5c8db03324218dca">00243</a> <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#ade883909faa615e4f9aa88de3686d3ce">add_nlatrack</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *prev)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l00246"></a>00246     
<a name="l00247"></a>00247     <span class="comment">/* sanity checks */</span>
<a name="l00248"></a>00248     <span class="keywordflow">if</span> (adt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00249"></a>00249         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00250"></a>00250         
<a name="l00251"></a>00251     <span class="comment">/* allocate new track */</span>
<a name="l00252"></a>00252     nlt= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a>), <span class="stringliteral">&quot;NlaTrack&quot;</span>);
<a name="l00253"></a>00253     
<a name="l00254"></a>00254     <span class="comment">/* set settings requiring the track to not be part of the stack yet */</span>
<a name="l00255"></a>00255     nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba652dbd32d48ab3c2de7b3d748f5b359c">NLATRACK_SELECTED</a>;
<a name="l00256"></a>00256     nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#af3ab0b45892cb8dde7f345fcc2f3faa0">index</a>= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>);
<a name="l00257"></a>00257     
<a name="l00258"></a>00258     <span class="comment">/* add track to stack, and make it the active one */</span>
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (prev)
<a name="l00260"></a>00260         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a9c299678f8810312806da26e6132ccc7">BLI_insertlinkafter</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>, prev, nlt);
<a name="l00261"></a>00261     <span class="keywordflow">else</span>
<a name="l00262"></a>00262         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>, nlt);
<a name="l00263"></a>00263     <a class="code" href="../../d9/de6/BKE__nla_8h.html#af4811d5a8bab55e7cc04ec0e0f4d259e">BKE_nlatrack_set_active</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>, nlt);
<a name="l00264"></a>00264     
<a name="l00265"></a>00265     <span class="comment">/* must have unique name, but we need to seed this */</span>
<a name="l00266"></a>00266     strcpy(nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a9db0526fede88fb6cd696bac97c3a860">name</a>, <span class="stringliteral">&quot;NlaTrack&quot;</span>);
<a name="l00267"></a>00267     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>, nlt, <span class="stringliteral">&quot;NlaTrack&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, offsetof(<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a>, name), <span class="keyword">sizeof</span>(nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a9db0526fede88fb6cd696bac97c3a860">name</a>));
<a name="l00268"></a>00268     
<a name="l00269"></a>00269     <span class="comment">/* return the new track */</span>
<a name="l00270"></a>00270     <span class="keywordflow">return</span> nlt;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/* Add a NLA Strip referencing the given Action */</span>
<a name="l00274"></a><a class="code" href="../../db/dee/nla_8c.html#aad1f018190db7e0106ddea283bff8fe1">00274</a> <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#ac2ba7b495cb4b07a1eebff5950be650e">add_nlastrip</a> (<a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <span class="comment">/* sanity checks */</span>
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (act == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00280"></a>00280         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00281"></a>00281         
<a name="l00282"></a>00282     <span class="comment">/* allocate new strip */</span>
<a name="l00283"></a>00283     strip= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a>), <span class="stringliteral">&quot;NlaStrip&quot;</span>);
<a name="l00284"></a>00284     
<a name="l00285"></a>00285     <span class="comment">/* generic settings </span>
<a name="l00286"></a>00286 <span class="comment">     *  - selected flag to highlight this to the user</span>
<a name="l00287"></a>00287 <span class="comment">     *  - auto-blends to ensure that blend in/out values are automatically </span>
<a name="l00288"></a>00288 <span class="comment">     *    determined by overlaps of strips</span>
<a name="l00289"></a>00289 <span class="comment">     *  - (XXX) synchronization of strip-length in accordance with changes to action-length</span>
<a name="l00290"></a>00290 <span class="comment">     *    is not done though, since this should only really happens in editmode for strips now</span>
<a name="l00291"></a>00291 <span class="comment">     *    though this decision is still subject to further review...</span>
<a name="l00292"></a>00292 <span class="comment">     */</span>
<a name="l00293"></a>00293     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a5957e93f21fddd289ccc66ac78c37b06">NLASTRIP_FLAG_AUTO_BLENDS</a>;
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     <span class="comment">/* assign the action reference */</span>
<a name="l00296"></a>00296     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>= act;
<a name="l00297"></a>00297     <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;act-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>);
<a name="l00298"></a>00298     
<a name="l00299"></a>00299     <span class="comment">/* determine initial range </span>
<a name="l00300"></a>00300 <span class="comment">     *  - strip length cannot be 0... ever...</span>
<a name="l00301"></a>00301 <span class="comment">     */</span>
<a name="l00302"></a>00302     <a class="code" href="../../d8/df5/BKE__action_8h.html#a6dd77f727bc29b2d0f031af51605915c">calc_action_range</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>, &amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>, &amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a>, 0);
<a name="l00303"></a>00303     
<a name="l00304"></a>00304     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> = strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>;
<a name="l00305"></a>00305     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> = (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a>)) ?  (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a> + 1.0f): (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a>);
<a name="l00306"></a>00306     
<a name="l00307"></a>00307     <span class="comment">/* strip should be referenced as-is */</span>
<a name="l00308"></a>00308     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>= 1.0f;
<a name="l00309"></a>00309     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a> = 1.0f;
<a name="l00310"></a>00310     
<a name="l00311"></a>00311     <span class="comment">/* return the new strip */</span>
<a name="l00312"></a>00312     <span class="keywordflow">return</span> strip;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="comment">/* Add new NLA-strip to the top of the NLA stack - i.e. into the last track if space, or a new one otherwise */</span>
<a name="l00316"></a><a class="code" href="../../db/dee/nla_8c.html#a98d9899ad15886f01aad42fdcecbf258">00316</a> <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#ad00a15832cf63c7d618884854d660742">add_nlastrip_to_stack</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l00319"></a>00319     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l00320"></a>00320     
<a name="l00321"></a>00321     <span class="comment">/* sanity checks */</span>
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, act))
<a name="l00323"></a>00323         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="comment">/* create a new NLA strip */</span>
<a name="l00326"></a>00326     strip= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ac2ba7b495cb4b07a1eebff5950be650e">add_nlastrip</a>(act);
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00328"></a>00328         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00329"></a>00329     
<a name="l00330"></a>00330     <span class="comment">/* firstly try adding strip to last track, but if that fails, add to a new track */</span>
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (<a class="code" href="../../d9/de6/BKE__nla_8h.html#a15ed3c0b4de96436ec6938f4a2aae230">BKE_nlatrack_add_strip</a>(adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>, strip) == 0) {
<a name="l00332"></a>00332         <span class="comment">/* trying to add to the last track failed (no track or no space), </span>
<a name="l00333"></a>00333 <span class="comment">         * so add a new track to the stack, and add to that...</span>
<a name="l00334"></a>00334 <span class="comment">         */</span>
<a name="l00335"></a>00335         nlt= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ade883909faa615e4f9aa88de3686d3ce">add_nlatrack</a>(adt, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00336"></a>00336         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a15ed3c0b4de96436ec6938f4a2aae230">BKE_nlatrack_add_strip</a>(nlt, strip);
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     <span class="comment">/* automatically name it too */</span>
<a name="l00340"></a>00340     <a class="code" href="../../d9/de6/BKE__nla_8h.html#a3dc48bd590f3e9bde0afb153cf6901f4">BKE_nlastrip_validate_name</a>(adt, strip);
<a name="l00341"></a>00341     
<a name="l00342"></a>00342     <span class="comment">/* returns the strip added */</span>
<a name="l00343"></a>00343     <span class="keywordflow">return</span> strip;
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="comment">/* Add a NLA Strip referencing the given speaker&#39;s sound */</span>
<a name="l00347"></a><a class="code" href="../../db/dee/nla_8c.html#a39d1e17def9ed0962a7cb89eee4fdda8">00347</a> <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#a29ae7338f7790c6c899109c1801fbe14">add_nla_soundstrip</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d0/d89/structSpeaker.html">Speaker</a> *speaker)
<a name="l00348"></a>00348 {
<a name="l00349"></a>00349     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a>), <span class="stringliteral">&quot;NlaSoundStrip&quot;</span>);
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     <span class="comment">/* if speaker has a sound, set the strip length to the length of the sound,</span>
<a name="l00352"></a>00352 <span class="comment">     * otherwise default to length of 10 frames</span>
<a name="l00353"></a>00353 <span class="comment">     */</span>
<a name="l00354"></a>00354 <span class="preprocessor">#ifdef WITH_AUDASPACE</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (speaker-&gt;<a class="code" href="../../d0/d89/structSpeaker.html#ae00ffd6b3fc6085cc66731770ff837d5">sound</a>) {
<a name="l00356"></a>00356         <a class="code" href="../../de/d20/structAUD__SoundInfo.html" title="Sound information structure.">AUD_SoundInfo</a> info = <a class="code" href="../../d3/ddf/AUD__C-API_8cpp.html#acce640fe1c834e238214e6668344cf39">AUD_getInfo</a>(speaker-&gt;<a class="code" href="../../d0/d89/structSpeaker.html#ae00ffd6b3fc6085cc66731770ff837d5">sound</a>-&gt;<a class="code" href="../../d9/dc6/structbSound.html#a2ea38d5cfc68f03d0688cf03efc5300f">playback_handle</a>);
<a name="l00357"></a>00357         
<a name="l00358"></a>00358         strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> = (float)ceil((<span class="keywordtype">double</span>)info.<a class="code" href="../../de/d20/structAUD__SoundInfo.html#a7863073078bbd0969373a7a776639ff3">length</a> * <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac92ca5ab87034a348decad7ee8d4bd1b">FPS</a>);
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     <span class="keywordflow">else</span> 
<a name="l00361"></a>00361 <span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>    {
<a name="l00363"></a>00363         strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> = 10.0f;
<a name="l00364"></a>00364         <span class="comment">/* quiet compiler warnings */</span>
<a name="l00365"></a>00365         (void)scene;
<a name="l00366"></a>00366         (void)speaker;
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     
<a name="l00369"></a>00369     <span class="comment">/* general settings */</span>
<a name="l00370"></a>00370     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a075d5802024bf6ca7013d4e4ae9ae3d2">NLASTRIP_TYPE_SOUND</a>;
<a name="l00371"></a>00371     
<a name="l00372"></a>00372     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>;
<a name="l00373"></a>00373     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae9070ad94fcfc0d7372652845dcd363f">extendmode</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a837ca549d74cba2a0bd31859e64d9f1fa3f57b0eb6ff21d2c99646bb180375911">NLASTRIP_EXTEND_NOTHING</a>; <span class="comment">/* nothing to extend... */</span>
<a name="l00374"></a>00374     
<a name="l00375"></a>00375     <span class="comment">/* strip should be referenced as-is */</span>
<a name="l00376"></a>00376     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>= 1.0f;
<a name="l00377"></a>00377     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a> = 1.0f;
<a name="l00378"></a>00378     
<a name="l00379"></a>00379     <span class="comment">/* return this strip */</span>
<a name="l00380"></a>00380     <span class="keywordflow">return</span> strip;
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="comment">/* *************************************************** */</span>
<a name="l00384"></a>00384 <span class="comment">/* NLA Evaluation &lt;-&gt; Editing Stuff */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">/* Strip Mapping ------------------------------------- */</span>
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 <span class="comment">/* non clipped mapping for strip-time &lt;-&gt; global time (for Action-Clips)</span>
<a name="l00389"></a>00389 <span class="comment"> *  invert = convert action-strip time to global time </span>
<a name="l00390"></a>00390 <span class="comment"> */</span>
<a name="l00391"></a><a class="code" href="../../db/dee/nla_8c.html#a403bb49a4fc1dca8ef6c0add87a973e5">00391</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/dee/nla_8c.html#a403bb49a4fc1dca8ef6c0add87a973e5">nlastrip_get_frame_actionclip</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, <span class="keywordtype">float</span> cframe, <span class="keywordtype">short</span> mode)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393     <span class="keywordtype">float</span> actlength, scale;
<a name="l00394"></a>00394     <span class="comment">// float repeat; // UNUSED</span>
<a name="l00395"></a>00395     
<a name="l00396"></a>00396     <span class="comment">/* get number of repeats */</span>
<a name="l00397"></a>00397     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>, 0.0f)) strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a> = 1.0f;
<a name="l00398"></a>00398     <span class="comment">// repeat = strip-&gt;repeat; // UNUSED</span>
<a name="l00399"></a>00399     
<a name="l00400"></a>00400     <span class="comment">/* scaling */</span>
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>, 0.0f)) strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>= 1.0f;
<a name="l00402"></a>00402     scale = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>); <span class="comment">/* scale must be positive - we&#39;ve got a special flag for reversing */</span>
<a name="l00403"></a>00403     
<a name="l00404"></a>00404     <span class="comment">/* length of referenced action */</span>
<a name="l00405"></a>00405     actlength = strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a> - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>;
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(actlength, 0.0f)) actlength = 1.0f;
<a name="l00407"></a>00407     
<a name="l00408"></a>00408     <span class="comment">/* reversed = play strip backwards */</span>
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a5ed0f0458a20c99adeca613f83ddd807">NLASTRIP_FLAG_REVERSE</a>) {
<a name="l00410"></a>00410         <span class="comment">// FIXME: this won&#39;t work right with Graph Editor?</span>
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>) {
<a name="l00412"></a>00412             <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - scale*(cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>);
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>) {
<a name="l00415"></a>00415             <span class="keywordflow">return</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> + (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a> * scale - cframe)) / scale;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417         <span class="keywordflow">else</span> <span class="comment">/* if (mode == NLATIME_CONVERT_EVAL) */</span>{
<a name="l00418"></a>00418             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(cframe, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>, ((<span class="keywordtype">int</span>)strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>))) {
<a name="l00419"></a>00419                 <span class="comment">/* this case prevents the motion snapping back to the first frame at the end of the strip </span>
<a name="l00420"></a>00420 <span class="comment">                 * by catching the case where repeats is a whole number, which means that the end of the strip</span>
<a name="l00421"></a>00421 <span class="comment">                 * could also be interpreted as the end of the start of a repeat</span>
<a name="l00422"></a>00422 <span class="comment">                 */</span>
<a name="l00423"></a>00423                 <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>;
<a name="l00424"></a>00424             }
<a name="l00425"></a>00425             <span class="keywordflow">else</span> {
<a name="l00426"></a>00426                 <span class="comment">/* - the &#39;fmod(..., actlength*scale)&#39; is needed to get the repeats working</span>
<a name="l00427"></a>00427 <span class="comment">                 * - the &#39;/ scale&#39; is needed to ensure that scaling influences the timing within the repeat</span>
<a name="l00428"></a>00428 <span class="comment">                 */</span>
<a name="l00429"></a>00429                 <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a> - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, actlength*scale) / scale;
<a name="l00430"></a>00430             }
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433     <span class="keywordflow">else</span> {
<a name="l00434"></a>00434         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>) {
<a name="l00435"></a>00435             <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> + scale*(cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>);
<a name="l00436"></a>00436         }
<a name="l00437"></a>00437         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>) {
<a name="l00438"></a>00438             <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a> + (cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) / scale;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440         <span class="keywordflow">else</span> <span class="comment">/* if (mode == NLATIME_CONVERT_EVAL) */</span>{
<a name="l00441"></a>00441             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(cframe, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>, ((<span class="keywordtype">int</span>)strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>))) {
<a name="l00442"></a>00442                 <span class="comment">/* this case prevents the motion snapping back to the first frame at the end of the strip </span>
<a name="l00443"></a>00443 <span class="comment">                 * by catching the case where repeats is a whole number, which means that the end of the strip</span>
<a name="l00444"></a>00444 <span class="comment">                 * could also be interpreted as the end of the start of a repeat</span>
<a name="l00445"></a>00445 <span class="comment">                 */</span>
<a name="l00446"></a>00446                 <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a>;
<a name="l00447"></a>00447             }
<a name="l00448"></a>00448             <span class="keywordflow">else</span> {
<a name="l00449"></a>00449                 <span class="comment">/* - the &#39;fmod(..., actlength*scale)&#39; is needed to get the repeats working</span>
<a name="l00450"></a>00450 <span class="comment">                 * - the &#39;/ scale&#39; is needed to ensure that scaling influences the timing within the repeat</span>
<a name="l00451"></a>00451 <span class="comment">                 */</span>
<a name="l00452"></a>00452                 <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a> + <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a99d00034f7a5444b7f593b530f61c972">fmodf</a>(cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, actlength*scale) / scale;
<a name="l00453"></a>00453             }
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="comment">/* non clipped mapping for strip-time &lt;-&gt; global time (for Transitions)</span>
<a name="l00459"></a>00459 <span class="comment"> *  invert = convert action-strip time to global time </span>
<a name="l00460"></a>00460 <span class="comment"> */</span>
<a name="l00461"></a><a class="code" href="../../db/dee/nla_8c.html#a6db0413fa42d89d348446584f859540c">00461</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/dee/nla_8c.html#a6db0413fa42d89d348446584f859540c">nlastrip_get_frame_transition</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, <span class="keywordtype">float</span> cframe, <span class="keywordtype">short</span> mode)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="comment">/* length of strip */</span>
<a name="l00466"></a>00466     length= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     <span class="comment">/* reversed = play strip backwards */</span>
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a5ed0f0458a20c99adeca613f83ddd807">NLASTRIP_FLAG_REVERSE</a>) {
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>)
<a name="l00471"></a>00471             <span class="keywordflow">return</span> strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - (length * cframe);
<a name="l00472"></a>00472         <span class="keywordflow">else</span>
<a name="l00473"></a>00473             <span class="keywordflow">return</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - cframe) / <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475     <span class="keywordflow">else</span> {
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (mode == <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035da67b7b4a040b6e4341cfbb48b51f8dcc3">NLATIME_CONVERT_MAP</a>)
<a name="l00477"></a>00477             <span class="keywordflow">return</span> (length * cframe) + strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00478"></a>00478         <span class="keywordflow">else</span>
<a name="l00479"></a>00479             <span class="keywordflow">return</span> (cframe - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) / <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 <span class="comment">/* non clipped mapping for strip-time &lt;-&gt; global time</span>
<a name="l00484"></a>00484 <span class="comment"> *  mode = eNlaTime_ConvertModes[] -&gt; NLATIME_CONVERT_*</span>
<a name="l00485"></a>00485 <span class="comment"> *</span>
<a name="l00486"></a>00486 <span class="comment"> * only secure for &#39;internal&#39; (i.e. within AnimSys evaluation) operations,</span>
<a name="l00487"></a>00487 <span class="comment"> * but should not be directly relied on for stuff which interacts with editors</span>
<a name="l00488"></a>00488 <span class="comment"> */</span>
<a name="l00489"></a><a class="code" href="../../db/dcb/nla__private_8h.html#a014bad290540943f0a8b701539da0dd1">00489</a> <span class="keywordtype">float</span> <a class="code" href="../../db/dee/nla_8c.html#a014bad290540943f0a8b701539da0dd1">nlastrip_get_frame</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, <span class="keywordtype">float</span> cframe, <span class="keywordtype">short</span> mode)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491     <span class="keywordflow">switch</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a>) {
<a name="l00492"></a>00492         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a330575a46d56bc5ce45afa8b6b7d5bb2">NLASTRIP_TYPE_META</a>: <span class="comment">/* meta - for now, does the same as transition (is really just an empty container) */</span>
<a name="l00493"></a>00493         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a507ee0ba236e46280991034c41d9b61a">NLASTRIP_TYPE_TRANSITION</a>: <span class="comment">/* transition */</span>
<a name="l00494"></a>00494             <span class="keywordflow">return</span> <a class="code" href="../../db/dee/nla_8c.html#a6db0413fa42d89d348446584f859540c">nlastrip_get_frame_transition</a>(strip, cframe, mode);
<a name="l00495"></a>00495         
<a name="l00496"></a>00496         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55aea70130d952e36e417d38704d3299339">NLASTRIP_TYPE_CLIP</a>: <span class="comment">/* action-clip (default) */</span>
<a name="l00497"></a>00497         <span class="keywordflow">default</span>:
<a name="l00498"></a>00498             <span class="keywordflow">return</span> <a class="code" href="../../db/dee/nla_8c.html#a403bb49a4fc1dca8ef6c0add87a973e5">nlastrip_get_frame_actionclip</a>(strip, cframe, mode);
<a name="l00499"></a>00499     }   
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/* Non clipped mapping for strip-time &lt;-&gt; global time</span>
<a name="l00504"></a>00504 <span class="comment"> *  mode = eNlaTime_ConvertModesp[] -&gt; NLATIME_CONVERT_*</span>
<a name="l00505"></a>00505 <span class="comment"> *</span>
<a name="l00506"></a>00506 <span class="comment"> * Public API method - perform this mapping using the given AnimData block</span>
<a name="l00507"></a>00507 <span class="comment"> * and perform any necessary sanity checks on the value</span>
<a name="l00508"></a>00508 <span class="comment"> */</span>
<a name="l00509"></a><a class="code" href="../../db/dee/nla_8c.html#a032e19e8dd989196a9fa3d772f40dcb1">00509</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <span class="keywordtype">float</span> cframe, <span class="keywordtype">short</span> mode)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l00512"></a>00512     
<a name="l00513"></a>00513     <span class="comment">/* sanity checks </span>
<a name="l00514"></a>00514 <span class="comment">     *  - obviously we&#39;ve got to have some starting data</span>
<a name="l00515"></a>00515 <span class="comment">     *  - when not in tweakmode, the active Action does not have any scaling applied :)</span>
<a name="l00516"></a>00516 <span class="comment">     *  - when in tweakmode, if the no-mapping flag is set, do not map</span>
<a name="l00517"></a>00517 <span class="comment">     */</span>
<a name="l00518"></a>00518     <span class="keywordflow">if</span> ((adt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673afe405d4c0a7ffe9fd822f85904916a4c">ADT_NLA_EDIT_ON</a>)==0 || (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673ad0c0e332b4302cb56f46fe6b865c2a9b">ADT_NLA_EDIT_NOMAP</a>))
<a name="l00519"></a>00519         <span class="keywordflow">return</span> cframe;
<a name="l00520"></a>00520         
<a name="l00521"></a>00521     <span class="comment">/* if the active-strip info has been stored already, access this, otherwise look this up</span>
<a name="l00522"></a>00522 <span class="comment">     * and store for (very probable) future usage</span>
<a name="l00523"></a>00523 <span class="comment">     */</span>
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a1b15d57a11f3d46b6c1a92d879c5a44b">actstrip</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00525"></a>00525         <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ae692a35f2630c86624f8554e0053edf9">BKE_nlatrack_find_active</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>);
<a name="l00526"></a>00526         adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a1b15d57a11f3d46b6c1a92d879c5a44b">actstrip</a>= <a class="code" href="../../d9/de6/BKE__nla_8h.html#a815347026dc7ae0222cbcf11e18c362e">BKE_nlastrip_find_active</a>(nlt);
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528     strip= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a1b15d57a11f3d46b6c1a92d879c5a44b">actstrip</a>;
<a name="l00529"></a>00529     
<a name="l00530"></a>00530     <span class="comment">/* sanity checks </span>
<a name="l00531"></a>00531 <span class="comment">     *  - in rare cases, we may not be able to find this strip for some reason (internal error)</span>
<a name="l00532"></a>00532 <span class="comment">     *  - for now, if the user has defined a curve to control the time, this correction cannot be performed</span>
<a name="l00533"></a>00533 <span class="comment">     *    reliably...</span>
<a name="l00534"></a>00534 <span class="comment">     */</span>
<a name="l00535"></a>00535     <span class="keywordflow">if</span> ((strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a2f7a73a57fe2f49ab932efadbff6076c">NLASTRIP_FLAG_USR_TIME</a>))
<a name="l00536"></a>00536         <span class="keywordflow">return</span> cframe;
<a name="l00537"></a>00537         
<a name="l00538"></a>00538     <span class="comment">/* perform the correction now... */</span>
<a name="l00539"></a>00539     <span class="keywordflow">return</span> <a class="code" href="../../db/dee/nla_8c.html#a014bad290540943f0a8b701539da0dd1">nlastrip_get_frame</a>(strip, cframe, mode);
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="comment">/* *************************************************** */</span>
<a name="l00543"></a>00543 <span class="comment">/* NLA API */</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="comment">/* List of Strips ------------------------------------ */</span>
<a name="l00546"></a>00546 <span class="comment">/* (these functions are used for NLA-Tracks and also for nested/meta-strips) */</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="comment">/* Check if there is any space in the given list to add the given strip */</span>
<a name="l00549"></a><a class="code" href="../../db/dee/nla_8c.html#a20bf0f1c3b2ec0b847f34e8b1b3abaf8">00549</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a20bf0f1c3b2ec0b847f34e8b1b3abaf8">BKE_nlastrips_has_space</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <span class="keywordtype">float</span> start, <span class="keywordtype">float</span> end)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l00552"></a>00552     
<a name="l00553"></a>00553     <span class="comment">/* sanity checks */</span>
<a name="l00554"></a>00554     <span class="keywordflow">if</span> ((strips == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(start, end))
<a name="l00555"></a>00555         <span class="keywordflow">return</span> 0;
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (start &gt; end) {
<a name="l00557"></a>00557         puts(<span class="stringliteral">&quot;BKE_nlastrips_has_space() error... start and end arguments swapped&quot;</span>);
<a name="l00558"></a>00558         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, start, end);
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     
<a name="l00561"></a>00561     <span class="comment">/* loop over NLA strips checking for any overlaps with this area... */</span>
<a name="l00562"></a>00562     <span class="keywordflow">for</span> (strip= strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00563"></a>00563         <span class="comment">/* if start frame of strip is past the target end-frame, that means that</span>
<a name="l00564"></a>00564 <span class="comment">         * we&#39;ve gone past the window we need to check for, so things are fine</span>
<a name="l00565"></a>00565 <span class="comment">         */</span>
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &gt;= end)
<a name="l00567"></a>00567             <span class="keywordflow">return</span> 1;
<a name="l00568"></a>00568         
<a name="l00569"></a>00569         <span class="comment">/* if the end of the strip is greater than either of the boundaries, the range</span>
<a name="l00570"></a>00570 <span class="comment">         * must fall within the extents of the strip</span>
<a name="l00571"></a>00571 <span class="comment">         */</span>
<a name="l00572"></a>00572         <span class="keywordflow">if</span> ((strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &gt; start) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &gt; end))
<a name="l00573"></a>00573             <span class="keywordflow">return</span> 0;
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     
<a name="l00576"></a>00576     <span class="comment">/* if we are still here, we haven&#39;t encountered any overlapping strips */</span>
<a name="l00577"></a>00577     <span class="keywordflow">return</span> 1;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">/* Rearrange the strips in the track so that they are always in order </span>
<a name="l00581"></a>00581 <span class="comment"> * (usually only needed after a strip has been moved) </span>
<a name="l00582"></a>00582 <span class="comment"> */</span>
<a name="l00583"></a><a class="code" href="../../db/dee/nla_8c.html#a498c644e5999c9044d8dc4b4d9aed04f">00583</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a498c644e5999c9044d8dc4b4d9aed04f">BKE_nlastrips_sort_strips</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> tmp = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00586"></a>00586     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *sstrip, *stripn;
<a name="l00587"></a>00587     
<a name="l00588"></a>00588     <span class="comment">/* sanity checks */</span>
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, strips, strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00590"></a>00590         <span class="keywordflow">return</span>;
<a name="l00591"></a>00591     
<a name="l00592"></a>00592     <span class="comment">/* we simply perform insertion sort on this list, since it is assumed that per track,</span>
<a name="l00593"></a>00593 <span class="comment">     * there are only likely to be at most 5-10 strips</span>
<a name="l00594"></a>00594 <span class="comment">     */</span>
<a name="l00595"></a>00595     <span class="keywordflow">for</span> (strip= strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= stripn) {
<a name="l00596"></a>00596         <span class="keywordtype">short</span> not_added = 1;
<a name="l00597"></a>00597         
<a name="l00598"></a>00598         stripn= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00599"></a>00599         
<a name="l00600"></a>00600         <span class="comment">/* remove this strip from the list, and add it to the new list, searching from the end of </span>
<a name="l00601"></a>00601 <span class="comment">         * the list, assuming that the lists are in order </span>
<a name="l00602"></a>00602 <span class="comment">         */</span>
<a name="l00603"></a>00603         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(strips, strip);
<a name="l00604"></a>00604         
<a name="l00605"></a>00605         <span class="keywordflow">for</span> (sstrip= tmp.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>; sstrip; sstrip= sstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>) {
<a name="l00606"></a>00606             <span class="comment">/* check if add after */</span>
<a name="l00607"></a>00607             <span class="keywordflow">if</span> (sstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &lt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) {
<a name="l00608"></a>00608                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a9c299678f8810312806da26e6132ccc7">BLI_insertlinkafter</a>(&amp;tmp, sstrip, strip);
<a name="l00609"></a>00609                 not_added= 0;
<a name="l00610"></a>00610                 <span class="keywordflow">break</span>;
<a name="l00611"></a>00611             }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613         
<a name="l00614"></a>00614         <span class="comment">/* add before first? */</span>
<a name="l00615"></a>00615         <span class="keywordflow">if</span> (not_added)
<a name="l00616"></a>00616             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#ab5b5ec121d2522c0e8e74e01d6517feb">BLI_addhead</a>(&amp;tmp, strip);
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618     
<a name="l00619"></a>00619     <span class="comment">/* reassign the start and end points of the strips */</span>
<a name="l00620"></a>00620     strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= tmp.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00621"></a>00621     strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= tmp.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 <span class="comment">/* Add the given NLA-Strip to the given list of strips, assuming that it </span>
<a name="l00625"></a>00625 <span class="comment"> * isn&#39;t currently a member of another list</span>
<a name="l00626"></a>00626 <span class="comment"> */</span>
<a name="l00627"></a><a class="code" href="../../db/dee/nla_8c.html#a305c5ad14df858dbe89f7e5c777a0b6c">00627</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a3319eb89e5a5a38b8c5c4f1361d60491">BKE_nlastrips_add_strip</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *ns;
<a name="l00630"></a>00630     <span class="keywordtype">short</span> not_added = 1;
<a name="l00631"></a>00631     
<a name="l00632"></a>00632     <span class="comment">/* sanity checks */</span>
<a name="l00633"></a>00633     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, strips, strip))
<a name="l00634"></a>00634         <span class="keywordflow">return</span> 0;
<a name="l00635"></a>00635         
<a name="l00636"></a>00636     <span class="comment">/* check if any space to add */</span>
<a name="l00637"></a>00637     <span class="keywordflow">if</span> (<a class="code" href="../../d9/de6/BKE__nla_8h.html#a20bf0f1c3b2ec0b847f34e8b1b3abaf8">BKE_nlastrips_has_space</a>(strips, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)==0)
<a name="l00638"></a>00638         <span class="keywordflow">return</span> 0;
<a name="l00639"></a>00639     
<a name="l00640"></a>00640     <span class="comment">/* find the right place to add the strip to the nominated track */</span>
<a name="l00641"></a>00641     <span class="keywordflow">for</span> (ns= strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ns; ns= ns-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00642"></a>00642         <span class="comment">/* if current strip occurs after the new strip, add it before */</span>
<a name="l00643"></a>00643         <span class="keywordflow">if</span> (ns-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &gt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) {
<a name="l00644"></a>00644             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(strips, ns, strip);
<a name="l00645"></a>00645             not_added= 0;
<a name="l00646"></a>00646             <span class="keywordflow">break</span>;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649     <span class="keywordflow">if</span> (not_added) {
<a name="l00650"></a>00650         <span class="comment">/* just add to the end of the list of the strips then... */</span>
<a name="l00651"></a>00651         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(strips, strip);
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653     
<a name="l00654"></a>00654     <span class="comment">/* added... */</span>
<a name="l00655"></a>00655     <span class="keywordflow">return</span> 1;
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="comment">/* Meta-Strips ------------------------------------ */</span>
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 <span class="comment">/* Convert &#39;islands&#39; (i.e. continuous string of) selected strips to be</span>
<a name="l00662"></a>00662 <span class="comment"> * contained within &#39;Meta-Strips&#39; which act as strips which contain strips.</span>
<a name="l00663"></a>00663 <span class="comment"> *  temp: are the meta-strips to be created &#39;temporary&#39; ones used for transforms?</span>
<a name="l00664"></a>00664 <span class="comment"> */</span>
<a name="l00665"></a><a class="code" href="../../db/dee/nla_8c.html#a116c0ccd57c84cafd821c1a5752abdea">00665</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a116c0ccd57c84cafd821c1a5752abdea">BKE_nlastrips_make_metas</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <span class="keywordtype">short</span> temp)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *mstrip = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00668"></a>00668     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *stripn;
<a name="l00669"></a>00669     
<a name="l00670"></a>00670     <span class="comment">/* sanity checks */</span>
<a name="l00671"></a>00671     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, strips, strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00672"></a>00672         <span class="keywordflow">return</span>;
<a name="l00673"></a>00673     
<a name="l00674"></a>00674     <span class="comment">/* group all continuous chains of selected strips into meta-strips */</span>
<a name="l00675"></a>00675     <span class="keywordflow">for</span> (strip= strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= stripn) {
<a name="l00676"></a>00676         stripn= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00677"></a>00677         
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>) {
<a name="l00679"></a>00679             <span class="comment">/* if there is an existing meta-strip, add this strip to it, otherwise, create a new one */</span>
<a name="l00680"></a>00680             <span class="keywordflow">if</span> (mstrip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00681"></a>00681                 <span class="comment">/* add a new meta-strip, and add it before the current strip that it will replace... */</span>
<a name="l00682"></a>00682                 mstrip= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a>), <span class="stringliteral">&quot;Meta-NlaStrip&quot;</span>);
<a name="l00683"></a>00683                 mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a330575a46d56bc5ce45afa8b6b7d5bb2">NLASTRIP_TYPE_META</a>;
<a name="l00684"></a>00684                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(strips, strip, mstrip);
<a name="l00685"></a>00685                 
<a name="l00686"></a>00686                 <span class="comment">/* set flags */</span>
<a name="l00687"></a>00687                 mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> = <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>;
<a name="l00688"></a>00688                 
<a name="l00689"></a>00689                 <span class="comment">/* set temp flag if appropriate (i.e. for transform-type editing) */</span>
<a name="l00690"></a>00690                 <span class="keywordflow">if</span> (temp)
<a name="l00691"></a>00691                     mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a44376ba8584e916a87fddb2ec469f62e">NLASTRIP_FLAG_TEMP_META</a>;
<a name="l00692"></a>00692                     
<a name="l00693"></a>00693                 <span class="comment">/* set default repeat/scale values to prevent warnings */</span>
<a name="l00694"></a>00694                 mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>= mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a>= 1.0f;
<a name="l00695"></a>00695                 
<a name="l00696"></a>00696                 <span class="comment">/* make its start frame be set to the start frame of the current strip */</span>
<a name="l00697"></a>00697                 mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699             
<a name="l00700"></a>00700             <span class="comment">/* remove the selected strips from the track, and add to the meta */</span>
<a name="l00701"></a>00701             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(strips, strip);
<a name="l00702"></a>00702             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, strip);
<a name="l00703"></a>00703             
<a name="l00704"></a>00704             <span class="comment">/* expand the meta&#39;s dimensions to include the newly added strip- i.e. its last frame */</span>
<a name="l00705"></a>00705             mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>;
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707         <span class="keywordflow">else</span> {
<a name="l00708"></a>00708             <span class="comment">/* current strip wasn&#39;t selected, so the end of &#39;island&#39; of selected strips has been reached,</span>
<a name="l00709"></a>00709 <span class="comment">             * so stop adding strips to the current meta</span>
<a name="l00710"></a>00710 <span class="comment">             */</span>
<a name="l00711"></a>00711             mstrip= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 <span class="comment">/* Split a meta-strip into a set of normal strips */</span>
<a name="l00717"></a><a class="code" href="../../db/dee/nla_8c.html#a2957f3c862627ef5edf8075220df0e40">00717</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a03ca282d2bd3c62f71cc20c7e24b544b">BKE_nlastrips_clear_metastrip</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *cs, *csn;
<a name="l00720"></a>00720     
<a name="l00721"></a>00721     <span class="comment">/* sanity check */</span>
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, strips, strip))
<a name="l00723"></a>00723         <span class="keywordflow">return</span>;
<a name="l00724"></a>00724     
<a name="l00725"></a>00725     <span class="comment">/* move each one of the meta-strip&#39;s children before the meta-strip</span>
<a name="l00726"></a>00726 <span class="comment">     * in the list of strips after unlinking them from the meta-strip</span>
<a name="l00727"></a>00727 <span class="comment">     */</span>
<a name="l00728"></a>00728     <span class="keywordflow">for</span> (cs= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; cs; cs= csn) {
<a name="l00729"></a>00729         csn= cs-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00730"></a>00730         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, cs);
<a name="l00731"></a>00731         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(strips, strip, cs);
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733     
<a name="l00734"></a>00734     <span class="comment">/* free the meta-strip now */</span>
<a name="l00735"></a>00735     <a class="code" href="../../d9/de6/BKE__nla_8h.html#a9c17a5e4c234227445423938413224a2">free_nlastrip</a>(strips, strip);
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 <span class="comment">/* Remove meta-strips (i.e. flatten the list of strips) from the top-level of the list of strips</span>
<a name="l00739"></a>00739 <span class="comment"> *  sel: only consider selected meta-strips, otherwise all meta-strips are removed</span>
<a name="l00740"></a>00740 <span class="comment"> *  onlyTemp: only remove the &#39;temporary&#39; meta-strips used for transforms</span>
<a name="l00741"></a>00741 <span class="comment"> */</span>
<a name="l00742"></a><a class="code" href="../../db/dee/nla_8c.html#a195e7c97865195c81abc1c4b13cc1f59">00742</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a195e7c97865195c81abc1c4b13cc1f59">BKE_nlastrips_clear_metas</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *strips, <span class="keywordtype">short</span> onlySel, <span class="keywordtype">short</span> onlyTemp)
<a name="l00743"></a>00743 {
<a name="l00744"></a>00744     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *stripn;
<a name="l00745"></a>00745     
<a name="l00746"></a>00746     <span class="comment">/* sanity checks */</span>
<a name="l00747"></a>00747     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, strips, strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00748"></a>00748         <span class="keywordflow">return</span>;
<a name="l00749"></a>00749     
<a name="l00750"></a>00750     <span class="comment">/* remove meta-strips fitting the criteria of the arguments */</span>
<a name="l00751"></a>00751     <span class="keywordflow">for</span> (strip= strips-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= stripn) {
<a name="l00752"></a>00752         stripn= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>;
<a name="l00753"></a>00753         
<a name="l00754"></a>00754         <span class="comment">/* check if strip is a meta-strip */</span>
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a330575a46d56bc5ce45afa8b6b7d5bb2">NLASTRIP_TYPE_META</a>) {
<a name="l00756"></a>00756             <span class="comment">/* if check if selection and &#39;temporary-only&#39; considerations are met */</span>
<a name="l00757"></a>00757             <span class="keywordflow">if</span> ((onlySel==0) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>)) {
<a name="l00758"></a>00758                 <span class="keywordflow">if</span> ((!onlyTemp) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a44376ba8584e916a87fddb2ec469f62e">NLASTRIP_FLAG_TEMP_META</a>)) {
<a name="l00759"></a>00759                     <a class="code" href="../../d9/de6/BKE__nla_8h.html#a03ca282d2bd3c62f71cc20c7e24b544b">BKE_nlastrips_clear_metastrip</a>(strips, strip);
<a name="l00760"></a>00760                 }
<a name="l00761"></a>00761             }
<a name="l00762"></a>00762         }
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="comment">/* Add the given NLA-Strip to the given Meta-Strip, assuming that the</span>
<a name="l00767"></a>00767 <span class="comment"> * strip isn&#39;t attached to anyy list of strips </span>
<a name="l00768"></a>00768 <span class="comment"> */</span>
<a name="l00769"></a><a class="code" href="../../db/dee/nla_8c.html#a3618d301b684f378859de90faccd7429">00769</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a40e9cf4e309c5abc263f3ebb315be699">BKE_nlameta_add_strip</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *mstrip, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771     <span class="comment">/* sanity checks */</span>
<a name="l00772"></a>00772     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mstrip, strip))
<a name="l00773"></a>00773         <span class="keywordflow">return</span> 0;
<a name="l00774"></a>00774         
<a name="l00775"></a>00775     <span class="comment">/* firstly, check if the meta-strip has space for this */</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (<a class="code" href="../../d9/de6/BKE__nla_8h.html#a20bf0f1c3b2ec0b847f34e8b1b3abaf8">BKE_nlastrips_has_space</a>(&amp;mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) == 0)
<a name="l00777"></a>00777         <span class="keywordflow">return</span> 0;
<a name="l00778"></a>00778         
<a name="l00779"></a>00779     <span class="comment">/* check if this would need to be added to the ends of the meta,</span>
<a name="l00780"></a>00780 <span class="comment">     * and subsequently, if the neighboring strips allow us enough room</span>
<a name="l00781"></a>00781 <span class="comment">     */</span>
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &lt; mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) {
<a name="l00783"></a>00783         <span class="comment">/* check if strip to the left (if it exists) ends before the </span>
<a name="l00784"></a>00784 <span class="comment">         * start of the strip we&#39;re trying to add </span>
<a name="l00785"></a>00785 <span class="comment">         */</span>
<a name="l00786"></a>00786         <span class="keywordflow">if</span> ((mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &lt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>)) {
<a name="l00787"></a>00787             <span class="comment">/* add strip to start of meta&#39;s list, and expand dimensions */</span>
<a name="l00788"></a>00788             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#ab5b5ec121d2522c0e8e74e01d6517feb">BLI_addhead</a>(&amp;mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, strip);
<a name="l00789"></a>00789             mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00790"></a>00790             
<a name="l00791"></a>00791             <span class="keywordflow">return</span> 1;
<a name="l00792"></a>00792         }
<a name="l00793"></a>00793         <span class="keywordflow">else</span> <span class="comment">/* failed... no room before */</span>
<a name="l00794"></a>00794             <span class="keywordflow">return</span> 0;
<a name="l00795"></a>00795     }
<a name="l00796"></a>00796     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &gt; mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) {
<a name="l00797"></a>00797         <span class="comment">/* check if strip to the right (if it exists) starts before the </span>
<a name="l00798"></a>00798 <span class="comment">         * end of the strip we&#39;re trying to add </span>
<a name="l00799"></a>00799 <span class="comment">         */</span>
<a name="l00800"></a>00800         <span class="keywordflow">if</span> ((mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &gt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)) {
<a name="l00801"></a>00801             <span class="comment">/* add strip to end of meta&#39;s list, and expand dimensions */</span>
<a name="l00802"></a>00802             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, strip);
<a name="l00803"></a>00803             mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>;
<a name="l00804"></a>00804             
<a name="l00805"></a>00805             <span class="keywordflow">return</span> 1;
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807         <span class="keywordflow">else</span> <span class="comment">/* failed... no room after */</span>
<a name="l00808"></a>00808             <span class="keywordflow">return</span> 0;
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810     <span class="keywordflow">else</span> {
<a name="l00811"></a>00811         <span class="comment">/* just try to add to the meta-strip (no dimension changes needed) */</span>
<a name="l00812"></a>00812         <span class="keywordflow">return</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a3319eb89e5a5a38b8c5c4f1361d60491">BKE_nlastrips_add_strip</a>(&amp;mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>, strip);
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="comment">/* Adjust the settings of NLA-Strips contained within a Meta-Strip (recursively), </span>
<a name="l00817"></a>00817 <span class="comment"> * until the Meta-Strips children all fit within the Meta-Strip&#39;s new dimensions</span>
<a name="l00818"></a>00818 <span class="comment"> */</span>
<a name="l00819"></a><a class="code" href="../../db/dee/nla_8c.html#a1b0a7e9e0060f06bd48deea9b0331e51">00819</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a5edf5738ee03c2158b209b897ab673d2">BKE_nlameta_flush_transforms</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *mstrip) 
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l00822"></a>00822     <span class="keywordtype">float</span> oStart, oEnd, offset;
<a name="l00823"></a>00823     <span class="keywordtype">float</span> oLen, nLen;
<a name="l00824"></a>00824     <span class="keywordtype">short</span> scaleChanged= 0;
<a name="l00825"></a>00825     
<a name="l00826"></a>00826     <span class="comment">/* sanity checks </span>
<a name="l00827"></a>00827 <span class="comment">     *  - strip must exist</span>
<a name="l00828"></a>00828 <span class="comment">     *  - strip must be a meta-strip with some contents</span>
<a name="l00829"></a>00829 <span class="comment">     */</span>
<a name="l00830"></a>00830     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mstrip, mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00831"></a>00831         <span class="keywordflow">return</span>;
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a> != <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a330575a46d56bc5ce45afa8b6b7d5bb2">NLASTRIP_TYPE_META</a>)
<a name="l00833"></a>00833         <span class="keywordflow">return</span>;
<a name="l00834"></a>00834         
<a name="l00835"></a>00835     <span class="comment">/* get the original start/end points, and calculate the start-frame offset</span>
<a name="l00836"></a>00836 <span class="comment">     *  - these are simply the start/end frames of the child strips, </span>
<a name="l00837"></a>00837 <span class="comment">     *    since we assume they weren&#39;t transformed yet</span>
<a name="l00838"></a>00838 <span class="comment">     */</span>
<a name="l00839"></a>00839     oStart= ((<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *)mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00840"></a>00840     oEnd= ((<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *)mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>)-&gt;end;
<a name="l00841"></a>00841     offset= mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> - oStart;
<a name="l00842"></a>00842     
<a name="l00843"></a>00843     <span class="comment">/* optimization:</span>
<a name="l00844"></a>00844 <span class="comment">     * don&#39;t flush if nothing changed yet</span>
<a name="l00845"></a>00845 <span class="comment">     *  TODO: maybe we need a flag to say always flush?</span>
<a name="l00846"></a>00846 <span class="comment">     */</span>
<a name="l00847"></a>00847     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(oStart, mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(oEnd, mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>))
<a name="l00848"></a>00848         <span class="keywordflow">return</span>;
<a name="l00849"></a>00849     
<a name="l00850"></a>00850     <span class="comment">/* check if scale changed */</span>
<a name="l00851"></a>00851     oLen = oEnd - oStart;
<a name="l00852"></a>00852     nLen = mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(nLen, oLen) == 0)
<a name="l00854"></a>00854         scaleChanged= 1;
<a name="l00855"></a>00855     
<a name="l00856"></a>00856     <span class="comment">/* for each child-strip, calculate new start/end points based on this new info */</span>
<a name="l00857"></a>00857     <span class="keywordflow">for</span> (strip= mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (scaleChanged) {
<a name="l00859"></a>00859             <span class="keywordtype">float</span> p1, p2;
<a name="l00860"></a>00860             
<a name="l00861"></a>00861             <span class="comment">/* compute positions of endpoints relative to old extents of strip */</span>
<a name="l00862"></a>00862             p1= (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> - oStart) / oLen;
<a name="l00863"></a>00863             p2= (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - oStart) / oLen;
<a name="l00864"></a>00864             
<a name="l00865"></a>00865             <span class="comment">/* apply new strip endpoints using the proportions, then wait for second pass to flush scale properly */</span>
<a name="l00866"></a>00866             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>= (p1 * nLen) + mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00867"></a>00867             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>= (p2 * nLen) + mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869         <span class="keywordflow">else</span> {
<a name="l00870"></a>00870             <span class="comment">/* just apply the changes in offset to both ends of the strip */</span>
<a name="l00871"></a>00871             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> += offset;
<a name="l00872"></a>00872             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> += offset;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875         
<a name="l00876"></a>00876     <span class="comment">/* apply a second pass over child strips, to finish up unfinished business */</span>
<a name="l00877"></a>00877     <span class="keywordflow">for</span> (strip= mstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a9cc3337843773f5b953893c79784044d">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l00878"></a>00878         <span class="comment">/* only if scale changed, need to perform RNA updates */</span>
<a name="l00879"></a>00879         <span class="keywordflow">if</span> (scaleChanged) {
<a name="l00880"></a>00880             <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr;
<a name="l00881"></a>00881             
<a name="l00882"></a>00882             <span class="comment">/* use RNA updates to compute scale properly */</span>
<a name="l00883"></a>00883             <a class="code" href="../../d3/d10/rna__access_8c.html#a1f8fb80da9a6450a51ab2e9b97264f01">RNA_pointer_create</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#af756e7795471d4656788aae93617f074">RNA_NlaStrip</a>, strip, &amp;ptr);
<a name="l00884"></a>00884             
<a name="l00885"></a>00885             <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(&amp;ptr, <span class="stringliteral">&quot;frame_start&quot;</span>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>);
<a name="l00886"></a>00886             <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(&amp;ptr, <span class="stringliteral">&quot;frame_end&quot;</span>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>);
<a name="l00887"></a>00887         }
<a name="l00888"></a>00888         
<a name="l00889"></a>00889         <span class="comment">/* finally, make sure the strip&#39;s children (if it is a meta-itself), get updated */</span>
<a name="l00890"></a>00890         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a5edf5738ee03c2158b209b897ab673d2">BKE_nlameta_flush_transforms</a>(strip);
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892 }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="comment">/* NLA-Tracks ---------------------------------------- */</span>
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/* Find the active NLA-track for the given stack */</span>
<a name="l00897"></a><a class="code" href="../../db/dee/nla_8c.html#ae33aaec915f1f7294d9d61685f224e0a">00897</a> <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#ae692a35f2630c86624f8554e0053edf9">BKE_nlatrack_find_active</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l00900"></a>00900     
<a name="l00901"></a>00901     <span class="comment">/* sanity check */</span>
<a name="l00902"></a>00902     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tracks, tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00903"></a>00903         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00904"></a>00904         
<a name="l00905"></a>00905     <span class="comment">/* try to find the first active track */</span>
<a name="l00906"></a>00906     <span class="keywordflow">for</span> (nlt= tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l00907"></a>00907         <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba3bfcf76c5ef87c391346e6e7ab29b7f8">NLATRACK_ACTIVE</a>)
<a name="l00908"></a>00908             <span class="keywordflow">return</span> nlt;
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910     
<a name="l00911"></a>00911     <span class="comment">/* none found */</span>
<a name="l00912"></a>00912     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 <span class="comment">/* Toggle the &#39;solo&#39; setting for the given NLA-track, making sure that it is the only one</span>
<a name="l00916"></a>00916 <span class="comment"> * that has this status in its AnimData block.</span>
<a name="l00917"></a>00917 <span class="comment"> */</span>
<a name="l00918"></a><a class="code" href="../../db/dee/nla_8c.html#a68209d81b951e9b7b48b499f10bdf83f">00918</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#aa9fc17ac8d0bec6d391e9003bbb9a7b2">BKE_nlatrack_solo_toggle</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l00919"></a>00919 {
<a name="l00920"></a>00920     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nt;
<a name="l00921"></a>00921     
<a name="l00922"></a>00922     <span class="comment">/* sanity check */</span>
<a name="l00923"></a>00923     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00924"></a>00924         <span class="keywordflow">return</span>;
<a name="l00925"></a>00925         
<a name="l00926"></a>00926     <span class="comment">/* firstly, make sure &#39;solo&#39; flag for all tracks is disabled */</span>
<a name="l00927"></a>00927     <span class="keywordflow">for</span> (nt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nt; nt= nt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l00928"></a>00928         <span class="keywordflow">if</span> (nt != nlt)
<a name="l00929"></a>00929             nt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba22c6f788f54b3d80dc0bddc1b396c6d5">NLATRACK_SOLO</a>;
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931         
<a name="l00932"></a>00932     <span class="comment">/* now, enable &#39;solo&#39; for the given track if appropriate */</span>
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (nlt) {
<a name="l00934"></a>00934         <span class="comment">/* toggle solo status */</span>
<a name="l00935"></a>00935         nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> ^= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba22c6f788f54b3d80dc0bddc1b396c6d5">NLATRACK_SOLO</a>;
<a name="l00936"></a>00936         
<a name="l00937"></a>00937         <span class="comment">/* set or clear solo-status on AnimData */</span>
<a name="l00938"></a>00938         <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba22c6f788f54b3d80dc0bddc1b396c6d5">NLATRACK_SOLO</a>)
<a name="l00939"></a>00939             adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673a15c1ce5866f739bfc43fa2922d6b5197">ADT_NLA_SOLO_TRACK</a>;
<a name="l00940"></a>00940         <span class="keywordflow">else</span>
<a name="l00941"></a>00941             adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673a15c1ce5866f739bfc43fa2922d6b5197">ADT_NLA_SOLO_TRACK</a>;
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943     <span class="keywordflow">else</span>
<a name="l00944"></a>00944         adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673a15c1ce5866f739bfc43fa2922d6b5197">ADT_NLA_SOLO_TRACK</a>;
<a name="l00945"></a>00945 }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947 <span class="comment">/* Make the given NLA-track the active one for the given stack. If no track is provided, </span>
<a name="l00948"></a>00948 <span class="comment"> * this function can be used to simply deactivate all the NLA tracks in the given stack too.</span>
<a name="l00949"></a>00949 <span class="comment"> */</span>
<a name="l00950"></a><a class="code" href="../../db/dee/nla_8c.html#ab9ff0cc2eb8ab1c5a1af2cb28fff074f">00950</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#af4811d5a8bab55e7cc04ec0e0f4d259e">BKE_nlatrack_set_active</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>, <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt_a)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l00953"></a>00953     
<a name="l00954"></a>00954     <span class="comment">/* sanity check */</span>
<a name="l00955"></a>00955     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tracks, tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00956"></a>00956         <span class="keywordflow">return</span>;
<a name="l00957"></a>00957     
<a name="l00958"></a>00958     <span class="comment">/* deactive all the rest */</span>
<a name="l00959"></a>00959     <span class="keywordflow">for</span> (nlt= tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) 
<a name="l00960"></a>00960         nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba3bfcf76c5ef87c391346e6e7ab29b7f8">NLATRACK_ACTIVE</a>;
<a name="l00961"></a>00961         
<a name="l00962"></a>00962     <span class="comment">/* set the given one as the active one */</span>
<a name="l00963"></a>00963     <span class="keywordflow">if</span> (nlt_a)
<a name="l00964"></a>00964         nlt_a-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba3bfcf76c5ef87c391346e6e7ab29b7f8">NLATRACK_ACTIVE</a>;
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="comment">/* Check if there is any space in the given track to add a strip of the given length */</span>
<a name="l00968"></a><a class="code" href="../../db/dee/nla_8c.html#a90946576d0fd64ec1725a7c038b47c63">00968</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#ac3eceb4053efcd15a8acc3ca4f9b16b9">BKE_nlatrack_has_space</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, <span class="keywordtype">float</span> start, <span class="keywordtype">float</span> end)
<a name="l00969"></a>00969 {
<a name="l00970"></a>00970     <span class="comment">/* sanity checks </span>
<a name="l00971"></a>00971 <span class="comment">     *  - track must exist</span>
<a name="l00972"></a>00972 <span class="comment">     *  - track must be editable</span>
<a name="l00973"></a>00973 <span class="comment">     *  - bounds cannot be equal (0-length is nasty) </span>
<a name="l00974"></a>00974 <span class="comment">     */</span>
<a name="l00975"></a>00975     <span class="keywordflow">if</span> ((nlt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba7af18a4810234306e8f6bc7ed5ea0cbb">NLATRACK_PROTECTED</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(start, end))
<a name="l00976"></a>00976         <span class="keywordflow">return</span> 0;
<a name="l00977"></a>00977     
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (start &gt; end) {
<a name="l00979"></a>00979         puts(<span class="stringliteral">&quot;BKE_nlatrack_has_space() error... start and end arguments swapped&quot;</span>);
<a name="l00980"></a>00980         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, start, end);
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982     
<a name="l00983"></a>00983     <span class="comment">/* check if there&#39;s any space left in the track for a strip of the given length */</span>
<a name="l00984"></a>00984     <span class="keywordflow">return</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a20bf0f1c3b2ec0b847f34e8b1b3abaf8">BKE_nlastrips_has_space</a>(&amp;nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>, start, end);
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="comment">/* Rearrange the strips in the track so that they are always in order </span>
<a name="l00988"></a>00988 <span class="comment"> * (usually only needed after a strip has been moved) </span>
<a name="l00989"></a>00989 <span class="comment"> */</span>
<a name="l00990"></a><a class="code" href="../../db/dee/nla_8c.html#aaefd4443c0ebbbe5652ea8a3768099c4">00990</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a0f2932c4dbc25f58e271e2ab02d18e11">BKE_nlatrack_sort_strips</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l00991"></a>00991 {
<a name="l00992"></a>00992     <span class="comment">/* sanity checks */</span>
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nlt, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00994"></a>00994         <span class="keywordflow">return</span>;
<a name="l00995"></a>00995     
<a name="l00996"></a>00996     <span class="comment">/* sort the strips with a more generic function */</span>
<a name="l00997"></a>00997     <a class="code" href="../../d9/de6/BKE__nla_8h.html#a498c644e5999c9044d8dc4b4d9aed04f">BKE_nlastrips_sort_strips</a>(&amp;nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>);
<a name="l00998"></a>00998 }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000 <span class="comment">/* Add the given NLA-Strip to the given NLA-Track, assuming that it </span>
<a name="l01001"></a>01001 <span class="comment"> * isn&#39;t currently attached to another one </span>
<a name="l01002"></a>01002 <span class="comment"> */</span>
<a name="l01003"></a><a class="code" href="../../db/dee/nla_8c.html#ac0471f35ad802cd2efdc8b7dc40235e9">01003</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a15ed3c0b4de96436ec6938f4a2aae230">BKE_nlatrack_add_strip</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <span class="comment">/* sanity checks */</span>
<a name="l01006"></a>01006     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nlt, strip))
<a name="l01007"></a>01007         <span class="keywordflow">return</span> 0;
<a name="l01008"></a>01008         
<a name="l01009"></a>01009     <span class="comment">/* try to add the strip to the track using a more generic function */</span>
<a name="l01010"></a>01010     <span class="keywordflow">return</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a3319eb89e5a5a38b8c5c4f1361d60491">BKE_nlastrips_add_strip</a>(&amp;nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>, strip);
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="comment">/* Get the extents of the given NLA-Track including gaps between strips,</span>
<a name="l01014"></a>01014 <span class="comment"> * returning whether this succeeded or not</span>
<a name="l01015"></a>01015 <span class="comment"> */</span>
<a name="l01016"></a><a class="code" href="../../db/dee/nla_8c.html#a2969d2636fba2501e56d03af44842a24">01016</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#aaf3f383bf64ef3ae114e7ec089ab6f1a">BKE_nlatrack_get_bounds</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[2])
<a name="l01017"></a>01017 {
<a name="l01018"></a>01018     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l01019"></a>01019     
<a name="l01020"></a>01020     <span class="comment">/* initialize bounds */</span>
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (bounds)
<a name="l01022"></a>01022         bounds[0] = bounds[1] = 0.0f;
<a name="l01023"></a>01023     <span class="keywordflow">else</span>
<a name="l01024"></a>01024         <span class="keywordflow">return</span> 0;
<a name="l01025"></a>01025     
<a name="l01026"></a>01026     <span class="comment">/* sanity checks */</span>
<a name="l01027"></a>01027     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nlt, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01028"></a>01028         <span class="keywordflow">return</span> 0;
<a name="l01029"></a>01029         
<a name="l01030"></a>01030     <span class="comment">/* lower bound is first strip&#39;s start frame */</span>
<a name="l01031"></a>01031     strip = nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01032"></a>01032     bounds[0] = strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l01033"></a>01033     
<a name="l01034"></a>01034     <span class="comment">/* upper bound is last strip&#39;s end frame */</span>
<a name="l01035"></a>01035     strip = nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l01036"></a>01036     bounds[1] = strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>;
<a name="l01037"></a>01037     
<a name="l01038"></a>01038     <span class="comment">/* done */</span>
<a name="l01039"></a>01039     <span class="keywordflow">return</span> 1;
<a name="l01040"></a>01040 }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042 <span class="comment">/* NLA Strips -------------------------------------- */</span>
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 <span class="comment">/* Find the active NLA-strip within the given track */</span>
<a name="l01045"></a><a class="code" href="../../db/dee/nla_8c.html#aea5b95fe6aafd30abbb87272e57f06b8">01045</a> <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *<a class="code" href="../../d9/de6/BKE__nla_8h.html#a815347026dc7ae0222cbcf11e18c362e">BKE_nlastrip_find_active</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l01048"></a>01048     
<a name="l01049"></a>01049     <span class="comment">/* sanity check */</span>
<a name="l01050"></a>01050     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nlt, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01051"></a>01051         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01052"></a>01052         
<a name="l01053"></a>01053     <span class="comment">/* try to find the first active strip */</span>
<a name="l01054"></a>01054     <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01055"></a>01055         <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a11b77f0bda6fb63b936acc20b58496ac">NLASTRIP_FLAG_ACTIVE</a>)
<a name="l01056"></a>01056             <span class="keywordflow">return</span> strip;
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058     
<a name="l01059"></a>01059     <span class="comment">/* none found */</span>
<a name="l01060"></a>01060     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 <span class="comment">/* Make the given NLA-Strip the active one within the given block */</span>
<a name="l01064"></a><a class="code" href="../../db/dee/nla_8c.html#a987f86ac9e162ab92a848acb7c459bef">01064</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a2aed03d2f861f48e2a33351a30f9e741">BKE_nlastrip_set_active</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l01065"></a>01065 {
<a name="l01066"></a>01066     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01067"></a>01067     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *nls;
<a name="l01068"></a>01068     
<a name="l01069"></a>01069     <span class="comment">/* sanity checks */</span>
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (adt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01071"></a>01071         <span class="keywordflow">return</span>;
<a name="l01072"></a>01072     
<a name="l01073"></a>01073     <span class="comment">/* loop over tracks, deactivating*/</span>
<a name="l01074"></a>01074     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01075"></a>01075         <span class="keywordflow">for</span> (nls= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nls; nls= nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01076"></a>01076             <span class="keywordflow">if</span> (nls != strip)
<a name="l01077"></a>01077                 nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a11b77f0bda6fb63b936acc20b58496ac">NLASTRIP_FLAG_ACTIVE</a>;
<a name="l01078"></a>01078             <span class="keywordflow">else</span>
<a name="l01079"></a>01079                 nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a11b77f0bda6fb63b936acc20b58496ac">NLASTRIP_FLAG_ACTIVE</a>;
<a name="l01080"></a>01080         }
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 <span class="comment">/* Does the given NLA-strip fall within the given bounds (times)? */</span>
<a name="l01086"></a><a class="code" href="../../db/dee/nla_8c.html#af8439a495e3d2c964e348f64414a1778">01086</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#ae3730dcb3d64032f47c3ef95f7c7c282">BKE_nlastrip_within_bounds</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>)
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088     <span class="keyword">const</span> <span class="keywordtype">float</span> stripLen= (strip) ? strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> : 0.0f;
<a name="l01089"></a>01089     <span class="keyword">const</span> <span class="keywordtype">float</span> boundsLen= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(max - min);
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     <span class="comment">/* sanity checks */</span>
<a name="l01092"></a>01092     <span class="keywordflow">if</span> ((strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(stripLen, 0.0f) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(boundsLen, 0.0f))
<a name="l01093"></a>01093         <span class="keywordflow">return</span> 0;
<a name="l01094"></a>01094     
<a name="l01095"></a>01095     <span class="comment">/* only ok if at least part of the strip is within the bounding window</span>
<a name="l01096"></a>01096 <span class="comment">     *  - first 2 cases cover when the strip length is less than the bounding area</span>
<a name="l01097"></a>01097 <span class="comment">     *  - second 2 cases cover when the strip length is greater than the bounding area</span>
<a name="l01098"></a>01098 <span class="comment">     */</span>
<a name="l01099"></a>01099     <span class="keywordflow">if</span> ( (stripLen &lt; boundsLen) &amp;&amp; 
<a name="l01100"></a>01100          !(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a7dadb214b740d4838066d84d83657e66">IN_RANGE</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, min, max) ||
<a name="l01101"></a>01101            <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a7dadb214b740d4838066d84d83657e66">IN_RANGE</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>, min, max)) )
<a name="l01102"></a>01102     {
<a name="l01103"></a>01103         <span class="keywordflow">return</span> 0;
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105     <span class="keywordflow">if</span> ( (stripLen &gt; boundsLen) &amp;&amp; 
<a name="l01106"></a>01106          !(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a7dadb214b740d4838066d84d83657e66">IN_RANGE</a>(min, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) ||
<a name="l01107"></a>01107            <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a7dadb214b740d4838066d84d83657e66">IN_RANGE</a>(max, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)) )
<a name="l01108"></a>01108     {
<a name="l01109"></a>01109         <span class="keywordflow">return</span> 0;
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111     
<a name="l01112"></a>01112     <span class="comment">/* should be ok! */</span>
<a name="l01113"></a>01113     <span class="keywordflow">return</span> 1;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="comment">/* Recalculate the start and end frames for the current strip, after changing</span>
<a name="l01117"></a>01117 <span class="comment"> * the extents of the action or the mapping (repeats or scale factor) info</span>
<a name="l01118"></a>01118 <span class="comment"> */</span>
<a name="l01119"></a><a class="code" href="../../db/dee/nla_8c.html#a7fe35a01b42d751f8ac1077586b11bd4">01119</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a5f1e18201a523a9f4183bb3c5bb1b7b9">BKE_nlastrip_recalculate_bounds</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121     <span class="keywordtype">float</span> actlen, mapping;
<a name="l01122"></a>01122     
<a name="l01123"></a>01123     <span class="comment">/* sanity checks</span>
<a name="l01124"></a>01124 <span class="comment">     *  - must have a strip</span>
<a name="l01125"></a>01125 <span class="comment">     *  - can only be done for action clips</span>
<a name="l01126"></a>01126 <span class="comment">     */</span>
<a name="l01127"></a>01127     <span class="keywordflow">if</span> ((strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a> != <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55aea70130d952e36e417d38704d3299339">NLASTRIP_TYPE_CLIP</a>))
<a name="l01128"></a>01128         <span class="keywordflow">return</span>;
<a name="l01129"></a>01129         
<a name="l01130"></a>01130     <span class="comment">/* calculate new length factors */</span>
<a name="l01131"></a>01131     actlen= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#aa701a7e948622bb5e5759c1491e43578">actend</a> - strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a014e33eeecd527bc006b4229cdf7ea72">actstart</a>;
<a name="l01132"></a>01132     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(actlen, 0.0f)) actlen= 1.0f;
<a name="l01133"></a>01133     
<a name="l01134"></a>01134     mapping= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a27146c6fc55825c160126786ad195950">scale</a> * strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ac810e95f37c9233f9c679ff25592a97e">repeat</a>;
<a name="l01135"></a>01135     
<a name="l01136"></a>01136     <span class="comment">/* adjust endpoint of strip in response to this */</span>
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(mapping, 0.0f) == 0)
<a name="l01138"></a>01138         strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> = (actlen * mapping) + strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l01139"></a>01139 }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 <span class="comment">/* Is the given NLA-strip the first one to occur for the given AnimData block */</span>
<a name="l01142"></a>01142 <span class="comment">// TODO: make this an api method if necesary, but need to add prefix first</span>
<a name="l01143"></a><a class="code" href="../../db/dee/nla_8c.html#a64294e12f3c103b3ded072af7a4a4235">01143</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/dee/nla_8c.html#a64294e12f3c103b3ded072af7a4a4235">nlastrip_is_first</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l01144"></a>01144 {
<a name="l01145"></a>01145     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01146"></a>01146     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *ns;
<a name="l01147"></a>01147     
<a name="l01148"></a>01148     <span class="comment">/* sanity checks */</span>
<a name="l01149"></a>01149     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, strip))
<a name="l01150"></a>01150         <span class="keywordflow">return</span> 0;
<a name="l01151"></a>01151         
<a name="l01152"></a>01152     <span class="comment">/* check if strip has any strips before it */</span>
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>)
<a name="l01154"></a>01154         <span class="keywordflow">return</span> 0;
<a name="l01155"></a>01155         
<a name="l01156"></a>01156     <span class="comment">/* check other tracks to see if they have a strip that&#39;s earlier */</span>
<a name="l01157"></a>01157     <span class="comment">// TODO: or should we check that the strip&#39;s track is also the first?</span>
<a name="l01158"></a>01158     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01159"></a>01159         <span class="comment">/* only check the first strip, assuming that they&#39;re all in order */</span>
<a name="l01160"></a>01160         ns= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (ns) {
<a name="l01162"></a>01162             <span class="keywordflow">if</span> (ns-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &lt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>)
<a name="l01163"></a>01163                 <span class="keywordflow">return</span> 0;
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165     }   
<a name="l01166"></a>01166     
<a name="l01167"></a>01167     <span class="comment">/* should be first now */</span>
<a name="l01168"></a>01168     <span class="keywordflow">return</span> 1;
<a name="l01169"></a>01169 }
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 <span class="comment">/* Animated Strips ------------------------------------------- */</span>
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 <span class="comment">/* Check if the given NLA-Track has any strips with own F-Curves */</span>
<a name="l01174"></a><a class="code" href="../../db/dee/nla_8c.html#a371ee47512f1b0b085237bda66c79993">01174</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a1965d45d7e8c1346e18e1068fcc0f54f">BKE_nlatrack_has_animated_strips</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt)
<a name="l01175"></a>01175 {
<a name="l01176"></a>01176     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l01177"></a>01177     
<a name="l01178"></a>01178     <span class="comment">/* sanity checks */</span>
<a name="l01179"></a>01179     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nlt, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01180"></a>01180         <span class="keywordflow">return</span> 0;
<a name="l01181"></a>01181         
<a name="l01182"></a>01182     <span class="comment">/* check each strip for F-Curves only (don&#39;t care about whether the flags are set) */</span>
<a name="l01183"></a>01183     <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01184"></a>01184         <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l01185"></a>01185             <span class="keywordflow">return</span> 1;
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     
<a name="l01188"></a>01188     <span class="comment">/* none found */</span>
<a name="l01189"></a>01189     <span class="keywordflow">return</span> 0;
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 <span class="comment">/* Check if given NLA-Tracks have any strips with own F-Curves */</span>
<a name="l01193"></a><a class="code" href="../../db/dee/nla_8c.html#af834edd9a4a47c06747bfe61db9ba6d9">01193</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#af834edd9a4a47c06747bfe61db9ba6d9">BKE_nlatracks_have_animated_strips</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../de/ddb/tracking_8c.html#afdbe7b66782dfc0090b48f59c3f1d76c">tracks</a>)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01196"></a>01196     
<a name="l01197"></a>01197     <span class="comment">/* sanity checks */</span>
<a name="l01198"></a>01198     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, tracks, tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01199"></a>01199         <span class="keywordflow">return</span> 0;
<a name="l01200"></a>01200         
<a name="l01201"></a>01201     <span class="comment">/* check each track, stopping on the first hit */</span>
<a name="l01202"></a>01202     <span class="keywordflow">for</span> (nlt= tracks-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01203"></a>01203         <span class="keywordflow">if</span> (<a class="code" href="../../d9/de6/BKE__nla_8h.html#a1965d45d7e8c1346e18e1068fcc0f54f">BKE_nlatrack_has_animated_strips</a>(nlt))
<a name="l01204"></a>01204             <span class="keywordflow">return</span> 1;
<a name="l01205"></a>01205     }
<a name="l01206"></a>01206     
<a name="l01207"></a>01207     <span class="comment">/* none found */</span>
<a name="l01208"></a>01208     <span class="keywordflow">return</span> 0;
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="comment">/* Validate the NLA-Strips &#39;control&#39; F-Curves based on the flags set*/</span>
<a name="l01212"></a><a class="code" href="../../db/dee/nla_8c.html#aedfbb7312f0e96f653fb0b553b943a15">01212</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a6f3c2b338d1af7ef97ce61079655d83a">BKE_nlastrip_validate_fcurves</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip) 
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l01215"></a>01215     
<a name="l01216"></a>01216     <span class="comment">/* sanity checks */</span>
<a name="l01217"></a>01217     <span class="keywordflow">if</span> (strip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01218"></a>01218         <span class="keywordflow">return</span>;
<a name="l01219"></a>01219     
<a name="l01220"></a>01220     <span class="comment">/* if controlling influence... */</span>
<a name="l01221"></a>01221     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a2d56d980e801da66f56afde2d9ebd6bd">NLASTRIP_FLAG_USR_INFLUENCE</a>) {
<a name="l01222"></a>01222         <span class="comment">/* try to get F-Curve */</span>
<a name="l01223"></a>01223         fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, <span class="stringliteral">&quot;influence&quot;</span>, 0);
<a name="l01224"></a>01224         
<a name="l01225"></a>01225         <span class="comment">/* add one if not found */</span>
<a name="l01226"></a>01226         <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01227"></a>01227             <span class="comment">/* make new F-Curve */</span>
<a name="l01228"></a>01228             fcu= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a>), <span class="stringliteral">&quot;NlaStrip FCurve&quot;</span>);
<a name="l01229"></a>01229             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, fcu);
<a name="l01230"></a>01230             
<a name="l01231"></a>01231             <span class="comment">/* set default flags */</span>
<a name="l01232"></a>01232             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> = (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464abc4ace997641edbdb0f8724f583dffda">FCURVE_VISIBLE</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a663e89ede10f0771e57578f6ec020a8b">FCURVE_SELECTED</a>);
<a name="l01233"></a>01233             
<a name="l01234"></a>01234             <span class="comment">/* store path - make copy, and store that */</span>
<a name="l01235"></a>01235             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>= <a class="code" href="../../d3/db3/BLI__string_8h.html#a76968e0a4c961ec556481b473eddf2c5">BLI_strdupn</a>(<span class="stringliteral">&quot;influence&quot;</span>, 9);
<a name="l01236"></a>01236             
<a name="l01237"></a>01237             <span class="comment">// TODO: insert a few keyframes to ensure default behavior?</span>
<a name="l01238"></a>01238         }
<a name="l01239"></a>01239     }
<a name="l01240"></a>01240     
<a name="l01241"></a>01241     <span class="comment">/* if controlling time... */</span>
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a2f7a73a57fe2f49ab932efadbff6076c">NLASTRIP_FLAG_USR_TIME</a>) {
<a name="l01243"></a>01243         <span class="comment">/* try to get F-Curve */</span>
<a name="l01244"></a>01244         fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, <span class="stringliteral">&quot;strip_time&quot;</span>, 0);
<a name="l01245"></a>01245         
<a name="l01246"></a>01246         <span class="comment">/* add one if not found */</span>
<a name="l01247"></a>01247         <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01248"></a>01248             <span class="comment">/* make new F-Curve */</span>
<a name="l01249"></a>01249             fcu= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a>), <span class="stringliteral">&quot;NlaStrip FCurve&quot;</span>);
<a name="l01250"></a>01250             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, fcu);
<a name="l01251"></a>01251             
<a name="l01252"></a>01252             <span class="comment">/* set default flags */</span>
<a name="l01253"></a>01253             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> = (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464abc4ace997641edbdb0f8724f583dffda">FCURVE_VISIBLE</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a663e89ede10f0771e57578f6ec020a8b">FCURVE_SELECTED</a>);
<a name="l01254"></a>01254             
<a name="l01255"></a>01255             <span class="comment">/* store path - make copy, and store that */</span>
<a name="l01256"></a>01256             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>= <a class="code" href="../../d3/db3/BLI__string_8h.html#a76968e0a4c961ec556481b473eddf2c5">BLI_strdupn</a>(<span class="stringliteral">&quot;strip_time&quot;</span>, 10);
<a name="l01257"></a>01257             
<a name="l01258"></a>01258             <span class="comment">// TODO: insert a few keyframes to ensure default behavior?</span>
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261 }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <span class="comment">/* Sanity Validation ------------------------------------ */</span>
<a name="l01264"></a>01264 
<a name="l01265"></a><a class="code" href="../../db/dee/nla_8c.html#ae0c6819a464173cc3de6f29af3206c27">01265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/dee/nla_8c.html#ae0c6819a464173cc3de6f29af3206c27">nla_editbone_name_check</a>(<span class="keywordtype">void</span> *arg, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l01266"></a>01266 {
<a name="l01267"></a>01267     <span class="keywordflow">return</span> <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aaf17fe206dcb6b7b222b670b2a9570c1">BLI_ghash_haskey</a>((<a class="code" href="../../df/da0/structGHash.html">GHash</a> *)arg, (<span class="keywordtype">void</span> *)name);
<a name="l01268"></a>01268 }
<a name="l01269"></a>01269 
<a name="l01270"></a>01270 <span class="comment">/* Find (and set) a unique name for a strip from the whole AnimData block </span>
<a name="l01271"></a>01271 <span class="comment"> * Uses a similar method to the BLI method, but is implemented differently</span>
<a name="l01272"></a>01272 <span class="comment"> * as we need to ensure that the name is unique over several lists of tracks,</span>
<a name="l01273"></a>01273 <span class="comment"> * not just a single track.</span>
<a name="l01274"></a>01274 <span class="comment"> */</span>
<a name="l01275"></a><a class="code" href="../../db/dee/nla_8c.html#ad7e2901fc3e6be7dbc15c8a52b1da089">01275</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a3dc48bd590f3e9bde0afb153cf6901f4">BKE_nlastrip_validate_name</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip)
<a name="l01276"></a>01276 {
<a name="l01277"></a>01277     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *gh;
<a name="l01278"></a>01278     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *tstrip;
<a name="l01279"></a>01279     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01280"></a>01280     
<a name="l01281"></a>01281     <span class="comment">/* sanity checks */</span>
<a name="l01282"></a>01282     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, strip))
<a name="l01283"></a>01283         <span class="keywordflow">return</span>;
<a name="l01284"></a>01284         
<a name="l01285"></a>01285     <span class="comment">/* give strip a default name if none already */</span>
<a name="l01286"></a>01286     <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>[0]==0) {
<a name="l01287"></a>01287         <span class="keywordflow">switch</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a25fb6e5c5f8719f65f416f509751b0ca">type</a>) {
<a name="l01288"></a>01288             <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55aea70130d952e36e417d38704d3299339">NLASTRIP_TYPE_CLIP</a>: <span class="comment">/* act-clip */</span>
<a name="l01289"></a>01289                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>)?(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2):(<span class="stringliteral">&quot;&lt;No Action&gt;&quot;</span>), <span class="keyword">sizeof</span>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>));
<a name="l01290"></a>01290                 <span class="keywordflow">break</span>;
<a name="l01291"></a>01291             <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a507ee0ba236e46280991034c41d9b61a">NLASTRIP_TYPE_TRANSITION</a>: <span class="comment">/* transition */</span>
<a name="l01292"></a>01292                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, <span class="stringliteral">&quot;Transition&quot;</span>, <span class="keyword">sizeof</span>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>));
<a name="l01293"></a>01293                 <span class="keywordflow">break</span>;
<a name="l01294"></a>01294             <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#abddb46a0c18f6964b5dcec7f2de51b55a330575a46d56bc5ce45afa8b6b7d5bb2">NLASTRIP_TYPE_META</a>: <span class="comment">/* meta */</span>
<a name="l01295"></a>01295                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, <span class="stringliteral">&quot;Meta&quot;</span>, <span class="keyword">sizeof</span>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>));
<a name="l01296"></a>01296                 <span class="keywordflow">break</span>;
<a name="l01297"></a>01297             <span class="keywordflow">default</span>:
<a name="l01298"></a>01298                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, <span class="stringliteral">&quot;NLA Strip&quot;</span>, <span class="keyword">sizeof</span>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>));
<a name="l01299"></a>01299                 <span class="keywordflow">break</span>;
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     
<a name="l01303"></a>01303     <span class="comment">/* build a hash-table of all the strips in the tracks </span>
<a name="l01304"></a>01304 <span class="comment">     *  - this is easier than iterating over all the tracks+strips hierarchy everytime</span>
<a name="l01305"></a>01305 <span class="comment">     *    (and probably faster)</span>
<a name="l01306"></a>01306 <span class="comment">     */</span>
<a name="l01307"></a>01307     gh= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a5ef36990cf63a693451c76a8faf6b6f5">BLI_ghashutil_strhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a040511a3bdc5ab15ee0d7bf266f3773c">BLI_ghashutil_strcmp</a>, <span class="stringliteral">&quot;nlastrip_validate_name gh&quot;</span>);
<a name="l01308"></a>01308     
<a name="l01309"></a>01309     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01310"></a>01310         <span class="keywordflow">for</span> (tstrip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tstrip; tstrip= tstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01311"></a>01311             <span class="comment">/* don&#39;t add the strip of interest */</span>
<a name="l01312"></a>01312             <span class="keywordflow">if</span> (tstrip == strip) 
<a name="l01313"></a>01313                 <span class="keywordflow">continue</span>;
<a name="l01314"></a>01314             
<a name="l01315"></a>01315             <span class="comment">/* use the name of the strip as the key, and the strip as the value, since we&#39;re mostly interested in the keys */</span>
<a name="l01316"></a>01316             <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(gh, tstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, tstrip);
<a name="l01317"></a>01317         }
<a name="l01318"></a>01318     }
<a name="l01319"></a>01319     
<a name="l01320"></a>01320     <span class="comment">/* if the hash-table has a match for this name, try other names... </span>
<a name="l01321"></a>01321 <span class="comment">     *  - in an extreme case, it might not be able to find a name, but then everything else in Blender would fail too :)</span>
<a name="l01322"></a>01322 <span class="comment">     */</span>
<a name="l01323"></a>01323     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a55d85aa9be3dcae052659d317bdc962b">BLI_uniquename_cb</a>(<a class="code" href="../../db/dee/nla_8c.html#ae0c6819a464173cc3de6f29af3206c27">nla_editbone_name_check</a>, (<span class="keywordtype">void</span> *)gh, <span class="stringliteral">&quot;NlaStrip&quot;</span>, <span class="charliteral">&#39;.&#39;</span>, strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>, <span class="keyword">sizeof</span>(strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a6f1cff67542a68ac84229954d1fe08d2">name</a>));
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     <span class="comment">/* free the hash... */</span>
<a name="l01326"></a>01326     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(gh, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 <span class="comment">/* ---- */</span>
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 <span class="comment">/* Get strips which overlap the given one at the start/end of its range </span>
<a name="l01332"></a>01332 <span class="comment"> *  - strip: strip that we&#39;re finding overlaps for</span>
<a name="l01333"></a>01333 <span class="comment"> *  - track: nla-track that the overlapping strips should be found from</span>
<a name="l01334"></a>01334 <span class="comment"> *  - start, end: frames for the offending endpoints</span>
<a name="l01335"></a>01335 <span class="comment"> */</span>
<a name="l01336"></a><a class="code" href="../../db/dee/nla_8c.html#a58dbeef007a2db8b3d8695a3d1af95c4">01336</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dee/nla_8c.html#a58dbeef007a2db8b3d8695a3d1af95c4">nlastrip_get_endpoint_overlaps</a> (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *track, <span class="keywordtype">float</span> **start, <span class="keywordtype">float</span> **end)
<a name="l01337"></a>01337 {
<a name="l01338"></a>01338     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *nls;
<a name="l01339"></a>01339     
<a name="l01340"></a>01340     <span class="comment">/* find strips that overlap over the start/end of the given strip,</span>
<a name="l01341"></a>01341 <span class="comment">     * but which don&#39;t cover the entire length </span>
<a name="l01342"></a>01342 <span class="comment">     */</span>
<a name="l01343"></a>01343     <span class="comment">// TODO: this scheme could get quite slow for doing this on many strips...</span>
<a name="l01344"></a>01344     <span class="keywordflow">for</span> (nls= track-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nls; nls= nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01345"></a>01345         <span class="comment">/* check if strip overlaps (extends over or exactly on) the entire range of the strip we&#39;re validating */</span>
<a name="l01346"></a>01346         <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &lt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) &amp;&amp; (nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &gt;= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)) {
<a name="l01347"></a>01347             *start= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01348"></a>01348             *end= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01349"></a>01349             <span class="keywordflow">return</span>;
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351         
<a name="l01352"></a>01352         <span class="comment">/* check if strip doesn&#39;t even occur anywhere near... */</span>
<a name="l01353"></a>01353         <span class="keywordflow">if</span> (nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &lt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>)
<a name="l01354"></a>01354             <span class="keywordflow">continue</span>; <span class="comment">/* skip checking this strip... not worthy of mention */</span>
<a name="l01355"></a>01355         <span class="keywordflow">if</span> (nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &gt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)
<a name="l01356"></a>01356             <span class="keywordflow">return</span>; <span class="comment">/* the range we&#39;re after has already passed */</span>
<a name="l01357"></a>01357             
<a name="l01358"></a>01358         <span class="comment">/* if this strip is not part of an island of continuous strips, it can be used</span>
<a name="l01359"></a>01359 <span class="comment">         *  - this check needs to be done for each end of the strip we try and use...</span>
<a name="l01360"></a>01360 <span class="comment">         */</span>
<a name="l01361"></a>01361         <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)==0) {
<a name="l01362"></a>01362             <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &gt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>) &amp;&amp; (nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> &lt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>))
<a name="l01363"></a>01363                 *start= &amp;nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>;
<a name="l01364"></a>01364         }
<a name="l01365"></a>01365         <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>, nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>)==0) {
<a name="l01366"></a>01366             <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &lt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>) &amp;&amp; (nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &gt; strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>))
<a name="l01367"></a>01367                 *end= &amp;nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369     }
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 <span class="comment">/* Determine auto-blending for the given strip */</span>
<a name="l01373"></a><a class="code" href="../../db/dee/nla_8c.html#ab62851f30af8dde137ed1e5ebee0b109">01373</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/dee/nla_8c.html#ab62851f30af8dde137ed1e5ebee0b109">BKE_nlastrip_validate_autoblends</a> (<a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *nls)
<a name="l01374"></a>01374 {
<a name="l01375"></a>01375     <span class="keywordtype">float</span> *ps=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *pe=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01376"></a>01376     <span class="keywordtype">float</span> *ns=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *ne=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01377"></a>01377     
<a name="l01378"></a>01378     <span class="comment">/* sanity checks */</span>
<a name="l01379"></a>01379     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, nls, nlt))
<a name="l01380"></a>01380         <span class="keywordflow">return</span>;
<a name="l01381"></a>01381     <span class="keywordflow">if</span> ((nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l01382"></a>01382         <span class="keywordflow">return</span>;
<a name="l01383"></a>01383     <span class="keywordflow">if</span> ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a5957e93f21fddd289ccc66ac78c37b06">NLASTRIP_FLAG_AUTO_BLENDS</a>)==0)
<a name="l01384"></a>01384         <span class="keywordflow">return</span>;
<a name="l01385"></a>01385     
<a name="l01386"></a>01386     <span class="comment">/* get test ranges */</span>
<a name="l01387"></a>01387     <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>)
<a name="l01388"></a>01388         <a class="code" href="../../db/dee/nla_8c.html#a58dbeef007a2db8b3d8695a3d1af95c4">nlastrip_get_endpoint_overlaps</a>(nls, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>, &amp;ps, &amp;pe);
<a name="l01389"></a>01389     <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>)
<a name="l01390"></a>01390         <a class="code" href="../../db/dee/nla_8c.html#a58dbeef007a2db8b3d8695a3d1af95c4">nlastrip_get_endpoint_overlaps</a>(nls, nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>, &amp;ns, &amp;ne);
<a name="l01391"></a>01391         
<a name="l01392"></a>01392     <span class="comment">/* set overlaps for this strip </span>
<a name="l01393"></a>01393 <span class="comment">     *  - don&#39;t use the values obtained though if the end in question </span>
<a name="l01394"></a>01394 <span class="comment">     *    is directly followed/preceeded by another strip, forming an </span>
<a name="l01395"></a>01395 <span class="comment">     *    &#39;island&#39; of continuous strips</span>
<a name="l01396"></a>01396 <span class="comment">     */</span>
<a name="l01397"></a>01397     <span class="keywordflow">if</span> ((ps || ns) &amp;&amp; ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ace28c520f4fe04f5d37bc26f40f3c2d6">prev</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>, nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>)==0)) {
<a name="l01398"></a>01398         <span class="comment">/* start overlaps - pick the largest overlap */</span>
<a name="l01399"></a>01399         <span class="keywordflow">if</span> ( ((ps &amp;&amp; ns) &amp;&amp; (*ps &gt; *ns)) || (ps) )
<a name="l01400"></a>01400             nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ad6778347ff710e6c2e8d8fd6fee26da6">blendin</a>= *ps - nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l01401"></a>01401         <span class="keywordflow">else</span>
<a name="l01402"></a>01402             nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ad6778347ff710e6c2e8d8fd6fee26da6">blendin</a>= *ns - nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>;
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404     <span class="keywordflow">else</span> <span class="comment">/* no overlap allowed/needed */</span>
<a name="l01405"></a>01405         nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ad6778347ff710e6c2e8d8fd6fee26da6">blendin</a>= 0.0f;
<a name="l01406"></a>01406         
<a name="l01407"></a>01407     <span class="keywordflow">if</span> ((pe || ne) &amp;&amp; ((nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>, nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a>)==0)) {
<a name="l01408"></a>01408         <span class="comment">/* end overlaps - pick the largest overlap */</span>
<a name="l01409"></a>01409         <span class="keywordflow">if</span> ( ((pe &amp;&amp; ne) &amp;&amp; (*pe &gt; *ne)) || (pe) )
<a name="l01410"></a>01410             nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a404fbc7678f6a351e3fbef441a2bac04">blendout</a>= nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - *pe;
<a name="l01411"></a>01411         <span class="keywordflow">else</span>
<a name="l01412"></a>01412             nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a404fbc7678f6a351e3fbef441a2bac04">blendout</a>= nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a8d7f4a18c61cd0cac5cbe8a344e875a1">end</a> - *ne;
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414     <span class="keywordflow">else</span> <span class="comment">/* no overlap allowed/needed */</span>
<a name="l01415"></a>01415         nls-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a404fbc7678f6a351e3fbef441a2bac04">blendout</a>= 0.0f;
<a name="l01416"></a>01416 }
<a name="l01417"></a>01417 
<a name="l01418"></a>01418 <span class="comment">/* Ensure that auto-blending and other settings are set correctly */</span>
<a name="l01419"></a><a class="code" href="../../db/dee/nla_8c.html#a61330979e00f6aa6b79fbcd1ce7df55f">01419</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a87394b87f9cd2d2b667e55425a5b2da6">BKE_nla_validate_state</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt)
<a name="l01420"></a>01420 {
<a name="l01421"></a>01421     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *fstrip=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01422"></a>01422     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01423"></a>01423     
<a name="l01424"></a>01424     <span class="comment">/* sanity checks */</span>
<a name="l01425"></a>01425     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01426"></a>01426         <span class="keywordflow">return</span>;
<a name="l01427"></a>01427         
<a name="l01428"></a>01428     <span class="comment">/* adjust blending values for auto-blending, and also do an initial pass to find the earliest strip */</span>
<a name="l01429"></a>01429     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01430"></a>01430         <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01431"></a>01431             <span class="comment">/* auto-blending first */</span>
<a name="l01432"></a>01432             <a class="code" href="../../db/dee/nla_8c.html#ab62851f30af8dde137ed1e5ebee0b109">BKE_nlastrip_validate_autoblends</a>(nlt, strip);
<a name="l01433"></a>01433             
<a name="l01434"></a>01434             <span class="comment">/* extend mode - find first strip */</span>
<a name="l01435"></a>01435             <span class="keywordflow">if</span> ((fstrip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a> &lt; fstrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae2094c7a1fbf3ace399a32ec093c4fd5">start</a>))
<a name="l01436"></a>01436                 fstrip= strip;
<a name="l01437"></a>01437         }
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439     
<a name="l01440"></a>01440     <span class="comment">/* second pass over the strips to adjust the extend-mode to fix any problems */</span>
<a name="l01441"></a>01441     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01442"></a>01442         <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01443"></a>01443             <span class="comment">/* apart from &#39;nothing&#39; option which user has to explicitly choose, we don&#39;t really know if </span>
<a name="l01444"></a>01444 <span class="comment">             * we should be overwriting the extend setting (but assume that&#39;s what the user wanted)</span>
<a name="l01445"></a>01445 <span class="comment">             */</span>
<a name="l01446"></a>01446             <span class="comment">// TODO: 1 solution is to tie this in with auto-blending...</span>
<a name="l01447"></a>01447             <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae9070ad94fcfc0d7372652845dcd363f">extendmode</a> != <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a837ca549d74cba2a0bd31859e64d9f1fa3f57b0eb6ff21d2c99646bb180375911">NLASTRIP_EXTEND_NOTHING</a>) {
<a name="l01448"></a>01448                 <span class="comment">/* 1) First strip must be set to extend hold, otherwise, stuff before acts dodgy</span>
<a name="l01449"></a>01449 <span class="comment">                 * 2) Only overwrite extend mode if *not* changing it will most probably result in </span>
<a name="l01450"></a>01450 <span class="comment">                 * occlusion problems, which will occur iff</span>
<a name="l01451"></a>01451 <span class="comment">                 *  - blendmode = REPLACE</span>
<a name="l01452"></a>01452 <span class="comment">                 *  - all channels the same (this is fiddly to test, so is currently assumed)</span>
<a name="l01453"></a>01453 <span class="comment">                 *</span>
<a name="l01454"></a>01454 <span class="comment">                 * Should fix problems such as [#29869]</span>
<a name="l01455"></a>01455 <span class="comment">                 */</span>
<a name="l01456"></a>01456                 <span class="keywordflow">if</span> (strip == fstrip)
<a name="l01457"></a>01457                     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae9070ad94fcfc0d7372652845dcd363f">extendmode</a>= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a837ca549d74cba2a0bd31859e64d9f1fa4d8f38fd1c2f617ee7d83869d40adb56">NLASTRIP_EXTEND_HOLD</a>;
<a name="l01458"></a>01458                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a1358dcd7111a0e1e74c8a6bc31b117ce">blendmode</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9ed6c7dec74bcd329ad19acabaac2b4ba546bd3d62182655f892fc9f9b2d8f212">NLASTRIP_MODE_REPLACE</a>)
<a name="l01459"></a>01459                     strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae9070ad94fcfc0d7372652845dcd363f">extendmode</a>= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a837ca549d74cba2a0bd31859e64d9f1fa04515347118f3a82036b823261f3e5f3">NLASTRIP_EXTEND_HOLD_FORWARD</a>;
<a name="l01460"></a>01460             }
<a name="l01461"></a>01461         }
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 <span class="comment">/* Core Tools ------------------------------------------- */</span>
<a name="l01466"></a>01466 
<a name="l01467"></a>01467 <span class="comment">/* For the given AnimData block, add the active action to the NLA</span>
<a name="l01468"></a>01468 <span class="comment"> * stack (i.e. &#39;push-down&#39; action). The UI should only allow this </span>
<a name="l01469"></a>01469 <span class="comment"> * for normal editing only (i.e. not in editmode for some strip&#39;s action),</span>
<a name="l01470"></a>01470 <span class="comment"> * so no checks for this are performed.</span>
<a name="l01471"></a>01471 <span class="comment"> */</span>
<a name="l01472"></a>01472 <span class="comment">// TODO: maybe we should have checks for this too...</span>
<a name="l01473"></a><a class="code" href="../../db/dee/nla_8c.html#a68b1c5de40bbacfca02ec3ba2ddfa341">01473</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#a7fcaf1dc50785b9860d415bc91fc5179">BKE_nla_action_pushdown</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt)
<a name="l01474"></a>01474 {
<a name="l01475"></a>01475     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l01476"></a>01476     
<a name="l01477"></a>01477     <span class="comment">/* sanity checks */</span>
<a name="l01478"></a>01478     <span class="comment">// TODO: need to report the error for this</span>
<a name="l01479"></a>01479     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>))
<a name="l01480"></a>01480         <span class="keywordflow">return</span>;
<a name="l01481"></a>01481         
<a name="l01482"></a>01482     <span class="comment">/* if the action is empty, we also shouldn&#39;t try to add to stack, </span>
<a name="l01483"></a>01483 <span class="comment">     * as that will cause us grief down the track</span>
<a name="l01484"></a>01484 <span class="comment">     */</span>
<a name="l01485"></a>01485     <span class="comment">// TODO: what about modifiers?</span>
<a name="l01486"></a>01486     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df5/BKE__action_8h.html#ac6ffc43140f6a9961c1acad29f1a9af3">action_has_motion</a>(adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>) == 0) {
<a name="l01487"></a>01487         printf(<span class="stringliteral">&quot;BKE_nla_action_pushdown(): action has no data\n&quot;</span>);
<a name="l01488"></a>01488         <span class="keywordflow">return</span>;
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490     
<a name="l01491"></a>01491     <span class="comment">/* add a new NLA strip to the track, which references the active action */</span>
<a name="l01492"></a>01492     strip= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ad00a15832cf63c7d618884854d660742">add_nlastrip_to_stack</a>(adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>);
<a name="l01493"></a>01493     
<a name="l01494"></a>01494     <span class="comment">/* do other necessary work on strip */</span>  
<a name="l01495"></a>01495     <span class="keywordflow">if</span> (strip) {
<a name="l01496"></a>01496         <span class="comment">/* clear reference to action now that we&#39;ve pushed it onto the stack */</span>
<a name="l01497"></a>01497         <a class="code" href="../../d8/db1/BKE__library_8h.html#a2caead3c3bda9441d1a4affbbe0d328b">id_us_min</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>);
<a name="l01498"></a>01498         adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01499"></a>01499         
<a name="l01500"></a>01500         <span class="comment">/* if the strip is the first one in the track it lives in, check if there</span>
<a name="l01501"></a>01501 <span class="comment">         * are strips in any other tracks that may be before this, and set the extend</span>
<a name="l01502"></a>01502 <span class="comment">         * mode accordingly</span>
<a name="l01503"></a>01503 <span class="comment">         */</span>
<a name="l01504"></a>01504         <span class="keywordflow">if</span> (<a class="code" href="../../db/dee/nla_8c.html#a64294e12f3c103b3ded072af7a4a4235">nlastrip_is_first</a>(adt, strip) == 0) {
<a name="l01505"></a>01505             <span class="comment">/* not first, so extend mode can only be NLASTRIP_EXTEND_HOLD_FORWARD not NLASTRIP_EXTEND_HOLD,</span>
<a name="l01506"></a>01506 <span class="comment">             * so that it doesn&#39;t override strips in previous tracks</span>
<a name="l01507"></a>01507 <span class="comment">             */</span>
<a name="l01508"></a>01508             <span class="comment">// FIXME: this needs to be more automated, since user can rearrange strips</span>
<a name="l01509"></a>01509             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#ae9070ad94fcfc0d7372652845dcd363f">extendmode</a>= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a837ca549d74cba2a0bd31859e64d9f1fa04515347118f3a82036b823261f3e5f3">NLASTRIP_EXTEND_HOLD_FORWARD</a>;
<a name="l01510"></a>01510         }
<a name="l01511"></a>01511         
<a name="l01512"></a>01512         <span class="comment">/* make strip the active one... */</span>
<a name="l01513"></a>01513         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a2aed03d2f861f48e2a33351a30f9e741">BKE_nlastrip_set_active</a>(adt, strip);
<a name="l01514"></a>01514     }
<a name="l01515"></a>01515 }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 <span class="comment">/* Find the active strip + track combo, and set them up as the tweaking track,</span>
<a name="l01519"></a>01519 <span class="comment"> * and return if successful or not.</span>
<a name="l01520"></a>01520 <span class="comment"> */</span>
<a name="l01521"></a><a class="code" href="../../db/dee/nla_8c.html#a3d13f354f260464cb10bd93dc5974f83">01521</a> <span class="keywordtype">short</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#aa52a32f34323dd9dec77e49ad06b6ad1">BKE_nla_tweakmode_enter</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt)
<a name="l01522"></a>01522 {
<a name="l01523"></a>01523     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt, *activeTrack=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01524"></a>01524     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip, *activeStrip=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01525"></a>01525     
<a name="l01526"></a>01526     <span class="comment">/* verify that data is valid */</span>
<a name="l01527"></a>01527     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01528"></a>01528         <span class="keywordflow">return</span> 0;
<a name="l01529"></a>01529         
<a name="l01530"></a>01530     <span class="comment">/* if block is already in tweakmode, just leave, but we should report </span>
<a name="l01531"></a>01531 <span class="comment">     * that this block is in tweakmode (as our returncode)</span>
<a name="l01532"></a>01532 <span class="comment">     */</span>
<a name="l01533"></a>01533     <span class="keywordflow">if</span> (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673afe405d4c0a7ffe9fd822f85904916a4c">ADT_NLA_EDIT_ON</a>)
<a name="l01534"></a>01534         <span class="keywordflow">return</span> 1;
<a name="l01535"></a>01535         
<a name="l01536"></a>01536     <span class="comment">/* go over the tracks, finding the active one, and its active strip</span>
<a name="l01537"></a>01537 <span class="comment">     *  - if we cannot find both, then there&#39;s nothing to do</span>
<a name="l01538"></a>01538 <span class="comment">     */</span>
<a name="l01539"></a>01539     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01540"></a>01540         <span class="comment">/* check if active */</span>
<a name="l01541"></a>01541         <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba3bfcf76c5ef87c391346e6e7ab29b7f8">NLATRACK_ACTIVE</a>) {
<a name="l01542"></a>01542             <span class="comment">/* store reference to this active track */</span>
<a name="l01543"></a>01543             activeTrack= nlt;
<a name="l01544"></a>01544             
<a name="l01545"></a>01545             <span class="comment">/* now try to find active strip */</span>
<a name="l01546"></a>01546             activeStrip= <a class="code" href="../../d9/de6/BKE__nla_8h.html#a815347026dc7ae0222cbcf11e18c362e">BKE_nlastrip_find_active</a>(nlt);
<a name="l01547"></a>01547             <span class="keywordflow">break</span>;
<a name="l01548"></a>01548         }   
<a name="l01549"></a>01549     }
<a name="l01550"></a>01550     
<a name="l01551"></a>01551     <span class="comment">/* There are situations where we may have multiple strips selected and we want to enter tweakmode on all </span>
<a name="l01552"></a>01552 <span class="comment">     * of those at once. Usually in those cases, it will usually just be a single strip per AnimData. </span>
<a name="l01553"></a>01553 <span class="comment">     * In such cases, compromise and take the last selected track and/or last selected strip [#28468] </span>
<a name="l01554"></a>01554 <span class="comment">     */</span>
<a name="l01555"></a>01555     <span class="keywordflow">if</span> (activeTrack == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01556"></a>01556         <span class="comment">/* try last selected track for active strip */</span>
<a name="l01557"></a>01557         <span class="keywordflow">for</span> (nlt = adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>; nlt; nlt = nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>) {
<a name="l01558"></a>01558             <span class="keywordflow">if</span> (nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba652dbd32d48ab3c2de7b3d748f5b359c">NLATRACK_SELECTED</a>) {
<a name="l01559"></a>01559                 <span class="comment">/* assume this is the active track */</span>
<a name="l01560"></a>01560                 activeTrack= nlt;
<a name="l01561"></a>01561                 
<a name="l01562"></a>01562                 <span class="comment">/* try to find active strip */</span>
<a name="l01563"></a>01563                 activeStrip= <a class="code" href="../../d9/de6/BKE__nla_8h.html#a815347026dc7ae0222cbcf11e18c362e">BKE_nlastrip_find_active</a>(nlt);
<a name="l01564"></a>01564                 <span class="keywordflow">break</span>;
<a name="l01565"></a>01565             }
<a name="l01566"></a>01566         }   
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568     <span class="keywordflow">if</span> ((activeTrack) &amp;&amp; (activeStrip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l01569"></a>01569         <span class="comment">/* no active strip in active or last selected track; compromise for first selected (assuming only single)... */</span>
<a name="l01570"></a>01570         <span class="keywordflow">for</span> (strip = activeTrack-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01571"></a>01571             <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp; (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a86b1827bba79c6683cdbeb6b1b4799e5">NLASTRIP_FLAG_SELECT</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a11b77f0bda6fb63b936acc20b58496ac">NLASTRIP_FLAG_ACTIVE</a>)) {
<a name="l01572"></a>01572                 activeStrip = strip;
<a name="l01573"></a>01573                 <span class="keywordflow">break</span>;
<a name="l01574"></a>01574             }
<a name="l01575"></a>01575         }
<a name="l01576"></a>01576     }
<a name="l01577"></a>01577     
<a name="l01578"></a>01578     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, activeTrack, activeStrip, activeStrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>)) {
<a name="l01579"></a>01579         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) {
<a name="l01580"></a>01580             printf(<span class="stringliteral">&quot;NLA tweakmode enter - neither active requirement found\n&quot;</span>);
<a name="l01581"></a>01581             printf(<span class="stringliteral">&quot;\tactiveTrack = %p, activeStrip = %p\n&quot;</span>, (<span class="keywordtype">void</span> *)activeTrack, (<span class="keywordtype">void</span> *)activeStrip);
<a name="l01582"></a>01582         }
<a name="l01583"></a>01583         <span class="keywordflow">return</span> 0;
<a name="l01584"></a>01584     }
<a name="l01585"></a>01585         
<a name="l01586"></a>01586     <span class="comment">/* go over all the tracks up to the active one, tagging each strip that uses the same </span>
<a name="l01587"></a>01587 <span class="comment">     * action as the active strip, but leaving everything else alone</span>
<a name="l01588"></a>01588 <span class="comment">     */</span>
<a name="l01589"></a>01589     <span class="keywordflow">for</span> (nlt= activeTrack-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#aaa379eff1cc66ad0eeed63f3e19efe08">prev</a>) {
<a name="l01590"></a>01590         <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) {
<a name="l01591"></a>01591             <span class="keywordflow">if</span> (strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a> == activeStrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>)
<a name="l01592"></a>01592                 strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a96a72aa59e3b3b41bbafdaac20eb7991">NLASTRIP_FLAG_TWEAKUSER</a>;
<a name="l01593"></a>01593             <span class="keywordflow">else</span>
<a name="l01594"></a>01594                 strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a96a72aa59e3b3b41bbafdaac20eb7991">NLASTRIP_FLAG_TWEAKUSER</a>;
<a name="l01595"></a>01595         }
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597     
<a name="l01598"></a>01598     
<a name="l01599"></a>01599     <span class="comment">/* go over all the tracks after AND INCLUDING the active one, tagging them as being disabled </span>
<a name="l01600"></a>01600 <span class="comment">     *  - the active track needs to also be tagged, otherwise, it&#39;ll overlap with the tweaks going on</span>
<a name="l01601"></a>01601 <span class="comment">     */</span>
<a name="l01602"></a>01602     <span class="keywordflow">for</span> (nlt= activeTrack; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>)
<a name="l01603"></a>01603         nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba5ecdb6168b42848880be95e7c3b8b551">NLATRACK_DISABLED</a>;
<a name="l01604"></a>01604     
<a name="l01605"></a>01605     <span class="comment">/* handle AnimData level changes:</span>
<a name="l01606"></a>01606 <span class="comment">     *  - &#39;real&#39; active action to temp storage (no need to change user-counts)</span>
<a name="l01607"></a>01607 <span class="comment">     *  - action of active strip set to be the &#39;active action&#39;, and have its usercount incremented</span>
<a name="l01608"></a>01608 <span class="comment">     *  - editing-flag for this AnimData block should also get turned on (for more efficient restoring)</span>
<a name="l01609"></a>01609 <span class="comment">     *  - take note of the active strip for mapping-correction of keyframes in the action being edited</span>
<a name="l01610"></a>01610 <span class="comment">     */</span>
<a name="l01611"></a>01611     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a83b840e7e27825c0cb79de4433a92a03">tmpact</a>= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>;
<a name="l01612"></a>01612     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>= activeStrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>;
<a name="l01613"></a>01613     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a1b15d57a11f3d46b6c1a92d879c5a44b">actstrip</a>= activeStrip;
<a name="l01614"></a>01614     <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;activeStrip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#af4a3969b3858c5536d1842f7a55f11ac">act</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>);
<a name="l01615"></a>01615     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673afe405d4c0a7ffe9fd822f85904916a4c">ADT_NLA_EDIT_ON</a>;
<a name="l01616"></a>01616     
<a name="l01617"></a>01617     <span class="comment">/* done! */</span>
<a name="l01618"></a>01618     <span class="keywordflow">return</span> 1;
<a name="l01619"></a>01619 }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621 <span class="comment">/* Exit tweakmode for this AnimData block */</span>
<a name="l01622"></a><a class="code" href="../../db/dee/nla_8c.html#af01e7894dbe741441de26333e8509707">01622</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/de6/BKE__nla_8h.html#ad459b0824ec367ada95ad5b66e78a68d">BKE_nla_tweakmode_exit</a> (<a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt)
<a name="l01623"></a>01623 {
<a name="l01624"></a>01624     <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip;
<a name="l01625"></a>01625     <a class="code" href="../../d4/de0/structNlaTrack.html">NlaTrack</a> *nlt;
<a name="l01626"></a>01626     
<a name="l01627"></a>01627     <span class="comment">/* verify that data is valid */</span>
<a name="l01628"></a>01628     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l01629"></a>01629         <span class="keywordflow">return</span>;
<a name="l01630"></a>01630         
<a name="l01631"></a>01631     <span class="comment">/* hopefully the flag is correct - skip if not on */</span>
<a name="l01632"></a>01632     <span class="keywordflow">if</span> ((adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673afe405d4c0a7ffe9fd822f85904916a4c">ADT_NLA_EDIT_ON</a>) == 0)
<a name="l01633"></a>01633         <span class="keywordflow">return</span>;
<a name="l01634"></a>01634         
<a name="l01635"></a>01635     <span class="comment">// TODO: need to sync the user-strip with the new state of the action!</span>
<a name="l01636"></a>01636         
<a name="l01637"></a>01637     <span class="comment">/* for all Tracks, clear the &#39;disabled&#39; flag</span>
<a name="l01638"></a>01638 <span class="comment">     * for all Strips, clear the &#39;tweak-user&#39; flag</span>
<a name="l01639"></a>01639 <span class="comment">     */</span>
<a name="l01640"></a>01640     <span class="keywordflow">for</span> (nlt= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#ad6e27784ea3b52a7914bc9b00a47b5c1">nla_tracks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; nlt; nlt= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a66180948e7084122081dfb79b212764c">next</a>) {
<a name="l01641"></a>01641         nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a285fc1de1605286e8255be7e5edd4863">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ad4932569a7243266199669afdd3a36eba5ecdb6168b42848880be95e7c3b8b551">NLATRACK_DISABLED</a>;
<a name="l01642"></a>01642         
<a name="l01643"></a>01643         <span class="keywordflow">for</span> (strip= nlt-&gt;<a class="code" href="../../d4/de0/structNlaTrack.html#a48a60b4990af20f5ba014adf60ee2043">strips</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; strip; strip= strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a0e1bf52d90da905fbab053178c869a8e">next</a>) 
<a name="l01644"></a>01644             strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a38c39284c9b83acf3c582ca956ded9d1">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0b7bac2d7694a130339dbc176c1f39f2a96a72aa59e3b3b41bbafdaac20eb7991">NLASTRIP_FLAG_TWEAKUSER</a>;
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646     
<a name="l01647"></a>01647     <span class="comment">/* handle AnimData level changes:</span>
<a name="l01648"></a>01648 <span class="comment">     *  - &#39;temporary&#39; active action needs its usercount decreased, since we&#39;re removing this reference</span>
<a name="l01649"></a>01649 <span class="comment">     *  - &#39;real&#39; active action is restored from storage</span>
<a name="l01650"></a>01650 <span class="comment">     *  - storage pointer gets cleared (to avoid having bad notes hanging around)</span>
<a name="l01651"></a>01651 <span class="comment">     *  - editing-flag for this AnimData block should also get turned off</span>
<a name="l01652"></a>01652 <span class="comment">     *  - clear pointer to active strip</span>
<a name="l01653"></a>01653 <span class="comment">     */</span>
<a name="l01654"></a>01654     <span class="keywordflow">if</span> (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>) adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#ad0f2d8efde1fdd4f81ee9fe471313bd6">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l01655"></a>01655     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a83b840e7e27825c0cb79de4433a92a03">tmpact</a>;
<a name="l01656"></a>01656     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a83b840e7e27825c0cb79de4433a92a03">tmpact</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01657"></a>01657     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a1b15d57a11f3d46b6c1a92d879c5a44b">actstrip</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01658"></a>01658     adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a057740ebd2ecdddb141073b0f2e0f441">flag</a> &amp;= ~<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a0da68d088688075989bcf4f547c5b673afe405d4c0a7ffe9fd822f85904916a4c">ADT_NLA_EDIT_ON</a>;
<a name="l01659"></a>01659 }
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 <span class="comment">/* Baking Tools ------------------------------------------- */</span>
<a name="l01662"></a>01662 
<a name="l01663"></a><a class="code" href="../../db/dee/nla_8c.html#a1f3009eca96701813193356a99379b22">01663</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a26aa3564d15ae9e56cce569a324df5da">UNUSED_FUNCTION</a>(<a class="code" href="../../db/dee/nla_8c.html#a1f3009eca96701813193356a99379b22">BKE_nla_bake</a>) (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(<span class="keywordtype">id</span>), <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(flag))
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665 
<a name="l01666"></a>01666     <span class="comment">/* verify that data is valid </span>
<a name="l01667"></a>01667 <span class="comment">     *  1) Scene and AnimData must be provided </span>
<a name="l01668"></a>01668 <span class="comment">     *  2) there must be tracks to merge...</span>
<a name="l01669"></a>01669 <span class="comment">     */</span>
<a name="l01670"></a>01670     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, scene, adt, adt-&gt;nla_tracks.first))
<a name="l01671"></a>01671         <span class="keywordflow">return</span>;
<a name="l01672"></a>01672     
<a name="l01673"></a>01673     <span class="comment">/* if animdata currently has an action, &#39;push down&#39; this onto the stack first */</span>
<a name="l01674"></a>01674     <span class="keywordflow">if</span> (adt-&gt;action)
<a name="l01675"></a>01675         <a class="code" href="../../d9/de6/BKE__nla_8h.html#a7fcaf1dc50785b9860d415bc91fc5179">BKE_nla_action_pushdown</a>(adt);
<a name="l01676"></a>01676     
<a name="l01677"></a>01677     <span class="comment">/* get range of motion to bake, and the channels involved... */</span>
<a name="l01678"></a>01678     
<a name="l01679"></a>01679     <span class="comment">/* temporarily mute the action, and start keying to it */</span>
<a name="l01680"></a>01680     
<a name="l01681"></a>01681     <span class="comment">/* start keying... */</span>
<a name="l01682"></a>01682     
<a name="l01683"></a>01683     <span class="comment">/* unmute the action */</span>
<a name="l01684"></a>01684 }
<a name="l01685"></a>01685 
<a name="l01686"></a>01686 <span class="comment">/* *************************************************** */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:34 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
