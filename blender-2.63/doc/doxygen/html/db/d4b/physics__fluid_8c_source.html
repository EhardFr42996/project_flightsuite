<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: physics_fluid.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">physics_fluid.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/d4b/physics__fluid_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * fluidsim.c</span>
<a name="l00003"></a>00003 <span class="comment"> * </span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00008"></a>00008 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00009"></a>00009 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00010"></a>00010 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00018"></a>00018 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00019"></a>00019 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is Copyright (C) Blender Foundation</span>
<a name="l00022"></a>00022 <span class="comment"> * All rights reserved.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/* types */</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d2a/DNA__action__types_8h.html">DNA_action_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html">DNA_object_fluidsim.h</a>&quot;</span>    
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/ddf/BKE__blender_8h.html" title="Blender util stuff.">BKE_blender.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d5e/BKE__customdata_8h.html" title="CustomData interface, see also DNA_customdata_types.h.">BKE_customdata.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d65/BKE__effect_8h.html">BKE_effect.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/de3/BKE__fluidsim_8h.html">BKE_fluidsim.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d48/BKE__ipo_8h.html">BKE_ipo.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df9/BKE__softbody_8h.html">BKE_softbody.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d47/BKE__unit_8h.html">BKE_unit.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db4/LBM__fluidsim_8h.html">LBM_fluidsim.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d76/ED__fluidsim_8h.html">ED_fluidsim.h</a>&quot;</span>
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/de6/physics__intern_8h.html">physics_intern.h</a>&quot;</span> <span class="comment">// own include</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">/* enable/disable overall compilation */</span>
<a name="l00088"></a>00088 <span class="preprocessor">#ifdef WITH_MOD_FLUID</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d5e/DNA__ipo__types_8h.html">DNA_ipo_types.h</a>&quot;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">static</span> <span class="keywordtype">float</span> get_fluid_viscosity(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *settings)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <span class="keywordflow">return</span> (1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(10.0f, settings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a27f21b44babb4413ee54a96e37fab65c">viscosityExponent</a>)) * settings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a05c96771133d1da337172a3297123f8d">viscosityValue</a>;
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="keyword">static</span> <span class="keywordtype">float</span> get_fluid_rate(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *settings)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <span class="keywordtype">float</span> rate = 1.0f; <span class="comment">/* default rate if not animated... */</span>
<a name="l00107"></a>00107     
<a name="l00108"></a>00108     rate = settings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a2d5eec45a4cdd40ec245fec4481e85f0">animRate</a>;
<a name="l00109"></a>00109     
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (rate &lt; 0.0f)
<a name="l00111"></a>00111         rate = 0.0f;
<a name="l00112"></a>00112     
<a name="l00113"></a>00113     <span class="keywordflow">return</span> rate;
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="keyword">static</span> <span class="keywordtype">void</span> get_fluid_gravity(<span class="keywordtype">float</span> *gravity, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss)
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#ae4c1524b30f9e72a87543f428be1549c">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a508bb80abc11d94db2661ef7f6d0cc00">PHYS_GLOBAL_GRAVITY</a>) {
<a name="l00119"></a>00119         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gravity, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a1ad145e35a189d541a16b143c20f3fd6">gravity</a>);
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     <span class="keywordflow">else</span> {
<a name="l00122"></a>00122         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(gravity, fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a40dc07f48651613e22ecf8f8b998623e">grav</a>);
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="keyword">static</span> <span class="keywordtype">float</span> get_fluid_size_m(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *domainob, <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (!scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a3ac319ff602239809e75b3939a014846">system</a>) {
<a name="l00129"></a>00129         <span class="keywordflow">return</span> fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a43aadbe52c1af64d377bc62af87c4eca">realsize</a>;
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131     <span class="keywordflow">else</span> {
<a name="l00132"></a>00132         <span class="keywordtype">float</span> dim[3];
<a name="l00133"></a>00133         <span class="keywordtype">float</span> longest_axis;
<a name="l00134"></a>00134         
<a name="l00135"></a>00135         <a class="code" href="../../df/dac/BKE__object_8h.html#a988826cd2808744a49bc097c2794cea4">object_get_dimensions</a>(domainob, dim);
<a name="l00136"></a>00136         longest_axis = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(dim[0], dim[1], dim[2]);
<a name="l00137"></a>00137         
<a name="l00138"></a>00138         <span class="keywordflow">return</span> longest_axis * scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a0c970043cd1006145890fee0041a5161">scale_length</a>;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">int</span> fluid_is_animated_mesh(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss)
<a name="l00143"></a>00143 {
<a name="l00144"></a>00144     <span class="keywordflow">return</span> ((fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a> == <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a963539c357aa7a18eea7a6e1a9ad44f9">OB_FLUIDSIM_CONTROL</a>) || fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a7ff5cbb5910dd116c4a1a8e832e781da">domainNovecgen</a>);
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="comment">/* ********************** fluid sim settings struct functions ********************** */</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="preprocessor">#if 0</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span><span class="comment">/* helper function */</span>
<a name="l00151"></a>00151 <span class="keywordtype">void</span> fluidsimGetGeometryObjFilename(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">char</span> *dst) { <span class="comment">//, char *srcname)</span>
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="comment">//BLI_snprintf(dst,FILE_MAXFILE, &quot;%s_cfgdata_%s.bobj.gz&quot;, srcname, ob-&gt;id.name);</span>
<a name="l00154"></a>00154     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(dst,<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a40b3bb1f7d7c8c9bbf4e0ed92564e73e">FILE_MAXFILE</a>, <span class="stringliteral">&quot;fluidcfgdata_%s.bobj.gz&quot;</span>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 <span class="preprocessor">#endif</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/* ********************** fluid sim channel helper functions ********************** */</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="keyword">typedef</span> <span class="keyword">struct </span>FluidAnimChannels {
<a name="l00162"></a>00162     <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00163"></a>00163     
<a name="l00164"></a>00164     <span class="keywordtype">double</span> aniFrameTime;
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     <span class="keywordtype">float</span> *timeAtFrame;
<a name="l00167"></a>00167     <span class="keywordtype">float</span> *DomainTime;
<a name="l00168"></a>00168     <span class="keywordtype">float</span> *DomainGravity;
<a name="l00169"></a>00169     <span class="keywordtype">float</span> *DomainViscosity;
<a name="l00170"></a>00170 } FluidAnimChannels;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="keyword">typedef</span> <span class="keyword">struct </span>FluidObject {
<a name="l00173"></a>00173     <span class="keyword">struct </span>FluidObject *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, *prev;
<a name="l00174"></a>00174     
<a name="l00175"></a>00175     <span class="keyword">struct </span><a class="code" href="../../de/de7/structObject.html">Object</a> *object;
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="keywordtype">float</span> *<a class="code" href="../../d8/d27/transform_8c.html#acb82f96e2666723b581caf75c103db1e">Translation</a>;
<a name="l00178"></a>00178     <span class="keywordtype">float</span> *<a class="code" href="../../d8/d27/transform_8c.html#a47ba954f955f9b498d27f1c6973b91ad">Rotation</a>;
<a name="l00179"></a>00179     <span class="keywordtype">float</span> *<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a0354781b21f31accac3e15f930945c95">Scale</a>;
<a name="l00180"></a>00180     <span class="keywordtype">float</span> *Active;
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <span class="keywordtype">float</span> *InitialVelocity;
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     <span class="keywordtype">float</span> *AttractforceStrength;
<a name="l00185"></a>00185     <span class="keywordtype">float</span> *AttractforceRadius;
<a name="l00186"></a>00186     <span class="keywordtype">float</span> *VelocityforceStrength;
<a name="l00187"></a>00187     <span class="keywordtype">float</span> *VelocityforceRadius;
<a name="l00188"></a>00188     
<a name="l00189"></a>00189     <span class="keywordtype">float</span> *VertexCache;
<a name="l00190"></a>00190     <span class="keywordtype">int</span> numVerts, numTris;
<a name="l00191"></a>00191 } FluidObject;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">// no. of entries for the two channel sizes</span>
<a name="l00194"></a>00194 <span class="preprocessor">#define CHANNEL_FLOAT 1</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor">#define CHANNEL_VEC   3</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>
<a name="l00197"></a>00197 <span class="comment">// simplify channels before printing</span>
<a name="l00198"></a>00198 <span class="comment">// for API this is done anyway upon init</span>
<a name="l00199"></a>00199 <span class="preprocessor">#if 0</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> fluidsimPrintChannel(FILE *file, <span class="keywordtype">float</span> *channel, <span class="keywordtype">int</span> paramsize, <span class="keywordtype">char</span> *<a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>, <span class="keywordtype">int</span> entries) 
<a name="l00201"></a>00201 { 
<a name="l00202"></a>00202     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j; 
<a name="l00203"></a>00203     <span class="keywordtype">int</span> channelSize = paramsize; 
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (entries==3) {
<a name="l00206"></a>00206         <a class="code" href="../../d8/d00/elbeem_8h.html#a8649c6f0c49da9baf1b51f4ce885ea97">elbeemSimplifyChannelVec3</a>( channel, &amp;channelSize); 
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entries==1) {
<a name="l00209"></a>00209         <a class="code" href="../../d8/d00/elbeem_8h.html#a0eb895701aa35491d946684e73e9e39d">elbeemSimplifyChannelFloat</a>( channel, &amp;channelSize); 
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     <span class="keywordflow">else</span> {
<a name="l00212"></a>00212         <span class="comment">// invalid, cant happen?</span>
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     fprintf(file, <span class="stringliteral">&quot;      CHANNEL %s =\n&quot;</span>, str);
<a name="l00216"></a>00216     <span class="keywordflow">for</span> (i=0; i&lt;channelSize;i++) { 
<a name="l00217"></a>00217         fprintf(file,<span class="stringliteral">&quot;        &quot;</span>);  
<a name="l00218"></a>00218         <span class="keywordflow">for</span> (j=0;j&lt;=entries;j++) {  <span class="comment">// also print time value</span>
<a name="l00219"></a>00219             fprintf(file,<span class="stringliteral">&quot; %f &quot;</span>, channel[i*(entries+1)+j] ); 
<a name="l00220"></a>00220             <span class="keywordflow">if</span> (j==entries-1) { fprintf(file,<span class="stringliteral">&quot;  &quot;</span>); }
<a name="l00221"></a>00221         } 
<a name="l00222"></a>00222         fprintf(file,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00223"></a>00223     } 
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     fprintf(file,  <span class="stringliteral">&quot;      ;\n&quot;</span> );
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 <span class="preprocessor">#endif</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="comment">/* Note: fluid anim channel data layout</span>
<a name="l00231"></a>00231 <span class="comment"> * ------------------------------------</span>
<a name="l00232"></a>00232 <span class="comment"> * CHANNEL_FLOAT:</span>
<a name="l00233"></a>00233 <span class="comment"> * frame 1     |frame 2</span>
<a name="l00234"></a>00234 <span class="comment"> * [dataF][time][dataF][time]</span>
<a name="l00235"></a>00235 <span class="comment"> *</span>
<a name="l00236"></a>00236 <span class="comment"> * CHANNEL_VEC:</span>
<a name="l00237"></a>00237 <span class="comment"> * frame 1                   |frame 2</span>
<a name="l00238"></a>00238 <span class="comment"> * [dataX][dataY][dataZ][time][dataX][dataY][dataZ][time]</span>
<a name="l00239"></a>00239 <span class="comment"> *</span>
<a name="l00240"></a>00240 <span class="comment"> */</span>
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="keyword">static</span> <span class="keywordtype">void</span> init_time(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *domainSettings, FluidAnimChannels *channels)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00245"></a>00245     
<a name="l00246"></a>00246     channels-&gt;timeAtFrame = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (channels-&gt;length+1)*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;timeAtFrame channel&quot;</span>);
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     channels-&gt;timeAtFrame[0] = channels-&gt;timeAtFrame[1] = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a79dc15ef40b2137032eed93a5ef4d4f5">animStart</a>; <span class="comment">// start at index 1</span>
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <span class="keywordflow">for</span> (i=2; i &lt;= channels-&gt;length; i++) {
<a name="l00251"></a>00251         channels-&gt;timeAtFrame[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = channels-&gt;timeAtFrame[i-1] + channels-&gt;aniFrameTime;
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="comment">/* if this is slow, can replace with faster, less readable code */</span>
<a name="l00256"></a>00256 <span class="keyword">static</span> <span class="keywordtype">void</span> set_channel(<span class="keywordtype">float</span> *channel, <span class="keywordtype">float</span> time, <span class="keywordtype">float</span> *value, <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (size == CHANNEL_FLOAT) {
<a name="l00259"></a>00259         channel[(i * 2) + 0] = value[0];
<a name="l00260"></a>00260         channel[(i * 2) + 1] = time;
<a name="l00261"></a>00261     }
<a name="l00262"></a>00262     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size == CHANNEL_VEC) {
<a name="l00263"></a>00263         channel[(i * 4) + 0] = value[0];
<a name="l00264"></a>00264         channel[(i * 4) + 1] = value[1];
<a name="l00265"></a>00265         channel[(i * 4) + 2] = value[2];
<a name="l00266"></a>00266         channel[(i * 4) + 3] = time;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="keyword">static</span> <span class="keywordtype">void</span> set_vertex_channel(<span class="keywordtype">float</span> *channel, <span class="keywordtype">float</span> time, <span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keyword">struct</span> FluidObject *fobj, <span class="keywordtype">int</span> i)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = fobj-&gt;object;
<a name="l00273"></a>00273     <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00274"></a>00274     <span class="keywordtype">float</span> *verts;
<a name="l00275"></a>00275     <span class="keywordtype">int</span> *tris=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, numVerts=0, numTris=0;
<a name="l00276"></a>00276     <span class="keywordtype">int</span> modifierIndex = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ae1bd4562ce50876e3597bdeade156da4">modifiers_indexInObject</a>(ob, (<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *)fluidmd);
<a name="l00277"></a>00277     <span class="keywordtype">int</span> framesize = (3*fobj-&gt;numVerts) + 1;
<a name="l00278"></a>00278     <span class="keywordtype">int</span> j;
<a name="l00279"></a>00279     
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (channel == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00281"></a>00281         <span class="keywordflow">return</span>;
<a name="l00282"></a>00282     
<a name="l00283"></a>00283     <a class="code" href="../../df/de3/BKE__fluidsim_8h.html#adf51a1d03e8e78d38fb5980527687ea0">initElbeemMesh</a>(scene, ob, &amp;numVerts, &amp;verts, &amp;numTris, &amp;tris, 1, modifierIndex);
<a name="l00284"></a>00284     
<a name="l00285"></a>00285     <span class="comment">/* don&#39;t allow mesh to change number of verts in anim sequence */</span>
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (numVerts != fobj-&gt;numVerts) {
<a name="l00287"></a>00287         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channel);
<a name="l00288"></a>00288         channel = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00289"></a>00289         <span class="keywordflow">return</span>;
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291     
<a name="l00292"></a>00292     <span class="comment">/* fill frame of channel with vertex locations */</span>
<a name="l00293"></a>00293     <span class="keywordflow">for</span> (j=0; j &lt; (3*numVerts); j++) {
<a name="l00294"></a>00294         channel[i*framesize + j] = verts[j];
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296     channel[i*framesize + framesize-1] = time;
<a name="l00297"></a>00297     
<a name="l00298"></a>00298     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(verts);
<a name="l00299"></a>00299     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tris);
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="keyword">static</span> <span class="keywordtype">void</span> free_domain_channels(FluidAnimChannels *channels)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304     <span class="keywordflow">if</span> (!channels-&gt;timeAtFrame)
<a name="l00305"></a>00305         <span class="keywordflow">return</span>;
<a name="l00306"></a>00306     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channels-&gt;timeAtFrame);
<a name="l00307"></a>00307     channels-&gt;timeAtFrame = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00308"></a>00308     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channels-&gt;DomainGravity);
<a name="l00309"></a>00309     channels-&gt;DomainGravity = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00310"></a>00310     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channels-&gt;DomainViscosity);
<a name="l00311"></a>00311     channels-&gt;DomainViscosity = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00312"></a>00312     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channels-&gt;DomainTime);
<a name="l00313"></a>00313     channels-&gt;DomainTime = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="keyword">static</span> <span class="keywordtype">void</span> free_all_fluidobject_channels(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fobjects)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     FluidObject *fobj;
<a name="l00319"></a>00319     
<a name="l00320"></a>00320     <span class="keywordflow">for</span> (fobj=fobjects-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fobj; fobj=fobj-&gt;next) {
<a name="l00321"></a>00321         <span class="keywordflow">if</span> (fobj-&gt;Translation) {
<a name="l00322"></a>00322             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;Translation);
<a name="l00323"></a>00323             fobj-&gt;Translation = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00324"></a>00324             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;Rotation);
<a name="l00325"></a>00325             fobj-&gt;Rotation = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00326"></a>00326             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;Scale);
<a name="l00327"></a>00327             fobj-&gt;Scale = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00328"></a>00328             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;Active);
<a name="l00329"></a>00329             fobj-&gt;Active = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00330"></a>00330             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;InitialVelocity);
<a name="l00331"></a>00331             fobj-&gt;InitialVelocity = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333         
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (fobj-&gt;AttractforceStrength) {
<a name="l00335"></a>00335             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;AttractforceStrength);
<a name="l00336"></a>00336             fobj-&gt;AttractforceStrength = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00337"></a>00337             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;AttractforceRadius);
<a name="l00338"></a>00338             fobj-&gt;AttractforceRadius = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00339"></a>00339             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;VelocityforceStrength);
<a name="l00340"></a>00340             fobj-&gt;VelocityforceStrength = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00341"></a>00341             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;VelocityforceRadius);
<a name="l00342"></a>00342             fobj-&gt;VelocityforceRadius = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344         
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (fobj-&gt;VertexCache) {
<a name="l00346"></a>00346             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobj-&gt;VertexCache);
<a name="l00347"></a>00347             fobj-&gt;VertexCache = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="keyword">static</span> <span class="keywordtype">void</span> fluid_init_all_channels(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fsDomain), <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *domainSettings, FluidAnimChannels *channels, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fobjects)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00355"></a>00355     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l00356"></a>00356     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00357"></a>00357     <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a> = channels-&gt;length;
<a name="l00358"></a>00358     <span class="keywordtype">float</span> eval_time;
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     <span class="comment">/* init time values (assuming that time moves at a constant speed; may be overridden later) */</span>
<a name="l00361"></a>00361     init_time(domainSettings, channels);
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     <span class="comment">/* allocate domain animation channels */</span>
<a name="l00364"></a>00364     channels-&gt;DomainGravity = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_VEC+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;channel DomainGravity&quot;</span>);
<a name="l00365"></a>00365     channels-&gt;DomainViscosity = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;channel DomainViscosity&quot;</span>);
<a name="l00366"></a>00366     channels-&gt;DomainTime = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;channel DomainTime&quot;</span>);
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     <span class="comment">/* allocate fluid objects */</span>
<a name="l00369"></a>00369     <span class="keywordflow">for</span> (base=scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l00370"></a>00370         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l00371"></a>00371         <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00372"></a>00372         
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (fluidmd) {
<a name="l00374"></a>00374             FluidObject *fobj = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(FluidObject), <span class="stringliteral">&quot;Fluid Object&quot;</span>);
<a name="l00375"></a>00375             fobj-&gt;object = ob;
<a name="l00376"></a>00376             
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a59740b4f369e9d886cf9ce13752d6b8f">OB_FLUIDSIM_PARTICLE</a>)) {
<a name="l00378"></a>00378                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(fobjects, fobj);
<a name="l00379"></a>00379                 <span class="keywordflow">continue</span>;
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381             
<a name="l00382"></a>00382             fobj-&gt;Translation = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_VEC+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject Translation&quot;</span>);
<a name="l00383"></a>00383             fobj-&gt;Rotation = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_VEC+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject Rotation&quot;</span>);
<a name="l00384"></a>00384             fobj-&gt;Scale = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_VEC+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject Scale&quot;</span>);
<a name="l00385"></a>00385             fobj-&gt;Active = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject Active&quot;</span>);
<a name="l00386"></a>00386             fobj-&gt;InitialVelocity = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_VEC+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject InitialVelocity&quot;</span>);
<a name="l00387"></a>00387             
<a name="l00388"></a>00388             <span class="keywordflow">if</span> (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a> == <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a963539c357aa7a18eea7a6e1a9ad44f9">OB_FLUIDSIM_CONTROL</a>) {
<a name="l00389"></a>00389                 fobj-&gt;AttractforceStrength = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject AttractforceStrength&quot;</span>);
<a name="l00390"></a>00390                 fobj-&gt;AttractforceRadius = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject AttractforceRadius&quot;</span>);
<a name="l00391"></a>00391                 fobj-&gt;VelocityforceStrength = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject VelocityforceStrength&quot;</span>);
<a name="l00392"></a>00392                 fobj-&gt;VelocityforceRadius = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length * (CHANNEL_FLOAT+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject VelocityforceRadius&quot;</span>);
<a name="l00393"></a>00393             }
<a name="l00394"></a>00394             
<a name="l00395"></a>00395             <span class="keywordflow">if</span> (fluid_is_animated_mesh(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>)) {
<a name="l00396"></a>00396                 <span class="keywordtype">float</span> *verts=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00397"></a>00397                 <span class="keywordtype">int</span> *tris=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, modifierIndex = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ae1bd4562ce50876e3597bdeade156da4">modifiers_indexInObject</a>(ob, (<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *)fluidmd);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399                 <a class="code" href="../../df/de3/BKE__fluidsim_8h.html#adf51a1d03e8e78d38fb5980527687ea0">initElbeemMesh</a>(scene, ob, &amp;fobj-&gt;numVerts, &amp;verts, &amp;fobj-&gt;numTris, &amp;tris, 0, modifierIndex);
<a name="l00400"></a>00400                 fobj-&gt;VertexCache = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( length *((fobj-&gt;numVerts*CHANNEL_VEC)+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;fluidobject VertexCache&quot;</span>);
<a name="l00401"></a>00401                 
<a name="l00402"></a>00402                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(verts);
<a name="l00403"></a>00403                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tris);
<a name="l00404"></a>00404             }
<a name="l00405"></a>00405             
<a name="l00406"></a>00406             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(fobjects, fobj);
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409     
<a name="l00410"></a>00410     <span class="comment">/* now we loop over the frames and fill the allocated channels with data */</span>
<a name="l00411"></a>00411     <span class="keywordflow">for</span> (i=0; i&lt;channels-&gt;length; i++) {
<a name="l00412"></a>00412         FluidObject *fobj;
<a name="l00413"></a>00413         <span class="keywordtype">float</span> viscosity, gravity[3];
<a name="l00414"></a>00414         <span class="keywordtype">float</span> timeAtFrame, time;
<a name="l00415"></a>00415         
<a name="l00416"></a>00416         eval_time = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a252d3c09d07fa2e4f42574045fef27b6">bakeStart</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00417"></a>00417         
<a name="l00418"></a>00418         <span class="comment">/* XXX: This can&#39;t be used due to an anim sys optimization that ignores recalc object animation,</span>
<a name="l00419"></a>00419 <span class="comment">         * leaving it for the depgraph (this ignores object animation such as modifier properties though... :/ )</span>
<a name="l00420"></a>00420 <span class="comment">         * --&gt; BKE_animsys_evaluate_all_animation(G.main, eval_time);</span>
<a name="l00421"></a>00421 <span class="comment">         * This doesn&#39;t work with drivers:</span>
<a name="l00422"></a>00422 <span class="comment">         * --&gt; BKE_animsys_evaluate_animdata(&amp;fsDomain-&gt;id, fsDomain-&gt;adt, eval_time, ADT_RECALC_ALL);</span>
<a name="l00423"></a>00423 <span class="comment">         */</span>
<a name="l00424"></a>00424         
<a name="l00425"></a>00425         <span class="comment">/* Modifying the global scene isn&#39;t nice, but we can do it in </span>
<a name="l00426"></a>00426 <span class="comment">         * this part of the process before a threaded job is created */</span>
<a name="l00427"></a>00427         scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> = (int)eval_time;
<a name="l00428"></a>00428         <a class="code" href="../../d1/d12/ED__screen_8h.html#a064a1225eaf305ae55dc93b0d35fbf82">ED_update_for_newframe</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), scene, <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C), 1);
<a name="l00429"></a>00429         
<a name="l00430"></a>00430         <span class="comment">/* now scene data should be current according to animation system, so we fill the channels */</span>
<a name="l00431"></a>00431         
<a name="l00432"></a>00432         <span class="comment">/* Domain time */</span>
<a name="l00433"></a>00433         <span class="comment">// TODO: have option for not running sim, time mangling, in which case second case comes in handy</span>
<a name="l00434"></a>00434         <span class="keywordflow">if</span> (channels-&gt;DomainTime) {
<a name="l00435"></a>00435             time = get_fluid_rate(domainSettings) * channels-&gt;aniFrameTime;
<a name="l00436"></a>00436             timeAtFrame = channels-&gt;timeAtFrame[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + time;
<a name="l00437"></a>00437             
<a name="l00438"></a>00438             channels-&gt;timeAtFrame[i+1] = timeAtFrame;
<a name="l00439"></a>00439             set_channel(channels-&gt;DomainTime, i, &amp;time, i, CHANNEL_FLOAT);
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441         <span class="keywordflow">else</span> {
<a name="l00442"></a>00442             timeAtFrame = channels-&gt;timeAtFrame[i+1];
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444         
<a name="l00445"></a>00445         <span class="comment">/* Domain properties - gravity/viscosity */</span>
<a name="l00446"></a>00446         get_fluid_gravity(gravity, scene, domainSettings);
<a name="l00447"></a>00447         set_channel(channels-&gt;DomainGravity, timeAtFrame, gravity, i, CHANNEL_VEC);
<a name="l00448"></a>00448         viscosity = get_fluid_viscosity(domainSettings);
<a name="l00449"></a>00449         set_channel(channels-&gt;DomainViscosity, timeAtFrame, &amp;viscosity, i, CHANNEL_FLOAT);
<a name="l00450"></a>00450         
<a name="l00451"></a>00451         <span class="comment">/* object movement */</span>
<a name="l00452"></a>00452         <span class="keywordflow">for</span> (fobj=fobjects-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fobj; fobj=fobj-&gt;next) {
<a name="l00453"></a>00453             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = fobj-&gt;object;
<a name="l00454"></a>00454             <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00455"></a>00455             <span class="keywordtype">float</span> active= (float)(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a71cd12d25749b0af83047f181a541b6f">flag</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a69170b974b3c3d68a6afad9158378239">OB_FLUIDSIM_ACTIVE</a>);
<a name="l00456"></a>00456             <span class="keywordtype">float</span> rot_d[3] = {0.f, 0.f, 0.f}, old_rot[3] = {0.f, 0.f, 0.f};
<a name="l00457"></a>00457             
<a name="l00458"></a>00458             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a59740b4f369e9d886cf9ce13752d6b8f">OB_FLUIDSIM_PARTICLE</a>))
<a name="l00459"></a>00459                 <span class="keywordflow">continue</span>;
<a name="l00460"></a>00460             
<a name="l00461"></a>00461             <span class="comment">/* init euler rotation values and convert to elbeem format */</span>
<a name="l00462"></a>00462             <span class="comment">/* get the rotation from ob-&gt;obmat rather than ob-&gt;rot to account for parent animations */</span>
<a name="l00463"></a>00463             <span class="keywordflow">if</span> (i) {
<a name="l00464"></a>00464                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(old_rot, fobj-&gt;Rotation + 4*(i-1));
<a name="l00465"></a>00465                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(old_rot, -<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/180.f);
<a name="l00466"></a>00466             }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a2d776e2992ff428939bf6574238c66ef">mat4_to_compatible_eulO</a>(rot_d, old_rot, 0, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00469"></a>00469             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(rot_d, -180.f/<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l00470"></a>00470             
<a name="l00471"></a>00471             set_channel(fobj-&gt;Translation, timeAtFrame, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>, i, CHANNEL_VEC);
<a name="l00472"></a>00472             set_channel(fobj-&gt;Rotation, timeAtFrame, rot_d, i, CHANNEL_VEC);
<a name="l00473"></a>00473             set_channel(fobj-&gt;Scale, timeAtFrame, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a46e0f5309f8c13d85e16fa6436acf9f8">size</a>, i, CHANNEL_VEC);
<a name="l00474"></a>00474             set_channel(fobj-&gt;Active, timeAtFrame, &amp;active, i, CHANNEL_FLOAT);
<a name="l00475"></a>00475             set_channel(fobj-&gt;InitialVelocity, timeAtFrame, &amp;fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a315a3f3653dc25e776e3f617298024f8">iniVelx</a>, i, CHANNEL_VEC);
<a name="l00476"></a>00476             
<a name="l00477"></a>00477             <span class="keywordflow">if</span> (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a> == <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a963539c357aa7a18eea7a6e1a9ad44f9">OB_FLUIDSIM_CONTROL</a>) {
<a name="l00478"></a>00478                 set_channel(fobj-&gt;AttractforceStrength, timeAtFrame, &amp;fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a2d81cbe3025f870cd34377b11246e408">attractforceStrength</a>, i, CHANNEL_FLOAT);
<a name="l00479"></a>00479                 set_channel(fobj-&gt;AttractforceRadius, timeAtFrame, &amp;fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#ae45f7d1cf14b8c5a043785c1f0c2d992">attractforceRadius</a>, i, CHANNEL_FLOAT);
<a name="l00480"></a>00480                 set_channel(fobj-&gt;VelocityforceStrength, timeAtFrame, &amp;fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#acdf21c38b0f6935e68d37724a366160b">velocityforceStrength</a>, i, CHANNEL_FLOAT);
<a name="l00481"></a>00481                 set_channel(fobj-&gt;VelocityforceRadius, timeAtFrame, &amp;fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aef4c19630bfeb5d5be4c2c1a1771108e">velocityforceRadius</a>, i, CHANNEL_FLOAT);
<a name="l00482"></a>00482             }
<a name="l00483"></a>00483             
<a name="l00484"></a>00484             <span class="keywordflow">if</span> (fluid_is_animated_mesh(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>)) {
<a name="l00485"></a>00485                 set_vertex_channel(fobj-&gt;VertexCache, timeAtFrame, scene, fobj, i);
<a name="l00486"></a>00486             }
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="keyword">static</span> <span class="keywordtype">void</span> export_fluid_objects(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fobjects, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">int</span> length)
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493     FluidObject *fobj;
<a name="l00494"></a>00494     
<a name="l00495"></a>00495     <span class="keywordflow">for</span> (fobj=fobjects-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fobj; fobj=fobj-&gt;next) {
<a name="l00496"></a>00496         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = fobj-&gt;object;
<a name="l00497"></a>00497         <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00498"></a>00498         <span class="keywordtype">int</span> modifierIndex = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ae1bd4562ce50876e3597bdeade156da4">modifiers_indexInObject</a>(ob, (<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *)fluidmd);
<a name="l00499"></a>00499         
<a name="l00500"></a>00500         <span class="keywordtype">float</span> *verts=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00501"></a>00501         <span class="keywordtype">int</span> *tris=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00502"></a>00502         <span class="keywordtype">int</span> numVerts=0, numTris=0;
<a name="l00503"></a>00503         <span class="keywordtype">int</span> deform = fluid_is_animated_mesh(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>);
<a name="l00504"></a>00504         
<a name="l00505"></a>00505         <a class="code" href="../../d1/d67/structelbeemMesh.html">elbeemMesh</a> fsmesh;
<a name="l00506"></a>00506         
<a name="l00507"></a>00507         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a59740b4f369e9d886cf9ce13752d6b8f">OB_FLUIDSIM_PARTICLE</a>))
<a name="l00508"></a>00508             <span class="keywordflow">continue</span>;
<a name="l00509"></a>00509         
<a name="l00510"></a>00510         <a class="code" href="../../d8/d00/elbeem_8h.html#a4a59a08ca7e19ca2b268eb6ecf6bd8ee">elbeemResetMesh</a>( &amp;fsmesh );
<a name="l00511"></a>00511         
<a name="l00512"></a>00512         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad4f835b46caf8b18e9b18ae2e76b461a">type</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>;
<a name="l00513"></a>00513         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad14236d68f9984395f31921aff7cc799">name</a> = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>;
<a name="l00514"></a>00514         
<a name="l00515"></a>00515         <a class="code" href="../../df/de3/BKE__fluidsim_8h.html#adf51a1d03e8e78d38fb5980527687ea0">initElbeemMesh</a>(scene, ob, &amp;numVerts, &amp;verts, &amp;numTris, &amp;tris, 0, modifierIndex);
<a name="l00516"></a>00516         
<a name="l00517"></a>00517         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad199e2117b87a0c4b56e3dd85d5f94f3">numVertices</a>   = numVerts;
<a name="l00518"></a>00518         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a772faeac1bac583a737cb896126ba13e">numTriangles</a>  = numTris;
<a name="l00519"></a>00519         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a4d9a1a61f8fdd48cfef692abc55b21b9">vertices</a>      = verts;
<a name="l00520"></a>00520         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a0a3445f338f0b90ece185f52194ddf82">triangles</a>     = tris;
<a name="l00521"></a>00521         
<a name="l00522"></a>00522         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a6c2ac956f0b9adbc33a64d19d103a8ea">channelSizeTranslation</a>  = 
<a name="l00523"></a>00523         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a58a9a6d346cb339b69008eb2bb9e1cfb">channelSizeRotation</a>     = 
<a name="l00524"></a>00524         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aaf310351b6f20cc58f092ffb83e7d805">channelSizeScale</a>        = 
<a name="l00525"></a>00525         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aa2ab9650dff4cc0aea1c6d9565c8da45">channelSizeInitialVel</a>   = 
<a name="l00526"></a>00526         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aaceeaedd31e20e9d44b47b4fcdd0707c">channelSizeActive</a>       = <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00527"></a>00527         
<a name="l00528"></a>00528         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a68f9423aae5f7a2abc656374314dd01d">channelTranslation</a>      = fobj-&gt;Translation;
<a name="l00529"></a>00529         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a74a4ea85b4e5a4ee581a5b5eff831f3e">channelRotation</a>         = fobj-&gt;Rotation;
<a name="l00530"></a>00530         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a05a79d731027ec3ef0bab074c1fc7220">channelScale</a>            = fobj-&gt;Scale;
<a name="l00531"></a>00531         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a09586c5e1fe145f7ec8dab4e80f3a04d">channelActive</a>           = fobj-&gt;Active;
<a name="l00532"></a>00532         
<a name="l00533"></a>00533         <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad4f835b46caf8b18e9b18ae2e76b461a">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeed5182a5a6fb69bebbe4e49c526dfdc">OB_FLUIDSIM_FLUID</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a4f9d1ea47ee6e99ec98632a3b0991f70">OB_FLUIDSIM_INFLOW</a>)) {
<a name="l00534"></a>00534             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a2cbe9fef37a3a31bd8b2c68ca6164c9e">channelInitialVel</a> = fobj-&gt;InitialVelocity;
<a name="l00535"></a>00535             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a5854a8ef8356991312638af93d2dbb3d">localInivelCoords</a> = ((fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a2c90fc734701657d9522a50b7dd9331f">OB_FSINFLOW_LOCALCOORD</a>)?1:0);
<a name="l00536"></a>00536         } 
<a name="l00537"></a>00537         
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#ac397e8b09765445d3f2a5ee61a25eebc">OB_FSBND_NOSLIP</a>)
<a name="l00539"></a>00539             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ae0916b078ea7df5f6e0abf31cff3bba8">obstacleType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#ac83976a5929415117a8a8823fe481ff0">FLUIDSIM_OBSTACLE_NOSLIP</a>;
<a name="l00540"></a>00540         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a73f653cf7bbce17fa41a10fd6e8f1547">OB_FSBND_PARTSLIP</a>)
<a name="l00541"></a>00541             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ae0916b078ea7df5f6e0abf31cff3bba8">obstacleType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#add9f864fbe2637ae205b5d229596a441">FLUIDSIM_OBSTACLE_PARTSLIP</a>;
<a name="l00542"></a>00542         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a274003182308a7c3ef0e58f6d1e1dd7e">OB_FSBND_FREESLIP</a>)
<a name="l00543"></a>00543             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ae0916b078ea7df5f6e0abf31cff3bba8">obstacleType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#a43074590bb0f68b1c6220f578de2758a">FLUIDSIM_OBSTACLE_FREESLIP</a>;
<a name="l00544"></a>00544         
<a name="l00545"></a>00545         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aaf48c5dbeb5822e5c02efd44e1fc60be">obstaclePartslip</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a048c5b6d4a4ab2462a6d2225e58c49cb">partSlipValue</a>;
<a name="l00546"></a>00546         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a612931a39335abed77661a5fc71aba6c">volumeInitType</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a1cdf827f53a222a54bed4fb5f50766da">volumeInitType</a>;
<a name="l00547"></a>00547         fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a1de545f3386753f7bbe45d6739c3e0ee">obstacleImpactFactor</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#add459d00b8c4749438d3b6cba9ab3acd">surfaceSmoothing</a>; <span class="comment">// misused value</span>
<a name="l00548"></a>00548         
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad4f835b46caf8b18e9b18ae2e76b461a">type</a> == <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a963539c357aa7a18eea7a6e1a9ad44f9">OB_FLUIDSIM_CONTROL</a>) {
<a name="l00550"></a>00550             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a0aa4b327b9884ebccaaf75349f49bbf1">cpsTimeStart</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a547a90e5c6a6b0791f712a3089b46bfd">cpsTimeStart</a>;
<a name="l00551"></a>00551             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aea0d0b5fd96a43813bac675600c70a51">cpsTimeEnd</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a08a68c34a7bc51f6e9a666d641347ac6">cpsTimeEnd</a>;
<a name="l00552"></a>00552             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ae9d67eb4b4c95824123c90b9aab84571">cpsQuality</a> = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a829f03fdac231511407c83ba7c81c227">cpsQuality</a>;
<a name="l00553"></a>00553             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ae0916b078ea7df5f6e0abf31cff3bba8">obstacleType</a> = (fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a71cd12d25749b0af83047f181a541b6f">flag</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a7c2fdaeed87cc05bbcef6b6472ea9336">OB_FLUIDSIM_REVERSE</a>);
<a name="l00554"></a>00554             
<a name="l00555"></a>00555             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ac2244d65afc60babf4d3e54ad803e771">channelSizeAttractforceRadius</a> = 
<a name="l00556"></a>00556             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a0be014b78140d13eef650aaa4231a6c8">channelSizeVelocityforceStrength</a> = 
<a name="l00557"></a>00557             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a29f3778bccfe2d931efe2a5549970e21">channelSizeVelocityforceRadius</a> = 
<a name="l00558"></a>00558             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aa58de21a375d291f2618928db7034d0b">channelSizeAttractforceStrength</a> = <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00559"></a>00559             
<a name="l00560"></a>00560             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a4db7613e612c278d2d15d2d152077a63">channelAttractforceStrength</a> = fobj-&gt;AttractforceStrength;
<a name="l00561"></a>00561             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a16b4fcd9896f3a47ffeba4e3cff4a564">channelAttractforceRadius</a> = fobj-&gt;AttractforceRadius;
<a name="l00562"></a>00562             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aee496e0be8be654c9bf74dcf273365bd">channelVelocityforceStrength</a> = fobj-&gt;VelocityforceStrength;
<a name="l00563"></a>00563             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad656ef21e839e84770d04de901f70f11">channelVelocityforceRadius</a> = fobj-&gt;VelocityforceRadius;
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565         <span class="keywordflow">else</span> {
<a name="l00566"></a>00566             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a4db7613e612c278d2d15d2d152077a63">channelAttractforceStrength</a> =
<a name="l00567"></a>00567             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a16b4fcd9896f3a47ffeba4e3cff4a564">channelAttractforceRadius</a> = 
<a name="l00568"></a>00568             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#aee496e0be8be654c9bf74dcf273365bd">channelVelocityforceStrength</a> = 
<a name="l00569"></a>00569             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#ad656ef21e839e84770d04de901f70f11">channelVelocityforceRadius</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; 
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571         
<a name="l00572"></a>00572         <span class="comment">/* animated meshes */</span>
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (deform) {
<a name="l00574"></a>00574             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a4ef0a836228a344709e2f0d7a9272921">channelSizeVertices</a> = <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00575"></a>00575             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a89484f22284a7428150a0bacb31ca4de">channelVertices</a> = fobj-&gt;VertexCache;
<a name="l00576"></a>00576                 
<a name="l00577"></a>00577             <span class="comment">// remove channels</span>
<a name="l00578"></a>00578             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a68f9423aae5f7a2abc656374314dd01d">channelTranslation</a>      = 
<a name="l00579"></a>00579             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a74a4ea85b4e5a4ee581a5b5eff831f3e">channelRotation</a>         = 
<a name="l00580"></a>00580             fsmesh.<a class="code" href="../../d1/d67/structelbeemMesh.html#a05a79d731027ec3ef0bab074c1fc7220">channelScale</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; 
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582         
<a name="l00583"></a>00583         <a class="code" href="../../d8/d00/elbeem_8h.html#ab1556477f4744dd39d2c5c099b7ab423">elbeemAddMesh</a>(&amp;fsmesh);
<a name="l00584"></a>00584         
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (verts) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(verts);
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (tris) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tris);
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="keyword">static</span> <span class="keywordtype">int</span> fluid_validate_scene(<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *fsDomain)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l00593"></a>00593     <a class="code" href="../../de/de7/structObject.html">Object</a> *newdomain = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00594"></a>00594     <span class="keywordtype">int</span> channelObjCount = 0;
<a name="l00595"></a>00595     <span class="keywordtype">int</span> fluidInputCount = 0;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="keywordflow">for</span> (base=scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>)
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l00600"></a>00600         <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmdtmp = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);            
<a name="l00601"></a>00601 
<a name="l00602"></a>00602         <span class="comment">/* only find objects with fluid modifiers */</span>
<a name="l00603"></a>00603         <span class="keywordflow">if</span> (!fluidmdtmp || ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) <span class="keywordflow">continue</span>;
<a name="l00604"></a>00604             
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (fluidmdtmp-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a> == <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>) {
<a name="l00606"></a>00606             <span class="comment">/* if no initial domain object given, find another potential domain */</span>
<a name="l00607"></a>00607             <span class="keywordflow">if</span> (!fsDomain) {
<a name="l00608"></a>00608                 newdomain = ob;
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610             <span class="comment">/* if there&#39;s more than one domain, cancel */</span>
<a name="l00611"></a>00611             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsDomain &amp;&amp; ob != fsDomain) {
<a name="l00612"></a>00612                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;There should be only one domain object&quot;</span>);
<a name="l00613"></a>00613                 <span class="keywordflow">return</span> 0;
<a name="l00614"></a>00614             }
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         
<a name="l00617"></a>00617         <span class="comment">/* count number of objects needed for animation channels */</span>
<a name="l00618"></a>00618         <span class="keywordflow">if</span> ( !<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fluidmdtmp-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeab4c3ed306761a0100bbc34495df12e">OB_FLUIDSIM_DOMAIN</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a59740b4f369e9d886cf9ce13752d6b8f">OB_FLUIDSIM_PARTICLE</a>) )
<a name="l00619"></a>00619             channelObjCount++;
<a name="l00620"></a>00620         
<a name="l00621"></a>00621         <span class="comment">/* count number of fluid input objects */</span>
<a name="l00622"></a>00622         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(fluidmdtmp-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa82fde23a83404f1848b01db5e08c676">type</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#aeed5182a5a6fb69bebbe4e49c526dfdc">OB_FLUIDSIM_FLUID</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a4f9d1ea47ee6e99ec98632a3b0991f70">OB_FLUIDSIM_INFLOW</a>))
<a name="l00623"></a>00623             fluidInputCount++;
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (newdomain)
<a name="l00627"></a>00627         fsDomain = newdomain;
<a name="l00628"></a>00628     
<a name="l00629"></a>00629     <span class="keywordflow">if</span> (!fsDomain) {
<a name="l00630"></a>00630         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No domain object found&quot;</span>);
<a name="l00631"></a>00631         <span class="keywordflow">return</span> 0;
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633     
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (channelObjCount&gt;=255) {
<a name="l00635"></a>00635         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Cannot bake with more then 256 objects&quot;</span>);
<a name="l00636"></a>00636         <span class="keywordflow">return</span> 0;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638     
<a name="l00639"></a>00639     <span class="keywordflow">if</span> (fluidInputCount == 0) {
<a name="l00640"></a>00640         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No fluid input objects in the scene&quot;</span>);
<a name="l00641"></a>00641         <span class="keywordflow">return</span> 0;
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643     
<a name="l00644"></a>00644     <span class="keywordflow">return</span> 1;
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="preprocessor">#define FLUID_SUFFIX_CONFIG     &quot;fluidsim.cfg&quot;</span>
<a name="l00649"></a>00649 <span class="preprocessor"></span><span class="preprocessor">#define FLUID_SUFFIX_CONFIG_TMP (FLUID_SUFFIX_CONFIG &quot;.tmp&quot;)</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span><span class="preprocessor">#define FLUID_SUFFIX_SURFACE    &quot;fluidsurface&quot;</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>
<a name="l00652"></a>00652 <span class="keyword">static</span> <span class="keywordtype">int</span> fluid_init_filepaths(<a class="code" href="../../de/de7/structObject.html">Object</a> *fsDomain, <span class="keywordtype">char</span> *targetDir, <span class="keywordtype">char</span> *targetFile, <span class="keywordtype">char</span> *debugStrBuffer)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(fsDomain, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00655"></a>00655     <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *domainSettings= fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>; 
<a name="l00656"></a>00656     FILE *fileCfg;
<a name="l00657"></a>00657     <span class="keywordtype">int</span> dirExist = 0;
<a name="l00658"></a>00658     <span class="keywordtype">char</span> newSurfdataPath[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>]; <span class="comment">// modified output settings</span>
<a name="l00659"></a>00659     <span class="keyword">const</span> <span class="keywordtype">char</span> *suffixConfigTmp = FLUID_SUFFIX_CONFIG_TMP;
<a name="l00660"></a>00660     <span class="keywordtype">int</span> outStringsChanged = 0;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="comment">// prepare names...</span>
<a name="l00663"></a>00663     <span class="keyword">const</span> <span class="keywordtype">char</span> *relbase= <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a0e4a2d2784b8ca3c1b20c7268e1e68b4">modifier_path_relbase</a>(fsDomain);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(targetDir, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#af231ebb113f3f085906d83d6424abefb">FILE_MAXDIR</a>);
<a name="l00666"></a>00666     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(newSurfdataPath, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#af231ebb113f3f085906d83d6424abefb">FILE_MAXDIR</a>); <span class="comment">/* if 0&#39;d out below, this value is never used! */</span>
<a name="l00667"></a>00667     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(targetDir, relbase); <span class="comment">// fixed #frame-no</span>
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="comment">/* .tmp: don&#39;t overwrite/delete original file */</span>
<a name="l00670"></a>00670     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(targetFile, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, targetDir, suffixConfigTmp);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="comment">// make sure all directories exist</span>
<a name="l00673"></a>00673     <span class="comment">// as the bobjs use the same dir, this only needs to be checked</span>
<a name="l00674"></a>00674     <span class="comment">// for the cfg output</span>
<a name="l00675"></a>00675     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(targetFile);
<a name="l00676"></a>00676     
<a name="l00677"></a>00677     <span class="comment">// check selected directory</span>
<a name="l00678"></a>00678     <span class="comment">// simply try to open cfg file for writing to test validity of settings</span>
<a name="l00679"></a>00679     fileCfg = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a270e4b01aaea72fa0d091cf3b32015af">BLI_fopen</a>(targetFile, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (fileCfg) { 
<a name="l00681"></a>00681         dirExist = 1; fclose(fileCfg); 
<a name="l00682"></a>00682         <span class="comment">// remove cfg dummy from  directory test</span>
<a name="l00683"></a>00683         <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(targetFile, 0,0);
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685     
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (targetDir[0] == <span class="charliteral">&#39;\0&#39;</span> || (!dirExist)) {
<a name="l00687"></a>00687         <span class="keywordtype">char</span> blendDir[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00688"></a>00688         <span class="keywordtype">char</span> blendFile[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00689"></a>00689         
<a name="l00690"></a>00690         <span class="comment">// invalid dir, reset to current/previous</span>
<a name="l00691"></a>00691         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(blendDir, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l00692"></a>00692         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a9587680f8895016dd21016fcecb476b0">BLI_splitdirstring</a>(blendDir, blendFile);
<a name="l00693"></a>00693         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#afa3da8cc53a62041acbb98eb6a9805c4">BLI_replace_extension</a>(blendFile, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, <span class="stringliteral">&quot;&quot;</span>); <span class="comment">/* strip .blend */</span>
<a name="l00694"></a>00694 
<a name="l00695"></a>00695         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(newSurfdataPath, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a> ,<span class="stringliteral">&quot;//fluidsimdata/%s_%s_&quot;</span>, blendFile, fsDomain-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l00696"></a>00696         
<a name="l00697"></a>00697         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer, 256, <span class="stringliteral">&quot;fluidsimBake::error - warning resetting output dir to &#39;%s&#39;\n&quot;</span>, newSurfdataPath);
<a name="l00698"></a>00698         <a class="code" href="../../d8/d00/elbeem_8h.html#abf5a83d9f745420c60f29493d5a74bc5">elbeemDebugOut</a>(debugStrBuffer);
<a name="l00699"></a>00699         outStringsChanged=1;
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     
<a name="l00702"></a>00702     <span class="comment">// check if modified output dir is ok</span>
<a name="l00703"></a>00703 <span class="preprocessor">#if 0</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (outStringsChanged) {
<a name="l00705"></a>00705         <span class="keywordtype">char</span> dispmsg[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>+256];
<a name="l00706"></a>00706         <span class="keywordtype">int</span>  selection=0;
<a name="l00707"></a>00707         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(dispmsg,<span class="stringliteral">&quot;Output settings set to: &#39;&quot;</span>, <span class="keyword">sizeof</span>(dispmsg));
<a name="l00708"></a>00708         strcat(dispmsg, newSurfdataPath);
<a name="l00709"></a>00709         strcat(dispmsg, <span class="stringliteral">&quot;&#39;%t|Continue with changed settings%x1|Discard and abort%x0&quot;</span>);
<a name="l00710"></a>00710         
<a name="l00711"></a>00711         <span class="comment">// ask user if thats what he/she wants...</span>
<a name="l00712"></a>00712         selection = <a class="code" href="../../d6/db5/object__edit_8c.html#a6f935fee7a3c6e413fac3693c8305992">pupmenu</a>(dispmsg);
<a name="l00713"></a>00713         <span class="keywordflow">if</span> (selection&lt;1) <span class="keywordflow">return</span> 0; <span class="comment">// 0 from menu, or -1 aborted</span>
<a name="l00714"></a>00714         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(targetDir, newSurfdataPath, <span class="keyword">sizeof</span>(targetDir));
<a name="l00715"></a>00715         strncpy(domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, newSurfdataPath, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#af231ebb113f3f085906d83d6424abefb">FILE_MAXDIR</a>);
<a name="l00716"></a>00716         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(targetDir, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name); <span class="comment">// fixed #frame-no </span>
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718 <span class="preprocessor">#endif  </span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>    <span class="keywordflow">return</span> outStringsChanged;
<a name="l00720"></a>00720 }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="comment">/* ******************************************************************************** */</span>
<a name="l00723"></a>00723 <span class="comment">/* ********************** write fluidsim config to file ************************* */</span>
<a name="l00724"></a>00724 <span class="comment">/* ******************************************************************************** */</span>
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 <span class="keyword">typedef</span> <span class="keyword">struct </span>FluidBakeJob {
<a name="l00727"></a>00727     <span class="comment">/* from wmJob */</span>
<a name="l00728"></a>00728     <span class="keywordtype">void</span> *owner;
<a name="l00729"></a>00729     <span class="keywordtype">short</span> *stop, *do_update;
<a name="l00730"></a>00730     <span class="keywordtype">float</span> *progress;
<a name="l00731"></a>00731     <span class="keywordtype">int</span> current_frame;
<a name="l00732"></a>00732     <a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a> *settings;
<a name="l00733"></a>00733 } FluidBakeJob;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidbake_free(<span class="keywordtype">void</span> *customdata)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737     FluidBakeJob *<a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>= (FluidBakeJob *)customdata;
<a name="l00738"></a>00738     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fb);
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <span class="comment">/* called by fluidbake, only to check job &#39;stop&#39; value */</span>
<a name="l00742"></a>00742 <span class="keyword">static</span> <span class="keywordtype">int</span> fluidbake_breakjob(<span class="keywordtype">void</span> *customdata)
<a name="l00743"></a>00743 {
<a name="l00744"></a>00744     FluidBakeJob *<a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>= (FluidBakeJob *)customdata;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (fb-&gt;stop &amp;&amp; *(fb-&gt;stop))
<a name="l00747"></a>00747         <span class="keywordflow">return</span> 1;
<a name="l00748"></a>00748     
<a name="l00749"></a>00749     <span class="comment">/* this is not nice yet, need to make the jobs list template better </span>
<a name="l00750"></a>00750 <span class="comment">     * for identifying/acting upon various different jobs */</span>
<a name="l00751"></a>00751     <span class="comment">/* but for now we&#39;ll reuse the render break... */</span>
<a name="l00752"></a>00752     <span class="keywordflow">return</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek);
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="comment">/* called by fluidbake, wmJob sends notifier */</span>
<a name="l00756"></a>00756 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidbake_updatejob(<span class="keywordtype">void</span> *customdata, <span class="keywordtype">float</span> progress)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     FluidBakeJob *fb= (FluidBakeJob *)customdata;
<a name="l00759"></a>00759     
<a name="l00760"></a>00760     *(fb-&gt;do_update)= 1;
<a name="l00761"></a>00761     *(fb-&gt;progress)= progress;
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidbake_startjob(<span class="keywordtype">void</span> *customdata, <span class="keywordtype">short</span> *stop, <span class="keywordtype">short</span> *do_update, <span class="keywordtype">float</span> *progress)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     FluidBakeJob *fb= (FluidBakeJob *)customdata;
<a name="l00767"></a>00767     
<a name="l00768"></a>00768     fb-&gt;stop= stop;
<a name="l00769"></a>00769     fb-&gt;do_update = do_update;
<a name="l00770"></a>00770     fb-&gt;progress = progress;
<a name="l00771"></a>00771     
<a name="l00772"></a>00772     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek= 0;   <span class="comment">/* XXX shared with render - replace with job &#39;stop&#39; switch */</span>
<a name="l00773"></a>00773     
<a name="l00774"></a>00774     <a class="code" href="../../d8/d00/elbeem_8h.html#a7987742bf9b20fa8d221f7241c1e50b9">elbeemSimulate</a>();
<a name="l00775"></a>00775     *do_update= 1;
<a name="l00776"></a>00776     *stop = 0;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidbake_endjob(<span class="keywordtype">void</span> *customdata)
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781     FluidBakeJob *fb= (FluidBakeJob *)customdata;
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (fb-&gt;settings) {
<a name="l00784"></a>00784         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fb-&gt;settings);
<a name="l00785"></a>00785         fb-&gt;settings = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 <span class="keywordtype">int</span> runSimulationCallback(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> status, <span class="keywordtype">int</span> frame)
<a name="l00790"></a>00790 {
<a name="l00791"></a>00791     FluidBakeJob *fb = (FluidBakeJob *)data;
<a name="l00792"></a>00792     <a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a> *settings = fb-&gt;settings;
<a name="l00793"></a>00793     
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (status == <a class="code" href="../../d8/d00/elbeem_8h.html#a5672810bf857fc96e76a66b0bde66f09">FLUIDSIM_CBSTATUS_NEWFRAME</a>) {
<a name="l00795"></a>00795         fluidbake_updatejob(fb, frame / (<span class="keywordtype">float</span>)settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a251f4962a77fa4415ee8eac005bf2604">noOfFrames</a>);
<a name="l00796"></a>00796         <span class="comment">//printf(&quot;elbeem blender cb s%d, f%d, domainid:%d noOfFrames: %d\n&quot;, status,frame, settings-&gt;domainId, settings-&gt;noOfFrames ); // DEBUG</span>
<a name="l00797"></a>00797     }
<a name="l00798"></a>00798     
<a name="l00799"></a>00799     <span class="keywordflow">if</span> (fluidbake_breakjob(fb)) {
<a name="l00800"></a>00800         <span class="keywordflow">return</span> <a class="code" href="../../d8/d00/elbeem_8h.html#a48c508319c934a028145ee0bd0a13f1e">FLUIDSIM_CBRET_ABORT</a>;
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802     
<a name="l00803"></a>00803     <span class="keywordflow">return</span> <a class="code" href="../../d8/d00/elbeem_8h.html#ad71ec863a8a9b953281b5145ea91c263">FLUIDSIM_CBRET_CONTINUE</a>;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidbake_free_data(FluidAnimChannels *channels, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fobjects, <a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a> *fsset, FluidBakeJob *fb)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     free_domain_channels(channels);
<a name="l00809"></a>00809     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(channels);
<a name="l00810"></a>00810     channels = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     free_all_fluidobject_channels(fobjects);
<a name="l00813"></a>00813     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(fobjects);
<a name="l00814"></a>00814     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fobjects);
<a name="l00815"></a>00815     fobjects = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00816"></a>00816     
<a name="l00817"></a>00817     <span class="keywordflow">if</span> (fsset) {
<a name="l00818"></a>00818         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fsset);
<a name="l00819"></a>00819         fsset = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821     
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (fb) {
<a name="l00823"></a>00823         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fb);
<a name="l00824"></a>00824         fb = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828 <span class="comment">/* copied from rna_fluidsim.c: fluidsim_find_lastframe() */</span>
<a name="l00829"></a>00829 <span class="keyword">static</span> <span class="keywordtype">void</span> fluidsim_delete_until_lastframe(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *fss, <span class="keyword">const</span> <span class="keywordtype">char</span> *relbase)
<a name="l00830"></a>00830 {
<a name="l00831"></a>00831     <span class="keywordtype">char</span> targetDir[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], targetFile[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00832"></a>00832     <span class="keywordtype">char</span> targetDirVel[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], targetFileVel[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00833"></a>00833     <span class="keywordtype">char</span> previewDir[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], previewFile[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00834"></a>00834     <span class="keywordtype">int</span> curFrame = 1, exists = 0;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(targetDir,    <span class="keyword">sizeof</span>(targetDir),    fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#adc7f8c6334ca0547dbb9a520ef711212">OB_FLUIDSIM_SURF_FINAL_OBJ_FNAME</a>);
<a name="l00837"></a>00837     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(targetDirVel, <span class="keyword">sizeof</span>(targetDirVel), fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#acf3b41f6118c95222317b61334261ddf">OB_FLUIDSIM_SURF_FINAL_VEL_FNAME</a>);
<a name="l00838"></a>00838     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(previewDir,   <span class="keyword">sizeof</span>(previewDir),   fss-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a6b4f09f0887a4f52d17d607abe9cb305">surfdataPath</a>, <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#ae4fcc24a47405be768da41de5160ac7c">OB_FLUIDSIM_SURF_PREVIEW_OBJ_FNAME</a>);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(targetDir,    relbase);
<a name="l00841"></a>00841     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(targetDirVel, relbase);
<a name="l00842"></a>00842     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(previewDir,   relbase);
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="keywordflow">do</span> {
<a name="l00845"></a>00845         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(targetFile, targetDir, <span class="keyword">sizeof</span>(targetFile));
<a name="l00846"></a>00846         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(targetFileVel, targetDirVel, <span class="keyword">sizeof</span>(targetFileVel));
<a name="l00847"></a>00847         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(previewFile, previewDir, <span class="keyword">sizeof</span>(previewFile));
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a57e90c5ab9a8c42672bb881833b4bde0">BLI_path_frame</a>(targetFile, curFrame, 0);
<a name="l00850"></a>00850         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a57e90c5ab9a8c42672bb881833b4bde0">BLI_path_frame</a>(targetFileVel, curFrame, 0);
<a name="l00851"></a>00851         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a57e90c5ab9a8c42672bb881833b4bde0">BLI_path_frame</a>(previewFile, curFrame, 0);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         curFrame++;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855         <span class="keywordflow">if</span> ((exists = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(targetFile))) {
<a name="l00856"></a>00856             <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(targetFile, 0, 0);
<a name="l00857"></a>00857             <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(targetFileVel, 0, 0);
<a name="l00858"></a>00858             <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(previewFile, 0, 0);
<a name="l00859"></a>00859         }
<a name="l00860"></a>00860     } <span class="keywordflow">while</span> (exists);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="keywordflow">return</span>;
<a name="l00863"></a>00863 }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 <span class="keyword">static</span> <span class="keywordtype">int</span> fluidsimBake(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../de/de7/structObject.html">Object</a> *fsDomain, <span class="keywordtype">short</span> do_job)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00868"></a>00868     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00869"></a>00869     <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *domainSettings;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="keywordtype">char</span> debugStrBuffer[256];
<a name="l00872"></a>00872     
<a name="l00873"></a>00873     <span class="keywordtype">int</span> gridlevels = 0;
<a name="l00874"></a>00874     <span class="keyword">const</span> <span class="keywordtype">char</span> *relbase= <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a0e4a2d2784b8ca3c1b20c7268e1e68b4">modifier_path_relbase</a>(fsDomain);
<a name="l00875"></a>00875     <span class="keyword">const</span> <span class="keywordtype">char</span> *strEnvName = <span class="stringliteral">&quot;BLENDER_ELBEEMDEBUG&quot;</span>; <span class="comment">// from blendercall.cpp</span>
<a name="l00876"></a>00876     <span class="keyword">const</span> <span class="keywordtype">char</span> *suffixConfigTmp = FLUID_SUFFIX_CONFIG_TMP;
<a name="l00877"></a>00877     <span class="keyword">const</span> <span class="keywordtype">char</span> *suffixSurface = FLUID_SUFFIX_SURFACE;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="keywordtype">char</span> targetDir[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];  <span class="comment">// store &amp; modify output settings</span>
<a name="l00880"></a>00880     <span class="keywordtype">char</span> targetFile[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>]; <span class="comment">// temp. store filename from targetDir for access</span>
<a name="l00881"></a>00881     <span class="keywordtype">int</span>  outStringsChanged = 0;             <span class="comment">// modified? copy back before baking</span>
<a name="l00882"></a>00882 
<a name="l00883"></a>00883     <span class="keywordtype">float</span> domainMat[4][4];
<a name="l00884"></a>00884     <span class="keywordtype">float</span> invDomMat[4][4];
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="keywordtype">int</span> noFrames;
<a name="l00887"></a>00887     <span class="keywordtype">int</span> origFrame = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l00888"></a>00888     
<a name="l00889"></a>00889     FluidAnimChannels *channels = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(FluidAnimChannels), <span class="stringliteral">&quot;fluid domain animation channels&quot;</span>);
<a name="l00890"></a>00890     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fobjects = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>), <span class="stringliteral">&quot;fluid objects&quot;</span>);
<a name="l00891"></a>00891     <a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *fluidmd = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00892"></a>00892     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     FluidBakeJob *<a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>;
<a name="l00895"></a>00895     <a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a> *fsset= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a>), <span class="stringliteral">&quot;Fluid sim settings&quot;</span>);
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     fb= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(FluidBakeJob), <span class="stringliteral">&quot;fluid bake job&quot;</span>);
<a name="l00898"></a>00898     
<a name="l00899"></a>00899     <span class="keywordflow">if</span> (getenv(strEnvName)) {
<a name="l00900"></a>00900         <span class="keywordtype">int</span> dlevel = atoi(getenv(strEnvName));
<a name="l00901"></a>00901         <a class="code" href="../../d8/d00/elbeem_8h.html#a6f3d5cdfb7b5271207e5e48e4b1da1a1">elbeemSetDebugLevel</a>(dlevel);
<a name="l00902"></a>00902         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer, <span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;fluidsimBake::msg: Debug messages activated due to envvar &#39;%s&#39;\n&quot;</span>,strEnvName);
<a name="l00903"></a>00903         <a class="code" href="../../d8/d00/elbeem_8h.html#abf5a83d9f745420c60f29493d5a74bc5">elbeemDebugOut</a>(debugStrBuffer);
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905     
<a name="l00906"></a>00906     <span class="comment">/* make sure it corresponds to startFrame setting (old: noFrames = scene-&gt;r.efra - scene-&gt;r.sfra +1) */</span>;
<a name="l00907"></a>00907     noFrames = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a> - 0;
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (noFrames&lt;=0) {
<a name="l00909"></a>00909         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No frames to export - check your animation range settings&quot;</span>);
<a name="l00910"></a>00910         fluidbake_free_data(channels, fobjects, fsset, fb);
<a name="l00911"></a>00911         <span class="keywordflow">return</span> 0;
<a name="l00912"></a>00912     }
<a name="l00913"></a>00913     
<a name="l00914"></a>00914     <span class="comment">/* check scene for sane object/modifier settings */</span>
<a name="l00915"></a>00915     <span class="keywordflow">if</span> (!fluid_validate_scene(reports, scene, fsDomain)) {
<a name="l00916"></a>00916         fluidbake_free_data(channels, fobjects, fsset, fb);
<a name="l00917"></a>00917         <span class="keywordflow">return</span> 0;
<a name="l00918"></a>00918     }
<a name="l00919"></a>00919     
<a name="l00920"></a>00920     <span class="comment">/* these both have to be valid, otherwise we wouldnt be here */</span>
<a name="l00921"></a>00921     fluidmd = (<a class="code" href="../../d0/dae/structFluidsimModifierData.html">FluidsimModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(fsDomain, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a1b7a8b34e7e5482f68e3447b75e56899">eModifierType_Fluidsim</a>);
<a name="l00922"></a>00922     domainSettings = fluidmd-&gt;<a class="code" href="../../d0/dae/structFluidsimModifierData.html#adca7b002e4bbf96014932ffe53e55be7">fss</a>;
<a name="l00923"></a>00923     mesh = fsDomain-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00924"></a>00924     
<a name="l00925"></a>00925     domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a252d3c09d07fa2e4f42574045fef27b6">bakeStart</a> = 1;
<a name="l00926"></a>00926     domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a93f33d7e3de64f730a0c0c1946f70f08">bakeEnd</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>;
<a name="l00927"></a>00927     
<a name="l00928"></a>00928     <span class="comment">// calculate bounding box</span>
<a name="l00929"></a>00929     <a class="code" href="../../df/de3/BKE__fluidsim_8h.html#a974fbb49d966748d7b3981f8a9186797">fluid_get_bb</a>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, fsDomain-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aaf9ef944b674e82438d35bd4a6988bab">bbStart</a>, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#af6978c75eb5f2b10b87e388077e520ab">bbSize</a>);
<a name="l00930"></a>00930     
<a name="l00931"></a>00931     <span class="comment">// reset last valid frame</span>
<a name="l00932"></a>00932     domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a8991a10e4215ff6f7db8d0d464291662">lastgoodframe</a> = -1;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934     <span class="comment">/* delete old baked files */</span>
<a name="l00935"></a>00935     fluidsim_delete_until_lastframe(domainSettings, relbase);
<a name="l00936"></a>00936     
<a name="l00937"></a>00937     <span class="comment">/* rough check of settings... */</span>
<a name="l00938"></a>00938     <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa379d5a02f2118469ddf12e3c614b0e0">previewresxyz</a> &gt; domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>) {
<a name="l00939"></a>00939         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer,<span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;fluidsimBake::warning - Preview (%d) &gt;= Resolution (%d)... setting equal.\n&quot;</span>, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa379d5a02f2118469ddf12e3c614b0e0">previewresxyz</a> ,  domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>);
<a name="l00940"></a>00940         <a class="code" href="../../d8/d00/elbeem_8h.html#abf5a83d9f745420c60f29493d5a74bc5">elbeemDebugOut</a>(debugStrBuffer);
<a name="l00941"></a>00941         domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa379d5a02f2118469ddf12e3c614b0e0">previewresxyz</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>;
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943     <span class="comment">// set adaptive coarsening according to resolutionxyz</span>
<a name="l00944"></a>00944     <span class="comment">// this should do as an approximation, with in/outflow</span>
<a name="l00945"></a>00945     <span class="comment">// doing this more accurate would be overkill</span>
<a name="l00946"></a>00946     <span class="comment">// perhaps add manual setting?</span>
<a name="l00947"></a>00947     <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#ab54c0a608e48fb898d7365b40a301048">maxRefine</a> &lt;0) {
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>&gt;128) {
<a name="l00949"></a>00949             gridlevels = 2;
<a name="l00950"></a>00950         }
<a name="l00951"></a>00951         <span class="keywordflow">else</span>
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>&gt;64) {
<a name="l00953"></a>00953             gridlevels = 1;
<a name="l00954"></a>00954         }
<a name="l00955"></a>00955         <span class="keywordflow">else</span> {
<a name="l00956"></a>00956             gridlevels = 0;
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959     <span class="keywordflow">else</span> {
<a name="l00960"></a>00960         gridlevels = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#ab54c0a608e48fb898d7365b40a301048">maxRefine</a>;
<a name="l00961"></a>00961     }
<a name="l00962"></a>00962     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer,<span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;fluidsimBake::msg: Baking %s, refine: %d\n&quot;</span>, fsDomain-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> , gridlevels );
<a name="l00963"></a>00963     <a class="code" href="../../d8/d00/elbeem_8h.html#abf5a83d9f745420c60f29493d5a74bc5">elbeemDebugOut</a>(debugStrBuffer);
<a name="l00964"></a>00964     
<a name="l00965"></a>00965     
<a name="l00966"></a>00966     
<a name="l00967"></a>00967     <span class="comment">/* ******** prepare output file paths ******** */</span>
<a name="l00968"></a>00968     outStringsChanged = fluid_init_filepaths(fsDomain, targetDir, targetFile, debugStrBuffer);
<a name="l00969"></a>00969     channels-&gt;length = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>;
<a name="l00970"></a>00970     channels-&gt;aniFrameTime = (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#abb6f58ebc6ea812583f5ff1f03ba1b9d">animEnd</a> - domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a79dc15ef40b2137032eed93a5ef4d4f5">animStart</a>)/(<span class="keywordtype">double</span>)noFrames;
<a name="l00971"></a>00971     
<a name="l00972"></a>00972     <span class="comment">/* ******** initialize and allocate animation channels ******** */</span>
<a name="l00973"></a>00973     fluid_init_all_channels(C, fsDomain, domainSettings, channels, fobjects);
<a name="l00974"></a>00974 
<a name="l00975"></a>00975     <span class="comment">/* reset to original current frame */</span>
<a name="l00976"></a>00976     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> = origFrame;
<a name="l00977"></a>00977     <a class="code" href="../../d1/d12/ED__screen_8h.html#a064a1225eaf305ae55dc93b0d35fbf82">ED_update_for_newframe</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), scene, <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C), 1);
<a name="l00978"></a>00978         
<a name="l00979"></a>00979     <span class="comment">/* ******** init domain object&#39;s matrix ******** */</span>
<a name="l00980"></a>00980     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(domainMat, fsDomain-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00981"></a>00981     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(invDomMat, domainMat)) {
<a name="l00982"></a>00982         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(debugStrBuffer,<span class="keyword">sizeof</span>(debugStrBuffer),<span class="stringliteral">&quot;fluidsimBake::error - Invalid obj matrix?\n&quot;</span>);
<a name="l00983"></a>00983         <a class="code" href="../../d8/d00/elbeem_8h.html#abf5a83d9f745420c60f29493d5a74bc5">elbeemDebugOut</a>(debugStrBuffer);
<a name="l00984"></a>00984         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Invalid object matrix&quot;</span>); 
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         fluidbake_free_data(channels, fobjects, fsset, fb);
<a name="l00987"></a>00987         <span class="keywordflow">return</span> 0;
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="comment">/* ********  start writing / exporting ******** */</span>
<a name="l00991"></a>00991     <span class="comment">// use .tmp, don&#39;t overwrite/delete original file</span>
<a name="l00992"></a>00992     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(targetFile, <span class="keyword">sizeof</span>(targetFile), targetDir, suffixConfigTmp);
<a name="l00993"></a>00993     
<a name="l00994"></a>00994     <span class="comment">// make sure these directories exist as well</span>
<a name="l00995"></a>00995     <span class="keywordflow">if</span> (outStringsChanged) {
<a name="l00996"></a>00996         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(targetFile);
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <span class="comment">/* ******** export domain to elbeem ******** */</span>
<a name="l01000"></a>01000     <a class="code" href="../../d8/d00/elbeem_8h.html#a7c16efd67129ffb79d9f4e5de1e95156">elbeemResetSettings</a>(fsset);
<a name="l01001"></a>01001     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#adff64af7dfc68e73a4818161d3a1023f">version</a> = 1;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="comment">// setup global settings</span>
<a name="l01004"></a>01004     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aaf9ef944b674e82438d35bd4a6988bab">bbStart</a>);
<a name="l01005"></a>01005     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad6ec2432d27565ba8eb9e18c98d50bdd">geoSize</a>, domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#af6978c75eb5f2b10b87e388077e520ab">bbSize</a>);
<a name="l01006"></a>01006     
<a name="l01007"></a>01007     <span class="comment">// simulate with 50^3</span>
<a name="l01008"></a>01008     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad3889f49d9cbb6605d366a4161c8857b">resolutionxyz</a> = (int)domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a9e981dfbec9808a77fbefd406055f784">resolutionxyz</a>;
<a name="l01009"></a>01009     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a758208b11c683a0448704ad48709d8ac">previewresxyz</a> = (<span class="keywordtype">int</span>)domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aa379d5a02f2118469ddf12e3c614b0e0">previewresxyz</a>;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#accc770fdefc6079eff4dcae7753b750f">realsize</a> = get_fluid_size_m(scene, fsDomain, domainSettings);
<a name="l01012"></a>01012     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ac0ac098a9115598677657ee5471415db">viscosity</a> = get_fluid_viscosity(domainSettings);
<a name="l01013"></a>01013     get_fluid_gravity(fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#afc7508091f207c6b9148c56052ea9685">gravity</a>, scene, domainSettings);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="comment">// simulate 5 frames, each 0.03 seconds, output to ./apitest_XXX.bobj.gz</span>
<a name="l01016"></a>01016     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#acb5dec91ace098f73eb7110783f2872c">animStart</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a79dc15ef40b2137032eed93a5ef4d4f5">animStart</a>;
<a name="l01017"></a>01017     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a7b76335c6fa581d8de07284012bceaec">aniFrameTime</a> = channels-&gt;aniFrameTime;
<a name="l01018"></a>01018     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a251f4962a77fa4415ee8eac005bf2604">noOfFrames</a> = noFrames; <span class="comment">// is otherwise subtracted in parser</span>
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(targetFile, <span class="keyword">sizeof</span>(targetFile), targetDir, suffixSurface);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     <span class="comment">// defaults for compressibility and adaptive grids</span>
<a name="l01023"></a>01023     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a78645ab0c49fae66e5a807d307cdc747">gstar</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#aac56092dd7fc5be484ef92db53aaa6af">gstar</a>;
<a name="l01024"></a>01024     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a77ab5c61a00f8e65fe7b0abdf0e51196">maxRefine</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#ab54c0a608e48fb898d7365b40a301048">maxRefine</a>; <span class="comment">// check &lt;-&gt; gridlevels</span>
<a name="l01025"></a>01025     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aeb59eeb8dc95ccdae1fca090ad927f26">generateParticles</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a4c9673055810962a380eab480fac7b4c">generateParticles</a>; 
<a name="l01026"></a>01026     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ae3fc4a0a9f553aa0728347e19117ee87">numTracerParticles</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a31be1d032b9e6aa4d75ae102fb5cfa39">generateTracers</a>; 
<a name="l01027"></a>01027     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a57259f9450c2cb3bec2c1922ef59a94d">surfaceSmoothing</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#add459d00b8c4749438d3b6cba9ab3acd">surfaceSmoothing</a>; 
<a name="l01028"></a>01028     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a87fc076b93bdf22e53051cf46ca292c3">surfaceSubdivs</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#ab3aee405af71cf4e4fd329257c3d8b94">surfaceSubdivs</a>; 
<a name="l01029"></a>01029     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a0314c0f91cbfc7a937753f02ca70ae2c">farFieldSize</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a66fab22ca7509cd412778b0cb7748919">farFieldSize</a>; 
<a name="l01030"></a>01030     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a80c082ac97031e941539c2abd04c5848">outputPath</a>, targetFile, <span class="keyword">sizeof</span>(fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a80c082ac97031e941539c2abd04c5848">outputPath</a>));
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <span class="comment">// domain channels</span>
<a name="l01033"></a>01033     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a7828a3700c1203956e05395f125e146b">channelSizeFrameTime</a> = 
<a name="l01034"></a>01034     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aa7047ddd7cbe37b627bc3b664477d349">channelSizeViscosity</a> = 
<a name="l01035"></a>01035     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a2a1c0ce8453a132c4bfd12dd9718db77">channelSizeGravity</a> = channels-&gt;length;
<a name="l01036"></a>01036     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a27769d2989d99ae66e9a57c8672db04a">channelFrameTime</a> = channels-&gt;DomainTime;
<a name="l01037"></a>01037     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ab44689840f807d2e2d1fee0c812ceaec">channelViscosity</a> = channels-&gt;DomainViscosity;
<a name="l01038"></a>01038     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a77596ec9398b619df476d5093f4d8cb7">channelGravity</a> = channels-&gt;DomainGravity;
<a name="l01039"></a>01039     
<a name="l01040"></a>01040     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a763e235978764c2cbc268af674731652">runsimCallback</a> = &amp;runSimulationCallback;
<a name="l01041"></a>01041     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a3f02301d3d2de00a8519079c2bc2d2b5">runsimUserData</a> = <a class="code" href="../../dc/d53/implicit_8c.html#a6593817fe20dfc95a3fb3f71c7b8c996">fb</a>;
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#ac397e8b09765445d3f2a5ee61a25eebc">OB_FSBND_NOSLIP</a>)        fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ac576032106143d0b159b0313615a58bd">domainobsType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#ac83976a5929415117a8a8823fe481ff0">FLUIDSIM_OBSTACLE_NOSLIP</a>;
<a name="l01044"></a>01044     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a>&amp;<a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a73f653cf7bbce17fa41a10fd6e8f1547">OB_FSBND_PARTSLIP</a>)   fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ac576032106143d0b159b0313615a58bd">domainobsType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#add9f864fbe2637ae205b5d229596a441">FLUIDSIM_OBSTACLE_PARTSLIP</a>;
<a name="l01045"></a>01045     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a>&amp;<a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a274003182308a7c3ef0e58f6d1e1dd7e">OB_FSBND_FREESLIP</a>)   fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ac576032106143d0b159b0313615a58bd">domainobsType</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#a43074590bb0f68b1c6220f578de2758a">FLUIDSIM_OBSTACLE_FREESLIP</a>;
<a name="l01046"></a>01046     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a521050c37bece4fb09acf0ce70468c90">domainobsPartslip</a> = domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a048c5b6d4a4ab2462a6d2225e58c49cb">partSlipValue</a>;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <span class="comment">/* use domainobsType also for surface generation flag (bit: &gt;=64) */</span>
<a name="l01049"></a>01049     <span class="keywordflow">if</span> (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#afe5b84a59a77eac2fdc398357153b82f">typeFlags</a> &amp; <a class="code" href="../../d8/d92/DNA__object__fluidsim_8h.html#a80e9c70628061519ac0353145d012aa4">OB_FSSG_NOOBS</a>)
<a name="l01050"></a>01050         fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#af59dd3aeb9fde2a848247de8bdbf678e">mFsSurfGenSetting</a> = <a class="code" href="../../d8/d00/elbeem_8h.html#a37c361a95858dd3dd43b56fad3fe043a">FLUIDSIM_FSSG_NOOBS</a>;
<a name="l01051"></a>01051     <span class="keywordflow">else</span>
<a name="l01052"></a>01052         fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#af59dd3aeb9fde2a848247de8bdbf678e">mFsSurfGenSetting</a> = 0; <span class="comment">// &quot;normal&quot; mode</span>
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a1ae68216d87095afdfcfa28391dfb1e1">generateVertexVectors</a> = (domainSettings-&gt;<a class="code" href="../../d9/d03/structFluidsimSettings.html#a7ff5cbb5910dd116c4a1a8e832e781da">domainNovecgen</a>==0);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="comment">// init blender domain transform matrix</span>
<a name="l01057"></a>01057     { <span class="keywordtype">int</span> j; 
<a name="l01058"></a>01058     <span class="keywordflow">for</span> (i=0; i&lt;4; i++) {
<a name="l01059"></a>01059         <span class="keywordflow">for</span> (j=0; j&lt;4; j++) {
<a name="l01060"></a>01060             fsset-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a5c63cd6fa71fd5b7cd1cb618812ce4a1">surfaceTrafo</a>[i*4+j] = invDomMat[j][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01061"></a>01061         }
<a name="l01062"></a>01062     } }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <span class="comment">/* ******** init solver with settings ******** */</span>
<a name="l01065"></a>01065     <a class="code" href="../../d8/d00/elbeem_8h.html#a932391041b25b60e9b3adab20cf21c74">elbeemInit</a>();
<a name="l01066"></a>01066     <a class="code" href="../../d8/d00/elbeem_8h.html#a208d11c0853c8039e16f49740cc35ca1">elbeemAddDomain</a>(fsset);
<a name="l01067"></a>01067     
<a name="l01068"></a>01068     <span class="comment">/* ******** export all fluid objects to elbeem ******** */</span>
<a name="l01069"></a>01069     export_fluid_objects(fobjects, scene, channels-&gt;length);
<a name="l01070"></a>01070     
<a name="l01071"></a>01071     <span class="comment">/* custom data for fluid bake job */</span>
<a name="l01072"></a>01072     fb-&gt;settings = fsset;
<a name="l01073"></a>01073     
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (do_job) {
<a name="l01075"></a>01075         <a class="code" href="../../df/da1/structwmJob.html">wmJob</a> *steve= <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a03e66c0464fe9538f2be29d10983a54b">WM_jobs_get</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), scene, <span class="stringliteral">&quot;Fluid Simulation&quot;</span>, <a class="code" href="../../d4/d7f/WM__api_8h.html#a465c1325f2e6a043e462d7cb9af39731">WM_JOB_PROGRESS</a>);
<a name="l01076"></a>01076 
<a name="l01077"></a>01077         <span class="comment">/* setup job */</span>
<a name="l01078"></a>01078         <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a32861c1bffe82b79764b704b38ef0751">WM_jobs_customdata</a>(steve, fb, fluidbake_free);
<a name="l01079"></a>01079         <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a61b5493e2cc31b7445290f3bd26be5ef">WM_jobs_timer</a>(steve, 0.1, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a93a7b7f4bba572e9176db2aa580d7aa9">ND_FRAME</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a93a7b7f4bba572e9176db2aa580d7aa9">ND_FRAME</a>);
<a name="l01080"></a>01080         <a class="code" href="../../d6/ddf/wm__jobs_8c.html#ad483f8df6cb0321204a4f98c645db4ba">WM_jobs_callbacks</a>(steve, fluidbake_startjob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fluidbake_endjob);
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         <a class="code" href="../../d6/ddf/wm__jobs_8c.html#a6b58050bebd06f6dcf195967da599bf0">WM_jobs_start</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), steve);
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084     <span class="keywordflow">else</span> {
<a name="l01085"></a>01085         <span class="keywordtype">short</span> dummy_stop, dummy_do_update;
<a name="l01086"></a>01086         <span class="keywordtype">float</span> dummy_progress;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088         <span class="comment">/* blocking, use with exec() */</span>
<a name="l01089"></a>01089         fluidbake_startjob((<span class="keywordtype">void</span> *)fb, &amp;dummy_stop, &amp;dummy_do_update, &amp;dummy_progress);
<a name="l01090"></a>01090         fluidbake_endjob((<span class="keywordtype">void</span> *)fb);
<a name="l01091"></a>01091         fluidbake_free((<span class="keywordtype">void</span> *)fb);
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <span class="comment">/* ******** free stored animation data ******** */</span>
<a name="l01095"></a>01095     fluidbake_free_data(channels, fobjects, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     <span class="comment">// elbeemFree();</span>
<a name="l01098"></a>01098     <span class="keywordflow">return</span> 1;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="keywordtype">void</span> fluidsimFreeBake(<a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob))
<a name="l01102"></a>01102 {
<a name="l01103"></a>01103     <span class="comment">/* not implemented yet */</span>
<a name="l01104"></a>01104 }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106 <span class="preprocessor">#else </span><span class="comment">/* WITH_MOD_FLUID */</span>
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 <span class="comment">/* compile dummy functions for disabled fluid sim */</span>
<a name="l01109"></a>01109 
<a name="l01110"></a>01110 <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *<a class="code" href="../../df/d76/ED__fluidsim_8h.html#abf15aa4292fa3a0af5064fb971a9292a">fluidsimSettingsNew</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(srcob))
<a name="l01111"></a>01111 {
<a name="l01112"></a>01112     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="keywordtype">void</span> <a class="code" href="../../df/d76/ED__fluidsim_8h.html#abeae1a21407e1d9703d9ca56360322c2">fluidsimSettingsFree</a>(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fss))
<a name="l01116"></a>01116 {
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119 <a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a>* <a class="code" href="../../df/d76/ED__fluidsim_8h.html#a7022325a69d6fed5953a7e7b684c62ad">fluidsimSettingsCopy</a>(<a class="code" href="../../d9/d03/structFluidsimSettings.html">FluidsimSettings</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fss))
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01122"></a>01122 }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124 <span class="comment">/* only compile dummy functions */</span>
<a name="l01125"></a>01125 <span class="keyword">static</span> <span class="keywordtype">int</span> fluidsimBake(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(C), <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(reports), <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob), <span class="keywordtype">short</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(do_job))
<a name="l01126"></a>01126 {
<a name="l01127"></a>01127     <span class="keywordflow">return</span> 0;
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 <span class="preprocessor">#endif </span><span class="comment">/* WITH_MOD_FLUID */</span>
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="comment">/***************************** Operators ******************************/</span>
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="keyword">static</span> <span class="keywordtype">int</span> fluid_bake_invoke(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01135"></a>01135 {
<a name="l01136"></a>01136     <span class="comment">/* only one bake job at a time */</span>
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (<a class="code" href="../../d6/ddf/wm__jobs_8c.html#ac173761e5d2abe3fef0c66bed8c471fd">WM_jobs_test</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C), <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C)))
<a name="l01138"></a>01138         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140     <span class="keywordflow">if</span> (!fluidsimBake(C, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C), <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>))
<a name="l01141"></a>01141         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 <span class="keyword">static</span> <span class="keywordtype">int</span> fluid_bake_exec(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01147"></a>01147 {
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (!fluidsimBake(C, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C), <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))
<a name="l01149"></a>01149         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01152"></a>01152 }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <span class="keywordtype">void</span> <a class="code" href="../../dd/de6/physics__intern_8h.html#a0cc89fe87bc6543191c27aba6f82c1d1">FLUID_OT_bake</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01155"></a>01155 {
<a name="l01156"></a>01156     <span class="comment">/* identifiers */</span>
<a name="l01157"></a>01157     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Fluid Simulation Bake&quot;</span>;
<a name="l01158"></a>01158     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Bake fluid simulation&quot;</span>;
<a name="l01159"></a>01159     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;FLUID_OT_bake&quot;</span>;
<a name="l01160"></a>01160     
<a name="l01161"></a>01161     <span class="comment">/* api callbacks */</span>
<a name="l01162"></a>01162     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = fluid_bake_invoke;
<a name="l01163"></a>01163     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = fluid_bake_exec;
<a name="l01164"></a>01164     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#adf69a13ccdb50f050485340e86a00d34">ED_operator_object_active_editable</a>;
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:44 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
