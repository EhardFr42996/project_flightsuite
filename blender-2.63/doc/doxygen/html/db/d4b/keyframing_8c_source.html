<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: keyframing.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">keyframing.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/d4b/keyframing_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2009 Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Joshua Leung (full recode)</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/BLI__dynstr_8h.html" title="A dynamically sized string ADT.">BLI_dynstr.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dba/BKE__fcurve_8h.html">BKE_fcurve.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/de6/BKE__nla_8h.html">BKE_nla.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d6f/ED__anim__api_8h.html">ED_anim_api.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df9/ED__keyframing_8h.html">ED_keyframing.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d10/ED__keyframes__edit_8h.html">ED_keyframes_edit.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d1e/UI__interface_8h.html">UI_interface.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d68/RNA__enum__types_8h.html">RNA_enum_types.h</a>&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dc3/anim__intern_8h.html">anim_intern.h</a>&quot;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/* ************************************************** */</span>
<a name="l00086"></a>00086 <span class="comment">/* Keyframing Setting Wrangling */</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="comment">/* Get the active settings for keyframing settings from context (specifically the given scene) */</span>
<a name="l00089"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#af445fa6332cbd5a9834d4278c5289314">00089</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ae69d690ee9dc8d2947eed67672d3f295">ANIM_get_keyframing_flags</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">short</span> incl_mode)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="keywordtype">short</span> flag = 0;
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     <span class="comment">/* standard flags */</span>
<a name="l00094"></a>00094     {
<a name="l00095"></a>00095         <span class="comment">/* visual keying */</span>
<a name="l00096"></a>00096         <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#a252c7b18e0db54ae761b35901e84a57e">IS_AUTOKEY_FLAG</a>(scene, AUTOMATKEY)) 
<a name="l00097"></a>00097             flag |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea6129ec465839968d5faafe2f901af338">INSERTKEY_MATRIX</a>;
<a name="l00098"></a>00098         
<a name="l00099"></a>00099         <span class="comment">/* only needed */</span>
<a name="l00100"></a>00100         <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#a252c7b18e0db54ae761b35901e84a57e">IS_AUTOKEY_FLAG</a>(scene, INSERTNEEDED)) 
<a name="l00101"></a>00101             flag |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea661b03e7db741895f1910da63c6ac08e">INSERTKEY_NEEDED</a>;
<a name="l00102"></a>00102         
<a name="l00103"></a>00103         <span class="comment">/* default F-Curve color mode - RGB from XYZ indices */</span>
<a name="l00104"></a>00104         <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#a252c7b18e0db54ae761b35901e84a57e">IS_AUTOKEY_FLAG</a>(scene, XYZ2RGB)) 
<a name="l00105"></a>00105             flag |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea82a151e237b00e9030e454ae93b0b5d2">INSERTKEY_XYZ2RGB</a>;
<a name="l00106"></a>00106     }
<a name="l00107"></a>00107         
<a name="l00108"></a>00108     <span class="comment">/* only if including settings from the autokeying mode... */</span>
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (incl_mode) { 
<a name="l00110"></a>00110         <span class="comment">/* keyframing mode - only replace existing keyframes */</span>
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#a40334789d14a6120769250de8198acc1">IS_AUTOKEY_MODE</a>(scene, EDITKEYS)) 
<a name="l00112"></a>00112             flag |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea530096d4f2231f90cc15f77773e50562">INSERTKEY_REPLACE</a>;
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114         
<a name="l00115"></a>00115     <span class="keywordflow">return</span> flag;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">/* ******************************************* */</span>
<a name="l00119"></a>00119 <span class="comment">/* Animation Data Validation */</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/* Get (or add relevant data to be able to do so) the Active Action for the given </span>
<a name="l00122"></a>00122 <span class="comment"> * Animation Data block, given an ID block where the Animation Data should reside.</span>
<a name="l00123"></a>00123 <span class="comment"> */</span>
<a name="l00124"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#af6d000b403ab4afd7c0fa9ca85949fac">00124</a> <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *<a class="code" href="../../db/d4b/keyframing_8c.html#abe8806e0669cf3b73a246c0e4c7eacd5">verify_adt_action</a> (<a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <span class="keywordtype">short</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a9a801fa87c9bf3472c399696366fe81c">add</a>)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt;
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     <span class="comment">/* init animdata if none available yet */</span>
<a name="l00129"></a>00129     adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(<span class="keywordtype">id</span>);
<a name="l00130"></a>00130     <span class="keywordflow">if</span> ((adt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (add))
<a name="l00131"></a>00131         adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a3d1b7d3abe94890891569f4bd6ba21b1">BKE_id_add_animdata</a>(<span class="keywordtype">id</span>);
<a name="l00132"></a>00132     <span class="keywordflow">if</span> (adt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { 
<a name="l00133"></a>00133         <span class="comment">/* if still none (as not allowed to add, or ID doesn&#39;t have animdata for some reason) */</span>
<a name="l00134"></a>00134         printf(<span class="stringliteral">&quot;ERROR: Couldn&#39;t add AnimData (ID = %s)\n&quot;</span>, (<span class="keywordtype">id</span>) ? (id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) : <span class="stringliteral">&quot;&lt;None&gt;&quot;</span>);
<a name="l00135"></a>00135         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137         
<a name="l00138"></a>00138     <span class="comment">/* init action if none available yet */</span>
<a name="l00139"></a>00139     <span class="comment">// TODO: need some wizardry to handle NLA stuff correct</span>
<a name="l00140"></a>00140     <span class="keywordflow">if</span> ((adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (add)) {
<a name="l00141"></a>00141         <span class="keywordtype">char</span> actname[<span class="keyword">sizeof</span>(<span class="keywordtype">id</span>-&gt;name)-2];
<a name="l00142"></a>00142         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(actname, <span class="keyword">sizeof</span>(actname), <span class="stringliteral">&quot;%sAction&quot;</span>, id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2);
<a name="l00143"></a>00143         adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>= <a class="code" href="../../d8/df5/BKE__action_8h.html#a77b6bd66ec260f2485cf1ff2d075fdb2">add_empty_action</a>(actname);
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145         
<a name="l00146"></a>00146     <span class="comment">/* return the action */</span>
<a name="l00147"></a>00147     <span class="keywordflow">return</span> adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>;
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="comment">/* Get (or add relevant data to be able to do so) F-Curve from the Active Action, </span>
<a name="l00151"></a>00151 <span class="comment"> * for the given Animation Data block. This assumes that all the destinations are valid.</span>
<a name="l00152"></a>00152 <span class="comment"> */</span>
<a name="l00153"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a17c15aa5ecdb0fa735fd4863d960b3d3">00153</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../db/d4b/keyframing_8c.html#a52eb6919edb749cd96baede51f9f1bc8">verify_fcurve</a> (<a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <span class="keyword">const</span> <span class="keywordtype">char</span> group[], <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a4703b9509fd2ed178b657f6ffff9d808">rna_path</a>[], <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>, <span class="keywordtype">short</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a9a801fa87c9bf3472c399696366fe81c">add</a>)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <a class="code" href="../../d9/dcf/structbActionGroup.html">bActionGroup</a> *<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a676db5b0626e01726bdb5fdd94694706">grp</a>;
<a name="l00156"></a>00156     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <span class="comment">/* sanity checks */</span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, act, rna_path))
<a name="l00160"></a>00160         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00161"></a>00161         
<a name="l00162"></a>00162     <span class="comment">/* try to find f-curve matching for this setting </span>
<a name="l00163"></a>00163 <span class="comment">     *  - add if not found and allowed to add one</span>
<a name="l00164"></a>00164 <span class="comment">     *      TODO: add auto-grouping support? how this works will need to be resolved</span>
<a name="l00165"></a>00165 <span class="comment">     */</span>
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (act)
<a name="l00167"></a>00167         fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>, rna_path, array_index);
<a name="l00168"></a>00168     <span class="keywordflow">else</span>
<a name="l00169"></a>00169         fcu= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     <span class="keywordflow">if</span> ((fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (add)) {
<a name="l00172"></a>00172         <span class="comment">/* use default settings to make a F-Curve */</span>
<a name="l00173"></a>00173         fcu= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a>), <span class="stringliteral">&quot;FCurve&quot;</span>);
<a name="l00174"></a>00174         
<a name="l00175"></a>00175         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> = (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464abc4ace997641edbdb0f8724f583dffda">FCURVE_VISIBLE</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a663e89ede10f0771e57578f6ec020a8b">FCURVE_SELECTED</a>);
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l00177"></a>00177             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a4dafc6cfdb87097d84384ce770383b66">FCURVE_ACTIVE</a>; <span class="comment">/* first one added active */</span>
<a name="l00178"></a>00178             
<a name="l00179"></a>00179         <span class="comment">/* store path - make copy, and store that */</span>
<a name="l00180"></a>00180         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>= <a class="code" href="../../d3/db3/BLI__string_8h.html#a76968e0a4c961ec556481b473eddf2c5">BLI_strdupn</a>(rna_path, <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(rna_path));
<a name="l00181"></a>00181         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a>= <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>;
<a name="l00182"></a>00182         
<a name="l00183"></a>00183         <span class="comment">/* if a group name has been provided, try to add or find a group, then add F-Curve to it */</span>
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (group) {
<a name="l00185"></a>00185             <span class="comment">/* try to find group */</span>
<a name="l00186"></a>00186             grp= <a class="code" href="../../d8/df5/BKE__action_8h.html#aaad65e0df0ec53f58ea0de0848ab383e">action_groups_find_named</a>(act, group);
<a name="l00187"></a>00187             
<a name="l00188"></a>00188             <span class="comment">/* no matching groups, so add one */</span>
<a name="l00189"></a>00189             <span class="keywordflow">if</span> (grp == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00190"></a>00190                 grp= <a class="code" href="../../d8/df5/BKE__action_8h.html#a0b646dad82be5776f531506380d6bd0d">action_groups_add_new</a>(act, group);
<a name="l00191"></a>00191             
<a name="l00192"></a>00192             <span class="comment">/* add F-Curve to group */</span>
<a name="l00193"></a>00193             <a class="code" href="../../d8/df5/BKE__action_8h.html#ae14baf4ad9762b4f19df690a2496ce53">action_groups_add_channel</a>(act, grp, fcu);
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         <span class="keywordflow">else</span> {
<a name="l00196"></a>00196             <span class="comment">/* just add F-Curve to end of Action&#39;s list */</span>
<a name="l00197"></a>00197             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>, fcu);
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200     
<a name="l00201"></a>00201     <span class="comment">/* return the F-Curve */</span>
<a name="l00202"></a>00202     <span class="keywordflow">return</span> fcu;
<a name="l00203"></a>00203 }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="comment">/* ************************************************** */</span>
<a name="l00206"></a>00206 <span class="comment">/* KEYFRAME INSERTION */</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">/* -------------- BezTriple Insertion -------------------- */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">/* This function adds a given BezTriple to an F-Curve. It will allocate </span>
<a name="l00211"></a>00211 <span class="comment"> * memory for the array if needed, and will insert the BezTriple into a</span>
<a name="l00212"></a>00212 <span class="comment"> * suitable place in chronological order.</span>
<a name="l00213"></a>00213 <span class="comment"> * </span>
<a name="l00214"></a>00214 <span class="comment"> * NOTE: any recalculate of the F-Curve that needs to be done will need to </span>
<a name="l00215"></a>00215 <span class="comment"> *      be done by the caller.</span>
<a name="l00216"></a>00216 <span class="comment"> */</span>
<a name="l00217"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a7dcbeddfd18c73a6f782b4f0bac3ffcc">00217</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ab139b5247c553842662942e96dc9df34">insert_bezt_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#ad793ed4b60fb6bb7586b7a196b6b2e61">bezt</a>, <span class="keywordtype">short</span> flag)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>= 0;
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     <span class="comment">/* are there already keyframes? */</span>
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00223"></a>00223         <span class="keywordtype">short</span> replace = -1;
<a name="l00224"></a>00224         i = <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a57be9969692b1bd993d12fa9f2c39bf2">binarysearch_bezt_index</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0], fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>, &amp;replace);
<a name="l00225"></a>00225         
<a name="l00226"></a>00226         <span class="comment">/* replace an existing keyframe? */</span>
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (replace) {          
<a name="l00228"></a>00228             <span class="comment">/* sanity check: &#39;i&#39; may in rare cases exceed arraylen */</span>
<a name="l00229"></a>00229             <span class="keywordflow">if</span> ((i &gt;= 0) &amp;&amp; (i &lt; fcu-&gt;<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a7240a655e9059baf2961aaad6711145f">totvert</a>)) {
<a name="l00230"></a>00230                 <span class="comment">/* just change the values when replacing, so as to not overwrite handles */</span>
<a name="l00231"></a>00231                 <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *dst= (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l00232"></a>00232                 <span class="keywordtype">float</span> dy= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00233"></a>00233                 
<a name="l00234"></a>00234                 <span class="comment">/* just apply delta value change to the handle values */</span>
<a name="l00235"></a>00235                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1] += dy;
<a name="l00236"></a>00236                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] += dy;
<a name="l00237"></a>00237                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1] += dy;
<a name="l00238"></a>00238                 
<a name="l00239"></a>00239                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad1188a435612de53bc858987af3c7acd">f1</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad1188a435612de53bc858987af3c7acd">f1</a>;
<a name="l00240"></a>00240                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a>;
<a name="l00241"></a>00241                 dst-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a426bd73dcd72de3539ed00b02646bac1">f3</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a426bd73dcd72de3539ed00b02646bac1">f3</a>;
<a name="l00242"></a>00242                 
<a name="l00243"></a>00243                 <span class="comment">// TODO: perform some other operations?</span>
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246         <span class="comment">/* keyframing modes allow to not replace keyframe */</span>
<a name="l00247"></a>00247         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea530096d4f2231f90cc15f77773e50562">INSERTKEY_REPLACE</a>) == 0) {
<a name="l00248"></a>00248             <span class="comment">/* insert new - if we&#39;re not restricted to replacing keyframes only */</span>
<a name="l00249"></a>00249             <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *newb= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>+1)*<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>), <span class="stringliteral">&quot;beztriple&quot;</span>);
<a name="l00250"></a>00250             
<a name="l00251"></a>00251             <span class="comment">/* add the beztriples that should occur before the beztriple to be pasted (originally in fcu) */</span>
<a name="l00252"></a>00252             <span class="keywordflow">if</span> (i &gt; 0)
<a name="l00253"></a>00253                 memcpy(newb, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, i*<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>));
<a name="l00254"></a>00254             
<a name="l00255"></a>00255             <span class="comment">/* add beztriple to paste at index i */</span>
<a name="l00256"></a>00256             *(newb + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)= *bezt;
<a name="l00257"></a>00257             
<a name="l00258"></a>00258             <span class="comment">/* add the beztriples that occur after the beztriple to be pasted (originally in fcu) */</span>
<a name="l00259"></a>00259             <span class="keywordflow">if</span> (i &lt; fcu-&gt;<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a7240a655e9059baf2961aaad6711145f">totvert</a>) 
<a name="l00260"></a>00260                 memcpy(newb+i+1, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>+i, (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-i)*<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>));
<a name="l00261"></a>00261             
<a name="l00262"></a>00262             <span class="comment">/* replace (+ free) old with new, only if necessary to do so */</span>
<a name="l00263"></a>00263             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>);
<a name="l00264"></a>00264             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>= newb;
<a name="l00265"></a>00265             
<a name="l00266"></a>00266             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>++;
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     <span class="comment">/* no keyframes already, but can only add if...</span>
<a name="l00270"></a>00270 <span class="comment">     *  1) keyframing modes say that keyframes can only be replaced, so adding new ones won&#39;t know</span>
<a name="l00271"></a>00271 <span class="comment">     *  2) there are no samples on the curve</span>
<a name="l00272"></a>00272 <span class="comment">     *      // NOTE: maybe we may want to allow this later when doing samples -&gt; bezt conversions, </span>
<a name="l00273"></a>00273 <span class="comment">     *      // but for now, having both is asking for trouble</span>
<a name="l00274"></a>00274 <span class="comment">     */</span>
<a name="l00275"></a>00275     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea530096d4f2231f90cc15f77773e50562">INSERTKEY_REPLACE</a>)==0 &amp;&amp; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00276"></a>00276         <span class="comment">/* create new keyframes array */</span>
<a name="l00277"></a>00277         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>), <span class="stringliteral">&quot;beztriple&quot;</span>);
<a name="l00278"></a>00278         *(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>)= *bezt;
<a name="l00279"></a>00279         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>= 1;
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281     <span class="comment">/* cannot add anything */</span>
<a name="l00282"></a>00282     <span class="keywordflow">else</span> {
<a name="l00283"></a>00283         <span class="comment">/* return error code -1 to prevent any misunderstandings */</span>
<a name="l00284"></a>00284         <span class="keywordflow">return</span> -1;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     
<a name="l00287"></a>00287     
<a name="l00288"></a>00288     <span class="comment">/* we need to return the index, so that some tools which do post-processing can </span>
<a name="l00289"></a>00289 <span class="comment">     * detect where we added the BezTriple in the array</span>
<a name="l00290"></a>00290 <span class="comment">     */</span>
<a name="l00291"></a>00291     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="comment">/* This function is a wrapper for insert_bezt_fcurve_internal(), and should be used when</span>
<a name="l00295"></a>00295 <span class="comment"> * adding a new keyframe to a curve, when the keyframe doesn&#39;t exist anywhere else yet. </span>
<a name="l00296"></a>00296 <span class="comment"> * It returns the index at which the keyframe was added.</span>
<a name="l00297"></a>00297 <span class="comment"> */</span>
<a name="l00298"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a305f223959938da12f0d0a57e8246914">00298</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a0571cb8bf7d082031428aa24348644a9">insert_vert_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">short</span> flag)
<a name="l00299"></a>00299 {
<a name="l00300"></a>00300     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> beztr= {{{0}}};
<a name="l00301"></a>00301     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oldTot = fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>;
<a name="l00302"></a>00302     <span class="keywordtype">int</span> a;
<a name="l00303"></a>00303     
<a name="l00304"></a>00304     <span class="comment">/* set all three points, for nicer start position </span>
<a name="l00305"></a>00305 <span class="comment">     * NOTE: +/- 1 on vec.x for left and right handles is so that &#39;free&#39; handles work ok...</span>
<a name="l00306"></a>00306 <span class="comment">     */</span>
<a name="l00307"></a>00307     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0]= x-1.0f; 
<a name="l00308"></a>00308     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1]= y;
<a name="l00309"></a>00309     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]= x;
<a name="l00310"></a>00310     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1]= y;
<a name="l00311"></a>00311     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]= x+1.0f;
<a name="l00312"></a>00312     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1]= y;
<a name="l00313"></a>00313     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#ad1188a435612de53bc858987af3c7acd">f1</a>= beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a>= beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a426bd73dcd72de3539ed00b02646bac1">f3</a>= <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>;
<a name="l00314"></a>00314     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>= beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>= <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.keyhandles_new; <span class="comment">/* use default handle type here */</span>
<a name="l00315"></a>00315     <span class="comment">//BEZKEYTYPE(&amp;beztr)= scene-&gt;keytype; /* default keyframe type */</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="comment">/* use default interpolation mode, with exceptions for int/discrete values */</span>
<a name="l00318"></a>00318     beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a>= <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.ipo_new;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>)
<a name="l00321"></a>00321         beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a> = <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5a8a7c4acc7a8382a9c8e1f88c9688254d">BEZT_IPO_CONST</a>;
<a name="l00322"></a>00322     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a> == <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5a9163255a4d331348a32c994ea1b191ce">BEZT_IPO_BEZ</a> &amp;&amp; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a41ae3a6a2626d648a9150c3531ac8bb6">FCURVE_INT_VALUES</a>))
<a name="l00323"></a>00323         beztr.<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a> = <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5aa1cd3be3b402e1401033731c66a1613b">BEZT_IPO_LIN</a>;
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="comment">/* add temp beztriple to keyframes */</span>
<a name="l00326"></a>00326     a= <a class="code" href="../../db/d4b/keyframing_8c.html#ab139b5247c553842662942e96dc9df34">insert_bezt_fcurve</a>(fcu, &amp;beztr, flag);
<a name="l00327"></a>00327     
<a name="l00328"></a>00328     <span class="comment">/* what if &#39;a&#39; is a negative index? </span>
<a name="l00329"></a>00329 <span class="comment">     * for now, just exit to prevent any segfaults</span>
<a name="l00330"></a>00330 <span class="comment">     */</span>
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (a &lt; 0) <span class="keywordflow">return</span> -1;
<a name="l00332"></a>00332     
<a name="l00333"></a>00333     <span class="comment">/* don&#39;t recalculate handles if fast is set</span>
<a name="l00334"></a>00334 <span class="comment">     *  - this is a hack to make importers faster</span>
<a name="l00335"></a>00335 <span class="comment">     *  - we may calculate twice (due to autohandle needing to be calculated twice)</span>
<a name="l00336"></a>00336 <span class="comment">     */</span>
<a name="l00337"></a>00337     <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea01863cb4196f71ef949912ed242ac93f">INSERTKEY_FAST</a>) == 0) 
<a name="l00338"></a>00338         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#abb464452313d3795a48da7421069f9e3">calchandles_fcurve</a>(fcu);
<a name="l00339"></a>00339     
<a name="l00340"></a>00340     <span class="comment">/* set handletype and interpolation */</span>
<a name="l00341"></a>00341     <span class="keywordflow">if</span> ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> &gt; 2) &amp;&amp; (flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea530096d4f2231f90cc15f77773e50562">INSERTKEY_REPLACE</a>)==0) {
<a name="l00342"></a>00342         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#ad793ed4b60fb6bb7586b7a196b6b2e61">bezt</a>= (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a> + a);
<a name="l00343"></a>00343         
<a name="l00344"></a>00344         <span class="comment">/* set interpolation from previous (if available), but only if we didn&#39;t just replace some keyframe </span>
<a name="l00345"></a>00345 <span class="comment">         *  - replacement is indicated by no-change in number of verts</span>
<a name="l00346"></a>00346 <span class="comment">         *  - when replacing, the user may have specified some interpolation that should be kept</span>
<a name="l00347"></a>00347 <span class="comment">         */</span>
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> &gt; oldTot) {
<a name="l00349"></a>00349             <span class="keywordflow">if</span> (a &gt; 0) 
<a name="l00350"></a>00350                 bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a>= (bezt-1)-&gt;ipo;
<a name="l00351"></a>00351             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a &lt; fcu-&gt;<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a7240a655e9059baf2961aaad6711145f">totvert</a>-1) 
<a name="l00352"></a>00352                 bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a>= (bezt+1)-&gt;ipo;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354             
<a name="l00355"></a>00355         <span class="comment">/* don&#39;t recalculate handles if fast is set</span>
<a name="l00356"></a>00356 <span class="comment">         *  - this is a hack to make importers faster</span>
<a name="l00357"></a>00357 <span class="comment">         *  - we may calculate twice (due to autohandle needing to be calculated twice)</span>
<a name="l00358"></a>00358 <span class="comment">         */</span>
<a name="l00359"></a>00359         <span class="keywordflow">if</span> ((flag &amp; INSERTKEY_FAST) == 0) 
<a name="l00360"></a>00360             <a class="code" href="../../da/dba/BKE__fcurve_8h.html#abb464452313d3795a48da7421069f9e3">calchandles_fcurve</a>(fcu);
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362     
<a name="l00363"></a>00363     <span class="comment">/* return the index at which the keyframe was added */</span>
<a name="l00364"></a>00364     <span class="keywordflow">return</span> a;
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">/* -------------- &#39;Smarter&#39; Keyframing Functions -------------------- */</span>
<a name="l00368"></a>00368 <span class="comment">/* return codes for new_key_needed */</span>
<a name="l00369"></a>00369 <span class="keyword">enum</span> {
<a name="l00370"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a0b64d66c156ddda25fdcb80b11cc26f8">00370</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a0b64d66c156ddda25fdcb80b11cc26f8">KEYNEEDED_DONTADD</a> = 0,
<a name="l00371"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">00371</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>,
<a name="l00372"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a43ff7dfc4a4f79ce282484f5cf6c5c63">00372</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a43ff7dfc4a4f79ce282484f5cf6c5c63">KEYNEEDED_DELPREV</a>,
<a name="l00373"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260ab31efb590e6fd832fa0f31e62fc6b882">00373</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260ab31efb590e6fd832fa0f31e62fc6b882">KEYNEEDED_DELNEXT</a>
<a name="l00374"></a>00374 } <span class="comment">/*eKeyNeededStatus*/</span>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment">/* This helper function determines whether a new keyframe is needed */</span>
<a name="l00377"></a>00377 <span class="comment">/* Cases where keyframes should not be added:</span>
<a name="l00378"></a>00378 <span class="comment"> *  1. Keyframe to be added between two keyframes with similar values</span>
<a name="l00379"></a>00379 <span class="comment"> *  2. Keyframe to be added on frame where two keyframes are already situated</span>
<a name="l00380"></a>00380 <span class="comment"> *  3. Keyframe lies at point that intersects the linear line between two keyframes</span>
<a name="l00381"></a>00381 <span class="comment"> */</span>
<a name="l00382"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ad4ecce5b0f1dd938eb24b9bbe2d408ff">00382</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ad4ecce5b0f1dd938eb24b9bbe2d408ff">new_key_needed</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> cFrame, <span class="keywordtype">float</span> nValue) 
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#ad793ed4b60fb6bb7586b7a196b6b2e61">bezt</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a2d6629facfe884d9d8b23618ba34814a">prev</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00385"></a>00385     <span class="keywordtype">int</span> totCount, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00386"></a>00386     <span class="keywordtype">float</span> valA = 0.0f, valB = 0.0f;
<a name="l00387"></a>00387     
<a name="l00388"></a>00388     <span class="comment">/* safety checking */</span>
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00390"></a>00390     totCount= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>;
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (totCount == 0) <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00392"></a>00392     
<a name="l00393"></a>00393     <span class="comment">/* loop through checking if any are the same */</span>
<a name="l00394"></a>00394     bezt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>;
<a name="l00395"></a>00395     <span class="keywordflow">for</span> (i=0; i&lt;totCount; i++) {
<a name="l00396"></a>00396         <span class="keywordtype">float</span> prevPosi=0.0f, prevVal=0.0f;
<a name="l00397"></a>00397         <span class="keywordtype">float</span> beztPosi=0.0f, beztVal=0.0f;
<a name="l00398"></a>00398             
<a name="l00399"></a>00399         <span class="comment">/* get current time+value */</span>    
<a name="l00400"></a>00400         beztPosi= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00401"></a>00401         beztVal= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00402"></a>00402             
<a name="l00403"></a>00403         <span class="keywordflow">if</span> (prev) {
<a name="l00404"></a>00404             <span class="comment">/* there is a keyframe before the one currently being examined */</span>       
<a name="l00405"></a>00405             
<a name="l00406"></a>00406             <span class="comment">/* get previous time+value */</span>
<a name="l00407"></a>00407             prevPosi= prev-&gt;vec[1][0];
<a name="l00408"></a>00408             prevVal= prev-&gt;vec[1][1];
<a name="l00409"></a>00409             
<a name="l00410"></a>00410             <span class="comment">/* keyframe to be added at point where there are already two similar points? */</span>
<a name="l00411"></a>00411             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prevPosi, cFrame) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztPosi, cFrame) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztPosi, prevPosi)) {
<a name="l00412"></a>00412                 <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a0b64d66c156ddda25fdcb80b11cc26f8">KEYNEEDED_DONTADD</a>;
<a name="l00413"></a>00413             }
<a name="l00414"></a>00414             
<a name="l00415"></a>00415             <span class="comment">/* keyframe between prev+current points ? */</span>
<a name="l00416"></a>00416             <span class="keywordflow">if</span> ((prevPosi &lt;= cFrame) &amp;&amp; (cFrame &lt;= beztPosi)) {
<a name="l00417"></a>00417                 <span class="comment">/* is the value of keyframe to be added the same as keyframes on either side ? */</span>
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prevVal, nValue) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztVal, nValue) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prevVal, beztVal)) {
<a name="l00419"></a>00419                     <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a0b64d66c156ddda25fdcb80b11cc26f8">KEYNEEDED_DONTADD</a>;
<a name="l00420"></a>00420                 }
<a name="l00421"></a>00421                 <span class="keywordflow">else</span> {
<a name="l00422"></a>00422                     <span class="keywordtype">float</span> realVal;
<a name="l00423"></a>00423                     
<a name="l00424"></a>00424                     <span class="comment">/* get real value of curve at that point */</span>
<a name="l00425"></a>00425                     realVal= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1ddf79cf14ac3b61c5ea5f3a3af5bd0c">evaluate_fcurve</a>(fcu, cFrame);
<a name="l00426"></a>00426                     
<a name="l00427"></a>00427                     <span class="comment">/* compare whether it&#39;s the same as proposed */</span>
<a name="l00428"></a>00428                     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(realVal, nValue))
<a name="l00429"></a>00429                         <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a0b64d66c156ddda25fdcb80b11cc26f8">KEYNEEDED_DONTADD</a>;
<a name="l00430"></a>00430                     <span class="keywordflow">else</span> 
<a name="l00431"></a>00431                         <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433             }
<a name="l00434"></a>00434             
<a name="l00435"></a>00435             <span class="comment">/* new keyframe before prev beztriple? */</span>
<a name="l00436"></a>00436             <span class="keywordflow">if</span> (cFrame &lt; prevPosi) {
<a name="l00437"></a>00437                 <span class="comment">/* A new keyframe will be added. However, whether the previous beztriple</span>
<a name="l00438"></a>00438 <span class="comment">                 * stays around or not depends on whether the values of previous/current</span>
<a name="l00439"></a>00439 <span class="comment">                 * beztriples and new keyframe are the same.</span>
<a name="l00440"></a>00440 <span class="comment">                 */</span>
<a name="l00441"></a>00441                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prevVal, nValue) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(beztVal, nValue) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(prevVal, beztVal))
<a name="l00442"></a>00442                     <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260ab31efb590e6fd832fa0f31e62fc6b882">KEYNEEDED_DELNEXT</a>;
<a name="l00443"></a>00443                 <span class="keywordflow">else</span> 
<a name="l00444"></a>00444                     <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00445"></a>00445             }
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447         <span class="keywordflow">else</span> {
<a name="l00448"></a>00448             <span class="comment">/* just add a keyframe if there&#39;s only one keyframe </span>
<a name="l00449"></a>00449 <span class="comment">             * and the new one occurs before the existing one does.</span>
<a name="l00450"></a>00450 <span class="comment">             */</span>
<a name="l00451"></a>00451             <span class="keywordflow">if</span> ((cFrame &lt; beztPosi) &amp;&amp; (totCount==1))
<a name="l00452"></a>00452                 <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454         
<a name="l00455"></a>00455         <span class="comment">/* continue. frame to do not yet passed (or other conditions not met) */</span>
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (i &lt; (totCount-1)) {
<a name="l00457"></a>00457             prev= <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#ad793ed4b60fb6bb7586b7a196b6b2e61">bezt</a>;
<a name="l00458"></a>00458             bezt++;
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460         <span class="keywordflow">else</span>
<a name="l00461"></a>00461             <span class="keywordflow">break</span>;
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463     
<a name="l00464"></a>00464     <span class="comment">/* Frame in which to add a new-keyframe occurs after all other keys</span>
<a name="l00465"></a>00465 <span class="comment">     * -&gt; If there are at least two existing keyframes, then if the values of the</span>
<a name="l00466"></a>00466 <span class="comment">     *   last two keyframes and the new-keyframe match, the last existing keyframe</span>
<a name="l00467"></a>00467 <span class="comment">     *   gets deleted as it is no longer required.</span>
<a name="l00468"></a>00468 <span class="comment">     * -&gt; Otherwise, a keyframe is just added. 1.0 is added so that fake-2nd-to-last</span>
<a name="l00469"></a>00469 <span class="comment">     *   keyframe is not equal to last keyframe.</span>
<a name="l00470"></a>00470 <span class="comment">     */</span>
<a name="l00471"></a>00471     bezt= (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a> + (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> - 1));
<a name="l00472"></a>00472     valA= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00473"></a>00473     
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (prev)
<a name="l00475"></a>00475         valB= prev-&gt;vec[1][1];
<a name="l00476"></a>00476     <span class="keywordflow">else</span> 
<a name="l00477"></a>00477         valB= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] + 1.0f; 
<a name="l00478"></a>00478         
<a name="l00479"></a>00479     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(valA, nValue) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(valA, valB))
<a name="l00480"></a>00480         <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a43ff7dfc4a4f79ce282484f5cf6c5c63">KEYNEEDED_DELPREV</a>;
<a name="l00481"></a>00481     <span class="keywordflow">else</span> 
<a name="l00482"></a>00482         <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a4a3c4efedb9652fcceb263c0c9f15bf6">KEYNEEDED_JUSTADD</a>;
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="comment">/* ------------------ RNA Data-Access Functions ------------------ */</span>
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="comment">/* Try to read value using RNA-properties obtained already */</span>
<a name="l00488"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a1fdd9ccd59df75232e1f424616aa5231">00488</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a1fdd9ccd59df75232e1f424616aa5231">setting_get_rna_value</a> (<a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop, <span class="keywordtype">int</span> index)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keywordtype">float</span> value= 0.0f;
<a name="l00491"></a>00491     
<a name="l00492"></a>00492     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a51b018d85ee119253ae423b9314eeaef">RNA_property_type</a>(prop)) {
<a name="l00493"></a>00493         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a3f897b521d476ae35d56f769b80b54f4">PROP_BOOLEAN</a>:
<a name="l00494"></a>00494             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(ptr, prop))
<a name="l00495"></a>00495                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#acb4afecfe847861cf6ebf4593d2b42bf">RNA_property_boolean_get_index</a>(ptr, prop, index);
<a name="l00496"></a>00496             <span class="keywordflow">else</span>
<a name="l00497"></a>00497                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#a3a4a0d200b12ded21d24676dcff67732">RNA_property_boolean_get</a>(ptr, prop);
<a name="l00498"></a>00498             <span class="keywordflow">break</span>;
<a name="l00499"></a>00499         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a620d0acb046e6bc10271434db1960d41">PROP_INT</a>:
<a name="l00500"></a>00500             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(ptr, prop))
<a name="l00501"></a>00501                 value= (<span class="keywordtype">float</span>)<a class="code" href="../../d3/d10/rna__access_8c.html#a30c78968af88b29eca251317dfbbece5">RNA_property_int_get_index</a>(ptr, prop, index);
<a name="l00502"></a>00502             <span class="keywordflow">else</span>
<a name="l00503"></a>00503                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#a7755e74d78f50e508966f2af17f7523e">RNA_property_int_get</a>(ptr, prop);
<a name="l00504"></a>00504             <span class="keywordflow">break</span>;
<a name="l00505"></a>00505         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a273da4f3eac15c9bfdf45600a9d3a223">PROP_FLOAT</a>:
<a name="l00506"></a>00506             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(ptr, prop))
<a name="l00507"></a>00507                 value= <a class="code" href="../../d3/d10/rna__access_8c.html#a402f3a472211a6817b5c1165566e35da">RNA_property_float_get_index</a>(ptr, prop, index);
<a name="l00508"></a>00508             <span class="keywordflow">else</span>
<a name="l00509"></a>00509                 value= <a class="code" href="../../d3/d10/rna__access_8c.html#a01215512e696b97758a08e61833fb8bd">RNA_property_float_get</a>(ptr, prop);
<a name="l00510"></a>00510             <span class="keywordflow">break</span>;
<a name="l00511"></a>00511         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a46db685881d563dbd4be267143d05b84">PROP_ENUM</a>:
<a name="l00512"></a>00512             value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#abb4862291354aedcb2cc916f1c30642b">RNA_property_enum_get</a>(ptr, prop);
<a name="l00513"></a>00513             <span class="keywordflow">break</span>;
<a name="l00514"></a>00514         <span class="keywordflow">default</span>:
<a name="l00515"></a>00515             <span class="keywordflow">break</span>;
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     
<a name="l00518"></a>00518     <span class="keywordflow">return</span> value;
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="comment">/* ------------------ &#39;Visual&#39; Keyframing Functions ------------------ */</span>
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="comment">/* internal status codes for visualkey_can_use */</span>
<a name="l00524"></a>00524 <span class="keyword">enum</span> {
<a name="l00525"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ac5467ac9e78177c26bcb29a0590d47fc">00525</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ac5467ac9e78177c26bcb29a0590d47fc">VISUALKEY_NONE</a> = 0,
<a name="l00526"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">00526</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>,
<a name="l00527"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">00527</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>
<a name="l00528"></a>00528     <span class="comment">/* VISUALKEY_SCA */</span> <span class="comment">/* TODO - looks like support can be added now */</span>
<a name="l00529"></a>00529 };
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="comment">/* This helper function determines if visual-keyframing should be used when  </span>
<a name="l00532"></a>00532 <span class="comment"> * inserting keyframes for the given channel. As visual-keyframing only works</span>
<a name="l00533"></a>00533 <span class="comment"> * on Object and Pose-Channel blocks, this should only get called for those </span>
<a name="l00534"></a>00534 <span class="comment"> * blocktypes, when using &quot;standard&quot; keying but &#39;Visual Keying&#39; option in Auto-Keying </span>
<a name="l00535"></a>00535 <span class="comment"> * settings is on.</span>
<a name="l00536"></a>00536 <span class="comment"> */</span>
<a name="l00537"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a23b70954ade42dcf3fe3d7bbff8e537b">00537</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a23b70954ade42dcf3fe3d7bbff8e537b">visualkey_can_use</a> (<a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop)
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00540"></a>00540     <span class="keywordtype">short</span> searchtype= <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ac5467ac9e78177c26bcb29a0590d47fc">VISUALKEY_NONE</a>;
<a name="l00541"></a>00541     <span class="keywordtype">short</span> has_parent = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00542"></a>00542     <span class="keyword">const</span> <span class="keywordtype">char</span> *identifier= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00543"></a>00543     
<a name="l00544"></a>00544     <span class="comment">/* validate data */</span>
<a name="l00545"></a>00545     <span class="comment">// TODO: this check is probably not needed, but it won&#39;t hurt</span>
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ptr, ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>, prop))
<a name="l00547"></a>00547         <span class="keywordflow">return</span> 0;
<a name="l00548"></a>00548         
<a name="l00549"></a>00549     <span class="comment">/* get first constraint and determine type of keyframe constraints to check for </span>
<a name="l00550"></a>00550 <span class="comment">     *  - constraints can be on either Objects or PoseChannels, so we only check if the</span>
<a name="l00551"></a>00551 <span class="comment">     *    ptr-&gt;type is RNA_Object or RNA_PoseBone, which are the RNA wrapping-info for</span>
<a name="l00552"></a>00552 <span class="comment">     *    those structs, allowing us to identify the owner of the data</span>
<a name="l00553"></a>00553 <span class="comment">     */</span>
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aada94b4b642ee7efbcc6ac0dadc8c4b2">RNA_Object</a>) {
<a name="l00555"></a>00555         <span class="comment">/* Object */</span>
<a name="l00556"></a>00556         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00557"></a>00557         
<a name="l00558"></a>00558         con= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a15cd252985e63b0a4b12a07297a7aa8b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00559"></a>00559         identifier= <a class="code" href="../../d3/d10/rna__access_8c.html#ad6f3c9684a8786587872fc6baf17dfc9">RNA_property_identifier</a>(prop);
<a name="l00560"></a>00560         has_parent= (ob-&gt;<a class="code" href="../../de/de7/structObject.html#acefcc0d10011d68526b827509403b951">parent</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aa57827e223e108b43db078059b848997">RNA_PoseBone</a>) {
<a name="l00563"></a>00563         <span class="comment">/* Pose Channel */</span>
<a name="l00564"></a>00564         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00565"></a>00565         
<a name="l00566"></a>00566         con= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00567"></a>00567         identifier= <a class="code" href="../../d3/d10/rna__access_8c.html#ad6f3c9684a8786587872fc6baf17dfc9">RNA_property_identifier</a>(prop);
<a name="l00568"></a>00568         has_parent= (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570     
<a name="l00571"></a>00571     <span class="comment">/* check if any data to search using */</span>
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, con, identifier) &amp;&amp; (has_parent == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))
<a name="l00573"></a>00573         <span class="keywordflow">return</span> 0;
<a name="l00574"></a>00574         
<a name="l00575"></a>00575     <span class="comment">/* location or rotation identifiers only... */</span>
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (identifier == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00577"></a>00577         printf(<span class="stringliteral">&quot;%s failed: NULL identifier\n&quot;</span>, __func__);
<a name="l00578"></a>00578         <span class="keywordflow">return</span> 0;
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;location&quot;</span>)) {
<a name="l00581"></a>00581         searchtype= <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation&quot;</span>)) {
<a name="l00584"></a>00584         searchtype= <a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     <span class="keywordflow">else</span> {
<a name="l00587"></a>00587         printf(<span class="stringliteral">&quot;%s failed: identifier - &#39;%s&#39;\n&quot;</span>, __func__, identifier);
<a name="l00588"></a>00588         <span class="keywordflow">return</span> 0;
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     
<a name="l00591"></a>00591     
<a name="l00592"></a>00592     <span class="comment">/* only search if a searchtype and initial constraint are available */</span>
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (searchtype) {
<a name="l00594"></a>00594         <span class="comment">/* parent is always matching */</span>
<a name="l00595"></a>00595         <span class="keywordflow">if</span> (has_parent)
<a name="l00596"></a>00596             <span class="keywordflow">return</span> 1;
<a name="l00597"></a>00597         
<a name="l00598"></a>00598         <span class="comment">/* constraints */</span>
<a name="l00599"></a>00599         <span class="keywordflow">for</span> (; con; con= con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l00600"></a>00600             <span class="comment">/* only consider constraint if it is not disabled, and has influence */</span>
<a name="l00601"></a>00601             <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efdac624d1811979843b913fe2a7c3833c53">CONSTRAINT_DISABLE</a>) <span class="keywordflow">continue</span>;
<a name="l00602"></a>00602             <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> == 0.0f) <span class="keywordflow">continue</span>;
<a name="l00603"></a>00603             
<a name="l00604"></a>00604             <span class="comment">/* some constraints may alter these transforms */</span>
<a name="l00605"></a>00605             <span class="keywordflow">switch</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a>) {
<a name="l00606"></a>00606                 <span class="comment">/* multi-transform constraints */</span>
<a name="l00607"></a>00607                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a23ff53dbd5e0a68bbd1656c899089630">CONSTRAINT_TYPE_CHILDOF</a>:
<a name="l00608"></a>00608                     <span class="keywordflow">return</span> 1;
<a name="l00609"></a>00609                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a27444db9c3d996dc97212fdab93a17a7">CONSTRAINT_TYPE_TRANSFORM</a>:
<a name="l00610"></a>00610                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5aa8188aca6a97fb120039f79fbabc88bc">CONSTRAINT_TYPE_TRANSLIKE</a>:
<a name="l00611"></a>00611                     <span class="keywordflow">return</span> 1;
<a name="l00612"></a>00612                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5adb7c70567fff24da35d0186e600ee38b">CONSTRAINT_TYPE_FOLLOWPATH</a>:
<a name="l00613"></a>00613                     <span class="keywordflow">return</span> 1;
<a name="l00614"></a>00614                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a8061c31c9da4a7351ce57037615d2c16">CONSTRAINT_TYPE_KINEMATIC</a>:
<a name="l00615"></a>00615                     <span class="keywordflow">return</span> 1;
<a name="l00616"></a>00616                     
<a name="l00617"></a>00617                 <span class="comment">/* single-transform constraits  */</span>
<a name="l00618"></a>00618                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a0a299f49fea25012a0b3cf4fab903ad7">CONSTRAINT_TYPE_TRACKTO</a>:
<a name="l00619"></a>00619                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>) <span class="keywordflow">return</span> 1;
<a name="l00620"></a>00620                     <span class="keywordflow">break</span>;
<a name="l00621"></a>00621                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a5dbe292ea3b5603f1d949964a243ba81">CONSTRAINT_TYPE_ROTLIMIT</a>:
<a name="l00622"></a>00622                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>) <span class="keywordflow">return</span> 1;
<a name="l00623"></a>00623                     <span class="keywordflow">break</span>;
<a name="l00624"></a>00624                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5aacf7ad78cacd4f1d8e999ef0ab64caf6">CONSTRAINT_TYPE_LOCLIMIT</a>:
<a name="l00625"></a>00625                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>) <span class="keywordflow">return</span> 1;
<a name="l00626"></a>00626                     <span class="keywordflow">break</span>;
<a name="l00627"></a>00627                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a70c9feed7fc4fb8e76891e7491245127">CONSTRAINT_TYPE_ROTLIKE</a>:
<a name="l00628"></a>00628                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>) <span class="keywordflow">return</span> 1;
<a name="l00629"></a>00629                     <span class="keywordflow">break</span>;
<a name="l00630"></a>00630                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a93f32e658d1d1a07eae1680fa573e7ec">CONSTRAINT_TYPE_DISTLIMIT</a>:
<a name="l00631"></a>00631                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>) <span class="keywordflow">return</span> 1;
<a name="l00632"></a>00632                     <span class="keywordflow">break</span>;
<a name="l00633"></a>00633                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a51cbb625f2e83f56a6e960b8a78f49b7">CONSTRAINT_TYPE_LOCLIKE</a>:
<a name="l00634"></a>00634                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>) <span class="keywordflow">return</span> 1;
<a name="l00635"></a>00635                     <span class="keywordflow">break</span>;
<a name="l00636"></a>00636                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5ac9eb1f7a921d259ad6baeea151f04630">CONSTRAINT_TYPE_LOCKTRACK</a>:
<a name="l00637"></a>00637                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0ad1dcb33f8e6aba50a4591fe39096776e">VISUALKEY_ROT</a>) <span class="keywordflow">return</span> 1;
<a name="l00638"></a>00638                     <span class="keywordflow">break</span>;
<a name="l00639"></a>00639                 <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a5912e6744cbb5720e1344e468ca35d8b">CONSTRAINT_TYPE_MINMAX</a>:
<a name="l00640"></a>00640                     <span class="keywordflow">if</span> (searchtype==<a class="code" href="../../db/d4b/keyframing_8c.html#a9e93d8eae633734dfeb29e24a1f3a7c0a83f621a9f98bc54563f1a11382ad9cdd">VISUALKEY_LOC</a>) <span class="keywordflow">return</span> 1;
<a name="l00641"></a>00641                     <span class="keywordflow">break</span>;
<a name="l00642"></a>00642                 
<a name="l00643"></a>00643                 <span class="keywordflow">default</span>:
<a name="l00644"></a>00644                     <span class="keywordflow">break</span>;
<a name="l00645"></a>00645             }
<a name="l00646"></a>00646         }
<a name="l00647"></a>00647     }
<a name="l00648"></a>00648     
<a name="l00649"></a>00649     <span class="comment">/* when some condition is met, this function returns, so here it can be 0 */</span>
<a name="l00650"></a>00650     <span class="keywordflow">return</span> 0;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="comment">/* This helper function extracts the value to use for visual-keyframing </span>
<a name="l00654"></a>00654 <span class="comment"> * In the event that it is not possible to perform visual keying, try to fall-back</span>
<a name="l00655"></a>00655 <span class="comment"> * to using the default method. Assumes that all data it has been passed is valid.</span>
<a name="l00656"></a>00656 <span class="comment"> */</span>
<a name="l00657"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ad89d44521c5a9aa0435252c1f18e3fd8">00657</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ad89d44521c5a9aa0435252c1f18e3fd8">visualkey_get_value</a> (<a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop, <span class="keywordtype">int</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>)
<a name="l00658"></a>00658 {
<a name="l00659"></a>00659     <span class="keyword">const</span> <span class="keywordtype">char</span> *identifier= <a class="code" href="../../d3/d10/rna__access_8c.html#ad6f3c9684a8786587872fc6baf17dfc9">RNA_property_identifier</a>(prop);
<a name="l00660"></a>00660     
<a name="l00661"></a>00661     <span class="comment">/* handle for Objects or PoseChannels only </span>
<a name="l00662"></a>00662 <span class="comment">     *  - constraints can be on either Objects or PoseChannels, so we only check if the</span>
<a name="l00663"></a>00663 <span class="comment">     *    ptr-&gt;type is RNA_Object or RNA_PoseBone, which are the RNA wrapping-info for</span>
<a name="l00664"></a>00664 <span class="comment">     *        those structs, allowing us to identify the owner of the data </span>
<a name="l00665"></a>00665 <span class="comment">     *  - assume that array_index will be sane</span>
<a name="l00666"></a>00666 <span class="comment">     */</span>
<a name="l00667"></a>00667     <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aada94b4b642ee7efbcc6ac0dadc8c4b2">RNA_Object</a>) {
<a name="l00668"></a>00668         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00669"></a>00669         
<a name="l00670"></a>00670         <span class="comment">/* only Location or Rotation keyframes are supported now */</span>
<a name="l00671"></a>00671         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (strstr(identifier, <span class="stringliteral">&quot;location&quot;</span>)) {
<a name="l00672"></a>00672             <span class="keywordflow">return</span> ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3][<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_euler&quot;</span>)) {
<a name="l00675"></a>00675             <span class="keywordtype">float</span> eul[3];
<a name="l00676"></a>00676             
<a name="l00677"></a>00677             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4baf6d531a682ae3eba58e56c27374a4">mat4_to_eulO</a>(eul, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aacca751408fdb1bc64d18670bcc4d73e">rotmode</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00678"></a>00678             <span class="keywordflow">return</span> eul[<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_quaternion&quot;</span>)) {
<a name="l00681"></a>00681             <span class="keywordtype">float</span> trimat[3][3], quat[4];
<a name="l00682"></a>00682             
<a name="l00683"></a>00683             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(trimat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00684"></a>00684             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a386b66d3598a9637999aa7bb91a1619c">mat3_to_quat_is_ok</a>(quat, trimat);
<a name="l00685"></a>00685             
<a name="l00686"></a>00686             <span class="keywordflow">return</span> quat[<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_axis_angle&quot;</span>)) {
<a name="l00689"></a>00689             <span class="keywordtype">float</span> axis[3], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00690"></a>00690             
<a name="l00691"></a>00691             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3795fcda1516668077d728c3ba319f40">mat4_to_axis_angle</a>(axis, &amp;angle, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00692"></a>00692             
<a name="l00693"></a>00693             <span class="comment">/* w = 0, x,y,z = 1,2,3 */</span>
<a name="l00694"></a>00694             <span class="keywordflow">if</span> (array_index == 0)
<a name="l00695"></a>00695                 <span class="keywordflow">return</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00696"></a>00696             <span class="keywordflow">else</span>
<a name="l00697"></a>00697                 <span class="keywordflow">return</span> axis[array_index - 1];
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aa57827e223e108b43db078059b848997">RNA_PoseBone</a>) {
<a name="l00701"></a>00701         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = (<a class="code" href="../../de/de7/structObject.html">Object</a> *)ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>; <span class="comment">/* we assume that this is always set, and is an object */</span>
<a name="l00702"></a>00702         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan= (<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *)ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00703"></a>00703         <span class="keywordtype">float</span> tmat[4][4];
<a name="l00704"></a>00704         
<a name="l00705"></a>00705         <span class="comment">/* Although it is not strictly required for this particular space conversion, </span>
<a name="l00706"></a>00706 <span class="comment">         * arg1 must not be null, as there is a null check for the other conversions to</span>
<a name="l00707"></a>00707 <span class="comment">         * be safe. Therefore, the active object is passed here, and in many cases, this</span>
<a name="l00708"></a>00708 <span class="comment">         * will be what owns the pose-channel that is getting this anyway.</span>
<a name="l00709"></a>00709 <span class="comment">         */</span>
<a name="l00710"></a>00710         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmat, pchan-&gt;pose_mat);
<a name="l00711"></a>00711         <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#ae040cca2a719b9e836aa44b2bd82b724">constraint_mat_convertspace</a>(ob, pchan, tmat, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303a611a7ece07a5656a655d1f21db1b49a2">CONSTRAINT_SPACE_POSE</a>, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303adcd072a1a47c05df5aaad749d71b5ebf">CONSTRAINT_SPACE_LOCAL</a>);
<a name="l00712"></a>00712         
<a name="l00713"></a>00713         <span class="comment">/* Loc, Rot/Quat keyframes are supported... */</span>
<a name="l00714"></a>00714         <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;location&quot;</span>)) {
<a name="l00715"></a>00715             <span class="comment">/* only use for non-connected bones */</span>
<a name="l00716"></a>00716             <span class="keywordflow">if</span> ((pchan-&gt;bone-&gt;parent) &amp;&amp; !(pchan-&gt;bone-&gt;flag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>))
<a name="l00717"></a>00717                 <span class="keywordflow">return</span> tmat[3][<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00718"></a>00718             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;bone-&gt;parent == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00719"></a>00719                 <span class="keywordflow">return</span> tmat[3][<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_euler&quot;</span>)) {
<a name="l00722"></a>00722             <span class="keywordtype">float</span> eul[3];
<a name="l00723"></a>00723             
<a name="l00724"></a>00724             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4baf6d531a682ae3eba58e56c27374a4">mat4_to_eulO</a>(eul, pchan-&gt;rotmode, tmat);
<a name="l00725"></a>00725             <span class="keywordflow">return</span> eul[<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_quaternion&quot;</span>)) {
<a name="l00728"></a>00728             <span class="keywordtype">float</span> trimat[3][3], quat[4];
<a name="l00729"></a>00729             
<a name="l00730"></a>00730             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(trimat, tmat);
<a name="l00731"></a>00731             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a386b66d3598a9637999aa7bb91a1619c">mat3_to_quat_is_ok</a>(quat, trimat);
<a name="l00732"></a>00732             
<a name="l00733"></a>00733             <span class="keywordflow">return</span> quat[<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>];
<a name="l00734"></a>00734         }
<a name="l00735"></a>00735         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(identifier, <span class="stringliteral">&quot;rotation_axis_angle&quot;</span>)) {
<a name="l00736"></a>00736             <span class="keywordtype">float</span> axis[3], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00737"></a>00737             
<a name="l00738"></a>00738             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3795fcda1516668077d728c3ba319f40">mat4_to_axis_angle</a>(axis, &amp;angle, tmat);
<a name="l00739"></a>00739             
<a name="l00740"></a>00740             <span class="comment">/* w = 0, x,y,z = 1,2,3 */</span>
<a name="l00741"></a>00741             <span class="keywordflow">if</span> (array_index == 0)
<a name="l00742"></a>00742                 <span class="keywordflow">return</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00743"></a>00743             <span class="keywordflow">else</span>
<a name="l00744"></a>00744                 <span class="keywordflow">return</span> axis[array_index - 1];
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747     
<a name="l00748"></a>00748     <span class="comment">/* as the function hasn&#39;t returned yet, read value from system in the default way */</span>
<a name="l00749"></a>00749     <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a1fdd9ccd59df75232e1f424616aa5231">setting_get_rna_value</a>(ptr, prop, array_index);
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752 <span class="comment">/* ------------------------- Insert Key API ------------------------- */</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="comment">/* Secondary Keyframing API call: </span>
<a name="l00755"></a>00755 <span class="comment"> *  Use this when validation of necessary animation data is not necessary, since an RNA-pointer to the necessary</span>
<a name="l00756"></a>00756 <span class="comment"> *  data being keyframed, and a pointer to the F-Curve to use have both been provided.</span>
<a name="l00757"></a>00757 <span class="comment"> *</span>
<a name="l00758"></a>00758 <span class="comment"> *  The flag argument is used for special settings that alter the behavior of</span>
<a name="l00759"></a>00759 <span class="comment"> *  the keyframe insertion. These include the &#39;visual&#39; keyframing modes, quick refresh,</span>
<a name="l00760"></a>00760 <span class="comment"> *  and extra keyframe filtering.</span>
<a name="l00761"></a>00761 <span class="comment"> */</span>
<a name="l00762"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a28b91e641ef6b2b8876bf9c982bbd180">00762</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a25ec9cccd9f3560210556afca64c74ac">insert_keyframe_direct</a> (<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop, <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> cfra, <span class="keywordtype">short</span> flag)
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764     <span class="keywordtype">float</span> curval= 0.0f;
<a name="l00765"></a>00765     
<a name="l00766"></a>00766     <span class="comment">/* no F-Curve to add keyframe to? */</span>
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00768"></a>00768         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No F-Curve to add keyframes to&quot;</span>);
<a name="l00769"></a>00769         <span class="keywordflow">return</span> 0;
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="comment">/* F-Curve not editable? */</span>
<a name="l00772"></a>00772     <span class="keywordflow">if</span> (<a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa6d423dce8219035b7cc9f06b85d4585">fcurve_is_keyframable</a>(fcu) == 0) {
<a name="l00773"></a>00773         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, 
<a name="l00774"></a>00774             <span class="stringliteral">&quot;F-Curve with path = &#39;%s&#39; [%d] cannot be keyframed. Ensure that it is not locked or sampled. Also, try removing F-Modifiers&quot;</span>,
<a name="l00775"></a>00775             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a>);
<a name="l00776"></a>00776         <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778     
<a name="l00779"></a>00779     <span class="comment">/* if no property given yet, try to validate from F-Curve info */</span>
<a name="l00780"></a>00780     <span class="keywordflow">if</span> ((ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00781"></a>00781         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No RNA-pointer available to retrieve values for keyframing from&quot;</span>);
<a name="l00782"></a>00782         <span class="keywordflow">return</span> 0;
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (prop == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00785"></a>00785         <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> tmp_ptr;
<a name="l00786"></a>00786         
<a name="l00787"></a>00787         <span class="comment">/* try to get property we should be affecting */</span>
<a name="l00788"></a>00788         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d10/rna__access_8c.html#a003cb660a44918af456e10e005495f86">RNA_path_resolve</a>(&amp;ptr, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, &amp;tmp_ptr, &amp;prop) == 0) || (prop == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00789"></a>00789             <span class="comment">/* property not found... */</span>
<a name="l00790"></a>00790             <span class="keyword">const</span> <span class="keywordtype">char</span> *idname= (ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>) ? ((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>)-&gt;name : <span class="stringliteral">&quot;&lt;No ID-Pointer&gt;&quot;</span>;
<a name="l00791"></a>00791             
<a name="l00792"></a>00792             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>,
<a name="l00793"></a>00793                 <span class="stringliteral">&quot;Could not insert keyframe, as RNA Path is invalid for the given ID (ID = %s, Path = %s)&quot;</span>, 
<a name="l00794"></a>00794                 idname, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>);
<a name="l00795"></a>00795             <span class="keywordflow">return</span> 0;
<a name="l00796"></a>00796         }
<a name="l00797"></a>00797         <span class="keywordflow">else</span> {
<a name="l00798"></a>00798             <span class="comment">/* property found, so overwrite &#39;ptr&#39; to make later code easier */</span>
<a name="l00799"></a>00799             ptr= tmp_ptr;
<a name="l00800"></a>00800         }
<a name="l00801"></a>00801     }
<a name="l00802"></a>00802     
<a name="l00803"></a>00803     <span class="comment">/* set additional flags for the F-Curve (i.e. only integer values) */</span>
<a name="l00804"></a>00804     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp;= ~(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a41ae3a6a2626d648a9150c3531ac8bb6">FCURVE_INT_VALUES</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>);
<a name="l00805"></a>00805     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a51b018d85ee119253ae423b9314eeaef">RNA_property_type</a>(prop)) {
<a name="l00806"></a>00806         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a273da4f3eac15c9bfdf45600a9d3a223">PROP_FLOAT</a>:
<a name="l00807"></a>00807             <span class="comment">/* do nothing */</span>
<a name="l00808"></a>00808             <span class="keywordflow">break</span>;
<a name="l00809"></a>00809         <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a620d0acb046e6bc10271434db1960d41">PROP_INT</a>:
<a name="l00810"></a>00810             <span class="comment">/* do integer (only &#39;whole&#39; numbers) interpolation between all points */</span>
<a name="l00811"></a>00811             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a41ae3a6a2626d648a9150c3531ac8bb6">FCURVE_INT_VALUES</a>;
<a name="l00812"></a>00812             <span class="keywordflow">break</span>;
<a name="l00813"></a>00813         <span class="keywordflow">default</span>:
<a name="l00814"></a>00814             <span class="comment">/* do &#39;discrete&#39; (i.e. enum, boolean values which cannot take any intermediate</span>
<a name="l00815"></a>00815 <span class="comment">             * values at all) interpolation between all points</span>
<a name="l00816"></a>00816 <span class="comment">             *  - however, we must also ensure that evaluated values are only integers still</span>
<a name="l00817"></a>00817 <span class="comment">             */</span>
<a name="l00818"></a>00818             fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> |= (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a41ae3a6a2626d648a9150c3531ac8bb6">FCURVE_INT_VALUES</a>);
<a name="l00819"></a>00819             <span class="keywordflow">break</span>;
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821     
<a name="l00822"></a>00822     <span class="comment">/* obtain value to give keyframe */</span>
<a name="l00823"></a>00823     <span class="keywordflow">if</span> ( (flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea6129ec465839968d5faafe2f901af338">INSERTKEY_MATRIX</a>) &amp;&amp; 
<a name="l00824"></a>00824          (<a class="code" href="../../db/d4b/keyframing_8c.html#a23b70954ade42dcf3fe3d7bbff8e537b">visualkey_can_use</a>(&amp;ptr, prop)) ) 
<a name="l00825"></a>00825     {
<a name="l00826"></a>00826         <span class="comment">/* visual-keying is only available for object and pchan datablocks, as </span>
<a name="l00827"></a>00827 <span class="comment">         * it works by keyframing using a value extracted from the final matrix </span>
<a name="l00828"></a>00828 <span class="comment">         * instead of using the kt system to extract a value.</span>
<a name="l00829"></a>00829 <span class="comment">         */</span>
<a name="l00830"></a>00830         curval= <a class="code" href="../../db/d4b/keyframing_8c.html#ad89d44521c5a9aa0435252c1f18e3fd8">visualkey_get_value</a>(&amp;ptr, prop, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a>);
<a name="l00831"></a>00831     }
<a name="l00832"></a>00832     <span class="keywordflow">else</span> {
<a name="l00833"></a>00833         <span class="comment">/* read value from system */</span>
<a name="l00834"></a>00834         curval= <a class="code" href="../../db/d4b/keyframing_8c.html#a1fdd9ccd59df75232e1f424616aa5231">setting_get_rna_value</a>(&amp;ptr, prop, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a>);
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836     
<a name="l00837"></a>00837     <span class="comment">/* only insert keyframes where they are needed */</span>
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea661b03e7db741895f1910da63c6ac08e">INSERTKEY_NEEDED</a>) {
<a name="l00839"></a>00839         <span class="keywordtype">short</span> insert_mode;
<a name="l00840"></a>00840         
<a name="l00841"></a>00841         <span class="comment">/* check whether this curve really needs a new keyframe */</span>
<a name="l00842"></a>00842         insert_mode= <a class="code" href="../../db/d4b/keyframing_8c.html#ad4ecce5b0f1dd938eb24b9bbe2d408ff">new_key_needed</a>(fcu, cfra, curval);
<a name="l00843"></a>00843         
<a name="l00844"></a>00844         <span class="comment">/* insert new keyframe at current frame */</span>
<a name="l00845"></a>00845         <span class="keywordflow">if</span> (insert_mode)
<a name="l00846"></a>00846             <a class="code" href="../../db/d4b/keyframing_8c.html#a0571cb8bf7d082031428aa24348644a9">insert_vert_fcurve</a>(fcu, cfra, curval, flag);
<a name="l00847"></a>00847         
<a name="l00848"></a>00848         <span class="comment">/* delete keyframe immediately before/after newly added */</span>
<a name="l00849"></a>00849         <span class="keywordflow">switch</span> (insert_mode) {
<a name="l00850"></a>00850             <span class="keywordflow">case</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260a43ff7dfc4a4f79ce282484f5cf6c5c63">KEYNEEDED_DELPREV</a>:
<a name="l00851"></a>00851                 <a class="code" href="../../db/d58/keyframes__general_8c.html#ab3323422d47da77c0a8bdae4f9dbc626">delete_fcurve_key</a>(fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-2, 1);
<a name="l00852"></a>00852                 <span class="keywordflow">break</span>;
<a name="l00853"></a>00853             <span class="keywordflow">case</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ade9ca5088d171ad20b4c237f1c2d6260ab31efb590e6fd832fa0f31e62fc6b882">KEYNEEDED_DELNEXT</a>:
<a name="l00854"></a>00854                 <a class="code" href="../../db/d58/keyframes__general_8c.html#ab3323422d47da77c0a8bdae4f9dbc626">delete_fcurve_key</a>(fcu, 1, 1);
<a name="l00855"></a>00855                 <span class="keywordflow">break</span>;
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857         
<a name="l00858"></a>00858         <span class="comment">/* only return success if keyframe added */</span>
<a name="l00859"></a>00859         <span class="keywordflow">if</span> (insert_mode)
<a name="l00860"></a>00860             <span class="keywordflow">return</span> 1;
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862     <span class="keywordflow">else</span> {
<a name="l00863"></a>00863         <span class="comment">/* just insert keyframe */</span>
<a name="l00864"></a>00864         <a class="code" href="../../db/d4b/keyframing_8c.html#a0571cb8bf7d082031428aa24348644a9">insert_vert_fcurve</a>(fcu, cfra, curval, flag);
<a name="l00865"></a>00865         
<a name="l00866"></a>00866         <span class="comment">/* return success */</span>
<a name="l00867"></a>00867         <span class="keywordflow">return</span> 1;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869     
<a name="l00870"></a>00870     <span class="comment">/* failed */</span>
<a name="l00871"></a>00871     <span class="keywordflow">return</span> 0;
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="comment">/* Main Keyframing API call:</span>
<a name="l00875"></a>00875 <span class="comment"> *  Use this when validation of necessary animation data is necessary, since it may not exist yet.</span>
<a name="l00876"></a>00876 <span class="comment"> *  </span>
<a name="l00877"></a>00877 <span class="comment"> *  The flag argument is used for special settings that alter the behavior of</span>
<a name="l00878"></a>00878 <span class="comment"> *  the keyframe insertion. These include the &#39;visual&#39; keyframing modes, quick refresh,</span>
<a name="l00879"></a>00879 <span class="comment"> *  and extra keyframe filtering.</span>
<a name="l00880"></a>00880 <span class="comment"> *</span>
<a name="l00881"></a>00881 <span class="comment"> *  index of -1 keys all array indices</span>
<a name="l00882"></a>00882 <span class="comment"> */</span>
<a name="l00883"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#abd9df9612aa6451edd238a7b2b8fa1b1">00883</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a7b16b21b2ffb9b0e3b5caf7c60cadc76">insert_keyframe</a> (<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <span class="keyword">const</span> <span class="keywordtype">char</span> group[], <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a4703b9509fd2ed178b657f6ffff9d808">rna_path</a>[], <span class="keywordtype">int</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>, <span class="keywordtype">float</span> cfra, <span class="keywordtype">short</span> flag)
<a name="l00884"></a>00884 {   
<a name="l00885"></a>00885     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> id_ptr, ptr;
<a name="l00886"></a>00886     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00887"></a>00887     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00888"></a>00888     <span class="keywordtype">int</span> array_index_max= array_index+1;
<a name="l00889"></a>00889     <span class="keywordtype">int</span> ret= 0;
<a name="l00890"></a>00890     
<a name="l00891"></a>00891     <span class="comment">/* validate pointer first - exit if failure */</span>
<a name="l00892"></a>00892     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00893"></a>00893         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No ID-block to insert keyframe in (Path = %s)&quot;</span>, rna_path);
<a name="l00894"></a>00894         <span class="keywordflow">return</span> 0;
<a name="l00895"></a>00895     }
<a name="l00896"></a>00896     
<a name="l00897"></a>00897     <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(<span class="keywordtype">id</span>, &amp;id_ptr);
<a name="l00898"></a>00898     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d10/rna__access_8c.html#a003cb660a44918af456e10e005495f86">RNA_path_resolve</a>(&amp;id_ptr, rna_path, &amp;ptr, &amp;prop) == 0) || (prop == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00899"></a>00899         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>,
<a name="l00900"></a>00900             <span class="stringliteral">&quot;Could not insert keyframe, as RNA Path is invalid for the given ID (ID = %s, Path = %s)&quot;</span>, 
<a name="l00901"></a>00901             (<span class="keywordtype">id</span>)? id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> : <span class="stringliteral">&quot;&lt;Missing ID-Block&gt;&quot;</span>, rna_path);
<a name="l00902"></a>00902         <span class="keywordflow">return</span> 0;
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904     
<a name="l00905"></a>00905     <span class="comment">/* if no action is provided, keyframe to the default one attached to this ID-block */</span>
<a name="l00906"></a>00906     <span class="keywordflow">if</span> (act == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00907"></a>00907         <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(<span class="keywordtype">id</span>);
<a name="l00908"></a>00908         
<a name="l00909"></a>00909         <span class="comment">/* get action to add F-Curve+keyframe to */</span>
<a name="l00910"></a>00910         act= <a class="code" href="../../db/d4b/keyframing_8c.html#abe8806e0669cf3b73a246c0e4c7eacd5">verify_adt_action</a>(<span class="keywordtype">id</span>, 1);
<a name="l00911"></a>00911         
<a name="l00912"></a>00912         <span class="keywordflow">if</span> (act == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00913"></a>00913             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, 
<a name="l00914"></a>00914                 <span class="stringliteral">&quot;Could not insert keyframe, as this type does not support animation data (ID = %s, Path = %s)&quot;</span>, 
<a name="l00915"></a>00915                 id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, rna_path);
<a name="l00916"></a>00916             <span class="keywordflow">return</span> 0;
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         
<a name="l00919"></a>00919         <span class="comment">/* apply NLA-mapping to frame to use (if applicable) */</span>
<a name="l00920"></a>00920         cfra= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, cfra, <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>);
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922     
<a name="l00923"></a>00923     <span class="comment">/* key entire array convenience method */</span>
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (array_index == -1) { 
<a name="l00925"></a>00925         array_index= 0;
<a name="l00926"></a>00926         array_index_max= <a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(&amp;ptr, prop);
<a name="l00927"></a>00927         
<a name="l00928"></a>00928         <span class="comment">/* for single properties, increase max_index so that the property itself gets included,</span>
<a name="l00929"></a>00929 <span class="comment">         * but don&#39;t do this for standard arrays since that can cause corruption issues </span>
<a name="l00930"></a>00930 <span class="comment">         * (extra unused curves)</span>
<a name="l00931"></a>00931 <span class="comment">         */</span>
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (array_index_max == array_index)
<a name="l00933"></a>00933             array_index_max++;
<a name="l00934"></a>00934     }
<a name="l00935"></a>00935     
<a name="l00936"></a>00936     <span class="comment">/* will only loop once unless the array index was -1 */</span>
<a name="l00937"></a>00937     <span class="keywordflow">for</span> (; array_index &lt; array_index_max; array_index++) {
<a name="l00938"></a>00938         <span class="comment">/* make sure the F-Curve exists </span>
<a name="l00939"></a>00939 <span class="comment">         *  - if we&#39;re replacing keyframes only, DO NOT create new F-Curves if they do not exist yet</span>
<a name="l00940"></a>00940 <span class="comment">         *    but still try to get the F-Curve if it exists...</span>
<a name="l00941"></a>00941 <span class="comment">         */</span>
<a name="l00942"></a>00942         fcu= <a class="code" href="../../db/d4b/keyframing_8c.html#a52eb6919edb749cd96baede51f9f1bc8">verify_fcurve</a>(act, group, rna_path, array_index, (flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea530096d4f2231f90cc15f77773e50562">INSERTKEY_REPLACE</a>)==0);
<a name="l00943"></a>00943         
<a name="l00944"></a>00944         <span class="comment">/* we may not have a F-Curve when we&#39;re replacing only... */</span>
<a name="l00945"></a>00945         <span class="keywordflow">if</span> (fcu) {
<a name="l00946"></a>00946             <span class="comment">/* set color mode if the F-Curve is new (i.e. without any keyframes) */</span>
<a name="l00947"></a>00947             <span class="keywordflow">if</span> ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> == 0) &amp;&amp; (flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a6707cbc2befc4b0c2908302c6146362ea82a151e237b00e9030e454ae93b0b5d2">INSERTKEY_XYZ2RGB</a>)) {
<a name="l00948"></a>00948                 <span class="comment">/* for Loc/Rot/Scale and also Color F-Curves, the color of the F-Curve in the Graph Editor,</span>
<a name="l00949"></a>00949 <span class="comment">                 * is determined by the array index for the F-Curve</span>
<a name="l00950"></a>00950 <span class="comment">                 */</span>
<a name="l00951"></a>00951                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a94fe4335845faafd0b969e89a13d8c76">ELEM5</a>(<a class="code" href="../../d3/d10/rna__access_8c.html#ac2188d2835e07f6dd15491f6764cae78">RNA_property_subtype</a>(prop), <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bcaae97c629470b1ebaf9aa8f213e1a3c7d">PROP_TRANSLATION</a>, <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bca106479cf1ee36b822fe22ac41dc63b25">PROP_XYZ</a>, <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bca74cb812d78d6529087feb6b751589c8d">PROP_EULER</a>, <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bca45b761f7a18f8b6316b4ca9d086304df">PROP_COLOR</a>, <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bca77df19269ed74fb2f60f7c3ad03c7f59">PROP_COORDS</a>)) {
<a name="l00952"></a>00952                     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3faf7e74a2917ab11502354a75bb5151">color_mode</a>= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a487b675d1b8ea6d6e9b8fd91f3a77f8aa3acd96f1f90e306d1c52cfcf08dad176">FCURVE_COLOR_AUTO_RGB</a>;
<a name="l00953"></a>00953                 }
<a name="l00954"></a>00954             }
<a name="l00955"></a>00955             
<a name="l00956"></a>00956             <span class="comment">/* insert keyframe */</span>
<a name="l00957"></a>00957             ret += <a class="code" href="../../db/d4b/keyframing_8c.html#a25ec9cccd9f3560210556afca64c74ac">insert_keyframe_direct</a>(reports, ptr, prop, fcu, cfra, flag);
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960     
<a name="l00961"></a>00961     <span class="keywordflow">return</span> ret;
<a name="l00962"></a>00962 }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="comment">/* ************************************************** */</span>
<a name="l00965"></a>00965 <span class="comment">/* KEYFRAME DELETION */</span>
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="comment">/* Main Keyframing API call:</span>
<a name="l00968"></a>00968 <span class="comment"> *  Use this when validation of necessary animation data isn&#39;t necessary as it</span>
<a name="l00969"></a>00969 <span class="comment"> *  already exists. It will delete a keyframe at the current frame.</span>
<a name="l00970"></a>00970 <span class="comment"> *  </span>
<a name="l00971"></a>00971 <span class="comment"> *  The flag argument is used for special settings that alter the behavior of</span>
<a name="l00972"></a>00972 <span class="comment"> *  the keyframe deletion. These include the quick refresh options.</span>
<a name="l00973"></a>00973 <span class="comment"> */</span>
<a name="l00974"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ac7990e54797908defaf7d4fb7d96fe97">00974</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ac7990e54797908defaf7d4fb7d96fe97">delete_keyframe</a> (<a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <span class="keyword">const</span> <span class="keywordtype">char</span> group[], <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a4703b9509fd2ed178b657f6ffff9d808">rna_path</a>[], <span class="keywordtype">int</span> <a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a0e8d1f6adcaba0fa1c7139ae0633e06d">array_index</a>, <span class="keywordtype">float</span> cfra, <span class="keywordtype">short</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(flag))
<a name="l00975"></a>00975 {
<a name="l00976"></a>00976     <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(<span class="keywordtype">id</span>);
<a name="l00977"></a>00977     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> id_ptr, ptr;
<a name="l00978"></a>00978     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l00979"></a>00979     <span class="keywordtype">int</span> array_index_max= array_index+1;
<a name="l00980"></a>00980     <span class="keywordtype">int</span> ret= 0;
<a name="l00981"></a>00981     
<a name="l00982"></a>00982     <span class="comment">/* sanity checks */</span>
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keywordtype">id</span>, adt)) {
<a name="l00984"></a>00984         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No ID-Block and/Or AnimData to delete keyframe from&quot;</span>);
<a name="l00985"></a>00985         <span class="keywordflow">return</span> 0;
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987     
<a name="l00988"></a>00988     <span class="comment">/* validate pointer first - exit if failure */</span>
<a name="l00989"></a>00989     <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(<span class="keywordtype">id</span>, &amp;id_ptr);
<a name="l00990"></a>00990     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d10/rna__access_8c.html#a003cb660a44918af456e10e005495f86">RNA_path_resolve</a>(&amp;id_ptr, rna_path, &amp;ptr, &amp;prop) == 0) || (prop == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00991"></a>00991         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Could not delete keyframe, as RNA Path is invalid for the given ID (ID = %s, Path = %s)&quot;</span>, id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, rna_path);
<a name="l00992"></a>00992         <span class="keywordflow">return</span> 0;
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994     
<a name="l00995"></a>00995     <span class="comment">/* get F-Curve</span>
<a name="l00996"></a>00996 <span class="comment">     * Note: here is one of the places where we don&#39;t want new Action + F-Curve added!</span>
<a name="l00997"></a>00997 <span class="comment">     *      so &#39;add&#39; var must be 0</span>
<a name="l00998"></a>00998 <span class="comment">     */</span>
<a name="l00999"></a>00999     <span class="keywordflow">if</span> (act == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01000"></a>01000         <span class="comment">/* if no action is provided, use the default one attached to this ID-block </span>
<a name="l01001"></a>01001 <span class="comment">         *  - if it doesn&#39;t exist, then we&#39;re out of options...</span>
<a name="l01002"></a>01002 <span class="comment">         */</span>
<a name="l01003"></a>01003         <span class="keywordflow">if</span> (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>) {
<a name="l01004"></a>01004             act= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>;
<a name="l01005"></a>01005             
<a name="l01006"></a>01006             <span class="comment">/* apply NLA-mapping to frame to use (if applicable) */</span>
<a name="l01007"></a>01007             cfra= <a class="code" href="../../d9/de6/BKE__nla_8h.html#ab4ae36c08ea78520b80d5d517ac20da4">BKE_nla_tweakedit_remap</a>(adt, cfra, <a class="code" href="../../d9/de6/BKE__nla_8h.html#abc5c98fcc1211af2b80116dd6e0a035dad6f4c7caaf2b3ab5e648419d521cfc9e">NLATIME_CONVERT_UNMAP</a>); 
<a name="l01008"></a>01008         }
<a name="l01009"></a>01009         <span class="keywordflow">else</span> {
<a name="l01010"></a>01010             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No Action to delete keyframes from for ID = %s\n&quot;</span>, id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l01011"></a>01011             <span class="keywordflow">return</span> 0;
<a name="l01012"></a>01012         }
<a name="l01013"></a>01013     }
<a name="l01014"></a>01014     
<a name="l01015"></a>01015     <span class="comment">/* key entire array convenience method */</span>
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (array_index == -1) { 
<a name="l01017"></a>01017         array_index= 0;
<a name="l01018"></a>01018         array_index_max= <a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(&amp;ptr, prop);
<a name="l01019"></a>01019         
<a name="l01020"></a>01020         <span class="comment">/* for single properties, increase max_index so that the property itself gets included,</span>
<a name="l01021"></a>01021 <span class="comment">         * but don&#39;t do this for standard arrays since that can cause corruption issues </span>
<a name="l01022"></a>01022 <span class="comment">         * (extra unused curves)</span>
<a name="l01023"></a>01023 <span class="comment">         */</span>
<a name="l01024"></a>01024         <span class="keywordflow">if</span> (array_index_max == array_index)
<a name="l01025"></a>01025             array_index_max++;
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027     
<a name="l01028"></a>01028     <span class="comment">/* will only loop once unless the array index was -1 */</span>
<a name="l01029"></a>01029     <span class="keywordflow">for</span> (; array_index &lt; array_index_max; array_index++) {
<a name="l01030"></a>01030         <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu= <a class="code" href="../../db/d4b/keyframing_8c.html#a52eb6919edb749cd96baede51f9f1bc8">verify_fcurve</a>(act, group, rna_path, array_index, 0);
<a name="l01031"></a>01031         <span class="keywordtype">short</span> found = -1;
<a name="l01032"></a>01032         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01033"></a>01033         
<a name="l01034"></a>01034         <span class="comment">/* check if F-Curve exists and/or whether it can be edited */</span>
<a name="l01035"></a>01035         <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01036"></a>01036             <span class="keywordflow">continue</span>;
<a name="l01037"></a>01037             
<a name="l01038"></a>01038         <span class="keywordflow">if</span> ( (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab581d30efbbb3a1a1f6f979d26d1cd25">FCURVE_PROTECTED</a>) || ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>) &amp;&amp; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>-&gt;<a class="code" href="../../d9/dcf/structbActionGroup.html#a5a04faf9cd6c23df183545e5842caf80">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a23623a6a10ec8ae24a77f37cf2093d1eac54dd221d44baca2d2ea17ee2c671f57">AGRP_PROTECTED</a>)) ) {
<a name="l01039"></a>01039             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01040"></a>01040                 printf(<span class="stringliteral">&quot;WARNING: not deleting keyframe for locked F-Curve\n&quot;</span>);
<a name="l01041"></a>01041             <span class="keywordflow">continue</span>;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043         
<a name="l01044"></a>01044         <span class="comment">/* try to find index of beztriple to get rid of */</span>
<a name="l01045"></a>01045         i = <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a57be9969692b1bd993d12fa9f2c39bf2">binarysearch_bezt_index</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, cfra, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>, &amp;found);
<a name="l01046"></a>01046         <span class="keywordflow">if</span> (found) {            
<a name="l01047"></a>01047             <span class="comment">/* delete the key at the index (will sanity check + do recalc afterwards) */</span>
<a name="l01048"></a>01048             <a class="code" href="../../db/d58/keyframes__general_8c.html#ab3323422d47da77c0a8bdae4f9dbc626">delete_fcurve_key</a>(fcu, i, 1);
<a name="l01049"></a>01049             
<a name="l01050"></a>01050             <span class="comment">/* Only delete curve too if it won&#39;t be doing anything anymore */</span>
<a name="l01051"></a>01051             <span class="keywordflow">if</span> ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> == 0) &amp;&amp; (<a class="code" href="../../da/dba/BKE__fcurve_8h.html#af507d5b05d44a294131417635cc297b9">list_has_suitable_fmodifier</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>, 0, <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>) == 0))
<a name="l01052"></a>01052                 <a class="code" href="../../d8/dc4/anim__channels__edit_8c.html#afff2ec35984d3c8db3161ea6a269851b">ANIM_fcurve_delete_from_animdata</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, fcu);
<a name="l01053"></a>01053             
<a name="l01054"></a>01054             <span class="comment">/* return success */</span>
<a name="l01055"></a>01055             ret++;
<a name="l01056"></a>01056         }
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058     
<a name="l01059"></a>01059     <span class="comment">/* return success/failure */</span>
<a name="l01060"></a>01060     <span class="keywordflow">return</span> ret;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 <span class="comment">/* ******************************************* */</span>
<a name="l01064"></a>01064 <span class="comment">/* KEYFRAME MODIFICATION */</span>
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 <span class="comment">/* mode for commonkey_modifykey */</span>
<a name="l01067"></a>01067 <span class="keyword">enum</span> {
<a name="l01068"></a><a class="code" href="../../db/d4b/keyframing_8c.html#aeb8e1c282570d629a6b603a94a4650d6a1a3c94df0a37b789bde6f3c147f4576a">01068</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#aeb8e1c282570d629a6b603a94a4650d6a1a3c94df0a37b789bde6f3c147f4576a">COMMONKEY_MODE_INSERT</a> = 0,
<a name="l01069"></a><a class="code" href="../../db/d4b/keyframing_8c.html#aeb8e1c282570d629a6b603a94a4650d6aa0c0f8d2bf5c694779b107c342c201e3">01069</a>     <a class="code" href="../../db/d4b/keyframing_8c.html#aeb8e1c282570d629a6b603a94a4650d6aa0c0f8d2bf5c694779b107c342c201e3">COMMONKEY_MODE_DELETE</a>,
<a name="l01070"></a>01070 } <span class="comment">/*eCommonModifyKey_Modes*/</span>;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072 <span class="comment">/* Polling callback for use with ANIM_*_keyframe() operators</span>
<a name="l01073"></a>01073 <span class="comment"> * This is based on the standard ED_operator_areaactive callback,</span>
<a name="l01074"></a>01074 <span class="comment"> * except that it does special checks for a few spacetypes too...</span>
<a name="l01075"></a>01075 <span class="comment"> */</span>
<a name="l01076"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">01076</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">modify_key_op_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa= <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l01079"></a>01079     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01080"></a>01080     <a class="code" href="../../d3/d88/structSpaceOops.html">SpaceOops</a> *so= <a class="code" href="../../df/d01/BKE__context_8h.html#a757b3be66ff99f2d3f92e0486c3eb381">CTX_wm_space_outliner</a>(C);
<a name="l01081"></a>01081     
<a name="l01082"></a>01082     <span class="comment">/* if no area or active scene */</span>
<a name="l01083"></a>01083     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sa, scene)) 
<a name="l01084"></a>01084         <span class="keywordflow">return</span> 0;
<a name="l01085"></a>01085     
<a name="l01086"></a>01086     <span class="comment">/* if Outliner, don&#39;t allow in some views */</span>
<a name="l01087"></a>01087     <span class="keywordflow">if</span> (so) {
<a name="l01088"></a>01088         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(so-&gt;<a class="code" href="../../d3/d88/structSpaceOops.html#a29f76b867f58ad3013a34ec8af0bdf48">outlinevis</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ab64bcf552275975cd1497fbde9fe7985">SO_GROUPS</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#af1eb98519f4668d1e45e4a1267c7b80a">SO_LIBRARIES</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a661dc004564c464344f780bf1217799c">SO_VERSE_SESSION</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a661dc004564c464344f780bf1217799c">SO_VERSE_SESSION</a>))
<a name="l01089"></a>01089             <span class="keywordflow">return</span> 0;
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(so-&gt;<a class="code" href="../../d3/d88/structSpaceOops.html#a29f76b867f58ad3013a34ec8af0bdf48">outlinevis</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a81ece48000f8460c5e8173d28459bfa7">SO_SEQUENCE</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a613e14201f0a7978e7a61861fcf66e6e">SO_USERDEF</a>, <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ae2f16b3fda0527c1972237e8e716b107">SO_KEYMAP</a>))
<a name="l01091"></a>01091             <span class="keywordflow">return</span> 0;
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093     
<a name="l01094"></a>01094     <span class="comment">/* TODO: checks for other space types can be added here */</span>
<a name="l01095"></a>01095     
<a name="l01096"></a>01096     <span class="comment">/* should be fine */</span>
<a name="l01097"></a>01097     <span class="keywordflow">return</span> 1;
<a name="l01098"></a>01098 }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100 <span class="comment">/* Insert Key Operator ------------------------ */</span>
<a name="l01101"></a>01101 
<a name="l01102"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a17722cc0ac0471c0b99908a343bdc7e2">01102</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a17722cc0ac0471c0b99908a343bdc7e2">insert_key_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01105"></a>01105     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01106"></a>01106     <a class="code" href="../../d4/d2c/structKeyingSet.html">KeyingSet</a> *ks= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01107"></a>01107     <span class="keywordtype">int</span> type= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l01108"></a>01108     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, don&#39;t bother about all the yucky offset crap</span>
<a name="l01109"></a>01109     <span class="keywordtype">short</span> success;
<a name="l01110"></a>01110     
<a name="l01111"></a>01111     <span class="comment">/* type is the Keying Set the user specified to use when calling the operator:</span>
<a name="l01112"></a>01112 <span class="comment">     *  - type == 0: use scene&#39;s active Keying Set</span>
<a name="l01113"></a>01113 <span class="comment">     *  - type &gt; 0: use a user-defined Keying Set from the active scene</span>
<a name="l01114"></a>01114 <span class="comment">     *  - type &lt; 0: use a builtin Keying Set</span>
<a name="l01115"></a>01115 <span class="comment">     */</span>
<a name="l01116"></a>01116     <span class="keywordflow">if</span> (type == 0) 
<a name="l01117"></a>01117         type= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a3aa00c4a174ddd0cde13173f05d7f960">active_keyingset</a>;
<a name="l01118"></a>01118     <span class="keywordflow">if</span> (type &gt; 0)
<a name="l01119"></a>01119         ks= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a61668a1aa7d493a6c770b8cd7a9c9e4e">keyingsets</a>, type-1);
<a name="l01120"></a>01120     <span class="keywordflow">else</span>
<a name="l01121"></a>01121         ks= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;<a class="code" href="../../db/dc3/anim__intern_8h.html#ac2c67291474afdb0e58dcee1efca54f4">builtin_keyingsets</a>, -type-1);
<a name="l01122"></a>01122         
<a name="l01123"></a>01123     <span class="comment">/* report failures */</span>
<a name="l01124"></a>01124     <span class="keywordflow">if</span> (ks == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01125"></a>01125         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active Keying Set&quot;</span>);
<a name="l01126"></a>01126         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128     
<a name="l01129"></a>01129     <span class="comment">/* try to insert keyframes for the channels specified by KeyingSet */</span>
<a name="l01130"></a>01130     success= <a class="code" href="../../de/d5c/keyingsets_8c.html#a01044547bfbc00a3377c900078313f51">ANIM_apply_keyingset</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ks, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a48e4988c2b608cebe42af2941d5e7d00abaf099b6ce7f582ab7790271f99a2614">MODIFYKEY_MODE_INSERT</a>, cfra);
<a name="l01131"></a>01131     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01132"></a>01132         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;KeyingSet &#39;%s&#39; - Successfully added %d Keyframes\n&quot;</span>, ks-&gt;<a class="code" href="../../d4/d2c/structKeyingSet.html#a25a8d7a6a01dc5b67be8d0351c36de23">name</a>, success);
<a name="l01133"></a>01133     
<a name="l01134"></a>01134     <span class="comment">/* report failure or do updates? */</span>
<a name="l01135"></a>01135     <span class="keywordflow">if</span> (success == <a class="code" href="../../da/df9/ED__keyframing_8h.html#aaea1dbb52df9d624958adbd3cb7b72b9aefaca929d54f1a662a5c67f462cc4fe4">MODIFYKEY_INVALID_CONTEXT</a>) {
<a name="l01136"></a>01136         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No suitable context info for active Keying Set&quot;</span>);
<a name="l01137"></a>01137         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (success) {
<a name="l01140"></a>01140         <span class="comment">/* if the appropriate properties have been set, make a note that we&#39;ve inserted something */</span>
<a name="l01141"></a>01141         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>))
<a name="l01142"></a>01142             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;Successfully added %d Keyframes for KeyingSet &#39;%s&#39;&quot;</span>, success, ks-&gt;<a class="code" href="../../d4/d2c/structKeyingSet.html#a25a8d7a6a01dc5b67be8d0351c36de23">name</a>);
<a name="l01143"></a>01143         
<a name="l01144"></a>01144         <span class="comment">/* send notifiers that keyframes have been changed */</span>
<a name="l01145"></a>01145         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a367b640edd611357ec6de8d1923d027e">NC_ANIMATION</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ad3ac9c1f16a6876edef02a4bc8287a61">ND_KEYFRAME</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147     <span class="keywordflow">else</span>
<a name="l01148"></a>01148         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Keying Set failed to insert any keyframes&quot;</span>);
<a name="l01149"></a>01149     
<a name="l01150"></a>01150     <span class="comment">/* send updates */</span>
<a name="l01151"></a>01151     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#ac7bea022d30913f94c94aff54e0fc186">DAG_ids_flush_update</a>(bmain, 0);
<a name="l01152"></a>01152     
<a name="l01153"></a>01153     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01156"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a3809822249b01c2f2ef9715ca7d90ae4">01156</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#a7b6fc85d116cc15374d67fa5ba2dc069">ANIM_OT_keyframe_insert</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01157"></a>01157 {
<a name="l01158"></a>01158     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01159"></a>01159     
<a name="l01160"></a>01160     <span class="comment">/* identifiers */</span>
<a name="l01161"></a>01161     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Insert Keyframe&quot;</span>;
<a name="l01162"></a>01162     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_insert&quot;</span>;
<a name="l01163"></a>01163     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Insert keyframes on the current frame for all properties in the specified Keying Set&quot;</span>;
<a name="l01164"></a>01164     
<a name="l01165"></a>01165     <span class="comment">/* callbacks */</span>
<a name="l01166"></a>01166     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a17722cc0ac0471c0b99908a343bdc7e2">insert_key_exec</a>; 
<a name="l01167"></a>01167     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">modify_key_op_poll</a>;
<a name="l01168"></a>01168     
<a name="l01169"></a>01169     <span class="comment">/* flags */</span>
<a name="l01170"></a>01170     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01171"></a>01171     
<a name="l01172"></a>01172     <span class="comment">/* keyingset to use (dynamic enum) */</span>
<a name="l01173"></a>01173     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#afebbe326102296030e3d563cc47b07c8">DummyRNA_DEFAULT_items</a>, 0, <span class="stringliteral">&quot;Keying Set&quot;</span>, <span class="stringliteral">&quot;The Keying Set to use&quot;</span>);
<a name="l01174"></a>01174     <a class="code" href="../../dc/d7e/rna__define_8c.html#adb30c6a3157cbd3193ff1a8de159389f">RNA_def_enum_funcs</a>(prop, <a class="code" href="../../de/d5c/keyingsets_8c.html#a700e1dd63fb1c271108944a812169a46">ANIM_keying_sets_enum_itemf</a>);
<a name="l01175"></a>01175     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01176"></a>01176     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = prop;
<a name="l01177"></a>01177     
<a name="l01178"></a>01178     <span class="comment">/* confirm whether a keyframe was added by showing a popup </span>
<a name="l01179"></a>01179 <span class="comment">     *  - by default, this is enabled, since this operator is assumed to be called independently</span>
<a name="l01180"></a>01180 <span class="comment">     */</span>
<a name="l01181"></a>01181     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>, 1, <span class="stringliteral">&quot;Confirm Successful Insert&quot;</span>,
<a name="l01182"></a>01182                           <span class="stringliteral">&quot;Show a popup when the keyframes get successfully added&quot;</span>);
<a name="l01183"></a>01183     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01184"></a>01184 }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 <span class="comment">/* Insert Key Operator (With Menu) ------------------------ */</span>
<a name="l01187"></a>01187 <span class="comment">/* This operator checks if a menu should be shown for choosing the KeyingSet to use, </span>
<a name="l01188"></a>01188 <span class="comment"> * then calls the menu if necessary before </span>
<a name="l01189"></a>01189 <span class="comment"> */</span>
<a name="l01190"></a>01190 
<a name="l01191"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a11bfb633cf24fc682d31df27a0cf683c">01191</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a11bfb633cf24fc682d31df27a0cf683c">insert_key_menu_invoke</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l01192"></a>01192 {
<a name="l01193"></a>01193     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01194"></a>01194     
<a name="l01195"></a>01195     <span class="comment">/* if prompting or no active Keying Set, show the menu */</span>
<a name="l01196"></a>01196     <span class="keywordflow">if</span> ((scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a3aa00c4a174ddd0cde13173f05d7f960">active_keyingset</a> == 0) || <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;always_prompt&quot;</span>)) {
<a name="l01197"></a>01197         <a class="code" href="../../d9/d4b/structuiPopupMenu.html">uiPopupMenu</a> *pup;
<a name="l01198"></a>01198         <a class="code" href="../../d4/d94/structuiLayout.html">uiLayout</a> *layout;
<a name="l01199"></a>01199         
<a name="l01200"></a>01200         <span class="comment">/* call the menu, which will call this operator again, hence the canceled */</span>
<a name="l01201"></a>01201         pup = <a class="code" href="../../d8/d1e/UI__interface_8h.html#a402c012d9cde0ff0f0808c25c4213d43">uiPupMenuBegin</a>(C, op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a>, ICON_NONE);
<a name="l01202"></a>01202         layout = <a class="code" href="../../d8/d1e/UI__interface_8h.html#a8c1b07b81987cdc2168a7417f9104cca">uiPupMenuLayout</a>(pup);
<a name="l01203"></a>01203         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a978da8810d3910b8b9057e80e1817de4">uiItemsEnumO</a>(layout, <span class="stringliteral">&quot;ANIM_OT_keyframe_insert_menu&quot;</span>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l01204"></a>01204         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a3ab0b4d9de253d473a16d4f329d8b50f">uiPupMenuEnd</a>(C, pup);
<a name="l01205"></a>01205         
<a name="l01206"></a>01206         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01207"></a>01207     }
<a name="l01208"></a>01208     <span class="keywordflow">else</span> {
<a name="l01209"></a>01209         <span class="comment">/* just call the exec() on the active keyingset */</span>
<a name="l01210"></a>01210         <a class="code" href="../../d3/d10/rna__access_8c.html#ad70d450cec9fe951de69b8c9128b8cc4">RNA_enum_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>, 0);
<a name="l01211"></a>01211         <a class="code" href="../../d3/d10/rna__access_8c.html#a1741c6fd78b5d828bb7b83517e2766db">RNA_boolean_set</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01212"></a>01212         
<a name="l01213"></a>01213         <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a>(C, op);
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215 }
<a name="l01216"></a>01216  
<a name="l01217"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a08d6d87a7f34f687eebb9bb56d678d08">01217</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#add49c0eef88b5e64ec20bc75cc0ab119">ANIM_OT_keyframe_insert_menu</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01218"></a>01218 {
<a name="l01219"></a>01219     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01220"></a>01220     
<a name="l01221"></a>01221     <span class="comment">/* identifiers */</span>
<a name="l01222"></a>01222     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Insert Keyframe Menu&quot;</span>;
<a name="l01223"></a>01223     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_insert_menu&quot;</span>;
<a name="l01224"></a>01224     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Insert Keyframes for specified Keying Set, with menu of available Keying Sets if undefined&quot;</span>;
<a name="l01225"></a>01225     
<a name="l01226"></a>01226     <span class="comment">/* callbacks */</span>
<a name="l01227"></a>01227     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a11bfb633cf24fc682d31df27a0cf683c">insert_key_menu_invoke</a>;
<a name="l01228"></a>01228     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a17722cc0ac0471c0b99908a343bdc7e2">insert_key_exec</a>; 
<a name="l01229"></a>01229     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#aa713266e21e982ecee61e7d2c43a3154">ED_operator_areaactive</a>;
<a name="l01230"></a>01230     
<a name="l01231"></a>01231     <span class="comment">/* flags */</span>
<a name="l01232"></a>01232     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01233"></a>01233     
<a name="l01234"></a>01234     <span class="comment">/* keyingset to use (dynamic enum) */</span>
<a name="l01235"></a>01235     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#afebbe326102296030e3d563cc47b07c8">DummyRNA_DEFAULT_items</a>, 0, <span class="stringliteral">&quot;Keying Set&quot;</span>, <span class="stringliteral">&quot;The Keying Set to use&quot;</span>);
<a name="l01236"></a>01236     <a class="code" href="../../dc/d7e/rna__define_8c.html#adb30c6a3157cbd3193ff1a8de159389f">RNA_def_enum_funcs</a>(prop, <a class="code" href="../../de/d5c/keyingsets_8c.html#a700e1dd63fb1c271108944a812169a46">ANIM_keying_sets_enum_itemf</a>);
<a name="l01237"></a>01237     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01238"></a>01238     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = prop;
<a name="l01239"></a>01239     
<a name="l01240"></a>01240     <span class="comment">/* confirm whether a keyframe was added by showing a popup </span>
<a name="l01241"></a>01241 <span class="comment">     *  - by default, this is disabled so that if a menu is shown, this doesn&#39;t come up too</span>
<a name="l01242"></a>01242 <span class="comment">     */</span>
<a name="l01243"></a>01243     <span class="comment">// XXX should this just be always on?</span>
<a name="l01244"></a>01244     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>, 0, <span class="stringliteral">&quot;Confirm Successful Insert&quot;</span>,
<a name="l01245"></a>01245                           <span class="stringliteral">&quot;Show a popup when the keyframes get successfully added&quot;</span>);
<a name="l01246"></a>01246     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01247"></a>01247     
<a name="l01248"></a>01248     <span class="comment">/* whether the menu should always be shown </span>
<a name="l01249"></a>01249 <span class="comment">     *  - by default, the menu should only be shown when there is no active Keying Set (2.5 behavior),</span>
<a name="l01250"></a>01250 <span class="comment">     *    although in some cases it might be useful to always shown (pre 2.5 behavior)</span>
<a name="l01251"></a>01251 <span class="comment">     */</span>
<a name="l01252"></a>01252     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;always_prompt&quot;</span>, 0, <span class="stringliteral">&quot;Always Show Menu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01253"></a>01253     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01254"></a>01254 }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256 <span class="comment">/* Delete Key Operator ------------------------ */</span>
<a name="l01257"></a>01257 
<a name="l01258"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a1b0fc7575ba6129c04afbb8f0610d43f">01258</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a1b0fc7575ba6129c04afbb8f0610d43f">delete_key_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01259"></a>01259 {
<a name="l01260"></a>01260     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01261"></a>01261     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01262"></a>01262     <a class="code" href="../../d4/d2c/structKeyingSet.html">KeyingSet</a> *ks= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;    
<a name="l01263"></a>01263     <span class="keywordtype">int</span> type= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l01264"></a>01264     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, don&#39;t bother about all the yucky offset crap</span>
<a name="l01265"></a>01265     <span class="keywordtype">short</span> success;
<a name="l01266"></a>01266     
<a name="l01267"></a>01267     <span class="comment">/* type is the Keying Set the user specified to use when calling the operator:</span>
<a name="l01268"></a>01268 <span class="comment">     *  - type == 0: use scene&#39;s active Keying Set</span>
<a name="l01269"></a>01269 <span class="comment">     *  - type &gt; 0: use a user-defined Keying Set from the active scene</span>
<a name="l01270"></a>01270 <span class="comment">     *  - type &lt; 0: use a builtin Keying Set</span>
<a name="l01271"></a>01271 <span class="comment">     */</span>
<a name="l01272"></a>01272     <span class="keywordflow">if</span> (type == 0) 
<a name="l01273"></a>01273         type= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a3aa00c4a174ddd0cde13173f05d7f960">active_keyingset</a>;
<a name="l01274"></a>01274     <span class="keywordflow">if</span> (type &gt; 0)
<a name="l01275"></a>01275         ks= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a61668a1aa7d493a6c770b8cd7a9c9e4e">keyingsets</a>, type-1);
<a name="l01276"></a>01276     <span class="keywordflow">else</span>
<a name="l01277"></a>01277         ks= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;<a class="code" href="../../db/dc3/anim__intern_8h.html#ac2c67291474afdb0e58dcee1efca54f4">builtin_keyingsets</a>, -type-1);
<a name="l01278"></a>01278     
<a name="l01279"></a>01279     <span class="comment">/* report failure */</span>
<a name="l01280"></a>01280     <span class="keywordflow">if</span> (ks == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01281"></a>01281         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No active Keying Set&quot;</span>);
<a name="l01282"></a>01282         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284     
<a name="l01285"></a>01285     <span class="comment">/* try to delete keyframes for the channels specified by KeyingSet */</span>
<a name="l01286"></a>01286     success= <a class="code" href="../../de/d5c/keyingsets_8c.html#a01044547bfbc00a3377c900078313f51">ANIM_apply_keyingset</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ks, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a48e4988c2b608cebe42af2941d5e7d00ae4badf40353b10bab565f38578f19ede">MODIFYKEY_MODE_DELETE</a>, cfra);
<a name="l01287"></a>01287     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01288"></a>01288         printf(<span class="stringliteral">&quot;KeyingSet &#39;%s&#39; - Successfully removed %d Keyframes\n&quot;</span>, ks-&gt;<a class="code" href="../../d4/d2c/structKeyingSet.html#a25a8d7a6a01dc5b67be8d0351c36de23">name</a>, success);
<a name="l01289"></a>01289     
<a name="l01290"></a>01290     <span class="comment">/* report failure or do updates? */</span>
<a name="l01291"></a>01291     <span class="keywordflow">if</span> (success == <a class="code" href="../../da/df9/ED__keyframing_8h.html#aaea1dbb52df9d624958adbd3cb7b72b9aefaca929d54f1a662a5c67f462cc4fe4">MODIFYKEY_INVALID_CONTEXT</a>) {
<a name="l01292"></a>01292         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;No suitable context info for active Keying Set&quot;</span>);
<a name="l01293"></a>01293         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (success) {
<a name="l01296"></a>01296         <span class="comment">/* if the appropriate properties have been set, make a note that we&#39;ve inserted something */</span>
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>))
<a name="l01298"></a>01298             <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;Successfully removed %d Keyframes for KeyingSet &#39;%s&#39;&quot;</span>, success, ks-&gt;<a class="code" href="../../d4/d2c/structKeyingSet.html#a25a8d7a6a01dc5b67be8d0351c36de23">name</a>);
<a name="l01299"></a>01299         
<a name="l01300"></a>01300         <span class="comment">/* send notifiers that keyframes have been changed */</span>
<a name="l01301"></a>01301         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a367b640edd611357ec6de8d1923d027e">NC_ANIMATION</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ad3ac9c1f16a6876edef02a4bc8287a61">ND_KEYFRAME</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303     <span class="keywordflow">else</span>
<a name="l01304"></a>01304         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Keying Set failed to remove any keyframes&quot;</span>);
<a name="l01305"></a>01305     
<a name="l01306"></a>01306     <span class="comment">/* send updates */</span>
<a name="l01307"></a>01307     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#ac7bea022d30913f94c94aff54e0fc186">DAG_ids_flush_update</a>(bmain, 0);
<a name="l01308"></a>01308     
<a name="l01309"></a>01309     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01310"></a>01310 }
<a name="l01311"></a>01311 
<a name="l01312"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a718dbe2ffd163fab87b6ad51acfecbb1">01312</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#adc82344e56f917d51a01d949bb59118b">ANIM_OT_keyframe_delete</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01313"></a>01313 {
<a name="l01314"></a>01314     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l01315"></a>01315     
<a name="l01316"></a>01316     <span class="comment">/* identifiers */</span>
<a name="l01317"></a>01317     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Delete Keying-Set Keyframe&quot;</span>;
<a name="l01318"></a>01318     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_delete&quot;</span>;
<a name="l01319"></a>01319     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Delete keyframes on the current frame for all properties in the specified Keying Set&quot;</span>;
<a name="l01320"></a>01320     
<a name="l01321"></a>01321     <span class="comment">/* callbacks */</span>
<a name="l01322"></a>01322     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a1b0fc7575ba6129c04afbb8f0610d43f">delete_key_exec</a>; 
<a name="l01323"></a>01323     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">modify_key_op_poll</a>;
<a name="l01324"></a>01324     
<a name="l01325"></a>01325     <span class="comment">/* flags */</span>
<a name="l01326"></a>01326     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01327"></a>01327     
<a name="l01328"></a>01328     <span class="comment">/* keyingset to use (dynamic enum) */</span>
<a name="l01329"></a>01329     prop= <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#afebbe326102296030e3d563cc47b07c8">DummyRNA_DEFAULT_items</a>, 0, <span class="stringliteral">&quot;Keying Set&quot;</span>, <span class="stringliteral">&quot;The Keying Set to use&quot;</span>);
<a name="l01330"></a>01330     <a class="code" href="../../dc/d7e/rna__define_8c.html#adb30c6a3157cbd3193ff1a8de159389f">RNA_def_enum_funcs</a>(prop, <a class="code" href="../../de/d5c/keyingsets_8c.html#a700e1dd63fb1c271108944a812169a46">ANIM_keying_sets_enum_itemf</a>);
<a name="l01331"></a>01331     <a class="code" href="../../dc/d7e/rna__define_8c.html#a97e75cad8daa0d94523c8df118947191">RNA_def_property_flag</a>(prop, <a class="code" href="../../de/d7e/RNA__types_8h.html#ae770cf51782953d602fb7ec23d3f2411ad872b0a5b183c05a4f6c6eaea6807334">PROP_HIDDEN</a>);
<a name="l01332"></a>01332     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = prop;
<a name="l01333"></a>01333     
<a name="l01334"></a>01334     <span class="comment">/* confirm whether a keyframe was added by showing a popup </span>
<a name="l01335"></a>01335 <span class="comment">     *  - by default, this is enabled, since this operator is assumed to be called independently</span>
<a name="l01336"></a>01336 <span class="comment">     */</span>
<a name="l01337"></a>01337     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;confirm_success&quot;</span>, 1, <span class="stringliteral">&quot;Confirm Successful Delete&quot;</span>,
<a name="l01338"></a>01338                     <span class="stringliteral">&quot;Show a popup when the keyframes get successfully removed&quot;</span>);
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 <span class="comment">/* Delete Key Operator ------------------------ */</span>
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 <span class="comment">/* XXX WARNING:</span>
<a name="l01344"></a>01344 <span class="comment"> * This is currently just a basic operator, which work in 3d-view context on objects only. </span>
<a name="l01345"></a>01345 <span class="comment"> * Should this be kept? It does have advantages over a version which requires selecting a keyingset to use...</span>
<a name="l01346"></a>01346 <span class="comment"> * -- Joshua Leung, Jan 2009</span>
<a name="l01347"></a>01347 <span class="comment"> */</span>
<a name="l01348"></a>01348  
<a name="l01349"></a><a class="code" href="../../db/d4b/keyframing_8c.html#afd8af5d03b9dfaf76f256fe2ed981c7d">01349</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#afd8af5d03b9dfaf76f256fe2ed981c7d">delete_key_v3d_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01350"></a>01350 {
<a name="l01351"></a>01351     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01352"></a>01352     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01353"></a>01353     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, don&#39;t bother about all the yucky offset crap</span>
<a name="l01354"></a>01354     
<a name="l01355"></a>01355     <span class="comment">// XXX more comprehensive tests will be needed</span>
<a name="l01356"></a>01356     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../de/de7/structObject.html">Object</a>*, ob, selected_objects) 
<a name="l01357"></a>01357     {
<a name="l01358"></a>01358         <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>= (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ob;
<a name="l01359"></a>01359         <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, *fcn;
<a name="l01360"></a>01360         <span class="keywordtype">short</span> success= 0;
<a name="l01361"></a>01361         
<a name="l01362"></a>01362         <span class="comment">/* loop through all curves in animdata and delete keys on this frame */</span>
<a name="l01363"></a>01363         <span class="keywordflow">if</span> ((ob-&gt;adt) &amp;&amp; (ob-&gt;adt-&gt;action)) {
<a name="l01364"></a>01364             <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= ob-&gt;adt;
<a name="l01365"></a>01365             <a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>;
<a name="l01366"></a>01366             
<a name="l01367"></a>01367             <span class="keywordflow">for</span> (fcu= act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcn) {
<a name="l01368"></a>01368                 fcn= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>;
<a name="l01369"></a>01369                 success+= <a class="code" href="../../db/d4b/keyframing_8c.html#ac7990e54797908defaf7d4fb7d96fe97">delete_keyframe</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <span class="keywordtype">id</span>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a>, cfra, 0);
<a name="l01370"></a>01370             }
<a name="l01371"></a>01371         }
<a name="l01372"></a>01372         
<a name="l01373"></a>01373         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a1c418509aad2eb64fd806b8a99d29f7d">RPT_INFO</a>, <span class="stringliteral">&quot;Ob &#39;%s&#39; - Successfully had %d keyframes removed&quot;</span>, id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, success);
<a name="l01374"></a>01374         
<a name="l01375"></a>01375         ob-&gt;recalc |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a189b3a96923b2425ee7c0990c0b3fd20">OB_RECALC_OB</a>;
<a name="l01376"></a>01376     }
<a name="l01377"></a>01377     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l01378"></a>01378     
<a name="l01379"></a>01379     <span class="comment">/* send updates */</span>
<a name="l01380"></a>01380     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#ac7bea022d30913f94c94aff54e0fc186">DAG_ids_flush_update</a>(bmain, 0);
<a name="l01381"></a>01381     
<a name="l01382"></a>01382     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ab2ab88214d816c47ebee1a985b0e68b3">ND_KEYS</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01383"></a>01383     
<a name="l01384"></a>01384     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01385"></a>01385 }
<a name="l01386"></a>01386 
<a name="l01387"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ae2b2e02e8c0d123551b924435a958a7c">01387</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#ad6be24de6bcd3620beadcf0b179c6f49">ANIM_OT_keyframe_delete_v3d</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01388"></a>01388 {
<a name="l01389"></a>01389     <span class="comment">/* identifiers */</span>
<a name="l01390"></a>01390     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Delete Keyframe&quot;</span>;
<a name="l01391"></a>01391     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Remove keyframes on current frame for selected object&quot;</span>;
<a name="l01392"></a>01392     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_delete_v3d&quot;</span>;
<a name="l01393"></a>01393     
<a name="l01394"></a>01394     <span class="comment">/* callbacks */</span>
<a name="l01395"></a>01395     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a63ac1372a9efaaca8bec8660ff770026">WM_operator_confirm</a>;
<a name="l01396"></a>01396     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#afd8af5d03b9dfaf76f256fe2ed981c7d">delete_key_v3d_exec</a>; 
<a name="l01397"></a>01397     
<a name="l01398"></a>01398     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#aa713266e21e982ecee61e7d2c43a3154">ED_operator_areaactive</a>;
<a name="l01399"></a>01399     
<a name="l01400"></a>01400     <span class="comment">/* flags */</span>
<a name="l01401"></a>01401     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01402"></a>01402 }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404 
<a name="l01405"></a>01405 <span class="comment">/* Insert Key Button Operator ------------------------ */</span>
<a name="l01406"></a>01406 
<a name="l01407"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a21627f95174ab241bdb52a11592e13b6">01407</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a21627f95174ab241bdb52a11592e13b6">insert_key_button_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01408"></a>01408 {
<a name="l01409"></a>01409     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01410"></a>01410     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01411"></a>01411     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l01412"></a>01412     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01413"></a>01413     <span class="keywordtype">char</span> *path;
<a name="l01414"></a>01414     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, don&#39;t bother about all the yucky offset crap</span>
<a name="l01415"></a>01415     <span class="keywordtype">short</span> success= 0;
<a name="l01416"></a>01416     <span class="keywordtype">int</span> a, index, <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>, all= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;all&quot;</span>);
<a name="l01417"></a>01417     <span class="keywordtype">short</span> flag = 0;
<a name="l01418"></a>01418     
<a name="l01419"></a>01419     <span class="comment">/* flags for inserting keyframes */</span>
<a name="l01420"></a>01420     flag = <a class="code" href="../../db/d4b/keyframing_8c.html#ae69d690ee9dc8d2947eed67672d3f295">ANIM_get_keyframing_flags</a>(scene, 1);
<a name="l01421"></a>01421     
<a name="l01422"></a>01422     <span class="comment">/* try to insert keyframe using property retrieved from UI */</span>
<a name="l01423"></a>01423     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a7ae2be7857ae4735f23feebea7471e56">uiContextActiveProperty</a>(C, &amp;ptr, &amp;prop, &amp;index);
<a name="l01424"></a>01424     
<a name="l01425"></a>01425     <span class="keywordflow">if</span> ((ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> &amp;&amp; ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> &amp;&amp; prop) &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a63b99969d7f69abd7809858a2687ae1c">RNA_property_animateable</a>(&amp;ptr, prop)) {
<a name="l01426"></a>01426         path= <a class="code" href="../../d3/d10/rna__access_8c.html#a66bdb30aeb21c0607ca3a0453e1d99eb">RNA_path_from_ID_to_property</a>(&amp;ptr, prop);
<a name="l01427"></a>01427         
<a name="l01428"></a>01428         <span class="keywordflow">if</span> (path) {
<a name="l01429"></a>01429             <span class="keywordflow">if</span> (all) {
<a name="l01430"></a>01430                 length= <a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(&amp;ptr, prop);
<a name="l01431"></a>01431                 
<a name="l01432"></a>01432                 <span class="keywordflow">if</span> (length) index= 0;
<a name="l01433"></a>01433                 <span class="keywordflow">else</span> length= 1;
<a name="l01434"></a>01434             }
<a name="l01435"></a>01435             <span class="keywordflow">else</span>
<a name="l01436"></a>01436                 length= 1;
<a name="l01437"></a>01437             
<a name="l01438"></a>01438             <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>; a++)
<a name="l01439"></a>01439                 success+= <a class="code" href="../../db/d4b/keyframing_8c.html#a7b16b21b2ffb9b0e3b5caf7c60cadc76">insert_keyframe</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, path, index+a, cfra, flag);
<a name="l01440"></a>01440             
<a name="l01441"></a>01441             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(path);
<a name="l01442"></a>01442         }
<a name="l01443"></a>01443         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#af756e7795471d4656788aae93617f074">RNA_NlaStrip</a>) {
<a name="l01444"></a>01444             <span class="comment">/* handle special vars for NLA-strips */</span>
<a name="l01445"></a>01445             <a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *strip= (<a class="code" href="../../d7/d95/structNlaStrip.html">NlaStrip</a> *)ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l01446"></a>01446             <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;strip-&gt;<a class="code" href="../../d7/d95/structNlaStrip.html#a58b04df157b3c8b38a99ef2ac6ba7948">fcurves</a>, <a class="code" href="../../d3/d10/rna__access_8c.html#ad6f3c9684a8786587872fc6baf17dfc9">RNA_property_identifier</a>(prop), flag);
<a name="l01447"></a>01447             
<a name="l01448"></a>01448             success+= <a class="code" href="../../db/d4b/keyframing_8c.html#a25ec9cccd9f3560210556afca64c74ac">insert_keyframe_direct</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, ptr, prop, fcu, cfra, 0);
<a name="l01449"></a>01449         }
<a name="l01450"></a>01450         <span class="keywordflow">else</span> {
<a name="l01451"></a>01451             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01452"></a>01452                 printf(<span class="stringliteral">&quot;Button Insert-Key: no path to property\n&quot;</span>);
<a name="l01453"></a>01453             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Failed to resolve path to property. Try using a Keying Set instead&quot;</span>);
<a name="l01454"></a>01454         }
<a name="l01455"></a>01455     }
<a name="l01456"></a>01456     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) {
<a name="l01457"></a>01457         printf(<span class="stringliteral">&quot;ptr.data = %p, prop = %p,&quot;</span>, (<span class="keywordtype">void</span> *)ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>, (<span class="keywordtype">void</span> *)prop);
<a name="l01458"></a>01458         <span class="keywordflow">if</span> (prop)
<a name="l01459"></a>01459             printf(<span class="stringliteral">&quot;animatable = %d\n&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#a63b99969d7f69abd7809858a2687ae1c">RNA_property_animateable</a>(&amp;ptr, prop));
<a name="l01460"></a>01460         <span class="keywordflow">else</span>
<a name="l01461"></a>01461             printf(<span class="stringliteral">&quot;animatable = NULL\n&quot;</span>);
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463     
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (success) {
<a name="l01465"></a>01465         <span class="comment">/* send updates */</span>
<a name="l01466"></a>01466         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a1e3f6b31f1acb59f917665305edc24e2">uiContextAnimUpdate</a>(C);
<a name="l01467"></a>01467         
<a name="l01468"></a>01468         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#ac7bea022d30913f94c94aff54e0fc186">DAG_ids_flush_update</a>(bmain, 0);
<a name="l01469"></a>01469         
<a name="l01470"></a>01470         <span class="comment">/* send notifiers that keyframes have been changed */</span>
<a name="l01471"></a>01471         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a367b640edd611357ec6de8d1923d027e">NC_ANIMATION</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ad3ac9c1f16a6876edef02a4bc8287a61">ND_KEYFRAME</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01472"></a>01472     }
<a name="l01473"></a>01473     
<a name="l01474"></a>01474     <span class="keywordflow">return</span> (success)? <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>: <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ab359d1cd46215be7c70fb24d622b850a">01477</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#a078208d8e45b9bb171c9f75bb85279e5">ANIM_OT_keyframe_insert_button</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479     <span class="comment">/* identifiers */</span>
<a name="l01480"></a>01480     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Insert Keyframe (Buttons)&quot;</span>;
<a name="l01481"></a>01481     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_insert_button&quot;</span>;
<a name="l01482"></a>01482     
<a name="l01483"></a>01483     <span class="comment">/* callbacks */</span>
<a name="l01484"></a>01484     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a21627f95174ab241bdb52a11592e13b6">insert_key_button_exec</a>; 
<a name="l01485"></a>01485     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">modify_key_op_poll</a>;
<a name="l01486"></a>01486     
<a name="l01487"></a>01487     <span class="comment">/* flags */</span>
<a name="l01488"></a>01488     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490     <span class="comment">/* properties */</span>
<a name="l01491"></a>01491     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;all&quot;</span>, 1, <span class="stringliteral">&quot;All&quot;</span>, <span class="stringliteral">&quot;Insert a keyframe for all element of the array&quot;</span>);
<a name="l01492"></a>01492 }
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 <span class="comment">/* Delete Key Button Operator ------------------------ */</span>
<a name="l01495"></a>01495 
<a name="l01496"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a4fd27cd45466c9aa85c524ad5309de03">01496</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a4fd27cd45466c9aa85c524ad5309de03">delete_key_button_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01497"></a>01497 {
<a name="l01498"></a>01498     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l01499"></a>01499     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01500"></a>01500     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr= {{<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}};
<a name="l01501"></a>01501     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01502"></a>01502     <span class="keywordtype">char</span> *path;
<a name="l01503"></a>01503     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, don&#39;t bother about all the yucky offset crap</span>
<a name="l01504"></a>01504     <span class="keywordtype">short</span> success= 0;
<a name="l01505"></a>01505     <span class="keywordtype">int</span> a, index, <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>, all= <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;all&quot;</span>);
<a name="l01506"></a>01506     
<a name="l01507"></a>01507     <span class="comment">/* try to insert keyframe using property retrieved from UI */</span>
<a name="l01508"></a>01508     <a class="code" href="../../d8/d1e/UI__interface_8h.html#a7ae2be7857ae4735f23feebea7471e56">uiContextActiveProperty</a>(C, &amp;ptr, &amp;prop, &amp;index);
<a name="l01509"></a>01509 
<a name="l01510"></a>01510     <span class="keywordflow">if</span> (ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> &amp;&amp; ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> &amp;&amp; prop) {
<a name="l01511"></a>01511         path= <a class="code" href="../../d3/d10/rna__access_8c.html#a66bdb30aeb21c0607ca3a0453e1d99eb">RNA_path_from_ID_to_property</a>(&amp;ptr, prop);
<a name="l01512"></a>01512         
<a name="l01513"></a>01513         <span class="keywordflow">if</span> (path) {
<a name="l01514"></a>01514             <span class="keywordflow">if</span> (all) {
<a name="l01515"></a>01515                 length= <a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(&amp;ptr, prop);
<a name="l01516"></a>01516                 
<a name="l01517"></a>01517                 <span class="keywordflow">if</span> (length) index= 0;
<a name="l01518"></a>01518                 <span class="keywordflow">else</span> length= 1;
<a name="l01519"></a>01519             }
<a name="l01520"></a>01520             <span class="keywordflow">else</span>
<a name="l01521"></a>01521                 length= 1;
<a name="l01522"></a>01522             
<a name="l01523"></a>01523             <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>; a++)
<a name="l01524"></a>01524                 success+= <a class="code" href="../../db/d4b/keyframing_8c.html#ac7990e54797908defaf7d4fb7d96fe97">delete_keyframe</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, path, index+a, cfra, 0);
<a name="l01525"></a>01525             
<a name="l01526"></a>01526             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(path);
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01529"></a>01529             printf(<span class="stringliteral">&quot;Button Delete-Key: no path to property\n&quot;</span>);
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) {
<a name="l01532"></a>01532         printf(<span class="stringliteral">&quot;ptr.data = %p, prop = %p\n&quot;</span>, (<span class="keywordtype">void</span> *)ptr.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>, (<span class="keywordtype">void</span> *)prop);
<a name="l01533"></a>01533     }
<a name="l01534"></a>01534     
<a name="l01535"></a>01535     
<a name="l01536"></a>01536     <span class="keywordflow">if</span> (success) {
<a name="l01537"></a>01537         <span class="comment">/* send updates */</span>
<a name="l01538"></a>01538         <a class="code" href="../../d8/d1e/UI__interface_8h.html#a1e3f6b31f1acb59f917665305edc24e2">uiContextAnimUpdate</a>(C);
<a name="l01539"></a>01539         
<a name="l01540"></a>01540         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#ac7bea022d30913f94c94aff54e0fc186">DAG_ids_flush_update</a>(bmain, 0);
<a name="l01541"></a>01541         
<a name="l01542"></a>01542         <span class="comment">/* send notifiers that keyframes have been changed */</span>
<a name="l01543"></a>01543         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a367b640edd611357ec6de8d1923d027e">NC_ANIMATION</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#ad3ac9c1f16a6876edef02a4bc8287a61">ND_KEYFRAME</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01544"></a>01544     }
<a name="l01545"></a>01545     
<a name="l01546"></a>01546     <span class="keywordflow">return</span> (success)? <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>: <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a><a class="code" href="../../db/d4b/keyframing_8c.html#af1b52e182c51f9148ed8f486b3224824">01549</a> <span class="keywordtype">void</span> <a class="code" href="../../db/dc3/anim__intern_8h.html#a06660f508ede375bb7f2148bceeac1fb">ANIM_OT_keyframe_delete_button</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01550"></a>01550 {
<a name="l01551"></a>01551     <span class="comment">/* identifiers */</span>
<a name="l01552"></a>01552     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Delete Keyframe (Buttons)&quot;</span>;
<a name="l01553"></a>01553     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;ANIM_OT_keyframe_delete_button&quot;</span>;
<a name="l01554"></a>01554     
<a name="l01555"></a>01555     <span class="comment">/* callbacks */</span>
<a name="l01556"></a>01556     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a4fd27cd45466c9aa85c524ad5309de03">delete_key_button_exec</a>; 
<a name="l01557"></a>01557     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../db/d4b/keyframing_8c.html#a324572c136b75863d072a9f144beddc4">modify_key_op_poll</a>;
<a name="l01558"></a>01558     
<a name="l01559"></a>01559     <span class="comment">/* flags */</span>
<a name="l01560"></a>01560     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="comment">/* properties */</span>
<a name="l01563"></a>01563     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;all&quot;</span>, 1, <span class="stringliteral">&quot;All&quot;</span>, <span class="stringliteral">&quot;Delete keyfames from all elements of the array&quot;</span>);
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566 <span class="comment">/* ******************************************* */</span>
<a name="l01567"></a>01567 <span class="comment">/* AUTO KEYFRAME */</span>
<a name="l01568"></a>01568 
<a name="l01569"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a9ad765bd06009d1ddbcd5a26daeaead9">01569</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#abae70599a7160c3c78c4e3347f5e0823">autokeyframe_cfra_can_key</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571     <span class="keywordtype">float</span> cfra= (float)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>; <span class="comment">// XXX for now, this will do</span>
<a name="l01572"></a>01572     
<a name="l01573"></a>01573     <span class="comment">/* only filter if auto-key mode requires this */</span>
<a name="l01574"></a>01574     <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#abccc93bdd6b764e5636de59e671d5112">IS_AUTOKEY_ON</a>(scene) == 0)
<a name="l01575"></a>01575         <span class="keywordflow">return</span> 0;
<a name="l01576"></a>01576         
<a name="l01577"></a>01577     <span class="keywordflow">if</span> (<a class="code" href="../../da/df9/ED__keyframing_8h.html#a40334789d14a6120769250de8198acc1">IS_AUTOKEY_MODE</a>(scene, NORMAL)) {
<a name="l01578"></a>01578         <span class="comment">/* can insert anytime we like... */</span>
<a name="l01579"></a>01579         <span class="keywordflow">return</span> 1;
<a name="l01580"></a>01580     }
<a name="l01581"></a>01581     <span class="keywordflow">else</span> <span class="comment">/* REPLACE */</span> {
<a name="l01582"></a>01582         <span class="comment">/* for whole block - only key if there&#39;s a keyframe on that frame already</span>
<a name="l01583"></a>01583 <span class="comment">         *  this is a valid assumption when we&#39;re blocking + tweaking</span>
<a name="l01584"></a>01584 <span class="comment">         */</span>
<a name="l01585"></a>01585         <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a>(<span class="keywordtype">id</span>, cfra, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a59cde8742d6436ab6868e5c6d02f2ca6">ANIMFILTER_KEYS_LOCAL</a>);
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587 }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <span class="comment">/* ******************************************* */</span>
<a name="l01590"></a>01590 <span class="comment">/* KEYFRAME DETECTION */</span>
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 <span class="comment">/* --------------- API/Per-Datablock Handling ------------------- */</span>
<a name="l01593"></a>01593 
<a name="l01594"></a>01594 <span class="comment">/* Checks if some F-Curve has a keyframe for a given frame */</span>
<a name="l01595"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a07904253c124e86770a6c80d587abe4f">01595</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#afe152676a9839e4993ad1eb112d29be1">fcurve_frame_has_keyframe</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> frame, <span class="keywordtype">short</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>)
<a name="l01596"></a>01596 {
<a name="l01597"></a>01597     <span class="comment">/* quick sanity check */</span>
<a name="l01598"></a>01598     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>))
<a name="l01599"></a>01599         <span class="keywordflow">return</span> 0;
<a name="l01600"></a>01600     
<a name="l01601"></a>01601     <span class="comment">/* we either include all regardless of muting, or only non-muted  */</span>
<a name="l01602"></a>01602     <span class="keywordflow">if</span> ((filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a539740f9d8f8679a2261c38e5efc13cd">ANIMFILTER_KEYS_MUTED</a>) || (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a28ead3f40ae6eaa9f6b27fd49caf0737">FCURVE_MUTED</a>)==0) {
<a name="l01603"></a>01603         <span class="keywordtype">short</span> replace = -1;
<a name="l01604"></a>01604         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a57be9969692b1bd993d12fa9f2c39bf2">binarysearch_bezt_index</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, frame, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>, &amp;replace);
<a name="l01605"></a>01605         
<a name="l01606"></a>01606         <span class="comment">/* binarysearch_bezt_index will set replace to be 0 or 1</span>
<a name="l01607"></a>01607 <span class="comment">         *  - obviously, 1 represents a match</span>
<a name="l01608"></a>01608 <span class="comment">         */</span>
<a name="l01609"></a>01609         <span class="keywordflow">if</span> (replace) {          
<a name="l01610"></a>01610             <span class="comment">/* sanity check: &#39;i&#39; may in rare cases exceed arraylen */</span>
<a name="l01611"></a>01611             <span class="keywordflow">if</span> ((i &gt;= 0) &amp;&amp; (i &lt; fcu-&gt;<a class="code" href="../../d9/d69/structtAnimCopybufItem.html#a7240a655e9059baf2961aaad6711145f">totvert</a>))
<a name="l01612"></a>01612                 <span class="keywordflow">return</span> 1;
<a name="l01613"></a>01613         }
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615     
<a name="l01616"></a>01616     <span class="keywordflow">return</span> 0;
<a name="l01617"></a>01617 }
<a name="l01618"></a>01618 
<a name="l01619"></a>01619 <span class="comment">/* Checks whether an Action has a keyframe for a given frame </span>
<a name="l01620"></a>01620 <span class="comment"> * Since we&#39;re only concerned whether a keyframe exists, we can simply loop until a match is found...</span>
<a name="l01621"></a>01621 <span class="comment"> */</span>
<a name="l01622"></a><a class="code" href="../../db/d4b/keyframing_8c.html#a0e225e4fd63fb3ec53c3c40b4507855c">01622</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a0e225e4fd63fb3ec53c3c40b4507855c">action_frame_has_keyframe</a> (<a class="code" href="../../d1/d48/structbAction.html">bAction</a> *act, <span class="keywordtype">float</span> frame, <span class="keywordtype">short</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>)
<a name="l01623"></a>01623 {
<a name="l01624"></a>01624     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l01625"></a>01625     
<a name="l01626"></a>01626     <span class="comment">/* can only find if there is data */</span>
<a name="l01627"></a>01627     <span class="keywordflow">if</span> (act == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01628"></a>01628         <span class="keywordflow">return</span> 0;
<a name="l01629"></a>01629         
<a name="l01630"></a>01630     <span class="comment">/* if only check non-muted, check if muted */</span>
<a name="l01631"></a>01631     <span class="keywordflow">if</span> ((filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a539740f9d8f8679a2261c38e5efc13cd">ANIMFILTER_KEYS_MUTED</a>) || (act-&gt;<a class="code" href="../../d1/d48/structbAction.html#ae61dc79aac883d6f6a8d84ae12a11352">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a429036fd64aa47ae5fe6565ccfb9c8daa6c60d4c1c07ff5124c20c1971609bb8a">ACT_MUTED</a>))
<a name="l01632"></a>01632         <span class="keywordflow">return</span> 0;
<a name="l01633"></a>01633     
<a name="l01634"></a>01634     <span class="comment">/* loop over F-Curves, using binary-search to try to find matches </span>
<a name="l01635"></a>01635 <span class="comment">     *  - this assumes that keyframes are only beztriples</span>
<a name="l01636"></a>01636 <span class="comment">     */</span>
<a name="l01637"></a>01637     <span class="keywordflow">for</span> (fcu= act-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l01638"></a>01638         <span class="comment">/* only check if there are keyframes (currently only of type BezTriple) */</span>
<a name="l01639"></a>01639         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a> &amp;&amp; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>) {
<a name="l01640"></a>01640             <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#afe152676a9839e4993ad1eb112d29be1">fcurve_frame_has_keyframe</a>(fcu, frame, filter))
<a name="l01641"></a>01641                 <span class="keywordflow">return</span> 1;
<a name="l01642"></a>01642         }
<a name="l01643"></a>01643     }
<a name="l01644"></a>01644     
<a name="l01645"></a>01645     <span class="comment">/* nothing found */</span>
<a name="l01646"></a>01646     <span class="keywordflow">return</span> 0;
<a name="l01647"></a>01647 }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649 <span class="comment">/* Checks whether an Object has a keyframe for a given frame */</span>
<a name="l01650"></a><a class="code" href="../../db/d4b/keyframing_8c.html#ad09002a4f979e87bf69321cff0bba9d0">01650</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ad09002a4f979e87bf69321cff0bba9d0">object_frame_has_keyframe</a> (<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> frame, <span class="keywordtype">short</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>)
<a name="l01651"></a>01651 {
<a name="l01652"></a>01652     <span class="comment">/* error checking */</span>
<a name="l01653"></a>01653     <span class="keywordflow">if</span> (ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01654"></a>01654         <span class="keywordflow">return</span> 0;
<a name="l01655"></a>01655     
<a name="l01656"></a>01656     <span class="comment">/* check own animation data - specifically, the action it contains */</span>
<a name="l01657"></a>01657     <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>)) {
<a name="l01658"></a>01658         <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#a0e225e4fd63fb3ec53c3c40b4507855c">action_frame_has_keyframe</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#ac096321d973976369c05cef4b2a9565b">adt</a>-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>, frame, filter))
<a name="l01659"></a>01659             <span class="keywordflow">return</span> 1;
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661     
<a name="l01662"></a>01662     <span class="comment">/* try shapekey keyframes (if available, and allowed by filter) */</span>
<a name="l01663"></a>01663     <span class="keywordflow">if</span> ( !(filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a59cde8742d6436ab6868e5c6d02f2ca6">ANIMFILTER_KEYS_LOCAL</a>) &amp;&amp; !(filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a46e11a85cdeb31739c8371ae719c169f">ANIMFILTER_KEYS_NOSKEY</a>) ) {
<a name="l01664"></a>01664         <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key= <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l01665"></a>01665         
<a name="l01666"></a>01666         <span class="comment">/* shapekeys can have keyframes (&#39;Relative Shape Keys&#39;) </span>
<a name="l01667"></a>01667 <span class="comment">         * or depend on time (old &#39;Absolute Shape Keys&#39;) </span>
<a name="l01668"></a>01668 <span class="comment">         */</span>
<a name="l01669"></a>01669          
<a name="l01670"></a>01670             <span class="comment">/* 1. test for relative (with keyframes) */</span>
<a name="l01671"></a>01671         <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)key, frame, filter))
<a name="l01672"></a>01672             <span class="keywordflow">return</span> 1;
<a name="l01673"></a>01673             
<a name="l01674"></a>01674             <span class="comment">/* 2. test for time */</span>
<a name="l01675"></a>01675         <span class="comment">// TODO... yet to be implemented (this feature may evolve before then anyway)</span>
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677     
<a name="l01678"></a>01678     <span class="comment">/* try materials */</span>
<a name="l01679"></a>01679     <span class="keywordflow">if</span> ( !(filter &amp; ANIMFILTER_KEYS_LOCAL) &amp;&amp; !(filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5acdda063b3047717913cfea8f09f1b4cf">ANIMFILTER_KEYS_NOMAT</a>) ) {
<a name="l01680"></a>01680         <span class="comment">/* if only active, then we can skip a lot of looping */</span>
<a name="l01681"></a>01681         <span class="keywordflow">if</span> (filter &amp; <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5ab74327c57046391f897b8c2eaf535420">ANIMFILTER_KEYS_ACTIVE</a>) {
<a name="l01682"></a>01682             <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(ob, (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a7f7913949235b61d1cd0b8f343d0cbfc">actcol</a> + 1));
<a name="l01683"></a>01683             
<a name="l01684"></a>01684             <span class="comment">/* we only retrieve the active material... */</span>
<a name="l01685"></a>01685             <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ma, frame, filter))
<a name="l01686"></a>01686                 <span class="keywordflow">return</span> 1;
<a name="l01687"></a>01687         }
<a name="l01688"></a>01688         <span class="keywordflow">else</span> {
<a name="l01689"></a>01689             <span class="keywordtype">int</span> a;
<a name="l01690"></a>01690             
<a name="l01691"></a>01691             <span class="comment">/* loop over materials */</span>
<a name="l01692"></a>01692             <span class="keywordflow">for</span> (a=0; a&lt;ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; a++) {
<a name="l01693"></a>01693                 <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(ob, a+1);
<a name="l01694"></a>01694                 
<a name="l01695"></a>01695                 <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ma, frame, filter))
<a name="l01696"></a>01696                     <span class="keywordflow">return</span> 1;
<a name="l01697"></a>01697             }
<a name="l01698"></a>01698         }
<a name="l01699"></a>01699     }
<a name="l01700"></a>01700     
<a name="l01701"></a>01701     <span class="comment">/* nothing found */</span>
<a name="l01702"></a>01702     <span class="keywordflow">return</span> 0;
<a name="l01703"></a>01703 }
<a name="l01704"></a>01704 
<a name="l01705"></a>01705 <span class="comment">/* --------------- API ------------------- */</span>
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 <span class="comment">/* Checks whether a keyframe exists for the given ID-block one the given frame */</span>
<a name="l01708"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#ac23180479b5b6208e9252f4e4ffc25c8">01708</a> <span class="keywordtype">short</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a> (<a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <span class="keywordtype">float</span> frame, <span class="keywordtype">short</span> <a class="code" href="../../dc/d53/implicit_8c.html#a5085563b3b926cbcce0bef0946da311e">filter</a>)
<a name="l01709"></a>01709 {
<a name="l01710"></a>01710     <span class="comment">/* sanity checks */</span>
<a name="l01711"></a>01711     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01712"></a>01712         <span class="keywordflow">return</span> 0;
<a name="l01713"></a>01713     
<a name="l01714"></a>01714     <span class="comment">/* perform special checks for &#39;macro&#39; types */</span>
<a name="l01715"></a>01715     <span class="keywordflow">switch</span> (<a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)) {
<a name="l01716"></a>01716         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a1f263dac7c79853c097b8ebde25cb0c1">ID_OB</a>: <span class="comment">/* object */</span>
<a name="l01717"></a>01717             <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ad09002a4f979e87bf69321cff0bba9d0">object_frame_has_keyframe</a>((<a class="code" href="../../de/de7/structObject.html">Object</a> *)<span class="keywordtype">id</span>, frame, filter);
<a name="l01718"></a>01718             <span class="keywordflow">break</span>;
<a name="l01719"></a>01719             
<a name="l01720"></a>01720         <span class="keywordflow">case</span> <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ac2b425dbd1f73ad1720fafad2626d974">ID_SCE</a>: <span class="comment">/* scene */</span>
<a name="l01721"></a>01721         <span class="comment">// XXX TODO... for now, just use &#39;normal&#39; behavior</span>
<a name="l01722"></a>01722         <span class="comment">//  break;</span>
<a name="l01723"></a>01723         
<a name="l01724"></a>01724         <span class="keywordflow">default</span>:    <span class="comment">/* &#39;normal type&#39; */</span>
<a name="l01725"></a>01725         {
<a name="l01726"></a>01726             <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(<span class="keywordtype">id</span>);
<a name="l01727"></a>01727             
<a name="l01728"></a>01728             <span class="comment">/* only check keyframes in active action */</span>
<a name="l01729"></a>01729             <span class="keywordflow">if</span> (adt)
<a name="l01730"></a>01730                 <span class="keywordflow">return</span> <a class="code" href="../../db/d4b/keyframing_8c.html#a0e225e4fd63fb3ec53c3c40b4507855c">action_frame_has_keyframe</a>(adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>, frame, filter);
<a name="l01731"></a>01731         }
<a name="l01732"></a>01732             <span class="keywordflow">break</span>;
<a name="l01733"></a>01733     }
<a name="l01734"></a>01734     
<a name="l01735"></a>01735     
<a name="l01736"></a>01736     <span class="comment">/* no keyframe found */</span>
<a name="l01737"></a>01737     <span class="keywordflow">return</span> 0;
<a name="l01738"></a>01738 }
<a name="l01739"></a>01739 
<a name="l01740"></a>01740 <span class="comment">/* ************************************************** */</span>
<a name="l01741"></a>01741 
<a name="l01742"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a1394a5fe96c5ae3b6e32f5213d742703">01742</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#ad2cfc295ebb83b042cdb2a81296cbc3c">ED_autokeyframe_object</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d4/d2c/structKeyingSet.html">KeyingSet</a> *ks)
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744     <span class="comment">/* auto keyframing */</span>
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#abae70599a7160c3c78c4e3347f5e0823">autokeyframe_cfra_can_key</a>(scene, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>)) {
<a name="l01746"></a>01746         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> dsources = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         <span class="comment">/* now insert the keyframe(s) using the Keying Set</span>
<a name="l01749"></a>01749 <span class="comment">         *  1) add datasource override for the Object</span>
<a name="l01750"></a>01750 <span class="comment">         *  2) insert keyframes</span>
<a name="l01751"></a>01751 <span class="comment">         *  3) free the extra info</span>
<a name="l01752"></a>01752 <span class="comment">         */</span>
<a name="l01753"></a>01753         <a class="code" href="../../de/d5c/keyingsets_8c.html#ac72463d63d3c2f063cb82346bf2e387c">ANIM_relative_keyingset_add_source</a>(&amp;dsources, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01754"></a>01754         <a class="code" href="../../de/d5c/keyingsets_8c.html#a01044547bfbc00a3377c900078313f51">ANIM_apply_keyingset</a>(C, &amp;dsources, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ks, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a48e4988c2b608cebe42af2941d5e7d00abaf099b6ce7f582ab7790271f99a2614">MODIFYKEY_MODE_INSERT</a>, (<span class="keywordtype">float</span>)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l01755"></a>01755         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;dsources);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01758"></a>01758     }
<a name="l01759"></a>01759     <span class="keywordflow">else</span> {
<a name="l01760"></a>01760         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01761"></a>01761     }
<a name="l01762"></a>01762 }
<a name="l01763"></a>01763 
<a name="l01764"></a><a class="code" href="../../da/df9/ED__keyframing_8h.html#a5aa4b2ad810c1de470c8016d8254b60c">01764</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d4b/keyframing_8c.html#aefe516641c6fed5d5594948b39e51238">ED_autokeyframe_pchan</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <a class="code" href="../../d4/d2c/structKeyingSet.html">KeyingSet</a> *ks)
<a name="l01765"></a>01765 {
<a name="l01766"></a>01766     <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#abae70599a7160c3c78c4e3347f5e0823">autokeyframe_cfra_can_key</a>(scene, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>)) {
<a name="l01767"></a>01767         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> dsources = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01768"></a>01768 
<a name="l01769"></a>01769         <span class="comment">/* now insert the keyframe(s) using the Keying Set</span>
<a name="l01770"></a>01770 <span class="comment">         *  1) add datasource override for the PoseChannel</span>
<a name="l01771"></a>01771 <span class="comment">         *  2) insert keyframes</span>
<a name="l01772"></a>01772 <span class="comment">         *  3) free the extra info</span>
<a name="l01773"></a>01773 <span class="comment">         */</span>
<a name="l01774"></a>01774         <a class="code" href="../../de/d5c/keyingsets_8c.html#ac72463d63d3c2f063cb82346bf2e387c">ANIM_relative_keyingset_add_source</a>(&amp;dsources, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aa57827e223e108b43db078059b848997">RNA_PoseBone</a>, pchan);
<a name="l01775"></a>01775         <a class="code" href="../../de/d5c/keyingsets_8c.html#a01044547bfbc00a3377c900078313f51">ANIM_apply_keyingset</a>(C, &amp;dsources, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ks, <a class="code" href="../../da/df9/ED__keyframing_8h.html#a48e4988c2b608cebe42af2941d5e7d00abaf099b6ce7f582ab7790271f99a2614">MODIFYKEY_MODE_INSERT</a>, (<span class="keywordtype">float</span>)<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l01776"></a>01776         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;dsources);
<a name="l01777"></a>01777 
<a name="l01778"></a>01778         <span class="comment">/* clear any unkeyed tags */</span>
<a name="l01779"></a>01779         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>) {
<a name="l01780"></a>01780             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp;= ~<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1cffb8d9b288e7798d0c533ba94a695">BONE_UNKEYED</a>;
<a name="l01781"></a>01781         }
<a name="l01782"></a>01782 
<a name="l01783"></a>01783         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01784"></a>01784     }
<a name="l01785"></a>01785     <span class="keywordflow">else</span> {
<a name="l01786"></a>01786         <span class="comment">/* add unkeyed tags */</span>
<a name="l01787"></a>01787         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>) {
<a name="l01788"></a>01788             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> |= <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1cffb8d9b288e7798d0c533ba94a695">BONE_UNKEYED</a>;
<a name="l01789"></a>01789         }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01792"></a>01792     }
<a name="l01793"></a>01793 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:27 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
