<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: render_texture.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">render_texture.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/d0d/render__texture_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): 2004-2006, Blender Foundation, full recode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d94/DNA__image__types_8h.html">DNA_image_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d27/DNA__node__types_8h.html">DNA_node_types.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dc1/BKE__plugin__types_8h.html">BKE_plugin_types.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d48/BKE__ipo_8h.html">BKE_ipo.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3f/envmap_8h.html">envmap.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/def/pointdensity_8h.html">pointdensity.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd0/voxeldata_8h.html">voxeldata.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d9e/texture__ocean_8h.html">texture_ocean.h</a>&quot;</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span> <span class="comment">/* needed for UV */</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00087"></a>00087 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00088"></a>00088 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00089"></a>00089 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00090"></a>00090 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a3cd5bd97ae79bf04afd704781e38c30b">00095</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a3cd5bd97ae79bf04afd704781e38c30b">init_render_texture</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097     <span class="keywordtype">int</span> <a class="code" href="../../d6/d7a/structRender.html#ad47f692066e77730b9e6300a9fc3b5ca">cfra</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l00098"></a>00098     
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (re) cfra= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l00100"></a>00100     
<a name="l00101"></a>00101     <span class="comment">/* imap test */</span>
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>)) {
<a name="l00103"></a>00103         <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>, cfra, re?re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#ac5d87dca9364a3ab7392124c18d7d434">R_SEC_FIELD</a>:0);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab99dfbf8e7952fd8f8f0f6466c798545">TEX_PLUGIN</a>) {
<a name="l00107"></a>00107         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a215592459592ac15cc9c97c765f5e48c">plugin</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a215592459592ac15cc9c97c765f5e48c">plugin</a>-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>) {
<a name="l00108"></a>00108             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a215592459592ac15cc9c97c765f5e48c">plugin</a>-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a879d33c641dc3013836ae3ef50424944">cfra</a>) {
<a name="l00109"></a>00109                 *(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a215592459592ac15cc9c97c765f5e48c">plugin</a>-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a879d33c641dc3013836ae3ef50424944">cfra</a>)= (<span class="keywordtype">float</span>)<a class="code" href="../../d6/d7a/structRender.html#ad47f692066e77730b9e6300a9fc3b5ca">cfra</a>; <span class="comment">//BKE_curframe(re-&gt;scene); // XXX old animsys - timing stuff to be fixed </span>
<a name="l00110"></a>00110             }
<a name="l00111"></a>00111         }
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a268a78c388efb693b879d6d21d3f60c7">TEX_ENVMAP</a>) {
<a name="l00114"></a>00114         <span class="comment">/* just in case */</span>
<a name="l00115"></a>00115         tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> |= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee709515cccf026654a5e18043c9522c">TEX_INTERPOL</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae80ae7a29d1acb12a94fa45c6eb3003f">TEX_MIPMAP</a>;
<a name="l00116"></a>00116         tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae216dc5ade0b0babd139ea7ef16f6e19">TEX_CLIP</a>;
<a name="l00117"></a>00117         
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>) {
<a name="l00119"></a>00119             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af7153b716c4378b1fa073540f7d6350d">ENV_PLANE</a>)
<a name="l00120"></a>00120                 tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a22aa960392e66d15c9c07a14af8e06cd">TEX_EXTEND</a>;
<a name="l00121"></a>00121             
<a name="l00122"></a>00122             <span class="comment">/* only free envmap when rendermode was set to render envmaps, for previewrender */</span>
<a name="l00123"></a>00123             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering &amp;&amp; re) {
<a name="l00124"></a>00124                 <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af38446c2dfb68ef620bd015cd68aebd2">R_ENVMAP</a>)
<a name="l00125"></a>00125                     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#aba1cb887824b438b9754bd605877cdf4">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abbcd1fb828f165d721ea63af038e0c4c">ENV_ANIM</a>)
<a name="l00126"></a>00126                         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>);
<a name="l00127"></a>00127             }
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130     
<a name="l00131"></a>00131     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a>) {
<a name="l00132"></a>00132         <a class="code" href="../../d4/d91/BKE__node_8h.html#a9e14a324036d8f90c3f9f09cf35c56f0">ntreeTexBeginExecTree</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>, 1); <span class="comment">/* has internal flag to detect it only does it once */</span>
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a7e81c2330dc3b0edad1d51f3df5a1365">00138</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#a7e81c2330dc3b0edad1d51f3df5a1365">init_render_textures</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     tex= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00143"></a>00143     <span class="keywordflow">while</span> (tex) {
<a name="l00144"></a>00144         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>) <a class="code" href="../../db/d0d/render__texture_8c.html#a3cd5bd97ae79bf04afd704781e38c30b">init_render_texture</a>(re, tex);
<a name="l00145"></a>00145         tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00146"></a>00146     }
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ae6b6d4e564396f0bc48ac3ab8af24775">00149</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ae6b6d4e564396f0bc48ac3ab8af24775">end_render_texture</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex)
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (tex &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>-&gt;<a class="code" href="../../d9/da9/structbNodeTree.html#ae9db87987b712dfeae144221d0e225d4">execdata</a>)
<a name="l00152"></a>00152         <a class="code" href="../../d4/d91/BKE__node_8h.html#a724a94a118bf6c8c74e2e06464652211">ntreeTexEndExecTree</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>-&gt;<a class="code" href="../../d9/da9/structbNodeTree.html#ae9db87987b712dfeae144221d0e225d4">execdata</a>, 1);
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ae701010fc53f6c8667857175f4f30563">00155</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#ae701010fc53f6c8667857175f4f30563">end_render_textures</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00158"></a>00158     <span class="keywordflow">for</span> (tex= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tex; tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00159"></a>00159         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>)
<a name="l00160"></a>00160             <a class="code" href="../../db/d0d/render__texture_8c.html#ae6b6d4e564396f0bc48ac3ab8af24775">end_render_texture</a>(tex);
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="comment">/* this allows colorbanded textures to control normals as well */</span>
<a name="l00167"></a><a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">00167</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00168"></a>00168 {
<a name="l00169"></a>00169     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a27ca5c0471d318e9195d90305cd52011">TEX_COLORBAND</a>) {
<a name="l00170"></a>00170         <span class="keywordtype">float</span> col[4];
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8a9db83c0f33abeb5ff2bf434abeac9e">coba</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, col)) {
<a name="l00172"></a>00172             <span class="keywordtype">float</span> fac0, fac1, fac2, fac3;
<a name="l00173"></a>00173             
<a name="l00174"></a>00174             fac0= (col[0]+col[1]+col[2]);
<a name="l00175"></a>00175             <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8a9db83c0f33abeb5ff2bf434abeac9e">coba</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0], col);
<a name="l00176"></a>00176             fac1= (col[0]+col[1]+col[2]);
<a name="l00177"></a>00177             <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8a9db83c0f33abeb5ff2bf434abeac9e">coba</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1], col);
<a name="l00178"></a>00178             fac2= (col[0]+col[1]+col[2]);
<a name="l00179"></a>00179             <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8a9db83c0f33abeb5ff2bf434abeac9e">coba</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2], col);
<a name="l00180"></a>00180             fac3= (col[0]+col[1]+col[2]);
<a name="l00181"></a>00181             
<a name="l00182"></a>00182             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= 0.3333f*(fac0 - fac1);
<a name="l00183"></a>00183             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= 0.3333f*(fac0 - fac2);
<a name="l00184"></a>00184             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]= 0.3333f*(fac0 - fac3);
<a name="l00185"></a>00185             
<a name="l00186"></a>00186             <span class="keywordflow">return</span>;
<a name="l00187"></a>00187         }
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l00190"></a>00190     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l00191"></a>00191     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> - texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">00196</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <span class="keywordtype">float</span> x, y, t;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aff2fd2bbbbd223750b6d0b337f72a096">TEX_FLIPBLEND</a>) {
<a name="l00201"></a>00201         x= texvec[1];
<a name="l00202"></a>00202         y= texvec[0];
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204     <span class="keywordflow">else</span> {
<a name="l00205"></a>00205         x= texvec[0];
<a name="l00206"></a>00206         y= texvec[1];
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a33566d922dd0233dc5e9963c54a73acd">TEX_LIN</a>) {  <span class="comment">/* lin */</span>
<a name="l00210"></a>00210         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (1.0f+x)/2.0f;
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ad6dbe20fe3c32e7616c6b4264ec6b431">TEX_QUAD</a>) {    <span class="comment">/* quad */</span>
<a name="l00213"></a>00213         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (1.0f+x)/2.0f;
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>&lt;0.0f) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0f;
<a name="l00215"></a>00215         <span class="keywordflow">else</span> texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aba1e2b23086b8ee583b22c89bc556ee7">TEX_EASE</a>) {    <span class="comment">/* ease */</span>
<a name="l00218"></a>00218         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (1.0f+x)/2.0f;
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>&lt;=0.0f) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0f;
<a name="l00220"></a>00220         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>&gt;=1.0f) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f;
<a name="l00221"></a>00221         <span class="keywordflow">else</span> {
<a name="l00222"></a>00222             t= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l00223"></a>00223             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (3.0f*t-2.0f*t*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>);
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac43d903a1fb366ef81f34b94128de8ea">TEX_DIAG</a>) { <span class="comment">/* diag */</span>
<a name="l00227"></a>00227         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (2.0f+x+y)/4.0f;
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a022044e666607a4dd739e86e8b5c26d2">TEX_RAD</a>) { <span class="comment">/* radial */</span>
<a name="l00230"></a>00230         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(y,x) / (2*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) + 0.5);
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     <span class="keywordflow">else</span> {  <span class="comment">/* sphere TEX_SPHERE */</span>
<a name="l00233"></a>00233         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0-<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(x*x+  y*y+texvec[2]*texvec[2]);
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>&lt;0.0f) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0f;
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aad16283784f67a8b1ddfbd9802cd5088">TEX_HALO</a>) texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;  <span class="comment">/* halo */</span>
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00244"></a>00244 <span class="comment">/* ************************************************************************* */</span>
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 <span class="comment">/* newnoise: all noisebased types now have different noisebases to choose from */</span>
<a name="l00247"></a>00247 
<a name="l00248"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a9c8087f4daa3abf9552797c1a8c2a128">00248</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a9c8087f4daa3abf9552797c1a8c2a128">clouds</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00251"></a>00251     
<a name="l00252"></a>00252     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00255"></a>00255         <span class="comment">// calculate bumpnormal</span>
<a name="l00256"></a>00256         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>,  (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00257"></a>00257         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>,  (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00258"></a>00258         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1], texvec[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>,  (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00259"></a>00259         
<a name="l00260"></a>00260         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00261"></a>00261         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a1e3d1091fc483ec64b5f93000b2ec535">TEX_COLOR</a>) {
<a name="l00265"></a>00265         <span class="comment">// in this case, int. value should really be computed from color,</span>
<a name="l00266"></a>00266         <span class="comment">// and bumpnormal from that, would be too slow, looks ok as is</span>
<a name="l00267"></a>00267         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l00268"></a>00268         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[1], texvec[0], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00269"></a>00269         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[1], texvec[2], texvec[0], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00270"></a>00270         <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l00271"></a>00271         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 1.0;
<a name="l00272"></a>00272         <span class="keywordflow">return</span> (rv | <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>);
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordflow">return</span> rv;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="comment">/* creates a sine wave */</span>
<a name="l00282"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a036ed6d27237dab14226a831a91f73be">00282</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a036ed6d27237dab14226a831a91f73be">tex_sin</a>(<span class="keywordtype">float</span> a)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284     a = 0.5 + 0.5*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(a);
<a name="l00285"></a>00285         
<a name="l00286"></a>00286     <span class="keywordflow">return</span> a;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">/* creates a saw wave */</span>
<a name="l00290"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a37318f90b073397ed68b6a87ac1b8cee">00290</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a37318f90b073397ed68b6a87ac1b8cee">tex_saw</a>(<span class="keywordtype">float</span> a)
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292     <span class="keyword">const</span> <span class="keywordtype">float</span> b = 2*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00293"></a>00293     
<a name="l00294"></a>00294     <span class="keywordtype">int</span> n = (int)(a / b);
<a name="l00295"></a>00295     a -= n*b;
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (a &lt; 0) a += b;
<a name="l00297"></a>00297     <span class="keywordflow">return</span> a / b;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="comment">/* creates a triangle wave */</span>
<a name="l00301"></a><a class="code" href="../../db/d0d/render__texture_8c.html#afac9fbfaeaa5898132e84480fcccc146">00301</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#afac9fbfaeaa5898132e84480fcccc146">tex_tri</a>(<span class="keywordtype">float</span> a)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303     <span class="keyword">const</span> <span class="keywordtype">float</span> b = 2*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00304"></a>00304     <span class="keyword">const</span> <span class="keywordtype">float</span> rmax = 1.0;
<a name="l00305"></a>00305     
<a name="l00306"></a>00306     a = rmax - 2.0f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>((a*(1.0f/b))+0.5f) - (a*(1.0f/b)));
<a name="l00307"></a>00307     
<a name="l00308"></a>00308     <span class="keywordflow">return</span> a;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="comment">/* computes basic wood intensity value at x,y,z */</span>
<a name="l00312"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">00312</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">wood_int</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <span class="keywordtype">float</span> wi=0;                     
<a name="l00315"></a>00315     <span class="keywordtype">short</span> wf = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>;    <span class="comment">/* wave form:   TEX_SIN=0,  TEX_SAW=1,  TEX_TRI=2                        */</span>
<a name="l00316"></a>00316     <span class="keywordtype">short</span> wt = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>;          <span class="comment">/* wood type:   TEX_BAND=0, TEX_RING=1, TEX_BANDNOISE=2, TEX_RINGNOISE=3 */</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     float (*waveform[3])(float);    <span class="comment">/* create array of pointers to waveform functions */</span>
<a name="l00319"></a>00319     waveform[0] = <a class="code" href="../../db/d0d/render__texture_8c.html#a036ed6d27237dab14226a831a91f73be">tex_sin</a>;          <span class="comment">/* assign address of tex_sin() function to pointer array */</span>
<a name="l00320"></a>00320     waveform[1] = <a class="code" href="../../db/d0d/render__texture_8c.html#a37318f90b073397ed68b6a87ac1b8cee">tex_saw</a>;
<a name="l00321"></a>00321     waveform[2] = <a class="code" href="../../db/d0d/render__texture_8c.html#afac9fbfaeaa5898132e84480fcccc146">tex_tri</a>;
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     <span class="keywordflow">if</span> ((wf&gt;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a30048dc1da6e63185b1ba44c1b42d80f">TEX_TRI</a>) || (wf&lt;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adce572a18915c6394a3e91142ed8ee9c">TEX_SIN</a>)) wf=0; <span class="comment">/* check to be sure noisebasis2 is initialized ahead of time */</span>
<a name="l00324"></a>00324         
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (wt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a6e746b408f4f64200c5179953f6b3e60">TEX_BAND</a>) {
<a name="l00326"></a>00326         wi = waveform[wf]((x + y + z)*10.0f);
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9146f2eff11f318c822925a2ed8e9609">TEX_RING</a>) {
<a name="l00329"></a>00329         wi = waveform[wf](<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(x*x + y*y + z*z)*20.0f);
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab0080982c8c2d4adf5abe6f5ce9b1b39">TEX_BANDNOISE</a>) {
<a name="l00332"></a>00332         wi = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ae3baa785e689a228223b989c9c51ed85">turbul</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, x, y, z, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00333"></a>00333         wi = waveform[wf]((x + y + z)*10.0f + wi);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5c86fbc4b5096a236890989452b06dbc">TEX_RINGNOISE</a>) {
<a name="l00336"></a>00336         wi = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ae3baa785e689a228223b989c9c51ed85">turbul</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, x, y, z, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00337"></a>00337         wi = waveform[wf](<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(x*x + y*y + z*z)*20.0f + wi);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339     
<a name="l00340"></a>00340     <span class="keywordflow">return</span> wi;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a168e81c63776465b82d6b8388c6eeb1c">00343</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a168e81c63776465b82d6b8388c6eeb1c">wood</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="keywordtype">int</span> rv=<a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = <a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">wood_int</a>(tex, texvec[0], texvec[1], texvec[2]);
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00349"></a>00349         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00350"></a>00350         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = <a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">wood_int</a>(tex, texvec[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[1], texvec[2]);
<a name="l00351"></a>00351         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = <a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">wood_int</a>(tex, texvec[0], texvec[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[2]);
<a name="l00352"></a>00352         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = <a class="code" href="../../db/d0d/render__texture_8c.html#a49ac7c375203e1a42500e558a7aff2d8">wood_int</a>(tex, texvec[0], texvec[1], texvec[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>);
<a name="l00353"></a>00353         
<a name="l00354"></a>00354         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00355"></a>00355         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">return</span> rv;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="comment">/* computes basic marble intensity at x,y,z */</span>
<a name="l00364"></a><a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">00364</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">marble_int</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="keywordtype">float</span> n, mi;
<a name="l00367"></a>00367     <span class="keywordtype">short</span> wf = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>;    <span class="comment">/* wave form:   TEX_SIN=0,  TEX_SAW=1,  TEX_TRI=2                       */</span>
<a name="l00368"></a>00368     <span class="keywordtype">short</span> <a class="code" href="../../d8/d43/MT__random_8cpp.html#a03af79695b0bf5be732dd7bed6cad125">mt</a> = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>;          <span class="comment">/* marble type: TEX_SOFT=0, TEX_SHARP=1,TEX_SHAPER=2                    */</span>
<a name="l00369"></a>00369     
<a name="l00370"></a>00370     float (*waveform[3])(float);    <span class="comment">/* create array of pointers to waveform functions */</span>
<a name="l00371"></a>00371     waveform[0] = <a class="code" href="../../db/d0d/render__texture_8c.html#a036ed6d27237dab14226a831a91f73be">tex_sin</a>;          <span class="comment">/* assign address of tex_sin() function to pointer array */</span>
<a name="l00372"></a>00372     waveform[1] = <a class="code" href="../../db/d0d/render__texture_8c.html#a37318f90b073397ed68b6a87ac1b8cee">tex_saw</a>;
<a name="l00373"></a>00373     waveform[2] = <a class="code" href="../../db/d0d/render__texture_8c.html#afac9fbfaeaa5898132e84480fcccc146">tex_tri</a>;
<a name="l00374"></a>00374     
<a name="l00375"></a>00375     <span class="keywordflow">if</span> ((wf&gt;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a30048dc1da6e63185b1ba44c1b42d80f">TEX_TRI</a>) || (wf&lt;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adce572a18915c6394a3e91142ed8ee9c">TEX_SIN</a>)) wf=0; <span class="comment">/* check to be sure noisebasis2 isn&#39;t initialized ahead of time */</span>
<a name="l00376"></a>00376     
<a name="l00377"></a>00377     n = 5.0f * (x + y + z);
<a name="l00378"></a>00378     
<a name="l00379"></a>00379     mi = n + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ae3baa785e689a228223b989c9c51ed85">turbul</a> * <a class="code" href="../../d1/d65/BLI__noise_8h.html#acb26a2b54ce9797d6038163af64e362d">BLI_gTurbulence</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, x, y, z, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>),  tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (mt&gt;=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a872e35234ebc77d55368d205ec1c6b16">TEX_SOFT</a>) {  <span class="comment">/* TEX_SOFT always true */</span>
<a name="l00382"></a>00382         mi = waveform[wf](mi);
<a name="l00383"></a>00383         <span class="keywordflow">if</span> (mt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a87447314684fb62e8a01c8c742793bd1">TEX_SHARP</a>) {
<a name="l00384"></a>00384             mi = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(mi);
<a name="l00385"></a>00385         } 
<a name="l00386"></a>00386         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mt==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0d43180bb3748e00327f87b00a62e401">TEX_SHARPER</a>) {
<a name="l00387"></a>00387             mi = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(mi));
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389     }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="keywordflow">return</span> mi;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a><a class="code" href="../../db/d0d/render__texture_8c.html#acbb0761f5c50abd65447a48e1b4b162f">00394</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#acbb0761f5c50abd65447a48e1b4b162f">marble</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396     <span class="keywordtype">int</span> rv=<a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = <a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">marble_int</a>(tex, texvec[0], texvec[1], texvec[2]);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00401"></a>00401         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00402"></a>00402         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = <a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">marble_int</a>(tex, texvec[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[1], texvec[2]);
<a name="l00403"></a>00403         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = <a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">marble_int</a>(tex, texvec[0], texvec[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>, texvec[2]);
<a name="l00404"></a>00404         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = <a class="code" href="../../db/d0d/render__texture_8c.html#aedda59f9935056a660d44858c06b15b3">marble_int</a>(tex, texvec[0], texvec[1], texvec[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>);
<a name="l00405"></a>00405         
<a name="l00406"></a>00406         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordflow">return</span> rv;
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00417"></a>00417 
<a name="l00418"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a703d5fa7e1224fee2112d1f28192b24c">00418</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a703d5fa7e1224fee2112d1f28192b24c">magic</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <span class="keywordtype">float</span> x, y, z, <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>=1.0;
<a name="l00421"></a>00421     <span class="keywordtype">int</span> n;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     n= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>;
<a name="l00424"></a>00424     turb= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ae3baa785e689a228223b989c9c51ed85">turbul</a>/5.0f;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     x=  <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>( ( texvec[0]+texvec[1]+texvec[2])*5.0f );
<a name="l00427"></a>00427     y=  <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>( (-texvec[0]+texvec[1]-texvec[2])*5.0f );
<a name="l00428"></a>00428     z= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>( (-texvec[0]-texvec[1]+texvec[2])*5.0f );
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (n&gt;0) {
<a name="l00430"></a>00430         x*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00431"></a>00431         y*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00432"></a>00432         z*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00433"></a>00433         y= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(x-y+z);
<a name="l00434"></a>00434         y*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (n&gt;1) {
<a name="l00436"></a>00436             x= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(x-y-z);
<a name="l00437"></a>00437             x*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00438"></a>00438             <span class="keywordflow">if</span> (n&gt;2) {
<a name="l00439"></a>00439                 z= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(-x-y-z);
<a name="l00440"></a>00440                 z*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00441"></a>00441                 <span class="keywordflow">if</span> (n&gt;3) {
<a name="l00442"></a>00442                     x= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(-x+y-z);
<a name="l00443"></a>00443                     x*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00444"></a>00444                     <span class="keywordflow">if</span> (n&gt;4) {
<a name="l00445"></a>00445                         y= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(-x+y+z);
<a name="l00446"></a>00446                         y*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00447"></a>00447                         <span class="keywordflow">if</span> (n&gt;5) {
<a name="l00448"></a>00448                             y= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(-x+y+z);
<a name="l00449"></a>00449                             y*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00450"></a>00450                             <span class="keywordflow">if</span> (n&gt;6) {
<a name="l00451"></a>00451                                 x= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(x+y+z);
<a name="l00452"></a>00452                                 x*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00453"></a>00453                                 <span class="keywordflow">if</span> (n&gt;7) {
<a name="l00454"></a>00454                                     z= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(x+y-z);
<a name="l00455"></a>00455                                     z*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00456"></a>00456                                     <span class="keywordflow">if</span> (n&gt;8) {
<a name="l00457"></a>00457                                         x= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(-x-y+z);
<a name="l00458"></a>00458                                         x*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00459"></a>00459                                         <span class="keywordflow">if</span> (n&gt;9) {
<a name="l00460"></a>00460                                             y= -<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(x-y+z);
<a name="l00461"></a>00461                                             y*= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00462"></a>00462                                         }
<a name="l00463"></a>00463                                     }
<a name="l00464"></a>00464                                 }
<a name="l00465"></a>00465                             }
<a name="l00466"></a>00466                         }
<a name="l00467"></a>00467                     }
<a name="l00468"></a>00468                 }
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="keywordflow">if</span> (turb!=0.0f) {
<a name="l00474"></a>00474         turb*= 2.0f;
<a name="l00475"></a>00475         x/= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>; 
<a name="l00476"></a>00476         y/= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>; 
<a name="l00477"></a>00477         z/= <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 0.5f-x;
<a name="l00480"></a>00480     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 0.5f-y;
<a name="l00481"></a>00481     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 0.5f-z;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.3333f*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l00484"></a>00484     
<a name="l00485"></a>00485     <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l00486"></a>00486     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 1.0;
<a name="l00487"></a>00487     
<a name="l00488"></a>00488     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>;
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00492"></a>00492 
<a name="l00493"></a>00493 <span class="comment">/* newnoise: stucci also modified to use different noisebasis */</span>
<a name="l00494"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a6d1ab6394625bbbf4bc058e2e8a99d53">00494</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a6d1ab6394625bbbf4bc058e2e8a99d53">stucci</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496     <span class="keywordtype">float</span> nor[3], b2, ofs;
<a name="l00497"></a>00497     <span class="keywordtype">int</span> retval= <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00498"></a>00498     
<a name="l00499"></a>00499     b2= <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1], texvec[2], (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00500"></a>00500     
<a name="l00501"></a>00501     ofs= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ae3baa785e689a228223b989c9c51ed85">turbul</a>/200.0f;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>) ofs*=(b2*b2);
<a name="l00504"></a>00504     nor[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0]+ofs, texvec[1], texvec[2], (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00505"></a>00505     nor[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1]+ofs, texvec[2], (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>); 
<a name="l00506"></a>00506     nor[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>, texvec[0], texvec[1], texvec[2]+ofs, (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a23a95354b76f369724ab0fd8e518942d">noisetype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ae0ffce829b2a33feba577262d01cd55e">TEX_NOISESOFT</a>), tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= nor[2];
<a name="l00509"></a>00509     
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l00511"></a>00511         
<a name="l00512"></a>00512         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>, nor);
<a name="l00513"></a>00513         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00514"></a>00514         
<a name="l00515"></a>00515         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5e11a2fdeb300fbff9abe4aa54587fe6">TEX_WALLOUT</a>) {
<a name="l00516"></a>00516             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= -texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l00517"></a>00517             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= -texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l00518"></a>00518             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]= -texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520         
<a name="l00521"></a>00521         retval |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523     
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5e11a2fdeb300fbff9abe4aa54587fe6">TEX_WALLOUT</a>)
<a name="l00525"></a>00525         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l00526"></a>00526     
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>&lt;0.0f)
<a name="l00528"></a>00528         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0f;
<a name="l00529"></a>00529     
<a name="l00530"></a>00530     <span class="keywordflow">return</span> retval;
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00534"></a>00534 <span class="comment">/* newnoise: musgrave terrain noise types */</span>
<a name="l00535"></a>00535 
<a name="l00536"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ab8bbc6f9b08a12c85af9799d2e60b733">00536</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ab8bbc6f9b08a12c85af9799d2e60b733">mg_mFractalOrfBmTex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00539"></a>00539     float (*mgravefunc)(float, float, float, float, float, float, int);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aaa6a31213575608016c2850cb6988c9d">TEX_MFRACTAL</a>)
<a name="l00542"></a>00542         mgravefunc = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a2a833cb1025b3f10df79c79c8b3112bf">mg_MultiFractal</a>;
<a name="l00543"></a>00543     <span class="keywordflow">else</span>
<a name="l00544"></a>00544         mgravefunc = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a185f1d01adec0613ae578226d22b3de1">mg_fBm</a>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00549"></a>00549         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>;  <span class="comment">// also scaling of texvec</span>
<a name="l00550"></a>00550         
<a name="l00551"></a>00551         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00552"></a>00552         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0] + offs, texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00553"></a>00553         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1] + offs, texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00554"></a>00554         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1], texvec[2] + offs, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00555"></a>00555         
<a name="l00556"></a>00556         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00557"></a>00557         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="keywordflow">return</span> rv;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a450d4d4d2f2887b9435455aeba17b646">00566</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a450d4d4d2f2887b9435455aeba17b646">mg_ridgedOrHybridMFTex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00569"></a>00569     float (*mgravefunc)(float, float, float, float, float, float, float, float, int);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a53629418e7b079bd50018791b8445f55">TEX_RIDGEDMF</a>)
<a name="l00572"></a>00572         mgravefunc = <a class="code" href="../../d1/d65/BLI__noise_8h.html#ad085274f4b7c6dc7e91ff9503ca0f3c0">mg_RidgedMultiFractal</a>;
<a name="l00573"></a>00573     <span class="keywordflow">else</span>
<a name="l00574"></a>00574         mgravefunc = <a class="code" href="../../d1/d65/BLI__noise_8h.html#abff6e1eb368a0ba2033c99c04587ea76">mg_HybridMultiFractal</a>;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6c5267d2eb220d6007101bb10e0d5337">mg_gain</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00579"></a>00579         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>;  <span class="comment">// also scaling of texvec</span>
<a name="l00580"></a>00580         
<a name="l00581"></a>00581         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00582"></a>00582         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0] + offs, texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6c5267d2eb220d6007101bb10e0d5337">mg_gain</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00583"></a>00583         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1] + offs, texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6c5267d2eb220d6007101bb10e0d5337">mg_gain</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00584"></a>00584         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*mgravefunc(texvec[0], texvec[1], texvec[2] + offs, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6c5267d2eb220d6007101bb10e0d5337">mg_gain</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00585"></a>00585         
<a name="l00586"></a>00586         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00587"></a>00587         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">return</span> rv;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a29fdb851de6e1b70bfc6bfea586e46ce">00597</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a29fdb851de6e1b70bfc6bfea586e46ce">mg_HTerrainTex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a3bafb31902093f5627af98a31d426527">mg_HeteroTerrain</a>(texvec[0], texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00604"></a>00604         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>;  <span class="comment">// also scaling of texvec</span>
<a name="l00605"></a>00605         
<a name="l00606"></a>00606         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00607"></a>00607         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a3bafb31902093f5627af98a31d426527">mg_HeteroTerrain</a>(texvec[0] + offs, texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00608"></a>00608         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a3bafb31902093f5627af98a31d426527">mg_HeteroTerrain</a>(texvec[0], texvec[1] + offs, texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00609"></a>00609         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>*<a class="code" href="../../d1/d65/BLI__noise_8h.html#a3bafb31902093f5627af98a31d426527">mg_HeteroTerrain</a>(texvec[0], texvec[1], texvec[2] + offs, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3ea44d8bb6dc11999a1ede5a1317558">mg_H</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a55a6949f946fd0a7b3531906d67b445f">mg_lacunarity</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a82d883e5aa3f1bf631bc9f6d66eb994a">mg_octaves</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a5eb9fbe7d06d0483265ce8088944654e">mg_offset</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>);
<a name="l00610"></a>00610         
<a name="l00611"></a>00611         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00612"></a>00612         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <span class="keywordflow">return</span> rv;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="../../db/d0d/render__texture_8c.html#aa26122b60c3d47bfafa55ab61b994116">00622</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#aa26122b60c3d47bfafa55ab61b994116">mg_distNoiseTex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a9055c2267469b09600c88481925b5459">mg_VLNoise</a>(texvec[0], texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0e54dfba0b0788bbb76651f6e65749c7">dist_amount</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00629"></a>00629         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>;  <span class="comment">// also scaling of texvec</span>
<a name="l00630"></a>00630         
<a name="l00631"></a>00631         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00632"></a>00632         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a9055c2267469b09600c88481925b5459">mg_VLNoise</a>(texvec[0] + offs, texvec[1], texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0e54dfba0b0788bbb76651f6e65749c7">dist_amount</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>);
<a name="l00633"></a>00633         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a9055c2267469b09600c88481925b5459">mg_VLNoise</a>(texvec[0], texvec[1] + offs, texvec[2], tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0e54dfba0b0788bbb76651f6e65749c7">dist_amount</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>);
<a name="l00634"></a>00634         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a9055c2267469b09600c88481925b5459">mg_VLNoise</a>(texvec[0], texvec[1], texvec[2] + offs, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0e54dfba0b0788bbb76651f6e65749c7">dist_amount</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#abc242baa2f29354f5d2ec1bae1a37821">noisebasis</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a73521f70654d28da48f68f683f893f83">noisebasis2</a>);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00637"></a>00637         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="keywordflow">return</span> rv;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00649"></a>00649 <span class="comment">/* newnoise: Voronoi texture type, probably the slowest, especially with minkovsky, bumpmapping, could be done another way */</span>
<a name="l00650"></a>00650 
<a name="l00651"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a61ae15fbcb085f696e88dc2720c015fa">00651</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a61ae15fbcb085f696e88dc2720c015fa">voronoiTex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653     <span class="keywordtype">int</span> rv = <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00654"></a>00654     <span class="keywordtype">float</span> da[4], pa[12];    <span class="comment">/* distance and point coordinate arrays of 4 nearest neighbors */</span>
<a name="l00655"></a>00655     <span class="keywordtype">float</span> aw1 = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#acb9c36bef38b25ddd926a32d70ef1f78">vn_w1</a>);
<a name="l00656"></a>00656     <span class="keywordtype">float</span> aw2 = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a25d116028e5609ddf539d1a82da83c8c">vn_w2</a>);
<a name="l00657"></a>00657     <span class="keywordtype">float</span> aw3 = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aabc707cf61482dc3872b34f4220cc691">vn_w3</a>);
<a name="l00658"></a>00658     <span class="keywordtype">float</span> aw4 = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a1115376afab5913b592d7440a6fc2bad">vn_w4</a>);
<a name="l00659"></a>00659     <span class="keywordtype">float</span> sc = (aw1 + aw2 + aw3 + aw4);
<a name="l00660"></a>00660     <span class="keywordflow">if</span> (sc!=0.f) sc =  tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a203fd887682138213c912b11724ba022">ns_outscale</a>/sc;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <a class="code" href="../../d1/d65/BLI__noise_8h.html#ae788ebeeeb53f295276feb95d1e3ee4d">voronoi</a>(texvec[0], texvec[1], texvec[2], da, pa, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6b14d9bd1481f1a27aca089b17ee14c5">vn_mexp</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8f469be812763057731b17e3a72c07f2">vn_distm</a>);
<a name="l00663"></a>00663     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = sc * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#acb9c36bef38b25ddd926a32d70ef1f78">vn_w1</a>*da[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a25d116028e5609ddf539d1a82da83c8c">vn_w2</a>*da[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aabc707cf61482dc3872b34f4220cc691">vn_w3</a>*da[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a1115376afab5913b592d7440a6fc2bad">vn_w4</a>*da[3]);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a74c7648c097a39843f0f78268dd94989">vn_coltype</a>) {
<a name="l00666"></a>00666         <span class="keywordtype">float</span> ca[3];    <span class="comment">/* cell color */</span>
<a name="l00667"></a>00667         <a class="code" href="../../d1/d65/BLI__noise_8h.html#a5566ceeb69371a67ca4bbc9c24a8a7f0">cellNoiseV</a>(pa[0], pa[1], pa[2], ca);
<a name="l00668"></a>00668         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = aw1*ca[0];
<a name="l00669"></a>00669         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = aw1*ca[1];
<a name="l00670"></a>00670         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = aw1*ca[2];
<a name="l00671"></a>00671         <a class="code" href="../../d1/d65/BLI__noise_8h.html#a5566ceeb69371a67ca4bbc9c24a8a7f0">cellNoiseV</a>(pa[3], pa[4], pa[5], ca);
<a name="l00672"></a>00672         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += aw2*ca[0];
<a name="l00673"></a>00673         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += aw2*ca[1];
<a name="l00674"></a>00674         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += aw2*ca[2];
<a name="l00675"></a>00675         <a class="code" href="../../d1/d65/BLI__noise_8h.html#a5566ceeb69371a67ca4bbc9c24a8a7f0">cellNoiseV</a>(pa[6], pa[7], pa[8], ca);
<a name="l00676"></a>00676         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += aw3*ca[0];
<a name="l00677"></a>00677         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += aw3*ca[1];
<a name="l00678"></a>00678         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += aw3*ca[2];
<a name="l00679"></a>00679         <a class="code" href="../../d1/d65/BLI__noise_8h.html#a5566ceeb69371a67ca4bbc9c24a8a7f0">cellNoiseV</a>(pa[9], pa[10], pa[11], ca);
<a name="l00680"></a>00680         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> += aw4*ca[0];
<a name="l00681"></a>00681         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> += aw4*ca[1];
<a name="l00682"></a>00682         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> += aw4*ca[2];
<a name="l00683"></a>00683         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a74c7648c097a39843f0f78268dd94989">vn_coltype</a>&gt;=2) {
<a name="l00684"></a>00684             <span class="keywordtype">float</span> t1 = (da[1]-da[0])*10;
<a name="l00685"></a>00685             <span class="keywordflow">if</span> (t1&gt;1) t1=1;
<a name="l00686"></a>00686             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a74c7648c097a39843f0f78268dd94989">vn_coltype</a>==3) t1*=texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>; <span class="keywordflow">else</span> t1*=sc;
<a name="l00687"></a>00687             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= t1;
<a name="l00688"></a>00688             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= t1;
<a name="l00689"></a>00689             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= t1;
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691         <span class="keywordflow">else</span> {
<a name="l00692"></a>00692             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> *= sc;
<a name="l00693"></a>00693             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> *= sc;
<a name="l00694"></a>00694             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> *= sc;
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00699"></a>00699         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a66a4a8d083ed2a61cbef84f9683e2829">nabla</a>/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>;  <span class="comment">// also scaling of texvec</span>
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <span class="comment">/* calculate bumpnormal */</span>
<a name="l00702"></a>00702         <a class="code" href="../../d1/d65/BLI__noise_8h.html#ae788ebeeeb53f295276feb95d1e3ee4d">voronoi</a>(texvec[0] + offs, texvec[1], texvec[2], da, pa, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6b14d9bd1481f1a27aca089b17ee14c5">vn_mexp</a>,  tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8f469be812763057731b17e3a72c07f2">vn_distm</a>);
<a name="l00703"></a>00703         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = sc * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#acb9c36bef38b25ddd926a32d70ef1f78">vn_w1</a>*da[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a25d116028e5609ddf539d1a82da83c8c">vn_w2</a>*da[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aabc707cf61482dc3872b34f4220cc691">vn_w3</a>*da[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a1115376afab5913b592d7440a6fc2bad">vn_w4</a>*da[3]);
<a name="l00704"></a>00704         <a class="code" href="../../d1/d65/BLI__noise_8h.html#ae788ebeeeb53f295276feb95d1e3ee4d">voronoi</a>(texvec[0], texvec[1] + offs, texvec[2], da, pa, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6b14d9bd1481f1a27aca089b17ee14c5">vn_mexp</a>,  tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8f469be812763057731b17e3a72c07f2">vn_distm</a>);
<a name="l00705"></a>00705         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = sc * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#acb9c36bef38b25ddd926a32d70ef1f78">vn_w1</a>*da[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a25d116028e5609ddf539d1a82da83c8c">vn_w2</a>*da[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aabc707cf61482dc3872b34f4220cc691">vn_w3</a>*da[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a1115376afab5913b592d7440a6fc2bad">vn_w4</a>*da[3]);
<a name="l00706"></a>00706         <a class="code" href="../../d1/d65/BLI__noise_8h.html#ae788ebeeeb53f295276feb95d1e3ee4d">voronoi</a>(texvec[0], texvec[1], texvec[2] + offs, da, pa, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a6b14d9bd1481f1a27aca089b17ee14c5">vn_mexp</a>,  tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8f469be812763057731b17e3a72c07f2">vn_distm</a>);
<a name="l00707"></a>00707         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2] = sc * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#acb9c36bef38b25ddd926a32d70ef1f78">vn_w1</a>*da[0] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a25d116028e5609ddf539d1a82da83c8c">vn_w2</a>*da[1] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aabc707cf61482dc3872b34f4220cc691">vn_w3</a>*da[2] + tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a1115376afab5913b592d7440a6fc2bad">vn_w4</a>*da[3]);
<a name="l00708"></a>00708         
<a name="l00709"></a>00709         <a class="code" href="../../db/d0d/render__texture_8c.html#aeb0c6e8d81ef223e3b991de3b94457b5">tex_normal_derivate</a>(tex, texres);
<a name="l00710"></a>00710         rv |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a74c7648c097a39843f0f78268dd94989">vn_coltype</a>) {
<a name="l00714"></a>00714         <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l00715"></a>00715         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = 1.0;
<a name="l00716"></a>00716         <span class="keywordflow">return</span> (rv | <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>);
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718     
<a name="l00719"></a>00719     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <span class="keywordflow">return</span> rv;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00726"></a>00726 
<a name="l00727"></a><a class="code" href="../../db/d0d/render__texture_8c.html#add5c6f522d253f111fc9ae32bb9c4caf">00727</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#add5c6f522d253f111fc9ae32bb9c4caf">texnoise</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>=3.0;
<a name="l00730"></a>00730     <span class="keywordtype">int</span> val, ran, loop;
<a name="l00731"></a>00731     
<a name="l00732"></a>00732     ran= <a class="code" href="../../d3/d88/BLI__rand_8h.html#aed3a0fd477063acc5f19de297b4c4bec">BLI_rand</a>();
<a name="l00733"></a>00733     val= (ran &amp; 3);
<a name="l00734"></a>00734     
<a name="l00735"></a>00735     loop= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a11bd95fac04bd9d893c9d0624dd1721c">noisedepth</a>;
<a name="l00736"></a>00736     <span class="keywordflow">while</span> (loop--) {
<a name="l00737"></a>00737         ran= (ran&gt;&gt;2);
<a name="l00738"></a>00738         val*= (ran &amp; 3);
<a name="l00739"></a>00739         div*= 3.0f;
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741     
<a name="l00742"></a>00742     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= ((float)val)/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00745"></a>00745     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a85edc7abc89f18d384d152521a58fcf6">00750</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a85edc7abc89f18d384d152521a58fcf6">plugintex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> osatex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752     <a class="code" href="../../db/dc9/structPluginTex.html">PluginTex</a> *pit;
<a name="l00753"></a>00753     <span class="keywordtype">int</span> rgbnor=0;
<a name="l00754"></a>00754     <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>[8]= {0.0f};
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     pit= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a215592459592ac15cc9c97c765f5e48c">plugin</a>;
<a name="l00759"></a>00759     <span class="keywordflow">if</span> (pit &amp;&amp; pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>) {
<a name="l00760"></a>00760         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l00761"></a>00761             <span class="keywordflow">if</span> (pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ae65ab7e452700bff44200c50bdcd20d2">version</a> &lt; 6) {
<a name="l00762"></a>00762                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>+5, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l00763"></a>00763             }
<a name="l00764"></a>00764             <span class="keywordflow">else</span> {
<a name="l00765"></a>00765                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(result+5, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l00766"></a>00766             }
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768         <span class="keywordflow">if</span> (pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ae65ab7e452700bff44200c50bdcd20d2">version</a> &lt; 6) {
<a name="l00769"></a>00769             <span class="keywordflow">if</span> (osatex) rgbnor= ((<a class="code" href="../../d0/dc1/BKE__plugin__types_8h.html#ae6baed36f3aec8b1e80fe949b8e5f7ed">TexDoitold</a>)pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>)(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>,
<a name="l00770"></a>00770                 pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a986ab30af83133513d7333e837714f9b">data</a>, texvec, dxt, dyt);
<a name="l00771"></a>00771             <span class="keywordflow">else</span> rgbnor= ((<a class="code" href="../../d0/dc1/BKE__plugin__types_8h.html#ae6baed36f3aec8b1e80fe949b8e5f7ed">TexDoitold</a>)pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>)(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>, 
<a name="l00772"></a>00772                 pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a986ab30af83133513d7333e837714f9b">data</a>, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00773"></a>00773         }
<a name="l00774"></a>00774         <span class="keywordflow">else</span> {
<a name="l00775"></a>00775             <span class="keywordflow">if</span> (osatex) rgbnor= ((<a class="code" href="../../d0/dc1/BKE__plugin__types_8h.html#a3e86700a534324250c507447337c5f5f">TexDoit</a>)pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>)(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>,
<a name="l00776"></a>00776                 pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a986ab30af83133513d7333e837714f9b">data</a>, texvec, dxt, dyt, <a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>);
<a name="l00777"></a>00777             <span class="keywordflow">else</span> rgbnor= ((<a class="code" href="../../d0/dc1/BKE__plugin__types_8h.html#a3e86700a534324250c507447337c5f5f">TexDoit</a>)pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ac9035901655eabafcecb59c286b0be92">doit</a>)(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>, 
<a name="l00778"></a>00778                 pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a986ab30af83133513d7333e837714f9b">data</a>, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>);
<a name="l00779"></a>00779         }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="keywordflow">if</span> (pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ae65ab7e452700bff44200c50bdcd20d2">version</a> &lt; 6) {
<a name="l00782"></a>00782             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>[0];
<a name="l00783"></a>00783         }
<a name="l00784"></a>00784         <span class="keywordflow">else</span> {
<a name="l00785"></a>00785             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a> = result[0]; <span class="comment">/* XXX, assigning garbage value, fixme! */</span>
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         <span class="keywordflow">if</span> (rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>) {
<a name="l00789"></a>00789             <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l00790"></a>00790                 <span class="keywordflow">if</span> (pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ae65ab7e452700bff44200c50bdcd20d2">version</a> &lt; 6) {
<a name="l00791"></a>00791                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>, pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>+5);
<a name="l00792"></a>00792                 }
<a name="l00793"></a>00793                 <span class="keywordflow">else</span> {
<a name="l00794"></a>00794                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>, result+5);
<a name="l00795"></a>00795                 }
<a name="l00796"></a>00796             }
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798         
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>) {
<a name="l00800"></a>00800             <span class="keywordflow">if</span> (pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#ae65ab7e452700bff44200c50bdcd20d2">version</a> &lt; 6) {
<a name="l00801"></a>00801                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>[1];
<a name="l00802"></a>00802                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>[2];
<a name="l00803"></a>00803                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>[3];
<a name="l00804"></a>00804                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = pit-&gt;<a class="code" href="../../db/dc9/structPluginTex.html#a0223a37867919a683cba7c0cd04a1876">result</a>[4];
<a name="l00805"></a>00805             }
<a name="l00806"></a>00806             <span class="keywordflow">else</span> {
<a name="l00807"></a>00807                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> = result[1];
<a name="l00808"></a>00808                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> = result[2];
<a name="l00809"></a>00809                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> = result[3];
<a name="l00810"></a>00810                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> = result[4];
<a name="l00811"></a>00811             }
<a name="l00812"></a>00812 
<a name="l00813"></a>00813             <a class="code" href="../../df/dba/texture_8h.html#a28e8df09893fe8afcbabdc0c59d37a12">BRICONTRGB</a>;
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815         
<a name="l00816"></a>00816         <a class="code" href="../../df/dba/texture_8h.html#a04457b749bb6d1f1ba084341ebba9779">BRICONT</a>;
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819     <span class="keywordflow">return</span> rgbnor;
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 
<a name="l00823"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">00823</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">cubemap_glob</a>(<span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z, <span class="keywordtype">float</span> *adr1, <span class="keywordtype">float</span> *adr2)
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825     <span class="keywordtype">float</span> x1, y1, z1, nor[3];
<a name="l00826"></a>00826     <span class="keywordtype">int</span> ret;
<a name="l00827"></a>00827     
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (n==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00829"></a>00829         nor[0]= x; nor[1]= y; nor[2]= z;    <span class="comment">// use local render coord</span>
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831     <span class="keywordflow">else</span> {
<a name="l00832"></a>00832         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nor, n);
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv, nor);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     x1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[0]);
<a name="l00837"></a>00837     y1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[1]);
<a name="l00838"></a>00838     z1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[2]);
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     <span class="keywordflow">if</span> (z1&gt;=x1 &amp;&amp; z1&gt;=y1) {
<a name="l00841"></a>00841         *adr1 = (x + 1.0f) / 2.0f;
<a name="l00842"></a>00842         *adr2 = (y + 1.0f) / 2.0f;
<a name="l00843"></a>00843         ret= 0;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y1&gt;=x1 &amp;&amp; y1&gt;=z1) {
<a name="l00846"></a>00846         *adr1 = (x + 1.0f) / 2.0f;
<a name="l00847"></a>00847         *adr2 = (z + 1.0f) / 2.0f;
<a name="l00848"></a>00848         ret= 1;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850     <span class="keywordflow">else</span> {
<a name="l00851"></a>00851         *adr1 = (y + 1.0f) / 2.0f;
<a name="l00852"></a>00852         *adr2 = (z + 1.0f) / 2.0f;
<a name="l00853"></a>00853         ret= 2;     
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     <span class="keywordflow">return</span> ret;
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="comment">/* mtex argument only for projection switches */</span>
<a name="l00861"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a7133fb4f5aab45241766478015efcf85">00861</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a7133fb4f5aab45241766478015efcf85">cubemap</a>(<a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z, <span class="keywordtype">float</span> *adr1, <span class="keywordtype">float</span> *adr2)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     <span class="keywordtype">int</span> proj[4]={0, <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0dddbb660f843fc89d077d66a8da9d6a">ME_PROJXY</a>, <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a765d2b7da820e68b0acd51606ffc9fd7">ME_PROJXZ</a>, <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#abce550782d974636103cf8b494921650">ME_PROJYZ</a>}, ret= 0;
<a name="l00864"></a>00864     
<a name="l00865"></a>00865     <span class="keywordflow">if</span> (vlr) {
<a name="l00866"></a>00866         <span class="keywordtype">int</span> index;
<a name="l00867"></a>00867         
<a name="l00868"></a>00868         <span class="comment">/* Mesh vertices have such flags, for others we calculate it once based on orco */</span>
<a name="l00869"></a>00869         <span class="keywordflow">if</span> ((vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> &amp; (<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0dddbb660f843fc89d077d66a8da9d6a">ME_PROJXY</a>|<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a765d2b7da820e68b0acd51606ffc9fd7">ME_PROJXZ</a>|<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#abce550782d974636103cf8b494921650">ME_PROJYZ</a>))==0) {
<a name="l00870"></a>00870             <span class="comment">/* test for v1, vlr can be faked for baking */</span>
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a> &amp;&amp; vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>) {
<a name="l00872"></a>00872                 <span class="keywordtype">float</span> nor[3];
<a name="l00873"></a>00873                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#ac297910bd4bdb283c9f04f70be6b4cbf">orco</a>);
<a name="l00874"></a>00874                 
<a name="l00875"></a>00875                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[0])&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[2]) &amp;&amp; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[1])&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[2]) ) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0dddbb660f843fc89d077d66a8da9d6a">ME_PROJXY</a>;
<a name="l00876"></a>00876                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[0])&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[1]) &amp;&amp; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[2])&lt;<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[1]) ) vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a765d2b7da820e68b0acd51606ffc9fd7">ME_PROJXZ</a>;
<a name="l00877"></a>00877                 <span class="keywordflow">else</span> vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#abce550782d974636103cf8b494921650">ME_PROJYZ</a>;
<a name="l00878"></a>00878             }
<a name="l00879"></a>00879             <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">cubemap_glob</a>(n, x, y, z, adr1, adr2);
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         <span class="keywordflow">if</span> (mtex) {
<a name="l00883"></a>00883             <span class="comment">/* the mtex-&gt;proj{xyz} have type char. maybe this should be wider? */</span>
<a name="l00884"></a>00884             <span class="comment">/* casting to int ensures that the index type is right.            */</span>
<a name="l00885"></a>00885             index = (int) mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>;
<a name="l00886"></a>00886             proj[index]= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a0dddbb660f843fc89d077d66a8da9d6a">ME_PROJXY</a>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888             index = (<span class="keywordtype">int</span>) mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>;
<a name="l00889"></a>00889             proj[index]= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a765d2b7da820e68b0acd51606ffc9fd7">ME_PROJXZ</a>;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891             index = (int) mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>;
<a name="l00892"></a>00892             proj[index]= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#abce550782d974636103cf8b494921650">ME_PROJYZ</a>;
<a name="l00893"></a>00893         }
<a name="l00894"></a>00894         
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> &amp; proj[1]) {
<a name="l00896"></a>00896             *adr1 = (x + 1.0f) / 2.0f;
<a name="l00897"></a>00897             *adr2 = (y + 1.0f) / 2.0f;
<a name="l00898"></a>00898         }
<a name="l00899"></a>00899         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af3aee5491f5b23a757a682f56732fba8">puno</a> &amp; proj[2]) {
<a name="l00900"></a>00900             *adr1 = (x + 1.0f) / 2.0f;
<a name="l00901"></a>00901             *adr2 = (z + 1.0f) / 2.0f;
<a name="l00902"></a>00902             ret= 1;
<a name="l00903"></a>00903         }
<a name="l00904"></a>00904         <span class="keywordflow">else</span> {
<a name="l00905"></a>00905             *adr1 = (y + 1.0f) / 2.0f;
<a name="l00906"></a>00906             *adr2 = (z + 1.0f) / 2.0f;
<a name="l00907"></a>00907             ret= 2;
<a name="l00908"></a>00908         }       
<a name="l00909"></a>00909     } 
<a name="l00910"></a>00910     <span class="keywordflow">else</span> {
<a name="l00911"></a>00911         <span class="keywordflow">return</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">cubemap_glob</a>(n, x, y, z, adr1, adr2);
<a name="l00912"></a>00912     }
<a name="l00913"></a>00913     
<a name="l00914"></a>00914     <span class="keywordflow">return</span> ret;
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00918"></a>00918 
<a name="l00919"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a1f02fe4907060085cc14908b2dce0a3c">00919</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a1f02fe4907060085cc14908b2dce0a3c">cubemap_ob</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z, <span class="keywordtype">float</span> *adr1, <span class="keywordtype">float</span> *adr2)
<a name="l00920"></a>00920 {
<a name="l00921"></a>00921     <span class="keywordtype">float</span> x1, y1, z1, nor[3];
<a name="l00922"></a>00922     <span class="keywordtype">int</span> ret;
<a name="l00923"></a>00923     
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (n==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> 0;
<a name="l00925"></a>00925     
<a name="l00926"></a>00926     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nor, n);
<a name="l00927"></a>00927     <span class="keywordflow">if</span> (ob) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, nor);
<a name="l00928"></a>00928     
<a name="l00929"></a>00929     x1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[0]);
<a name="l00930"></a>00930     y1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[1]);
<a name="l00931"></a>00931     z1= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nor[2]);
<a name="l00932"></a>00932     
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (z1&gt;=x1 &amp;&amp; z1&gt;=y1) {
<a name="l00934"></a>00934         *adr1 = (x + 1.0f) / 2.0f;
<a name="l00935"></a>00935         *adr2 = (y + 1.0f) / 2.0f;
<a name="l00936"></a>00936         ret= 0;
<a name="l00937"></a>00937     }
<a name="l00938"></a>00938     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y1&gt;=x1 &amp;&amp; y1&gt;=z1) {
<a name="l00939"></a>00939         *adr1 = (x + 1.0f) / 2.0f;
<a name="l00940"></a>00940         *adr2 = (z + 1.0f) / 2.0f;
<a name="l00941"></a>00941         ret= 1;
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943     <span class="keywordflow">else</span> {
<a name="l00944"></a>00944         *adr1 = (y + 1.0f) / 2.0f;
<a name="l00945"></a>00945         *adr2 = (z + 1.0f) / 2.0f;
<a name="l00946"></a>00946         ret= 2;     
<a name="l00947"></a>00947     }
<a name="l00948"></a>00948     <span class="keywordflow">return</span> ret;
<a name="l00949"></a>00949 }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00952"></a>00952 
<a name="l00953"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">00953</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(<a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <span class="keywordtype">float</span> *t, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00956"></a>00956     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00957"></a>00957     <span class="keywordtype">float</span> fx, fy, fac1, area[8];
<a name="l00958"></a>00958     <span class="keywordtype">int</span> <a class="code" href="../../d6/d7a/structRender.html#a4bf4f0b482e1d05c2662f09cf5b1dfa3">ok</a>, proj, areaflag= 0, wrap, texco;
<a name="l00959"></a>00959     
<a name="l00960"></a>00960     <span class="comment">/* mtex variables localized, only cubemap doesn&#39;t cooperate yet... */</span>
<a name="l00961"></a>00961     wrap= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a3335663a382f6984d2d0766c8b645cb3">mapping</a>;
<a name="l00962"></a>00962     tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l00963"></a>00963     ob= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>;
<a name="l00964"></a>00964     texco= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa==0) {
<a name="l00967"></a>00967         
<a name="l00968"></a>00968         <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#addd792b0dd4f8d972cc09811d8e0ed01">MTEX_FLAT</a>) {
<a name="l00969"></a>00969             fx = (t[0] + 1.0f) / 2.0f;
<a name="l00970"></a>00970             fy = (t[1] + 1.0f) / 2.0f;
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a6286fa104040f72d5a3bc80c354f6a84">MTEX_TUBE</a>) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( &amp;fx, &amp;fy,t[0], t[1], t[2]);
<a name="l00973"></a>00973         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5d5e04a309feb982f9791a9a8c8efda3">MTEX_SPHERE</a>) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;fx, &amp;fy,t[0], t[1], t[2]);
<a name="l00974"></a>00974         <span class="keywordflow">else</span> {
<a name="l00975"></a>00975             <span class="keywordflow">if</span> (texco==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) <a class="code" href="../../db/d0d/render__texture_8c.html#a1f02fe4907060085cc14908b2dce0a3c">cubemap_ob</a>(ob, n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l00976"></a>00976             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texco==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) <a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">cubemap_glob</a>(n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l00977"></a>00977             <span class="keywordflow">else</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a7133fb4f5aab45241766478015efcf85">cubemap</a>(mtex, vlr, n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l00978"></a>00978         }
<a name="l00979"></a>00979         
<a name="l00980"></a>00980         <span class="comment">/* repeat */</span>
<a name="l00981"></a>00981         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>) {
<a name="l00982"></a>00982             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>&gt;1) {
<a name="l00983"></a>00983                 <span class="keywordtype">float</span> origf= fx *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>;
<a name="l00984"></a>00984                 
<a name="l00985"></a>00985                 <span class="keywordflow">if</span> (fx&gt;1.0f) fx -= (int)(fx);
<a name="l00986"></a>00986                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fx&lt;0.0f) fx+= 1-(int)(fx);
<a name="l00987"></a>00987                 
<a name="l00988"></a>00988                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a>) {
<a name="l00989"></a>00989                     <span class="keywordtype">int</span> orig= (int)floor(origf);
<a name="l00990"></a>00990                     <span class="keywordflow">if</span> (orig &amp; 1)
<a name="l00991"></a>00991                         fx= 1.0f-fx;
<a name="l00992"></a>00992                 }
<a name="l00993"></a>00993             }
<a name="l00994"></a>00994             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>&gt;1) {
<a name="l00995"></a>00995                 <span class="keywordtype">float</span> origf= fy *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>;
<a name="l00996"></a>00996                 
<a name="l00997"></a>00997                 <span class="keywordflow">if</span> (fy&gt;1.0f) fy -= (int)(fy);
<a name="l00998"></a>00998                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fy&lt;0.0f) fy+= 1-(int)(fy);
<a name="l00999"></a>00999                 
<a name="l01000"></a>01000                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>) {
<a name="l01001"></a>01001                     <span class="keywordtype">int</span> orig= (int)floor(origf);
<a name="l01002"></a>01002                     <span class="keywordflow">if</span> (orig &amp; 1)
<a name="l01003"></a>01003                         fy= 1.0f-fy;
<a name="l01004"></a>01004                 }
<a name="l01005"></a>01005             }
<a name="l01006"></a>01006         }
<a name="l01007"></a>01007         <span class="comment">/* crop */</span>
<a name="l01008"></a>01008         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>!=0.0f || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a3565947775a033a2021eaf409bf7f805">cropxmax</a>!=1.0f) {
<a name="l01009"></a>01009             fac1= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a3565947775a033a2021eaf409bf7f805">cropxmax</a> - tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>;
<a name="l01010"></a>01010             fx= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>+ fx*fac1;
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>!=0.0f || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a4926ae9c1a790a8873d062dc70206b31">cropymax</a>!=1.0f) {
<a name="l01013"></a>01013             fac1= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a4926ae9c1a790a8873d062dc70206b31">cropymax</a> - tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>;
<a name="l01014"></a>01014             fy= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>+ fy*fac1;
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016 
<a name="l01017"></a>01017         t[0]= fx;
<a name="l01018"></a>01018         t[1]= fy;
<a name="l01019"></a>01019     }
<a name="l01020"></a>01020     <span class="keywordflow">else</span> {
<a name="l01021"></a>01021         
<a name="l01022"></a>01022         <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#addd792b0dd4f8d972cc09811d8e0ed01">MTEX_FLAT</a>) {
<a name="l01023"></a>01023             fx= (t[0] + 1.0f) / 2.0f;
<a name="l01024"></a>01024             fy= (t[1] + 1.0f) / 2.0f;
<a name="l01025"></a>01025             dxt[0]/= 2.0f;
<a name="l01026"></a>01026             dxt[1]/= 2.0f;
<a name="l01027"></a>01027             dxt[2]/= 2.0f;
<a name="l01028"></a>01028             dyt[0]/= 2.0f;
<a name="l01029"></a>01029             dyt[1]/= 2.0f;
<a name="l01030"></a>01030             dyt[2]/= 2.0f;
<a name="l01031"></a>01031         }
<a name="l01032"></a>01032         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(wrap, <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a6286fa104040f72d5a3bc80c354f6a84">MTEX_TUBE</a>, <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5d5e04a309feb982f9791a9a8c8efda3">MTEX_SPHERE</a>)) {
<a name="l01033"></a>01033             <span class="comment">/* exception: the seam behind (y&lt;0.0) */</span>
<a name="l01034"></a>01034             ok= 1;
<a name="l01035"></a>01035             <span class="keywordflow">if</span> (t[1]&lt;=0.0f) {
<a name="l01036"></a>01036                 fx= t[0]+dxt[0];
<a name="l01037"></a>01037                 fy= t[0]+dyt[0];
<a name="l01038"></a>01038                 <span class="keywordflow">if</span> (fx&gt;=0.0f &amp;&amp; fy&gt;=0.0f &amp;&amp; t[0]&gt;=0.0f);
<a name="l01039"></a>01039                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fx&lt;=0.0f &amp;&amp; fy&lt;=0.0f &amp;&amp; t[0]&lt;=0.0f);
<a name="l01040"></a>01040                 <span class="keywordflow">else</span> ok= 0;
<a name="l01041"></a>01041             }
<a name="l01042"></a>01042             <span class="keywordflow">if</span> (ok) {
<a name="l01043"></a>01043                 <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a6286fa104040f72d5a3bc80c354f6a84">MTEX_TUBE</a>) {
<a name="l01044"></a>01044                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( area, area+1,t[0], t[1], t[2]);
<a name="l01045"></a>01045                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( area+2, area+3,t[0]+dxt[0], t[1]+dxt[1], t[2]+dxt[2]);
<a name="l01046"></a>01046                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( area+4, area+5,t[0]+dyt[0], t[1]+dyt[1], t[2]+dyt[2]);
<a name="l01047"></a>01047                 }
<a name="l01048"></a>01048                 <span class="keywordflow">else</span> { 
<a name="l01049"></a>01049                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>(area,area+1,t[0], t[1], t[2]);
<a name="l01050"></a>01050                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( area+2, area+3,t[0]+dxt[0], t[1]+dxt[1], t[2]+dxt[2]);
<a name="l01051"></a>01051                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( area+4, area+5,t[0]+dyt[0], t[1]+dyt[1], t[2]+dyt[2]);
<a name="l01052"></a>01052                 }
<a name="l01053"></a>01053                 areaflag= 1;
<a name="l01054"></a>01054             }
<a name="l01055"></a>01055             <span class="keywordflow">else</span> {
<a name="l01056"></a>01056                 <span class="keywordflow">if</span> (wrap==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a6286fa104040f72d5a3bc80c354f6a84">MTEX_TUBE</a>) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( &amp;fx, &amp;fy,t[0], t[1], t[2]);
<a name="l01057"></a>01057                 <span class="keywordflow">else</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;fx, &amp;fy,t[0], t[1], t[2]);
<a name="l01058"></a>01058                 dxt[0]/= 2.0f;
<a name="l01059"></a>01059                 dxt[1]/= 2.0f;
<a name="l01060"></a>01060                 dyt[0]/= 2.0f;
<a name="l01061"></a>01061                 dyt[1]/= 2.0f;
<a name="l01062"></a>01062             }
<a name="l01063"></a>01063         }
<a name="l01064"></a>01064         <span class="keywordflow">else</span> {
<a name="l01065"></a>01065 
<a name="l01066"></a>01066             <span class="keywordflow">if</span> (texco==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) proj = <a class="code" href="../../db/d0d/render__texture_8c.html#a1f02fe4907060085cc14908b2dce0a3c">cubemap_ob</a>(ob, n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l01067"></a>01067             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texco==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) proj = <a class="code" href="../../db/d0d/render__texture_8c.html#ac33c1da29d82c38a7bb1a72952af08e1">cubemap_glob</a>(n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l01068"></a>01068             <span class="keywordflow">else</span> proj = <a class="code" href="../../db/d0d/render__texture_8c.html#a7133fb4f5aab45241766478015efcf85">cubemap</a>(mtex, vlr, n, t[0], t[1], t[2], &amp;fx, &amp;fy);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070             <span class="keywordflow">if</span> (proj==1) {
<a name="l01071"></a>01071                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, dxt[1], dxt[2]);
<a name="l01072"></a>01072                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, dyt[1], dyt[2]);
<a name="l01073"></a>01073             }
<a name="l01074"></a>01074             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (proj==2) {
<a name="l01075"></a>01075                 <span class="keywordtype">float</span> f1= dxt[0], f2= dyt[0];
<a name="l01076"></a>01076                 dxt[0]= dxt[1];
<a name="l01077"></a>01077                 dyt[0]= dyt[1];
<a name="l01078"></a>01078                 dxt[1]= dxt[2];
<a name="l01079"></a>01079                 dyt[1]= dyt[2];
<a name="l01080"></a>01080                 dxt[2]= f1;
<a name="l01081"></a>01081                 dyt[2]= f2;
<a name="l01082"></a>01082             }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084             dxt[0] *= 0.5f;
<a name="l01085"></a>01085             dxt[1] *= 0.5f;
<a name="l01086"></a>01086             dxt[2] *= 0.5f;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088             dyt[0] *= 0.5f;
<a name="l01089"></a>01089             dyt[1] *= 0.5f;
<a name="l01090"></a>01090             dyt[2] *= 0.5f;
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         }
<a name="l01093"></a>01093         
<a name="l01094"></a>01094         <span class="comment">/* if area, then reacalculate dxt[] and dyt[] */</span>
<a name="l01095"></a>01095         <span class="keywordflow">if</span> (areaflag) {
<a name="l01096"></a>01096             fx= area[0]; 
<a name="l01097"></a>01097             fy= area[1];
<a name="l01098"></a>01098             dxt[0]= area[2]-fx;
<a name="l01099"></a>01099             dxt[1]= area[3]-fy;
<a name="l01100"></a>01100             dyt[0]= area[4]-fx;
<a name="l01101"></a>01101             dyt[1]= area[5]-fy;
<a name="l01102"></a>01102         }
<a name="l01103"></a>01103         
<a name="l01104"></a>01104         <span class="comment">/* repeat */</span>
<a name="l01105"></a>01105         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a>) {
<a name="l01106"></a>01106             <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= 1.0f;
<a name="l01107"></a>01107             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>&gt;1) {
<a name="l01108"></a>01108                 <span class="keywordtype">float</span> origf= fx *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>;
<a name="l01109"></a>01109                 
<a name="l01110"></a>01110                 <span class="comment">// TXF: omit mirror here, see comments in do_material_tex() after do_2d_mapping() call</span>
<a name="l01111"></a>01111                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a95c4c1619f7b35365a1352603de03ab5">TXF_BOX</a>) {
<a name="l01112"></a>01112                     <span class="keywordflow">if</span> (fx&gt;1.0f) fx -= (int)(fx);
<a name="l01113"></a>01113                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fx&lt;0.0f) fx+= 1-(int)(fx);
<a name="l01114"></a>01114                 
<a name="l01115"></a>01115                     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a>) {
<a name="l01116"></a>01116                         <span class="keywordtype">int</span> orig= (int)floor(origf);
<a name="l01117"></a>01117                         <span class="keywordflow">if</span> (orig &amp; 1)
<a name="l01118"></a>01118                             fx= 1.0f-fx;
<a name="l01119"></a>01119                     }
<a name="l01120"></a>01120                 }
<a name="l01121"></a>01121                 
<a name="l01122"></a>01122                 max= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>;
<a name="l01123"></a>01123                 
<a name="l01124"></a>01124                 dxt[0]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>;
<a name="l01125"></a>01125                 dyt[0]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10e273a1c0a0f25423b2eaa3ce468bc2">xrepeat</a>;
<a name="l01126"></a>01126             }
<a name="l01127"></a>01127             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>&gt;1) {
<a name="l01128"></a>01128                 <span class="keywordtype">float</span> origf= fy *= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>;
<a name="l01129"></a>01129                 
<a name="l01130"></a>01130                 <span class="comment">// TXF: omit mirror here, see comments in do_material_tex() after do_2d_mapping() call</span>
<a name="l01131"></a>01131                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a95c4c1619f7b35365a1352603de03ab5">TXF_BOX</a>) {
<a name="l01132"></a>01132                     <span class="keywordflow">if</span> (fy&gt;1.0f) fy -= (int)(fy);
<a name="l01133"></a>01133                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fy&lt;0.0f) fy+= 1-(int)(fy);
<a name="l01134"></a>01134                 
<a name="l01135"></a>01135                     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>) {
<a name="l01136"></a>01136                         <span class="keywordtype">int</span> orig= (int)floor(origf);
<a name="l01137"></a>01137                         <span class="keywordflow">if</span> (orig &amp; 1)
<a name="l01138"></a>01138                             fy= 1.0f-fy;
<a name="l01139"></a>01139                     }
<a name="l01140"></a>01140                 }
<a name="l01141"></a>01141                 
<a name="l01142"></a>01142                 <span class="keywordflow">if</span> (max&lt;tex-&gt;yrepeat)
<a name="l01143"></a>01143                     max= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145                 dxt[1]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>;
<a name="l01146"></a>01146                 dyt[1]*= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad852759f1de379ee0800966663d31129">yrepeat</a>;
<a name="l01147"></a>01147             }
<a name="l01148"></a>01148             <span class="keywordflow">if</span> (max!=1.0f) {
<a name="l01149"></a>01149                 dxt[2]*= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>;
<a name="l01150"></a>01150                 dyt[2]*= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>;
<a name="l01151"></a>01151             }
<a name="l01152"></a>01152             
<a name="l01153"></a>01153         }
<a name="l01154"></a>01154         <span class="comment">/* crop */</span>
<a name="l01155"></a>01155         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>!=0.0f || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a3565947775a033a2021eaf409bf7f805">cropxmax</a>!=1.0f) {
<a name="l01156"></a>01156             fac1= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a3565947775a033a2021eaf409bf7f805">cropxmax</a> - tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>;
<a name="l01157"></a>01157             fx= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a9386c490f037245cef7f486da359e248">cropxmin</a>+ fx*fac1;
<a name="l01158"></a>01158             dxt[0]*= fac1;
<a name="l01159"></a>01159             dyt[0]*= fac1;
<a name="l01160"></a>01160         }
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>!=0.0f || tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a4926ae9c1a790a8873d062dc70206b31">cropymax</a>!=1.0f) {
<a name="l01162"></a>01162             fac1= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a4926ae9c1a790a8873d062dc70206b31">cropymax</a> - tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>;
<a name="l01163"></a>01163             fy= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0293451165aefb6e630194b5ddf6fed0">cropymin</a>+ fy*fac1;
<a name="l01164"></a>01164             dxt[1]*= fac1;
<a name="l01165"></a>01165             dyt[1]*= fac1;
<a name="l01166"></a>01166         }
<a name="l01167"></a>01167         
<a name="l01168"></a>01168         t[0]= fx;
<a name="l01169"></a>01169         t[1]= fy;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="comment">/* ************************************** */</span>
<a name="l01175"></a>01175 
<a name="l01176"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">01176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> osatex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keywordtype">short</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">short</span> which_output)
<a name="l01177"></a>01177 {
<a name="l01178"></a>01178     <span class="keywordtype">float</span> tmpvec[3];
<a name="l01179"></a>01179     <span class="keywordtype">int</span> retval=0; <span class="comment">/* return value, int:0, col:1, nor:2, everything:3 */</span>
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= 0;  <span class="comment">/* is set when image texture returns alpha (considered premul) */</span>
<a name="l01182"></a>01182     
<a name="l01183"></a>01183     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>) {
<a name="l01184"></a>01184         retval = <a class="code" href="../../d4/d91/BKE__node_8h.html#ad75db1f1a7eb861f3865a4b27575e43b">ntreeTexExecTree</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>, texres, texvec, dxt, dyt, osatex, thread,
<a name="l01185"></a>01185             tex, which_output, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.cfra, (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08bb1fdeac9e78bfcaa9d5b5fb4b5057">R_TEXNODE_PREVIEW</a>) != 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     <span class="keywordflow">else</span>
<a name="l01188"></a>01188     <span class="keywordflow">switch</span>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>) {
<a name="l01189"></a>01189     
<a name="l01190"></a>01190     <span class="keywordflow">case</span> 0:
<a name="l01191"></a>01191         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0f;
<a name="l01192"></a>01192         <span class="keywordflow">return</span> 0;
<a name="l01193"></a>01193     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a239147364b12a01b853cd5c4ce233f5b">TEX_CLOUDS</a>:
<a name="l01194"></a>01194         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a9c8087f4daa3abf9552797c1a8c2a128">clouds</a>(tex, texvec, texres);
<a name="l01195"></a>01195         <span class="keywordflow">break</span>;
<a name="l01196"></a>01196     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af26b6a3bb8552eddc14031b3ec63153f">TEX_WOOD</a>:
<a name="l01197"></a>01197         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a168e81c63776465b82d6b8388c6eeb1c">wood</a>(tex, texvec, texres); 
<a name="l01198"></a>01198         <span class="keywordflow">break</span>;
<a name="l01199"></a>01199     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ad0f55ed9031261b9233ffc09eee67d24">TEX_MARBLE</a>:
<a name="l01200"></a>01200         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#acbb0761f5c50abd65447a48e1b4b162f">marble</a>(tex, texvec, texres); 
<a name="l01201"></a>01201         <span class="keywordflow">break</span>;
<a name="l01202"></a>01202     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aee62150160ebba04cd4dd5fe2bb796f9">TEX_MAGIC</a>:
<a name="l01203"></a>01203         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a703d5fa7e1224fee2112d1f28192b24c">magic</a>(tex, texvec, texres); 
<a name="l01204"></a>01204         <span class="keywordflow">break</span>;
<a name="l01205"></a>01205     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a3cbb6b00c7535699f6a238567cd9c013">TEX_BLEND</a>:
<a name="l01206"></a>01206         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>(tex, texvec, texres);
<a name="l01207"></a>01207         <span class="keywordflow">break</span>;
<a name="l01208"></a>01208     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a8c188992ebde707d32773f09a2d03d8f">TEX_STUCCI</a>:
<a name="l01209"></a>01209         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a6d1ab6394625bbbf4bc058e2e8a99d53">stucci</a>(tex, texvec, texres); 
<a name="l01210"></a>01210         <span class="keywordflow">break</span>;
<a name="l01211"></a>01211     <span class="keywordflow">case</span> <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a9d836499a3644344ccf91598ebc7fc46">TEX_NOISE</a>:
<a name="l01212"></a>01212         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#add5c6f522d253f111fc9ae32bb9c4caf">texnoise</a>(tex, texres); 
<a name="l01213"></a>01213         <span class="keywordflow">break</span>;
<a name="l01214"></a>01214     <span class="keywordflow">case</span> <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>:
<a name="l01215"></a>01215         <span class="keywordflow">if</span> (osatex) retval= <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(tex, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, texvec, dxt, dyt, texres);
<a name="l01216"></a>01216         <span class="keywordflow">else</span> retval= <a class="code" href="../../df/dba/texture_8h.html#a7762aab857b2d37f53a4504f8e529d83">imagewrap</a>(tex, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, texvec, texres); 
<a name="l01217"></a>01217         <a class="code" href="../../d2/d77/BKE__image_8h.html#ad5b660dd2b40bffa484187872f271009">tag_image_time</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>); <span class="comment">/* tag image as having being used */</span>
<a name="l01218"></a>01218         <span class="keywordflow">break</span>;
<a name="l01219"></a>01219     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab99dfbf8e7952fd8f8f0f6466c798545">TEX_PLUGIN</a>:
<a name="l01220"></a>01220         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a85edc7abc89f18d384d152521a58fcf6">plugintex</a>(tex, texvec, dxt, dyt, osatex, texres);
<a name="l01221"></a>01221         <span class="keywordflow">break</span>;
<a name="l01222"></a>01222     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a268a78c388efb693b879d6d21d3f60c7">TEX_ENVMAP</a>:
<a name="l01223"></a>01223         retval= <a class="code" href="../../d7/d3f/envmap_8h.html#a7c7f8bb586f73faea7680bf6acf3364d">envmaptex</a>(tex, texvec, dxt, dyt, osatex, texres);
<a name="l01224"></a>01224         <span class="keywordflow">break</span>;
<a name="l01225"></a>01225     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aa706404a507d9cc7e5416e474ae16469">TEX_MUSGRAVE</a>:
<a name="l01226"></a>01226         <span class="comment">/* newnoise: musgrave types */</span>
<a name="l01227"></a>01227         
<a name="l01228"></a>01228         <span class="comment">/* ton: added this, for Blender convention reason. </span>
<a name="l01229"></a>01229 <span class="comment">         * artificer: added the use of tmpvec to avoid scaling texvec</span>
<a name="l01230"></a>01230 <span class="comment">         */</span>
<a name="l01231"></a>01231         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmpvec, texvec);
<a name="l01232"></a>01232         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tmpvec, 1.0f/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>);
<a name="l01233"></a>01233         
<a name="l01234"></a>01234         <span class="keywordflow">switch</span>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8232165bb3210ad106bdc7880f801eb2">stype</a>) {
<a name="l01235"></a>01235         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aaa6a31213575608016c2850cb6988c9d">TEX_MFRACTAL</a>:
<a name="l01236"></a>01236         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aa32fb09e749784898bd75bb4092368ee">TEX_FBM</a>:
<a name="l01237"></a>01237             retval= <a class="code" href="../../db/d0d/render__texture_8c.html#ab8bbc6f9b08a12c85af9799d2e60b733">mg_mFractalOrfBmTex</a>(tex, tmpvec, texres);
<a name="l01238"></a>01238             <span class="keywordflow">break</span>;
<a name="l01239"></a>01239         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a53629418e7b079bd50018791b8445f55">TEX_RIDGEDMF</a>:
<a name="l01240"></a>01240         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a287ac6ccb66a8434cc4bf541476d513f">TEX_HYBRIDMF</a>:
<a name="l01241"></a>01241             retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a450d4d4d2f2887b9435455aeba17b646">mg_ridgedOrHybridMFTex</a>(tex, tmpvec, texres);
<a name="l01242"></a>01242             <span class="keywordflow">break</span>;
<a name="l01243"></a>01243         <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ad81778ab560dee80890ec2a48b3780ba">TEX_HTERRAIN</a>:
<a name="l01244"></a>01244             retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a29fdb851de6e1b70bfc6bfea586e46ce">mg_HTerrainTex</a>(tex, tmpvec, texres);
<a name="l01245"></a>01245             <span class="keywordflow">break</span>;
<a name="l01246"></a>01246         }
<a name="l01247"></a>01247         <span class="keywordflow">break</span>;
<a name="l01248"></a>01248     <span class="comment">/* newnoise: voronoi type */</span>
<a name="l01249"></a>01249     <span class="keywordflow">case</span> <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a31f7c8b5966205950eb8fabc78fc36cf">TEX_VORONOI</a>:
<a name="l01250"></a>01250         <span class="comment">/* ton: added this, for Blender convention reason.</span>
<a name="l01251"></a>01251 <span class="comment">         * artificer: added the use of tmpvec to avoid scaling texvec</span>
<a name="l01252"></a>01252 <span class="comment">         */</span>
<a name="l01253"></a>01253         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmpvec, texvec);
<a name="l01254"></a>01254         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tmpvec, 1.0f/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>);
<a name="l01255"></a>01255         
<a name="l01256"></a>01256         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#a61ae15fbcb085f696e88dc2720c015fa">voronoiTex</a>(tex, tmpvec, texres);
<a name="l01257"></a>01257         <span class="keywordflow">break</span>;
<a name="l01258"></a>01258     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a81107f01f8f2bf485ad64e784546ab57">TEX_DISTNOISE</a>:
<a name="l01259"></a>01259         <span class="comment">/* ton: added this, for Blender convention reason.</span>
<a name="l01260"></a>01260 <span class="comment">         * artificer: added the use of tmpvec to avoid scaling texvec</span>
<a name="l01261"></a>01261 <span class="comment">         */</span>
<a name="l01262"></a>01262         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmpvec, texvec);
<a name="l01263"></a>01263         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(tmpvec, 1.0f/tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a10d31271eb9bf27b184c404ac6352714">noisesize</a>);
<a name="l01264"></a>01264         
<a name="l01265"></a>01265         retval= <a class="code" href="../../db/d0d/render__texture_8c.html#aa26122b60c3d47bfafa55ab61b994116">mg_distNoiseTex</a>(tex, tmpvec, texres);
<a name="l01266"></a>01266         <span class="keywordflow">break</span>;
<a name="l01267"></a>01267     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0d2d438f1eb6896112dd8862eae03be2">TEX_POINTDENSITY</a>:
<a name="l01268"></a>01268         retval= <a class="code" href="../../d7/def/pointdensity_8h.html#aa6361fdae3df6d2be0911faddf811e9b">pointdensitytex</a>(tex, texvec, texres);
<a name="l01269"></a>01269         <span class="keywordflow">break</span>;
<a name="l01270"></a>01270     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7fd8163d72590628d35ab2695e48424a">TEX_VOXELDATA</a>:
<a name="l01271"></a>01271         retval= <a class="code" href="../../d5/dd0/voxeldata_8h.html#a7cc61cd2e427bc44cf95822962ffc004">voxeldatatex</a>(tex, texvec, texres);  
<a name="l01272"></a>01272         <span class="keywordflow">break</span>;
<a name="l01273"></a>01273     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0bfbe31cefcbc95329fdcc8273fad989">TEX_OCEAN</a>:
<a name="l01274"></a>01274         retval= <a class="code" href="../../d0/d9e/texture__ocean_8h.html#a76a258b6d1ea6eb248f7fdd7e70d773b">ocean_texture</a>(tex, texvec, texres);  
<a name="l01275"></a>01275         <span class="keywordflow">break</span>;
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a27ca5c0471d318e9195d90305cd52011">TEX_COLORBAND</a>) {
<a name="l01279"></a>01279         <span class="keywordtype">float</span> col[4];
<a name="l01280"></a>01280         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8a9db83c0f33abeb5ff2bf434abeac9e">coba</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, col)) {
<a name="l01281"></a>01281             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= 1;
<a name="l01282"></a>01282             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= col[0];
<a name="l01283"></a>01283             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= col[1];
<a name="l01284"></a>01284             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= col[2];
<a name="l01285"></a>01285             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= col[3];
<a name="l01286"></a>01286             retval |= <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>;
<a name="l01287"></a>01287         }
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289     <span class="keywordflow">return</span> retval;
<a name="l01290"></a>01290 }
<a name="l01291"></a>01291 
<a name="l01292"></a>01292 <span class="comment">/* this is called from the shader and texture nodes */</span>
<a name="l01293"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a4b0634d46f5718b815e4fed5ebd02df6">01293</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a8cb395f0242c466962615f5cafdf090c">multitex_nodes</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> osatex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keywordtype">short</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">short</span> which_output, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex)
<a name="l01294"></a>01294 {
<a name="l01295"></a>01295     <span class="keywordflow">if</span> (tex==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01296"></a>01296         memset(texres, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/da2/structTexResult.html">TexResult</a>));
<a name="l01297"></a>01297         <span class="keywordflow">return</span> 0;
<a name="l01298"></a>01298     }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300     <span class="keywordflow">if</span> (mtex)
<a name="l01301"></a>01301         which_output= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>;
<a name="l01302"></a>01302     
<a name="l01303"></a>01303     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l01304"></a>01304         <span class="keywordtype">int</span> rgbnor;
<a name="l01305"></a>01305 
<a name="l01306"></a>01306         <span class="keywordflow">if</span> (mtex) {
<a name="l01307"></a>01307             <span class="comment">/* we have mtex, use it for 2d mapping images only */</span>
<a name="l01308"></a>01308             <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>, dxt, dyt);
<a name="l01309"></a>01309             rgbnor= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec, dxt, dyt, osatex, texres, thread, which_output);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#af205394e8cf1225dd1746ef3fe0c08cb">MAP_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a14f4ce1c3bd682fda8faf3e93243682b">MAP_COLSPEC</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9e22389d5148446e93c44bf98a79fb81">MAP_COLMIR</a>)) {
<a name="l01312"></a>01312                 <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l01313"></a>01313                 
<a name="l01314"></a>01314                 <span class="comment">/* don&#39;t linearize float buffers, assumed to be linear */</span>
<a name="l01315"></a>01315                 <span class="keywordflow">if</span> (ibuf &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) &amp;&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.color_mgt_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l01316"></a>01316                     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(&amp;texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, &amp;texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>);
<a name="l01317"></a>01317             }
<a name="l01318"></a>01318         }
<a name="l01319"></a>01319         <span class="keywordflow">else</span> {
<a name="l01320"></a>01320             <span class="comment">/* we don&#39;t have mtex, do default flat 2d projection */</span>
<a name="l01321"></a>01321             <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> localmtex;
<a name="l01322"></a>01322             <span class="keywordtype">float</span> texvec_l[3], dxt_l[3], dyt_l[3];
<a name="l01323"></a>01323             
<a name="l01324"></a>01324             localmtex.<a class="code" href="../../dc/ddd/structMTex.html#a3335663a382f6984d2d0766c8b645cb3">mapping</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#addd792b0dd4f8d972cc09811d8e0ed01">MTEX_FLAT</a>;
<a name="l01325"></a>01325             localmtex.<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>= tex;
<a name="l01326"></a>01326             localmtex.<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01327"></a>01327             localmtex.<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>= <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>;
<a name="l01328"></a>01328             
<a name="l01329"></a>01329             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(texvec_l, texvec);
<a name="l01330"></a>01330             <span class="keywordflow">if</span> (dxt &amp;&amp; dyt) {
<a name="l01331"></a>01331                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dxt_l, dxt);
<a name="l01332"></a>01332                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dyt_l, dyt);
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334             <span class="keywordflow">else</span> {
<a name="l01335"></a>01335                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(dxt_l);
<a name="l01336"></a>01336                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(dyt_l);
<a name="l01337"></a>01337             }
<a name="l01338"></a>01338             
<a name="l01339"></a>01339             <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(&amp;localmtex, texvec_l, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dxt_l, dyt_l);
<a name="l01340"></a>01340             rgbnor= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec_l, dxt_l, dyt_l, osatex, texres, thread, which_output);
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343         <span class="keywordflow">return</span> rgbnor;
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345     <span class="keywordflow">else</span>
<a name="l01346"></a>01346         <span class="keywordflow">return</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec, dxt, dyt, osatex, texres, thread, which_output);
<a name="l01347"></a>01347 }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349 <span class="comment">/* this is called for surface shading */</span>
<a name="l01350"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">01350</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l01351"></a>01351 {
<a name="l01352"></a>01352     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>) {
<a name="l01355"></a>01355         <span class="comment">/* stupid exception here .. but we have to pass shi and mtex to</span>
<a name="l01356"></a>01356 <span class="comment">         * textures nodes for 2d mapping and color management for images */</span>
<a name="l01357"></a>01357         <span class="keywordflow">return</span> <a class="code" href="../../d4/d91/BKE__node_8h.html#ad75db1f1a7eb861f3865a4b27575e43b">ntreeTexExecTree</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a>, texres, texvec, dxt, dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>,
<a name="l01358"></a>01358             tex, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.cfra, (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08bb1fdeac9e78bfcaa9d5b5fb4b5057">R_TEXNODE_PREVIEW</a>) != 0, shi, mtex);
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     <span class="keywordflow">else</span>
<a name="l01361"></a>01361         <span class="keywordflow">return</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>, texvec, dxt, dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>, texres, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);
<a name="l01362"></a>01362 }
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 <span class="comment">/* Warning, if the texres&#39;s values are not declared zero, check the return value to be sure</span>
<a name="l01365"></a>01365 <span class="comment"> * the color values are set before using the r/g/b values, otherwise you may use uninitialized values - Campbell */</span>
<a name="l01366"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a208910f1b75fc874ae8fdf19b0daad3f">01366</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a5a08933d2cffb0132e123669117f04ac">multitex_ext</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> osatex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l01367"></a>01367 {
<a name="l01368"></a>01368     <span class="keywordflow">return</span> <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a8cb395f0242c466962615f5cafdf090c">multitex_nodes</a>(tex, texvec, dxt, dyt, osatex, texres, 0, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 <span class="comment">/* extern-tex doesn&#39;t support nodes (ntreeBeginExec() can&#39;t be called when rendering is going on) */</span>
<a name="l01372"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a19e182564c4ac428aa9aac3f46c2b626">01372</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a667fa1cc0062c0202d418921e3b6beff">multitex_ext_safe</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374     <span class="keywordtype">int</span> use_nodes= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a>, retval;
<a name="l01375"></a>01375     
<a name="l01376"></a>01376     tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a>= 0;
<a name="l01377"></a>01377     retval= <a class="code" href="../../d9/d49/RE__shader__ext_8h.html#a8cb395f0242c466962615f5cafdf090c">multitex_nodes</a>(tex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, texres, 0, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01378"></a>01378     tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a>= use_nodes;
<a name="l01379"></a>01379     
<a name="l01380"></a>01380     <span class="keywordflow">return</span> retval;
<a name="l01381"></a>01381 }
<a name="l01382"></a>01382 
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 <span class="comment">/* in = destination, tex = texture, out = previous color */</span>
<a name="l01387"></a>01387 <span class="comment">/* fact = texture strength, facg = button strength value */</span>
<a name="l01388"></a><a class="code" href="../../db/d0d/render__texture_8c.html#af3c49ebb2bfd6a153751a26b54cf32cc">01388</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(<span class="keywordtype">float</span> in[3], <span class="keyword">const</span> <span class="keywordtype">float</span> tex[3], <span class="keyword">const</span> <span class="keywordtype">float</span> out[3], <span class="keywordtype">float</span> fact, <span class="keywordtype">float</span> facg, <span class="keywordtype">int</span> blendtype)
<a name="l01389"></a>01389 {
<a name="l01390"></a>01390     <span class="keywordtype">float</span> facm, col;
<a name="l01391"></a>01391     
<a name="l01392"></a>01392     <span class="keywordflow">switch</span>(blendtype) {
<a name="l01393"></a>01393     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3a8049d0db5deca0c55bbe3782ef97f">MTEX_BLEND</a>:
<a name="l01394"></a>01394         fact*= facg;
<a name="l01395"></a>01395         facm= 1.0f-fact;
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         in[0]= (fact*tex[0] + facm*out[0]);
<a name="l01398"></a>01398         in[1]= (fact*tex[1] + facm*out[1]);
<a name="l01399"></a>01399         in[2]= (fact*tex[2] + facm*out[2]);
<a name="l01400"></a>01400         <span class="keywordflow">break</span>;
<a name="l01401"></a>01401         
<a name="l01402"></a>01402     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a082272727c78e320aa764225c854d1f0">MTEX_MUL</a>:
<a name="l01403"></a>01403         fact*= facg;
<a name="l01404"></a>01404         facm= 1.0f-facg;
<a name="l01405"></a>01405         in[0]= (facm+fact*tex[0])*out[0];
<a name="l01406"></a>01406         in[1]= (facm+fact*tex[1])*out[1];
<a name="l01407"></a>01407         in[2]= (facm+fact*tex[2])*out[2];
<a name="l01408"></a>01408         <span class="keywordflow">break</span>;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a88efd9c2cb9d9260da3084457143a7e9">MTEX_SCREEN</a>:
<a name="l01411"></a>01411         fact*= facg;
<a name="l01412"></a>01412         facm= 1.0f-facg;
<a name="l01413"></a>01413         in[0]= 1.0f - (facm+fact*(1.0f-tex[0])) * (1.0f-out[0]);
<a name="l01414"></a>01414         in[1]= 1.0f - (facm+fact*(1.0f-tex[1])) * (1.0f-out[1]);
<a name="l01415"></a>01415         in[2]= 1.0f - (facm+fact*(1.0f-tex[2])) * (1.0f-out[2]);
<a name="l01416"></a>01416         <span class="keywordflow">break</span>;
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a34c05d3b7a38b96b17ca2af0df9fcd78">MTEX_OVERLAY</a>:
<a name="l01419"></a>01419         fact*= facg;
<a name="l01420"></a>01420         facm= 1.0f-facg;
<a name="l01421"></a>01421         
<a name="l01422"></a>01422         <span class="keywordflow">if</span> (out[0] &lt; 0.5f)
<a name="l01423"></a>01423             in[0] = out[0] * (facm + 2.0f*fact*tex[0]);
<a name="l01424"></a>01424         <span class="keywordflow">else</span>
<a name="l01425"></a>01425             in[0] = 1.0f - (facm + 2.0f*fact*(1.0f - tex[0])) * (1.0f - out[0]);
<a name="l01426"></a>01426         <span class="keywordflow">if</span> (out[1] &lt; 0.5f)
<a name="l01427"></a>01427             in[1] = out[1] * (facm + 2.0f*fact*tex[1]);
<a name="l01428"></a>01428         <span class="keywordflow">else</span>
<a name="l01429"></a>01429             in[1] = 1.0f - (facm + 2.0f*fact*(1.0f - tex[1])) * (1.0f - out[1]);
<a name="l01430"></a>01430         <span class="keywordflow">if</span> (out[2] &lt; 0.5f)
<a name="l01431"></a>01431             in[2] = out[2] * (facm + 2.0f*fact*tex[2]);
<a name="l01432"></a>01432         <span class="keywordflow">else</span>
<a name="l01433"></a>01433             in[2] = 1.0f - (facm + 2.0f*fact*(1.0f - tex[2])) * (1.0f - out[2]);
<a name="l01434"></a>01434         <span class="keywordflow">break</span>;
<a name="l01435"></a>01435         
<a name="l01436"></a>01436     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7a6644c61ffb76743b6ac4cd423633b5">MTEX_SUB</a>:
<a name="l01437"></a>01437         fact= -fact;
<a name="l01438"></a>01438     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#add089465c8a525998da583aea2b3800d">MTEX_ADD</a>:
<a name="l01439"></a>01439         fact*= facg;
<a name="l01440"></a>01440         in[0]= (fact*tex[0] + out[0]);
<a name="l01441"></a>01441         in[1]= (fact*tex[1] + out[1]);
<a name="l01442"></a>01442         in[2]= (fact*tex[2] + out[2]);
<a name="l01443"></a>01443         <span class="keywordflow">break</span>;
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a4316794e681f553f0a0289b4e993af97">MTEX_DIV</a>:
<a name="l01446"></a>01446         fact*= facg;
<a name="l01447"></a>01447         facm= 1.0f-fact;
<a name="l01448"></a>01448         
<a name="l01449"></a>01449         <span class="keywordflow">if</span> (tex[0]!=0.0f)
<a name="l01450"></a>01450             in[0]= facm*out[0] + fact*out[0]/tex[0];
<a name="l01451"></a>01451         <span class="keywordflow">if</span> (tex[1]!=0.0f)
<a name="l01452"></a>01452             in[1]= facm*out[1] + fact*out[1]/tex[1];
<a name="l01453"></a>01453         <span class="keywordflow">if</span> (tex[2]!=0.0f)
<a name="l01454"></a>01454             in[2]= facm*out[2] + fact*out[2]/tex[2];
<a name="l01455"></a>01455 
<a name="l01456"></a>01456         <span class="keywordflow">break</span>;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab0dafdbade8ba317f975bcfaab19fb48">MTEX_DIFF</a>:
<a name="l01459"></a>01459         fact*= facg;
<a name="l01460"></a>01460         facm= 1.0f-fact;
<a name="l01461"></a>01461         in[0]= facm*out[0] + fact*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex[0]-out[0]);
<a name="l01462"></a>01462         in[1]= facm*out[1] + fact*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex[1]-out[1]);
<a name="l01463"></a>01463         in[2]= facm*out[2] + fact*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex[2]-out[2]);
<a name="l01464"></a>01464         <span class="keywordflow">break</span>;
<a name="l01465"></a>01465 
<a name="l01466"></a>01466     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af3f59fa4c5b02ed3d935c8f1b7dae6b4">MTEX_DARK</a>:
<a name="l01467"></a>01467         fact*= facg;
<a name="l01468"></a>01468         facm= 1.0f-fact;
<a name="l01469"></a>01469         
<a name="l01470"></a>01470         col= tex[0]+((1-tex[0])*facm);
<a name="l01471"></a>01471         <span class="keywordflow">if</span> (col &lt; out[0]) in[0]= col; <span class="keywordflow">else</span> in[0]= out[0];
<a name="l01472"></a>01472         col= tex[1]+((1-tex[1])*facm);
<a name="l01473"></a>01473         <span class="keywordflow">if</span> (col &lt; out[1]) in[1]= col; <span class="keywordflow">else</span> in[1]= out[1];
<a name="l01474"></a>01474         col= tex[2]+((1-tex[2])*facm);
<a name="l01475"></a>01475         <span class="keywordflow">if</span> (col &lt; out[2]) in[2]= col; <span class="keywordflow">else</span> in[2]= out[2];
<a name="l01476"></a>01476         <span class="keywordflow">break</span>;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0115564f6c905ecb82ce7083aac5a2f3">MTEX_LIGHT</a>:
<a name="l01479"></a>01479         fact*= facg;
<a name="l01480"></a>01480         
<a name="l01481"></a>01481         col= fact*tex[0];
<a name="l01482"></a>01482         <span class="keywordflow">if</span> (col &gt; out[0]) in[0]= col; <span class="keywordflow">else</span> in[0]= out[0];
<a name="l01483"></a>01483         col= fact*tex[1];
<a name="l01484"></a>01484         <span class="keywordflow">if</span> (col &gt; out[1]) in[1]= col; <span class="keywordflow">else</span> in[1]= out[1];
<a name="l01485"></a>01485         col= fact*tex[2];
<a name="l01486"></a>01486         <span class="keywordflow">if</span> (col &gt; out[2]) in[2]= col; <span class="keywordflow">else</span> in[2]= out[2];
<a name="l01487"></a>01487         <span class="keywordflow">break</span>;
<a name="l01488"></a>01488         
<a name="l01489"></a>01489     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a457b5b2b3352ec63a484e5ea29c6af11">MTEX_BLEND_HUE</a>:
<a name="l01490"></a>01490         fact*= facg;
<a name="l01491"></a>01491         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01492"></a>01492         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#acec0a576845ca0e96530fb4228f0dbf1">MA_RAMP_HUE</a>, in, fact, tex);
<a name="l01493"></a>01493         <span class="keywordflow">break</span>;
<a name="l01494"></a>01494     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abf0720d4c8bcb9b69fb54972ff27e7c0">MTEX_BLEND_SAT</a>:
<a name="l01495"></a>01495         fact*= facg;
<a name="l01496"></a>01496         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01497"></a>01497         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#a80e6116f3942eef9c0aadca73ee04831">MA_RAMP_SAT</a>, in, fact, tex);
<a name="l01498"></a>01498         <span class="keywordflow">break</span>;
<a name="l01499"></a>01499     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0c4961cd710cdabb0515d9595e15f501">MTEX_BLEND_VAL</a>:
<a name="l01500"></a>01500         fact*= facg;
<a name="l01501"></a>01501         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01502"></a>01502         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#a1f7996d0c0f2eec0a93a7a3ea7112b25">MA_RAMP_VAL</a>, in, fact, tex);
<a name="l01503"></a>01503         <span class="keywordflow">break</span>;
<a name="l01504"></a>01504     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adcbf0f8adf7358f2b03ccde139b50ebb">MTEX_BLEND_COLOR</a>:
<a name="l01505"></a>01505         fact*= facg;
<a name="l01506"></a>01506         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01507"></a>01507         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#afdeec308449de3990c42c27b31da63c0">MA_RAMP_COLOR</a>, in, fact, tex);
<a name="l01508"></a>01508         <span class="keywordflow">break</span>;
<a name="l01509"></a>01509     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#acda1e4c8f7761a632083a514027855f1">MTEX_SOFT_LIGHT</a>: 
<a name="l01510"></a>01510         fact*= facg; 
<a name="l01511"></a>01511         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01512"></a>01512         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#a42789198d385b729242aa8734ad5aa3e">MA_RAMP_SOFT</a>, in, fact, tex);
<a name="l01513"></a>01513         <span class="keywordflow">break</span>; 
<a name="l01514"></a>01514     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a8b592d169dca6d7c7e66873814726d52">MTEX_LIN_LIGHT</a>: 
<a name="l01515"></a>01515         fact*= facg; 
<a name="l01516"></a>01516         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(in, out);
<a name="l01517"></a>01517         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(<a class="code" href="../../de/db2/DNA__material__types_8h.html#a6bd01310bf6a8f23d2aff0b5e559b570">MA_RAMP_LINEAR</a>, in, fact, tex);
<a name="l01518"></a>01518         <span class="keywordflow">break</span>; 
<a name="l01519"></a>01519     }
<a name="l01520"></a>01520 }
<a name="l01521"></a>01521 
<a name="l01522"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ae82635e8146c80bff5e9858e7200b328">01522</a> <span class="keywordtype">float</span> <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(<span class="keywordtype">float</span> tex, <span class="keywordtype">float</span> out, <span class="keywordtype">float</span> fact, <span class="keywordtype">float</span> facg, <span class="keywordtype">int</span> blendtype)
<a name="l01523"></a>01523 {
<a name="l01524"></a>01524     <span class="keywordtype">float</span> in=0.0, facm, col, scf;
<a name="l01525"></a>01525     <span class="keywordtype">int</span> flip= (facg &lt; 0.0f);
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     facg= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(facg);
<a name="l01528"></a>01528     
<a name="l01529"></a>01529     fact*= facg;
<a name="l01530"></a>01530     facm= 1.0f-fact;
<a name="l01531"></a>01531     <span class="keywordflow">if</span> (flip) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, fact, facm);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533     <span class="keywordflow">switch</span>(blendtype) {
<a name="l01534"></a>01534     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3a8049d0db5deca0c55bbe3782ef97f">MTEX_BLEND</a>:
<a name="l01535"></a>01535         in= fact*tex + facm*out;
<a name="l01536"></a>01536         <span class="keywordflow">break</span>;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a082272727c78e320aa764225c854d1f0">MTEX_MUL</a>:
<a name="l01539"></a>01539         facm= 1.0f-facg;
<a name="l01540"></a>01540         in= (facm+fact*tex)*out;
<a name="l01541"></a>01541         <span class="keywordflow">break</span>;
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a88efd9c2cb9d9260da3084457143a7e9">MTEX_SCREEN</a>:
<a name="l01544"></a>01544         facm= 1.0f-facg;
<a name="l01545"></a>01545         in= 1.0f-(facm+fact*(1.0f-tex))*(1.0f-out);
<a name="l01546"></a>01546         <span class="keywordflow">break</span>;
<a name="l01547"></a>01547 
<a name="l01548"></a>01548     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a34c05d3b7a38b96b17ca2af0df9fcd78">MTEX_OVERLAY</a>:
<a name="l01549"></a>01549         facm= 1.0f-facg;
<a name="l01550"></a>01550         <span class="keywordflow">if</span> (out &lt; 0.5f)
<a name="l01551"></a>01551             in = out * (facm + 2.0f*fact*tex);
<a name="l01552"></a>01552         <span class="keywordflow">else</span>
<a name="l01553"></a>01553             in = 1.0f - (facm + 2.0f*fact*(1.0f - tex)) * (1.0f - out);
<a name="l01554"></a>01554         <span class="keywordflow">break</span>;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7a6644c61ffb76743b6ac4cd423633b5">MTEX_SUB</a>:
<a name="l01557"></a>01557         fact= -fact;
<a name="l01558"></a>01558     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#add089465c8a525998da583aea2b3800d">MTEX_ADD</a>:
<a name="l01559"></a>01559         in= fact*tex + out;
<a name="l01560"></a>01560         <span class="keywordflow">break</span>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a4316794e681f553f0a0289b4e993af97">MTEX_DIV</a>:
<a name="l01563"></a>01563         <span class="keywordflow">if</span> (tex!=0.0f)
<a name="l01564"></a>01564             in= facm*out + fact*out/tex;
<a name="l01565"></a>01565         <span class="keywordflow">break</span>;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ab0dafdbade8ba317f975bcfaab19fb48">MTEX_DIFF</a>:
<a name="l01568"></a>01568         in= facm*out + fact*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tex-out);
<a name="l01569"></a>01569         <span class="keywordflow">break</span>;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af3f59fa4c5b02ed3d935c8f1b7dae6b4">MTEX_DARK</a>:
<a name="l01572"></a>01572         col= fact*tex;
<a name="l01573"></a>01573         <span class="keywordflow">if</span> (col &lt; out) in= col; <span class="keywordflow">else</span> in= out;
<a name="l01574"></a>01574         <span class="keywordflow">break</span>;
<a name="l01575"></a>01575 
<a name="l01576"></a>01576     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0115564f6c905ecb82ce7083aac5a2f3">MTEX_LIGHT</a>:
<a name="l01577"></a>01577         col= fact*tex;
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (col &gt; out) in= col; <span class="keywordflow">else</span> in= out;
<a name="l01579"></a>01579         <span class="keywordflow">break</span>;
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#acda1e4c8f7761a632083a514027855f1">MTEX_SOFT_LIGHT</a>: 
<a name="l01582"></a>01582         scf=1.0f - (1.0f - tex) * (1.0f - out);
<a name="l01583"></a>01583         in= facm*out + fact * ((1.0f - out) * tex * out) + (out * scf);
<a name="l01584"></a>01584         <span class="keywordflow">break</span>;       
<a name="l01585"></a>01585 
<a name="l01586"></a>01586     <span class="keywordflow">case</span> <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a8b592d169dca6d7c7e66873814726d52">MTEX_LIN_LIGHT</a>: 
<a name="l01587"></a>01587         <span class="keywordflow">if</span> (tex &gt; 0.5f)
<a name="l01588"></a>01588             in = out + fact*(2.0f*(tex - 0.5f));
<a name="l01589"></a>01589         <span class="keywordflow">else</span> 
<a name="l01590"></a>01590             in = out + fact*(2.0f*tex - 1.0f);
<a name="l01591"></a>01591         <span class="keywordflow">break</span>;
<a name="l01592"></a>01592     }
<a name="l01593"></a>01593     
<a name="l01594"></a>01594     <span class="keywordflow">return</span> in;
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01597"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">01597</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a>* shi, <a class="code" href="../../df/d2d/structTex.html">Tex</a>* tex, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a>* mtex, <span class="keywordtype">float</span>* <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span>* dx, <span class="keywordtype">float</span>* dy, <span class="keywordtype">float</span>* texvec, <span class="keywordtype">float</span>* dxt, <span class="keywordtype">float</span>* dyt)
<a name="l01598"></a>01598 {
<a name="l01599"></a>01599     <span class="comment">// new: first swap coords, then map, then trans/scale</span>
<a name="l01600"></a>01600     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l01601"></a>01601         <span class="comment">// placement</span>
<a name="l01602"></a>01602         texvec[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> ? co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1] : 0.f;
<a name="l01603"></a>01603         texvec[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> ? co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1] : 0.f;
<a name="l01604"></a>01604         texvec[2] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> ? co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1] : 0.f;
<a name="l01605"></a>01605 
<a name="l01606"></a>01606         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l01607"></a>01607             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) {
<a name="l01608"></a>01608                 dxt[0] = dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1];
<a name="l01609"></a>01609                 dyt[0] = dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1];
<a name="l01610"></a>01610             }
<a name="l01611"></a>01611             <span class="keywordflow">else</span> dxt[0] = dyt[0] = 0.f;
<a name="l01612"></a>01612             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) {
<a name="l01613"></a>01613                 dxt[1] = dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1];
<a name="l01614"></a>01614                 dyt[1] = dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1];
<a name="l01615"></a>01615             }
<a name="l01616"></a>01616             <span class="keywordflow">else</span> dxt[1] = dyt[1] = 0.f;
<a name="l01617"></a>01617             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) {
<a name="l01618"></a>01618                 dxt[2] = dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1];
<a name="l01619"></a>01619                 dyt[2] = dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1];
<a name="l01620"></a>01620             }
<a name="l01621"></a>01621             <span class="keywordflow">else</span> dxt[2] = dyt[2] = 0.f;
<a name="l01622"></a>01622         }
<a name="l01623"></a>01623         <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1febf510d3abe003af69a46e5d59a3b8">facenor</a>, dxt, dyt);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625         <span class="comment">// translate and scale</span>
<a name="l01626"></a>01626         texvec[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(texvec[0] - 0.5f) + mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0] + 0.5f;
<a name="l01627"></a>01627         texvec[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(texvec[1] - 0.5f) + mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1] + 0.5f;
<a name="l01628"></a>01628         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l01629"></a>01629             dxt[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dxt[0];
<a name="l01630"></a>01630             dxt[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dxt[1];
<a name="l01631"></a>01631             dyt[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dyt[0];
<a name="l01632"></a>01632             dyt[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dyt[1];
<a name="l01633"></a>01633         }
<a name="l01634"></a>01634         
<a name="l01635"></a>01635         <span class="comment">/* problem: repeat-mirror is not a &#39;repeat&#39; but &#39;extend&#39; in imagetexture.c */</span>
<a name="l01636"></a>01636         <span class="comment">// TXF: bug was here, only modify texvec when repeat mode set, old code affected other modes too.</span>
<a name="l01637"></a>01637         <span class="comment">// New texfilters solve mirroring differently so that it also works correctly when</span>
<a name="l01638"></a>01638         <span class="comment">// textures are scaled (sizeXYZ) as well as repeated. See also modification in do_2d_mapping().</span>
<a name="l01639"></a>01639         <span class="comment">// (since currently only done in osa mode, results will look incorrect without osa TODO) </span>
<a name="l01640"></a>01640         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3b51e69442cbdc880028b9e8c7d1b29">TEX_REPEAT_XMIR</a>)) {
<a name="l01641"></a>01641             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a95c4c1619f7b35365a1352603de03ab5">TXF_BOX</a>)
<a name="l01642"></a>01642                 texvec[0] -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(texvec[0]); <span class="comment">// this line equivalent to old code, same below</span>
<a name="l01643"></a>01643             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texvec[0] &lt; 0.f || texvec[0] &gt; 1.f) {
<a name="l01644"></a>01644                 <span class="keyword">const</span> <span class="keywordtype">float</span> tx = 0.5f*texvec[0];
<a name="l01645"></a>01645                 texvec[0] = 2.f*(tx - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(tx));
<a name="l01646"></a>01646                 <span class="keywordflow">if</span> (texvec[0] &gt; 1.f) texvec[0] = 2.f - texvec[0];
<a name="l01647"></a>01647             }
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad82e336d2f6265f9b521d16e7e105568">extend</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a62cd592404cc5c5ce712a415db44ec61">TEX_REPEAT</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a100f3a4871658621820db4d77f133440">TEX_REPEAT_YMIR</a>)) {
<a name="l01650"></a>01650             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8c8d67b564ada6d587d5900b17244f59">texfilter</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a95c4c1619f7b35365a1352603de03ab5">TXF_BOX</a>)
<a name="l01651"></a>01651                 texvec[1] -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(texvec[1]);
<a name="l01652"></a>01652             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texvec[1] &lt; 0.f || texvec[1] &gt; 1.f) {
<a name="l01653"></a>01653                 <span class="keyword">const</span> <span class="keywordtype">float</span> ty = 0.5f*texvec[1];
<a name="l01654"></a>01654                 texvec[1] = 2.f*(ty - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(ty));
<a name="l01655"></a>01655                 <span class="keywordflow">if</span> (texvec[1] &gt; 1.f) texvec[1] = 2.f - texvec[1];
<a name="l01656"></a>01656             }
<a name="l01657"></a>01657         }
<a name="l01658"></a>01658         
<a name="l01659"></a>01659     }
<a name="l01660"></a>01660     <span class="keywordflow">else</span> {  <span class="comment">// procedural</span>
<a name="l01661"></a>01661         <span class="comment">// placement</span>
<a name="l01662"></a>01662         texvec[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> ? (co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1] + mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]) : mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l01663"></a>01663         texvec[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> ? (co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1] + mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]) : mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l01664"></a>01664         texvec[2] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> ? (co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1] + mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]) : mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l01665"></a>01665 
<a name="l01666"></a>01666         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l01667"></a>01667             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) {
<a name="l01668"></a>01668                 dxt[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1];
<a name="l01669"></a>01669                 dyt[0] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> - 1];
<a name="l01670"></a>01670             }
<a name="l01671"></a>01671             <span class="keywordflow">else</span> dxt[0] = dyt[0] = 0.f;
<a name="l01672"></a>01672             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) {
<a name="l01673"></a>01673                 dxt[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1];
<a name="l01674"></a>01674                 dyt[1] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> - 1];
<a name="l01675"></a>01675             }
<a name="l01676"></a>01676             <span class="keywordflow">else</span> dxt[1] = dyt[1] = 0.f;
<a name="l01677"></a>01677             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) {
<a name="l01678"></a>01678                 dxt[2] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1];
<a name="l01679"></a>01679                 dyt[2] = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> - 1];
<a name="l01680"></a>01680             }
<a name="l01681"></a>01681             <span class="keywordflow">else</span> dxt[2]= dyt[2] = 0.f;
<a name="l01682"></a>01682         }
<a name="l01683"></a>01683     }
<a name="l01684"></a>01684 }
<a name="l01685"></a>01685 
<a name="l01686"></a>01686 <span class="comment">/* Bump code from 2.5 development cycle, has a number of bugs, but here for compatibility */</span>
<a name="l01687"></a>01687 
<a name="l01688"></a><a class="code" href="../../d1/d24/structCompatibleBump.html">01688</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d24/structCompatibleBump.html">CompatibleBump</a> {
<a name="l01689"></a><a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">01689</a>     <span class="keywordtype">float</span> <a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[3], <a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[3], <a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[3];
<a name="l01690"></a><a class="code" href="../../d1/d24/structCompatibleBump.html#af6be5a6561b2ffe88b2550bb8ae07cfc">01690</a>     <span class="keywordtype">float</span> <a class="code" href="../../d1/d24/structCompatibleBump.html#a773e09d16a8cbbb25a940890f5d21ac8">dudnu</a>, <a class="code" href="../../d1/d24/structCompatibleBump.html#a89a305d91385d723cd77f03d7dde5a1e">dudnv</a>, <a class="code" href="../../d1/d24/structCompatibleBump.html#a765a3504c76f992e8e92aa6f2741e1cf">dvdnu</a>, <a class="code" href="../../d1/d24/structCompatibleBump.html#af6be5a6561b2ffe88b2550bb8ae07cfc">dvdnv</a>;
<a name="l01691"></a><a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">01691</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">nunvdone</a>;
<a name="l01692"></a>01692 } <a class="code" href="../../db/d0d/render__texture_8c.html#afa1ca5602daadd9532f88d07fe0c5104">CompatibleBump</a>;
<a name="l01693"></a>01693 
<a name="l01694"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a12e571b58126ce888b4752820eed96c3">01694</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a12e571b58126ce888b4752820eed96c3">compatible_bump_init</a>(<a class="code" href="../../d1/d24/structCompatibleBump.html">CompatibleBump</a> *compat_bump)
<a name="l01695"></a>01695 {
<a name="l01696"></a>01696     memset(compat_bump, 0, <span class="keyword">sizeof</span>(*compat_bump));
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a773e09d16a8cbbb25a940890f5d21ac8">dudnu</a> = 1.0f;
<a name="l01699"></a>01699     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#af6be5a6561b2ffe88b2550bb8ae07cfc">dvdnv</a> = 1.0f;
<a name="l01700"></a>01700 }
<a name="l01701"></a>01701 
<a name="l01702"></a><a class="code" href="../../db/d0d/render__texture_8c.html#af9757aa03350e0490a58966a60042851">01702</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#af9757aa03350e0490a58966a60042851">compatible_bump_uv_derivs</a>(<a class="code" href="../../d1/d24/structCompatibleBump.html">CompatibleBump</a> *compat_bump, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l01703"></a>01703 {
<a name="l01704"></a>01704     <span class="comment">// uvmapping only, calculation of normal tangent u/v partial derivatives</span>
<a name="l01705"></a>01705     <span class="comment">// (should not be here, dudnu, dudnv, dvdnu &amp; dvdnv should probably be part of ShadeInputUV struct,</span>
<a name="l01706"></a>01706     <span class="comment">//  nu/nv in ShadeInput and this calculation should then move to shadeinput.c, shade_input_set_shade_texco() func.)</span>
<a name="l01707"></a>01707     <span class="comment">// NOTE: test for shi-&gt;obr-&gt;ob here, since vlr/obr/obi can be &#39;fake&#39; when called from fastshade(), another reason to move it..</span>
<a name="l01708"></a>01708     <span class="comment">// NOTE: shi-&gt;v1 is NULL when called from displace_render_vert, assigning verts in this case is not trivial because the shi quad face side is not know.</span>
<a name="l01709"></a>01709     <span class="keywordflow">if</span> ((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a34c38b251780f8c3229cd389f0fe6dfa">MTEX_COMPAT_BUMP</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>) {
<a name="l01710"></a>01710         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a98aa925aecdf5a9af3e1bb8968b4f2df">MAP_NORM</a>|<a class="code" href="../../de/db2/DNA__material__types_8h.html#a54f3d3d4d03b347951224821aa887f36">MAP_WARP</a>) &amp;&amp; !((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>))) {
<a name="l01711"></a>01711             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>* tf = <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac29f5d3a694d97a68d9fbc98437c9dca">RE_vlakren_get_tface</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, i, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01712"></a>01712             <span class="keywordtype">int</span> j1 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af7277a2aeb6b3e50b72ca0eaee2a977b">i1</a>, j2 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a62c9a0621a82b989601a6648ddbaabf2">i2</a>, j3 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a466a4d58a6483e64b667dfb6f2419e66">i3</a>;
<a name="l01713"></a>01713 
<a name="l01714"></a>01714             <a class="code" href="../../da/d3d/shading_8h.html#a9c2e2e22e2f1209117daaeb118b386ea">vlr_set_uv_indices</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, &amp;j1, &amp;j2, &amp;j3);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716             <span class="comment">// compute ortho basis around normal</span>
<a name="l01717"></a>01717             <span class="keywordflow">if</span> (!compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">nunvdone</a>) {
<a name="l01718"></a>01718                 <span class="comment">// render normal is negated</span>
<a name="l01719"></a>01719                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[0] = -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l01720"></a>01720                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[1] = -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l01721"></a>01721                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[2] = -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l01722"></a>01722                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>);
<a name="l01723"></a>01723                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">nunvdone</a>= 1;
<a name="l01724"></a>01724             }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726             <span class="keywordflow">if</span> (tf) {
<a name="l01727"></a>01727                 <span class="keywordtype">float</span> *uv1 = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[j1], *uv2 = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[j2], *uv3 = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[j3];
<a name="l01728"></a>01728                 <span class="keyword">const</span> <span class="keywordtype">float</span> an[3] = {<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[1]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[2])};
<a name="l01729"></a>01729                 <span class="keyword">const</span> <span class="keywordtype">int</span> a1 = (an[0] &gt; an[1] &amp;&amp; an[0] &gt; an[2]) ? 1 : 0;
<a name="l01730"></a>01730                 <span class="keyword">const</span> <span class="keywordtype">int</span> a2 = (an[2] &gt; an[0] &amp;&amp; an[2] &gt; an[1]) ? 1 : 2;
<a name="l01731"></a>01731                 <span class="keyword">const</span> <span class="keywordtype">float</span> dp1_a1 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a1] - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a1];
<a name="l01732"></a>01732                 <span class="keyword">const</span> <span class="keywordtype">float</span> dp1_a2 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a2] - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a2];
<a name="l01733"></a>01733                 <span class="keyword">const</span> <span class="keywordtype">float</span> dp2_a1 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a1] - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a1];
<a name="l01734"></a>01734                 <span class="keyword">const</span> <span class="keywordtype">float</span> dp2_a2 = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a2] - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>[a2];
<a name="l01735"></a>01735                 <span class="keyword">const</span> <span class="keywordtype">float</span> du1 = uv1[0] - uv3[0], du2 = uv2[0] - uv3[0];
<a name="l01736"></a>01736                 <span class="keyword">const</span> <span class="keywordtype">float</span> dv1 = uv1[1] - uv3[1], dv2 = uv2[1] - uv3[1];
<a name="l01737"></a>01737                 <span class="keyword">const</span> <span class="keywordtype">float</span> dpdu_a1 = dv2*dp1_a1 - dv1*dp2_a1;
<a name="l01738"></a>01738                 <span class="keyword">const</span> <span class="keywordtype">float</span> dpdu_a2 = dv2*dp1_a2 - dv1*dp2_a2;
<a name="l01739"></a>01739                 <span class="keyword">const</span> <span class="keywordtype">float</span> dpdv_a1 = du1*dp2_a1 - du2*dp1_a1;
<a name="l01740"></a>01740                 <span class="keyword">const</span> <span class="keywordtype">float</span> dpdv_a2 = du1*dp2_a2 - du2*dp1_a2;
<a name="l01741"></a>01741                 <span class="keywordtype">float</span> d = dpdu_a1*dpdv_a2 - dpdv_a1*dpdu_a2;
<a name="l01742"></a>01742                 <span class="keywordtype">float</span> uvd = du1*dv2 - dv1*du2;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744                 <span class="keywordflow">if</span> (uvd == 0.f) uvd = 1e-5f;
<a name="l01745"></a>01745                 <span class="keywordflow">if</span> (d == 0.f) d = 1e-5f;
<a name="l01746"></a>01746                 d = uvd / d;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a773e09d16a8cbbb25a940890f5d21ac8">dudnu</a> = (dpdv_a2*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[a1] - dpdv_a1*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[a2])*d;
<a name="l01749"></a>01749                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a765a3504c76f992e8e92aa6f2741e1cf">dvdnu</a> = (dpdu_a1*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[a2] - dpdu_a2*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[a1])*d;
<a name="l01750"></a>01750                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a89a305d91385d723cd77f03d7dde5a1e">dudnv</a> = (dpdv_a2*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[a1] - dpdv_a1*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[a2])*d;
<a name="l01751"></a>01751                 compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#af6be5a6561b2ffe88b2550bb8ae07cfc">dvdnv</a> = (dpdu_a1*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[a2] - dpdu_a2*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[a1])*d;
<a name="l01752"></a>01752             }
<a name="l01753"></a>01753         }
<a name="l01754"></a>01754     }
<a name="l01755"></a>01755 }
<a name="l01756"></a>01756 
<a name="l01757"></a><a class="code" href="../../db/d0d/render__texture_8c.html#aa30eba984d79c7ed74604bcc7b8e0ea2">01757</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#aa30eba984d79c7ed74604bcc7b8e0ea2">compatible_bump_compute</a>(<a class="code" href="../../d1/d24/structCompatibleBump.html">CompatibleBump</a> *compat_bump, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keywordtype">float</span> Tnor, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *dx, <span class="keywordtype">float</span> *dy, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt)
<a name="l01758"></a>01758 {
<a name="l01759"></a>01759     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> ttexr = {0, 0, 0, 0, 0, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};    <span class="comment">// temp TexResult</span>
<a name="l01760"></a>01760     <span class="keywordtype">float</span> tco[3], texv[3], cd, ud, vd, du, dv, idu, idv;
<a name="l01761"></a>01761     <span class="keyword">const</span> <span class="keywordtype">int</span> fromrgb = ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) || ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a27ca5c0471d318e9195d90305cd52011">TEX_COLORBAND</a>)!=0));
<a name="l01762"></a>01762     <span class="keyword">const</span> <span class="keywordtype">float</span> bf = -0.04f*Tnor*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0eec064756d3176e805049adb245cf29">norfac</a>;
<a name="l01763"></a>01763     <span class="keywordtype">int</span> rgbnor;
<a name="l01764"></a>01764     <span class="comment">// disable internal bump eval</span>
<a name="l01765"></a>01765     <span class="keywordtype">float</span>* nvec = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>;
<a name="l01766"></a>01766     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01767"></a>01767     <span class="comment">// du &amp; dv estimates, constant value defaults</span>
<a name="l01768"></a>01768     du = dv = 0.01f;
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="comment">// compute ortho basis around normal</span>
<a name="l01771"></a>01771     <span class="keywordflow">if</span> (!compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">nunvdone</a>) {
<a name="l01772"></a>01772         <span class="comment">// render normal is negated</span>
<a name="l01773"></a>01773         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01774"></a>01774         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a95b7613e67751dd3734921135b3d620a">ortho_basis_v3v3_v3</a>(compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>);
<a name="l01775"></a>01775         compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a96f7e5b7d1f2d96e3443017dffbc7a83">nunvdone</a>= 1;
<a name="l01776"></a>01776     }
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     <span class="comment">// two methods, either constant based on main image resolution,</span>
<a name="l01779"></a>01779     <span class="comment">// (which also works without osa, though of course not always good (or even very bad) results),</span>
<a name="l01780"></a>01780     <span class="comment">// or based on tex derivative max values (osa only). Not sure which is best...</span>
<a name="l01781"></a>01781 
<a name="l01782"></a>01782     <span class="keywordflow">if</span> (!shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a> &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>) {
<a name="l01783"></a>01783         <span class="comment">// in case we have no proper derivatives, fall back to</span>
<a name="l01784"></a>01784         <span class="comment">// computing du/dv it based on image size</span>
<a name="l01785"></a>01785         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l01786"></a>01786         <span class="keywordflow">if</span> (ibuf) {
<a name="l01787"></a>01787             du = 1.f/(float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01788"></a>01788             dv = 1.f/(<span class="keywordtype">float</span>)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01789"></a>01789         }
<a name="l01790"></a>01790     }
<a name="l01791"></a>01791     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l01792"></a>01792         <span class="comment">// we have derivatives, can compute proper du/dv</span>
<a name="l01793"></a>01793         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {   <span class="comment">// 2d image, use u &amp; v max. of dx/dy 2d vecs</span>
<a name="l01794"></a>01794             <span class="keyword">const</span> <span class="keywordtype">float</span> adx[2] = {<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx[1])};
<a name="l01795"></a>01795             <span class="keyword">const</span> <span class="keywordtype">float</span> ady[2] = {<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy[1])};
<a name="l01796"></a>01796             du = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(adx[0], ady[0]);
<a name="l01797"></a>01797             dv = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(adx[1], ady[1]);
<a name="l01798"></a>01798         }
<a name="l01799"></a>01799         <span class="keywordflow">else</span> {  <span class="comment">// 3d procedural, estimate from all dx/dy elems</span>
<a name="l01800"></a>01800             <span class="keyword">const</span> <span class="keywordtype">float</span> adx[3] = {<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx[1]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx[2])};
<a name="l01801"></a>01801             <span class="keyword">const</span> <span class="keywordtype">float</span> ady[3] = {<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy[1]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy[2])};
<a name="l01802"></a>01802             du = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(adx[0], adx[1], adx[2]);
<a name="l01803"></a>01803             dv = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(ady[0], ady[1], ady[2]);
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805     }
<a name="l01806"></a>01806 
<a name="l01807"></a>01807     <span class="comment">// center, main return value</span>
<a name="l01808"></a>01808     <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l01809"></a>01809     rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texvec, dxt, dyt, texres);
<a name="l01810"></a>01810     cd = fromrgb ? (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*0.33333333f : texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>) {
<a name="l01813"></a>01813         <span class="comment">// for the uv case, use the same value for both du/dv,</span>
<a name="l01814"></a>01814         <span class="comment">// since individually scaling the normal derivatives makes them useless...</span>
<a name="l01815"></a>01815         du = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(du, dv);
<a name="l01816"></a>01816         idu = (du &lt; 1e-5f) ? bf : (bf/du);
<a name="l01817"></a>01817 
<a name="l01818"></a>01818         <span class="comment">// +u val</span>
<a name="l01819"></a>01819         tco[0] = co[0] + compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a773e09d16a8cbbb25a940890f5d21ac8">dudnu</a>*du;
<a name="l01820"></a>01820         tco[1] = co[1] + compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a765a3504c76f992e8e92aa6f2741e1cf">dvdnu</a>*du;
<a name="l01821"></a>01821         tco[2] = 0.f;
<a name="l01822"></a>01822         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, tco, dx, dy, texv, dxt, dyt);
<a name="l01823"></a>01823         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texv, dxt, dyt, &amp;ttexr);
<a name="l01824"></a>01824         ud = idu*(cd - (fromrgb ? (ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*0.33333333f : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>));
<a name="l01825"></a>01825 
<a name="l01826"></a>01826         <span class="comment">// +v val</span>
<a name="l01827"></a>01827         tco[0] = co[0] + compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a89a305d91385d723cd77f03d7dde5a1e">dudnv</a>*du;
<a name="l01828"></a>01828         tco[1] = co[1] + compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#af6be5a6561b2ffe88b2550bb8ae07cfc">dvdnv</a>*du;
<a name="l01829"></a>01829         tco[2] = 0.f;
<a name="l01830"></a>01830         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, tco, dx, dy, texv, dxt, dyt);
<a name="l01831"></a>01831         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texv, dxt, dyt, &amp;ttexr);
<a name="l01832"></a>01832         vd = idu*(cd - (fromrgb ? (ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*0.33333333f : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>));
<a name="l01833"></a>01833     }
<a name="l01834"></a>01834     <span class="keywordflow">else</span> {
<a name="l01835"></a>01835         <span class="keywordtype">float</span> tu[3], tv[3];
<a name="l01836"></a>01836 
<a name="l01837"></a>01837         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tu, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>);
<a name="l01838"></a>01838         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tv, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>);
<a name="l01839"></a>01839 
<a name="l01840"></a>01840         idu = (du &lt; 1e-5f) ? bf : (bf/du);
<a name="l01841"></a>01841         idv = (dv &lt; 1e-5f) ? bf : (bf/dv);
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         <span class="keywordflow">if</span> ((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) {
<a name="l01844"></a>01844             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tu);
<a name="l01845"></a>01845             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tv);
<a name="l01846"></a>01846             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tu);
<a name="l01847"></a>01847             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tv);
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) {
<a name="l01850"></a>01850             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv, tu);
<a name="l01851"></a>01851             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv, tv);
<a name="l01852"></a>01852         }
<a name="l01853"></a>01853         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a> &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>) {
<a name="l01854"></a>01854             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tu);
<a name="l01855"></a>01855             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tv);
<a name="l01856"></a>01856             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tu);
<a name="l01857"></a>01857             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(tv);
<a name="l01858"></a>01858         }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860         <span class="comment">// +u val</span>
<a name="l01861"></a>01861         tco[0] = co[0] + tu[0]*du;
<a name="l01862"></a>01862         tco[1] = co[1] + tu[1]*du;
<a name="l01863"></a>01863         tco[2] = co[2] + tu[2]*du;
<a name="l01864"></a>01864         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, tco, dx, dy, texv, dxt, dyt);
<a name="l01865"></a>01865         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texv, dxt, dyt, &amp;ttexr);
<a name="l01866"></a>01866         ud = idu*(cd - (fromrgb ? (ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*0.33333333f : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>));
<a name="l01867"></a>01867 
<a name="l01868"></a>01868         <span class="comment">// +v val</span>
<a name="l01869"></a>01869         tco[0] = co[0] + tv[0]*dv;
<a name="l01870"></a>01870         tco[1] = co[1] + tv[1]*dv;
<a name="l01871"></a>01871         tco[2] = co[2] + tv[2]*dv;
<a name="l01872"></a>01872         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, tco, dx, dy, texv, dxt, dyt);
<a name="l01873"></a>01873         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texv, dxt, dyt, &amp;ttexr);
<a name="l01874"></a>01874         vd = idv*(cd - (fromrgb ? (ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*0.33333333f : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>));
<a name="l01875"></a>01875     }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877     <span class="comment">// bumped normal</span>
<a name="l01878"></a>01878     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[0] += ud*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[0];
<a name="l01879"></a>01879     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[1] += ud*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[1];
<a name="l01880"></a>01880     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>[2] += ud*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[2];
<a name="l01881"></a>01881     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[0] += vd*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[0];
<a name="l01882"></a>01882     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[1] += vd*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[1];
<a name="l01883"></a>01883     compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>[2] += vd*compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a7cd6f6fb11cc8673cdd49833d1093c93">nn</a>[2];
<a name="l01884"></a>01884     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(nvec, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a3636ca3a7fad9db3c135d8b26515eab9">nu</a>, compat_bump-&gt;<a class="code" href="../../d1/d24/structCompatibleBump.html#a4f10697ffd6d061400cddf8bee750676">nv</a>);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886     nvec[0] = -nvec[0];
<a name="l01887"></a>01887     nvec[1] = -nvec[1];
<a name="l01888"></a>01888     nvec[2] = -nvec[2];
<a name="l01889"></a>01889     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> = nvec;
<a name="l01890"></a>01890 
<a name="l01891"></a>01891     rgbnor |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l01892"></a>01892     <span class="keywordflow">return</span> rgbnor;
<a name="l01893"></a>01893 }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895 <span class="comment">/* Improved bump code from later in 2.5 development cycle */</span>
<a name="l01896"></a>01896 
<a name="l01897"></a><a class="code" href="../../d5/dde/structNTapBump.html">01897</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/dde/structNTapBump.html">NTapBump</a> {
<a name="l01898"></a><a class="code" href="../../d5/dde/structNTapBump.html#a85066666aefd4041eb869a6e63df029f">01898</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dde/structNTapBump.html#a85066666aefd4041eb869a6e63df029f">init_done</a>;
<a name="l01899"></a><a class="code" href="../../d5/dde/structNTapBump.html#a43a6446968927fb5efec0089d8c4c720">01899</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dde/structNTapBump.html#a43a6446968927fb5efec0089d8c4c720">iPrevBumpSpace</a>; <span class="comment">// 0: uninitialized, 1: objectspace, 2: texturespace, 4: viewspace</span>
<a name="l01900"></a>01900     <span class="comment">// bumpmapping</span>
<a name="l01901"></a><a class="code" href="../../d5/dde/structNTapBump.html#a9fff35e8e81e59c9bce4a5039ac17ac5">01901</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dde/structNTapBump.html#a9fff35e8e81e59c9bce4a5039ac17ac5">vNorg</a>[3]; <span class="comment">// backup copy of shi-&gt;vn</span>
<a name="l01902"></a><a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">01902</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">vNacc</a>[3]; <span class="comment">// original surface normal minus the surface gradient of every bump map which is encountered</span>
<a name="l01903"></a><a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">01903</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a>[3], <a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">vR2</a>[3]; <span class="comment">// cross products (sigma_y, original_normal), (original_normal, sigma_x)</span>
<a name="l01904"></a><a class="code" href="../../d5/dde/structNTapBump.html#af18703d3d194e155e4da485202d2d8d1">01904</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dde/structNTapBump.html#af18703d3d194e155e4da485202d2d8d1">sgn_det</a>; <span class="comment">// sign of the determinant of the matrix {sigma_x, sigma_y, original_normal}</span>
<a name="l01905"></a><a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">01905</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">fPrevMagnitude</a>; <span class="comment">// copy of previous magnitude, used for multiple bumps in different spaces</span>
<a name="l01906"></a>01906 } <a class="code" href="../../db/d0d/render__texture_8c.html#acc8da31691c30df569d1fc82be68acf6">NTapBump</a>;
<a name="l01907"></a>01907 
<a name="l01908"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a8a33935c6b4eb254d0efc344003fd3c5">01908</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a8a33935c6b4eb254d0efc344003fd3c5">ntap_bump_init</a>(<a class="code" href="../../d5/dde/structNTapBump.html">NTapBump</a> *ntap_bump)
<a name="l01909"></a>01909 {
<a name="l01910"></a>01910     memset(ntap_bump, 0, <span class="keyword">sizeof</span>(*ntap_bump));
<a name="l01911"></a>01911 }
<a name="l01912"></a>01912 
<a name="l01913"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a20f81dc10484a80cc14a81510378ca03">01913</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a20f81dc10484a80cc14a81510378ca03">ntap_bump_compute</a>(<a class="code" href="../../d5/dde/structNTapBump.html">NTapBump</a> *ntap_bump, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres, <span class="keywordtype">float</span> Tnor, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *dx, <span class="keywordtype">float</span> *dy, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt)
<a name="l01914"></a>01914 {
<a name="l01915"></a>01915     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> ttexr = {0, 0, 0, 0, 0, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};    <span class="comment">// temp TexResult</span>
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     <span class="keyword">const</span> <span class="keywordtype">int</span> fromrgb = ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) || ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa3d72a0e7a943da508e3f4c1cd1803e7">flag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a27ca5c0471d318e9195d90305cd52011">TEX_COLORBAND</a>)!=0));
<a name="l01918"></a>01918 
<a name="l01919"></a>01919     <span class="comment">// The negate on Hscale is done because the</span>
<a name="l01920"></a>01920     <span class="comment">// normal in the renderer points inward which corresponds</span>
<a name="l01921"></a>01921     <span class="comment">// to inverting the bump map. The normals are generated</span>
<a name="l01922"></a>01922     <span class="comment">// this way in calc_vertexnormals(). Should this ever change</span>
<a name="l01923"></a>01923     <span class="comment">// this negate must be removed.</span>
<a name="l01924"></a>01924     <span class="keywordtype">float</span> Hscale = -Tnor*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0eec064756d3176e805049adb245cf29">norfac</a>;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="keywordtype">int</span> dimx=512, dimy=512;
<a name="l01927"></a>01927     <span class="keyword">const</span> <span class="keywordtype">int</span> imag_tspace_dimension_x = 1024;       <span class="comment">// only used for texture space variant</span>
<a name="l01928"></a>01928     <span class="keywordtype">float</span> aspect = 1.0f;
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     <span class="comment">// 2 channels for 2D texture and 3 for 3D textures.</span>
<a name="l01931"></a>01931     <span class="keyword">const</span> <span class="keywordtype">int</span> nr_channels = (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>)? 2 : 3;
<a name="l01932"></a>01932     <span class="keywordtype">int</span> c, rgbnor, iBumpSpace;
<a name="l01933"></a>01933     <span class="keywordtype">float</span> dHdx, dHdy;
<a name="l01934"></a>01934     <span class="keywordtype">int</span> found_deriv_map = (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adbcb8af95ecbbd7682b7dfc521960f17">TEX_DERIVATIVEMAP</a>);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936     <span class="comment">// disable internal bump eval in sampler, save pointer</span>
<a name="l01937"></a>01937     <span class="keywordtype">float</span> *nvec = texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>;
<a name="l01938"></a>01938     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     <span class="keywordflow">if</span> (found_deriv_map==0) {
<a name="l01941"></a>01941         <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abcea1fd3a04643afb7aa5223ab6f52c1">MTEX_BUMP_TEXTURESPACE</a> ) {
<a name="l01942"></a>01942             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>)
<a name="l01943"></a>01943                 Hscale *= 13.0f; <span class="comment">// appears to be a sensible default value</span>
<a name="l01944"></a>01944         }
<a name="l01945"></a>01945         <span class="keywordflow">else</span>
<a name="l01946"></a>01946             Hscale *= 0.1f; <span class="comment">// factor 0.1 proved to look like the previous bump code</span>
<a name="l01947"></a>01947     }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949     <span class="keywordflow">if</span> ( !ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a85066666aefd4041eb869a6e63df029f">init_done</a> ) {
<a name="l01950"></a>01950         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">vNacc</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01951"></a>01951         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a9fff35e8e81e59c9bce4a5039ac17ac5">vNorg</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l01952"></a>01952         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">fPrevMagnitude</a> = 1.0f;
<a name="l01953"></a>01953         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a43a6446968927fb5efec0089d8c4c720">iPrevBumpSpace</a> = 0;
<a name="l01954"></a>01954         
<a name="l01955"></a>01955         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a85066666aefd4041eb869a6e63df029f">init_done</a> = 1;
<a name="l01956"></a>01956     }
<a name="l01957"></a>01957 
<a name="l01958"></a>01958     <span class="comment">// resolve image dimensions</span>
<a name="l01959"></a>01959     <span class="keywordflow">if</span> (found_deriv_map || (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a>&amp;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abcea1fd3a04643afb7aa5223ab6f52c1">MTEX_BUMP_TEXTURESPACE</a>)!=0) {
<a name="l01960"></a>01960         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a>* ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l01961"></a>01961         <span class="keywordflow">if</span> (ibuf) {
<a name="l01962"></a>01962             dimx = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01963"></a>01963             dimy = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01964"></a>01964             aspect = ((float) dimy) / dimx;
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966     }
<a name="l01967"></a>01967     
<a name="l01968"></a>01968     <span class="keywordflow">if</span> (found_deriv_map) {
<a name="l01969"></a>01969         <span class="keywordtype">float</span> dBdu, dBdv, auto_bump = 1.0f;
<a name="l01970"></a>01970         <span class="keywordtype">float</span> s = 1;        <span class="comment">// negate this if flipped texture coordinate</span>
<a name="l01971"></a>01971         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l01972"></a>01972         rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texvec, dxt, dyt, texres);
<a name="l01973"></a>01973 
<a name="l01974"></a>01974         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>) {
<a name="l01975"></a>01975             auto_bump = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa480cce78cce6112e4501d533beb76c1">auto_bump_scale</a>;
<a name="l01976"></a>01976         }
<a name="l01977"></a>01977 
<a name="l01978"></a>01978         {
<a name="l01979"></a>01979             <span class="keywordtype">float</span> fVirtDim = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>((<span class="keywordtype">float</span>) (dimx*dimy)*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]));
<a name="l01980"></a>01980             auto_bump /= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(fVirtDim, FLT_EPSILON);
<a name="l01981"></a>01981         }
<a name="l01982"></a>01982         
<a name="l01983"></a>01983         <span class="comment">// this variant using a derivative map is described here</span>
<a name="l01984"></a>01984         <span class="comment">// http://mmikkelsen3d.blogspot.com/2011/07/derivative-maps.html</span>
<a name="l01985"></a>01985         dBdu = auto_bump*Hscale*dimx*(2*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>-1);
<a name="l01986"></a>01986         dBdv = auto_bump*Hscale*dimy*(2*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>-1);
<a name="l01987"></a>01987 
<a name="l01988"></a>01988         dHdx = dBdu*dxt[0] + s * dBdv*dxt[1];
<a name="l01989"></a>01989         dHdy = dBdu*dyt[0] + s * dBdv*dyt[1];
<a name="l01990"></a>01990     }
<a name="l01991"></a>01991     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a1f8878bf24b88c6e4b978f0a3dc58a4b">MTEX_5TAP_BUMP</a>)) {
<a name="l01992"></a>01992         <span class="comment">// compute height derivatives with respect to output image pixel coordinates x and y</span>
<a name="l01993"></a>01993         <span class="keywordtype">float</span> STll[3], STlr[3], STul[3];
<a name="l01994"></a>01994         <span class="keywordtype">float</span> Hll, Hlr, Hul;
<a name="l01995"></a>01995 
<a name="l01996"></a>01996         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l01997"></a>01997 
<a name="l01998"></a>01998         <span class="keywordflow">for</span> (c=0; c&lt;nr_channels; c++) {
<a name="l01999"></a>01999             <span class="comment">// dx contains the derivatives (du/dx, dv/dx)</span>
<a name="l02000"></a>02000             <span class="comment">// dy contains the derivatives (du/dy, dv/dy)</span>
<a name="l02001"></a>02001             STll[c] = texvec[c];
<a name="l02002"></a>02002             STlr[c] = texvec[c]+dxt[c];
<a name="l02003"></a>02003             STul[c] = texvec[c]+dyt[c];
<a name="l02004"></a>02004         }
<a name="l02005"></a>02005 
<a name="l02006"></a>02006         <span class="comment">// clear unused derivatives</span>
<a name="l02007"></a>02007         <span class="keywordflow">for</span> (c=nr_channels; c&lt;3; c++) {
<a name="l02008"></a>02008             STll[c] = 0.0f;
<a name="l02009"></a>02009             STlr[c] = 0.0f;
<a name="l02010"></a>02010             STul[c] = 0.0f;
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012 
<a name="l02013"></a>02013         <span class="comment">// use texres for the center sample, set rgbnor</span>
<a name="l02014"></a>02014         rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STll, dxt, dyt, texres);
<a name="l02015"></a>02015         Hll = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02016"></a>02016 
<a name="l02017"></a>02017         <span class="comment">// use ttexr for the other 2 taps</span>
<a name="l02018"></a>02018         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STlr, dxt, dyt, &amp;ttexr);
<a name="l02019"></a>02019         Hlr = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02020"></a>02020 
<a name="l02021"></a>02021         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STul, dxt, dyt, &amp;ttexr);
<a name="l02022"></a>02022         Hul = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024         dHdx = Hscale*(Hlr - Hll);
<a name="l02025"></a>02025         dHdy = Hscale*(Hul - Hll);
<a name="l02026"></a>02026     }
<a name="l02027"></a>02027     <span class="keywordflow">else</span> {
<a name="l02028"></a>02028         <span class="comment">/* same as above, but doing 5 taps, increasing quality at cost of speed */</span>
<a name="l02029"></a>02029         <span class="keywordtype">float</span> STc[3], STl[3], STr[3], STd[3], STu[3];
<a name="l02030"></a>02030         <span class="keywordtype">float</span> <span class="comment">/* Hc, */</span> <span class="comment">/* UNUSED */</span>  Hl, Hr, Hd, Hu;
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l02033"></a>02033 
<a name="l02034"></a>02034         <span class="keywordflow">for</span> (c=0; c&lt;nr_channels; c++) {
<a name="l02035"></a>02035             STc[c] = texvec[c];
<a name="l02036"></a>02036             STl[c] = texvec[c] - 0.5f*dxt[c];
<a name="l02037"></a>02037             STr[c] = texvec[c] + 0.5f*dxt[c];
<a name="l02038"></a>02038             STd[c] = texvec[c] - 0.5f*dyt[c];
<a name="l02039"></a>02039             STu[c] = texvec[c] + 0.5f*dyt[c];
<a name="l02040"></a>02040         }
<a name="l02041"></a>02041 
<a name="l02042"></a>02042         <span class="comment">// clear unused derivatives</span>
<a name="l02043"></a>02043         <span class="keywordflow">for</span> (c=nr_channels; c&lt;3; c++) {
<a name="l02044"></a>02044             STc[c] = 0.0f;
<a name="l02045"></a>02045             STl[c] = 0.0f;
<a name="l02046"></a>02046             STr[c] = 0.0f;
<a name="l02047"></a>02047             STd[c] = 0.0f;
<a name="l02048"></a>02048             STu[c] = 0.0f;
<a name="l02049"></a>02049         }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051         <span class="comment">// use texres for the center sample, set rgbnor</span>
<a name="l02052"></a>02052         rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STc, dxt, dyt, texres);
<a name="l02053"></a>02053         <span class="comment">/* Hc = (fromrgb)? RGBTOBW(texres-&gt;tr, texres-&gt;tg, texres-&gt;tb) : texres-&gt;tin; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02054"></a>02054 
<a name="l02055"></a>02055         <span class="comment">// use ttexr for the other taps</span>
<a name="l02056"></a>02056         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STl, dxt, dyt, &amp;ttexr);
<a name="l02057"></a>02057         Hl = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02058"></a>02058         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STr, dxt, dyt, &amp;ttexr);
<a name="l02059"></a>02059         Hr = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02060"></a>02060         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STd, dxt, dyt, &amp;ttexr);
<a name="l02061"></a>02061         Hd = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02062"></a>02062         <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, STu, dxt, dyt, &amp;ttexr);
<a name="l02063"></a>02063         Hu = (fromrgb)? <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a895bc07a6c54d1de0e287f68b7ff27df">RGBTOBW</a>(ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>, ttexr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>) : ttexr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065         dHdx = Hscale*(Hr - Hl);
<a name="l02066"></a>02066         dHdy = Hscale*(Hu - Hd);
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069     <span class="comment">// restore pointer</span>
<a name="l02070"></a>02070     texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> = nvec;
<a name="l02071"></a>02071 
<a name="l02072"></a>02072     <span class="comment">/* replaced newbump with code based on listing 1 and 2 of</span>
<a name="l02073"></a>02073 <span class="comment">     * [Mik10] Mikkelsen M. S.: Bump Mapping Unparametrized Surfaces on the GPU.</span>
<a name="l02074"></a>02074 <span class="comment">     * -&gt; http://jbit.net/~sparky/sfgrad_bump/mm_sfgrad_bump.pdf */</span>
<a name="l02075"></a>02075 
<a name="l02076"></a>02076     <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a32deda6621ccfb3490fd2f7d7924566a">MTEX_BUMP_OBJECTSPACE</a> )
<a name="l02077"></a>02077         iBumpSpace = 1;
<a name="l02078"></a>02078     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abcea1fd3a04643afb7aa5223ab6f52c1">MTEX_BUMP_TEXTURESPACE</a> )
<a name="l02079"></a>02079         iBumpSpace = 2;
<a name="l02080"></a>02080     <span class="keywordflow">else</span>
<a name="l02081"></a>02081         iBumpSpace = 4; <span class="comment">// ViewSpace</span>
<a name="l02082"></a>02082     
<a name="l02083"></a>02083     <span class="keywordflow">if</span> ( ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a43a6446968927fb5efec0089d8c4c720">iPrevBumpSpace</a> != iBumpSpace ) {
<a name="l02084"></a>02084         
<a name="l02085"></a>02085         <span class="comment">// initialize normal perturbation vectors</span>
<a name="l02086"></a>02086         <span class="keywordtype">int</span> xyz;
<a name="l02087"></a>02087         <span class="keywordtype">float</span> fDet, abs_fDet, fMagnitude;
<a name="l02088"></a>02088         <span class="comment">// object2view and inverted matrix</span>
<a name="l02089"></a>02089         <span class="keywordtype">float</span> obj2view[3][3], view2obj[3][3], tmp[4][4];
<a name="l02090"></a>02090         <span class="comment">// local copies of derivatives and normal</span>
<a name="l02091"></a>02091         <span class="keywordtype">float</span> dPdx[3], dPdy[3], vN[3];
<a name="l02092"></a>02092         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dPdx, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>);
<a name="l02093"></a>02093         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dPdy, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l02094"></a>02094         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vN, ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a9fff35e8e81e59c9bce4a5039ac17ac5">vNorg</a>);
<a name="l02095"></a>02095         
<a name="l02096"></a>02096         <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a32deda6621ccfb3490fd2f7d7924566a">MTEX_BUMP_OBJECTSPACE</a> ) {
<a name="l02097"></a>02097             <span class="comment">// TODO: these calculations happen for every pixel!</span>
<a name="l02098"></a>02098             <span class="comment">//  -&gt; move to shi-&gt;obi</span>
<a name="l02099"></a>02099             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(tmp, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewmat, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02100"></a>02100             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(obj2view, tmp); <span class="comment">// use only upper left 3x3 matrix</span>
<a name="l02101"></a>02101             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(view2obj, obj2view);
<a name="l02102"></a>02102         
<a name="l02103"></a>02103             <span class="comment">// generate the surface derivatives in object space</span>
<a name="l02104"></a>02104             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(view2obj, dPdx);
<a name="l02105"></a>02105             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>( view2obj, dPdy );
<a name="l02106"></a>02106             <span class="comment">// generate the unit normal in object space</span>
<a name="l02107"></a>02107             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0ce5d2c9c86dbf7fb4cb3822de3fa751">mul_transposed_m3_v3</a>( obj2view, vN );
<a name="l02108"></a>02108             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vN);
<a name="l02109"></a>02109         }
<a name="l02110"></a>02110         
<a name="l02111"></a>02111         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a>, dPdy, vN);
<a name="l02112"></a>02112         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">vR2</a>, vN, dPdx);
<a name="l02113"></a>02113         fDet = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dPdx, ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a>);
<a name="l02114"></a>02114         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#af18703d3d194e155e4da485202d2d8d1">sgn_det</a> = (fDet &lt; 0)? -1.0f: 1.0f;
<a name="l02115"></a>02115         abs_fDet = ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#af18703d3d194e155e4da485202d2d8d1">sgn_det</a> * fDet;
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abcea1fd3a04643afb7aa5223ab6f52c1">MTEX_BUMP_TEXTURESPACE</a> ) {
<a name="l02118"></a>02118             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>) {
<a name="l02119"></a>02119                 <span class="comment">// crazy hack solution that gives results similar to normal mapping - part 1</span>
<a name="l02120"></a>02120                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a>);
<a name="l02121"></a>02121                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">vR2</a>);
<a name="l02122"></a>02122                 abs_fDet = 1.0f;
<a name="l02123"></a>02123             }
<a name="l02124"></a>02124         }
<a name="l02125"></a>02125         
<a name="l02126"></a>02126         fMagnitude = abs_fDet;
<a name="l02127"></a>02127         <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a32deda6621ccfb3490fd2f7d7924566a">MTEX_BUMP_OBJECTSPACE</a> ) {
<a name="l02128"></a>02128             <span class="comment">// pre do transform of texres-&gt;nor by the inverse transposed of obj2view</span>
<a name="l02129"></a>02129             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0ce5d2c9c86dbf7fb4cb3822de3fa751">mul_transposed_m3_v3</a>( view2obj, vN );
<a name="l02130"></a>02130             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0ce5d2c9c86dbf7fb4cb3822de3fa751">mul_transposed_m3_v3</a>( view2obj, ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a> );
<a name="l02131"></a>02131             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0ce5d2c9c86dbf7fb4cb3822de3fa751">mul_transposed_m3_v3</a>( view2obj, ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">vR2</a> );
<a name="l02132"></a>02132             
<a name="l02133"></a>02133             fMagnitude *= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vN);
<a name="l02134"></a>02134         }
<a name="l02135"></a>02135         
<a name="l02136"></a>02136         <span class="keywordflow">if</span> (ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">fPrevMagnitude</a> &gt; 0.0f)
<a name="l02137"></a>02137             <span class="keywordflow">for</span> (xyz=0; xyz&lt;3; xyz++)
<a name="l02138"></a>02138                 ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">vNacc</a>[xyz] *= fMagnitude / ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">fPrevMagnitude</a>;
<a name="l02139"></a>02139         
<a name="l02140"></a>02140         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a51ed93419219670eff85669bf88e9028">fPrevMagnitude</a> = fMagnitude;
<a name="l02141"></a>02141         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a43a6446968927fb5efec0089d8c4c720">iPrevBumpSpace</a> = iBumpSpace;
<a name="l02142"></a>02142     }
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#abcea1fd3a04643afb7aa5223ab6f52c1">MTEX_BUMP_TEXTURESPACE</a> ) {
<a name="l02145"></a>02145         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>) {
<a name="l02146"></a>02146             <span class="comment">// crazy hack solution that gives results similar to normal mapping - part 2</span>
<a name="l02147"></a>02147             <span class="keywordtype">float</span> vec[2];
<a name="l02148"></a>02148             <span class="keyword">const</span> <span class="keywordtype">float</span> imag_tspace_dimension_y = aspect*imag_tspace_dimension_x;
<a name="l02149"></a>02149             
<a name="l02150"></a>02150             vec[0] = imag_tspace_dimension_x*dxt[0];
<a name="l02151"></a>02151             vec[1] = imag_tspace_dimension_y*dxt[1];
<a name="l02152"></a>02152             dHdx *= 1.0f/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(vec);
<a name="l02153"></a>02153             vec[0] = imag_tspace_dimension_x*dyt[0];
<a name="l02154"></a>02154             vec[1] = imag_tspace_dimension_y*dyt[1];
<a name="l02155"></a>02155             dHdy *= 1.0f/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(vec);
<a name="l02156"></a>02156         }
<a name="l02157"></a>02157     }
<a name="l02158"></a>02158     
<a name="l02159"></a>02159     <span class="comment">// subtract the surface gradient from vNacc</span>
<a name="l02160"></a>02160     <span class="keywordflow">for</span> (c=0; c&lt;3; c++) {
<a name="l02161"></a>02161         <span class="keywordtype">float</span> vSurfGrad_compi = ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#af18703d3d194e155e4da485202d2d8d1">sgn_det</a> * (dHdx * ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a7b06a6fa050fe9ffb68ff3888515b0d7">vR1</a>[c] + dHdy * ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#aa100bdd0b937a61640f096b087f5ac7d">vR2</a>[c]);
<a name="l02162"></a>02162         ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">vNacc</a>[c] -= vSurfGrad_compi;
<a name="l02163"></a>02163         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[c] = ntap_bump-&gt;<a class="code" href="../../d5/dde/structNTapBump.html#a8a0ade001c9ece1f8edc5b6deb3dddef">vNacc</a>[c]; <span class="comment">// copy</span>
<a name="l02164"></a>02164     }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166     rgbnor |= <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>;
<a name="l02167"></a>02167     <span class="keywordflow">return</span> rgbnor;
<a name="l02168"></a>02168 }
<a name="l02169"></a>02169 
<a name="l02170"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a257380fa61fdcedbe4c3959ed9c960fd">02170</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7c/gpu__material_8c.html#ab09827a486fe37e91a118c621f94cfdd">do_material_tex</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l02171"></a>02171 {
<a name="l02172"></a>02172     <a class="code" href="../../d1/d24/structCompatibleBump.html">CompatibleBump</a> compat_bump;
<a name="l02173"></a>02173     <a class="code" href="../../d5/dde/structNTapBump.html">NTapBump</a> ntap_bump;
<a name="l02174"></a>02174     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex;
<a name="l02175"></a>02175     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l02176"></a>02176     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02177"></a>02177     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dx = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dy = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02178"></a>02178     <span class="keywordtype">float</span> fact, facm, factt, facmm, stencilTin=1.0;
<a name="l02179"></a>02179     <span class="keywordtype">float</span> texvec[3], dxt[3], dyt[3], tempvec[3], norvec[3], warpvec[3]={0.0f, 0.0f, 0.0f}, Tnor=1.0;
<a name="l02180"></a>02180     <span class="keywordtype">int</span> tex_nr, rgbnor= 0, warpdone=0;
<a name="l02181"></a>02181     <span class="keywordtype">int</span> use_compat_bump = 0, use_ntap_bump = 0;
<a name="l02182"></a>02182     <span class="keywordtype">int</span> found_nmapping = 0, found_deriv_map = 0;
<a name="l02183"></a>02183     <span class="keywordtype">int</span> iFirstTimeNMap=1;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185     <a class="code" href="../../db/d0d/render__texture_8c.html#a12e571b58126ce888b4752820eed96c3">compatible_bump_init</a>(&amp;compat_bump);
<a name="l02186"></a>02186     <a class="code" href="../../db/d0d/render__texture_8c.html#a8a33935c6b4eb254d0efc344003fd3c5">ntap_bump_init</a>(&amp;ntap_bump);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l02189"></a>02189     <span class="comment">/* here: test flag if there&#39;s a tex (todo) */</span>
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     <span class="keywordflow">for</span> (tex_nr=0; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l02192"></a>02192         
<a name="l02193"></a>02193         <span class="comment">/* separate tex switching */</span>
<a name="l02194"></a>02194         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af9e93d9aaaf44eb7c36410d3fcc53415">septex</a> &amp; (1&lt;&lt;tex_nr)) <span class="keywordflow">continue</span>;
<a name="l02195"></a>02195         
<a name="l02196"></a>02196         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr]) {
<a name="l02197"></a>02197             mtex= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr];
<a name="l02198"></a>02198             
<a name="l02199"></a>02199             tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l02200"></a>02200             <span class="keywordflow">if</span> (tex==0) <span class="keywordflow">continue</span>;
<a name="l02201"></a>02201 
<a name="l02202"></a>02202             found_deriv_map = (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adbcb8af95ecbbd7682b7dfc521960f17">TEX_DERIVATIVEMAP</a>);
<a name="l02203"></a>02203             use_compat_bump= (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a34c38b251780f8c3229cd389f0fe6dfa">MTEX_COMPAT_BUMP</a>);
<a name="l02204"></a>02204             use_ntap_bump= ((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; (<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a78d33d68b2f0fc1c737b133b85e0ab71">MTEX_3TAP_BUMP</a>|<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a1f8878bf24b88c6e4b978f0a3dc58a4b">MTEX_5TAP_BUMP</a>|<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ade8dbd4468efec6368e426d6b42f0f45">MTEX_BICUBIC_BUMP</a>))!=0 || found_deriv_map!=0) ? 1 : 0;
<a name="l02205"></a>02205 
<a name="l02206"></a>02206             <span class="comment">/* XXX texture node trees don&#39;t work for this yet */</span>
<a name="l02207"></a>02207             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ab26dc04cadfb5135b1a08047097080f1">nodetree</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a68462151f8b18293c51d8928f2d3af9c">use_nodes</a>) {
<a name="l02208"></a>02208                 use_compat_bump = 0;
<a name="l02209"></a>02209                 use_ntap_bump = 0;
<a name="l02210"></a>02210             }
<a name="l02211"></a>02211             
<a name="l02212"></a>02212             <span class="comment">/* case displacement mapping */</span>
<a name="l02213"></a>02213             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>==0 &amp;&amp; use_ntap_bump) {
<a name="l02214"></a>02214                 use_ntap_bump = 0;
<a name="l02215"></a>02215                 use_compat_bump = 1;
<a name="l02216"></a>02216             }
<a name="l02217"></a>02217             
<a name="l02218"></a>02218             <span class="comment">/* case ocean */</span>
<a name="l02219"></a>02219             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0bfbe31cefcbc95329fdcc8273fad989">TEX_OCEAN</a>) {
<a name="l02220"></a>02220                 use_ntap_bump = 0;
<a name="l02221"></a>02221                 use_compat_bump = 0;
<a name="l02222"></a>02222             }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224             <span class="comment">/* which coords */</span>
<a name="l02225"></a>02225             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>) {
<a name="l02226"></a>02226                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5dc3716f556f4e65cb94fb8e0a820afe">MTEX_DUPLI_MAPTO</a>) {
<a name="l02227"></a>02227                     co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a38bcf846931b6e6b5e6d220917f00495">duplilo</a>; dx= dxt; dy= dyt;
<a name="l02228"></a>02228                     dxt[0]= dxt[1]= dxt[2]= 0.0f;
<a name="l02229"></a>02229                     dyt[0]= dyt[1]= dyt[2]= 0.0f;
<a name="l02230"></a>02230                 }
<a name="l02231"></a>02231                 <span class="keywordflow">else</span> {
<a name="l02232"></a>02232                     co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb54b5adec3827670a144c48b94abb48">lo</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a88110d2bac2dfbb2b6c1e47ecc810aa1">dxlo</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a88aff523b69f73a900aeb39aa1bd04cb">dylo</a>;
<a name="l02233"></a>02233                 }
<a name="l02234"></a>02234             }
<a name="l02235"></a>02235             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a60edf27e1e829323a1caa8f0c2318047">TEXCO_STICKY</a>) {
<a name="l02236"></a>02236                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1481c782eba3468a124f6096ec544c32">sticky</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ade262263eed0cd241410f74213e669ed">dxsticky</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af316a5f7f7d9979096c811eafce77271">dysticky</a>;
<a name="l02237"></a>02237             }
<a name="l02238"></a>02238             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) {
<a name="l02239"></a>02239                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>;
<a name="l02240"></a>02240                 <span class="keywordflow">if</span> (ob) {
<a name="l02241"></a>02241                     co= tempvec;
<a name="l02242"></a>02242                     dx= dxt;
<a name="l02243"></a>02243                     dy= dyt;
<a name="l02244"></a>02244                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tempvec, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l02245"></a>02245                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0eb5b5e4a7831e8d9b88e672eb6f7530">MTEX_OB_DUPLI_ORIG</a>)
<a name="l02246"></a>02246                         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>)
<a name="l02247"></a>02247                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>, tempvec);
<a name="l02248"></a>02248                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tempvec);
<a name="l02249"></a>02249                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l02250"></a>02250                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dxt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>);
<a name="l02251"></a>02251                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l02252"></a>02252                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, dxt);
<a name="l02253"></a>02253                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, dyt);
<a name="l02254"></a>02254                     }
<a name="l02255"></a>02255                 }
<a name="l02256"></a>02256                 <span class="keywordflow">else</span> {
<a name="l02257"></a>02257                     <span class="comment">/* if object doesn&#39;t exist, do not use orcos (not initialized) */</span>
<a name="l02258"></a>02258                     co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l02259"></a>02259                     dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>;
<a name="l02260"></a>02260                 }
<a name="l02261"></a>02261             }
<a name="l02262"></a>02262             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a29019e3a840bac8047994ce5829b07d6">TEXCO_REFL</a>) {
<a name="l02263"></a>02263                 <a class="code" href="../../da/d3d/shading_8h.html#ad16b88e414593db21a48ef03fb93487b">calc_R_ref</a>(shi);
<a name="l02264"></a>02264                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>;
<a name="l02265"></a>02265             }
<a name="l02266"></a>02266             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#aaa5de8ec9022fb2d91875b60047eecb1">TEXCO_NORM</a>) {
<a name="l02267"></a>02267                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a26b05dc2892589038568bc54023ffda2">orn</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>;
<a name="l02268"></a>02268             }
<a name="l02269"></a>02269             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ae4ff7cbf2e23bf1c8b5b1a56642f2492">TEXCO_TANGENT</a>) {
<a name="l02270"></a>02270                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>;
<a name="l02271"></a>02271             }
<a name="l02272"></a>02272             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) {
<a name="l02273"></a>02273                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a56fc67a606b849afbbeadbfecd57ed75">dxgl</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aecbbb693eddb8698ea0f87b35b0787a3">dygl</a>;
<a name="l02274"></a>02274             }
<a name="l02275"></a>02275             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>) {
<a name="l02276"></a>02276                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5dc3716f556f4e65cb94fb8e0a820afe">MTEX_DUPLI_MAPTO</a>) {
<a name="l02277"></a>02277                     co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afc7f826ed1d5ccc38bed659c1783f888">dupliuv</a>; dx= dxt; dy= dyt;
<a name="l02278"></a>02278                     dxt[0]= dxt[1]= dxt[2]= 0.0f;
<a name="l02279"></a>02279                     dyt[0]= dyt[1]= dyt[2]= 0.0f;
<a name="l02280"></a>02280                 }
<a name="l02281"></a>02281                 <span class="keywordflow">else</span> {
<a name="l02282"></a>02282                     <a class="code" href="../../d9/dbd/structShadeInputUV.html">ShadeInputUV</a> *suv= &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac83061350468fa98d31884e34086fb78">actuv</a>];
<a name="l02283"></a>02283                     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac83061350468fa98d31884e34086fb78">actuv</a>;
<a name="l02284"></a>02284 
<a name="l02285"></a>02285                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#acd0c915b6336e1c3e1e46d19a27e9a17">uvname</a>[0] != 0) {
<a name="l02286"></a>02286                         <span class="keywordflow">for</span> (i = 0; i &lt; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7bc618e140f97186f3d736795511a6a3">totuv</a>; i++) {
<a name="l02287"></a>02287                             <span class="keywordflow">if</span> (strcmp(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[i].<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97c1ee0ff9f1462a3bd02f2352698809">name</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#acd0c915b6336e1c3e1e46d19a27e9a17">uvname</a>)==0) {
<a name="l02288"></a>02288                                 suv= &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02289"></a>02289                                 <span class="keywordflow">break</span>;
<a name="l02290"></a>02290                             }
<a name="l02291"></a>02291                         }
<a name="l02292"></a>02292                     }
<a name="l02293"></a>02293 
<a name="l02294"></a>02294                     co= suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>;
<a name="l02295"></a>02295                     dx= suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a226b73a16e9307233dff84fa985852f0">dxuv</a>;
<a name="l02296"></a>02296                     dy= suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a3f8d9c158e762344935e17c24d298160">dyuv</a>; 
<a name="l02297"></a>02297 
<a name="l02298"></a>02298                     <a class="code" href="../../db/d0d/render__texture_8c.html#af9757aa03350e0490a58966a60042851">compatible_bump_uv_derivs</a>(&amp;compat_bump, shi, mtex, i);
<a name="l02299"></a>02299                 }
<a name="l02300"></a>02300             }
<a name="l02301"></a>02301             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a27bdce2be00cc91bc2166d9f6009e0c5">TEXCO_WINDOW</a>) {
<a name="l02302"></a>02302                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a737052677e4034637bd34bd726866877">winco</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a92db76471ade2a187fea876af38102fc">dxwin</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af627350a689c6a3993ee10a33d758c6c">dywin</a>;
<a name="l02303"></a>02303             }
<a name="l02304"></a>02304             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a1af344ca05f93e8a01745fe1d7223dd8">TEXCO_STRAND</a>) {
<a name="l02305"></a>02305                 co= tempvec; dx= dxt; dy= dyt;
<a name="l02306"></a>02306                 co[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a141eb1f86a1385050d5ec3c95e00b888">strandco</a>;
<a name="l02307"></a>02307                 co[1]= co[2]= 0.0f;
<a name="l02308"></a>02308                 dx[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a04404a305b86dd723f6aa4d75a8bef62">dxstrand</a>;
<a name="l02309"></a>02309                 dx[1]= dx[2]= 0.0f;
<a name="l02310"></a>02310                 dy[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7ed52991b6be248cfddb3ca4f6f63aad">dystrand</a>;
<a name="l02311"></a>02311                 dy[1]= dy[2]= 0.0f;
<a name="l02312"></a>02312             }
<a name="l02313"></a>02313             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8f7e277845f209165fd27712f95e3fc">TEXCO_STRESS</a>) {
<a name="l02314"></a>02314                 co= tempvec; dx= dxt; dy= dyt;
<a name="l02315"></a>02315                 co[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a528a56bd337ae203b590943ff7659466">stress</a>;
<a name="l02316"></a>02316                 co[1]= co[2]= 0.0f;
<a name="l02317"></a>02317                 dx[0]= 0.0f;
<a name="l02318"></a>02318                 dx[1]= dx[2]= 0.0f;
<a name="l02319"></a>02319                 dy[0]= 0.0f;
<a name="l02320"></a>02320                 dy[1]= dy[2]= 0.0f;
<a name="l02321"></a>02321             }
<a name="l02322"></a>02322             <span class="keywordflow">else</span> <span class="keywordflow">continue</span>;  <span class="comment">// can happen when texco defines disappear and it renders old files</span>
<a name="l02323"></a>02323 
<a name="l02324"></a>02324             <span class="comment">/* the pointer defines if bumping happens */</span>
<a name="l02325"></a>02325             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a98aa925aecdf5a9af3e1bb8968b4f2df">MAP_NORM</a>|<a class="code" href="../../de/db2/DNA__material__types_8h.html#a54f3d3d4d03b347951224821aa887f36">MAP_WARP</a>)) {
<a name="l02326"></a>02326                 texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= norvec;
<a name="l02327"></a>02327                 norvec[0]= norvec[1]= norvec[2]= 0.0;
<a name="l02328"></a>02328             }
<a name="l02329"></a>02329             <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02330"></a>02330             
<a name="l02331"></a>02331             <span class="keywordflow">if</span> (warpdone) {
<a name="l02332"></a>02332                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(tempvec, co, warpvec);
<a name="l02333"></a>02333                 co= tempvec;
<a name="l02334"></a>02334             }
<a name="l02335"></a>02335 
<a name="l02336"></a>02336             <span class="comment">/* XXX texture node trees don&#39;t work for this yet */</span>
<a name="l02337"></a>02337             <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a> &amp;&amp; !((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>))) {
<a name="l02338"></a>02338                 <span class="keywordflow">if</span> (use_compat_bump) {
<a name="l02339"></a>02339                     rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#aa30eba984d79c7ed74604bcc7b8e0ea2">compatible_bump_compute</a>(&amp;compat_bump, shi, mtex, tex,
<a name="l02340"></a>02340                         &amp;texres, Tnor*stencilTin, co, dx, dy, texvec, dxt, dyt);
<a name="l02341"></a>02341                 }
<a name="l02342"></a>02342                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (use_ntap_bump) {
<a name="l02343"></a>02343                     rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a20f81dc10484a80cc14a81510378ca03">ntap_bump_compute</a>(&amp;ntap_bump, shi, mtex, tex,
<a name="l02344"></a>02344                         &amp;texres, Tnor*stencilTin, co, dx, dy, texvec, dxt, dyt);
<a name="l02345"></a>02345                 }
<a name="l02346"></a>02346                 <span class="keywordflow">else</span> {
<a name="l02347"></a>02347                     <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l02348"></a>02348                     rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texvec, dxt, dyt, &amp;texres);
<a name="l02349"></a>02349                 }
<a name="l02350"></a>02350             }
<a name="l02351"></a>02351             <span class="keywordflow">else</span> {
<a name="l02352"></a>02352                 <a class="code" href="../../db/d0d/render__texture_8c.html#ab67e03caa9601c8e959143d740347989">texco_mapping</a>(shi, tex, mtex, co, dx, dy, texvec, dxt, dyt);
<a name="l02353"></a>02353                 rgbnor = <a class="code" href="../../db/d0d/render__texture_8c.html#a5b5a828aa6e87a0a19ab02013dddc4cb">multitex_mtex</a>(shi, mtex, texvec, dxt, dyt, &amp;texres);
<a name="l02354"></a>02354             }
<a name="l02355"></a>02355 
<a name="l02356"></a>02356             <span class="comment">/* texture output */</span>
<a name="l02357"></a>02357 
<a name="l02358"></a>02358             <span class="keywordflow">if</span> ( (rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a>)) {
<a name="l02359"></a>02359                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02360"></a>02360                 rgbnor-= <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>;
<a name="l02361"></a>02361             }
<a name="l02362"></a>02362             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a>) {
<a name="l02363"></a>02363                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02364"></a>02364                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l02365"></a>02365                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l02366"></a>02366                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02367"></a>02367                 }
<a name="l02368"></a>02368                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02369"></a>02369             }
<a name="l02370"></a>02370             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aafc412fccbce3dfbec71f176755ab115">MTEX_STENCIL</a>) {
<a name="l02371"></a>02371                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02372"></a>02372                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02373"></a>02373                     texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= stencilTin;
<a name="l02374"></a>02374                     stencilTin*= fact;
<a name="l02375"></a>02375                 }
<a name="l02376"></a>02376                 <span class="keywordflow">else</span> {
<a name="l02377"></a>02377                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02378"></a>02378                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l02379"></a>02379                     stencilTin*= fact;
<a name="l02380"></a>02380                 }
<a name="l02381"></a>02381             }
<a name="l02382"></a>02382             <span class="keywordflow">else</span> {
<a name="l02383"></a>02383                 Tnor*= stencilTin;
<a name="l02384"></a>02384             }
<a name="l02385"></a>02385             
<a name="l02386"></a>02386             <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l02387"></a>02387                 <span class="keywordflow">if</span> ((rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#a102abd9fe0d1c45c3b7099188a444c58">TEX_NOR</a>)==0) {
<a name="l02388"></a>02388                     <span class="comment">/* make our own normal */</span>
<a name="l02389"></a>02389                     <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02390"></a>02390                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l02391"></a>02391                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l02392"></a>02392                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]= texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02393"></a>02393                     }
<a name="l02394"></a>02394                     <span class="keywordflow">else</span> {
<a name="l02395"></a>02395                         <span class="keywordtype">float</span> co_nor= 0.5*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>-0.5f);
<a name="l02396"></a>02396                         <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>= 0.5*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>-0.5f);
<a name="l02397"></a>02397                         <span class="keywordtype">float</span> f1, f2;
<a name="l02398"></a>02398 
<a name="l02399"></a>02399                         f1= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l02400"></a>02400                         f2= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l02401"></a>02401                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]= f1*co_nor+f2*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02402"></a>02402                         f1= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l02403"></a>02403                         f2= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l02404"></a>02404                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]= f1*co_nor+f2*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02405"></a>02405                         texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]= f2*co_nor-f1*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>;
<a name="l02406"></a>02406                     }
<a name="l02407"></a>02407                 }
<a name="l02408"></a>02408                 <span class="comment">// warping, local space</span>
<a name="l02409"></a>02409                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a54f3d3d4d03b347951224821aa887f36">MAP_WARP</a>) {
<a name="l02410"></a>02410                     <span class="keywordtype">float</span> *warpnor= texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>, warpnor_[3];
<a name="l02411"></a>02411                     
<a name="l02412"></a>02412                     <span class="keywordflow">if</span> (use_ntap_bump) {
<a name="l02413"></a>02413                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(warpnor_, texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02414"></a>02414                         warpnor= warpnor_;
<a name="l02415"></a>02415                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(warpnor_);
<a name="l02416"></a>02416                     }
<a name="l02417"></a>02417                     warpvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4e1b6ca70088db7dd9d8e73e343e10ea">warpfac</a>*warpnor[0];
<a name="l02418"></a>02418                     warpvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4e1b6ca70088db7dd9d8e73e343e10ea">warpfac</a>*warpnor[1];
<a name="l02419"></a>02419                     warpvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4e1b6ca70088db7dd9d8e73e343e10ea">warpfac</a>*warpnor[2];
<a name="l02420"></a>02420                     warpdone= 1;
<a name="l02421"></a>02421                 }
<a name="l02422"></a>02422 <span class="preprocessor">#if 0               </span>
<a name="l02423"></a>02423 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a24ae13041bb22a8c1de545091ff593f4">MTEX_VIEWSPACE</a>) {
<a name="l02424"></a>02424                     <span class="comment">// rotate to global coords</span>
<a name="l02425"></a>02425                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a> || mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>) {
<a name="l02426"></a>02426                         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) {
<a name="l02427"></a>02427                             <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02428"></a>02428                             <span class="comment">// can be optimized... (ton)</span>
<a name="l02429"></a>02429                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02430"></a>02430                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02431"></a>02431                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02432"></a>02432                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>, len);
<a name="l02433"></a>02433                         }
<a name="l02434"></a>02434                     }
<a name="l02435"></a>02435                 }
<a name="l02436"></a>02436 <span class="preprocessor">#endif              </span>
<a name="l02437"></a>02437 <span class="preprocessor"></span>            }
<a name="l02438"></a>02438 
<a name="l02439"></a>02439             <span class="comment">/* mapping */</span>
<a name="l02440"></a>02440             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#af205394e8cf1225dd1746ef3fe0c08cb">MAP_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a14f4ce1c3bd682fda8faf3e93243682b">MAP_COLSPEC</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9e22389d5148446e93c44bf98a79fb81">MAP_COLMIR</a>)) {
<a name="l02441"></a>02441                 <span class="keywordtype">float</span> tcol[3];
<a name="l02442"></a>02442                 
<a name="l02443"></a>02443                 <span class="comment">/* stencil maps on the texture control slider, not texture intensity value */</span>
<a name="l02444"></a>02444                 
<a name="l02445"></a>02445                 tcol[0]=texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>; tcol[1]=texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>; tcol[2]=texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02446"></a>02446                 
<a name="l02447"></a>02447                 <span class="keywordflow">if</span> ((rgbnor &amp; TEX_RGB)==0) {
<a name="l02448"></a>02448                     tcol[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l02449"></a>02449                     tcol[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l02450"></a>02450                     tcol[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l02451"></a>02451                 }
<a name="l02452"></a>02452                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) {
<a name="l02453"></a>02453                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= stencilTin;
<a name="l02454"></a>02454                 }
<a name="l02455"></a>02455                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02456"></a>02456                 
<a name="l02457"></a>02457                 <span class="comment">/* inverse gamma correction */</span>
<a name="l02458"></a>02458                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l02459"></a>02459                     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l02460"></a>02460                     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l02461"></a>02461                     
<a name="l02462"></a>02462                     <span class="comment">/* don&#39;t linearize float buffers, assumed to be linear */</span>
<a name="l02463"></a>02463                     <span class="keywordflow">if</span> (ibuf &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l02464"></a>02464                         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(tcol, tcol);
<a name="l02465"></a>02465                 }
<a name="l02466"></a>02466                 
<a name="l02467"></a>02467                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#af205394e8cf1225dd1746ef3fe0c08cb">MAP_COL</a>) {
<a name="l02468"></a>02468                     <span class="keywordtype">float</span> colfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a50c3aa992ec063f2e025bda4932d9671">colfac</a>*stencilTin;
<a name="l02469"></a>02469                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(&amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>, tcol, &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, colfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02470"></a>02470                 }
<a name="l02471"></a>02471                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a14f4ce1c3bd682fda8faf3e93243682b">MAP_COLSPEC</a>) {
<a name="l02472"></a>02472                     <span class="keywordtype">float</span> colspecfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#af06ed960fc34d478679a6847ae196bc1">colspecfac</a>*stencilTin;
<a name="l02473"></a>02473                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(&amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>, tcol, &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, colspecfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02474"></a>02474                 }
<a name="l02475"></a>02475                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9e22389d5148446e93c44bf98a79fb81">MAP_COLMIR</a>) {
<a name="l02476"></a>02476                     <span class="keywordtype">float</span> mirrfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa7f47775a883545533b1b0a01e00684e">mirrfac</a>*stencilTin;
<a name="l02477"></a>02477 
<a name="l02478"></a>02478                     <span class="comment">// exception for envmap only</span>
<a name="l02479"></a>02479                     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a268a78c388efb693b879d6d21d3f60c7">TEX_ENVMAP</a> &amp;&amp; mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3a8049d0db5deca0c55bbe3782ef97f">MTEX_BLEND</a>) {
<a name="l02480"></a>02480                         fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*mirrfac;
<a name="l02481"></a>02481                         facm= 1.0f- fact;
<a name="l02482"></a>02482                         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0]= fact + facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0];
<a name="l02483"></a>02483                         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[1]= fact*tcol[0] + facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[1];
<a name="l02484"></a>02484                         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[2]= fact*tcol[1] + facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[2];
<a name="l02485"></a>02485                         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[3]= fact*tcol[2] + facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[3];
<a name="l02486"></a>02486                     }
<a name="l02487"></a>02487                     <span class="keywordflow">else</span> {
<a name="l02488"></a>02488                         <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(&amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>, tcol, &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, mirrfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02489"></a>02489                     }
<a name="l02490"></a>02490                 }
<a name="l02491"></a>02491             }
<a name="l02492"></a>02492             <span class="keywordflow">if</span> ( (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a98aa925aecdf5a9af3e1bb8968b4f2df">MAP_NORM</a>) ) {
<a name="l02493"></a>02493                 <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l02494"></a>02494                     <span class="keywordtype">float</span> norfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0eec064756d3176e805049adb245cf29">norfac</a>;
<a name="l02495"></a>02495                     
<a name="l02496"></a>02496                     <span class="comment">/* we need to code blending modes for normals too once.. now 1 exception hardcoded */</span>
<a name="l02497"></a>02497                     
<a name="l02498"></a>02498                     <span class="keywordflow">if</span> ((tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) &amp;&amp; (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a2f3d295e7caaecf01e345d12d195e76e">imaflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7c7d30df56b7e8582f6a6402cfed6ff2">TEX_NORMALMAP</a>)) {
<a name="l02499"></a>02499                         
<a name="l02500"></a>02500                         found_nmapping = 1;
<a name="l02501"></a>02501                         
<a name="l02502"></a>02502                         <span class="comment">/* qdn: for normalmaps, to invert the normalmap vector,</span>
<a name="l02503"></a>02503 <span class="comment">                         * it is better to negate x &amp; y instead of subtracting the vector as was done before */</span>
<a name="l02504"></a>02504                         <span class="keywordflow">if</span> (norfac &lt; 0.0f) {
<a name="l02505"></a>02505                             texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0] = -texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l02506"></a>02506                             texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1] = -texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l02507"></a>02507                         }
<a name="l02508"></a>02508                         fact = Tnor*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(norfac);
<a name="l02509"></a>02509                         <span class="keywordflow">if</span> (fact&gt;1.f) fact = 1.f;
<a name="l02510"></a>02510                         facm = 1.f-fact;
<a name="l02511"></a>02511                         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#adb61d81e68e9c9d22a8f722ea51ef4d4">normapspace</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#adfe5660dff8846030a68938e33401aa2">MTEX_NSPACE_TANGENT</a>) {
<a name="l02512"></a>02512                             <span class="comment">/* qdn: tangent space */</span>
<a name="l02513"></a>02513                             <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a>[3], tv[3];
<a name="l02514"></a>02514                             <span class="keyword">const</span> <span class="keywordtype">float</span> * no = iFirstTimeNMap!=0 ? shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2c2e4145529a7185b8b6ef79571e84ee">nmapnorm</a> : shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>;
<a name="l02515"></a>02515                             iFirstTimeNMap=0;
<a name="l02516"></a>02516                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(B, no, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a69535a984e13265e876f7ef1e314922a">nmaptang</a>);    <span class="comment">/* bitangent */</span>
<a name="l02517"></a>02517                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(B, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a69535a984e13265e876f7ef1e314922a">nmaptang</a>[3]);
<a name="l02518"></a>02518                             <span class="comment">/* transform norvec from tangent space to object surface in camera space */</span>
<a name="l02519"></a>02519                             tv[0] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a69535a984e13265e876f7ef1e314922a">nmaptang</a>[0] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]*B[0] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]*no[0];
<a name="l02520"></a>02520                             tv[1] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a69535a984e13265e876f7ef1e314922a">nmaptang</a>[1] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]*B[1] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]*no[1];
<a name="l02521"></a>02521                             tv[2] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a69535a984e13265e876f7ef1e314922a">nmaptang</a>[2] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1]*B[2] + texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2]*no[2];
<a name="l02522"></a>02522                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]= facm*no[0] + fact*tv[0];
<a name="l02523"></a>02523                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]= facm*no[1] + fact*tv[1];
<a name="l02524"></a>02524                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]= facm*no[2] + fact*tv[2];
<a name="l02525"></a>02525                         }
<a name="l02526"></a>02526                         <span class="keywordflow">else</span> {
<a name="l02527"></a>02527                             <span class="keywordtype">float</span> nor[3];
<a name="l02528"></a>02528 
<a name="l02529"></a>02529                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nor, texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531                             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#adb61d81e68e9c9d22a8f722ea51ef4d4">normapspace</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a06aaa8d0d408d87a3f39a8d75700f493">MTEX_NSPACE_CAMERA</a>);
<a name="l02532"></a>02532                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#adb61d81e68e9c9d22a8f722ea51ef4d4">normapspace</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a292c1f73050bae90890ee9cec05b601e">MTEX_NSPACE_WORLD</a>) {
<a name="l02533"></a>02533                                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, nor);
<a name="l02534"></a>02534                             }
<a name="l02535"></a>02535                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#adb61d81e68e9c9d22a8f722ea51ef4d4">normapspace</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a79de3395cf9b7fc0062ed634e6d35396">MTEX_NSPACE_OBJECT</a>) {
<a name="l02536"></a>02536                                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>)
<a name="l02537"></a>02537                                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, nor);
<a name="l02538"></a>02538                                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, nor);
<a name="l02539"></a>02539                             }
<a name="l02540"></a>02540 
<a name="l02541"></a>02541                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l02542"></a>02542 
<a name="l02543"></a>02543                             <span class="comment">/* qdn: worldspace */</span>
<a name="l02544"></a>02544                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]= facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] + fact*nor[0];
<a name="l02545"></a>02545                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]= facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] + fact*nor[1];
<a name="l02546"></a>02546                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]= facm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2] + fact*nor[2];
<a name="l02547"></a>02547                         }
<a name="l02548"></a>02548                     }
<a name="l02549"></a>02549                     <span class="keywordflow">else</span> {
<a name="l02550"></a>02550                         <span class="comment">/* XXX texture node trees don&#39;t work for this yet */</span>
<a name="l02551"></a>02551                         <span class="keywordflow">if</span> (use_compat_bump || use_ntap_bump) {
<a name="l02552"></a>02552                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l02553"></a>02553                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l02554"></a>02554                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2] = texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l02555"></a>02555                         }
<a name="l02556"></a>02556                         <span class="keywordflow">else</span> {
<a name="l02557"></a>02557                             <span class="keywordtype">float</span> nor[3], <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>;
<a name="l02558"></a>02558     
<a name="l02559"></a>02559                             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>) {
<a name="l02560"></a>02560                                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>[0]+= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l02561"></a>02561                                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>[1]+= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l02562"></a>02562                                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>[2]+= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l02563"></a>02563                             }
<a name="l02564"></a>02564     
<a name="l02565"></a>02565                             <span class="comment">/* prevent bump to become negative normal */</span>
<a name="l02566"></a>02566                             nor[0]= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l02567"></a>02567                             nor[1]= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l02568"></a>02568                             nor[2]= Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l02569"></a>02569                             
<a name="l02570"></a>02570                             dot= 0.5f + 0.5f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l02571"></a>02571                             
<a name="l02572"></a>02572                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]+= dot*nor[0];
<a name="l02573"></a>02573                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]+= dot*nor[1];
<a name="l02574"></a>02574                             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]+= dot*nor[2];
<a name="l02575"></a>02575                         }
<a name="l02576"></a>02576                     }
<a name="l02577"></a>02577                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l02578"></a>02578                     
<a name="l02579"></a>02579                     <span class="comment">/* this makes sure the bump is passed on to the next texture */</span>
<a name="l02580"></a>02580                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a26b05dc2892589038568bc54023ffda2">orn</a>[0]= -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l02581"></a>02581                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a26b05dc2892589038568bc54023ffda2">orn</a>[1]= -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l02582"></a>02582                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a26b05dc2892589038568bc54023ffda2">orn</a>[2]= -shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l02583"></a>02583                 }
<a name="l02584"></a>02584             }
<a name="l02585"></a>02585 
<a name="l02586"></a>02586             <span class="keywordflow">if</span> ( mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a6c854338c5f616f758046219cf45b454">MAP_DISPLACE</a> ) {
<a name="l02587"></a>02587                 <span class="comment">/* Now that most textures offer both Nor and Intensity, allow  */</span>
<a name="l02588"></a>02588                 <span class="comment">/* both to work, and let user select with slider.   */</span>
<a name="l02589"></a>02589                 <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>) {
<a name="l02590"></a>02590                     <span class="keywordtype">float</span> norfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0eec064756d3176e805049adb245cf29">norfac</a>;
<a name="l02591"></a>02591 
<a name="l02592"></a>02592                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]+= 0.2f*Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[0];
<a name="l02593"></a>02593                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]+= 0.2f*Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[1];
<a name="l02594"></a>02594                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]+= 0.2f*Tnor*norfac*texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>[2];
<a name="l02595"></a>02595                 }
<a name="l02596"></a>02596                 
<a name="l02597"></a>02597                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02598"></a>02598                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02599"></a>02599                 }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601                 factt= (0.5f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>)*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab8859964ddff8c7ca6b22aff96e80b72">dispfac</a>*stencilTin; facmm= 1.0f-factt;
<a name="l02602"></a>02602 
<a name="l02603"></a>02603                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3a8049d0db5deca0c55bbe3782ef97f">MTEX_BLEND</a>) {
<a name="l02604"></a>02604                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] + facmm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0];
<a name="l02605"></a>02605                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] + facmm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1];
<a name="l02606"></a>02606                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2] + facmm*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2];
<a name="l02607"></a>02607                 }
<a name="l02608"></a>02608                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a082272727c78e320aa764225c854d1f0">MTEX_MUL</a>) {
<a name="l02609"></a>02609                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]*= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l02610"></a>02610                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]*= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l02611"></a>02611                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]*= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l02612"></a>02612                 }
<a name="l02613"></a>02613                 <span class="keywordflow">else</span> { <span class="comment">/* add or sub */</span>
<a name="l02614"></a>02614                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7a6644c61ffb76743b6ac4cd423633b5">MTEX_SUB</a>) factt= -factt;
<a name="l02615"></a>02615                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[0]+= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0];
<a name="l02616"></a>02616                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[1]+= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1];
<a name="l02617"></a>02617                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9c2485d1d5bd6eede5f45af7efa44d7">displace</a>[2]+= factt*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l02618"></a>02618                 }
<a name="l02619"></a>02619             }
<a name="l02620"></a>02620 
<a name="l02621"></a>02621             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#afba3bdabca5f842283c90b63b298fcfb">MAP_VARS</a>) {
<a name="l02622"></a>02622                 <span class="comment">/* stencil maps on the texture control slider, not texture intensity value */</span>
<a name="l02623"></a>02623                 
<a name="l02624"></a>02624                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02625"></a>02625                     <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02626"></a>02626                     <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02627"></a>02627                 }
<a name="l02628"></a>02628 
<a name="l02629"></a>02629                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#afc80d6a261c2aad5ae750e1d5c163cce">MAP_REF</a>) {
<a name="l02630"></a>02630                     <span class="keywordtype">float</span> difffac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a771d4de799fe2dfa9ebfe33709a2c9fe">difffac</a>*stencilTin;
<a name="l02631"></a>02631 
<a name="l02632"></a>02632                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, difffac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02633"></a>02633                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>= 0.0f;
<a name="l02634"></a>02634                 }
<a name="l02635"></a>02635                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ae611f4560e7b7acb33d645c437407cd4">MAP_SPEC</a>) {
<a name="l02636"></a>02636                     <span class="keywordtype">float</span> specfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7141aa945409f526feb906f752cdee1b">specfac</a>*stencilTin;
<a name="l02637"></a>02637                     
<a name="l02638"></a>02638                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, specfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02639"></a>02639                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>= 0.0f;
<a name="l02640"></a>02640                 }
<a name="l02641"></a>02641                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aadd527fd8bea6a7385879d0c9dbf9114">MAP_EMIT</a>) {
<a name="l02642"></a>02642                     <span class="keywordtype">float</span> emitfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ae142f5ebd7ec3303b40b2802a0bafed8">emitfac</a>*stencilTin;
<a name="l02643"></a>02643 
<a name="l02644"></a>02644                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, emitfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02645"></a>02645                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>= 0.0f;
<a name="l02646"></a>02646                 }
<a name="l02647"></a>02647                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) {
<a name="l02648"></a>02648                     <span class="keywordtype">float</span> alphafac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab1c4b184dbdff11ca36fc0c838d2a444">alphafac</a>*stencilTin;
<a name="l02649"></a>02649 
<a name="l02650"></a>02650                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, alphafac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02651"></a>02651                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= 0.0f;
<a name="l02652"></a>02652                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>&gt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= 1.0f;
<a name="l02653"></a>02653                 }
<a name="l02654"></a>02654                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acf19bfa4c7b6b00b31c619fab6930f8f">MAP_HAR</a>) {
<a name="l02655"></a>02655                     <span class="keywordtype">float</span> har;  <span class="comment">// have to map to 0-1</span>
<a name="l02656"></a>02656                     <span class="keywordtype">float</span> hardfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#adcc6e046c588ca0ed1e9726ceb957b56">hardfac</a>*stencilTin;
<a name="l02657"></a>02657                     
<a name="l02658"></a>02658                     har= ((float)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>)/128.0f;
<a name="l02659"></a>02659                     har= 128.0f*<a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, har, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, hardfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02660"></a>02660                     
<a name="l02661"></a>02661                     <span class="keywordflow">if</span> (har&lt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>= 1;
<a name="l02662"></a>02662                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (har&gt;511) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>= 511;
<a name="l02663"></a>02663                     <span class="keywordflow">else</span> shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>= (int)har;
<a name="l02664"></a>02664                 }
<a name="l02665"></a>02665                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#afef53ea8bfe8d51fd945f8f780837a15">MAP_RAYMIRR</a>) {
<a name="l02666"></a>02666                     <span class="keywordtype">float</span> raymirrfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#afdd1053d04ec8a354b4c5f28e6edcb40">raymirrfac</a>*stencilTin;
<a name="l02667"></a>02667 
<a name="l02668"></a>02668                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, raymirrfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02669"></a>02669                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>= 0.0f;
<a name="l02670"></a>02670                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>&gt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a336f2631b8fbc5d1aa66e5a95cc1782a">ray_mirror</a>= 1.0f;
<a name="l02671"></a>02671                 }
<a name="l02672"></a>02672                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ac864f8cbe64fe2a610d02b7542ae95f6">MAP_TRANSLU</a>) {
<a name="l02673"></a>02673                     <span class="keywordtype">float</span> translfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6905f98e365919a8894bd19cbadd3069">translfac</a>*stencilTin;
<a name="l02674"></a>02674 
<a name="l02675"></a>02675                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, translfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02676"></a>02676                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>= 0.0f;
<a name="l02677"></a>02677                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>&gt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac6d2c7028aa0996790702648621a1fdd">translucency</a>= 1.0f;
<a name="l02678"></a>02678                 }
<a name="l02679"></a>02679                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ae3bc8c879e5c1123eb7464f6c33f8e1d">MAP_AMB</a>) {
<a name="l02680"></a>02680                     <span class="keywordtype">float</span> ambfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ad3fdcaa4886bf2d4ad0e3312be7f34a7">ambfac</a>*stencilTin;
<a name="l02681"></a>02681 
<a name="l02682"></a>02682                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, ambfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02683"></a>02683                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>&lt;0.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>= 0.0f;
<a name="l02684"></a>02684                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>&gt;1.0f) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>= 1.0f;
<a name="l02685"></a>02685                     
<a name="l02686"></a>02686                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a56eee57ffdf9f02ab159afaf391f599b">ambr</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#afe57a3755ed6c82d7e6462e7bc0c0525">ambr</a>;
<a name="l02687"></a>02687                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5244edfcdbd24937cc45c832a1ed481d">ambg</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ab4b99c046006d092cf910b4df7487915">ambg</a>;
<a name="l02688"></a>02688                     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5d82ef6ebef011a44e03414609806ba3">ambb</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a6fe3448072c72656e6d96d8f775cbe40">ambb</a>;
<a name="l02689"></a>02689                 }
<a name="l02690"></a>02690             }
<a name="l02691"></a>02691         }
<a name="l02692"></a>02692     }
<a name="l02693"></a>02693     <span class="keywordflow">if</span> ((use_compat_bump || use_ntap_bump || found_nmapping) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>)!=0) {
<a name="l02694"></a>02694         <span class="keyword">const</span> <span class="keywordtype">float</span> fnegdot = -<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);
<a name="l02695"></a>02695         <span class="comment">// apply Gram-Schmidt projection</span>
<a name="l02696"></a>02696         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>,  shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, fnegdot);
<a name="l02697"></a>02697         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);
<a name="l02698"></a>02698     }
<a name="l02699"></a>02699 }
<a name="l02700"></a>02700 
<a name="l02701"></a>02701 
<a name="l02702"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a2a0f9fe085ab216c783404a3ef1e104e">02702</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">const</span> <span class="keywordtype">float</span> *xyz, <span class="keywordtype">int</span> mapto_flag, <span class="keywordtype">float</span> *col, <span class="keywordtype">float</span> *val, <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l02703"></a>02703 {
<a name="l02704"></a>02704     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex;
<a name="l02705"></a>02705     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l02706"></a>02706     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02707"></a>02707     <span class="keywordtype">int</span> tex_nr, rgbnor= 0;
<a name="l02708"></a>02708     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], texvec[3];
<a name="l02709"></a>02709     <span class="keywordtype">float</span> fact, stencilTin=1.0;
<a name="l02710"></a>02710     
<a name="l02711"></a>02711     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l02712"></a>02712     <span class="comment">/* here: test flag if there&#39;s a tex (todo) */</span>
<a name="l02713"></a>02713     
<a name="l02714"></a>02714     <span class="keywordflow">for</span> (tex_nr=0; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l02715"></a>02715         <span class="comment">/* separate tex switching */</span>
<a name="l02716"></a>02716         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af9e93d9aaaf44eb7c36410d3fcc53415">septex</a> &amp; (1&lt;&lt;tex_nr)) <span class="keywordflow">continue</span>;
<a name="l02717"></a>02717         
<a name="l02718"></a>02718         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr]) {
<a name="l02719"></a>02719             mtex= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr];
<a name="l02720"></a>02720             tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l02721"></a>02721             <span class="keywordflow">if</span> (tex==0) <span class="keywordflow">continue</span>;
<a name="l02722"></a>02722             
<a name="l02723"></a>02723             <span class="comment">/* only process if this texture is mapped </span>
<a name="l02724"></a>02724 <span class="comment">             * to one that we&#39;re interested in */</span>
<a name="l02725"></a>02725             <span class="keywordflow">if</span> (!(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; mapto_flag)) <span class="keywordflow">continue</span>;
<a name="l02726"></a>02726             
<a name="l02727"></a>02727             <span class="comment">/* which coords */</span>
<a name="l02728"></a>02728             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) {
<a name="l02729"></a>02729                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>;
<a name="l02730"></a>02730                 <span class="keywordflow">if</span> (ob) {
<a name="l02731"></a>02731                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co, xyz);
<a name="l02732"></a>02732                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0eb5b5e4a7831e8d9b88e672eb6f7530">MTEX_OB_DUPLI_ORIG</a>) {
<a name="l02733"></a>02733                         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>)
<a name="l02734"></a>02734                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a36b8dd033ce85cb14c1ad24f3ca4d71d">duplitexmat</a>, co);                   
<a name="l02735"></a>02735                     } 
<a name="l02736"></a>02736                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, co);
<a name="l02737"></a>02737                 }
<a name="l02738"></a>02738             }
<a name="l02739"></a>02739             <span class="comment">/* not really orco, but &#39;local&#39; */</span>
<a name="l02740"></a>02740             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>) {
<a name="l02741"></a>02741                 
<a name="l02742"></a>02742                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5dc3716f556f4e65cb94fb8e0a820afe">MTEX_DUPLI_MAPTO</a>) {
<a name="l02743"></a>02743                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a38bcf846931b6e6b5e6d220917f00495">duplilo</a>);
<a name="l02744"></a>02744                 }
<a name="l02745"></a>02745                 <span class="keywordflow">else</span> {
<a name="l02746"></a>02746                     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a>;
<a name="l02747"></a>02747                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co, xyz);
<a name="l02748"></a>02748                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, co);
<a name="l02749"></a>02749                 }
<a name="l02750"></a>02750             }
<a name="l02751"></a>02751             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) {
<a name="l02752"></a>02752                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(co, xyz);
<a name="l02753"></a>02753                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, co);
<a name="l02754"></a>02754             }
<a name="l02755"></a>02755             <span class="keywordflow">else</span> <span class="keywordflow">continue</span>;  <span class="comment">// can happen when texco defines disappear and it renders old files</span>
<a name="l02756"></a>02756 
<a name="l02757"></a>02757             texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02758"></a>02758             
<a name="l02759"></a>02759             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l02760"></a>02760                 <span class="keywordflow">continue</span>;   <span class="comment">/* not supported yet */</span>             
<a name="l02761"></a>02761                 <span class="comment">//do_2d_mapping(mtex, texvec, NULL, NULL, dxt, dyt);</span>
<a name="l02762"></a>02762             }
<a name="l02763"></a>02763             <span class="keywordflow">else</span> {
<a name="l02764"></a>02764                 <span class="comment">/* placement */</span>
<a name="l02765"></a>02765                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l02766"></a>02766                 <span class="keywordflow">else</span> texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l02767"></a>02767 
<a name="l02768"></a>02768                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l02769"></a>02769                 <span class="keywordflow">else</span> texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l02770"></a>02770 
<a name="l02771"></a>02771                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l02772"></a>02772                 <span class="keywordflow">else</span> texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l02773"></a>02773             }
<a name="l02774"></a>02774             
<a name="l02775"></a>02775             rgbnor= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, &amp;texres, 0, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);   <span class="comment">/* NULL = dxt/dyt, 0 = shi-&gt;osatex - not supported */</span>
<a name="l02776"></a>02776             
<a name="l02777"></a>02777             <span class="comment">/* texture output */</span>
<a name="l02778"></a>02778 
<a name="l02779"></a>02779             <span class="keywordflow">if</span> ( (rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a>)) {
<a name="l02780"></a>02780                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02781"></a>02781                 rgbnor-= <a class="code" href="../../d9/dc4/plugin_8h.html#aaa8e38ee47b6313793550136ca647de9">TEX_RGB</a>;
<a name="l02782"></a>02782             }
<a name="l02783"></a>02783             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a>) {
<a name="l02784"></a>02784                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02785"></a>02785                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l02786"></a>02786                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l02787"></a>02787                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02788"></a>02788                 }
<a name="l02789"></a>02789                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02790"></a>02790             }
<a name="l02791"></a>02791             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aafc412fccbce3dfbec71f176755ab115">MTEX_STENCIL</a>) {
<a name="l02792"></a>02792                 <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02793"></a>02793                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02794"></a>02794                     texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= stencilTin;
<a name="l02795"></a>02795                     stencilTin*= fact;
<a name="l02796"></a>02796                 }
<a name="l02797"></a>02797                 <span class="keywordflow">else</span> {
<a name="l02798"></a>02798                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02799"></a>02799                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l02800"></a>02800                     stencilTin*= fact;
<a name="l02801"></a>02801                 }
<a name="l02802"></a>02802             }
<a name="l02803"></a>02803             
<a name="l02804"></a>02804             
<a name="l02805"></a>02805             <span class="keywordflow">if</span> ((mapto_flag &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>)) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>))) {
<a name="l02806"></a>02806                 <span class="keywordtype">float</span> tcol[3];
<a name="l02807"></a>02807                 
<a name="l02808"></a>02808                 <span class="comment">/* stencil maps on the texture control slider, not texture intensity value */</span>
<a name="l02809"></a>02809                 
<a name="l02810"></a>02810                 <span class="keywordflow">if</span> ((rgbnor &amp; TEX_RGB)==0) {
<a name="l02811"></a>02811                     tcol[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l02812"></a>02812                     tcol[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l02813"></a>02813                     tcol[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l02814"></a>02814                 }
<a name="l02815"></a>02815                 <span class="keywordflow">else</span> {
<a name="l02816"></a>02816                     tcol[0]=texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l02817"></a>02817                     tcol[1]=texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l02818"></a>02818                     tcol[2]=texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02819"></a>02819                     <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>)
<a name="l02820"></a>02820                         texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02821"></a>02821                 }
<a name="l02822"></a>02822                 
<a name="l02823"></a>02823                 <span class="comment">/* used for emit */</span>
<a name="l02824"></a>02824                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>)) {
<a name="l02825"></a>02825                     <span class="keywordtype">float</span> colemitfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ac49df23d0bd8a7f21184f8488a08645a">colemitfac</a>*stencilTin;
<a name="l02826"></a>02826                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(col, tcol, col, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, colemitfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02827"></a>02827                 }
<a name="l02828"></a>02828                 
<a name="l02829"></a>02829                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_REFLECTION_COL)) {
<a name="l02830"></a>02830                     <span class="keywordtype">float</span> colreflfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7db98161b61601800c194852a5464d79">colreflfac</a>*stencilTin;
<a name="l02831"></a>02831                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(col, tcol, col, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, colreflfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02832"></a>02832                 }
<a name="l02833"></a>02833                 
<a name="l02834"></a>02834                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_TRANSMISSION_COL)) {
<a name="l02835"></a>02835                     <span class="keywordtype">float</span> coltransfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab6268d7bd2724c2b812e5f01a2f7c3e0">coltransfac</a>*stencilTin;
<a name="l02836"></a>02836                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(col, tcol, col, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, coltransfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02837"></a>02837                 }
<a name="l02838"></a>02838             }
<a name="l02839"></a>02839             
<a name="l02840"></a>02840             <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#afba3bdabca5f842283c90b63b298fcfb">MAP_VARS</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_VARS)) {
<a name="l02841"></a>02841                 <span class="comment">/* stencil maps on the texture control slider, not texture intensity value */</span>
<a name="l02842"></a>02842                 
<a name="l02843"></a>02843                 <span class="comment">/* convert RGB to intensity if intensity info isn&#39;t provided */</span>
<a name="l02844"></a>02844                 <span class="keywordflow">if</span> (!(rgbnor &amp; <a class="code" href="../../d9/dc4/plugin_8h.html#a38e52e343e873c90a8b83fe465a8756a">TEX_INT</a>)) {
<a name="l02845"></a>02845                     <span class="keywordflow">if</span> (rgbnor &amp; TEX_RGB) {
<a name="l02846"></a>02846                         <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02847"></a>02847                         <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02848"></a>02848                     }
<a name="l02849"></a>02849                 }
<a name="l02850"></a>02850                 
<a name="l02851"></a>02851                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>)) {
<a name="l02852"></a>02852                     <span class="keywordtype">float</span> emitfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ae142f5ebd7ec3303b40b2802a0bafed8">emitfac</a>*stencilTin;
<a name="l02853"></a>02853 
<a name="l02854"></a>02854                     *val = <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, *val, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, emitfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02855"></a>02855                     <span class="keywordflow">if</span> (*val&lt;0.0f) *val= 0.0f;
<a name="l02856"></a>02856                 }
<a name="l02857"></a>02857                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_DENSITY)) {
<a name="l02858"></a>02858                     <span class="keywordtype">float</span> densfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#acc827ff5217dfddf5991ec5971fac248">densfac</a>*stencilTin;
<a name="l02859"></a>02859 
<a name="l02860"></a>02860                     *val = <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, *val, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, densfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02861"></a>02861                     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(*val, 0.0f, 1.0f);
<a name="l02862"></a>02862                 }
<a name="l02863"></a>02863                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_SCATTERING)) {
<a name="l02864"></a>02864                     <span class="keywordtype">float</span> scatterfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28ceaf93956c35c0e2780dd8e65ff2b">scatterfac</a>*stencilTin;
<a name="l02865"></a>02865                     
<a name="l02866"></a>02866                     *val = <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, *val, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, scatterfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02867"></a>02867                     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(*val, 0.0f, 1.0f);
<a name="l02868"></a>02868                 }
<a name="l02869"></a>02869                 <span class="keywordflow">if</span> ((mapto_flag &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a30f1fd2b082cfd91b07340e3afbee2d7">MAP_REFLECTION</a>) &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; MAP_REFLECTION)) {
<a name="l02870"></a>02870                     <span class="keywordtype">float</span> reflfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aff784f611f628613560f8a828691500f">reflfac</a>*stencilTin;
<a name="l02871"></a>02871                     
<a name="l02872"></a>02872                     *val = <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, *val, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, reflfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l02873"></a>02873                     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(*val, 0.0f, 1.0f);
<a name="l02874"></a>02874                 }
<a name="l02875"></a>02875             }
<a name="l02876"></a>02876         }
<a name="l02877"></a>02877     }
<a name="l02878"></a>02878 }
<a name="l02879"></a>02879 
<a name="l02880"></a>02880 
<a name="l02881"></a>02881 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l02882"></a>02882 
<a name="l02883"></a><a class="code" href="../../db/d0d/render__texture_8c.html#aa46b14700081232747695cc9b5dd6709">02883</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#aabf6885dbd37f8dc9af584f71fb963ed">do_halo_tex</a>(<a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har, <span class="keywordtype">float</span> xn, <span class="keywordtype">float</span> yn, <span class="keywordtype">float</span> col_r[4])
<a name="l02884"></a>02884 {
<a name="l02885"></a>02885     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex;
<a name="l02886"></a>02886     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02887"></a>02887     <span class="keywordtype">float</span> texvec[3], dxt[3], dyt[3], fact, facm, dx;
<a name="l02888"></a>02888     <span class="keywordtype">int</span> rgb, osatex;
<a name="l02889"></a>02889 
<a name="l02890"></a>02890     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l02891"></a>02891     
<a name="l02892"></a>02892     mtex= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[0];
<a name="l02893"></a>02893     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af9e93d9aaaf44eb7c36410d3fcc53415">septex</a> &amp; (1&lt;&lt;0)) <span class="keywordflow">return</span>;
<a name="l02894"></a>02894     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l02895"></a>02895     
<a name="l02896"></a>02896     <span class="comment">/* no normal mapping */</span>
<a name="l02897"></a>02897     texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02898"></a>02898         
<a name="l02899"></a>02899     texvec[0]= xn/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>;
<a name="l02900"></a>02900     texvec[1]= yn/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>;
<a name="l02901"></a>02901     texvec[2]= 0.0;
<a name="l02902"></a>02902     
<a name="l02903"></a>02903     osatex= (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e87de29f884738db97666c1628c9de5">TEXCO_OSA</a>);
<a name="l02904"></a>02904 
<a name="l02905"></a>02905     <span class="comment">/* placement */</span>
<a name="l02906"></a>02906     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(texvec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l02907"></a>02907     <span class="keywordflow">else</span> texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l02908"></a>02908     
<a name="l02909"></a>02909     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(texvec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l02910"></a>02910     <span class="keywordflow">else</span> texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l02911"></a>02911     
<a name="l02912"></a>02912     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(texvec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l02913"></a>02913     <span class="keywordflow">else</span> texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l02914"></a>02914     
<a name="l02915"></a>02915     <span class="keywordflow">if</span> (osatex) {
<a name="l02916"></a>02916     
<a name="l02917"></a>02917         dx= 1.0f/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>;
<a name="l02918"></a>02918     
<a name="l02919"></a>02919         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) {
<a name="l02920"></a>02920             dxt[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dx;
<a name="l02921"></a>02921             dyt[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dx;
<a name="l02922"></a>02922         }
<a name="l02923"></a>02923         <span class="keywordflow">else</span> dxt[0]= dyt[0]= 0.0;
<a name="l02924"></a>02924         
<a name="l02925"></a>02925         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) {
<a name="l02926"></a>02926             dxt[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dx;
<a name="l02927"></a>02927             dyt[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dx;
<a name="l02928"></a>02928         }
<a name="l02929"></a>02929         <span class="keywordflow">else</span> dxt[1]= dyt[1]= 0.0;
<a name="l02930"></a>02930         
<a name="l02931"></a>02931         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) {
<a name="l02932"></a>02932             dxt[2]= 0.0;
<a name="l02933"></a>02933             dyt[2]= 0.0;
<a name="l02934"></a>02934         }
<a name="l02935"></a>02935         <span class="keywordflow">else</span> dxt[2]= dyt[2]= 0.0;
<a name="l02936"></a>02936 
<a name="l02937"></a>02937     }
<a name="l02938"></a>02938 
<a name="l02939"></a>02939     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dxt, dyt);
<a name="l02940"></a>02940     
<a name="l02941"></a>02941     rgb= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>, texvec, dxt, dyt, osatex, &amp;texres, 0, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     <span class="comment">/* texture output */</span>
<a name="l02944"></a>02944     <span class="keywordflow">if</span> (rgb &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a>)) {
<a name="l02945"></a>02945         texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l02946"></a>02946         rgb= 0;
<a name="l02947"></a>02947     }
<a name="l02948"></a>02948     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a>) {
<a name="l02949"></a>02949         <span class="keywordflow">if</span> (rgb) {
<a name="l02950"></a>02950             texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l02951"></a>02951             texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l02952"></a>02952             texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l02953"></a>02953         }
<a name="l02954"></a>02954         <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l02955"></a>02955     }
<a name="l02956"></a>02956 
<a name="l02957"></a>02957     <span class="comment">/* mapping */</span>
<a name="l02958"></a>02958     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#af205394e8cf1225dd1746ef3fe0c08cb">MAP_COL</a>) {
<a name="l02959"></a>02959         
<a name="l02960"></a>02960         <span class="keywordflow">if</span> (rgb==0) {
<a name="l02961"></a>02961             texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l02962"></a>02962             texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l02963"></a>02963             texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l02964"></a>02964         }
<a name="l02965"></a>02965         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) {
<a name="l02966"></a>02966             texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0;
<a name="l02967"></a>02967         }
<a name="l02968"></a>02968         <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l02969"></a>02969 
<a name="l02970"></a>02970         <span class="comment">/* inverse gamma correction */</span>
<a name="l02971"></a>02971         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l02972"></a>02972             <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l02973"></a>02973             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l02974"></a>02974             
<a name="l02975"></a>02975             <span class="comment">/* don&#39;t linearize float buffers, assumed to be linear */</span>
<a name="l02976"></a>02976             <span class="keywordflow">if</span> (ibuf &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) &amp;&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.color_mgt_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l02977"></a>02977                 <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(&amp;texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, &amp;texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>);
<a name="l02978"></a>02978         }
<a name="l02979"></a>02979 
<a name="l02980"></a>02980         fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a50c3aa992ec063f2e025bda4932d9671">colfac</a>;
<a name="l02981"></a>02981         facm= 1.0f-fact;
<a name="l02982"></a>02982         
<a name="l02983"></a>02983         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a082272727c78e320aa764225c854d1f0">MTEX_MUL</a>) {
<a name="l02984"></a>02984             facm= 1.0f-mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a50c3aa992ec063f2e025bda4932d9671">colfac</a>;
<a name="l02985"></a>02985         }
<a name="l02986"></a>02986         
<a name="l02987"></a>02987         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7a6644c61ffb76743b6ac4cd423633b5">MTEX_SUB</a>) fact= -fact;
<a name="l02988"></a>02988 
<a name="l02989"></a>02989         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac3a8049d0db5deca0c55bbe3782ef97f">MTEX_BLEND</a>) {
<a name="l02990"></a>02990             col_r[0]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + facm*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a>);
<a name="l02991"></a>02991             col_r[1]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + facm*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a>);
<a name="l02992"></a>02992             col_r[2]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> + facm*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a>);
<a name="l02993"></a>02993         }
<a name="l02994"></a>02994         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a082272727c78e320aa764225c854d1f0">MTEX_MUL</a>) {
<a name="l02995"></a>02995             col_r[0]= (facm+fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>)*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a>;
<a name="l02996"></a>02996             col_r[1]= (facm+fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>)*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a>;
<a name="l02997"></a>02997             col_r[2]= (facm+fact*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>)*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a>;
<a name="l02998"></a>02998         }
<a name="l02999"></a>02999         <span class="keywordflow">else</span> {
<a name="l03000"></a>03000             col_r[0]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a>);
<a name="l03001"></a>03001             col_r[1]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a>);
<a name="l03002"></a>03002             col_r[2]= (fact*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> + har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a>);
<a name="l03003"></a>03003             
<a name="l03004"></a>03004             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(col_r[0], 0.0f, 1.0f);
<a name="l03005"></a>03005             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(col_r[1], 0.0f, 1.0f);
<a name="l03006"></a>03006             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(col_r[2], 0.0f, 1.0f);
<a name="l03007"></a>03007         }
<a name="l03008"></a>03008     }
<a name="l03009"></a>03009     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) {
<a name="l03010"></a>03010         <span class="keywordflow">if</span> (rgb) {
<a name="l03011"></a>03011             <span class="keywordflow">if</span> (texres.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>) texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03012"></a>03012             <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l03013"></a>03013         }
<a name="l03014"></a>03014                 
<a name="l03015"></a>03015         col_r[3]*= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03016"></a>03016     }
<a name="l03017"></a>03017 }
<a name="l03018"></a>03018 
<a name="l03019"></a>03019 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03020"></a>03020 
<a name="l03021"></a>03021 <span class="comment">/* hor and zen are RGB vectors, blend is 1 float, should all be initialized */</span>
<a name="l03022"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a94cf83c880cf8e294c05af423bf2624e">03022</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#a94cf83c880cf8e294c05af423bf2624e">do_sky_tex</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> rco[3], <span class="keywordtype">float</span> lo[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dxyview[2], <span class="keywordtype">float</span> hor[3], <span class="keywordtype">float</span> zen[3], <span class="keywordtype">float</span> *<a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>, <span class="keywordtype">int</span> skyflag, <span class="keywordtype">short</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l03023"></a>03023 {
<a name="l03024"></a>03024     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex;
<a name="l03025"></a>03025     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l03026"></a>03026     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l03027"></a>03027     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, fact, stencilTin=1.0;
<a name="l03028"></a>03028     <span class="keywordtype">float</span> tempvec[3], texvec[3], dxt[3], dyt[3];
<a name="l03029"></a>03029     <span class="keywordtype">int</span> tex_nr, rgb= 0;
<a name="l03030"></a>03030     
<a name="l03031"></a>03031     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l03032"></a>03032     <span class="comment">/* todo: add flag to test if there&#39;s a tex */</span>
<a name="l03033"></a>03033     texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03034"></a>03034     
<a name="l03035"></a>03035     <span class="keywordflow">for</span> (tex_nr=0; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l03036"></a>03036         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mtex[tex_nr]) {
<a name="l03037"></a>03037             mtex= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mtex[tex_nr];
<a name="l03038"></a>03038             
<a name="l03039"></a>03039             tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l03040"></a>03040             <span class="keywordflow">if</span> (tex==0) <span class="keywordflow">continue</span>;
<a name="l03041"></a>03041             <span class="comment">/* if (mtex-&gt;mapto==0) continue; */</span>
<a name="l03042"></a>03042             
<a name="l03043"></a>03043             <span class="comment">/* which coords */</span>
<a name="l03044"></a>03044             co= lo;
<a name="l03045"></a>03045             
<a name="l03046"></a>03046             <span class="comment">/* dxt dyt just from 1 value */</span>
<a name="l03047"></a>03047             <span class="keywordflow">if</span> (dxyview) {
<a name="l03048"></a>03048                 dxt[0]= dxt[1]= dxt[2]= dxyview[0];
<a name="l03049"></a>03049                 dyt[0]= dyt[1]= dyt[2]= dxyview[1];
<a name="l03050"></a>03050             }
<a name="l03051"></a>03051             <span class="keywordflow">else</span> {
<a name="l03052"></a>03052                 dxt[0]= dxt[1]= dxt[2]= 0.0;
<a name="l03053"></a>03053                 dyt[0]= dyt[1]= dyt[2]= 0.0;
<a name="l03054"></a>03054             }
<a name="l03055"></a>03055             
<a name="l03056"></a>03056             <span class="comment">/* Grab the mapping settings for this texture */</span>
<a name="l03057"></a>03057             <span class="keywordflow">switch</span>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>) {
<a name="l03058"></a>03058             <span class="keywordflow">case</span> <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab52b2f72504f830a9456ab0c461419a9">TEXCO_ANGMAP</a>:
<a name="l03059"></a>03059                 <span class="comment">/* only works with texture being &quot;real&quot; */</span>
<a name="l03060"></a>03060                 <span class="comment">/* use saacos(), fixes bug [#22398], float precision caused lo[2] to be slightly less then -1.0 */</span>
<a name="l03061"></a>03061                 <span class="keywordflow">if</span> (lo[0] || lo[1]) { <span class="comment">/* check for zero case [#24807] */</span>
<a name="l03062"></a>03062                     fact= (1.0f/(float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>)*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(lo[2])/(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(lo[0]*lo[0] + lo[1]*lo[1]));
<a name="l03063"></a>03063                     tempvec[0]= lo[0]*fact;
<a name="l03064"></a>03064                     tempvec[1]= lo[1]*fact;
<a name="l03065"></a>03065                     tempvec[2]= 0.0;
<a name="l03066"></a>03066                 }
<a name="l03067"></a>03067                 <span class="keywordflow">else</span> {
<a name="l03068"></a>03068                     <span class="comment">/* this value has no angle, the vector is directly along the view.</span>
<a name="l03069"></a>03069 <span class="comment">                     * avoide divide by zero and use a dummy value. */</span>
<a name="l03070"></a>03070                     tempvec[0]= 1.0f;
<a name="l03071"></a>03071                     tempvec[1]= 0.0;
<a name="l03072"></a>03072                     tempvec[2]= 0.0;
<a name="l03073"></a>03073                 }
<a name="l03074"></a>03074                 co= tempvec;
<a name="l03075"></a>03075                 <span class="keywordflow">break</span>;
<a name="l03076"></a>03076                 
<a name="l03077"></a>03077             <span class="keywordflow">case</span> <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ad6855847bb98eec69f59cb9bf76b0abd">TEXCO_H_SPHEREMAP</a>:
<a name="l03078"></a>03078             <span class="keywordflow">case</span> <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a324685578f01a2ba21efd00a2cf589f1">TEXCO_H_TUBEMAP</a>:
<a name="l03079"></a>03079                 <span class="keywordflow">if</span> (skyflag &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5a28b03f5d53e0a34d098ab2a8b03eaf">WO_ZENUP</a>) {
<a name="l03080"></a>03080                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a324685578f01a2ba21efd00a2cf589f1">TEXCO_H_TUBEMAP</a>) <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>( tempvec, tempvec+1,lo[0], lo[2], lo[1]);
<a name="l03081"></a>03081                     <span class="keywordflow">else</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( tempvec, tempvec+1,lo[0], lo[2], lo[1]);
<a name="l03082"></a>03082                     <span class="comment">/* tube/spheremap maps for outside view, not inside */</span>
<a name="l03083"></a>03083                     tempvec[0]= 1.0f-tempvec[0];
<a name="l03084"></a>03084                     <span class="comment">/* only top half */</span>
<a name="l03085"></a>03085                     tempvec[1]= 2.0f*tempvec[1]-1.0f;
<a name="l03086"></a>03086                     tempvec[2]= 0.0;
<a name="l03087"></a>03087                     <span class="comment">/* and correction for do_2d_mapping */</span>
<a name="l03088"></a>03088                     tempvec[0]= 2.0f*tempvec[0]-1.0f;
<a name="l03089"></a>03089                     tempvec[1]= 2.0f*tempvec[1]-1.0f;
<a name="l03090"></a>03090                     co= tempvec;
<a name="l03091"></a>03091                 }
<a name="l03092"></a>03092                 <span class="keywordflow">else</span> {
<a name="l03093"></a>03093                     <span class="comment">/* potentially dangerous... check with multitex! */</span>
<a name="l03094"></a>03094                     <span class="keywordflow">continue</span>;
<a name="l03095"></a>03095                 }
<a name="l03096"></a>03096                 <span class="keywordflow">break</span>;
<a name="l03097"></a>03097             <span class="keywordflow">case</span> <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5761205e9ba1b4cca21a11f07110c28b">TEXCO_EQUIRECTMAP</a>:
<a name="l03098"></a>03098                 tempvec[0]= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab616618cf09fc0ef5c0ec0d9e5825f58">atan2f</a>(lo[0], lo[2]) / (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l03099"></a>03099                 tempvec[1]= 1.0f - 2.0f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(lo[1]) / (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l03100"></a>03100                 tempvec[2]= 0.0f;
<a name="l03101"></a>03101                 co= tempvec;
<a name="l03102"></a>03102                 <span class="keywordflow">break</span>;
<a name="l03103"></a>03103             <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>:
<a name="l03104"></a>03104                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>) {
<a name="l03105"></a>03105                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tempvec, lo);
<a name="l03106"></a>03106                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tempvec);
<a name="l03107"></a>03107                     co= tempvec;
<a name="l03108"></a>03108                 }
<a name="l03109"></a>03109                 <span class="keywordflow">break</span>;
<a name="l03110"></a>03110                 
<a name="l03111"></a>03111             <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>:
<a name="l03112"></a>03112                 <span class="keywordflow">if</span> (rco) {
<a name="l03113"></a>03113                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tempvec, rco);
<a name="l03114"></a>03114                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv, tempvec);
<a name="l03115"></a>03115                     co= tempvec;
<a name="l03116"></a>03116                 }
<a name="l03117"></a>03117                 <span class="keywordflow">else</span>
<a name="l03118"></a>03118                     co= lo;
<a name="l03119"></a>03119                 
<a name="l03120"></a>03120 <span class="comment">//              copy_v3_v3(shi-&gt;dxgl, shi-&gt;dxco);</span>
<a name="l03121"></a>03121 <span class="comment">//              mul_m3_v3(R.imat, shi-&gt;dxco);</span>
<a name="l03122"></a>03122 <span class="comment">//              copy_v3_v3(shi-&gt;dygl, shi-&gt;dyco);</span>
<a name="l03123"></a>03123 <span class="comment">//              mul_m3_v3(R.imat, shi-&gt;dyco);</span>
<a name="l03124"></a>03124                 <span class="keywordflow">break</span>;
<a name="l03125"></a>03125             }
<a name="l03126"></a>03126             
<a name="l03127"></a>03127             <span class="comment">/* placement */</span>         
<a name="l03128"></a>03128             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03129"></a>03129             <span class="keywordflow">else</span> texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03130"></a>03130             
<a name="l03131"></a>03131             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03132"></a>03132             <span class="keywordflow">else</span> texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03133"></a>03133             
<a name="l03134"></a>03134             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03135"></a>03135             <span class="keywordflow">else</span> texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03136"></a>03136             
<a name="l03137"></a>03137             <span class="comment">/* texture */</span>
<a name="l03138"></a>03138             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dxt, dyt);
<a name="l03139"></a>03139         
<a name="l03140"></a>03140             rgb= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>, texvec, dxt, dyt, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa, &amp;texres, thread, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);
<a name="l03141"></a>03141             
<a name="l03142"></a>03142             <span class="comment">/* texture output */</span>
<a name="l03143"></a>03143             <span class="keywordflow">if</span> (rgb &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a>)) {
<a name="l03144"></a>03144                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l03145"></a>03145                 rgb= 0;
<a name="l03146"></a>03146             }
<a name="l03147"></a>03147             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a>) {
<a name="l03148"></a>03148                 <span class="keywordflow">if</span> (rgb) {
<a name="l03149"></a>03149                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l03150"></a>03150                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l03151"></a>03151                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l03152"></a>03152                 }
<a name="l03153"></a>03153                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03154"></a>03154             }
<a name="l03155"></a>03155             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aafc412fccbce3dfbec71f176755ab115">MTEX_STENCIL</a>) {
<a name="l03156"></a>03156                 <span class="keywordflow">if</span> (rgb) {
<a name="l03157"></a>03157                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03158"></a>03158                     texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= stencilTin;
<a name="l03159"></a>03159                     stencilTin*= fact;
<a name="l03160"></a>03160                 }
<a name="l03161"></a>03161                 <span class="keywordflow">else</span> {
<a name="l03162"></a>03162                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03163"></a>03163                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l03164"></a>03164                     stencilTin*= fact;
<a name="l03165"></a>03165                 }
<a name="l03166"></a>03166             }
<a name="l03167"></a>03167             <span class="keywordflow">else</span> {
<a name="l03168"></a>03168                 <span class="keywordflow">if</span> (rgb) texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a> *= stencilTin;
<a name="l03169"></a>03169                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l03170"></a>03170             }
<a name="l03171"></a>03171             
<a name="l03172"></a>03172             <span class="comment">/* color mapping */</span>
<a name="l03173"></a>03173             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aa88b2e408d24959cdfc3cea43542c9b7">WOMAP_HORIZ</a>+<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a272018a370e2af8a600161966cdf042b">WOMAP_ZENUP</a>+<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aed935881cd37d675bab153443dbc30a3">WOMAP_ZENDOWN</a>)) {
<a name="l03174"></a>03174                 <span class="keywordtype">float</span> tcol[3];
<a name="l03175"></a>03175                 
<a name="l03176"></a>03176                 <span class="keywordflow">if</span> (rgb==0) {
<a name="l03177"></a>03177                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l03178"></a>03178                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l03179"></a>03179                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l03180"></a>03180                 }
<a name="l03181"></a>03181                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03182"></a>03182                 
<a name="l03183"></a>03183                 tcol[0]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>; tcol[1]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>; tcol[2]= texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l03184"></a>03184 
<a name="l03185"></a>03185                 <span class="comment">/* inverse gamma correction */</span>
<a name="l03186"></a>03186                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l03187"></a>03187                     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l03188"></a>03188                     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l03189"></a>03189                     
<a name="l03190"></a>03190                     <span class="comment">/* don&#39;t linearize float buffers, assumed to be linear */</span>
<a name="l03191"></a>03191                     <span class="keywordflow">if</span> (ibuf &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) &amp;&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.color_mgt_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l03192"></a>03192                         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(tcol, tcol);
<a name="l03193"></a>03193                 }
<a name="l03194"></a>03194 
<a name="l03195"></a>03195                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aa88b2e408d24959cdfc3cea43542c9b7">WOMAP_HORIZ</a>) {
<a name="l03196"></a>03196                     <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(hor, tcol, hor, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a50c3aa992ec063f2e025bda4932d9671">colfac</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l03197"></a>03197                 }
<a name="l03198"></a>03198                 <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a272018a370e2af8a600161966cdf042b">WOMAP_ZENUP</a>+<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aed935881cd37d675bab153443dbc30a3">WOMAP_ZENDOWN</a>)) {
<a name="l03199"></a>03199                     <span class="keywordtype">float</span> zenfac = 0.0f;
<a name="l03200"></a>03200 
<a name="l03201"></a>03201                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ad4022c2e675d4a4f25ea99c833bad0b8">WO_SKYREAL</a>) {
<a name="l03202"></a>03202                         <span class="keywordflow">if</span> ((skyflag &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5a28b03f5d53e0a34d098ab2a8b03eaf">WO_ZENUP</a>)) {
<a name="l03203"></a>03203                             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a272018a370e2af8a600161966cdf042b">WOMAP_ZENUP</a>) zenfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a2f101ce15edc008532e5c1c18584b3ba">zenupfac</a>;
<a name="l03204"></a>03204                         }
<a name="l03205"></a>03205                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aed935881cd37d675bab153443dbc30a3">WOMAP_ZENDOWN</a>) zenfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#abd81c48187542f62c07d4ac23e464f5e">zendownfac</a>;
<a name="l03206"></a>03206                     }
<a name="l03207"></a>03207                     <span class="keywordflow">else</span> {
<a name="l03208"></a>03208                         <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a272018a370e2af8a600161966cdf042b">WOMAP_ZENUP</a>) zenfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a2f101ce15edc008532e5c1c18584b3ba">zenupfac</a>;
<a name="l03209"></a>03209                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aed935881cd37d675bab153443dbc30a3">WOMAP_ZENDOWN</a>) zenfac= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#abd81c48187542f62c07d4ac23e464f5e">zendownfac</a>;
<a name="l03210"></a>03210                     }
<a name="l03211"></a>03211                     
<a name="l03212"></a>03212                     <span class="keywordflow">if</span> (zenfac != 0.0f)
<a name="l03213"></a>03213                         <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(zen, tcol, zen, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, zenfac, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l03214"></a>03214                 }
<a name="l03215"></a>03215             }
<a name="l03216"></a>03216             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a821137c3873605e55431e07f745931ac">WOMAP_BLEND</a>) {
<a name="l03217"></a>03217                 <span class="keywordflow">if</span> (rgb) texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l03218"></a>03218                 
<a name="l03219"></a>03219                 *blend= <a class="code" href="../../d8/d7c/gpu__material_8c.html#af94b394db47e7a314e0b744bc14ab36c">texture_value_blend</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a90e02daa4078be47f55db6e521b64b21">def_var</a>, *blend, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab3dc6c4ec20ced6ef8cd9a3f14e4025d">blendfac</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l03220"></a>03220             }
<a name="l03221"></a>03221         }
<a name="l03222"></a>03222     }
<a name="l03223"></a>03223 }
<a name="l03224"></a>03224 
<a name="l03225"></a>03225 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03226"></a>03226 <span class="comment">/* col_r supposed to be initialized with la-&gt;r,g,b */</span>
<a name="l03227"></a>03227 
<a name="l03228"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ac079886dd7f004d44fb713bce6ae4a93">03228</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#a2d34292e93e416e64d0017ed4429c6c0">do_lamp_tex</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *la, <span class="keyword">const</span> <span class="keywordtype">float</span> lavec[3], <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> col_r[3], <span class="keywordtype">int</span> effect)
<a name="l03229"></a>03229 {
<a name="l03230"></a>03230     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l03231"></a>03231     <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex;
<a name="l03232"></a>03232     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l03233"></a>03233     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texres= {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l03234"></a>03234     <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dx = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dy = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fact, stencilTin=1.0;
<a name="l03235"></a>03235     <span class="keywordtype">float</span> texvec[3], dxt[3], dyt[3], tempvec[3];
<a name="l03236"></a>03236     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, tex_nr, rgb= 0;
<a name="l03237"></a>03237     
<a name="l03238"></a>03238     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l03239"></a>03239     tex_nr= 0;
<a name="l03240"></a>03240     
<a name="l03241"></a>03241     <span class="keywordflow">for</span> (; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l03242"></a>03242         
<a name="l03243"></a>03243         <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a653926316f1da3f0b94db0c09f0b52d9">mtex</a>[tex_nr]) {
<a name="l03244"></a>03244             mtex= la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a653926316f1da3f0b94db0c09f0b52d9">mtex</a>[tex_nr];
<a name="l03245"></a>03245             
<a name="l03246"></a>03246             tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l03247"></a>03247             <span class="keywordflow">if</span> (tex==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l03248"></a>03248             texres.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03249"></a>03249             
<a name="l03250"></a>03250             <span class="comment">/* which coords */</span>
<a name="l03251"></a>03251             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) {
<a name="l03252"></a>03252                 ob= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>;
<a name="l03253"></a>03253                 <span class="keywordflow">if</span> (ob) {
<a name="l03254"></a>03254                     co= tempvec;
<a name="l03255"></a>03255                     dx= dxt;
<a name="l03256"></a>03256                     dy= dyt;
<a name="l03257"></a>03257                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tempvec, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l03258"></a>03258                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, tempvec);
<a name="l03259"></a>03259                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l03260"></a>03260                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dxt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>);
<a name="l03261"></a>03261                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l03262"></a>03262                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, dxt);
<a name="l03263"></a>03263                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, dyt);
<a name="l03264"></a>03264                     }
<a name="l03265"></a>03265                 }
<a name="l03266"></a>03266                 <span class="keywordflow">else</span> {
<a name="l03267"></a>03267                     co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l03268"></a>03268                     dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>;
<a name="l03269"></a>03269                 }
<a name="l03270"></a>03270             }
<a name="l03271"></a>03271             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>) {
<a name="l03272"></a>03272                 co= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>; dx= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>; dy= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>;
<a name="l03273"></a>03273                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l03274"></a>03274                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>);
<a name="l03275"></a>03275             }
<a name="l03276"></a>03276             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a123e75e6a8a22f7dc8a32093577e5038">TEXCO_VIEW</a>) {
<a name="l03277"></a>03277                 
<a name="l03278"></a>03278                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tempvec, lavec);
<a name="l03279"></a>03279                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, tempvec);
<a name="l03280"></a>03280                 
<a name="l03281"></a>03281                 <span class="keywordflow">if</span> (la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>) {
<a name="l03282"></a>03282                     tempvec[0]*= la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b0a00085e1c30f39892f8e066d92d0">spottexfac</a>;
<a name="l03283"></a>03283                     tempvec[1]*= la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b0a00085e1c30f39892f8e066d92d0">spottexfac</a>;
<a name="l03284"></a>03284                 <span class="comment">/* project from 3d to 2d */</span>
<a name="l03285"></a>03285                     tempvec[0] /= -tempvec[2];
<a name="l03286"></a>03286                     tempvec[1] /= -tempvec[2];
<a name="l03287"></a>03287                 }
<a name="l03288"></a>03288                 co= tempvec; 
<a name="l03289"></a>03289                 
<a name="l03290"></a>03290                 dx= dxt; dy= dyt;   
<a name="l03291"></a>03291                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l03292"></a>03292                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dxt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac90d38a2bdca62e44ab85b9a593bafbe">dxlv</a>);
<a name="l03293"></a>03293                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abae44293e402838cf8b4f631432e10d7">dylv</a>);
<a name="l03294"></a>03294                     <span class="comment">/* need some matrix conversion here? la-&gt;imat is a [3][3]  matrix!!! **/</span>
<a name="l03295"></a>03295                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, dxt);
<a name="l03296"></a>03296                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, dyt);
<a name="l03297"></a>03297                     
<a name="l03298"></a>03298                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dxt, la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b0a00085e1c30f39892f8e066d92d0">spottexfac</a>);
<a name="l03299"></a>03299                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dyt, la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b0a00085e1c30f39892f8e066d92d0">spottexfac</a>);
<a name="l03300"></a>03300                 }
<a name="l03301"></a>03301             }
<a name="l03302"></a>03302             
<a name="l03303"></a>03303             
<a name="l03304"></a>03304             <span class="comment">/* placement */</span>
<a name="l03305"></a>03305             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a> &amp;&amp; co) texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03306"></a>03306             <span class="keywordflow">else</span> texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03307"></a>03307             
<a name="l03308"></a>03308             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a> &amp;&amp; co) texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03309"></a>03309             <span class="keywordflow">else</span> texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03310"></a>03310             
<a name="l03311"></a>03311             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a> &amp;&amp; co) texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(co[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03312"></a>03312             <span class="keywordflow">else</span> texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03313"></a>03313             
<a name="l03314"></a>03314             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l03315"></a>03315                 <span class="keywordflow">if</span> (!dx) {
<a name="l03316"></a>03316                     <span class="keywordflow">for</span> (i=0;i&lt;2;i++) {
<a name="l03317"></a>03317                         dxt[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = dyt[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0;
<a name="l03318"></a>03318                     }
<a name="l03319"></a>03319                 }
<a name="l03320"></a>03320                 <span class="keywordflow">else</span> {
<a name="l03321"></a>03321                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) {
<a name="l03322"></a>03322                         dxt[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1];
<a name="l03323"></a>03323                         dyt[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1];
<a name="l03324"></a>03324                     }
<a name="l03325"></a>03325                     <span class="keywordflow">else</span> {
<a name="l03326"></a>03326                         dxt[0]= 0.0;
<a name="l03327"></a>03327                         dyt[0]= 0.0;
<a name="l03328"></a>03328                     }
<a name="l03329"></a>03329                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) {
<a name="l03330"></a>03330                         dxt[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1];
<a name="l03331"></a>03331                         dyt[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1];
<a name="l03332"></a>03332                     }
<a name="l03333"></a>03333                     <span class="keywordflow">else</span> {
<a name="l03334"></a>03334                         dxt[1]= 0.0;
<a name="l03335"></a>03335                         dyt[1]= 0.0;
<a name="l03336"></a>03336                     }
<a name="l03337"></a>03337                     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) {
<a name="l03338"></a>03338                         dxt[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*dx[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1];
<a name="l03339"></a>03339                         dyt[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*dy[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1];
<a name="l03340"></a>03340                     }
<a name="l03341"></a>03341                     <span class="keywordflow">else</span> {
<a name="l03342"></a>03342                         dxt[2]= 0.0;
<a name="l03343"></a>03343                         dyt[2]= 0.0;
<a name="l03344"></a>03344                     }
<a name="l03345"></a>03345                 }
<a name="l03346"></a>03346             }
<a name="l03347"></a>03347             
<a name="l03348"></a>03348             <span class="comment">/* texture */</span>
<a name="l03349"></a>03349             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l03350"></a>03350                 <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dxt, dyt);
<a name="l03351"></a>03351             }
<a name="l03352"></a>03352             
<a name="l03353"></a>03353             rgb= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec, dxt, dyt, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>, &amp;texres, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);
<a name="l03354"></a>03354 
<a name="l03355"></a>03355             <span class="comment">/* texture output */</span>
<a name="l03356"></a>03356             <span class="keywordflow">if</span> (rgb &amp;&amp; (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a>)) {
<a name="l03357"></a>03357                 texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l03358"></a>03358                 rgb= 0;
<a name="l03359"></a>03359             }
<a name="l03360"></a>03360             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a>) {
<a name="l03361"></a>03361                 <span class="keywordflow">if</span> (rgb) {
<a name="l03362"></a>03362                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l03363"></a>03363                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l03364"></a>03364                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l03365"></a>03365                 }
<a name="l03366"></a>03366                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 1.0f-texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03367"></a>03367             }
<a name="l03368"></a>03368             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aafc412fccbce3dfbec71f176755ab115">MTEX_STENCIL</a>) {
<a name="l03369"></a>03369                 <span class="keywordflow">if</span> (rgb) {
<a name="l03370"></a>03370                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03371"></a>03371                     texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= stencilTin;
<a name="l03372"></a>03372                     stencilTin*= fact;
<a name="l03373"></a>03373                 }
<a name="l03374"></a>03374                 <span class="keywordflow">else</span> {
<a name="l03375"></a>03375                     fact= texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03376"></a>03376                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l03377"></a>03377                     stencilTin*= fact;
<a name="l03378"></a>03378                 }
<a name="l03379"></a>03379             }
<a name="l03380"></a>03380             <span class="keywordflow">else</span> {
<a name="l03381"></a>03381                 <span class="keywordflow">if</span> (rgb) texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*= stencilTin;
<a name="l03382"></a>03382                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>*= stencilTin;
<a name="l03383"></a>03383             }
<a name="l03384"></a>03384             
<a name="l03385"></a>03385             <span class="comment">/* mapping */</span>
<a name="l03386"></a>03386             <span class="keywordflow">if</span> (((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aae63e37d7dddc407c68288610486ffd6">LAMAP_COL</a>) &amp;&amp; (effect &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>))||((mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aad74125b6ea0c029453815dbc7171a88">LAMAP_SHAD</a>) &amp;&amp; (effect &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a151fc803e1c480ea3746f302284d3b41">LA_SHAD_TEX</a>))) {
<a name="l03387"></a>03387                 <span class="keywordtype">float</span> col[3];
<a name="l03388"></a>03388                 
<a name="l03389"></a>03389                 <span class="keywordflow">if</span> (rgb==0) {
<a name="l03390"></a>03390                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l03391"></a>03391                     texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l03392"></a>03392                     texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l03393"></a>03393                 }
<a name="l03394"></a>03394                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>) {
<a name="l03395"></a>03395                     texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= stencilTin;
<a name="l03396"></a>03396                 }
<a name="l03397"></a>03397                 <span class="keywordflow">else</span> texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= texres.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03398"></a>03398 
<a name="l03399"></a>03399                 <span class="comment">/* inverse gamma correction */</span>
<a name="l03400"></a>03400                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l03401"></a>03401                     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima = tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l03402"></a>03402                     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>);
<a name="l03403"></a>03403                     
<a name="l03404"></a>03404                     <span class="comment">/* don&#39;t linearize float buffers, assumed to be linear */</span>
<a name="l03405"></a>03405                     <span class="keywordflow">if</span> (ibuf &amp;&amp; !(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) &amp;&amp; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.color_mgt_flag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l03406"></a>03406                         <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a1a32a8dcd1fca2ac08d3df36cd1adcd7">srgb_to_linearrgb_v3_v3</a>(&amp;texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>, &amp;texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>);
<a name="l03407"></a>03407                 }
<a name="l03408"></a>03408 
<a name="l03409"></a>03409                 <span class="comment">/* lamp colors were premultiplied with this */</span>
<a name="l03410"></a>03410                 col[0]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>*la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l03411"></a>03411                 col[1]= texres.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>*la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l03412"></a>03412                 col[2]= texres.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>*la-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l03413"></a>03413                 
<a name="l03414"></a>03414                 <a class="code" href="../../d8/d7c/gpu__material_8c.html#aa5a41d2468109b6ca8d4f7bb9f13c65e">texture_rgb_blend</a>(col_r, col, col_r, texres.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a50c3aa992ec063f2e025bda4932d9671">colfac</a>, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a6aacfa6bf53d67200c50a11b4662402e">blendtype</a>);
<a name="l03415"></a>03415             }
<a name="l03416"></a>03416         }
<a name="l03417"></a>03417     }
<a name="l03418"></a>03418 }
<a name="l03419"></a>03419 
<a name="l03420"></a>03420 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03421"></a>03421 
<a name="l03422"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a99aaad68492af13a1ffd18b5ff8b707d">03422</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a833cb47a92698779f8873ec22ba1fad1">externtex</a>(<a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex, <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keywordtype">float</span> *tin, <span class="keywordtype">float</span> *tr, <span class="keywordtype">float</span> *tg, <span class="keywordtype">float</span> *tb, <span class="keywordtype">float</span> *ta, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l03423"></a>03423 {
<a name="l03424"></a>03424     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l03425"></a>03425     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr;
<a name="l03426"></a>03426     <span class="keywordtype">float</span> dxt[3], dyt[3], texvec[3];
<a name="l03427"></a>03427     <span class="keywordtype">int</span> rgb;
<a name="l03428"></a>03428     
<a name="l03429"></a>03429     tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>;
<a name="l03430"></a>03430     <span class="keywordflow">if</span> (tex==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> 0;
<a name="l03431"></a>03431     texr.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03432"></a>03432     
<a name="l03433"></a>03433     <span class="comment">/* placement */</span>
<a name="l03434"></a>03434     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>) texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(vec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a73d150ce25a5958b9bb9883dc15e36b8">projx</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03435"></a>03435     <span class="keywordflow">else</span> texvec[0]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[0]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[0]);
<a name="l03436"></a>03436     
<a name="l03437"></a>03437     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>) texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(vec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a20f2b9a9fb58c2ac5be98fa2a461ca40">projy</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03438"></a>03438     <span class="keywordflow">else</span> texvec[1]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[1]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[1]);
<a name="l03439"></a>03439     
<a name="l03440"></a>03440     <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>) texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(vec[mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a313bfa927173e512fb242f1886f3d0c8">projz</a>-1]+mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03441"></a>03441     <span class="keywordflow">else</span> texvec[2]= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#accae10059528ad76fb12b21d19f7d9c1">size</a>[2]*(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a9b7596a4182c5d9c82299e9599edfe48">ofs</a>[2]);
<a name="l03442"></a>03442     
<a name="l03443"></a>03443     <span class="comment">/* texture */</span>
<a name="l03444"></a>03444     <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>) {
<a name="l03445"></a>03445         <a class="code" href="../../db/d0d/render__texture_8c.html#a61a026a098a6e956a363eb2cbddf7b81">do_2d_mapping</a>(mtex, texvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dxt, dyt);
<a name="l03446"></a>03446     }
<a name="l03447"></a>03447     
<a name="l03448"></a>03448     rgb= <a class="code" href="../../db/d0d/render__texture_8c.html#ae5345ae0e081b526adccc4d730695a6a">multitex</a>(tex, texvec, dxt, dyt, 0, &amp;texr, thread, mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a99b01f17feb6ed940e3b3a411d79aad7">which_output</a>);
<a name="l03449"></a>03449     
<a name="l03450"></a>03450     <span class="keywordflow">if</span> (rgb) {
<a name="l03451"></a>03451         texr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= (0.35f*texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>+0.45f*texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>+0.2f*texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>);
<a name="l03452"></a>03452     }
<a name="l03453"></a>03453     <span class="keywordflow">else</span> {
<a name="l03454"></a>03454         texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a7995072160c31cc3dfa6638ae818cc1f">r</a>;
<a name="l03455"></a>03455         texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a4332ebc8f8f4df1021266be6de568e5e">g</a>;
<a name="l03456"></a>03456         texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa20b1baa5206162619b13a806cdc7de4">b</a>;
<a name="l03457"></a>03457     }
<a name="l03458"></a>03458     
<a name="l03459"></a>03459     *tin= texr.<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>;
<a name="l03460"></a>03460     *tr= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l03461"></a>03461     *tg= texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l03462"></a>03462     *tb= texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l03463"></a>03463     *ta= texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03464"></a>03464 
<a name="l03465"></a>03465     <span class="keywordflow">return</span> (rgb != 0);
<a name="l03466"></a>03466 }
<a name="l03467"></a>03467 
<a name="l03468"></a>03468 
<a name="l03469"></a>03469 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l03470"></a>03470 
<a name="l03471"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ae77c37d375821037519c3ae35d80a4c2">03471</a> <span class="keywordtype">void</span> <a class="code" href="../../df/dba/texture_8h.html#aeef7f12a1673abe65be4490b02bf20f1">render_realtime_texture</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l03472"></a>03472 {
<a name="l03473"></a>03473     <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr;
<a name="l03474"></a>03474     <span class="keyword">static</span> <a class="code" href="../../df/d2d/structTex.html">Tex</a> imatex[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>]; <span class="comment">// threadsafe</span>
<a name="l03475"></a>03475     <span class="keyword">static</span> <span class="keywordtype">int</span> firsttime= 1;
<a name="l03476"></a>03476     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l03477"></a>03477     <span class="keywordtype">float</span> texvec[3], dx[2], dy[2];
<a name="l03478"></a>03478     <a class="code" href="../../d9/dbd/structShadeInputUV.html">ShadeInputUV</a> *suv= &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac83061350468fa98d31884e34086fb78">actuv</a>];
<a name="l03479"></a>03479     <span class="keywordtype">int</span> a;
<a name="l03480"></a>03480 
<a name="l03481"></a>03481     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7cd89a1370eb05b3c7ecd9dc4c854866">R_NO_TEX</a>) <span class="keywordflow">return</span>;
<a name="l03482"></a>03482 
<a name="l03483"></a>03483     <span class="keywordflow">if</span> (firsttime) {
<a name="l03484"></a>03484         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l03485"></a>03485         <span class="keywordflow">if</span> (firsttime) {
<a name="l03486"></a>03486             <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>; a++) {
<a name="l03487"></a>03487                 memset(&amp;imatex[a], 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d2d/structTex.html">Tex</a>));
<a name="l03488"></a>03488                 <a class="code" href="../../d2/d66/BKE__texture_8h.html#a6a815276a186c8908dc7c1c521ded519">default_tex</a>(&amp;imatex[a]);
<a name="l03489"></a>03489                 imatex[a].<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>= <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#af2375c975e2ce5925f9be76460a1f1c1">TEX_IMAGE</a>;
<a name="l03490"></a>03490             }
<a name="l03491"></a>03491 
<a name="l03492"></a>03492             firsttime= 0;
<a name="l03493"></a>03493         }
<a name="l03494"></a>03494         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l03495"></a>03495     }
<a name="l03496"></a>03496     
<a name="l03497"></a>03497     tex= &amp;imatex[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>];
<a name="l03498"></a>03498     tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l03499"></a>03499     
<a name="l03500"></a>03500     texvec[0]= 0.5f+0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[0];
<a name="l03501"></a>03501     texvec[1]= 0.5f+0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[1];
<a name="l03502"></a>03502     texvec[2] = 0.0f;  <span class="comment">// initalize it because imagewrap looks at it.</span>
<a name="l03503"></a>03503     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l03504"></a>03504         dx[0]= 0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a226b73a16e9307233dff84fa985852f0">dxuv</a>[0];
<a name="l03505"></a>03505         dx[1]= 0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a226b73a16e9307233dff84fa985852f0">dxuv</a>[1];
<a name="l03506"></a>03506         dy[0]= 0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a3f8d9c158e762344935e17c24d298160">dyuv</a>[0];
<a name="l03507"></a>03507         dy[1]= 0.5f*suv-&gt;<a class="code" href="../../d9/dbd/structShadeInputUV.html#a3f8d9c158e762344935e17c24d298160">dyuv</a>[1];
<a name="l03508"></a>03508     }
<a name="l03509"></a>03509     
<a name="l03510"></a>03510     texr.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03511"></a>03511     
<a name="l03512"></a>03512     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(tex, ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, texvec, dx, dy, &amp;texr);
<a name="l03513"></a>03513     <span class="keywordflow">else</span> <a class="code" href="../../df/dba/texture_8h.html#a7762aab857b2d37f53a4504f8e529d83">imagewrap</a>(tex, ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, texvec, &amp;texr); 
<a name="l03514"></a>03514 
<a name="l03515"></a>03515     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0]*= texr.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>;
<a name="l03516"></a>03516     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1]*= texr.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>;
<a name="l03517"></a>03517     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2]*= texr.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>;
<a name="l03518"></a>03518     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3]*= texr.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>;
<a name="l03519"></a>03519 }
<a name="l03520"></a>03520 
<a name="l03521"></a>03521 <span class="comment">/* A modified part of shadeinput.c -&gt; shade_input_set_uv()</span>
<a name="l03522"></a>03522 <span class="comment"> *  Used for sampling UV mapped texture color */</span>
<a name="l03523"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a128869ee6d422418cef290f7ab95cbbc">03523</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a128869ee6d422418cef290f7ab95cbbc">textured_face_generate_uv</a>(<span class="keywordtype">float</span> *uv, <span class="keywordtype">float</span> *normal, <span class="keywordtype">float</span> *hit, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3)
<a name="l03524"></a>03524 {
<a name="l03525"></a>03525 
<a name="l03526"></a>03526     <span class="keywordtype">float</span> detsh, t00, t10, t01, t11;
<a name="l03527"></a>03527     <span class="keywordtype">int</span> axis1, axis2;
<a name="l03528"></a>03528 
<a name="l03529"></a>03529     <span class="comment">/* find most stable axis to project */</span>
<a name="l03530"></a>03530     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(&amp;axis1, &amp;axis2, normal);
<a name="l03531"></a>03531 
<a name="l03532"></a>03532     <span class="comment">/* compute u,v and derivatives */</span>
<a name="l03533"></a>03533     t00= v3[axis1]-v1[axis1]; t01= v3[axis2]-v1[axis2];
<a name="l03534"></a>03534     t10= v3[axis1]-v2[axis1]; t11= v3[axis2]-v2[axis2];
<a name="l03535"></a>03535 
<a name="l03536"></a>03536     detsh= 1.0f/(t00*t11-t10*t01);
<a name="l03537"></a>03537     t00*= detsh; t01*=detsh; 
<a name="l03538"></a>03538     t10*=detsh; t11*=detsh;
<a name="l03539"></a>03539 
<a name="l03540"></a>03540     uv[0] = (hit[axis1]-v3[axis1])*t11-(hit[axis2]-v3[axis2])*t10;
<a name="l03541"></a>03541     uv[1] = (hit[axis2]-v3[axis2])*t00-(hit[axis1]-v3[axis1])*t01;
<a name="l03542"></a>03542 
<a name="l03543"></a>03543     <span class="comment">/* u and v are in range -1 to 0, we allow a little bit extra but not too much, screws up speedvectors */</span>
<a name="l03544"></a>03544     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[0], -2.0f, 1.0f);
<a name="l03545"></a>03545     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(uv[1], -2.0f, 1.0f);
<a name="l03546"></a>03546 }
<a name="l03547"></a>03547 
<a name="l03548"></a>03548 <span class="comment">/* Generate an updated copy of material to use for color sampling. */</span>
<a name="l03549"></a><a class="code" href="../../db/d0d/render__texture_8c.html#ac95193d4b54d05254c497ee1409170c4">03549</a> <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *<a class="code" href="../../d1/de4/RE__render__ext_8h.html#a26b7ee47d3fd9f490d3be2727c51d288">RE_init_sample_material</a>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *orig_mat, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l03550"></a>03550 {
<a name="l03551"></a>03551     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03552"></a>03552     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *mat;
<a name="l03553"></a>03553     <span class="keywordtype">int</span> tex_nr;
<a name="l03554"></a>03554 
<a name="l03555"></a>03555     <span class="keywordflow">if</span> (!orig_mat) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03556"></a>03556 
<a name="l03557"></a>03557     <span class="comment">/* copy material */</span>
<a name="l03558"></a>03558     mat = <a class="code" href="../../d4/d0f/BKE__material_8h.html#a5ec0bb804bad98c1a4ffbd14672fcb89">localize_material</a>(orig_mat);
<a name="l03559"></a>03559 
<a name="l03560"></a>03560     <span class="comment">/* update material anims */</span>
<a name="l03561"></a>03561     <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a3fc06eed9b3244922dd05906dcc58cde">id</a>, mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#abd1e09497ddf15bd6b49b0bc31ce3e42">adt</a>, <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(scene), <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8a1bce4262e3f1016c7b92e1ac709e4bec">ADT_RECALC_ANIM</a>);
<a name="l03562"></a>03562 
<a name="l03563"></a>03563     <span class="comment">/* strip material copy from unsupported flags */</span>
<a name="l03564"></a>03564     <span class="keywordflow">for</span> (tex_nr=0; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l03565"></a>03565         <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af9e93d9aaaf44eb7c36410d3fcc53415">septex</a> &amp; (1&lt;&lt;tex_nr)) <span class="keywordflow">continue</span>;
<a name="l03566"></a>03566     
<a name="l03567"></a>03567         <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr]) {
<a name="l03568"></a>03568             <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr];
<a name="l03569"></a>03569 
<a name="l03570"></a>03570             <span class="keywordflow">if</span> (!mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) <span class="keywordflow">continue</span>;
<a name="l03571"></a>03571 
<a name="l03572"></a>03572             <span class="comment">/* only keep compatible texflags */</span>
<a name="l03573"></a>03573             mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#ab51470b87b40b19a8ca3781d30b70f12">texflag</a> &amp; (<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a9735e1c7f812cb40de3565cdbcfeafaa">MTEX_RGBTOINT</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#aafc412fccbce3dfbec71f176755ab115">MTEX_STENCIL</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5b0a127a63aea49f47ce00125a79f6cc">MTEX_NEGATIVE</a> | <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af3ddbad6b850b047d82d81d5fecb941a">MTEX_ALPHAMIX</a>);
<a name="l03574"></a>03574 
<a name="l03575"></a>03575             <span class="comment">/* depending of material type, strip non-compatible mapping modes */</span>
<a name="l03576"></a>03576             <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>) {
<a name="l03577"></a>03577                 <span class="keywordflow">if</span> (!<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a938a2602f1452ef9399e915c4a004116">TEXCO_UV</a>)) {
<a name="l03578"></a>03578                     <span class="comment">/* ignore this texture */</span>
<a name="l03579"></a>03579                     mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> = 0;
<a name="l03580"></a>03580                     <span class="keywordflow">continue</span>;
<a name="l03581"></a>03581                 }
<a name="l03582"></a>03582                 <span class="comment">/* strip all mapto flags except color and alpha */</span>
<a name="l03583"></a>03583                 mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> = (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#af205394e8cf1225dd1746ef3fe0c08cb">MAP_COL</a>) | (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a4d4d91166a52a89f90553ad91d3efd06">MAP_ALPHA</a>);
<a name="l03584"></a>03584             }
<a name="l03585"></a>03585             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>) {
<a name="l03586"></a>03586                 <span class="keywordflow">if</span> (!<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#ad7840c0d1aa749edccc8bfb7215b472a">TEXCO_ORCO</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a24fae7c12b9d1c2c450f8056a0c08d9e">TEXCO_GLOB</a>)) {
<a name="l03587"></a>03587                     <span class="comment">/* ignore */</span>
<a name="l03588"></a>03588                     mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a> = 0;
<a name="l03589"></a>03589                     <span class="keywordflow">continue</span>;
<a name="l03590"></a>03590                 }
<a name="l03591"></a>03591                 <span class="comment">/* strip all mapto flags except color and alpha */</span>
<a name="l03592"></a>03592                 mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> = mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aa28e86f4cbc4330e5e8518b11dcfbc61">mapto</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a> | <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a> | <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>);
<a name="l03593"></a>03593             }
<a name="l03594"></a>03594             
<a name="l03595"></a>03595             <span class="comment">/* if mapped to an object, calculate inverse matrices */</span>
<a name="l03596"></a>03596             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#a0e8d81acbf5efcb10a9c30bba03a5c09">texco</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a19dec5a9457d85954f61c9b0dffd8211">TEXCO_OBJECT</a>) {
<a name="l03597"></a>03597                 <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aaf7b9758f217a9aa59a16b1768c2753e">object</a>;
<a name="l03598"></a>03598                 <span class="keywordflow">if</span> (ob) {
<a name="l03599"></a>03599                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l03600"></a>03600                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a14735e830bf7d13889a5d3cb38bb9a44">imat_ren</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>);
<a name="l03601"></a>03601                 }
<a name="l03602"></a>03602             }
<a name="l03603"></a>03603 
<a name="l03604"></a>03604             <span class="comment">/* copy texture */</span>
<a name="l03605"></a>03605             tex= mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a> = <a class="code" href="../../d2/d66/BKE__texture_8h.html#aaa0ce7353c0badedf543803a728158c3">localize_texture</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>);
<a name="l03606"></a>03606 
<a name="l03607"></a>03607             <span class="comment">/* update texture anims */</span>
<a name="l03608"></a>03608             <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a0e72e8e868390e4ad0e7efe64499a207">BKE_animsys_evaluate_animdata</a>(scene, &amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>, tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a0ec2c56bda9943af0ea2540d25dca05b">adt</a>, <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(scene), <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a7cc2212e3e0823a3ce68c0ada63fdca8a1bce4262e3f1016c7b92e1ac709e4bec">ADT_RECALC_ANIM</a>);
<a name="l03609"></a>03609 
<a name="l03610"></a>03610             <span class="comment">/* update texture cache if required */</span>
<a name="l03611"></a>03611             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a7fd8163d72590628d35ab2695e48424a">TEX_VOXELDATA</a>) {
<a name="l03612"></a>03612                 <a class="code" href="../../d5/dd0/voxeldata_8h.html#a5faa71f6a9daaf3526d054aa9ec91490">cache_voxeldata</a>(tex, (<span class="keywordtype">int</span>)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>);
<a name="l03613"></a>03613             }
<a name="l03614"></a>03614             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a0d2d438f1eb6896112dd8862eae03be2">TEX_POINTDENSITY</a>) {
<a name="l03615"></a>03615                 <span class="comment">/* set dummy values for render and do cache */</span>
<a name="l03616"></a>03616                 <a class="code" href="../../d6/d7a/structRender.html">Render</a> dummy_re = {0};
<a name="l03617"></a>03617                 dummy_re.<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a> = scene;
<a name="l03618"></a>03618                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(dummy_re.<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>);
<a name="l03619"></a>03619                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(dummy_re.<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l03620"></a>03620                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(dummy_re.<a class="code" href="../../d6/d7a/structRender.html#a07d836d18fd4150885d623fec88c6e43">winmat</a>);
<a name="l03621"></a>03621                 dummy_re.<a class="code" href="../../d6/d7a/structRender.html#acacedf0aeea8091d71da37f69a22232c">winx</a> = dummy_re.<a class="code" href="../../d6/d7a/structRender.html#a3b16dc1176a7652ab08659364215501a">winy</a> = 128;
<a name="l03622"></a>03622                 <a class="code" href="../../d7/def/pointdensity_8h.html#a6bdf96da5c3a02cf075bea331a6491cf">cache_pointdensity</a>(&amp;dummy_re, tex);
<a name="l03623"></a>03623             }
<a name="l03624"></a>03624 
<a name="l03625"></a>03625             <span class="comment">/* update image sequences and movies */</span>
<a name="l03626"></a>03626             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a> &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>)) {
<a name="l03627"></a>03627                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>.<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l03628"></a>03628                     <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a87a10b6d51aa883dcf4a9a1b469a8577">iuser</a>, (<span class="keywordtype">int</span>)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>, 0);
<a name="l03629"></a>03629             }
<a name="l03630"></a>03630         }
<a name="l03631"></a>03631     }
<a name="l03632"></a>03632     <span class="keywordflow">return</span> mat;
<a name="l03633"></a>03633 }
<a name="l03634"></a>03634 
<a name="l03635"></a>03635 <span class="comment">/* free all duplicate data allocated by RE_init_sample_material() */</span>
<a name="l03636"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a4d658cb037f424bc1fe1bd8f76f097ca">03636</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#ae998dd73b5ffcad34a5a7268b2d2d075">RE_free_sample_material</a>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *mat)
<a name="l03637"></a>03637 {
<a name="l03638"></a>03638     <span class="keywordtype">int</span> tex_nr;
<a name="l03639"></a>03639 
<a name="l03640"></a>03640     <span class="comment">/* free textures */</span>
<a name="l03641"></a>03641     <span class="keywordflow">for</span> (tex_nr=0; tex_nr&lt;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5c921b6ba71dfcfa9a404e101d9bcaf4">MAX_MTEX</a>; tex_nr++) {
<a name="l03642"></a>03642         <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af9e93d9aaaf44eb7c36410d3fcc53415">septex</a> &amp; (1&lt;&lt;tex_nr)) <span class="keywordflow">continue</span>;
<a name="l03643"></a>03643         <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr]) {
<a name="l03644"></a>03644             <a class="code" href="../../dc/ddd/structMTex.html">MTex</a> *mtex= mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a738a376b474b09dba529b222ba7876d6">mtex</a>[tex_nr];
<a name="l03645"></a>03645     
<a name="l03646"></a>03646             <span class="keywordflow">if</span> (mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>) {
<a name="l03647"></a>03647                 <a class="code" href="../../d2/d66/BKE__texture_8h.html#a5b1a5127cc36165efb6acdd0c86279e2">free_texture</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>);
<a name="l03648"></a>03648                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a>);
<a name="l03649"></a>03649                 mtex-&gt;<a class="code" href="../../dc/ddd/structMTex.html#aef6acbb854984bb254e1cb5b75f821d4">tex</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03650"></a>03650             }
<a name="l03651"></a>03651         }
<a name="l03652"></a>03652     }
<a name="l03653"></a>03653 
<a name="l03654"></a>03654     <a class="code" href="../../d4/d0f/BKE__material_8h.html#a6adfd8fa1663e41b80663e9730a3217a">free_material</a>(mat);
<a name="l03655"></a>03655     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mat);
<a name="l03656"></a>03656 }
<a name="l03657"></a>03657 
<a name="l03658"></a>03658 
<a name="l03659"></a>03659 
<a name="l03660"></a>03660 <span class="comment">/*</span>
<a name="l03661"></a>03661 <span class="comment"> *  Get material diffuse color and alpha (including linked textures) in given coordinates</span>
<a name="l03662"></a>03662 <span class="comment"> *</span>
<a name="l03663"></a>03663 <span class="comment"> *  color,alpha : input/output color values</span>
<a name="l03664"></a>03664 <span class="comment"> *  volume_co : sample coordinate in global space. used by volumetric materials</span>
<a name="l03665"></a>03665 <span class="comment"> *  surface_co : sample surface coordinate in global space. used by &quot;surface&quot; materials</span>
<a name="l03666"></a>03666 <span class="comment"> *  face_index : surface face index</span>
<a name="l03667"></a>03667 <span class="comment"> *  hit_quad : whether point is on second &quot;half&quot; of a quad</span>
<a name="l03668"></a>03668 <span class="comment"> *  orcoDm : orco state derived mesh</span>
<a name="l03669"></a>03669 <span class="comment"> */</span>
<a name="l03670"></a><a class="code" href="../../db/d0d/render__texture_8c.html#a68dc52c53464d512d59972af80fcb4e5">03670</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de4/RE__render__ext_8h.html#a1a4ec036bcd94bec834c54fd29fd7dfa">RE_sample_material_color</a>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *mat, <span class="keywordtype">float</span> color[3], <span class="keywordtype">float</span> *alpha, <span class="keyword">const</span> <span class="keywordtype">float</span> volume_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> surface_co[3], <span class="keywordtype">int</span> face_index, <span class="keywordtype">short</span> hit_quad, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *orcoDm, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l03671"></a>03671 {
<a name="l03672"></a>03672     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l03673"></a>03673     <span class="keywordtype">int</span> v1, v2, v3;
<a name="l03674"></a>03674     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l03675"></a>03675     <span class="keywordtype">float</span> uv[3], normal[3];
<a name="l03676"></a>03676     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi = {0};
<a name="l03677"></a>03677     <a class="code" href="../../d6/d7a/structRender.html">Render</a> re = {0};
<a name="l03678"></a>03678 
<a name="l03679"></a>03679     <span class="comment">/* Get face data    */</span>
<a name="l03680"></a>03680     mvert = orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(orcoDm);
<a name="l03681"></a>03681     mface = orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(orcoDm);
<a name="l03682"></a>03682 
<a name="l03683"></a>03683     <span class="keywordflow">if</span> (!mvert || !mface || !mat) <span class="keywordflow">return</span>;
<a name="l03684"></a>03684     v1=mface[face_index].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, v2=mface[face_index].<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, v3=mface[face_index].<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l03685"></a>03685     <span class="keywordflow">if</span> (hit_quad) {v2=mface[face_index].<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>; v3=mface[face_index].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;}
<a name="l03686"></a>03686     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( normal, mvert[v1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, mvert[v2].co, mvert[v3].co);
<a name="l03687"></a>03687 
<a name="l03688"></a>03688     <span class="comment">/* generate shadeinput with data required */</span>
<a name="l03689"></a>03689     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a> = mat;
<a name="l03690"></a>03690 
<a name="l03691"></a>03691     <span class="comment">/* fill shadeinput data depending on material type */</span>
<a name="l03692"></a>03692     <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>) {
<a name="l03693"></a>03693         <span class="comment">/* global coordinates */</span>
<a name="l03694"></a>03694         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#a0b2a0ed0b28d49e8ea915326c070e4b4">gl</a>, surface_co);
<a name="l03695"></a>03695         <span class="comment">/* object space coordinates */</span>
<a name="l03696"></a>03696         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, surface_co);
<a name="l03697"></a>03697         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l03698"></a>03698         <span class="comment">/* orco coordinates */</span>
<a name="l03699"></a>03699         {
<a name="l03700"></a>03700             <span class="keywordtype">float</span> l;
<a name="l03701"></a>03701             <span class="comment">/* Get generated UV */</span>
<a name="l03702"></a>03702             <a class="code" href="../../db/d0d/render__texture_8c.html#a128869ee6d422418cef290f7ab95cbbc">textured_face_generate_uv</a>(uv, normal, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, mvert[v1].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mvert[v2].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mvert[v3].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03703"></a>03703             l= 1.0f+uv[0]+uv[1];
<a name="l03704"></a>03704 
<a name="l03705"></a>03705             <span class="comment">/* calculate generated coordinate */</span>
<a name="l03706"></a>03706             shi.<a class="code" href="../../d8/db3/structShadeInput.html#afb54b5adec3827670a144c48b94abb48">lo</a>[0]= l*mvert[v3].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0]-uv[0]*mvert[v1].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0]-uv[1]*mvert[v2].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l03707"></a>03707             shi.<a class="code" href="../../d8/db3/structShadeInput.html#afb54b5adec3827670a144c48b94abb48">lo</a>[1]= l*mvert[v3].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1]-uv[0]*mvert[v1].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1]-uv[1]*mvert[v2].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l03708"></a>03708             shi.<a class="code" href="../../d8/db3/structShadeInput.html#afb54b5adec3827670a144c48b94abb48">lo</a>[2]= l*mvert[v3].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2]-uv[0]*mvert[v1].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2]-uv[1]*mvert[v2].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l03709"></a>03709         }
<a name="l03710"></a>03710         <span class="comment">/* uv coordinates */</span>
<a name="l03711"></a>03711         {
<a name="l03712"></a>03712             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, layers = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(&amp;orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l03713"></a>03713             <span class="keywordtype">int</span> layer_index = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l03714"></a>03714 
<a name="l03715"></a>03715             <span class="comment">/* for every uv map set coords and name */</span>
<a name="l03716"></a>03716             <span class="keywordflow">for</span> (i=0; i&lt;layers; i++) {
<a name="l03717"></a>03717                 <span class="keywordflow">if</span> (layer_index &gt;= 0) {
<a name="l03718"></a>03718                     <span class="keywordtype">float</span> *uv1, *uv2, *uv3;
<a name="l03719"></a>03719                     <span class="keywordtype">float</span> l;
<a name="l03720"></a>03720                     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = &amp;orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>;
<a name="l03721"></a>03721                     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface = (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*) data-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer_index+i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l03722"></a>03722                     <span class="keywordtype">float</span> uv[3];
<a name="l03723"></a>03723                     <span class="comment">/* point layer name from actual layer data */</span>
<a name="l03724"></a>03724                     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[i].<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97c1ee0ff9f1462a3bd02f2352698809">name</a> = data-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#aa8ef26f614b5037233d4ba102e3286d8">name</a>;
<a name="l03725"></a>03725                     <span class="comment">/* Get generated coordinates to calculate UV from */</span>
<a name="l03726"></a>03726                     <a class="code" href="../../db/d0d/render__texture_8c.html#a128869ee6d422418cef290f7ab95cbbc">textured_face_generate_uv</a>(uv, normal, shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, mvert[v1].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mvert[v2].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, mvert[v3].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l03727"></a>03727                     <span class="comment">/* Get UV mapping coordinate */</span>
<a name="l03728"></a>03728                     l= 1.0f+uv[0]+uv[1];
<a name="l03729"></a>03729                         
<a name="l03730"></a>03730                     uv1= tface[face_index].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0];
<a name="l03731"></a>03731                     uv2= (hit_quad) ? tface[face_index].uv[2] : tface[face_index].uv[1];
<a name="l03732"></a>03732                     uv3= (hit_quad) ? tface[face_index].uv[3] : tface[face_index].uv[2];
<a name="l03733"></a>03733                                 
<a name="l03734"></a>03734                     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[0]= -1.0f + 2.0f*(l*uv3[0]-uv[0]*uv1[0]-uv[1]*uv2[0]);
<a name="l03735"></a>03735                     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[1]= -1.0f + 2.0f*(l*uv3[1]-uv[0]*uv1[1]-uv[1]*uv2[1]);
<a name="l03736"></a>03736                     shi.<a class="code" href="../../d8/db3/structShadeInput.html#a377a7ce12be6a058873616b1d99c722f">uv</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/dbd/structShadeInputUV.html#a97dd5e09350b988db360b6d9abe5aabb">uv</a>[2]= 0.0f;  <span class="comment">/* texture.c assumes there are 3 coords */</span>
<a name="l03737"></a>03737                 }
<a name="l03738"></a>03738             }
<a name="l03739"></a>03739             <span class="comment">/* active uv map */</span>
<a name="l03740"></a>03740             shi.<a class="code" href="../../d8/db3/structShadeInput.html#ac83061350468fa98d31884e34086fb78">actuv</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(&amp;orcoDm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>,<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>) - layer_index;
<a name="l03741"></a>03741             shi.<a class="code" href="../../d8/db3/structShadeInput.html#a7bc618e140f97186f3d736795511a6a3">totuv</a> = layers;
<a name="l03742"></a>03742         }
<a name="l03743"></a>03743 
<a name="l03744"></a>03744         <span class="comment">/* apply initial values from material */</span>
<a name="l03745"></a>03745         shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a> = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9e892cbd7e25b6fd5ee00c383cd9cacf">r</a>;
<a name="l03746"></a>03746         shi.<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a> = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4b832bd11d2b3d00ab74a269f2f2e9e8">g</a>;
<a name="l03747"></a>03747         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a> = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a01ac5d90e907d35afcf7af9cf6b17c04">b</a>;
<a name="l03748"></a>03748         shi.<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a> = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac0f2eb80623ad884c7fa770e47ae92a2">alpha</a>;
<a name="l03749"></a>03749 
<a name="l03750"></a>03750         <span class="comment">/* do texture */</span>
<a name="l03751"></a>03751         <a class="code" href="../../d8/d7c/gpu__material_8c.html#ab09827a486fe37e91a118c621f94cfdd">do_material_tex</a>(&amp;shi, &amp;re);
<a name="l03752"></a>03752 
<a name="l03753"></a>03753         <span class="comment">/* apply result */</span>
<a name="l03754"></a>03754         color[0] = shi.<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l03755"></a>03755         color[1] = shi.<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l03756"></a>03756         color[2] = shi.<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l03757"></a>03757         *alpha = shi.<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l03758"></a>03758     }
<a name="l03759"></a>03759     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#adaea506ad43f2c01368fc0d3ac083baf">MA_TYPE_VOLUME</a>) {
<a name="l03760"></a>03760         <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> obi = {0};
<a name="l03761"></a>03761         obi.<a class="code" href="../../da/d94/structObjectInstanceRen.html#a92d949bdac4420bf9128f907c1b786d6">ob</a> = ob;
<a name="l03762"></a>03762         shi.<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> = &amp;obi;
<a name="l03763"></a>03763         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(re.<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>);
<a name="l03764"></a>03764         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(color, mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a570c152bc25f58beb1e037c729ac07a4">reflection_col</a>);
<a name="l03765"></a>03765         *alpha = mat-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#af8e1903e47e2379a39a8fdcf5eb68182">density</a>;
<a name="l03766"></a>03766 
<a name="l03767"></a>03767         <span class="comment">/* do texture */</span>
<a name="l03768"></a>03768         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(&amp;shi, volume_co, (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a> | <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a> | <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>),
<a name="l03769"></a>03769                       color, alpha, &amp;re);
<a name="l03770"></a>03770     }
<a name="l03771"></a>03771 }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773 <span class="comment">/* eof */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:47 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
