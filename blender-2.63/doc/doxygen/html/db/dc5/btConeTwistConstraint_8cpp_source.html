<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: btConeTwistConstraint.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">btConeTwistConstraint.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../db/dc5/btConeTwistConstraint_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">Bullet Continuous Collision Detection and Physics Library</span>
<a name="l00003"></a>00003 <span class="comment">btConeTwistConstraint is Copyright (c) 2007 Starbreeze Studios</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">This software is provided &#39;as-is&#39;, without any express or implied warranty.</span>
<a name="l00006"></a>00006 <span class="comment">In no event will the authors be held liable for any damages arising from the use of this software.</span>
<a name="l00007"></a>00007 <span class="comment">Permission is granted to anyone to use this software for any purpose, </span>
<a name="l00008"></a>00008 <span class="comment">including commercial applications, and to alter it and redistribute it freely, </span>
<a name="l00009"></a>00009 <span class="comment">subject to the following restrictions:</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">1. The origin of this software must not be misrepresented; you must not claim that you wrote the original software. If you use this software in a product, an acknowledgment in the product documentation would be appreciated but is not required.</span>
<a name="l00012"></a>00012 <span class="comment">2. Altered source versions must be plainly marked as such, and must not be misrepresented as being the original software.</span>
<a name="l00013"></a>00013 <span class="comment">3. This notice may not be removed or altered from any source distribution.</span>
<a name="l00014"></a>00014 <span class="comment"></span>
<a name="l00015"></a>00015 <span class="comment">Written by: Marcus Hennix</span>
<a name="l00016"></a>00016 <span class="comment">*/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html">btConeTwistConstraint.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d16/btRigidBody_8h.html">BulletDynamics/Dynamics/btRigidBody.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/df3/btTransformUtil_8h.html">LinearMath/btTransformUtil.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d05/btMinMax_8h.html">LinearMath/btMinMax.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;new&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="comment">//#define CONETWIST_USE_OBSOLETE_SOLVER true</span>
<a name="l00028"></a><a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#aabccbdfd05c63291341d79d1bca4878c">00028</a> <span class="preprocessor">#define CONETWIST_USE_OBSOLETE_SOLVER false</span>
<a name="l00029"></a><a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#ac763386aab812a005bc16a9363740ff3">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define CONETWIST_DEF_FIX_THRESH btScalar(.05f)</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">00032</a> <a class="code" href="../../d0/d6b/btScalar_8h.html#a8a6a3e8b28846a3d7271e376c738ec40">SIMD_FORCE_INLINE</a> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">computeAngularImpulseDenominator</a>(<span class="keyword">const</span> btVector3&amp; axis, <span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; invInertiaWorld)
<a name="l00033"></a>00033 {
<a name="l00034"></a>00034     btVector3 vec = axis * invInertiaWorld;
<a name="l00035"></a>00035     <span class="keywordflow">return</span> axis.dot(vec);
<a name="l00036"></a>00036 }
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6c1d41196d4830e5c231ffd81731d0a2">00041</a> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6c1d41196d4830e5c231ffd81731d0a2">btConeTwistConstraint::btConeTwistConstraint</a>(<a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>&amp; rbA,<a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>&amp; rbB, 
<a name="l00042"></a>00042                                              <span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; rbAFrame,<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; rbBFrame)
<a name="l00043"></a>00043                                              :<a class="code" href="../../df/daa/classbtTypedConstraint.html" title="TypedConstraint is the baseclass for Bullet constraints and vehicles.">btTypedConstraint</a>(<a class="code" href="../../d4/d72/btTypedConstraint_8h.html#af8c47105aa5342e470e9c4e353fbcb73a2ad45cdbc9186820b9c3a1314856ebab">CONETWIST_CONSTRAINT_TYPE</a>, rbA,rbB),m_rbAFrame(rbAFrame),m_rbBFrame(rbBFrame),
<a name="l00044"></a>00044                                              m_angularOnly(false),
<a name="l00045"></a>00045                                              m_useSolveConstraintObsolete(<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#aabccbdfd05c63291341d79d1bca4878c">CONETWIST_USE_OBSOLETE_SOLVER</a>)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aba4ee06b6d4b893975331b43c63f11be">init</a>();
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3c322f99d5a31016d808e15edaedaed6">00050</a> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6c1d41196d4830e5c231ffd81731d0a2">btConeTwistConstraint::btConeTwistConstraint</a>(<a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>&amp; rbA,<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; rbAFrame)
<a name="l00051"></a>00051                                             :<a class="code" href="../../df/daa/classbtTypedConstraint.html" title="TypedConstraint is the baseclass for Bullet constraints and vehicles.">btTypedConstraint</a>(<a class="code" href="../../d4/d72/btTypedConstraint_8h.html#af8c47105aa5342e470e9c4e353fbcb73a2ad45cdbc9186820b9c3a1314856ebab">CONETWIST_CONSTRAINT_TYPE</a>,rbA),m_rbAFrame(rbAFrame),
<a name="l00052"></a>00052                                              m_angularOnly(false),
<a name="l00053"></a>00053                                              m_useSolveConstraintObsolete(<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#aabccbdfd05c63291341d79d1bca4878c">CONETWIST_USE_OBSOLETE_SOLVER</a>)
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055     m_rbBFrame = m_rbAFrame;
<a name="l00056"></a>00056     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aba4ee06b6d4b893975331b43c63f11be">init</a>(); 
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aba4ee06b6d4b893975331b43c63f11be">00060</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aba4ee06b6d4b893975331b43c63f11be">btConeTwistConstraint::init</a>()
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062     m_angularOnly = <span class="keyword">false</span>;
<a name="l00063"></a>00063     m_solveTwistLimit = <span class="keyword">false</span>;
<a name="l00064"></a>00064     m_solveSwingLimit = <span class="keyword">false</span>;
<a name="l00065"></a>00065     m_bMotorEnabled = <span class="keyword">false</span>;
<a name="l00066"></a>00066     m_maxMotorImpulse = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(-1);
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a7d7bcaf2e7c8ce20748d992681af7838">setLimit</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a3a24ecdd029d38fef175bee5d965710a">BT_LARGE_FLOAT</a>), <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a3a24ecdd029d38fef175bee5d965710a">BT_LARGE_FLOAT</a>), <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a3a24ecdd029d38fef175bee5d965710a">BT_LARGE_FLOAT</a>));
<a name="l00069"></a>00069     m_damping = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.01);
<a name="l00070"></a>00070     m_fixThresh = <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#ac763386aab812a005bc16a9363740ff3">CONETWIST_DEF_FIX_THRESH</a>;
<a name="l00071"></a>00071     m_flags = 0;
<a name="l00072"></a>00072     m_linCFM = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f);
<a name="l00073"></a>00073     m_linERP = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.7f);
<a name="l00074"></a>00074     m_angCFM = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a433d4f072ca7bf2352d6720ceb573467">00078</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a433d4f072ca7bf2352d6720ceb573467" title="internal method used by the constraint solver, don&#39;t use them directly">btConeTwistConstraint::getInfo1</a> (<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html">btConstraintInfo1</a>* info)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (m_useSolveConstraintObsolete)
<a name="l00081"></a>00081     {
<a name="l00082"></a>00082         info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a> = 0;
<a name="l00083"></a>00083         info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a> = 0;
<a name="l00084"></a>00084     } 
<a name="l00085"></a>00085     <span class="keywordflow">else</span>
<a name="l00086"></a>00086     {
<a name="l00087"></a>00087         info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a> = 3;
<a name="l00088"></a>00088         info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a> = 3;
<a name="l00089"></a>00089         <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac367e0423a33ec00b18223921db6bbb0">calcAngleInfo2</a>(<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>());
<a name="l00090"></a>00090         <span class="keywordflow">if</span>(m_solveSwingLimit)
<a name="l00091"></a>00091         {
<a name="l00092"></a>00092             info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a>++;
<a name="l00093"></a>00093             info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a>--;
<a name="l00094"></a>00094             <span class="keywordflow">if</span>((m_swingSpan1 &lt; m_fixThresh) &amp;&amp; (m_swingSpan2 &lt; m_fixThresh))
<a name="l00095"></a>00095             {
<a name="l00096"></a>00096                 info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a>++;
<a name="l00097"></a>00097                 info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a>--;
<a name="l00098"></a>00098             }
<a name="l00099"></a>00099         }
<a name="l00100"></a>00100         <span class="keywordflow">if</span>(m_solveTwistLimit)
<a name="l00101"></a>00101         {
<a name="l00102"></a>00102             info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a>++;
<a name="l00103"></a>00103             info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a>--;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aa78e8e2b022243057b83b88e68e0473a">00108</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aa78e8e2b022243057b83b88e68e0473a">btConeTwistConstraint::getInfo1NonVirtual</a> (<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html">btConstraintInfo1</a>* info)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <span class="comment">//always reserve 6 rows: object transform is not available on SPU</span>
<a name="l00111"></a>00111     info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a37aac13b0176d3589ec3077cc7961713">m_numConstraintRows</a> = 6;
<a name="l00112"></a>00112     info-&gt;<a class="code" href="../../d3/dd1/structbtTypedConstraint_1_1btConstraintInfo1.html#a80b9f5ee154c3d2ff38d094522d82137">nub</a> = 0;
<a name="l00113"></a>00113         
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115     
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ad28d3b03658148219b40262c29556a50">00117</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ad28d3b03658148219b40262c29556a50" title="internal method used by the constraint solver, don&#39;t use them directly">btConeTwistConstraint::getInfo2</a> (<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html">btConstraintInfo2</a>* info)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6e303822942e27b953326e32ff0d1c43">getInfo2NonVirtual</a>(info,<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>());
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6e303822942e27b953326e32ff0d1c43">00122</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a6e303822942e27b953326e32ff0d1c43">btConeTwistConstraint::getInfo2NonVirtual</a> (<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html">btConstraintInfo2</a>* info,<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; transA,<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; transB,<span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; invInertiaWorldA,<span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; invInertiaWorldB)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac367e0423a33ec00b18223921db6bbb0">calcAngleInfo2</a>(transA,transB,invInertiaWorldA,invInertiaWorldB);
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     <a class="code" href="../../d0/d6b/btScalar_8h.html#aff3e6078c073f6ba0edb95353f2c2c62">btAssert</a>(!m_useSolveConstraintObsolete);
<a name="l00127"></a>00127     <span class="comment">// set jacobian</span>
<a name="l00128"></a>00128     info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a00aa8fdfc3168fdec0930876857a7968">m_J1linearAxis</a>[0] = 1;
<a name="l00129"></a>00129     info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a00aa8fdfc3168fdec0930876857a7968">m_J1linearAxis</a>[info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>+1] = 1;
<a name="l00130"></a>00130     info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a00aa8fdfc3168fdec0930876857a7968">m_J1linearAxis</a>[2*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>+2] = 1;
<a name="l00131"></a>00131     btVector3 a1 = transA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00132"></a>00132     {
<a name="l00133"></a>00133         btVector3* angular0 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a749460f27a71554e97de1988bd5f527a">m_J1angularAxis</a>);
<a name="l00134"></a>00134         btVector3* angular1 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a749460f27a71554e97de1988bd5f527a">m_J1angularAxis</a>+info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>);
<a name="l00135"></a>00135         btVector3* angular2 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a749460f27a71554e97de1988bd5f527a">m_J1angularAxis</a>+2*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>);
<a name="l00136"></a>00136         btVector3 a1neg = -a1;
<a name="l00137"></a>00137         a1neg.getSkewSymmetricMatrix(angular0,angular1,angular2);
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139     btVector3 a2 = transB.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00140"></a>00140     {
<a name="l00141"></a>00141         btVector3* angular0 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0050d07b4624455d925e313d851abb8a">m_J2angularAxis</a>);
<a name="l00142"></a>00142         btVector3* angular1 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0050d07b4624455d925e313d851abb8a">m_J2angularAxis</a>+info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>);
<a name="l00143"></a>00143         btVector3* angular2 = (btVector3*)(info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0050d07b4624455d925e313d851abb8a">m_J2angularAxis</a>+2*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>);
<a name="l00144"></a>00144         a2.getSkewSymmetricMatrix(angular0,angular1,angular2);
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146     <span class="comment">// set right hand side</span>
<a name="l00147"></a>00147     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> linERP = (m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea43904f56ec584a9102dc046f4998bb68">BT_CONETWIST_FLAGS_LIN_ERP</a>) ? m_linERP : info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0546adf80186f30d0c9436b70b87af6a">erp</a>;
<a name="l00148"></a>00148     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> k = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a73db62a50c97016f03303a71bf170e95">fps</a> * linERP;
<a name="l00149"></a>00149     <span class="keywordtype">int</span> j;
<a name="l00150"></a>00150     for (j=0; j&lt;3; j++)
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152         info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a9fe8bcf749ad7bb01fd517cd839e05d8">m_constraintError</a>[j*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>] = k * (a2[j] + transB.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>()[j] - a1[j] - transA.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>()[j]);
<a name="l00153"></a>00153         info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[j*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>] = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00154"></a>00154         info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[j*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00155"></a>00155         <span class="keywordflow">if</span>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea4259c8d65138be663e5ab368054fc994">BT_CONETWIST_FLAGS_LIN_CFM</a>)
<a name="l00156"></a>00156         {
<a name="l00157"></a>00157             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a707419a1794b57aa73447fd3faec0dca">cfm</a>[j*info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>] = m_linCFM;
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     <span class="keywordtype">int</span> row = 3;
<a name="l00161"></a>00161     <span class="keywordtype">int</span> srow = row * info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>;
<a name="l00162"></a>00162     btVector3 ax1;
<a name="l00163"></a>00163     <span class="comment">// angular limits</span>
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(m_solveSwingLimit)
<a name="l00165"></a>00165     {
<a name="l00166"></a>00166         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *J1 = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a749460f27a71554e97de1988bd5f527a">m_J1angularAxis</a>;
<a name="l00167"></a>00167         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *J2 = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0050d07b4624455d925e313d851abb8a">m_J2angularAxis</a>;
<a name="l00168"></a>00168         <span class="keywordflow">if</span>((m_swingSpan1 &lt; m_fixThresh) &amp;&amp; (m_swingSpan2 &lt; m_fixThresh))
<a name="l00169"></a>00169         {
<a name="l00170"></a>00170             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trA = transA*m_rbAFrame;
<a name="l00171"></a>00171             btVector3 <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = trA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(1);
<a name="l00172"></a>00172             btVector3 q = trA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(2);
<a name="l00173"></a>00173             <span class="keywordtype">int</span> srow1 = srow + info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>;
<a name="l00174"></a>00174             J1[srow+0] = p[0];
<a name="l00175"></a>00175             J1[srow+1] = p[1];
<a name="l00176"></a>00176             J1[srow+2] = p[2];
<a name="l00177"></a>00177             J1[srow1+0] = q[0];
<a name="l00178"></a>00178             J1[srow1+1] = q[1];
<a name="l00179"></a>00179             J1[srow1+2] = q[2];
<a name="l00180"></a>00180             J2[srow+0] = -p[0];
<a name="l00181"></a>00181             J2[srow+1] = -p[1];
<a name="l00182"></a>00182             J2[srow+2] = -p[2];
<a name="l00183"></a>00183             J2[srow1+0] = -q[0];
<a name="l00184"></a>00184             J2[srow1+1] = -q[1];
<a name="l00185"></a>00185             J2[srow1+2] = -q[2];
<a name="l00186"></a>00186             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> fact = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a73db62a50c97016f03303a71bf170e95">fps</a> * m_relaxationFactor;
<a name="l00187"></a>00187             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a9fe8bcf749ad7bb01fd517cd839e05d8">m_constraintError</a>[srow] =   fact * m_swingAxis.dot(p);
<a name="l00188"></a>00188             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a9fe8bcf749ad7bb01fd517cd839e05d8">m_constraintError</a>[srow1] =  fact * m_swingAxis.dot(q);
<a name="l00189"></a>00189             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow] = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00190"></a>00190             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00191"></a>00191             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow1] = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00192"></a>00192             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow1] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00193"></a>00193             srow = srow1 + info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>;
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195         <span class="keywordflow">else</span>
<a name="l00196"></a>00196         {
<a name="l00197"></a>00197             ax1 = m_swingAxis * m_relaxationFactor * m_relaxationFactor;
<a name="l00198"></a>00198             J1[srow+0] = ax1[0];
<a name="l00199"></a>00199             J1[srow+1] = ax1[1];
<a name="l00200"></a>00200             J1[srow+2] = ax1[2];
<a name="l00201"></a>00201             J2[srow+0] = -ax1[0];
<a name="l00202"></a>00202             J2[srow+1] = -ax1[1];
<a name="l00203"></a>00203             J2[srow+2] = -ax1[2];
<a name="l00204"></a>00204             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> k = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a73db62a50c97016f03303a71bf170e95">fps</a> * m_biasFactor;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a9fe8bcf749ad7bb01fd517cd839e05d8">m_constraintError</a>[srow] = k * m_swingCorrection;
<a name="l00207"></a>00207             <span class="keywordflow">if</span>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea7c4ee7313641e9762ff905341cab3cd6">BT_CONETWIST_FLAGS_ANG_CFM</a>)
<a name="l00208"></a>00208             {
<a name="l00209"></a>00209                 info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a707419a1794b57aa73447fd3faec0dca">cfm</a>[srow] = m_angCFM;
<a name="l00210"></a>00210             }
<a name="l00211"></a>00211             <span class="comment">// m_swingCorrection is always positive or 0</span>
<a name="l00212"></a>00212             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow] = 0;
<a name="l00213"></a>00213             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00214"></a>00214             srow += info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>;
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="keywordflow">if</span>(m_solveTwistLimit)
<a name="l00218"></a>00218     {
<a name="l00219"></a>00219         ax1 = m_twistAxis * m_relaxationFactor * m_relaxationFactor;
<a name="l00220"></a>00220         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *J1 = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a749460f27a71554e97de1988bd5f527a">m_J1angularAxis</a>;
<a name="l00221"></a>00221         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *J2 = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a0050d07b4624455d925e313d851abb8a">m_J2angularAxis</a>;
<a name="l00222"></a>00222         J1[srow+0] = ax1[0];
<a name="l00223"></a>00223         J1[srow+1] = ax1[1];
<a name="l00224"></a>00224         J1[srow+2] = ax1[2];
<a name="l00225"></a>00225         J2[srow+0] = -ax1[0];
<a name="l00226"></a>00226         J2[srow+1] = -ax1[1];
<a name="l00227"></a>00227         J2[srow+2] = -ax1[2];
<a name="l00228"></a>00228         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> k = info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a73db62a50c97016f03303a71bf170e95">fps</a> * m_biasFactor;
<a name="l00229"></a>00229         info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a9fe8bcf749ad7bb01fd517cd839e05d8">m_constraintError</a>[srow] = k * m_twistCorrection;
<a name="l00230"></a>00230         <span class="keywordflow">if</span>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea7c4ee7313641e9762ff905341cab3cd6">BT_CONETWIST_FLAGS_ANG_CFM</a>)
<a name="l00231"></a>00231         {
<a name="l00232"></a>00232             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a707419a1794b57aa73447fd3faec0dca">cfm</a>[srow] = m_angCFM;
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         <span class="keywordflow">if</span>(m_twistSpan &gt; 0.0f)
<a name="l00235"></a>00235         {
<a name="l00236"></a>00236 
<a name="l00237"></a>00237             <span class="keywordflow">if</span>(m_twistCorrection &gt; 0.0f)
<a name="l00238"></a>00238             {
<a name="l00239"></a>00239                 info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow] = 0;
<a name="l00240"></a>00240                 info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00241"></a>00241             } 
<a name="l00242"></a>00242             <span class="keywordflow">else</span>
<a name="l00243"></a>00243             {
<a name="l00244"></a>00244                 info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow] = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00245"></a>00245                 info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow] = 0;
<a name="l00246"></a>00246             } 
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248         <span class="keywordflow">else</span>
<a name="l00249"></a>00249         {
<a name="l00250"></a>00250             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a4cd03c3304c6db2237b29d326c8df892">m_lowerLimit</a>[srow] = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00251"></a>00251             info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#a315b73dee7455ddf2f4623901b71ba0a">m_upperLimit</a>[srow] = <a class="code" href="../../d0/d6b/btScalar_8h.html#a87dcd463392e45ddb5350989e566f34a">SIMD_INFINITY</a>;
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         srow += info-&gt;<a class="code" href="../../dc/d33/structbtTypedConstraint_1_1btConstraintInfo2.html#af54818ed7fb32e094ad8de4a342ab764">rowskip</a>;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256     
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a423ae402c9cc25dde3ae5dd338ed5f6d">00259</a> <span class="keywordtype">void</span>    <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a423ae402c9cc25dde3ae5dd338ed5f6d" title="internal method used by the constraint solver, don&#39;t use them directly">btConeTwistConstraint::buildJacobian</a>()
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (m_useSolveConstraintObsolete)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         <a class="code" href="../../df/daa/classbtTypedConstraint.html#a08eaed5868c21916a59d5dc4071775d4">m_appliedImpulse</a> = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00264"></a>00264         m_accTwistLimitImpulse = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00265"></a>00265         m_accSwingLimitImpulse = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00266"></a>00266         m_accMotorImpulse = btVector3(0.,0.,0.);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         <span class="keywordflow">if</span> (!m_angularOnly)
<a name="l00269"></a>00269         {
<a name="l00270"></a>00270             btVector3 pivotAInW = <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>()*m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00271"></a>00271             btVector3 pivotBInW = <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>()*m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00272"></a>00272             btVector3 relPos = pivotBInW - pivotAInW;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274             btVector3 normal[3];
<a name="l00275"></a>00275             <span class="keywordflow">if</span> (relPos.length2() &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00276"></a>00276             {
<a name="l00277"></a>00277                 normal[0] = relPos.normalized();
<a name="l00278"></a>00278             }
<a name="l00279"></a>00279             <span class="keywordflow">else</span>
<a name="l00280"></a>00280             {
<a name="l00281"></a>00281                 normal[0].setValue(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.0),0,0);
<a name="l00282"></a>00282             }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284             <a class="code" href="../../d2/dd0/btVector3_8h.html#a17d43dc0b1e36c2f3dd5b7aeaf930989">btPlaneSpace1</a>(normal[0], normal[1], normal[2]);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;3;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00287"></a>00287             {
<a name="l00288"></a>00288                 <span class="keyword">new</span> (&amp;m_jac[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) btJacobianEntry(
<a name="l00289"></a>00289                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#aa7fe855a2910c515482576ee08b2f455" title="Return the transpose of the matrix.">transpose</a>(),
<a name="l00290"></a>00290                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#aa7fe855a2910c515482576ee08b2f455" title="Return the transpose of the matrix.">transpose</a>(),
<a name="l00291"></a>00291                 pivotAInW - <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad87d0db677fd8f074178d993f0ff1c42">getCenterOfMassPosition</a>(),
<a name="l00292"></a>00292                 pivotBInW - <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad87d0db677fd8f074178d993f0ff1c42">getCenterOfMassPosition</a>(),
<a name="l00293"></a>00293                 normal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>],
<a name="l00294"></a>00294                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#acaf08c40e69ccacaf50a64e03519e3a2">getInvInertiaDiagLocal</a>(),
<a name="l00295"></a>00295                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aff8193d59d882da6de7236b2410d7e52">getInvMass</a>(),
<a name="l00296"></a>00296                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#acaf08c40e69ccacaf50a64e03519e3a2">getInvInertiaDiagLocal</a>(),
<a name="l00297"></a>00297                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aff8193d59d882da6de7236b2410d7e52">getInvMass</a>());
<a name="l00298"></a>00298             }
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac367e0423a33ec00b18223921db6bbb0">calcAngleInfo2</a>(<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>(),<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>());
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a507981abeff683a947a05534ea110e82">00307</a> <span class="keywordtype">void</span>    <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a507981abeff683a947a05534ea110e82" title="internal method used by the constraint solver, don&#39;t use them directly">btConeTwistConstraint::solveConstraintObsolete</a>(<a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>&amp; bodyA,<a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>&amp; bodyB,<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>   timeStep)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309 <span class="preprocessor">    #ifndef __SPU__</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (m_useSolveConstraintObsolete)
<a name="l00311"></a>00311     {
<a name="l00312"></a>00312         btVector3 pivotAInW = <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>()*m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00313"></a>00313         btVector3 pivotBInW = <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>()*m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> tau = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.3);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="comment">//linear part</span>
<a name="l00318"></a>00318         <span class="keywordflow">if</span> (!m_angularOnly)
<a name="l00319"></a>00319         {
<a name="l00320"></a>00320             btVector3 rel_pos1 = pivotAInW - <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad87d0db677fd8f074178d993f0ff1c42">getCenterOfMassPosition</a>(); 
<a name="l00321"></a>00321             btVector3 rel_pos2 = pivotBInW - <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad87d0db677fd8f074178d993f0ff1c42">getCenterOfMassPosition</a>();
<a name="l00322"></a>00322 
<a name="l00323"></a>00323             btVector3 vel1;
<a name="l00324"></a>00324             bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad9f10190f7da87d6f6b57424426cad92">internalGetVelocityInLocalPointObsolete</a>(rel_pos1,vel1);
<a name="l00325"></a>00325             btVector3 vel2;
<a name="l00326"></a>00326             bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#ad9f10190f7da87d6f6b57424426cad92">internalGetVelocityInLocalPointObsolete</a>(rel_pos2,vel2);
<a name="l00327"></a>00327             btVector3 vel = vel1 - vel2;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;3;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00330"></a>00330             {       
<a name="l00331"></a>00331                 <span class="keyword">const</span> btVector3&amp; normal = m_jac[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].m_linearJointAxis;
<a name="l00332"></a>00332                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> jacDiagABInv = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.) / m_jac[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].getDiagonal();
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> rel_vel;
<a name="l00335"></a>00335                 rel_vel = normal.dot(vel);
<a name="l00336"></a>00336                 <span class="comment">//positional error (zeroth order error)</span>
<a name="l00337"></a>00337                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> depth = -(pivotAInW - pivotBInW).<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(normal); <span class="comment">//this is the error projected on the normal</span>
<a name="l00338"></a>00338                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> impulse = depth*tau/timeStep  * jacDiagABInv -  rel_vel * jacDiagABInv;
<a name="l00339"></a>00339                 <a class="code" href="../../df/daa/classbtTypedConstraint.html#a08eaed5868c21916a59d5dc4071775d4">m_appliedImpulse</a> += impulse;
<a name="l00340"></a>00340                 
<a name="l00341"></a>00341                 btVector3 ftorqueAxis1 = rel_pos1.cross(normal);
<a name="l00342"></a>00342                 btVector3 ftorqueAxis2 = rel_pos2.cross(normal);
<a name="l00343"></a>00343                 bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(normal*<a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aff8193d59d882da6de7236b2410d7e52">getInvMass</a>(), <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*ftorqueAxis1,impulse);
<a name="l00344"></a>00344                 bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(normal*<a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aff8193d59d882da6de7236b2410d7e52">getInvMass</a>(), <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*ftorqueAxis2,-impulse);
<a name="l00345"></a>00345         
<a name="l00346"></a>00346             }
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="comment">// apply motor</span>
<a name="l00350"></a>00350         <span class="keywordflow">if</span> (m_bMotorEnabled)
<a name="l00351"></a>00351         {
<a name="l00352"></a>00352             <span class="comment">// compute current and predicted transforms</span>
<a name="l00353"></a>00353             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trACur = <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>();
<a name="l00354"></a>00354             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trBCur = <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>();
<a name="l00355"></a>00355             btVector3 omegaA; bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(omegaA);
<a name="l00356"></a>00356             btVector3 omegaB; bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(omegaB);
<a name="l00357"></a>00357             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trAPred; trAPred.<a class="code" href="../../d4/d79/classbtTransform.html#ac95a4f502585b3c896001eb236293ce5" title="Set this transformation to the identity.">setIdentity</a>(); 
<a name="l00358"></a>00358             btVector3 zerovec(0,0,0);
<a name="l00359"></a>00359             <a class="code" href="../../d0/d66/classbtTransformUtil.html#ac943ee956ab17687013a60a5918b23e4">btTransformUtil::integrateTransform</a>(
<a name="l00360"></a>00360                 trACur, zerovec, omegaA, timeStep, trAPred);
<a name="l00361"></a>00361             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trBPred; trBPred.<a class="code" href="../../d4/d79/classbtTransform.html#ac95a4f502585b3c896001eb236293ce5" title="Set this transformation to the identity.">setIdentity</a>(); 
<a name="l00362"></a>00362             <a class="code" href="../../d0/d66/classbtTransformUtil.html#ac943ee956ab17687013a60a5918b23e4">btTransformUtil::integrateTransform</a>(
<a name="l00363"></a>00363                 trBCur, zerovec, omegaB, timeStep, trBPred);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365             <span class="comment">// compute desired transforms in world</span>
<a name="l00366"></a>00366             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trPose(m_qTarget);
<a name="l00367"></a>00367             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trABDes = m_rbBFrame * trPose * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#ab8bfe567b46a87ca917b29ad75ac383a" title="Return the inverse of this transform.">inverse</a>();
<a name="l00368"></a>00368             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trADes = trBPred * trABDes;
<a name="l00369"></a>00369             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trBDes = trAPred * trABDes.<a class="code" href="../../d4/d79/classbtTransform.html#ab8bfe567b46a87ca917b29ad75ac383a" title="Return the inverse of this transform.">inverse</a>();
<a name="l00370"></a>00370 
<a name="l00371"></a>00371             <span class="comment">// compute desired omegas in world</span>
<a name="l00372"></a>00372             btVector3 omegaADes, omegaBDes;
<a name="l00373"></a>00373             
<a name="l00374"></a>00374             <a class="code" href="../../d0/d66/classbtTransformUtil.html#adea3509ccb6eb65675a102c80aa1b312">btTransformUtil::calculateVelocity</a>(trACur, trADes, timeStep, zerovec, omegaADes);
<a name="l00375"></a>00375             <a class="code" href="../../d0/d66/classbtTransformUtil.html#adea3509ccb6eb65675a102c80aa1b312">btTransformUtil::calculateVelocity</a>(trBCur, trBDes, timeStep, zerovec, omegaBDes);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377             <span class="comment">// compute delta omegas</span>
<a name="l00378"></a>00378             btVector3 dOmegaA = omegaADes - omegaA;
<a name="l00379"></a>00379             btVector3 dOmegaB = omegaBDes - omegaB;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381             <span class="comment">// compute weighted avg axis of dOmega (weighting based on inertias)</span>
<a name="l00382"></a>00382             btVector3 axisA, axisB;
<a name="l00383"></a>00383             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> kAxisAInv = 0, kAxisBInv = 0;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <span class="keywordflow">if</span> (dOmegaA.length2() &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00386"></a>00386             {
<a name="l00387"></a>00387                 axisA = dOmegaA.normalized();
<a name="l00388"></a>00388                 kAxisAInv = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(axisA);
<a name="l00389"></a>00389             }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391             <span class="keywordflow">if</span> (dOmegaB.length2() &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00392"></a>00392             {
<a name="l00393"></a>00393                 axisB = dOmegaB.normalized();
<a name="l00394"></a>00394                 kAxisBInv = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a14e3b3af87cc8f30e0c9c160f02ce3af">getRigidBodyB</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(axisB);
<a name="l00395"></a>00395             }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397             btVector3 avgAxis = kAxisAInv * axisA + kAxisBInv * axisB;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399             <span class="keyword">static</span> <span class="keywordtype">bool</span> bDoTorque = <span class="keyword">true</span>;
<a name="l00400"></a>00400             <span class="keywordflow">if</span> (bDoTorque &amp;&amp; avgAxis.length2() &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00401"></a>00401             {
<a name="l00402"></a>00402                 avgAxis.normalize();
<a name="l00403"></a>00403                 kAxisAInv = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(avgAxis);
<a name="l00404"></a>00404                 kAxisBInv = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a14e3b3af87cc8f30e0c9c160f02ce3af">getRigidBodyB</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(avgAxis);
<a name="l00405"></a>00405                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> kInvCombined = kAxisAInv + kAxisBInv;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407                 btVector3 impulse = (kAxisAInv * dOmegaA - kAxisBInv * dOmegaB) /
<a name="l00408"></a>00408                                     (kInvCombined * kInvCombined);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410                 <span class="keywordflow">if</span> (m_maxMotorImpulse &gt;= 0)
<a name="l00411"></a>00411                 {
<a name="l00412"></a>00412                     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> fMaxImpulse = m_maxMotorImpulse;
<a name="l00413"></a>00413                     <span class="keywordflow">if</span> (m_bNormalizedMotorStrength)
<a name="l00414"></a>00414                         fMaxImpulse = fMaxImpulse/kAxisAInv;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                     btVector3 newUnclampedAccImpulse = m_accMotorImpulse + impulse;
<a name="l00417"></a>00417                     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>  newUnclampedMag = newUnclampedAccImpulse.length();
<a name="l00418"></a>00418                     <span class="keywordflow">if</span> (newUnclampedMag &gt; fMaxImpulse)
<a name="l00419"></a>00419                     {
<a name="l00420"></a>00420                         newUnclampedAccImpulse.normalize();
<a name="l00421"></a>00421                         newUnclampedAccImpulse *= fMaxImpulse;
<a name="l00422"></a>00422                         impulse = newUnclampedAccImpulse - m_accMotorImpulse;
<a name="l00423"></a>00423                     }
<a name="l00424"></a>00424                     m_accMotorImpulse += impulse;
<a name="l00425"></a>00425                 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>  impulseMag  = impulse.length();
<a name="l00428"></a>00428                 btVector3 impulseAxis =  impulse / impulseMag;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                 bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*impulseAxis, impulseMag);
<a name="l00431"></a>00431                 bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*impulseAxis, -impulseMag);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433             }
<a name="l00434"></a>00434         }
<a name="l00435"></a>00435         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_damping &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>) <span class="comment">// no motor: do a little damping</span>
<a name="l00436"></a>00436         {
<a name="l00437"></a>00437             btVector3 angVelA; bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(angVelA);
<a name="l00438"></a>00438             btVector3 angVelB; bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(angVelB);
<a name="l00439"></a>00439             btVector3 relVel = angVelB - angVelA;
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (relVel.length2() &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00441"></a>00441             {
<a name="l00442"></a>00442                 btVector3 relVelAxis = relVel.normalized();
<a name="l00443"></a>00443                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> m_kDamping =  <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.) /
<a name="l00444"></a>00444                     (<a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(relVelAxis) +
<a name="l00445"></a>00445                      <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a14e3b3af87cc8f30e0c9c160f02ce3af">getRigidBodyB</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f0d52514a70e7e010a055e9aab742b0">computeAngularImpulseDenominator</a>(relVelAxis));
<a name="l00446"></a>00446                 btVector3 impulse = m_damping * m_kDamping * relVel;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>  impulseMag  = impulse.length();
<a name="l00449"></a>00449                 btVector3 impulseAxis = impulse / impulseMag;
<a name="l00450"></a>00450                 bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*impulseAxis, impulseMag);
<a name="l00451"></a>00451                 bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*impulseAxis, -impulseMag);
<a name="l00452"></a>00452             }
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455         <span class="comment">// joint limits</span>
<a name="l00456"></a>00456         {
<a name="l00458"></a>00458             btVector3 angVelA;
<a name="l00459"></a>00459             bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(angVelA);
<a name="l00460"></a>00460             btVector3 angVelB;
<a name="l00461"></a>00461             bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a9f051eca18ff96ea69d0a01703333d72">internalGetAngularVelocity</a>(angVelB);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463             <span class="comment">// solve swing limit</span>
<a name="l00464"></a>00464             <span class="keywordflow">if</span> (m_solveSwingLimit)
<a name="l00465"></a>00465             {
<a name="l00466"></a>00466                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> amplitude = m_swingLimitRatio * m_swingCorrection*m_biasFactor/timeStep;
<a name="l00467"></a>00467                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> relSwingVel = (angVelB - angVelA).<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(m_swingAxis);
<a name="l00468"></a>00468                 <span class="keywordflow">if</span> (relSwingVel &gt; 0)
<a name="l00469"></a>00469                     amplitude += m_swingLimitRatio * relSwingVel * m_relaxationFactor;
<a name="l00470"></a>00470                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> impulseMag = amplitude * m_kSwing;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                 <span class="comment">// Clamp the accumulated impulse</span>
<a name="l00473"></a>00473                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> temp = m_accSwingLimitImpulse;
<a name="l00474"></a>00474                 m_accSwingLimitImpulse = <a class="code" href="../../da/d05/btMinMax_8h.html#ac663fae9d94f02fb5a2d45828aa91ba1">btMax</a>(m_accSwingLimitImpulse + impulseMag, <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.0) );
<a name="l00475"></a>00475                 impulseMag = m_accSwingLimitImpulse - temp;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                 btVector3 impulse = m_swingAxis * impulseMag;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479                 <span class="comment">// don&#39;t let cone response affect twist</span>
<a name="l00480"></a>00480                 <span class="comment">// (this can happen since body A&#39;s twist doesn&#39;t match body B&#39;s AND we use an elliptical cone limit)</span>
<a name="l00481"></a>00481                 {
<a name="l00482"></a>00482                     btVector3 impulseTwistCouple = impulse.dot(m_twistAxisA) * m_twistAxisA;
<a name="l00483"></a>00483                     btVector3 impulseNoTwistCouple = impulse - impulseTwistCouple;
<a name="l00484"></a>00484                     impulse = impulseNoTwistCouple;
<a name="l00485"></a>00485                 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                 impulseMag = impulse.length();
<a name="l00488"></a>00488                 btVector3 noTwistSwingAxis = impulse / impulseMag;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490                 bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*noTwistSwingAxis, impulseMag);
<a name="l00491"></a>00491                 bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*noTwistSwingAxis, -impulseMag);
<a name="l00492"></a>00492             }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 
<a name="l00495"></a>00495             <span class="comment">// solve twist limit</span>
<a name="l00496"></a>00496             <span class="keywordflow">if</span> (m_solveTwistLimit)
<a name="l00497"></a>00497             {
<a name="l00498"></a>00498                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> amplitude = m_twistLimitRatio * m_twistCorrection*m_biasFactor/timeStep;
<a name="l00499"></a>00499                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> relTwistVel = (angVelB - angVelA).<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>( m_twistAxis );
<a name="l00500"></a>00500                 <span class="keywordflow">if</span> (relTwistVel &gt; 0) <span class="comment">// only damp when moving towards limit (m_twistAxis flipping is important)</span>
<a name="l00501"></a>00501                     amplitude += m_twistLimitRatio * relTwistVel * m_relaxationFactor;
<a name="l00502"></a>00502                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> impulseMag = amplitude * m_kTwist;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504                 <span class="comment">// Clamp the accumulated impulse</span>
<a name="l00505"></a>00505                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> temp = m_accTwistLimitImpulse;
<a name="l00506"></a>00506                 m_accTwistLimitImpulse = <a class="code" href="../../da/d05/btMinMax_8h.html#ac663fae9d94f02fb5a2d45828aa91ba1">btMax</a>(m_accTwistLimitImpulse + impulseMag, <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.0) );
<a name="l00507"></a>00507                 impulseMag = m_accTwistLimitImpulse - temp;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509                 btVector3 impulse = m_twistAxis * impulseMag;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511                 bodyA.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*m_twistAxis,impulseMag);
<a name="l00512"></a>00512                 bodyB.<a class="code" href="../../d9/dea/classbtRigidBody.html#a1c71450dbbd8775c12ebb127508a7d15">internalApplyImpulse</a>(btVector3(0,0,0), <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#aac3284d52f4dd4628a0e0ffbc6e05908">getInvInertiaTensorWorld</a>()*m_twistAxis,-impulseMag);
<a name="l00513"></a>00513             }       
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 <span class="preprocessor">#else</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span><a class="code" href="../../d0/d6b/btScalar_8h.html#aff3e6078c073f6ba0edb95353f2c2c62">btAssert</a>(0);
<a name="l00518"></a>00518 <span class="preprocessor">#endif //__SPU__</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>}
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ae0a662c20999f24aebc18888ed0246f7">00524</a> <span class="keywordtype">void</span>    <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ae0a662c20999f24aebc18888ed0246f7">btConeTwistConstraint::updateRHS</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>   timeStep)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     (void)timeStep;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 
<a name="l00531"></a>00531 <span class="preprocessor">#ifndef __SPU__</span>
<a name="l00532"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aaaf3cc9dcbbc551314ba3f4bdabf437d">00532</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aaaf3cc9dcbbc551314ba3f4bdabf437d">btConeTwistConstraint::calcAngleInfo</a>()
<a name="l00533"></a>00533 {
<a name="l00534"></a>00534     m_swingCorrection = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00535"></a>00535     m_twistLimitSign = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00536"></a>00536     m_solveTwistLimit = <span class="keyword">false</span>;
<a name="l00537"></a>00537     m_solveSwingLimit = <span class="keyword">false</span>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     btVector3 b1Axis1,b1Axis2,b1Axis3;
<a name="l00540"></a>00540     btVector3 b2Axis1,b2Axis2;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     b1Axis1 = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * this-&gt;m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(0);
<a name="l00543"></a>00543     b2Axis1 = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a14e3b3af87cc8f30e0c9c160f02ce3af">getRigidBodyB</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * this-&gt;m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(0);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swing1=<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.),swing2 = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swx=<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.),swy = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00548"></a>00548     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a> = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(10.);
<a name="l00549"></a>00549     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> fact;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">// Get Frame into world space</span>
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (m_swingSpan1 &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f))
<a name="l00553"></a>00553     {
<a name="l00554"></a>00554         b1Axis2 = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * this-&gt;m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(1);
<a name="l00555"></a>00555         swx = b2Axis1.dot(b1Axis1);
<a name="l00556"></a>00556         swy = b2Axis1.dot(b1Axis2);
<a name="l00557"></a>00557         swing1  = <a class="code" href="../../d0/d6b/btScalar_8h.html#a66aac39acce2b5c6d043d390f3ef4d4f">btAtan2Fast</a>(swy, swx);
<a name="l00558"></a>00558         fact = (swy*swy + swx*swx) * thresh * thresh;
<a name="l00559"></a>00559         fact = fact / (fact + <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.0));
<a name="l00560"></a>00560         swing1 *= fact; 
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (m_swingSpan2 &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f))
<a name="l00564"></a>00564     {
<a name="l00565"></a>00565         b1Axis3 = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a3f95f5c926b999d41cca2ccc8d529f10">getRigidBodyA</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * this-&gt;m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(2);         
<a name="l00566"></a>00566         swx = b2Axis1.dot(b1Axis1);
<a name="l00567"></a>00567         swy = b2Axis1.dot(b1Axis3);
<a name="l00568"></a>00568         swing2  = <a class="code" href="../../d0/d6b/btScalar_8h.html#a66aac39acce2b5c6d043d390f3ef4d4f">btAtan2Fast</a>(swy, swx);
<a name="l00569"></a>00569         fact = (swy*swy + swx*swx) * thresh * thresh;
<a name="l00570"></a>00570         fact = fact / (fact + <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.0));
<a name="l00571"></a>00571         swing2 *= fact; 
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> RMaxAngle1Sq = 1.0f / (m_swingSpan1*m_swingSpan1);     
<a name="l00575"></a>00575     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> RMaxAngle2Sq = 1.0f / (m_swingSpan2*m_swingSpan2); 
<a name="l00576"></a>00576     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> EllipseAngle = <a class="code" href="../../d0/d6b/btScalar_8h.html#a4c4bd8e065ab617f4e37273d76e6d581">btFabs</a>(swing1*swing1)* RMaxAngle1Sq + <a class="code" href="../../d0/d6b/btScalar_8h.html#a4c4bd8e065ab617f4e37273d76e6d581">btFabs</a>(swing2*swing2) * RMaxAngle2Sq;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (EllipseAngle &gt; 1.0f)
<a name="l00579"></a>00579     {
<a name="l00580"></a>00580         m_swingCorrection = EllipseAngle-1.0f;
<a name="l00581"></a>00581         m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00582"></a>00582         <span class="comment">// Calculate necessary axis &amp; factors</span>
<a name="l00583"></a>00583         m_swingAxis = b2Axis1.cross(b1Axis2* b2Axis1.dot(b1Axis2) + b1Axis3* b2Axis1.dot(b1Axis3));
<a name="l00584"></a>00584         m_swingAxis.normalize();
<a name="l00585"></a>00585         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swingAxisSign = (b2Axis1.dot(b1Axis1) &gt;= 0.0f) ? 1.0f : -1.0f;
<a name="l00586"></a>00586         m_swingAxis *= swingAxisSign;
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="comment">// Twist limits</span>
<a name="l00590"></a>00590     <span class="keywordflow">if</span> (m_twistSpan &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.))
<a name="l00591"></a>00591     {
<a name="l00592"></a>00592         btVector3 b2Axis2 = <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a14e3b3af87cc8f30e0c9c160f02ce3af">getRigidBodyB</a>().<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>().<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * this-&gt;m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(1);
<a name="l00593"></a>00593         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> rotationArc = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a2884ed105928c310d48521fcacf39eb2">shortestArcQuat</a>(b2Axis1,b1Axis1);
<a name="l00594"></a>00594         btVector3 TwistRef = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(rotationArc,b2Axis2); 
<a name="l00595"></a>00595         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> twist = <a class="code" href="../../d0/d6b/btScalar_8h.html#a66aac39acce2b5c6d043d390f3ef4d4f">btAtan2Fast</a>( TwistRef.dot(b1Axis3), TwistRef.dot(b1Axis2) );
<a name="l00596"></a>00596         m_twistAngle = twist;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="comment">//      btScalar lockedFreeFactor = (m_twistSpan &gt; btScalar(0.05f)) ? m_limitSoftness : btScalar(0.);</span>
<a name="l00599"></a>00599         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> lockedFreeFactor = (m_twistSpan &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f)) ? <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.0f) : <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00600"></a>00600         <span class="keywordflow">if</span> (twist &lt;= -m_twistSpan*lockedFreeFactor)
<a name="l00601"></a>00601         {
<a name="l00602"></a>00602             m_twistCorrection = -(twist + m_twistSpan);
<a name="l00603"></a>00603             m_solveTwistLimit = <span class="keyword">true</span>;
<a name="l00604"></a>00604             m_twistAxis = (b2Axis1 + b1Axis1) * 0.5f;
<a name="l00605"></a>00605             m_twistAxis.normalize();
<a name="l00606"></a>00606             m_twistAxis *= -1.0f;
<a name="l00607"></a>00607         }
<a name="l00608"></a>00608         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (twist &gt;  m_twistSpan*lockedFreeFactor)
<a name="l00609"></a>00609         {
<a name="l00610"></a>00610             m_twistCorrection = (twist - m_twistSpan);
<a name="l00611"></a>00611             m_solveTwistLimit = <span class="keyword">true</span>;
<a name="l00612"></a>00612             m_twistAxis = (b2Axis1 + b1Axis1) * 0.5f;
<a name="l00613"></a>00613             m_twistAxis.normalize();
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 <span class="preprocessor">#endif //__SPU__</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span>
<a name="l00619"></a>00619 <span class="keyword">static</span> btVector3 <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#a94d3f9d6691cd71064c1603e330798d9">vTwist</a>(1,0,0); <span class="comment">// twist axis in constraint&#39;s space</span>
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac367e0423a33ec00b18223921db6bbb0">00623</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac367e0423a33ec00b18223921db6bbb0">btConeTwistConstraint::calcAngleInfo2</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; transA, <span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; transB, <span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; invInertiaWorldA,<span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; invInertiaWorldB)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625     m_swingCorrection = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00626"></a>00626     m_twistLimitSign = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.);
<a name="l00627"></a>00627     m_solveTwistLimit = <span class="keyword">false</span>;
<a name="l00628"></a>00628     m_solveSwingLimit = <span class="keyword">false</span>;
<a name="l00629"></a>00629     <span class="comment">// compute rotation of A wrt B (in constraint space)</span>
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (m_bMotorEnabled &amp;&amp; (!m_useSolveConstraintObsolete))
<a name="l00631"></a>00631     {   <span class="comment">// it is assumed that setMotorTarget() was alredy called </span>
<a name="l00632"></a>00632         <span class="comment">// and motor target m_qTarget is within constraint limits</span>
<a name="l00633"></a>00633         <span class="comment">// TODO : split rotation to pure swing and pure twist</span>
<a name="l00634"></a>00634         <span class="comment">// compute desired transforms in world</span>
<a name="l00635"></a>00635         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trPose(m_qTarget);
<a name="l00636"></a>00636         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trA = transA * m_rbAFrame;
<a name="l00637"></a>00637         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trB = transB * m_rbBFrame;
<a name="l00638"></a>00638         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trDeltaAB = trB * trPose * trA.<a class="code" href="../../d4/d79/classbtTransform.html#ab8bfe567b46a87ca917b29ad75ac383a" title="Return the inverse of this transform.">inverse</a>();
<a name="l00639"></a>00639         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qDeltaAB = trDeltaAB.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00640"></a>00640         btVector3 swingAxis =   btVector3(qDeltaAB.x(), qDeltaAB.y(), qDeltaAB.z());
<a name="l00641"></a>00641         m_swingAxis = swingAxis;
<a name="l00642"></a>00642         m_swingAxis.normalize();
<a name="l00643"></a>00643         m_swingCorrection = qDeltaAB.<a class="code" href="../../d2/d33/classbtQuaternion.html#a4071aa455c5850f651be8d49d3db7133" title="Return the angle of rotation represented by this quaternion.">getAngle</a>();
<a name="l00644"></a>00644         <span class="keywordflow">if</span>(!<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(m_swingCorrection))
<a name="l00645"></a>00645         {
<a name="l00646"></a>00646             m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648         <span class="keywordflow">return</span>;
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     {
<a name="l00653"></a>00653         <span class="comment">// compute rotation of A wrt B (in constraint space)</span>
<a name="l00654"></a>00654         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qA = transA.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>() * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00655"></a>00655         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qB = transB.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>() * m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00656"></a>00656         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qAB = qB.<a class="code" href="../../d2/d33/classbtQuaternion.html#aa8894800b346577a9a568048d10e09d0" title="Return the inverse of this quaternion.">inverse</a>() * qA;
<a name="l00657"></a>00657         <span class="comment">// split rotation into cone and twist</span>
<a name="l00658"></a>00658         <span class="comment">// (all this is done from B&#39;s perspective. Maybe I should be averaging axes...)</span>
<a name="l00659"></a>00659         btVector3 vConeNoTwist = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(qAB, <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#a94d3f9d6691cd71064c1603e330798d9">vTwist</a>); vConeNoTwist.normalize();
<a name="l00660"></a>00660         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qABCone  = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a2884ed105928c310d48521fcacf39eb2">shortestArcQuat</a>(<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#a94d3f9d6691cd71064c1603e330798d9">vTwist</a>, vConeNoTwist); qABCone.<a class="code" href="../../d2/d33/classbtQuaternion.html#adb5cd1eb8145a906f9f47857c498d3d6" title="Normalize the quaternion Such that x^2 + y^2 + z^2 +w^2 = 1.">normalize</a>();
<a name="l00661"></a>00661         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qABTwist = qABCone.<a class="code" href="../../d2/d33/classbtQuaternion.html#aa8894800b346577a9a568048d10e09d0" title="Return the inverse of this quaternion.">inverse</a>() * qAB; qABTwist.<a class="code" href="../../d2/d33/classbtQuaternion.html#adb5cd1eb8145a906f9f47857c498d3d6" title="Normalize the quaternion Such that x^2 + y^2 + z^2 +w^2 = 1.">normalize</a>();
<a name="l00662"></a>00662 
<a name="l00663"></a>00663         <span class="keywordflow">if</span> (m_swingSpan1 &gt;= m_fixThresh &amp;&amp; m_swingSpan2 &gt;= m_fixThresh)
<a name="l00664"></a>00664         {
<a name="l00665"></a>00665             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swingAngle, swingLimit = 0; btVector3 swingAxis;
<a name="l00666"></a>00666             <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9598f57371abe6a8c647a23038d51b46">computeConeLimitInfo</a>(qABCone, swingAngle, swingAxis, swingLimit);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (swingAngle &gt; swingLimit * m_limitSoftness)
<a name="l00669"></a>00669             {
<a name="l00670"></a>00670                 m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672                 <span class="comment">// compute limit ratio: 0-&gt;1, where</span>
<a name="l00673"></a>00673                 <span class="comment">// 0 == beginning of soft limit</span>
<a name="l00674"></a>00674                 <span class="comment">// 1 == hard/real limit</span>
<a name="l00675"></a>00675                 m_swingLimitRatio = 1.f;
<a name="l00676"></a>00676                 <span class="keywordflow">if</span> (swingAngle &lt; swingLimit &amp;&amp; m_limitSoftness &lt; 1.f - <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00677"></a>00677                 {
<a name="l00678"></a>00678                     m_swingLimitRatio = (swingAngle - swingLimit * m_limitSoftness)/
<a name="l00679"></a>00679                                         (swingLimit - swingLimit * m_limitSoftness);
<a name="l00680"></a>00680                 }               
<a name="l00681"></a>00681 
<a name="l00682"></a>00682                 <span class="comment">// swing correction tries to get back to soft limit</span>
<a name="l00683"></a>00683                 m_swingCorrection = swingAngle - (swingLimit * m_limitSoftness);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685                 <span class="comment">// adjustment of swing axis (based on ellipse normal)</span>
<a name="l00686"></a>00686                 <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9cc2bd57668f04e5a662b01d9eda8e11">adjustSwingAxisToUseEllipseNormal</a>(swingAxis);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688                 <span class="comment">// Calculate necessary axis &amp; factors       </span>
<a name="l00689"></a>00689                 m_swingAxis = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(qB, -swingAxis);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691                 m_twistAxisA.setValue(0,0,0);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                 m_kSwing =  <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.) /
<a name="l00694"></a>00694                     (<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">computeAngularImpulseDenominator</a>(m_swingAxis,invInertiaWorldA) +
<a name="l00695"></a>00695                      <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">computeAngularImpulseDenominator</a>(m_swingAxis,invInertiaWorldB));
<a name="l00696"></a>00696             }
<a name="l00697"></a>00697         }
<a name="l00698"></a>00698         <span class="keywordflow">else</span>
<a name="l00699"></a>00699         {
<a name="l00700"></a>00700             <span class="comment">// you haven&#39;t set any limits;</span>
<a name="l00701"></a>00701             <span class="comment">// or you&#39;re trying to set at least one of the swing limits too small. (if so, do you really want a conetwist constraint?)</span>
<a name="l00702"></a>00702             <span class="comment">// anyway, we have either hinge or fixed joint</span>
<a name="l00703"></a>00703             btVector3 ivA = transA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(0);
<a name="l00704"></a>00704             btVector3 jvA = transA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(1);
<a name="l00705"></a>00705             btVector3 kvA = transA.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(2);
<a name="l00706"></a>00706             btVector3 ivB = transB.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>() * m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a28f33e6a9c017b6199a099992dc31ec1" title="Get a column of the matrix as a vector.">getColumn</a>(0);
<a name="l00707"></a>00707             btVector3 target;
<a name="l00708"></a>00708             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> x = ivB.dot(ivA);
<a name="l00709"></a>00709             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> y = ivB.dot(jvA);
<a name="l00710"></a>00710             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> z = ivB.dot(kvA);
<a name="l00711"></a>00711             <span class="keywordflow">if</span>((m_swingSpan1 &lt; m_fixThresh) &amp;&amp; (m_swingSpan2 &lt; m_fixThresh))
<a name="l00712"></a>00712             { <span class="comment">// fixed. We&#39;ll need to add one more row to constraint</span>
<a name="l00713"></a>00713                 <span class="keywordflow">if</span>((!<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(y)) || (!(<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(z))))
<a name="l00714"></a>00714                 {
<a name="l00715"></a>00715                     m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00716"></a>00716                     m_swingAxis = -ivB.cross(ivA);
<a name="l00717"></a>00717                 }
<a name="l00718"></a>00718             }
<a name="l00719"></a>00719             <span class="keywordflow">else</span>
<a name="l00720"></a>00720             {
<a name="l00721"></a>00721                 <span class="keywordflow">if</span>(m_swingSpan1 &lt; m_fixThresh)
<a name="l00722"></a>00722                 { <span class="comment">// hinge around Y axis</span>
<a name="l00723"></a>00723                     <span class="keywordflow">if</span>(!(<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(y)))
<a name="l00724"></a>00724                     {
<a name="l00725"></a>00725                         m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00726"></a>00726                         <span class="keywordflow">if</span>(m_swingSpan2 &gt;= m_fixThresh)
<a name="l00727"></a>00727                         {
<a name="l00728"></a>00728                             y = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f);
<a name="l00729"></a>00729                             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> span2 = <a class="code" href="../../d0/d6b/btScalar_8h.html#ac7d89f182c6f2997f9a50fe963f6f986">btAtan2</a>(z, x);
<a name="l00730"></a>00730                             <span class="keywordflow">if</span>(span2 &gt; m_swingSpan2)
<a name="l00731"></a>00731                             {
<a name="l00732"></a>00732                                 x = <a class="code" href="../../d0/d6b/btScalar_8h.html#a08cebf88560180c665f205810cc02d0f">btCos</a>(m_swingSpan2);
<a name="l00733"></a>00733                                 z = <a class="code" href="../../d0/d6b/btScalar_8h.html#a21de15ec6359a37d7876fa26be384a4b">btSin</a>(m_swingSpan2);
<a name="l00734"></a>00734                             }
<a name="l00735"></a>00735                             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(span2 &lt; -m_swingSpan2)
<a name="l00736"></a>00736                             {
<a name="l00737"></a>00737                                 x =  <a class="code" href="../../d0/d6b/btScalar_8h.html#a08cebf88560180c665f205810cc02d0f">btCos</a>(m_swingSpan2);
<a name="l00738"></a>00738                                 z = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a21de15ec6359a37d7876fa26be384a4b">btSin</a>(m_swingSpan2);
<a name="l00739"></a>00739                             }
<a name="l00740"></a>00740                         }
<a name="l00741"></a>00741                     }
<a name="l00742"></a>00742                 }
<a name="l00743"></a>00743                 <span class="keywordflow">else</span>
<a name="l00744"></a>00744                 { <span class="comment">// hinge around Z axis</span>
<a name="l00745"></a>00745                     <span class="keywordflow">if</span>(!<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(z))
<a name="l00746"></a>00746                     {
<a name="l00747"></a>00747                         m_solveSwingLimit = <span class="keyword">true</span>;
<a name="l00748"></a>00748                         <span class="keywordflow">if</span>(m_swingSpan1 &gt;= m_fixThresh)
<a name="l00749"></a>00749                         {
<a name="l00750"></a>00750                             z = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f);
<a name="l00751"></a>00751                             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> span1 = <a class="code" href="../../d0/d6b/btScalar_8h.html#ac7d89f182c6f2997f9a50fe963f6f986">btAtan2</a>(y, x);
<a name="l00752"></a>00752                             <span class="keywordflow">if</span>(span1 &gt; m_swingSpan1)
<a name="l00753"></a>00753                             {
<a name="l00754"></a>00754                                 x = <a class="code" href="../../d0/d6b/btScalar_8h.html#a08cebf88560180c665f205810cc02d0f">btCos</a>(m_swingSpan1);
<a name="l00755"></a>00755                                 y = <a class="code" href="../../d0/d6b/btScalar_8h.html#a21de15ec6359a37d7876fa26be384a4b">btSin</a>(m_swingSpan1);
<a name="l00756"></a>00756                             }
<a name="l00757"></a>00757                             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(span1 &lt; -m_swingSpan1)
<a name="l00758"></a>00758                             {
<a name="l00759"></a>00759                                 x =  <a class="code" href="../../d0/d6b/btScalar_8h.html#a08cebf88560180c665f205810cc02d0f">btCos</a>(m_swingSpan1);
<a name="l00760"></a>00760                                 y = -<a class="code" href="../../d0/d6b/btScalar_8h.html#a21de15ec6359a37d7876fa26be384a4b">btSin</a>(m_swingSpan1);
<a name="l00761"></a>00761                             }
<a name="l00762"></a>00762                         }
<a name="l00763"></a>00763                     }
<a name="l00764"></a>00764                 }
<a name="l00765"></a>00765                 target[0] = x * ivA[0] + y * jvA[0] + z * kvA[0];
<a name="l00766"></a>00766                 target[1] = x * ivA[1] + y * jvA[1] + z * kvA[1];
<a name="l00767"></a>00767                 target[2] = x * ivA[2] + y * jvA[2] + z * kvA[2];
<a name="l00768"></a>00768                 target.normalize();
<a name="l00769"></a>00769                 m_swingAxis = -ivB.cross(target);
<a name="l00770"></a>00770                 m_swingCorrection = m_swingAxis.length();
<a name="l00771"></a>00771                 m_swingAxis.normalize();
<a name="l00772"></a>00772             }
<a name="l00773"></a>00773         }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (m_twistSpan &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f))
<a name="l00776"></a>00776         {
<a name="l00777"></a>00777             btVector3 twistAxis;
<a name="l00778"></a>00778             <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a7327d130d314d2f7b9da9884c139fa4c">computeTwistLimitInfo</a>(qABTwist, m_twistAngle, twistAxis);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780             <span class="keywordflow">if</span> (m_twistAngle &gt; m_twistSpan*m_limitSoftness)
<a name="l00781"></a>00781             {
<a name="l00782"></a>00782                 m_solveTwistLimit = <span class="keyword">true</span>;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784                 m_twistLimitRatio = 1.f;
<a name="l00785"></a>00785                 <span class="keywordflow">if</span> (m_twistAngle &lt; m_twistSpan &amp;&amp; m_limitSoftness &lt; 1.f - <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00786"></a>00786                 {
<a name="l00787"></a>00787                     m_twistLimitRatio = (m_twistAngle - m_twistSpan * m_limitSoftness)/
<a name="l00788"></a>00788                                         (m_twistSpan  - m_twistSpan * m_limitSoftness);
<a name="l00789"></a>00789                 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791                 <span class="comment">// twist correction tries to get back to soft limit</span>
<a name="l00792"></a>00792                 m_twistCorrection = m_twistAngle - (m_twistSpan * m_limitSoftness);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794                 m_twistAxis = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(qB, -twistAxis);
<a name="l00795"></a>00795 
<a name="l00796"></a>00796                 m_kTwist = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(1.) /
<a name="l00797"></a>00797                     (<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">computeAngularImpulseDenominator</a>(m_twistAxis,invInertiaWorldA) +
<a name="l00798"></a>00798                      <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#af3d83abb7b51491e50569132970267d7">computeAngularImpulseDenominator</a>(m_twistAxis,invInertiaWorldB));
<a name="l00799"></a>00799             }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801             <span class="keywordflow">if</span> (m_solveSwingLimit)
<a name="l00802"></a>00802                 m_twistAxisA = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(qA, -twistAxis);
<a name="l00803"></a>00803         }
<a name="l00804"></a>00804         <span class="keywordflow">else</span>
<a name="l00805"></a>00805         {
<a name="l00806"></a>00806             m_twistAngle = <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.f);
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 <span class="comment">// given a cone rotation in constraint space, (pre: twist must already be removed)</span>
<a name="l00814"></a>00814 <span class="comment">// this method computes its corresponding swing angle and axis.</span>
<a name="l00815"></a>00815 <span class="comment">// more interestingly, it computes the cone/swing limit (angle) for this cone &quot;pose&quot;.</span>
<a name="l00816"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9598f57371abe6a8c647a23038d51b46">00816</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9598f57371abe6a8c647a23038d51b46">btConeTwistConstraint::computeConeLimitInfo</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a>&amp; qCone,
<a name="l00817"></a>00817                                                  <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>&amp; swingAngle, <span class="comment">// out</span>
<a name="l00818"></a>00818                                                  btVector3&amp; vSwingAxis, <span class="comment">// out</span>
<a name="l00819"></a>00819                                                  <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>&amp; swingLimit) <span class="comment">// out</span>
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821     swingAngle = qCone.<a class="code" href="../../d2/d33/classbtQuaternion.html#a4071aa455c5850f651be8d49d3db7133" title="Return the angle of rotation represented by this quaternion.">getAngle</a>();
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (swingAngle &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00823"></a>00823     {
<a name="l00824"></a>00824         vSwingAxis = btVector3(qCone.x(), qCone.y(), qCone.z());
<a name="l00825"></a>00825         vSwingAxis.normalize();
<a name="l00826"></a>00826         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(vSwingAxis.x()) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00827"></a>00827         {
<a name="l00828"></a>00828             <span class="comment">// non-zero twist?! this should never happen.</span>
<a name="l00829"></a>00829             <span class="keywordtype">int</span> wtf = 0; wtf = wtf;
<a name="l00830"></a>00830         }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832         <span class="comment">// Compute limit for given swing. tricky:</span>
<a name="l00833"></a>00833         <span class="comment">// Given a swing axis, we&#39;re looking for the intersection with the bounding cone ellipse.</span>
<a name="l00834"></a>00834         <span class="comment">// (Since we&#39;re dealing with angles, this ellipse is embedded on the surface of a sphere.)</span>
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         <span class="comment">// For starters, compute the direction from center to surface of ellipse.</span>
<a name="l00837"></a>00837         <span class="comment">// This is just the perpendicular (ie. rotate 2D vector by PI/2) of the swing axis.</span>
<a name="l00838"></a>00838         <span class="comment">// (vSwingAxis is the cone rotation (in z,y); change vars and rotate to (x,y) coords.)</span>
<a name="l00839"></a>00839         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> xEllipse =  vSwingAxis.y();
<a name="l00840"></a>00840         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> yEllipse = -vSwingAxis.z();
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         <span class="comment">// Now, we use the slope of the vector (using x/yEllipse) and find the length</span>
<a name="l00843"></a>00843         <span class="comment">// of the line that intersects the ellipse:</span>
<a name="l00844"></a>00844         <span class="comment">//  x^2   y^2</span>
<a name="l00845"></a>00845         <span class="comment">//  --- + --- = 1, where a and b are semi-major axes 2 and 1 respectively (ie. the limits)</span>
<a name="l00846"></a>00846         <span class="comment">//  a^2   b^2</span>
<a name="l00847"></a>00847         <span class="comment">// Do the math and it should be clear.</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         swingLimit = m_swingSpan1; <span class="comment">// if xEllipse == 0, we have a pure vSwingAxis.z rotation: just use swingspan1</span>
<a name="l00850"></a>00850         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(xEllipse) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00851"></a>00851         {
<a name="l00852"></a>00852             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> surfaceSlope2 = (yEllipse*yEllipse)/(xEllipse*xEllipse);
<a name="l00853"></a>00853             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a> = 1 / (m_swingSpan2 * m_swingSpan2);
<a name="l00854"></a>00854             norm += surfaceSlope2 / (m_swingSpan1 * m_swingSpan1);
<a name="l00855"></a>00855             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swingLimit2 = (1 + surfaceSlope2) / norm;
<a name="l00856"></a>00856             swingLimit = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(swingLimit2);
<a name="l00857"></a>00857         }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="comment">// test!</span>
<a name="l00860"></a>00860         <span class="comment">/*swingLimit = m_swingSpan2;</span>
<a name="l00861"></a>00861 <span class="comment">        if (fabs(vSwingAxis.z()) &gt; SIMD_EPSILON)</span>
<a name="l00862"></a>00862 <span class="comment">        {</span>
<a name="l00863"></a>00863 <span class="comment">        btScalar mag_2 = m_swingSpan1*m_swingSpan1 + m_swingSpan2*m_swingSpan2;</span>
<a name="l00864"></a>00864 <span class="comment">        btScalar sinphi = m_swingSpan2 / sqrt(mag_2);</span>
<a name="l00865"></a>00865 <span class="comment">        btScalar phi = asin(sinphi);</span>
<a name="l00866"></a>00866 <span class="comment">        btScalar theta = atan2(fabs(vSwingAxis.y()),fabs(vSwingAxis.z()));</span>
<a name="l00867"></a>00867 <span class="comment">        btScalar alpha = 3.14159f - theta - phi;</span>
<a name="l00868"></a>00868 <span class="comment">        btScalar sinalpha = sin(alpha);</span>
<a name="l00869"></a>00869 <span class="comment">        swingLimit = m_swingSpan1 * sinphi/sinalpha;</span>
<a name="l00870"></a>00870 <span class="comment">        }*/</span>
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (swingAngle &lt; 0)
<a name="l00873"></a>00873     {
<a name="l00874"></a>00874         <span class="comment">// this should never happen!</span>
<a name="l00875"></a>00875         <span class="keywordtype">int</span> wtf = 0; wtf = wtf;
<a name="l00876"></a>00876     }
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aa27c002605e6fec76c9387f716f67a60">00879</a> btVector3 <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#aa27c002605e6fec76c9387f716f67a60">btConeTwistConstraint::GetPointForAngle</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> fAngleInRadians, <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> fLength)<span class="keyword"> const</span>
<a name="l00880"></a>00880 <span class="keyword"></span>{
<a name="l00881"></a>00881     <span class="comment">// compute x/y in ellipse using cone angle (0 -&gt; 2*PI along surface of cone)</span>
<a name="l00882"></a>00882     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> xEllipse = <a class="code" href="../../d0/d6b/btScalar_8h.html#a08cebf88560180c665f205810cc02d0f">btCos</a>(fAngleInRadians);
<a name="l00883"></a>00883     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> yEllipse = <a class="code" href="../../d0/d6b/btScalar_8h.html#a21de15ec6359a37d7876fa26be384a4b">btSin</a>(fAngleInRadians);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">// Use the slope of the vector (using x/yEllipse) and find the length</span>
<a name="l00886"></a>00886     <span class="comment">// of the line that intersects the ellipse:</span>
<a name="l00887"></a>00887     <span class="comment">//  x^2   y^2</span>
<a name="l00888"></a>00888     <span class="comment">//  --- + --- = 1, where a and b are semi-major axes 2 and 1 respectively (ie. the limits)</span>
<a name="l00889"></a>00889     <span class="comment">//  a^2   b^2</span>
<a name="l00890"></a>00890     <span class="comment">// Do the math and it should be clear.</span>
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="keywordtype">float</span> swingLimit = m_swingSpan1; <span class="comment">// if xEllipse == 0, just use axis b (1)</span>
<a name="l00893"></a>00893     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(xEllipse) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00894"></a>00894     {
<a name="l00895"></a>00895         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> surfaceSlope2 = (yEllipse*yEllipse)/(xEllipse*xEllipse);
<a name="l00896"></a>00896         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a> = 1 / (m_swingSpan2 * m_swingSpan2);
<a name="l00897"></a>00897         norm += surfaceSlope2 / (m_swingSpan1 * m_swingSpan1);
<a name="l00898"></a>00898         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swingLimit2 = (1 + surfaceSlope2) / norm;
<a name="l00899"></a>00899         swingLimit = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(swingLimit2);
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <span class="comment">// convert into point in constraint space:</span>
<a name="l00903"></a>00903     <span class="comment">// note: twist is x-axis, swing 1 and 2 are along the z and y axes respectively</span>
<a name="l00904"></a>00904     btVector3 vSwingAxis(0, xEllipse, -yEllipse);
<a name="l00905"></a>00905     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qSwing(vSwingAxis, swingLimit);
<a name="l00906"></a>00906     btVector3 vPointInConstraintSpace(fLength,0,0);
<a name="l00907"></a>00907     <span class="keywordflow">return</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(qSwing, vPointInConstraintSpace);
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 <span class="comment">// given a twist rotation in constraint space, (pre: cone must already be removed)</span>
<a name="l00911"></a>00911 <span class="comment">// this method computes its corresponding angle and axis.</span>
<a name="l00912"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a7327d130d314d2f7b9da9884c139fa4c">00912</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a7327d130d314d2f7b9da9884c139fa4c">btConeTwistConstraint::computeTwistLimitInfo</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a>&amp; qTwist,
<a name="l00913"></a>00913                                                   <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>&amp; twistAngle, <span class="comment">// out</span>
<a name="l00914"></a>00914                                                   btVector3&amp; vTwistAxis) <span class="comment">// out</span>
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qMinTwist = qTwist;
<a name="l00917"></a>00917     twistAngle = qTwist.<a class="code" href="../../d2/d33/classbtQuaternion.html#a4071aa455c5850f651be8d49d3db7133" title="Return the angle of rotation represented by this quaternion.">getAngle</a>();
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     <span class="keywordflow">if</span> (twistAngle &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#a1bdff187c878167505bcedbbbabf7b0a">SIMD_PI</a>) <span class="comment">// long way around. flip quat and recalculate.</span>
<a name="l00920"></a>00920     {
<a name="l00921"></a>00921         qMinTwist = <a class="code" href="../../d9/d90/util__math_8h.html#a870c76f285829f7ea3127121491c38c5">operator-</a>(qTwist);
<a name="l00922"></a>00922         twistAngle = qMinTwist.<a class="code" href="../../d2/d33/classbtQuaternion.html#a4071aa455c5850f651be8d49d3db7133" title="Return the angle of rotation represented by this quaternion.">getAngle</a>();
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (twistAngle &lt; 0)
<a name="l00925"></a>00925     {
<a name="l00926"></a>00926         <span class="comment">// this should never happen</span>
<a name="l00927"></a>00927         <span class="keywordtype">int</span> wtf = 0; wtf = wtf;         
<a name="l00928"></a>00928     }
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     vTwistAxis = btVector3(qMinTwist.x(), qMinTwist.y(), qMinTwist.z());
<a name="l00931"></a>00931     <span class="keywordflow">if</span> (twistAngle &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l00932"></a>00932         vTwistAxis.normalize();
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 
<a name="l00936"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9cc2bd57668f04e5a662b01d9eda8e11">00936</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9cc2bd57668f04e5a662b01d9eda8e11">btConeTwistConstraint::adjustSwingAxisToUseEllipseNormal</a>(btVector3&amp; vSwingAxis)<span class="keyword"> const</span>
<a name="l00937"></a>00937 <span class="keyword"></span>{
<a name="l00938"></a>00938     <span class="comment">// the swing axis is computed as the &quot;twist-free&quot; cone rotation,</span>
<a name="l00939"></a>00939     <span class="comment">// but the cone limit is not circular, but elliptical (if swingspan1 != swingspan2).</span>
<a name="l00940"></a>00940     <span class="comment">// so, if we&#39;re outside the limits, the closest way back inside the cone isn&#39;t </span>
<a name="l00941"></a>00941     <span class="comment">// along the vector back to the center. better (and more stable) to use the ellipse normal.</span>
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="comment">// convert swing axis to direction from center to surface of ellipse</span>
<a name="l00944"></a>00944     <span class="comment">// (ie. rotate 2D vector by PI/2)</span>
<a name="l00945"></a>00945     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> y = -vSwingAxis.z();
<a name="l00946"></a>00946     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> z =  vSwingAxis.y();
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="comment">// do the math...</span>
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(z) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>) <span class="comment">// avoid division by 0. and we don&#39;t need an update if z == 0.</span>
<a name="l00950"></a>00950     {
<a name="l00951"></a>00951         <span class="comment">// compute gradient/normal of ellipse surface at current &quot;point&quot;</span>
<a name="l00952"></a>00952         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../df/d5a/svm__noise_8h.html#a24def295b818c408edc87331ff9f3544">grad</a> = y/z;
<a name="l00953"></a>00953         grad *= m_swingSpan2 / m_swingSpan1;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         <span class="comment">// adjust y/z to represent normal at point (instead of vector to point)</span>
<a name="l00956"></a>00956         <span class="keywordflow">if</span> (y &gt; 0)
<a name="l00957"></a>00957             y =  <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(grad * z);
<a name="l00958"></a>00958         <span class="keywordflow">else</span>
<a name="l00959"></a>00959             y = -<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(grad * z);
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         <span class="comment">// convert ellipse direction back to swing axis</span>
<a name="l00962"></a>00962         vSwingAxis.setZ(-y);
<a name="l00963"></a>00963         vSwingAxis.setY( z);
<a name="l00964"></a>00964         vSwingAxis.normalize();
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 
<a name="l00970"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#affa8f9aeea43d37a4ce5e61d87217d93">00970</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#affa8f9aeea43d37a4ce5e61d87217d93">btConeTwistConstraint::setMotorTarget</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> &amp;q)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trACur = <a class="code" href="../../df/daa/classbtTypedConstraint.html#ad26bc1b31fe84ce160d1fb2e47a49c1f">m_rbA</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>();
<a name="l00973"></a>00973     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trBCur = <a class="code" href="../../df/daa/classbtTypedConstraint.html#af6cf7d2cb4756cb8419d82142f930446">m_rbB</a>.<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>();
<a name="l00974"></a>00974     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trABCur = trBCur.<a class="code" href="../../d4/d79/classbtTransform.html#ab8bfe567b46a87ca917b29ad75ac383a" title="Return the inverse of this transform.">inverse</a>() * trACur;
<a name="l00975"></a>00975     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qABCur = trABCur.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00976"></a>00976     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trConstraintCur = (trBCur * m_rbBFrame).<a class="code" href="../../d9/d42/btQuaternion_8h.html#ae51e49cc6a687e7b1534a6a03fafe2c8" title="Return the inverse of a quaternion.">inverse</a>() * (trACur * m_rbAFrame);
<a name="l00977"></a>00977     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qConstraintCur = trConstraintCur.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qConstraint = m_rbBFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>().<a class="code" href="../../d2/d33/classbtQuaternion.html#aa8894800b346577a9a568048d10e09d0" title="Return the inverse of this quaternion.">inverse</a>() * q * m_rbAFrame.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00980"></a>00980     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a8e5e0ef917335c9e12580872d3dbf533">setMotorTargetInConstraintSpace</a>(qConstraint);
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 
<a name="l00984"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a8e5e0ef917335c9e12580872d3dbf533">00984</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a8e5e0ef917335c9e12580872d3dbf533">btConeTwistConstraint::setMotorTargetInConstraintSpace</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> &amp;q)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     m_qTarget = q;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="comment">// clamp motor target to within limits</span>
<a name="l00989"></a>00989     {
<a name="l00990"></a>00990         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> softness = 1.f;<span class="comment">//m_limitSoftness;</span>
<a name="l00991"></a>00991 
<a name="l00992"></a>00992         <span class="comment">// split into twist and cone</span>
<a name="l00993"></a>00993         btVector3 vTwisted = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a41643f41d42b592d640c7b33e9f66dd6">quatRotate</a>(m_qTarget, <a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#a94d3f9d6691cd71064c1603e330798d9">vTwist</a>);
<a name="l00994"></a>00994         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qTargetCone  = <a class="code" href="../../d9/d42/btQuaternion_8h.html#a2884ed105928c310d48521fcacf39eb2">shortestArcQuat</a>(<a class="code" href="../../db/dc5/btConeTwistConstraint_8cpp.html#a94d3f9d6691cd71064c1603e330798d9">vTwist</a>, vTwisted); qTargetCone.<a class="code" href="../../d2/d33/classbtQuaternion.html#adb5cd1eb8145a906f9f47857c498d3d6" title="Normalize the quaternion Such that x^2 + y^2 + z^2 +w^2 = 1.">normalize</a>();
<a name="l00995"></a>00995         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> qTargetTwist = qTargetCone.<a class="code" href="../../d2/d33/classbtQuaternion.html#aa8894800b346577a9a568048d10e09d0" title="Return the inverse of this quaternion.">inverse</a>() * m_qTarget; qTargetTwist.<a class="code" href="../../d2/d33/classbtQuaternion.html#adb5cd1eb8145a906f9f47857c498d3d6" title="Normalize the quaternion Such that x^2 + y^2 + z^2 +w^2 = 1.">normalize</a>();
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <span class="comment">// clamp cone</span>
<a name="l00998"></a>00998         <span class="keywordflow">if</span> (m_swingSpan1 &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f) &amp;&amp; m_swingSpan2 &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f))
<a name="l00999"></a>00999         {
<a name="l01000"></a>01000             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> swingAngle, swingLimit; btVector3 swingAxis;
<a name="l01001"></a>01001             <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9598f57371abe6a8c647a23038d51b46">computeConeLimitInfo</a>(qTargetCone, swingAngle, swingAxis, swingLimit);
<a name="l01002"></a>01002 
<a name="l01003"></a>01003             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(swingAngle) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l01004"></a>01004             {
<a name="l01005"></a>01005                 <span class="keywordflow">if</span> (swingAngle &gt; swingLimit*softness)
<a name="l01006"></a>01006                     swingAngle = swingLimit*softness;
<a name="l01007"></a>01007                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (swingAngle &lt; -swingLimit*softness)
<a name="l01008"></a>01008                     swingAngle = -swingLimit*softness;
<a name="l01009"></a>01009                 qTargetCone = <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a>(swingAxis, swingAngle);
<a name="l01010"></a>01010             }
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013         <span class="comment">// clamp twist</span>
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (m_twistSpan &gt;= <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>(0.05f))
<a name="l01015"></a>01015         {
<a name="l01016"></a>01016             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> twistAngle; btVector3 twistAxis;
<a name="l01017"></a>01017             <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a7327d130d314d2f7b9da9884c139fa4c">computeTwistLimitInfo</a>(qTargetTwist, twistAngle, twistAxis);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(twistAngle) &gt; <a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>)
<a name="l01020"></a>01020             {
<a name="l01021"></a>01021                 <span class="comment">// eddy todo: limitSoftness used here???</span>
<a name="l01022"></a>01022                 <span class="keywordflow">if</span> (twistAngle &gt; m_twistSpan*softness)
<a name="l01023"></a>01023                     twistAngle = m_twistSpan*softness;
<a name="l01024"></a>01024                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (twistAngle &lt; -m_twistSpan*softness)
<a name="l01025"></a>01025                     twistAngle = -m_twistSpan*softness;
<a name="l01026"></a>01026                 qTargetTwist = <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a>(twistAxis, twistAngle);
<a name="l01027"></a>01027             }
<a name="l01028"></a>01028         }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030         m_qTarget = qTargetCone * qTargetTwist;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01036"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9c08ca8bd948257fb26819b14c93ef93">01036</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a9c08ca8bd948257fb26819b14c93ef93">btConeTwistConstraint::setParam</a>(<span class="keywordtype">int</span> num, <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> value, <span class="keywordtype">int</span> axis)
<a name="l01037"></a>01037 {
<a name="l01038"></a>01038     <span class="keywordflow">switch</span>(num)
<a name="l01039"></a>01039     {
<a name="l01040"></a>01040         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa56f67fdb7bfc986332bdbcf0d55eaad8">BT_CONSTRAINT_ERP</a> :
<a name="l01041"></a>01041         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aaf95fc89b78bf5f778d27567f192cb8f9">BT_CONSTRAINT_STOP_ERP</a> :
<a name="l01042"></a>01042             <span class="keywordflow">if</span>((axis &gt;= 0) &amp;&amp; (axis &lt; 3)) 
<a name="l01043"></a>01043             {
<a name="l01044"></a>01044                 m_linERP = value;
<a name="l01045"></a>01045                 m_flags |= <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea43904f56ec584a9102dc046f4998bb68">BT_CONETWIST_FLAGS_LIN_ERP</a>;
<a name="l01046"></a>01046             }
<a name="l01047"></a>01047             <span class="keywordflow">else</span>
<a name="l01048"></a>01048             {
<a name="l01049"></a>01049                 m_biasFactor = value;
<a name="l01050"></a>01050             }
<a name="l01051"></a>01051             <span class="keywordflow">break</span>;
<a name="l01052"></a>01052         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa0b433a419024d791a6a83bd59ae940cc">BT_CONSTRAINT_CFM</a> :
<a name="l01053"></a>01053         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa80f229d99f998883ffa56a28bc57f0bd">BT_CONSTRAINT_STOP_CFM</a> :
<a name="l01054"></a>01054             <span class="keywordflow">if</span>((axis &gt;= 0) &amp;&amp; (axis &lt; 3)) 
<a name="l01055"></a>01055             {
<a name="l01056"></a>01056                 m_linCFM = value;
<a name="l01057"></a>01057                 m_flags |= <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea4259c8d65138be663e5ab368054fc994">BT_CONETWIST_FLAGS_LIN_CFM</a>;
<a name="l01058"></a>01058             }
<a name="l01059"></a>01059             <span class="keywordflow">else</span>
<a name="l01060"></a>01060             {
<a name="l01061"></a>01061                 m_angCFM = value;
<a name="l01062"></a>01062                 m_flags |= <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea7c4ee7313641e9762ff905341cab3cd6">BT_CONETWIST_FLAGS_ANG_CFM</a>;
<a name="l01063"></a>01063             }
<a name="l01064"></a>01064             <span class="keywordflow">break</span>;
<a name="l01065"></a>01065         <span class="keywordflow">default</span>:
<a name="l01066"></a>01066             <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(0);
<a name="l01067"></a>01067             <span class="keywordflow">break</span>;
<a name="l01068"></a>01068     }
<a name="l01069"></a>01069 }
<a name="l01070"></a>01070 
<a name="l01072"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac21e97ef42822620c22ed233b46c421b">01072</a> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#ac21e97ef42822620c22ed233b46c421b" title="return the local value of parameter">btConeTwistConstraint::getParam</a>(<span class="keywordtype">int</span> num, <span class="keywordtype">int</span> axis)<span class="keyword"> const </span>
<a name="l01073"></a>01073 <span class="keyword"></span>{
<a name="l01074"></a>01074     <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> retVal = 0;
<a name="l01075"></a>01075     <span class="keywordflow">switch</span>(num)
<a name="l01076"></a>01076     {
<a name="l01077"></a>01077         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa56f67fdb7bfc986332bdbcf0d55eaad8">BT_CONSTRAINT_ERP</a> :
<a name="l01078"></a>01078         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aaf95fc89b78bf5f778d27567f192cb8f9">BT_CONSTRAINT_STOP_ERP</a> :
<a name="l01079"></a>01079             <span class="keywordflow">if</span>((axis &gt;= 0) &amp;&amp; (axis &lt; 3)) 
<a name="l01080"></a>01080             {
<a name="l01081"></a>01081                 <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea43904f56ec584a9102dc046f4998bb68">BT_CONETWIST_FLAGS_LIN_ERP</a>);
<a name="l01082"></a>01082                 retVal = m_linERP;
<a name="l01083"></a>01083             }
<a name="l01084"></a>01084             <span class="keywordflow">else</span> <span class="keywordflow">if</span>((axis &gt;= 3) &amp;&amp; (axis &lt; 6)) 
<a name="l01085"></a>01085             {
<a name="l01086"></a>01086                 retVal = m_biasFactor;
<a name="l01087"></a>01087             }
<a name="l01088"></a>01088             <span class="keywordflow">else</span>
<a name="l01089"></a>01089             {
<a name="l01090"></a>01090                 <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(0);
<a name="l01091"></a>01091             }
<a name="l01092"></a>01092             <span class="keywordflow">break</span>;
<a name="l01093"></a>01093         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa0b433a419024d791a6a83bd59ae940cc">BT_CONSTRAINT_CFM</a> :
<a name="l01094"></a>01094         <span class="keywordflow">case</span> <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#adbf2bd68c9d2fcd047d052d9bc627e1aa80f229d99f998883ffa56a28bc57f0bd">BT_CONSTRAINT_STOP_CFM</a> :
<a name="l01095"></a>01095             <span class="keywordflow">if</span>((axis &gt;= 0) &amp;&amp; (axis &lt; 3)) 
<a name="l01096"></a>01096             {
<a name="l01097"></a>01097                 <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea4259c8d65138be663e5ab368054fc994">BT_CONETWIST_FLAGS_LIN_CFM</a>);
<a name="l01098"></a>01098                 retVal = m_linCFM;
<a name="l01099"></a>01099             }
<a name="l01100"></a>01100             <span class="keywordflow">else</span> <span class="keywordflow">if</span>((axis &gt;= 3) &amp;&amp; (axis &lt; 6)) 
<a name="l01101"></a>01101             {
<a name="l01102"></a>01102                 <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(m_flags &amp; <a class="code" href="../../d4/d08/btConeTwistConstraint_8h.html#a47c61c273ae9c48432b65a92d607481ea7c4ee7313641e9762ff905341cab3cd6">BT_CONETWIST_FLAGS_ANG_CFM</a>);
<a name="l01103"></a>01103                 retVal = m_angCFM;
<a name="l01104"></a>01104             }
<a name="l01105"></a>01105             <span class="keywordflow">else</span>
<a name="l01106"></a>01106             {
<a name="l01107"></a>01107                 <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(0);
<a name="l01108"></a>01108             }
<a name="l01109"></a>01109             <span class="keywordflow">break</span>;
<a name="l01110"></a>01110         <span class="keywordflow">default</span> : 
<a name="l01111"></a>01111             <a class="code" href="../../d4/d72/btTypedConstraint_8h.html#aa159da6403424fcf4e4c72374f4e61a9">btAssertConstrParams</a>(0);
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113     <span class="keywordflow">return</span> retVal;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 
<a name="l01117"></a><a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#addb8bdc195d7b9cbecf1f033228bf010">01117</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#addb8bdc195d7b9cbecf1f033228bf010">btConeTwistConstraint::setFrames</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> &amp; frameA, <span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> &amp; frameB)
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119     m_rbAFrame = frameA;
<a name="l01120"></a>01120     m_rbBFrame = frameB;
<a name="l01121"></a>01121     <a class="code" href="../../d1/d4d/classbtConeTwistConstraint.html#a423ae402c9cc25dde3ae5dd338ed5f6d" title="internal method used by the constraint solver, don&#39;t use them directly">buildJacobian</a>();
<a name="l01122"></a>01122     <span class="comment">//calculateTransforms();</span>
<a name="l01123"></a>01123 }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125  
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:07 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
