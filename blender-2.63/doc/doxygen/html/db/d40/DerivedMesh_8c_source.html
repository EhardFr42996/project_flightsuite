<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: DerivedMesh.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">DerivedMesh.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/d40/DerivedMesh_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2005 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;limits.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d70/DNA__cloth__types_8h.html">DNA_cloth_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span> <span class="comment">// N_T</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d6c/BLI__array_8h.html">BLI_array.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d13/BLI__pbvh_8h.html" title="A BVH for high poly meshes.">BLI_pbvh.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d31/BLI__linklist_8h.html" title="Routines for working with singly linked lists of &#39;links&#39; - pointers to other data.">BLI_linklist.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d61/BLF__translation_8h.html">BLF_translation.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d37/BKE__multires_8h.html">BKE_multires.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dca/BKE__particle_8h.html">BKE_particle.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d65/BKE__bvhutils_8h.html">BKE_bvhutils.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span> <span class="comment">/* For debug flag, DM_update_tessface_data() func. */</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#ifdef WITH_GAMEENGINE</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7e/BKE__navmesh__conversion_8h.html">BKE_navmesh_conversion.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *navmesh_dm_createNavMeshForVisualization(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm);
<a name="l00075"></a>00075 <span class="preprocessor">#endif</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d59/BLO__sys__types_8h.html">BLO_sys_types.h</a>&quot;</span> <span class="comment">// for intptr_t support</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;GL/glew.h&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dca/GPU__buffers_8h.html">GPU_buffers.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/df0/GPU__draw_8h.html">GPU_draw.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../da/deb/GPU__extensions_8h.html">GPU_extensions.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d68/GPU__material_8h.html">GPU_material.h</a>&quot;</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob);
<a name="l00087"></a>00087 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1e5a16b35f4a5e1f1ce55014dc1c06dc">shapekey_layers_to_keyblocks</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> actshape_uid);
<a name="l00088"></a>00088 
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8bbe0ff72291daf3a521e868cf8ef26">00092</a> <span class="keyword">static</span> <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8bbe0ff72291daf3a521e868cf8ef26">dm_getVertArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (!mvert) {
<a name="l00097"></a>00097         mvert = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00098"></a>00098             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm));
<a name="l00099"></a>00099         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac1725328c05cb8eef4285f73d071bfe1">CustomData_set_layer_flag</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae4c5bb1e4ffeb49e72f409bd2bfa8479">CD_FLAG_TEMPORARY</a>);
<a name="l00100"></a>00100         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a91b8fe1efc5d3401d92fe4479bbaffd0">copyVertArray</a>(dm, mvert);
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="keywordflow">return</span> mvert;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a22a08d99c28626e8ba6ca298ed4a4db7">00106</a> <span class="keyword">static</span> <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a22a08d99c28626e8ba6ca298ed4a4db7">dm_getEdgeArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (!medge) {
<a name="l00111"></a>00111         medge = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00112"></a>00112             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm));
<a name="l00113"></a>00113         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac1725328c05cb8eef4285f73d071bfe1">CustomData_set_layer_flag</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae4c5bb1e4ffeb49e72f409bd2bfa8479">CD_FLAG_TEMPORARY</a>);
<a name="l00114"></a>00114         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac4aa9c8766a7b5b3bed13cbc136b55e1">copyEdgeArray</a>(dm, medge);
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">return</span> medge;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a13c77d8fc36da7a34d201a09689fd64e">00120</a> <span class="keyword">static</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a13c77d8fc36da7a34d201a09689fd64e">dm_getTessFaceArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <span class="keywordflow">if</span> (!mface) {
<a name="l00125"></a>00125         <span class="keywordtype">int</span> numTessFaces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00126"></a>00126         
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (!numTessFaces) {
<a name="l00128"></a>00128             <span class="comment">/* Do not add layer if there&#39;s no elements in it, this leads to issues later when</span>
<a name="l00129"></a>00129 <span class="comment">             * this layer is needed with non-zero size, but currently CD stuff does not check</span>
<a name="l00130"></a>00130 <span class="comment">             * for requested layer size on creation and just returns layer which was previously</span>
<a name="l00131"></a>00131 <span class="comment">             * added (sergey) */</span>
<a name="l00132"></a>00132             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134         
<a name="l00135"></a>00135         mface = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, numTessFaces);
<a name="l00136"></a>00136         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac1725328c05cb8eef4285f73d071bfe1">CustomData_set_layer_flag</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae4c5bb1e4ffeb49e72f409bd2bfa8479">CD_FLAG_TEMPORARY</a>);
<a name="l00137"></a>00137         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac1b3448557fc2eb24aa10db4fc361aad">copyTessFaceArray</a>(dm, mface);
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="keywordflow">return</span> mface;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aeca99ea6addcec4d3eaf2ed46205305c">00143</a> <span class="keyword">static</span> <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#aeca99ea6addcec4d3eaf2ed46205305c">dm_getLoopArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *mloop = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (!mloop) {
<a name="l00148"></a>00148         mloop = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00149"></a>00149             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aef9f2c0729f927f89fd74b6f95dd2a8f">getNumLoops</a>(dm));
<a name="l00150"></a>00150         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac1725328c05cb8eef4285f73d071bfe1">CustomData_set_layer_flag</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae4c5bb1e4ffeb49e72f409bd2bfa8479">CD_FLAG_TEMPORARY</a>);
<a name="l00151"></a>00151         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac0f42d17a43cb2dde3516e4223cd7130">copyLoopArray</a>(dm, mloop);
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">return</span> mloop;
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a894f2a506dfe66113b27285e22d84c63">00157</a> <span class="keyword">static</span> <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a894f2a506dfe66113b27285e22d84c63">dm_getPolyArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00158"></a>00158 {
<a name="l00159"></a>00159     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="keywordflow">if</span> (!mpoly) {
<a name="l00162"></a>00162         mpoly = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00163"></a>00163             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm));
<a name="l00164"></a>00164         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac1725328c05cb8eef4285f73d071bfe1">CustomData_set_layer_flag</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae4c5bb1e4ffeb49e72f409bd2bfa8479">CD_FLAG_TEMPORARY</a>);
<a name="l00165"></a>00165         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a23af5986914ff01d7f9e7a29efba1ab1">copyPolyArray</a>(dm, mpoly);
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="keywordflow">return</span> mpoly;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a5407cedee47d3ea208b3b34ab30f6a42">00171</a> <span class="keyword">static</span> <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a5407cedee47d3ea208b3b34ab30f6a42">dm_dupVertArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *tmp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tmp) * dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm),
<a name="l00174"></a>00174                              <span class="stringliteral">&quot;dm_dupVertArray tmp&quot;</span>);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (tmp) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a91b8fe1efc5d3401d92fe4479bbaffd0">copyVertArray</a>(dm, tmp);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordflow">return</span> tmp;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4443fc56cb0a02f14399b998f060e3b5">00181</a> <span class="keyword">static</span> <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a4443fc56cb0a02f14399b998f060e3b5">dm_dupEdgeArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *tmp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tmp) * dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm),
<a name="l00184"></a>00184                              <span class="stringliteral">&quot;dm_dupEdgeArray tmp&quot;</span>);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (tmp) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac4aa9c8766a7b5b3bed13cbc136b55e1">copyEdgeArray</a>(dm, tmp);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">return</span> tmp;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac57020f912aa132d847e263a0f8df7d0">00191</a> <span class="keyword">static</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#ac57020f912aa132d847e263a0f8df7d0">dm_dupFaceArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *tmp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tmp) * dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm),
<a name="l00194"></a>00194                              <span class="stringliteral">&quot;dm_dupFaceArray tmp&quot;</span>);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (tmp) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac1b3448557fc2eb24aa10db4fc361aad">copyTessFaceArray</a>(dm, tmp);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="keywordflow">return</span> tmp;
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a6af439f8a0784464a3d9ddaa6c69219e">00201</a> <span class="keyword">static</span> <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a6af439f8a0784464a3d9ddaa6c69219e">dm_dupLoopArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *tmp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tmp) * dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aef9f2c0729f927f89fd74b6f95dd2a8f">getNumLoops</a>(dm),
<a name="l00204"></a>00204                              <span class="stringliteral">&quot;dm_dupLoopArray tmp&quot;</span>);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (tmp) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac0f42d17a43cb2dde3516e4223cd7130">copyLoopArray</a>(dm, tmp);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordflow">return</span> tmp;
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aa5567f88f40dbcd381793a39abe1c9a9">00211</a> <span class="keyword">static</span> <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#aa5567f88f40dbcd381793a39abe1c9a9">dm_dupPolyArray</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *tmp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tmp) * dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm),
<a name="l00214"></a>00214                              <span class="stringliteral">&quot;dm_dupPolyArray tmp&quot;</span>);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (tmp) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a23af5986914ff01d7f9e7a29efba1ab1">copyPolyArray</a>(dm, tmp);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">return</span> tmp;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a0713aa21fc412662fd123e81866e7b1b">00221</a> <span class="keyword">static</span> <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a0713aa21fc412662fd123e81866e7b1b">dm_getVertCData</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <span class="keywordflow">return</span> &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>;
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ab3ac3f93a17ec33cdd2d8779a61a1fe5">00226</a> <span class="keyword">static</span> <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#ab3ac3f93a17ec33cdd2d8779a61a1fe5">dm_getEdgeCData</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228     <span class="keywordflow">return</span> &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00231"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a36957cb59e99a8eecfdba798236314d3">00231</a> <span class="keyword">static</span> <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a36957cb59e99a8eecfdba798236314d3">dm_getTessFaceCData</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233     <span class="keywordflow">return</span> &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4fba1f0bd876dfee40000c4c9d829b1d">00236</a> <span class="keyword">static</span> <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a4fba1f0bd876dfee40000c4c9d829b1d">dm_getLoopCData</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <span class="keywordflow">return</span> &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>;
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00241"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4285f8cb2dbf07c0aa9982b1bb98f356">00241</a> <span class="keyword">static</span> <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a4285f8cb2dbf07c0aa9982b1bb98f356">dm_getPolyCData</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243     <span class="keywordflow">return</span> &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac1f183140483e7f98ba267aead1a7701">00246</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac1f183140483e7f98ba267aead1a7701">DM_init_funcs</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     <span class="comment">/* default function implementations */</span>
<a name="l00249"></a>00249     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8bbe0ff72291daf3a521e868cf8ef26">dm_getVertArray</a>;
<a name="l00250"></a>00250     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5b98f2e9b75d92be2854b7ab25e5521">getEdgeArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a22a08d99c28626e8ba6ca298ed4a4db7">dm_getEdgeArray</a>;
<a name="l00251"></a>00251     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a13c77d8fc36da7a34d201a09689fd64e">dm_getTessFaceArray</a>;
<a name="l00252"></a>00252     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac37f17fc9af1ffe241e8ad3049a9ccfb">getLoopArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#aeca99ea6addcec4d3eaf2ed46205305c">dm_getLoopArray</a>;
<a name="l00253"></a>00253     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab8b054b009b29543deee65428097ee83">getPolyArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a894f2a506dfe66113b27285e22d84c63">dm_getPolyArray</a>;
<a name="l00254"></a>00254     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad0c2442b371cdd42a28b6079c8520de6">dupVertArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a5407cedee47d3ea208b3b34ab30f6a42">dm_dupVertArray</a>;
<a name="l00255"></a>00255     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a87d62d810af0d97dc7bde75a2d9a9785">dupEdgeArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a4443fc56cb0a02f14399b998f060e3b5">dm_dupEdgeArray</a>;
<a name="l00256"></a>00256     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a37bb907e7d7c4a4b0efd3c20258904d0">dupTessFaceArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#ac57020f912aa132d847e263a0f8df7d0">dm_dupFaceArray</a>;
<a name="l00257"></a>00257     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a0690b96df28795798390632339f0cce3">dupLoopArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6af439f8a0784464a3d9ddaa6c69219e">dm_dupLoopArray</a>;
<a name="l00258"></a>00258     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8e2a7f7d7c2092c08496a54ff7b9a4b6">dupPolyArray</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa5567f88f40dbcd381793a39abe1c9a9">dm_dupPolyArray</a>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a150cd194b2cec9b1d87725eda852c6f1">getVertDataLayout</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a0713aa21fc412662fd123e81866e7b1b">dm_getVertCData</a>;
<a name="l00261"></a>00261     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae9fcde3ae5c7878ac8378224975bf4c9">getEdgeDataLayout</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#ab3ac3f93a17ec33cdd2d8779a61a1fe5">dm_getEdgeCData</a>;
<a name="l00262"></a>00262     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fc1707b5d97e84c917ce44c015fdd14">getTessFaceDataLayout</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a36957cb59e99a8eecfdba798236314d3">dm_getTessFaceCData</a>;
<a name="l00263"></a>00263     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8ba9e2e6c310e5ddfb0535f0425c56a4">getLoopDataLayout</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a4fba1f0bd876dfee40000c4c9d829b1d">dm_getLoopCData</a>;
<a name="l00264"></a>00264     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af3fe314640eb5d70d5aa1ddcfd39b22c">getPolyDataLayout</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a4285f8cb2dbf07c0aa9982b1bb98f356">dm_getPolyCData</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a2d43efb5e4248ed01bd60d6ee910b59c">DM_get_vert_data</a>;
<a name="l00267"></a>00267     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a49e4165f22db4c97108e459b2758d477">getEdgeData</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1fb584d53f6f036da15e5d7bd425bcc4">DM_get_edge_data</a>;
<a name="l00268"></a>00268     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae079874046ef653b053339bccb1a2be4">getTessFaceData</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a98509ea08dca30ed505f7649a79c5ae0">DM_get_tessface_data</a>;
<a name="l00269"></a>00269     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>;
<a name="l00270"></a>00270     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9afc810992214e6dac919ab7a522bd0a">getEdgeDataArray</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a03bf14aaccee3ee9b3d6a19dd013309c">DM_get_edge_data_layer</a>;
<a name="l00271"></a>00271     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6f4a64ea66e4fa753666158e8fb9f2f2">DM_get_tessface_data_layer</a>;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <a class="code" href="../../d2/d65/BKE__bvhutils_8h.html#a46dcc15dd875fdbf93281bd2b6754473">bvhcache_init</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad0fb7c089766f10443e6e8a1e12e4dc1">bvhCache</a>);
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 
<a name="l00276"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a639bc6e25335136ab080be9e75d2ee11">00276</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af7d578b056706eb7a6cfe00af7a8f57b">DM_init</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fef">DerivedMeshType</a> type, <span class="keywordtype">int</span> numVerts, <span class="keywordtype">int</span> numEdges,
<a name="l00277"></a>00277              <span class="keywordtype">int</span> numTessFaces, <span class="keywordtype">int</span> numLoops, <span class="keywordtype">int</span> numPolys)
<a name="l00278"></a>00278 {
<a name="l00279"></a>00279     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> = type;
<a name="l00280"></a>00280     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a> = numVerts;
<a name="l00281"></a>00281     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a> = numEdges;
<a name="l00282"></a>00282     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a> = numTessFaces;
<a name="l00283"></a>00283     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a> = numLoops;
<a name="l00284"></a>00284     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a> = numPolys;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac1f183140483e7f98ba267aead1a7701">DM_init_funcs</a>(dm);
<a name="l00287"></a>00287     
<a name="l00288"></a>00288     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l00289"></a>00289     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa480cce78cce6112e4501d533beb76c1">auto_bump_scale</a> = -1.0f;
<a name="l00290"></a>00290     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> = 0;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a7ea89ecc6baa97130c0706713b10a48d">00293</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a177273c6b671dc3cba7e8f9f0b875a7e">DM_from_template</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fef">DerivedMeshType</a> type,
<a name="l00294"></a>00294                       <span class="keywordtype">int</span> numVerts, <span class="keywordtype">int</span> numEdges, <span class="keywordtype">int</span> numTessFaces,
<a name="l00295"></a>00295                       <span class="keywordtype">int</span> numLoops, <span class="keywordtype">int</span> numPolys)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>,
<a name="l00298"></a>00298                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, numVerts);
<a name="l00299"></a>00299     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>,
<a name="l00300"></a>00300                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, numEdges);
<a name="l00301"></a>00301     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>,
<a name="l00302"></a>00302                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, numTessFaces);
<a name="l00303"></a>00303     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>,
<a name="l00304"></a>00304                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, numLoops);
<a name="l00305"></a>00305     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>,
<a name="l00306"></a>00306                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, numPolys);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> = type;
<a name="l00309"></a>00309     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a> = numVerts;
<a name="l00310"></a>00310     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a> = numEdges;
<a name="l00311"></a>00311     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a> = numTessFaces;
<a name="l00312"></a>00312     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a> = numLoops;
<a name="l00313"></a>00313     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a> = numPolys;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac1f183140483e7f98ba267aead1a7701">DM_init_funcs</a>(dm);
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l00318"></a>00318     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> = 0;
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a591ff29e89a21847a4969751b5a6f63d">00321</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a591ff29e89a21847a4969751b5a6f63d">DM_release</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a>) {
<a name="l00324"></a>00324         <a class="code" href="../../d2/d65/BKE__bvhutils_8h.html#a9f41ac7050e066171378e85778bc3b20">bvhcache_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad0fb7c089766f10443e6e8a1e12e4dc1">bvhCache</a>);
<a name="l00325"></a>00325         <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a024ed6ecea42504ed2685e2d0298cc30">GPU_drawobject_free</a>( dm );
<a name="l00326"></a>00326         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>);
<a name="l00327"></a>00327         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a>);
<a name="l00328"></a>00328         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a>);
<a name="l00329"></a>00329         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00330"></a>00330         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="keywordflow">return</span> 1;
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334     <span class="keywordflow">else</span> {
<a name="l00335"></a>00335         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abcfbfa1d37668b370c72204a696c2f08">CustomData_free_temporary</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>);
<a name="l00336"></a>00336         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abcfbfa1d37668b370c72204a696c2f08">CustomData_free_temporary</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a>);
<a name="l00337"></a>00337         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abcfbfa1d37668b370c72204a696c2f08">CustomData_free_temporary</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a>);
<a name="l00338"></a>00338         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abcfbfa1d37668b370c72204a696c2f08">CustomData_free_temporary</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00339"></a>00339         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abcfbfa1d37668b370c72204a696c2f08">CustomData_free_temporary</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">return</span> 0;
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aab56865ebcaf3c33869920046e5894ad">00345</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aab56865ebcaf3c33869920046e5894ad">DM_DupPolys</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *target)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00348"></a>00348     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, &amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00351"></a>00351     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, &amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a> = source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>;
<a name="l00354"></a>00354     target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a> = source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>)) {
<a name="l00357"></a>00357         <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly;
<a name="l00358"></a>00358         <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *mloop;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         mloop = source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a0690b96df28795798390632339f0cce3">dupLoopArray</a>(source);
<a name="l00361"></a>00361         mpoly = source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8e2a7f7d7c2092c08496a54ff7b9a4b6">dupPolyArray</a>(source);
<a name="l00362"></a>00362         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, mloop, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00363"></a>00363         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;target-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, mpoly, source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">/* note: until all modifiers can take MPoly&#39;s as input,</span>
<a name="l00368"></a>00368 <span class="comment"> * use this at the start of modifiers  */</span>
<a name="l00369"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#afed7604eb89f555bfcad4c3ccd1e5a35">00369</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371     <span class="keyword">const</span> <span class="keywordtype">int</span> numTessFaces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00372"></a>00372     <span class="keyword">const</span> <span class="keywordtype">int</span> numPolys =     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="keywordflow">if</span> ( (numTessFaces == 0) &amp;&amp; (numPolys != 0)) {
<a name="l00375"></a>00375         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af036394045ae57efd07158f511945a5d">recalcTessellation</a>(dm);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm) != 0) {
<a name="l00378"></a>00378             <span class="comment">/* printf(&quot;info %s: polys -&gt; ngons calculated\n&quot;, __func__); */</span>
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="keywordflow">else</span> {
<a name="l00381"></a>00381             printf(<span class="stringliteral">&quot;warning %s: could not create tessfaces from %d polygons, dm-&gt;type=%d\n&quot;</span>,
<a name="l00382"></a>00382                    __func__, numPolys, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a>);
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> &amp;&amp; <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>) {
<a name="l00387"></a>00387         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa372d7e079afb57b1c244af8b8906509">CD_POLYINDEX</a>));
<a name="l00388"></a>00388         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a36e06cb48015911210caafd7b9b1f5ca">DM_update_tessface_data</a>(dm);
<a name="l00389"></a>00389     }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> &amp;= ~<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">/* Update tessface CD data from loop/poly ones. Needed when not retessellating after modstack evaluation. */</span>
<a name="l00395"></a>00395 <span class="comment">/* NOTE: Assumes dm has valid tessellated data! */</span>
<a name="l00396"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a36e06cb48015911210caafd7b9b1f5ca">00396</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a36e06cb48015911210caafd7b9b1f5ca">DM_update_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l00399"></a>00399     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab8b054b009b29543deee65428097ee83">getPolyArray</a>(dm);
<a name="l00400"></a>00400     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac37f17fc9af1ffe241e8ad3049a9ccfb">getLoopArray</a>(dm);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *fdata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fc1707b5d97e84c917ce44c015fdd14">getTessFaceDataLayout</a>(dm);
<a name="l00403"></a>00403     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *pdata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af3fe314640eb5d70d5aa1ddcfd39b22c">getPolyDataLayout</a>(dm);
<a name="l00404"></a>00404     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *ldata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8ba9e2e6c310e5ddfb0535f0425c56a4">getLoopDataLayout</a>(dm);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keyword">const</span> <span class="keywordtype">int</span> numTex = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(pdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05731a08cef6d81e74c221963ae25712">CD_MTEXPOLY</a>);
<a name="l00407"></a>00407     <span class="keyword">const</span> <span class="keywordtype">int</span> numCol = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#adfdc3d9683ce132f088e8fee80fe6f71">CD_MLOOPCOL</a>);
<a name="l00408"></a>00408     <span class="keyword">const</span> <span class="keywordtype">int</span> hasPCol = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae45380b4ba75d70e532ffb22358a48d3">CD_PREVIEW_MLOOPCOL</a>);
<a name="l00409"></a>00409     <span class="keyword">const</span> <span class="keywordtype">int</span> hasOrigSpace = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="keywordtype">int</span> *polyindex = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(fdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa372d7e079afb57b1c244af8b8906509">CD_POLYINDEX</a>);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordtype">int</span> mf_idx,
<a name="l00414"></a>00414         totface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm),
<a name="l00415"></a>00415         ml_idx[4];
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="comment">/* Should never occure, but better abort than segfault! */</span>
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (!polyindex)
<a name="l00419"></a>00419         <span class="keywordflow">return</span>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab01cf34385f85de067da6ca5d3efe638">CustomData_from_bmeshpoly</a>(fdata, pdata, ldata, totface);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="keywordflow">for</span> (mf_idx = 0; mf_idx &lt; totface; mf_idx++, mf++) {
<a name="l00424"></a>00424         <span class="keyword">const</span> <span class="keywordtype">int</span> mf_len = mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3;
<a name="l00425"></a>00425         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, not_done;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         <span class="comment">/* Find out loop indices. */</span>
<a name="l00428"></a>00428         <span class="comment">/* XXX Is there a better way to do this? */</span>
<a name="l00429"></a>00429         <span class="comment">/* NOTE: This assumes tessface are valid and in sync with loop/poly… Else, most likely, segfault! */</span>
<a name="l00430"></a>00430         <span class="keywordflow">for</span> (i = mp[polyindex[mf_idx]].loopstart, not_done = mf_len; not_done; i++) {
<a name="l00431"></a>00431             <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *tml = &amp;ml[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00432"></a>00432             <span class="keywordflow">if</span> (tml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>) {
<a name="l00433"></a>00433                 ml_idx[0] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00434"></a>00434                 not_done--;
<a name="l00435"></a>00435             }
<a name="l00436"></a>00436             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>) {
<a name="l00437"></a>00437                 ml_idx[1] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00438"></a>00438                 not_done--;
<a name="l00439"></a>00439             }
<a name="l00440"></a>00440             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>) {
<a name="l00441"></a>00441                 ml_idx[2] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00442"></a>00442                 not_done--;
<a name="l00443"></a>00443             }
<a name="l00444"></a>00444             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf_len == 4 &amp;&amp; tml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00445"></a>00445                 ml_idx[3] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00446"></a>00446                 not_done--;
<a name="l00447"></a>00447             }
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#ac57b3a3915672432eecd9efac766ba69">mesh_loops_to_mface_corners</a>(fdata, ldata, pdata,
<a name="l00450"></a>00450                                     ml_idx, mf_idx, polyindex[mf_idx],
<a name="l00451"></a>00451                                     mf_len,
<a name="l00452"></a>00452                                     numTex, numCol, hasPCol, hasOrigSpace);
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00456"></a>00456         printf(<span class="stringliteral">&quot;%s: Updated tessellated customdata of dm %p\n&quot;</span>, __func__, dm);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> &amp;= ~<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>;
<a name="l00459"></a>00459 }
<a name="l00460"></a>00460 
<a name="l00461"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ab678b3995a714a19799f09d8ec653c97">00461</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ae3465d29a8fd03daf7e55cf77571d01b">DM_to_mesh</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463     <span class="comment">/* dm might depend on me, so we need to do everything with a local copy */</span>
<a name="l00464"></a>00464     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> tmp = *me;
<a name="l00465"></a>00465     <span class="keywordtype">int</span> totvert, totedge <span class="comment">/*, totface */</span> <span class="comment">/* UNUSED */</span>, totloop, totpoly;
<a name="l00466"></a>00466     <span class="keywordtype">int</span> did_shapekeys=0;
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     memset(&amp;tmp.vdata, 0, <span class="keyword">sizeof</span>(tmp.vdata));
<a name="l00469"></a>00469     memset(&amp;tmp.edata, 0, <span class="keyword">sizeof</span>(tmp.edata));
<a name="l00470"></a>00470     memset(&amp;tmp.<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, 0, <span class="keyword">sizeof</span>(tmp.<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>));
<a name="l00471"></a>00471     memset(&amp;tmp.<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, 0, <span class="keyword">sizeof</span>(tmp.<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>));
<a name="l00472"></a>00472     memset(&amp;tmp.pdata, 0, <span class="keyword">sizeof</span>(tmp.pdata));
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     totvert = tmp.<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00475"></a>00475     totedge = tmp.<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3b3f4272750d320851296b91df489952">getNumEdges</a>(dm);
<a name="l00476"></a>00476     totloop = tmp.<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aef9f2c0729f927f89fd74b6f95dd2a8f">getNumLoops</a>(dm);
<a name="l00477"></a>00477     totpoly = tmp.<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, &amp;tmp.vdata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, totvert);
<a name="l00480"></a>00480     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, &amp;tmp.edata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, totedge);
<a name="l00481"></a>00481     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, &amp;tmp.<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, totloop);
<a name="l00482"></a>00482     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a3c46f1ea248ceb0f206d49b24b162cff">CustomData_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, &amp;tmp.pdata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, totpoly);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>)) {
<a name="l00485"></a>00485         <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00486"></a>00486         <span class="keywordtype">int</span> uid;
<a name="l00487"></a>00487         
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (ob) {
<a name="l00489"></a>00489             kb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a>-1);
<a name="l00490"></a>00490             <span class="keywordflow">if</span> (kb) {
<a name="l00491"></a>00491                 uid = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a>;
<a name="l00492"></a>00492             }
<a name="l00493"></a>00493             <span class="keywordflow">else</span> {
<a name="l00494"></a>00494                 printf(<span class="stringliteral">&quot;%s: error - could not find active shapekey %d!\n&quot;</span>,
<a name="l00495"></a>00495                        __func__, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a>-1);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                 uid = INT_MAX;
<a name="l00498"></a>00498             }
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500         <span class="keywordflow">else</span> {
<a name="l00501"></a>00501             <span class="comment">/*if no object, set to INT_MAX so we don&#39;t mess up any shapekey layers*/</span>
<a name="l00502"></a>00502             uid = INT_MAX;
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1e5a16b35f4a5e1f1ce55014dc1c06dc">shapekey_layers_to_keyblocks</a>(dm, me, uid);
<a name="l00506"></a>00506         did_shapekeys = 1;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     
<a name="l00509"></a>00509     <span class="comment">/* not all DerivedMeshes store their verts/edges/faces in CustomData, so</span>
<a name="l00510"></a>00510 <span class="comment">     * we set them here in case they are missing */</span>
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;tmp.vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>))
<a name="l00512"></a>00512         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;tmp.vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad0c2442b371cdd42a28b6079c8520de6">dupVertArray</a>(dm), totvert);
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;tmp.edata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>))
<a name="l00514"></a>00514         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;tmp.edata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a87d62d810af0d97dc7bde75a2d9a9785">dupEdgeArray</a>(dm), totedge);
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;tmp.pdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>)) {
<a name="l00516"></a>00516         tmp.<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a0690b96df28795798390632339f0cce3">dupLoopArray</a>(dm);
<a name="l00517"></a>00517         tmp.<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8e2a7f7d7c2092c08496a54ff7b9a4b6">dupPolyArray</a>(dm);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;tmp.<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, tmp.<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>, tmp.<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00520"></a>00520         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;tmp.pdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, tmp.<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>, tmp.<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>);
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="comment">/* object had got displacement layer, should copy this layer to save sculpted data */</span>
<a name="l00524"></a>00524     <span class="comment">/* NOTE: maybe some other layers should be copied? nazgul */</span>
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>)) {
<a name="l00526"></a>00526         <span class="keywordflow">if</span> (totloop == me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>) {
<a name="l00527"></a>00527             <a class="code" href="../../da/d81/structMDisps.html">MDisps</a> *mdisps = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>);
<a name="l00528"></a>00528             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;tmp.<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a85dd305a310931c933a9d0a3fa0a69a4">CD_MDISPS</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>, mdisps, totloop);
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="comment">/* yes, must be before _and_ after tessellate */</span>
<a name="l00533"></a>00533     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#adc8217e8a6385eec61318e5f7489b462">mesh_update_customdata_pointers</a>(&amp;tmp, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a935b5b7d16979aed31099dc7024bdbab">BKE_mesh_tessface_calc</a>(&amp;tmp);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;vdata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l00538"></a>00538     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;edata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>);
<a name="l00539"></a>00539     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l00540"></a>00540     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00541"></a>00541     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;pdata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="comment">/* ok, this should now use new CD shapekey data,</span>
<a name="l00544"></a>00544 <span class="comment">     * which shouuld be fed through the modifier</span>
<a name="l00545"></a>00545 <span class="comment">     * stack*/</span>
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (tmp.<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> != me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> &amp;&amp; !did_shapekeys &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>) {
<a name="l00547"></a>00547         printf(<span class="stringliteral">&quot;%s: YEEK! this should be recoded! Shape key loss!: ID &#39;%s&#39;\n&quot;</span>, __func__, tmp.<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l00548"></a>00548         <span class="keywordflow">if</span> (tmp.<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>) tmp.<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a4e5a48e60e8ed39616fdbb90d501fc6c">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00549"></a>00549         tmp.<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     *me = tmp;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ae37f596100795ea95dbdbc2c24c41b0d">00555</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aebd0bdc75ce6be70e08f6b3026b2694c">DM_to_meshkey</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb)
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557     <span class="keywordtype">int</span> a, totvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00558"></a>00558     <span class="keywordtype">float</span> *fp;
<a name="l00559"></a>00559     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00560"></a>00560     
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (totvert==0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>==0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>!=totvert) <span class="keywordflow">return</span>;
<a name="l00562"></a>00562     
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00564"></a>00564     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#a61e6991b6b6a75a8c65470f3b240c193">elemsize</a>*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;kb-&gt;data&quot;</span>);
<a name="l00565"></a>00565     kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>= totvert;
<a name="l00566"></a>00566     
<a name="l00567"></a>00567     fp= kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l00568"></a>00568     mvert=dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l00569"></a>00569     
<a name="l00570"></a>00570     <span class="keywordflow">for</span> (a=0; a&lt;kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>; a++, fp+=3, mvert++) {
<a name="l00571"></a>00571         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac99330c3a2409a10111f1c0d9aef3080">00575</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask)
<a name="l00576"></a>00576 {
<a name="l00577"></a>00577     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a4594a4a9ec164ca0748e8c78fbcaad03">CustomData_set_only_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, mask);
<a name="l00578"></a>00578     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a4594a4a9ec164ca0748e8c78fbcaad03">CustomData_set_only_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, mask);
<a name="l00579"></a>00579     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a4594a4a9ec164ca0748e8c78fbcaad03">CustomData_set_only_copy</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, mask);
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac17fecea2dc9145dfa13d4ee6ca7299a">00582</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1d5e2eb6e1a26961b60f0cac4a7411bc">DM_add_vert_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> alloctype, <span class="keywordtype">void</span> *layer)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, type, alloctype, layer, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>);
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a84f1dee3831e26ecc477011efef9f997">00587</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a5c012cd27a5099e683af31e5cac9cbdb">DM_add_edge_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> alloctype, <span class="keywordtype">void</span> *layer)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, type, alloctype, layer, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a>);
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a48e0134ef61a39632515cf698178cd39">00592</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8cc9d09112d34ee1f78b652333530dd4">DM_add_tessface_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> alloctype, <span class="keywordtype">void</span> *layer)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, type, alloctype, layer, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a>);
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a0375950f9607f964fc5a2761e2ed44d3">00597</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0375950f9607f964fc5a2761e2ed44d3">DM_add_loop_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> alloctype, <span class="keywordtype">void</span> *layer)
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, type, alloctype, layer, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aca73d969f2a71a14cba14fcc03a58602">numLoopData</a>);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a746273e09e1a5fdd6a2b697e2e764827">00602</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8edc78844a26b9e714ae937daca04354">DM_add_poly_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type, <span class="keywordtype">int</span> alloctype, <span class="keywordtype">void</span> *layer)
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, type, alloctype, layer, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>);
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4d9352e5383fd01802420c3a88748e47">00607</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a2d43efb5e4248ed01bd60d6ee910b59c">DM_get_vert_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad7c68e821437b13392ebdd3f7a41faf0">CustomData_get</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, index, type);
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#af961435412ca77e4b5e2a782ecbfd4dc">00612</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1fb584d53f6f036da15e5d7bd425bcc4">DM_get_edge_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type)
<a name="l00613"></a>00613 {
<a name="l00614"></a>00614     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad7c68e821437b13392ebdd3f7a41faf0">CustomData_get</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, index, type);
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad08d5536c97e530e6f859c32b7f680cc">00617</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a98509ea08dca30ed505f7649a79c5ae0">DM_get_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad7c68e821437b13392ebdd3f7a41faf0">CustomData_get</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, index, type);
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aec7e768bdf67758f58c986abcefda4f7">00622</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (type == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>)
<a name="l00625"></a>00625         <span class="keywordflow">return</span> dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, type);
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a9be65ca5ebc4f81185a149abe88000ef">00630</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a03bf14aaccee3ee9b3d6a19dd013309c">DM_get_edge_data_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type)
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632     <span class="keywordflow">if</span> (type == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>)
<a name="l00633"></a>00633         <span class="keywordflow">return</span> dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae5b98f2e9b75d92be2854b7ab25e5521">getEdgeArray</a>(dm);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, type);
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00638"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad026b8224fff54ebd7480cb7244d4968">00638</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6f4a64ea66e4fa753666158e8fb9f2f2">DM_get_tessface_data_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (type == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>)
<a name="l00641"></a>00641         <span class="keywordflow">return</span> dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, type);
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a43bf1d5b82f80d64928c49b959ab1aac">00646</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a134ed8d7ec1c59a8d65cf1f8899123a2">DM_get_poly_data_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, type);
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4103f7a27e5597d634c723b9f5610e35">00651</a> <span class="keywordtype">void</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac13bcba0ff94c0a387fc156b613954dc">DM_get_loop_data_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> type)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, type);
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#abc1177bf81bea6df4e5d3b73b6a59a0a">00656</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a17f538a4049fe3e2e2d050c30a7e8136">DM_set_vert_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a77d7af997272e3f4e04b8ae48e202055">CustomData_set</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, index, type, data);
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a254e5c099ddbae2be192206e44db91c7">00661</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a9ab9ec8c2a87ed1316439a86e1f9414f">DM_set_edge_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00662"></a>00662 {
<a name="l00663"></a>00663     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a77d7af997272e3f4e04b8ae48e202055">CustomData_set</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, index, type, data);
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a00a9d756d0c64466002ee695bff395ed">00666</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af35a8d133328c140fe9413676293b7d1">DM_set_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> type, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00667"></a>00667 {
<a name="l00668"></a>00668     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a77d7af997272e3f4e04b8ae48e202055">CustomData_set</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, index, type, data);
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac11506c22f130321518b89c63c019317">00671</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0dc714df15d00d9c6986f64606a00bbd">DM_copy_vert_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00672"></a>00672                        <span class="keywordtype">int</span> source_index, <span class="keywordtype">int</span> dest_index, <span class="keywordtype">int</span> count)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>,
<a name="l00675"></a>00675                          source_index, dest_index, count);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#abc11038addaacc5f3de460c7b92d3b89">00678</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a4862b733584eca2082b8f100f9a33d9c">DM_copy_edge_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00679"></a>00679                        <span class="keywordtype">int</span> source_index, <span class="keywordtype">int</span> dest_index, <span class="keywordtype">int</span> count)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>,
<a name="l00682"></a>00682                          source_index, dest_index, count);
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2a7ed2c4c7de3a8afb1e1029d7004b2c">00685</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a47a62e0959a455df14d253c3060ecb70">DM_copy_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00686"></a>00686                        <span class="keywordtype">int</span> source_index, <span class="keywordtype">int</span> dest_index, <span class="keywordtype">int</span> count)
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>,
<a name="l00689"></a>00689                          source_index, dest_index, count);
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4396b041b81b0dd7874a7e8a671c59e1">00692</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ab8a9a876655ae118ef432714cf1ca8cf">DM_copy_loop_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00693"></a>00693                        <span class="keywordtype">int</span> source_index, <span class="keywordtype">int</span> dest_index, <span class="keywordtype">int</span> count)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>,
<a name="l00696"></a>00696                          source_index, dest_index, count);
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00699"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a742ec76feaf4003c5a54c7d458df03a5">00699</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa5026c57cdc53adcb7856a6c6483013d">DM_copy_poly_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00700"></a>00700                        <span class="keywordtype">int</span> source_index, <span class="keywordtype">int</span> dest_index, <span class="keywordtype">int</span> count)
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>,
<a name="l00703"></a>00703                          source_index, dest_index, count);
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aa6b9ef2b5786166f0a2b6dd8f13fca9a">00706</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa6b9ef2b5786166f0a2b6dd8f13fca9a">DM_free_vert_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> count)
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad3344be03de63b3df3680faf25e72eef">CustomData_free_elem</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, index, count);
<a name="l00709"></a>00709 }
<a name="l00710"></a>00710 
<a name="l00711"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ac7c8bf86b6bd1fa3f8173d9e9dbec334">00711</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac7c8bf86b6bd1fa3f8173d9e9dbec334">DM_free_edge_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> count)
<a name="l00712"></a>00712 {
<a name="l00713"></a>00713     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad3344be03de63b3df3680faf25e72eef">CustomData_free_elem</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, index, count);
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ae925ce693644ddd2d2410010ebce97a6">00716</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ae925ce693644ddd2d2410010ebce97a6">DM_free_tessface_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> count)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad3344be03de63b3df3680faf25e72eef">CustomData_free_elem</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, index, count);
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a937d95c99e80a055af7c805772aa9746">00721</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a937d95c99e80a055af7c805772aa9746">DM_free_loop_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> count)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad3344be03de63b3df3680faf25e72eef">CustomData_free_elem</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, index, count);
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 
<a name="l00726"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#adf8816b2920330816bf0fb4cd8fd3071">00726</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#adf8816b2920330816bf0fb4cd8fd3071">DM_free_poly_data</a>(<span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> count)
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad3344be03de63b3df3680faf25e72eef">CustomData_free_elem</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, index, count);
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a74a994884c811f307d752e89338578bf">00731</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0482d05629c59788d67f21d3f15d83ee">DM_interp_vert_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00732"></a>00732                          <span class="keywordtype">int</span> *src_indices, <span class="keywordtype">float</span> *weights,
<a name="l00733"></a>00733                          <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> dest_index)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0878a281294e77e4591333b27182334">CustomData_interp</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, src_indices,
<a name="l00736"></a>00736                       weights, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, count, dest_index);
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aa7364343b2d4b24c94cb5621ae599b70">00739</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6147214aee28df5bcbed5b4cfec594e0">DM_interp_edge_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00740"></a>00740                          <span class="keywordtype">int</span> *src_indices,
<a name="l00741"></a>00741                          <span class="keywordtype">float</span> *weights, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#acf2b55863e0f17557c2f1ef45995f44b">EdgeVertWeight</a> *vert_weights,
<a name="l00742"></a>00742                          <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> dest_index)
<a name="l00743"></a>00743 {
<a name="l00744"></a>00744     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0878a281294e77e4591333b27182334">CustomData_interp</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab3adae7e2e8db21d0d96eb39889ed885">edgeData</a>, src_indices,
<a name="l00745"></a>00745                       weights, (<span class="keywordtype">float</span>*)vert_weights, count, dest_index);
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c7afb136b7d17bfd3f03b12986e3e9b">00748</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a9c2c94d3cff63d7b8c35a21ead4069d3">DM_interp_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00749"></a>00749                          <span class="keywordtype">int</span> *src_indices,
<a name="l00750"></a>00750                          <span class="keywordtype">float</span> *weights, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a16a0bcbdb91f8aefe091fe5f12a1250b">FaceVertWeight</a> *vert_weights,
<a name="l00751"></a>00751                          <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> dest_index)
<a name="l00752"></a>00752 {
<a name="l00753"></a>00753     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0878a281294e77e4591333b27182334">CustomData_interp</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, src_indices,
<a name="l00754"></a>00754                       weights, (<span class="keywordtype">float</span>*)vert_weights, count, dest_index);
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a47599fa033fdc1cce423147363a9d7ef">00757</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af4804d12783bcabb2df582f9c235f30a">DM_swap_tessface_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">int</span> *corner_indices)
<a name="l00758"></a>00758 {
<a name="l00759"></a>00759     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1a1574c9e5a9774c9c480d16dceba423">CustomData_swap</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, index, corner_indices);
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a8b8b5f4c2af72935578d9bf9530410c8">00762</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#adb94f9989e857a3b508cf63df8e7da71">DM_interp_loop_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00763"></a>00763                          <span class="keywordtype">int</span> *src_indices,
<a name="l00764"></a>00764                          <span class="keywordtype">float</span> *weights, <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> dest_index)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0878a281294e77e4591333b27182334">CustomData_interp</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, src_indices,
<a name="l00767"></a>00767                       weights, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, count, dest_index);
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a892f70686766a157aa5f9162762441cf">00770</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a18eec1482b4908e2a5b3c8a6cda7990f">DM_interp_poly_data</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *source, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dest,
<a name="l00771"></a>00771                          <span class="keywordtype">int</span> *src_indices,
<a name="l00772"></a>00772                          <span class="keywordtype">float</span> *weights, <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> dest_index)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0878a281294e77e4591333b27182334">CustomData_interp</a>(&amp;source-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, &amp;dest-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, src_indices,
<a name="l00775"></a>00775                       weights, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, count, dest_index);
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00779"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a74c9f2a3f2a151cdbfd7a132b9a1c684">00779</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a4fea807092a809b1dfe14637993d8dde">mesh_create_derived</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertCos)[3])
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (!dm)
<a name="l00784"></a>00784         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00785"></a>00785     
<a name="l00786"></a>00786     <span class="keywordflow">if</span> (vertCos)
<a name="l00787"></a>00787         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, vertCos);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">return</span> dm;
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 <span class="comment">/***/</span>
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a79542c805f35fff52ef36d04cf24817b">00796</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a462f613f54830e2a53e716c54462f5ae">mesh_create_derived_for_modifier</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, 
<a name="l00797"></a>00797                                               <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <span class="keywordtype">int</span> build_shapekey_layers)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00800"></a>00800     <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l00801"></a>00801     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l00802"></a>00802     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>= scene;
<a name="l00805"></a>00805     
<a name="l00806"></a>00806     <span class="keywordflow">if</span> (!(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a905ab5cd625053441b2e82efe47e95d1">mode</a>&amp;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>)) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#ae365ec70b13b21228b7d53c132a1a9c1">isDisabled</a> &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#ae365ec70b13b21228b7d53c132a1a9c1">isDisabled</a>(md, 0)) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00808"></a>00808     
<a name="l00809"></a>00809     <span class="keywordflow">if</span> (build_shapekey_layers &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a> &amp;&amp; (kb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a>-1))) {
<a name="l00810"></a>00810         <a class="code" href="../../d5/d17/BKE__key_8h.html#aa638210d1b5a527144f7eee9dd8c5a47">key_to_mesh</a>(kb, me);
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812     
<a name="l00813"></a>00813     <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a>==<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>) {
<a name="l00814"></a>00814         <span class="keywordtype">int</span> numVerts;
<a name="l00815"></a>00815         float (*deformedVerts)[3] = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a64404f5c7a4df638ad4d59f531eff895">mesh_getVertexCos</a>(me, &amp;numVerts);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, deformedVerts, numVerts, 0, 0);
<a name="l00818"></a>00818         dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a4fea807092a809b1dfe14637993d8dde">mesh_create_derived</a>(me, ob, deformedVerts);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820         <span class="keywordflow">if</span> (build_shapekey_layers)
<a name="l00821"></a>00821             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(dm, me, ob);
<a name="l00822"></a>00822         
<a name="l00823"></a>00823         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825     <span class="keywordflow">else</span> {
<a name="l00826"></a>00826         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tdm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a4fea807092a809b1dfe14637993d8dde">mesh_create_derived</a>(me, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828         <span class="keywordflow">if</span> (build_shapekey_layers)
<a name="l00829"></a>00829             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(tdm, me, ob);
<a name="l00830"></a>00830         
<a name="l00831"></a>00831         dm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, tdm, 0, 0);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833         <span class="keywordflow">if</span> (tdm != dm) tdm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(tdm);
<a name="l00834"></a>00834     }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">return</span> dm;
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4e7fa488ba48d2d59a072f2a97a0ee98">00839</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a4e7fa488ba48d2d59a072f2a97a0ee98">get_editbmesh_orco_verts</a>(<a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em)
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l00842"></a>00842     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l00843"></a>00843     <span class="keywordtype">float</span> *orco;
<a name="l00844"></a>00844     <span class="keywordtype">int</span> a, totvert;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="comment">/* these may not really be the orco&#39;s, but it&#39;s only for preview.</span>
<a name="l00847"></a>00847 <span class="comment">     * could be solver better once, but isn&#39;t simple */</span>
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     totvert= em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a>;
<a name="l00850"></a>00850     
<a name="l00851"></a>00851     orco = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert, <span class="stringliteral">&quot;BMEditMesh Orco&quot;</span>);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     eve = <a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#aba8c82365003c5fcbb34bbcb4e50f8f6" title="Iterator New.">BM_iter_new</a>(&amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00854"></a>00854     <span class="keywordflow">for</span> (a=0; eve; eve=<a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#a0fc839bb30650592541b47e20669a995" title="Iterator Step.">BM_iter_step</a>(&amp;iter), a+=3) {
<a name="l00855"></a>00855         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(orco+a, eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>);
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857     
<a name="l00858"></a>00858     <span class="keywordflow">return</span> orco;
<a name="l00859"></a>00859 }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="comment">/* orco custom data layer */</span>
<a name="l00862"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a062fb9b1257115443ae480266e1b30da">00862</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a062fb9b1257115443ae480266e1b30da">get_orco_coords_dm</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">int</span> layer, <span class="keywordtype">int</span> *free)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864     *free= 0;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="keywordflow">if</span> (layer == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>) {
<a name="l00867"></a>00867         <span class="comment">/* get original coordinates */</span>
<a name="l00868"></a>00868         *free= 1;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (em)
<a name="l00871"></a>00871             <span class="keywordflow">return</span> (<span class="keywordtype">float</span>(*)[3])<a class="code" href="../../db/d40/DerivedMesh_8c.html#a4e7fa488ba48d2d59a072f2a97a0ee98">get_editbmesh_orco_verts</a>(em);
<a name="l00872"></a>00872         <span class="keywordflow">else</span>
<a name="l00873"></a>00873             <span class="keywordflow">return</span> (<span class="keywordtype">float</span>(*)[3])<a class="code" href="../../df/d7f/BKE__mesh_8h.html#a397c869231e123f1bf2b24d7a9642258">get_mesh_orco_verts</a>(ob);
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (layer == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a7040e68f2a73465e0872379c94387b34">CD_CLOTH_ORCO</a>) {
<a name="l00876"></a>00876         <span class="comment">/* apply shape key for cloth, this should really be solved</span>
<a name="l00877"></a>00877 <span class="comment">         * by a more flexible customdata system, but not simple */</span>
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (!em) {
<a name="l00879"></a>00879             <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd = (<a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *)<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a90fa4bb334209f7e9f25fc6c4a594574">modifiers_findByType</a>(ob, <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a5fc484f055c7aba4c89beda85b5ba321">eModifierType_Cloth</a>);
<a name="l00880"></a>00880             <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb= <a class="code" href="../../d5/d17/BKE__key_8h.html#a73a6a2a7acd66ef711953753e3df14a5">key_get_keyblock</a>(<a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob), clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a988c44f77f99941feca4eb68e4910e94">sim_parms</a>-&gt;<a class="code" href="../../df/d87/structClothSimSettings.html#a1c774f3f6749e86d50d1400566e65f28">shapekey_rest</a>);
<a name="l00881"></a>00881 
<a name="l00882"></a>00882             <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>)
<a name="l00883"></a>00883                 <span class="keywordflow">return</span> kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>;
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a407ac650392ca386d236bcd29cfbaa77">00892</a> <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a407ac650392ca386d236bcd29cfbaa77">create_orco_dm</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">int</span> layer)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l00895"></a>00895     float (*orco)[3];
<a name="l00896"></a>00896     <span class="keywordtype">int</span> free;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (em) dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a76ccb905297ec18a26c8187f551a7e34">CDDM_from_BMEditMesh</a>(em, me, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00899"></a>00899     <span class="keywordflow">else</span> dm= <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l00900"></a>00900 
<a name="l00901"></a>00901     orco= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a062fb9b1257115443ae480266e1b30da">get_orco_coords_dm</a>(ob, em, layer, &amp;free);
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (orco) {
<a name="l00904"></a>00904         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, orco);
<a name="l00905"></a>00905         <span class="keywordflow">if</span> (free) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(orco);
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">return</span> dm;
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00913"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">00913</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l00914"></a>00914                         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *orcodm, <span class="keywordtype">int</span> layer)
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916     float (*orco)[3], (*layerorco)[3];
<a name="l00917"></a>00917     <span class="keywordtype">int</span> totvert, free;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="keywordflow">if</span> (orcodm) {
<a name="l00922"></a>00922         orco= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert, <span class="stringliteral">&quot;dm orco&quot;</span>);
<a name="l00923"></a>00923         free= 1;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         <span class="keywordflow">if</span> (orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(orcodm) == totvert)
<a name="l00926"></a>00926             orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(orcodm, orco);
<a name="l00927"></a>00927         <span class="keywordflow">else</span>
<a name="l00928"></a>00928             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(dm, orco);
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930     <span class="keywordflow">else</span>
<a name="l00931"></a>00931         orco= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a062fb9b1257115443ae480266e1b30da">get_orco_coords_dm</a>(ob, em, layer, &amp;free);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (orco) {
<a name="l00934"></a>00934         <span class="keywordflow">if</span> (layer == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>)
<a name="l00935"></a>00935             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a16d398e9339bf1522a9e4c13c374ab37">transform_mesh_orco_verts</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, orco, totvert, 0);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         <span class="keywordflow">if</span> (!(layerorco = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(dm, layer))) {
<a name="l00938"></a>00938             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1d5e2eb6e1a26961b60f0cac4a7411bc">DM_add_vert_layer</a>(dm, layer, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00939"></a>00939             layerorco = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(dm, layer);
<a name="l00940"></a>00940         }
<a name="l00941"></a>00941 
<a name="l00942"></a>00942         memcpy(layerorco, orco, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert);
<a name="l00943"></a>00943         <span class="keywordflow">if</span> (free) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(orco);
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945 }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947 <span class="comment">/* weight paint colors */</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="comment">/* Something of a hack, at the moment deal with weightpaint</span>
<a name="l00950"></a>00950 <span class="comment"> * by tucking into colors during modifier eval, only in</span>
<a name="l00951"></a>00951 <span class="comment"> * wpaint mode. Works ok but need to make sure recalc</span>
<a name="l00952"></a>00952 <span class="comment"> * happens on enter/exit wpaint.</span>
<a name="l00953"></a>00953 <span class="comment"> */</span>
<a name="l00954"></a>00954 
<a name="l00955"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#abb4c373c2f4f0297a7807ecd7f7a818c">00955</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#abb4c373c2f4f0297a7807ecd7f7a818c">weight_to_rgb</a>(<span class="keywordtype">float</span> r_rgb[3], <span class="keyword">const</span> <span class="keywordtype">float</span> weight)
<a name="l00956"></a>00956 {
<a name="l00957"></a>00957     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>= ((weight/2.0f)+0.5f);
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">if</span> (weight&lt;=0.25f) {    <span class="comment">// blue-&gt;cyan</span>
<a name="l00960"></a>00960         r_rgb[0]= 0.0f;
<a name="l00961"></a>00961         r_rgb[1]= blend*weight*4.0f;
<a name="l00962"></a>00962         r_rgb[2]= <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight&lt;=0.50f) {   <span class="comment">// cyan-&gt;green</span>
<a name="l00965"></a>00965         r_rgb[0]= 0.0f;
<a name="l00966"></a>00966         r_rgb[1]= <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l00967"></a>00967         r_rgb[2]= blend*(1.0f-((weight-0.25f)*4.0f));
<a name="l00968"></a>00968     }
<a name="l00969"></a>00969     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight &lt;= 0.75f) { <span class="comment">// green-&gt;yellow</span>
<a name="l00970"></a>00970         r_rgb[0]= blend * ((weight-0.50f)*4.0f);
<a name="l00971"></a>00971         r_rgb[1]= <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l00972"></a>00972         r_rgb[2]= 0.0f;
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight &lt;= 1.0f) { <span class="comment">// yellow-&gt;red</span>
<a name="l00975"></a>00975         r_rgb[0]= <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l00976"></a>00976         r_rgb[1]= blend * (1.0f-((weight-0.75f)*4.0f));
<a name="l00977"></a>00977         r_rgb[2]= 0.0f;
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979     <span class="keywordflow">else</span> {
<a name="l00980"></a>00980         <span class="comment">/* exceptional value, unclamped or nan,</span>
<a name="l00981"></a>00981 <span class="comment">         * avoid uninitialized memory use */</span>
<a name="l00982"></a>00982         r_rgb[0]= 1.0f;
<a name="l00983"></a>00983         r_rgb[1]= 0.0f;
<a name="l00984"></a>00984         r_rgb[2]= 1.0f;
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="comment">/* draw_flag&#39;s for calc_weightpaint_vert_color */</span>
<a name="l00989"></a>00989 <span class="keyword">enum</span> {
<a name="l00990"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a67674dc9fe57884fff7d0ad8e2e021a5">00990</a>     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a67674dc9fe57884fff7d0ad8e2e021a5">CALC_WP_MULTIPAINT</a>= (1&lt;&lt;0),
<a name="l00991"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a45b845f2d71d22ceaab1a1427d899455">00991</a>     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a45b845f2d71d22ceaab1a1427d899455">CALC_WP_AUTO_NORMALIZE</a>= (1&lt;&lt;1)
<a name="l00992"></a>00992 };
<a name="l00993"></a>00993 
<a name="l00994"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8a8178a69ca6e2216364abb6cf73ad1">00994</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8a8178a69ca6e2216364abb6cf73ad1">weightpaint_color</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> r_col[4], <a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *coba, <span class="keyword">const</span> <span class="keywordtype">float</span> input)
<a name="l00995"></a>00995 {
<a name="l00996"></a>00996     <span class="keywordtype">float</span> colf[4];
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     <span class="keywordflow">if</span> (coba) {
<a name="l00999"></a>00999         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(coba, input, colf);
<a name="l01000"></a>01000     }
<a name="l01001"></a>01001     <span class="keywordflow">else</span> {
<a name="l01002"></a>01002         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#abb4c373c2f4f0297a7807ecd7f7a818c">weight_to_rgb</a>(colf, input);
<a name="l01003"></a>01003     }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005     <span class="comment">/* don&#39;t use rgb_float_to_uchar() here because</span>
<a name="l01006"></a>01006 <span class="comment">     * the resulting float doesn&#39;t need 0-1 clamp check */</span>
<a name="l01007"></a>01007     r_col[0] = (<span class="keywordtype">unsigned</span> char)(colf[0] * 255.0f);
<a name="l01008"></a>01008     r_col[1] = (<span class="keywordtype">unsigned</span> char)(colf[1] * 255.0f);
<a name="l01009"></a>01009     r_col[2] = (<span class="keywordtype">unsigned</span> char)(colf[2] * 255.0f);
<a name="l01010"></a>01010     r_col[3] = 255;
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 
<a name="l01014"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a7a9f47e1bdc057e912926e0cab320308">01014</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a7a9f47e1bdc057e912926e0cab320308">calc_weightpaint_vert_color</a>(
<a name="l01015"></a>01015         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> r_col[4],
<a name="l01016"></a>01016         <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv, <a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *coba,
<a name="l01017"></a>01017         <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_act,
<a name="l01018"></a>01018         <span class="keyword">const</span> <span class="keywordtype">char</span> *dg_flags,
<a name="l01019"></a>01019         <span class="keyword">const</span> <span class="keywordtype">int</span> selected, <span class="keyword">const</span> <span class="keywordtype">int</span> draw_flag)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021     <span class="keywordtype">float</span> input = 0.0f;
<a name="l01022"></a>01022     
<a name="l01023"></a>01023     <span class="keywordtype">int</span> make_black= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="keywordflow">if</span> ((selected &gt; 1) &amp;&amp; (draw_flag &amp; <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a67674dc9fe57884fff7d0ad8e2e021a5">CALC_WP_MULTIPAINT</a>)) {
<a name="l01026"></a>01026         <span class="keywordtype">int</span> was_a_nonzero= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01027"></a>01027         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw= dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01030"></a>01030         <span class="keywordflow">for</span> (i = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i != 0; i--, dw++) {
<a name="l01031"></a>01031             <span class="comment">/* in multipaint, get the average if auto normalize is inactive</span>
<a name="l01032"></a>01032 <span class="comment">             * get the sum if it is active */</span>
<a name="l01033"></a>01033             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01034"></a>01034                 <span class="keywordflow">if</span> (dg_flags[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01035"></a>01035                     <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) {
<a name="l01036"></a>01036                         input += dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01037"></a>01037                         was_a_nonzero= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01038"></a>01038                     }
<a name="l01039"></a>01039                 }
<a name="l01040"></a>01040             }
<a name="l01041"></a>01041         }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043         <span class="comment">/* make it black if the selected groups have no weight on a vertex */</span>
<a name="l01044"></a>01044         <span class="keywordflow">if</span> (was_a_nonzero == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l01045"></a>01045             make_black = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01046"></a>01046         }
<a name="l01047"></a>01047         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((draw_flag &amp; <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a45b845f2d71d22ceaab1a1427d899455">CALC_WP_AUTO_NORMALIZE</a>) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l01048"></a>01048             input /= selected; <span class="comment">/* get the average */</span>
<a name="l01049"></a>01049         }
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051     <span class="keywordflow">else</span> {
<a name="l01052"></a>01052         <span class="comment">/* default, non tricky behavior */</span>
<a name="l01053"></a>01053         input= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dv, defbase_act);
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="keywordflow">if</span> (make_black) { <span class="comment">/* TODO, theme color */</span>
<a name="l01057"></a>01057         r_col[3] = 0;
<a name="l01058"></a>01058         r_col[2] = 0;
<a name="l01059"></a>01059         r_col[1] = 0;
<a name="l01060"></a>01060         r_col[0] = 255;
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062     <span class="keywordflow">else</span> {
<a name="l01063"></a>01063         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(input, 0.0f, 1.0f);
<a name="l01064"></a>01064         <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8a8178a69ca6e2216364abb6cf73ad1">weightpaint_color</a>(r_col, coba, input);
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a401dc1e817c7203e761bb2c2ca4fdc6a">01068</a> <span class="keyword">static</span> <a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a401dc1e817c7203e761bb2c2ca4fdc6a">stored_cb</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01069"></a>01069 
<a name="l01070"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a3c15986a0056ca1f2536f085d00128f6">01070</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a62b5b646e305bd93bf7e9181a411d3ef">vDM_ColorBand_store</a>(<a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *coba)
<a name="l01071"></a>01071 {
<a name="l01072"></a>01072     stored_cb= coba;
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 <span class="comment">/* return an array of vertex weight colors, caller must free.</span>
<a name="l01076"></a>01076 <span class="comment"> *</span>
<a name="l01077"></a>01077 <span class="comment"> * note that we could save some memory and allocate RGB only but then we&#39;d need to</span>
<a name="l01078"></a>01078 <span class="comment"> * re-arrange the colors when copying to the face since MCol has odd ordering,</span>
<a name="l01079"></a>01079 <span class="comment"> * so leave this as is - campbell */</span>
<a name="l01080"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a56fcec0bca4cb9c223a3e3500dadce5d">01080</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#a56fcec0bca4cb9c223a3e3500dadce5d">calc_weightpaint_vert_array</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> <span class="keyword">const</span> draw_flag, <a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *coba)
<a name="l01081"></a>01081 {
<a name="l01082"></a>01082     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l01083"></a>01083     <span class="keywordtype">int</span> numVerts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01084"></a>01084     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wtcol_v = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a> (<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) * numVerts * 4, <span class="stringliteral">&quot;weightmap_v&quot;</span>);
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     <span class="keywordflow">if</span> (dv) {
<a name="l01087"></a>01087         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wc = wtcol_v;
<a name="l01088"></a>01088         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090         <span class="comment">/* variables for multipaint */</span>
<a name="l01091"></a>01091         <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>);
<a name="l01092"></a>01092         <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_act = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a>-1;
<a name="l01093"></a>01093         <span class="keywordtype">char</span> *dg_flags = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(defbase_tot * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), __func__);
<a name="l01094"></a>01094         <span class="keyword">const</span> <span class="keywordtype">int</span> selected = <a class="code" href="../../da/d17/BKE__armature_8h.html#a5a61334aef7488589135bfb9f2f8d447">get_selected_defgroups</a>(ob, dg_flags, defbase_tot);
<a name="l01095"></a>01095 
<a name="l01096"></a>01096         <span class="keywordflow">for</span> (i = numVerts; i != 0; i--, wc += 4, dv++) {
<a name="l01097"></a>01097             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a7a9f47e1bdc057e912926e0cab320308">calc_weightpaint_vert_color</a>(wc, dv, coba, defbase_tot, defbase_act, dg_flags, selected, draw_flag);
<a name="l01098"></a>01098         }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dg_flags);
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102     <span class="keywordflow">else</span> {
<a name="l01103"></a>01103         <span class="keywordtype">int</span> col_i;
<a name="l01104"></a>01104         <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8a8178a69ca6e2216364abb6cf73ad1">weightpaint_color</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col_i, coba, 0.0f);
<a name="l01105"></a>01105         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#adb4412e21d9975cb827d6fadfd25d624">fill_vn_i</a>((<span class="keywordtype">int</span> *)wtcol_v, numVerts, col_i);
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">return</span> wtcol_v;
<a name="l01109"></a>01109 }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 <span class="comment">/* return an array of vertex weight colors from given weights, caller must free.</span>
<a name="l01112"></a>01112 <span class="comment"> *</span>
<a name="l01113"></a>01113 <span class="comment"> * note that we could save some memory and allocate RGB only but then we&#39;d need to</span>
<a name="l01114"></a>01114 <span class="comment"> * re-arrange the colors when copying to the face since MCol has odd ordering,</span>
<a name="l01115"></a>01115 <span class="comment"> * so leave this as is - campbell */</span>
<a name="l01116"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1c114fb24e1fbc8761a2cbb68f96b16">01116</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1c114fb24e1fbc8761a2cbb68f96b16">calc_colors_from_weights_array</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> num, <span class="keywordtype">float</span> *weights)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wtcol_v = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) * num * 4, <span class="stringliteral">&quot;weightmap_v&quot;</span>);
<a name="l01119"></a>01119     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wc = wtcol_v;
<a name="l01120"></a>01120     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     <span class="keywordflow">for</span> (i = 0; i &lt; num; i++, wc += 4, weights++)
<a name="l01123"></a>01123         <a class="code" href="../../db/d40/DerivedMesh_8c.html#aa8a8178a69ca6e2216364abb6cf73ad1">weightpaint_color</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) wc, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *weights);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="keywordflow">return</span> wtcol_v;
<a name="l01126"></a>01126 }
<a name="l01127"></a>01127 
<a name="l01128"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a6a081dbb3e1c6f572b48d00d16eabed9">01128</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">int</span> <span class="keyword">const</span> draw_flag,
<a name="l01129"></a>01129                            <span class="keywordtype">float</span> *weights, <span class="keywordtype">int</span> num, <span class="keyword">const</span> <span class="keywordtype">int</span> *<a class="code" href="../../d2/d6c/mball_8c.html#a47e7cc913f2b356de088363a1d87db4a">indices</a>)
<a name="l01130"></a>01130 {
<a name="l01131"></a>01131     <a class="code" href="../../d0/dc8/structColorBand.html">ColorBand</a> *coba= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a401dc1e817c7203e761bb2c2ca4fdc6a">stored_cb</a>; <span class="comment">/* warning, not a local var */</span>
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wtcol_v;
<a name="l01134"></a>01134 <span class="preprocessor">#if 0 </span><span class="comment">/* See coment below. */</span>
<a name="l01135"></a>01135     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wtcol_f = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05dbd15401b25131931348cee85e3d92">CD_PREVIEW_MCOL</a>);
<a name="l01136"></a>01136 <span class="preprocessor">#endif</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> char(*wtcol_l)[4] = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8ba9e2e6c310e5ddfb0535f0425c56a4">getLoopDataLayout</a>(dm), <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae45380b4ba75d70e532ffb22358a48d3">CD_PREVIEW_MLOOPCOL</a>);
<a name="l01138"></a>01138 <span class="preprocessor">#if 0 </span><span class="comment">/* See coment below. */</span>
<a name="l01139"></a>01139     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01140"></a>01140 <span class="preprocessor">#endif</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>    <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *mloop = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ac37f17fc9af1ffe241e8ad3049a9ccfb">getLoopArray</a>(dm), *ml;
<a name="l01142"></a>01142     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab8b054b009b29543deee65428097ee83">getPolyArray</a>(dm);
<a name="l01143"></a>01143 <span class="preprocessor">#if 0</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span>    <span class="keywordtype">int</span> numFaces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01145"></a>01145 <span class="preprocessor">#endif</span>
<a name="l01146"></a>01146 <span class="preprocessor"></span>    <span class="keywordtype">int</span> numVerts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01147"></a>01147     <span class="keywordtype">int</span> totloop;
<a name="l01148"></a>01148     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="preprocessor">#if 0 </span><span class="comment">/* See comment below */</span>
<a name="l01151"></a>01151     <span class="comment">/* If no CD_PREVIEW_MCOL existed yet, add a new one! */</span>
<a name="l01152"></a>01152     <span class="keywordflow">if</span> (!wtcol_f)
<a name="l01153"></a>01153         wtcol_f = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05dbd15401b25131931348cee85e3d92">CD_PREVIEW_MCOL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, numFaces);
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (wtcol_f) {
<a name="l01156"></a>01156         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *wtcol_f_step = wtcol_f;
<a name="l01157"></a>01157 <span class="preprocessor"># else</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
<a name="l01159"></a>01159 <span class="preprocessor"></span>    <span class="comment">/* XXX We have to create a CD_PREVIEW_MCOL, else it might sigsev (after a SubSurf mod, eg)... */</span>
<a name="l01160"></a>01160     <span class="keywordflow">if</span> (!dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05dbd15401b25131931348cee85e3d92">CD_PREVIEW_MCOL</a>))
<a name="l01161"></a>01161         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05dbd15401b25131931348cee85e3d92">CD_PREVIEW_MCOL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, numFaces);
<a name="l01162"></a>01162 <span class="preprocessor">#endif</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span>
<a name="l01164"></a>01164     {
<a name="l01165"></a>01165 <span class="preprocessor">#endif</span>
<a name="l01166"></a>01166 <span class="preprocessor"></span>
<a name="l01167"></a>01167         <span class="comment">/* Weights are given by caller. */</span>
<a name="l01168"></a>01168         <span class="keywordflow">if</span> (weights) {
<a name="l01169"></a>01169             <span class="keywordtype">float</span> *w = weights;
<a name="l01170"></a>01170             <span class="comment">/* If indices is not NULL, it means we do not have weights for all vertices,</span>
<a name="l01171"></a>01171 <span class="comment">             * so we must create them (and set them to zero)... */</span>
<a name="l01172"></a>01172             <span class="keywordflow">if</span> (indices) {
<a name="l01173"></a>01173                 w = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*numVerts, <span class="stringliteral">&quot;Temp weight array DM_update_weight_mcol&quot;</span>);
<a name="l01174"></a>01174                 i = num;
<a name="l01175"></a>01175                 <span class="keywordflow">while</span> (i--)
<a name="l01176"></a>01176                     w[indices[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]] = weights[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01177"></a>01177             }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179             <span class="comment">/* Convert float weights to colors. */</span>
<a name="l01180"></a>01180             wtcol_v = <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1c114fb24e1fbc8761a2cbb68f96b16">calc_colors_from_weights_array</a>(numVerts, w);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182             <span class="keywordflow">if</span> (indices)
<a name="l01183"></a>01183                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(w);
<a name="l01184"></a>01184         }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186         <span class="comment">/* No weights given, take them from active vgroup(s). */</span>
<a name="l01187"></a>01187         <span class="keywordflow">else</span>
<a name="l01188"></a>01188             wtcol_v = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a56fcec0bca4cb9c223a3e3500dadce5d">calc_weightpaint_vert_array</a>(ob, dm, draw_flag, coba);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         <span class="comment">/* Now copy colors in all face verts. */</span>
<a name="l01191"></a>01191         <span class="comment">/*first add colors to the tessellation faces*/</span>
<a name="l01192"></a>01192         <span class="comment">/* XXX Why update that layer? We have to update WEIGHT_MLOOPCOL anyway, </span>
<a name="l01193"></a>01193 <span class="comment">         *     and tessellation recreates mface layers from mloop/mpoly ones, so no</span>
<a name="l01194"></a>01194 <span class="comment">         *     need to fill WEIGHT_MCOL here. */</span>
<a name="l01195"></a>01195 <span class="preprocessor">#if 0</span>
<a name="l01196"></a>01196 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; numFaces; i++, mf++, wtcol_f_step += (4 * 4)) {
<a name="l01197"></a>01197             <span class="comment">/*origindex being NULL means we&#39;re operating on original mesh data*/</span>
<a name="l01198"></a>01198 <span class="preprocessor">#if 0</span>
<a name="l01199"></a>01199 <span class="preprocessor"></span>            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fidx= mf-&gt;v4 ? 3:2;
<a name="l01200"></a>01200 
<a name="l01201"></a>01201 <span class="preprocessor">#else   </span><span class="comment">/* better zero out triangles 4th component. else valgrind complains when the buffer&#39;s copied */</span>
<a name="l01202"></a>01202             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fidx;
<a name="l01203"></a>01203             <span class="keywordflow">if</span> (mf-&gt;v4) {
<a name="l01204"></a>01204                 fidx = 3;
<a name="l01205"></a>01205             }
<a name="l01206"></a>01206             <span class="keywordflow">else</span> {
<a name="l01207"></a>01207                 fidx = 2;
<a name="l01208"></a>01208                 *(<span class="keywordtype">int</span> *)(&amp;wtcol_f_step[3 * 4]) = 0;
<a name="l01209"></a>01209             }
<a name="l01210"></a>01210 <span class="preprocessor">#endif</span>
<a name="l01211"></a>01211 <span class="preprocessor"></span>
<a name="l01212"></a>01212             <span class="keywordflow">do</span> {
<a name="l01213"></a>01213                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a37ee99047410ba6a2c2552b52d3489f5">copy_v4_v4_char</a>((<span class="keywordtype">char</span> *)&amp;wtcol_f_step[fidx * 4],
<a name="l01214"></a>01214                                 (<span class="keywordtype">char</span> *)&amp;wtcol_v[4 * (*(&amp;mf-&gt;v1 + fidx))]);
<a name="l01215"></a>01215             } <span class="keywordflow">while</span> (fidx--);
<a name="l01216"></a>01216         }
<a name="l01217"></a>01217 <span class="preprocessor">#endif</span>
<a name="l01218"></a>01218 <span class="preprocessor"></span>        <span class="comment">/*now add to loops, so the data can be passed through the modifier stack*/</span>
<a name="l01219"></a>01219         <span class="comment">/* If no CD_PREVIEW_MLOOPCOL existed yet, we have to add a new one! */</span>
<a name="l01220"></a>01220         <span class="keywordflow">if</span> (!wtcol_l) {
<a name="l01221"></a>01221             <a class="code" href="../../da/d6c/BLI__array_8h.html#ae22059e2259b0ea217cfe400e698d21e">BLI_array_declare</a>(wtcol_l);
<a name="l01222"></a>01222             totloop = 0;
<a name="l01223"></a>01223             <span class="keywordflow">for</span> (i=0; i&lt;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>; i++, mp++) {
<a name="l01224"></a>01224                 ml = mloop + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226                 <a class="code" href="../../da/d6c/BLI__array_8h.html#a2b94e088d5d4b36bccad5ad91b41da23">BLI_array_growitems</a>(wtcol_l, mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>);
<a name="l01227"></a>01227                 <span class="keywordflow">for</span> (j = 0; j &lt; mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, ml++, totloop++) {
<a name="l01228"></a>01228                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a37ee99047410ba6a2c2552b52d3489f5">copy_v4_v4_char</a>((<span class="keywordtype">char</span> *)&amp;wtcol_l[totloop],
<a name="l01229"></a>01229                                     (<span class="keywordtype">char</span> *)&amp;wtcol_v[4 * ml-&gt;v]);
<a name="l01230"></a>01230                 }
<a name="l01231"></a>01231             }
<a name="l01232"></a>01232             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae45380b4ba75d70e532ffb22358a48d3">CD_PREVIEW_MLOOPCOL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, wtcol_l, totloop);
<a name="l01233"></a>01233         }
<a name="l01234"></a>01234         <span class="keywordflow">else</span> {
<a name="l01235"></a>01235             totloop = 0;
<a name="l01236"></a>01236             <span class="keywordflow">for</span> (i=0; i &lt; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>; i++, mp++) {
<a name="l01237"></a>01237                 ml = mloop + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l01238"></a>01238 
<a name="l01239"></a>01239                 <span class="keywordflow">for</span> (j=0; j &lt; mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, ml++, totloop++) {
<a name="l01240"></a>01240                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a37ee99047410ba6a2c2552b52d3489f5">copy_v4_v4_char</a>((<span class="keywordtype">char</span> *)&amp;wtcol_l[totloop],
<a name="l01241"></a>01241                                     (<span class="keywordtype">char</span> *)&amp;wtcol_v[4 * ml-&gt;v]);
<a name="l01242"></a>01242                 }
<a name="l01243"></a>01243             }
<a name="l01244"></a>01244         }
<a name="l01245"></a>01245         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(wtcol_v);
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> |= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>;
<a name="l01249"></a>01249 }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 
<a name="l01252"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a1e5a16b35f4a5e1f1ce55014dc1c06dc">01252</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1e5a16b35f4a5e1f1ce55014dc1c06dc">shapekey_layers_to_keyblocks</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> actshape_uid)
<a name="l01253"></a>01253 {
<a name="l01254"></a>01254     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01255"></a>01255     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, tot;
<a name="l01256"></a>01256     
<a name="l01257"></a>01257     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>)
<a name="l01258"></a>01258         <span class="keywordflow">return</span>; 
<a name="l01259"></a>01259     
<a name="l01260"></a>01260     tot = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a1952483728c254dddff6523fba919538">CustomData_number_of_layers</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>);
<a name="l01261"></a>01261     <span class="keywordflow">for</span> (i=0; i&lt;tot; i++) {
<a name="l01262"></a>01262         <a class="code" href="../../d5/d97/structCustomDataLayer.html">CustomDataLayer</a> *layer = &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a4cb6fb28022d2864818d082fb4f18be0">CustomData_get_layer_index_n</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>, i)];
<a name="l01263"></a>01263         float (*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>)[3], (*kbcos)[3];
<a name="l01264"></a>01264         
<a name="l01265"></a>01265         <span class="keywordflow">for</span> (kb=me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb=kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l01266"></a>01266             <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a> == layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#ab1bd1ff1a18d5afc9466a0c6bdac8b95">uid</a>)
<a name="l01267"></a>01267                 <span class="keywordflow">break</span>;
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269         
<a name="l01270"></a>01270         <span class="keywordflow">if</span> (!kb) {
<a name="l01271"></a>01271             kb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a118d62c847e0e2e8423ee54247fd3128">add_keyblock</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>, layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#aa8ef26f614b5037233d4ba102e3286d8">name</a>);
<a name="l01272"></a>01272             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a> = layer-&gt;<a class="code" href="../../d5/d97/structCustomDataLayer.html#ab1bd1ff1a18d5afc9466a0c6bdac8b95">uid</a>;
<a name="l01273"></a>01273         }
<a name="l01274"></a>01274         
<a name="l01275"></a>01275         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>)
<a name="l01276"></a>01276             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01277"></a>01277         
<a name="l01278"></a>01278         <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa4f16a171b314c81058a73acdd45388b">CustomData_get_layer_n</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>, i);
<a name="l01279"></a>01279         kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281         kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = kbcos = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>, <span class="stringliteral">&quot;kbcos DerivedMesh.c&quot;</span>);
<a name="l01282"></a>01282         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a> == actshape_uid) {
<a name="l01283"></a>01283             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01284"></a>01284             
<a name="l01285"></a>01285             <span class="keywordflow">for</span> (j=0; j&lt;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>; j++, kbcos++, mvert++) {
<a name="l01286"></a>01286                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(*kbcos, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01287"></a>01287             }
<a name="l01288"></a>01288         }
<a name="l01289"></a>01289         <span class="keywordflow">else</span> {
<a name="l01290"></a>01290             <span class="keywordflow">for</span> (j=0; j&lt;kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>; j++, <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>++, kbcos++) {
<a name="l01291"></a>01291                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(*kbcos, *cos);
<a name="l01292"></a>01292             }
<a name="l01293"></a>01293         }
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295     
<a name="l01296"></a>01296     <span class="keywordflow">for</span> (kb=me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb=kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> != dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>) {
<a name="l01298"></a>01298             <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>)
<a name="l01299"></a>01299                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l01300"></a>01300             
<a name="l01301"></a>01301             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>;
<a name="l01302"></a>01302             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>, <span class="stringliteral">&quot;kb-&gt;data derivedmesh.c&quot;</span>);
<a name="l01303"></a>01303             fprintf(stderr, <span class="stringliteral">&quot;%s: lost a shapekey layer: &#39;%s&#39;! (bmesh internal error)\n&quot;</span>, __func__, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>);
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306 }
<a name="l01307"></a>01307 
<a name="l01308"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a1522fca11b67f569b9b6456d2f612c32">01308</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob))
<a name="l01309"></a>01309 {
<a name="l01310"></a>01310     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l01311"></a>01311     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>;
<a name="l01312"></a>01312     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01313"></a>01313     <span class="keyword">const</span> <span class="keywordtype">size_t</span> shape_alloc_len = <span class="keyword">sizeof</span>(float) * 3 * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01314"></a>01314 
<a name="l01315"></a>01315     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>)
<a name="l01316"></a>01316         <span class="keywordflow">return</span>;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318     <span class="comment">/* ensure we can use mesh vertex count for derived mesh custom data */</span>
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> != dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm)) {
<a name="l01320"></a>01320         fprintf(stderr,
<a name="l01321"></a>01321                 <span class="stringliteral">&quot;%s: vertex size mismatch (mesh/dm) &#39;%s&#39; (%d != %d)\n&quot;</span>,
<a name="l01322"></a>01322                 __func__, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm));
<a name="l01323"></a>01323         <span class="keywordflow">return</span>;
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <span class="keywordflow">for</span> (i=0, kb=key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb=kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>, i++) {
<a name="l01327"></a>01327         <span class="keywordtype">int</span> ci;
<a name="l01328"></a>01328         <span class="keywordtype">float</span> *<a class="code" href="../../d2/d41/classarray.html">array</a>;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> != kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>) {
<a name="l01331"></a>01331             fprintf(stderr,
<a name="l01332"></a>01332                     <span class="stringliteral">&quot;%s: vertex size mismatch (Mesh &#39;%s&#39;:%d != KeyBlock &#39;%s&#39;:%d)\n&quot;</span>,
<a name="l01333"></a>01333                     __func__, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a>);
<a name="l01334"></a>01334             array = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(shape_alloc_len, __func__);
<a name="l01335"></a>01335         }
<a name="l01336"></a>01336         <span class="keywordflow">else</span> {
<a name="l01337"></a>01337             array = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(shape_alloc_len, __func__);
<a name="l01338"></a>01338             memcpy(array, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>, shape_alloc_len);
<a name="l01339"></a>01339         }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341         <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a514f57347b3c1b0b3bdcbfca430b4730">CustomData_add_layer_named</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2322540667163be1f19150b2ec590291">CD_ASSIGN</a>, array, dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>);
<a name="l01342"></a>01342         ci = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a4cb6fb28022d2864818d082fb4f18be0">CustomData_get_layer_index_n</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa9fa683ff8192cbd1897c3f9e50861ff">CD_SHAPEKEY</a>, i);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[ci].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ab1bd1ff1a18d5afc9466a0c6bdac8b95">uid</a> = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a19133403f4209f5165ef7d874cce987c">uid</a>;
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 <span class="comment">/* new value for useDeform -1  (hack for the gameengine):</span>
<a name="l01349"></a>01349 <span class="comment"> * - apply only the modifier stack of the object, skipping the virtual modifiers,</span>
<a name="l01350"></a>01350 <span class="comment"> * - don&#39;t apply the key</span>
<a name="l01351"></a>01351 <span class="comment"> * - apply deform modifiers and input vertexco</span>
<a name="l01352"></a>01352 <span class="comment"> */</span>
<a name="l01353"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">01353</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*inputVertexCos)[3],
<a name="l01354"></a>01354                                 <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> **deform_r, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> **final_r,
<a name="l01355"></a>01355                                 <span class="keywordtype">int</span> useRenderParams, <span class="keywordtype">int</span> useDeform,
<a name="l01356"></a>01356                                 <span class="keywordtype">int</span> needMapping, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask, 
<a name="l01357"></a>01357                                 <span class="keywordtype">int</span> index, <span class="keywordtype">int</span> useCache, <span class="keywordtype">int</span> build_shapekey_layers)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01360"></a>01360     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *firstmd, *md, *previewmd = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01361"></a>01361     <a class="code" href="../../dd/dfa/structCDMaskLink.html">CDMaskLink</a> *datamasks, *curr;
<a name="l01362"></a>01362     <span class="comment">/* XXX Always copying POLYINDEX, else tessellated data are no more valid! */</span>
<a name="l01363"></a>01363     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask, nextmask, append_mask = <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae2ef7b00a43a786d553244ecdd2b4dd9">CD_MASK_POLYINDEX</a>;
<a name="l01364"></a>01364     float (*deformedVerts)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01365"></a>01365     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *orcodm, *clothorcodm, *finaldm;
<a name="l01366"></a>01366     <span class="keywordtype">int</span> numVerts = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l01367"></a>01367     <span class="keywordtype">int</span> required_mode;
<a name="l01368"></a>01368     <span class="keywordtype">int</span> isPrevDeform= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01369"></a>01369     <span class="keywordtype">int</span> skipVirtualArmature = (useDeform &lt; 0);
<a name="l01370"></a>01370     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd= <a class="code" href="../../d1/d37/BKE__multires_8h.html#ae802ee87a22e74874fa1acd0e8771388">get_multires_modifier</a>(scene, ob, 0);
<a name="l01371"></a>01371     <span class="keywordtype">int</span> has_multires = mmd != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, multires_applied = 0;
<a name="l01372"></a>01372     <span class="keywordtype">int</span> sculpt_mode = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a7b8620799f1bc866a5dc5ecaacf987a7">OB_MODE_SCULPT</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374     <span class="keyword">const</span> <span class="keywordtype">int</span> draw_flag= ((scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a87a556ea02e1c4d8373e54eb45610b74">multipaint</a> ? <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a67674dc9fe57884fff7d0ad8e2e021a5">CALC_WP_MULTIPAINT</a> : 0) |
<a name="l01375"></a>01375                           (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a854bcd28f2ceed508851e4c830c4c037">auto_normalize</a> ? <a class="code" href="../../db/d40/DerivedMesh_8c.html#ae4d5251432e1a9e6803c0240cc492e18a45b845f2d71d22ceaab1a1427d899455">CALC_WP_AUTO_NORMALIZE</a> : 0));
<a name="l01376"></a>01376     <span class="comment">/* Generic preview only in object mode! */</span>
<a name="l01377"></a>01377     <span class="keyword">const</span> <span class="keywordtype">int</span> do_mod_mcol = (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550af1bb3c40f4c542a4dc41414edc7c2d10">OB_MODE_OBJECT</a>);
<a name="l01378"></a>01378 <span class="preprocessor">#if 0 </span><span class="comment">/* XXX Will re-enable this when we have global mod stack options. */</span>
<a name="l01379"></a>01379     <span class="keyword">const</span> <span class="keywordtype">int</span> do_final_wmcol = (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;weights_preview == WP_WPREVIEW_FINAL) &amp;&amp; do_wmcol;
<a name="l01380"></a>01380 <span class="preprocessor">#endif</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">int</span> do_final_wmcol = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01382"></a>01382     <span class="keywordtype">int</span> do_init_wmcol = ((dataMask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e6aa6e2e4639941b0029226411d6a04">CD_MASK_PREVIEW_MCOL</a>) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) &amp;&amp; !do_final_wmcol);
<a name="l01383"></a>01383     <span class="comment">/* XXX Same as above... For now, only weights preview in WPaint mode. */</span>
<a name="l01384"></a>01384     <span class="keyword">const</span> <span class="keywordtype">int</span> do_mod_wmcol = do_init_wmcol;
<a name="l01385"></a>01385 
<a name="l01386"></a>01386     <span class="keywordflow">if</span> (mmd &amp;&amp; !mmd-&gt;<a class="code" href="../../dd/dd2/structMultiresModifierData.html#a80a926d4fb1ecdf396aa270b0d1724e1">sculptlvl</a>)
<a name="l01387"></a>01387         has_multires = 0;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389     <span class="keywordflow">if</span> (!skipVirtualArmature) {
<a name="l01390"></a>01390         firstmd = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a136f15cde944e4b0c5d938d946d975c9">modifiers_getVirtualModifierList</a>(ob);
<a name="l01391"></a>01391     }
<a name="l01392"></a>01392     <span class="keywordflow">else</span> {
<a name="l01393"></a>01393         <span class="comment">/* game engine exception */</span>
<a name="l01394"></a>01394         firstmd = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01395"></a>01395         <span class="keywordflow">if</span> (firstmd &amp;&amp; firstmd-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435aa45deecb66e254a60207702a40efa416">eModifierType_Armature</a>)
<a name="l01396"></a>01396             firstmd = firstmd-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>;
<a name="l01397"></a>01397     }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399     md = firstmd;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a2f0e48ce13f2da1a049132012ebc6efa">modifiers_clearErrors</a>(ob);
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <span class="keywordflow">if</span> (useRenderParams) required_mode = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a35b98a06484384dcc7e907ca646e5918">eModifierMode_Render</a>;
<a name="l01404"></a>01404     <span class="keywordflow">else</span> required_mode = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a>;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     datamasks = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a1eabdd43f807b40d1ac15aece51c0704">modifiers_calcDataMasks</a>(scene, ob, md, dataMask, required_mode);
<a name="l01407"></a>01407     curr = datamasks;
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     <span class="keywordflow">if</span> (do_mod_wmcol || do_mod_mcol) {
<a name="l01410"></a>01410         <span class="comment">/* Find the last active modifier generating a preview, or NULL if none. */</span>
<a name="l01411"></a>01411         <span class="comment">/* XXX Currently, DPaint modifier just ignores this.</span>
<a name="l01412"></a>01412 <span class="comment">         *     Needs a stupid hack...</span>
<a name="l01413"></a>01413 <span class="comment">         *     The whole &quot;modifier preview&quot; thing has to be (re?)designed, anyway! */</span>
<a name="l01414"></a>01414         previewmd = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a73f6dfb7b13cecb2aed4e58f47198f91">modifiers_getLastPreview</a>(scene, md, required_mode);
<a name="l01415"></a>01415     }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     <span class="keywordflow">if</span> (deform_r) *deform_r = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01418"></a>01418     *final_r = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     <span class="keywordflow">if</span> (useDeform) {
<a name="l01421"></a>01421         <span class="keywordflow">if</span> (inputVertexCos)
<a name="l01422"></a>01422             deformedVerts = inputVertexCos;
<a name="l01423"></a>01423         
<a name="l01424"></a>01424         <span class="comment">/* Apply all leading deforming modifiers */</span>
<a name="l01425"></a>01425         <span class="keywordflow">for</span> (;md; md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>, curr = curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#acd0dfda6340bd3a89dcaa565dd06861f">next</a>) {
<a name="l01426"></a>01426             <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l01427"></a>01427 
<a name="l01428"></a>01428             md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>= scene;
<a name="l01429"></a>01429             
<a name="l01430"></a>01430             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, required_mode)) <span class="keywordflow">continue</span>;
<a name="l01431"></a>01431             <span class="keywordflow">if</span> (useDeform &lt; 0 &amp;&amp; mti-&gt;<a class="code" href="../../dc/d63/MOD__build_8c.html#ae37f754ad05622ea4c4922c878329a6b">dependsOnTime</a> &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a60773b9eb458957474414abef891b29d">dependsOnTime</a>(md)) <span class="keywordflow">continue</span>;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433             <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>) {
<a name="l01434"></a>01434                 <span class="keywordflow">if</span> (!deformedVerts)
<a name="l01435"></a>01435                     deformedVerts = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a64404f5c7a4df638ad4d59f531eff895">mesh_getVertexCos</a>(me, &amp;numVerts);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437                 mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, deformedVerts, numVerts, useRenderParams, useDeform);
<a name="l01438"></a>01438             }
<a name="l01439"></a>01439             <span class="keywordflow">else</span> {
<a name="l01440"></a>01440                 <span class="keywordflow">break</span>;
<a name="l01441"></a>01441             }
<a name="l01442"></a>01442             
<a name="l01443"></a>01443             <span class="comment">/* grab modifiers until index i */</span>
<a name="l01444"></a>01444             <span class="keywordflow">if</span> ((index &gt;= 0) &amp;&amp; (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ae1bd4562ce50876e3597bdeade156da4">modifiers_indexInObject</a>(ob, md) &gt;= index))
<a name="l01445"></a>01445                 <span class="keywordflow">break</span>;
<a name="l01446"></a>01446         }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448         <span class="comment">/* Result of all leading deforming modifiers is cached for</span>
<a name="l01449"></a>01449 <span class="comment">         * places that wish to use the original mesh but with deformed</span>
<a name="l01450"></a>01450 <span class="comment">         * coordinates (vpaint, etc.)</span>
<a name="l01451"></a>01451 <span class="comment">         */</span>
<a name="l01452"></a>01452         <span class="keywordflow">if</span> (deform_r) {
<a name="l01453"></a>01453             *deform_r = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01454"></a>01454              
<a name="l01455"></a>01455             <span class="keywordflow">if</span> (build_shapekey_layers)
<a name="l01456"></a>01456                 <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(dm, me, ob);
<a name="l01457"></a>01457             
<a name="l01458"></a>01458             <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01459"></a>01459                 <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(*deform_r, deformedVerts);
<a name="l01460"></a>01460                 <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(*deform_r);
<a name="l01461"></a>01461             }
<a name="l01462"></a>01462         }
<a name="l01463"></a>01463     }
<a name="l01464"></a>01464     <span class="keywordflow">else</span> {
<a name="l01465"></a>01465         <span class="comment">/* default behavior for meshes */</span>
<a name="l01466"></a>01466         <span class="keywordflow">if</span> (inputVertexCos)
<a name="l01467"></a>01467             deformedVerts = inputVertexCos;
<a name="l01468"></a>01468         <span class="keywordflow">else</span>
<a name="l01469"></a>01469             deformedVerts = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a64404f5c7a4df638ad4d59f531eff895">mesh_getVertexCos</a>(me, &amp;numVerts);
<a name="l01470"></a>01470     }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     <span class="comment">/* Now apply all remaining modifiers. If useDeform is off then skip</span>
<a name="l01474"></a>01474 <span class="comment">     * OnlyDeform ones. </span>
<a name="l01475"></a>01475 <span class="comment">     */</span>
<a name="l01476"></a>01476     dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01477"></a>01477     orcodm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01478"></a>01478     clothorcodm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     <span class="keywordflow">for</span> (;md; md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>, curr = curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#acd0dfda6340bd3a89dcaa565dd06861f">next</a>) {
<a name="l01481"></a>01481         <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l01482"></a>01482 
<a name="l01483"></a>01483         md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a753914a1c3656e4c937e3c3975fec77e">scene</a>= scene;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, required_mode)) <span class="keywordflow">continue</span>;
<a name="l01486"></a>01486         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a> &amp;&amp; !useDeform) <span class="keywordflow">continue</span>;
<a name="l01487"></a>01487         <span class="keywordflow">if</span> ((mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a6ab09ae52780d2c940000109012f1fe3">flags</a> &amp; <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a4c64dc2e6ccb9a3c602589c543ac0321ac5af09e5d1959bdec23fdab1478df24d">eModifierTypeFlag_RequiresOriginalData</a>) &amp;&amp; dm) {
<a name="l01488"></a>01488             <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#aa8f7ed8ac604b1d55b0b420634e91ea3">modifier_setError</a>(md, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="../../d6/d61/BLF__translation_8h.html#a7163975dd2031d6463da225baaf59bfb">TIP_</a>(<span class="stringliteral">&quot;Modifier requires original data, bad stack position.&quot;</span>));
<a name="l01489"></a>01489             <span class="keywordflow">continue</span>;
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491         <span class="keywordflow">if</span> (sculpt_mode &amp;&amp; (!has_multires || multires_applied)) {
<a name="l01492"></a>01492             <span class="keywordtype">int</span> unsupported= 0;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a3d7b2bfc12195d43d8dac148e95d0281">sculpt</a>-&gt;<a class="code" href="../../d2/df6/structSculpt.html#a1651e1f51e767932ec6a696f367b2723">flags</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a08a201674b91c6b7ed2f8c1513a196d5a2bdf4c2e60375afea74f43c3cedbe07c">SCULPT_ONLY_DEFORM</a>)
<a name="l01495"></a>01495                 unsupported|= mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> != <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497             unsupported|= md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a> &amp;&amp; ((<a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a>*)md)-&gt;sculptlvl==0;
<a name="l01498"></a>01498             unsupported|= multires_applied;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500             <span class="keywordflow">if</span> (unsupported) {
<a name="l01501"></a>01501                 <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#aa8f7ed8ac604b1d55b0b420634e91ea3">modifier_setError</a>(md, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="../../d6/d61/BLF__translation_8h.html#a7163975dd2031d6463da225baaf59bfb">TIP_</a>(<span class="stringliteral">&quot;Not supported in sculpt mode.&quot;</span>));
<a name="l01502"></a>01502                 <span class="keywordflow">continue</span>;
<a name="l01503"></a>01503             }
<a name="l01504"></a>01504         }
<a name="l01505"></a>01505         <span class="keywordflow">if</span> (needMapping &amp;&amp; !<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a246b91308b8dbdfa39f9998f14b0a002">modifier_supportsMapping</a>(md)) <span class="keywordflow">continue</span>;
<a name="l01506"></a>01506         <span class="keywordflow">if</span> (useDeform &lt; 0 &amp;&amp; mti-&gt;<a class="code" href="../../dc/d63/MOD__build_8c.html#ae37f754ad05622ea4c4922c878329a6b">dependsOnTime</a> &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a60773b9eb458957474414abef891b29d">dependsOnTime</a>(md)) <span class="keywordflow">continue</span>;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508         <span class="comment">/* add an orco layer if needed by this modifier */</span>
<a name="l01509"></a>01509         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a29ad86ddfc5c2aeb34f59ec4e3713aba">requiredDataMask</a>)
<a name="l01510"></a>01510             mask = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a29ad86ddfc5c2aeb34f59ec4e3713aba">requiredDataMask</a>(ob, md);
<a name="l01511"></a>01511         <span class="keywordflow">else</span>
<a name="l01512"></a>01512             mask = 0;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (dm &amp;&amp; (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>))
<a name="l01515"></a>01515             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dm, orcodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517         <span class="comment">/* How to apply modifier depends on (a) what we already have as</span>
<a name="l01518"></a>01518 <span class="comment">         * a result of previous modifiers (could be a DerivedMesh or just</span>
<a name="l01519"></a>01519 <span class="comment">         * deformed vertices) and (b) what type the modifier is.</span>
<a name="l01520"></a>01520 <span class="comment">         */</span>
<a name="l01521"></a>01521 
<a name="l01522"></a>01522         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>) {
<a name="l01523"></a>01523             <span class="comment">/* No existing verts to deform, need to build them. */</span>
<a name="l01524"></a>01524             <span class="keywordflow">if</span> (!deformedVerts) {
<a name="l01525"></a>01525                 <span class="keywordflow">if</span> (dm) {
<a name="l01526"></a>01526                     <span class="comment">/* Deforming a derived mesh, read the vertex locations</span>
<a name="l01527"></a>01527 <span class="comment">                     * out of the mesh and deform them. Once done with this</span>
<a name="l01528"></a>01528 <span class="comment">                     * run of deformers verts will be written back.</span>
<a name="l01529"></a>01529 <span class="comment">                     */</span>
<a name="l01530"></a>01530                     numVerts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01531"></a>01531                     deformedVerts =
<a name="l01532"></a>01532                         <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(*deformedVerts) * numVerts, <span class="stringliteral">&quot;dfmv&quot;</span>);
<a name="l01533"></a>01533                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(dm, deformedVerts);
<a name="l01534"></a>01534                 }
<a name="l01535"></a>01535                 <span class="keywordflow">else</span> {
<a name="l01536"></a>01536                     deformedVerts = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a64404f5c7a4df638ad4d59f531eff895">mesh_getVertexCos</a>(me, &amp;numVerts);
<a name="l01537"></a>01537                 }
<a name="l01538"></a>01538             }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540             <span class="comment">/* if this is not the last modifier in the stack then recalculate the normals</span>
<a name="l01541"></a>01541 <span class="comment">             * to avoid giving bogus normals to the next modifier see: [#23673] */</span>
<a name="l01542"></a>01542             <span class="keywordflow">if</span> (isPrevDeform &amp;&amp;  mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a06bc9bfbb0b2235bd90b1dc2c3015ad8">dependsOnNormals</a> &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a06bc9bfbb0b2235bd90b1dc2c3015ad8">dependsOnNormals</a>(md)) {
<a name="l01543"></a>01543                 <span class="comment">/* XXX, this covers bug #23673, but we may need normal calc for other types */</span>
<a name="l01544"></a>01544                 <span class="keywordflow">if</span> (dm &amp;&amp; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> == <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>) {
<a name="l01545"></a>01545                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, deformedVerts);
<a name="l01546"></a>01546                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l01547"></a>01547                 }
<a name="l01548"></a>01548             }
<a name="l01549"></a>01549 
<a name="l01550"></a>01550             mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, dm, deformedVerts, numVerts, useRenderParams, useDeform);
<a name="l01551"></a>01551         }
<a name="l01552"></a>01552         <span class="keywordflow">else</span> {
<a name="l01553"></a>01553             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *ndm;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555             <span class="comment">/* determine which data layers are needed by following modifiers */</span>
<a name="l01556"></a>01556             <span class="keywordflow">if</span> (curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#acd0dfda6340bd3a89dcaa565dd06861f">next</a>)
<a name="l01557"></a>01557                 nextmask= curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#acd0dfda6340bd3a89dcaa565dd06861f">next</a>-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#a91272532243d51751842e81cc63eae7c">mask</a>;
<a name="l01558"></a>01558             <span class="keywordflow">else</span>
<a name="l01559"></a>01559                 nextmask= dataMask;
<a name="l01560"></a>01560 
<a name="l01561"></a>01561             <span class="comment">/* apply vertex coordinates or build a DerivedMesh as necessary */</span>
<a name="l01562"></a>01562             <span class="keywordflow">if</span> (dm) {
<a name="l01563"></a>01563                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01564"></a>01564                     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tdm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l01565"></a>01565                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01566"></a>01566                     dm = tdm;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, deformedVerts);
<a name="l01569"></a>01569                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l01570"></a>01570                 }
<a name="l01571"></a>01571             }
<a name="l01572"></a>01572             <span class="keywordflow">else</span> {
<a name="l01573"></a>01573                 dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01574"></a>01574 
<a name="l01575"></a>01575                 <span class="keywordflow">if</span> (build_shapekey_layers)
<a name="l01576"></a>01576                     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(dm, me, ob);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01579"></a>01579                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, deformedVerts);
<a name="l01580"></a>01580                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l01581"></a>01581                 }
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (do_init_wmcol)
<a name="l01584"></a>01584                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(ob, dm, draw_flag, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586                 <span class="comment">/* Constructive modifiers need to have an origindex</span>
<a name="l01587"></a>01587 <span class="comment">                 * otherwise they wont have anywhere to copy the data from.</span>
<a name="l01588"></a>01588 <span class="comment">                 *</span>
<a name="l01589"></a>01589 <span class="comment">                 * Also create ORIGINDEX data if any of the following modifiers</span>
<a name="l01590"></a>01590 <span class="comment">                 * requests it, this way Mirror, Solidify etc will keep ORIGINDEX</span>
<a name="l01591"></a>01591 <span class="comment">                 * data by using generic DM_copy_vert_data() functions.</span>
<a name="l01592"></a>01592 <span class="comment">                 */</span>
<a name="l01593"></a>01593                 <span class="keywordflow">if</span> (needMapping || (nextmask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a352c6860702ca1aeea5767d7c6368147">CD_MASK_ORIGINDEX</a>)) {
<a name="l01594"></a>01594                     <span class="comment">/* calc */</span>
<a name="l01595"></a>01595                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1d5e2eb6e1a26961b60f0cac4a7411bc">DM_add_vert_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01596"></a>01596                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a5c012cd27a5099e683af31e5cac9cbdb">DM_add_edge_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01597"></a>01597                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8edc78844a26b9e714ae937daca04354">DM_add_poly_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acc53e44a82e4229a6809480d3158c173">range_vn_i</a>(<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aa122e954c0ef25634444e54d7064365f">DM_get_vert_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>), dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a2edb9ee7af5ff3b26b2615882e2b7dcf">numVertData</a>, 0);
<a name="l01600"></a>01600                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acc53e44a82e4229a6809480d3158c173">range_vn_i</a>(<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a03bf14aaccee3ee9b3d6a19dd013309c">DM_get_edge_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>), dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa77e459bd709eed5b4724f4e8fdebfae">numEdgeData</a>, 0);
<a name="l01601"></a>01601                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acc53e44a82e4229a6809480d3158c173">range_vn_i</a>(<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a134ed8d7ec1c59a8d65cf1f8899123a2">DM_get_poly_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>), dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aff24b50c34425277af6c2e00079e9d7f">numPolyData</a>, 0);
<a name="l01602"></a>01602                 }
<a name="l01603"></a>01603             }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605             
<a name="l01606"></a>01606             <span class="comment">/* set the DerivedMesh to only copy needed data */</span>
<a name="l01607"></a>01607             mask= curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#a91272532243d51751842e81cc63eae7c">mask</a>;
<a name="l01608"></a>01608             <span class="comment">/* needMapping check here fixes bug [#28112], otherwise its</span>
<a name="l01609"></a>01609 <span class="comment">             * possible that it wont be copied */</span>
<a name="l01610"></a>01610             mask |= append_mask;
<a name="l01611"></a>01611             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(dm, mask | (needMapping ? <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a352c6860702ca1aeea5767d7c6368147">CD_MASK_ORIGINDEX</a> : 0));
<a name="l01612"></a>01612             
<a name="l01613"></a>01613             <span class="comment">/* add cloth rest shape key if need */</span>
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9c9641026a22f1dcdee62c703f1e773b">CD_MASK_CLOTH_ORCO</a>)
<a name="l01615"></a>01615                 <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dm, clothorcodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a7040e68f2a73465e0872379c94387b34">CD_CLOTH_ORCO</a>);
<a name="l01616"></a>01616 
<a name="l01617"></a>01617             <span class="comment">/* add an origspace layer if needed */</span>
<a name="l01618"></a>01618             <span class="keywordflow">if</span> ((curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#a91272532243d51751842e81cc63eae7c">mask</a>) &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a907a9b3b81f32261dc9f4d40fba94b3e">CD_MASK_ORIGSPACE_MLOOP</a>) {
<a name="l01619"></a>01619                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>)) {
<a name="l01620"></a>01620                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0375950f9607f964fc5a2761e2ed44d3">DM_add_loop_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01621"></a>01621                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af0153c5b305453f044f1101e646f232b">DM_init_origspace</a>(dm);
<a name="l01622"></a>01622                 }
<a name="l01623"></a>01623             }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625             ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, dm, useRenderParams, useCache);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627             <span class="keywordflow">if</span> (ndm) {
<a name="l01628"></a>01628                 <span class="comment">/* if the modifier returned a new dm, release the old one */</span>
<a name="l01629"></a>01629                 <span class="keywordflow">if</span> (dm &amp;&amp; dm != ndm) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01630"></a>01630 
<a name="l01631"></a>01631                 dm = ndm;
<a name="l01632"></a>01632 
<a name="l01633"></a>01633                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01634"></a>01634                     <span class="keywordflow">if</span> (deformedVerts != inputVertexCos)
<a name="l01635"></a>01635                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l01636"></a>01636 
<a name="l01637"></a>01637                     deformedVerts = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01638"></a>01638                 }
<a name="l01639"></a>01639             }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641             <span class="comment">/* create an orco derivedmesh in parallel */</span>
<a name="l01642"></a>01642             <span class="keywordflow">if</span> (nextmask &amp; CD_MASK_ORCO) {
<a name="l01643"></a>01643                 <span class="keywordflow">if</span> (!orcodm)
<a name="l01644"></a>01644                     orcodm= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a407ac650392ca386d236bcd29cfbaa77">create_orco_dm</a>(ob, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01645"></a>01645 
<a name="l01646"></a>01646                 nextmask &amp;= ~CD_MASK_ORCO;
<a name="l01647"></a>01647                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(orcodm, nextmask | CD_MASK_ORIGINDEX);
<a name="l01648"></a>01648                 ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, orcodm, useRenderParams, 0);
<a name="l01649"></a>01649 
<a name="l01650"></a>01650                 <span class="keywordflow">if</span> (ndm) {
<a name="l01651"></a>01651                     <span class="comment">/* if the modifier returned a new dm, release the old one */</span>
<a name="l01652"></a>01652                     <span class="keywordflow">if</span> (orcodm &amp;&amp; orcodm != ndm) orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(orcodm);
<a name="l01653"></a>01653                     orcodm = ndm;
<a name="l01654"></a>01654                 }
<a name="l01655"></a>01655             }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657             <span class="comment">/* create cloth orco derivedmesh in parallel */</span>
<a name="l01658"></a>01658             <span class="keywordflow">if</span> (nextmask &amp; CD_MASK_CLOTH_ORCO) {
<a name="l01659"></a>01659                 <span class="keywordflow">if</span> (!clothorcodm)
<a name="l01660"></a>01660                     clothorcodm= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a407ac650392ca386d236bcd29cfbaa77">create_orco_dm</a>(ob, me, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a7040e68f2a73465e0872379c94387b34">CD_CLOTH_ORCO</a>);
<a name="l01661"></a>01661 
<a name="l01662"></a>01662                 nextmask &amp;= ~CD_MASK_CLOTH_ORCO;
<a name="l01663"></a>01663                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(clothorcodm, nextmask | CD_MASK_ORIGINDEX);
<a name="l01664"></a>01664                 ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, clothorcodm, useRenderParams, 0);
<a name="l01665"></a>01665 
<a name="l01666"></a>01666                 <span class="keywordflow">if</span> (ndm) {
<a name="l01667"></a>01667                     <span class="comment">/* if the modifier returned a new dm, release the old one */</span>
<a name="l01668"></a>01668                     <span class="keywordflow">if</span> (clothorcodm &amp;&amp; clothorcodm != ndm) clothorcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(clothorcodm);
<a name="l01669"></a>01669                     clothorcodm = ndm;
<a name="l01670"></a>01670                 }
<a name="l01671"></a>01671             }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673             <span class="comment">/* in case of dynamic paint, make sure preview mask remains for following modifiers */</span>
<a name="l01674"></a>01674             <span class="comment">/* XXX Temp and hackish solution! */</span>
<a name="l01675"></a>01675             <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435abf6c2369ea1f5b0cab992eb27906823c">eModifierType_DynamicPaint</a>)
<a name="l01676"></a>01676                 append_mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aab7d9103c55cc8f9c1d283a90ab03f41">CD_MASK_PREVIEW_MLOOPCOL</a>;
<a name="l01677"></a>01677             <span class="comment">/* In case of active preview modifier, make sure preview mask remains for following modifiers. */</span>
<a name="l01678"></a>01678             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((md == previewmd) &amp;&amp; (do_mod_wmcol)) {
<a name="l01679"></a>01679                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(ob, dm, draw_flag, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01680"></a>01680                 append_mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aab7d9103c55cc8f9c1d283a90ab03f41">CD_MASK_PREVIEW_MLOOPCOL</a>;
<a name="l01681"></a>01681             }
<a name="l01682"></a>01682         }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684         isPrevDeform= (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>);
<a name="l01685"></a>01685 
<a name="l01686"></a>01686         <span class="comment">/* grab modifiers until index i */</span>
<a name="l01687"></a>01687         <span class="keywordflow">if</span> ((index &gt;= 0) &amp;&amp; (<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#ae1bd4562ce50876e3597bdeade156da4">modifiers_indexInObject</a>(ob, md) &gt;= index))
<a name="l01688"></a>01688             <span class="keywordflow">break</span>;
<a name="l01689"></a>01689 
<a name="l01690"></a>01690         <span class="keywordflow">if</span> (sculpt_mode &amp;&amp; md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435ae66e8d1df0f230926a6ec95cae4c7a8d">eModifierType_Multires</a>)
<a name="l01691"></a>01691             multires_applied = 1;
<a name="l01692"></a>01692     }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694     <span class="keywordflow">for</span> (md=firstmd; md; md=md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>)
<a name="l01695"></a>01695         <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a66c9f6dd851c4607005c4d0034ae2119">modifier_freeTemporaryData</a>(md);
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="comment">/* Yay, we are done. If we have a DerivedMesh and deformed vertices</span>
<a name="l01698"></a>01698 <span class="comment">     * need to apply these back onto the DerivedMesh. If we have no</span>
<a name="l01699"></a>01699 <span class="comment">     * DerivedMesh then we need to build one.</span>
<a name="l01700"></a>01700 <span class="comment">     */</span>
<a name="l01701"></a>01701     <span class="keywordflow">if</span> (dm &amp;&amp; deformedVerts) {
<a name="l01702"></a>01702         finaldm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l01703"></a>01703 
<a name="l01704"></a>01704         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(finaldm, deformedVerts);
<a name="l01707"></a>01707         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(finaldm);
<a name="l01708"></a>01708 
<a name="l01709"></a>01709 <span class="preprocessor">#if 0 </span><span class="comment">/* For later nice mod preview! */</span>
<a name="l01710"></a>01710         <span class="comment">/* In case we need modified weights in CD_PREVIEW_MCOL, we have to re-compute it. */</span>
<a name="l01711"></a>01711         <span class="keywordflow">if</span> (do_final_wmcol)
<a name="l01712"></a>01712             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(ob, finaldm, draw_flag, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01713"></a>01713 <span class="preprocessor">#endif</span>
<a name="l01714"></a>01714 <span class="preprocessor"></span>    }
<a name="l01715"></a>01715     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dm) {
<a name="l01716"></a>01716         finaldm = dm;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718 <span class="preprocessor">#if 0 </span><span class="comment">/* For later nice mod preview! */</span>
<a name="l01719"></a>01719         <span class="comment">/* In case we need modified weights in CD_PREVIEW_MCOL, we have to re-compute it. */</span>
<a name="l01720"></a>01720         <span class="keywordflow">if</span> (do_final_wmcol)
<a name="l01721"></a>01721             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(ob, finaldm, draw_flag, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01722"></a>01722 <span class="preprocessor">#endif</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span>    }
<a name="l01724"></a>01724     <span class="keywordflow">else</span> {
<a name="l01725"></a>01725         <span class="keywordtype">int</span> recalc_normals= 0;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727         finaldm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(me, ob);
<a name="l01728"></a>01728         
<a name="l01729"></a>01729         <span class="keywordflow">if</span> (build_shapekey_layers) {
<a name="l01730"></a>01730             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a77ef045e35e4a8bb1b87886610052eda">add_shapekey_layers</a>(finaldm, me, ob);
<a name="l01731"></a>01731             recalc_normals= 1;
<a name="l01732"></a>01732         }
<a name="l01733"></a>01733         
<a name="l01734"></a>01734         <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01735"></a>01735             <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(finaldm, deformedVerts);
<a name="l01736"></a>01736             recalc_normals= 1;
<a name="l01737"></a>01737         }
<a name="l01738"></a>01738 
<a name="l01739"></a>01739         <span class="keywordflow">if</span> (recalc_normals) {
<a name="l01740"></a>01740             <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(finaldm);
<a name="l01741"></a>01741         }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         <span class="comment">/* In this case, we should never have weight-modifying modifiers in stack... */</span>
<a name="l01744"></a>01744         <span class="keywordflow">if</span> (do_init_wmcol)
<a name="l01745"></a>01745             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad2301d7a5206df1fe10774f0433bbc92">DM_update_weight_mcol</a>(ob, finaldm, draw_flag, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="comment">/* add an orco layer if needed */</span>
<a name="l01749"></a>01749     <span class="keywordflow">if</span> (dataMask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>) {
<a name="l01750"></a>01750         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, finaldm, orcodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752         <span class="keywordflow">if</span> (deform_r &amp;&amp; *deform_r)
<a name="l01753"></a>01753             <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *deform_r, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01754"></a>01754     }
<a name="l01755"></a>01755 
<a name="l01756"></a>01756     {
<a name="l01757"></a>01757         <span class="comment">/* calculating normals can re-calculate tessfaces in some cases */</span>
<a name="l01758"></a>01758 <span class="preprocessor">#if 0</span>
<a name="l01759"></a>01759 <span class="preprocessor"></span>        <span class="keywordtype">int</span> num_tessface = finaldm-&gt;getNumTessFaces(finaldm);
<a name="l01760"></a>01760 <span class="preprocessor">#endif</span>
<a name="l01761"></a>01761 <span class="preprocessor"></span>        <span class="comment">/* --------------------------------------------------------------------- */</span>
<a name="l01762"></a>01762         <span class="comment">/* First calculate the polygon and vertex normals, re-tessellation</span>
<a name="l01763"></a>01763 <span class="comment">         * copies these into the tessface&#39;s normal layer */</span>
<a name="l01764"></a>01764 
<a name="l01765"></a>01765 
<a name="l01766"></a>01766         <span class="comment">/* comment because this causes a bug when deform is applied after a</span>
<a name="l01767"></a>01767 <span class="comment">         * bug when applied after a subsurf modifier (SubSurf -&gt; Cast) for eg,</span>
<a name="l01768"></a>01768 <span class="comment">         * it also looks like this isn&#39;t even needed since code above recalc&#39;s</span>
<a name="l01769"></a>01769 <span class="comment">         * normals - campbell */</span>
<a name="l01770"></a>01770 <span class="preprocessor">#if 0</span>
<a name="l01771"></a>01771 <span class="preprocessor"></span>        finaldm-&gt;calcNormals(finaldm);
<a name="l01772"></a>01772 <span class="preprocessor">#endif</span>
<a name="l01773"></a>01773 <span class="preprocessor"></span>
<a name="l01774"></a>01774         <span class="comment">/* Re-tessellation is necessary to push render data (uvs, textures, colors)</span>
<a name="l01775"></a>01775 <span class="comment">         * from loops and polys onto the tessfaces. This may be currently be</span>
<a name="l01776"></a>01776 <span class="comment">         * redundant in cases where the render mode doesn&#39;t use these inputs, but</span>
<a name="l01777"></a>01777 <span class="comment">         * ideally eventually tessellation would happen on-demand, and this is one</span>
<a name="l01778"></a>01778 <span class="comment">         * of the primary places it would be needed. */</span>
<a name="l01779"></a>01779 <span class="preprocessor">#if 0</span>
<a name="l01780"></a>01780 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (num_tessface == 0 &amp;&amp; finaldm-&gt;getNumTessFaces(finaldm) == 0)
<a name="l01781"></a>01781 #<span class="keywordflow">else</span>
<a name="l01782"></a>01782         <span class="keywordflow">if</span> (finaldm-&gt;getNumTessFaces(finaldm) == 0) <span class="comment">/* || !CustomData_has_layer(&amp;finaldm-&gt;faceData, CD_POLYINDEX)) */</span>
<a name="l01783"></a>01783 #endif
<a name="l01784"></a>01784         {
<a name="l01785"></a>01785             finaldm-&gt;recalcTessellation(finaldm);
<a name="l01786"></a>01786         }
<a name="l01787"></a>01787         <span class="comment">/* Even if tessellation is not needed, some modifiers migh have modified CD layers</span>
<a name="l01788"></a>01788 <span class="comment">         * (like mloopcol or mloopuv), hence we have to update those. */</span>
<a name="l01789"></a>01789         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (finaldm-&gt;dirty &amp; <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>) {
<a name="l01790"></a>01790             <span class="comment">/* A tessellation already exists, it should always have a CD_POLYINDEX. */</span>
<a name="l01791"></a>01791             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;finaldm-&gt;faceData, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa372d7e079afb57b1c244af8b8906509">CD_POLYINDEX</a>));
<a name="l01792"></a>01792             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a36e06cb48015911210caafd7b9b1f5ca">DM_update_tessface_data</a>(finaldm);
<a name="l01793"></a>01793         }
<a name="l01794"></a>01794         <span class="comment">/* Need to watch this, it can cause issues, see bug [#29338]             */</span>
<a name="l01795"></a>01795         <span class="comment">/* take care with this block, we really need testing frameworks          */</span>
<a name="l01796"></a>01796         <span class="comment">/* --------------------------------------------------------------------- */</span>
<a name="l01797"></a>01797 
<a name="l01798"></a>01798         <span class="comment">/* without this, drawing ngon tri&#39;s faces will show ugly tessellated face</span>
<a name="l01799"></a>01799 <span class="comment">         * normals and will also have to calculate normals on the fly, try avoid</span>
<a name="l01800"></a>01800 <span class="comment">         * this where possible since calculating polygon normals isn&#39;t fast,</span>
<a name="l01801"></a>01801 <span class="comment">         * note that this isn&#39;t a problem for subsurf (only quads) or editmode</span>
<a name="l01802"></a>01802 <span class="comment">         * which deals with drawing differently.</span>
<a name="l01803"></a>01803 <span class="comment">         *</span>
<a name="l01804"></a>01804 <span class="comment">         * Never calc vertex normals because other code ensures these are up to date.</span>
<a name="l01805"></a>01805 <span class="comment">         */</span>
<a name="l01806"></a>01806         <span class="keywordflow">if</span> ((finaldm-&gt;type == <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>) &amp;&amp; (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;finaldm-&gt;faceData, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a28e89d54f6d2545bdce86f0511392f7e">CD_NORMAL</a>) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>)) {
<a name="l01807"></a>01807             <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#af9c8ef6d2cdfb8fcadf28b52b3aa4e82">CDDM_calc_normals_mapping_ex</a>(finaldm, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01808"></a>01808         }
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810 
<a name="l01811"></a>01811 <span class="preprocessor">#ifdef WITH_GAMEENGINE</span>
<a name="l01812"></a>01812 <span class="preprocessor"></span>    <span class="comment">/* NavMesh - this is a hack but saves having a NavMesh modifier */</span>
<a name="l01813"></a>01813     <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa98e0216a27ddd692f1ec329ce4a4db4">gameflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a3f9a77538b44c005c3225228453ef3a2">OB_NAVMESH</a>) &amp;&amp; (finaldm-&gt;type == <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>)) {
<a name="l01814"></a>01814         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tdm;
<a name="l01815"></a>01815         tdm= navmesh_dm_createNavMeshForVisualization(finaldm);
<a name="l01816"></a>01816         <span class="keywordflow">if</span> (finaldm != tdm) {
<a name="l01817"></a>01817             finaldm-&gt;release(finaldm);
<a name="l01818"></a>01818             finaldm= tdm;
<a name="l01819"></a>01819         }
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821 <span class="preprocessor">#endif </span><span class="comment">/* WITH_GAMEENGINE */</span>
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     *final_r = finaldm;
<a name="l01824"></a>01824 
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (orcodm)
<a name="l01826"></a>01826         orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(orcodm);
<a name="l01827"></a>01827     <span class="keywordflow">if</span> (clothorcodm)
<a name="l01828"></a>01828         clothorcodm-&gt;release(clothorcodm);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830     <span class="keywordflow">if</span> (deformedVerts &amp;&amp; deformedVerts != inputVertexCos)
<a name="l01831"></a>01831         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     <a class="code" href="../../df/d31/BLI__linklist_8h.html#a8c58644b0c8fa747ee6d0b1d02b89861">BLI_linklist_free</a>((<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a>*)datamasks, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a82d599a68a4f5855e25fa2a6f497a00f">01836</a> float (*<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8084b06dcfcf0a17b90955c3a821bc84">editbmesh_get_vertex_cos</a>(<a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">int</span> *numVerts_r))[3]
<a name="l01837"></a>01837 {
<a name="l01838"></a>01838     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, numVerts = *numVerts_r = em-&gt;bm-&gt;totvert;
<a name="l01839"></a>01839     float (*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>)[3];
<a name="l01840"></a>01840     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l01841"></a>01841     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843     <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*numVerts, <span class="stringliteral">&quot;vertexcos&quot;</span>);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845     eve = <a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#aba8c82365003c5fcbb34bbcb4e50f8f6" title="Iterator New.">BM_iter_new</a>(&amp;iter, em-&gt;<a class="code" href="../../de/d88/structBMIter.html#a1ec3227591418dc593f76ec4689d5b7d">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01846"></a>01846     <span class="keywordflow">for</span> (i=0; eve; eve=<a class="code" href="../../d5/d48/bmesh__iterators__inline_8h.html#a0fc839bb30650592541b47e20669a995" title="Iterator Step.">BM_iter_step</a>(&amp;iter), i++) {
<a name="l01847"></a>01847         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>[i], eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>);
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850     <span class="keywordflow">return</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>;
<a name="l01851"></a>01851 }
<a name="l01852"></a>01852 
<a name="l01853"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a71626e3e74f8316b0fc402c1838c3bb9">01853</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a10170a86b20d0070131ee85db9c1645a">editbmesh_modifier_is_enabled</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l01854"></a>01854 {
<a name="l01855"></a>01855     <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a>);
<a name="l01856"></a>01856     <span class="keywordtype">int</span> required_mode = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a> | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a9efe97c797f991a7bbbe3cfa81d08857">eModifierMode_Editmode</a>;
<a name="l01857"></a>01857 
<a name="l01858"></a>01858     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a8d1659c909e1b4185c2e6d0e12326b71">modifier_isEnabled</a>(scene, md, required_mode)) <span class="keywordflow">return</span> 0;
<a name="l01859"></a>01859     <span class="keywordflow">if</span> ((mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a6ab09ae52780d2c940000109012f1fe3">flags</a> &amp; <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a4c64dc2e6ccb9a3c602589c543ac0321ac5af09e5d1959bdec23fdab1478df24d">eModifierTypeFlag_RequiresOriginalData</a>) &amp;&amp; dm) {
<a name="l01860"></a>01860         <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#aa8f7ed8ac604b1d55b0b420634e91ea3">modifier_setError</a>(md, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="../../d6/d61/BLF__translation_8h.html#a7163975dd2031d6463da225baaf59bfb">TIP_</a>(<span class="stringliteral">&quot;Modifier requires original data, bad stack position.&quot;</span>));
<a name="l01861"></a>01861         <span class="keywordflow">return</span> 0;
<a name="l01862"></a>01862     }
<a name="l01863"></a>01863     
<a name="l01864"></a>01864     <span class="keywordflow">return</span> 1;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2325a773659df8d78a668e72ca84d241">01867</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2325a773659df8d78a668e72ca84d241">editbmesh_calc_modifiers</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> **cage_r,
<a name="l01868"></a>01868                                     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> **final_r,
<a name="l01869"></a>01869                                     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l01870"></a>01870 {
<a name="l01871"></a>01871     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l01872"></a>01872     float (*deformedVerts)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01873"></a>01873     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask;
<a name="l01874"></a>01874     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, *orcodm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01875"></a>01875     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, numVerts = 0, cageIndex = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a928cf2f36a386c9d2c704e5b5ffe3b04">modifiers_getCageIndex</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1);
<a name="l01876"></a>01876     <a class="code" href="../../dd/dfa/structCDMaskLink.html">CDMaskLink</a> *datamasks, *curr;
<a name="l01877"></a>01877     <span class="keywordtype">int</span> required_mode = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a> | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a9efe97c797f991a7bbbe3cfa81d08857">eModifierMode_Editmode</a>;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a2f0e48ce13f2da1a049132012ebc6efa">modifiers_clearErrors</a>(ob);
<a name="l01880"></a>01880 
<a name="l01881"></a>01881     <span class="keywordflow">if</span> (cage_r &amp;&amp; cageIndex == -1) {
<a name="l01882"></a>01882         *cage_r = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ab35d59b96567e3d01900f07b1a05271a">getEditDerivedBMesh</a>(em, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01883"></a>01883     }
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01886"></a>01886     md = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a136f15cde944e4b0c5d938d946d975c9">modifiers_getVirtualModifierList</a>(ob);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888     datamasks = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a1eabdd43f807b40d1ac15aece51c0704">modifiers_calcDataMasks</a>(scene, ob, md, dataMask, required_mode);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890     curr = datamasks;
<a name="l01891"></a>01891     <span class="keywordflow">for</span> (i = 0; md; i++, md = md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>, curr = curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#acd0dfda6340bd3a89dcaa565dd06861f">next</a>) {
<a name="l01892"></a>01892         <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> *<a class="code" href="../../d8/d43/MT__random_8cpp.html#a0893639c022032e006e5b13378f7b4b2">mti</a> = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a837a63cd144446bec663f3a02e0ad397">modifierType_getInfo</a>(md-&gt;type);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894         md-&gt;scene= scene;
<a name="l01895"></a>01895         
<a name="l01896"></a>01896         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a10170a86b20d0070131ee85db9c1645a">editbmesh_modifier_is_enabled</a>(scene, md, dm))
<a name="l01897"></a>01897             <span class="keywordflow">continue</span>;
<a name="l01898"></a>01898 
<a name="l01899"></a>01899         <span class="comment">/* add an orco layer if needed by this modifier */</span>
<a name="l01900"></a>01900         <span class="keywordflow">if</span> (dm &amp;&amp; mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a29ad86ddfc5c2aeb34f59ec4e3713aba">requiredDataMask</a>) {
<a name="l01901"></a>01901             mask = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a29ad86ddfc5c2aeb34f59ec4e3713aba">requiredDataMask</a>(ob, md);
<a name="l01902"></a>01902             <span class="keywordflow">if</span> (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>)
<a name="l01903"></a>01903                 <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, em, dm, orcodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01904"></a>01904         }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906         <span class="comment">/* How to apply modifier depends on (a) what we already have as</span>
<a name="l01907"></a>01907 <span class="comment">         * a result of previous modifiers (could be a DerivedMesh or just</span>
<a name="l01908"></a>01908 <span class="comment">         * deformed vertices) and (b) what type the modifier is.</span>
<a name="l01909"></a>01909 <span class="comment">         */</span>
<a name="l01910"></a>01910 
<a name="l01911"></a>01911         <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a7a7867ee9773d0b29fd0f4c9d3f390d0">type</a> == <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>) {
<a name="l01912"></a>01912             <span class="comment">/* No existing verts to deform, need to build them. */</span>
<a name="l01913"></a>01913             <span class="keywordflow">if</span> (!deformedVerts) {
<a name="l01914"></a>01914                 <span class="keywordflow">if</span> (dm) {
<a name="l01915"></a>01915                     <span class="comment">/* Deforming a derived mesh, read the vertex locations</span>
<a name="l01916"></a>01916 <span class="comment">                     * out of the mesh and deform them. Once done with this</span>
<a name="l01917"></a>01917 <span class="comment">                     * run of deformers verts will be written back.</span>
<a name="l01918"></a>01918 <span class="comment">                     */</span>
<a name="l01919"></a>01919                     numVerts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01920"></a>01920                     deformedVerts =
<a name="l01921"></a>01921                         <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(*deformedVerts) * numVerts, <span class="stringliteral">&quot;dfmv&quot;</span>);
<a name="l01922"></a>01922                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a22917d90ddbd83f1765f118d6f8e353f">getVertCos</a>(dm, deformedVerts);
<a name="l01923"></a>01923                 }
<a name="l01924"></a>01924                 <span class="keywordflow">else</span> {
<a name="l01925"></a>01925                     deformedVerts = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8084b06dcfcf0a17b90955c3a821bc84">editbmesh_get_vertex_cos</a>(em, &amp;numVerts);
<a name="l01926"></a>01926                 }
<a name="l01927"></a>01927             }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929             <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a05838e2730f3995451a5a005f7b66ce7">deformVertsEM</a>)
<a name="l01930"></a>01930                 mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a05838e2730f3995451a5a005f7b66ce7">deformVertsEM</a>(md, ob, em, dm, deformedVerts, numVerts);
<a name="l01931"></a>01931             <span class="keywordflow">else</span> mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a1c287b027a1c2b68d169ebb772c03c19">deformVerts</a>(md, ob, dm, deformedVerts, numVerts, 0, 0);
<a name="l01932"></a>01932         }
<a name="l01933"></a>01933         <span class="keywordflow">else</span> {
<a name="l01934"></a>01934             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *ndm;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936             <span class="comment">/* apply vertex coordinates or build a DerivedMesh as necessary */</span>
<a name="l01937"></a>01937             <span class="keywordflow">if</span> (dm) {
<a name="l01938"></a>01938                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01939"></a>01939                     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *tdm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l01940"></a>01940                     <span class="keywordflow">if</span> (!(cage_r &amp;&amp; dm == *cage_r)) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01941"></a>01941                     dm = tdm;
<a name="l01942"></a>01942 
<a name="l01943"></a>01943                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, deformedVerts);
<a name="l01944"></a>01944                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l01945"></a>01945                 }
<a name="l01946"></a>01946                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cage_r &amp;&amp; dm == *cage_r) {
<a name="l01947"></a>01947                     <span class="comment">/* dm may be changed by this modifier, so we need to copy it</span>
<a name="l01948"></a>01948 <span class="comment">                     */</span>
<a name="l01949"></a>01949                     dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l01950"></a>01950                 }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952             }
<a name="l01953"></a>01953             <span class="keywordflow">else</span> {
<a name="l01954"></a>01954                 dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a76ccb905297ec18a26c8187f551a7e34">CDDM_from_BMEditMesh</a>(em, ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01955"></a>01955 
<a name="l01956"></a>01956                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l01957"></a>01957                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(dm, deformedVerts);
<a name="l01958"></a>01958                     <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(dm);
<a name="l01959"></a>01959                 }
<a name="l01960"></a>01960             }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962             <span class="comment">/* create an orco derivedmesh in parallel */</span>
<a name="l01963"></a>01963             mask= curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#a91272532243d51751842e81cc63eae7c">mask</a>;
<a name="l01964"></a>01964             <span class="keywordflow">if</span> (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>) {
<a name="l01965"></a>01965                 <span class="keywordflow">if</span> (!orcodm)
<a name="l01966"></a>01966                     orcodm= <a class="code" href="../../db/d40/DerivedMesh_8c.html#a407ac650392ca386d236bcd29cfbaa77">create_orco_dm</a>(ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, em, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                 mask &amp;= ~CD_MASK_ORCO;
<a name="l01969"></a>01969                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(orcodm, mask | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a352c6860702ca1aeea5767d7c6368147">CD_MASK_ORIGINDEX</a>);
<a name="l01970"></a>01970 
<a name="l01971"></a>01971                 <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#afbf8cb875df3ba9f766f988c79f1704b">applyModifierEM</a>)
<a name="l01972"></a>01972                     ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#afbf8cb875df3ba9f766f988c79f1704b">applyModifierEM</a>(md, ob, em, orcodm);
<a name="l01973"></a>01973                 <span class="keywordflow">else</span>
<a name="l01974"></a>01974                     ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, orcodm, 0, 0);
<a name="l01975"></a>01975 
<a name="l01976"></a>01976                 <span class="keywordflow">if</span> (ndm) {
<a name="l01977"></a>01977                     <span class="comment">/* if the modifier returned a new dm, release the old one */</span>
<a name="l01978"></a>01978                     <span class="keywordflow">if</span> (orcodm &amp;&amp; orcodm != ndm) orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(orcodm);
<a name="l01979"></a>01979                     orcodm = ndm;
<a name="l01980"></a>01980                 }
<a name="l01981"></a>01981             }
<a name="l01982"></a>01982 
<a name="l01983"></a>01983             <span class="comment">/* set the DerivedMesh to only copy needed data */</span>
<a name="l01984"></a>01984             mask= curr-&gt;<a class="code" href="../../dd/dfa/structCDMaskLink.html#a91272532243d51751842e81cc63eae7c">mask</a>; <span class="comment">/* CD_MASK_ORCO may have been cleared above */</span>
<a name="l01985"></a>01985 
<a name="l01986"></a>01986             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac99330c3a2409a10111f1c0d9aef3080">DM_set_only_copy</a>(dm, mask | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a352c6860702ca1aeea5767d7c6368147">CD_MASK_ORIGINDEX</a>);
<a name="l01987"></a>01987 
<a name="l01988"></a>01988             <span class="keywordflow">if</span> (mask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a907a9b3b81f32261dc9f4d40fba94b3e">CD_MASK_ORIGSPACE_MLOOP</a>) {
<a name="l01989"></a>01989                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>)) {
<a name="l01990"></a>01990                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0375950f9607f964fc5a2761e2ed44d3">DM_add_loop_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01991"></a>01991                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af0153c5b305453f044f1101e646f232b">DM_init_origspace</a>(dm);
<a name="l01992"></a>01992                 }
<a name="l01993"></a>01993             }
<a name="l01994"></a>01994             
<a name="l01995"></a>01995             <span class="keywordflow">if</span> (mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#afbf8cb875df3ba9f766f988c79f1704b">applyModifierEM</a>)
<a name="l01996"></a>01996                 ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#afbf8cb875df3ba9f766f988c79f1704b">applyModifierEM</a>(md, ob, em, dm);
<a name="l01997"></a>01997             <span class="keywordflow">else</span>
<a name="l01998"></a>01998                 ndm = mti-&gt;<a class="code" href="../../db/dc5/structModifierTypeInfo.html#a3b7f1e21e70923ff5900fa5c54bc99ba">applyModifier</a>(md, ob, dm, 0, 0);
<a name="l01999"></a>01999 
<a name="l02000"></a>02000             <span class="keywordflow">if</span> (ndm) {
<a name="l02001"></a>02001                 <span class="keywordflow">if</span> (dm &amp;&amp; dm != ndm)
<a name="l02002"></a>02002                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004                 dm = ndm;
<a name="l02005"></a>02005 
<a name="l02006"></a>02006                 <span class="keywordflow">if</span> (deformedVerts) {
<a name="l02007"></a>02007                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l02008"></a>02008                     deformedVerts = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02009"></a>02009                 }
<a name="l02010"></a>02010             }
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012 
<a name="l02013"></a>02013         <span class="keywordflow">if</span> (cage_r &amp;&amp; i == cageIndex) {
<a name="l02014"></a>02014             <span class="keywordflow">if</span> (dm &amp;&amp; deformedVerts) {
<a name="l02015"></a>02015                 *cage_r = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l02016"></a>02016                 <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(*cage_r, deformedVerts);
<a name="l02017"></a>02017             }
<a name="l02018"></a>02018             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dm) {
<a name="l02019"></a>02019                 *cage_r = dm;
<a name="l02020"></a>02020             }
<a name="l02021"></a>02021             <span class="keywordflow">else</span> {
<a name="l02022"></a>02022                 *cage_r =
<a name="l02023"></a>02023                     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ab35d59b96567e3d01900f07b1a05271a">getEditDerivedBMesh</a>(em, ob,
<a name="l02024"></a>02024                         deformedVerts ? <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(deformedVerts) : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02025"></a>02025             }
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027     }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     <a class="code" href="../../df/d31/BLI__linklist_8h.html#a8c58644b0c8fa747ee6d0b1d02b89861">BLI_linklist_free</a>((<a class="code" href="../../d7/deb/structLinkNode.html">LinkNode</a>*)datamasks, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02030"></a>02030 
<a name="l02031"></a>02031     <span class="comment">/* Yay, we are done. If we have a DerivedMesh and deformed vertices need</span>
<a name="l02032"></a>02032 <span class="comment">     * to apply these back onto the DerivedMesh. If we have no DerivedMesh</span>
<a name="l02033"></a>02033 <span class="comment">     * then we need to build one.</span>
<a name="l02034"></a>02034 <span class="comment">     */</span>
<a name="l02035"></a>02035     <span class="keywordflow">if</span> (dm &amp;&amp; deformedVerts) {
<a name="l02036"></a>02036         *final_r = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l02037"></a>02037 
<a name="l02038"></a>02038         <span class="keywordflow">if</span> (!(cage_r &amp;&amp; dm == *cage_r)) dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#aca825d304a82c5e0c12e664c64fa831d">CDDM_apply_vert_coords</a>(*final_r, deformedVerts);
<a name="l02041"></a>02041         <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a231267779e27c6615eea7aa3bd40b036">CDDM_calc_normals</a>(*final_r); <span class="comment">/* was CDDM_calc_normals_mapping - campbell */</span>
<a name="l02042"></a>02042     }
<a name="l02043"></a>02043     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dm) {
<a name="l02044"></a>02044         *final_r = dm;
<a name="l02045"></a>02045         (*final_r)-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4ce764128d07bada75eba3176731fb4c">calcNormals</a>(*final_r); <span class="comment">/* BMESH_ONLY - BMESH_TODO. check if this is needed */</span>
<a name="l02046"></a>02046     }
<a name="l02047"></a>02047     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!deformedVerts &amp;&amp; cage_r &amp;&amp; *cage_r) {
<a name="l02048"></a>02048         <span class="comment">/* cage should already have up to date normals */</span>
<a name="l02049"></a>02049         *final_r = *cage_r;
<a name="l02050"></a>02050         (*final_r)-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4ce764128d07bada75eba3176731fb4c">calcNormals</a>(*final_r); <span class="comment">/* BMESH_ONLY - BMESH_TODO. check if this is needed */</span>
<a name="l02051"></a>02051     }
<a name="l02052"></a>02052     <span class="keywordflow">else</span> {
<a name="l02053"></a>02053         <span class="comment">/* this is just a copy of the editmesh, no need to calc normals */</span>
<a name="l02054"></a>02054         *final_r = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ab35d59b96567e3d01900f07b1a05271a">getEditDerivedBMesh</a>(em, ob, deformedVerts);
<a name="l02055"></a>02055         deformedVerts = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02056"></a>02056     }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058     <span class="comment">/* --- */</span>
<a name="l02059"></a>02059     <span class="comment">/* BMESH_ONLY, ensure tessface&#39;s used for drawing,</span>
<a name="l02060"></a>02060 <span class="comment">     * but don&#39;t recalculate if the last modifier in the stack gives us tessfaces</span>
<a name="l02061"></a>02061 <span class="comment">     * check if the derived meshes are DM_TYPE_EDITBMESH before calling, this isn&#39;t essential</span>
<a name="l02062"></a>02062 <span class="comment">     * but quiets annoying error messages since tessfaces wont be created. */</span>
<a name="l02063"></a>02063     <span class="keywordflow">if</span> ((*final_r)-&gt;type != <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefa6ab3966d014cf244418874be6a8a503a">DM_TYPE_EDITBMESH</a>) {
<a name="l02064"></a>02064         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(*final_r);
<a name="l02065"></a>02065     }
<a name="l02066"></a>02066     <span class="keywordflow">if</span> (cage_r) {
<a name="l02067"></a>02067         <span class="keywordflow">if</span> ((*cage_r)-&gt;type != <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefa6ab3966d014cf244418874be6a8a503a">DM_TYPE_EDITBMESH</a>) {
<a name="l02068"></a>02068             <span class="keywordflow">if</span> (*cage_r != *final_r) {
<a name="l02069"></a>02069                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(*cage_r);
<a name="l02070"></a>02070             }
<a name="l02071"></a>02071         }
<a name="l02072"></a>02072     }
<a name="l02073"></a>02073     <span class="comment">/* --- */</span>
<a name="l02074"></a>02074 
<a name="l02075"></a>02075     <span class="comment">/* add an orco layer if needed */</span>
<a name="l02076"></a>02076     <span class="keywordflow">if</span> (dataMask &amp; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>)
<a name="l02077"></a>02077         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2c2c0f3e20c89c098137fc9058f58163">add_orco_dm</a>(ob, em, *final_r, orcodm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l02078"></a>02078 
<a name="l02079"></a>02079     <span class="keywordflow">if</span> (orcodm)
<a name="l02080"></a>02080         orcodm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(orcodm);
<a name="l02081"></a>02081 
<a name="l02082"></a>02082     <span class="keywordflow">if</span> (deformedVerts)
<a name="l02083"></a>02083         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(deformedVerts);
<a name="l02084"></a>02084 }
<a name="l02085"></a>02085 
<a name="l02086"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a1625f4efd2c61331003b2fa5b839e498">02086</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1625f4efd2c61331003b2fa5b839e498">clear_mesh_caches</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02087"></a>02087 {
<a name="l02088"></a>02088     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02089"></a>02089 
<a name="l02090"></a>02090         <span class="comment">/* also serves as signal to remake texspace */</span>
<a name="l02091"></a>02091     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>) {
<a name="l02092"></a>02092         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>);
<a name="l02093"></a>02093         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02094"></a>02094     }
<a name="l02095"></a>02095     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a71b32c841e28c59ad02129f2a0e72648">bb</a>) {
<a name="l02096"></a>02096         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a71b32c841e28c59ad02129f2a0e72648">bb</a>);
<a name="l02097"></a>02097         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a71b32c841e28c59ad02129f2a0e72648">bb</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02098"></a>02098     }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100     <a class="code" href="../../d9/d12/BKE__displist_8h.html#a561c3ea04fd61b48f782bfea0aae53ad">freedisplist</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a45d11e4826c3a8ba292c91691bb2885d">disp</a>);
<a name="l02101"></a>02101 
<a name="l02102"></a>02102     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>) {
<a name="l02103"></a>02103         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l02104"></a>02104         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>);
<a name="l02105"></a>02105         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02106"></a>02106     }
<a name="l02107"></a>02107     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>) {
<a name="l02108"></a>02108         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l02109"></a>02109         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>);
<a name="l02110"></a>02110         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02111"></a>02111     }
<a name="l02112"></a>02112 
<a name="l02113"></a>02113     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>) {
<a name="l02114"></a>02114         <a class="code" href="../../df/dac/BKE__object_8h.html#a6250ba98a1ba290ae6c0545ac87f6698">object_sculpt_modifiers_changed</a>(ob);
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116 }
<a name="l02117"></a>02117 
<a name="l02118"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a6233e6a8e8a995389dfdbefaf9f1ba45">02118</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6233e6a8e8a995389dfdbefaf9f1ba45">mesh_build_data</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask,
<a name="l02119"></a>02119                             <span class="keywordtype">int</span> build_shapekey_layers)
<a name="l02120"></a>02120 {
<a name="l02121"></a>02121     <a class="code" href="../../de/de7/structObject.html">Object</a> *obact = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>?scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>:<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02122"></a>02122     <span class="keywordtype">int</span> editing = <a class="code" href="../../d8/d86/BKE__paint_8h.html#a56fc7a16c6dcfa3dd82680c86385e45f">paint_facesel_test</a>(ob);
<a name="l02123"></a>02123     <span class="comment">/* weight paint and face select need original indices because of selection buffer drawing */</span>
<a name="l02124"></a>02124     <span class="keywordtype">int</span> needMapping = (ob==obact) &amp;&amp; (editing || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; (<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>|<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>)));
<a name="l02125"></a>02125 
<a name="l02126"></a>02126     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1625f4efd2c61331003b2fa5b839e498">clear_mesh_caches</a>(ob);
<a name="l02127"></a>02127 
<a name="l02128"></a>02128     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>,
<a name="l02129"></a>02129                         &amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>, 0, 1,
<a name="l02130"></a>02130                         needMapping, dataMask, -1, 1, build_shapekey_layers);
<a name="l02131"></a>02131 
<a name="l02132"></a>02132     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a7140dcf7215b75e8e49d8f166a0ef7f7">DM_set_object_boundbox</a> (ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>);
<a name="l02133"></a>02133 
<a name="l02134"></a>02134     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 0;
<a name="l02135"></a>02135     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 0;
<a name="l02136"></a>02136     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a370b76f3864a06bc43f149a073e49cfe">lastDataMask</a> = dataMask;
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a7b8620799f1bc866a5dc5ecaacf987a7">OB_MODE_SCULPT</a>) &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>) {
<a name="l02139"></a>02139         <span class="comment">/* create PBVH immediately (would be created on the fly too,</span>
<a name="l02140"></a>02140 <span class="comment">         * but this avoids waiting on first stroke) */</span>
<a name="l02141"></a>02141         ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ace18d1ecfbf1d633e0150bbf4c4c84b9">getPBVH</a>(ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>);
<a name="l02142"></a>02142     }
<a name="l02143"></a>02143 }
<a name="l02144"></a>02144 
<a name="l02145"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a04004c082eb0fd2ab0feefcb4117c64e">02145</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a04004c082eb0fd2ab0feefcb4117c64e">editbmesh_build_data</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02146"></a>02146 {
<a name="l02147"></a>02147     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a1625f4efd2c61331003b2fa5b839e498">clear_mesh_caches</a>(obedit);
<a name="l02148"></a>02148 
<a name="l02149"></a>02149     <span class="keywordflow">if</span> (em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>) {
<a name="l02150"></a>02150         <span class="keywordflow">if</span> (em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>!=em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>) {
<a name="l02151"></a>02151             em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l02152"></a>02152             em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>);
<a name="l02153"></a>02153         }
<a name="l02154"></a>02154         em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156     <span class="keywordflow">if</span> (em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>) {
<a name="l02157"></a>02157         em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l02158"></a>02158         em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>);
<a name="l02159"></a>02159         em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02160"></a>02160     }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2325a773659df8d78a668e72ca84d241">editbmesh_calc_modifiers</a>(scene, obedit, em, &amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>, &amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>, dataMask);
<a name="l02163"></a>02163     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a7140dcf7215b75e8e49d8f166a0ef7f7">DM_set_object_boundbox</a> (obedit, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a9fe74f9668be51bdab83dfdaea003303">lastDataMask</a> = dataMask;
<a name="l02166"></a>02166     em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 0;
<a name="l02167"></a>02167     em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 0;
<a name="l02168"></a>02168 }
<a name="l02169"></a>02169 
<a name="l02170"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#acf8ab61167975a39b991a2a10f9d7eda">02170</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ae5f8948de8154f33137ad68f4446d193">makeDerivedMesh</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em,
<a name="l02171"></a>02171                      <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask, <span class="keywordtype">int</span> build_shapekey_layers)
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173     <span class="keywordflow">if</span> (em) {
<a name="l02174"></a>02174         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a04004c082eb0fd2ab0feefcb4117c64e">editbmesh_build_data</a>(scene, ob, em, dataMask);
<a name="l02175"></a>02175     }
<a name="l02176"></a>02176     <span class="keywordflow">else</span> {
<a name="l02177"></a>02177         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6233e6a8e8a995389dfdbefaf9f1ba45">mesh_build_data</a>(scene, ob, dataMask, build_shapekey_layers);
<a name="l02178"></a>02178     }
<a name="l02179"></a>02179 }
<a name="l02180"></a>02180 
<a name="l02181"></a>02181 <span class="comment">/***/</span>
<a name="l02182"></a>02182 
<a name="l02183"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2ad833ff37894f410c2ff0ee22774d43">02183</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02184"></a>02184 {
<a name="l02185"></a>02185     <span class="comment">/* if there&#39;s no derived mesh or the last data mask used doesn&#39;t include</span>
<a name="l02186"></a>02186 <span class="comment">     * the data we need, rebuild the derived mesh</span>
<a name="l02187"></a>02187 <span class="comment">     */</span>
<a name="l02188"></a>02188     <span class="keywordflow">if</span> (!ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a> || (dataMask &amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a370b76f3864a06bc43f149a073e49cfe">lastDataMask</a>) != dataMask)
<a name="l02189"></a>02189         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6233e6a8e8a995389dfdbefaf9f1ba45">mesh_build_data</a>(scene, ob, dataMask, 0);
<a name="l02190"></a>02190 
<a name="l02191"></a>02191     <span class="keywordflow">return</span> ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a7d026333c809ef062c77eacf9c63f418">02194</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0cb599f3f397fcb5f99b02677bf3b0ec">mesh_get_derived_deform</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02195"></a>02195 {
<a name="l02196"></a>02196     <span class="comment">/* if there&#39;s no derived mesh or the last data mask used doesn&#39;t include</span>
<a name="l02197"></a>02197 <span class="comment">     * the data we need, rebuild the derived mesh</span>
<a name="l02198"></a>02198 <span class="comment">     */</span>
<a name="l02199"></a>02199     <span class="keywordflow">if</span> (!ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a> || (dataMask &amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a370b76f3864a06bc43f149a073e49cfe">lastDataMask</a>) != dataMask)
<a name="l02200"></a>02200         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6233e6a8e8a995389dfdbefaf9f1ba45">mesh_build_data</a>(scene, ob, dataMask, 0);
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     <span class="keywordflow">return</span> ob-&gt;<a class="code" href="../../de/de7/structObject.html#a75bea6e258885840c46b755cec75f7d0">derivedDeform</a>;
<a name="l02203"></a>02203 }
<a name="l02204"></a>02204 
<a name="l02205"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a893e2f74e35366da6187feb2c4cfabbf">02205</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aeade9a199706a910fa3a5593b49cdbdf">mesh_create_derived_render</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02206"></a>02206 {
<a name="l02207"></a>02207     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02208"></a>02208     
<a name="l02209"></a>02209     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 1, 1, 0, dataMask, -1, 0, 0);
<a name="l02210"></a>02210 
<a name="l02211"></a>02211     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02212"></a>02212 }
<a name="l02213"></a>02213 
<a name="l02214"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a0eb555d5e44ae49a584faf7b1f04e18d">02214</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aed0d40495a5611c544ff2ebab9433434">mesh_create_derived_index_render</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask, <span class="keywordtype">int</span> index)
<a name="l02215"></a>02215 {
<a name="l02216"></a>02216     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02217"></a>02217     
<a name="l02218"></a>02218     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 1, 1, 0, dataMask, index, 0, 0);
<a name="l02219"></a>02219 
<a name="l02220"></a>02220     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02223"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a453197dd8f354f3daf892a250cd0ef30">02223</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a99116f90bfa6f5bd4a42c80bfe3db469">mesh_create_derived_view</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02224"></a>02224 {
<a name="l02225"></a>02225     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02226"></a>02226 
<a name="l02227"></a>02227     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 0, 1, 0, dataMask, -1, 0, 0);
<a name="l02228"></a>02228 
<a name="l02229"></a>02229     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02230"></a>02230 }
<a name="l02231"></a>02231 
<a name="l02232"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad76a7f69217f4b8645c34a2e2b2deebf">02232</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1becf00e42dabc8360b487414142b0ae">mesh_create_derived_no_deform</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertCos)[3],
<a name="l02233"></a>02233                                            <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02234"></a>02234 {
<a name="l02235"></a>02235     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02236"></a>02236     
<a name="l02237"></a>02237     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, vertCos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 0, 0, 0, dataMask, -1, 0, 0);
<a name="l02238"></a>02238 
<a name="l02239"></a>02239     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02240"></a>02240 }
<a name="l02241"></a>02241 
<a name="l02242"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aaeeda2b9696d09cfc3c5bea1a4a60d8b">02242</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afce5fe11731f0e902d410685bfe57677">mesh_create_derived_no_virtual</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertCos)[3],
<a name="l02243"></a>02243                                             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02244"></a>02244 {
<a name="l02245"></a>02245     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02246"></a>02246     
<a name="l02247"></a>02247     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, vertCos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 0, -1, 0, dataMask, -1, 0, 0);
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02250"></a>02250 }
<a name="l02251"></a>02251 
<a name="l02252"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#adabe858db1518e4fbbdfdbfaa2593116">02252</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a3ace126068660c18a74dde520fbb837d">mesh_create_derived_physics</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> (*vertCos)[3],
<a name="l02253"></a>02253                                             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02254"></a>02254 {
<a name="l02255"></a>02255     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02256"></a>02256     
<a name="l02257"></a>02257     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, vertCos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 0, -1, 1, dataMask, -1, 0, 0);
<a name="l02258"></a>02258 
<a name="l02259"></a>02259     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02260"></a>02260 }
<a name="l02261"></a>02261 
<a name="l02262"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#afe6f9d0135cc5d4932ea9b0a34e1a12d">02262</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6139118964aebb50ca9d512d9bdc0a59">mesh_create_derived_no_deform_render</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,
<a name="l02263"></a>02263                                                   <span class="keywordtype">float</span> (*vertCos)[3],
<a name="l02264"></a>02264                                                   <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02265"></a>02265 {
<a name="l02266"></a>02266     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<span class="keyword">final</span>;
<a name="l02267"></a>02267 
<a name="l02268"></a>02268     <a class="code" href="../../db/d40/DerivedMesh_8c.html#a2b804b4f280824e9236bc88aef0f4663">mesh_calc_modifiers</a>(scene, ob, vertCos, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keyword">final</span>, 1, 0, 0, dataMask, -1, 0, 0);
<a name="l02269"></a>02269 
<a name="l02270"></a>02270     <span class="keywordflow">return</span> <span class="keyword">final</span>;
<a name="l02271"></a>02271 }
<a name="l02272"></a>02272 
<a name="l02273"></a>02273 <span class="comment">/***/</span>
<a name="l02274"></a>02274 
<a name="l02275"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#aae676b01c4d8919e1cb12cdf30db23f7">02275</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6173b8466ecd4cd5c46176550ff7867c">editbmesh_get_derived_cage_and_final</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> **final_r,
<a name="l02276"></a>02276                                                  <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02277"></a>02277 {
<a name="l02278"></a>02278     <span class="comment">/* if there&#39;s no derived mesh or the last data mask used doesn&#39;t include</span>
<a name="l02279"></a>02279 <span class="comment">     * the data we need, rebuild the derived mesh</span>
<a name="l02280"></a>02280 <span class="comment">     */</span>
<a name="l02281"></a>02281     <span class="keywordflow">if</span> (!em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a> ||
<a name="l02282"></a>02282        (em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a9fe74f9668be51bdab83dfdaea003303">lastDataMask</a> &amp; dataMask) != dataMask)
<a name="l02283"></a>02283         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a04004c082eb0fd2ab0feefcb4117c64e">editbmesh_build_data</a>(scene, obedit, em, dataMask);
<a name="l02284"></a>02284 
<a name="l02285"></a>02285     *final_r = em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a1e29091bf70bbf487416ed9aff2a1072">derivedFinal</a>;
<a name="l02286"></a>02286     <span class="keywordflow">return</span> em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>;
<a name="l02287"></a>02287 }
<a name="l02288"></a>02288 
<a name="l02289"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a71be52e0a4dd26c88d17762e89246504">02289</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aadc7033561fddea210085209cea4dfa1">editbmesh_get_derived_cage</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask)
<a name="l02290"></a>02290 {
<a name="l02291"></a>02291     <span class="comment">/* if there&#39;s no derived mesh or the last data mask used doesn&#39;t include</span>
<a name="l02292"></a>02292 <span class="comment">     * the data we need, rebuild the derived mesh</span>
<a name="l02293"></a>02293 <span class="comment">     */</span>
<a name="l02294"></a>02294     <span class="keywordflow">if</span> (!em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a> ||
<a name="l02295"></a>02295        (em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a9fe74f9668be51bdab83dfdaea003303">lastDataMask</a> &amp; dataMask) != dataMask)
<a name="l02296"></a>02296         <a class="code" href="../../db/d40/DerivedMesh_8c.html#a04004c082eb0fd2ab0feefcb4117c64e">editbmesh_build_data</a>(scene, obedit, em, dataMask);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298     <span class="keywordflow">return</span> em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a70f4254c9e74e01ae7579dac46585245">derivedCage</a>;
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 
<a name="l02301"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a9ae684821f19e43a690247a55321068e">02301</a> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ad219e8b9311146ba070bcd1e98622a1d">editbmesh_get_derived_base</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *obedit, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em)
<a name="l02302"></a>02302 {
<a name="l02303"></a>02303     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ab35d59b96567e3d01900f07b1a05271a">getEditDerivedBMesh</a>(em, obedit, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02304"></a>02304 }
<a name="l02305"></a>02305 
<a name="l02306"></a>02306 
<a name="l02307"></a>02307 <span class="comment">/* ********* For those who don&#39;t grasp derived stuff! (ton) :) *************** */</span>
<a name="l02308"></a>02308 
<a name="l02309"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a636452e96da4a26a1f2759b22139e43d">02309</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a636452e96da4a26a1f2759b22139e43d">make_vertexcosnos__mapFunc</a>(<span class="keywordtype">void</span> *userData, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3],
<a name="l02310"></a>02310                                        <span class="keyword">const</span> <span class="keywordtype">float</span> no_f[3], <span class="keyword">const</span> <span class="keywordtype">short</span> no_s[3])
<a name="l02311"></a>02311 {
<a name="l02312"></a>02312     <span class="keywordtype">float</span> *vec = userData;
<a name="l02313"></a>02313     
<a name="l02314"></a>02314     vec+= 6*index;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316     <span class="comment">/* check if we&#39;ve been here before (normal should not be 0) */</span>
<a name="l02317"></a>02317     <span class="keywordflow">if</span> (vec[3] || vec[4] || vec[5]) <span class="keywordflow">return</span>;
<a name="l02318"></a>02318 
<a name="l02319"></a>02319     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, co);
<a name="l02320"></a>02320     vec+= 3;
<a name="l02321"></a>02321     <span class="keywordflow">if</span> (no_f) {
<a name="l02322"></a>02322         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, no_f);
<a name="l02323"></a>02323     }
<a name="l02324"></a>02324     <span class="keywordflow">else</span> {
<a name="l02325"></a>02325         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(vec, no_s);
<a name="l02326"></a>02326     }
<a name="l02327"></a>02327 }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329 <span class="comment">/* always returns original amount me-&gt;totvert of vertices and normals, but fully deformed and subsurfered */</span>
<a name="l02330"></a>02330 <span class="comment">/* this is needed for all code using vertexgroups (no subsurf support) */</span>
<a name="l02331"></a>02331 <span class="comment">/* it stores the normals as floats, but they can still be scaled as shorts (32767 = unit) */</span>
<a name="l02332"></a>02332 <span class="comment">/* in use now by vertex/weight paint and particle generating */</span>
<a name="l02333"></a>02333 
<a name="l02334"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a27231d83c08b86f8592666a7c8593d28">02334</a> <span class="keywordtype">float</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1793a322a76b3b50ddd2c09742c5366f">mesh_get_mapped_verts_nors</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02335"></a>02335 {
<a name="l02336"></a>02336     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02337"></a>02337     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm;
<a name="l02338"></a>02338     <span class="keywordtype">float</span> *vertexcosnos;
<a name="l02339"></a>02339     
<a name="l02340"></a>02340     <span class="comment">/* lets prevent crashing... */</span>
<a name="l02341"></a>02341     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a> || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>==0)
<a name="l02342"></a>02342         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02343"></a>02343     
<a name="l02344"></a>02344     dm= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, ob, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>|<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a352c6860702ca1aeea5767d7c6368147">CD_MASK_ORIGINDEX</a>);
<a name="l02345"></a>02345     vertexcosnos= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(6*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;vertexcosnos map&quot;</span>);
<a name="l02346"></a>02346     
<a name="l02347"></a>02347     <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a14c8a2dc23a8af0e7aaf2190f7cf0202">foreachMappedVert</a>) {
<a name="l02348"></a>02348         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a14c8a2dc23a8af0e7aaf2190f7cf0202">foreachMappedVert</a>(dm, <a class="code" href="../../db/d40/DerivedMesh_8c.html#a636452e96da4a26a1f2759b22139e43d">make_vertexcosnos__mapFunc</a>, vertexcosnos);
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350     <span class="keywordflow">else</span> {
<a name="l02351"></a>02351         <span class="keywordtype">float</span> *fp= vertexcosnos;
<a name="l02352"></a>02352         <span class="keywordtype">int</span> a;
<a name="l02353"></a>02353         
<a name="l02354"></a>02354         <span class="keywordflow">for</span> (a=0; a&lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, fp+=6) {
<a name="l02355"></a>02355             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, a, fp);
<a name="l02356"></a>02356             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a35d607166e97c1c1b6dc29fd36b6ee3c">getVertNo</a>(dm, a, fp+3);
<a name="l02357"></a>02357         }
<a name="l02358"></a>02358     }
<a name="l02359"></a>02359     
<a name="l02360"></a>02360     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02361"></a>02361     <span class="keywordflow">return</span> vertexcosnos;
<a name="l02362"></a>02362 }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364 <span class="comment">/* ******************* GLSL ******************** */</span>
<a name="l02365"></a>02365 
<a name="l02366"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">02366</a> <span class="keyword">typedef</span> <span class="keyword">struct</span>
<a name="l02367"></a>02367 {
<a name="l02368"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#aba422c11613d50503660a4090e06bd1e">02368</a>     <span class="keywordtype">float</span> * <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#aba422c11613d50503660a4090e06bd1e">precomputedFaceNormals</a>;
<a name="l02369"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a59716ad54f273d80b65b92cd04a2ccf2">02369</a>     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> * <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a59716ad54f273d80b65b92cd04a2ccf2">mtface</a>;    <span class="comment">// texture coordinates</span>
<a name="l02370"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">02370</a>     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> * <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>;      <span class="comment">// indices</span>
<a name="l02371"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">02371</a>     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> * <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>;      <span class="comment">// vertices &amp; normals</span>
<a name="l02372"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ae790804d70bfcf68aba03333278eb76e">02372</a>     float (*orco)[3];
<a name="l02373"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a3e14f5de2e70bee4df5ab196d40e2ea4">02373</a>     float (*tangent)[4];    <span class="comment">// destination</span>
<a name="l02374"></a><a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#af24cb0034912db0b2a59233109c5fed1">02374</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#af24cb0034912db0b2a59233109c5fed1">numTessFaces</a>;
<a name="l02375"></a>02375 
<a name="l02376"></a>02376 } <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a>;
<a name="l02377"></a>02377 
<a name="l02378"></a>02378 <span class="comment">// interface</span>
<a name="l02379"></a>02379 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d68/mikktspace_8h.html">mikktspace.h</a>&quot;</span>
<a name="l02380"></a>02380 
<a name="l02381"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">02381</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">GetNumFaces</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext)
<a name="l02382"></a>02382 {
<a name="l02383"></a>02383     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02384"></a>02384     <span class="keywordflow">return</span> pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#af24cb0034912db0b2a59233109c5fed1">numTessFaces</a>;
<a name="l02385"></a>02385 }
<a name="l02386"></a>02386 
<a name="l02387"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">02387</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">GetNumVertsOfFace</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keyword">const</span> <span class="keywordtype">int</span> face_num)
<a name="l02388"></a>02388 {
<a name="l02389"></a>02389     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02390"></a>02390     <span class="keywordflow">return</span> pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>!=0 ? 4 : 3;
<a name="l02391"></a>02391 }
<a name="l02392"></a>02392 
<a name="l02393"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">02393</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">GetPosition</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fPos[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l02394"></a>02394 {
<a name="l02395"></a>02395     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l02396"></a>02396     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02397"></a>02397     <span class="keyword">const</span> <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[(&amp;pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[vert_index]].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02398"></a>02398     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fPos, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02401"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a29515ce64a75f208fbc86d676f61d5ca">02401</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a29515ce64a75f208fbc86d676f61d5ca">GetTextureCoordinate</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fUV[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l02402"></a>02402 {
<a name="l02403"></a>02403     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l02404"></a>02404     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02405"></a>02405 
<a name="l02406"></a>02406     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a59716ad54f273d80b65b92cd04a2ccf2">mtface</a>!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02407"></a>02407         <span class="keywordtype">float</span> * uv = pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a59716ad54f273d80b65b92cd04a2ccf2">mtface</a>[face_num].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[vert_index];
<a name="l02408"></a>02408         fUV[0]=uv[0]; fUV[1]=uv[1];
<a name="l02409"></a>02409     }
<a name="l02410"></a>02410     <span class="keywordflow">else</span> {
<a name="l02411"></a>02411         <span class="keyword">const</span> <span class="keywordtype">float</span> *orco= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ae790804d70bfcf68aba03333278eb76e">orco</a>[(&amp;pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[vert_index]];
<a name="l02412"></a>02412         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;fUV[0], &amp;fUV[1], orco[0], orco[1], orco[2]);
<a name="l02413"></a>02413     }
<a name="l02414"></a>02414 }
<a name="l02415"></a>02415 
<a name="l02416"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">02416</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">GetNormal</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keywordtype">float</span> fNorm[], <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> vert_index)
<a name="l02417"></a>02417 {
<a name="l02418"></a>02418     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l02419"></a>02419     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02420"></a>02420 
<a name="l02421"></a>02421     <span class="keyword">const</span> <span class="keywordtype">int</span> smoothnormal = (pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a2907e1f781802f5886994a86e0ee6fd1">ME_SMOOTH</a>);
<a name="l02422"></a>02422     <span class="keywordflow">if</span> (!smoothnormal) {    <span class="comment">// flat</span>
<a name="l02423"></a>02423         <span class="keywordflow">if</span> (pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#aba422c11613d50503660a4090e06bd1e">precomputedFaceNormals</a>) {
<a name="l02424"></a>02424             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fNorm, &amp;pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#aba422c11613d50503660a4090e06bd1e">precomputedFaceNormals</a>[3*face_num]);
<a name="l02425"></a>02425         }
<a name="l02426"></a>02426         <span class="keywordflow">else</span> {
<a name="l02427"></a>02427             <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf= &amp;pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num];
<a name="l02428"></a>02428             <span class="keywordtype">float</span> *p0= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02429"></a>02429             <span class="keywordtype">float</span> *p1= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02430"></a>02430             <span class="keywordtype">float</span> *p2= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02431"></a>02431 
<a name="l02432"></a>02432             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02433"></a>02433                 <span class="keywordtype">float</span> *p3 = pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02434"></a>02434                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>(fNorm, p0, p1, p2, p3);
<a name="l02435"></a>02435             }
<a name="l02436"></a>02436             <span class="keywordflow">else</span> {
<a name="l02437"></a>02437                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(fNorm, p0, p1, p2);
<a name="l02438"></a>02438             }
<a name="l02439"></a>02439         }
<a name="l02440"></a>02440     }
<a name="l02441"></a>02441     <span class="keywordflow">else</span> {
<a name="l02442"></a>02442         <span class="keyword">const</span> <span class="keywordtype">short</span> *no= pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a>[(&amp;pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a>[face_num].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[vert_index]].no;
<a name="l02443"></a>02443         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a57d12e99226ed5380368efa5add45b75">normal_short_to_float_v3</a>(fNorm, no);
<a name="l02444"></a>02444     }
<a name="l02445"></a>02445 }
<a name="l02446"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a81e0648485f316732cd9bf91f02abe98">02446</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#a81e0648485f316732cd9bf91f02abe98">SetTSpace</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> * pContext, <span class="keyword">const</span> <span class="keywordtype">float</span> fvTangent[], <span class="keyword">const</span> <span class="keywordtype">float</span> fSign, <span class="keyword">const</span> <span class="keywordtype">int</span> face_num, <span class="keyword">const</span> <span class="keywordtype">int</span> iVert)
<a name="l02447"></a>02447 {
<a name="l02448"></a>02448     <span class="comment">//assert(vert_index&gt;=0 &amp;&amp; vert_index&lt;4);</span>
<a name="l02449"></a>02449     <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> * pMesh = (<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> *) pContext-&gt;<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a>;
<a name="l02450"></a>02450     <span class="keywordtype">float</span> * pRes = pMesh-&gt;<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a3e14f5de2e70bee4df5ab196d40e2ea4">tangent</a>[4*face_num+iVert];
<a name="l02451"></a>02451     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pRes, fvTangent);
<a name="l02452"></a>02452     pRes[3]=fSign;
<a name="l02453"></a>02453 }
<a name="l02454"></a>02454 
<a name="l02455"></a>02455 
<a name="l02456"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a63408f7aaa01a246352ce26d0123d480">02456</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a63408f7aaa01a246352ce26d0123d480">DM_add_tangent_layer</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l02457"></a>02457 {
<a name="l02458"></a>02458     <span class="comment">/* mesh vars */</span>
<a name="l02459"></a>02459     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *mtface, *tf;
<a name="l02460"></a>02460     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface, *mf;
<a name="l02461"></a>02461     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert, *v1, *v2, *v3, *v4;
<a name="l02462"></a>02462     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02463"></a>02463     <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> **vtangents= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02464"></a>02464     float (*orco)[3]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (*tangent)[4];
<a name="l02465"></a>02465     <span class="keywordtype">float</span> *uv1, *uv2, *uv3, *uv4, *vtang;
<a name="l02466"></a>02466     <span class="keywordtype">float</span> fno[3], tang[3], uv[4][2];
<a name="l02467"></a>02467     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, mf_vi[4], totvert, totface, iCalcNewMethod;
<a name="l02468"></a>02468     <span class="keywordtype">float</span> *nors;
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>) != -1)
<a name="l02471"></a>02471         <span class="keywordflow">return</span>;
<a name="l02472"></a>02472 
<a name="l02473"></a>02473     nors = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a28e89d54f6d2545bdce86f0511392f7e">CD_NORMAL</a>);
<a name="l02474"></a>02474 
<a name="l02475"></a>02475     <span class="comment">/* check we have all the needed layers */</span>
<a name="l02476"></a>02476     totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l02477"></a>02477     totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l02480"></a>02480     mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l02481"></a>02481     mtface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l02482"></a>02482 
<a name="l02483"></a>02483     <span class="keywordflow">if</span> (!mtface) {
<a name="l02484"></a>02484         orco= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aac2f1d3ce8a7a1a66926e1d295707e67">getVertDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l02485"></a>02485         <span class="keywordflow">if</span> (!orco)
<a name="l02486"></a>02486             <span class="keywordflow">return</span>;
<a name="l02487"></a>02487     }
<a name="l02488"></a>02488     
<a name="l02489"></a>02489     <span class="comment">/* create tangent layer */</span>
<a name="l02490"></a>02490     <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8cc9d09112d34ee1f78b652333530dd4">DM_add_tessface_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02491"></a>02491     tangent= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6f4a64ea66e4fa753666158e8fb9f2f2">DM_get_tessface_data_layer</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>);
<a name="l02492"></a>02492     
<a name="l02493"></a>02493     <span class="comment">/* allocate some space */</span>
<a name="l02494"></a>02494     arena= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;tangent layer arena&quot;</span>);
<a name="l02495"></a>02495     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(arena);
<a name="l02496"></a>02496     vtangents= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a>*)*totvert, <span class="stringliteral">&quot;VertexTangent&quot;</span>);
<a name="l02497"></a>02497 
<a name="l02498"></a>02498     <span class="comment">// new computation method</span>
<a name="l02499"></a>02499     iCalcNewMethod = 1;
<a name="l02500"></a>02500     <span class="keywordflow">if</span> (iCalcNewMethod != 0) {
<a name="l02501"></a>02501         <a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html">SGLSLMeshToTangent</a> mesh2tangent= {0};
<a name="l02502"></a>02502         <a class="code" href="../../d4/d00/structSMikkTSpaceContext.html">SMikkTSpaceContext</a> sContext= {0};
<a name="l02503"></a>02503         <a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html">SMikkTSpaceInterface</a> sInterface= {0};
<a name="l02504"></a>02504 
<a name="l02505"></a>02505         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#aba422c11613d50503660a4090e06bd1e">precomputedFaceNormals</a> = nors;
<a name="l02506"></a>02506         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a59716ad54f273d80b65b92cd04a2ccf2">mtface</a> = mtface;
<a name="l02507"></a>02507         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ab094a9ec99550375975c88138918e3be">mface</a> = mface;
<a name="l02508"></a>02508         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a619a84261b1ab60b06ab41066156a475">mvert</a> = mvert;
<a name="l02509"></a>02509         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#ae790804d70bfcf68aba03333278eb76e">orco</a> = orco;
<a name="l02510"></a>02510         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#a3e14f5de2e70bee4df5ab196d40e2ea4">tangent</a> = tangent;
<a name="l02511"></a>02511         mesh2tangent.<a class="code" href="../../df/dd2/structSGLSLMeshToTangent.html#af24cb0034912db0b2a59233109c5fed1">numTessFaces</a> = totface;
<a name="l02512"></a>02512 
<a name="l02513"></a>02513         sContext.<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a789c94da7ec0b26030e0a5b95e127535">m_pUserData</a> = &amp;mesh2tangent;
<a name="l02514"></a>02514         sContext.<a class="code" href="../../d4/d00/structSMikkTSpaceContext.html#a06f3a644c8b3236e23e7254863e85490">m_pInterface</a> = &amp;sInterface;
<a name="l02515"></a>02515         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a9fdecb1f66d99797e33d82c951581604">m_getNumFaces</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad782df4a126c4f8f2ef4bf005ce27346">GetNumFaces</a>;
<a name="l02516"></a>02516         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a5c2aee0b507cd4358d2e788dd879c688">m_getNumVerticesOfFace</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a52cfd95d6aa90dc6d7423e43892b3dbe">GetNumVertsOfFace</a>;
<a name="l02517"></a>02517         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#ad5cccc1210db6ca934dec70756825faa">m_getPosition</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a18ab7231c2e78c665f43e1e6e5d92403">GetPosition</a>;
<a name="l02518"></a>02518         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#ad5839c559cfb6db6c4a0a2b30a30c12e">m_getTexCoord</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a29515ce64a75f208fbc86d676f61d5ca">GetTextureCoordinate</a>;
<a name="l02519"></a>02519         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a39461c5429112f6eeac3bc8e2398a4ec">m_getNormal</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a6cf17e95b6c3c43f08c4f66fb3558d00">GetNormal</a>;
<a name="l02520"></a>02520         sInterface.<a class="code" href="../../d6/da3/structSMikkTSpaceInterface.html#a23ae8ce236e6ba34c16599db4a364f48">m_setTSpaceBasic</a> = <a class="code" href="../../db/d40/DerivedMesh_8c.html#a81e0648485f316732cd9bf91f02abe98">SetTSpace</a>;
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         <span class="comment">// 0 if failed</span>
<a name="l02523"></a>02523         iCalcNewMethod = <a class="code" href="../../d8/d91/mikktspace_8c.html#a89f845f84dc134105236dc7f568115d6">genTangSpaceDefault</a>(&amp;sContext);
<a name="l02524"></a>02524     }
<a name="l02525"></a>02525 
<a name="l02526"></a>02526     <span class="keywordflow">if</span> (!iCalcNewMethod) {
<a name="l02527"></a>02527         <span class="comment">/* sum tangents at connected vertices */</span>
<a name="l02528"></a>02528         <span class="keywordflow">for</span> (i=0, tf=mtface, mf=mface; i &lt; totface; mf++, tf++, i++) {
<a name="l02529"></a>02529             v1= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l02530"></a>02530             v2= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l02531"></a>02531             v3= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l02532"></a>02532 
<a name="l02533"></a>02533             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02534"></a>02534                 v4= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l02535"></a>02535                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( fno,v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02536"></a>02536             }
<a name="l02537"></a>02537             <span class="keywordflow">else</span> {
<a name="l02538"></a>02538                 v4= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02539"></a>02539                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( fno,v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02540"></a>02540             }
<a name="l02541"></a>02541         
<a name="l02542"></a>02542             <span class="keywordflow">if</span> (mtface) {
<a name="l02543"></a>02543                 uv1= tf-&gt;uv[0];
<a name="l02544"></a>02544                 uv2= tf-&gt;uv[1];
<a name="l02545"></a>02545                 uv3= tf-&gt;uv[2];
<a name="l02546"></a>02546                 uv4= tf-&gt;uv[3];
<a name="l02547"></a>02547             }
<a name="l02548"></a>02548             <span class="keywordflow">else</span> {
<a name="l02549"></a>02549                 uv1= uv[0]; uv2= uv[1]; uv3= uv[2]; uv4= uv[3];
<a name="l02550"></a>02550                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[0][0], &amp;uv[0][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][2]);
<a name="l02551"></a>02551                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[1][0], &amp;uv[1][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][2]);
<a name="l02552"></a>02552                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[2][0], &amp;uv[2][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][2]);
<a name="l02553"></a>02553                 <span class="keywordflow">if</span> (v4)
<a name="l02554"></a>02554                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[3][0], &amp;uv[3][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][2]);
<a name="l02555"></a>02555             }
<a name="l02556"></a>02556         
<a name="l02557"></a>02557             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaba45324d81462685b3b3b650ea84e3f">tangent_from_uv</a>(uv1, uv2, uv3, v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, fno, tang);
<a name="l02558"></a>02558             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], tang, uv1);
<a name="l02559"></a>02559             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], tang, uv2);
<a name="l02560"></a>02560             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], tang, uv3);
<a name="l02561"></a>02561         
<a name="l02562"></a>02562             <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02563"></a>02563                 v4= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l02564"></a>02564             
<a name="l02565"></a>02565                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaba45324d81462685b3b3b650ea84e3f">tangent_from_uv</a>(uv1, uv3, uv4, v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, fno, tang);
<a name="l02566"></a>02566                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], tang, uv1);
<a name="l02567"></a>02567                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], tang, uv3);
<a name="l02568"></a>02568                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(arena, &amp;vtangents[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], tang, uv4);
<a name="l02569"></a>02569             }
<a name="l02570"></a>02570         }
<a name="l02571"></a>02571     
<a name="l02572"></a>02572         <span class="comment">/* write tangent to layer */</span>
<a name="l02573"></a>02573         <span class="keywordflow">for</span> (i=0, tf=mtface, mf=mface; i &lt; totface; mf++, tf++, i++, tangent+=4) {
<a name="l02574"></a>02574             len= (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)? 4 : 3; 
<a name="l02575"></a>02575 
<a name="l02576"></a>02576             <span class="keywordflow">if</span> (mtface == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02577"></a>02577                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[0][0], &amp;uv[0][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>][2]);
<a name="l02578"></a>02578                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[1][0], &amp;uv[1][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>][2]);
<a name="l02579"></a>02579                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[2][0], &amp;uv[2][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>][2]);
<a name="l02580"></a>02580                 <span class="keywordflow">if</span> (len==4)
<a name="l02581"></a>02581                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>( &amp;uv[3][0], &amp;uv[3][1],orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][0], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][1], orco[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>][2]);
<a name="l02582"></a>02582             }
<a name="l02583"></a>02583         
<a name="l02584"></a>02584             mf_vi[0]= mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l02585"></a>02585             mf_vi[1]= mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l02586"></a>02586             mf_vi[2]= mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l02587"></a>02587             mf_vi[3]= mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l02588"></a>02588         
<a name="l02589"></a>02589             <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; j++) {
<a name="l02590"></a>02590                 vtang= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(vtangents[mf_vi[j]], mtface ? tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[j] : uv[j]);
<a name="l02591"></a>02591                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(tangent[j], vtang);
<a name="l02592"></a>02592                 ((<span class="keywordtype">float</span> *) tangent[j])[3]=1.0f;
<a name="l02593"></a>02593             }
<a name="l02594"></a>02594         }
<a name="l02595"></a>02595     }
<a name="l02596"></a>02596     
<a name="l02597"></a>02597     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(arena);
<a name="l02598"></a>02598     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vtangents);
<a name="l02599"></a>02599 }
<a name="l02600"></a>02600 
<a name="l02601"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a34146809e61bbbafa1486bca5cfcebe8">02601</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a34146809e61bbbafa1486bca5cfcebe8">DM_calc_auto_bump_scale</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l02602"></a>02602 {
<a name="l02603"></a>02603     <span class="comment">/* int totvert= dm-&gt;getNumVerts(dm); */</span> <span class="comment">/* UNUSED */</span>
<a name="l02604"></a>02604     <span class="keywordtype">int</span> totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l02605"></a>02605 
<a name="l02606"></a>02606     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> * mvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l02607"></a>02607     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> * mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l02608"></a>02608     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> * mtface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l02609"></a>02609 
<a name="l02610"></a>02610     <span class="keywordflow">if</span> (mtface) {
<a name="l02611"></a>02611         <span class="keywordtype">double</span> dsum = 0.0;
<a name="l02612"></a>02612         <span class="keywordtype">int</span> nr_accumulated = 0;
<a name="l02613"></a>02613         <span class="keywordtype">int</span> f;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615         <span class="keywordflow">for</span> ( f=0; f &lt; totface; f++ ) {
<a name="l02616"></a>02616             {
<a name="l02617"></a>02617                 <span class="keywordtype">float</span> * verts[4], * tex_coords[4];
<a name="l02618"></a>02618                 <span class="keyword">const</span> <span class="keywordtype">int</span> nr_verts = mface[f].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>!=0 ? 4 : 3;
<a name="l02619"></a>02619                 <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, is_degenerate;
<a name="l02620"></a>02620 
<a name="l02621"></a>02621                 verts[0]=mvert[mface[f].<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>; verts[1]=mvert[mface[f].<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>; verts[2]=mvert[mface[f].<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02622"></a>02622                 tex_coords[0]=mtface[f].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0]; tex_coords[1]=mtface[f].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1]; tex_coords[2]=mtface[f].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2];
<a name="l02623"></a>02623                 <span class="keywordflow">if</span> (nr_verts==4) {
<a name="l02624"></a>02624                     verts[3]=mvert[mface[f].<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l02625"></a>02625                     tex_coords[3]=mtface[f].<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3];
<a name="l02626"></a>02626                 }
<a name="l02627"></a>02627 
<a name="l02628"></a>02628                 <span class="comment">// discard degenerate faces</span>
<a name="l02629"></a>02629                 is_degenerate = 0;
<a name="l02630"></a>02630                 <span class="keywordflow">if</span> (    <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[0], verts[1]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[0], verts[2]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[1], verts[2]) ||
<a name="l02631"></a>02631                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[0], tex_coords[1]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[0], tex_coords[2]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[1], tex_coords[2]) )
<a name="l02632"></a>02632                 {
<a name="l02633"></a>02633                     is_degenerate = 1;
<a name="l02634"></a>02634                 }
<a name="l02635"></a>02635 
<a name="l02636"></a>02636                 <span class="comment">// verify last vertex as well if this is a quad</span>
<a name="l02637"></a>02637                 <span class="keywordflow">if</span> (is_degenerate == 0 &amp;&amp; nr_verts == 4) {
<a name="l02638"></a>02638                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[3], verts[0]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[3], verts[1]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(verts[3], verts[2]) ||
<a name="l02639"></a>02639                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[3], tex_coords[0]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[3], tex_coords[1]) || <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(tex_coords[3], tex_coords[2]) )
<a name="l02640"></a>02640                     {
<a name="l02641"></a>02641                         is_degenerate = 1;
<a name="l02642"></a>02642                     }
<a name="l02643"></a>02643 
<a name="l02644"></a>02644                     <span class="comment">// verify the winding is consistent</span>
<a name="l02645"></a>02645                     <span class="keywordflow">if</span> (is_degenerate == 0) {
<a name="l02646"></a>02646                         <span class="keywordtype">float</span> prev_edge[2];
<a name="l02647"></a>02647                         <span class="keywordtype">int</span> is_signed = 0;
<a name="l02648"></a>02648                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(prev_edge, tex_coords[0], tex_coords[3]);
<a name="l02649"></a>02649 
<a name="l02650"></a>02650                         i = 0;
<a name="l02651"></a>02651                         <span class="keywordflow">while</span> (is_degenerate == 0 &amp;&amp; i &lt; 4) {
<a name="l02652"></a>02652                             <span class="keywordtype">float</span> cur_edge[2], signed_area;
<a name="l02653"></a>02653                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(cur_edge, tex_coords[(i+1)&amp;0x3], tex_coords[i]);
<a name="l02654"></a>02654                             signed_area = prev_edge[0]*cur_edge[1] - prev_edge[1]*cur_edge[0];
<a name="l02655"></a>02655 
<a name="l02656"></a>02656                             <span class="keywordflow">if</span> (i == 0 ) {
<a name="l02657"></a>02657                                 is_signed = (signed_area &lt; 0.0f) ? 1 : 0;
<a name="l02658"></a>02658                             }
<a name="l02659"></a>02659                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((is_signed != 0) != (signed_area &lt; 0.0f)) {
<a name="l02660"></a>02660                                 is_degenerate = 1;
<a name="l02661"></a>02661                             }
<a name="l02662"></a>02662 
<a name="l02663"></a>02663                             <span class="keywordflow">if</span> (is_degenerate == 0) {
<a name="l02664"></a>02664                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(prev_edge, cur_edge);
<a name="l02665"></a>02665                                 ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02666"></a>02666                             }
<a name="l02667"></a>02667                         }
<a name="l02668"></a>02668                     }
<a name="l02669"></a>02669                 }
<a name="l02670"></a>02670 
<a name="l02671"></a>02671                 <span class="comment">// proceed if not a degenerate face</span>
<a name="l02672"></a>02672                 <span class="keywordflow">if</span> (is_degenerate == 0) {
<a name="l02673"></a>02673                     <span class="keywordtype">int</span> nr_tris_to_pile=0;
<a name="l02674"></a>02674                     <span class="comment">// quads split at shortest diagonal</span>
<a name="l02675"></a>02675                     <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a> = 0;       <span class="comment">// initial triangulation is 0,1,2 and 0, 2, 3</span>
<a name="l02676"></a>02676                     <span class="keywordflow">if</span> (nr_verts == 4) {
<a name="l02677"></a>02677                         <span class="keywordtype">float</span> pos_len_diag0, pos_len_diag1;
<a name="l02678"></a>02678                         <span class="keywordtype">float</span> vtmp[3];
<a name="l02679"></a>02679                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vtmp, verts[2], verts[0]);
<a name="l02680"></a>02680                         pos_len_diag0 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vtmp, vtmp);
<a name="l02681"></a>02681                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vtmp, verts[3], verts[1]);
<a name="l02682"></a>02682                         pos_len_diag1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vtmp, vtmp);
<a name="l02683"></a>02683 
<a name="l02684"></a>02684                         <span class="keywordflow">if</span> (pos_len_diag1&lt;pos_len_diag0) {
<a name="l02685"></a>02685                             offs=1;     <span class="comment">// alter split</span>
<a name="l02686"></a>02686                         }
<a name="l02687"></a>02687                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pos_len_diag0==pos_len_diag1) { <span class="comment">/* do UV check instead */</span>
<a name="l02688"></a>02688                             <span class="keywordtype">float</span> tex_len_diag0, tex_len_diag1;
<a name="l02689"></a>02689 
<a name="l02690"></a>02690                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(vtmp, tex_coords[2], tex_coords[0]);
<a name="l02691"></a>02691                             tex_len_diag0 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(vtmp, vtmp);
<a name="l02692"></a>02692                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(vtmp, tex_coords[3], tex_coords[1]);
<a name="l02693"></a>02693                             tex_len_diag1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(vtmp, vtmp);
<a name="l02694"></a>02694 
<a name="l02695"></a>02695                             <span class="keywordflow">if</span> (tex_len_diag1&lt;tex_len_diag0) {
<a name="l02696"></a>02696                                 offs=1; <span class="comment">/* alter split */</span>
<a name="l02697"></a>02697                             }
<a name="l02698"></a>02698                         }
<a name="l02699"></a>02699                     }
<a name="l02700"></a>02700                     nr_tris_to_pile = nr_verts - 2;
<a name="l02701"></a>02701                     <span class="keywordflow">if</span> (nr_tris_to_pile==1 || nr_tris_to_pile==2) {
<a name="l02702"></a>02702                         <span class="keyword">const</span> <span class="keywordtype">int</span> indices[] = {offs+0, offs+1, offs+2, offs+0, offs+2, (offs+3)&amp;0x3 };
<a name="l02703"></a>02703                         <span class="keywordtype">int</span> t;
<a name="l02704"></a>02704                         <span class="keywordflow">for</span> ( t=0; t&lt;nr_tris_to_pile; t++ )
<a name="l02705"></a>02705                         {
<a name="l02706"></a>02706                             <span class="keywordtype">float</span> f2x_area_uv;
<a name="l02707"></a>02707                             <span class="keywordtype">float</span> * p0 = verts[indices[t*3+0]];
<a name="l02708"></a>02708                             <span class="keywordtype">float</span> * p1 = verts[indices[t*3+1]];
<a name="l02709"></a>02709                             <span class="keywordtype">float</span> * p2 = verts[indices[t*3+2]];
<a name="l02710"></a>02710 
<a name="l02711"></a>02711                             <span class="keywordtype">float</span> edge_t0[2], edge_t1[2];
<a name="l02712"></a>02712                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(edge_t0, tex_coords[indices[t*3+1]], tex_coords[indices[t*3+0]]);
<a name="l02713"></a>02713                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(edge_t1, tex_coords[indices[t*3+2]], tex_coords[indices[t*3+0]]);
<a name="l02714"></a>02714 
<a name="l02715"></a>02715                             f2x_area_uv = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(edge_t0[0]*edge_t1[1] - edge_t0[1]*edge_t1[0]);
<a name="l02716"></a>02716                             <span class="keywordflow">if</span> (f2x_area_uv&gt;FLT_EPSILON) {
<a name="l02717"></a>02717                                 <span class="keywordtype">float</span> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>[3], v0[3], v1[3], f2x_surf_area, fsurf_ratio;
<a name="l02718"></a>02718                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v0, p1, p0);
<a name="l02719"></a>02719                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v1, p2, p0);
<a name="l02720"></a>02720                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(norm, v0, v1);
<a name="l02721"></a>02721 
<a name="l02722"></a>02722                                 f2x_surf_area = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(norm);
<a name="l02723"></a>02723                                 fsurf_ratio = f2x_surf_area/f2x_area_uv;    <span class="comment">// tri area divided by texture area</span>
<a name="l02724"></a>02724 
<a name="l02725"></a>02725                                 ++nr_accumulated;
<a name="l02726"></a>02726                                 dsum += (double)(fsurf_ratio);
<a name="l02727"></a>02727                             }
<a name="l02728"></a>02728                         }
<a name="l02729"></a>02729                     }
<a name="l02730"></a>02730                 }
<a name="l02731"></a>02731             }
<a name="l02732"></a>02732         }
<a name="l02733"></a>02733 
<a name="l02734"></a>02734         <span class="comment">// finalize</span>
<a name="l02735"></a>02735         {
<a name="l02736"></a>02736             <span class="keyword">const</span> <span class="keywordtype">float</span> avg_area_ratio = (nr_accumulated&gt;0) ? ((<span class="keywordtype">float</span>)(dsum / nr_accumulated)) : 1.0f;
<a name="l02737"></a>02737             <span class="keyword">const</span> <span class="keywordtype">float</span> use_as_render_bump_scale = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(avg_area_ratio);       <span class="comment">// use width of average surface ratio as your bump scale</span>
<a name="l02738"></a>02738             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa480cce78cce6112e4501d533beb76c1">auto_bump_scale</a> = use_as_render_bump_scale;
<a name="l02739"></a>02739         }
<a name="l02740"></a>02740     }
<a name="l02741"></a>02741     <span class="keywordflow">else</span> {
<a name="l02742"></a>02742         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa480cce78cce6112e4501d533beb76c1">auto_bump_scale</a> = 1.0f;
<a name="l02743"></a>02743     }
<a name="l02744"></a>02744 }
<a name="l02745"></a>02745 
<a name="l02746"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a651b141ca4ffe1ef01cabd416f9c56f8">02746</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a824fbbdba6c71ac5c1aee9b1170b814b">DM_vertex_attributes_from_gpu</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../df/d4b/structGPUVertexAttribs.html">GPUVertexAttribs</a> *gattribs, <a class="code" href="../../d8/dd7/structDMVertexAttribs.html">DMVertexAttribs</a> *attribs)
<a name="l02747"></a>02747 {
<a name="l02748"></a>02748     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *vdata, *fdata, *tfdata = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02749"></a>02749     <span class="keywordtype">int</span> a, b, layer;
<a name="l02750"></a>02750 
<a name="l02751"></a>02751     <span class="comment">/* From the layers requested by the GLSL shader, figure out which ones are</span>
<a name="l02752"></a>02752 <span class="comment">     * actually available for this derivedmesh, and retrieve the pointers */</span>
<a name="l02753"></a>02753 
<a name="l02754"></a>02754     memset(attribs, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/dd7/structDMVertexAttribs.html">DMVertexAttribs</a>));
<a name="l02755"></a>02755 
<a name="l02756"></a>02756     vdata = &amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>;
<a name="l02757"></a>02757     fdata = tfdata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fc1707b5d97e84c917ce44c015fdd14">getTessFaceDataLayout</a>(dm);
<a name="l02758"></a>02758     
<a name="l02759"></a>02759     <span class="comment">/* calc auto bump scale if necessary */</span>
<a name="l02760"></a>02760     <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aa480cce78cce6112e4501d533beb76c1">auto_bump_scale</a> &lt;= 0.0f)
<a name="l02761"></a>02761         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a34146809e61bbbafa1486bca5cfcebe8">DM_calc_auto_bump_scale</a>(dm);
<a name="l02762"></a>02762 
<a name="l02763"></a>02763     <span class="comment">/* add a tangent layer if necessary */</span>
<a name="l02764"></a>02764     <span class="keywordflow">for</span> (b = 0; b &lt; gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a6caaa54064e974c109aad170c20a0388">totlayer</a>; b++)
<a name="l02765"></a>02765         <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a43db018ebac664a17df57e1a237ce456">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>)
<a name="l02766"></a>02766             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(fdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>) == -1)
<a name="l02767"></a>02767                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a63408f7aaa01a246352ce26d0123d480">DM_add_tangent_layer</a>(dm);
<a name="l02768"></a>02768 
<a name="l02769"></a>02769     <span class="keywordflow">for</span> (b = 0; b &lt; gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a6caaa54064e974c109aad170c20a0388">totlayer</a>; b++) {
<a name="l02770"></a>02770         <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a43db018ebac664a17df57e1a237ce456">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>) {
<a name="l02771"></a>02771             <span class="comment">/* uv coordinates */</span>
<a name="l02772"></a>02772             <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> == <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefa6ab3966d014cf244418874be6a8a503a">DM_TYPE_EDITBMESH</a>) {
<a name="l02773"></a>02773                 <span class="comment">/* exception .. */</span>
<a name="l02774"></a>02774                 <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *ldata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8ba9e2e6c310e5ddfb0535f0425c56a4">getLoopDataLayout</a>(dm);
<a name="l02775"></a>02775 
<a name="l02776"></a>02776                 <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>[0])
<a name="l02777"></a>02777                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#acc4311230a2627e6cbaf767a15b3aaa2">CD_MLOOPUV</a>,
<a name="l02778"></a>02778                         gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>);
<a name="l02779"></a>02779                 <span class="keywordflow">else</span>
<a name="l02780"></a>02780                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#acc4311230a2627e6cbaf767a15b3aaa2">CD_MLOOPUV</a>);
<a name="l02781"></a>02781 
<a name="l02782"></a>02782                 <span class="keywordflow">if</span> (layer != -1) {
<a name="l02783"></a>02783                     a = attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a65eb81d36af09c531433819335069260">tottface</a>++;
<a name="l02784"></a>02784 
<a name="l02785"></a>02785                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02786"></a>02786                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02787"></a>02787                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02788"></a>02788                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a53e6ad9f6d9b06dbddb131f2a3e21a11">glTexco</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a56eeb1c11e55e52c9380a1d0feca4f34">gltexco</a>;
<a name="l02789"></a>02789                 }
<a name="l02790"></a>02790             }
<a name="l02791"></a>02791             <span class="keywordflow">else</span> {
<a name="l02792"></a>02792                 <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>[0])
<a name="l02793"></a>02793                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(tfdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>,
<a name="l02794"></a>02794                         gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>);
<a name="l02795"></a>02795                 <span class="keywordflow">else</span>
<a name="l02796"></a>02796                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(tfdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l02797"></a>02797 
<a name="l02798"></a>02798                 <span class="keywordflow">if</span> (layer != -1) {
<a name="l02799"></a>02799                     a = attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a65eb81d36af09c531433819335069260">tottface</a>++;
<a name="l02800"></a>02800 
<a name="l02801"></a>02801                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02802"></a>02802                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02803"></a>02803                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02804"></a>02804                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4d02c794ba86d52838fcd0b8b8e5f7ba">tface</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a53e6ad9f6d9b06dbddb131f2a3e21a11">glTexco</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a56eeb1c11e55e52c9380a1d0feca4f34">gltexco</a>;
<a name="l02805"></a>02805                 }
<a name="l02806"></a>02806             }
<a name="l02807"></a>02807         }
<a name="l02808"></a>02808         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a43db018ebac664a17df57e1a237ce456">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>) {
<a name="l02809"></a>02809             <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a> == <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefa6ab3966d014cf244418874be6a8a503a">DM_TYPE_EDITBMESH</a>) {
<a name="l02810"></a>02810                 <span class="comment">/* exception .. */</span>
<a name="l02811"></a>02811                 <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> *ldata = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a8ba9e2e6c310e5ddfb0535f0425c56a4">getLoopDataLayout</a>(dm);
<a name="l02812"></a>02812 
<a name="l02813"></a>02813                 <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>[0])
<a name="l02814"></a>02814                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#adfdc3d9683ce132f088e8fee80fe6f71">CD_MLOOPCOL</a>,
<a name="l02815"></a>02815                         gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>);
<a name="l02816"></a>02816                 <span class="keywordflow">else</span>
<a name="l02817"></a>02817                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#adfdc3d9683ce132f088e8fee80fe6f71">CD_MLOOPCOL</a>);
<a name="l02818"></a>02818 
<a name="l02819"></a>02819                 <span class="keywordflow">if</span> (layer != -1) {
<a name="l02820"></a>02820                     a = attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab50343352f1360220b42a76f4f54fafe">totmcol</a>++;
<a name="l02821"></a>02821 
<a name="l02822"></a>02822                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02823"></a>02823                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02824"></a>02824                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02825"></a>02825                 }
<a name="l02826"></a>02826             }
<a name="l02827"></a>02827             <span class="keywordflow">else</span> {
<a name="l02828"></a>02828                 <span class="comment">/* vertex colors */</span>
<a name="l02829"></a>02829                 <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>[0])
<a name="l02830"></a>02830                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a42d4bac4843a93806cbf4b71a76c2e81">CustomData_get_named_layer_index</a>(tfdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>,
<a name="l02831"></a>02831                         gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aaa70448e97776d5570ca597c7eb047ba">name</a>);
<a name="l02832"></a>02832                 <span class="keywordflow">else</span>
<a name="l02833"></a>02833                     layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a098bb428fd4e855c00284e9920551f7d">CustomData_get_active_layer_index</a>(tfdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>);
<a name="l02834"></a>02834 
<a name="l02835"></a>02835                 <span class="keywordflow">if</span> (layer != -1) {
<a name="l02836"></a>02836                     a = attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab50343352f1360220b42a76f4f54fafe">totmcol</a>++;
<a name="l02837"></a>02837 
<a name="l02838"></a>02838                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02839"></a>02839                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = tfdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02840"></a>02840                     attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a4f0fdddc28f5446973a94ff03a06c740">mcol</a>[a].<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02841"></a>02841                 }
<a name="l02842"></a>02842             }
<a name="l02843"></a>02843         }
<a name="l02844"></a>02844         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a43db018ebac664a17df57e1a237ce456">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>) {
<a name="l02845"></a>02845             <span class="comment">/* tangents */</span>
<a name="l02846"></a>02846             layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(fdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9a75d58928774d1a6eaca221552ba789">CD_TANGENT</a>);
<a name="l02847"></a>02847 
<a name="l02848"></a>02848             <span class="keywordflow">if</span> (layer != -1) {
<a name="l02849"></a>02849                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a5d30e1bab596da97a5d188924c069162">tottang</a> = 1;
<a name="l02850"></a>02850 
<a name="l02851"></a>02851                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aed33201b696f004c6c81024b396584ec">tang</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = fdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02852"></a>02852                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aed33201b696f004c6c81024b396584ec">tang</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = fdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02853"></a>02853                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aed33201b696f004c6c81024b396584ec">tang</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02854"></a>02854             }
<a name="l02855"></a>02855         }
<a name="l02856"></a>02856         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a43db018ebac664a17df57e1a237ce456">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>) {
<a name="l02857"></a>02857             <span class="comment">/* original coordinates */</span>
<a name="l02858"></a>02858             layer = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa8003ee4a69673200c1cc2227a89eb2a">CustomData_get_layer_index</a>(vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ae98238829926fe3c3d1fd496d95ac727">CD_ORCO</a>);
<a name="l02859"></a>02859 
<a name="l02860"></a>02860             <span class="keywordflow">if</span> (layer != -1) {
<a name="l02861"></a>02861                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aa289786e63a006a2b351d52e0dee6aba">totorco</a> = 1;
<a name="l02862"></a>02862 
<a name="l02863"></a>02863                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a5d03cdfff90b491a20c21bbfcb88e0f3">orco</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a85ef74ca5388f33dcdb69175d093526c">array</a> = vdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l02864"></a>02864                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a5d03cdfff90b491a20c21bbfcb88e0f3">orco</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#aabfc4c93df8eddfa8cf52b96045f13ea">emOffset</a> = vdata-&gt;<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[layer].<a class="code" href="../../d5/d97/structCustomDataLayer.html#ad6fffe385d55bacd44aff0043d959953">offset</a>;
<a name="l02865"></a>02865                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a5d03cdfff90b491a20c21bbfcb88e0f3">orco</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#ab9af6369d82028723765dff22df49747">glIndex</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#aca303ab13b62704511b4c25ab3d66896">glindex</a>;
<a name="l02866"></a>02866                 attribs-&gt;<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a5d03cdfff90b491a20c21bbfcb88e0f3">orco</a>.<a class="code" href="../../d8/dd7/structDMVertexAttribs.html#a53e6ad9f6d9b06dbddb131f2a3e21a11">glTexco</a> = gattribs-&gt;<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a76cf952f016dd62c2f60dedc0716c3ac">layer</a>[b].<a class="code" href="../../df/d4b/structGPUVertexAttribs.html#a56eeb1c11e55e52c9380a1d0feca4f34">gltexco</a>;
<a name="l02867"></a>02867             }
<a name="l02868"></a>02868         }
<a name="l02869"></a>02869     }
<a name="l02870"></a>02870 }
<a name="l02871"></a>02871 
<a name="l02872"></a>02872 <span class="comment">/* Set object&#39;s bounding box based on DerivedMesh min/max data */</span>
<a name="l02873"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a2a928856adb13b10ae7e0c491fbeabc4">02873</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a7140dcf7215b75e8e49d8f166a0ef7f7">DM_set_object_boundbox</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l02874"></a>02874 {
<a name="l02875"></a>02875     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3];
<a name="l02876"></a>02876 
<a name="l02877"></a>02877     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l02878"></a>02878 
<a name="l02879"></a>02879     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1e765037d4de223d2f7fd63b551e1c99">getMinMax</a>(dm, min, max);
<a name="l02880"></a>02880 
<a name="l02881"></a>02881     <span class="keywordflow">if</span> (!ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>)
<a name="l02882"></a>02882         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a>), <span class="stringliteral">&quot;DM-BoundBox&quot;</span>);
<a name="l02883"></a>02883 
<a name="l02884"></a>02884     <a class="code" href="../../df/dac/BKE__object_8h.html#af195012a626e055e795867bdb53d2dd3">boundbox_set_from_min_max</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>, min, max);
<a name="l02885"></a>02885 }
<a name="l02886"></a>02886 
<a name="l02887"></a>02887 <span class="comment">/* --- NAVMESH (begin) --- */</span>
<a name="l02888"></a>02888 <span class="preprocessor">#ifdef WITH_GAMEENGINE</span>
<a name="l02889"></a>02889 <span class="preprocessor"></span>
<a name="l02890"></a>02890 <span class="comment">/* BMESH_TODO, navmesh is not working right currently</span>
<a name="l02891"></a>02891 <span class="comment"> * All tools set this as MPoly data, but derived mesh currently draws from MFace (tessface)</span>
<a name="l02892"></a>02892 <span class="comment"> *</span>
<a name="l02893"></a>02893 <span class="comment"> * Proposed solution, rather then copy CD_RECAST into the MFace array,</span>
<a name="l02894"></a>02894 <span class="comment"> * use ORIGINDEX to get the original poly index and then get the CD_RECAST</span>
<a name="l02895"></a>02895 <span class="comment"> * data from the original me-&gt;mpoly layer. - campbell</span>
<a name="l02896"></a>02896 <span class="comment"> */</span>
<a name="l02897"></a>02897 
<a name="l02898"></a>02898 
<a name="l02899"></a>02899 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">int</span> navmesh_bit(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b)
<a name="l02900"></a>02900 {
<a name="l02901"></a>02901     <span class="keywordflow">return</span> (a &amp; (1 &lt;&lt; b)) &gt;&gt; b;
<a name="l02902"></a>02902 }
<a name="l02903"></a>02903 
<a name="l02904"></a>02904 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">void</span> navmesh_intToCol(<span class="keywordtype">int</span> i, <span class="keywordtype">float</span> col[3])
<a name="l02905"></a>02905 {
<a name="l02906"></a>02906     <span class="keywordtype">int</span> r = navmesh_bit(i, 0) + navmesh_bit(i, 3) * 2 + 1;
<a name="l02907"></a>02907     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a> = navmesh_bit(i, 1) + navmesh_bit(i, 4) * 2 + 1;
<a name="l02908"></a>02908     <span class="keywordtype">int</span> b = navmesh_bit(i, 2) + navmesh_bit(i, 5) * 2 + 1;
<a name="l02909"></a>02909     col[0] = 1 - r*63.0f/255.0f;
<a name="l02910"></a>02910     col[1] = 1 - g*63.0f/255.0f;
<a name="l02911"></a>02911     col[2] = 1 - b*63.0f/255.0f;
<a name="l02912"></a>02912 }
<a name="l02913"></a>02913 
<a name="l02914"></a>02914 <span class="keyword">static</span> <span class="keywordtype">void</span> navmesh_drawColored(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l02915"></a>02915 {
<a name="l02916"></a>02916     <span class="keywordtype">int</span> a, glmode;
<a name="l02917"></a>02917     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = (<a class="code" href="../../d8/de5/structMVert.html">MVert</a> *)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a1c381760f3a93e81d828b261dc9ad6d3">vertData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>);
<a name="l02918"></a>02918     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = (<a class="code" href="../../d6/da0/structMFace.html">MFace</a> *)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#ab3e1f19d7cc2b320286784997edc1519">CD_MFACE</a>);
<a name="l02919"></a>02919     <span class="keywordtype">int</span> *polygonIdx = (<span class="keywordtype">int</span> *)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a721b9eda28c1f0855565f70b99fb21c4">CD_RECAST</a>);
<a name="l02920"></a>02920     <span class="keywordtype">float</span> col[3];
<a name="l02921"></a>02921 
<a name="l02922"></a>02922     <span class="keywordflow">if</span> (!polygonIdx)
<a name="l02923"></a>02923         <span class="keywordflow">return</span>;
<a name="l02924"></a>02924 
<a name="l02925"></a>02925 <span class="preprocessor">#if 0</span>
<a name="l02926"></a>02926 <span class="preprocessor"></span>    <span class="comment">//UI_ThemeColor(TH_WIRE);</span>
<a name="l02927"></a>02927     glDisable(GL_LIGHTING);
<a name="l02928"></a>02928     glLineWidth(2.0);
<a name="l02929"></a>02929     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a05d1c2b6c7c1eff4fdf4fdb973bbba5c">drawEdges</a>(dm, 0, 1);
<a name="l02930"></a>02930     glLineWidth(1.0);
<a name="l02931"></a>02931     glEnable(GL_LIGHTING);
<a name="l02932"></a>02932 <span class="preprocessor">#endif</span>
<a name="l02933"></a>02933 <span class="preprocessor"></span>
<a name="l02934"></a>02934     glDisable(GL_LIGHTING);
<a name="l02935"></a>02935     <span class="comment">/*  if (GPU_buffer_legacy(dm) ) */</span> { <span class="comment">/* TODO - VBO draw code, not high priority - campbell */</span>
<a name="l02936"></a>02936         <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a44eb6243d4d5ee45e31453b0e66c6530">DEBUG_VBO</a>( <span class="stringliteral">&quot;Using legacy code. drawNavMeshColored\n&quot;</span> );
<a name="l02937"></a>02937         <span class="comment">//glShadeModel(GL_SMOOTH);</span>
<a name="l02938"></a>02938         glBegin(glmode = GL_QUADS);
<a name="l02939"></a>02939         <span class="keywordflow">for</span> (a = 0; a &lt; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a9c1e3e826773dadacab930b7f3b84bd4">numTessFaceData</a>; a++, mface++) {
<a name="l02940"></a>02940             <span class="keywordtype">int</span> new_glmode = mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>?GL_QUADS:GL_TRIANGLES;
<a name="l02941"></a>02941             <span class="keywordtype">int</span> pi = polygonIdx[a];
<a name="l02942"></a>02942             <span class="keywordflow">if</span> (pi &lt;= 0) {
<a name="l02943"></a>02943                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(col);
<a name="l02944"></a>02944             }
<a name="l02945"></a>02945             <span class="keywordflow">else</span> {
<a name="l02946"></a>02946                 navmesh_intToCol(pi, col);
<a name="l02947"></a>02947             }
<a name="l02948"></a>02948 
<a name="l02949"></a>02949             <span class="keywordflow">if</span> (new_glmode != glmode) {
<a name="l02950"></a>02950                 glEnd();
<a name="l02951"></a>02951                 glBegin(glmode = new_glmode);
<a name="l02952"></a>02952             }
<a name="l02953"></a>02953             glColor3fv(col);
<a name="l02954"></a>02954             glVertex3fv(mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02955"></a>02955             glVertex3fv(mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02956"></a>02956             glVertex3fv(mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02957"></a>02957             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02958"></a>02958                 glVertex3fv(mvert[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l02959"></a>02959             }
<a name="l02960"></a>02960         }
<a name="l02961"></a>02961         glEnd();
<a name="l02962"></a>02962     }
<a name="l02963"></a>02963     glEnable(GL_LIGHTING);
<a name="l02964"></a>02964 }
<a name="l02965"></a>02965 
<a name="l02966"></a>02966 <span class="keyword">static</span> <span class="keywordtype">void</span> navmesh_DM_drawFacesTex(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l02967"></a>02967             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aef957b3341a537c68afe7a4e5fdcb25a">DMSetDrawOptionsTex</a> setDrawOptions,
<a name="l02968"></a>02968             <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#acb89f197b8bb92b92b933d95e540e562">DMCompareDrawOptions</a> <a class="code" href="../../d8/d5e/drawmesh_8c.html#a5b00e8aa393dfa266e6141205ab9c4e4">compareDrawOptions</a>,
<a name="l02969"></a>02969             <span class="keywordtype">void</span> *userData)
<a name="l02970"></a>02970 {
<a name="l02971"></a>02971     (void) setDrawOptions;
<a name="l02972"></a>02972     (void) compareDrawOptions;
<a name="l02973"></a>02973     (void) userData;
<a name="l02974"></a>02974 
<a name="l02975"></a>02975     navmesh_drawColored(dm);
<a name="l02976"></a>02976 }
<a name="l02977"></a>02977 
<a name="l02978"></a>02978 <span class="keyword">static</span> <span class="keywordtype">void</span> navmesh_DM_drawFacesSolid(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l02979"></a>02979                                       <span class="keywordtype">float</span> (*partial_redraw_planes)[4],
<a name="l02980"></a>02980                                       <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(fast), <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a8e2f823f024740efe648726f57f4a336">DMSetMaterial</a> setMaterial)
<a name="l02981"></a>02981 {
<a name="l02982"></a>02982     (void) partial_redraw_planes;
<a name="l02983"></a>02983     (void) setMaterial;
<a name="l02984"></a>02984 
<a name="l02985"></a>02985     <span class="comment">//drawFacesSolid_original(dm, partial_redraw_planes, fast, setMaterial);</span>
<a name="l02986"></a>02986     navmesh_drawColored(dm);
<a name="l02987"></a>02987 }
<a name="l02988"></a>02988 
<a name="l02989"></a>02989 <span class="keyword">static</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *navmesh_dm_createNavMeshForVisualization(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l02990"></a>02990 {
<a name="l02991"></a>02991     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *result;
<a name="l02992"></a>02992     <span class="keywordtype">int</span> maxFaces = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm);
<a name="l02993"></a>02993     <span class="keywordtype">int</span> *recastData;
<a name="l02994"></a>02994     <span class="keywordtype">int</span> vertsPerPoly=0, nverts=0, ndtris=0, npolys=0;
<a name="l02995"></a>02995     <span class="keywordtype">float</span>* verts=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02996"></a>02996     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *dtris=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dmeshes=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *polys=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02997"></a>02997     <span class="keywordtype">int</span> *dtrisToPolysMap=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dtrisToTrisMap=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *trisToFacesMap=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02998"></a>02998     <span class="keywordtype">int</span> res;
<a name="l02999"></a>02999 
<a name="l03000"></a>03000     result = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#a11c2ffc21d7b76e1d54d7d0acca4081b">CDDM_copy</a>(dm);
<a name="l03001"></a>03001     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a721b9eda28c1f0855565f70b99fb21c4">CD_RECAST</a>)) {
<a name="l03002"></a>03002         <span class="keywordtype">int</span> *sourceRecastData = (<span class="keywordtype">int</span>*)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a721b9eda28c1f0855565f70b99fb21c4">CD_RECAST</a>);
<a name="l03003"></a>03003         <span class="keywordflow">if</span> (sourceRecastData) {
<a name="l03004"></a>03004             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a514f57347b3c1b0b3bdcbfca430b4730">CustomData_add_layer_named</a>(&amp;result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a721b9eda28c1f0855565f70b99fb21c4">CD_RECAST</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9ae838613069a4816ab0085d58b11162">CD_DUPLICATE</a>,
<a name="l03005"></a>03005                                        sourceRecastData, maxFaces, <span class="stringliteral">&quot;recastData&quot;</span>);
<a name="l03006"></a>03006         }
<a name="l03007"></a>03007     }
<a name="l03008"></a>03008     recastData = (<span class="keywordtype">int</span>*)<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a6fef20d1e0da7b52c44be7a98b2fb388">polyData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a721b9eda28c1f0855565f70b99fb21c4">CD_RECAST</a>);
<a name="l03009"></a>03009 
<a name="l03010"></a>03010     <span class="comment">/* note: This is not good design! - really should not be doing this */</span>
<a name="l03011"></a>03011     result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aabf376427b748363f4488e019f83d6ca">drawFacesTex</a> =  navmesh_DM_drawFacesTex;
<a name="l03012"></a>03012     result-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ae8847d132e3b89911b0ee999b3843b95">drawFacesSolid</a> = navmesh_DM_drawFacesSolid;
<a name="l03013"></a>03013 
<a name="l03014"></a>03014 
<a name="l03015"></a>03015     <span class="comment">/* process mesh */</span>
<a name="l03016"></a>03016     res  = <a class="code" href="../../d0/d7e/BKE__navmesh__conversion_8h.html#adaa926fb73a1ff588f0cfe8036ef0b2a">buildNavMeshDataByDerivedMesh</a>(dm, &amp;vertsPerPoly, &amp;nverts, &amp;verts, &amp;ndtris, &amp;dtris,
<a name="l03017"></a>03017                                          &amp;npolys, &amp;dmeshes, &amp;polys, &amp;dtrisToPolysMap, &amp;dtrisToTrisMap,
<a name="l03018"></a>03018                                          &amp;trisToFacesMap);
<a name="l03019"></a>03019     <span class="keywordflow">if</span> (res) {
<a name="l03020"></a>03020         <span class="keywordtype">size_t</span> polyIdx;
<a name="l03021"></a>03021 
<a name="l03022"></a>03022         <span class="comment">/* invalidate concave polygon */</span>
<a name="l03023"></a>03023         <span class="keywordflow">for</span> (polyIdx=0; polyIdx&lt;(size_t)npolys; polyIdx++) {
<a name="l03024"></a>03024             <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>* poly = &amp;polys[polyIdx*2*vertsPerPoly];
<a name="l03025"></a>03025             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d7e/BKE__navmesh__conversion_8h.html#a2e1848b071ee7ed17337de741d771cd2">polyIsConvex</a>(poly, vertsPerPoly, verts)) {
<a name="l03026"></a>03026                 <span class="comment">/* set negative polygon idx to all faces */</span>
<a name="l03027"></a>03027                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *dmesh = &amp;dmeshes[4*polyIdx];
<a name="l03028"></a>03028                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> tbase = dmesh[2];
<a name="l03029"></a>03029                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> tnum = dmesh[3];
<a name="l03030"></a>03030                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ti;
<a name="l03031"></a>03031 
<a name="l03032"></a>03032                 <span class="keywordflow">for</span> (ti=0; ti&lt;tnum; ti++) {
<a name="l03033"></a>03033                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> triidx = dtrisToTrisMap[tbase+ti];
<a name="l03034"></a>03034                     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> faceidx = trisToFacesMap[triidx];
<a name="l03035"></a>03035                     <span class="keywordflow">if</span> (recastData[faceidx] &gt; 0) {
<a name="l03036"></a>03036                         recastData[faceidx] = -recastData[faceidx];
<a name="l03037"></a>03037                     }
<a name="l03038"></a>03038                 }
<a name="l03039"></a>03039             }
<a name="l03040"></a>03040         }
<a name="l03041"></a>03041     }
<a name="l03042"></a>03042     <span class="keywordflow">else</span> {
<a name="l03043"></a>03043         printf(<span class="stringliteral">&quot;%s: Error during creation polygon infos\n&quot;</span>, __func__);
<a name="l03044"></a>03044     }
<a name="l03045"></a>03045 
<a name="l03046"></a>03046     <span class="comment">/* clean up */</span>
<a name="l03047"></a>03047     <span class="keywordflow">if</span> (verts!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03048"></a>03048         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(verts);
<a name="l03049"></a>03049     <span class="keywordflow">if</span> (dtris!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03050"></a>03050         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dtris);
<a name="l03051"></a>03051     <span class="keywordflow">if</span> (dmeshes!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03052"></a>03052         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dmeshes);
<a name="l03053"></a>03053     <span class="keywordflow">if</span> (polys!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03054"></a>03054         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(polys);
<a name="l03055"></a>03055     <span class="keywordflow">if</span> (dtrisToPolysMap!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03056"></a>03056         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dtrisToPolysMap);
<a name="l03057"></a>03057     <span class="keywordflow">if</span> (dtrisToTrisMap!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03058"></a>03058         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dtrisToTrisMap);
<a name="l03059"></a>03059     <span class="keywordflow">if</span> (trisToFacesMap!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03060"></a>03060         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(trisToFacesMap);
<a name="l03061"></a>03061 
<a name="l03062"></a>03062     <span class="keywordflow">return</span> result;
<a name="l03063"></a>03063 }
<a name="l03064"></a>03064 
<a name="l03065"></a>03065 <span class="preprocessor">#endif </span><span class="comment">/* WITH_GAMEENGINE */</span>
<a name="l03066"></a>03066 
<a name="l03067"></a>03067 <span class="comment">/* --- NAVMESH (end) --- */</span>
<a name="l03068"></a>03068 
<a name="l03069"></a>03069 
<a name="l03070"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#af0153c5b305453f044f1101e646f232b">03070</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af0153c5b305453f044f1101e646f232b">DM_init_origspace</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l03071"></a>03071 {
<a name="l03072"></a>03072     <span class="keyword">static</span> <span class="keywordtype">float</span> default_osf[4][2] = {{0, 0}, {1, 0}, {1, 1}, {0, 1}};
<a name="l03073"></a>03073 
<a name="l03074"></a>03074     <a class="code" href="../../d8/d9c/structOrigSpaceLoop.html">OrigSpaceLoop</a> *lof_array = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ad32638299fdf4c22df6a6254add64780">loopData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a4760909f6caf8b85c680e664b979307c">CD_ORIGSPACE_MLOOP</a>);
<a name="l03075"></a>03075     <a class="code" href="../../d8/d9c/structOrigSpaceLoop.html">OrigSpaceLoop</a> *lof;
<a name="l03076"></a>03076     <span class="keyword">const</span> <span class="keywordtype">int</span> numpoly = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a316a9297495999cd00e5fa1107c67efd">getNumPolys</a>(dm);
<a name="l03077"></a>03077     <span class="comment">// const int numloop = dm-&gt;getNumLoops(dm);</span>
<a name="l03078"></a>03078     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab8b054b009b29543deee65428097ee83">getPolyArray</a>(dm);
<a name="l03079"></a>03079     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l03080"></a>03080 
<a name="l03081"></a>03081     <span class="keywordflow">for</span> (i = 0; i &lt; numpoly; i++, mp++) {
<a name="l03082"></a>03082         <span class="comment">/* only quads/tri&#39;s for now */</span>
<a name="l03083"></a>03083         <span class="keywordflow">if</span> (mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> == 3 || mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> == 4) {
<a name="l03084"></a>03084             lof = lof_array + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l03085"></a>03085             <span class="keywordflow">for</span> (j = 0; j &lt; mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, lof++) {
<a name="l03086"></a>03086                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(lof-&gt;<a class="code" href="../../d8/d9c/structOrigSpaceLoop.html#ad03a01f772538ecf5bbc663097e2eab2">uv</a>, default_osf[j]);
<a name="l03087"></a>03087             }
<a name="l03088"></a>03088         }
<a name="l03089"></a>03089     }
<a name="l03090"></a>03090 
<a name="l03091"></a>03091     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#af38d7806eaa66f67c9a2c00121f9d4a1">dirty</a> |= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#af5d2d5fad496bc75bcbfa56999d8061aa011d123155855e8ed0e1bd3e8ffc21e5">DM_DIRTY_TESS_CDLAYERS</a>;
<a name="l03092"></a>03092 }
<a name="l03093"></a>03093 
<a name="l03094"></a>03094 
<a name="l03095"></a>03095 
<a name="l03096"></a>03096 <span class="comment">/* derivedmesh info printing function,</span>
<a name="l03097"></a>03097 <span class="comment"> * to help track down differences DM output */</span>
<a name="l03098"></a>03098 
<a name="l03099"></a>03099 <span class="preprocessor">#ifndef NDEBUG</span>
<a name="l03100"></a>03100 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/BLI__dynstr_8h.html" title="A dynamically sized string ADT.">BLI_dynstr.h</a>&quot;</span>
<a name="l03101"></a>03101 
<a name="l03102"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">03102</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(<a class="code" href="../../d4/de5/structDynStr.html">DynStr</a> *dynstr, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">void</span> *(*getElemDataArray)(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *, <span class="keywordtype">int</span>))
<a name="l03103"></a>03103 {
<a name="l03104"></a>03104     <span class="keywordtype">int</span> type;
<a name="l03105"></a>03105 
<a name="l03106"></a>03106     <span class="keywordflow">for</span> (type = 0; type &lt; <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8d7a084c61d95b955d4821b87eef6c7e">CD_NUMTYPES</a>; type++) {
<a name="l03107"></a>03107         <span class="comment">/* note: doesnt account for multiple layers */</span>
<a name="l03108"></a>03108         <span class="keywordtype">void</span> *pt = getElemDataArray(dm, type);
<a name="l03109"></a>03109         <span class="keywordflow">if</span> (pt) {
<a name="l03110"></a>03110             <span class="keyword">const</span> <span class="keywordtype">char</span> *name = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a98086f24aec0b94d18904d56760656cc">CustomData_layertype_name</a>(type);
<a name="l03111"></a>03111             <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab0c12e026f263d0d8bfd11a85cc93d00">CustomData_sizeof</a>(type);
<a name="l03112"></a>03112             <span class="keyword">const</span> <span class="keywordtype">char</span> *structname;
<a name="l03113"></a>03113             <span class="keywordtype">int</span> structnum;
<a name="l03114"></a>03114             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7b2101530260dda182a08c6f4b893e3b">CustomData_file_write_info</a>(type, &amp;structname, &amp;structnum);
<a name="l03115"></a>03115             <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr,
<a name="l03116"></a>03116                                <span class="stringliteral">&quot;        dict(name=&#39;%s&#39;, struct=&#39;%s&#39;, type=%d, ptr=&#39;%p&#39;, elem=%d, length=%d),\n&quot;</span>,
<a name="l03117"></a>03117                                name, structname, type, (<span class="keywordtype">void</span> *)pt, size, (<span class="keywordtype">int</span>)(<a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(pt) / size));
<a name="l03118"></a>03118         }
<a name="l03119"></a>03119     }
<a name="l03120"></a>03120 }
<a name="l03121"></a>03121 
<a name="l03122"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a5918163bd4aba6145407c3c2b9e98f00">03122</a> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a5918163bd4aba6145407c3c2b9e98f00">DM_debug_info</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l03123"></a>03123 {
<a name="l03124"></a>03124     <a class="code" href="../../d4/de5/structDynStr.html">DynStr</a> *dynstr= <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#ae83ee20abb290558ce2e8f151ed54227">BLI_dynstr_new</a>();
<a name="l03125"></a>03125     <span class="keywordtype">char</span> *ret;
<a name="l03126"></a>03126     <span class="keyword">const</span> <span class="keywordtype">char</span> *tstr;
<a name="l03127"></a>03127 
<a name="l03128"></a>03128     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;{\n&quot;</span>);
<a name="l03129"></a>03129     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;ptr&#39;: &#39;%p&#39;,\n&quot;</span>, (<span class="keywordtype">void</span> *)dm);
<a name="l03130"></a>03130     <span class="keywordflow">switch</span> (dm-&gt;type) {
<a name="l03131"></a>03131         <span class="keywordflow">case</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad39bfabfeccc5364d4b2828dbfb09131">DM_TYPE_CDDM</a>:     tstr = <span class="stringliteral">&quot;DM_TYPE_CDDM&quot;</span>;     <span class="keywordflow">break</span>;
<a name="l03132"></a>03132         <span class="keywordflow">case</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefa6ab3966d014cf244418874be6a8a503a">DM_TYPE_EDITBMESH</a>: tstr = <span class="stringliteral">&quot;DM_TYPE_EDITMESH&quot;</span>;  <span class="keywordflow">break</span>;
<a name="l03133"></a>03133         <span class="keywordflow">case</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aea838fd8bdcc9862088f92645d3c1fefad66ecfdb37d7171c8980b9ab11232730">DM_TYPE_CCGDM</a>:    tstr = <span class="stringliteral">&quot;DM_TYPE_CCGDM&quot;</span>;     <span class="keywordflow">break</span>;
<a name="l03134"></a>03134         <span class="keywordflow">default</span>:               tstr = <span class="stringliteral">&quot;UNKNOWN&quot;</span>;           <span class="keywordflow">break</span>;
<a name="l03135"></a>03135     }
<a name="l03136"></a>03136     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;type&#39;: &#39;%s&#39;,\n&quot;</span>, tstr);
<a name="l03137"></a>03137     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;numVertData&#39;: %d,\n&quot;</span>, dm-&gt;numVertData);
<a name="l03138"></a>03138     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;numEdgeData&#39;: %d,\n&quot;</span>, dm-&gt;numEdgeData);
<a name="l03139"></a>03139     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;numTessFaceData&#39;: %d,\n&quot;</span>, dm-&gt;numTessFaceData);
<a name="l03140"></a>03140     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;numPolyData&#39;: %d,\n&quot;</span>, dm-&gt;numPolyData);
<a name="l03141"></a>03141     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;deformedOnly&#39;: %d,\n&quot;</span>, dm-&gt;deformedOnly);
<a name="l03142"></a>03142 
<a name="l03143"></a>03143     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;vertexLayers&#39;: (\n&quot;</span>);
<a name="l03144"></a>03144     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(dynstr, dm, dm-&gt;getVertDataArray);
<a name="l03145"></a>03145     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    ),\n&quot;</span>);
<a name="l03146"></a>03146 
<a name="l03147"></a>03147     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;loopLayers&#39;: (\n&quot;</span>);
<a name="l03148"></a>03148     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(dynstr, dm, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#ac13bcba0ff94c0a387fc156b613954dc">DM_get_loop_data_layer</a>);
<a name="l03149"></a>03149     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    ),\n&quot;</span>);
<a name="l03150"></a>03150 
<a name="l03151"></a>03151     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;edgeLayers&#39;: (\n&quot;</span>);
<a name="l03152"></a>03152     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(dynstr, dm, dm-&gt;getEdgeDataArray);
<a name="l03153"></a>03153     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    ),\n&quot;</span>);
<a name="l03154"></a>03154 
<a name="l03155"></a>03155     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;tessFaceLayers&#39;: (\n&quot;</span>);
<a name="l03156"></a>03156     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(dynstr, dm, dm-&gt;getTessFaceDataArray);
<a name="l03157"></a>03157     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    ),\n&quot;</span>);
<a name="l03158"></a>03158 
<a name="l03159"></a>03159     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    &#39;polyLayers&#39;: (\n&quot;</span>);
<a name="l03160"></a>03160     <a class="code" href="../../db/d40/DerivedMesh_8c.html#ad1e4d894fbf90f206010f5eb93fa1f1b">dm_debug_info_layers</a>(dynstr, dm, <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a134ed8d7ec1c59a8d65cf1f8899123a2">DM_get_poly_data_layer</a>);
<a name="l03161"></a>03161     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;    ),\n&quot;</span>);
<a name="l03162"></a>03162 
<a name="l03163"></a>03163     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a5220af66d1325c122e7276140580b873">BLI_dynstr_appendf</a>(dynstr, <span class="stringliteral">&quot;}\n&quot;</span>);
<a name="l03164"></a>03164 
<a name="l03165"></a>03165     ret = <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a4ec5498b239c83c6657f206d2f2f4968">BLI_dynstr_get_cstring</a>(dynstr);
<a name="l03166"></a>03166     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a3687f0d324bc2026a013872ce32d157a">BLI_dynstr_free</a>(dynstr);
<a name="l03167"></a>03167     <span class="keywordflow">return</span> ret;
<a name="l03168"></a>03168 }
<a name="l03169"></a>03169 
<a name="l03170"></a><a class="code" href="../../db/d40/DerivedMesh_8c.html#a4335d1b5c403fce714be28717602f4a7">03170</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a4335d1b5c403fce714be28717602f4a7">DM_debug_print</a>(<a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm)
<a name="l03171"></a>03171 {
<a name="l03172"></a>03172     <span class="keywordtype">char</span> *<a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a5918163bd4aba6145407c3c2b9e98f00">DM_debug_info</a>(dm);
<a name="l03173"></a>03173     puts(str);
<a name="l03174"></a>03174     fflush(stdout);
<a name="l03175"></a>03175     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(str);
<a name="l03176"></a>03176 }
<a name="l03177"></a>03177 
<a name="l03178"></a>03178 <span class="preprocessor">#endif </span><span class="comment">/* NDEBUG */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:12 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
