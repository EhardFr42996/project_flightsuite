<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: fcurve.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">fcurve.c</div>  </div>
</div>
<div class="contents">
<a href="../../db/d17/fcurve_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2009 Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Joshua Leung (full recode)</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dba/BKE__fcurve_8h.html">BKE_fcurve.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span> 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d76/BPY__extern_8h.html">BPY_extern.h</a>&quot;</span> 
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">00066</a> <span class="preprocessor">#define SMALL -1.0e-10</span>
<a name="l00067"></a><a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define SELECT 1</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069 <span class="comment">/* ************************** Data-Level Functions ************************* */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* ---------------------- Freeing --------------------------- */</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="comment">/* Frees the F-Curve itself too, so make sure BLI_remlink is called before calling this... */</span>
<a name="l00074"></a><a class="code" href="../../db/d17/fcurve_8c.html#a9c5c6768eb893154c7fc69af4abd9ba2">00074</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a0d147bf242aadd56249b4da00fdb19d8">free_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu) 
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l00077"></a>00077         <span class="keywordflow">return</span>;
<a name="l00078"></a>00078     
<a name="l00079"></a>00079     <span class="comment">/* free curve data */</span>
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (fcu) {
<a name="l00081"></a>00081         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>);
<a name="l00082"></a>00082         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>);
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084     
<a name="l00085"></a>00085     <span class="comment">/* free RNA-path, as this were allocated when getting the path string */</span>
<a name="l00086"></a>00086     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>)
<a name="l00087"></a>00087         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>);
<a name="l00088"></a>00088     
<a name="l00089"></a>00089     <span class="comment">/* free extra data - i.e. modifiers, and driver */</span>
<a name="l00090"></a>00090     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa920352dd2079f3978b595c960e63d24">fcurve_free_driver</a>(fcu);
<a name="l00091"></a>00091     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ada226703127f86a28c14e4fcc807b0e6">free_fmodifiers</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>);
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     <span class="comment">/* free f-curve itself */</span>
<a name="l00094"></a>00094     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu);
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">/* Frees a list of F-Curves */</span>
<a name="l00098"></a><a class="code" href="../../db/d17/fcurve_8c.html#ab62d82f0242ead6ce4d83cf4e5d26774">00098</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab62d82f0242ead6ce4d83cf4e5d26774">free_fcurves</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *list)
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, *fcn;
<a name="l00101"></a>00101     
<a name="l00102"></a>00102     <span class="comment">/* sanity check */</span>
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (list == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00104"></a>00104         <span class="keywordflow">return</span>;
<a name="l00105"></a>00105         
<a name="l00106"></a>00106     <span class="comment">/* free data - no need to call remlink before freeing each curve, </span>
<a name="l00107"></a>00107 <span class="comment">     * as we store reference to next, and freeing only touches the curve</span>
<a name="l00108"></a>00108 <span class="comment">     * it&#39;s given</span>
<a name="l00109"></a>00109 <span class="comment">     */</span>
<a name="l00110"></a>00110     <span class="keywordflow">for</span> (fcu= list-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcn) {
<a name="l00111"></a>00111         fcn= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>;
<a name="l00112"></a>00112         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a0d147bf242aadd56249b4da00fdb19d8">free_fcurve</a>(fcu);
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114     
<a name="l00115"></a>00115     <span class="comment">/* clear pointers just in case */</span>
<a name="l00116"></a>00116     list-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= list-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00117"></a>00117 }   
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">/* ---------------------- Copy --------------------------- */</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/* duplicate an F-Curve */</span>
<a name="l00122"></a><a class="code" href="../../db/d17/fcurve_8c.html#aec5b20bdb48edfa06b689d38afbd102c">00122</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae2aca464f2e35470877917876a933472">copy_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu_d;
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     <span class="comment">/* sanity check */</span>
<a name="l00127"></a>00127     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00128"></a>00128         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00129"></a>00129         
<a name="l00130"></a>00130     <span class="comment">/* make a copy */</span>
<a name="l00131"></a>00131     fcu_d= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(fcu);
<a name="l00132"></a>00132     
<a name="l00133"></a>00133     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>= fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a92d052d42d902b2a553eb972aec7caba">prev</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00134"></a>00134     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="comment">/* copy curve data */</span>
<a name="l00137"></a>00137     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>);
<a name="l00138"></a>00138     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>);
<a name="l00139"></a>00139     
<a name="l00140"></a>00140     <span class="comment">/* copy rna-path */</span>
<a name="l00141"></a>00141     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>);
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     <span class="comment">/* copy driver */</span>
<a name="l00144"></a>00144     fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a323c524f60e3c9aa2a427f3f897e591c">fcurve_copy_driver</a>(fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>);
<a name="l00145"></a>00145     
<a name="l00146"></a>00146     <span class="comment">/* copy modifiers */</span>
<a name="l00147"></a>00147     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a95962d86693b5a728216f9e2ba797cdc">copy_fmodifiers</a>(&amp;fcu_d-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>, &amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>);
<a name="l00148"></a>00148     
<a name="l00149"></a>00149     <span class="comment">/* return new data */</span>
<a name="l00150"></a>00150     <span class="keywordflow">return</span> fcu_d;
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">/* duplicate a list of F-Curves */</span>
<a name="l00154"></a><a class="code" href="../../db/d17/fcurve_8c.html#a73ae7909c6fa074a6ac39cf13cfa27c5">00154</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a73ae7909c6fa074a6ac39cf13cfa27c5">copy_fcurves</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *dst, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *src)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *dfcu, *sfcu;
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <span class="comment">/* sanity checks */</span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dst, src))
<a name="l00160"></a>00160         <span class="keywordflow">return</span>;
<a name="l00161"></a>00161     
<a name="l00162"></a>00162     <span class="comment">/* clear destination list first */</span>
<a name="l00163"></a>00163     dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= dst-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     <span class="comment">/* copy one-by-one */</span>
<a name="l00166"></a>00166     <span class="keywordflow">for</span> (sfcu= src-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sfcu; sfcu= sfcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00167"></a>00167         dfcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae2aca464f2e35470877917876a933472">copy_fcurve</a>(sfcu);
<a name="l00168"></a>00168         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(dst, dfcu);
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 <span class="comment">/* ----------------- Finding F-Curves -------------------------- */</span>
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="comment">/* high level function to get an fcurve from C without having the rna */</span>
<a name="l00175"></a><a class="code" href="../../db/d17/fcurve_8c.html#abc869f8fb970f8abdf74254ad98bb936">00175</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a28ac16344887a931a8284227129bca8f">id_data_find_fcurve</a>(<a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../d5/d61/structStructRNA.html">StructRNA</a> *type, <span class="keyword">const</span> <span class="keywordtype">char</span> *prop_name, <span class="keywordtype">int</span> index, <span class="keywordtype">char</span> *driven)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177     <span class="comment">/* anim vars */</span>
<a name="l00178"></a>00178     <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(<span class="keywordtype">id</span>);
<a name="l00179"></a>00179     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">/* rna vars */</span>
<a name="l00182"></a>00182     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> ptr;
<a name="l00183"></a>00183     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l00184"></a>00184     <span class="keywordtype">char</span> *path;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (driven)
<a name="l00187"></a>00187         *driven = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00188"></a>00188     
<a name="l00189"></a>00189     <span class="comment">/* only use the current action ??? */</span>
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, adt, adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>))
<a name="l00191"></a>00191         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00192"></a>00192     
<a name="l00193"></a>00193     <a class="code" href="../../d3/d10/rna__access_8c.html#a1f8fb80da9a6450a51ab2e9b97264f01">RNA_pointer_create</a>(<span class="keywordtype">id</span>, type, data, &amp;ptr);
<a name="l00194"></a>00194     prop = <a class="code" href="../../d3/d10/rna__access_8c.html#a58253ea33cfb6f09202907a524090aab">RNA_struct_find_property</a>(&amp;ptr, prop_name);
<a name="l00195"></a>00195     
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (prop) {
<a name="l00197"></a>00197         path= <a class="code" href="../../d3/d10/rna__access_8c.html#a66bdb30aeb21c0607ca3a0453e1d99eb">RNA_path_from_ID_to_property</a>(&amp;ptr, prop);
<a name="l00198"></a>00198             
<a name="l00199"></a>00199         <span class="keywordflow">if</span> (path) {
<a name="l00200"></a>00200             <span class="comment">/* animation takes priority over drivers */</span>
<a name="l00201"></a>00201             <span class="keywordflow">if</span> ((adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>) &amp;&amp; (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>))
<a name="l00202"></a>00202                 fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>, path, index);
<a name="l00203"></a>00203             
<a name="l00204"></a>00204             <span class="comment">/* if not animated, check if driven */</span>
<a name="l00205"></a>00205             <span class="keywordflow">if</span> ((fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#aaca565f031ee1209087422d8a5d77769">drivers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l00206"></a>00206                 fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#aaca565f031ee1209087422d8a5d77769">drivers</a>, path, index);
<a name="l00207"></a>00207                 <span class="keywordflow">if</span> (fcu &amp;&amp; driven)
<a name="l00208"></a>00208                     *driven = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00209"></a>00209                 fcu = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00210"></a>00210             }
<a name="l00211"></a>00211             
<a name="l00212"></a>00212             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(path);
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">return</span> fcu;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="comment">/* Find the F-Curve affecting the given RNA-access path + index, in the list of F-Curves provided */</span>
<a name="l00221"></a><a class="code" href="../../db/d17/fcurve_8c.html#a38d8323329bf4cc5a1e68a465094e959">00221</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *list, <span class="keyword">const</span> <span class="keywordtype">char</span> rna_path[], <span class="keyword">const</span> <span class="keywordtype">int</span> array_index)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     <span class="comment">/* sanity checks */</span>
<a name="l00226"></a>00226     <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, list, rna_path) || (array_index &lt; 0) )
<a name="l00227"></a>00227         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     <span class="comment">/* check paths of curves, then array indices... */</span>
<a name="l00230"></a>00230     <span class="keywordflow">for</span> (fcu= list-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00231"></a>00231         <span class="comment">/* simple string-compare (this assumes that they have the same root...) */</span>
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a> &amp;&amp; !strcmp(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, rna_path)) {
<a name="l00233"></a>00233             <span class="comment">/* now check indices */</span>
<a name="l00234"></a>00234             <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad63b7b4ef28bdd8a212bd6e35e954208">array_index</a> == array_index)
<a name="l00235"></a>00235                 <span class="keywordflow">return</span> fcu;
<a name="l00236"></a>00236         }
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     
<a name="l00239"></a>00239     <span class="comment">/* return */</span>
<a name="l00240"></a>00240     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* quick way to loop over all fcurves of a given &#39;path&#39; */</span>
<a name="l00244"></a><a class="code" href="../../db/d17/fcurve_8c.html#ae660b8ae0facb2402f3fc0bfc1832be0">00244</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#ad52f31f1a6b08f5277744e89a7d76056">iter_step_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu_iter, <span class="keyword">const</span> <span class="keywordtype">char</span> rna_path[])
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <span class="comment">/* sanity checks */</span>
<a name="l00249"></a>00249     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu_iter, rna_path))
<a name="l00250"></a>00250         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="comment">/* check paths of curves, then array indices... */</span>
<a name="l00253"></a>00253     <span class="keywordflow">for</span> (fcu= fcu_iter; fcu; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00254"></a>00254         <span class="comment">/* simple string-compare (this assumes that they have the same root...) */</span>
<a name="l00255"></a>00255         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a> &amp;&amp; !strcmp(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, rna_path)) {
<a name="l00256"></a>00256             <span class="keywordflow">return</span> fcu;
<a name="l00257"></a>00257         }
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">/* return */</span>
<a name="l00261"></a>00261     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">/* Get list of LinkData&#39;s containing pointers to the F-Curves which control the types of data indicated </span>
<a name="l00265"></a>00265 <span class="comment"> * Lists...</span>
<a name="l00266"></a>00266 <span class="comment"> *  - dst: list of LinkData&#39;s matching the criteria returned. </span>
<a name="l00267"></a>00267 <span class="comment"> *    List must be freed after use, and is assumed to be empty when passed.</span>
<a name="l00268"></a>00268 <span class="comment"> *  - src: list of F-Curves to search through</span>
<a name="l00269"></a>00269 <span class="comment"> * Filters...</span>
<a name="l00270"></a>00270 <span class="comment"> *  - dataPrefix: i.e. &#39;pose.bones[&#39; or &#39;nodes[&#39;</span>
<a name="l00271"></a>00271 <span class="comment"> *  - dataName: name of entity within &quot;&quot; immediately following the prefix</span>
<a name="l00272"></a>00272 <span class="comment"> */</span>
<a name="l00273"></a><a class="code" href="../../db/d17/fcurve_8c.html#a9e899a0b3204fef671d8f1f51a71432f">00273</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a9e899a0b3204fef671d8f1f51a71432f">list_find_data_fcurves</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *dst, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *src, <span class="keyword">const</span> <span class="keywordtype">char</span> *dataPrefix, <span class="keyword">const</span> <span class="keywordtype">char</span> *dataName)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu;
<a name="l00276"></a>00276     <span class="keywordtype">int</span> matches = 0;
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <span class="comment">/* sanity checks */</span>
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dst, src, dataPrefix, dataName))
<a name="l00280"></a>00280         <span class="keywordflow">return</span> 0;
<a name="l00281"></a>00281     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((dataPrefix[0] == 0) || (dataName[0] == 0))
<a name="l00282"></a>00282         <span class="keywordflow">return</span> 0;
<a name="l00283"></a>00283     
<a name="l00284"></a>00284     <span class="comment">/* search each F-Curve one by one */</span>
<a name="l00285"></a>00285     <span class="keywordflow">for</span> (fcu= src-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; fcu; fcu= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a381b65464374cad861b80c44b9ae0759">next</a>) {
<a name="l00286"></a>00286         <span class="comment">/* check if quoted string matches the path */</span>
<a name="l00287"></a>00287         <span class="keywordflow">if</span> ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>) &amp;&amp; strstr(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, dataPrefix)) {
<a name="l00288"></a>00288             <span class="keywordtype">char</span> *quotedName= <a class="code" href="../../d3/db3/BLI__string_8h.html#a59a96d992ef2c92f5c92b197c7fb2f9b">BLI_getQuotedStr</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a4b841fbabd01a3fd639b7672dcc1da7a">rna_path</a>, dataPrefix);
<a name="l00289"></a>00289             
<a name="l00290"></a>00290             <span class="keywordflow">if</span> (quotedName) {
<a name="l00291"></a>00291                 <span class="comment">/* check if the quoted name matches the required name */</span>
<a name="l00292"></a>00292                 <span class="keywordflow">if</span> (strcmp(quotedName, dataName) == 0) {
<a name="l00293"></a>00293                     <a class="code" href="../../d0/df2/structLinkData.html">LinkData</a> *ld= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/df2/structLinkData.html">LinkData</a>), <span class="stringliteral">&quot;list_find_data_fcurves&quot;</span>);
<a name="l00294"></a>00294                     
<a name="l00295"></a>00295                     ld-&gt;<a class="code" href="../../d0/df2/structLinkData.html#a3591ce65917fa263d5e3c0586e90bf40">data</a>= fcu;
<a name="l00296"></a>00296                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(dst, ld);
<a name="l00297"></a>00297                     
<a name="l00298"></a>00298                     matches++;
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300                 
<a name="l00301"></a>00301                 <span class="comment">/* always free the quoted string, since it needs freeing */</span>
<a name="l00302"></a>00302                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(quotedName);
<a name="l00303"></a>00303             }
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     
<a name="l00307"></a>00307     <span class="comment">/* return the number of matches */</span>
<a name="l00308"></a>00308     <span class="keywordflow">return</span> matches;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="../../db/d17/fcurve_8c.html#a7f1aba57441b87fb5790882a55a27333">00311</a> <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#af9576b956927514758a9a308ce2e0e81">rna_get_fcurve</a> (<a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *ptr, <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop, <span class="keywordtype">int</span> rnaindex, <a class="code" href="../../d1/d48/structbAction.html">bAction</a> **action, <span class="keywordtype">int</span> *driven)
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313     <a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00314"></a>00314     
<a name="l00315"></a>00315     *driven= 0;
<a name="l00316"></a>00316     
<a name="l00317"></a>00317     <span class="comment">/* there must be some RNA-pointer + property combon */</span>
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (prop &amp;&amp; ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a> &amp;&amp; <a class="code" href="../../d3/d10/rna__access_8c.html#a63b99969d7f69abd7809858a2687ae1c">RNA_property_animateable</a>(ptr, prop)) {
<a name="l00319"></a>00319         <a class="code" href="../../d1/d5c/structAnimData.html">AnimData</a> *adt= <a class="code" href="../../dc/d51/BKE__animsys_8h.html#aa3c6a97f5185329334a481908e7cf985">BKE_animdata_from_id</a>(ptr-&gt;<a class="code" href="../../dd/d80/structPointerRNA.html#a7afa52885727738cb03bbdf46e808e1b">id</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>);
<a name="l00320"></a>00320         <span class="keywordtype">char</span> *path;
<a name="l00321"></a>00321         
<a name="l00322"></a>00322         <span class="keywordflow">if</span> (adt) {
<a name="l00323"></a>00323             <span class="keywordflow">if</span> ((adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a> &amp;&amp; adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) || (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#aaca565f031ee1209087422d8a5d77769">drivers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l00324"></a>00324                 <span class="comment">/* XXX this function call can become a performance bottleneck */</span>
<a name="l00325"></a>00325                 path= <a class="code" href="../../d3/d10/rna__access_8c.html#a66bdb30aeb21c0607ca3a0453e1d99eb">RNA_path_from_ID_to_property</a>(ptr, prop);
<a name="l00326"></a>00326                 
<a name="l00327"></a>00327                 <span class="keywordflow">if</span> (path) {
<a name="l00328"></a>00328                     <span class="comment">/* animation takes priority over drivers */</span>
<a name="l00329"></a>00329                     <span class="keywordflow">if</span> (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a> &amp;&amp; adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l00330"></a>00330                         fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>-&gt;<a class="code" href="../../d1/d48/structbAction.html#a17c9f9250f377305171640e7a4aa7666">curves</a>, path, rnaindex);
<a name="l00331"></a>00331                     
<a name="l00332"></a>00332                     <span class="comment">/* if not animated, check if driven */</span>
<a name="l00333"></a>00333                     <span class="keywordflow">if</span> (!fcu &amp;&amp; (adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#aaca565f031ee1209087422d8a5d77769">drivers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l00334"></a>00334                         fcu= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ec021af91abcfc2a7fcaea5ba7a2994">list_find_fcurve</a>(&amp;adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#aaca565f031ee1209087422d8a5d77769">drivers</a>, path, rnaindex);
<a name="l00335"></a>00335                         
<a name="l00336"></a>00336                         <span class="keywordflow">if</span> (fcu)
<a name="l00337"></a>00337                             *driven= 1;
<a name="l00338"></a>00338                     }
<a name="l00339"></a>00339                     
<a name="l00340"></a>00340                     <span class="keywordflow">if</span> (fcu &amp;&amp; action)
<a name="l00341"></a>00341                         *action= adt-&gt;<a class="code" href="../../d1/d5c/structAnimData.html#a14a8b84cc330ffddb772fe4a224eba0a">action</a>;
<a name="l00342"></a>00342                     
<a name="l00343"></a>00343                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(path);
<a name="l00344"></a>00344                 }
<a name="l00345"></a>00345             }
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     <span class="keywordflow">return</span> fcu;
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="comment">/* ----------------- Finding Keyframes/Extents -------------------------- */</span>
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="comment">/* threshold for binary-searching keyframes - threshold here should be good enough for now, but should become userpref */</span>
<a name="l00355"></a><a class="code" href="../../db/d17/fcurve_8c.html#aaa1b311c938eb5bedf885f56ce40aeef">00355</a> <span class="preprocessor">#define BEZT_BINARYSEARCH_THRESH    0.01f </span><span class="comment">/* was 0.00001, but giving errors */</span>
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 <span class="comment">/* Binary search algorithm for finding where to insert BezTriple. (for use by insert_bezt_fcurve)</span>
<a name="l00358"></a>00358 <span class="comment"> * Returns the index to insert at (data already at that index will be offset if replace is 0)</span>
<a name="l00359"></a>00359 <span class="comment"> */</span>
<a name="l00360"></a><a class="code" href="../../db/d17/fcurve_8c.html#a54b7f41817fea747e9e48c7dffdcfbb9">00360</a> <span class="keywordtype">int</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a57be9969692b1bd993d12fa9f2c39bf2">binarysearch_bezt_index</a> (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> <a class="code" href="../../d2/d41/classarray.html">array</a>[], <span class="keywordtype">float</span> frame, <span class="keywordtype">int</span> arraylen, <span class="keywordtype">short</span> *replace)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362     <span class="keywordtype">int</span> start=0, end=arraylen;
<a name="l00363"></a>00363     <span class="keywordtype">int</span> loopbreaker= 0, maxloop= arraylen * 2;
<a name="l00364"></a>00364     
<a name="l00365"></a>00365     <span class="comment">/* initialize replace-flag first */</span>
<a name="l00366"></a>00366     *replace= 0;
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     <span class="comment">/* sneaky optimisations (don&#39;t go through searching process if...):</span>
<a name="l00369"></a>00369 <span class="comment">     *  - keyframe to be added is to be added out of current bounds</span>
<a name="l00370"></a>00370 <span class="comment">     *  - keyframe to be added would replace one of the existing ones on bounds</span>
<a name="l00371"></a>00371 <span class="comment">     */</span>
<a name="l00372"></a>00372     <span class="keywordflow">if</span> ((arraylen &lt;= 0) || (array == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00373"></a>00373         printf(<span class="stringliteral">&quot;Warning: binarysearch_bezt_index() encountered invalid array\n&quot;</span>);
<a name="l00374"></a>00374         <span class="keywordflow">return</span> 0;
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     <span class="keywordflow">else</span> {
<a name="l00377"></a>00377         <span class="comment">/* check whether to add before/after/on */</span>
<a name="l00378"></a>00378         <span class="keywordtype">float</span> framenum;
<a name="l00379"></a>00379         
<a name="l00380"></a>00380         <span class="comment">/* &#39;First&#39; Keyframe (when only one keyframe, this case is used) */</span>
<a name="l00381"></a>00381         framenum= array[0].<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00382"></a>00382         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aec275dde8d6dd7e9a49fb107215749e7">IS_EQT</a>(frame, framenum, <a class="code" href="../../db/d17/fcurve_8c.html#aaa1b311c938eb5bedf885f56ce40aeef">BEZT_BINARYSEARCH_THRESH</a>)) {
<a name="l00383"></a>00383             *replace = 1;
<a name="l00384"></a>00384             <span class="keywordflow">return</span> 0;
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame &lt; framenum)
<a name="l00387"></a>00387             <span class="keywordflow">return</span> 0;
<a name="l00388"></a>00388             
<a name="l00389"></a>00389         <span class="comment">/* &#39;Last&#39; Keyframe */</span>
<a name="l00390"></a>00390         framenum= array[(arraylen-1)].vec[1][0];
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aec275dde8d6dd7e9a49fb107215749e7">IS_EQT</a>(frame, framenum, <a class="code" href="../../db/d17/fcurve_8c.html#aaa1b311c938eb5bedf885f56ce40aeef">BEZT_BINARYSEARCH_THRESH</a>)) {
<a name="l00392"></a>00392             *replace= 1;
<a name="l00393"></a>00393             <span class="keywordflow">return</span> (arraylen - 1);
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame &gt; framenum)
<a name="l00396"></a>00396             <span class="keywordflow">return</span> arraylen;
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     
<a name="l00399"></a>00399     
<a name="l00400"></a>00400     <span class="comment">/* most of the time, this loop is just to find where to put it</span>
<a name="l00401"></a>00401 <span class="comment">     * &#39;loopbreaker&#39; is just here to prevent infinite loops </span>
<a name="l00402"></a>00402 <span class="comment">     */</span>
<a name="l00403"></a>00403     <span class="keywordflow">for</span> (loopbreaker=0; (start &lt;= end) &amp;&amp; (loopbreaker &lt; maxloop); loopbreaker++) {
<a name="l00404"></a>00404         <span class="comment">/* compute and get midpoint */</span>
<a name="l00405"></a>00405         <span class="keywordtype">int</span> mid = start + ((end - start) / 2);  <span class="comment">/* we calculate the midpoint this way to avoid int overflows... */</span>
<a name="l00406"></a>00406         <span class="keywordtype">float</span> midfra= array[mid].<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00407"></a>00407         
<a name="l00408"></a>00408         <span class="comment">/* check if exactly equal to midpoint */</span>
<a name="l00409"></a>00409         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aec275dde8d6dd7e9a49fb107215749e7">IS_EQT</a>(frame, midfra, <a class="code" href="../../db/d17/fcurve_8c.html#aaa1b311c938eb5bedf885f56ce40aeef">BEZT_BINARYSEARCH_THRESH</a>)) {
<a name="l00410"></a>00410             *replace = 1;
<a name="l00411"></a>00411             <span class="keywordflow">return</span> mid;
<a name="l00412"></a>00412         }
<a name="l00413"></a>00413         
<a name="l00414"></a>00414         <span class="comment">/* repeat in upper/lower half */</span>
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (frame &gt; midfra)
<a name="l00416"></a>00416             start= mid + 1;
<a name="l00417"></a>00417         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame &lt; midfra)
<a name="l00418"></a>00418             end= mid - 1;
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     
<a name="l00421"></a>00421     <span class="comment">/* print error if loop-limit exceeded */</span>
<a name="l00422"></a>00422     <span class="keywordflow">if</span> (loopbreaker == (maxloop-1)) {
<a name="l00423"></a>00423         printf(<span class="stringliteral">&quot;Error: binarysearch_bezt_index() was taking too long\n&quot;</span>);
<a name="l00424"></a>00424         
<a name="l00425"></a>00425         <span class="comment">// include debug info </span>
<a name="l00426"></a>00426         printf(<span class="stringliteral">&quot;\tround = %d: start = %d, end = %d, arraylen = %d\n&quot;</span>, loopbreaker, start, end, arraylen);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     
<a name="l00429"></a>00429     <span class="comment">/* not found, so return where to place it */</span>
<a name="l00430"></a>00430     <span class="keywordflow">return</span> start;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="comment">/* ...................................... */</span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="comment">/* helper for calc_fcurve_* functions -&gt; find first and last BezTriple to be used */</span>
<a name="l00436"></a><a class="code" href="../../db/d17/fcurve_8c.html#abb26f3639752ce48dfc01dcda15dfb9a">00436</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d17/fcurve_8c.html#abb26f3639752ce48dfc01dcda15dfb9a">get_fcurve_end_keyframes</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> **first, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> **last,
<a name="l00437"></a>00437                                       <span class="keyword">const</span> <span class="keywordtype">short</span> do_sel_only)
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439     <span class="comment">/* init outputs */</span>
<a name="l00440"></a>00440     *first = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00441"></a>00441     *last = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00442"></a>00442     
<a name="l00443"></a>00443     <span class="comment">/* sanity checks */</span>
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00445"></a>00445         <span class="keywordflow">return</span>;
<a name="l00446"></a>00446     
<a name="l00447"></a>00447     <span class="comment">/* only include selected items? */</span>
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (do_sel_only) {
<a name="l00449"></a>00449         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00450"></a>00450         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00451"></a>00451         
<a name="l00452"></a>00452         <span class="comment">/* find first selected */</span>
<a name="l00453"></a>00453         bezt = fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>;
<a name="l00454"></a>00454         <span class="keywordflow">for</span> (i=0; i &lt; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>; bezt++, i++) {
<a name="l00455"></a>00455             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(bezt)) {
<a name="l00456"></a>00456                 *first= bezt;
<a name="l00457"></a>00457                 <span class="keywordflow">break</span>;
<a name="l00458"></a>00458             }
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460         
<a name="l00461"></a>00461         <span class="comment">/* find last selected */</span>
<a name="l00462"></a>00462         bezt = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1fef132003aaa489d49a36768ffe0c01">ARRAY_LAST_ITEM</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>), fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>);
<a name="l00463"></a>00463         <span class="keywordflow">for</span> (i=0; i &lt; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>; bezt--, i++) {
<a name="l00464"></a>00464             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(bezt)) {
<a name="l00465"></a>00465                 *last= bezt;
<a name="l00466"></a>00466                 <span class="keywordflow">break</span>;
<a name="l00467"></a>00467             }
<a name="l00468"></a>00468         }
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     <span class="keywordflow">else</span> {
<a name="l00471"></a>00471         <span class="comment">/* just full array */</span>
<a name="l00472"></a>00472         *first = fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>;
<a name="l00473"></a>00473         *last = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1fef132003aaa489d49a36768ffe0c01">ARRAY_LAST_ITEM</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>), fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>);
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475 }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 <span class="comment">/* Calculate the extents of F-Curve&#39;s data */</span>
<a name="l00479"></a><a class="code" href="../../db/d17/fcurve_8c.html#ae5a27c3aa3801791f494e4ad6de5e03b">00479</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab62340fb539169f192517de451b37d1d">calc_fcurve_bounds</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> *xmin, <span class="keywordtype">float</span> *xmax, <span class="keywordtype">float</span> *ymin, <span class="keywordtype">float</span> *ymax,
<a name="l00480"></a>00480                          <span class="keyword">const</span> <span class="keywordtype">short</span> do_sel_only)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482     <span class="keywordtype">float</span> xminv=999999999.0f, xmaxv=-999999999.0f;
<a name="l00483"></a>00483     <span class="keywordtype">float</span> yminv=999999999.0f, ymaxv=-999999999.0f;
<a name="l00484"></a>00484     <span class="keywordtype">short</span> foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00485"></a>00485     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00486"></a>00486     
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>) {
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00489"></a>00489             <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt_first= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *bezt_last= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00490"></a>00490             
<a name="l00491"></a>00491             <span class="keywordflow">if</span> (xmin || xmax) {
<a name="l00492"></a>00492                 <span class="comment">/* get endpoint keyframes */</span>
<a name="l00493"></a>00493                 <a class="code" href="../../db/d17/fcurve_8c.html#abb26f3639752ce48dfc01dcda15dfb9a">get_fcurve_end_keyframes</a>(fcu, &amp;bezt_first, &amp;bezt_last, do_sel_only);
<a name="l00494"></a>00494                 
<a name="l00495"></a>00495                 <span class="keywordflow">if</span> (bezt_first) {
<a name="l00496"></a>00496                     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(bezt_last != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00497"></a>00497                     
<a name="l00498"></a>00498                     xminv= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(xminv, bezt_first-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]);
<a name="l00499"></a>00499                     xmaxv= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(xmaxv, bezt_last-&gt;vec[1][0]);
<a name="l00500"></a>00500                 }
<a name="l00501"></a>00501             }
<a name="l00502"></a>00502             
<a name="l00503"></a>00503             <span class="comment">/* only loop over keyframes to find extents for values if needed */</span>
<a name="l00504"></a>00504             <span class="keywordflow">if</span> (ymin || ymax) { 
<a name="l00505"></a>00505                 <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00506"></a>00506                 
<a name="l00507"></a>00507                 <span class="keywordflow">for</span> (bezt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, i=0; i &lt; fcu-&gt;totvert; bezt++, i++) {
<a name="l00508"></a>00508                     <span class="keywordflow">if</span> ((do_sel_only == 0) || <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a30e90c4df6243a5254d5a1b61c5c8a9c">BEZSELECTED</a>(bezt)) {
<a name="l00509"></a>00509                         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] &lt; yminv)
<a name="l00510"></a>00510                             yminv= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00511"></a>00511                         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] &gt; ymaxv)
<a name="l00512"></a>00512                             ymaxv= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00513"></a>00513                         foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00514"></a>00514                     }
<a name="l00515"></a>00515                 }
<a name="l00516"></a>00516             }
<a name="l00517"></a>00517         }
<a name="l00518"></a>00518         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) {
<a name="l00519"></a>00519             <span class="comment">/* frame range can be directly calculated from end verts */</span>
<a name="l00520"></a>00520             <span class="keywordflow">if</span> (xmin || xmax) {
<a name="l00521"></a>00521                 xminv= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(xminv, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>[0].<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]);
<a name="l00522"></a>00522                 xmaxv= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(xmaxv, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>[fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1].<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]);
<a name="l00523"></a>00523             }
<a name="l00524"></a>00524             
<a name="l00525"></a>00525             <span class="comment">/* only loop over keyframes to find extents for values if needed */</span>
<a name="l00526"></a>00526             <span class="keywordflow">if</span> (ymin || ymax) {
<a name="l00527"></a>00527                 <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *fpt;
<a name="l00528"></a>00528                 
<a name="l00529"></a>00529                 <span class="keywordflow">for</span> (fpt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>, i=0; i &lt; fcu-&gt;totvert; fpt++, i++) {
<a name="l00530"></a>00530                     <span class="keywordflow">if</span> (fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1] &lt; yminv)
<a name="l00531"></a>00531                         yminv= fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l00532"></a>00532                     <span class="keywordflow">if</span> (fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1] &gt; ymaxv)
<a name="l00533"></a>00533                         ymaxv= fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                     foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00536"></a>00536                 }
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (foundvert) {
<a name="l00542"></a>00542         <span class="keywordflow">if</span> (xmin) *xmin= xminv;
<a name="l00543"></a>00543         <span class="keywordflow">if</span> (xmax) *xmax= xmaxv;
<a name="l00544"></a>00544         
<a name="l00545"></a>00545         <span class="keywordflow">if</span> (ymin) *ymin= yminv;
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (ymax) *ymax= ymaxv;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     <span class="keywordflow">else</span> {
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00550"></a>00550             printf(<span class="stringliteral">&quot;F-Curve calc bounds didn&#39;t find anything, so assuming minimum bounds of 1.0\n&quot;</span>);
<a name="l00551"></a>00551             
<a name="l00552"></a>00552         <span class="keywordflow">if</span> (xmin) *xmin= 0.0f;
<a name="l00553"></a>00553         <span class="keywordflow">if</span> (xmax) *xmax= 1.0f;
<a name="l00554"></a>00554         
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (ymin) *ymin= 0.0f;
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (ymax) *ymax= 1.0f;
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="comment">/* Calculate the extents of F-Curve&#39;s keyframes */</span>
<a name="l00561"></a><a class="code" href="../../db/d17/fcurve_8c.html#adf92660dc62072fa06745709ffc5d5e3">00561</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a3ae0d09406f4d940179d6208e74b08e5">calc_fcurve_range</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> *start, <span class="keywordtype">float</span> *end,
<a name="l00562"></a>00562                         <span class="keyword">const</span> <span class="keywordtype">short</span> do_sel_only, <span class="keyword">const</span> <span class="keywordtype">short</span> do_min_length)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>=999999999.0f, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>=-999999999.0f;
<a name="l00565"></a>00565     <span class="keywordtype">short</span> foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>) {
<a name="l00568"></a>00568         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00569"></a>00569             <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt_first= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *bezt_last= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00570"></a>00570             
<a name="l00571"></a>00571             <span class="comment">/* get endpoint keyframes */</span>
<a name="l00572"></a>00572             <a class="code" href="../../db/d17/fcurve_8c.html#abb26f3639752ce48dfc01dcda15dfb9a">get_fcurve_end_keyframes</a>(fcu, &amp;bezt_first, &amp;bezt_last, do_sel_only);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574             <span class="keywordflow">if</span> (bezt_first) {
<a name="l00575"></a>00575                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(bezt_last != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577                 min= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(min, bezt_first-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]);
<a name="l00578"></a>00578                 <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, bezt_last-&gt;vec[1][0]);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580                 foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00581"></a>00581             }
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) {
<a name="l00584"></a>00584             min= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(min, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>[0].<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]);
<a name="l00585"></a>00585             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>[fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1].<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587             foundvert= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589         
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (foundvert == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00593"></a>00593         min= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>= 0.0f;
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keywordflow">if</span> (do_min_length) {
<a name="l00597"></a>00597         <span class="comment">/* minimum length is 1 frame */</span>
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (min == <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>) {
<a name="l00599"></a>00599             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a> += 1.0f;
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     *start= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>;
<a name="l00604"></a>00604     *end= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="comment">/* ----------------- Status Checks -------------------------- */</span>
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="comment">/* Are keyframes on F-Curve of any use? </span>
<a name="l00610"></a>00610 <span class="comment"> * Usability of keyframes refers to whether they should be displayed,</span>
<a name="l00611"></a>00611 <span class="comment"> * and also whether they will have any influence on the final result.</span>
<a name="l00612"></a>00612 <span class="comment"> */</span>
<a name="l00613"></a><a class="code" href="../../db/d17/fcurve_8c.html#a81cb249f79dfadab3526fbcc9d7ad366">00613</a> <span class="keywordtype">short</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ac5fc7825c4f2c610ccc7ac591a6686d1">fcurve_are_keyframes_usable</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615     <span class="comment">/* F-Curve must exist */</span>
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00617"></a>00617         <span class="keywordflow">return</span> 0;
<a name="l00618"></a>00618         
<a name="l00619"></a>00619     <span class="comment">/* F-Curve must not have samples - samples are mutually exclusive of keyframes */</span>
<a name="l00620"></a>00620     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>)
<a name="l00621"></a>00621         <span class="keywordflow">return</span> 0;
<a name="l00622"></a>00622     
<a name="l00623"></a>00623     <span class="comment">/* if it has modifiers, none of these should &quot;drastically&quot; alter the curve */</span>
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00625"></a>00625         <a class="code" href="../../dc/d68/structFModifier.html">FModifier</a> *fcm;
<a name="l00626"></a>00626         
<a name="l00627"></a>00627         <span class="comment">/* check modifiers from last to first, as last will be more influential */</span>
<a name="l00628"></a>00628         <span class="comment">// TODO: optionally, only check modifier if it is the active one...</span>
<a name="l00629"></a>00629         <span class="keywordflow">for</span> (fcm = fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>; fcm; fcm = fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#aff8bd6357c375b26fd5537e6c20cdda0">prev</a>) {
<a name="l00630"></a>00630             <span class="comment">/* ignore if muted/disabled */</span>
<a name="l00631"></a>00631             <span class="keywordflow">if</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a8e34636c726c7caeb1b4050eb4ee5ce4">flag</a> &amp; (<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2bac65e1acd5607743a689fc1ddb90b97e9">FMODIFIER_FLAG_DISABLED</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a8c878df62ac6a462d95eae4813195e2ba1ff53e4dc66786f20c42f4b47460b9f5">FMODIFIER_FLAG_MUTED</a>))
<a name="l00632"></a>00632                 <span class="keywordflow">continue</span>;
<a name="l00633"></a>00633                 
<a name="l00634"></a>00634             <span class="comment">/* type checks */</span>
<a name="l00635"></a>00635             <span class="keywordflow">switch</span> (fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a2618b2144f7498de1afe54faa6692344">type</a>) {
<a name="l00636"></a>00636                 <span class="comment">/* clearly harmless - do nothing */</span>
<a name="l00637"></a>00637                 <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba0a9f871f719b71334e21fb78f83aa48d">FMODIFIER_TYPE_CYCLES</a>:
<a name="l00638"></a>00638                 <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba314c542c16a384de8c395fd2ae1d003b">FMODIFIER_TYPE_STEPPED</a>:
<a name="l00639"></a>00639                 <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba48f599ed4496ee02ee9a85d2c0df0044">FMODIFIER_TYPE_NOISE</a>:
<a name="l00640"></a>00640                     <span class="keywordflow">break</span>;
<a name="l00641"></a>00641                     
<a name="l00642"></a>00642                 <span class="comment">/* sometimes harmful - depending on whether they&#39;re &quot;additive&quot; or not */</span>
<a name="l00643"></a>00643                 <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba57fb312e27b01da48bd9a5eabb7bd506">FMODIFIER_TYPE_GENERATOR</a>:
<a name="l00644"></a>00644                 {
<a name="l00645"></a>00645                     <a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = (<a class="code" href="../../d6/d18/structFMod__Generator.html">FMod_Generator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00646"></a>00646                     
<a name="l00647"></a>00647                     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((data-&gt;<a class="code" href="../../d6/d18/structFMod__Generator.html#ac1b0aa418d935b68a8d116e9dc455b50">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>) == 0)
<a name="l00648"></a>00648                         <span class="keywordflow">return</span> 0;
<a name="l00649"></a>00649                 }
<a name="l00650"></a>00650                     <span class="keywordflow">break</span>;
<a name="l00651"></a>00651                 <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a780a87e4018e6dbc53e4dc812f83c97ba3f5c7902b0a8c0aafe94ab0835a06c18">FMODIFIER_TYPE_FN_GENERATOR</a>:
<a name="l00652"></a>00652                 {
<a name="l00653"></a>00653                     <a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = (<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html">FMod_FunctionGenerator</a> *)fcm-&gt;<a class="code" href="../../dc/d68/structFModifier.html#a68e8b157c9aa0a3984e0b772054c4416">data</a>;
<a name="l00654"></a>00654                     
<a name="l00655"></a>00655                     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> ((data-&gt;<a class="code" href="../../d6/d06/structFMod__FunctionGenerator.html#a6f19bb34b73d31bd11db6c3bc1826283">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a48b9cbf3285b63f5134db148f0e7eb9dab8b04a0f87a573d5c20d4fd447ac9934">FCM_GENERATOR_ADDITIVE</a>) == 0)
<a name="l00656"></a>00656                         <span class="keywordflow">return</span> 0;
<a name="l00657"></a>00657                 }
<a name="l00658"></a>00658                     <span class="keywordflow">break</span>;
<a name="l00659"></a>00659                     
<a name="l00660"></a>00660                 <span class="comment">/* always harmful - cannot allow */</span>
<a name="l00661"></a>00661                 <span class="keywordflow">default</span>:
<a name="l00662"></a>00662                     <span class="keywordflow">return</span> 0;
<a name="l00663"></a>00663             }
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     
<a name="l00667"></a>00667     <span class="comment">/* keyframes are usable */</span>
<a name="l00668"></a>00668     <span class="keywordflow">return</span> 1;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">/* Can keyframes be added to F-Curve? </span>
<a name="l00672"></a>00672 <span class="comment"> * Keyframes can only be added if they are already visible</span>
<a name="l00673"></a>00673 <span class="comment"> */</span>
<a name="l00674"></a><a class="code" href="../../db/d17/fcurve_8c.html#a77b698f61ad1a8542bf4bd4fe079248f">00674</a> <span class="keywordtype">short</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa6d423dce8219035b7cc9f06b85d4585">fcurve_is_keyframable</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676     <span class="comment">/* F-Curve&#39;s keyframes must be &quot;usable&quot; (i.e. visible + have an effect on final result) */</span>
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (<a class="code" href="../../da/dba/BKE__fcurve_8h.html#ac5fc7825c4f2c610ccc7ac591a6686d1">fcurve_are_keyframes_usable</a>(fcu) == 0)
<a name="l00678"></a>00678         <span class="keywordflow">return</span> 0;
<a name="l00679"></a>00679         
<a name="l00680"></a>00680     <span class="comment">/* F-Curve must currently be editable too */</span>
<a name="l00681"></a>00681     <span class="keywordflow">if</span> ( (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab581d30efbbb3a1a1f6f979d26d1cd25">FCURVE_PROTECTED</a>) || ((fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>) &amp;&amp; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a3e312bcc15bdf7b83ce03a842044350a">grp</a>-&gt;<a class="code" href="../../d9/dcf/structbActionGroup.html#a5a04faf9cd6c23df183545e5842caf80">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a23623a6a10ec8ae24a77f37cf2093d1eac54dd221d44baca2d2ea17ee2c671f57">AGRP_PROTECTED</a>)) )
<a name="l00682"></a>00682         <span class="keywordflow">return</span> 0;
<a name="l00683"></a>00683     
<a name="l00684"></a>00684     <span class="comment">/* F-Curve is keyframable */</span>
<a name="l00685"></a>00685     <span class="keywordflow">return</span> 1;
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 <span class="comment">/* ***************************** Keyframe Column Tools ********************************* */</span>
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 <span class="comment">/* add a BezTriple to a column */</span>
<a name="l00691"></a><a class="code" href="../../db/d17/fcurve_8c.html#a1c40d84ba4c26d47bbad025e513110b8">00691</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ac734a2abdaa9030789ef483c217542a4">bezt_add_to_cfra_elem</a> (<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693     <a class="code" href="../../db/d00/structCfraElem.html">CfraElem</a> *ce, *cen;
<a name="l00694"></a>00694     
<a name="l00695"></a>00695     <span class="keywordflow">for</span> (ce= lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ce; ce= ce-&gt;<a class="code" href="../../db/d00/structCfraElem.html#ab87202e5ec809b32216d4c8f5f2cde42">next</a>) {
<a name="l00696"></a>00696         <span class="comment">/* double key? */</span>
<a name="l00697"></a>00697         <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="../../db/d00/structCfraElem.html#a021a2c83db7f2b1bfc3b9d425e646522">cfra</a> == bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) {
<a name="l00698"></a>00698             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) ce-&gt;<a class="code" href="../../db/d00/structCfraElem.html#af25aea4af383e20b1cea342320c6cacd">sel</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a>;
<a name="l00699"></a>00699             <span class="keywordflow">return</span>;
<a name="l00700"></a>00700         }
<a name="l00701"></a>00701         <span class="comment">/* should key be inserted before this column? */</span>
<a name="l00702"></a>00702         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="../../db/d00/structCfraElem.html#a021a2c83db7f2b1bfc3b9d425e646522">cfra</a> &gt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) <span class="keywordflow">break</span>;
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704     
<a name="l00705"></a>00705     <span class="comment">/* create a new column */</span>
<a name="l00706"></a>00706     cen= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d00/structCfraElem.html">CfraElem</a>), <span class="stringliteral">&quot;add_to_cfra_elem&quot;</span>); 
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (ce) <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(lb, ce, cen);
<a name="l00708"></a>00708     <span class="keywordflow">else</span> <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, cen);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     cen-&gt;<a class="code" href="../../db/d00/structCfraElem.html#a021a2c83db7f2b1bfc3b9d425e646522">cfra</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00711"></a>00711     cen-&gt;<a class="code" href="../../db/d00/structCfraElem.html#af25aea4af383e20b1cea342320c6cacd">sel</a>= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a>;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/* ***************************** Samples Utilities ******************************* */</span>
<a name="l00715"></a>00715 <span class="comment">/* Some utilities for working with FPoints (i.e. &#39;sampled&#39; animation curve data, such as</span>
<a name="l00716"></a>00716 <span class="comment"> * data imported from BVH/Mocap files), which are specialized for use with high density datasets,</span>
<a name="l00717"></a>00717 <span class="comment"> * which BezTriples/Keyframe data are ill equipped to do.</span>
<a name="l00718"></a>00718 <span class="comment"> */</span>
<a name="l00719"></a>00719  
<a name="l00720"></a>00720  
<a name="l00721"></a>00721 <span class="comment">/* Basic sampling callback which acts as a wrapper for evaluate_fcurve() </span>
<a name="l00722"></a>00722 <span class="comment"> *  &#39;data&#39; arg here is unneeded here...</span>
<a name="l00723"></a>00723 <span class="comment"> */</span>
<a name="l00724"></a><a class="code" href="../../db/d17/fcurve_8c.html#a429dd56b73a5c7ceeadc13eb4ccc6a7a">00724</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae4cd58a0dc544c1ba39f4621d91394eb">fcurve_samplingcb_evalcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>), <span class="keywordtype">float</span> evaltime)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726     <span class="comment">/* assume any interference from drivers on the curve is intended... */</span>
<a name="l00727"></a>00727     <span class="keywordflow">return</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1ddf79cf14ac3b61c5ea5f3a3af5bd0c">evaluate_fcurve</a>(fcu, evaltime);
<a name="l00728"></a>00728 } 
<a name="l00729"></a>00729 
<a name="l00730"></a>00730  
<a name="l00731"></a>00731 <span class="comment">/* Main API function for creating a set of sampled curve data, given some callback function </span>
<a name="l00732"></a>00732 <span class="comment"> * used to retrieve the values to store.</span>
<a name="l00733"></a>00733 <span class="comment"> */</span>
<a name="l00734"></a><a class="code" href="../../db/d17/fcurve_8c.html#af588ec787412fdc36853bf56e3ca1fa1">00734</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a74aab8fcbc30cc0337243ace43fc007c">fcurve_store_samples</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> start, <span class="keywordtype">int</span> end, <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ac576b5b8ac1602bad812b7e188d894c2">FcuSampleFunc</a> sample_cb)
<a name="l00735"></a>00735 {
<a name="l00736"></a>00736     <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *fpt, *new_fpt;
<a name="l00737"></a>00737     <span class="keywordtype">int</span> cfra;
<a name="l00738"></a>00738     
<a name="l00739"></a>00739     <span class="comment">/* sanity checks */</span>
<a name="l00740"></a>00740     <span class="comment">// TODO: make these tests report errors using reports not printf&#39;s</span>
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, sample_cb)) {
<a name="l00742"></a>00742         printf(<span class="stringliteral">&quot;Error: No F-Curve with F-Curve Modifiers to Bake\n&quot;</span>);
<a name="l00743"></a>00743         <span class="keywordflow">return</span>;
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (start &gt;= end) {
<a name="l00746"></a>00746         printf(<span class="stringliteral">&quot;Error: Frame range for Sampled F-Curve creation is inappropriate\n&quot;</span>);
<a name="l00747"></a>00747         <span class="keywordflow">return</span>;
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     
<a name="l00750"></a>00750     <span class="comment">/* set up sample data */</span>
<a name="l00751"></a>00751     fpt= new_fpt= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a>)*(end-start+1), <span class="stringliteral">&quot;FPoint Samples&quot;</span>);
<a name="l00752"></a>00752     
<a name="l00753"></a>00753     <span class="comment">/* use the sampling callback at 1-frame intervals from start to end frames */</span>
<a name="l00754"></a>00754     <span class="keywordflow">for</span> (cfra= start; cfra &lt;= end; cfra++, fpt++) {
<a name="l00755"></a>00755         fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]= (float)cfra;
<a name="l00756"></a>00756         fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1]= sample_cb(fcu, data, (<span class="keywordtype">float</span>)cfra);
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758     
<a name="l00759"></a>00759     <span class="comment">/* free any existing sample/keyframe data on curve  */</span>
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>);
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>);
<a name="l00762"></a>00762     
<a name="l00763"></a>00763     <span class="comment">/* store the samples */</span>
<a name="l00764"></a>00764     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00765"></a>00765     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>= new_fpt;
<a name="l00766"></a>00766     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>= end - start + 1;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="comment">/* ***************************** F-Curve Sanity ********************************* */</span>
<a name="l00770"></a>00770 <span class="comment">/* The functions here are used in various parts of Blender, usually after some editing</span>
<a name="l00771"></a>00771 <span class="comment"> * of keyframe data has occurred. They ensure that keyframe data is properly ordered and</span>
<a name="l00772"></a>00772 <span class="comment"> * that the handles are correctly </span>
<a name="l00773"></a>00773 <span class="comment"> */</span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">/* This function recalculates the handles of an F-Curve </span>
<a name="l00776"></a>00776 <span class="comment"> * If the BezTriples have been rearranged, sort them first before using this.</span>
<a name="l00777"></a>00777 <span class="comment"> */</span>
<a name="l00778"></a><a class="code" href="../../db/d17/fcurve_8c.html#a523b6c8d63e25d266f4e96c6988307a8">00778</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#abb464452313d3795a48da7421069f9e3">calchandles_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00779"></a>00779 {
<a name="l00780"></a>00780     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt, *prev, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l00781"></a>00781     <span class="keywordtype">int</span> a= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment">/* Error checking:</span>
<a name="l00784"></a>00784 <span class="comment">     *  - need at least two points</span>
<a name="l00785"></a>00785 <span class="comment">     *  - need bezier keys</span>
<a name="l00786"></a>00786 <span class="comment">     *  - only bezier-interpolation has handles (for now)</span>
<a name="l00787"></a>00787 <span class="comment">     */</span>
<a name="l00788"></a>00788     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) || (a &lt; 2) <span class="comment">/*|| ELEM(fcu-&gt;ipo, BEZT_IPO_CONST, BEZT_IPO_LIN)*/</span>) 
<a name="l00789"></a>00789         <span class="keywordflow">return</span>;
<a name="l00790"></a>00790     
<a name="l00791"></a>00791     <span class="comment">/* get initial pointers */</span>
<a name="l00792"></a>00792     bezt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>;
<a name="l00793"></a>00793     prev= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00794"></a>00794     next= (bezt + 1);
<a name="l00795"></a>00795     
<a name="l00796"></a>00796     <span class="comment">/* loop over all beztriples, adjusting handles */</span>
<a name="l00797"></a>00797     <span class="keywordflow">while</span> (a--) {
<a name="l00798"></a>00798         <span class="comment">/* clamp timing of handles to be on either side of beztriple */</span>
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0] &gt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00800"></a>00800         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0] &lt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00801"></a>00801         
<a name="l00802"></a>00802         <span class="comment">/* calculate auto-handles */</span>
<a name="l00803"></a>00803         <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a1b74ac08e2d1a385a6dd7c1e26e25a5c">calchandleNurb</a>(bezt, prev, next, 1);    <span class="comment">/* 1==special autohandle */</span>
<a name="l00804"></a>00804         
<a name="l00805"></a>00805         <span class="comment">/* for automatic ease in and out */</span>
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>,<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca4030ebec929ea300ba646458062c761b">HD_AUTO</a>,<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca015592fc9e4aa078609a35b5bc00e698">HD_AUTO_ANIM</a>) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>,<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca4030ebec929ea300ba646458062c761b">HD_AUTO</a>,<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca015592fc9e4aa078609a35b5bc00e698">HD_AUTO_ANIM</a>)) {
<a name="l00807"></a>00807             <span class="comment">/* only do this on first or last beztriple */</span>
<a name="l00808"></a>00808             <span class="keywordflow">if</span> ((a == 0) || (a == fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1)) {
<a name="l00809"></a>00809                 <span class="comment">/* set both handles to have same horizontal value as keyframe */</span>
<a name="l00810"></a>00810                 <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ac932d96a37634a3b105b80b0daf3afd5">extend</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#adb4a5053227c5d734c2586c5b536ddcaa5bd72cf7f090932e6427cac8ac0f6dc5">FCURVE_EXTRAPOLATE_CONSTANT</a>) {
<a name="l00811"></a>00811                     bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00812"></a>00812                 }
<a name="l00813"></a>00813             }
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815         
<a name="l00816"></a>00816         <span class="comment">/* advance pointers for next iteration */</span>
<a name="l00817"></a>00817         prev= bezt;
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (a == 1) next= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00819"></a>00819         <span class="keywordflow">else</span> next++;
<a name="l00820"></a>00820         bezt++;
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="comment">/* Use when F-Curve with handles has changed</span>
<a name="l00825"></a>00825 <span class="comment"> * It treats all BezTriples with the following rules:</span>
<a name="l00826"></a>00826 <span class="comment"> *  - PHASE 1: do types have to be altered?</span>
<a name="l00827"></a>00827 <span class="comment"> *      -&gt; Auto handles: become aligned when selection status is NOT(000 || 111)</span>
<a name="l00828"></a>00828 <span class="comment"> *      -&gt; Vector handles: become &#39;nothing&#39; when (one half selected AND other not)</span>
<a name="l00829"></a>00829 <span class="comment"> *  - PHASE 2: recalculate handles</span>
<a name="l00830"></a>00830 <span class="comment"> */</span>
<a name="l00831"></a><a class="code" href="../../db/d17/fcurve_8c.html#acdaf5f08b8b201d15ce6f8272edaf08a">00831</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#abad77ca653f43c257d897dd681f7ec33">testhandles_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keyword">const</span> <span class="keywordtype">short</span> use_handle)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00834"></a>00834     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="comment">/* only beztriples have handles (bpoints don&#39;t though) */</span>
<a name="l00837"></a>00837     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>))
<a name="l00838"></a>00838         <span class="keywordflow">return</span>;
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     <span class="comment">/* loop over beztriples */</span>
<a name="l00841"></a>00841     <span class="keywordflow">for</span> (a=0, bezt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>; a &lt; fcu-&gt;totvert; a++, bezt++) {
<a name="l00842"></a>00842         <span class="keywordtype">short</span> flag= 0;
<a name="l00843"></a>00843         
<a name="l00844"></a>00844         <span class="comment">/* flag is initialized as selection status</span>
<a name="l00845"></a>00845 <span class="comment">         * of beztriple control-points (labelled 0,1,2)</span>
<a name="l00846"></a>00846 <span class="comment">         */</span>
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a6589749668d64ba3a1182a17bb0e5d89">f2</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) flag |= (1&lt;&lt;1); <span class="comment">// == 2</span>
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (use_handle == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00849"></a>00849             <span class="keywordflow">if</span> (flag &amp; 2) {
<a name="l00850"></a>00850                 flag |= (1&lt;&lt;0) | (1&lt;&lt;2);
<a name="l00851"></a>00851             }
<a name="l00852"></a>00852         }
<a name="l00853"></a>00853         <span class="keywordflow">else</span> {
<a name="l00854"></a>00854             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad1188a435612de53bc858987af3c7acd">f1</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) flag |= (1&lt;&lt;0); <span class="comment">// == 1</span>
<a name="l00855"></a>00855             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a426bd73dcd72de3539ed00b02646bac1">f3</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) flag |= (1&lt;&lt;2); <span class="comment">// == 4</span>
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857         
<a name="l00858"></a>00858         <span class="comment">/* one or two handles selected only */</span>
<a name="l00859"></a>00859         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(flag, 0, 7)==0) {
<a name="l00860"></a>00860             <span class="comment">/* auto handles become aligned */</span>
<a name="l00861"></a>00861             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>, <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca4030ebec929ea300ba646458062c761b">HD_AUTO</a>, <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca015592fc9e4aa078609a35b5bc00e698">HD_AUTO_ANIM</a>))
<a name="l00862"></a>00862                 bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45ecacf967643ac26269318a51fe281992051">HD_ALIGN</a>;
<a name="l00863"></a>00863             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>, <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca4030ebec929ea300ba646458062c761b">HD_AUTO</a>, <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca015592fc9e4aa078609a35b5bc00e698">HD_AUTO_ANIM</a>))
<a name="l00864"></a>00864                 bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45ecacf967643ac26269318a51fe281992051">HD_ALIGN</a>;
<a name="l00865"></a>00865             
<a name="l00866"></a>00866             <span class="comment">/* vector handles become &#39;free&#39; when only one half selected */</span>
<a name="l00867"></a>00867             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca1e9cb5ecc39a3c74be445d1c4d151d04">HD_VECT</a>) {
<a name="l00868"></a>00868                 <span class="comment">/* only left half (1 or 2 or 1+2) */</span>
<a name="l00869"></a>00869                 <span class="keywordflow">if</span> (flag &lt; 4) 
<a name="l00870"></a>00870                     bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#af6f1298c6043038ba343b76054feb920">h1</a>= 0;
<a name="l00871"></a>00871             }
<a name="l00872"></a>00872             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aae1919333e2c55cb17830a26b0ce45eca1e9cb5ecc39a3c74be445d1c4d151d04">HD_VECT</a>) {
<a name="l00873"></a>00873                 <span class="comment">/* only right half (4 or 2+4) */</span>
<a name="l00874"></a>00874                 <span class="keywordflow">if</span> (flag &gt; 3) 
<a name="l00875"></a>00875                     bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#ad4c02b7166fdff040ebb931ed1d4bfc0">h2</a>= 0;
<a name="l00876"></a>00876             }
<a name="l00877"></a>00877         }
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <span class="comment">/* recalculate handles */</span>
<a name="l00881"></a>00881     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#abb464452313d3795a48da7421069f9e3">calchandles_fcurve</a>(fcu);
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="comment">/* This function sorts BezTriples so that they are arranged in chronological order,</span>
<a name="l00885"></a>00885 <span class="comment"> * as tools working on F-Curves expect that the BezTriples are in order.</span>
<a name="l00886"></a>00886 <span class="comment"> */</span>
<a name="l00887"></a><a class="code" href="../../db/d17/fcurve_8c.html#adc59cd3b76210dce7f2545e02d302446">00887</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab62b2de349c531a4c12bc371ba85344c">sort_time_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00888"></a>00888 {
<a name="l00889"></a>00889     <span class="keywordtype">short</span> ok= 1;
<a name="l00890"></a>00890     
<a name="l00891"></a>00891     <span class="comment">/* keep adjusting order of beztriples until nothing moves (bubble-sort) */</span>
<a name="l00892"></a>00892     <span class="keywordflow">while</span> (ok) {
<a name="l00893"></a>00893         ok= 0;
<a name="l00894"></a>00894         
<a name="l00895"></a>00895         <span class="comment">/* currently, will only be needed when there are beztriples */</span>
<a name="l00896"></a>00896         <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00897"></a>00897             <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00898"></a>00898             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00899"></a>00899             
<a name="l00900"></a>00900             <span class="comment">/* loop over ALL points to adjust position in array and recalculate handles */</span>
<a name="l00901"></a>00901             <span class="keywordflow">for</span> (a=0, bezt=fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>; a &lt; fcu-&gt;totvert; a++, bezt++) {
<a name="l00902"></a>00902                 <span class="comment">/* check if thee&#39;s a next beztriple which we could try to swap with current */</span>
<a name="l00903"></a>00903                 <span class="keywordflow">if</span> (a &lt; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1)) {
<a name="l00904"></a>00904                     <span class="comment">/* swap if one is after the other (and indicate that order has changed) */</span>
<a name="l00905"></a>00905                     <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt; (bezt+1)-&gt;vec[1][0]) {
<a name="l00906"></a>00906                         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>, *bezt, *(bezt+1));
<a name="l00907"></a>00907                         ok= 1;
<a name="l00908"></a>00908                     }
<a name="l00909"></a>00909                     
<a name="l00910"></a>00910                     <span class="comment">/* if either one of both of the points exceeds crosses over the keyframe time... */</span>
<a name="l00911"></a>00911                     <span class="keywordflow">if</span> ( (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0] &gt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) &amp;&amp; (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0] &lt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) ) {
<a name="l00912"></a>00912                         <span class="comment">/* swap handles if they have switched sides for some reason */</span>
<a name="l00913"></a>00913                         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0], bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]);
<a name="l00914"></a>00914                         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1], bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1]);
<a name="l00915"></a>00915                     }
<a name="l00916"></a>00916                     <span class="keywordflow">else</span> {
<a name="l00917"></a>00917                         <span class="comment">/* clamp handles */</span>
<a name="l00918"></a>00918                         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0] &gt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) 
<a name="l00919"></a>00919                             bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00920"></a>00920                         <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0] &lt; bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0]) 
<a name="l00921"></a>00921                             bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l00922"></a>00922                     }
<a name="l00923"></a>00923                 }
<a name="l00924"></a>00924             }
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 <span class="comment">/* This function tests if any BezTriples are out of order, thus requiring a sort */</span>
<a name="l00930"></a><a class="code" href="../../db/d17/fcurve_8c.html#a774ddd6f8fb3f314998e5b5ea55f4ced">00930</a> <span class="keywordtype">short</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#af7bd0732d3125d8fba729f4e750ff9e2">test_time_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00933"></a>00933     
<a name="l00934"></a>00934     <span class="comment">/* sanity checks */</span>
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (fcu == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00936"></a>00936         <span class="keywordflow">return</span> 0;
<a name="l00937"></a>00937     
<a name="l00938"></a>00938     <span class="comment">/* currently, only need to test beztriples */</span>
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>) {
<a name="l00940"></a>00940         <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt;
<a name="l00941"></a>00941         
<a name="l00942"></a>00942         <span class="comment">/* loop through all BezTriples, stopping when one exceeds the one after it */</span>
<a name="l00943"></a>00943         <span class="keywordflow">for</span> (a=0, bezt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>; a &lt; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> - 1); a++, bezt++) {
<a name="l00944"></a>00944             <span class="keywordflow">if</span> (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt; (bezt+1)-&gt;vec[1][0])
<a name="l00945"></a>00945                 <span class="keywordflow">return</span> 1;
<a name="l00946"></a>00946         }
<a name="l00947"></a>00947     }
<a name="l00948"></a>00948     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>) {
<a name="l00949"></a>00949         <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *fpt;
<a name="l00950"></a>00950         
<a name="l00951"></a>00951         <span class="comment">/* loop through all FPoints, stopping when one exceeds the one after it */</span>
<a name="l00952"></a>00952         <span class="keywordflow">for</span> (a=0, fpt= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>; a &lt; (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> - 1); a++, fpt++) {
<a name="l00953"></a>00953             <span class="keywordflow">if</span> (fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0] &gt; (fpt+1)-&gt;vec[0])
<a name="l00954"></a>00954                 <span class="keywordflow">return</span> 1;
<a name="l00955"></a>00955         }
<a name="l00956"></a>00956     }
<a name="l00957"></a>00957     
<a name="l00958"></a>00958     <span class="comment">/* none need any swapping */</span>
<a name="l00959"></a>00959     <span class="keywordflow">return</span> 0;
<a name="l00960"></a>00960 }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962 <span class="comment">/* ***************************** Drivers ********************************* */</span>
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="comment">/* Driver Variables --------------------------- */</span>
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="comment">/* TypeInfo for Driver Variables (dvti) */</span>
<a name="l00967"></a><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">00967</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">DriverVarTypeInfo</a> {
<a name="l00968"></a>00968     <span class="comment">/* evaluation callback */</span>
<a name="l00969"></a><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#aa9a1ca73372d582debd48aaf7f018611">00969</a>     float (*<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#aa9a1ca73372d582debd48aaf7f018611">get_value</a>)(<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar);
<a name="l00970"></a>00970     
<a name="l00971"></a>00971     <span class="comment">/* allocation of target slots */</span>
<a name="l00972"></a><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a90eda97203287ce0dd98355ffe05500b">00972</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a90eda97203287ce0dd98355ffe05500b">num_targets</a>;                        <span class="comment">/* number of target slots required */</span>
<a name="l00973"></a><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a95bac78a38b8b4880da4f3830e85c1e9">00973</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a95bac78a38b8b4880da4f3830e85c1e9">target_names</a>[<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a01ad68a7a7effea7431d961971954e4c">MAX_DRIVER_TARGETS</a>];   <span class="comment">/* UI names that should be given to the slots */</span>
<a name="l00974"></a><a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a71fbbd93e5b304295963f6addb56c1b0">00974</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a71fbbd93e5b304295963f6addb56c1b0">target_flags</a>[<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a01ad68a7a7effea7431d961971954e4c">MAX_DRIVER_TARGETS</a>];   <span class="comment">/* flags defining the requirements for each slot */</span>
<a name="l00975"></a>00975 } <a class="code" href="../../db/d17/fcurve_8c.html#afe62dc1e39ceafd576269f2b24ab0c59">DriverVarTypeInfo</a>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="comment">/* Macro to begin definitions */</span>
<a name="l00978"></a><a class="code" href="../../db/d17/fcurve_8c.html#ad8433979d5b91aff6aa02be33e77ccea">00978</a> <span class="preprocessor">#define BEGIN_DVAR_TYPEDEF(type) \</span>
<a name="l00979"></a>00979 <span class="preprocessor">    {</span>
<a name="l00980"></a>00980 <span class="preprocessor"></span>    
<a name="l00981"></a>00981 <span class="comment">/* Macro to end definitions */</span>
<a name="l00982"></a><a class="code" href="../../db/d17/fcurve_8c.html#aada802411c9979e2fc2d5cc2b9bf949b">00982</a> <span class="preprocessor">#define END_DVAR_TYPEDEF \</span>
<a name="l00983"></a>00983 <span class="preprocessor">    }</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>
<a name="l00985"></a>00985 <span class="comment">/* ......... */</span>
<a name="l00986"></a>00986 
<a name="l00987"></a><a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">00987</a> <span class="keyword">static</span> <a class="code" href="../../d8/d7e/structID.html">ID</a> *<a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">dtar_id_ensure_proxy_from</a>(<a class="code" href="../../d8/d7e/structID.html">ID</a> *<span class="keywordtype">id</span>)
<a name="l00988"></a>00988 {
<a name="l00989"></a>00989     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &amp;&amp; <a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)==<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a1f263dac7c79853c097b8ebde25cb0c1">ID_OB</a> &amp;&amp; ((<a class="code" href="../../de/de7/structObject.html">Object</a> *)<span class="keywordtype">id</span>)-&gt;proxy_from)
<a name="l00990"></a>00990         <span class="keywordflow">return</span> (<a class="code" href="../../d8/d7e/structID.html">ID</a> *)(((<a class="code" href="../../de/de7/structObject.html">Object</a> *)<span class="keywordtype">id</span>)-&gt;proxy_from);
<a name="l00991"></a>00991     <span class="keywordflow">return</span> id;
<a name="l00992"></a>00992 }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 <span class="comment">/* Helper function to obtain a value using RNA from the specified source (for evaluating drivers) */</span>
<a name="l00995"></a><a class="code" href="../../db/d17/fcurve_8c.html#ad17e1b2b5f27a746f93893f1fa7a4a97">00995</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#ad17e1b2b5f27a746f93893f1fa7a4a97">dtar_get_prop_val</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../df/d26/structDriverTarget.html">DriverTarget</a> *dtar)
<a name="l00996"></a>00996 {
<a name="l00997"></a>00997     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> id_ptr, ptr;
<a name="l00998"></a>00998     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop;
<a name="l00999"></a>00999     <a class="code" href="../../d8/d7e/structID.html">ID</a> *id;
<a name="l01000"></a>01000     <span class="keywordtype">int</span> index;
<a name="l01001"></a>01001     <span class="keywordtype">float</span> value= 0.0f;
<a name="l01002"></a>01002     
<a name="l01003"></a>01003     <span class="comment">/* sanity check */</span>
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, driver, dtar))
<a name="l01005"></a>01005         <span class="keywordflow">return</span> 0.0f;
<a name="l01006"></a>01006     
<a name="l01007"></a>01007     <span class="keywordtype">id</span>= <a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">dtar_id_ensure_proxy_from</a>(dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#abf59e6fd45af3532b4a1342a4376eb59">id</a>);
<a name="l01008"></a>01008     
<a name="l01009"></a>01009     <span class="comment">/* error check for missing pointer... */</span>
<a name="l01010"></a>01010     <span class="comment">// TODO: tag the specific target too as having issues</span>
<a name="l01011"></a>01011     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01012"></a>01012         printf(<span class="stringliteral">&quot;Error: driver has an invalid target to use\n&quot;</span>);
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) printf(<span class="stringliteral">&quot;\tpath = %s\n&quot;</span>, dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a6ecf1283e64a40c345c981eb0e66861d">rna_path</a>);
<a name="l01014"></a>01014         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>;
<a name="l01015"></a>01015         <span class="keywordflow">return</span> 0.0f;
<a name="l01016"></a>01016     }
<a name="l01017"></a>01017     
<a name="l01018"></a>01018     <span class="comment">/* get RNA-pointer for the ID-block given in target */</span>
<a name="l01019"></a>01019     <a class="code" href="../../d3/d10/rna__access_8c.html#a2ce5c1d9b520b00730820e0e118dd4e1">RNA_id_pointer_create</a>(<span class="keywordtype">id</span>, &amp;id_ptr);
<a name="l01020"></a>01020     
<a name="l01021"></a>01021     <span class="comment">/* get property to read from, and get value as appropriate */</span>
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#aba39c18e773e458ac0fc02a46fd9d05f">RNA_path_resolve_full</a>(&amp;id_ptr, dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a6ecf1283e64a40c345c981eb0e66861d">rna_path</a>, &amp;ptr, &amp;prop, &amp;index)) {
<a name="l01023"></a>01023         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a2b969ea1007e1516895f65336025e529">RNA_property_array_check</a>(prop)) {
<a name="l01024"></a>01024             <span class="comment">/* array */</span>
<a name="l01025"></a>01025             <span class="keywordflow">if</span> (index &lt; <a class="code" href="../../d3/d10/rna__access_8c.html#aad51db9a31d245dba4ee1f50608f331c">RNA_property_array_length</a>(&amp;ptr, prop)) {    
<a name="l01026"></a>01026                 <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a51b018d85ee119253ae423b9314eeaef">RNA_property_type</a>(prop)) {
<a name="l01027"></a>01027                 <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a3f897b521d476ae35d56f769b80b54f4">PROP_BOOLEAN</a>:
<a name="l01028"></a>01028                     value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#acb4afecfe847861cf6ebf4593d2b42bf">RNA_property_boolean_get_index</a>(&amp;ptr, prop, index);
<a name="l01029"></a>01029                     <span class="keywordflow">break</span>;
<a name="l01030"></a>01030                 <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a620d0acb046e6bc10271434db1960d41">PROP_INT</a>:
<a name="l01031"></a>01031                     value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#a30c78968af88b29eca251317dfbbece5">RNA_property_int_get_index</a>(&amp;ptr, prop, index);
<a name="l01032"></a>01032                     <span class="keywordflow">break</span>;
<a name="l01033"></a>01033                 <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a273da4f3eac15c9bfdf45600a9d3a223">PROP_FLOAT</a>:
<a name="l01034"></a>01034                     value= <a class="code" href="../../d3/d10/rna__access_8c.html#a402f3a472211a6817b5c1165566e35da">RNA_property_float_get_index</a>(&amp;ptr, prop, index);
<a name="l01035"></a>01035                     <span class="keywordflow">break</span>;
<a name="l01036"></a>01036                 <span class="keywordflow">default</span>:
<a name="l01037"></a>01037                     <span class="keywordflow">break</span>;
<a name="l01038"></a>01038                 }
<a name="l01039"></a>01039             }
<a name="l01040"></a>01040         }
<a name="l01041"></a>01041         <span class="keywordflow">else</span> {
<a name="l01042"></a>01042             <span class="comment">/* not an array */</span>
<a name="l01043"></a>01043             <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a51b018d85ee119253ae423b9314eeaef">RNA_property_type</a>(prop)) {
<a name="l01044"></a>01044             <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a3f897b521d476ae35d56f769b80b54f4">PROP_BOOLEAN</a>:
<a name="l01045"></a>01045                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#a3a4a0d200b12ded21d24676dcff67732">RNA_property_boolean_get</a>(&amp;ptr, prop);
<a name="l01046"></a>01046                 <span class="keywordflow">break</span>;
<a name="l01047"></a>01047             <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a620d0acb046e6bc10271434db1960d41">PROP_INT</a>:
<a name="l01048"></a>01048                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#a7755e74d78f50e508966f2af17f7523e">RNA_property_int_get</a>(&amp;ptr, prop);
<a name="l01049"></a>01049                 <span class="keywordflow">break</span>;
<a name="l01050"></a>01050             <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a273da4f3eac15c9bfdf45600a9d3a223">PROP_FLOAT</a>:
<a name="l01051"></a>01051                 value= <a class="code" href="../../d3/d10/rna__access_8c.html#a01215512e696b97758a08e61833fb8bd">RNA_property_float_get</a>(&amp;ptr, prop);
<a name="l01052"></a>01052                 <span class="keywordflow">break</span>;
<a name="l01053"></a>01053             <span class="keywordflow">case</span> <a class="code" href="../../de/d7e/RNA__types_8h.html#a7ff5a5c54f182b86d1cd993cf4512c87a46db685881d563dbd4be267143d05b84">PROP_ENUM</a>:
<a name="l01054"></a>01054                 value= (float)<a class="code" href="../../d3/d10/rna__access_8c.html#abb4862291354aedcb2cc916f1c30642b">RNA_property_enum_get</a>(&amp;ptr, prop);
<a name="l01055"></a>01055                 <span class="keywordflow">break</span>;
<a name="l01056"></a>01056             <span class="keywordflow">default</span>:
<a name="l01057"></a>01057                 <span class="keywordflow">break</span>;
<a name="l01058"></a>01058             }
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062     <span class="keywordflow">else</span> {
<a name="l01063"></a>01063         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01064"></a>01064             printf(<span class="stringliteral">&quot;Driver Evaluation Error: cannot resolve target for %s -&gt; %s\n&quot;</span>, id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a6ecf1283e64a40c345c981eb0e66861d">rna_path</a>);
<a name="l01065"></a>01065         
<a name="l01066"></a>01066         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>;
<a name="l01067"></a>01067         <span class="keywordflow">return</span> 0.0f;
<a name="l01068"></a>01068     }
<a name="l01069"></a>01069     
<a name="l01070"></a>01070     <span class="keywordflow">return</span> value;
<a name="l01071"></a>01071 }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073 <span class="comment">/* Helper function to obtain a pointer to a Pose Channel (for evaluating drivers) */</span>
<a name="l01074"></a><a class="code" href="../../db/d17/fcurve_8c.html#a8fe910910b026d8553f680e6220bd0a1">01074</a> <span class="keyword">static</span> <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *<a class="code" href="../../db/d17/fcurve_8c.html#a8fe910910b026d8553f680e6220bd0a1">dtar_get_pchan_ptr</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../df/d26/structDriverTarget.html">DriverTarget</a> *dtar)
<a name="l01075"></a>01075 {
<a name="l01076"></a>01076     <a class="code" href="../../d8/d7e/structID.html">ID</a> *id;
<a name="l01077"></a>01077     <span class="comment">/* sanity check */</span>
<a name="l01078"></a>01078     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, driver, dtar))
<a name="l01079"></a>01079         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081     <span class="keywordtype">id</span>= <a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">dtar_id_ensure_proxy_from</a>(dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#abf59e6fd45af3532b4a1342a4376eb59">id</a>);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="comment">/* check if the ID here is a valid object */</span>
<a name="l01084"></a>01084     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &amp;&amp; <a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(id-&gt;<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)) {
<a name="l01085"></a>01085         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)<span class="keywordtype">id</span>;
<a name="l01086"></a>01086         
<a name="l01087"></a>01087         <span class="comment">/* get pose, and subsequently, posechannel */</span>
<a name="l01088"></a>01088         <span class="keywordflow">return</span> <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a13435e86fb1862e6c28c3d1dc797623f">pchan_name</a>);
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090     <span class="keywordflow">else</span> {
<a name="l01091"></a>01091         <span class="comment">/* cannot find a posechannel this way */</span>
<a name="l01092"></a>01092         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094 }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096 <span class="comment">/* ......... */</span>
<a name="l01097"></a>01097 
<a name="l01098"></a>01098 <span class="comment">/* evaluate &#39;single prop&#39; driver variable */</span>
<a name="l01099"></a><a class="code" href="../../db/d17/fcurve_8c.html#a528e1eaa8792d5218ce0be354ce6d5be">01099</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#a528e1eaa8792d5218ce0be354ce6d5be">dvar_eval_singleProp</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101     <span class="comment">/* just evaluate the first target slot */</span>
<a name="l01102"></a>01102     <span class="keywordflow">return</span> <a class="code" href="../../db/d17/fcurve_8c.html#ad17e1b2b5f27a746f93893f1fa7a4a97">dtar_get_prop_val</a>(driver, &amp;dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a7f717ae819c408739d15204e1de98219">targets</a>[0]);
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 <span class="comment">/* evaluate &#39;rotation difference&#39; driver variable */</span>
<a name="l01106"></a><a class="code" href="../../db/d17/fcurve_8c.html#aa0b0fddc517237d12e900633cc6bbaf6">01106</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#aa0b0fddc517237d12e900633cc6bbaf6">dvar_eval_rotDiff</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01107"></a>01107 {
<a name="l01108"></a>01108     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchan2;
<a name="l01109"></a>01109     <span class="keywordtype">float</span> q1[4], q2[4], quat[4], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l01110"></a>01110     
<a name="l01111"></a>01111     <span class="comment">/* get pose channels, and check if we&#39;ve got two */</span>
<a name="l01112"></a>01112     pchan= <a class="code" href="../../db/d17/fcurve_8c.html#a8fe910910b026d8553f680e6220bd0a1">dtar_get_pchan_ptr</a>(driver, &amp;dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a7f717ae819c408739d15204e1de98219">targets</a>[0]);
<a name="l01113"></a>01113     pchan2= <a class="code" href="../../db/d17/fcurve_8c.html#a8fe910910b026d8553f680e6220bd0a1">dtar_get_pchan_ptr</a>(driver, &amp;dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a7f717ae819c408739d15204e1de98219">targets</a>[1]);
<a name="l01114"></a>01114     
<a name="l01115"></a>01115     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, pchan, pchan2)) {
<a name="l01116"></a>01116         <span class="comment">/* disable this driver, since it doesn&#39;t work correctly... */</span>
<a name="l01117"></a>01117         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>;
<a name="l01118"></a>01118         
<a name="l01119"></a>01119         <span class="comment">/* check what the error was */</span>
<a name="l01120"></a>01120         <span class="keywordflow">if</span> ((pchan == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (pchan2 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l01121"></a>01121             printf(<span class="stringliteral">&quot;Driver Evaluation Error: Rotational difference failed - first 2 targets invalid\n&quot;</span>);
<a name="l01122"></a>01122         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01123"></a>01123             printf(<span class="stringliteral">&quot;Driver Evaluation Error: Rotational difference failed - first target not valid PoseChannel\n&quot;</span>);
<a name="l01124"></a>01124         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan2 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01125"></a>01125             printf(<span class="stringliteral">&quot;Driver Evaluation Error: Rotational difference failed - second target not valid PoseChannel\n&quot;</span>);
<a name="l01126"></a>01126             
<a name="l01127"></a>01127         <span class="comment">/* stop here... */</span>
<a name="l01128"></a>01128         <span class="keywordflow">return</span> 0.0f;
<a name="l01129"></a>01129     }           
<a name="l01130"></a>01130     
<a name="l01131"></a>01131     <span class="comment">/* use the final posed locations */</span>
<a name="l01132"></a>01132     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad76b90158227d13beb93cf29952f78a9">mat4_to_quat</a>(q1, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01133"></a>01133     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad76b90158227d13beb93cf29952f78a9">mat4_to_quat</a>(q2, pchan2-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01134"></a>01134     
<a name="l01135"></a>01135     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5bc8657197a0d909debcabc063c0b25a">invert_qt</a>(q1);
<a name="l01136"></a>01136     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a933ad0450d410fc2fae72afe434be287">mul_qt_qtqt</a>(quat, q1, q2);
<a name="l01137"></a>01137     angle = 2.0f * (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(quat[0]));
<a name="l01138"></a>01138     angle= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(angle);
<a name="l01139"></a>01139     
<a name="l01140"></a>01140     <span class="keywordflow">return</span> (angle &gt; (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) ? (float)((2.0f * (<span class="keywordtype">float</span>)M_PI) - <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>) : (<span class="keywordtype">float</span>)(<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>);
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="comment">/* evaluate &#39;location difference&#39; driver variable */</span>
<a name="l01144"></a>01144 <span class="comment">// TODO: this needs to take into account space conversions...</span>
<a name="l01145"></a><a class="code" href="../../db/d17/fcurve_8c.html#ac5e9cc87f1349164ff45b233a68527bd">01145</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#ac5e9cc87f1349164ff45b233a68527bd">dvar_eval_locDiff</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147     <span class="keywordtype">float</span> loc1[3] = {0.0f,0.0f,0.0f};
<a name="l01148"></a>01148     <span class="keywordtype">float</span> loc2[3] = {0.0f,0.0f,0.0f};
<a name="l01149"></a>01149     
<a name="l01150"></a>01150     <span class="comment">/* get two location values */</span>
<a name="l01151"></a>01151     <span class="comment">// NOTE: for now, these are all just worldspace</span>
<a name="l01152"></a>01152     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab7a010e2c04c7ccc1c70a90f9346d3ef">DRIVER_TARGETS_USED_LOOPER</a>(dvar)
<a name="l01153"></a>01153     {
<a name="l01154"></a>01154         <span class="comment">/* get pointer to loc values to store in */</span>
<a name="l01155"></a>01155         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)<a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">dtar_id_ensure_proxy_from</a>(dtar-&gt;id);
<a name="l01156"></a>01156         <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01157"></a>01157         <span class="keywordtype">float</span> tmp_loc[3];
<a name="l01158"></a>01158         
<a name="l01159"></a>01159         <span class="comment">/* check if this target has valid data */</span>
<a name="l01160"></a>01160         <span class="keywordflow">if</span> ((ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (<a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) != <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a1f263dac7c79853c097b8ebde25cb0c1">ID_OB</a>)) {
<a name="l01161"></a>01161             <span class="comment">/* invalid target, so will not have enough targets */</span>
<a name="l01162"></a>01162             driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>;
<a name="l01163"></a>01163             <span class="keywordflow">return</span> 0.0f;
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165         
<a name="l01166"></a>01166         <span class="comment">/* try to get posechannel */</span>
<a name="l01167"></a>01167         pchan= <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, dtar-&gt;pchan_name);
<a name="l01168"></a>01168         
<a name="l01169"></a>01169         <span class="comment">/* check if object or bone */</span>
<a name="l01170"></a>01170         <span class="keywordflow">if</span> (pchan) {
<a name="l01171"></a>01171             <span class="comment">/* bone */</span>
<a name="l01172"></a>01172             <span class="keywordflow">if</span> (dtar-&gt;flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa296d68de32f1844a319d4fa63ea6dc59">DTAR_FLAG_LOCALSPACE</a>) {
<a name="l01173"></a>01173                 <span class="keywordflow">if</span> (dtar-&gt;flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa14abab1f09fb81086ab9e7a9cfd9c90b">DTAR_FLAG_LOCAL_CONSTS</a>) {
<a name="l01174"></a>01174                     <span class="keywordtype">float</span> mat[4][4];
<a name="l01175"></a>01175                     
<a name="l01176"></a>01176                     <span class="comment">/* extract transform just like how the constraints do it! */</span>
<a name="l01177"></a>01177                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01178"></a>01178                     <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#ae040cca2a719b9e836aa44b2bd82b724">constraint_mat_convertspace</a>(ob, pchan, mat, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303a611a7ece07a5656a655d1f21db1b49a2">CONSTRAINT_SPACE_POSE</a>, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303adcd072a1a47c05df5aaad749d71b5ebf">CONSTRAINT_SPACE_LOCAL</a>);
<a name="l01179"></a>01179                     
<a name="l01180"></a>01180                     <span class="comment">/* ... and from that, we get our transform */</span>
<a name="l01181"></a>01181                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, mat[3]);
<a name="l01182"></a>01182                 }
<a name="l01183"></a>01183                 <span class="keywordflow">else</span> {
<a name="l01184"></a>01184                     <span class="comment">/* transform space (use transform values directly) */</span>
<a name="l01185"></a>01185                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>);
<a name="l01186"></a>01186                 }
<a name="l01187"></a>01187             }
<a name="l01188"></a>01188             <span class="keywordflow">else</span> {
<a name="l01189"></a>01189                 <span class="comment">/* convert to worldspace */</span>
<a name="l01190"></a>01190                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l01191"></a>01191                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, tmp_loc);
<a name="l01192"></a>01192             }
<a name="l01193"></a>01193         }
<a name="l01194"></a>01194         <span class="keywordflow">else</span> {
<a name="l01195"></a>01195             <span class="comment">/* object */</span>
<a name="l01196"></a>01196             <span class="keywordflow">if</span> (dtar-&gt;flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa296d68de32f1844a319d4fa63ea6dc59">DTAR_FLAG_LOCALSPACE</a>) {
<a name="l01197"></a>01197                 <span class="keywordflow">if</span> (dtar-&gt;flag &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa14abab1f09fb81086ab9e7a9cfd9c90b">DTAR_FLAG_LOCAL_CONSTS</a>) {
<a name="l01198"></a>01198                     <span class="comment">// XXX: this should practically be the same as transform space...</span>
<a name="l01199"></a>01199                     <span class="keywordtype">float</span> mat[4][4];
<a name="l01200"></a>01200                     
<a name="l01201"></a>01201                     <span class="comment">/* extract transform just like how the constraints do it! */</span>
<a name="l01202"></a>01202                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01203"></a>01203                     <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#ae040cca2a719b9e836aa44b2bd82b724">constraint_mat_convertspace</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mat, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303a7c47938357a8f04d9f8cbbd12dd44e70">CONSTRAINT_SPACE_WORLD</a>, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303adcd072a1a47c05df5aaad749d71b5ebf">CONSTRAINT_SPACE_LOCAL</a>);
<a name="l01204"></a>01204                     
<a name="l01205"></a>01205                     <span class="comment">/* ... and from that, we get our transform */</span>
<a name="l01206"></a>01206                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, mat[3]);
<a name="l01207"></a>01207                 }
<a name="l01208"></a>01208                 <span class="keywordflow">else</span> {
<a name="l01209"></a>01209                     <span class="comment">/* transform space (use transform values directly) */</span>
<a name="l01210"></a>01210                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>);
<a name="l01211"></a>01211                 }
<a name="l01212"></a>01212             }
<a name="l01213"></a>01213             <span class="keywordflow">else</span> {
<a name="l01214"></a>01214                 <span class="comment">/* worldspace */</span>
<a name="l01215"></a>01215                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_loc, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l01216"></a>01216             }
<a name="l01217"></a>01217         }
<a name="l01218"></a>01218         
<a name="l01219"></a>01219         <span class="comment">/* copy the location to the right place */</span>
<a name="l01220"></a>01220         <span class="keywordflow">if</span> (tarIndex) {
<a name="l01221"></a>01221             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc2, tmp_loc);
<a name="l01222"></a>01222         }
<a name="l01223"></a>01223         <span class="keywordflow">else</span> {
<a name="l01224"></a>01224             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc1, tmp_loc);
<a name="l01225"></a>01225         }
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae6f978c887bc26c0da1235ccef77444b">DRIVER_TARGETS_LOOPER_END</a>
<a name="l01228"></a>01228     
<a name="l01229"></a>01229     
<a name="l01230"></a>01230     <span class="comment">/* if we&#39;re still here, there should now be two targets to use,</span>
<a name="l01231"></a>01231 <span class="comment">     * so just take the length of the vector between these points </span>
<a name="l01232"></a>01232 <span class="comment">     */</span>
<a name="l01233"></a>01233     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(loc1, loc2);
<a name="l01234"></a>01234 }
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 <span class="comment">/* evaluate &#39;transform channel&#39; driver variable */</span>
<a name="l01237"></a><a class="code" href="../../db/d17/fcurve_8c.html#a2cf4bcc22cb179999e22b6c9705ad970">01237</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#a2cf4bcc22cb179999e22b6c9705ad970">dvar_eval_transChan</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01238"></a>01238 {
<a name="l01239"></a>01239     <a class="code" href="../../df/d26/structDriverTarget.html">DriverTarget</a> *dtar= &amp;dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a7f717ae819c408739d15204e1de98219">targets</a>[0];
<a name="l01240"></a>01240     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)<a class="code" href="../../db/d17/fcurve_8c.html#a3be36ba3fd3d4eb0bdc72d4ef05d762f">dtar_id_ensure_proxy_from</a>(dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#abf59e6fd45af3532b4a1342a4376eb59">id</a>);
<a name="l01241"></a>01241     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01242"></a>01242     <span class="keywordtype">float</span> mat[4][4];
<a name="l01243"></a>01243     <span class="keywordtype">float</span> oldEul[3] = {0.0f,0.0f,0.0f};
<a name="l01244"></a>01244     <span class="keywordtype">short</span> useEulers=0, rotOrder=<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddacaab17f62773635010f913dedee89a8b3d">ROT_MODE_EUL</a>;
<a name="l01245"></a>01245     
<a name="l01246"></a>01246     <span class="comment">/* check if this target has valid data */</span>
<a name="l01247"></a>01247     <span class="keywordflow">if</span> ((ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (<a class="code" href="../../db/ddc/icons_8c.html#adcd5f4a8d30b31ea3612fab180fa3338">GS</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) != <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a1f263dac7c79853c097b8ebde25cb0c1">ID_OB</a>)) {
<a name="l01248"></a>01248         <span class="comment">/* invalid target, so will not have enough targets */</span>
<a name="l01249"></a>01249         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>;
<a name="l01250"></a>01250         <span class="keywordflow">return</span> 0.0f;
<a name="l01251"></a>01251     }
<a name="l01252"></a>01252     
<a name="l01253"></a>01253     <span class="comment">/* try to get posechannel */</span>
<a name="l01254"></a>01254     pchan= <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a13435e86fb1862e6c28c3d1dc797623f">pchan_name</a>);
<a name="l01255"></a>01255     
<a name="l01256"></a>01256     <span class="comment">/* check if object or bone, and get transform matrix accordingly </span>
<a name="l01257"></a>01257 <span class="comment">     *  - &quot;useEulers&quot; code is used to prevent the problems associated with non-uniqueness</span>
<a name="l01258"></a>01258 <span class="comment">     *    of euler decomposition from matrices [#20870]</span>
<a name="l01259"></a>01259 <span class="comment">     *  - localspace is for [#21384], where parent results are not wanted</span>
<a name="l01260"></a>01260 <span class="comment">     *    but local-consts is for all the common &quot;corrective-shapes-for-limbs&quot; situations</span>
<a name="l01261"></a>01261 <span class="comment">     */</span>
<a name="l01262"></a>01262     <span class="keywordflow">if</span> (pchan) {
<a name="l01263"></a>01263         <span class="comment">/* bone */</span>
<a name="l01264"></a>01264         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> &gt; 0) {
<a name="l01265"></a>01265             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(oldEul, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>);
<a name="l01266"></a>01266             rotOrder= pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a>;
<a name="l01267"></a>01267             useEulers = 1;
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269         
<a name="l01270"></a>01270         <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a475f0be35635c6f5f6b2d257a7b78440">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa296d68de32f1844a319d4fa63ea6dc59">DTAR_FLAG_LOCALSPACE</a>) {
<a name="l01271"></a>01271             <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a475f0be35635c6f5f6b2d257a7b78440">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa14abab1f09fb81086ab9e7a9cfd9c90b">DTAR_FLAG_LOCAL_CONSTS</a>) {
<a name="l01272"></a>01272                 <span class="comment">/* just like how the constraints do it! */</span>
<a name="l01273"></a>01273                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01274"></a>01274                 <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#ae040cca2a719b9e836aa44b2bd82b724">constraint_mat_convertspace</a>(ob, pchan, mat, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303a611a7ece07a5656a655d1f21db1b49a2">CONSTRAINT_SPACE_POSE</a>, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303adcd072a1a47c05df5aaad749d71b5ebf">CONSTRAINT_SPACE_LOCAL</a>);
<a name="l01275"></a>01275             }
<a name="l01276"></a>01276             <span class="keywordflow">else</span> {
<a name="l01277"></a>01277                 <span class="comment">/* specially calculate local matrix, since chan_mat is not valid </span>
<a name="l01278"></a>01278 <span class="comment">                 * since it stores delta transform of pose_mat so that deforms work</span>
<a name="l01279"></a>01279 <span class="comment">                 * so it cannot be used here for &quot;transform&quot; space</span>
<a name="l01280"></a>01280 <span class="comment">                 */</span>
<a name="l01281"></a>01281                 <a class="code" href="../../da/d17/BKE__armature_8h.html#a8522165732c241ac79d83f3e55955931">pchan_to_mat4</a>(pchan, mat);
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283         }
<a name="l01284"></a>01284         <span class="keywordflow">else</span> {
<a name="l01285"></a>01285             <span class="comment">/* worldspace matrix */</span>
<a name="l01286"></a>01286             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01287"></a>01287         }
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289     <span class="keywordflow">else</span> {
<a name="l01290"></a>01290         <span class="comment">/* object */</span>
<a name="l01291"></a>01291         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#aacca751408fdb1bc64d18670bcc4d73e">rotmode</a> &gt; 0) {
<a name="l01292"></a>01292             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(oldEul, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a73a4242dd7998a04e9895fc07c749153">rot</a>);
<a name="l01293"></a>01293             rotOrder= ob-&gt;<a class="code" href="../../de/de7/structObject.html#aacca751408fdb1bc64d18670bcc4d73e">rotmode</a>;
<a name="l01294"></a>01294             useEulers = 1;
<a name="l01295"></a>01295         }
<a name="l01296"></a>01296         
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a475f0be35635c6f5f6b2d257a7b78440">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa296d68de32f1844a319d4fa63ea6dc59">DTAR_FLAG_LOCALSPACE</a>) {
<a name="l01298"></a>01298             <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#a475f0be35635c6f5f6b2d257a7b78440">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa14abab1f09fb81086ab9e7a9cfd9c90b">DTAR_FLAG_LOCAL_CONSTS</a>) {
<a name="l01299"></a>01299                 <span class="comment">/* just like how the constraints do it! */</span>
<a name="l01300"></a>01300                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01301"></a>01301                 <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#ae040cca2a719b9e836aa44b2bd82b724">constraint_mat_convertspace</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, mat, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303a7c47938357a8f04d9f8cbbd12dd44e70">CONSTRAINT_SPACE_WORLD</a>, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a70bdab3459b92ba40a7aaed75e56d303adcd072a1a47c05df5aaad749d71b5ebf">CONSTRAINT_SPACE_LOCAL</a>);
<a name="l01302"></a>01302             }
<a name="l01303"></a>01303             <span class="keywordflow">else</span> {
<a name="l01304"></a>01304                 <span class="comment">/* transforms to matrix */</span>
<a name="l01305"></a>01305                 <a class="code" href="../../df/dac/BKE__object_8h.html#ad84262a6f0d74d4ac9c3aaf0513f49a4">object_to_mat4</a>(ob, mat);
<a name="l01306"></a>01306             }
<a name="l01307"></a>01307         }
<a name="l01308"></a>01308         <span class="keywordflow">else</span> {
<a name="l01309"></a>01309             <span class="comment">/* worldspace matrix - just the good-old one */</span>
<a name="l01310"></a>01310             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312     }
<a name="l01313"></a>01313     
<a name="l01314"></a>01314     <span class="comment">/* check which transform */</span>
<a name="l01315"></a>01315     <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a> &gt;= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1467b6d38dc5f38d00d1a813cd132ea6a8872494b768a64f0fc40a701fc523d58">MAX_DTAR_TRANSCHAN_TYPES</a>) {
<a name="l01316"></a>01316         <span class="comment">/* not valid channel */</span>
<a name="l01317"></a>01317         <span class="keywordflow">return</span> 0.0f;
<a name="l01318"></a>01318     }
<a name="l01319"></a>01319     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a> &gt;= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1467b6d38dc5f38d00d1a813cd132ea6a15006c0fdbe76393480898e805a8d527">DTAR_TRANSCHAN_SCALEX</a>) {
<a name="l01320"></a>01320         <span class="comment">/* extract scale, and choose the right axis */</span>
<a name="l01321"></a>01321         <span class="keywordtype">float</span> scale[3];
<a name="l01322"></a>01322         
<a name="l01323"></a>01323         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a245c1bf7630bef5c065994ea56751d21">mat4_to_size</a>(scale, mat);
<a name="l01324"></a>01324         <span class="keywordflow">return</span> scale[dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a> - <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1467b6d38dc5f38d00d1a813cd132ea6a15006c0fdbe76393480898e805a8d527">DTAR_TRANSCHAN_SCALEX</a>];
<a name="l01325"></a>01325     }
<a name="l01326"></a>01326     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a> &gt;= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1467b6d38dc5f38d00d1a813cd132ea6a70d33ca7a36d12ef881637440c5cf792">DTAR_TRANSCHAN_ROTX</a>) {
<a name="l01327"></a>01327         <span class="comment">/* extract rotation as eulers (if needed) </span>
<a name="l01328"></a>01328 <span class="comment">         *  - definitely if rotation order isn&#39;t eulers already</span>
<a name="l01329"></a>01329 <span class="comment">         *  - if eulers, then we have 2 options:</span>
<a name="l01330"></a>01330 <span class="comment">         *      a) decompose transform matrix as required, then try to make eulers from</span>
<a name="l01331"></a>01331 <span class="comment">         *         there compatible with original values</span>
<a name="l01332"></a>01332 <span class="comment">         *      b) [NOT USED] directly use the original values (no decomposition) </span>
<a name="l01333"></a>01333 <span class="comment">         *          - only an option for &quot;transform space&quot;, if quality is really bad with a)</span>
<a name="l01334"></a>01334 <span class="comment">         */</span>
<a name="l01335"></a>01335         <span class="keywordtype">float</span> eul[3];
<a name="l01336"></a>01336         
<a name="l01337"></a>01337         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4baf6d531a682ae3eba58e56c27374a4">mat4_to_eulO</a>(eul, rotOrder, mat);
<a name="l01338"></a>01338         
<a name="l01339"></a>01339         <span class="keywordflow">if</span> (useEulers) {
<a name="l01340"></a>01340             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad1b2afdb475f2fe8056611c91b9a5aa9">compatible_eul</a>(eul, oldEul);
<a name="l01341"></a>01341         }
<a name="l01342"></a>01342         
<a name="l01343"></a>01343         <span class="keywordflow">return</span> eul[dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a> - <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a1467b6d38dc5f38d00d1a813cd132ea6a70d33ca7a36d12ef881637440c5cf792">DTAR_TRANSCHAN_ROTX</a>];
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345     <span class="keywordflow">else</span> {
<a name="l01346"></a>01346         <span class="comment">/* extract location and choose right axis */</span>
<a name="l01347"></a>01347         <span class="keywordflow">return</span> mat[3][dtar-&gt;<a class="code" href="../../df/d26/structDriverTarget.html#ac8ffdbbdaeb860c6685af1c5e8800cf1">transChan</a>];
<a name="l01348"></a>01348     }
<a name="l01349"></a>01349 }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351 <span class="comment">/* ......... */</span>
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 <span class="comment">/* Table of Driver Varaiable Type Info Data */</span>
<a name="l01354"></a><a class="code" href="../../db/d17/fcurve_8c.html#aeb69957a168cbfba8d047b3e0a462767">01354</a> <span class="keyword">static</span> <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">DriverVarTypeInfo</a> <a class="code" href="../../db/d17/fcurve_8c.html#aeb69957a168cbfba8d047b3e0a462767">dvar_types</a>[<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca52540d41e730ed1eee5d109bab0013cf">MAX_DVAR_TYPES</a>] = {
<a name="l01355"></a>01355     <a class="code" href="../../db/d17/fcurve_8c.html#ad8433979d5b91aff6aa02be33e77ccea">BEGIN_DVAR_TYPEDEF</a>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca6b0fec76581d1fea1e98f1bbba577ed7">DVAR_TYPE_SINGLE_PROP</a>)
<a name="l01356"></a>01356         <a class="code" href="../../db/d17/fcurve_8c.html#a528e1eaa8792d5218ce0be354ce6d5be">dvar_eval_singleProp</a>, <span class="comment">/* eval callback */</span>
<a name="l01357"></a>01357         1, <span class="comment">/* number of targets used */</span>
<a name="l01358"></a>01358         {<span class="stringliteral">&quot;Property&quot;</span>}, <span class="comment">/* UI names for targets */</span>
<a name="l01359"></a>01359         {0} <span class="comment">/* flags */</span>
<a name="l01360"></a>01360     <a class="code" href="../../db/d17/fcurve_8c.html#aada802411c9979e2fc2d5cc2b9bf949b">END_DVAR_TYPEDEF</a>,
<a name="l01361"></a>01361     
<a name="l01362"></a>01362     <a class="code" href="../../db/d17/fcurve_8c.html#ad8433979d5b91aff6aa02be33e77ccea">BEGIN_DVAR_TYPEDEF</a>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca43572bc69ffd8cfd2858971d2c4acc7c">DVAR_TYPE_ROT_DIFF</a>)
<a name="l01363"></a>01363         <a class="code" href="../../db/d17/fcurve_8c.html#aa0b0fddc517237d12e900633cc6bbaf6">dvar_eval_rotDiff</a>, <span class="comment">/* eval callback */</span>
<a name="l01364"></a>01364         2, <span class="comment">/* number of targets used */</span>
<a name="l01365"></a>01365         {<span class="stringliteral">&quot;Bone 1&quot;</span>, <span class="stringliteral">&quot;Bone 2&quot;</span>}, <span class="comment">/* UI names for targets */</span>
<a name="l01366"></a>01366         {<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa80e084458864700178a95d79b406ecfe">DTAR_FLAG_STRUCT_REF</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa80e084458864700178a95d79b406ecfe">DTAR_FLAG_STRUCT_REF</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>} <span class="comment">/* flags */</span>
<a name="l01367"></a>01367     <a class="code" href="../../db/d17/fcurve_8c.html#aada802411c9979e2fc2d5cc2b9bf949b">END_DVAR_TYPEDEF</a>,
<a name="l01368"></a>01368     
<a name="l01369"></a>01369     <a class="code" href="../../db/d17/fcurve_8c.html#ad8433979d5b91aff6aa02be33e77ccea">BEGIN_DVAR_TYPEDEF</a>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca00f802d5fcbeea4503bd9a15ecc38f1e">DVAR_TYPE_LOC_DIFF</a>)
<a name="l01370"></a>01370         <a class="code" href="../../db/d17/fcurve_8c.html#ac5e9cc87f1349164ff45b233a68527bd">dvar_eval_locDiff</a>, <span class="comment">/* eval callback */</span>
<a name="l01371"></a>01371         2, <span class="comment">/* number of targets used */</span>
<a name="l01372"></a>01372         {<span class="stringliteral">&quot;Object/Bone 1&quot;</span>, <span class="stringliteral">&quot;Object/Bone 2&quot;</span>}, <span class="comment">/* UI names for targets */</span>
<a name="l01373"></a>01373         {<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa80e084458864700178a95d79b406ecfe">DTAR_FLAG_STRUCT_REF</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa80e084458864700178a95d79b406ecfe">DTAR_FLAG_STRUCT_REF</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>} <span class="comment">/* flags */</span>
<a name="l01374"></a>01374     <a class="code" href="../../db/d17/fcurve_8c.html#aada802411c9979e2fc2d5cc2b9bf949b">END_DVAR_TYPEDEF</a>,
<a name="l01375"></a>01375     
<a name="l01376"></a>01376     <a class="code" href="../../db/d17/fcurve_8c.html#ad8433979d5b91aff6aa02be33e77ccea">BEGIN_DVAR_TYPEDEF</a>(<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca189c989aa474667a72eeaa4db54dc750">DVAR_TYPE_TRANSFORM_CHAN</a>)
<a name="l01377"></a>01377         <a class="code" href="../../db/d17/fcurve_8c.html#a2cf4bcc22cb179999e22b6c9705ad970">dvar_eval_transChan</a>, <span class="comment">/* eval callback */</span>
<a name="l01378"></a>01378         1, <span class="comment">/* number of targets used */</span>
<a name="l01379"></a>01379         {<span class="stringliteral">&quot;Object/Bone&quot;</span>}, <span class="comment">/* UI names for targets */</span>
<a name="l01380"></a>01380         {<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa80e084458864700178a95d79b406ecfe">DTAR_FLAG_STRUCT_REF</a>|<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>} <span class="comment">/* flags */</span>
<a name="l01381"></a>01381     <a class="code" href="../../db/d17/fcurve_8c.html#aada802411c9979e2fc2d5cc2b9bf949b">END_DVAR_TYPEDEF</a>,
<a name="l01382"></a>01382 };
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 <span class="comment">/* Get driver variable typeinfo */</span>
<a name="l01385"></a><a class="code" href="../../db/d17/fcurve_8c.html#a5b2d069080f08abb46365656e9784296">01385</a> <span class="keyword">static</span> <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">DriverVarTypeInfo</a> *<a class="code" href="../../db/d17/fcurve_8c.html#a5b2d069080f08abb46365656e9784296">get_dvar_typeinfo</a> (<span class="keywordtype">int</span> type)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387     <span class="comment">/* check if valid type */</span>
<a name="l01388"></a>01388     <span class="keywordflow">if</span> ((type &gt;= 0) &amp;&amp; (type &lt; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca52540d41e730ed1eee5d109bab0013cf">MAX_DVAR_TYPES</a>))
<a name="l01389"></a>01389         <span class="keywordflow">return</span> &amp;dvar_types[type];
<a name="l01390"></a>01390     <span class="keywordflow">else</span>
<a name="l01391"></a>01391         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01392"></a>01392 }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 <span class="comment">/* Driver API --------------------------------- */</span>
<a name="l01395"></a>01395 
<a name="l01396"></a>01396 <span class="comment">/* This frees the driver variable itself */</span>
<a name="l01397"></a><a class="code" href="../../db/d17/fcurve_8c.html#a68081a02585bb5ad9770e4e760fce5a5">01397</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae2ee39c1c3566aecc68ab6f67324fa28">driver_free_variable</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01398"></a>01398 {
<a name="l01399"></a>01399     <span class="comment">/* sanity checks */</span>
<a name="l01400"></a>01400     <span class="keywordflow">if</span> (dvar == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01401"></a>01401         <span class="keywordflow">return</span>;
<a name="l01402"></a>01402         
<a name="l01403"></a>01403     <span class="comment">/* free target vars </span>
<a name="l01404"></a>01404 <span class="comment">     *  - need to go over all of them, not just up to the ones that are used</span>
<a name="l01405"></a>01405 <span class="comment">     *    currently, since there may be some lingering RNA paths from </span>
<a name="l01406"></a>01406 <span class="comment">     *    previous users needing freeing</span>
<a name="l01407"></a>01407 <span class="comment">     */</span>
<a name="l01408"></a>01408     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a94a8b2b8c805858b0e72e8652b5d79b6">DRIVER_TARGETS_LOOPER</a>(dvar) 
<a name="l01409"></a>01409     {
<a name="l01410"></a>01410         <span class="comment">/* free RNA path if applicable */</span>
<a name="l01411"></a>01411         <span class="keywordflow">if</span> (dtar-&gt;rna_path)
<a name="l01412"></a>01412             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dtar-&gt;rna_path);
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae6f978c887bc26c0da1235ccef77444b">DRIVER_TARGETS_LOOPER_END</a>
<a name="l01415"></a>01415     
<a name="l01416"></a>01416     <span class="comment">/* remove the variable from the driver */</span>
<a name="l01417"></a>01417     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>, dvar);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l01420"></a>01420 <span class="preprocessor"></span>    <span class="comment">/* since driver variables are cached, the expression needs re-compiling too */</span>
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a3945d10db5e98f2de0797cef16a43fbb">type</a>==<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3a373b8dd334d78c62a7d8f4726046dea8">DRIVER_TYPE_PYTHON</a>)
<a name="l01422"></a>01422         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa78b0f04b5003c6b12b9687a3d837b15c">DRIVER_FLAG_RENAMEVAR</a>;
<a name="l01423"></a>01423 <span class="preprocessor">#endif</span>
<a name="l01424"></a>01424 <span class="preprocessor"></span>}
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 <span class="comment">/* Change the type of driver variable */</span>
<a name="l01427"></a><a class="code" href="../../db/d17/fcurve_8c.html#a0317b3df4f38bfa400c02a06bf42c0a1">01427</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#af3943320f375173560fae0463cfad099">driver_change_variable_type</a> (<a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar, <span class="keywordtype">int</span> type)
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429     <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">DriverVarTypeInfo</a> *dvti= <a class="code" href="../../db/d17/fcurve_8c.html#a5b2d069080f08abb46365656e9784296">get_dvar_typeinfo</a>(type);
<a name="l01430"></a>01430     
<a name="l01431"></a>01431     <span class="comment">/* sanity check */</span>
<a name="l01432"></a>01432     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, dvar, dvti))
<a name="l01433"></a>01433         <span class="keywordflow">return</span>;
<a name="l01434"></a>01434         
<a name="l01435"></a>01435     <span class="comment">/* set the new settings */</span>
<a name="l01436"></a>01436     dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a1d286addd47402783d2353b855db04f3">type</a>= type;
<a name="l01437"></a>01437     dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a502d670b6d8e31dedaa0b3b385c0fea8">num_targets</a>= dvti-&gt;<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a90eda97203287ce0dd98355ffe05500b">num_targets</a>;
<a name="l01438"></a>01438     
<a name="l01439"></a>01439     <span class="comment">/* make changes to the targets based on the defines for these types </span>
<a name="l01440"></a>01440 <span class="comment">     * NOTE: only need to make sure the ones we&#39;re using here are valid...</span>
<a name="l01441"></a>01441 <span class="comment">     */</span>
<a name="l01442"></a>01442     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ab7a010e2c04c7ccc1c70a90f9346d3ef">DRIVER_TARGETS_USED_LOOPER</a>(dvar)
<a name="l01443"></a>01443     {
<a name="l01444"></a>01444         <span class="keywordtype">int</span> flags = dvti-&gt;<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#a71fbbd93e5b304295963f6addb56c1b0">target_flags</a>[tarIndex];
<a name="l01445"></a>01445         
<a name="l01446"></a>01446         <span class="comment">/* store the flags */</span>
<a name="l01447"></a>01447         dtar-&gt;flag = flags;
<a name="l01448"></a>01448         
<a name="l01449"></a>01449         <span class="comment">/* object ID types only, or idtype not yet initialized*/</span>
<a name="l01450"></a>01450         <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a9b0375da90726dfc722f08e00bfe898aa3b340e55b3a55da774569be2868ccb6e">DTAR_FLAG_ID_OB_ONLY</a>) || (dtar-&gt;idtype == 0))
<a name="l01451"></a>01451             dtar-&gt;idtype= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a1f263dac7c79853c097b8ebde25cb0c1">ID_OB</a>;
<a name="l01452"></a>01452     }
<a name="l01453"></a>01453     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae6f978c887bc26c0da1235ccef77444b">DRIVER_TARGETS_LOOPER_END</a>
<a name="l01454"></a>01454 }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456 <span class="comment">/* Add a new driver variable */</span>
<a name="l01457"></a><a class="code" href="../../db/d17/fcurve_8c.html#ac71c034f860e3769d14d33836254ca0a">01457</a> <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a8f9bdffc0203c985fe46a3d84f880f44">driver_add_new_variable</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver)
<a name="l01458"></a>01458 {
<a name="l01459"></a>01459     <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar;
<a name="l01460"></a>01460     
<a name="l01461"></a>01461     <span class="comment">/* sanity checks */</span>
<a name="l01462"></a>01462     <span class="keywordflow">if</span> (driver == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01463"></a>01463         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01464"></a>01464         
<a name="l01465"></a>01465     <span class="comment">/* make a new variable */</span>
<a name="l01466"></a>01466     dvar= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a>), <span class="stringliteral">&quot;DriverVar&quot;</span>);
<a name="l01467"></a>01467     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>, dvar);
<a name="l01468"></a>01468     
<a name="l01469"></a>01469     <span class="comment">/* give the variable a &#39;unique&#39; name */</span>
<a name="l01470"></a>01470     strcpy(dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a9dbf67b7de6552f1b802785c0d96d28b">name</a>, <span class="stringliteral">&quot;var&quot;</span>);
<a name="l01471"></a>01471     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a584e08e337965c8bb232cf7ff28a0e13">BLI_uniquename</a>(&amp;driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>, dvar, <span class="stringliteral">&quot;var&quot;</span>, <span class="charliteral">&#39;_&#39;</span>, offsetof(<a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a>, name), <span class="keyword">sizeof</span>(dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a9dbf67b7de6552f1b802785c0d96d28b">name</a>));
<a name="l01472"></a>01472     
<a name="l01473"></a>01473     <span class="comment">/* set the default type to &#39;single prop&#39; */</span>
<a name="l01474"></a>01474     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#af3943320f375173560fae0463cfad099">driver_change_variable_type</a>(dvar, <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a5fab844c1ef7db8f17ccb4ae57b7934ca6b0fec76581d1fea1e98f1bbba577ed7">DVAR_TYPE_SINGLE_PROP</a>);
<a name="l01475"></a>01475     
<a name="l01476"></a>01476 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l01477"></a>01477 <span class="preprocessor"></span>    <span class="comment">/* since driver variables are cached, the expression needs re-compiling too */</span>
<a name="l01478"></a>01478     <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a3945d10db5e98f2de0797cef16a43fbb">type</a>==<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3a373b8dd334d78c62a7d8f4726046dea8">DRIVER_TYPE_PYTHON</a>)
<a name="l01479"></a>01479         driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> |= <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa78b0f04b5003c6b12b9687a3d837b15c">DRIVER_FLAG_RENAMEVAR</a>;
<a name="l01480"></a>01480 <span class="preprocessor">#endif</span>
<a name="l01481"></a>01481 <span class="preprocessor"></span>
<a name="l01482"></a>01482     <span class="comment">/* return the target */</span>
<a name="l01483"></a>01483     <span class="keywordflow">return</span> dvar;
<a name="l01484"></a>01484 }
<a name="l01485"></a>01485 
<a name="l01486"></a>01486 <span class="comment">/* This frees the driver itself */</span>
<a name="l01487"></a><a class="code" href="../../db/d17/fcurve_8c.html#a1a1bb1ebf7a10f3ccb7b305980c48cb0">01487</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#aa920352dd2079f3978b595c960e63d24">fcurve_free_driver</a>(<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu)
<a name="l01488"></a>01488 {
<a name="l01489"></a>01489     <a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver;
<a name="l01490"></a>01490     <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar, *dvarn;
<a name="l01491"></a>01491     
<a name="l01492"></a>01492     <span class="comment">/* sanity checks */</span>
<a name="l01493"></a>01493     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>))
<a name="l01494"></a>01494         <span class="keywordflow">return</span>;
<a name="l01495"></a>01495     driver= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>;
<a name="l01496"></a>01496     
<a name="l01497"></a>01497     <span class="comment">/* free driver targets */</span>
<a name="l01498"></a>01498     <span class="keywordflow">for</span> (dvar= driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dvar; dvar= dvarn) {
<a name="l01499"></a>01499         dvarn= dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a6cbe874a49fab44dd2e2ec49b5a35da1">next</a>;
<a name="l01500"></a>01500         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae2ee39c1c3566aecc68ab6f67324fa28">driver_free_variable</a>(driver, dvar);
<a name="l01501"></a>01501     }
<a name="l01502"></a>01502 
<a name="l01503"></a>01503 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span>    <span class="comment">/* free compiled driver expression */</span>
<a name="l01505"></a>01505     <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a72ccfa81424a06dd3f40e7b83a2ca1d8">expr_comp</a>)
<a name="l01506"></a>01506         <a class="code" href="../../dc/d76/BPY__extern_8h.html#afe72b6f9e2f6ff7e2a7961f5cdfa9ead">BPY_DECREF</a>(driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a72ccfa81424a06dd3f40e7b83a2ca1d8">expr_comp</a>);
<a name="l01507"></a>01507 <span class="preprocessor">#endif</span>
<a name="l01508"></a>01508 <span class="preprocessor"></span>
<a name="l01509"></a>01509     <span class="comment">/* free driver itself, then set F-Curve&#39;s point to this to NULL (as the curve may still be used) */</span>
<a name="l01510"></a>01510     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(driver);
<a name="l01511"></a>01511     fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01512"></a>01512 }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514 <span class="comment">/* This makes a copy of the given driver */</span>
<a name="l01515"></a><a class="code" href="../../db/d17/fcurve_8c.html#aeffbe1be5de3c35956f8398ebfd526ac">01515</a> <a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *<a class="code" href="../../da/dba/BKE__fcurve_8h.html#a323c524f60e3c9aa2a427f3f897e591c">fcurve_copy_driver</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver)
<a name="l01516"></a>01516 {
<a name="l01517"></a>01517     <a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *ndriver;
<a name="l01518"></a>01518     <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar;
<a name="l01519"></a>01519     
<a name="l01520"></a>01520     <span class="comment">/* sanity checks */</span>
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (driver == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01522"></a>01522         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01523"></a>01523         
<a name="l01524"></a>01524     <span class="comment">/* copy all data */</span>
<a name="l01525"></a>01525     ndriver= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(driver);
<a name="l01526"></a>01526     ndriver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a72ccfa81424a06dd3f40e7b83a2ca1d8">expr_comp</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01527"></a>01527     
<a name="l01528"></a>01528     <span class="comment">/* copy variables */</span>
<a name="l01529"></a>01529     ndriver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= ndriver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01530"></a>01530     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;ndriver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>, &amp;driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>);
<a name="l01531"></a>01531     
<a name="l01532"></a>01532     <span class="keywordflow">for</span> (dvar= ndriver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dvar; dvar= dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a6cbe874a49fab44dd2e2ec49b5a35da1">next</a>) {  
<a name="l01533"></a>01533         <span class="comment">/* need to go over all targets so that we don&#39;t leave any dangling paths */</span>
<a name="l01534"></a>01534         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a94a8b2b8c805858b0e72e8652b5d79b6">DRIVER_TARGETS_LOOPER</a>(dvar) 
<a name="l01535"></a>01535         {   
<a name="l01536"></a>01536             <span class="comment">/* make a copy of target&#39;s rna path if available */</span>
<a name="l01537"></a>01537             <span class="keywordflow">if</span> (dtar-&gt;rna_path)
<a name="l01538"></a>01538                 dtar-&gt;rna_path = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(dtar-&gt;rna_path);
<a name="l01539"></a>01539         }
<a name="l01540"></a>01540         <a class="code" href="../../da/dba/BKE__fcurve_8h.html#ae6f978c887bc26c0da1235ccef77444b">DRIVER_TARGETS_LOOPER_END</a>
<a name="l01541"></a>01541     }
<a name="l01542"></a>01542     
<a name="l01543"></a>01543     <span class="comment">/* return the new driver */</span>
<a name="l01544"></a>01544     <span class="keywordflow">return</span> ndriver;
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547 <span class="comment">/* Driver Evaluation -------------------------- */</span>
<a name="l01548"></a>01548 
<a name="l01549"></a>01549 <span class="comment">/* Evaluate a Driver Variable to get a value that contributes to the final */</span>
<a name="l01550"></a><a class="code" href="../../db/d17/fcurve_8c.html#af719db8703b0b1ae9dd8404f13074336">01550</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a489663e8bbce68ccd7be0de67d620c36">driver_get_variable_value</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar)
<a name="l01551"></a>01551 {
<a name="l01552"></a>01552     <a class="code" href="../../da/d2e/structDriverVarTypeInfo.html">DriverVarTypeInfo</a> *dvti;
<a name="l01553"></a>01553 
<a name="l01554"></a>01554     <span class="comment">/* sanity check */</span>
<a name="l01555"></a>01555     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, driver, dvar))
<a name="l01556"></a>01556         <span class="keywordflow">return</span> 0.0f;
<a name="l01557"></a>01557     
<a name="l01558"></a>01558     <span class="comment">/* call the relevant callbacks to get the variable value </span>
<a name="l01559"></a>01559 <span class="comment">     * using the variable type info, storing the obtained value</span>
<a name="l01560"></a>01560 <span class="comment">     * in dvar-&gt;curval so that drivers can be debugged</span>
<a name="l01561"></a>01561 <span class="comment">     */</span>
<a name="l01562"></a>01562     dvti= <a class="code" href="../../db/d17/fcurve_8c.html#a5b2d069080f08abb46365656e9784296">get_dvar_typeinfo</a>(dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a1d286addd47402783d2353b855db04f3">type</a>);
<a name="l01563"></a>01563     
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (dvti &amp;&amp; dvti-&gt;<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#aa9a1ca73372d582debd48aaf7f018611">get_value</a>)
<a name="l01565"></a>01565         dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a0f21aa0140e861189e1920e6829483e5">curval</a>= dvti-&gt;<a class="code" href="../../da/d2e/structDriverVarTypeInfo.html#aa9a1ca73372d582debd48aaf7f018611">get_value</a>(driver, dvar);
<a name="l01566"></a>01566     <span class="keywordflow">else</span>
<a name="l01567"></a>01567         dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a0f21aa0140e861189e1920e6829483e5">curval</a>= 0.0f;
<a name="l01568"></a>01568     
<a name="l01569"></a>01569     <span class="keywordflow">return</span> dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a0f21aa0140e861189e1920e6829483e5">curval</a>;
<a name="l01570"></a>01570 }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 <span class="comment">/* Evaluate an Channel-Driver to get a &#39;time&#39; value to use instead of &quot;evaltime&quot;</span>
<a name="l01573"></a>01573 <span class="comment"> *  - &quot;evaltime&quot; is the frame at which F-Curve is being evaluated</span>
<a name="l01574"></a>01574 <span class="comment"> *  - has to return a float value </span>
<a name="l01575"></a>01575 <span class="comment"> */</span>
<a name="l01576"></a><a class="code" href="../../db/d17/fcurve_8c.html#ab6782e470a8f172bacfe7aa35358ec2f">01576</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#ab6782e470a8f172bacfe7aa35358ec2f">evaluate_driver</a> (<a class="code" href="../../d3/d1e/structChannelDriver.html">ChannelDriver</a> *driver, <span class="keyword">const</span> <span class="keywordtype">float</span> evaltime)
<a name="l01577"></a>01577 {
<a name="l01578"></a>01578     <a class="code" href="../../d1/d24/structDriverVar.html">DriverVar</a> *dvar;
<a name="l01579"></a>01579     
<a name="l01580"></a>01580     <span class="comment">/* check if driver can be evaluated */</span>
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>)
<a name="l01582"></a>01582         <span class="keywordflow">return</span> 0.0f;
<a name="l01583"></a>01583     
<a name="l01584"></a>01584     <span class="keywordflow">switch</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a3945d10db5e98f2de0797cef16a43fbb">type</a>) {
<a name="l01585"></a>01585         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3a35f1be0ae17dc775aff78508a5243354">DRIVER_TYPE_AVERAGE</a>: <span class="comment">/* average values of driver targets */</span>
<a name="l01586"></a>01586         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3afcae6631b55c5c9a78bfff70836ee5c4">DRIVER_TYPE_SUM</a>: <span class="comment">/* sum values of driver targets */</span>
<a name="l01587"></a>01587         {
<a name="l01588"></a>01588             <span class="comment">/* check how many variables there are first (i.e. just one?) */</span>
<a name="l01589"></a>01589             <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>) {
<a name="l01590"></a>01590                 <span class="comment">/* just one target, so just use that */</span>
<a name="l01591"></a>01591                 dvar= driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01592"></a>01592                 driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a489663e8bbce68ccd7be0de67d620c36">driver_get_variable_value</a>(driver, dvar);
<a name="l01593"></a>01593             }
<a name="l01594"></a>01594             <span class="keywordflow">else</span> {
<a name="l01595"></a>01595                 <span class="comment">/* more than one target, so average the values of the targets */</span>
<a name="l01596"></a>01596                 <span class="keywordtype">float</span> value = 0.0f;
<a name="l01597"></a>01597                 <span class="keywordtype">int</span> tot = 0;
<a name="l01598"></a>01598                 
<a name="l01599"></a>01599                 <span class="comment">/* loop through targets, adding (hopefully we don&#39;t get any overflow!) */</span>
<a name="l01600"></a>01600                 <span class="keywordflow">for</span> (dvar= driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dvar; dvar=dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a6cbe874a49fab44dd2e2ec49b5a35da1">next</a>) {
<a name="l01601"></a>01601                     value += <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a489663e8bbce68ccd7be0de67d620c36">driver_get_variable_value</a>(driver, dvar);
<a name="l01602"></a>01602                     tot++;
<a name="l01603"></a>01603                 }
<a name="l01604"></a>01604                 
<a name="l01605"></a>01605                 <span class="comment">/* perform operations on the total if appropriate */</span>
<a name="l01606"></a>01606                 <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a3945d10db5e98f2de0797cef16a43fbb">type</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3a35f1be0ae17dc775aff78508a5243354">DRIVER_TYPE_AVERAGE</a>)
<a name="l01607"></a>01607                     driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= (value / (float)tot);
<a name="l01608"></a>01608                 <span class="keywordflow">else</span>
<a name="l01609"></a>01609                     driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= value;
<a name="l01610"></a>01610             }
<a name="l01611"></a>01611         }
<a name="l01612"></a>01612             <span class="keywordflow">break</span>;
<a name="l01613"></a>01613             
<a name="l01614"></a>01614         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3af8f632517ef1996ee2faa3b223c38cf4">DRIVER_TYPE_MIN</a>: <span class="comment">/* smallest value */</span>
<a name="l01615"></a>01615         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3aeaa0e73bd12ec3b60da4f3c007a345e9">DRIVER_TYPE_MAX</a>: <span class="comment">/* largest value */</span>
<a name="l01616"></a>01616         {
<a name="l01617"></a>01617             <span class="keywordtype">float</span> value = 0.0f;
<a name="l01618"></a>01618             
<a name="l01619"></a>01619             <span class="comment">/* loop through the variables, getting the values and comparing them to existing ones */</span>
<a name="l01620"></a>01620             <span class="keywordflow">for</span> (dvar= driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a14d54c061db1124addaba9a6a80cce1e">variables</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dvar; dvar= dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#a6cbe874a49fab44dd2e2ec49b5a35da1">next</a>) {
<a name="l01621"></a>01621                 <span class="comment">/* get value */</span>
<a name="l01622"></a>01622                 <span class="keywordtype">float</span> tmp_val= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a489663e8bbce68ccd7be0de67d620c36">driver_get_variable_value</a>(driver, dvar);
<a name="l01623"></a>01623                 
<a name="l01624"></a>01624                 <span class="comment">/* store this value if appropriate */</span>
<a name="l01625"></a>01625                 <span class="keywordflow">if</span> (dvar-&gt;<a class="code" href="../../d1/d24/structDriverVar.html#afb4ef4976657387daf9c8808452ed055">prev</a>) {
<a name="l01626"></a>01626                     <span class="comment">/* check if greater/smaller than the baseline */</span>
<a name="l01627"></a>01627                     <span class="keywordflow">if</span> (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a3945d10db5e98f2de0797cef16a43fbb">type</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3aeaa0e73bd12ec3b60da4f3c007a345e9">DRIVER_TYPE_MAX</a>) {
<a name="l01628"></a>01628                         <span class="comment">/* max? */</span>
<a name="l01629"></a>01629                         <span class="keywordflow">if</span> (tmp_val &gt; value) 
<a name="l01630"></a>01630                             value= tmp_val;
<a name="l01631"></a>01631                     }
<a name="l01632"></a>01632                     <span class="keywordflow">else</span> {
<a name="l01633"></a>01633                         <span class="comment">/* min? */</span>
<a name="l01634"></a>01634                         <span class="keywordflow">if</span> (tmp_val &lt; value) 
<a name="l01635"></a>01635                             value= tmp_val;
<a name="l01636"></a>01636                     }
<a name="l01637"></a>01637                 }
<a name="l01638"></a>01638                 <span class="keywordflow">else</span> {
<a name="l01639"></a>01639                     <span class="comment">/* first item - make this the baseline for comparisons */</span>
<a name="l01640"></a>01640                     value= tmp_val;
<a name="l01641"></a>01641                 }
<a name="l01642"></a>01642             }
<a name="l01643"></a>01643             
<a name="l01644"></a>01644             <span class="comment">/* store value in driver */</span>
<a name="l01645"></a>01645             driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= value;
<a name="l01646"></a>01646         }
<a name="l01647"></a>01647             <span class="keywordflow">break</span>;
<a name="l01648"></a>01648             
<a name="l01649"></a>01649         <span class="keywordflow">case</span> <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#a473d8cf531a0db376806d5149760dfd3a373b8dd334d78c62a7d8f4726046dea8">DRIVER_TYPE_PYTHON</a>: <span class="comment">/* expression */</span>
<a name="l01650"></a>01650         {
<a name="l01651"></a>01651 <span class="preprocessor">#ifdef WITH_PYTHON</span>
<a name="l01652"></a>01652 <span class="preprocessor"></span>            <span class="comment">/* check for empty or invalid expression */</span>
<a name="l01653"></a>01653             <span class="keywordflow">if</span> ( (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#ad47404498424ae42fcd4c2804edbf1c6">expression</a>[0] == <span class="charliteral">&#39;\0&#39;</span>) ||
<a name="l01654"></a>01654                  (driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>) )
<a name="l01655"></a>01655             {
<a name="l01656"></a>01656                 driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= 0.0f;
<a name="l01657"></a>01657             }
<a name="l01658"></a>01658             <span class="keywordflow">else</span>
<a name="l01659"></a>01659             {
<a name="l01660"></a>01660                 <span class="comment">/* this evaluates the expression using Python,and returns its result:</span>
<a name="l01661"></a>01661 <span class="comment">                 *  - on errors it reports, then returns 0.0f</span>
<a name="l01662"></a>01662 <span class="comment">                 */</span>
<a name="l01663"></a>01663                 driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>= <a class="code" href="../../dc/d76/BPY__extern_8h.html#a8c4bdcc6454ba71d6f72e2b899c68d08">BPY_driver_exec</a>(driver, evaltime);
<a name="l01664"></a>01664             }
<a name="l01665"></a>01665 <span class="preprocessor">#else </span><span class="comment">/* WITH_PYTHON*/</span>
<a name="l01666"></a>01666         (void)evaltime;
<a name="l01667"></a>01667 <span class="preprocessor">#endif </span><span class="comment">/* WITH_PYTHON*/</span>
<a name="l01668"></a>01668         }
<a name="l01669"></a>01669             <span class="keywordflow">break</span>;
<a name="l01670"></a>01670         
<a name="l01671"></a>01671         <span class="keywordflow">default</span>:
<a name="l01672"></a>01672         {
<a name="l01673"></a>01673             <span class="comment">/* special &#39;hack&#39; - just use stored value </span>
<a name="l01674"></a>01674 <span class="comment">             *  This is currently used as the mechanism which allows animated settings to be able</span>
<a name="l01675"></a>01675 <span class="comment">             *  to be changed via the UI.</span>
<a name="l01676"></a>01676 <span class="comment">             */</span>
<a name="l01677"></a>01677         }
<a name="l01678"></a>01678     }
<a name="l01679"></a>01679     
<a name="l01680"></a>01680     <span class="comment">/* return value for driver */</span>
<a name="l01681"></a>01681     <span class="keywordflow">return</span> driver-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a7597121f661e483bb9164843c105ca67">curval</a>;
<a name="l01682"></a>01682 }
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 <span class="comment">/* ***************************** Curve Calculations ********************************* */</span>
<a name="l01685"></a>01685 
<a name="l01686"></a>01686 <span class="comment">/* The total length of the handles is not allowed to be more</span>
<a name="l01687"></a>01687 <span class="comment"> * than the horizontal distance between (v1-v4).</span>
<a name="l01688"></a>01688 <span class="comment"> * This is to prevent curve loops.</span>
<a name="l01689"></a>01689 <span class="comment"> */</span>
<a name="l01690"></a><a class="code" href="../../db/d17/fcurve_8c.html#a7a0a78c857aa3664f92023bf248ad4dd">01690</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1f8abee2136c70ce678fb55a8f881060">correct_bezpart</a>(<span class="keywordtype">float</span> v1[2], <span class="keywordtype">float</span> v2[2], <span class="keywordtype">float</span> v3[2], <span class="keywordtype">float</span> v4[2])
<a name="l01691"></a>01691 {
<a name="l01692"></a>01692     <span class="keywordtype">float</span> h1[2], h2[2], len1, len2, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, fac;
<a name="l01693"></a>01693     
<a name="l01694"></a>01694     <span class="comment">/* calculate handle deltas */</span>
<a name="l01695"></a>01695     h1[0]= v1[0] - v2[0];
<a name="l01696"></a>01696     h1[1]= v1[1] - v2[1];
<a name="l01697"></a>01697     
<a name="l01698"></a>01698     h2[0]= v4[0] - v3[0];
<a name="l01699"></a>01699     h2[1]= v4[1] - v3[1];
<a name="l01700"></a>01700     
<a name="l01701"></a>01701     <span class="comment">/* calculate distances: </span>
<a name="l01702"></a>01702 <span class="comment">     *  - len   = span of time between keyframes </span>
<a name="l01703"></a>01703 <span class="comment">     *  - len1  = length of handle of start key</span>
<a name="l01704"></a>01704 <span class="comment">     *  - len2  = length of handle of end key</span>
<a name="l01705"></a>01705 <span class="comment">     */</span>
<a name="l01706"></a>01706     len= v4[0]- v1[0];
<a name="l01707"></a>01707     len1= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(h1[0]);
<a name="l01708"></a>01708     len2= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(h2[0]);
<a name="l01709"></a>01709     
<a name="l01710"></a>01710     <span class="comment">/* if the handles have no length, no need to do any corrections */</span>
<a name="l01711"></a>01711     <span class="keywordflow">if</span> ((len1+len2) == 0.0f) 
<a name="l01712"></a>01712         <span class="keywordflow">return</span>;
<a name="l01713"></a>01713         
<a name="l01714"></a>01714     <span class="comment">/* the two handles cross over each other, so force them</span>
<a name="l01715"></a>01715 <span class="comment">     * apart using the proportion they overlap </span>
<a name="l01716"></a>01716 <span class="comment">     */</span>
<a name="l01717"></a>01717     <span class="keywordflow">if</span> ((len1+len2) &gt; len) {
<a name="l01718"></a>01718         fac= len / (len1+len2);
<a name="l01719"></a>01719         
<a name="l01720"></a>01720         v2[0]= (v1[0] - fac*h1[0]);
<a name="l01721"></a>01721         v2[1]= (v1[1] - fac*h1[1]);
<a name="l01722"></a>01722         
<a name="l01723"></a>01723         v3[0]= (v4[0] - fac*h2[0]);
<a name="l01724"></a>01724         v3[1]= (v4[1] - fac*h2[1]);
<a name="l01725"></a>01725     }
<a name="l01726"></a>01726 }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728 <span class="comment">/* find root (&#39;zero&#39;) */</span>
<a name="l01729"></a><a class="code" href="../../db/d17/fcurve_8c.html#a9adc6563be48f8124a471b00392127a0">01729</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d17/fcurve_8c.html#a9adc6563be48f8124a471b00392127a0">findzero</a> (<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> q0, <span class="keywordtype">float</span> q1, <span class="keywordtype">float</span> q2, <span class="keywordtype">float</span> q3, <span class="keywordtype">float</span> *o)
<a name="l01730"></a>01730 {
<a name="l01731"></a>01731     <span class="keywordtype">double</span> c0, c1, c2, c3, a, b, c, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, q, d, t, phi;
<a name="l01732"></a>01732     <span class="keywordtype">int</span> nr= 0;
<a name="l01733"></a>01733 
<a name="l01734"></a>01734     c0= q0 - x;
<a name="l01735"></a>01735     c1= 3.0f * (q1 - q0);
<a name="l01736"></a>01736     c2= 3.0f * (q0 - 2.0f*q1 + q2);
<a name="l01737"></a>01737     c3= q3 - q0 + 3.0f * (q1 - q2);
<a name="l01738"></a>01738     
<a name="l01739"></a>01739     <span class="keywordflow">if</span> (c3 != 0.0) {
<a name="l01740"></a>01740         a= c2/c3;
<a name="l01741"></a>01741         b= c1/c3;
<a name="l01742"></a>01742         c= c0/c3;
<a name="l01743"></a>01743         a= a/3;
<a name="l01744"></a>01744         
<a name="l01745"></a>01745         p= b/3 - a*a;
<a name="l01746"></a>01746         q= (2*a*a*a - a*b + c) / 2;
<a name="l01747"></a>01747         d= q*q + p*p*<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01748"></a>01748         
<a name="l01749"></a>01749         <span class="keywordflow">if</span> (d &gt; 0.0) {
<a name="l01750"></a>01750             t= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(d);
<a name="l01751"></a>01751             o[0]= (float)(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac2d79438db19f6f51938185af26fb02f">sqrt3d</a>(-q+t) + <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac2d79438db19f6f51938185af26fb02f">sqrt3d</a>(-q-t) - a);
<a name="l01752"></a>01752             
<a name="l01753"></a>01753             <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) <span class="keywordflow">return</span> 1;
<a name="l01754"></a>01754             <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l01755"></a>01755         }
<a name="l01756"></a>01756         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d == 0.0) {
<a name="l01757"></a>01757             t= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ac2d79438db19f6f51938185af26fb02f">sqrt3d</a>(-q);
<a name="l01758"></a>01758             o[0]= (float)(2*t - a);
<a name="l01759"></a>01759             
<a name="l01760"></a>01760             <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) nr++;
<a name="l01761"></a>01761             o[nr]= (float)(-t-a);
<a name="l01762"></a>01762             
<a name="l01763"></a>01763             <span class="keywordflow">if</span> ((o[nr] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[nr] &lt;= 1.000001f)) <span class="keywordflow">return</span> nr+1;
<a name="l01764"></a>01764             <span class="keywordflow">else</span> <span class="keywordflow">return</span> nr;
<a name="l01765"></a>01765         }
<a name="l01766"></a>01766         <span class="keywordflow">else</span> {
<a name="l01767"></a>01767             phi= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(-q / <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(-(p*p*p)));
<a name="l01768"></a>01768             t= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(-p);
<a name="l01769"></a>01769             p= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(phi/3);
<a name="l01770"></a>01770             q= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(3 - 3*p*p);
<a name="l01771"></a>01771             o[0]= (float)(2*t*p - a);
<a name="l01772"></a>01772             
<a name="l01773"></a>01773             <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) nr++;
<a name="l01774"></a>01774             o[nr]= (float)(-t * (p + q) - a);
<a name="l01775"></a>01775             
<a name="l01776"></a>01776             <span class="keywordflow">if</span> ((o[nr] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[nr] &lt;= 1.000001f)) nr++;
<a name="l01777"></a>01777             o[nr]= (float)(-t * (p - q) - a);
<a name="l01778"></a>01778             
<a name="l01779"></a>01779             <span class="keywordflow">if</span> ((o[nr] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[nr] &lt;= 1.000001f)) <span class="keywordflow">return</span> nr+1;
<a name="l01780"></a>01780             <span class="keywordflow">else</span> <span class="keywordflow">return</span> nr;
<a name="l01781"></a>01781         }
<a name="l01782"></a>01782     }
<a name="l01783"></a>01783     <span class="keywordflow">else</span> {
<a name="l01784"></a>01784         a=c2;
<a name="l01785"></a>01785         b=c1;
<a name="l01786"></a>01786         c=c0;
<a name="l01787"></a>01787         
<a name="l01788"></a>01788         <span class="keywordflow">if</span> (a != 0.0) {
<a name="l01789"></a>01789             <span class="comment">// discriminant</span>
<a name="l01790"></a>01790             p= b*b - 4*a*c;
<a name="l01791"></a>01791             
<a name="l01792"></a>01792             <span class="keywordflow">if</span> (p &gt; 0) {
<a name="l01793"></a>01793                 p= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(p);
<a name="l01794"></a>01794                 o[0]= (float)((-b-p) / (2 * a));
<a name="l01795"></a>01795                 
<a name="l01796"></a>01796                 <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) nr++;
<a name="l01797"></a>01797                 o[nr]= (float)((-b+p)/(2*a));
<a name="l01798"></a>01798                 
<a name="l01799"></a>01799                 <span class="keywordflow">if</span> ((o[nr] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[nr] &lt;= 1.000001f)) <span class="keywordflow">return</span> nr+1;
<a name="l01800"></a>01800                 <span class="keywordflow">else</span> <span class="keywordflow">return</span> nr;
<a name="l01801"></a>01801             }
<a name="l01802"></a>01802             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p == 0) {
<a name="l01803"></a>01803                 o[0]= (float)(-b / (2 * a));
<a name="l01804"></a>01804                 <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) <span class="keywordflow">return</span> 1;
<a name="l01805"></a>01805                 <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l01806"></a>01806             }
<a name="l01807"></a>01807         }
<a name="l01808"></a>01808         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (b != 0.0) {
<a name="l01809"></a>01809             o[0]= (float)(-c/b);
<a name="l01810"></a>01810             
<a name="l01811"></a>01811             <span class="keywordflow">if</span> ((o[0] &gt;= (<span class="keywordtype">float</span>)<a class="code" href="../../db/d17/fcurve_8c.html#a09c78d2f8feb311dd9fc969a0bf84979">SMALL</a>) &amp;&amp; (o[0] &lt;= 1.000001f)) <span class="keywordflow">return</span> 1;
<a name="l01812"></a>01812             <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l01813"></a>01813         }
<a name="l01814"></a>01814         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == 0.0) {
<a name="l01815"></a>01815             o[0]= 0.0;
<a name="l01816"></a>01816             <span class="keywordflow">return</span> 1;
<a name="l01817"></a>01817         }
<a name="l01818"></a>01818         
<a name="l01819"></a>01819         <span class="keywordflow">return</span> 0;   
<a name="l01820"></a>01820     }
<a name="l01821"></a>01821 }
<a name="l01822"></a>01822 
<a name="l01823"></a><a class="code" href="../../db/d17/fcurve_8c.html#a5ca84beb1b733f7f1579c9f27e989907">01823</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../db/d17/fcurve_8c.html#a5ca84beb1b733f7f1579c9f27e989907">berekeny</a> (<span class="keywordtype">float</span> f1, <span class="keywordtype">float</span> f2, <span class="keywordtype">float</span> f3, <span class="keywordtype">float</span> f4, <span class="keywordtype">float</span> *o, <span class="keywordtype">int</span> b)
<a name="l01824"></a>01824 {
<a name="l01825"></a>01825     <span class="keywordtype">float</span> t, c0, c1, c2, c3;
<a name="l01826"></a>01826     <span class="keywordtype">int</span> a;
<a name="l01827"></a>01827 
<a name="l01828"></a>01828     c0= f1;
<a name="l01829"></a>01829     c1= 3.0f * (f2 - f1);
<a name="l01830"></a>01830     c2= 3.0f * (f1 - 2.0f*f2 + f3);
<a name="l01831"></a>01831     c3= f4 - f1 + 3.0f * (f2 - f3);
<a name="l01832"></a>01832     
<a name="l01833"></a>01833     <span class="keywordflow">for</span> (a=0; a &lt; b; a++) {
<a name="l01834"></a>01834         t= o[a];
<a name="l01835"></a>01835         o[a]= c0 + t*c1 + t*t*c2 + t*t*t*c3;
<a name="l01836"></a>01836     }
<a name="l01837"></a>01837 }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839 <span class="preprocessor">#if 0</span>
<a name="l01840"></a>01840 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> berekenx (<span class="keywordtype">float</span> *f, <span class="keywordtype">float</span> *o, <span class="keywordtype">int</span> b)
<a name="l01841"></a>01841 {
<a name="l01842"></a>01842     <span class="keywordtype">float</span> t, c0, c1, c2, c3;
<a name="l01843"></a>01843     <span class="keywordtype">int</span> a;
<a name="l01844"></a>01844 
<a name="l01845"></a>01845     c0= f[0];
<a name="l01846"></a>01846     c1= 3.0f * (f[3] - f[0]);
<a name="l01847"></a>01847     c2= 3.0f * (f[0] - 2.0f*f[3] + f[6]);
<a name="l01848"></a>01848     c3= f[9] - f[0] + 3.0f * (f[3] - f[6]);
<a name="l01849"></a>01849     
<a name="l01850"></a>01850     <span class="keywordflow">for</span> (a=0; a &lt; b; a++) {
<a name="l01851"></a>01851         t= o[a];
<a name="l01852"></a>01852         o[a]= c0 + t*c1 + t*t*c2 + t*t*t*c3;
<a name="l01853"></a>01853     }
<a name="l01854"></a>01854 }
<a name="l01855"></a>01855 <span class="preprocessor">#endif</span>
<a name="l01856"></a>01856 <span class="preprocessor"></span>
<a name="l01857"></a>01857 
<a name="l01858"></a>01858 <span class="comment">/* -------------------------- */</span>
<a name="l01859"></a>01859 
<a name="l01860"></a>01860 <span class="comment">/* Calculate F-Curve value for &#39;evaltime&#39; using BezTriple keyframes */</span>
<a name="l01861"></a><a class="code" href="../../db/d17/fcurve_8c.html#ae5f7ee7b8c0588b40210402cb41f99ba">01861</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#ae5f7ee7b8c0588b40210402cb41f99ba">fcurve_eval_keyframes</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezts, <span class="keywordtype">float</span> evaltime)
<a name="l01862"></a>01862 {
<a name="l01863"></a>01863     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt, *prevbezt, *lastbezt;
<a name="l01864"></a>01864     <span class="keywordtype">float</span> v1[2], v2[2], v3[2], v4[2], opl[32], dx, fac;
<a name="l01865"></a>01865     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l01866"></a>01866     <span class="keywordtype">int</span> b;
<a name="l01867"></a>01867     <span class="keywordtype">float</span> cvalue = 0.0f;
<a name="l01868"></a>01868     
<a name="l01869"></a>01869     <span class="comment">/* get pointers */</span>
<a name="l01870"></a>01870     a= fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1;
<a name="l01871"></a>01871     prevbezt= bezts;
<a name="l01872"></a>01872     bezt= prevbezt+1;
<a name="l01873"></a>01873     lastbezt= prevbezt + a;
<a name="l01874"></a>01874     
<a name="l01875"></a>01875     <span class="comment">/* evaluation time at or past endpoints? */</span>
<a name="l01876"></a>01876     <span class="keywordflow">if</span> (prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt;= evaltime) {
<a name="l01877"></a>01877         <span class="comment">/* before or on first keyframe */</span>
<a name="l01878"></a>01878         <span class="keywordflow">if</span> ( (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ac932d96a37634a3b105b80b0daf3afd5">extend</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#adb4a5053227c5d734c2586c5b536ddcaa9fb213c325c652c818d9a4025fb9de47">FCURVE_EXTRAPOLATE_LINEAR</a>) &amp;&amp; (prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a> != <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5a8a7c4acc7a8382a9c8e1f88c9688254d">BEZT_IPO_CONST</a>) &amp;&amp;
<a name="l01879"></a>01879             !(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>) )
<a name="l01880"></a>01880         {
<a name="l01881"></a>01881             <span class="comment">/* linear or bezier interpolation */</span>
<a name="l01882"></a>01882             <span class="keywordflow">if</span> (prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5aa1cd3be3b402e1401033731c66a1613b">BEZT_IPO_LIN</a>) {
<a name="l01883"></a>01883                 <span class="comment">/* Use the next center point instead of our own handle for</span>
<a name="l01884"></a>01884 <span class="comment">                 * linear interpolated extrapolate </span>
<a name="l01885"></a>01885 <span class="comment">                 */</span>
<a name="l01886"></a>01886                 <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> == 1) {
<a name="l01887"></a>01887                     cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01888"></a>01888                 }
<a name="l01889"></a>01889                 <span class="keywordflow">else</span> {
<a name="l01890"></a>01890                     bezt = prevbezt+1;
<a name="l01891"></a>01891                     dx= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - evaltime;
<a name="l01892"></a>01892                     fac= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l01893"></a>01893                     
<a name="l01894"></a>01894                     <span class="comment">/* prevent division by zero */</span>
<a name="l01895"></a>01895                     <span class="keywordflow">if</span> (fac) {
<a name="l01896"></a>01896                         fac= (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1]) / fac;
<a name="l01897"></a>01897                         cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - (fac * dx);
<a name="l01898"></a>01898                     }
<a name="l01899"></a>01899                     <span class="keywordflow">else</span> {
<a name="l01900"></a>01900                         cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01901"></a>01901                     }
<a name="l01902"></a>01902                 }
<a name="l01903"></a>01903             } 
<a name="l01904"></a>01904             <span class="keywordflow">else</span> {
<a name="l01905"></a>01905                 <span class="comment">/* Use the first handle (earlier) of first BezTriple to calculate the</span>
<a name="l01906"></a>01906 <span class="comment">                 * gradient and thus the value of the curve at evaltime</span>
<a name="l01907"></a>01907 <span class="comment">                 */</span>
<a name="l01908"></a>01908                 dx= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - evaltime;
<a name="l01909"></a>01909                 fac= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0];
<a name="l01910"></a>01910                 
<a name="l01911"></a>01911                 <span class="comment">/* prevent division by zero */</span>
<a name="l01912"></a>01912                 <span class="keywordflow">if</span> (fac) {
<a name="l01913"></a>01913                     fac= (prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1]) / fac;
<a name="l01914"></a>01914                     cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - (fac * dx);
<a name="l01915"></a>01915                 }
<a name="l01916"></a>01916                 <span class="keywordflow">else</span> {
<a name="l01917"></a>01917                     cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01918"></a>01918                 }
<a name="l01919"></a>01919             }
<a name="l01920"></a>01920         }
<a name="l01921"></a>01921         <span class="keywordflow">else</span> {
<a name="l01922"></a>01922             <span class="comment">/* constant (BEZT_IPO_HORIZ) extrapolation or constant interpolation, </span>
<a name="l01923"></a>01923 <span class="comment">             * so just extend first keyframe&#39;s value </span>
<a name="l01924"></a>01924 <span class="comment">             */</span>
<a name="l01925"></a>01925             cvalue= prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01926"></a>01926         }
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &lt;= evaltime) {
<a name="l01929"></a>01929         <span class="comment">/* after or on last keyframe */</span>
<a name="l01930"></a>01930         <span class="keywordflow">if</span> ( (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ac932d96a37634a3b105b80b0daf3afd5">extend</a> == <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#adb4a5053227c5d734c2586c5b536ddcaa9fb213c325c652c818d9a4025fb9de47">FCURVE_EXTRAPOLATE_LINEAR</a>) &amp;&amp; (lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a> != <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5a8a7c4acc7a8382a9c8e1f88c9688254d">BEZT_IPO_CONST</a>) &amp;&amp;
<a name="l01931"></a>01931             !(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>) ) 
<a name="l01932"></a>01932         {
<a name="l01933"></a>01933             <span class="comment">/* linear or bezier interpolation */</span>
<a name="l01934"></a>01934             <span class="keywordflow">if</span> (lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a2b20e9a54cf1f1637920ae56f75d0926">ipo</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5aa1cd3be3b402e1401033731c66a1613b">BEZT_IPO_LIN</a>) {
<a name="l01935"></a>01935                 <span class="comment">/* Use the next center point instead of our own handle for</span>
<a name="l01936"></a>01936 <span class="comment">                 * linear interpolated extrapolate </span>
<a name="l01937"></a>01937 <span class="comment">                 */</span>
<a name="l01938"></a>01938                 <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a> == 1) {
<a name="l01939"></a>01939                     cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01940"></a>01940                 }
<a name="l01941"></a>01941                 <span class="keywordflow">else</span> {
<a name="l01942"></a>01942                     prevbezt = lastbezt - 1;
<a name="l01943"></a>01943                     dx= evaltime - lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l01944"></a>01944                     fac= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l01945"></a>01945                     
<a name="l01946"></a>01946                     <span class="comment">/* prevent division by zero */</span>
<a name="l01947"></a>01947                     <span class="keywordflow">if</span> (fac) {
<a name="l01948"></a>01948                         fac= (lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - prevbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1]) / fac;
<a name="l01949"></a>01949                         cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] + (fac * dx);
<a name="l01950"></a>01950                     }
<a name="l01951"></a>01951                     <span class="keywordflow">else</span> {
<a name="l01952"></a>01952                         cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01953"></a>01953                     }
<a name="l01954"></a>01954                 }
<a name="l01955"></a>01955             } 
<a name="l01956"></a>01956             <span class="keywordflow">else</span> {
<a name="l01957"></a>01957                 <span class="comment">/* Use the gradient of the second handle (later) of last BezTriple to calculate the</span>
<a name="l01958"></a>01958 <span class="comment">                 * gradient and thus the value of the curve at evaltime</span>
<a name="l01959"></a>01959 <span class="comment">                 */</span>
<a name="l01960"></a>01960                 dx= evaltime - lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l01961"></a>01961                 fac= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0] - lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l01962"></a>01962                 
<a name="l01963"></a>01963                 <span class="comment">/* prevent division by zero */</span>
<a name="l01964"></a>01964                 <span class="keywordflow">if</span> (fac) {
<a name="l01965"></a>01965                     fac= (lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1] - lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1]) / fac;
<a name="l01966"></a>01966                     cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] + (fac * dx);
<a name="l01967"></a>01967                 }
<a name="l01968"></a>01968                 <span class="keywordflow">else</span> {
<a name="l01969"></a>01969                     cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01970"></a>01970                 }
<a name="l01971"></a>01971             }
<a name="l01972"></a>01972         }
<a name="l01973"></a>01973         <span class="keywordflow">else</span> {
<a name="l01974"></a>01974             <span class="comment">/* constant (BEZT_IPO_HORIZ) extrapolation or constant interpolation, </span>
<a name="l01975"></a>01975 <span class="comment">             * so just extend last keyframe&#39;s value </span>
<a name="l01976"></a>01976 <span class="comment">             */</span>
<a name="l01977"></a>01977             cvalue= lastbezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01978"></a>01978         }
<a name="l01979"></a>01979     }
<a name="l01980"></a>01980     <span class="keywordflow">else</span> {
<a name="l01981"></a>01981         <span class="comment">/* evaltime occurs somewhere in the middle of the curve */</span>
<a name="l01982"></a>01982         <span class="keywordflow">for</span> (a=0; prevbezt &amp;&amp; bezt &amp;&amp; (a &lt; fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1); a++, prevbezt=bezt, bezt++) {
<a name="l01983"></a>01983             <span class="comment">/* use if the key is directly on the frame, rare cases this is needed else we get 0.0 instead. */</span>
<a name="l01984"></a>01984             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - evaltime) &lt; <a class="code" href="../../d3/d35/math__base__inline_8c.html#a4b9c2c17b44d318829df5e1bd7e50f1d">SMALL_NUMBER</a>) {
<a name="l01985"></a>01985                 cvalue= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l01986"></a>01986             }
<a name="l01987"></a>01987             <span class="comment">/* evaltime occurs within the interval defined by these two keyframes */</span>
<a name="l01988"></a>01988             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((prevbezt-&gt;vec[1][0] &lt;= evaltime) &amp;&amp; (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] &gt;= evaltime)) {
<a name="l01989"></a>01989                 <span class="comment">/* value depends on interpolation mode */</span>
<a name="l01990"></a>01990                 <span class="keywordflow">if</span> ((prevbezt-&gt;ipo == <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5a8a7c4acc7a8382a9c8e1f88c9688254d">BEZT_IPO_CONST</a>) || (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464ab4fca2d24ce8b1b1482c796adf0f115f">FCURVE_DISCRETE_VALUES</a>)) {
<a name="l01991"></a>01991                     <span class="comment">/* constant (evaltime not relevant, so no interpolation needed) */</span>
<a name="l01992"></a>01992                     cvalue= prevbezt-&gt;vec[1][1];
<a name="l01993"></a>01993                 }
<a name="l01994"></a>01994                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prevbezt-&gt;ipo == <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad74346e6c15814750cc9c5eb6369fda5aa1cd3be3b402e1401033731c66a1613b">BEZT_IPO_LIN</a>) {
<a name="l01995"></a>01995                     <span class="comment">/* linear - interpolate between values of the two keyframes */</span>
<a name="l01996"></a>01996                     fac= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] - prevbezt-&gt;vec[1][0];
<a name="l01997"></a>01997                     
<a name="l01998"></a>01998                     <span class="comment">/* prevent division by zero */</span>
<a name="l01999"></a>01999                     <span class="keywordflow">if</span> (fac) {
<a name="l02000"></a>02000                         fac= (evaltime - prevbezt-&gt;vec[1][0]) / fac;
<a name="l02001"></a>02001                         cvalue= prevbezt-&gt;vec[1][1] + (fac * (bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1] - prevbezt-&gt;vec[1][1]));
<a name="l02002"></a>02002                     }
<a name="l02003"></a>02003                     <span class="keywordflow">else</span> {
<a name="l02004"></a>02004                         cvalue= prevbezt-&gt;vec[1][1];
<a name="l02005"></a>02005                     }
<a name="l02006"></a>02006                 }
<a name="l02007"></a>02007                 <span class="keywordflow">else</span> {
<a name="l02008"></a>02008                     <span class="comment">/* bezier interpolation */</span>
<a name="l02009"></a>02009                         <span class="comment">/* v1,v2 are the first keyframe and its 2nd handle */</span>
<a name="l02010"></a>02010                     v1[0]= prevbezt-&gt;vec[1][0];
<a name="l02011"></a>02011                     v1[1]= prevbezt-&gt;vec[1][1];
<a name="l02012"></a>02012                     v2[0]= prevbezt-&gt;vec[2][0];
<a name="l02013"></a>02013                     v2[1]= prevbezt-&gt;vec[2][1];
<a name="l02014"></a>02014                         <span class="comment">/* v3,v4 are the last keyframe&#39;s 1st handle + the last keyframe */</span>
<a name="l02015"></a>02015                     v3[0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0];
<a name="l02016"></a>02016                     v3[1]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1];
<a name="l02017"></a>02017                     v4[0]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0];
<a name="l02018"></a>02018                     v4[1]= bezt-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l02019"></a>02019                     
<a name="l02020"></a>02020                     <span class="comment">/* adjust handles so that they don&#39;t overlap (forming a loop) */</span>
<a name="l02021"></a>02021                     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1f8abee2136c70ce678fb55a8f881060">correct_bezpart</a>(v1, v2, v3, v4);
<a name="l02022"></a>02022                     
<a name="l02023"></a>02023                     <span class="comment">/* try to get a value for this position - if failure, try another set of points */</span>
<a name="l02024"></a>02024                     b= <a class="code" href="../../db/d17/fcurve_8c.html#a9adc6563be48f8124a471b00392127a0">findzero</a>(evaltime, v1[0], v2[0], v3[0], v4[0], opl);
<a name="l02025"></a>02025                     <span class="keywordflow">if</span> (b) {
<a name="l02026"></a>02026                         <a class="code" href="../../db/d17/fcurve_8c.html#a5ca84beb1b733f7f1579c9f27e989907">berekeny</a>(v1[1], v2[1], v3[1], v4[1], opl, 1);
<a name="l02027"></a>02027                         cvalue= opl[0];
<a name="l02028"></a>02028                         <span class="keywordflow">break</span>;
<a name="l02029"></a>02029                     }
<a name="l02030"></a>02030                 }
<a name="l02031"></a>02031             }
<a name="l02032"></a>02032         }
<a name="l02033"></a>02033     }
<a name="l02034"></a>02034     
<a name="l02035"></a>02035     <span class="comment">/* return value */</span>
<a name="l02036"></a>02036     <span class="keywordflow">return</span> cvalue;
<a name="l02037"></a>02037 }
<a name="l02038"></a>02038 
<a name="l02039"></a>02039 <span class="comment">/* Calculate F-Curve value for &#39;evaltime&#39; using FPoint samples */</span>
<a name="l02040"></a><a class="code" href="../../db/d17/fcurve_8c.html#a0d53e9b7307398d6bd0f081afc77d9c8">02040</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d17/fcurve_8c.html#a0d53e9b7307398d6bd0f081afc77d9c8">fcurve_eval_samples</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *fpts, <span class="keywordtype">float</span> evaltime)
<a name="l02041"></a>02041 {
<a name="l02042"></a>02042     <a class="code" href="../../dc/d4a/structFPoint.html">FPoint</a> *prevfpt, *lastfpt, *fpt;
<a name="l02043"></a>02043     <span class="keywordtype">float</span> cvalue= 0.0f;
<a name="l02044"></a>02044     
<a name="l02045"></a>02045     <span class="comment">/* get pointers */</span>
<a name="l02046"></a>02046     prevfpt= fpts;
<a name="l02047"></a>02047     lastfpt= prevfpt + fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>-1;
<a name="l02048"></a>02048     
<a name="l02049"></a>02049     <span class="comment">/* evaluation time at or past endpoints? */</span>
<a name="l02050"></a>02050     <span class="keywordflow">if</span> (prevfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0] &gt;= evaltime) {
<a name="l02051"></a>02051         <span class="comment">/* before or on first sample, so just extend value */</span>
<a name="l02052"></a>02052         cvalue= prevfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l02053"></a>02053     }
<a name="l02054"></a>02054     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0] &lt;= evaltime) {
<a name="l02055"></a>02055         <span class="comment">/* after or on last sample, so just extend value */</span>
<a name="l02056"></a>02056         cvalue= lastfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l02057"></a>02057     }
<a name="l02058"></a>02058     <span class="keywordflow">else</span> {
<a name="l02059"></a>02059         <span class="keywordtype">float</span> t= (float)<a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(evaltime - (<span class="keywordtype">int</span>)evaltime);
<a name="l02060"></a>02060         
<a name="l02061"></a>02061         <span class="comment">/* find the one on the right frame (assume that these are spaced on 1-frame intervals) */</span>
<a name="l02062"></a>02062         fpt= prevfpt + (int)(evaltime - prevfpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[0]);
<a name="l02063"></a>02063         
<a name="l02064"></a>02064         <span class="comment">/* if not exactly on the frame, perform linear interpolation with the next one */</span>
<a name="l02065"></a>02065         <span class="keywordflow">if</span> (t != 0.0f) 
<a name="l02066"></a>02066             cvalue= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab81894572f3dfe3985161cf8595bbe3a">interpf</a>(fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1], (fpt+1)-&gt;vec[1], t);
<a name="l02067"></a>02067         <span class="keywordflow">else</span>
<a name="l02068"></a>02068             cvalue= fpt-&gt;<a class="code" href="../../dc/d4a/structFPoint.html#af7a341292136798d8aae227f1cceffeb">vec</a>[1];
<a name="l02069"></a>02069     }
<a name="l02070"></a>02070     
<a name="l02071"></a>02071     <span class="comment">/* return value */</span>
<a name="l02072"></a>02072     <span class="keywordflow">return</span> cvalue;
<a name="l02073"></a>02073 }
<a name="l02074"></a>02074 
<a name="l02075"></a>02075 <span class="comment">/* ***************************** F-Curve - Evaluation ********************************* */</span>
<a name="l02076"></a>02076 
<a name="l02077"></a>02077 <span class="comment">/* Evaluate and return the value of the given F-Curve at the specified frame (&quot;evaltime&quot;) </span>
<a name="l02078"></a>02078 <span class="comment"> * Note: this is also used for drivers</span>
<a name="l02079"></a>02079 <span class="comment"> */</span>
<a name="l02080"></a><a class="code" href="../../db/d17/fcurve_8c.html#a0165a45897dcb036020b67e48234d93d">02080</a> <span class="keywordtype">float</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1ddf79cf14ac3b61c5ea5f3a3af5bd0c">evaluate_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> evaltime)
<a name="l02081"></a>02081 {
<a name="l02082"></a>02082     <span class="keywordtype">float</span> cvalue= 0.0f;
<a name="l02083"></a>02083     <span class="keywordtype">float</span> devaltime;
<a name="l02084"></a>02084     
<a name="l02085"></a>02085     <span class="comment">/* if there is a driver (only if this F-Curve is acting as &#39;driver&#39;), evaluate it to find value to use as &quot;evaltime&quot; </span>
<a name="l02086"></a>02086 <span class="comment">     * since drivers essentially act as alternative input (i.e. in place of &#39;time&#39;) for F-Curves</span>
<a name="l02087"></a>02087 <span class="comment">     *  - this value will also be returned as the value of the &#39;curve&#39;, if there are no keyframes</span>
<a name="l02088"></a>02088 <span class="comment">     */</span>
<a name="l02089"></a>02089     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>) {
<a name="l02090"></a>02090         <span class="comment">/* evaltime now serves as input for the curve */</span>
<a name="l02091"></a>02091         evaltime= cvalue= <a class="code" href="../../db/d17/fcurve_8c.html#ab6782e470a8f172bacfe7aa35358ec2f">evaluate_driver</a>(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>, evaltime);
<a name="l02092"></a>02092     }
<a name="l02093"></a>02093     
<a name="l02094"></a>02094     <span class="comment">/* evaluate modifiers which modify time to evaluate the base curve at */</span>
<a name="l02095"></a>02095     devaltime= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a6e97a1611f606024e707f0beef7ec1df">evaluate_time_fmodifiers</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>, fcu, cvalue, evaltime);
<a name="l02096"></a>02096     
<a name="l02097"></a>02097     <span class="comment">/* evaluate curve-data </span>
<a name="l02098"></a>02098 <span class="comment">     *  - &#39;devaltime&#39; instead of &#39;evaltime&#39;, as this is the time that the last time-modifying </span>
<a name="l02099"></a>02099 <span class="comment">     *    F-Curve modifier on the stack requested the curve to be evaluated at</span>
<a name="l02100"></a>02100 <span class="comment">     */</span>
<a name="l02101"></a>02101     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>)
<a name="l02102"></a>02102         cvalue= <a class="code" href="../../db/d17/fcurve_8c.html#ae5f7ee7b8c0588b40210402cb41f99ba">fcurve_eval_keyframes</a>(fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a799ab2725f85e5ee19e9ef88a8d6b006">bezt</a>, devaltime);
<a name="l02103"></a>02103     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>)
<a name="l02104"></a>02104         cvalue= <a class="code" href="../../db/d17/fcurve_8c.html#a0d53e9b7307398d6bd0f081afc77d9c8">fcurve_eval_samples</a>(fcu, fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a568e66419fe835c1baaabb739b305e0a">fpt</a>, devaltime);
<a name="l02105"></a>02105     
<a name="l02106"></a>02106     <span class="comment">/* evaluate modifiers */</span>
<a name="l02107"></a>02107     <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a6c7259cde27b3daf8636f08372ea1e0e">evaluate_value_fmodifiers</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>, fcu, &amp;cvalue, evaltime);
<a name="l02108"></a>02108     
<a name="l02109"></a>02109     <span class="comment">/* if curve can only have integral values, perform truncation (i.e. drop the decimal part)</span>
<a name="l02110"></a>02110 <span class="comment">     * here so that the curve can be sampled correctly</span>
<a name="l02111"></a>02111 <span class="comment">     */</span>
<a name="l02112"></a>02112     <span class="keywordflow">if</span> (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#ad6eecd82ed24f053525b459881e405ea">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#ac0aededd6dcdcaa6f2dcf7d0f812e464a41ae3a6a2626d648a9150c3531ac8bb6">FCURVE_INT_VALUES</a>)
<a name="l02113"></a>02113         cvalue= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(cvalue + 0.5f);
<a name="l02114"></a>02114     
<a name="l02115"></a>02115     <span class="comment">/* return evaluated value */</span>
<a name="l02116"></a>02116     <span class="keywordflow">return</span> cvalue;
<a name="l02117"></a>02117 }
<a name="l02118"></a>02118 
<a name="l02119"></a>02119 <span class="comment">/* Calculate the value of the given F-Curve at the given frame, and set its curval */</span>
<a name="l02120"></a><a class="code" href="../../db/d17/fcurve_8c.html#a2969ef35e0511ea04a09a2ec0f8f2bd6">02120</a> <span class="keywordtype">void</span> <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a31e8e5737940b76cc90569916f53da5f">calculate_fcurve</a> (<a class="code" href="../../d6/df2/structFCurve.html">FCurve</a> *fcu, <span class="keywordtype">float</span> ctime)
<a name="l02121"></a>02121 {
<a name="l02122"></a>02122     <span class="comment">/* only calculate + set curval (overriding the existing value) if curve has </span>
<a name="l02123"></a>02123 <span class="comment">     * any data which warrants this...</span>
<a name="l02124"></a>02124 <span class="comment">     */</span>
<a name="l02125"></a>02125     <span class="keywordflow">if</span> ( (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#adec915e7ed4f2b66b12313566bf5c33f">totvert</a>) || (fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a> &amp;&amp; !(fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a6c79ab38bad6125a0c63120a5bf4dd3e">driver</a>-&gt;<a class="code" href="../../d3/d1e/structChannelDriver.html#a27db0085bcd979ac13ceac31c92c7478">flag</a> &amp; <a class="code" href="../../d5/ddb/DNA__anim__types_8h.html#aac7cb5ac3a18e0d26ee4bf5f22464a2fa199e1528ba0e102857fc8f1414057af6">DRIVER_FLAG_INVALID</a>)) ||
<a name="l02126"></a>02126          <a class="code" href="../../da/dba/BKE__fcurve_8h.html#af507d5b05d44a294131417635cc297b9">list_has_suitable_fmodifier</a>(&amp;fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#afd96cdfbbfd2b148482ca111cefa1f74">modifiers</a>, 0, <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a048b0ea81093e0ff3691ac15274ab5a7aeb1884bc3c507d4b438f7911fc2ee1a8">FMI_TYPE_GENERATE_CURVE</a>) )
<a name="l02127"></a>02127     {
<a name="l02128"></a>02128         <span class="comment">/* calculate and set curval (evaluates driver too if necessary) */</span>
<a name="l02129"></a>02129         fcu-&gt;<a class="code" href="../../d6/df2/structFCurve.html#a49947c25d2aa958182e7d5001cb0a245">curval</a>= <a class="code" href="../../da/dba/BKE__fcurve_8h.html#a1ddf79cf14ac3b61c5ea5f3a3af5bd0c">evaluate_fcurve</a>(fcu, ctime);
<a name="l02130"></a>02130     }
<a name="l02131"></a>02131 }
<a name="l02132"></a>02132 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:17 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
