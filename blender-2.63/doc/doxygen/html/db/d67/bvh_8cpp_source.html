<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: bvh.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">bvh.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../db/d67/bvh_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Adapted from code copyright 2009-2010 NVIDIA Corporation</span>
<a name="l00003"></a>00003 <span class="comment"> * Modifications Copyright 2011, Blender Foundation.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00006"></a>00006 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> * limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d3b/mesh_8h.html">mesh.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d10/object_8h.html">object.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d83/scene_8h.html">scene.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;bvh.h&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d2b/bvh__build_8h.html">bvh_build.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d69/bvh__node_8h.html">bvh_node.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/de1/bvh__params_8h.html">bvh_params.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d34/util__cache_8h.html">util_cache.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d42/util__debug_8h.html">util_debug.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d42/util__foreach_8h.html">util_foreach.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dff/util__map_8h.html">util_map.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d74/util__progress_8h.html">util_progress.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dad/util__types_8h.html">util_types.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a127a92451281fa5863da396ed5cd581a">CCL_NAMESPACE_BEGIN</a>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/* Pack Utility */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="../../d0/d11/structBVHStackEntry.html">00038</a> <span class="keyword">struct </span><a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>
<a name="l00039"></a>00039 {
<a name="l00040"></a><a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">00040</a>     <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>;
<a name="l00041"></a><a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">00041</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>;
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="../../d0/d11/structBVHStackEntry.html#a4cf3fcd69335813c1baa83f82a9b262a">00043</a>     <a class="code" href="../../d0/d11/structBVHStackEntry.html#a4cf3fcd69335813c1baa83f82a9b262a">BVHStackEntry</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a>* n = 0, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0)
<a name="l00044"></a>00044     : <a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>(n), <a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00045"></a>00045     {
<a name="l00046"></a>00046     }
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="../../d0/d11/structBVHStackEntry.html#aca4f3a6bdfa944ead9f988f98f2428d1">00048</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html#aca4f3a6bdfa944ead9f988f98f2428d1">encodeIdx</a>()<span class="keyword"> const</span>
<a name="l00049"></a>00049 <span class="keyword">    </span>{
<a name="l00050"></a>00050         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>())? ~<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>: <a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>;
<a name="l00051"></a>00051     }
<a name="l00052"></a>00052 };
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">/* BVH */</span>
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="../../de/de9/classBVH.html#a0261d845ae26a99b11e324976512f5a8">00056</a> <a class="code" href="../../de/de9/classBVH.html#a0261d845ae26a99b11e324976512f5a8">BVH::BVH</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a>&amp; params_, <span class="keyword">const</span> vector&lt;Object*&gt;&amp; objects_)
<a name="l00057"></a>00057 : params(params_), objects(objects_)
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="../../de/de9/classBVH.html#a48bf4d666e249f0f107bf3474cbae33a">00061</a> <a class="code" href="../../de/de9/classBVH.html">BVH</a> *<a class="code" href="../../de/de9/classBVH.html#a48bf4d666e249f0f107bf3474cbae33a">BVH::create</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a>&amp; params, <span class="keyword">const</span> vector&lt;Object*&gt;&amp; objects)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063     <span class="keywordflow">if</span>(params.<a class="code" href="../../d2/d2f/classBVHParams.html#afeb8f1d8925362247de00e156cd4dd84">use_qbvh</a>)
<a name="l00064"></a>00064         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d8/deb/classQBVH.html">QBVH</a>(params, objects);
<a name="l00065"></a>00065     <span class="keywordflow">else</span>
<a name="l00066"></a>00066         <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="../../d4/dfd/classRegularBVH.html">RegularBVH</a>(params, objects);
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">/* Cache */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="../../de/de9/classBVH.html#a0b21e2a46aacc46b38afc165cdf7a3ee">00071</a> <span class="keywordtype">bool</span> <a class="code" href="../../de/de9/classBVH.html#a0b21e2a46aacc46b38afc165cdf7a3ee">BVH::cache_read</a>(<a class="code" href="../../de/d97/classCacheData.html">CacheData</a>&amp; key)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(&amp;<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>));
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>) {
<a name="l00076"></a>00076         key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>);
<a name="l00077"></a>00077         key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>);
<a name="l00078"></a>00078         key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a77b70fcd563fc1a77ad9d332012e8440">bounds</a>, <span class="keyword">sizeof</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a77b70fcd563fc1a77ad9d332012e8440">bounds</a>));
<a name="l00079"></a>00079         key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a04efb76d2cc6a8eaedaec133f61e007f">visibility</a>, <span class="keyword">sizeof</span>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a04efb76d2cc6a8eaedaec133f61e007f">visibility</a>));
<a name="l00080"></a>00080         key.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>));
<a name="l00081"></a>00081     }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <a class="code" href="../../de/d97/classCacheData.html">CacheData</a> value;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span>(<a class="code" href="../../d8/d2c/classCache.html#ad91819224def928dd8faf11337807c74">Cache::global</a>.lookup(key, value)) {
<a name="l00086"></a>00086         <a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a> = key.<a class="code" href="../../de/d97/classCacheData.html#a74c02a6298fead3f9450f99923950cbf">get_filename</a>();
<a name="l00087"></a>00087 
<a name="l00088"></a>00088         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afc8883f1bede1dfaffdfaebf03c1e800">root_index</a>);
<a name="l00089"></a>00089         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a044cd488631bd1c568a2f0abb6675f55">SAH</a>);
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>);
<a name="l00092"></a>00092         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>);
<a name="l00093"></a>00093         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>);
<a name="l00094"></a>00094         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>);
<a name="l00095"></a>00095         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>);
<a name="l00096"></a>00096         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>);
<a name="l00097"></a>00097         value.<a class="code" href="../../de/d97/classCacheData.html#a658f73f18e742fb50db3075e641e3417">read</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>);
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="../../de/de9/classBVH.html#aba96835db2b19e4a900764d15660d53d">00105</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#aba96835db2b19e4a900764d15660d53d">BVH::cache_write</a>(<a class="code" href="../../de/d97/classCacheData.html">CacheData</a>&amp; key)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     <a class="code" href="../../de/d97/classCacheData.html">CacheData</a> value;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afc8883f1bede1dfaffdfaebf03c1e800">root_index</a>);
<a name="l00110"></a>00110     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a044cd488631bd1c568a2f0abb6675f55">SAH</a>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>);
<a name="l00113"></a>00113     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>);
<a name="l00114"></a>00114     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>);
<a name="l00115"></a>00115     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>);
<a name="l00116"></a>00116     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>);
<a name="l00117"></a>00117     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>);
<a name="l00118"></a>00118     value.<a class="code" href="../../de/d97/classCacheData.html#ac814d8009f43baa1faf4102df7ae187a">add</a>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <a class="code" href="../../d8/d2c/classCache.html#ad91819224def928dd8faf11337807c74">Cache::global</a>.<a class="code" href="../../d8/d2c/classCache.html#a7222fe02eeb654e03eab89e292391af1">insert</a>(key, value);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a> = key.<a class="code" href="../../de/d97/classCacheData.html#a74c02a6298fead3f9450f99923950cbf">get_filename</a>();
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="../../de/de9/classBVH.html#a14fc71fc4421e614f6593f956447eea9">00125</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#a14fc71fc4421e614f6593f956447eea9">BVH::clear_cache_except</a>()
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     set&lt;string&gt; except;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a>.empty())
<a name="l00130"></a>00130         except.insert(<a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a>);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>) {
<a name="l00133"></a>00133         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>;
<a name="l00134"></a>00134         <a class="code" href="../../de/de9/classBVH.html">BVH</a> *bvh = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="keywordflow">if</span>(bvh &amp;&amp; !bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a>.empty())
<a name="l00137"></a>00137             except.insert(bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a079559773c78d87a52cdb2305983cc49">cache_filename</a>);
<a name="l00138"></a>00138     }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <a class="code" href="../../d8/d2c/classCache.html#ad91819224def928dd8faf11337807c74">Cache::global</a>.<a class="code" href="../../d8/d2c/classCache.html#a7eb6052064c55c466fe1e5ac76f4dad7">clear_except</a>(<span class="stringliteral">&quot;bvh&quot;</span>, except);
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">/* Building */</span>
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="../../de/de9/classBVH.html#a7cab038c6312055ec0855b70758e130d">00145</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#a7cab038c6312055ec0855b70758e130d">BVH::build</a>(<a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Building BVH&quot;</span>);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="comment">/* cache read */</span>
<a name="l00150"></a>00150     <a class="code" href="../../de/d97/classCacheData.html">CacheData</a> key(<span class="stringliteral">&quot;bvh&quot;</span>);
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#ae30cb72a824a5774c82c62bea4cb46f8">use_cache</a>) {
<a name="l00153"></a>00153         progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Looking in BVH cache&quot;</span>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#a0b21e2a46aacc46b38afc165cdf7a3ee">cache_read</a>(key))
<a name="l00156"></a>00156             <span class="keywordflow">return</span>;
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">/* build nodes */</span>
<a name="l00160"></a>00160     vector&lt;int&gt; prim_index;
<a name="l00161"></a>00161     vector&lt;int&gt; prim_object;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <a class="code" href="../../d9/d83/classBVHBuild.html">BVHBuild</a> bvh_build(<a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>, prim_index, prim_object, <a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>, progress);
<a name="l00164"></a>00164     <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *root = bvh_build.<a class="code" href="../../d9/d83/classBVHBuild.html#a64fa142b742d3723340bca4f87a950a6">run</a>();
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) {
<a name="l00167"></a>00167         <span class="keywordflow">if</span>(root) root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00168"></a>00168         <span class="keywordflow">return</span>;
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="comment">/* todo: get rid of this copy */</span>
<a name="l00172"></a>00172     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a> = prim_index;
<a name="l00173"></a>00173     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a> = prim_object;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* compute SAH */</span>
<a name="l00176"></a>00176     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>)
<a name="l00177"></a>00177         <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a044cd488631bd1c568a2f0abb6675f55">SAH</a> = root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aa7f1bede823f7f2f6e1ca14c5ae0225d">computeSubtreeSAHCost</a>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) {
<a name="l00180"></a>00180         root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00181"></a>00181         <span class="keywordflow">return</span>;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="comment">/* pack triangles */</span>
<a name="l00185"></a>00185     progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Packing BVH triangles&quot;</span>);
<a name="l00186"></a>00186     <a class="code" href="../../de/de9/classBVH.html#a6f0ff9ec53a3d960027b85485841b5cc">pack_triangles</a>();
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) {
<a name="l00189"></a>00189         root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00190"></a>00190         <span class="keywordflow">return</span>;
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="comment">/* pack nodes */</span>
<a name="l00194"></a>00194     progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Packing BVH nodes&quot;</span>);
<a name="l00195"></a>00195     <a class="code" href="../../d2/d41/classarray.html">array&lt;int&gt;</a> tmp_prim_object = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>;
<a name="l00196"></a>00196     <a class="code" href="../../de/de9/classBVH.html#a4312c1a801f2d649de588d66e24523f5">pack_nodes</a>(tmp_prim_object, root);
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     <span class="comment">/* free build nodes */</span>
<a name="l00199"></a>00199     root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a8bfc676b0300d101d49f29dd55a60602">deleteSubtree</a>();
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="comment">/* cache write */</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#ae30cb72a824a5774c82c62bea4cb46f8">use_cache</a>) {
<a name="l00205"></a>00205         progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Writing BVH cache&quot;</span>);
<a name="l00206"></a>00206         <a class="code" href="../../de/de9/classBVH.html#aba96835db2b19e4a900764d15660d53d">cache_write</a>(key);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="comment">/* clear other bvh files from cache */</span>
<a name="l00209"></a>00209         <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>)
<a name="l00210"></a>00210             <a class="code" href="../../de/de9/classBVH.html#a14fc71fc4421e614f6593f956447eea9">clear_cache_except</a>();
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="comment">/* Refitting */</span>
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="../../de/de9/classBVH.html#a42649619788d30e3451ad5a9a3e16c8d">00216</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#a42649619788d30e3451ad5a9a3e16c8d">BVH::refit</a>(<a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Packing BVH triangles&quot;</span>);
<a name="l00219"></a>00219     <a class="code" href="../../de/de9/classBVH.html#a6f0ff9ec53a3d960027b85485841b5cc">pack_triangles</a>();
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Refitting BVH nodes&quot;</span>);
<a name="l00224"></a>00224     <a class="code" href="../../de/de9/classBVH.html#afceb272d6f241645fd16987448641312">refit_nodes</a>();
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="comment">/* Triangles */</span>
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="../../de/de9/classBVH.html#a2b8098ad16ec6f8844007899e24ea7ca">00229</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#a2b8098ad16ec6f8844007899e24ea7ca">BVH::pack_triangle</a>(<span class="keywordtype">int</span> idx, <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> woop[3])
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <span class="comment">/* create Woop triangle */</span>
<a name="l00232"></a>00232     <span class="keywordtype">int</span> tob = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[idx];
<a name="l00233"></a>00233     <span class="keyword">const</span> <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>[tob]-&gt;mesh;
<a name="l00234"></a>00234     <span class="keywordtype">int</span> tidx = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[idx];
<a name="l00235"></a>00235     <span class="keyword">const</span> <span class="keywordtype">int</span> *vidx = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[tidx].v;
<a name="l00236"></a>00236     <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a>* vpos = &amp;mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0];
<a name="l00237"></a>00237     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v0 = vpos[vidx[0]];
<a name="l00238"></a>00238     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v1 = vpos[vidx[1]];
<a name="l00239"></a>00239     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v2 = vpos[vidx[2]];
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> r0 = v0 - v2;
<a name="l00242"></a>00242     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> r1 = v1 - v2;
<a name="l00243"></a>00243     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> r2 = <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>(r0, r1);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="keywordflow">if</span>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(r0, r0) == 0.0f || <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(r1, r1) == 0.0f || <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(r2, r2) == 0.0f) {
<a name="l00246"></a>00246         <span class="comment">/* degenerate */</span>
<a name="l00247"></a>00247         woop[0] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(0.0f, 0.0f, 0.0f, 0.0f);
<a name="l00248"></a>00248         woop[1] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(0.0f, 0.0f, 0.0f, 0.0f);
<a name="l00249"></a>00249         woop[2] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(0.0f, 0.0f, 0.0f, 0.0f);
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     <span class="keywordflow">else</span> {
<a name="l00252"></a>00252         <a class="code" href="../../d2/d43/structTransform.html">Transform</a> t = <a class="code" href="../../db/dc7/util__transform_8h.html#a25680601f0179870d42ecc76fc03a8cc">make_transform</a>(
<a name="l00253"></a>00253             r0.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, r1.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, r2.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, v2.x,
<a name="l00254"></a>00254             r0.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, r1.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, r2.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, v2.y,
<a name="l00255"></a>00255             r0.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>, r1.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>, r2.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>, v2.z,
<a name="l00256"></a>00256             0.0f, 0.0f, 0.0f, 1.0f);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         t = <a class="code" href="../../df/dc4/util__transform_8cpp.html#aa57adc432ae0e55945b8e91b56ef2f69">transform_inverse</a>(t);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         woop[0] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(t.<a class="code" href="../../d2/d43/structTransform.html#aedd38a87d23a48d0a4ee63c0574c9bab">z</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a>, t.<a class="code" href="../../d2/d43/structTransform.html#aedd38a87d23a48d0a4ee63c0574c9bab">z</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, t.<a class="code" href="../../d2/d43/structTransform.html#aedd38a87d23a48d0a4ee63c0574c9bab">z</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, -t.<a class="code" href="../../d2/d43/structTransform.html#aedd38a87d23a48d0a4ee63c0574c9bab">z</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00261"></a>00261         woop[1] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(t.<a class="code" href="../../d2/d43/structTransform.html#ad78a95210bc8d6c23af6acbe4e062482">x</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a>, t.<a class="code" href="../../d2/d43/structTransform.html#ad78a95210bc8d6c23af6acbe4e062482">x</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, t.<a class="code" href="../../d2/d43/structTransform.html#ad78a95210bc8d6c23af6acbe4e062482">x</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, t.<a class="code" href="../../d2/d43/structTransform.html#ad78a95210bc8d6c23af6acbe4e062482">x</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00262"></a>00262         woop[2] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(t.<a class="code" href="../../d2/d43/structTransform.html#acc836172e508a669465c15dd5f64370f">y</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a>, t.<a class="code" href="../../d2/d43/structTransform.html#acc836172e508a669465c15dd5f64370f">y</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, t.<a class="code" href="../../d2/d43/structTransform.html#acc836172e508a669465c15dd5f64370f">y</a>.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, t.<a class="code" href="../../d2/d43/structTransform.html#acc836172e508a669465c15dd5f64370f">y</a>.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="../../de/de9/classBVH.html#a6f0ff9ec53a3d960027b85485841b5cc">00266</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#a6f0ff9ec53a3d960027b85485841b5cc">BVH::pack_triangles</a>()
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268     <span class="keywordtype">int</span> nsize = <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#ac1e0b9f674fee04979ec77810732aed6">TRI_NODE_SIZE</a>;
<a name="l00269"></a>00269     <span class="keywordtype">size_t</span> tidx_size = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00272"></a>00272     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(tidx_size * nsize);
<a name="l00273"></a>00273     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00274"></a>00274     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(tidx_size);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; tidx_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00277"></a>00277         <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != -1) {
<a name="l00278"></a>00278             <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> woop[3];
<a name="l00279"></a>00279 
<a name="l00280"></a>00280             <a class="code" href="../../de/de9/classBVH.html#a2b8098ad16ec6f8844007899e24ea7ca">pack_triangle</a>(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, woop);
<a name="l00281"></a>00281             memcpy(&amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> * nsize], woop, <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9d/structfloat4.html">float4</a>)*3);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283             <span class="keywordtype">int</span> tob = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00284"></a>00284             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>[tob];
<a name="l00285"></a>00285             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a04efb76d2cc6a8eaedaec133f61e007f">visibility</a>;
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="comment">/* Pack Instances */</span>
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="../../de/de9/classBVH.html#aeded60354d737e397433fff6c6c79614">00292</a> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/classBVH.html#aeded60354d737e397433fff6c6c79614">BVH::pack_instances</a>(<span class="keywordtype">size_t</span> nodes_size)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <span class="comment">/* The BVH&#39;s for instances are built separately, but for traversal all</span>
<a name="l00295"></a>00295 <span class="comment">       BVH&#39;s are stored in global arrays. This function merges them into the</span>
<a name="l00296"></a>00296 <span class="comment">       top level BVH, adjusting indexes and offsets where appropriate. */</span>
<a name="l00297"></a>00297     <span class="keywordtype">bool</span> use_qbvh = <a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#afeb8f1d8925362247de00e156cd4dd84">use_qbvh</a>;
<a name="l00298"></a>00298     <span class="keywordtype">size_t</span> nsize = (use_qbvh)? <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>: <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a1f5271742f88501fa88bcd6e148c0a02">BVH_NODE_SIZE</a>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">/* adjust primitive index to point to the triangle in the global array, for</span>
<a name="l00301"></a>00301 <span class="comment">       meshes with transform applied and already in the top level BVH */</span>
<a name="l00302"></a>00302     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00303"></a>00303         <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != -1)
<a name="l00304"></a>00304             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>[<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]]-&gt;mesh-&gt;tri_offset;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="comment">/* track offsets of instanced BVH data in global array */</span>
<a name="l00307"></a>00307     <span class="keywordtype">size_t</span> tri_offset = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00308"></a>00308     <span class="keywordtype">size_t</span> nodes_offset = nodes_size;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="comment">/* clear array that gives the node indexes for instanced objects */</span>
<a name="l00311"></a>00311     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="comment">/* reserve */</span>
<a name="l00314"></a>00314     <span class="keywordtype">size_t</span> prim_index_size = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00315"></a>00315     <span class="keywordtype">size_t</span> tri_woop_size = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="keywordtype">size_t</span> pack_prim_index_offset = prim_index_size;
<a name="l00318"></a>00318     <span class="keywordtype">size_t</span> pack_tri_woop_offset = tri_woop_size;
<a name="l00319"></a>00319     <span class="keywordtype">size_t</span> pack_nodes_offset = nodes_size;
<a name="l00320"></a>00320     <span class="keywordtype">size_t</span> object_offset = 0;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     map&lt;Mesh*, int&gt; mesh_map;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>) {
<a name="l00325"></a>00325         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>;
<a name="l00326"></a>00326         <a class="code" href="../../de/de9/classBVH.html">BVH</a> *bvh = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">if</span>(!mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>) {
<a name="l00329"></a>00329             <span class="keywordflow">if</span>(mesh_map.find(mesh) == mesh_map.end()) {
<a name="l00330"></a>00330                 prim_index_size += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00331"></a>00331                 tri_woop_size += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00332"></a>00332                 nodes_size += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()*nsize;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334                 mesh_map[mesh] = 1;
<a name="l00335"></a>00335             }
<a name="l00336"></a>00336         }
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     mesh_map.clear();
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(prim_index_size);
<a name="l00342"></a>00342     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(prim_index_size);
<a name="l00343"></a>00343     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(prim_index_size);
<a name="l00344"></a>00344     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(tri_woop_size);
<a name="l00345"></a>00345     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(nodes_size);
<a name="l00346"></a>00346     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(<a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>.size());
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <span class="keywordtype">int</span> *pack_prim_index = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>())? &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00349"></a>00349     <span class="keywordtype">int</span> *pack_prim_object = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>())? &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00350"></a>00350     <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> *pack_prim_visibility = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>())? &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00351"></a>00351     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *pack_tri_woop = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>())? &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00352"></a>00352     <a class="code" href="../../d7/d0a/structint4.html">int4</a> *<a class="code" href="../../de/de9/classBVH.html#a4312c1a801f2d649de588d66e24523f5">pack_nodes</a> = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>())? &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="comment">/* merge */</span>
<a name="l00355"></a>00355     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>) {
<a name="l00356"></a>00356         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358         <span class="comment">/* if mesh transform is applied, that means it&#39;s already in the top</span>
<a name="l00359"></a>00359 <span class="comment">           level BVH, and we don&#39;t need to merge it in */</span>
<a name="l00360"></a>00360         <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>) {
<a name="l00361"></a>00361             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[object_offset++] = 0;
<a name="l00362"></a>00362             <span class="keywordflow">continue</span>;
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="comment">/* if mesh already added once, don&#39;t add it again, but used set</span>
<a name="l00366"></a>00366 <span class="comment">           node offset for this object */</span>
<a name="l00367"></a>00367         map&lt;Mesh*, int&gt;::iterator it = mesh_map.find(mesh);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="keywordflow">if</span>(mesh_map.find(mesh) != mesh_map.end()) {
<a name="l00370"></a>00370             <span class="keywordtype">int</span> noffset = it-&gt;second;
<a name="l00371"></a>00371             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[object_offset++] = noffset;
<a name="l00372"></a>00372             <span class="keywordflow">continue</span>;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <a class="code" href="../../de/de9/classBVH.html">BVH</a> *bvh = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="keywordtype">int</span> noffset = nodes_offset/nsize;
<a name="l00378"></a>00378         <span class="keywordtype">int</span> mesh_tri_offset = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="comment">/* fill in node indexes for instances */</span>
<a name="l00381"></a>00381         <span class="keywordflow">if</span>(bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[0])
<a name="l00382"></a>00382             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[object_offset++] = -noffset-1;
<a name="l00383"></a>00383         <span class="keywordflow">else</span>
<a name="l00384"></a>00384             <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[object_offset++] = noffset;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         mesh_map[mesh] = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[object_offset-1];
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="comment">/* merge primitive and object indexes */</span>
<a name="l00389"></a>00389         <span class="keywordflow">if</span>(bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00390"></a>00390             <span class="keywordtype">size_t</span> bvh_prim_index_size = bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00391"></a>00391             <span class="keywordtype">int</span> *bvh_prim_index = &amp;bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[0];
<a name="l00392"></a>00392             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> *bvh_prim_visibility = &amp;bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>[0];
<a name="l00393"></a>00393 
<a name="l00394"></a>00394             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; bvh_prim_index_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00395"></a>00395                 pack_prim_index[pack_prim_index_offset] = bvh_prim_index[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + mesh_tri_offset;
<a name="l00396"></a>00396                 pack_prim_visibility[pack_prim_index_offset] = bvh_prim_visibility[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00397"></a>00397                 pack_prim_object[pack_prim_index_offset] = 0;  <span class="comment">// unused for instances</span>
<a name="l00398"></a>00398                 pack_prim_index_offset++;
<a name="l00399"></a>00399             }
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">/* merge triangle intersection data */</span>
<a name="l00403"></a>00403         <span class="keywordflow">if</span>(bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00404"></a>00404             memcpy(pack_tri_woop+pack_tri_woop_offset, &amp;bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>[0],
<a name="l00405"></a>00405                 bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()*<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9d/structfloat4.html">float4</a>));
<a name="l00406"></a>00406             pack_tri_woop_offset += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="comment">/* merge nodes */</span>
<a name="l00410"></a>00410         <span class="keywordflow">if</span>( bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00411"></a>00411             <span class="keywordtype">size_t</span> nsize_bbox = (use_qbvh)? nsize-2: nsize-1;
<a name="l00412"></a>00412             <a class="code" href="../../d7/d0a/structint4.html">int4</a> *bvh_nodes = &amp;bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[0];
<a name="l00413"></a>00413             <span class="keywordtype">size_t</span> bvh_nodes_size = bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>(); 
<a name="l00414"></a>00414             <span class="keywordtype">int</span> *bvh_is_leaf = &amp;bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[0];
<a name="l00415"></a>00415 
<a name="l00416"></a>00416             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, j = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; bvh_nodes_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+=nsize, j++) {
<a name="l00417"></a>00417                 memcpy(<a class="code" href="../../de/de9/classBVH.html#a4312c1a801f2d649de588d66e24523f5">pack_nodes</a> + pack_nodes_offset, bvh_nodes + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, nsize_bbox*<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d0a/structint4.html">int4</a>));
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                 <span class="comment">/* modify offsets into arrays */</span>
<a name="l00420"></a>00420                 <a class="code" href="../../d7/d0a/structint4.html">int4</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = bvh_nodes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> + nsize_bbox];
<a name="l00421"></a>00421 
<a name="l00422"></a>00422                 <span class="keywordflow">if</span>(bvh_is_leaf[j]) {
<a name="l00423"></a>00423                     data.<a class="code" href="../../d7/d0a/structint4.html#a5cf362aa802672cc8ef61fda401ea39f">x</a> += tri_offset;
<a name="l00424"></a>00424                     data.<a class="code" href="../../d7/d0a/structint4.html#a7aa524da4f1f5a4615e958a009953495">y</a> += tri_offset;
<a name="l00425"></a>00425                 }
<a name="l00426"></a>00426                 <span class="keywordflow">else</span> {
<a name="l00427"></a>00427                     data.<a class="code" href="../../d7/d0a/structint4.html#a5cf362aa802672cc8ef61fda401ea39f">x</a> += (data.<a class="code" href="../../d7/d0a/structint4.html#a5cf362aa802672cc8ef61fda401ea39f">x</a> &lt; 0)? -noffset: noffset;
<a name="l00428"></a>00428                     data.<a class="code" href="../../d7/d0a/structint4.html#a7aa524da4f1f5a4615e958a009953495">y</a> += (data.<a class="code" href="../../d7/d0a/structint4.html#a7aa524da4f1f5a4615e958a009953495">y</a> &lt; 0)? -noffset: noffset;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430                     <span class="keywordflow">if</span>(use_qbvh) {
<a name="l00431"></a>00431                         data.<a class="code" href="../../d7/d0a/structint4.html#a95bb901cfcd69960cd3d609eef4c9c8c">z</a> += (data.<a class="code" href="../../d7/d0a/structint4.html#a95bb901cfcd69960cd3d609eef4c9c8c">z</a> &lt; 0)? -noffset: noffset;
<a name="l00432"></a>00432                         data.<a class="code" href="../../d7/d0a/structint4.html#a5fcec5b3c04a5c1b6a5dc39e75d95975">w</a> += (data.<a class="code" href="../../d7/d0a/structint4.html#a5fcec5b3c04a5c1b6a5dc39e75d95975">w</a> &lt; 0)? -noffset: noffset;
<a name="l00433"></a>00433                     }
<a name="l00434"></a>00434                 }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436                 <a class="code" href="../../de/de9/classBVH.html#a4312c1a801f2d649de588d66e24523f5">pack_nodes</a>[pack_nodes_offset + nsize_bbox] = <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438                 <span class="keywordflow">if</span>(use_qbvh)
<a name="l00439"></a>00439                     <a class="code" href="../../de/de9/classBVH.html#a4312c1a801f2d649de588d66e24523f5">pack_nodes</a>[pack_nodes_offset + nsize_bbox+1] = bvh_nodes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> + nsize_bbox+1];
<a name="l00440"></a>00440 
<a name="l00441"></a>00441                 pack_nodes_offset += nsize;
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         nodes_offset += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00446"></a>00446         tri_offset += bvh-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>();
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="comment">/* Regular BVH */</span>
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#a92022c658287c710b2d5ab3bb41962a4">00452</a> <a class="code" href="../../d4/dfd/classRegularBVH.html#a92022c658287c710b2d5ab3bb41962a4">RegularBVH::RegularBVH</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a>&amp; params_, <span class="keyword">const</span> vector&lt;Object*&gt;&amp; objects_)
<a name="l00453"></a>00453 : <a class="code" href="../../de/de9/classBVH.html">BVH</a>(params_, objects_)
<a name="l00454"></a>00454 {
<a name="l00455"></a>00455 }
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#ae6bf7ae6a5adbe6dee6c6129dbbe4002">00457</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#ae6bf7ae6a5adbe6dee6c6129dbbe4002">RegularBVH::pack_leaf</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e, <span class="keyword">const</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a> *leaf)
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459     <span class="keywordflow">if</span>(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4d76b7ecd3a1f238e26c676abfc0667a">num_triangles</a>() == 1 &amp;&amp; <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>] == -1)
<a name="l00460"></a>00460         <span class="comment">/* object */</span>
<a name="l00461"></a>00461         <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">pack_node</a>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, ~(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>), 0, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>);
<a name="l00462"></a>00462     <span class="keywordflow">else</span>
<a name="l00463"></a>00463         <span class="comment">/* triangle */</span>
<a name="l00464"></a>00464         <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">pack_node</a>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>, leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a6a99b2765a3b99e456ef042c1f11be52">m_hi</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>, leaf-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>);
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#a7c91dd5a4fd46ef42c687402f09a0c19">00467</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#a7c91dd5a4fd46ef42c687402f09a0c19">RegularBVH::pack_inner</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e, <span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e0, <span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e1)
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469     <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">pack_node</a>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>, e0.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, e1.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>, e0.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aca4f3a6bdfa944ead9f988f98f2428d1">encodeIdx</a>(), e1.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aca4f3a6bdfa944ead9f988f98f2428d1">encodeIdx</a>(), e0.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>, e1.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#affc607a44239f73546727b8f5dc555ac">m_visibility</a>);
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">00472</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">RegularBVH::pack_node</a>(<span class="keywordtype">int</span> idx, <span class="keyword">const</span> <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a>&amp; b0, <span class="keyword">const</span> <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a>&amp; b1, <span class="keywordtype">int</span> c0, <span class="keywordtype">int</span> c1, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility0, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility1)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474     <a class="code" href="../../d7/d0a/structint4.html">int4</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a1f5271742f88501fa88bcd6e148c0a02">BVH_NODE_SIZE</a>] =
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476         <a class="code" href="../../d7/dad/util__types_8h.html#a93fe485e9023a9044f20441cec01a470">make_int4</a>(<a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>)),
<a name="l00477"></a>00477         <a class="code" href="../../d7/dad/util__types_8h.html#a93fe485e9023a9044f20441cec01a470">make_int4</a>(<a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>)),
<a name="l00478"></a>00478         <a class="code" href="../../d7/dad/util__types_8h.html#a93fe485e9023a9044f20441cec01a470">make_int4</a>(<a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b0.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>), <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(b1.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>)),
<a name="l00479"></a>00479         <a class="code" href="../../d7/dad/util__types_8h.html#a93fe485e9023a9044f20441cec01a470">make_int4</a>(c0, c1, visibility0, visibility1)
<a name="l00480"></a>00480     };
<a name="l00481"></a>00481 
<a name="l00482"></a>00482     memcpy(&amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[idx * <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a1f5271742f88501fa88bcd6e148c0a02">BVH_NODE_SIZE</a>], data, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d0a/structint4.html">int4</a>)*BVH_NODE_SIZE);
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#ab24132a62f3beeb71a13583644224331">00485</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#ab24132a62f3beeb71a13583644224331">RegularBVH::pack_nodes</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d41/classarray.html">array&lt;int&gt;</a>&amp; prims, <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *root)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <span class="keywordtype">size_t</span> node_size = root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#ae7ebd0bbff87226d0e7e3f3af47a5ea7">getSubtreeSize</a>(<a class="code" href="../../db/d69/bvh__node_8h.html#a5a6fc7f50768e68513422af47ae66b69a22a9f1257c84acf9eb6481411577260f">BVH_STAT_NODE_COUNT</a>);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="comment">/* resize arrays */</span>
<a name="l00490"></a>00490     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00491"></a>00491     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00492"></a>00492     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(node_size);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="comment">/* for top level BVH, first merge existing BVH&#39;s so we know the offsets */</span>
<a name="l00495"></a>00495     <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>)
<a name="l00496"></a>00496         <a class="code" href="../../de/de9/classBVH.html#aeded60354d737e397433fff6c6c79614">pack_instances</a>(node_size*<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a1f5271742f88501fa88bcd6e148c0a02">BVH_NODE_SIZE</a>);
<a name="l00497"></a>00497     <span class="keywordflow">else</span>
<a name="l00498"></a>00498         <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(node_size*BVH_NODE_SIZE);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="keywordtype">int</span> nextNodeIdx = 0;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     vector&lt;BVHStackEntry&gt; <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l00503"></a>00503     stack.push_back(<a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>(root, nextNodeIdx++));
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="keywordflow">while</span>(stack.size()) {
<a name="l00506"></a>00506         <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a> e = stack.back();
<a name="l00507"></a>00507         stack.pop_back();
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>] = e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>();
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         <span class="keywordflow">if</span>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>()) {
<a name="l00512"></a>00512             <span class="comment">/* leaf node */</span>
<a name="l00513"></a>00513             <span class="keyword">const</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>* leaf = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>*<span class="keyword">&gt;</span>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>);
<a name="l00514"></a>00514             <a class="code" href="../../d4/dfd/classRegularBVH.html#ae6bf7ae6a5adbe6dee6c6129dbbe4002">pack_leaf</a>(e, leaf);
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516         <span class="keywordflow">else</span> {
<a name="l00517"></a>00517             <span class="comment">/* innner node */</span>
<a name="l00518"></a>00518             stack.push_back(<a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(0), nextNodeIdx++));
<a name="l00519"></a>00519             stack.push_back(<a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(1), nextNodeIdx++));
<a name="l00520"></a>00520 
<a name="l00521"></a>00521             <a class="code" href="../../d4/dfd/classRegularBVH.html#a7c91dd5a4fd46ef42c687402f09a0c19">pack_inner</a>(e, stack[stack.size()-2], stack[stack.size()-1]);
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="comment">/* root index to start traversal at, to handle case of single leaf node */</span>
<a name="l00526"></a>00526     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afc8883f1bede1dfaffdfaebf03c1e800">root_index</a> = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[0])? -1: 0;
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00529"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#a8dab7f1cbf67b9f091e252ece5607d98">00529</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#a8dab7f1cbf67b9f091e252ece5607d98">RegularBVH::refit_nodes</a>()
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(!<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> bbox;
<a name="l00534"></a>00534     <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility = 0;
<a name="l00535"></a>00535     <a class="code" href="../../d4/dfd/classRegularBVH.html#a50bf5dc5b137630fffa7b5944bb5d726">refit_node</a>(0, (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[0])? <span class="keyword">true</span>: <span class="keyword">false</span>, bbox, visibility);
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="../../d4/dfd/classRegularBVH.html#a50bf5dc5b137630fffa7b5944bb5d726">00538</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/dfd/classRegularBVH.html#a50bf5dc5b137630fffa7b5944bb5d726">RegularBVH::refit_node</a>(<span class="keywordtype">int</span> idx, <span class="keywordtype">bool</span> leaf, <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a>&amp; bbox, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>&amp; visibility)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <a class="code" href="../../d7/d0a/structint4.html">int4</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = &amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[idx*4];
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordtype">int</span> c0 = data[3].<a class="code" href="../../d7/d0a/structint4.html#a5cf362aa802672cc8ef61fda401ea39f">x</a>;
<a name="l00543"></a>00543     <span class="keywordtype">int</span> c1 = data[3].<a class="code" href="../../d7/d0a/structint4.html#a7aa524da4f1f5a4615e958a009953495">y</a>;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="keywordflow">if</span>(leaf) {
<a name="l00546"></a>00546         <span class="comment">/* refit leaf node */</span>
<a name="l00547"></a>00547         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> tri = c0; tri &lt; c1; tri++) {
<a name="l00548"></a>00548             <span class="keywordtype">int</span> tidx = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[tri];
<a name="l00549"></a>00549             <span class="keywordtype">int</span> tob = <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[tri];
<a name="l00550"></a>00550             <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a>[tob];
<a name="l00551"></a>00551 
<a name="l00552"></a>00552             <span class="keywordflow">if</span>(tidx == -1) {
<a name="l00553"></a>00553                 <span class="comment">/* object instance */</span>
<a name="l00554"></a>00554                 bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a77b70fcd563fc1a77ad9d332012e8440">bounds</a>);
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556             <span class="keywordflow">else</span> {
<a name="l00557"></a>00557                 <span class="comment">/* triangles */</span>
<a name="l00558"></a>00558                 <span class="keyword">const</span> <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>;
<a name="l00559"></a>00559                 <span class="keywordtype">int</span> tri_offset = (<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>)? mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>: 0;
<a name="l00560"></a>00560                 <span class="keyword">const</span> <span class="keywordtype">int</span> *vidx = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[tidx - tri_offset].v;
<a name="l00561"></a>00561                 <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *vpos = &amp;mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0];
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                 bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(vpos[vidx[0]]);
<a name="l00564"></a>00564                 bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(vpos[vidx[1]]);
<a name="l00565"></a>00565                 bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(vpos[vidx[2]]);
<a name="l00566"></a>00566             }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568             visibility |= ob-&gt;<a class="code" href="../../de/de7/structObject.html#a04efb76d2cc6a8eaedaec133f61e007f">visibility</a>;
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">pack_node</a>(idx, bbox, bbox, c0, c1, visibility, visibility);
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573     <span class="keywordflow">else</span> {
<a name="l00574"></a>00574         <span class="comment">/* refit inner node, set bbox from children */</span>
<a name="l00575"></a>00575         <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> bbox0, bbox1;
<a name="l00576"></a>00576         <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> visibility0 = 0, visibility1 = 0;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <a class="code" href="../../d4/dfd/classRegularBVH.html#a50bf5dc5b137630fffa7b5944bb5d726">refit_node</a>((c0 &lt; 0)? -c0-1: c0, (c0 &lt; 0), bbox0, visibility0);
<a name="l00579"></a>00579         <a class="code" href="../../d4/dfd/classRegularBVH.html#a50bf5dc5b137630fffa7b5944bb5d726">refit_node</a>((c1 &lt; 0)? -c1-1: c1, (c1 &lt; 0), bbox1, visibility1);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <a class="code" href="../../d4/dfd/classRegularBVH.html#a839742ff1db86aaf8574a781753f0085">pack_node</a>(idx, bbox0, bbox1, c0, c1, visibility0, visibility1);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(bbox0);
<a name="l00584"></a>00584         bbox.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(bbox1);
<a name="l00585"></a>00585         visibility = visibility0|visibility1;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="comment">/* QBVH */</span>
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="../../d8/deb/classQBVH.html#ace9d5605d18a7a50d409aa996881dc28">00591</a> <a class="code" href="../../d8/deb/classQBVH.html#ace9d5605d18a7a50d409aa996881dc28">QBVH::QBVH</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a>&amp; params_, <span class="keyword">const</span> vector&lt;Object*&gt;&amp; objects_)
<a name="l00592"></a>00592 : <a class="code" href="../../de/de9/classBVH.html">BVH</a>(params_, objects_)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#afeb8f1d8925362247de00e156cd4dd84">use_qbvh</a> = <span class="keyword">true</span>;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="comment">/* todo: use visibility */</span>
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a><a class="code" href="../../d8/deb/classQBVH.html#a9ad174d76ad3f92d3c6006178324ce15">00599</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/deb/classQBVH.html#a9ad174d76ad3f92d3c6006178324ce15">QBVH::pack_leaf</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e, <span class="keyword">const</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a> *leaf)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>];
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     memset(data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4d76b7ecd3a1f238e26c676abfc0667a">num_triangles</a>() == 1 &amp;&amp; <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>] == -1) {
<a name="l00606"></a>00606         <span class="comment">/* object */</span>
<a name="l00607"></a>00607         data[6].<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a> = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(~(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>));
<a name="l00608"></a>00608         data[6].<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a> = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(0);
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610     <span class="keywordflow">else</span> {
<a name="l00611"></a>00611         <span class="comment">/* triangle */</span>
<a name="l00612"></a>00612         data[6].<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a> = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a4ccc9cac6c125581bf82061c0a6035da">m_lo</a>);
<a name="l00613"></a>00613         data[6].<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a> = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(leaf-&gt;<a class="code" href="../../d7/d4b/classLeafNode.html#a6a99b2765a3b99e456ef042c1f11be52">m_hi</a>);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     memcpy(&amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a> * <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>], data, <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9d/structfloat4.html">float4</a>)*<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>);
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="../../d8/deb/classQBVH.html#aebdf3daa61f66c4c67ebecb5a3026671">00619</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/deb/classQBVH.html#aebdf3daa61f66c4c67ebecb5a3026671">QBVH::pack_inner</a>(<span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>&amp; e, <span class="keyword">const</span> <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a> *en, <span class="keywordtype">int</span> num)
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>];
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; num; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00624"></a>00624         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> bb_min = en[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#af70d19101e013b78fcb8af9bdb539d34">min</a>;
<a name="l00625"></a>00625         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> bb_max = en[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a4ad1cf8e3d9e4b8366600f3fdd31a042">m_bounds</a>.<a class="code" href="../../d3/d8a/structBoundBox.html#a8d1c9b8948732b9b722e3dadad68dc65">max</a>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         data[0][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_min.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>;
<a name="l00628"></a>00628         data[1][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_max.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>;
<a name="l00629"></a>00629         data[2][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_min.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>;
<a name="l00630"></a>00630         data[3][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_max.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>;
<a name="l00631"></a>00631         data[4][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_min.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>;
<a name="l00632"></a>00632         data[5][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = bb_max.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>;
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         data[6][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(en[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].encodeIdx());
<a name="l00635"></a>00635         data[7][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = num; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; 4; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00639"></a>00639         data[0][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00640"></a>00640         data[1][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00641"></a>00641         data[2][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         data[3][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00644"></a>00644         data[4][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00645"></a>00645         data[5][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         data[6][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(0);
<a name="l00648"></a>00648         data[7][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.0f;
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     memcpy(&amp;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a> * <a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>], data, <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9d/structfloat4.html">float4</a>)*<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>);
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="comment">/* Quad SIMD Nodes */</span>
<a name="l00655"></a>00655 
<a name="l00656"></a><a class="code" href="../../d8/deb/classQBVH.html#a858ca3fea886e2533a4b42a6a8e8f5ab">00656</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/deb/classQBVH.html#a858ca3fea886e2533a4b42a6a8e8f5ab">QBVH::pack_nodes</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d41/classarray.html">array&lt;int&gt;</a>&amp; prims, <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *root)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658     <span class="keywordtype">size_t</span> node_size = root-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#ae7ebd0bbff87226d0e7e3f3af47a5ea7">getSubtreeSize</a>(<a class="code" href="../../db/d69/bvh__node_8h.html#a5a6fc7f50768e68513422af47ae66b69a22a9f1257c84acf9eb6481411577260f">BVH_STAT_NODE_COUNT</a>);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="comment">/* resize arrays */</span>
<a name="l00661"></a>00661     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00662"></a>00662     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>.<a class="code" href="../../d2/d41/classarray.html#a1ff3c2ce7f237a31a0cfc42a23badc6e">clear</a>();
<a name="l00663"></a>00663     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(node_size);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="comment">/* for top level BVH, first merge existing BVH&#39;s so we know the offsets */</span>
<a name="l00666"></a>00666     <span class="keywordflow">if</span>(<a class="code" href="../../de/de9/classBVH.html#ad3f275d50ff8ecf8d026550c019a54b9">params</a>.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a>)
<a name="l00667"></a>00667         <a class="code" href="../../de/de9/classBVH.html#aeded60354d737e397433fff6c6c79614">pack_instances</a>(node_size*<a class="code" href="../../da/dab/intern_2cycles_2bvh_2bvh_8h.html#a8e47a99fbc876d74b6f617376f3a4595">BVH_QNODE_SIZE</a>);
<a name="l00668"></a>00668     <span class="keywordflow">else</span>
<a name="l00669"></a>00669         <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a43389f3625df4723f58117b9f5673402">resize</a>(node_size*BVH_QNODE_SIZE);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     <span class="keywordtype">int</span> nextNodeIdx = 0;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     vector&lt;BVHStackEntry&gt; <a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l00674"></a>00674     stack.push_back(<a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>(root, nextNodeIdx++));
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">while</span>(stack.size()) {
<a name="l00677"></a>00677         <a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a> e = stack.back();
<a name="l00678"></a>00678         stack.pop_back();
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#aa872659a9cd9db3279542766a5ef9a60">idx</a>] = e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>();
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <span class="keywordflow">if</span>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>()) {
<a name="l00683"></a>00683             <span class="comment">/* leaf node */</span>
<a name="l00684"></a>00684             <span class="keyword">const</span> <a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>* leaf = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><a class="code" href="../../d7/d4b/classLeafNode.html">LeafNode</a>*<span class="keyword">&gt;</span>(e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>);
<a name="l00685"></a>00685             <a class="code" href="../../d8/deb/classQBVH.html#a9ad174d76ad3f92d3c6006178324ce15">pack_leaf</a>(e, leaf);
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687         <span class="keywordflow">else</span> {
<a name="l00688"></a>00688             <span class="comment">/* inner node */</span>
<a name="l00689"></a>00689             <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *node = e.<a class="code" href="../../d0/d11/structBVHStackEntry.html#a24d776c214db02ae9fd6bffb6e571cc4">node</a>;
<a name="l00690"></a>00690             <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *node0 = node-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(0);
<a name="l00691"></a>00691             <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *node1 = node-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(1);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693             <span class="comment">/* collect nodes */</span>
<a name="l00694"></a>00694             <span class="keyword">const</span> <a class="code" href="../../d4/d59/structBVHNode.html">BVHNode</a> *<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>[4];
<a name="l00695"></a>00695             <span class="keywordtype">int</span> numnodes = 0;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697             <span class="keywordflow">if</span>(node0-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>()) {
<a name="l00698"></a>00698                 nodes[numnodes++] = node0;
<a name="l00699"></a>00699             }
<a name="l00700"></a>00700             <span class="keywordflow">else</span> {
<a name="l00701"></a>00701                 nodes[numnodes++] = node0-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(0);
<a name="l00702"></a>00702                 nodes[numnodes++] = node0-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(1);
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705             <span class="keywordflow">if</span>(node1-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#a87d608b0baf1d0ba36a8e6c9d2698bb1">is_leaf</a>()) {
<a name="l00706"></a>00706                 nodes[numnodes++] = node1;
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708             <span class="keywordflow">else</span> {
<a name="l00709"></a>00709                 nodes[numnodes++] = node1-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(0);
<a name="l00710"></a>00710                 nodes[numnodes++] = node1-&gt;<a class="code" href="../../d4/d59/structBVHNode.html#aabd780f5218a63c6c5180c35fc4ce9c2">get_child</a>(1);
<a name="l00711"></a>00711             }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713             <span class="comment">/* push entries on the stack */</span>
<a name="l00714"></a>00714             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; numnodes; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00715"></a>00715                 stack.push_back(<a class="code" href="../../d0/d11/structBVHStackEntry.html">BVHStackEntry</a>(nodes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>], nextNodeIdx++));
<a name="l00716"></a>00716 
<a name="l00717"></a>00717             <span class="comment">/* set node */</span>
<a name="l00718"></a>00718             <a class="code" href="../../d8/deb/classQBVH.html#aebdf3daa61f66c4c67ebecb5a3026671">pack_inner</a>(e, &amp;stack[stack.size()-numnodes], numnodes);
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="comment">/* root index to start traversal at, to handle case of single leaf node */</span>
<a name="l00723"></a>00723     <a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#afc8883f1bede1dfaffdfaebf03c1e800">root_index</a> = (<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>.<a class="code" href="../../de/d0d/structPackedBVH.html#aaec9d198bd8262009b5aed0b674bd33a">is_leaf</a>[0])? -1: 0;
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 
<a name="l00726"></a><a class="code" href="../../d8/deb/classQBVH.html#a5deae725afc69c2039d3cea83e545d9f">00726</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/deb/classQBVH.html#a5deae725afc69c2039d3cea83e545d9f">QBVH::refit_nodes</a>()
<a name="l00727"></a>00727 {
<a name="l00728"></a>00728     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(0); <span class="comment">/* todo */</span>
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#ae0c27e57708248c67409956ddc159e18">CCL_NAMESPACE_END</a>
<a name="l00732"></a>00732 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:10 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
