<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: pixelshading.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">pixelshading.c</div>  </div>
</div>
<div class="contents">
<a href="../../d9/dc7/pixelshading_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): 2004-2006, Blender Foundation, full recode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/* External modules: */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d94/DNA__image__types_8h.html">DNA_image_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">/* own module */</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db3/pixelblending_8h.html">pixelblending.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d05/pixelshading_8h.html">pixelshading.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d88/sunsky_8h.html">sunsky.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00070"></a>00070 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00071"></a>00071 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00072"></a>00072 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00073"></a>00073 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#a5d12acc6336a883bfc361172c3f5752c">hashvectf</a>[];
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#ae3b3fd22c42d62ccdfd965376b2c9302">00078</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc7/pixelshading_8c.html#ae3b3fd22c42d62ccdfd965376b2c9302">render_lighting_halo</a>(<a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har, <span class="keywordtype">float</span> col_r[3])
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l00081"></a>00081     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00082"></a>00082     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, inp, inpr, rco[3], dco[3], lv[3], lampdist, ld, t, *vn;
<a name="l00083"></a>00083     <span class="keywordtype">float</span> ir, ig, ib, shadfac, soft, lacol[3];
<a name="l00084"></a>00084     
<a name="l00085"></a>00085     ir= ig= ib= 0.0;
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rco, har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ae6c5e70c8bccbccfa3e5eef8bc8b2529">co</a>);
<a name="l00088"></a>00088     dco[0]=dco[1]=dco[2]= 1.0f/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>;
<a name="l00089"></a>00089     
<a name="l00090"></a>00090     vn= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a16f247e47bc64f0a5076b25acac1742f">no</a>;
<a name="l00091"></a>00091     
<a name="l00092"></a>00092     <span class="keywordflow">for</span> (go=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights.first; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l00093"></a>00093         lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l00094"></a>00094         
<a name="l00095"></a>00095         <span class="comment">/* test for lamplayer */</span>
<a name="l00096"></a>00096         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4846848b366b4f085ce68cf576e2b411">lay</a>)==0) <span class="keywordflow">continue</span>;
<a name="l00097"></a>00097         
<a name="l00098"></a>00098         <span class="comment">/* lampdist cacluation */</span>
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l00100"></a>00100             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lv, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>);
<a name="l00101"></a>00101             lampdist= 1.0;
<a name="l00102"></a>00102         }
<a name="l00103"></a>00103         <span class="keywordflow">else</span> {
<a name="l00104"></a>00104             lv[0]= rco[0]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0];
<a name="l00105"></a>00105             lv[1]= rco[1]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1];
<a name="l00106"></a>00106             lv[2]= rco[2]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2];
<a name="l00107"></a>00107             ld = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(lv);
<a name="l00108"></a>00108             lv[0]/= ld;
<a name="l00109"></a>00109             lv[1]/= ld;
<a name="l00110"></a>00110             lv[2]/= ld;
<a name="l00111"></a>00111             
<a name="l00112"></a>00112             <span class="comment">/* ld is re-used further on (texco&#39;s) */</span>
<a name="l00113"></a>00113             
<a name="l00114"></a>00114             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2e09bd4d28e8365b52c3e5d67a41deca">LA_QUAD</a>) {
<a name="l00115"></a>00115                 t= 1.0;
<a name="l00116"></a>00116                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aa426d637e8e7dbe8cbd851c2d5b91d42">ld1</a>&gt;0.0f)
<a name="l00117"></a>00117                     t= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aa426d637e8e7dbe8cbd851c2d5b91d42">ld1</a>*ld);
<a name="l00118"></a>00118                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad534b1e39f44bfa3def6c9edc21cad50">ld2</a>&gt;0.0f)
<a name="l00119"></a>00119                     t*= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac87d813965f10bca880aa6b30e8d7974">distkw</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac87d813965f10bca880aa6b30e8d7974">distkw</a>+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad534b1e39f44bfa3def6c9edc21cad50">ld2</a>*ld*ld);
<a name="l00120"></a>00120                 
<a name="l00121"></a>00121                 lampdist= t;
<a name="l00122"></a>00122             }
<a name="l00123"></a>00123             <span class="keywordflow">else</span> {
<a name="l00124"></a>00124                 lampdist= (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>+ld));
<a name="l00125"></a>00125             }
<a name="l00126"></a>00126             
<a name="l00127"></a>00127             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a6d59a2aff598eff08f19650920459fa8">LA_SPHERE</a>) {
<a name="l00128"></a>00128                 t= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a> - ld;
<a name="l00129"></a>00129                 <span class="keywordflow">if</span> (t&lt;0.0f) <span class="keywordflow">continue</span>;
<a name="l00130"></a>00130                 
<a name="l00131"></a>00131                 t/= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>;
<a name="l00132"></a>00132                 lampdist*= (t);
<a name="l00133"></a>00133             }
<a name="l00134"></a>00134             
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136         
<a name="l00137"></a>00137         lacol[0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a>;
<a name="l00138"></a>00138         lacol[1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac459abfab45ae7ccecdf626896763675">g</a>;
<a name="l00139"></a>00139         lacol[2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8df1307b7133d24f3a3b64a1e5eabf11">b</a>;
<a name="l00140"></a>00140         
<a name="l00141"></a>00141         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>) {
<a name="l00142"></a>00142             <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi;
<a name="l00143"></a>00143             
<a name="l00144"></a>00144             <span class="comment">/* Warning, This is not that nice, and possibly a bit slow,</span>
<a name="l00145"></a>00145 <span class="comment">             * however some variables were not initialized properly in, unless using shade_input_initialize(...),</span>
<a name="l00146"></a>00146 <span class="comment">             * we need to do a memset */</span>
<a name="l00147"></a>00147             memset(&amp;shi, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a>)); 
<a name="l00148"></a>00148             <span class="comment">/* end warning! - Campbell */</span>
<a name="l00149"></a>00149             
<a name="l00150"></a>00150             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi.<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, rco);
<a name="l00151"></a>00151             shi.<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>= 0;
<a name="l00152"></a>00152             <a class="code" href="../../df/dba/texture_8h.html#a2d34292e93e416e64d0017ed4429c6c0">do_lamp_tex</a>(lar, lv, &amp;shi, lacol, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>);
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154         
<a name="l00155"></a>00155         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>) {
<a name="l00156"></a>00156             
<a name="l00157"></a>00157             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab52bf56b834bad1d21c3aaa274943059">LA_SQUARE</a>) {
<a name="l00158"></a>00158                 <span class="keywordflow">if</span> (lv[0]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0]+lv[1]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1]+lv[2]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2]&gt;0.0f) {
<a name="l00159"></a>00159                     <span class="keywordtype">float</span> x, lvrot[3];
<a name="l00160"></a>00160                     
<a name="l00161"></a>00161                     <span class="comment">/* rotate view to lampspace */</span>
<a name="l00162"></a>00162                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lvrot, lv);
<a name="l00163"></a>00163                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, lvrot);
<a name="l00164"></a>00164                     
<a name="l00165"></a>00165                     x = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(lvrot[0]/lvrot[2]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(lvrot[1]/lvrot[2]));
<a name="l00166"></a>00166                     <span class="comment">/* 1.0/(sqrt(1+x*x)) is equivalent to cos(atan(x)) */</span>
<a name="l00167"></a>00167                     
<a name="l00168"></a>00168                     inpr= 1.0/(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(1.0f+x*x));
<a name="l00169"></a>00169                 }
<a name="l00170"></a>00170                 <span class="keywordflow">else</span> inpr= 0.0;
<a name="l00171"></a>00171             }
<a name="l00172"></a>00172             <span class="keywordflow">else</span> {
<a name="l00173"></a>00173                 inpr= lv[0]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0]+lv[1]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1]+lv[2]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2];
<a name="l00174"></a>00174             }
<a name="l00175"></a>00175             
<a name="l00176"></a>00176             t= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>;
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (inpr&lt;t) <span class="keywordflow">continue</span>;
<a name="l00178"></a>00178             <span class="keywordflow">else</span> {
<a name="l00179"></a>00179                 t= inpr-t;
<a name="l00180"></a>00180                 soft= 1.0;
<a name="l00181"></a>00181                 <span class="keywordflow">if</span> (t&lt;lar-&gt;spotbl &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a2a5b4e6535eb9e727d0331696ff975ce">spotbl</a>!=0.0f) {
<a name="l00182"></a>00182                     <span class="comment">/* soft area */</span>
<a name="l00183"></a>00183                     i= t/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a2a5b4e6535eb9e727d0331696ff975ce">spotbl</a>;
<a name="l00184"></a>00184                     t= i*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00185"></a>00185                     soft= (3.0f*t-2.0f*t*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l00186"></a>00186                     inpr*= soft;
<a name="l00187"></a>00187                 }
<a name="l00188"></a>00188                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>) {
<a name="l00189"></a>00189                     <span class="comment">/* if (ma-&gt;mode &amp; MA_SHADOW) { */</span>
<a name="l00190"></a>00190                     <span class="comment">/* dot product positive: front side face! */</span>
<a name="l00191"></a>00191                     inp= vn[0]*lv[0] + vn[1]*lv[1] + vn[2]*lv[2];
<a name="l00192"></a>00192                     <span class="keywordflow">if</span> (inp&gt;0.0f) {
<a name="l00193"></a>00193                         <span class="comment">/* testshadowbuf==0.0 : 100% shadow */</span>
<a name="l00194"></a>00194                         shadfac = <a class="code" href="../../d9/d30/shadbuf_8h.html#a90bba8ef1567f3b648d21a39493a85a7">testshadowbuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>, rco, dco, dco, inp, 0.0f);
<a name="l00195"></a>00195                         <span class="keywordflow">if</span> ( shadfac&gt;0.0f ) {
<a name="l00196"></a>00196                             shadfac*= inp*soft*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l00197"></a>00197                             ir -= shadfac;
<a name="l00198"></a>00198                             ig -= shadfac;
<a name="l00199"></a>00199                             ib -= shadfac;
<a name="l00200"></a>00200                             
<a name="l00201"></a>00201                             <span class="keywordflow">continue</span>;
<a name="l00202"></a>00202                         }
<a name="l00203"></a>00203                     }
<a name="l00204"></a>00204                     <span class="comment">/* } */</span>
<a name="l00205"></a>00205                 }
<a name="l00206"></a>00206                 lampdist*=inpr;
<a name="l00207"></a>00207             }
<a name="l00208"></a>00208             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>) <span class="keywordflow">continue</span>;
<a name="l00209"></a>00209             
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211         
<a name="l00212"></a>00212         <span class="comment">/* dot product and  reflectivity*/</span>
<a name="l00213"></a>00213         
<a name="l00214"></a>00214         inp = 1.0 - <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vn, lv));
<a name="l00215"></a>00215         
<a name="l00216"></a>00216         <span class="comment">/* inp= cos(0.5*M_PI-acos(inp)); */</span>
<a name="l00217"></a>00217         
<a name="l00218"></a>00218         i= inp;
<a name="l00219"></a>00219         
<a name="l00220"></a>00220         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l00221"></a>00221             i= 0.5f*i+0.5f;
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223         <span class="keywordflow">if</span> (i&gt;0.0f) {
<a name="l00224"></a>00224             i*= lampdist;
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226         
<a name="l00227"></a>00227         <span class="comment">/* shadow  */</span>
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (i&gt; -0.41f) { <span class="comment">/* heuristic valua! */</span>
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l00230"></a>00230                 shadfac = <a class="code" href="../../d9/d30/shadbuf_8h.html#a90bba8ef1567f3b648d21a39493a85a7">testshadowbuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>, rco, dco, dco, inp, 0.0f);
<a name="l00231"></a>00231                 <span class="keywordflow">if</span> (shadfac==0.0f) <span class="keywordflow">continue</span>;
<a name="l00232"></a>00232                 i*= shadfac;
<a name="l00233"></a>00233             }
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235         
<a name="l00236"></a>00236         <span class="keywordflow">if</span> (i&gt;0.0f) {
<a name="l00237"></a>00237             ir+= i*lacol[0];
<a name="l00238"></a>00238             ig+= i*lacol[1];
<a name="l00239"></a>00239             ib+= i*lacol[2];
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242     
<a name="l00243"></a>00243     <span class="keywordflow">if</span> (ir&lt;0.0f) ir= 0.0f;
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (ig&lt;0.0f) ig= 0.0f;
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (ib&lt;0.0f) ib= 0.0f;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     col_r[0]*= ir;
<a name="l00248"></a>00248     col_r[1]*= ig;
<a name="l00249"></a>00249     col_r[2]*= ib;
<a name="l00250"></a>00250     
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 
<a name="l00259"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#abf4c66f12e147c0e8751425557339080">00259</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc7/pixelshading_8c.html#abf4c66f12e147c0e8751425557339080">haloZtoDist</a>(<span class="keywordtype">int</span> z)
<a name="l00260"></a>00260 {
<a name="l00261"></a>00261     <span class="keywordtype">float</span> zco = 0;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (z &gt;= 0x7FFFFF)
<a name="l00264"></a>00264         <span class="keywordflow">return</span> 10e10;
<a name="l00265"></a>00265     <span class="keywordflow">else</span> {
<a name="l00266"></a>00266         zco = (float)z/(<span class="keywordtype">float</span>)0x7FFFFF;
<a name="l00267"></a>00267         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad1461325b45cf05ec52533e0b5fc9c5b">R_ORTHO</a>)
<a name="l00268"></a>00268             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[3][2] - zco*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[3][3])/(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[2][2]);
<a name="l00269"></a>00269         <span class="keywordflow">else</span>
<a name="l00270"></a>00270             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[3][2])/(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[2][2] - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[2][3]*zco);
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00283"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#ad57ee8aca67ce758072e7bad10e25e1f">00283</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d05/pixelshading_8h.html#ad57ee8aca67ce758072e7bad10e25e1f">shadeHaloFloat</a>(<a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har,  <span class="keywordtype">float</span> *col, <span class="keywordtype">int</span> zz, 
<a name="l00284"></a>00284                     <span class="keywordtype">float</span> dist, <span class="keywordtype">float</span> xn,  <span class="keywordtype">float</span> yn, <span class="keywordtype">short</span> flarec)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286     <span class="comment">/* fill in col */</span>
<a name="l00287"></a>00287     <span class="keywordtype">float</span> t, zn, radist, ringf=0.0f, linef=0.0f, alpha, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00288"></a>00288     <span class="keywordtype">int</span> a;
<a name="l00289"></a>00289    
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a91bffe0ae7ebf43c052eaf29fddd42bf">WO_MIST</a>) {
<a name="l00291"></a>00291         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#aca296043eb7e9833b210a663ad55f2c8">HA_ONLYSKY</a>) {
<a name="l00292"></a>00292             <span class="comment">/* stars but no mist */</span>
<a name="l00293"></a>00293             alpha= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a68d719be1aed339ef904c34afa550ab4">alfa</a>;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295         <span class="keywordflow">else</span> {
<a name="l00296"></a>00296             <span class="comment">/* a bit patchy... */</span>
<a name="l00297"></a>00297             alpha= <a class="code" href="../../d0/d0e/rendercore_8h.html#ae00f1b73fedea87dea90430cc5f98c6c">mistfactor</a>(-har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ae6c5e70c8bccbccfa3e5eef8bc8b2529">co</a>[2], har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ae6c5e70c8bccbccfa3e5eef8bc8b2529">co</a>)*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a68d719be1aed339ef904c34afa550ab4">alfa</a>;
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300     <span class="keywordflow">else</span> alpha= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a68d719be1aed339ef904c34afa550ab4">alfa</a>;
<a name="l00301"></a>00301     
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (alpha==0.0f)
<a name="l00303"></a>00303         <span class="keywordflow">return</span> 0;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="comment">/* soften the halo if it intersects geometry */</span>
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a> &amp;&amp; har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a48d97b4d01221cd176e1d5cfbf18bc8a">MA_HALO_SOFT</a>) {
<a name="l00307"></a>00307         <span class="keywordtype">float</span> segment_length, halo_depth, distance_from_z <span class="comment">/* , visible_depth */</span> <span class="comment">/* UNUSED */</span>, soften;
<a name="l00308"></a>00308         
<a name="l00309"></a>00309         <span class="comment">/* calculate halo depth */</span>
<a name="l00310"></a>00310         segment_length= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a663b6c98c2cae6bdcbbc0d27b3b7a122">hasize</a>*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - dist/(har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>));
<a name="l00311"></a>00311         halo_depth= 2.0f*segment_length;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         <span class="keywordflow">if</span> (halo_depth &lt; FLT_EPSILON)
<a name="l00314"></a>00314             <span class="keywordflow">return</span> 0;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="comment">/* calculate how much of this depth is visible */</span>
<a name="l00317"></a>00317         distance_from_z = <a class="code" href="../../d9/dc7/pixelshading_8c.html#abf4c66f12e147c0e8751425557339080">haloZtoDist</a>(zz) - <a class="code" href="../../d9/dc7/pixelshading_8c.html#abf4c66f12e147c0e8751425557339080">haloZtoDist</a>(har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a>);
<a name="l00318"></a>00318         <span class="comment">/* visible_depth = halo_depth; */</span> <span class="comment">/* UNUSED */</span>
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (distance_from_z &lt; segment_length) {
<a name="l00320"></a>00320             soften= (segment_length + distance_from_z)/halo_depth;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322             <span class="comment">/* apply softening to alpha */</span>
<a name="l00323"></a>00323             <span class="keywordflow">if</span> (soften &lt; 1.0f)
<a name="l00324"></a>00324                 alpha *= soften;
<a name="l00325"></a>00325             <span class="keywordflow">if</span> (alpha &lt;= 0.0f)
<a name="l00326"></a>00326                 <span class="keywordflow">return</span> 0;
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="keywordflow">else</span> {
<a name="l00330"></a>00330         <span class="comment">/* not a soft halo. use the old softening code */</span>
<a name="l00331"></a>00331         <span class="comment">/* halo being intersected? */</span>
<a name="l00332"></a>00332         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a>&gt; zz-har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a65f59dc267d1701b80d439f8beff9e1a">zd</a>) {
<a name="l00333"></a>00333             t= ((float)(zz-har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#acc4800954c26151f3992194e7ba846f0">zs</a>))/(<span class="keywordtype">float</span>)har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a65f59dc267d1701b80d439f8beff9e1a">zd</a>;
<a name="l00334"></a>00334             alpha*= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(t));
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     radist= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dist);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">/* watch it: not used nicely: flarec is set at zero in pixstruct */</span>
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (flarec) har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a5303c3880e703e2d1297d804672fb1fd">pixels</a>+= (int)(har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>-radist);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab0ad5f6b19519b08c52781f273de8997">ringc</a>) {
<a name="l00344"></a>00344         <span class="keywordtype">float</span> *rc, fac;
<a name="l00345"></a>00345         <span class="keywordtype">int</span> ofs;
<a name="l00346"></a>00346         
<a name="l00347"></a>00347         <span class="comment">/* per ring an antialised circle */</span>
<a name="l00348"></a>00348         ofs= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a2a3e6cbcc60403a056c5ee209c98f8a5">seed</a>;
<a name="l00349"></a>00349         
<a name="l00350"></a>00350         <span class="keywordflow">for</span> (a= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab0ad5f6b19519b08c52781f273de8997">ringc</a>; a&gt;0; a--, ofs+=2) {
<a name="l00351"></a>00351             
<a name="l00352"></a>00352             rc= <a class="code" href="../../dd/d05/noise_8c.html#a5d12acc6336a883bfc361172c3f5752c">hashvectf</a> + (ofs % 768);
<a name="l00353"></a>00353             
<a name="l00354"></a>00354             fac= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>( rc[1]*(har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(rc[0]) - radist) );
<a name="l00355"></a>00355             
<a name="l00356"></a>00356             <span class="keywordflow">if</span> (fac&lt; 1.0f) {
<a name="l00357"></a>00357                 ringf+= (1.0f-fac);
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad772f51cfb24adf1a661798dbda78e33">HA_VECT</a>) {
<a name="l00363"></a>00363         dist= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>( har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a64985ecb5608fa0d8f373daf398fe610">cos</a>*(yn) - har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a9033aa08ffa8e8ff41be1bf1693f509b">sin</a>*(xn) )/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>;
<a name="l00364"></a>00364         <span class="keywordflow">if</span> (dist&gt;1.0f) dist= 1.0f;
<a name="l00365"></a>00365         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4dd5eb4a96dde958905b093886ea48cc">tex</a>) {
<a name="l00366"></a>00366             zn= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a9033aa08ffa8e8ff41be1bf1693f509b">sin</a>*xn - har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a64985ecb5608fa0d8f373daf398fe610">cos</a>*yn;
<a name="l00367"></a>00367             yn= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a64985ecb5608fa0d8f373daf398fe610">cos</a>*xn + har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a9033aa08ffa8e8ff41be1bf1693f509b">sin</a>*yn;
<a name="l00368"></a>00368             xn= zn;
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371     <span class="keywordflow">else</span> dist= dist/har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a2813ecb819ef4d5496772f62da80a3b3">radsq</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#a72dbbabf44e4cbead78c59b11175b656">HA_FLARECIRC</a>) {
<a name="l00374"></a>00374         
<a name="l00375"></a>00375         dist= 0.5+<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dist-0.5f);
<a name="l00376"></a>00376         
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ac33c1ea4cecf2ecc66b448986f0e1693">hard</a>&gt;=30) {
<a name="l00380"></a>00380         dist= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dist);
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ac33c1ea4cecf2ecc66b448986f0e1693">hard</a>&gt;=40) {
<a name="l00382"></a>00382             dist= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(dist*(<span class="keywordtype">float</span>)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a958e4508ed28ee5cc04249144312c15f">M_PI_2</a>);
<a name="l00383"></a>00383             <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ac33c1ea4cecf2ecc66b448986f0e1693">hard</a>&gt;=50) {
<a name="l00384"></a>00384                 dist= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dist);
<a name="l00385"></a>00385             }
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ac33c1ea4cecf2ecc66b448986f0e1693">hard</a>&lt;20) dist*=dist;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (dist &lt; 1.0f)
<a name="l00391"></a>00391         dist= (1.0f-dist);
<a name="l00392"></a>00392     <span class="keywordflow">else</span>
<a name="l00393"></a>00393         dist= 0.0f;
<a name="l00394"></a>00394     
<a name="l00395"></a>00395     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a120bf9f2e8817858b6d3be6b958c23cb">linec</a>) {
<a name="l00396"></a>00396         <span class="keywordtype">float</span> *rc, fac;
<a name="l00397"></a>00397         <span class="keywordtype">int</span> ofs;
<a name="l00398"></a>00398         
<a name="l00399"></a>00399         <span class="comment">/* per starpoint an antialiased line */</span>
<a name="l00400"></a>00400         ofs= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a2a3e6cbcc60403a056c5ee209c98f8a5">seed</a>;
<a name="l00401"></a>00401         
<a name="l00402"></a>00402         <span class="keywordflow">for</span> (a= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a120bf9f2e8817858b6d3be6b958c23cb">linec</a>; a&gt;0; a--, ofs+=3) {
<a name="l00403"></a>00403             
<a name="l00404"></a>00404             rc= <a class="code" href="../../dd/d05/noise_8c.html#a5d12acc6336a883bfc361172c3f5752c">hashvectf</a> + (ofs % 768);
<a name="l00405"></a>00405             
<a name="l00406"></a>00406             fac= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>( (xn)*rc[0]+(yn)*rc[1]);
<a name="l00407"></a>00407             
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (fac&lt; 1.0f )
<a name="l00409"></a>00409                 linef+= (1.0f-fac);
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411         
<a name="l00412"></a>00412         linef*= dist;
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab20cf0314b2e03ecce0f1d248c16ee36">starpoints</a>) {
<a name="l00416"></a>00416         <span class="keywordtype">float</span> ster, <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00417"></a>00417         <span class="comment">/* rotation */</span>
<a name="l00418"></a>00418         angle= <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(yn, xn);
<a name="l00419"></a>00419         angle*= (1.0f+0.25f*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab20cf0314b2e03ecce0f1d248c16ee36">starpoints</a>);
<a name="l00420"></a>00420         
<a name="l00421"></a>00421         co= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(angle);
<a name="l00422"></a>00422         si= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(angle);
<a name="l00423"></a>00423         
<a name="l00424"></a>00424         angle= (co*xn+si*yn)*(co*yn-si*xn);
<a name="l00425"></a>00425         
<a name="l00426"></a>00426         ster= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(angle);
<a name="l00427"></a>00427         <span class="keywordflow">if</span> (ster&gt;1.0f) {
<a name="l00428"></a>00428             ster= (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a779a3c79af8081911639ce0bd0ac1130">rad</a>)/(ster);
<a name="l00429"></a>00429             
<a name="l00430"></a>00430             <span class="keywordflow">if</span> (ster&lt;1.0f) dist*= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(ster);
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="comment">/* disputable optimize... (ton) */</span>
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (dist&lt;=0.00001f)
<a name="l00436"></a>00436         <span class="keywordflow">return</span> 0;
<a name="l00437"></a>00437     
<a name="l00438"></a>00438     dist*= alpha;
<a name="l00439"></a>00439     ringf*= dist;
<a name="l00440"></a>00440     linef*= alpha;
<a name="l00441"></a>00441     
<a name="l00442"></a>00442     <span class="comment">/* The color is either the rgb spec-ed by the user, or extracted from   */</span>
<a name="l00443"></a>00443     <span class="comment">/* the texture                                                           */</span>
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a4dd5eb4a96dde958905b093886ea48cc">tex</a>) {
<a name="l00445"></a>00445         col[0]= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a>; 
<a name="l00446"></a>00446         col[1]= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a>; 
<a name="l00447"></a>00447         col[2]= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a>;
<a name="l00448"></a>00448         col[3]= dist;
<a name="l00449"></a>00449         
<a name="l00450"></a>00450         <a class="code" href="../../df/dba/texture_8h.html#aabf6885dbd37f8dc9af584f71fb963ed">do_halo_tex</a>(har, xn, yn, col);
<a name="l00451"></a>00451         
<a name="l00452"></a>00452         col[0]*= col[3];
<a name="l00453"></a>00453         col[1]*= col[3];
<a name="l00454"></a>00454         col[2]*= col[3];
<a name="l00455"></a>00455         
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">else</span> {
<a name="l00458"></a>00458         col[0]= dist*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3003c17d5841b1b487dd505491f3d52a">r</a>;
<a name="l00459"></a>00459         col[1]= dist*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a0384c045b96ad018717d20efbd0513b1">g</a>;
<a name="l00460"></a>00460         col[2]= dist*har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ab7d93357b522b9419652988360e0cd46">b</a>;
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8943793af765f367389a5c20b20fde41">HA_XALPHA</a>) col[3]= dist*dist;
<a name="l00462"></a>00462         <span class="keywordflow">else</span> col[3]= dist;
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>) {
<a name="l00466"></a>00466         <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ae9a18ed3a4e4ac8ff2740655ae694013">MA_HALO_SHADE</a>) {
<a name="l00467"></a>00467             <span class="comment">/* we test for lights because of preview... */</span>
<a name="l00468"></a>00468             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights.first) <a class="code" href="../../d9/dc7/pixelshading_8c.html#ae3b3fd22c42d62ccdfd965376b2c9302">render_lighting_halo</a>(har, col);
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         <span class="comment">/* Next, we do the line and ring factor modifications. */</span>
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (linef!=0.0f) {
<a name="l00473"></a>00473             <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>;
<a name="l00474"></a>00474             
<a name="l00475"></a>00475             col[0]+= linef * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af595797ad989716e9a27949aa0fc3fcb">specr</a>;
<a name="l00476"></a>00476             col[1]+= linef * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a056953ed5167834167da6744af3ef1ff">specg</a>;
<a name="l00477"></a>00477             col[2]+= linef * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac7a3474ca6b651dbd0cb99b3849750e2">specb</a>;
<a name="l00478"></a>00478             
<a name="l00479"></a>00479             <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8943793af765f367389a5c20b20fde41">HA_XALPHA</a>) col[3]+= linef*linef;
<a name="l00480"></a>00480             <span class="keywordflow">else</span> col[3]+= linef;
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482         <span class="keywordflow">if</span> (ringf!=0.0f) {
<a name="l00483"></a>00483             <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ad2c96b647aac0c60d272df3b1f7e04cc">mat</a>;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485             col[0]+= ringf * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a5f52fd66a8540b2442213722f9715e41">mirr</a>;
<a name="l00486"></a>00486             col[1]+= ringf * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1c58663867c8b7242f526194393e4ee6">mirg</a>;
<a name="l00487"></a>00487             col[2]+= ringf * ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a6793793fa26367926045ffcae03d8474">mirb</a>;
<a name="l00488"></a>00488             
<a name="l00489"></a>00489             <span class="keywordflow">if</span> (har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#a3f078a16703e97c2e9ec33962bec1cba">type</a> &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8943793af765f367389a5c20b20fde41">HA_XALPHA</a>) col[3]+= ringf*ringf;
<a name="l00490"></a>00490             <span class="keywordflow">else</span> col[3]+= ringf;
<a name="l00491"></a>00491         }
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     
<a name="l00494"></a>00494     <span class="comment">/* alpha requires clip, gives black dots */</span>
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (col[3] &gt; 1.0f)
<a name="l00496"></a>00496         col[3]= 1.0f;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">return</span> 1;
<a name="l00499"></a>00499 }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="comment">/* Only view vector is important here. Result goes to col_r[3] */</span>
<a name="l00504"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#a3350a4efc0f19f5c99c5127c6544adbf">00504</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(<span class="keywordtype">float</span> col_r[3], <span class="keyword">const</span> <span class="keywordtype">float</span> rco[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dxyview[2], <span class="keywordtype">short</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506     <span class="keywordtype">float</span> lo[3], zen[3], hor[3], <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>, blendm;
<a name="l00507"></a>00507     <span class="keywordtype">int</span> skyflag;
<a name="l00508"></a>00508     
<a name="l00509"></a>00509     <span class="comment">/* flag indicating if we render the top hemisphere */</span>
<a name="l00510"></a>00510     skyflag = <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5a28b03f5d53e0a34d098ab2a8b03eaf">WO_ZENUP</a>;
<a name="l00511"></a>00511     
<a name="l00512"></a>00512     <span class="comment">/* Some view vector stuff. */</span>
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ad4022c2e675d4a4f25ea99c833bad0b8">WO_SKYREAL</a>) {
<a name="l00514"></a>00514         
<a name="l00515"></a>00515         blend = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.grvec);
<a name="l00516"></a>00516         
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (blend&lt;0.0f) skyflag= 0;
<a name="l00518"></a>00518         
<a name="l00519"></a>00519         blend= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(blend);
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a3e06163f47d64dae704193cfa4008d8f">WO_SKYPAPER</a>) {
<a name="l00522"></a>00522         blend= 0.5f + 0.5f * view[1];
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524     <span class="keywordflow">else</span> {
<a name="l00525"></a>00525         <span class="comment">/* the fraction of how far we are above the bottom of the screen */</span>
<a name="l00526"></a>00526         blend= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(0.5f + view[1]);
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(hor, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr);
<a name="l00530"></a>00530     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(zen, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenr);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="comment">/* Careful: SKYTEX and SKYBLEND are NOT mutually exclusive! If           */</span>
<a name="l00533"></a>00533     <span class="comment">/* SKYBLEND is active, the texture and color blend are added.           */</span>
<a name="l00534"></a>00534     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab33a2cd9d8570434339bbfd7a3664a0a">WO_SKYTEX</a>) {
<a name="l00535"></a>00535         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lo, view);
<a name="l00536"></a>00536         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ad4022c2e675d4a4f25ea99c833bad0b8">WO_SKYREAL</a>) {
<a name="l00537"></a>00537             
<a name="l00538"></a>00538             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.imat, lo);
<a name="l00539"></a>00539             
<a name="l00540"></a>00540             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, lo[1],  lo[2]);
<a name="l00541"></a>00541             
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543         <a class="code" href="../../df/dba/texture_8h.html#a94cf83c880cf8e294c05af423bf2624e">do_sky_tex</a>(rco, lo, dxyview, hor, zen, &amp;blend, skyflag, thread);
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545     
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (blend&gt;1.0f) blend= 1.0f;
<a name="l00547"></a>00547     blendm= 1.0f-<a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l00548"></a>00548     
<a name="l00549"></a>00549     <span class="comment">/* No clipping, no conversion! */</span>
<a name="l00550"></a>00550     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a2f8fe7e66ac133b4d95886abeed2900e">WO_SKYBLEND</a>) {
<a name="l00551"></a>00551         col_r[0] = (blendm*hor[0] + blend*zen[0]);
<a name="l00552"></a>00552         col_r[1] = (blendm*hor[1] + blend*zen[1]);
<a name="l00553"></a>00553         col_r[2] = (blendm*hor[2] + blend*zen[2]);
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555     <span class="keywordflow">else</span> {
<a name="l00556"></a>00556         <span class="comment">/* Done when a texture was grabbed. */</span>
<a name="l00557"></a>00557         col_r[0]= hor[0];
<a name="l00558"></a>00558         col_r[1]= hor[1];
<a name="l00559"></a>00559         col_r[2]= hor[2];
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 <span class="comment">/* shade sky according to sun lamps, all parameters are like shadeSkyView except sunsky*/</span>
<a name="l00564"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#a18941dec954f5f0c240f0caa0206ee41">00564</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(<span class="keywordtype">float</span> col_r[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3])
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l00567"></a>00567     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00568"></a>00568     <span class="keywordtype">float</span> sview[3];
<a name="l00569"></a>00569     <span class="keywordtype">int</span> do_init= 1;
<a name="l00570"></a>00570     
<a name="l00571"></a>00571     <span class="keywordflow">for</span> (go=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights.first; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l00572"></a>00572         lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> &amp;&amp;    lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a> &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac6d6c031fe6fd039f98c5fcc695a2247">effect_type</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7a634c6683d6ac9a1214bc85f4baf561">LA_SUN_EFFECT_SKY</a>)) {
<a name="l00574"></a>00574             <span class="keywordtype">float</span> sun_collector[3];
<a name="l00575"></a>00575             <span class="keywordtype">float</span> colorxyz[3];
<a name="l00576"></a>00576             
<a name="l00577"></a>00577             <span class="keywordflow">if</span> (do_init) {
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(sview, view);
<a name="l00580"></a>00580                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.imat, sview);
<a name="l00581"></a>00581                 <span class="keywordflow">if</span> (sview[2] &lt; 0.0f)
<a name="l00582"></a>00582                     sview[2] = 0.0f;
<a name="l00583"></a>00583                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(sview);
<a name="l00584"></a>00584                 do_init= 0;
<a name="l00585"></a>00585             }
<a name="l00586"></a>00586             
<a name="l00587"></a>00587             <a class="code" href="../../dc/d88/sunsky_8h.html#a635b203f1cec132c76cd888249df299b">GetSkyXYZRadiancef</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>, sview, colorxyz);
<a name="l00588"></a>00588             <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a2e7b99561d42bfdbbc562ac71fc360bf">xyz_to_rgb</a>(colorxyz[0], colorxyz[1], colorxyz[2], &amp;sun_collector[0], &amp;sun_collector[1], &amp;sun_collector[2], 
<a name="l00589"></a>00589                        lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7299aacc8f3babf7a16758bd0968256c">sky_colorspace</a>);
<a name="l00590"></a>00590             
<a name="l00591"></a>00591             <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a749f61e3d414352b282ab681986ebfc8">skyblendtype</a>, col_r, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8f524918c440cd0c5b7926156e156e81">sunsky</a>-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a8fcd983c4bed0caf9ff9f7d2f733a741">skyblendfac</a>, sun_collector);
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">/*</span>
<a name="l00598"></a>00598 <span class="comment"> * Stuff the sky color into the collector.</span>
<a name="l00599"></a>00599 <span class="comment"> */</span>
<a name="l00600"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#a9e9e11d9aaf91f1f064f666847e5ab5f">00600</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d05/pixelshading_8h.html#a9e9e11d9aaf91f1f064f666847e5ab5f">shadeSkyPixel</a>(<span class="keywordtype">float</span> collector[4], <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <span class="keywordtype">short</span> <a class="code" href="../../df/d68/classthread.html">thread</a>)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     <span class="keywordtype">float</span> view[3], dxyview[2];
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="comment">/*</span>
<a name="l00605"></a>00605 <span class="comment">     * The rules for sky:</span>
<a name="l00606"></a>00606 <span class="comment">     * 1. Draw an image, if a background image was provided. Stop</span>
<a name="l00607"></a>00607 <span class="comment">     * 2. get texture and color blend, and combine these.</span>
<a name="l00608"></a>00608 <span class="comment">     */</span>
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordtype">float</span> fac;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a2f8fe7e66ac133b4d95886abeed2900e">WO_SKYBLEND</a>+<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab33a2cd9d8570434339bbfd7a3664a0a">WO_SKYTEX</a>))==0) {
<a name="l00613"></a>00613         <span class="comment">/* 1. solid color */</span>
<a name="l00614"></a>00614         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(collector, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         collector[3] = 0.0f;
<a name="l00617"></a>00617     } 
<a name="l00618"></a>00618     <span class="keywordflow">else</span> {
<a name="l00619"></a>00619         <span class="comment">/* 2. */</span>
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         <span class="comment">/* This one true because of the context of this routine  */</span>
<a name="l00622"></a>00622         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a3e06163f47d64dae704193cfa4008d8f">WO_SKYPAPER</a>) {
<a name="l00623"></a>00623             view[0]= -1.0f + 2.0f*(fx/(float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx);
<a name="l00624"></a>00624             view[1]= -1.0f + 2.0f*(fy/(float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy);
<a name="l00625"></a>00625             view[2]= 0.0;
<a name="l00626"></a>00626             
<a name="l00627"></a>00627             dxyview[0]= 1.0f/(float)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx;
<a name="l00628"></a>00628             dxyview[1]= 1.0f/(<span class="keywordtype">float</span>)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy;
<a name="l00629"></a>00629         }
<a name="l00630"></a>00630         <span class="keywordflow">else</span> {
<a name="l00631"></a>00631             <a class="code" href="../../d0/d0e/rendercore_8h.html#af170a4376e3760003c79d828fe89c7d0">calc_view_vector</a>(view, fx, fy);
<a name="l00632"></a>00632             fac= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l00633"></a>00633             
<a name="l00634"></a>00634             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.skytype &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab33a2cd9d8570434339bbfd7a3664a0a">WO_SKYTEX</a>) {
<a name="l00635"></a>00635                 dxyview[0]= -<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewdx/fac;
<a name="l00636"></a>00636                 dxyview[1]= -<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewdy/fac;
<a name="l00637"></a>00637             }
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639         
<a name="l00640"></a>00640         <span class="comment">/* get sky color in the collector */</span>
<a name="l00641"></a>00641         <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(collector, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, view, dxyview, thread);
<a name="l00642"></a>00642         collector[3] = 0.0f;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644     
<a name="l00645"></a>00645     <a class="code" href="../../d0/d0e/rendercore_8h.html#af170a4376e3760003c79d828fe89c7d0">calc_view_vector</a>(view, fx, fy);
<a name="l00646"></a>00646     <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(collector, view);
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="comment">/* aerial perspective */</span>
<a name="l00650"></a><a class="code" href="../../d9/dc7/pixelshading_8c.html#a887279bfe25202116c20d8f765c4820f">00650</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d05/pixelshading_8h.html#a495e55faa20437a6da8179a3a70d2d96">shadeAtmPixel</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a> *sunsky, <span class="keywordtype">float</span> collector[3], <span class="keywordtype">float</span> fx, <span class="keywordtype">float</span> fy, <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="keywordtype">float</span> view[3];
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <a class="code" href="../../d0/d0e/rendercore_8h.html#af170a4376e3760003c79d828fe89c7d0">calc_view_vector</a>(view, fx, fy);
<a name="l00655"></a>00655     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l00656"></a>00656     <span class="comment">/*mul_m3_v3(R.imat, view);*/</span>
<a name="l00657"></a>00657     <a class="code" href="../../dc/d88/sunsky_8h.html#a1d5ef4ae25285a3f691a14a8c02570b7">AtmospherePixleShader</a>(sunsky, view, distance, collector);
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="comment">/* eof */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:44 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
