<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: solver_main.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">solver_main.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d9/d2b/solver__main_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * El&#39;Beem - Free Surface Fluid Simulation with the Lattice Boltzmann Method</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright 2003-2006 Nils Thuerey</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Standard LBM Factory implementation</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *****************************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d24/solver__class_8h.html">solver_class.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d75/solver__relax_8h.html">solver_relax.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d69/particletracer_8h.html">particletracer.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d41/loop__tools_8h.html">loop_tools.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="comment">/*****************************************************************************/</span>
<a name="l00021"></a>00021 <span class="comment">/*****************************************************************************/</span>
<a name="l00022"></a>00022 
<a name="l00023"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#a71808d769198f430100abb2a4b994256">00023</a> <span class="keywordtype">double</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a71808d769198f430100abb2a4b994256">globdfcnt</a>;
<a name="l00024"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#afb5e0f5d3cd036f3803c00b185b2aa15">00024</a> <span class="keywordtype">double</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#afb5e0f5d3cd036f3803c00b185b2aa15">globdfavg</a>[19];
<a name="l00025"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#a331d1130fd808a6be8c3641baca74ae8">00025</a> <span class="keywordtype">double</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a331d1130fd808a6be8c3641baca74ae8">globdfmax</a>[19];
<a name="l00026"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad02ffd736945d8fe4857df8355ab57fb">00026</a> <span class="keywordtype">double</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad02ffd736945d8fe4857df8355ab57fb">globdfmin</a>[19];
<a name="l00027"></a>00027 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>,<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#ab6ff78cb4ce2a353f47a92a3c21018f8">glob_mpnum</a>;
<a name="l00028"></a>00028 <span class="keyword">extern</span> <span class="keywordtype">bool</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4da29f67d1d381cded63595eed3d462e">globOutstrForce</a>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="comment">// simulation object interface</span>
<a name="l00031"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a69fdb250dfd0730ccf4b11def0a5072f">00031</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a69fdb250dfd0730ccf4b11def0a5072f">LbmFsgrSolver::step</a>() { 
<a name="l00032"></a>00032     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4a51bdd784b2952e07310f442d291cd2">stepMain</a>();
<a name="l00033"></a>00033 }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">// lbm main step</span>
<a name="l00036"></a>00036 <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a04d0c522395a5bb68e7265f8633ca18e">messageOutputForce</a>(<span class="keywordtype">string</span> from);
<a name="l00037"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4a51bdd784b2952e07310f442d291cd2">00037</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4a51bdd784b2952e07310f442d291cd2">LbmFsgrSolver::stepMain</a>() { 
<a name="l00038"></a>00038     <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> timestart = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00039"></a>00039 
<a name="l00040"></a>00040     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1eedd6b2c8bd318a4cdd4e868d41c1eb" title="Initialize omegas and forces on all levels (for init/timestep change)">initLevelOmegas</a>();
<a name="l00041"></a>00041     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a09fbef62264f98c4a5e7404e64045fce">markedClearList</a>(); <span class="comment">// DMC clearMarkedCellsList</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043     <span class="comment">// safety check, counter reset</span>
<a name="l00044"></a>00044     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a> = 0;
<a name="l00045"></a>00045     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a892c4c850e08c8b2c3cdefe271941c75" title="fluid stats">mNumInterdCells</a> = 0;
<a name="l00046"></a>00046     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a9d77bc50a4140b08b633840a5f1d7e5e">mNumInvIfCells</a> = 0;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048   <span class="comment">//debugOutNnl(&quot;LbmFsgrSolver::step : &quot;&lt;&lt;mStepCnt, 10);</span>
<a name="l00049"></a>00049   <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::step&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <a class="code" href="../../db/dff/classLbmSolverInterface.html#aa07d7718f9fe8054024b89a4105964f8">mName</a>&lt;&lt;<span class="stringliteral">&quot; cnt:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>&lt;&lt;<span class="stringliteral">&quot; t:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>, 10); }
<a name="l00050"></a>00050     <span class="comment">//debMsgDirect(  &quot;LbmFsgrSolver::step : &quot;&lt;&lt;mStepCnt&lt;&lt;&quot; &quot;);</span>
<a name="l00051"></a>00051     <span class="comment">//myTime_t timestart = 0;</span>
<a name="l00052"></a>00052     <span class="comment">//if(mStartSymm) { checkSymmetry(&quot;step1&quot;); } // DEBUG </span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="comment">// time adapt</span>
<a name="l00055"></a>00055     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a52300efb79ae97f755da53d66026db05">mMaxVlen</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97efbfafd441bc2c300f38618356bec0">mMxvz</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a00506d50238e68b4a916c33de9d5b82d">mMxvy</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a8df9c9df85b54438a6f3beb7ad470307" title="track max. velocity">mMxvx</a> = 0.0;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <span class="comment">// init moving bc&#39;s, can change mMaxVlen</span>
<a name="l00058"></a>00058     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6afefacd79094e4c5fb6a3073145bcf3" title="init moving obstacles for next sim step sim">initMovingObstacles</a>(<span class="keyword">false</span>);
<a name="l00059"></a>00059     
<a name="l00060"></a>00060     <span class="comment">// handle fluid control </span>
<a name="l00061"></a>00061     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#afed938e8ab5789319d9136f00bf754de">handleCpdata</a>();
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="comment">// important - keep for tadap</span>
<a name="l00064"></a>00064     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lastMass = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>;
<a name="l00065"></a>00065     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a>; <span class="comment">// reset here for next step</span>
<a name="l00066"></a>00066     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadde2333da700e8b59fdec8ce3a2a21d">mCurrentVolume</a> = 0.0;
<a name="l00067"></a>00067     
<a name="l00068"></a>00068     <span class="comment">//change to single step advance!</span>
<a name="l00069"></a>00069     <span class="keywordtype">int</span> levsteps = 0;
<a name="l00070"></a>00070     <span class="keywordtype">int</span> dsbits = <a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a> ^ (<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>-1);
<a name="l00071"></a>00071     <span class="comment">//errMsg(&quot;S&quot;,&quot; step:&quot;&lt;&lt;mStepCnt&lt;&lt;&quot; s-1:&quot;&lt;&lt;(mStepCnt-1)&lt;&lt;&quot; xf:&quot;&lt;&lt;convertCellFlagType2String(dsbits));</span>
<a name="l00072"></a>00072     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev=0; lev&lt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>; lev++) {
<a name="l00073"></a>00073         <span class="comment">//if(! (mStepCnt&amp;(1&lt;&lt;lev)) ) {</span>
<a name="l00074"></a>00074         <span class="keywordflow">if</span>( dsbits &amp; (1&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>-lev)) ) {
<a name="l00075"></a>00075             <span class="comment">//errMsg(&quot;S&quot;,&quot; l&quot;&lt;&lt;lev);</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077             <span class="keywordflow">if</span>(lev==<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) {
<a name="l00078"></a>00078                 <span class="comment">// always advance fine level...</span>
<a name="l00079"></a>00079                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac89a9a4cb36ddc19996bd874b51f9f8e" title="advance fine grid">fineAdvance</a>();
<a name="l00080"></a>00080             } <span class="keywordflow">else</span> {
<a name="l00081"></a>00081                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a4c7cb0e8a03c580e65ccc368dcb401e3">adaptGrid</a>(lev);
<a name="l00082"></a>00082                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97c57a11db77306909c68df328272ca6" title="multi level functions">coarseRestrictFromFine</a>(lev);
<a name="l00083"></a>00083                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac31e6ed4d719af9ba132a97331159ffe" title="advance coarse grid">coarseAdvance</a>(lev);
<a name="l00084"></a>00084             }
<a name="l00085"></a>00085 <span class="preprocessor">#if FSGR_OMEGA_DEBUG==1</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>            <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;LbmFsgrSolver::step&quot;</span>,<span class="stringliteral">&quot;LES stats l=&quot;</span>&lt;&lt;lev&lt;&lt;<span class="stringliteral">&quot; omega=&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].omega&lt;&lt;<span class="stringliteral">&quot; avgOmega=&quot;</span>&lt;&lt; (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].avgOmega/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].avgOmegaCnt) );
<a name="l00087"></a>00087             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aed69d3b1808d245fd47e5a4a46e703fc">avgOmega</a> = 0.0; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a8eabc7924711e070189f16b21c1c3f94">avgOmegaCnt</a> = 0.0;
<a name="l00088"></a>00088 <span class="preprocessor">#endif // FSGR_OMEGA_DEBUG==1</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>            levsteps++;
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>   += <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2fd0a63e02aeb6ca2b93e19040fbd07f" title="mass&amp;volume for this level">lmass</a>;
<a name="l00092"></a>00092         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadde2333da700e8b59fdec8ce3a2a21d">mCurrentVolume</a> += <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ad24148aecd9abb90cd0100eabb440703">lvolume</a>;
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   <span class="comment">// prepare next step</span>
<a name="l00096"></a>00096     <a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>++;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="comment">// some dbugging output follows</span>
<a name="l00100"></a>00100     <span class="comment">// calculate MLSUPS</span>
<a name="l00101"></a>00101     <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> timeend = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a> += <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a892c4c850e08c8b2c3cdefe271941c75" title="fluid stats">mNumInterdCells</a>; <span class="comment">// count both types for MLSUPS</span>
<a name="l00104"></a>00104     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#afccc2fe16943150260d515b244ea098f">mAvgNumUsedCells</a> += <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>;
<a name="l00105"></a>00105     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a36d347768c1672da4b98928208931b4d">mMLSUPS</a> = ((double)<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a> / ((timeend-timestart)/(double)1000.0) ) / (1000000.0);
<a name="l00106"></a>00106     <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a36d347768c1672da4b98928208931b4d">mMLSUPS</a>&gt;10000){ <a class="code" href="../../db/dff/classLbmSolverInterface.html#a36d347768c1672da4b98928208931b4d">mMLSUPS</a> = -1; }
<a name="l00107"></a>00107     <span class="comment">//else { mAvgMLSUPS += mMLSUPS; mAvgMLSUPSCnt += 1.0; } // track average mlsups</span>
<a name="l00108"></a>00108     
<a name="l00109"></a>00109     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> totMLSUPS = ( ((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>-2)*(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lSizey-2)*(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab174bfba48094afdd7847a7cec4a82a2">getForZMax1</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>)-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad066dc119f1bcd9dd4ec5849210c4fda">getForZMin1</a>())) / ((timeend-timestart)/(<span class="keywordtype">double</span>)1000.0) ) / (1000000);
<a name="l00110"></a>00110     <span class="keywordflow">if</span>(totMLSUPS&gt;10000) totMLSUPS = -1;
<a name="l00111"></a>00111     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1ce922519a229495f84b159370c3dabc">mNumInvIfTotal</a> += <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a9d77bc50a4140b08b633840a5f1d7e5e">mNumInvIfCells</a>; <span class="comment">// debug</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113   <span class="comment">// do some formatting </span>
<a name="l00114"></a>00114   <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ 
<a name="l00115"></a>00115         <span class="keywordtype">int</span> avgcls = (int)(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#afccc2fe16943150260d515b244ea098f">mAvgNumUsedCells</a>/(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a41a6a848ac1750ea79579492320f45b6">LONGINT</a>)<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>);
<a name="l00116"></a>00116     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::step&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <a class="code" href="../../db/dff/classLbmSolverInterface.html#aa07d7718f9fe8054024b89a4105964f8">mName</a>&lt;&lt;<span class="stringliteral">&quot; cnt:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>&lt;&lt;<span class="stringliteral">&quot; t:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>&lt;&lt;
<a name="l00117"></a>00117             <span class="stringliteral">&quot; cur-mlsups:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a36d347768c1672da4b98928208931b4d">mMLSUPS</a>&lt;&lt; <span class="comment">//&quot; avg:&quot;&lt;&lt;(mAvgMLSUPS/mAvgMLSUPSCnt)&lt;&lt;&quot;), &quot;&lt;&lt; </span>
<a name="l00118"></a>00118             <span class="stringliteral">&quot; totcls:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>&lt;&lt; <span class="stringliteral">&quot; avgcls:&quot;</span>&lt;&lt; avgcls&lt;&lt; 
<a name="l00119"></a>00119             <span class="stringliteral">&quot; intd:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a892c4c850e08c8b2c3cdefe271941c75" title="fluid stats">mNumInterdCells</a>&lt;&lt; <span class="stringliteral">&quot; invif:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a9d77bc50a4140b08b633840a5f1d7e5e">mNumInvIfCells</a>&lt;&lt; 
<a name="l00120"></a>00120             <span class="stringliteral">&quot; invift:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1ce922519a229495f84b159370c3dabc">mNumInvIfTotal</a>&lt;&lt; <span class="stringliteral">&quot; fsgrcs:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a87046fc9adf1d49189af26539be2e3a6">mNumFsgrChanges</a>&lt;&lt; 
<a name="l00121"></a>00121             <span class="stringliteral">&quot; filled:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a43de085c6b09820fc804ec697debe940">mNumFilledCells</a>&lt;&lt;<span class="stringliteral">&quot;, emptied:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a9579b2132c4b31c0a5e0121963fcf911">mNumEmptiedCells</a>&lt;&lt; 
<a name="l00122"></a>00122             <span class="stringliteral">&quot; mMxv:&quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#aa1f5d23ceba93fcb09cf2c2258fb3ba5">PRINT_VEC</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a8df9c9df85b54438a6f3beb7ad470307" title="track max. velocity">mMxvx</a>,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a00506d50238e68b4a916c33de9d5b82d">mMxvy</a>,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97efbfafd441bc2c300f38618356bec0">mMxvz</a>)&lt;&lt;<span class="stringliteral">&quot;, tscnts:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7f5edad200c90c474a24dbe5594cd2a3" title="count no. of switches">mTimeSwitchCounts</a>&lt;&lt; 
<a name="l00123"></a>00123             <span class="comment">//&quot; RWmxv:&quot;&lt;&lt;ntlVec3Gfx(mMxvx,mMxvy,mMxvz)*(mLevel[mMaxRefine].simCellSize / mLevel[mMaxRefine].timestep)&lt;&lt;&quot; &quot;&lt;&lt; /* realworld vel output */</span>
<a name="l00124"></a>00124             <span class="stringliteral">&quot; probs:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aeebe0b6350b64f6a2b7aa9b7a67c8af0" title="count problematic cases, that occured so far...">mNumProblems</a>&lt;&lt; <span class="stringliteral">&quot; simt:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>&lt;&lt; 
<a name="l00125"></a>00125             <span class="stringliteral">&quot; took:&quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(timeend-timestart)&lt;&lt;
<a name="l00126"></a>00126             <span class="stringliteral">&quot; for &#39;&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#aa07d7718f9fe8054024b89a4105964f8">mName</a>&lt;&lt;<span class="stringliteral">&quot;&#39; &quot;</span> , 10);
<a name="l00127"></a>00127     } <span class="keywordflow">else</span> { <a class="code" href="../../de/df0/utilities_8h.html#a53a891c94e097c591c694e21d6aaded4">debMsgDirect</a>(<span class="stringliteral">&quot;.&quot;</span>); }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>==1) {
<a name="l00130"></a>00130         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aeec49ef9fef90cb8b00047ac70f6e5fd">mMinNoCells</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab759fb4943103c9efdb635c913bc8c46" title="kepp track of max/min no. of filled cells">mMaxNoCells</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>;
<a name="l00131"></a>00131     } <span class="keywordflow">else</span> {
<a name="l00132"></a>00132         <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab759fb4943103c9efdb635c913bc8c46" title="kepp track of max/min no. of filled cells">mMaxNoCells</a>) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab759fb4943103c9efdb635c913bc8c46" title="kepp track of max/min no. of filled cells">mMaxNoCells</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>;
<a name="l00133"></a>00133         <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aeec49ef9fef90cb8b00047ac70f6e5fd">mMinNoCells</a>) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aeec49ef9fef90cb8b00047ac70f6e5fd">mMinNoCells</a> = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a>;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="comment">// mass scale test</span>
<a name="l00137"></a>00137     <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>&gt;0)&amp;&amp;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>&gt;0.0)) {
<a name="l00138"></a>00138         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> mscale = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         mscale = 1.0;
<a name="l00141"></a>00141         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dchh = 0.001;
<a name="l00142"></a>00142         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>) mscale = 1.0+dchh;
<a name="l00143"></a>00143         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>) mscale = 1.0-dchh;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145         <span class="comment">// use mass rescaling?</span>
<a name="l00146"></a>00146         <span class="comment">// with float precision this seems to be nonsense...</span>
<a name="l00147"></a>00147         <span class="keyword">const</span> <span class="keywordtype">bool</span> MREnable = <span class="keyword">false</span>;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="keyword">const</span> <span class="keywordtype">int</span> MSInter = 2;
<a name="l00150"></a>00150         <span class="keyword">static</span> <span class="keywordtype">int</span> mscount = 0;
<a name="l00151"></a>00151         <span class="keywordflow">if</span>( (MREnable) &amp;&amp; ((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[0].lsteps%MSInter)== (MSInter-1)) &amp;&amp; ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>( (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>)-1.0 ) &gt; 0.01) &amp;&amp; ( dsbits &amp; (1&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>-0)) ) ){
<a name="l00152"></a>00152             <span class="comment">// example: FORCE RESCALE MASS! ini:1843.5, cur:1817.6, f=1.01425 step:22153 levstep:5539 msc:37</span>
<a name="l00153"></a>00153             <span class="comment">// mass rescale MASS RESCALE check</span>
<a name="l00154"></a>00154             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MDTDD&quot;</span>,<span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00155"></a>00155             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MDTDD&quot;</span>,<span class="stringliteral">&quot;FORCE RESCALE MASS! &quot;</span>
<a name="l00156"></a>00156                     &lt;&lt;<span class="stringliteral">&quot;ini:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>&lt;&lt;<span class="stringliteral">&quot;, cur:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>&lt;&lt;<span class="stringliteral">&quot;, f=&quot;</span>&lt;&lt;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>)
<a name="l00157"></a>00157                     &lt;&lt;<span class="stringliteral">&quot; step:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>&lt;&lt;<span class="stringliteral">&quot; levstep:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[0].lsteps&lt;&lt;<span class="stringliteral">&quot; msc:&quot;</span>&lt;&lt;mscount&lt;&lt;<span class="stringliteral">&quot; &quot;</span>
<a name="l00158"></a>00158                     );
<a name="l00159"></a>00159             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MDTDD&quot;</span>,<span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161             mscount++;
<a name="l00162"></a>00162             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> lev=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>; lev&gt;=0 ; lev--) {
<a name="l00163"></a>00163                 <span class="comment">//for(int workSet = 0; workSet&lt;=1; workSet++) {</span>
<a name="l00164"></a>00164                 <span class="keywordtype">int</span> wss = 0;
<a name="l00165"></a>00165                 <span class="keywordtype">int</span> wse = 1;
<a name="l00166"></a>00166 <span class="preprocessor">#if COMPRESSGRIDS==1</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(lev== <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>) wss = wse = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00168"></a>00168 <span class="preprocessor">#endif // COMPRESSGRIDS==1</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span>                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> workSet = wss; workSet&lt;=wse; workSet++) { <span class="comment">// COMPRT</span>
<a name="l00170"></a>00170 
<a name="l00171"></a>00171                     <a class="code" href="../../d1/d24/solver__class_8h.html#a1cd53306465fab36f6bc4c1d8ef9d291">FSGR_FORIJK1</a>(lev) {
<a name="l00172"></a>00172                         <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>)) 
<a name="l00173"></a>00173                             ) {
<a name="l00174"></a>00174 
<a name="l00175"></a>00175                             <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, l) *= mscale; }
<a name="l00176"></a>00176                             <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) *= mscale;
<a name="l00177"></a>00177                             <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) *= mscale;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179                         } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180                             <span class="keywordflow">continue</span>;
<a name="l00181"></a>00181                         }
<a name="l00182"></a>00182                     }
<a name="l00183"></a>00183                 }
<a name="l00184"></a>00184                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2fd0a63e02aeb6ca2b93e19040fbd07f" title="mass&amp;volume for this level">lmass</a> *= mscale;
<a name="l00185"></a>00185             }
<a name="l00186"></a>00186         } 
<a name="l00187"></a>00187 
<a name="l00188"></a>00188         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a> *= mscale;
<a name="l00189"></a>00189     }<span class="comment">// if mass scale test */</span>
<a name="l00190"></a>00190     <span class="keywordflow">else</span> {
<a name="l00191"></a>00191         <span class="comment">// use current mass after full step for initial setting</span>
<a name="l00192"></a>00192         <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>&gt;0)&amp;&amp;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>&lt;=0.0) &amp;&amp; (levsteps == (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>+1))) {
<a name="l00193"></a>00193             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>;
<a name="l00194"></a>00194             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;MDTDD&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;Second Initial Mass Init: &quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a>, 2);
<a name="l00195"></a>00195         }
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="preprocessor">#if LBM_INCLUDE_TESTSOLVERS==1</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>    <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3cbbe08b78aafee0bf1572e5bae2d811">mUseTestdata</a>)&amp;&amp;(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a0cb712be00a6c0fe651a2798abe4ab88">mInitDone</a>)) { handleTestdata(); }
<a name="l00200"></a>00200     mrExchange();
<a name="l00201"></a>00201 <span class="preprocessor">#endif</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>
<a name="l00203"></a>00203     <span class="comment">// advance positions with current grid</span>
<a name="l00204"></a>00204     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aef81da55d27713fcfd97d3e5f756f29f">advanceParticles</a>();
<a name="l00205"></a>00205     <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a5bbaae326effab891ecad2f6f9bf4b0d" title="store particle tracer">mpParticles</a>) {
<a name="l00206"></a>00206         <a class="code" href="../../db/dff/classLbmSolverInterface.html#a5bbaae326effab891ecad2f6f9bf4b0d" title="store particle tracer">mpParticles</a>-&gt;<a class="code" href="../../de/db7/classParticleTracer.html#a463a0a4a407c8d1d75a3827ea02f8a34" title="called after each frame to check if positions should be dumped">checkDumpTextPositions</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>);
<a name="l00207"></a>00207         <a class="code" href="../../db/dff/classLbmSolverInterface.html#a5bbaae326effab891ecad2f6f9bf4b0d" title="store particle tracer">mpParticles</a>-&gt;<a class="code" href="../../de/db7/classParticleTracer.html#aed8725fe29601fe0f7a5e1edada30483">checkTrails</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a>);
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="comment">// one of the last things to do - adapt timestep</span>
<a name="l00211"></a>00211     <span class="comment">// was in fineAdvance before... </span>
<a name="l00212"></a>00212     <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3cc8dd62ffb041fcb2068e7da4bb4e5c" title="use time adaptivity?">mTimeAdap</a>) {
<a name="l00213"></a>00213         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac54636f91eb5017737efb7598baf53b3">adaptTimestep</a>();
<a name="l00214"></a>00214     } <span class="comment">// time adaptivity</span>
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>    <span class="comment">// good indicator for instabilities</span>
<a name="l00219"></a>00219     <span class="keywordflow">if</span>( (!finite(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a8df9c9df85b54438a6f3beb7ad470307" title="track max. velocity">mMxvx</a>)) || (!finite(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a00506d50238e68b4a916c33de9d5b82d">mMxvy</a>)) || (!finite(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a97efbfafd441bc2c300f38618356bec0">mMxvz</a>)) ) { <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>; }
<a name="l00220"></a>00220     <span class="keywordflow">if</span>( (!finite(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>)) || (!finite(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadde2333da700e8b59fdec8ce3a2a21d">mCurrentVolume</a>)) ) { <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>; }
<a name="l00221"></a>00221 <span class="preprocessor">#endif // WIN32</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a>00223     <span class="comment">// output total step time</span>
<a name="l00224"></a>00224     <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> timeend2 = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00225"></a>00225     <span class="keywordtype">double</span> mdelta = (lastMass-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>);
<a name="l00226"></a>00226     <span class="keywordflow">if</span>(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(mdelta)&lt;1e-12) mdelta=0.;
<a name="l00227"></a>00227     <span class="keywordtype">double</span> effMLSUPS = ((double)<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a> / ((timeend2-timestart)/(double)1000.0) ) / (1000000.0);
<a name="l00228"></a>00228     <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a0cb712be00a6c0fe651a2798abe4ab88">mInitDone</a>) {
<a name="l00229"></a>00229         <span class="keywordflow">if</span>(effMLSUPS&gt;10000){ effMLSUPS = -1; }
<a name="l00230"></a>00230         <span class="keywordflow">else</span> { <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2907db3903d0cd35906af14ee97df99d">mAvgMLSUPS</a> += effMLSUPS; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1bd3f16b8c7bf908c3ca3e7e06dbfb57">mAvgMLSUPSCnt</a> += 1.0; } <span class="comment">// track average mlsups</span>
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     
<a name="l00233"></a>00233     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;LbmFsgrSolver::stepMain&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <span class="stringliteral">&quot;mmpid:&quot;</span>&lt;&lt;<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>&lt;&lt;<span class="stringliteral">&quot; step:&quot;</span>&lt;&lt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a>
<a name="l00234"></a>00234             &lt;&lt;<span class="stringliteral">&quot; dccd=&quot;</span>&lt;&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>
<a name="l00235"></a>00235             <span class="comment">//&lt;&lt;&quot;,d&quot;&lt;&lt;mdelta</span>
<a name="l00236"></a>00236             <span class="comment">//&lt;&lt;&quot;,ds&quot;&lt;&lt;(mCurrentMass-mObjectMassMovnd[1])</span>
<a name="l00237"></a>00237             <span class="comment">//&lt;&lt;&quot;/&quot;&lt;&lt;mCurrentVolume&lt;&lt;&quot;(fix=&quot;&lt;&lt;mFixMass&lt;&lt;&quot;,ini=&quot;&lt;&lt;mInitialMass&lt;&lt;&quot;), &quot;</span>
<a name="l00238"></a>00238             &lt;&lt;<span class="stringliteral">&quot; effMLSUPS=(&quot;</span>&lt;&lt; effMLSUPS
<a name="l00239"></a>00239             &lt;&lt;<span class="stringliteral">&quot;,avg:&quot;</span>&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2907db3903d0cd35906af14ee97df99d">mAvgMLSUPS</a>/<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1bd3f16b8c7bf908c3ca3e7e06dbfb57">mAvgMLSUPSCnt</a>)&lt;&lt;<span class="stringliteral">&quot;), &quot;</span>
<a name="l00240"></a>00240             &lt;&lt;<span class="stringliteral">&quot; took totst:&quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(timeend2-timestart), 3);
<a name="l00241"></a>00241     <span class="comment">// nicer output</span>
<a name="l00242"></a>00242     <span class="comment">//debMsgDirect(std::endl); </span>
<a name="l00243"></a>00243     <span class="comment">// */</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a04d0c522395a5bb68e7265f8633ca18e">messageOutputForce</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00246"></a>00246  <span class="comment">//#endif // ELBEEM_PLUGIN!=1</span>
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#abaa1c3cedfbbf901e6b954b001cb2d02">00249</a> <span class="preprocessor">#define NEWDEBCHECK(str) \</span>
<a name="l00250"></a>00250 <span class="preprocessor">    if(!this-&gt;mPanic){ FSGR_FORIJK_BOUNDS(mMaxRefine) { \</span>
<a name="l00251"></a>00251 <span class="preprocessor">        if(RFLAG(mMaxRefine,i,j,k,mLevel[mMaxRefine].setCurr)&amp;(CFFluid|CFInter)) { \</span>
<a name="l00252"></a>00252 <span class="preprocessor">        for(int l=0;l&lt;dTotalNum;l++) { \</span>
<a name="l00253"></a>00253 <span class="preprocessor">            if(!finite(QCELL(mMaxRefine,i,j,k,mLevel[mMaxRefine].setCurr,l))) { errMsg(&quot;NNOFIN&quot;,&quot; &quot;&lt;&lt;str&lt;&lt;&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; l&quot;&lt;&lt;l&lt;&lt;&quot; &quot;); }\</span>
<a name="l00254"></a>00254 <span class="preprocessor">        }</span><span class="comment">/*for*/</span> \
<a name="l00255"></a>00255         }<span class="comment">/*if*/</span> \
<a name="l00256"></a>00256     } }
<a name="l00257"></a>00257 
<a name="l00258"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac89a9a4cb36ddc19996bd874b51f9f8e">00258</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ac89a9a4cb36ddc19996bd874b51f9f8e" title="advance fine grid">LbmFsgrSolver::fineAdvance</a>()
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260     <span class="comment">// do the real thing...</span>
<a name="l00261"></a>00261     <span class="comment">//NEWDEBCHECK(&quot;t1&quot;);</span>
<a name="l00262"></a>00262     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a15575701256f1373594c728110ae06d7" title="fine step function">mainLoop</a>( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a> );
<a name="l00263"></a>00263     <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a931a090fc3ce0b4cc91d0f4f88d24ac8">mUpdateFVHeight</a>) {
<a name="l00264"></a>00264         <span class="comment">// warning assume -Y gravity...</span>
<a name="l00265"></a>00265         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#abb0f406ebbf469e1153877413af0d573" title="fluid vol height">mFVHeight</a> = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a6e354059ddae9c48053b758729e04204" title="mass calculated during streaming step">mCurrentMass</a>*<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a10b64cbe82425bfd2453000cfe7ef9dc">mFVArea</a>/((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lSizex*<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lSizez));
<a name="l00266"></a>00266         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#abb0f406ebbf469e1153877413af0d573" title="fluid vol height">mFVHeight</a>&lt;1.0) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#abb0f406ebbf469e1153877413af0d573" title="fluid vol height">mFVHeight</a> = 1.0;
<a name="l00267"></a>00267         <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a2954c3acbfcda93534cb17e0eb03a876">setFluidVolumeHeight</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#abb0f406ebbf469e1153877413af0d573" title="fluid vol height">mFVHeight</a>);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="comment">// advance time before timestep change</span>
<a name="l00271"></a>00271     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a50412f936b85efad4ad14b135fd78847" title="total simulation time so far">mSimulationTime</a> += <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ad6481f27613af196314d262f662a5c61">getTimestep</a>();
<a name="l00272"></a>00272     <span class="comment">// time adaptivity</span>
<a name="l00273"></a>00273     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a7408e004d2084b9f025365f0fcd038dd">mpParam</a>-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#aa8f0eaa100c08ad87f62d869477a7d26">setSimulationMaxSpeed</a>( <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a52300efb79ae97f755da53d66026db05">mMaxVlen</a> / 1.5) );
<a name="l00274"></a>00274     <span class="comment">//if(mStartSymm) { checkSymmetry(&quot;step2&quot;); } // DEBUG </span>
<a name="l00275"></a>00275     <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;fineAdvance&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot; stepped from &quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setCurr&lt;&lt;<span class="stringliteral">&quot; to &quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setOther&lt;&lt;<span class="stringliteral">&quot; step&quot;</span>&lt;&lt; (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].lsteps), 3 ); }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="comment">// update other set</span>
<a name="l00278"></a>00278   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a969dc4eebe3ff743980e099cad72240a" title="target/other set of dist funcs">setOther</a>   = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00279"></a>00279   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>   ^= 1;
<a name="l00280"></a>00280   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a71ed2e9133bd4102bf1d3be8e29b97a0" title="step count">lsteps</a>++;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">// flag init... (work on current set, to simplify flag checks)</span>
<a name="l00283"></a>00283     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a59ea03776e39abe07bb7142307976b2c" title="flag reinit step - always works on finest grid!">reinitFlags</a>( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setCurr );
<a name="l00284"></a>00284     <span class="keywordflow">if</span>(!<a class="code" href="../../db/dff/classLbmSolverInterface.html#aee34210942d51f7babe9ad9d367e350f" title="debug output?">mSilent</a>){ <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;fineAdvance&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot; flags reinit on set &quot;</span>&lt;&lt; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setCurr, 3 ); }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <span class="comment">// DEBUG VEL CHECK</span>
<a name="l00287"></a>00287     <span class="keywordflow">if</span>(0) {
<a name="l00288"></a>00288         <span class="keywordtype">int</span> lev = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l00289"></a>00289         <span class="keywordtype">int</span> workSet = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l00290"></a>00290         <span class="keywordtype">int</span> mi=0,mj=0,mk=0;
<a name="l00291"></a>00291         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> compRho=0.;
<a name="l00292"></a>00292         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> compUx=0.;
<a name="l00293"></a>00293         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> compUy=0.;
<a name="l00294"></a>00294         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> compUz=0.;
<a name="l00295"></a>00295         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> maxUlen=0.;
<a name="l00296"></a>00296         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> maxU(0.);
<a name="l00297"></a>00297         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> maxRho=-100.;
<a name="l00298"></a>00298         <span class="keywordtype">int</span> ri=0,rj=0,rk=0;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <a class="code" href="../../d1/d24/solver__class_8h.html#a1cd53306465fab36f6bc4c1d8ef9d291">FSGR_FORIJK1</a>(lev) {
<a name="l00301"></a>00301             <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev,<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, workSet) &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#ac378aafd920a230c4488d4706c816b87">CFGrFromFine</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#ad2159dd2d8e6b9112bed41907ec3bad7">CFGrNorm</a>)) ) {
<a name="l00302"></a>00302                 compRho=<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, <a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a>);
<a name="l00303"></a>00303                 compUx = compUy = compUz = 0.0;
<a name="l00304"></a>00304                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l00305"></a>00305                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> df = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,workSet, l);
<a name="l00306"></a>00306                     compRho += df;
<a name="l00307"></a>00307                     compUx  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*df);
<a name="l00308"></a>00308                     compUy  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*df); 
<a name="l00309"></a>00309                     compUz  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*df); 
<a name="l00310"></a>00310                 } 
<a name="l00311"></a>00311                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> u(compUx,compUy,compUz);
<a name="l00312"></a>00312                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nu = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(u);
<a name="l00313"></a>00313                 <span class="keywordflow">if</span>(nu&gt;maxUlen) {
<a name="l00314"></a>00314                     maxU = u;
<a name="l00315"></a>00315                     maxUlen = nu;
<a name="l00316"></a>00316                     mi=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; mj=j; mk=k;
<a name="l00317"></a>00317                 }
<a name="l00318"></a>00318                 <span class="keywordflow">if</span>(compRho&gt;maxRho) {
<a name="l00319"></a>00319                     maxRho=compRho;
<a name="l00320"></a>00320                     ri=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; rj=j; rk=k;
<a name="l00321"></a>00321                 }
<a name="l00322"></a>00322             } <span class="keywordflow">else</span> {
<a name="l00323"></a>00323                 <span class="keywordflow">continue</span>;
<a name="l00324"></a>00324             }
<a name="l00325"></a>00325         }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MAXVELCHECK&quot;</span>,<span class="stringliteral">&quot; at &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#aa1f5d23ceba93fcb09cf2c2258fb3ba5">PRINT_VEC</a>(mi,mj,mk)&lt;&lt;<span class="stringliteral">&quot; norm:&quot;</span>&lt;&lt;maxUlen&lt;&lt;<span class="stringliteral">&quot; u:&quot;</span>&lt;&lt;maxU);
<a name="l00328"></a>00328         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MAXRHOCHECK&quot;</span>,<span class="stringliteral">&quot; at &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#aa1f5d23ceba93fcb09cf2c2258fb3ba5">PRINT_VEC</a>(ri,rj,rk)&lt;&lt;<span class="stringliteral">&quot; rho:&quot;</span>&lt;&lt;maxRho);
<a name="l00329"></a>00329         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a58362bf0afc375950175bc78125b9462" title="internal quick print function (for debugging)">printLbmCell</a>(lev, 30,36,23, -1);
<a name="l00330"></a>00330     } <span class="comment">// DEBUG VEL CHECK</span>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="comment">// fine step defines</span>
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">// access to own dfs during step (may be changed to local array)</span>
<a name="l00339"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">00339</a> <span class="preprocessor">#define MYDF(l) RAC(ccel, l)</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>
<a name="l00341"></a>00341 <span class="comment">// drop model definitions</span>
<a name="l00342"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#a025d690618d648f4d51e496851517b97">00342</a> <span class="preprocessor">#define RWVEL_THRESH 1.5</span>
<a name="l00343"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#a98e16587de8db47d60a007f81926577a">00343</a> <span class="preprocessor"></span><span class="preprocessor">#define RWVEL_WINDTHRESH (RWVEL_THRESH*0.5)</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span>
<a name="l00345"></a>00345 <span class="preprocessor">#if LBMDIM==3</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="comment">// normal</span>
<a name="l00347"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad1d6d88cb01bd943c59ca06c78e1dfa7">00347</a> <span class="preprocessor">#define SLOWDOWNREGION (mSizez/4)</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor">#else // LBMDIM==2</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="comment">// off</span>
<a name="l00350"></a>00350 <span class="preprocessor">#define SLOWDOWNREGION 10 </span>
<a name="l00351"></a>00351 <span class="preprocessor"></span><span class="preprocessor">#endif // LBMDIM==2</span>
<a name="l00352"></a><a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa4681d8630f315e649802ceedd36608f">00352</a> <span class="preprocessor"></span><span class="preprocessor">#define P_LCSMQO 0.01</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>
<a name="l00354"></a>00354 <span class="comment">/*****************************************************************************/</span>
<a name="l00356"></a>00356 <span class="comment">/*****************************************************************************/</span>
<a name="l00357"></a>00357 <span class="keywordtype">void</span> 
<a name="l00358"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a15575701256f1373594c728110ae06d7">00358</a> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a15575701256f1373594c728110ae06d7" title="fine step function">LbmFsgrSolver::mainLoop</a>(<span class="keywordtype">int</span> lev)
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360     <span class="comment">// loops over _only inner_ cells  -----------------------------------------------------------------------------------</span>
<a name="l00361"></a>00361     
<a name="l00362"></a>00362     <span class="comment">// slow surf regions smooth (if below)</span>
<a name="l00363"></a>00363     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> smoothStrength = 0.0; <span class="comment">//0.01;</span>
<a name="l00364"></a>00364     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> sssUsqrLimit = 1.5 * 0.03*0.03;
<a name="l00365"></a>00365     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> sssUsqrLimitInv = 1.0/sssUsqrLimit;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="keyword">const</span> <span class="keywordtype">int</span> cutMin  = 1;
<a name="l00368"></a>00368     <span class="keyword">const</span> <span class="keywordtype">int</span> cutConst = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a883de517b6b8407dbd30c35169b53c84" title="border cutoff value">mCutoff</a>+2;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 <span class="preprocessor">#   if LBM_INCLUDE_TESTSOLVERS==1</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>    <span class="comment">// 3d region off... quit</span>
<a name="l00373"></a>00373     <span class="keywordflow">if</span>((<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3cbbe08b78aafee0bf1572e5bae2d811">mUseTestdata</a>)&amp;&amp;(mpTest-&gt;mFarfMode&gt;0)) { <span class="keywordflow">return</span>; }
<a name="l00374"></a>00374 <span class="preprocessor">#   endif // ELBEEM_PLUGIN!=1</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>    
<a name="l00376"></a>00376   <span class="comment">// main loop region</span>
<a name="l00377"></a>00377     <span class="keyword">const</span> <span class="keywordtype">bool</span> doReduce = <span class="keyword">true</span>;
<a name="l00378"></a>00378     <span class="keyword">const</span> <span class="keywordtype">int</span> gridLoopBound=1;
<a name="l00379"></a>00379     <a class="code" href="../../dd/d41/loop__tools_8h.html#aa667319c69798626cff44dc611349e7f">GRID_REGION_INIT</a>();
<a name="l00380"></a>00380 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span><span class="preprocessor">#pragma omp parallel default(shared) \</span>
<a name="l00382"></a>00382 <span class="preprocessor">  reduction(+: \</span>
<a name="l00383"></a>00383 <span class="preprocessor">      calcCurrentMass,calcCurrentVolume, \</span>
<a name="l00384"></a>00384 <span class="preprocessor">        calcCellsFilled,calcCellsEmptied, \</span>
<a name="l00385"></a>00385 <span class="preprocessor">        calcNumUsedCells )</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span>    <a class="code" href="../../dd/d41/loop__tools_8h.html#aa89ccaa4075d3de7f57a2235ece72572">GRID_REGION_START</a>();
<a name="l00387"></a>00387 <span class="preprocessor">#else // PARALLEL==1</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>    <a class="code" href="../../dd/d41/loop__tools_8h.html#aa89ccaa4075d3de7f57a2235ece72572">GRID_REGION_START</a>();
<a name="l00389"></a>00389 <span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>
<a name="l00391"></a>00391     <span class="comment">// local to main</span>
<a name="l00392"></a>00392     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> nbflag[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>]; 
<a name="l00393"></a>00393     <span class="keywordtype">int</span> oldFlag, newFlag, nbored;
<a name="l00394"></a>00394     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l00395"></a>00395     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho, ux, uy, uz, tmp, usqr;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     <span class="comment">// smago vars</span>
<a name="l00398"></a>00398     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqadd, lcsmeq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>], lcsmomega;
<a name="l00399"></a>00399     
<a name="l00400"></a>00400     <span class="comment">// ifempty cell conversion flags</span>
<a name="l00401"></a>00401     <span class="keywordtype">bool</span> iffilled, ifemptied;
<a name="l00402"></a>00402     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbfracs[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>]; <span class="comment">// ffracs of neighbors</span>
<a name="l00403"></a>00403     <span class="keywordtype">int</span> recons[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];   <span class="comment">// reconstruct this DF?</span>
<a name="l00404"></a>00404     <span class="keywordtype">int</span> numRecons;           <span class="comment">// how many are reconstructed?</span>
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> mass=0., change=0., lcsmqo=0.;
<a name="l00407"></a>00407     rho= ux= uy= uz= usqr= tmp= 0.; 
<a name="l00408"></a>00408     lcsmqadd = lcsmomega = 0.;
<a name="l00409"></a>00409     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ lcsmeq[l] = 0.; }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="comment">// ---</span>
<a name="l00412"></a>00412     <span class="comment">// now stream etc.</span>
<a name="l00413"></a>00413     <span class="comment">// use //template functions for 2D/3D</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <a class="code" href="../../dd/d41/loop__tools_8h.html#a9fdcd30a3b8698c32e4ad09c722f635a">GRID_LOOP_START</a>();
<a name="l00416"></a>00416         <span class="comment">// loop start</span>
<a name="l00417"></a>00417         <span class="comment">// stream from current set to other, then collide and store</span>
<a name="l00418"></a>00418         <span class="comment">//errMsg(&quot;l2&quot;,&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; id&quot;&lt;&lt;id);</span>
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="preprocessor">#       if FSGR_STRICT_DEBUG==1</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>        <span class="comment">// safety pointer check</span>
<a name="l00422"></a>00422         rho = ux = uy = uz = tmp = usqr = -100.0; <span class="comment">// DEBUG</span>
<a name="l00423"></a>00423         <span class="keywordflow">if</span>( (&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr) != pFlagSrc) || 
<a name="l00424"></a>00424             (&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setOther) != pFlagDst) ) {
<a name="l00425"></a>00425             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;LbmFsgrSolver::mainLoop&quot;</span>,<span class="stringliteral">&quot;Err flagp &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot;=&quot;</span>&lt;&lt;
<a name="l00426"></a>00426                     <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr)&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setOther)&lt;&lt;<span class="stringliteral">&quot; but is &quot;</span>&lt;&lt;
<a name="l00427"></a>00427                     (*pFlagSrc)&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;(*pFlagDst) &lt;&lt;<span class="stringliteral">&quot;,  pointers &quot;</span>&lt;&lt;
<a name="l00428"></a>00428           (<span class="keywordtype">long</span>)(&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr))&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;(<span class="keywordtype">long</span>)(&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setOther))&lt;&lt;<span class="stringliteral">&quot; but is &quot;</span>&lt;&lt;
<a name="l00429"></a>00429           (<span class="keywordtype">long</span>)(pFlagSrc)&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;(<span class="keywordtype">long</span>)(pFlagDst)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>
<a name="l00430"></a>00430                     ); 
<a name="l00431"></a>00431             <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>;
<a name="l00432"></a>00432         }   
<a name="l00433"></a>00433         <span class="keywordflow">if</span>( (&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr,0) != ccel) || 
<a name="l00434"></a>00434             (&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setOther,0) != tcel) ) {
<a name="l00435"></a>00435             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;LbmFsgrSolver::mainLoop&quot;</span>,<span class="stringliteral">&quot;Err cellp &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot;=&quot;</span>&lt;&lt;
<a name="l00436"></a>00436           (<span class="keywordtype">long</span>)(&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setCurr,0))&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;(<span class="keywordtype">long</span>)(&amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].setOther,0))&lt;&lt;<span class="stringliteral">&quot; but is &quot;</span>&lt;&lt;
<a name="l00437"></a>00437           (<span class="keywordtype">long</span>)(ccel)&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;(<span class="keywordtype">long</span>)(tcel)&lt;&lt;<span class="stringliteral">&quot; &quot;</span>
<a name="l00438"></a>00438                     ); 
<a name="l00439"></a>00439             <a class="code" href="../../d2/d75/solver__relax_8h.html#ae80956f703c9d97b2d0a938e5d7a0aa8">CAUSE_PANIC</a>;
<a name="l00440"></a>00440         }   
<a name="l00441"></a>00441 <span class="preprocessor">#       endif</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>        oldFlag = *pFlagSrc;
<a name="l00443"></a>00443         
<a name="l00444"></a>00444         <span class="comment">// old INTCFCOARSETEST==1</span>
<a name="l00445"></a>00445         <span class="keywordflow">if</span>( (oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>)) ) { 
<a name="l00446"></a>00446             <span class="keywordflow">if</span>(( <a class="code" href="../../db/dff/classLbmSolverInterface.html#ae22fd479f492ac4bcc02d0a510ab21dd">mStepCnt</a> &amp; (1&lt;&lt;(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>-lev)) ) ==1) {
<a name="l00447"></a>00447                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }
<a name="l00448"></a>00448             } <span class="keywordflow">else</span> {
<a name="l00449"></a>00449                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1e95e3818cbe3589eb44a89555a7e114" title="cell is interpolated from coarse level (inited into set, source sets are determined by t)...">interpolateCellFromCoarse</a>( lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), 0.0, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>, <span class="keyword">false</span>);
<a name="l00450"></a>00450                 calcNumUsedCells++;
<a name="l00451"></a>00451             }
<a name="l00452"></a>00452             <span class="keywordflow">continue</span>; <span class="comment">// interpolateFineFromCoarse test!</span>
<a name="l00453"></a>00453         } <span class="comment">// interpolateFineFromCoarse test! </span>
<a name="l00454"></a>00454     
<a name="l00455"></a>00455         <span class="keywordflow">if</span>(oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a4329fc9838ec0a7bc80d0631dfd91289">CFMbndInflow</a>)) {
<a name="l00456"></a>00456             <span class="comment">// fluid &amp; if are ok, fill if later on</span>
<a name="l00457"></a>00457             <span class="keywordtype">int</span> isValid = oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>);
<a name="l00458"></a>00458             <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> iniRho = 1.0;
<a name="l00459"></a>00459             <span class="keyword">const</span> <span class="keywordtype">int</span> OId = oldFlag&gt;&gt;24;
<a name="l00460"></a>00460             <span class="keywordflow">if</span>(!isValid) {
<a name="l00461"></a>00461                 <span class="comment">// make new if cell</span>
<a name="l00462"></a>00462                 <span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> vel(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad0dc1680ff9a031cf632cbca05c72f25" title="precalculated objects speeds for current parametrization">mObjectSpeeds</a>[OId]);
<a name="l00463"></a>00463                 <span class="comment">// TODO add OPT3D treatment</span>
<a name="l00464"></a>00464                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, iniRho,vel[0],vel[1],vel[2]); }
<a name="l00465"></a>00465                 <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = iniRho;
<a name="l00466"></a>00466                 <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = <a class="code" href="../../d1/d24/solver__class_8h.html#a604e06bc4a635aac711c4d0b29dfa1ef">FLUX_INIT</a>;
<a name="l00467"></a>00467                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>);
<a name="l00468"></a>00468                 calcCurrentMass += iniRho; 
<a name="l00469"></a>00469                 calcCurrentVolume += 1.0; 
<a name="l00470"></a>00470                 calcNumUsedCells++;
<a name="l00471"></a>00471                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a> += iniRho;
<a name="l00472"></a>00472                 <span class="comment">// dont treat cell until next step</span>
<a name="l00473"></a>00473                 <span class="keywordflow">continue</span>;
<a name="l00474"></a>00474             } 
<a name="l00475"></a>00475         } 
<a name="l00476"></a>00476         <span class="keywordflow">else</span>  <span class="comment">// these are exclusive</span>
<a name="l00477"></a>00477         <span class="keywordflow">if</span>(oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#abbcc2b1313cb2b55a0a0bfe2ba51499d">CFMbndOutflow</a>)) {
<a name="l00478"></a>00478             <span class="keywordtype">int</span> isnotValid = oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>);
<a name="l00479"></a>00479             <span class="keywordflow">if</span>(isnotValid) {
<a name="l00480"></a>00480                 <span class="comment">// remove fluid cells, shouldnt be here anyway</span>
<a name="l00481"></a>00481                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> fluidRho = m[0]; <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { fluidRho += m[l]; }
<a name="l00482"></a>00482                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a> -= fluidRho;
<a name="l00483"></a>00483                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> iniRho = 0.0;
<a name="l00484"></a>00484                 <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = iniRho;
<a name="l00485"></a>00485                 <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = <a class="code" href="../../d1/d24/solver__class_8h.html#a604e06bc4a635aac711c4d0b29dfa1ef">FLUX_INIT</a>;
<a name="l00486"></a>00486                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488                 <span class="comment">// same as ifemptied for if below</span>
<a name="l00489"></a>00489                 <a class="code" href="../../d0/df9/structLbmPoint.html">LbmPoint</a> oemptyp; oemptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a> = 0;
<a name="l00490"></a>00490                 oemptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#aabaaed0f34d022011b5ac3a255d1fd5d">x</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; oemptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#a516f69ea1f2d509eac6d931df4d2a019">y</a> = j; oemptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#a67c07375508ee8912bcae570493faca0">z</a> = k;
<a name="l00491"></a>00491                 <a class="code" href="../../dd/d41/loop__tools_8h.html#a8819f7f2955dee29e3b3029edf4f72c2">LIST_EMPTY</a>(oemptyp);
<a name="l00492"></a>00492                 calcCellsEmptied++;
<a name="l00493"></a>00493                 <span class="keywordflow">continue</span>;
<a name="l00494"></a>00494             }
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <span class="keywordflow">if</span>(oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a59edb41b92d2b093c8ec53e0fbc53074">CFGrFromCoarse</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a359bbf2f03fcbbfe1436259e9c2b1f60">CFUnused</a>)) { 
<a name="l00498"></a>00498             *pFlagDst = oldFlag;
<a name="l00499"></a>00499             <span class="keywordflow">continue</span>;
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501         <span class="comment">/*if( oldFlag &amp; CFNoBndFluid ) {  // TEST ME FASTER?</span>
<a name="l00502"></a>00502 <span class="comment">            OPTIMIZED_STREAMCOLLIDE; PERFORM_USQRMAXCHECK;</span>
<a name="l00503"></a>00503 <span class="comment">            RAC(tcel,dFfrac) = 1.0; </span>
<a name="l00504"></a>00504 <span class="comment">            *pFlagDst = (CellFlagType)oldFlag; // newFlag;</span>
<a name="l00505"></a>00505 <span class="comment">            calcCurrentMass += rho; calcCurrentVolume += 1.0;</span>
<a name="l00506"></a>00506 <span class="comment">            calcNumUsedCells++;</span>
<a name="l00507"></a>00507 <span class="comment">            continue;</span>
<a name="l00508"></a>00508 <span class="comment">        }// TEST ME FASTER? */</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         <span class="comment">// only neighbor flags! not own flag</span>
<a name="l00511"></a>00511         nbored = 0;
<a name="l00512"></a>00512         
<a name="l00513"></a>00513 <span class="preprocessor">#if OPT3D==0</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>        <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l00515"></a>00515             nbflag[l] = <a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev),l);
<a name="l00516"></a>00516             nbored |= nbflag[l];
<a name="l00517"></a>00517         } 
<a name="l00518"></a>00518 <span class="preprocessor">#else</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>        nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>];
<a name="l00520"></a>00520         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+-1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>];
<a name="l00521"></a>00521         nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a>];
<a name="l00522"></a>00522         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+ 1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>];
<a name="l00523"></a>00523         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+ <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>];
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>+-1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>];
<a name="l00526"></a>00526         nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a>];
<a name="l00527"></a>00527         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>] = *(pFlagSrc + (-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>+ 1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>];
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a>] = *(pFlagSrc + (-1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a>];
<a name="l00530"></a>00530         nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a>] = *(pFlagSrc + ( 1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a>];
<a name="l00531"></a>00531 
<a name="l00532"></a>00532         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>+-1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>];
<a name="l00533"></a>00533       nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a>];
<a name="l00534"></a>00534         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>+ 1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>];
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>];
<a name="l00537"></a>00537         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+-1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>];
<a name="l00538"></a>00538         nbflag[ <a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a>];
<a name="l00539"></a>00539         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+ 1)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>];
<a name="l00540"></a>00540         nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>] = *(pFlagSrc + ( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>+ <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>)); nbored |= nbflag[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>];
<a name="l00541"></a>00541         <span class="comment">// */</span>
<a name="l00542"></a>00542 <span class="preprocessor">#endif</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>
<a name="l00544"></a>00544         <span class="comment">// pointer to destination cell</span>
<a name="l00545"></a>00545         calcNumUsedCells++;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="comment">// FLUID cells </span>
<a name="l00548"></a>00548         <span class="keywordflow">if</span>( oldFlag &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a> ) { 
<a name="l00549"></a>00549             <span class="comment">// only standard fluid cells (with nothing except fluid as nbs</span>
<a name="l00550"></a>00550 
<a name="l00551"></a>00551             <span class="keywordflow">if</span>(oldFlag&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a4329fc9838ec0a7bc80d0631dfd91289">CFMbndInflow</a>) {
<a name="l00552"></a>00552                 <span class="comment">// force velocity for inflow, necessary to have constant direction of flow</span>
<a name="l00553"></a>00553                 <span class="comment">// FIXME , test also set interface cells?</span>
<a name="l00554"></a>00554                 <span class="keyword">const</span> <span class="keywordtype">int</span> OId = oldFlag&gt;&gt;24;
<a name="l00555"></a>00555                 <span class="comment">//? DEFAULT_STREAM;</span>
<a name="l00556"></a>00556                 <span class="comment">//const LbmFloat fluidRho = 1.0;</span>
<a name="l00557"></a>00557                 <span class="comment">// for submerged inflows, streaming would have to be performed...</span>
<a name="l00558"></a>00558                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> fluidRho = m[0]; <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { fluidRho += m[l]; }
<a name="l00559"></a>00559                 <span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> vel(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad0dc1680ff9a031cf632cbca05c72f25" title="precalculated objects speeds for current parametrization">mObjectSpeeds</a>[OId]);
<a name="l00560"></a>00560                 ux=vel[0], uy=vel[1], uz=vel[2]; 
<a name="l00561"></a>00561                 usqr = 1.5 * (ux*ux + uy*uy + uz*uz);
<a name="l00562"></a>00562                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, fluidRho,ux,uy,uz); }
<a name="l00563"></a>00563                 rho = fluidRho;
<a name="l00564"></a>00564                 <span class="comment">//errMsg(&quot;INFLOW_DEBUG&quot;,&quot;std at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; v=&quot;&lt;&lt;vel&lt;&lt;&quot; rho=&quot;&lt;&lt;rho);</span>
<a name="l00565"></a>00565             } <span class="keywordflow">else</span> {
<a name="l00566"></a>00566                 <span class="keywordflow">if</span>(nbored&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>) {
<a name="l00567"></a>00567                     <a class="code" href="../../d2/d75/solver__relax_8h.html#a62aeeb02480e9713cb4c28ac56f625a8">DEFAULT_STREAM</a>;
<a name="l00568"></a>00568                     <span class="comment">//ux = [0]; uy = mLevel[lev].gravity[1]; uz = mLevel[lev].gravity[2]; </span>
<a name="l00569"></a>00569                     <a class="code" href="../../d2/d75/solver__relax_8h.html#a1ae3840edf382b4dacbc6f5e1e614034">DEFAULT_COLLIDEG</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].gravity);
<a name="l00570"></a>00570                     oldFlag &amp;= (~<a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>);
<a name="l00571"></a>00571                 } <span class="keywordflow">else</span> {
<a name="l00572"></a>00572                     <span class="comment">// do standard stream/collide</span>
<a name="l00573"></a>00573                     <a class="code" href="../../d2/d75/solver__relax_8h.html#aca0e7264a23365d760325084f5f20962">OPTIMIZED_STREAMCOLLIDE</a>;
<a name="l00574"></a>00574                     oldFlag |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>;
<a name="l00575"></a>00575                 } 
<a name="l00576"></a>00576             }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578             <a class="code" href="../../dd/d41/loop__tools_8h.html#a404349d564604764a661cedbc0624798">PERFORM_USQRMAXCHECK</a>;
<a name="l00579"></a>00579             <span class="comment">// &quot;normal&quot; fluid cells</span>
<a name="l00580"></a>00580             <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = 1.0; 
<a name="l00581"></a>00581             *pFlagDst = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a>)oldFlag; <span class="comment">// newFlag;</span>
<a name="l00582"></a>00582             calcCurrentMass += rho; 
<a name="l00583"></a>00583             calcCurrentVolume += 1.0;
<a name="l00584"></a>00584             <span class="keywordflow">continue</span>;
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586         
<a name="l00587"></a>00587         newFlag  = oldFlag;
<a name="l00588"></a>00588         <span class="comment">// make sure here: always check which flags to really unset...!</span>
<a name="l00589"></a>00589         newFlag = newFlag &amp; (~( 
<a name="l00590"></a>00590                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>| <a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a> 
<a name="l00591"></a>00591                     | <a class="code" href="../../d2/d3c/solver__interface_8h.html#adce131aad1a8841dc1a68b7df4b1d828">CFNoInterpolSrc</a>
<a name="l00592"></a>00592                     | <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>
<a name="l00593"></a>00593                     ));
<a name="l00594"></a>00594         <span class="keywordflow">if</span>(!(nbored&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a52169459320fac69e44404feaa0a340e">CFBndNoslip</a>)) { <span class="comment">//NEWSURFT NEWSURFTNOS</span>
<a name="l00595"></a>00595             newFlag |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         <span class="comment">/*if(!(nbored&amp;CFBnd)) { //NEWSURFT NEWSURFTNOS</span>
<a name="l00598"></a>00598 <span class="comment">            // explicitly check for noslip neighbors</span>
<a name="l00599"></a>00599 <span class="comment">            bool hasnoslipnb = false;</span>
<a name="l00600"></a>00600 <span class="comment">            FORDF1 { if((nbflag[l]&amp;CFBnd)&amp;&amp;(nbflag[l]&amp;CFBndNoslip)) hasnoslipnb=true; }</span>
<a name="l00601"></a>00601 <span class="comment">            if(!hasnoslipnb) newFlag |= CFNoBndFluid; </span>
<a name="l00602"></a>00602 <span class="comment">        } // */</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604         <span class="comment">// store own dfs and mass</span>
<a name="l00605"></a>00605         mass = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607         <span class="comment">// WARNING - only interface cells arrive here!</span>
<a name="l00608"></a>00608         <span class="comment">// read distribution funtions of adjacent cells = stream step</span>
<a name="l00609"></a>00609         <a class="code" href="../../d2/d75/solver__relax_8h.html#a62aeeb02480e9713cb4c28ac56f625a8">DEFAULT_STREAM</a>;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611         <span class="keywordflow">if</span>((nbored &amp; CFFluid)==0) { newFlag |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a9d77bc50a4140b08b633840a5f1d7e5e">mNumInvIfCells</a>++; }
<a name="l00612"></a>00612         <span class="keywordflow">if</span>((nbored &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>)==0) { newFlag |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>; <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a9d77bc50a4140b08b633840a5f1d7e5e">mNumInvIfCells</a>++; }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614         <span class="comment">// calculate mass exchange for interface cells </span>
<a name="l00615"></a>00615         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> myfrac = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>);
<a name="l00616"></a>00616         <span class="keywordflow">if</span>(myfrac&lt;0.) myfrac=0.; <span class="comment">// NEWSURFT</span>
<a name="l00617"></a>00617 <span class="preprocessor">#       define nbdf(l) m[ this-&gt;dfInv[(l)] ]</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span>
<a name="l00619"></a>00619         <span class="comment">// update mass </span>
<a name="l00620"></a>00620         <span class="comment">// only do boundaries for fluid cells, and interface cells without</span>
<a name="l00621"></a>00621         <span class="comment">// any fluid neighbors (assume that interface cells _with_ fluid</span>
<a name="l00622"></a>00622         <span class="comment">// neighbors are affected enough by these) </span>
<a name="l00623"></a>00623         <span class="comment">// which Df&#39;s have to be reconstructed? </span>
<a name="l00624"></a>00624         <span class="comment">// for fluid cells - just the f_i difference from streaming to empty cells  ----</span>
<a name="l00625"></a>00625         numRecons = 0;
<a name="l00626"></a>00626         <span class="keywordtype">bool</span> onlyBndnb = ((!(oldFlag&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>))&amp;&amp;(oldFlag&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>)&amp;&amp;(nbored&amp;CFBndNoslip));
<a name="l00627"></a>00627         <span class="comment">//onlyBndnb = false; // DEBUG test off</span>
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { <span class="comment">// dfl loop</span>
<a name="l00630"></a>00630             recons[l] = 0;
<a name="l00631"></a>00631             nbfracs[l] = 0.0;
<a name="l00632"></a>00632             <span class="comment">// finally, &quot;normal&quot; interface cells ----</span>
<a name="l00633"></a>00633             <span class="keywordflow">if</span>( nbflag[l]&amp;(CFFluid|<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>) ) { <span class="comment">// NEWTEST! FIXME check!!!!!!!!!!!!!!!!!!</span>
<a name="l00634"></a>00634                 change = <a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa96730acc0b9cdef51e0d524740ed899">nbdf</a>(l) - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(l);
<a name="l00635"></a>00635             }
<a name="l00636"></a>00636             <span class="comment">// interface cells - distuingish cells that shouldn&#39;t fill/empty </span>
<a name="l00637"></a>00637             <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nbflag[l] &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a> ) {
<a name="l00638"></a>00638                 
<a name="l00639"></a>00639                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> mynbfac,nbnbfac;
<a name="l00640"></a>00640                 <span class="comment">// NEW TEST t1</span>
<a name="l00641"></a>00641                 <span class="comment">// t2 -&gt; off</span>
<a name="l00642"></a>00642                 <span class="keywordflow">if</span>((oldFlag&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>)&amp;&amp;(nbflag[l]&amp;CFNoBndFluid)) {
<a name="l00643"></a>00643                     mynbfac = <a class="code" href="../../d1/d24/solver__class_8h.html#aa2ec3cc5ea4099c60265e7bc5a0aef15">QCELL_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev),l, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) / <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev), <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>);
<a name="l00644"></a>00644                     nbnbfac = 1.0/mynbfac;
<a name="l00645"></a>00645                     onlyBndnb = <span class="keyword">false</span>;
<a name="l00646"></a>00646                 } <span class="keywordflow">else</span> {
<a name="l00647"></a>00647                     mynbfac = nbnbfac = 1.0; <span class="comment">// switch calc flux off</span>
<a name="l00648"></a>00648                     <span class="keywordflow">goto</span> changeDefault;  <span class="comment">// NEWSURFT</span>
<a name="l00649"></a>00649                     <span class="comment">//change = 0.; goto changeDone;  // NEWSURFT</span>
<a name="l00650"></a>00650                 }
<a name="l00651"></a>00651                 <span class="comment">//mynbfac = nbnbfac = 1.0; // switch calc flux off t3</span>
<a name="l00652"></a>00652 
<a name="l00653"></a>00653                 <span class="comment">// perform interface case handling</span>
<a name="l00654"></a>00654                 <span class="keywordflow">if</span> ((oldFlag|nbflag[l])&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)) {
<a name="l00655"></a>00655                 <span class="keywordflow">switch</span> (oldFlag&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)) {
<a name="l00656"></a>00656                     <span class="keywordflow">case</span> 0: 
<a name="l00657"></a>00657                         <span class="comment">// we are a normal cell so... </span>
<a name="l00658"></a>00658                         <span class="keywordflow">switch</span> (nbflag[l]&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)) {
<a name="l00659"></a>00659                             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>: 
<a name="l00660"></a>00660                                 <span class="comment">// just fill current cell = empty neighbor </span>
<a name="l00661"></a>00661                                 change = nbnbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa96730acc0b9cdef51e0d524740ed899">nbdf</a>(l) ; <span class="keywordflow">goto</span> changeDone; 
<a name="l00662"></a>00662                             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>: 
<a name="l00663"></a>00663                                 <span class="comment">// just empty current cell = fill neighbor </span>
<a name="l00664"></a>00664                                 change = - mynbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(l) ; <span class="keywordflow">goto</span> changeDone; 
<a name="l00665"></a>00665                         }
<a name="l00666"></a>00666                         <span class="keywordflow">break</span>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668                     <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>: 
<a name="l00669"></a>00669                         <span class="comment">// we dont have fluid nb&#39;s so...</span>
<a name="l00670"></a>00670                         <span class="keywordflow">switch</span> (nbflag[l]&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)) {
<a name="l00671"></a>00671                             <span class="keywordflow">case</span> 0: 
<a name="l00672"></a>00672                             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>: 
<a name="l00673"></a>00673                                 <span class="comment">// we have no fluid nb&#39;s -&gt; just empty</span>
<a name="l00674"></a>00674                                 change = - mynbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(l) ; <span class="keywordflow">goto</span> changeDone; 
<a name="l00675"></a>00675                         }
<a name="l00676"></a>00676                         <span class="keywordflow">break</span>;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                     <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>: 
<a name="l00679"></a>00679                         <span class="comment">// we dont have empty nb&#39;s so...</span>
<a name="l00680"></a>00680                         <span class="keywordflow">switch</span> (nbflag[l]&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)) {
<a name="l00681"></a>00681                             <span class="keywordflow">case</span> 0: 
<a name="l00682"></a>00682                             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>: 
<a name="l00683"></a>00683                                 <span class="comment">// we have no empty nb&#39;s -&gt; just fill</span>
<a name="l00684"></a>00684                                 change = nbnbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa96730acc0b9cdef51e0d524740ed899">nbdf</a>(l); <span class="keywordflow">goto</span> changeDone; 
<a name="l00685"></a>00685                         }
<a name="l00686"></a>00686                         <span class="keywordflow">break</span>;
<a name="l00687"></a>00687                 }} <span class="comment">// inter-inter exchange</span>
<a name="l00688"></a>00688 
<a name="l00689"></a>00689             changeDefault: ;
<a name="l00690"></a>00690                 <span class="comment">// just do normal mass exchange...</span>
<a name="l00691"></a>00691                 change = ( nbnbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa96730acc0b9cdef51e0d524740ed899">nbdf</a>(l) - mynbfac*<a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(l) ) ;
<a name="l00692"></a>00692             changeDone: ;
<a name="l00693"></a>00693                 nbfracs[l] = <a class="code" href="../../d1/d24/solver__class_8h.html#aa2ec3cc5ea4099c60265e7bc5a0aef15">QCELL_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev),l, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>);
<a name="l00694"></a>00694                 <span class="keywordflow">if</span>(nbfracs[l]&lt;0.) nbfracs[l] = 0.; <span class="comment">// NEWSURFT</span>
<a name="l00695"></a>00695                 change *=  (myfrac + nbfracs[l]) * 0.5;
<a name="l00696"></a>00696             } <span class="comment">// the other cell is interface</span>
<a name="l00697"></a>00697 
<a name="l00698"></a>00698             <span class="comment">// last alternative - reconstruction in this direction</span>
<a name="l00699"></a>00699             <span class="keywordflow">else</span> {
<a name="l00700"></a>00700                 <span class="comment">// empty + bnd case</span>
<a name="l00701"></a>00701                 recons[l] = 1; 
<a name="l00702"></a>00702                 numRecons++;
<a name="l00703"></a>00703                 change = 0.0; 
<a name="l00704"></a>00704             }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706             <span class="comment">// modify mass at SRCS</span>
<a name="l00707"></a>00707             mass += change;
<a name="l00708"></a>00708         } <span class="comment">// l</span>
<a name="l00709"></a>00709         <span class="comment">// normal interface, no if empty/fluid</span>
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="comment">// computenormal</span>
<a name="l00712"></a>00712         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> surfaceNormal[3];
<a name="l00713"></a>00713         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2bc2115887c69f0c23016e87c1ddc2de" title="compute surface normals: fluid, fluid more accurate, and for obstacles">computeFluidSurfaceNormal</a>(ccel,pFlagSrc, surfaceNormal);
<a name="l00714"></a>00714 
<a name="l00715"></a>00715         <span class="keywordflow">if</span>( (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(surfaceNormal[0])+<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(surfaceNormal[1])+<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(surfaceNormal[2])) &gt; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a0a6ff24e88963689483e35acbb53ca28">LBM_EPSILON</a>) {
<a name="l00716"></a>00716             <span class="comment">// normal ok and usable...</span>
<a name="l00717"></a>00717             <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l00718"></a>00718                 <span class="keywordflow">if</span>( (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*surfaceNormal[0] + this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*surfaceNormal[1] + this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*surfaceNormal[2])  <span class="comment">// dot Dvec,norml</span>
<a name="l00719"></a>00719                         &gt; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a0a6ff24e88963689483e35acbb53ca28">LBM_EPSILON</a>) {
<a name="l00720"></a>00720                     recons[l] = 2; 
<a name="l00721"></a>00721                     numRecons++;
<a name="l00722"></a>00722                 } 
<a name="l00723"></a>00723             }
<a name="l00724"></a>00724         }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <span class="comment">// calculate macroscopic cell values</span>
<a name="l00727"></a>00727         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> oldUx, oldUy, oldUz;
<a name="l00728"></a>00728         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> oldRho; <span class="comment">// OLD rho = ccel-&gt;rho;</span>
<a name="l00729"></a>00729 <span class="preprocessor">#       define REFERENCE_PRESSURE 1.0 // always atmosphere...</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span><span class="preprocessor">#       if OPT3D==0</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>        oldRho=<a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,0);
<a name="l00732"></a>00732         oldUx = oldUy = oldUz = 0.0;
<a name="l00733"></a>00733         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=1; l&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; l++) {
<a name="l00734"></a>00734             oldRho += <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l);
<a name="l00735"></a>00735             oldUx  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*<a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l));
<a name="l00736"></a>00736             oldUy  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*<a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l)); 
<a name="l00737"></a>00737             oldUz  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*<a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l)); 
<a name="l00738"></a>00738         } 
<a name="l00739"></a>00739         <span class="comment">// reconstruct dist funcs from empty cells</span>
<a name="l00740"></a>00740         <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l00741"></a>00741             <span class="keywordflow">if</span>(recons[ l ]) {
<a name="l00742"></a>00742                 m[ this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad7298c005477abe4727db7ddb2368ad7">dfInv</a>[l] ] = 
<a name="l00743"></a>00743                     this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, <a class="code" href="../../d9/d2b/solver__main_8cpp.html#ac252fa61a2eb41af847cf06ea07e8bfd">REFERENCE_PRESSURE</a>, oldUx,oldUy,oldUz) + 
<a name="l00744"></a>00744                     this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(this-&gt;dfInv[l], <a class="code" href="../../d9/d2b/solver__main_8cpp.html#ac252fa61a2eb41af847cf06ea07e8bfd">REFERENCE_PRESSURE</a>, oldUx,oldUy,oldUz) 
<a name="l00745"></a>00745                     - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>( l );
<a name="l00746"></a>00746             }
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748         ux=oldUx, uy=oldUy, uz=oldUz;  <span class="comment">// no local vars, only for usqr</span>
<a name="l00749"></a>00749         usqr = 1.5 * (ux*ux + uy*uy + uz*uz); <span class="comment">// needed later on</span>
<a name="l00750"></a>00750 <span class="preprocessor">#       else // OPT3D==0</span>
<a name="l00751"></a>00751 <span class="preprocessor"></span>        oldRho = + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a>)  + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> )
<a name="l00752"></a>00752                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> )
<a name="l00753"></a>00753                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> )
<a name="l00754"></a>00754                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>)
<a name="l00755"></a>00755                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>)
<a name="l00756"></a>00756                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>)
<a name="l00757"></a>00757                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>)
<a name="l00758"></a>00758                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>)
<a name="l00759"></a>00759                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>)
<a name="l00760"></a>00760                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762         oldUx = + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a>)
<a name="l00763"></a>00763                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>)
<a name="l00764"></a>00764                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>)
<a name="l00765"></a>00765                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>)
<a name="l00766"></a>00766                 - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         oldUy = + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a>)
<a name="l00769"></a>00769                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>)
<a name="l00770"></a>00770                 - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>)
<a name="l00771"></a>00771                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>) + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>)
<a name="l00772"></a>00772                 - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774         oldUz = + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a>)
<a name="l00775"></a>00775                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>)
<a name="l00776"></a>00776                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>)
<a name="l00777"></a>00777                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>)
<a name="l00778"></a>00778                 + <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>) - <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780         <span class="comment">// now reconstruction</span>
<a name="l00781"></a>00781         ux=oldUx, uy=oldUy, uz=oldUz;  <span class="comment">// no local vars, only for usqr</span>
<a name="l00782"></a>00782         rho = <a class="code" href="../../d9/d2b/solver__main_8cpp.html#ac252fa61a2eb41af847cf06ea07e8bfd">REFERENCE_PRESSURE</a>;
<a name="l00783"></a>00783         usqr = 1.5 * (ux*ux + uy*uy + uz*uz); <span class="comment">// needed later on</span>
<a name="l00784"></a>00784         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a722fe30f4252d44b8a3c5c19beb0adbf">EQN</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a1b96fad41423e3cf4555538bb18d8257">EQS</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dN ); }
<a name="l00785"></a>00785         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#ac46cfcc8d7eaa4512d9841b305fbe4a4">dS</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#ac31c474a9697f863a9dfbe46db76b415">dN</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a1b96fad41423e3cf4555538bb18d8257">EQS</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a722fe30f4252d44b8a3c5c19beb0adbf">EQN</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dS ); }
<a name="l00786"></a>00786         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a81e0d0c58cfceaa0f34804a4c3c7c87f">EQE</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a7b3634dc94663edad4a9711d53eaf6d3">EQW</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dE ); }
<a name="l00787"></a>00787         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a44be9b1eefe60b7e27b556d88abcc6f4">dW</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a7c88964022af72871b9fed013b1ddc8f">dE</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a7b3634dc94663edad4a9711d53eaf6d3">EQW</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a81e0d0c58cfceaa0f34804a4c3c7c87f">EQE</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dW ); }
<a name="l00788"></a>00788         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a1020140876056c409ec2a96ba81108e5">EQT</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a48ae093180e17535dac8c1954fbb57ab">EQB</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dT ); }
<a name="l00789"></a>00789         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#ab27d62f5a54da9ba6aa17c4c3ed57b30">dB</a> ]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a9089721cd57ed2f745c1f7e29c07b100">dT</a> ] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a48ae093180e17535dac8c1954fbb57ab">EQB</a>  + <a class="code" href="../../d2/d75/solver__relax_8h.html#a1020140876056c409ec2a96ba81108e5">EQT</a>  - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dB ); }
<a name="l00790"></a>00790         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a36f29e021f6cea7919dd97af1cb6599a">EQNE</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#acb168bbfb1f13defc6fadaaa966ad148">EQSW</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dNE); }
<a name="l00791"></a>00791         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a1ed57c0b94db20a8f5f52ba0c3be5ada">EQNW</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a76ddc4b64460551ac95b96f9bc21ab0b">EQSE</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dNW); }
<a name="l00792"></a>00792         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a53d0c163f8155911bff1e5a269d972cc">dSE</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a48ee6866e2aaa528e1a9878d3244d526">dNW</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a76ddc4b64460551ac95b96f9bc21ab0b">EQSE</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a1ed57c0b94db20a8f5f52ba0c3be5ada">EQNW</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dSE); }
<a name="l00793"></a>00793         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#abf959e134c6a8bf1d01d56b01ccc2117">dSW</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a2e473c6019a52c159c7a0b2864f4bafd">dNE</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#acb168bbfb1f13defc6fadaaa966ad148">EQSW</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a36f29e021f6cea7919dd97af1cb6599a">EQNE</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dSW); }
<a name="l00794"></a>00794         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a404c433c1176658255b9092233970e41">EQNT</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a435ece83e4586e898880b12b9e25f5cf">EQSB</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dNT); }
<a name="l00795"></a>00795         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#af90500bf22913ad12aa4eea619518f87">EQNB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a77fa943c6fa704a4aed89fdb848bc343">EQST</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dNB); }
<a name="l00796"></a>00796         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a10345c39daa49436f6cbbf6ed9e71215">dST</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a2b64b43268f38cd973bc967607afa16e">dNB</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a77fa943c6fa704a4aed89fdb848bc343">EQST</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#af90500bf22913ad12aa4eea619518f87">EQNB</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dST); }
<a name="l00797"></a>00797         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#aeb29648e34a1511a20b5f80664079726">dSB</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#ae078540cb5e597a152d3e745b40a6f8d">dNT</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a435ece83e4586e898880b12b9e25f5cf">EQSB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a404c433c1176658255b9092233970e41">EQNT</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dSB); }
<a name="l00798"></a>00798         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#aea72b62ac74fd26e19e5a8b1e6ab6fad">EQET</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a7e3d6f1de22ae27f016032b3dfb06fad">EQWB</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dET); }
<a name="l00799"></a>00799         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a36c155ddd28e226ace503943682ecc96">EQEB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a4cb50e5d21d4c41a2502d263168220b7">EQWT</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dEB); }
<a name="l00800"></a>00800         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#a6706cd8ff508fdeb40bbee9c35c91a07">dWT</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#abcc66e39dc21dead8486592376b10d1c">dEB</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a4cb50e5d21d4c41a2502d263168220b7">EQWT</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#a36c155ddd28e226ace503943682ecc96">EQEB</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dWT); }
<a name="l00801"></a>00801         <span class="keywordflow">if</span>(recons[<a class="code" href="../../d1/d24/solver__class_8h.html#aa4cfa63d66708e282d6306d62f5d5b89">dWB</a>]) { m[<a class="code" href="../../d1/d24/solver__class_8h.html#a60aa03f80d9979d8c5423be2b6b8577b">dET</a>] = <a class="code" href="../../d2/d75/solver__relax_8h.html#a7e3d6f1de22ae27f016032b3dfb06fad">EQWB</a> + <a class="code" href="../../d2/d75/solver__relax_8h.html#aea72b62ac74fd26e19e5a8b1e6ab6fad">EQET</a> - <a class="code" href="../../d9/d2b/solver__main_8cpp.html#a4427dc1b98e6d9a9d9474e47e4d2acc7">MYDF</a>(dWB); }
<a name="l00802"></a>00802 <span class="preprocessor">#       endif       </span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="comment">// inflow bc handling</span>
<a name="l00806"></a>00806         <span class="keywordflow">if</span>(oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a4329fc9838ec0a7bc80d0631dfd91289">CFMbndInflow</a>)) {
<a name="l00807"></a>00807             <span class="comment">// fill if cells in inflow region</span>
<a name="l00808"></a>00808             <span class="keywordflow">if</span>(myfrac&lt;0.5) { 
<a name="l00809"></a>00809                 mass += 0.25; 
<a name="l00810"></a>00810                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a> += 0.25;
<a name="l00811"></a>00811             }
<a name="l00812"></a>00812             <span class="keyword">const</span> <span class="keywordtype">int</span> OId = oldFlag&gt;&gt;24;
<a name="l00813"></a>00813             <span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> vel(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad0dc1680ff9a031cf632cbca05c72f25" title="precalculated objects speeds for current parametrization">mObjectSpeeds</a>[OId]);
<a name="l00814"></a>00814             ux=vel[0], uy=vel[1], uz=vel[2]; 
<a name="l00815"></a>00815             <span class="comment">//? usqr = 1.5 * (ux*ux + uy*uy + uz*uz);</span>
<a name="l00816"></a>00816             <span class="comment">//FORDF0 { RAC(tcel, l) = this-&gt;getCollideEq(l, fluidRho,ux,uy,uz); } rho = fluidRho;</span>
<a name="l00817"></a>00817             rho = <a class="code" href="../../d9/d2b/solver__main_8cpp.html#ac252fa61a2eb41af847cf06ea07e8bfd">REFERENCE_PRESSURE</a>;
<a name="l00818"></a>00818             <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, rho,ux,uy,uz); }
<a name="l00819"></a>00819             <span class="comment">//errMsg(&quot;INFLOW_DEBUG&quot;,&quot;if at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; v=&quot;&lt;&lt;vel&lt;&lt;&quot; rho=&quot;&lt;&lt;rho);</span>
<a name="l00820"></a>00820         }  <span class="keywordflow">else</span> { 
<a name="l00821"></a>00821             <span class="comment">// NEWSURFT, todo optimize!</span>
<a name="l00822"></a>00822             <span class="keywordflow">if</span>(onlyBndnb) { <span class="comment">//if(usqr&lt;0.001*0.001) {</span>
<a name="l00823"></a>00823                 rho = ux = uy = uz = 0.;
<a name="l00824"></a>00824                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a>{ 
<a name="l00825"></a>00825                     rho += m[l]; 
<a name="l00826"></a>00826                     ux  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]*m[l]); 
<a name="l00827"></a>00827                     uy  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]*m[l]);  
<a name="l00828"></a>00828                     uz  += (this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l]*m[l]);  
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830                 <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, rho,ux,uy,uz); }
<a name="l00831"></a>00831             } <span class="keywordflow">else</span> {<span class="comment">// NEWSURFT */</span>
<a name="l00832"></a>00832                 <span class="keywordflow">if</span>(usqr&gt;0.3*0.3) { 
<a name="l00833"></a>00833                     <span class="comment">// force reset! , warning causes distortions...</span>
<a name="l00834"></a>00834                     <a class="code" href="../../d1/d24/solver__class_8h.html#a93c07afda92f7e43d3b70438ef885eb5">FORDF0</a> { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel, l) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>(l, rho,0.,0.,0.); }
<a name="l00835"></a>00835                 } <span class="keywordflow">else</span> {
<a name="l00836"></a>00836                 <span class="comment">// normal collide</span>
<a name="l00837"></a>00837                 <span class="comment">// mass streaming done... do normal collide</span>
<a name="l00838"></a>00838                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> grav = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aee10f28f4bb002854da33f2d08053df1" title="gravity force for this level">gravity</a>*mass;
<a name="l00839"></a>00839                 <a class="code" href="../../d2/d75/solver__relax_8h.html#a1ae3840edf382b4dacbc6f5e1e614034">DEFAULT_COLLIDEG</a>(grav);
<a name="l00840"></a>00840                 <a class="code" href="../../dd/d41/loop__tools_8h.html#a404349d564604764a661cedbc0624798">PERFORM_USQRMAXCHECK</a>; }
<a name="l00841"></a>00841                 <span class="comment">// rho init from default collide necessary for fill/empty check below</span>
<a name="l00842"></a>00842             } <span class="comment">// test</span>
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         <span class="comment">// testing..., particle generation</span>
<a name="l00846"></a>00846         <span class="comment">// also check oldFlag for CFNoNbFluid, test</span>
<a name="l00847"></a>00847         <span class="comment">// for inflow no pargen test // NOBUBBB!</span>
<a name="l00848"></a>00848         <span class="keywordflow">if</span>((<a class="code" href="../../db/dff/classLbmSolverInterface.html#a0cb712be00a6c0fe651a2798abe4ab88">mInitDone</a>) 
<a name="l00849"></a>00849                 <span class="comment">// dont allow new if cells, or submerged ones</span>
<a name="l00850"></a>00850                 &amp;&amp; (!((oldFlag|newFlag)&amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>) )) 
<a name="l00851"></a>00851                 <span class="comment">// dont try to subtract from empty cells</span>
<a name="l00852"></a>00852                 &amp;&amp; (mass&gt;0.) &amp;&amp; (<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6358cc8e1b4774a3f353c281363588f8" title="particle generation probability">mPartGenProb</a>&gt;0.0)) {
<a name="l00853"></a>00853             <span class="keywordtype">bool</span> doAdd = <span class="keyword">true</span>;
<a name="l00854"></a>00854             <span class="keywordtype">bool</span> bndOk=<span class="keyword">true</span>;
<a name="l00855"></a>00855             <span class="keywordflow">if</span>( (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;cutMin)||(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6c95b1f65877b7605046bb8f7ff19257">mSizex</a>-cutMin)||
<a name="l00856"></a>00856                     (j&lt;cutMin)||(j&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a5afdd08e7db9e06e186eeadf4abe918e">mSizey</a>-cutMin)||
<a name="l00857"></a>00857                     (k&lt;cutMin)||(k&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>-cutMin) ) { bndOk=<span class="keyword">false</span>; }
<a name="l00858"></a>00858             <span class="keywordflow">if</span>(!bndOk) doAdd=<span class="keyword">false</span>;
<a name="l00859"></a>00859             
<a name="l00860"></a>00860             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> prob = (rand()/(RAND_MAX+1.0));
<a name="l00861"></a>00861             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> basethresh = <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6358cc8e1b4774a3f353c281363588f8" title="particle generation probability">mPartGenProb</a>*lcsmqo*(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>+<a class="code" href="../../db/dff/classLbmSolverInterface.html#a5afdd08e7db9e06e186eeadf4abe918e">mSizey</a>+<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6c95b1f65877b7605046bb8f7ff19257">mSizex</a>)*0.5*0.333;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863             <span class="comment">// physical drop model</span>
<a name="l00864"></a>00864             <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a0e5f18391be45ce21aaa215fe24ebe09">mPartUsePhysModel</a>) {
<a name="l00865"></a>00865                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> realWorldFac = (<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a64d427112a6782a30a22116f381265ae" title="node size on this level in simulation units">simCellSize</a> / <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aaca9039d0c72020bbce09424438ef972" title="size of a single lbm step in time units on this level">timestep</a>);
<a name="l00866"></a>00866                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rux = (ux * realWorldFac);
<a name="l00867"></a>00867                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> ruy = (uy * realWorldFac);
<a name="l00868"></a>00868                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> ruz = (uz * realWorldFac);
<a name="l00869"></a>00869                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rl = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(rux,ruy,ruz));
<a name="l00870"></a>00870                 basethresh *= rl;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                 <span class="comment">// reduce probability in outer region?</span>
<a name="l00873"></a>00873                 <span class="keyword">const</span> <span class="keywordtype">int</span> pibord = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a7306ebbc57a4e2c200990ef22aa1e0a4" title="local storage of mSizes">lSizex</a>/2-cutConst;
<a name="l00874"></a>00874                 <span class="keyword">const</span> <span class="keywordtype">int</span> pjbord = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>/2-cutConst;
<a name="l00875"></a>00875                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> pifac = 1.-(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>-pibord)) / (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(pibord);
<a name="l00876"></a>00876                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> pjfac = 1.-(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(j-pjbord)) / (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(pjbord);
<a name="l00877"></a>00877                 <span class="keywordflow">if</span>(pifac&lt;0.) pifac=0.;
<a name="l00878"></a>00878                 <span class="keywordflow">if</span>(pjfac&lt;0.) pjfac=0.;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880                 <span class="comment">//if( (prob&lt; (basethresh*rl)) &amp;&amp; (lcsmqo&gt;0.0095) &amp;&amp; (rl&gt;RWVEL_THRESH) ) {</span>
<a name="l00881"></a>00881                 <span class="keywordflow">if</span>( (prob&lt; (basethresh*rl*pifac*pjfac)) &amp;&amp; (lcsmqo&gt;0.0095) &amp;&amp; (rl&gt;<a class="code" href="../../d9/d2b/solver__main_8cpp.html#a025d690618d648f4d51e496851517b97">RWVEL_THRESH</a>) ) {
<a name="l00882"></a>00882                     <span class="comment">// add</span>
<a name="l00883"></a>00883                 } <span class="keywordflow">else</span> {
<a name="l00884"></a>00884                     doAdd = <span class="keyword">false</span>; <span class="comment">// dont...</span>
<a name="l00885"></a>00885                 }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887                 <span class="comment">// &quot;wind&quot; disturbance</span>
<a name="l00888"></a>00888                 <span class="comment">// use realworld relative velocity here instead?</span>
<a name="l00889"></a>00889                 <span class="keywordflow">if</span>( (doAdd &amp;&amp; 
<a name="l00890"></a>00890                         ((rl&gt;<a class="code" href="../../d9/d2b/solver__main_8cpp.html#a98e16587de8db47d60a007f81926577a">RWVEL_WINDTHRESH</a>) &amp;&amp; (lcsmqo&lt;<a class="code" href="../../d9/d2b/solver__main_8cpp.html#aa4681d8630f315e649802ceedd36608f">P_LCSMQO</a>)) )<span class="comment">// normal checks</span>
<a name="l00891"></a>00891                         ||(k&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>-<a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad1d6d88cb01bd943c59ca06c78e1dfa7">SLOWDOWNREGION</a>)   ) {
<a name="l00892"></a>00892                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nuz = uz;
<a name="l00893"></a>00893                     <span class="keywordflow">if</span>(k&gt;<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>-<a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad1d6d88cb01bd943c59ca06c78e1dfa7">SLOWDOWNREGION</a>) {
<a name="l00894"></a>00894                         <span class="comment">// special case</span>
<a name="l00895"></a>00895                         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> zfac = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)( k-(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>-<a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad1d6d88cb01bd943c59ca06c78e1dfa7">SLOWDOWNREGION</a>) );
<a name="l00896"></a>00896                         zfac /= (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(<a class="code" href="../../d9/d2b/solver__main_8cpp.html#ad1d6d88cb01bd943c59ca06c78e1dfa7">SLOWDOWNREGION</a>);
<a name="l00897"></a>00897                         nuz += (1.0) * zfac; <span class="comment">// check max speed? OFF?</span>
<a name="l00898"></a>00898                         <span class="comment">//errMsg(&quot;TOPT&quot;,&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; zfac&quot;&lt;&lt;zfac);</span>
<a name="l00899"></a>00899                     } <span class="keywordflow">else</span> {
<a name="l00900"></a>00900                         <span class="comment">// normal probability</span>
<a name="l00901"></a>00901                         <span class="comment">//? LbmFloat fac = P_LCSMQO-lcsmqo;</span>
<a name="l00902"></a>00902                         <span class="comment">//? jdf *= fac;</span>
<a name="l00903"></a>00903                     }
<a name="l00904"></a>00904                     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l00905"></a>00905                         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jdf = 0.05 * (rand()/(RAND_MAX+1.0));
<a name="l00906"></a>00906                         <span class="comment">// TODO  use wind velocity?</span>
<a name="l00907"></a>00907                         <span class="keywordflow">if</span>(jdf&gt;0.025) {
<a name="l00908"></a>00908                         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a9a801fa87c9bf3472c399696366fe81c">add</a> =  this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a002d8d48f62d78a83487f8d356c33cd7">dfLength</a>[l]*(-ux*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a60d0590342236f7662405c849600f6fe">dfDvecX</a>[l]-uy*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a84d3dd485042513c646a2ad651a2c68c">dfDvecY</a>[l]-nuz*this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a99726a6439256ff33e2a6397e9de0ef9">dfDvecZ</a>[l])*jdf;
<a name="l00909"></a>00909                         <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) += <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a9a801fa87c9bf3472c399696366fe81c">add</a>; }
<a name="l00910"></a>00910                     }
<a name="l00911"></a>00911                     <span class="comment">//errMsg(&quot;TOPDOWNCORR&quot;,&quot; jdf:&quot;&lt;&lt;jdf&lt;&lt;&quot; rl&quot;&lt;&lt;rl&lt;&lt;&quot; vel &quot;&lt;&lt;norm(LbmVec(ux,uy,nuz))&lt;&lt;&quot; rwv&quot;&lt;&lt;norm(LbmVec(rux,ruy,ruz)) );</span>
<a name="l00912"></a>00912                 } <span class="comment">// wind disturbance</span>
<a name="l00913"></a>00913             } <span class="comment">// mPartUsePhysModel</span>
<a name="l00914"></a>00914             <span class="keywordflow">else</span> {
<a name="l00915"></a>00915                 <span class="comment">// empirical model</span>
<a name="l00916"></a>00916                 <span class="comment">//if((prob&lt;basethresh) &amp;&amp; (lcsmqo&gt;0.0095)) { // add</span>
<a name="l00917"></a>00917                 <span class="keywordflow">if</span>((prob&lt;basethresh) &amp;&amp; (lcsmqo&gt;0.012)) { <span class="comment">// add</span>
<a name="l00918"></a>00918                 } <span class="keywordflow">else</span> { doAdd = <span class="keyword">false</span>; }<span class="comment">// dont...</span>
<a name="l00919"></a>00919             } 
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 
<a name="l00922"></a>00922             <span class="comment">// remove noise</span>
<a name="l00923"></a>00923             <span class="keywordflow">if</span>(usqr&lt;0.0001) doAdd=<span class="keyword">false</span>;   <span class="comment">// TODO check!?</span>
<a name="l00924"></a>00924 
<a name="l00925"></a>00925             <span class="comment">// dont try to subtract from empty cells</span>
<a name="l00926"></a>00926             <span class="comment">// ensure cell has enough mass for new drop</span>
<a name="l00927"></a>00927             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> newPartsize = 1.0;
<a name="l00928"></a>00928             <span class="keywordflow">if</span>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a0e5f18391be45ce21aaa215fe24ebe09">mPartUsePhysModel</a>) {
<a name="l00929"></a>00929                 <span class="comment">// 1-10</span>
<a name="l00930"></a>00930                 newPartsize += 9.0* (rand()/(RAND_MAX+1.0));
<a name="l00931"></a>00931             } <span class="keywordflow">else</span> {
<a name="l00932"></a>00932                 <span class="comment">// 1-5, overall size has to be less than</span>
<a name="l00933"></a>00933                 <span class="comment">// .62 (ca. 0.5) to make drops significantly smaller </span>
<a name="l00934"></a>00934                 <span class="comment">// than a full cell!</span>
<a name="l00935"></a>00935                 newPartsize += 4.0* (rand()/(RAND_MAX+1.0));
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937             <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> dropmass = <a class="code" href="../../d5/d15/classParticleObject.html#aab9cc6e259f23d202bb762cf689c3bc0">ParticleObject::getMass</a>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a96b365a3ed6985783709033fc3ebeb18">mPartDropMassSub</a>*newPartsize); <span class="comment">//PARTMASS(mPartDropMassSub*newPartsize); // mass: 4/3 pi r^3 rho</span>
<a name="l00938"></a>00938             <span class="keywordflow">while</span>(dropmass&gt;mass) {
<a name="l00939"></a>00939                 newPartsize -= 0.2;
<a name="l00940"></a>00940                 dropmass = <a class="code" href="../../d5/d15/classParticleObject.html#aab9cc6e259f23d202bb762cf689c3bc0">ParticleObject::getMass</a>(<a class="code" href="../../db/dff/classLbmSolverInterface.html#a96b365a3ed6985783709033fc3ebeb18">mPartDropMassSub</a>*newPartsize);
<a name="l00941"></a>00941             }
<a name="l00942"></a>00942             <span class="keywordflow">if</span>(newPartsize&lt;=1.) doAdd=<span class="keyword">false</span>;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944             <span class="keywordflow">if</span>( (doAdd)  ) { <span class="comment">// init new particle</span>
<a name="l00945"></a>00945                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> s=0; s&lt;1; s++) { <span class="comment">// one part!</span>
<a name="l00946"></a>00946                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> posjitter = 0.05;
<a name="l00947"></a>00947                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> posjitteroffs = posjitter*-0.5;
<a name="l00948"></a>00948                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jpx = posjitteroffs+ posjitter* (rand()/(RAND_MAX+1.0));
<a name="l00949"></a>00949                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jpy = posjitteroffs+ posjitter* (rand()/(RAND_MAX+1.0));
<a name="l00950"></a>00950                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jpz = posjitteroffs+ posjitter* (rand()/(RAND_MAX+1.0));
<a name="l00951"></a>00951 
<a name="l00952"></a>00952                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jitterstr = 1.0;
<a name="l00953"></a>00953                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jitteroffs = jitterstr*-0.5;
<a name="l00954"></a>00954                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jx = jitteroffs+ jitterstr* (rand()/(RAND_MAX+1.0));
<a name="l00955"></a>00955                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jy = jitteroffs+ jitterstr* (rand()/(RAND_MAX+1.0));
<a name="l00956"></a>00956                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> jz = jitteroffs+ jitterstr* (rand()/(RAND_MAX+1.0));
<a name="l00957"></a>00957 
<a name="l00958"></a>00958                 <span class="comment">// average normal &amp; velocity </span>
<a name="l00959"></a>00959                 <span class="comment">// -&gt; mostly along velocity dir, many into surface</span>
<a name="l00960"></a>00960                 <span class="comment">// fluid velocity (not normalized!)</span>
<a name="l00961"></a>00961                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> flvelVel = <a class="code" href="../../d2/d3c/solver__interface_8h.html#abde65d221fe8c68b1ec7abebb43726f5">LbmVec</a>(ux,uy,uz);
<a name="l00962"></a>00962                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> flvelLen = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(flvelVel);
<a name="l00963"></a>00963                 <span class="comment">// surface normal</span>
<a name="l00964"></a>00964                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> normVel = <a class="code" href="../../d2/d3c/solver__interface_8h.html#abde65d221fe8c68b1ec7abebb43726f5">LbmVec</a>(surfaceNormal[0],surfaceNormal[1],surfaceNormal[2]);
<a name="l00965"></a>00965                 <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(normVel);
<a name="l00966"></a>00966                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> normScale = (0.01+flvelLen);
<a name="l00967"></a>00967                 <span class="comment">// jitter vector, 0.2 * flvel</span>
<a name="l00968"></a>00968                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> jittVel = <a class="code" href="../../d2/d3c/solver__interface_8h.html#abde65d221fe8c68b1ec7abebb43726f5">LbmVec</a>(jx,jy,jz)*(0.05+flvelLen)*0.1;
<a name="l00969"></a>00969                 <span class="comment">// weighten velocities</span>
<a name="l00970"></a>00970                 <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> flvelWeight = 0.9;
<a name="l00971"></a>00971                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> newpartVel = normVel*normScale*(1.-flvelWeight) + flvelVel*(flvelWeight) + jittVel; 
<a name="l00972"></a>00972 
<a name="l00973"></a>00973                 <span class="comment">// offset towards surface (hide popping)</span>
<a name="l00974"></a>00974                 jpx += -normVel[0]*0.4;
<a name="l00975"></a>00975                 jpy += -normVel[1]*0.4;
<a name="l00976"></a>00976                 jpz += -normVel[2]*0.4;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> srci=<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+0.5+jpx, srcj=j+0.5+jpy, srck=k+0.5+jpz;
<a name="l00979"></a>00979                 <span class="keywordtype">int</span> type=0;
<a name="l00980"></a>00980                 type = <a class="code" href="../../d0/d69/particletracer_8h.html#aa34c342137a60a8d1b9504cea2791919">PART_DROP</a>;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="preprocessor">#               if LBMDIM==2</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span>                newpartVel[2]=0.; srck=0.5;
<a name="l00984"></a>00984 <span class="preprocessor">#               endif // LBMDIM==2</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span>                <span class="comment">// subtract drop mass</span>
<a name="l00986"></a>00986                 mass -= dropmass;
<a name="l00987"></a>00987                 <span class="comment">// init new particle</span>
<a name="l00988"></a>00988                 {
<a name="l00989"></a>00989                     <a class="code" href="../../d5/d15/classParticleObject.html" title="A single particle.">ParticleObject</a> np( <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(srci,srcj,srck) );
<a name="l00990"></a>00990                     np.<a class="code" href="../../d5/d15/classParticleObject.html#ad3c2934de916bb194798f656f8e53e7b" title="set velocity">setVel</a>(newpartVel[0],newpartVel[1],newpartVel[2]);
<a name="l00991"></a>00991                     np.<a class="code" href="../../d5/d15/classParticleObject.html#ae71d7fecdc83a8c57aa384296cf8e658" title="set status (higher byte)">setStatus</a>(<a class="code" href="../../d0/d69/particletracer_8h.html#a1cfbfeb8d8bcbede78dd8ead8420b237">PART_IN</a>);
<a name="l00992"></a>00992                     np.<a class="code" href="../../d5/d15/classParticleObject.html#abc8af5d01d8df0cdac14d241784c7d5e" title="set type (lower byte)">setType</a>(type);
<a name="l00993"></a>00993                     <span class="comment">//if((s%3)==2) np.setType(PART_FLOAT);</span>
<a name="l00994"></a>00994                     np.<a class="code" href="../../d5/d15/classParticleObject.html#ad060ac475f1f772e5d08d97d76039ce9">setSize</a>(newPartsize);
<a name="l00995"></a>00995                     <span class="comment">//errMsg(&quot;NEWPART&quot;,&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot;   u=&quot;&lt;&lt;norm(LbmVec(ux,uy,uz)) &lt;&lt;&quot; add&quot;&lt;&lt;doAdd&lt;&lt;&quot; pvel=&quot;&lt;&lt;norm(newpartVel)&lt;&lt;&quot; size=&quot;&lt;&lt;newPartsize );</span>
<a name="l00996"></a>00996                     <span class="comment">//errMsg(&quot;NEWPT&quot;,&quot;u=&quot;&lt;&lt;newpartVel&lt;&lt;&quot; norm=&quot;&lt;&lt;normVel&lt;&lt;&quot; flvel=&quot;&lt;&lt;flvelVel&lt;&lt;&quot; jitt=&quot;&lt;&lt;jittVel );</span>
<a name="l00997"></a>00997                     <a class="code" href="../../dd/d41/loop__tools_8h.html#a8cd4cf8dcfc3556998144d3ad4ea88b3">FSGR_ADDPART</a>(np);
<a name="l00998"></a>00998                 } <span class="comment">// new part</span>
<a name="l00999"></a>00999             <span class="comment">//errMsg(&quot;PIT&quot;,&quot;NEW pit&quot;&lt;&lt;np.getId()&lt;&lt;&quot; pos:&quot;&lt;&lt; np.getPos()&lt;&lt;&quot; status:&quot;&lt;&lt;convertFlags2String(np.getFlags())&lt;&lt;&quot; vel:&quot;&lt;&lt; np.getVel()  );</span>
<a name="l01000"></a>01000                 } <span class="comment">// multiple parts</span>
<a name="l01001"></a>01001             } <span class="comment">// doAdd</span>
<a name="l01002"></a>01002         } <span class="comment">// */</span>
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         <span class="comment">// interface cell filled or emptied?</span>
<a name="l01006"></a>01006         iffilled = ifemptied = 0;
<a name="l01007"></a>01007         <span class="comment">// interface cells empty/full?, WARNING: to mark these cells, better do it at the end of reinitCellFlags</span>
<a name="l01008"></a>01008         <span class="comment">// interface cell if full?</span>
<a name="l01009"></a>01009         <span class="keywordflow">if</span>( (mass) &gt;= (rho * (1.0+<a class="code" href="../../d1/d24/solver__class_8h.html#aa35b84a0354fbc5fbb9cb6e8d1ddecdb">FSGR_MAGICNR</a>)) ) { iffilled = 1; }
<a name="l01010"></a>01010         <span class="comment">// interface cell if empty?</span>
<a name="l01011"></a>01011         <span class="keywordflow">if</span>( (mass) &lt;= (rho * (   -<a class="code" href="../../d1/d24/solver__class_8h.html#aa35b84a0354fbc5fbb9cb6e8d1ddecdb">FSGR_MAGICNR</a>)) ) { ifemptied = 1; }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013         <span class="keywordflow">if</span>(oldFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#abbcc2b1313cb2b55a0a0bfe2ba51499d">CFMbndOutflow</a>)) {
<a name="l01014"></a>01014             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ad4cc016bc016cfca6a6e43801c066f7e">mInitialMass</a> -= mass;
<a name="l01015"></a>01015             mass = myfrac = 0.0;
<a name="l01016"></a>01016             iffilled = 0; ifemptied = 1;
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="comment">// looks much nicer... LISTTRICK</span>
<a name="l01020"></a>01020 <span class="preprocessor">#       if FSGR_LISTTRICK==1</span>
<a name="l01021"></a>01021 <span class="preprocessor"></span>        <span class="comment">//if((oldFlag&amp;CFNoNbEmpty)&amp;&amp;(newFlag&amp;CFNoNbEmpty)) { TEST_IF_CHECK; }</span>
<a name="l01022"></a>01022         <span class="keywordflow">if</span>(newFlag&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>) { <span class="comment">// test NEW TEST</span>
<a name="l01023"></a>01023             <span class="keywordflow">if</span>(!iffilled) {
<a name="l01024"></a>01024                 <span class="comment">// remove cells independent from amount of change...</span>
<a name="l01025"></a>01025                 <span class="keywordflow">if</span>( (oldFlag &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>)&amp;&amp;(newFlag &amp; CFNoNbEmpty)&amp;&amp;
<a name="l01026"></a>01026                         ( (mass&gt;(rho*<a class="code" href="../../d1/d24/solver__class_8h.html#aeffae4c0d0b0c858bfc55d1ec29cd2d0">FSGR_LISTTTHRESHFULL</a>))  || ((nbored&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)==0)  )) { 
<a name="l01027"></a>01027                     <span class="comment">//if((nbored&amp;CFInter)==0){ errMsg(&quot;NBORED!CFINTER&quot;,&quot;filled &quot;&lt;&lt;PRINT_IJK); };</span>
<a name="l01028"></a>01028                     iffilled = 1; 
<a name="l01029"></a>01029                 } 
<a name="l01030"></a>01030             }
<a name="l01031"></a>01031             <span class="keywordflow">if</span>(!ifemptied) {
<a name="l01032"></a>01032                 <span class="keywordflow">if</span>( (oldFlag &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>)&amp;&amp;(newFlag &amp; CFNoNbFluid)&amp;&amp;
<a name="l01033"></a>01033                         ( (mass&lt;(rho*<a class="code" href="../../d1/d24/solver__class_8h.html#a2c4cba3ed30749d7c5d13e205b7f2f42">FSGR_LISTTTHRESHEMPTY</a>)) || ((nbored&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)==0)  )) { 
<a name="l01034"></a>01034                     <span class="comment">//if((nbored&amp;CFInter)==0){ errMsg(&quot;NBORED!CFINTER&quot;,&quot;emptied &quot;&lt;&lt;PRINT_IJK); };</span>
<a name="l01035"></a>01035                     ifemptied = 1; 
<a name="l01036"></a>01036                 } 
<a name="l01037"></a>01037             }
<a name="l01038"></a>01038         } <span class="comment">// nobndfluid only */</span>
<a name="l01039"></a>01039 <span class="preprocessor">#       endif</span>
<a name="l01040"></a>01040 <span class="preprocessor"></span>        <span class="comment">//iffilled = ifemptied = 0; // DEBUG!!!!!!!!!!!!!!!</span>
<a name="l01041"></a>01041         
<a name="l01042"></a>01042 
<a name="l01043"></a>01043         <span class="comment">// now that all dfs are known, handle last changes</span>
<a name="l01044"></a>01044         <span class="keywordflow">if</span>(iffilled) {
<a name="l01045"></a>01045             <a class="code" href="../../d0/df9/structLbmPoint.html">LbmPoint</a> filledp; filledp.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a>=0;
<a name="l01046"></a>01046             <span class="keywordflow">if</span>(!(newFlag&amp;CFNoBndFluid)) filledp.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a> |= 1;  <span class="comment">// NEWSURFT</span>
<a name="l01047"></a>01047             filledp.<a class="code" href="../../d0/df9/structLbmPoint.html#aabaaed0f34d022011b5ac3a255d1fd5d">x</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; filledp.<a class="code" href="../../d0/df9/structLbmPoint.html#a516f69ea1f2d509eac6d931df4d2a019">y</a> = j; filledp.<a class="code" href="../../d0/df9/structLbmPoint.html#a67c07375508ee8912bcae570493faca0">z</a> = k;
<a name="l01048"></a>01048             <a class="code" href="../../dd/d41/loop__tools_8h.html#a31e270d846d8197b8046a692b442eaa8">LIST_FULL</a>(filledp);
<a name="l01049"></a>01049             <span class="comment">//mNumFilledCells++; // DEBUG</span>
<a name="l01050"></a>01050             calcCellsFilled++;
<a name="l01051"></a>01051         }
<a name="l01052"></a>01052         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ifemptied) {
<a name="l01053"></a>01053             <a class="code" href="../../d0/df9/structLbmPoint.html">LbmPoint</a> emptyp; emptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a>=0;
<a name="l01054"></a>01054             <span class="keywordflow">if</span>(!(newFlag&amp;CFNoBndFluid)) emptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a> |= 1; <span class="comment">//  NEWSURFT</span>
<a name="l01055"></a>01055             emptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#aabaaed0f34d022011b5ac3a255d1fd5d">x</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>; emptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#a516f69ea1f2d509eac6d931df4d2a019">y</a> = j; emptyp.<a class="code" href="../../d0/df9/structLbmPoint.html#a67c07375508ee8912bcae570493faca0">z</a> = k;
<a name="l01056"></a>01056             <a class="code" href="../../dd/d41/loop__tools_8h.html#a8819f7f2955dee29e3b3029edf4f72c2">LIST_EMPTY</a>(emptyp);
<a name="l01057"></a>01057             <span class="comment">//mNumEmptiedCells++; // DEBUG</span>
<a name="l01058"></a>01058             calcCellsEmptied++;
<a name="l01059"></a>01059         } 
<a name="l01060"></a>01060         <span class="comment">// dont cutoff values -&gt; better cell conversions</span>
<a name="l01061"></a>01061         <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>)   = (mass/rho);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="comment">// init new flux value</span>
<a name="l01064"></a>01064         <span class="keywordtype">float</span> flux = <a class="code" href="../../d1/d24/solver__class_8h.html#a604e06bc4a635aac711c4d0b29dfa1ef">FLUX_INIT</a>; <span class="comment">// dxqn on</span>
<a name="l01065"></a>01065         <span class="keywordflow">if</span>(newFlag&amp;CFNoBndFluid) {
<a name="l01066"></a>01066             <span class="comment">//flux = 50.0; // extreme on</span>
<a name="l01067"></a>01067             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> nn=1; nn&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; nn++) { 
<a name="l01068"></a>01068                 <span class="keywordflow">if</span>(nbflag[nn] &amp; (CFFluid|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)) { flux += this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a002d8d48f62d78a83487f8d356c33cd7">dfLength</a>[nn]; }
<a name="l01069"></a>01069             }
<a name="l01070"></a>01070             <span class="comment">// optical hack - smooth slow moving</span>
<a name="l01071"></a>01071             <span class="comment">// surface regions</span>
<a name="l01072"></a>01072             <span class="keywordflow">if</span>(usqr&lt; sssUsqrLimit) {
<a name="l01073"></a>01073             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> nn=1; nn&lt;this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a>; nn++) { 
<a name="l01074"></a>01074                 <span class="keywordflow">if</span>(nbfracs[nn]!=0.0) {
<a name="l01075"></a>01075                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> curSmooth = (sssUsqrLimit-usqr)*sssUsqrLimitInv;
<a name="l01076"></a>01076                     <span class="keywordflow">if</span>(curSmooth&gt;1.0) curSmooth=1.0;
<a name="l01077"></a>01077                     flux *= (1.0+ smoothStrength*curSmooth * (nbfracs[nn]-myfrac)) ;
<a name="l01078"></a>01078                 }
<a name="l01079"></a>01079             } }
<a name="l01080"></a>01080             <span class="comment">// NEW TEST */</span>
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082         <span class="comment">// flux = FLUX_INIT; // calc flux off</span>
<a name="l01083"></a>01083         <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), <a class="code" href="../../d2/d3c/solver__interface_8h.html#a510b7f66ad01b66603cc08e98ad3aa49">dFlux</a>) = flux; <span class="comment">// */</span>
<a name="l01084"></a>01084 
<a name="l01085"></a>01085         <span class="comment">// perform mass exchange with streamed values</span>
<a name="l01086"></a>01086         <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k,<a class="code" href="../../d2/d75/solver__relax_8h.html#a6d9615b3101a3ac7b60bb3bd118e6878">TSET</a>(lev), <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = mass; <span class="comment">// MASST</span>
<a name="l01087"></a>01087         <span class="comment">// set new flag </span>
<a name="l01088"></a>01088         *pFlagDst = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a>)newFlag;
<a name="l01089"></a>01089         calcCurrentMass += mass; 
<a name="l01090"></a>01090         calcCurrentVolume += <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         <span class="comment">// interface cell handling done...</span>
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="preprocessor">#if PARALLEL!=1</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span>    <a class="code" href="../../dd/d41/loop__tools_8h.html#aab84efab4fc0c92466e3c7a19fad0b04">GRID_LOOPREG_END</a>();
<a name="l01096"></a>01096 <span class="preprocessor">#else // PARALLEL==1</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dd/db6/paraloopend_8h.html">paraloopend.h</a>&quot;</span> <span class="comment">// = GRID_LOOPREG_END();</span>
<a name="l01098"></a>01098 <span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span>
<a name="l01100"></a>01100     <span class="comment">// write vars from computations to class</span>
<a name="l01101"></a>01101     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2fd0a63e02aeb6ca2b93e19040fbd07f" title="mass&amp;volume for this level">lmass</a>    = calcCurrentMass;
<a name="l01102"></a>01102     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#ad24148aecd9abb90cd0100eabb440703">lvolume</a>  = calcCurrentVolume;
<a name="l01103"></a>01103     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a43de085c6b09820fc804ec697debe940">mNumFilledCells</a>  = calcCellsFilled;
<a name="l01104"></a>01104     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a9579b2132c4b31c0a5e0121963fcf911">mNumEmptiedCells</a> = calcCellsEmptied;
<a name="l01105"></a>01105     <a class="code" href="../../db/dff/classLbmSolverInterface.html#a6adb68125fd0cbfbc67a110d57e2c713">mNumUsedCells</a> = calcNumUsedCells;
<a name="l01106"></a>01106 }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 
<a name="l01109"></a>01109 
<a name="l01110"></a>01110 <span class="keywordtype">void</span> 
<a name="l01111"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a36a3f631fced45a55f755188c312cdd5">01111</a> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a36a3f631fced45a55f755188c312cdd5">LbmFsgrSolver::preinitGrids</a>()
<a name="l01112"></a>01112 {
<a name="l01113"></a>01113     <span class="keyword">const</span> <span class="keywordtype">int</span> lev = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01114"></a>01114     <span class="keyword">const</span> <span class="keywordtype">bool</span> doReduce = <span class="keyword">false</span>;
<a name="l01115"></a>01115     <span class="keyword">const</span> <span class="keywordtype">int</span> gridLoopBound=0;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     <span class="comment">// preinit both grids</span>
<a name="l01118"></a>01118     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> s=0; s&lt;2; s++) {
<a name="l01119"></a>01119     
<a name="l01120"></a>01120         <a class="code" href="../../dd/d41/loop__tools_8h.html#aa667319c69798626cff44dc611349e7f">GRID_REGION_INIT</a>();
<a name="l01121"></a>01121 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l01122"></a>01122 <span class="preprocessor"></span><span class="preprocessor">#pragma omp parallel default(shared) \</span>
<a name="l01123"></a>01123 <span class="preprocessor">  reduction(+: \</span>
<a name="l01124"></a>01124 <span class="preprocessor">      calcCurrentMass,calcCurrentVolume, \</span>
<a name="l01125"></a>01125 <span class="preprocessor">        calcCellsFilled,calcCellsEmptied, \</span>
<a name="l01126"></a>01126 <span class="preprocessor">        calcNumUsedCells )</span>
<a name="l01127"></a>01127 <span class="preprocessor"></span><span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l01128"></a>01128 <span class="preprocessor"></span>        <a class="code" href="../../dd/d41/loop__tools_8h.html#aa89ccaa4075d3de7f57a2235ece72572">GRID_REGION_START</a>();
<a name="l01129"></a>01129         <a class="code" href="../../dd/d41/loop__tools_8h.html#a9fdcd30a3b8698c32e4ad09c722f635a">GRID_LOOP_START</a>();
<a name="l01130"></a>01130             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d2/d3c/solver__interface_8h.html#ab0601b2c1dfd0bf11c64c99be397ed7b">dTotalNum</a>; l++) { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l) = 0.; }
<a name="l01131"></a>01131             *pFlagSrc =0;
<a name="l01132"></a>01132             *pFlagDst =0;
<a name="l01133"></a>01133             <span class="comment">//errMsg(&quot;l1&quot;,&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; id&quot;&lt;&lt;id);</span>
<a name="l01134"></a>01134 <span class="preprocessor">#if PARALLEL!=1</span>
<a name="l01135"></a>01135 <span class="preprocessor"></span>        <a class="code" href="../../dd/d41/loop__tools_8h.html#aab84efab4fc0c92466e3c7a19fad0b04">GRID_LOOPREG_END</a>();
<a name="l01136"></a>01136 <span class="preprocessor">#else // PARALLEL==1</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dd/db6/paraloopend_8h.html">paraloopend.h</a>&quot;</span> <span class="comment">// = GRID_LOOPREG_END();</span>
<a name="l01138"></a>01138 <span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span>
<a name="l01140"></a>01140         <span class="comment">/* dummy, remove warnings */</span> 
<a name="l01141"></a>01141         calcCurrentMass = calcCurrentVolume = 0.;
<a name="l01142"></a>01142         calcCellsFilled = calcCellsEmptied = calcNumUsedCells = 0;
<a name="l01143"></a>01143         
<a name="l01144"></a>01144         <span class="comment">// change grid</span>
<a name="l01145"></a>01145         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a969dc4eebe3ff743980e099cad72240a" title="target/other set of dist funcs">setOther</a>   = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l01146"></a>01146         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>   ^= 1;
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="keywordtype">void</span> 
<a name="l01151"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2306f5833f95152547078bc46a6851de">01151</a> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2306f5833f95152547078bc46a6851de">LbmFsgrSolver::standingFluidPreinit</a>()
<a name="l01152"></a>01152 {
<a name="l01153"></a>01153     <span class="keyword">const</span> <span class="keywordtype">int</span> lev = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01154"></a>01154     <span class="keyword">const</span> <span class="keywordtype">bool</span> doReduce = <span class="keyword">false</span>;
<a name="l01155"></a>01155     <span class="keyword">const</span> <span class="keywordtype">int</span> gridLoopBound=1;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <a class="code" href="../../dd/d41/loop__tools_8h.html#aa667319c69798626cff44dc611349e7f">GRID_REGION_INIT</a>();
<a name="l01158"></a>01158 <span class="preprocessor">#if PARALLEL==1</span>
<a name="l01159"></a>01159 <span class="preprocessor"></span><span class="preprocessor">#pragma omp parallel default(shared) \</span>
<a name="l01160"></a>01160 <span class="preprocessor">  reduction(+: \</span>
<a name="l01161"></a>01161 <span class="preprocessor">      calcCurrentMass,calcCurrentVolume, \</span>
<a name="l01162"></a>01162 <span class="preprocessor">        calcCellsFilled,calcCellsEmptied, \</span>
<a name="l01163"></a>01163 <span class="preprocessor">        calcNumUsedCells )</span>
<a name="l01164"></a>01164 <span class="preprocessor"></span><span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l01165"></a>01165 <span class="preprocessor"></span>    <a class="code" href="../../dd/d41/loop__tools_8h.html#aa89ccaa4075d3de7f57a2235ece72572">GRID_REGION_START</a>();
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> rho, ux,uy,uz, usqr; 
<a name="l01168"></a>01168     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> nbflag[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01169"></a>01169     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> m[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01170"></a>01170     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqo;
<a name="l01171"></a>01171 <span class="preprocessor">#   if OPT3D==1 </span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>    <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> lcsmqadd, lcsmeq[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>], lcsmomega;
<a name="l01173"></a>01173     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> nbored=0;
<a name="l01174"></a>01174 <span class="preprocessor">#   endif // OPT3D==true </span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>
<a name="l01176"></a>01176     <a class="code" href="../../dd/d41/loop__tools_8h.html#a9fdcd30a3b8698c32e4ad09c722f635a">GRID_LOOP_START</a>();
<a name="l01177"></a>01177         <span class="comment">//errMsg(&quot;l1&quot;,&quot; at &quot;&lt;&lt;PRINT_IJK&lt;&lt;&quot; id&quot;&lt;&lt;id);</span>
<a name="l01178"></a>01178         <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> currFlag = *pFlagSrc; <span class="comment">//RFLAG(lev, i,j,k,workSet);</span>
<a name="l01179"></a>01179         <span class="keywordflow">if</span>( (currFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)) ) <span class="keywordflow">continue</span>;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181         <span class="keywordflow">if</span>( (currFlag &amp; (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) ) {
<a name="l01182"></a>01182             <span class="comment">// copy all values</span>
<a name="l01183"></a>01183             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="../../d2/d3c/solver__interface_8h.html#ab0601b2c1dfd0bf11c64c99be397ed7b">dTotalNum</a>;l++) { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }
<a name="l01184"></a>01184             <span class="keywordflow">continue</span>;
<a name="l01185"></a>01185         }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187         <span class="keywordflow">if</span>( (currFlag &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>)) {
<a name="l01188"></a>01188             <a class="code" href="../../d2/d75/solver__relax_8h.html#aca0e7264a23365d760325084f5f20962">OPTIMIZED_STREAMCOLLIDE</a>;
<a name="l01189"></a>01189         } <span class="keywordflow">else</span> {
<a name="l01190"></a>01190             <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01191"></a>01191                 nbflag[l] = <a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(lev, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,j,k, <a class="code" href="../../d2/d75/solver__relax_8h.html#a7eab7803391ea704d84e0db95689a8f6">SRCS</a>(lev),l);
<a name="l01192"></a>01192             } 
<a name="l01193"></a>01193             <a class="code" href="../../d2/d75/solver__relax_8h.html#a62aeeb02480e9713cb4c28ac56f625a8">DEFAULT_STREAM</a>;
<a name="l01194"></a>01194             <a class="code" href="../../d2/d75/solver__relax_8h.html#a1ae3840edf382b4dacbc6f5e1e614034">DEFAULT_COLLIDEG</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[lev].gravity);
<a name="l01195"></a>01195         }
<a name="l01196"></a>01196         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> l=<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>; l&lt;<a class="code" href="../../d2/d3c/solver__interface_8h.html#ab0601b2c1dfd0bf11c64c99be397ed7b">dTotalNum</a>;l++) { <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(tcel,l) = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>(ccel,l); }
<a name="l01197"></a>01197 <span class="preprocessor">#if PARALLEL!=1</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>    <a class="code" href="../../dd/d41/loop__tools_8h.html#aab84efab4fc0c92466e3c7a19fad0b04">GRID_LOOPREG_END</a>();
<a name="l01199"></a>01199 <span class="preprocessor">#else // PARALLEL==1</span>
<a name="l01200"></a>01200 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dd/db6/paraloopend_8h.html">paraloopend.h</a>&quot;</span> <span class="comment">// = GRID_LOOPREG_END();</span>
<a name="l01201"></a>01201 <span class="preprocessor">#endif // PARALLEL==1</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>
<a name="l01203"></a>01203     <span class="comment">/* dummy remove warnings */</span> 
<a name="l01204"></a>01204     calcCurrentMass = calcCurrentVolume = 0.;
<a name="l01205"></a>01205     calcCellsFilled = calcCellsEmptied = calcNumUsedCells = 0;
<a name="l01206"></a>01206     
<a name="l01207"></a>01207     <span class="comment">// change grid</span>
<a name="l01208"></a>01208   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a969dc4eebe3ff743980e099cad72240a" title="target/other set of dist funcs">setOther</a>   = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>;
<a name="l01209"></a>01209   <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2a319f3ae16856311222713e342184bf" title="current set of dist funcs">setCurr</a>   ^= 1;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="comment">/******************************************************************************</span>
<a name="l01214"></a>01214 <span class="comment"> * work on lists from updateCellMass to reinit cell flags</span>
<a name="l01215"></a>01215 <span class="comment"> *****************************************************************************/</span>
<a name="l01216"></a>01216 
<a name="l01217"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aef9a467e2f93178030e401d3c8c7b86a">01217</a> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aef9a467e2f93178030e401d3c8c7b86a" title="mass dist weights">LbmFsgrSolver::getMassdWeight</a>(<span class="keywordtype">bool</span> dirForw, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,<span class="keywordtype">int</span> j,<span class="keywordtype">int</span> k,<span class="keywordtype">int</span> workSet, <span class="keywordtype">int</span> l) {
<a name="l01218"></a>01218     <span class="comment">//return 0.0; // test</span>
<a name="l01219"></a>01219     <span class="keywordtype">int</span> level = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01220"></a>01220     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>     *ccel  = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(level, i,j,k, workSet);
<a name="l01221"></a>01221 
<a name="l01222"></a>01222     <span class="comment">// computenormal</span>
<a name="l01223"></a>01223     <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *cflag = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(level, i,j,k, workSet);
<a name="l01224"></a>01224     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> n[3];
<a name="l01225"></a>01225     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2bc2115887c69f0c23016e87c1ddc2de" title="compute surface normals: fluid, fluid more accurate, and for obstacles">computeFluidSurfaceNormal</a>(ccel,cflag, n);
<a name="l01226"></a>01226     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> scal = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a80a908d9f984a5888a67b806d7e648a1" title="normalized vectors for all neighboring cell directions (for e.g. massdweight calc)">mDvecNrm</a>[l][0]*n[0] + <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a80a908d9f984a5888a67b806d7e648a1" title="normalized vectors for all neighboring cell directions (for e.g. massdweight calc)">mDvecNrm</a>[l][1]*n[1] + <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a80a908d9f984a5888a67b806d7e648a1" title="normalized vectors for all neighboring cell directions (for e.g. massdweight calc)">mDvecNrm</a>[l][2]*n[2];
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> ret = 1.0;
<a name="l01229"></a>01229     <span class="comment">// forward direction, add mass (for filling cells):</span>
<a name="l01230"></a>01230     <span class="keywordflow">if</span>(dirForw) {
<a name="l01231"></a>01231         <span class="keywordflow">if</span>(scal&lt;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a0a6ff24e88963689483e35acbb53ca28">LBM_EPSILON</a>) ret = 0.0;
<a name="l01232"></a>01232         <span class="keywordflow">else</span> ret = scal;
<a name="l01233"></a>01233     } <span class="keywordflow">else</span> {
<a name="l01234"></a>01234         <span class="comment">// backward for emptying</span>
<a name="l01235"></a>01235         <span class="keywordflow">if</span>(scal&gt;-<a class="code" href="../../d2/d3c/solver__interface_8h.html#a0a6ff24e88963689483e35acbb53ca28">LBM_EPSILON</a>) ret = 0.0;
<a name="l01236"></a>01236         <span class="keywordflow">else</span> ret = scal * -1.0;
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238     <span class="comment">//errMsg(&quot;massd&quot;, PRINT_IJK&lt;&lt;&quot; nv&quot;&lt;&lt;nvel&lt;&lt;&quot; : ret=&quot;&lt;&lt;ret ); //xit(1); //VECDEB</span>
<a name="l01239"></a>01239     <span class="keywordflow">return</span> ret;
<a name="l01240"></a>01240 }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242 <span class="comment">// warning - normal compuations are without</span>
<a name="l01243"></a>01243 <span class="comment">//   boundary checks &amp;</span>
<a name="l01244"></a>01244 <span class="comment">//   normalization</span>
<a name="l01245"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2bc2115887c69f0c23016e87c1ddc2de">01245</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2bc2115887c69f0c23016e87c1ddc2de" title="compute surface normals: fluid, fluid more accurate, and for obstacles">LbmFsgrSolver::computeFluidSurfaceNormal</a>(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *ccel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *cflagpnt,<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *snret) {
<a name="l01246"></a>01246     <span class="keyword">const</span> <span class="keywordtype">int</span> level = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01247"></a>01247     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nx,ny,nz, nv1,nv2;
<a name="l01248"></a>01248     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagE = *(cflagpnt+1);
<a name="l01249"></a>01249     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagW = *(cflagpnt-1);
<a name="l01250"></a>01250     <span class="keywordflow">if</span>(flagE &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv1 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel+<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a> ),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01251"></a>01251     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagE &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01252"></a>01252     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01253"></a>01253     <span class="keywordflow">if</span>(flagW &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv2 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel-<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a> ),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01254"></a>01254     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagW &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01255"></a>01255     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01256"></a>01256     nx = 0.5* (nv2-nv1);
<a name="l01257"></a>01257 
<a name="l01258"></a>01258     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagN = *(cflagpnt+<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>);
<a name="l01259"></a>01259     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagS = *(cflagpnt-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>);
<a name="l01260"></a>01260     <span class="keywordflow">if</span>(flagN &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv1 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel+(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].lOffsx*<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>)),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01261"></a>01261     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagN &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01262"></a>01262     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01263"></a>01263     <span class="keywordflow">if</span>(flagS &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv2 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel-(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].lOffsx*<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>)),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01264"></a>01264     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagS &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01265"></a>01265     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01266"></a>01266     ny = 0.5* (nv2-nv1);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268 <span class="preprocessor">#if LBMDIM==3</span>
<a name="l01269"></a>01269 <span class="preprocessor"></span>    <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagT = *(cflagpnt+<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>);
<a name="l01270"></a>01270     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagB = *(cflagpnt-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>);
<a name="l01271"></a>01271     <span class="keywordflow">if</span>(flagT &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv1 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel+(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].lOffsy*<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>)),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01272"></a>01272     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagT &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01273"></a>01273     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01274"></a>01274     <span class="keywordflow">if</span>(flagB &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)){ nv2 = <a class="code" href="../../d1/d24/solver__class_8h.html#a392d8362c0d5aa69f1cfbd87109c7833">RAC</a>((ccel-(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].lOffsy*<a class="code" href="../../d1/d24/solver__class_8h.html#aacdd0e31b26c783f8a6248d4e1854974">QCELLSTEP</a>)),<a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>); } 
<a name="l01275"></a>01275     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(flagB &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01276"></a>01276     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01277"></a>01277     nz = 0.5* (nv2-nv1);
<a name="l01278"></a>01278 <span class="preprocessor">#else //LBMDIM==3</span>
<a name="l01279"></a>01279 <span class="preprocessor"></span>    nz = 0.0;
<a name="l01280"></a>01280 <span class="preprocessor">#endif //LBMDIM==3</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span>
<a name="l01282"></a>01282     <span class="comment">// return vals</span>
<a name="l01283"></a>01283     snret[0]=nx; snret[1]=ny; snret[2]=nz;
<a name="l01284"></a>01284 }
<a name="l01285"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a8c8089234c331a98be597c507fd4cf35">01285</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a8c8089234c331a98be597c507fd4cf35">LbmFsgrSolver::computeFluidSurfaceNormalAcc</a>(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *ccel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *cflagpnt, <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *snret) {
<a name="l01286"></a>01286     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nx=0.,ny=0.,nz=0.;
<a name="l01287"></a>01287     ccel = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; cflagpnt=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">// remove warning</span>
<a name="l01288"></a>01288     snret[0]=nx; snret[1]=ny; snret[2]=nz;
<a name="l01289"></a>01289 }
<a name="l01290"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a5f1eddb40c78005c16ae61680cc27fc7">01290</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a5f1eddb40c78005c16ae61680cc27fc7">LbmFsgrSolver::computeObstacleSurfaceNormal</a>(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *ccel, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *cflagpnt, <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *snret) {
<a name="l01291"></a>01291     <span class="keyword">const</span> <span class="keywordtype">int</span> level = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01292"></a>01292     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nx,ny,nz, nv1,nv2;
<a name="l01293"></a>01293     ccel = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">// remove warning</span>
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagE = *(cflagpnt+1);
<a name="l01296"></a>01296     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagW = *(cflagpnt-1);
<a name="l01297"></a>01297     <span class="keywordflow">if</span>(flagE &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01298"></a>01298     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01299"></a>01299     <span class="keywordflow">if</span>(flagW &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01300"></a>01300     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01301"></a>01301     nx = 0.5* (nv2-nv1);
<a name="l01302"></a>01302 
<a name="l01303"></a>01303     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagN = *(cflagpnt+<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>);
<a name="l01304"></a>01304     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagS = *(cflagpnt-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a0c1985355b137e52a8a5d4190a0f4c93">lOffsx</a>);
<a name="l01305"></a>01305     <span class="keywordflow">if</span>(flagN &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01306"></a>01306     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01307"></a>01307     <span class="keywordflow">if</span>(flagS &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01308"></a>01308     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01309"></a>01309     ny = 0.5* (nv2-nv1);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 <span class="preprocessor">#if LBMDIM==3</span>
<a name="l01312"></a>01312 <span class="preprocessor"></span>    <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagT = *(cflagpnt+<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>);
<a name="l01313"></a>01313     <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> flagB = *(cflagpnt-<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[level].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a1aa1abfdb211d7fca4ebc0623b2600b5">lOffsy</a>);
<a name="l01314"></a>01314     <span class="keywordflow">if</span>(flagT &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv1 = 1.; }
<a name="l01315"></a>01315     <span class="keywordflow">else</span> nv1 = 0.0;
<a name="l01316"></a>01316     <span class="keywordflow">if</span>(flagB &amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#aa223bf935d9fbd98aafae01a592ea0a4">CFBnd</a>)){ nv2 = 1.; }
<a name="l01317"></a>01317     <span class="keywordflow">else</span> nv2 = 0.0;
<a name="l01318"></a>01318     nz = 0.5* (nv2-nv1);
<a name="l01319"></a>01319 <span class="preprocessor">#else //LBMDIM==3</span>
<a name="l01320"></a>01320 <span class="preprocessor"></span>    nz = 0.0;
<a name="l01321"></a>01321 <span class="preprocessor">#endif //LBMDIM==3</span>
<a name="l01322"></a>01322 <span class="preprocessor"></span>
<a name="l01323"></a>01323     <span class="comment">// return vals</span>
<a name="l01324"></a>01324     snret[0]=nx; snret[1]=ny; snret[2]=nz;
<a name="l01325"></a>01325 }
<a name="l01326"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2fee97b68562a4028f43922b1d81161e">01326</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a2fee97b68562a4028f43922b1d81161e">LbmFsgrSolver::computeObstacleSurfaceNormalAcc</a>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>,<span class="keywordtype">int</span> j,<span class="keywordtype">int</span> k, <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> *snret) {
<a name="l01327"></a>01327     <span class="keywordtype">bool</span> nonorm = <span class="keyword">false</span>;
<a name="l01328"></a>01328     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nx=0.,ny=0.,nz=0.;
<a name="l01329"></a>01329     <span class="keywordflow">if</span>(i&lt;=0)        { nx =  1.; nonorm = <span class="keyword">true</span>; }
<a name="l01330"></a>01330     <span class="keywordflow">if</span>(i&gt;=<a class="code" href="../../db/dff/classLbmSolverInterface.html#a6c95b1f65877b7605046bb8f7ff19257">mSizex</a>-1) { nx = -1.; nonorm = <span class="keyword">true</span>; }
<a name="l01331"></a>01331     <span class="keywordflow">if</span>(j&lt;=0)        { ny =  1.; nonorm = <span class="keyword">true</span>; }
<a name="l01332"></a>01332     <span class="keywordflow">if</span>(j&gt;=<a class="code" href="../../db/dff/classLbmSolverInterface.html#a5afdd08e7db9e06e186eeadf4abe918e">mSizey</a>-1) { ny = -1.; nonorm = <span class="keyword">true</span>; }
<a name="l01333"></a>01333 <span class="preprocessor">#   if LBMDIM==3</span>
<a name="l01334"></a>01334 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(k&lt;=0)        { nz =  1.; nonorm = <span class="keyword">true</span>; }
<a name="l01335"></a>01335     <span class="keywordflow">if</span>(k&gt;=<a class="code" href="../../db/dff/classLbmSolverInterface.html#a60ade6ab109112eeb2fce766c258eb7e">mSizez</a>-1) { nz = -1.; nonorm = <span class="keyword">true</span>; }
<a name="l01336"></a>01336 <span class="preprocessor">#   endif // LBMDIM==3</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(!nonorm) {
<a name="l01338"></a>01338         <span class="comment">// in domain, revert to helper, use setCurr&amp;mMaxRefine</span>
<a name="l01339"></a>01339         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">LbmVec</a> bnormal;
<a name="l01340"></a>01340         <a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a> *bflag = &amp;<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>, i,j,k, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setCurr);
<a name="l01341"></a>01341         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>     *bcell = <a class="code" href="../../d1/d24/solver__class_8h.html#a8716918cb0374cf433217d8d3078aba5">RACPNT</a>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>, i,j,k, <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>].setCurr);
<a name="l01342"></a>01342         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a5f1eddb40c78005c16ae61680cc27fc7">computeObstacleSurfaceNormal</a>(bcell,bflag, &amp;bnormal[0]);
<a name="l01343"></a>01343         <span class="comment">// TODO check if there is a normal near here?</span>
<a name="l01344"></a>01344         <span class="comment">// use wider range otherwise...</span>
<a name="l01345"></a>01345         snret[0]=bnormal[0]; snret[1]=bnormal[0]; snret[2]=bnormal[0];
<a name="l01346"></a>01346         <span class="keywordflow">return</span>;
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348     snret[0]=nx; snret[1]=ny; snret[2]=nz;
<a name="l01349"></a>01349 }
<a name="l01350"></a>01350 
<a name="l01351"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253">01351</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">LbmFsgrSolver::addToNewInterList</a>( <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj, <span class="keywordtype">int</span> nk ) {
<a name="l01352"></a>01352 <span class="preprocessor">#if FSGR_STRICT_DEBUG==10</span>
<a name="l01353"></a>01353 <span class="preprocessor"></span>    <span class="comment">// dangerous, this can change the simulation...</span>
<a name="l01354"></a>01354   <span class="comment">/*for( vector&lt;LbmPoint&gt;::iterator iter=mListNewInter.begin();</span>
<a name="l01355"></a>01355 <span class="comment">       iter != mListNewInter.end(); iter++ ) {</span>
<a name="l01356"></a>01356 <span class="comment">    if(ni!=iter-&gt;x) continue;</span>
<a name="l01357"></a>01357 <span class="comment">    if(nj!=iter-&gt;y) continue;</span>
<a name="l01358"></a>01358 <span class="comment">    if(nk!=iter-&gt;z) continue;</span>
<a name="l01359"></a>01359 <span class="comment">        // all 3 values match... skip point</span>
<a name="l01360"></a>01360 <span class="comment">        return;</span>
<a name="l01361"></a>01361 <span class="comment">    } */</span>
<a name="l01362"></a>01362 <span class="preprocessor">#endif // FSGR_STRICT_DEBUG==1</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span>    <span class="comment">// store point</span>
<a name="l01364"></a>01364     <a class="code" href="../../d0/df9/structLbmPoint.html">LbmPoint</a> newinter; newinter.<a class="code" href="../../d0/df9/structLbmPoint.html#ac0fd124ebbeb8892310e6764874f68c5">flag</a> = 0;
<a name="l01365"></a>01365     newinter.<a class="code" href="../../d0/df9/structLbmPoint.html#aabaaed0f34d022011b5ac3a255d1fd5d">x</a> = ni; newinter.<a class="code" href="../../d0/df9/structLbmPoint.html#a516f69ea1f2d509eac6d931df4d2a019">y</a> = nj; newinter.<a class="code" href="../../d0/df9/structLbmPoint.html#a67c07375508ee8912bcae570493faca0">z</a> = nk;
<a name="l01366"></a>01366     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.push_back(newinter);
<a name="l01367"></a>01367 }
<a name="l01368"></a>01368 
<a name="l01369"></a><a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a59ea03776e39abe07bb7142307976b2c">01369</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a59ea03776e39abe07bb7142307976b2c" title="flag reinit step - always works on finest grid!">LbmFsgrSolver::reinitFlags</a>( <span class="keywordtype">int</span> workSet ) { 
<a name="l01370"></a>01370     <span class="comment">// reinitCellFlags OLD mods:</span>
<a name="l01371"></a>01371     <span class="comment">// add all to intel list?</span>
<a name="l01372"></a>01372     <span class="comment">// check ffrac for new cells</span>
<a name="l01373"></a>01373     <span class="comment">// new if cell inits (last loop)</span>
<a name="l01374"></a>01374     <span class="comment">// vweights handling</span>
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     <span class="keyword">const</span> <span class="keywordtype">int</span> debugFlagreinit = 0;
<a name="l01377"></a>01377     
<a name="l01378"></a>01378     <span class="comment">// some things need to be read/modified on the other set</span>
<a name="l01379"></a>01379     <span class="keywordtype">int</span> otherSet = (workSet^1);
<a name="l01380"></a>01380     <span class="comment">// fixed level on which to perform </span>
<a name="l01381"></a>01381     <span class="keywordtype">int</span> workLev = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a475ab55b6567ca5902bb1c78aa629c8d">mMaxRefine</a>;
<a name="l01382"></a>01382 
<a name="l01383"></a>01383   <span class="comment">/* modify interface cells from lists */</span>
<a name="l01384"></a>01384   <span class="comment">/* mark filled interface cells as fluid, or emptied as empty */</span>
<a name="l01385"></a>01385     <span class="comment">/* count neighbors and distribute excess mass to interface neighbor cells</span>
<a name="l01386"></a>01386 <span class="comment">   * problems arise when there are no interface neighbors anymore</span>
<a name="l01387"></a>01387 <span class="comment">     * then just distribute to any fluid neighbors...</span>
<a name="l01388"></a>01388 <span class="comment">     */</span>
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="comment">// for symmetry, first init all neighbor cells */</span>
<a name="l01391"></a>01391     <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.begin();
<a name="l01392"></a>01392        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.end(); iter++ ) {
<a name="l01393"></a>01393     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01394"></a>01394         <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;FULL&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; mss&quot;</span>&lt;&lt;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) &lt;&lt;<span class="stringliteral">&quot; rho&quot;</span>&lt;&lt; <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, 0) ); <span class="comment">// DEBUG SYMM</span>
<a name="l01395"></a>01395     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01396"></a>01396             <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01397"></a>01397             <span class="comment">//if((LBMDIM&gt;2)&amp;&amp;( (ni&lt;=0) || (nj&lt;=0) || (nk&lt;=0) || (ni&gt;=mLevel[workLev].lSizex-1) || (nj&gt;=mLevel[workLev].lSizey-1) || (nk&gt;=mLevel[workLev].lSizez-1) )) {</span>
<a name="l01398"></a>01398             <span class="keywordflow">if</span>( (ni&lt;=0) || (nj&lt;=0) || 
<a name="l01399"></a>01399                   (ni&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].lSizex-1) ||
<a name="l01400"></a>01400                   (nj&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].lSizey-1) 
<a name="l01401"></a>01401 #                   <span class="keywordflow">if</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==3
<a name="l01402"></a>01402                   || (nk&lt;=0) || (nk&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].lSizez-1) 
<a name="l01403"></a>01403 #                   endif <span class="comment">// LBMDIM==1</span>
<a name="l01404"></a>01404                  ) {
<a name="l01405"></a>01405                 <span class="keywordflow">continue</span>; } <span class="comment">// new bc, dont treat cells on boundary NEWBC</span>
<a name="l01406"></a>01406       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev, ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a> ){
<a name="l01407"></a>01407                 
<a name="l01408"></a>01408                 <span class="comment">// preinit speed, get from average surrounding cells</span>
<a name="l01409"></a>01409                 <span class="comment">// interpolate from non-workset to workset, sets are handled in function</span>
<a name="l01410"></a>01410 
<a name="l01411"></a>01411                 <span class="comment">// new and empty interface cell, dont change old flag here!</span>
<a name="l01412"></a>01412                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">addToNewInterList</a>(ni,nj,nk);
<a name="l01413"></a>01413 
<a name="l01414"></a>01414                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> avgrho = 0.0;
<a name="l01415"></a>01415                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> avgux = 0.0, avguy = 0.0, avguz = 0.0;
<a name="l01416"></a>01416                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a95e2dca112073efe75e5855afccf8dc1" title="interpolate velocity and density at a given position">interpolateCellValues</a>(workLev,ni,nj,nk,workSet, avgrho,avgux,avguy,avguz);
<a name="l01417"></a>01417 
<a name="l01418"></a>01418                 <span class="comment">// careful with l&#39;s...</span>
<a name="l01419"></a>01419                 <a class="code" href="../../d1/d24/solver__class_8h.html#a8f6a13f3b836fa45225af3e658713c93">FORDF0M</a> { 
<a name="l01420"></a>01420                     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, m) = this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a25c5045bdb65c365067fbe6ca53a35a5">getCollideEq</a>( m,avgrho,  avgux, avguy, avguz ); 
<a name="l01421"></a>01421                     <span class="comment">//QCELL(workLev,ni,nj,nk, workSet, l) = avgnbdf[l]; // CHECK FIXME test?</span>
<a name="l01422"></a>01422                 }
<a name="l01423"></a>01423                 <span class="comment">//errMsg(&quot;FNEW&quot;, PRINT_VEC(ni,nj,nk)&lt;&lt;&quot; mss&quot;&lt;&lt;QCELL(workLev, i,j,k, workSet, dMass) &lt;&lt;&quot; rho&quot;&lt;&lt;avgrho&lt;&lt;&quot; vel&quot;&lt;&lt;PRINT_VEC(avgux,avguy,avguz) ); // DEBUG SYMM</span>
<a name="l01424"></a>01424                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = 0.0; <span class="comment">//?? new</span>
<a name="l01425"></a>01425                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = 0.0; <span class="comment">//?? new</span>
<a name="l01426"></a>01426                 <span class="comment">//RFLAG(workLev,ni,nj,nk,workSet) = (CellFlagType)(CFInter|CFNoInterpolSrc);</span>
<a name="l01427"></a>01427                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,ni,nj,nk,workSet, (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#adce131aad1a8841dc1a68b7df4b1d828">CFNoInterpolSrc</a>));
<a name="l01428"></a>01428                 <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;NEWE&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; newif &quot;</span>&lt;&lt;<a class="code" href="../../de/df0/utilities_8h.html#aa1f5d23ceba93fcb09cf2c2258fb3ba5">PRINT_VEC</a>(ni,nj,nk)&lt;&lt;<span class="stringliteral">&quot; rho&quot;</span>&lt;&lt;avgrho&lt;&lt;<span class="stringliteral">&quot; vel(&quot;</span>&lt;&lt;avgux&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;avguy&lt;&lt;<span class="stringliteral">&quot;,&quot;</span>&lt;&lt;avguz&lt;&lt;<span class="stringliteral">&quot;) &quot;</span> );
<a name="l01429"></a>01429       }
<a name="l01430"></a>01430             <span class="comment">/* prevent surrounding interface cells from getting removed as empty cells </span>
<a name="l01431"></a>01431 <span class="comment">             * (also cells that are not newly inited) */</span>
<a name="l01432"></a>01432       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) {
<a name="l01433"></a>01433                 <span class="comment">//RFLAG(workLev,ni,nj,nk, workSet) = (CellFlagType)(RFLAG(workLev,ni,nj,nk, workSet) | CFNoDelete);</span>
<a name="l01434"></a>01434                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,ni,nj,nk, workSet, (<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) | <a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>));
<a name="l01435"></a>01435                 <span class="comment">// also add to list...</span>
<a name="l01436"></a>01436                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">addToNewInterList</a>(ni,nj,nk);
<a name="l01437"></a>01437             } <span class="comment">// NEW?</span>
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440         <span class="comment">// NEW? no extra loop...</span>
<a name="l01441"></a>01441         <span class="comment">//RFLAG(workLev,i,j,k, workSet) = CFFluid;</span>
<a name="l01442"></a>01442         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,i,j,k, workSet,<a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>);
<a name="l01443"></a>01443     }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="comment">/* remove empty interface cells that are not allowed to be removed anyway</span>
<a name="l01446"></a>01446 <span class="comment">     * this is important, otherwise the dreaded cell-type-flickering can occur! */</span>
<a name="l01447"></a>01447   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n=0; n&lt;(int)<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.size(); n++) {
<a name="l01448"></a>01448     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>[n].x, j=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>[n].y, k=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>[n].z;
<a name="l01449"></a>01449         <span class="keywordflow">if</span>((<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>)) == (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>)) {
<a name="l01450"></a>01450             <span class="comment">// treat as &quot;new inter&quot;</span>
<a name="l01451"></a>01451             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">addToNewInterList</a>(i,j,k);
<a name="l01452"></a>01452             <span class="comment">// remove entry</span>
<a name="l01453"></a>01453             <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;EMPT REMOVED!!!&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; mss&quot;</span>&lt;&lt;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) &lt;&lt;<span class="stringliteral">&quot; rho&quot;</span>&lt;&lt; <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, 0) ); <span class="comment">// DEBUG SYMM</span>
<a name="l01454"></a>01454             <span class="keywordflow">if</span>(n&lt;(<span class="keywordtype">int</span>)<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.size()-1) <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>[n] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>[<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.size()-1]; 
<a name="l01455"></a>01455             <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.pop_back();
<a name="l01456"></a>01456             n--; 
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458     } 
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     <span class="comment">/* problems arise when adjacent cells empty&amp;fill -&gt;</span>
<a name="l01462"></a>01462 <span class="comment">         let fill cells+surrounding interface cells have the higher importance */</span>
<a name="l01463"></a>01463   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.begin();
<a name="l01464"></a>01464        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.end(); iter++ ) {
<a name="l01465"></a>01465     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01466"></a>01466         <span class="keywordflow">if</span>((<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet)&amp;(<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>)) == (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>|<a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>)){ <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;A&quot;</span>,<span class="stringliteral">&quot; ARGHARGRAG &quot;</span>); } <span class="comment">// DEBUG</span>
<a name="l01467"></a>01467         <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;EMPT&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; mss&quot;</span>&lt;&lt;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) &lt;&lt;<span class="stringliteral">&quot; rho&quot;</span>&lt;&lt; <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, 0) );
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         <span class="comment">/* set surrounding fluid cells to interface cells */</span>
<a name="l01470"></a>01470     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01471"></a>01471             <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01472"></a>01472       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>){
<a name="l01473"></a>01473                 <span class="comment">// init fluid-&gt;interface </span>
<a name="l01474"></a>01474                 <span class="comment">//RFLAG(workLev,ni,nj,nk, workSet) = (CellFlagType)(CFInter); </span>
<a name="l01475"></a>01475                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>); 
<a name="l01476"></a>01476                 <span class="comment">/* new mass = current density */</span>
<a name="l01477"></a>01477                 <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbrho = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a>);
<a name="l01478"></a>01478             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rl=1; rl&lt; this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aadafa560920abba91bd5b0ca1c0c5b8e" title="size of a single set of distribution functions">cDfNum</a> ; ++rl) { nbrho += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, rl); }
<a name="l01479"></a>01479                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) =  nbrho; 
<a name="l01480"></a>01480                 <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) =  1.0; 
<a name="l01481"></a>01481 
<a name="l01482"></a>01482                 <span class="comment">// store point</span>
<a name="l01483"></a>01483                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">addToNewInterList</a>(ni,nj,nk);
<a name="l01484"></a>01484       }
<a name="l01485"></a>01485       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>){
<a name="l01486"></a>01486                 <span class="comment">// test, also add to list...</span>
<a name="l01487"></a>01487                 <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a533455c4c8bde84cbd796d9b6b7d0253" title="add point to mListNewInter list">addToNewInterList</a>(ni,nj,nk);
<a name="l01488"></a>01488             } <span class="comment">// NEW?</span>
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491         <span class="comment">/* for symmetry, set our flag right now */</span>
<a name="l01492"></a>01492         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>);
<a name="l01493"></a>01493         <span class="comment">// mark cell not be changed mass... - not necessary, not in list anymore anyway!</span>
<a name="l01494"></a>01494     } <span class="comment">// emptylist</span>
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     
<a name="l01498"></a>01498     <span class="comment">// precompute weights to get rid of order dependancies</span>
<a name="l01499"></a>01499     vector&lt;lbmFloatSet&gt; vWeights;
<a name="l01500"></a>01500     vWeights.resize( <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.size() + <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.size() );
<a name="l01501"></a>01501     <span class="keywordtype">int</span> weightIndex = 0;
<a name="l01502"></a>01502   <span class="keywordtype">int</span> nbCount = 0;
<a name="l01503"></a>01503     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbWeights[<a class="code" href="../../d2/d3c/solver__interface_8h.html#a5b93395a4f54a13f465488eb134e010d">LBM_DFNUM</a>];
<a name="l01504"></a>01504     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbTotWeights = 0.0;
<a name="l01505"></a>01505     <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.begin();
<a name="l01506"></a>01506        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.end(); iter++ ) {
<a name="l01507"></a>01507     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01508"></a>01508     nbCount = 0; nbTotWeights = 0.0;
<a name="l01509"></a>01509     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01510"></a>01510             <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01511"></a>01511       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) {
<a name="l01512"></a>01512                 nbCount++;
<a name="l01513"></a>01513                 <span class="keywordflow">if</span>(iter-&gt;flag&amp;1) nbWeights[l] = 1.; <span class="comment">// NEWSURFT</span>
<a name="l01514"></a>01514                 <span class="keywordflow">else</span> nbWeights[l] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aef9a467e2f93178030e401d3c8c7b86a" title="mass dist weights">getMassdWeight</a>(1,i,j,k,workSet,l); <span class="comment">// NEWSURFT</span>
<a name="l01515"></a>01515                 nbTotWeights += nbWeights[l];
<a name="l01516"></a>01516       } <span class="keywordflow">else</span> {
<a name="l01517"></a>01517                 nbWeights[l] = -100.0; <span class="comment">// DEBUG;</span>
<a name="l01518"></a>01518             }
<a name="l01519"></a>01519     }
<a name="l01520"></a>01520         <span class="keywordflow">if</span>(nbCount&gt;0) { 
<a name="l01521"></a>01521             <span class="comment">//errMsg(&quot;FF  I&quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;weightIndex&lt;&lt;&quot; &quot;&lt;&lt;nbTotWeights);</span>
<a name="l01522"></a>01522         vWeights[weightIndex].val[0] = nbTotWeights;
<a name="l01523"></a>01523         <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { vWeights[weightIndex].val[l] = nbWeights[l]; }
<a name="l01524"></a>01524         vWeights[weightIndex].numNbs = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)nbCount;
<a name="l01525"></a>01525         } <span class="keywordflow">else</span> { 
<a name="l01526"></a>01526         vWeights[weightIndex].numNbs = 0.0;
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528         weightIndex++;
<a name="l01529"></a>01529     }
<a name="l01530"></a>01530   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.begin();
<a name="l01531"></a>01531        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.end(); iter++ ) {
<a name="l01532"></a>01532     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01533"></a>01533     nbCount = 0; nbTotWeights = 0.0;
<a name="l01534"></a>01534     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01535"></a>01535             <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01536"></a>01536       <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) {
<a name="l01537"></a>01537                 nbCount++;
<a name="l01538"></a>01538                 <span class="keywordflow">if</span>(iter-&gt;flag&amp;1) nbWeights[l] = 1.; <span class="comment">// NEWSURFT</span>
<a name="l01539"></a>01539                 <span class="keywordflow">else</span> nbWeights[l] = <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#aef9a467e2f93178030e401d3c8c7b86a" title="mass dist weights">getMassdWeight</a>(0,i,j,k,workSet,l); <span class="comment">// NEWSURFT</span>
<a name="l01540"></a>01540                 nbTotWeights += nbWeights[l];
<a name="l01541"></a>01541       } <span class="keywordflow">else</span> {
<a name="l01542"></a>01542                 nbWeights[l] = -100.0; <span class="comment">// DEBUG;</span>
<a name="l01543"></a>01543             }
<a name="l01544"></a>01544     }
<a name="l01545"></a>01545         <span class="keywordflow">if</span>(nbCount&gt;0) { 
<a name="l01546"></a>01546             <span class="comment">//errMsg(&quot;EE  I&quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;weightIndex&lt;&lt;&quot; &quot;&lt;&lt;nbTotWeights);</span>
<a name="l01547"></a>01547         vWeights[weightIndex].val[0] = nbTotWeights;
<a name="l01548"></a>01548         <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { vWeights[weightIndex].val[l] = nbWeights[l]; }
<a name="l01549"></a>01549         vWeights[weightIndex].numNbs = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)nbCount;
<a name="l01550"></a>01550         } <span class="keywordflow">else</span> { 
<a name="l01551"></a>01551         vWeights[weightIndex].numNbs = 0.0;
<a name="l01552"></a>01552         }
<a name="l01553"></a>01553         weightIndex++;
<a name="l01554"></a>01554     } 
<a name="l01555"></a>01555     weightIndex = 0;
<a name="l01556"></a>01556     
<a name="l01557"></a>01557 
<a name="l01558"></a>01558     <span class="comment">/* process full list entries, filled cells are done after this loop */</span>
<a name="l01559"></a>01559     <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.begin();
<a name="l01560"></a>01560        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.end(); iter++ ) {
<a name="l01561"></a>01561     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01562"></a>01562 
<a name="l01563"></a>01563         <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> myrho = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d1/d24/solver__class_8h.html#acc5ec578ced5d032234e83703b4b352a">dC</a>);
<a name="l01564"></a>01564     <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { myrho += <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, l); } <span class="comment">// QCELL.rho</span>
<a name="l01565"></a>01565 
<a name="l01566"></a>01566     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> massChange = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) - myrho;
<a name="l01567"></a>01567         <span class="keywordflow">if</span>(vWeights[weightIndex].numNbs&gt;0.0) {
<a name="l01568"></a>01568             <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbTotWeightsp = vWeights[weightIndex].val[0];
<a name="l01569"></a>01569             <span class="comment">//errMsg(&quot;FF  I&quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;weightIndex&lt;&lt;&quot; &quot;&lt;&lt;nbTotWeightsp);</span>
<a name="l01570"></a>01570             <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01571"></a>01571                 <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01572"></a>01572         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) {
<a name="l01573"></a>01573                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> change = -1.0;
<a name="l01574"></a>01574                     <span class="keywordflow">if</span>(nbTotWeightsp&gt;0.0) {
<a name="l01575"></a>01575                         <span class="comment">//change = massChange * ( nbWeights[l]/nbTotWeightsp );</span>
<a name="l01576"></a>01576                         change = massChange * ( vWeights[weightIndex].val[l]/nbTotWeightsp );
<a name="l01577"></a>01577                     } <span class="keywordflow">else</span> {
<a name="l01578"></a>01578                         change = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(massChange/vWeights[weightIndex].numNbs);
<a name="l01579"></a>01579                     }
<a name="l01580"></a>01580                     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) += change;
<a name="l01581"></a>01581                 }
<a name="l01582"></a>01582             }
<a name="l01583"></a>01583             massChange = 0.0;
<a name="l01584"></a>01584         } <span class="keywordflow">else</span> {
<a name="l01585"></a>01585             <span class="comment">// Problem! no interface neighbors</span>
<a name="l01586"></a>01586             <a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a> += massChange;
<a name="l01587"></a>01587             <span class="comment">//TTT mNumProblems++;</span>
<a name="l01588"></a>01588             <span class="comment">//errMsg(&quot; FULL PROBLEM &quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;mFixMass);</span>
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590         weightIndex++;
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="comment">// already done? RFLAG(workLev,i,j,k, workSet) = CFFluid;</span>
<a name="l01593"></a>01593     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = myrho; <span class="comment">// should be rho... but unused?</span>
<a name="l01594"></a>01594     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = 1.0; <span class="comment">// should be rho... but unused?</span>
<a name="l01595"></a>01595   } <span class="comment">// fulllist</span>
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     <span class="comment">/* now, finally handle the empty cells - order is important, has to be after</span>
<a name="l01599"></a>01599 <span class="comment">     * full cell handling */</span>
<a name="l01600"></a>01600   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.begin();
<a name="l01601"></a>01601        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.end(); iter++ ) {
<a name="l01602"></a>01602     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> massChange = <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>);
<a name="l01605"></a>01605         <span class="keywordflow">if</span>(vWeights[weightIndex].numNbs&gt;0.0) {
<a name="l01606"></a>01606             <span class="keyword">const</span> <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> nbTotWeightsp = vWeights[weightIndex].val[0];
<a name="l01607"></a>01607             <span class="comment">//errMsg(&quot;EE  I&quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;weightIndex&lt;&lt;&quot; &quot;&lt;&lt;nbTotWeightsp);</span>
<a name="l01608"></a>01608             <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> {
<a name="l01609"></a>01609                 <span class="keywordtype">int</span> ni=i+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ab12c3dc91f1cd691160ee3951e1ae902">dfVecX</a>[l], nj=j+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7453528e7789d405e13cfb60551aa868">dfVecY</a>[l], nk=k+this-&gt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a530c88f9f44a5002ab6aa7ca4a81849f">dfVecZ</a>[l];
<a name="l01610"></a>01610         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,ni,nj,nk, workSet) &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>) {
<a name="l01611"></a>01611                     <a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a> change = -1.0;
<a name="l01612"></a>01612                     <span class="keywordflow">if</span>(nbTotWeightsp&gt;0.0) {
<a name="l01613"></a>01613                         change = massChange * ( vWeights[weightIndex].val[l]/nbTotWeightsp );
<a name="l01614"></a>01614                     } <span class="keywordflow">else</span> {
<a name="l01615"></a>01615                         change = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)(massChange/vWeights[weightIndex].numNbs);
<a name="l01616"></a>01616                     }
<a name="l01617"></a>01617                     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, ni,nj,nk, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) += change;
<a name="l01618"></a>01618                 }
<a name="l01619"></a>01619             }
<a name="l01620"></a>01620             massChange = 0.0;
<a name="l01621"></a>01621         } <span class="keywordflow">else</span> {
<a name="l01622"></a>01622             <span class="comment">// Problem! no interface neighbors</span>
<a name="l01623"></a>01623             <a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a> += massChange;
<a name="l01624"></a>01624             <span class="comment">//TTT mNumProblems++;</span>
<a name="l01625"></a>01625             <span class="comment">//errMsg(&quot; EMPT PROBLEM &quot;, PRINT_IJK&lt;&lt;&quot; &quot;&lt;&lt;mFixMass);</span>
<a name="l01626"></a>01626         }
<a name="l01627"></a>01627         weightIndex++;
<a name="l01628"></a>01628         
<a name="l01629"></a>01629         <span class="comment">// finally... make it empty </span>
<a name="l01630"></a>01630     <span class="comment">// already done? RFLAG(workLev,i,j,k, workSet) = CFEmpty;</span>
<a name="l01631"></a>01631     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) = 0.0;
<a name="l01632"></a>01632     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#a64b7025f17b762d336e621092066bd7b">dFfrac</a>) = 0.0;
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.begin();
<a name="l01635"></a>01635        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.end(); iter++ ) {
<a name="l01636"></a>01636     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01637"></a>01637     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a1b0d31e6800625d63b6bd0423216c4f4">changeFlag</a>(workLev,i,j,k, otherSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>);
<a name="l01638"></a>01638     } 
<a name="l01639"></a>01639 
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     <span class="comment">// check if some of the new interface cells can be removed again </span>
<a name="l01642"></a>01642     <span class="comment">// never happens !!! not necessary</span>
<a name="l01643"></a>01643     <span class="comment">// calculate ffrac for new IF cells NEW</span>
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="comment">// how many are really new interface cells?</span>
<a name="l01646"></a>01646     <span class="keywordtype">int</span> numNewIf = 0;
<a name="l01647"></a>01647   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.begin();
<a name="l01648"></a>01648        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.end(); iter++ ) {
<a name="l01649"></a>01649     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01650"></a>01650         <span class="keywordflow">if</span>(!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) { 
<a name="l01651"></a>01651             <span class="keywordflow">continue</span>; 
<a name="l01652"></a>01652             <span class="comment">// FIXME remove from list?</span>
<a name="l01653"></a>01653         }
<a name="l01654"></a>01654         numNewIf++;
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657     <span class="comment">// redistribute mass, reinit flags</span>
<a name="l01658"></a>01658     <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;NEWIF&quot;</span>, <span class="stringliteral">&quot;total:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.size());
<a name="l01659"></a>01659     <span class="keywordtype">float</span> newIfFac = 1.0/(<a class="code" href="../../d2/d3c/solver__interface_8h.html#af1e9e3e460c78fdb5e07e11cd7960a96">LbmFloat</a>)numNewIf;
<a name="l01660"></a>01660   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.begin();
<a name="l01661"></a>01661        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.end(); iter++ ) {
<a name="l01662"></a>01662     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01663"></a>01663         <span class="keywordflow">if</span>((i&lt;=0) || (j&lt;=0) || 
<a name="l01664"></a>01664              (i&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].lSizex-1) ||
<a name="l01665"></a>01665              (j&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#aa5460f8e9efb833143af49b400370fdb">lSizey</a>-1) ||
<a name="l01666"></a>01666              ((<a class="code" href="../../d2/d3c/solver__interface_8h.html#af50003ba6592bac88481fa0fbcb1f512">LBMDIM</a>==3) &amp;&amp; ((k&lt;=0) || (k&gt;=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a3fc2f0553686b535f6fd876e2906aa49">mLevel</a>[workLev].<a class="code" href="../../d9/d23/classFsgrLevelData.html#a2991956e53ba783f0c875bc177ce74da">lSizez</a>-1) ) )
<a name="l01667"></a>01667              ) {
<a name="l01668"></a>01668             <span class="keywordflow">continue</span>; } <span class="comment">// new bc, dont treat cells on boundary NEWBC</span>
<a name="l01669"></a>01669         <span class="keywordflow">if</span>(!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) { 
<a name="l01670"></a>01670             <span class="comment">//errMsg(&quot;???&quot;,&quot; &quot;&lt;&lt;PRINT_IJK);</span>
<a name="l01671"></a>01671             <span class="keywordflow">continue</span>; 
<a name="l01672"></a>01672         } <span class="comment">// */</span>
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev,i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) += (<a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a> * newIfFac);
<a name="l01675"></a>01675         
<a name="l01676"></a>01676         <span class="keywordtype">int</span> nbored = 0;
<a name="l01677"></a>01677         <a class="code" href="../../d1/d24/solver__class_8h.html#a05299a1574e06e5aea3e901ff62ffd62">FORDF1</a> { nbored |= <a class="code" href="../../d1/d24/solver__class_8h.html#ab7241eb60f02ecd564250f80e7cd5f74">RFLAG_NB</a>(workLev, i,j,k, workSet,l); }
<a name="l01678"></a>01678         <span class="keywordflow">if</span>(!(nbored &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a52169459320fac69e44404feaa0a340e">CFBndNoslip</a>)) { <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet) |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a06a8f440b330072436f970902fedb653">CFNoBndFluid</a>; }
<a name="l01679"></a>01679         <span class="keywordflow">if</span>(!(nbored &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#a6b2692d470fe364a1d108e6264e3a842">CFFluid</a>))     { <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet) |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae4360cd40e495db2052638b5e37917f1">CFNoNbFluid</a>; }
<a name="l01680"></a>01680         <span class="keywordflow">if</span>(!(nbored &amp; <a class="code" href="../../d2/d3c/solver__interface_8h.html#aefab053b4a918a159ca2b4399e31ed45">CFEmpty</a>))     { <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet) |= <a class="code" href="../../d2/d3c/solver__interface_8h.html#a5ea9e718dc4beefcceab4d0b849e939c">CFNoNbEmpty</a>; }
<a name="l01681"></a>01681 
<a name="l01682"></a>01682         <span class="keywordflow">if</span>(!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, otherSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) {
<a name="l01683"></a>01683             <a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet) = (<a class="code" href="../../d2/d3c/solver__interface_8h.html#a94930675ea85a64cef414f52b22917ff">CellFlagType</a>)(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet) | <a class="code" href="../../d2/d3c/solver__interface_8h.html#af320996309a9786439306953c5e85340">CFNoDelete</a>);
<a name="l01684"></a>01684         }
<a name="l01685"></a>01685         <span class="keywordflow">if</span>(debugFlagreinit) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;NEWIF&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a0f456e0c862e871578fb308924863566">PRINT_IJK</a>&lt;&lt;<span class="stringliteral">&quot; mss&quot;</span>&lt;&lt;<a class="code" href="../../d1/d24/solver__class_8h.html#a3aeec4e6dbda7449abaa9eee19d86038">QCELL</a>(workLev, i,j,k, workSet, <a class="code" href="../../d2/d3c/solver__interface_8h.html#ae3af1df16ce777d054aa7c1798f5f634">dMass</a>) &lt;&lt;<span class="stringliteral">&quot; f&quot;</span>&lt;&lt; <a class="code" href="../../da/d9f/solver__interface_8cpp.html#a232a0b36030169b0250e3e21814fcb23" title="helper function to convert flag to string (for debuggin)">convertCellFlagType2String</a>(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet))&lt;&lt;<span class="stringliteral">&quot; wl&quot;</span>&lt;&lt;workLev );
<a name="l01686"></a>01686     }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688     <span class="comment">// reinit fill fraction</span>
<a name="l01689"></a>01689   <span class="keywordflow">for</span>( vector&lt;LbmPoint&gt;::iterator iter=<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.begin();
<a name="l01690"></a>01690        iter != <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.end(); iter++ ) {
<a name="l01691"></a>01691     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=iter-&gt;x, j=iter-&gt;y, k=iter-&gt;z;
<a name="l01692"></a>01692         <span class="keywordflow">if</span>(!(<a class="code" href="../../d1/d24/solver__class_8h.html#a571a0a03caf939a34bc8af115d2d4ba0">RFLAG</a>(workLev,i,j,k, workSet)&amp;<a class="code" href="../../d2/d3c/solver__interface_8h.html#a8029ef4adefaa697c111eddcd5793f99">CFInter</a>)) { <span class="keywordflow">continue</span>; }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694         <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a37576beb014a781b278623dc672231b5">initInterfaceVars</a>(workLev, i,j,k, workSet, <span class="keyword">false</span>); <span class="comment">//int level, int i,int j,int k,int workSet, bool initMass) {</span>
<a name="l01695"></a>01695         <span class="comment">//LbmFloat nrho = 0.0;</span>
<a name="l01696"></a>01696         <span class="comment">//FORDF0 { nrho += QCELL(workLev, i,j,k, workSet, l); }</span>
<a name="l01697"></a>01697     <span class="comment">//QCELL(workLev,i,j,k, workSet, dFfrac) = QCELL(workLev,i,j,k, workSet, dMass)/nrho;</span>
<a name="l01698"></a>01698     <span class="comment">//QCELL(workLev,i,j,k, workSet, dFlux) = FLUX_INIT;</span>
<a name="l01699"></a>01699     }
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <span class="keywordflow">if</span>(<a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.size()&gt;0){ 
<a name="l01702"></a>01702         <span class="comment">//errMsg(&quot;FixMassDisted&quot;,&quot; fm:&quot;&lt;&lt;mFixMass&lt;&lt;&quot; nif:&quot;&lt;&lt;mListNewInter.size() );</span>
<a name="l01703"></a>01703         <a class="code" href="../../db/dff/classLbmSolverInterface.html#afa0c481ee5455284658a997804363f92">mFixMass</a> = 0.0; 
<a name="l01704"></a>01704     }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706     <span class="comment">// empty lists for next step</span>
<a name="l01707"></a>01707     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a0d1655aeeea1fcf16ab8ffe565d964a4" title="list of the cells to make fluid at the end of the step">mListFull</a>.clear();
<a name="l01708"></a>01708     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#a7a025e0bbd9f5798f20ed9d302f362f9" title="list of the cells to empty at the end of the step">mListEmpty</a>.clear();
<a name="l01709"></a>01709     <a class="code" href="../../d0/d4d/classLbmFsgrSolver.html#ae2bed325877e149d9ad1063823cc4d80" title="list of new interface cells to init">mListNewInter</a>.clear();
<a name="l01710"></a>01710 } <span class="comment">// reinitFlags</span>
<a name="l01711"></a>01711 
<a name="l01712"></a>01712 
<a name="l01713"></a>01713 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:56 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
