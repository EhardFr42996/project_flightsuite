<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: MOD_cast.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">MOD_cast.c</div>  </div>
</div>
<div class="contents">
<a href="../../d9/d2b/MOD__cast_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software  Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2005 by the Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Daniel Dunbar</span>
<a name="l00022"></a>00022 <span class="comment"> *                 Ton Roosendaal,</span>
<a name="l00023"></a>00023 <span class="comment"> *                 Ben Batt,</span>
<a name="l00024"></a>00024 <span class="comment"> *                 Brecht Van Lommel,</span>
<a name="l00025"></a>00025 <span class="comment"> *                 Campbell Barton</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db3/BLI__string_8h.html">BLI_string.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d24/depsgraph__private_8h.html">depsgraph_private.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d63/MOD__util_8h.html">MOD_util.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#acad405562919addc6fda7d44b7f6fe03">00053</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#acad405562919addc6fda7d44b7f6fe03">initData</a>(<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md)
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) md;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a> = 0.5f;
<a name="l00058"></a>00058     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> = 0.0f;
<a name="l00059"></a>00059     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a> = 0.0f;
<a name="l00060"></a>00060     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a> = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a> | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a> | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>
<a name="l00061"></a>00061             | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#afdfee6c74fcf5b46ca547a10ecc417b5">MOD_CAST_SIZE_FROM_RADIUS</a>;
<a name="l00062"></a>00062     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a> = <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a101ac17d217b28aa10a4de4918099df8">MOD_CAST_TYPE_SPHERE</a>;
<a name="l00063"></a>00063     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00064"></a>00064     cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a65005feee1154b489f849ad1324f5f11">00068</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a65005feee1154b489f849ad1324f5f11">copyData</a>(<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *target)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) md;
<a name="l00071"></a>00071     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *tcmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) target;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a>;
<a name="l00074"></a>00074     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>;
<a name="l00075"></a>00075     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a>;
<a name="l00076"></a>00076     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a>;
<a name="l00077"></a>00077     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a>;
<a name="l00078"></a>00078     tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a> = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>;
<a name="l00079"></a>00079     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>, cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>, <span class="keyword">sizeof</span>(tcmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>));
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a5eee3667a19acb156dd9e004f7f7c9ee">00082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a5eee3667a19acb156dd9e004f7f7c9ee">isDisabled</a>(<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(useRenderParams))
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) md;
<a name="l00085"></a>00085     <span class="keywordtype">short</span> flag;
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     flag = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a> &amp; (<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a>|<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a>|<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="keywordflow">if</span> ((cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a> == 0.0f) || flag == 0) <span class="keywordflow">return</span> 1;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     <span class="keywordflow">return</span> 0;
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#aaaab84bec23bf66ef8cb8ae92947ce43">00094</a> <span class="keyword">static</span> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#aaaab84bec23bf66ef8cb8ae92947ce43">requiredDataMask</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob), <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md)
<a name="l00095"></a>00095 {
<a name="l00096"></a>00096     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *)md;
<a name="l00097"></a>00097     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> dataMask = 0;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="comment">/* ask for vertexgroups if we need them */</span>
<a name="l00100"></a>00100     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>[0]) dataMask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3e9147e0f8c7f6d5bc8afb9989edee12">CD_MASK_MDEFORMVERT</a>;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> dataMask;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#af70aed39cb1311ae3b168dc840e894c2">00105</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#af70aed39cb1311ae3b168dc840e894c2">foreachObjectLink</a>(
<a name="l00106"></a>00106                        <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,
<a name="l00107"></a>00107     <span class="keywordtype">void</span> (*walk)(<span class="keywordtype">void</span> *userData, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> **obpoin),
<a name="l00108"></a>00108            <span class="keywordtype">void</span> *userData)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) md;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     walk (userData, ob, &amp;cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>);
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 
<a name="l00115"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a3ea2a8e8d2062b8c73a47d4a4b4989d9">00115</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a3ea2a8e8d2062b8c73a47d4a4b4989d9">updateDepgraph</a>(<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../dc/df7/structDagForest.html">DagForest</a> *forest,
<a name="l00116"></a>00116                         <span class="keyword">struct</span> <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(scene),
<a name="l00117"></a>00117                         <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob),
<a name="l00118"></a>00118                         <a class="code" href="../../d5/d07/structDagNode.html">DagNode</a> *obNode)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a>*) md;
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>) {
<a name="l00123"></a>00123         <a class="code" href="../../d5/d07/structDagNode.html">DagNode</a> *curNode = <a class="code" href="../../d4/d24/depsgraph__private_8h.html#aedbf331f72cdcc89995322ae0567f1df">dag_get_node</a>(forest, cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         <a class="code" href="../../d4/d24/depsgraph__private_8h.html#aedb692691c3406661eae56c512685bb8">dag_add_relation</a>(forest, curNode, obNode, <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#aab7d56d2d4b14b85da29c700d3e4cd1c">DAG_RL_OB_DATA</a>,
<a name="l00126"></a>00126             <span class="stringliteral">&quot;Cast Modifier&quot;</span>);
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a2f492b283c9e8b0c3e910a88ed3e3695">00130</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a2f492b283c9e8b0c3e910a88ed3e3695">sphere_do</a>(
<a name="l00131"></a>00131                    <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l00132"></a>00132        <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <a class="code" href="../../de/de7/structObject.html">Object</a> *ctrl_ob = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, defgrp_index;
<a name="l00139"></a>00139     <span class="keywordtype">int</span> has_radius = 0;
<a name="l00140"></a>00140     <span class="keywordtype">short</span> flag, <a class="code" href="../../d5/d6c/structDerivedMesh.html#afe18e696881b0dbf56124b4b1c01b63c">type</a>;
<a name="l00141"></a>00141     <span class="keywordtype">float</span> fac, facm, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a> = 0.0f;
<a name="l00142"></a>00142     <span class="keywordtype">float</span> vec[3], center[3] = {0.0f, 0.0f, 0.0f};
<a name="l00143"></a>00143     <span class="keywordtype">float</span> mat[4][4], imat[4][4];
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     fac = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a>;
<a name="l00146"></a>00146     facm = 1.0f - fac;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     flag = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a>;
<a name="l00149"></a>00149     type = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a>; <span class="comment">/* projection type: sphere or cylinder */</span>
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (type == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#aefe091c45a1bbc813a2ab2e861135511">MOD_CAST_TYPE_CYLINDER</a>) 
<a name="l00152"></a>00152         flag &amp;= ~<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     ctrl_ob = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="comment">/* spherify&#39;s center is {0, 0, 0} (the ob&#39;s own center in its local</span>
<a name="l00157"></a>00157 <span class="comment">     * space), by default, but if the user defined a control object,</span>
<a name="l00158"></a>00158 <span class="comment">     * we use its location, transformed to ob&#39;s local space */</span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00160"></a>00160         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00161"></a>00161             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00162"></a>00162             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00163"></a>00163             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, mat);
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00167"></a>00167         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(center, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">/* now we check which options the user wants */</span>
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment">/* 1) (flag was checked in the &quot;if (ctrl_ob)&quot; block above) */</span>
<a name="l00173"></a>00173     <span class="comment">/* 2) cmd-&gt;radius &gt; 0.0f: only the vertices within this radius from</span>
<a name="l00174"></a>00174 <span class="comment">     * the center of the effect should be deformed */</span>
<a name="l00175"></a>00175     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> &gt; FLT_EPSILON) has_radius = 1;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">/* 3) if we were given a vertex group name,</span>
<a name="l00178"></a>00178 <span class="comment">     * only those vertices should be affected */</span>
<a name="l00179"></a>00179     <a class="code" href="../../d3/d54/MOD__util_8c.html#a89892701552bff87585a897291e1000e">modifier_get_vgroup</a>(ob, dm, cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>, &amp;dvert, &amp;defgrp_index);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#afdfee6c74fcf5b46ca547a10ecc417b5">MOD_CAST_SIZE_FROM_RADIUS</a>) {
<a name="l00182"></a>00182         len = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>;
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     <span class="keywordflow">else</span> {
<a name="l00185"></a>00185         len = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a>;
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (len &lt;= 0) {
<a name="l00189"></a>00189         <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00190"></a>00190             len += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(center, vertexCos[i]);
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         len /= numVerts;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         <span class="keywordflow">if</span> (len == 0.0f) len = 10.0f;
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="comment">/* ready to apply the effect, one vertex at a time;</span>
<a name="l00198"></a>00198 <span class="comment">     * tiny optimization: the code is separated (with parts repeated)</span>
<a name="l00199"></a>00199 <span class="comment">     * in two possible cases:</span>
<a name="l00200"></a>00200 <span class="comment">     * with or w/o a vgroup. With lots of if&#39;s in the code below,</span>
<a name="l00201"></a>00201 <span class="comment">     * further optimization&#39;s are possible, if needed */</span>
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (dvert) { <span class="comment">/* with a vgroup */</span>
<a name="l00203"></a>00203         <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv= dvert;
<a name="l00204"></a>00204         <span class="keywordtype">float</span> fac_orig = fac;
<a name="l00205"></a>00205         <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++, dv++) {
<a name="l00206"></a>00206             <span class="keywordtype">float</span> tmp_co[3];
<a name="l00207"></a>00207             <span class="keywordtype">float</span> weight;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_co, vertexCos[i]);
<a name="l00210"></a>00210             <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00211"></a>00211                 <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00212"></a>00212                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, tmp_co);
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214                 <span class="keywordflow">else</span> {
<a name="l00215"></a>00215                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(tmp_co, center);
<a name="l00216"></a>00216                 }
<a name="l00217"></a>00217             }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, tmp_co);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221             <span class="keywordflow">if</span> (type == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#aefe091c45a1bbc813a2ab2e861135511">MOD_CAST_TYPE_CYLINDER</a>)
<a name="l00222"></a>00222                 vec[2] = 0.0f;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224             <span class="keywordflow">if</span> (has_radius) {
<a name="l00225"></a>00225                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vec) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>) <span class="keywordflow">continue</span>;
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228             weight= <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dv, defgrp_index);
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (weight &lt;= 0.0f) <span class="keywordflow">continue</span>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231             fac = fac_orig * weight;
<a name="l00232"></a>00232             facm = 1.0f - fac;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a>)
<a name="l00237"></a>00237                 tmp_co[0] = fac*vec[0]*len + facm*tmp_co[0];
<a name="l00238"></a>00238             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a>)
<a name="l00239"></a>00239                 tmp_co[1] = fac*vec[1]*len + facm*tmp_co[1];
<a name="l00240"></a>00240             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>)
<a name="l00241"></a>00241                 tmp_co[2] = fac*vec[2]*len + facm*tmp_co[2];
<a name="l00242"></a>00242 
<a name="l00243"></a>00243             <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00244"></a>00244                 <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00245"></a>00245                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, tmp_co);
<a name="l00246"></a>00246                 }
<a name="l00247"></a>00247                 <span class="keywordflow">else</span> {
<a name="l00248"></a>00248                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tmp_co, center);
<a name="l00249"></a>00249                 }
<a name="l00250"></a>00250             }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[i], tmp_co);
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254         <span class="keywordflow">return</span>;
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="comment">/* no vgroup */</span>
<a name="l00258"></a>00258     <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00259"></a>00259         <span class="keywordtype">float</span> tmp_co[3];
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_co, vertexCos[i]);
<a name="l00262"></a>00262         <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00263"></a>00263             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00264"></a>00264                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, tmp_co);
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266             <span class="keywordflow">else</span> {
<a name="l00267"></a>00267                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(tmp_co, center);
<a name="l00268"></a>00268             }
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, tmp_co);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="keywordflow">if</span> (type == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#aefe091c45a1bbc813a2ab2e861135511">MOD_CAST_TYPE_CYLINDER</a>)
<a name="l00274"></a>00274             vec[2] = 0.0f;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (has_radius) {
<a name="l00277"></a>00277             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(vec) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>) <span class="keywordflow">continue</span>;
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a>)
<a name="l00283"></a>00283             tmp_co[0] = fac*vec[0]*len + facm*tmp_co[0];
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a>)
<a name="l00285"></a>00285             tmp_co[1] = fac*vec[1]*len + facm*tmp_co[1];
<a name="l00286"></a>00286         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>)
<a name="l00287"></a>00287             tmp_co[2] = fac*vec[2]*len + facm*tmp_co[2];
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00290"></a>00290             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00291"></a>00291                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, tmp_co);
<a name="l00292"></a>00292             }
<a name="l00293"></a>00293             <span class="keywordflow">else</span> {
<a name="l00294"></a>00294                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tmp_co, center);
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[i], tmp_co);
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#ab322c022bf617a6e931d326b9bb68a84">00302</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#ab322c022bf617a6e931d326b9bb68a84">cuboid_do</a>(
<a name="l00303"></a>00303                    <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l00304"></a>00304        <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00307"></a>00307     <a class="code" href="../../de/de7/structObject.html">Object</a> *ctrl_ob = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, defgrp_index;
<a name="l00310"></a>00310     <span class="keywordtype">int</span> has_radius = 0;
<a name="l00311"></a>00311     <span class="keywordtype">short</span> flag;
<a name="l00312"></a>00312     <span class="keywordtype">float</span> fac, facm;
<a name="l00313"></a>00313     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], bb[8][3];
<a name="l00314"></a>00314     <span class="keywordtype">float</span> center[3] = {0.0f, 0.0f, 0.0f};
<a name="l00315"></a>00315     <span class="keywordtype">float</span> mat[4][4], imat[4][4];
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     fac = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a5aa3d9bf8a07ae888efb13edb2f13cf4">fac</a>;
<a name="l00318"></a>00318     facm = 1.0f - fac;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     flag = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a774372441782790420fad3e5946d63c3">flag</a>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     ctrl_ob = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a67d664f0f10aa83491a8a1fa718da90a">object</a>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <span class="comment">/* now we check which options the user wants */</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="comment">/* 1) (flag was checked in the &quot;if (ctrl_ob)&quot; block above) */</span>
<a name="l00327"></a>00327     <span class="comment">/* 2) cmd-&gt;radius &gt; 0.0f: only the vertices within this radius from</span>
<a name="l00328"></a>00328 <span class="comment">     * the center of the effect should be deformed */</span>
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> &gt; FLT_EPSILON) has_radius = 1;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">/* 3) if we were given a vertex group name,</span>
<a name="l00332"></a>00332 <span class="comment">     * only those vertices should be affected */</span>
<a name="l00333"></a>00333     <a class="code" href="../../d3/d54/MOD__util_8c.html#a89892701552bff87585a897291e1000e">modifier_get_vgroup</a>(ob, dm, cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad9fc4eb2d91222be431ca47b99da3a32">defgrp_name</a>, &amp;dvert, &amp;defgrp_index);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00336"></a>00336         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00337"></a>00337             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00338"></a>00338             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00339"></a>00339             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, mat);
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00343"></a>00343         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(center, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ctrl_ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>[3]);
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="keywordflow">if</span> ((flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#afdfee6c74fcf5b46ca547a10ecc417b5">MOD_CAST_SIZE_FROM_RADIUS</a>) &amp;&amp; has_radius) {
<a name="l00347"></a>00347         <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l00348"></a>00348             min[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>;
<a name="l00349"></a>00349             max[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(flag &amp; MOD_CAST_SIZE_FROM_RADIUS) &amp;&amp; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a> &gt; 0) {
<a name="l00353"></a>00353         <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l00354"></a>00354             min[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a>;
<a name="l00355"></a>00355             max[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ac73d943de009d656c8afa9220e79f6ad">size</a>;
<a name="l00356"></a>00356         }
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <span class="keywordflow">else</span> {
<a name="l00359"></a>00359         <span class="comment">/* get bound box */</span>
<a name="l00360"></a>00360         <span class="comment">/* We can&#39;t use the object&#39;s bound box because other modifiers</span>
<a name="l00361"></a>00361 <span class="comment">         * may have changed the vertex data. */</span>
<a name="l00362"></a>00362         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="comment">/* Cast&#39;s center is the ob&#39;s own center in its local space,</span>
<a name="l00365"></a>00365 <span class="comment">         * by default, but if the user defined a control object, we use</span>
<a name="l00366"></a>00366 <span class="comment">         * its location, transformed to ob&#39;s local space. */</span>
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00368"></a>00368             <span class="keywordtype">float</span> vec[3];
<a name="l00369"></a>00369 
<a name="l00370"></a>00370             <span class="comment">/* let the center of the ctrl_ob be part of the bound box: */</span>
<a name="l00371"></a>00371             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(center, min, max);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373             <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00374"></a>00374                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, vertexCos[i], center);
<a name="l00375"></a>00375                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vec, min, max);
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378         <span class="keywordflow">else</span> {
<a name="l00379"></a>00379             <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00380"></a>00380                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vertexCos[i], min, max);
<a name="l00381"></a>00381             }
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <span class="comment">/* we want a symmetric bound box around the origin */</span>
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[0]) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(max[0])) max[0] = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[0]); 
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[1]) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(max[1])) max[1] = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[1]); 
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[2]) &gt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(max[2])) max[2] = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(min[2]);
<a name="l00388"></a>00388         min[0] = -max[0];
<a name="l00389"></a>00389         min[1] = -max[1];
<a name="l00390"></a>00390         min[2] = -max[2];
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     <span class="comment">/* building our custom bounding box */</span>
<a name="l00394"></a>00394     bb[0][0] = bb[2][0] = bb[4][0] = bb[6][0] = min[0];
<a name="l00395"></a>00395     bb[1][0] = bb[3][0] = bb[5][0] = bb[7][0] = max[0];
<a name="l00396"></a>00396     bb[0][1] = bb[1][1] = bb[4][1] = bb[5][1] = min[1];
<a name="l00397"></a>00397     bb[2][1] = bb[3][1] = bb[6][1] = bb[7][1] = max[1];
<a name="l00398"></a>00398     bb[0][2] = bb[1][2] = bb[2][2] = bb[3][2] = min[2];
<a name="l00399"></a>00399     bb[4][2] = bb[5][2] = bb[6][2] = bb[7][2] = max[2];
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">/* ready to apply the effect, one vertex at a time;</span>
<a name="l00402"></a>00402 <span class="comment">     * tiny optimization: the code is separated (with parts repeated)</span>
<a name="l00403"></a>00403 <span class="comment">     * in two possible cases:</span>
<a name="l00404"></a>00404 <span class="comment">     * with or w/o a vgroup. With lots of if&#39;s in the code below,</span>
<a name="l00405"></a>00405 <span class="comment">     * further optimization&#39;s are possible, if needed */</span>
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (dvert) { <span class="comment">/* with a vgroup */</span>
<a name="l00407"></a>00407         <span class="keywordtype">float</span> fac_orig = fac;
<a name="l00408"></a>00408         <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00409"></a>00409             <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00410"></a>00410             <span class="keywordtype">int</span> j, octant, coord;
<a name="l00411"></a>00411             <span class="keywordtype">float</span> d[3], dmax, apex[3], fbb;
<a name="l00412"></a>00412             <span class="keywordtype">float</span> tmp_co[3];
<a name="l00413"></a>00413 
<a name="l00414"></a>00414             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_co, vertexCos[i]);
<a name="l00415"></a>00415             <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00416"></a>00416                 <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00417"></a>00417                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, tmp_co);
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419                 <span class="keywordflow">else</span> {
<a name="l00420"></a>00420                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(tmp_co, center);
<a name="l00421"></a>00421                 }
<a name="l00422"></a>00422             }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424             <span class="keywordflow">if</span> (has_radius) {
<a name="l00425"></a>00425                 <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[0]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> ||
<a name="l00426"></a>00426                                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[1]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> ||
<a name="l00427"></a>00427                                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[2]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>) <span class="keywordflow">continue</span>;
<a name="l00428"></a>00428             }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430             <span class="keywordflow">for</span> (j = 0; j &lt; dvert[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; ++j) {
<a name="l00431"></a>00431                 <span class="keywordflow">if</span> (dvert[i].dw[j].def_nr == defgrp_index) {
<a name="l00432"></a>00432                     dw = &amp;dvert[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[j];
<a name="l00433"></a>00433                     <span class="keywordflow">break</span>;
<a name="l00434"></a>00434                 }
<a name="l00435"></a>00435             }
<a name="l00436"></a>00436             <span class="keywordflow">if</span> (!dw) <span class="keywordflow">continue</span>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438             fac = fac_orig * dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l00439"></a>00439             facm = 1.0f - fac;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441             <span class="comment">/* The algo used to project the vertices to their</span>
<a name="l00442"></a>00442 <span class="comment">             * bounding box (bb) is pretty simple:</span>
<a name="l00443"></a>00443 <span class="comment">             * for each vertex v:</span>
<a name="l00444"></a>00444 <span class="comment">             * 1) find in which octant v is in;</span>
<a name="l00445"></a>00445 <span class="comment">             * 2) find which outer &quot;wall&quot; of that octant is closer to v;</span>
<a name="l00446"></a>00446 <span class="comment">             * 3) calculate factor (var fbb) to project v to that wall;</span>
<a name="l00447"></a>00447 <span class="comment">             * 4) project. */</span>
<a name="l00448"></a>00448 
<a name="l00449"></a>00449             <span class="comment">/* find in which octant this vertex is in */</span>
<a name="l00450"></a>00450             octant = 0;
<a name="l00451"></a>00451             <span class="keywordflow">if</span> (tmp_co[0] &gt; 0.0f) octant += 1;
<a name="l00452"></a>00452             <span class="keywordflow">if</span> (tmp_co[1] &gt; 0.0f) octant += 2;
<a name="l00453"></a>00453             <span class="keywordflow">if</span> (tmp_co[2] &gt; 0.0f) octant += 4;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455             <span class="comment">/* apex is the bb&#39;s vertex at the chosen octant */</span>
<a name="l00456"></a>00456             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(apex, bb[octant]);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458             <span class="comment">/* find which bb plane is closest to this vertex ... */</span>
<a name="l00459"></a>00459             d[0] = tmp_co[0] / apex[0];
<a name="l00460"></a>00460             d[1] = tmp_co[1] / apex[1];
<a name="l00461"></a>00461             d[2] = tmp_co[2] / apex[2];
<a name="l00462"></a>00462 
<a name="l00463"></a>00463             <span class="comment">/* ... (the closest has the higher (closer to 1) d value) */</span>
<a name="l00464"></a>00464             dmax = d[0];
<a name="l00465"></a>00465             coord = 0;
<a name="l00466"></a>00466             <span class="keywordflow">if</span> (d[1] &gt; dmax) {
<a name="l00467"></a>00467                 dmax = d[1];
<a name="l00468"></a>00468                 coord = 1;
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470             <span class="keywordflow">if</span> (d[2] &gt; dmax) {
<a name="l00471"></a>00471                 <span class="comment">/* dmax = d[2]; */</span> <span class="comment">/* commented, we don&#39;t need it */</span>
<a name="l00472"></a>00472                 coord = 2;
<a name="l00473"></a>00473             }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475             <span class="comment">/* ok, now we know which coordinate of the vertex to use */</span>
<a name="l00476"></a>00476 
<a name="l00477"></a>00477             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[coord]) &lt; FLT_EPSILON) <span class="comment">/* avoid division by zero */</span>
<a name="l00478"></a>00478                 <span class="keywordflow">continue</span>;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480             <span class="comment">/* finally, this is the factor we wanted, to project the vertex</span>
<a name="l00481"></a>00481 <span class="comment">             * to its bounding box (bb) */</span>
<a name="l00482"></a>00482             fbb = apex[coord] / tmp_co[coord];
<a name="l00483"></a>00483 
<a name="l00484"></a>00484             <span class="comment">/* calculate the new vertex position */</span>
<a name="l00485"></a>00485             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a>)
<a name="l00486"></a>00486                 tmp_co[0] = facm * tmp_co[0] + fac * tmp_co[0] * fbb;
<a name="l00487"></a>00487             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a>)
<a name="l00488"></a>00488                 tmp_co[1] = facm * tmp_co[1] + fac * tmp_co[1] * fbb;
<a name="l00489"></a>00489             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>)
<a name="l00490"></a>00490                 tmp_co[2] = facm * tmp_co[2] + fac * tmp_co[2] * fbb;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492             <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00493"></a>00493                 <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00494"></a>00494                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, tmp_co);
<a name="l00495"></a>00495                 }
<a name="l00496"></a>00496                 <span class="keywordflow">else</span> {
<a name="l00497"></a>00497                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tmp_co, center);
<a name="l00498"></a>00498                 }
<a name="l00499"></a>00499             }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[i], tmp_co);
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503         <span class="keywordflow">return</span>;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <span class="comment">/* no vgroup (check previous case for comments about the code) */</span>
<a name="l00507"></a>00507     <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00508"></a>00508         <span class="keywordtype">int</span> octant, coord;
<a name="l00509"></a>00509         <span class="keywordtype">float</span> d[3], dmax, fbb, apex[3];
<a name="l00510"></a>00510         <span class="keywordtype">float</span> tmp_co[3];
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tmp_co, vertexCos[i]);
<a name="l00513"></a>00513         <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00514"></a>00514             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00515"></a>00515                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, tmp_co);
<a name="l00516"></a>00516             }
<a name="l00517"></a>00517             <span class="keywordflow">else</span> {
<a name="l00518"></a>00518                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(tmp_co, center);
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         <span class="keywordflow">if</span> (has_radius) {
<a name="l00523"></a>00523             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[0]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> ||
<a name="l00524"></a>00524                          <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[1]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a> ||
<a name="l00525"></a>00525                          <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[2]) &gt; cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#a00bab3a1c0742bdb577ce79edec5cfd4">radius</a>) <span class="keywordflow">continue</span>;
<a name="l00526"></a>00526         }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         octant = 0;
<a name="l00529"></a>00529         <span class="keywordflow">if</span> (tmp_co[0] &gt; 0.0f) octant += 1;
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (tmp_co[1] &gt; 0.0f) octant += 2;
<a name="l00531"></a>00531         <span class="keywordflow">if</span> (tmp_co[2] &gt; 0.0f) octant += 4;
<a name="l00532"></a>00532 
<a name="l00533"></a>00533         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(apex, bb[octant]);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         d[0] = tmp_co[0] / apex[0];
<a name="l00536"></a>00536         d[1] = tmp_co[1] / apex[1];
<a name="l00537"></a>00537         d[2] = tmp_co[2] / apex[2];
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         dmax = d[0];
<a name="l00540"></a>00540         coord = 0;
<a name="l00541"></a>00541         <span class="keywordflow">if</span> (d[1] &gt; dmax) {
<a name="l00542"></a>00542             dmax = d[1];
<a name="l00543"></a>00543             coord = 1;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545         <span class="keywordflow">if</span> (d[2] &gt; dmax) {
<a name="l00546"></a>00546             <span class="comment">/* dmax = d[2]; */</span> <span class="comment">/* commented, we don&#39;t need it */</span>
<a name="l00547"></a>00547             coord = 2;
<a name="l00548"></a>00548         }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(tmp_co[coord]) &lt; FLT_EPSILON)
<a name="l00551"></a>00551             <span class="keywordflow">continue</span>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         fbb = apex[coord] / tmp_co[coord];
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#ae0c7f01cadc2f59123b87e53c9370681">MOD_CAST_X</a>)
<a name="l00556"></a>00556             tmp_co[0] = facm * tmp_co[0] + fac * tmp_co[0] * fbb;
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a3fb7b70f664ea1a20376a9a663cff144">MOD_CAST_Y</a>)
<a name="l00558"></a>00558             tmp_co[1] = facm * tmp_co[1] + fac * tmp_co[1] * fbb;
<a name="l00559"></a>00559         <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a2a8ec2919e36b36dc878a65bc7c0eec4">MOD_CAST_Z</a>)
<a name="l00560"></a>00560             tmp_co[2] = facm * tmp_co[2] + fac * tmp_co[2] * fbb;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562         <span class="keywordflow">if</span> (ctrl_ob) {
<a name="l00563"></a>00563             <span class="keywordflow">if</span> (flag &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a70237c01557c7e18d54ea9b34c2ae30e">MOD_CAST_USE_OB_TRANSFORM</a>) {
<a name="l00564"></a>00564                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, tmp_co);
<a name="l00565"></a>00565             }
<a name="l00566"></a>00566             <span class="keywordflow">else</span> {
<a name="l00567"></a>00567                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(tmp_co, center);
<a name="l00568"></a>00568             }
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vertexCos[i], tmp_co);
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a6b431ded590b58dcfe12f16ce9782e01">00575</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a6b431ded590b58dcfe12f16ce9782e01">deformVerts</a>(<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,
<a name="l00576"></a>00576                         <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *derivedData,
<a name="l00577"></a>00577                         <span class="keywordtype">float</span> (*vertexCos)[3],
<a name="l00578"></a>00578                         <span class="keywordtype">int</span> numVerts,
<a name="l00579"></a>00579                         <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(useRenderParams),
<a name="l00580"></a>00580                         <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(isFinalCalc))
<a name="l00581"></a>00581 {
<a name="l00582"></a>00582     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00583"></a>00583     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *)md;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     dm = <a class="code" href="../../d3/d54/MOD__util_8c.html#a245fa4d8b75ad76da2ccc7f9dfc2551b">get_dm</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, derivedData, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#af96cb159776ead1af3e9da06c12e5c22">MOD_CAST_TYPE_CUBOID</a>) {
<a name="l00588"></a>00588         <a class="code" href="../../d9/d2b/MOD__cast_8c.html#ab322c022bf617a6e931d326b9bb68a84">cuboid_do</a>(cmd, ob, dm, vertexCos, numVerts);
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     <span class="keywordflow">else</span> { <span class="comment">/* MOD_CAST_TYPE_SPHERE or MOD_CAST_TYPE_CYLINDER */</span>
<a name="l00591"></a>00591         <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a2f492b283c9e8b0c3e910a88ed3e3695">sphere_do</a>(cmd, ob, dm, vertexCos, numVerts);
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (dm != derivedData)
<a name="l00595"></a>00595         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a><a class="code" href="../../d9/d2b/MOD__cast_8c.html#a714f5617bb6a9483e8711e0d5a6cc52f">00598</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a714f5617bb6a9483e8711e0d5a6cc52f">deformVertsEM</a>(
<a name="l00599"></a>00599                        <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">struct</span> <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *editData,
<a name="l00600"></a>00600        <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *derivedData, <span class="keywordtype">float</span> (*vertexCos)[3], <span class="keywordtype">int</span> numVerts)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d3/d54/MOD__util_8c.html#a245fa4d8b75ad76da2ccc7f9dfc2551b">get_dm</a>(ob, editData, derivedData, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00603"></a>00603     <a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *cmd = (<a class="code" href="../../d9/d22/structCastModifierData.html">CastModifierData</a> *)md;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (cmd-&gt;<a class="code" href="../../d9/d22/structCastModifierData.html#ad5453e6ff731550d99e394b01234ce8f">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#af96cb159776ead1af3e9da06c12e5c22">MOD_CAST_TYPE_CUBOID</a>) {
<a name="l00606"></a>00606         <a class="code" href="../../d9/d2b/MOD__cast_8c.html#ab322c022bf617a6e931d326b9bb68a84">cuboid_do</a>(cmd, ob, dm, vertexCos, numVerts);
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608     <span class="keywordflow">else</span> { <span class="comment">/* MOD_CAST_TYPE_SPHERE or MOD_CAST_TYPE_CYLINDER */</span>
<a name="l00609"></a>00609         <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a2f492b283c9e8b0c3e910a88ed3e3695">sphere_do</a>(cmd, ob, dm, vertexCos, numVerts);
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (dm != derivedData)
<a name="l00613"></a>00613         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l00614"></a>00614 }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="../../d1/d59/MOD__modifiertypes_8h.html#a36d3d3633d5c6cce575f9e7b16f2e568">00617</a> <a class="code" href="../../db/dc5/structModifierTypeInfo.html">ModifierTypeInfo</a> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a36d3d3633d5c6cce575f9e7b16f2e568">modifierType_Cast</a> = {
<a name="l00618"></a>00618     <span class="comment">/* name */</span>              <span class="stringliteral">&quot;Cast&quot;</span>,
<a name="l00619"></a>00619     <span class="comment">/* structName */</span>        <span class="stringliteral">&quot;CastModifierData&quot;</span>,
<a name="l00620"></a>00620     <span class="comment">/* structSize */</span>        <span class="keyword">sizeof</span>(<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a59b9f44979841637893f6bc147a88a96">CastModifierData</a>),
<a name="l00621"></a>00621     <span class="comment">/* type */</span>              <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#abd2410bb81ff1d02c80627595bfc66a7a6f49a6768bd29306ee172bd8126bf4fc">eModifierTypeType_OnlyDeform</a>,
<a name="l00622"></a>00622     <span class="comment">/* flags */</span>             <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a4c64dc2e6ccb9a3c602589c543ac0321a53a11fb0ddd77f14d66e8b7c0df54268">eModifierTypeFlag_AcceptsCVs</a>
<a name="l00623"></a>00623                             | <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a4c64dc2e6ccb9a3c602589c543ac0321a8805d824ff1947a7a3d1a0e493770809">eModifierTypeFlag_SupportsEditmode</a>,
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="comment">/* copyData */</span>          <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a65005feee1154b489f849ad1324f5f11">copyData</a>,
<a name="l00626"></a>00626     <span class="comment">/* deformVerts */</span>       <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a6b431ded590b58dcfe12f16ce9782e01">deformVerts</a>,
<a name="l00627"></a>00627     <span class="comment">/* deformMatrices */</span>    <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00628"></a>00628     <span class="comment">/* deformVertsEM */</span>     <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a714f5617bb6a9483e8711e0d5a6cc52f">deformVertsEM</a>,
<a name="l00629"></a>00629     <span class="comment">/* deformMatricesEM */</span>  <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00630"></a>00630     <span class="comment">/* applyModifier */</span>     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00631"></a>00631     <span class="comment">/* applyModifierEM */</span>   <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00632"></a>00632     <span class="comment">/* initData */</span>          <a class="code" href="../../d9/d2b/MOD__cast_8c.html#acad405562919addc6fda7d44b7f6fe03">initData</a>,
<a name="l00633"></a>00633     <span class="comment">/* requiredDataMask */</span>  <a class="code" href="../../d9/d2b/MOD__cast_8c.html#aaaab84bec23bf66ef8cb8ae92947ce43">requiredDataMask</a>,
<a name="l00634"></a>00634     <span class="comment">/* freeData */</span>          <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00635"></a>00635     <span class="comment">/* isDisabled */</span>        <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a5eee3667a19acb156dd9e004f7f7c9ee">isDisabled</a>,
<a name="l00636"></a>00636     <span class="comment">/* updateDepgraph */</span>    <a class="code" href="../../d9/d2b/MOD__cast_8c.html#a3ea2a8e8d2062b8c73a47d4a4b4989d9">updateDepgraph</a>,
<a name="l00637"></a>00637     <span class="comment">/* dependsOnTime */</span>     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00638"></a>00638     <span class="comment">/* dependsOnNormals */</span>  <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00639"></a>00639     <span class="comment">/* foreachObjectLink */</span> <a class="code" href="../../d9/d2b/MOD__cast_8c.html#af70aed39cb1311ae3b168dc840e894c2">foreachObjectLink</a>,
<a name="l00640"></a>00640     <span class="comment">/* foreachIDLink */</span>     <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00641"></a>00641     <span class="comment">/* foreachTexLink */</span>    <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00642"></a>00642 };
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:33 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
