<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: armature.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">armature.c</div>  </div>
</div>
<div class="contents">
<a href="../../d9/d2b/armature_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Full recode, Ton Roosendaal, Crete 2005</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd1/BLI__bpath_8h.html">BLI_bpath.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddb/DNA__anim__types_8h.html">DNA_anim_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d03/DNA__constraint__types_8h.html">DNA_constraint_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d2f/DNA__lattice__types_8h.html">DNA_lattice_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../db/db5/DNA__nla__types_8h.html">DNA_nla_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d51/BKE__animsys_8h.html">BKE_animsys.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddd/BKE__constraint_8h.html">BKE_constraint.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d95/BKE__idprop_8h.html">BKE_idprop.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8f/BKE__lattice_8h.html">BKE_lattice.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dd6/BIK__api_8h.html">BIK_api.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d6a/BKE__sketch_8h.html">BKE_sketch.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/* **************** Generic Functions, data level *************** */</span>
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="../../d9/d2b/armature_8c.html#a68dbc2b964c09985359f7153891a6ba9">00078</a> <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#acf696458d453d078804fc53ef82bb704">add_armature</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     arm = <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a> (&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;armature, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#ae4ba19f70b08895557ef00b489e7d255">ID_AR</a>, name);
<a name="l00083"></a>00083     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7c414a008b307fcd47b2441d93ae2213">deformflag</a> = <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00a5ed89fe6fa4c071ff20da36463151513">ARM_DEF_VGROUP</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00ab02e539bc235b4304295e2e0cbf76ba8">ARM_DEF_ENVELOPE</a>;
<a name="l00084"></a>00084     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> = <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837a08b76ffdd07189adcf78fe50f24d5f60">ARM_COL_CUSTOM</a>; <span class="comment">/* custom bone-group colors */</span>
<a name="l00085"></a>00085     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a> = 1;
<a name="l00086"></a>00086     <span class="keywordflow">return</span> arm;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="../../d9/d2b/armature_8c.html#a51a8490bd02d3ba0c949e6f417b980b6">00089</a> <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#a0c6c9c472b6b6bb51a784294b3688ae9">get_armature</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l00092"></a>00092         <span class="keywordflow">return</span> (<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00093"></a>00093     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="../../d9/d2b/armature_8c.html#a7fb975dd1247efdf726c113101ac5101">00096</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a197a7c908db86e9a921de33254085b2c">free_bonelist</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordflow">for</span> (bone = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bone; bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00101"></a>00101         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>) {
<a name="l00102"></a>00102             <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>);
<a name="l00103"></a>00103             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>);
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         <a class="code" href="../../da/d17/BKE__armature_8h.html#a197a7c908db86e9a921de33254085b2c">free_bonelist</a>(&amp;bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>);
<a name="l00106"></a>00106     }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(lb);
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a><a class="code" href="../../d9/d2b/armature_8c.html#a7ee6370bdd9ae3d901112e3324304795">00111</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a91bbc1938a5886744090ddb44bccc537">free_armature</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (arm) {
<a name="l00114"></a>00114         <a class="code" href="../../da/d17/BKE__armature_8h.html#a197a7c908db86e9a921de33254085b2c">free_bonelist</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">/* free editmode data */</span>
<a name="l00117"></a>00117         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>) {
<a name="l00118"></a>00118             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>);
<a name="l00121"></a>00121             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00122"></a>00122         }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         <span class="comment">/* free sketch */</span>
<a name="l00125"></a>00125         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a18e4e3bd147d59ebca30148176784b86">sketch</a>) {
<a name="l00126"></a>00126             <a class="code" href="../../de/d6a/BKE__sketch_8h.html#aea0149dae3f80e5f63280ad501c2a241">freeSketch</a>(arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a18e4e3bd147d59ebca30148176784b86">sketch</a>);
<a name="l00127"></a>00127             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a18e4e3bd147d59ebca30148176784b86">sketch</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="comment">/* free animation data */</span>
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a3da4410a3e26839cd1a675b0fe1f52d2">adt</a>) {
<a name="l00132"></a>00132             <a class="code" href="../../dc/d51/BKE__animsys_8h.html#a186ce67df8bf9873cc945eed480eaa49">BKE_free_animdata</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>);
<a name="l00133"></a>00133             arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a3da4410a3e26839cd1a675b0fe1f52d2">adt</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="../../d9/d2b/armature_8c.html#a548a02782e7ea44a2ebdbc544c170686">00138</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a7fa42bd978a57ce3ad47c00fa317b07b">make_local_armature</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main;
<a name="l00141"></a>00141     <span class="keywordtype">int</span> is_local = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, is_lib = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00142"></a>00142     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00145"></a>00145         <span class="keywordflow">return</span>;
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> == 1) {
<a name="l00147"></a>00147         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>);
<a name="l00148"></a>00148         <span class="keywordflow">return</span>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="keywordflow">for</span> (ob = bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(0, is_lib, is_local); ob = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00152"></a>00152         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> == arm) {
<a name="l00153"></a>00153             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>)
<a name="l00154"></a>00154                 is_lib = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00155"></a>00155             <span class="keywordflow">else</span>
<a name="l00156"></a>00156                 is_local = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00157"></a>00157         }
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00161"></a>00161         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>);
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib) {
<a name="l00164"></a>00164         <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm_new = <a class="code" href="../../da/d17/BKE__armature_8h.html#a7c245e42389c5059456c8102bc7b2ce0">copy_armature</a>(arm);
<a name="l00165"></a>00165         arm_new-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> = 0;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="comment">/* Remap paths of new ID using old library as base. */</span>
<a name="l00168"></a>00168         <a class="code" href="../../d8/db1/BKE__library_8h.html#a28231f1e4d5edb6c8498db449bda4528">BKE_id_lib_local_paths</a>(bmain, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>, &amp;arm_new-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">for</span> (ob = bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob; ob = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00171"></a>00171             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> == arm) {
<a name="l00172"></a>00172                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00173"></a>00173                     ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> = arm_new;
<a name="l00174"></a>00174                     arm_new-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00175"></a>00175                     arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00176"></a>00176                 }
<a name="l00177"></a>00177             }
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="../../d9/d2b/armature_8c.html#ace604151cf24647605242274351c506f">00182</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#ace604151cf24647605242274351c506f">copy_bonechildren</a>(<a class="code" href="../../de/de0/structBone.html">Bone</a>* newBone, <a class="code" href="../../de/de0/structBone.html">Bone</a>* oldBone, <a class="code" href="../../de/de0/structBone.html">Bone</a>* actBone, <a class="code" href="../../de/de0/structBone.html">Bone</a> **newActBone)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <a class="code" href="../../de/de0/structBone.html">Bone</a> *curBone, *newChildBone;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (oldBone == actBone)
<a name="l00187"></a>00187         *newActBone = newBone;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="keywordflow">if</span> (oldBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>)
<a name="l00190"></a>00190         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a> = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(oldBone-&gt;<a class="code" href="../../de/de0/structBone.html#aaba2ee560b6e3d1a41516ed6bff79fab">prop</a>);
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">/* Copy this bone&#39;s list */</span>
<a name="l00193"></a>00193     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;newBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>, &amp;oldBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="comment">/* For each child in the list, update it&#39;s children */</span>
<a name="l00196"></a>00196     newChildBone = newBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00197"></a>00197     <span class="keywordflow">for</span> (curBone = oldBone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00198"></a>00198         newChildBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a> = newBone;
<a name="l00199"></a>00199         <a class="code" href="../../d9/d2b/armature_8c.html#ace604151cf24647605242274351c506f">copy_bonechildren</a>(newChildBone, curBone, actBone, newActBone);
<a name="l00200"></a>00200         newChildBone = newChildBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>;
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="../../d9/d2b/armature_8c.html#a0b60da9e228de2977730c0f5bb6d9e8f">00204</a> <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#a7c245e42389c5059456c8102bc7b2ce0">copy_armature</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *newArm;
<a name="l00207"></a>00207     <a class="code" href="../../de/de0/structBone.html">Bone</a> *oldBone, *newBone;
<a name="l00208"></a>00208     <a class="code" href="../../de/de0/structBone.html">Bone</a> *newActBone= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     newArm = <a class="code" href="../../d8/db1/BKE__library_8h.html#a0c0c1987364874c73cda326eace31efd">copy_libblock</a>(&amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#aac2e7b42212dbab58684702ed9f0921a">id</a>);
<a name="l00211"></a>00211     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>, &amp;arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="comment">/* Duplicate the childrens&#39; lists*/</span>
<a name="l00214"></a>00214     newBone = newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00215"></a>00215     <span class="keywordflow">for</span> (oldBone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; oldBone; oldBone = oldBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00216"></a>00216         newBone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00217"></a>00217         <a class="code" href="../../d9/d2b/armature_8c.html#ace604151cf24647605242274351c506f">copy_bonechildren</a>(newBone, oldBone, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>, &amp;newActBone);
<a name="l00218"></a>00218         newBone = newBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a> = newActBone;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00224"></a>00224     newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00225"></a>00225     newArm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a18e4e3bd147d59ebca30148176784b86">sketch</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordflow">return</span> newArm;
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a><a class="code" href="../../d9/d2b/armature_8c.html#a2f392765291f0e37df3dd012ae217c98">00230</a> <span class="keyword">static</span> <a class="code" href="../../de/de0/structBone.html">Bone</a> *<a class="code" href="../../d9/d2b/armature_8c.html#a2f392765291f0e37df3dd012ae217c98">get_named_bone_bonechildren</a>(<a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232     <a class="code" href="../../de/de0/structBone.html">Bone</a> *curBone, *rbone;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="keywordflow">if</span> (!strcmp(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>, name))
<a name="l00235"></a>00235         <span class="keywordflow">return</span> bone;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <span class="keywordflow">for</span> (curBone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone = curBone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l00238"></a>00238         rbone = <a class="code" href="../../d9/d2b/armature_8c.html#a2f392765291f0e37df3dd012ae217c98">get_named_bone_bonechildren</a>(curBone, name);
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (rbone)
<a name="l00240"></a>00240             <span class="keywordflow">return</span> rbone;
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00244"></a>00244 }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="comment">/* Walk the list until the bone is found */</span>
<a name="l00248"></a><a class="code" href="../../d9/d2b/armature_8c.html#ac2e34ea1630dfca51756a3accccf58c3">00248</a> <a class="code" href="../../de/de0/structBone.html">Bone</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#aa555e0c2fb76b7edbcbd5fc8344b993a">get_named_bone</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *curBone;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (!arm)
<a name="l00253"></a>00253         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="keywordflow">for</span> (curBone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; curBone; curBone = curBone-&gt;next) {
<a name="l00256"></a>00256         bone = <a class="code" href="../../d9/d2b/armature_8c.html#a2f392765291f0e37df3dd012ae217c98">get_named_bone_bonechildren</a>(curBone, name);
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (bone)
<a name="l00258"></a>00258             <span class="keywordflow">return</span> bone;
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="keywordflow">return</span> bone;
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">/* Finds the best possible extension to the name on a particular axis. (For renaming, check for</span>
<a name="l00265"></a>00265 <span class="comment"> * unique names afterwards) strip_number: removes number extensions  (TODO: not used)</span>
<a name="l00266"></a>00266 <span class="comment"> * axis: the axis to name on</span>
<a name="l00267"></a>00267 <span class="comment"> * head/tail: the head/tail co-ordinate of the bone on the specified axis */</span>
<a name="l00268"></a><a class="code" href="../../d9/d2b/armature_8c.html#a8d501e711b1245a937f5b8aa0111f6af">00268</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#af721e7a6d7d58835277acef64651caa3">bone_autoside_name</a>(<span class="keywordtype">char</span> name[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>], <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(strip_number), <span class="keywordtype">short</span> axis, <span class="keywordtype">float</span> head, <span class="keywordtype">float</span> tail)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00271"></a>00271     <span class="keywordtype">char</span> basename[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00272"></a>00272     <span class="keywordtype">char</span> extension[5] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     len = <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(name);
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (len == 0)
<a name="l00276"></a>00276         <span class="keywordflow">return</span> 0;
<a name="l00277"></a>00277     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(basename, name, <span class="keyword">sizeof</span>(basename));
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="comment">/* Figure out extension to append:</span>
<a name="l00280"></a>00280 <span class="comment">     *  - The extension to append is based upon the axis that we are working on.</span>
<a name="l00281"></a>00281 <span class="comment">     *  - If head happens to be on 0, then we must consider the tail position as well to decide</span>
<a name="l00282"></a>00282 <span class="comment">     *    which side the bone is on</span>
<a name="l00283"></a>00283 <span class="comment">     *      -&gt; If tail is 0, then it&#39;s bone is considered to be on axis, so no extension should be added</span>
<a name="l00284"></a>00284 <span class="comment">     *      -&gt; Otherwise, extension is added from perspective of object based on which side tail goes to</span>
<a name="l00285"></a>00285 <span class="comment">     *  - If head is non-zero, extension is added from perspective of object based on side head is on</span>
<a name="l00286"></a>00286 <span class="comment">     */</span>
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (axis == 2) {
<a name="l00288"></a>00288         <span class="comment">/* z-axis - vertical (top/bottom) */</span>
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa35a6894bca38a8ffb558c2c22a1eee1">IS_EQ</a>(head, 0)) {
<a name="l00290"></a>00290             <span class="keywordflow">if</span> (tail &lt; 0)
<a name="l00291"></a>00291                 strcpy(extension, <span class="stringliteral">&quot;Bot&quot;</span>);
<a name="l00292"></a>00292             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tail &gt; 0)
<a name="l00293"></a>00293                 strcpy(extension, <span class="stringliteral">&quot;Top&quot;</span>);
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295         <span class="keywordflow">else</span> {
<a name="l00296"></a>00296             <span class="keywordflow">if</span> (head &lt; 0)
<a name="l00297"></a>00297                 strcpy(extension, <span class="stringliteral">&quot;Bot&quot;</span>);
<a name="l00298"></a>00298             <span class="keywordflow">else</span>
<a name="l00299"></a>00299                 strcpy(extension, <span class="stringliteral">&quot;Top&quot;</span>);
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (axis == 1) {
<a name="l00303"></a>00303         <span class="comment">/* y-axis - depth (front/back) */</span>
<a name="l00304"></a>00304         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa35a6894bca38a8ffb558c2c22a1eee1">IS_EQ</a>(head, 0)) {
<a name="l00305"></a>00305             <span class="keywordflow">if</span> (tail &lt; 0)
<a name="l00306"></a>00306                 strcpy(extension, <span class="stringliteral">&quot;Fr&quot;</span>);
<a name="l00307"></a>00307             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tail &gt; 0)
<a name="l00308"></a>00308                 strcpy(extension, <span class="stringliteral">&quot;Bk&quot;</span>);
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310         <span class="keywordflow">else</span> {
<a name="l00311"></a>00311             <span class="keywordflow">if</span> (head &lt; 0)
<a name="l00312"></a>00312                 strcpy(extension, <span class="stringliteral">&quot;Fr&quot;</span>);
<a name="l00313"></a>00313             <span class="keywordflow">else</span>
<a name="l00314"></a>00314                 strcpy(extension, <span class="stringliteral">&quot;Bk&quot;</span>);
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317     <span class="keywordflow">else</span> {
<a name="l00318"></a>00318         <span class="comment">/* x-axis - horizontal (left/right) */</span>
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa35a6894bca38a8ffb558c2c22a1eee1">IS_EQ</a>(head, 0)) {
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (tail &lt; 0)
<a name="l00321"></a>00321                 strcpy(extension, <span class="stringliteral">&quot;R&quot;</span>);
<a name="l00322"></a>00322             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tail &gt; 0)
<a name="l00323"></a>00323                 strcpy(extension, <span class="stringliteral">&quot;L&quot;</span>);
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325         <span class="keywordflow">else</span> {
<a name="l00326"></a>00326             <span class="keywordflow">if</span> (head &lt; 0)
<a name="l00327"></a>00327                 strcpy(extension, <span class="stringliteral">&quot;R&quot;</span>);
<a name="l00328"></a>00328             <span class="comment">/* XXX Shouldn&#39;t this be simple else, as for z and y axes? */</span>
<a name="l00329"></a>00329             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (head &gt; 0)
<a name="l00330"></a>00330                 strcpy(extension, <span class="stringliteral">&quot;L&quot;</span>);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="comment">/* Simple name truncation</span>
<a name="l00335"></a>00335 <span class="comment">     *  - truncate if there is an extension and it wouldn&#39;t be able to fit</span>
<a name="l00336"></a>00336 <span class="comment">     *  - otherwise, just append to end</span>
<a name="l00337"></a>00337 <span class="comment">     */</span>
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (extension[0]) {
<a name="l00339"></a>00339         <span class="keywordtype">int</span> change = 1;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">while</span> (change) { <span class="comment">/* remove extensions */</span>
<a name="l00342"></a>00342             change = 0;
<a name="l00343"></a>00343             <span class="keywordflow">if</span> (len &gt; 2 &amp;&amp; basename[len-2] == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00344"></a>00344                 <span class="keywordflow">if</span> (basename[len-1] == <span class="charliteral">&#39;L&#39;</span> || basename[len-1] == <span class="charliteral">&#39;R&#39;</span>) { <span class="comment">/* L R */</span>
<a name="l00345"></a>00345                     basename[len-2] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00346"></a>00346                     len -= 2;
<a name="l00347"></a>00347                     change = 1;
<a name="l00348"></a>00348                 }
<a name="l00349"></a>00349             }
<a name="l00350"></a>00350             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; 3 &amp;&amp; basename[len-3] == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00351"></a>00351                 <span class="keywordflow">if</span> ((basename[len-2] == <span class="charliteral">&#39;F&#39;</span> &amp;&amp; basename[len-1] == <span class="charliteral">&#39;r&#39;</span>) || <span class="comment">/* Fr */</span>
<a name="l00352"></a>00352                    (basename[len-2] == <span class="charliteral">&#39;B&#39;</span> &amp;&amp; basename[len-1] == <span class="charliteral">&#39;k&#39;</span>))   <span class="comment">/* Bk */</span>
<a name="l00353"></a>00353                 {
<a name="l00354"></a>00354                     basename[len-3] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00355"></a>00355                     len -= 3;
<a name="l00356"></a>00356                     change = 1;
<a name="l00357"></a>00357                 }
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; 4 &amp;&amp; basename[len-4] == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00360"></a>00360                 <span class="keywordflow">if</span> ((basename[len-3] == <span class="charliteral">&#39;T&#39;</span> &amp;&amp; basename[len-2] == <span class="charliteral">&#39;o&#39;</span> &amp;&amp; basename[len-1] == <span class="charliteral">&#39;p&#39;</span>) || <span class="comment">/* Top */</span>
<a name="l00361"></a>00361                    (basename[len-3] == <span class="charliteral">&#39;B&#39;</span> &amp;&amp; basename[len-2] == <span class="charliteral">&#39;o&#39;</span> &amp;&amp; basename[len-1] == <span class="charliteral">&#39;t&#39;</span>))   <span class="comment">/* Bot */</span>
<a name="l00362"></a>00362                 {
<a name="l00363"></a>00363                     basename[len-4] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00364"></a>00364                     len -= 4;
<a name="l00365"></a>00365                     change = 1;
<a name="l00366"></a>00366                 }
<a name="l00367"></a>00367             }
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370         <span class="keywordflow">if</span> ((MAXBONENAME - len) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(extension) + 1) { <span class="comment">/* add 1 for the &#39;.&#39; */</span>
<a name="l00371"></a>00371             strncpy(name, basename, len-<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(extension));
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(name, MAXBONENAME, <span class="stringliteral">&quot;%s.%s&quot;</span>, basename, extension);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         <span class="keywordflow">return</span> 1;
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">else</span>
<a name="l00380"></a>00380         <span class="keywordflow">return</span> 0;
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="comment">/* ************* B-Bone support ******************* */</span>
<a name="l00384"></a>00384 
<a name="l00385"></a><a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">00385</a> <span class="preprocessor">#define MAX_BBONE_SUBDIV    32</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span>
<a name="l00387"></a>00387 <span class="comment">/* data has MAX_BBONE_SUBDIV+1 interpolated points, will become desired amount with equal distances */</span>
<a name="l00388"></a><a class="code" href="../../d9/d2b/armature_8c.html#a3c046ddd6e2fa33352bf25dcee6f33c2">00388</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a3c046ddd6e2fa33352bf25dcee6f33c2">equalize_bezier</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> desired)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390     <span class="keywordtype">float</span> *fp, totdist, ddist, dist, fac1, fac2;
<a name="l00391"></a>00391     <span class="keywordtype">float</span> pdist[<a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>+1];
<a name="l00392"></a>00392     <span class="keywordtype">float</span> temp[<a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>+1][4];
<a name="l00393"></a>00393     <span class="keywordtype">int</span> a, nr;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     pdist[0] = 0.0f;
<a name="l00396"></a>00396     <span class="keywordflow">for</span> (a = 0, fp = data; a &lt; <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>; a++, fp += 4) {
<a name="l00397"></a>00397         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(temp[a], fp);
<a name="l00398"></a>00398         pdist[a+1] = pdist[a] + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(fp, fp+4);
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400     <span class="comment">/* do last point */</span>
<a name="l00401"></a>00401     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(temp[a], fp);
<a name="l00402"></a>00402     totdist = pdist[a];
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* go over distances and calculate new points */</span>
<a name="l00405"></a>00405     ddist = totdist/((float)desired);
<a name="l00406"></a>00406     nr = 1;
<a name="l00407"></a>00407     <span class="keywordflow">for</span> (a = 1, fp = data+4; a &lt; desired; a++, fp += 4) {
<a name="l00408"></a>00408         dist = ((float)a)*ddist;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="comment">/* we&#39;re looking for location (distance) &#39;dist&#39; in the array */</span>
<a name="l00411"></a>00411         <span class="keywordflow">while</span> ((dist &gt;= pdist[nr]) &amp;&amp; nr &lt; <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>)
<a name="l00412"></a>00412             nr++;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         fac1 = pdist[nr] - pdist[nr-1];
<a name="l00415"></a>00415         fac2 = pdist[nr] - dist;
<a name="l00416"></a>00416         fac1 = fac2 / fac1;
<a name="l00417"></a>00417         fac2 = 1.0f - fac1;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         fp[0] = fac1*temp[nr-1][0] + fac2*temp[nr][0];
<a name="l00420"></a>00420         fp[1] = fac1*temp[nr-1][1] + fac2*temp[nr][1];
<a name="l00421"></a>00421         fp[2] = fac1*temp[nr-1][2] + fac2*temp[nr][2];
<a name="l00422"></a>00422         fp[3] = fac1*temp[nr-1][3] + fac2*temp[nr][3];
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="comment">/* set last point, needed for orientation calculus */</span>
<a name="l00425"></a>00425     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad474b870b380ee0c83901e9199506078">copy_qt_qt</a>(fp, temp[MAX_BBONE_SUBDIV]);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">/* returns pointer to static array, filled with desired amount of bone-&gt;segments elements */</span>
<a name="l00429"></a>00429 <span class="comment">/* this calculation is done  within unit bone space */</span>
<a name="l00430"></a><a class="code" href="../../d9/d2b/armature_8c.html#afb7e40847fb470758472aac302bb28d4">00430</a> <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#aff2236f3e8532360b1b7b72f5336ef53">b_bone_spline_setup</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">int</span> rest)
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432     <span class="keyword">static</span> <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> bbone_array[<a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>];
<a name="l00433"></a>00433     <span class="keyword">static</span> <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> bbone_rest_array[<a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>];
<a name="l00434"></a>00434     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *result_array = (rest) ? bbone_rest_array : bbone_array;
<a name="l00435"></a>00435     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, *prev;
<a name="l00436"></a>00436     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l00437"></a>00437     <span class="keywordtype">float</span> h1[3], h2[3], scale[3], <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>, hlength1, hlength2, roll1 = 0.0f, roll2;
<a name="l00438"></a>00438     <span class="keywordtype">float</span> mat3[3][3], imat[4][4], posemat[4][4], scalemat[4][4], iscalemat[4][4];
<a name="l00439"></a>00439     <span class="keywordtype">float</span> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[<a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>+1][4], *fp;
<a name="l00440"></a>00440     <span class="keywordtype">int</span> a, doscale = 0;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     length = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (!rest) {
<a name="l00445"></a>00445         <span class="comment">/* check if we need to take non-uniform bone scaling into account */</span>
<a name="l00446"></a>00446         scale[0] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0]);
<a name="l00447"></a>00447         scale[1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l00448"></a>00448         scale[2] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[2]);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(scale[0] - scale[1]) &gt; 1e-6f || <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(scale[1] - scale[2]) &gt; 1e-6f) {
<a name="l00451"></a>00451             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(scalemat);
<a name="l00452"></a>00452             scalemat[0][0] = scale[0];
<a name="l00453"></a>00453             scalemat[1][1] = scale[1];
<a name="l00454"></a>00454             scalemat[2][2] = scale[2];
<a name="l00455"></a>00455             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(iscalemat, scalemat);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457             length *= scale[1];
<a name="l00458"></a>00458             doscale = 1;
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     hlength1 = bone-&gt;<a class="code" href="../../de/de0/structBone.html#a1a8c73a40cb50593f865077eb42b47e4">ease1</a>*length*0.390464f; <span class="comment">/* 0.5*sqrt(2)*kappa, the handle length for near-perfect circles */</span>
<a name="l00463"></a>00463     hlength2 = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac19a237ba3a787497f2d147bfe045d99">ease2</a>*length*0.390464f;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="comment">/* evaluate next and prev bones */</span>
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)
<a name="l00467"></a>00467         prev = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l00468"></a>00468     <span class="keywordflow">else</span>
<a name="l00469"></a>00469         prev = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     next = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad63dea990fc5ac499625f4d9ef570de9">child</a>;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="comment">/* find the handle points, since this is inside bone space, the</span>
<a name="l00474"></a>00474 <span class="comment">     * first point = (0,0,0)</span>
<a name="l00475"></a>00475 <span class="comment">     * last point =  (0, length, 0) */</span>
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (rest) {
<a name="l00477"></a>00477         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (doscale) {
<a name="l00480"></a>00480         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(posemat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00481"></a>00481         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(posemat);
<a name="l00482"></a>00482         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, posemat);
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     <span class="keywordflow">else</span>
<a name="l00485"></a>00485         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (prev) {
<a name="l00488"></a>00488         <span class="keywordtype">float</span> difmat[4][4], result[3][3], imat3[3][3];
<a name="l00489"></a>00489 
<a name="l00490"></a>00490         <span class="comment">/* transform previous point inside this bone space */</span>
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (rest)
<a name="l00492"></a>00492             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(h1, prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>);
<a name="l00493"></a>00493         <span class="keywordflow">else</span>
<a name="l00494"></a>00494             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(h1, prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l00495"></a>00495         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, h1);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>&gt;1) {
<a name="l00498"></a>00498             <span class="comment">/* if previous bone is B-bone too, use average handle direction */</span>
<a name="l00499"></a>00499             h1[1] -= <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00500"></a>00500             roll1 = 0.0f;
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h1);
<a name="l00504"></a>00504         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(h1, -hlength1);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> == 1) {
<a name="l00507"></a>00507             <span class="comment">/* find the previous roll to interpolate */</span>
<a name="l00508"></a>00508             <span class="keywordflow">if</span> (rest)
<a name="l00509"></a>00509                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(difmat, imat, prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l00510"></a>00510             <span class="keywordflow">else</span>
<a name="l00511"></a>00511                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(difmat, imat, prev-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00512"></a>00512             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(result, difmat); <span class="comment">/* the desired rotation at beginning of next bone */</span>
<a name="l00513"></a>00513 
<a name="l00514"></a>00514             <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(h1, 0.0f, mat3); <span class="comment">/* the result of vec_roll without roll */</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat3, mat3);
<a name="l00517"></a>00517             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(mat3, result, imat3); <span class="comment">/* the matrix transforming vec_roll to desired roll */</span>
<a name="l00518"></a>00518 
<a name="l00519"></a>00519             roll1 = (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(mat3[2][0], mat3[2][2]);
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     <span class="keywordflow">else</span> {
<a name="l00523"></a>00523         h1[0] = 0.0f; h1[1] = hlength1; h1[2] = 0.0f;
<a name="l00524"></a>00524         roll1 = 0.0f;
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (next) {
<a name="l00527"></a>00527         <span class="keywordtype">float</span> difmat[4][4], result[3][3], imat3[3][3];
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <span class="comment">/* transform next point inside this bone space */</span>
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (rest)
<a name="l00531"></a>00531             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(h2, next-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l00532"></a>00532         <span class="keywordflow">else</span>
<a name="l00533"></a>00533             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(h2, next-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l00534"></a>00534         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(imat, h2);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         <span class="comment">/* if next bone is B-bone too, use average handle direction */</span>
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (next-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>&gt;1)
<a name="l00538"></a>00538             ;
<a name="l00539"></a>00539         <span class="keywordflow">else</span>
<a name="l00540"></a>00540             h2[1]-= <a class="code" href="../../d1/d22/stdosl_8h.html#a939ad05d43eeb38dcadd8218e52d9648">length</a>;
<a name="l00541"></a>00541         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h2);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543         <span class="comment">/* find the next roll to interpolate as well */</span>
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (rest)
<a name="l00545"></a>00545             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(difmat, imat, next-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l00546"></a>00546         <span class="keywordflow">else</span>
<a name="l00547"></a>00547             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(difmat, imat, next-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l00548"></a>00548         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(result, difmat); <span class="comment">/* the desired rotation at beginning of next bone */</span>
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(h2, 0.0f, mat3); <span class="comment">/* the result of vec_roll without roll */</span>
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(imat3, mat3);
<a name="l00553"></a>00553         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(mat3, imat3, result); <span class="comment">/* the matrix transforming vec_roll to desired roll */</span>
<a name="l00554"></a>00554 
<a name="l00555"></a>00555         roll2 = (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(mat3[2][0], mat3[2][2]);
<a name="l00556"></a>00556 
<a name="l00557"></a>00557         <span class="comment">/* and only now negate handle */</span>
<a name="l00558"></a>00558         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(h2, -hlength2);
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span> {
<a name="l00561"></a>00561         h2[0] = 0.0f; h2[1] = -hlength2; h2[2] = 0.0f;
<a name="l00562"></a>00562         roll2 = 0.0;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="comment">/* make curve */</span>
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>)
<a name="l00567"></a>00567         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> = <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a44c2709924870c4af9d9268f691a63e0">forward_diff_bezier</a>(0.0,   h1[0],                           h2[0],                           0.0,    data[0],
<a name="l00570"></a>00570                         <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>, 4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00571"></a>00571     <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a44c2709924870c4af9d9268f691a63e0">forward_diff_bezier</a>(0.0,   h1[1],                           length + h2[1],                  length, data[0]+1,
<a name="l00572"></a>00572                         <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>, 4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00573"></a>00573     <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a44c2709924870c4af9d9268f691a63e0">forward_diff_bezier</a>(0.0,   h1[2],                           h2[2],                           0.0,    data[0]+2,
<a name="l00574"></a>00574                         <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>, 4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00575"></a>00575     <a class="code" href="../../d7/dfc/BKE__curve_8h.html#a44c2709924870c4af9d9268f691a63e0">forward_diff_bezier</a>(roll1, roll1 + 0.390464f*(roll2-roll1), roll2 - 0.390464f*(roll2-roll1), roll2,  data[0]+3,
<a name="l00576"></a>00576                         <a class="code" href="../../d9/d2b/armature_8c.html#a462e363e498854b4319d95dda38deb7f">MAX_BBONE_SUBDIV</a>, 4*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <a class="code" href="../../d9/d2b/armature_8c.html#a3c046ddd6e2fa33352bf25dcee6f33c2">equalize_bezier</a>(data[0], bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>); <span class="comment">/* note: does stride 4! */</span>
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">/* make transformation matrices for the segments for drawing */</span>
<a name="l00581"></a>00581     <span class="keywordflow">for</span> (a = 0, fp = data[0]; a &lt; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>; a++, fp += 4) {
<a name="l00582"></a>00582         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(h1, fp+4, fp);
<a name="l00583"></a>00583         <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(h1, fp[3], mat3); <span class="comment">/* fp[3] is roll */</span>
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(result_array[a].mat, mat3);
<a name="l00586"></a>00586         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(result_array[a].mat[3], fp);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="keywordflow">if</span> (doscale) {
<a name="l00589"></a>00589             <span class="comment">/* correct for scaling when this matrix is used in scaled space */</span>
<a name="l00590"></a>00590             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(result_array[a].mat, iscalemat, result_array[a].mat, scalemat, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00591"></a>00591         }
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <span class="keywordflow">return</span> result_array;
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">/* ************ Armature Deform ******************* */</span>
<a name="l00598"></a>00598 
<a name="l00599"></a><a class="code" href="../../df/df4/structbPoseChanDeform.html">00599</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> {
<a name="l00600"></a><a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">00600</a>     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a>     *<a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">b_bone_mats</a>;
<a name="l00601"></a><a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">00601</a>     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *<a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">dual_quat</a>;
<a name="l00602"></a><a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">00602</a>     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *<a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">b_bone_dual_quats</a>;
<a name="l00603"></a>00603 } <a class="code" href="../../d9/d2b/armature_8c.html#a5e7f66ec1077d2c6d4b683d85dde6664">bPoseChanDeform</a>;
<a name="l00604"></a>00604 
<a name="l00605"></a><a class="code" href="../../d9/d2b/armature_8c.html#a52ef042340396e7a91cda5e89993d7a4">00605</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a52ef042340396e7a91cda5e89993d7a4">pchan_b_bone_defmats</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info, <span class="keywordtype">int</span> use_quaternion)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l00608"></a>00608     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *b_bone = <a class="code" href="../../da/d17/BKE__armature_8h.html#aff2236f3e8532360b1b7b72f5336ef53">b_bone_spline_setup</a>(pchan, 0);
<a name="l00609"></a>00609     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *b_bone_rest = <a class="code" href="../../da/d17/BKE__armature_8h.html#aff2236f3e8532360b1b7b72f5336ef53">b_bone_spline_setup</a>(pchan, 1);
<a name="l00610"></a>00610     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *b_bone_mats;
<a name="l00611"></a>00611     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *b_bone_dual_quats = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00612"></a>00612     <span class="keywordtype">float</span> tmat[4][4] = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l00613"></a>00613     <span class="keywordtype">int</span> a;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="comment">/* allocate b_bone matrices and dual quats */</span>
<a name="l00616"></a>00616     b_bone_mats = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>((1+bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>)*<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d89/structMat4.html">Mat4</a>), <span class="stringliteral">&quot;BBone defmats&quot;</span>);
<a name="l00617"></a>00617     pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">b_bone_mats</a> = b_bone_mats;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (use_quaternion) {
<a name="l00620"></a>00620         b_bone_dual_quats = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>((bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>)*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a>), <span class="stringliteral">&quot;BBone dqs&quot;</span>);
<a name="l00621"></a>00621         pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">b_bone_dual_quats</a> = b_bone_dual_quats;
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">/* first matrix is the inverse arm_mat, to bring points in local bone space</span>
<a name="l00625"></a>00625 <span class="comment">     * for finding out which segment it belongs to */</span>
<a name="l00626"></a>00626     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(b_bone_mats[0].mat, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="comment">/* then we make the b_bone_mats:</span>
<a name="l00629"></a>00629 <span class="comment">     * - first transform to local bone space</span>
<a name="l00630"></a>00630 <span class="comment">     * - translate over the curve to the bbone mat space</span>
<a name="l00631"></a>00631 <span class="comment">     * - transform with b_bone matrix</span>
<a name="l00632"></a>00632 <span class="comment">     * - transform back into global space */</span>
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">for</span> (a = 0; a &lt; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>; a++) {
<a name="l00635"></a>00635         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(tmat, b_bone_rest[a].mat);
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(b_bone_mats[a+1].mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, b_bone[a].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>, tmat, b_bone_mats[0].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>,
<a name="l00638"></a>00638                      <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (use_quaternion)
<a name="l00641"></a>00641             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a0df6e83dd1777be727abea688c73f06a">mat4_to_dquat</a>(&amp;b_bone_dual_quats[a], bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, b_bone_mats[a+1].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>);
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a><a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">00645</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">b_bone_deform</a>(<a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *dq, <span class="keywordtype">float</span> defmat[][3])
<a name="l00646"></a>00646 {
<a name="l00647"></a>00647     <a class="code" href="../../d5/d89/structMat4.html">Mat4</a> *b_bone = pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">b_bone_mats</a>;
<a name="l00648"></a>00648     float (*mat)[4] = b_bone[0].<a class="code" href="../../d5/d89/structMat4.html#a8e517e734be59cf585e9011578927141">mat</a>;
<a name="l00649"></a>00649     <span class="keywordtype">float</span> segment, y;
<a name="l00650"></a>00650     <span class="keywordtype">int</span> a;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="comment">/* need to transform co back to bonespace, only need y */</span>
<a name="l00653"></a>00653     y = mat[0][1]*co[0] + mat[1][1]*co[1] + mat[2][1]*co[2] + mat[3][1];
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <span class="comment">/* now calculate which of the b_bones are deforming this */</span>
<a name="l00656"></a>00656     segment = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>/((float)bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>);
<a name="l00657"></a>00657     a = (int)(y/segment);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="comment">/* note; by clamping it extends deform at endpoints, goes best with</span>
<a name="l00660"></a>00660 <span class="comment">     * straight joints in restpos. */</span>
<a name="l00661"></a>00661     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(a, 0, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>-1);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (dq) {
<a name="l00664"></a>00664         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a4e83b929ddd33a5b820466b745e3787a">copy_dq_dq</a>(dq, &amp;(pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">b_bone_dual_quats</a>)[a]);
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     <span class="keywordflow">else</span> {
<a name="l00667"></a>00667         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(b_bone[a+1].mat, co);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         <span class="keywordflow">if</span> (defmat) {
<a name="l00670"></a>00670             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(defmat, b_bone[a+1].mat);
<a name="l00671"></a>00671         }
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="comment">/* using vec with dist to bone b1 - b2 */</span>
<a name="l00676"></a><a class="code" href="../../d9/d2b/armature_8c.html#a6808063ff4c217906aa5da820d40178b">00676</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a4047ce9de4bf6ef8d4afe6ae35e8940c">distfactor_to_bone</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keyword">const</span> <span class="keywordtype">float</span> b1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> b2[3], <span class="keywordtype">float</span> rad1, <span class="keywordtype">float</span> rad2, <span class="keywordtype">float</span> rdist)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <span class="keywordtype">float</span> dist = 0.0f;
<a name="l00679"></a>00679     <span class="keywordtype">float</span> bdelta[3];
<a name="l00680"></a>00680     <span class="keywordtype">float</span> pdelta[3];
<a name="l00681"></a>00681     <span class="keywordtype">float</span> hsqr, a, l, rad;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(bdelta, b2, b1);
<a name="l00684"></a>00684     l = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(bdelta);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pdelta, vec, b1);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(bdelta, pdelta);
<a name="l00689"></a>00689     hsqr = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(pdelta, pdelta);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">if</span> (a &lt; 0.0f) {
<a name="l00692"></a>00692         <span class="comment">/* If we&#39;re past the end of the bone, do a spherical field attenuation thing */</span>
<a name="l00693"></a>00693         dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(b1, vec);
<a name="l00694"></a>00694         rad = rad1;
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a &gt; l) {
<a name="l00697"></a>00697         <span class="comment">/* If we&#39;re past the end of the bone, do a spherical field attenuation thing */</span>
<a name="l00698"></a>00698         dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(b2, vec);
<a name="l00699"></a>00699         rad = rad2;
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     <span class="keywordflow">else</span> {
<a name="l00702"></a>00702         dist = (hsqr - (a*a));
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         <span class="keywordflow">if</span> (l != 0.0f) {
<a name="l00705"></a>00705             rad = a/l;
<a name="l00706"></a>00706             rad = rad*rad2 + (1.0f-rad)*rad1;
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708         <span class="keywordflow">else</span>
<a name="l00709"></a>00709             rad = rad1;
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     a = rad*rad;
<a name="l00713"></a>00713     <span class="keywordflow">if</span> (dist &lt; a)
<a name="l00714"></a>00714         <span class="keywordflow">return</span> 1.0f;
<a name="l00715"></a>00715     <span class="keywordflow">else</span> {
<a name="l00716"></a>00716         l = rad+rdist;
<a name="l00717"></a>00717         l *= l;
<a name="l00718"></a>00718         <span class="keywordflow">if</span> (rdist == 0.0f || dist &gt;= l)
<a name="l00719"></a>00719             <span class="keywordflow">return</span> 0.0f;
<a name="l00720"></a>00720         <span class="keywordflow">else</span> {
<a name="l00721"></a>00721             a = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(dist)-rad;
<a name="l00722"></a>00722             <span class="keywordflow">return</span> 1.0f-( a*a )/( rdist*rdist );
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725 }
<a name="l00726"></a>00726 
<a name="l00727"></a><a class="code" href="../../d9/d2b/armature_8c.html#a254080621cb4590b65d72d81e6174e5c">00727</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a254080621cb4590b65d72d81e6174e5c">pchan_deform_mat_add</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> weight, <span class="keywordtype">float</span> bbonemat[][3], <span class="keywordtype">float</span> mat[][3])
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729     <span class="keywordtype">float</span> wmat[3][3];
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1)
<a name="l00732"></a>00732         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(wmat, bbonemat);
<a name="l00733"></a>00733     <span class="keywordflow">else</span>
<a name="l00734"></a>00734         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(wmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a55eec16c2fac66336344b9e7f346fe83">mul_m3_fl</a>(wmat, weight);
<a name="l00737"></a>00737     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac90ef87bc55924ddc815b4b604fd645b">add_m3_m3m3</a>(mat, mat, wmat);
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a><a class="code" href="../../d9/d2b/armature_8c.html#afbbbbf02b08bc8fc6fb0dde0f915f3dd">00740</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/d2b/armature_8c.html#afbbbbf02b08bc8fc6fb0dde0f915f3dd">dist_bone_deform</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info, <span class="keywordtype">float</span> vec[3], <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *dq,
<a name="l00741"></a>00741                               <span class="keywordtype">float</span> mat[][3], <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l00744"></a>00744     <span class="keywordtype">float</span> fac, contrib = 0.0;
<a name="l00745"></a>00745     <span class="keywordtype">float</span> cop[3], bbonemat[3][3];
<a name="l00746"></a>00746     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> bbonedq;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748     <span class="keywordflow">if</span> (bone == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00749"></a>00749         <span class="keywordflow">return</span> 0.0f;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cop, co);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     fac = <a class="code" href="../../da/d17/BKE__armature_8h.html#a4047ce9de4bf6ef8d4afe6ae35e8940c">distfactor_to_bone</a>(cop, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#aa3a081bf3e8f40876c53868e52174190">rad_head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac603bd97e3cb0f73ec55cc73ee8ac1d0">rad_tail</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae41dbb73ded85fe0699b8c7283998ea9">dist</a>);
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="keywordflow">if</span> (fac &gt; 0.0f) {
<a name="l00756"></a>00756         fac *= bone-&gt;<a class="code" href="../../de/de0/structBone.html#afa2a71efdb2d15bcab524ddddf54ee70">weight</a>;
<a name="l00757"></a>00757         contrib = fac;
<a name="l00758"></a>00758         <span class="keywordflow">if</span> (contrib &gt; 0.0f) {
<a name="l00759"></a>00759             <span class="keywordflow">if</span> (vec) {
<a name="l00760"></a>00760                 <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1)
<a name="l00761"></a>00761                     <span class="comment">/* applies on cop and bbonemat */</span>
<a name="l00762"></a>00762                     <a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">b_bone_deform</a>(pdef_info, bone, cop, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (mat) ? bbonemat : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00763"></a>00763                 <span class="keywordflow">else</span>
<a name="l00764"></a>00764                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, cop);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766                 <span class="comment">/* Make this a delta from the base position */</span>
<a name="l00767"></a>00767                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(cop, co);
<a name="l00768"></a>00768                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vec, cop, fac);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770                 <span class="keywordflow">if</span> (mat)
<a name="l00771"></a>00771                     <a class="code" href="../../d9/d2b/armature_8c.html#a254080621cb4590b65d72d81e6174e5c">pchan_deform_mat_add</a>(pchan, fac, bbonemat, mat);
<a name="l00772"></a>00772             }
<a name="l00773"></a>00773             <span class="keywordflow">else</span> {
<a name="l00774"></a>00774                 <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1) {
<a name="l00775"></a>00775                     <a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">b_bone_deform</a>(pdef_info, bone, cop, &amp;bbonedq, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00776"></a>00776                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a2cbc6b21679655400ef71f0bc13ca8a9">add_weighted_dq_dq</a>(dq, &amp;bbonedq, fac);
<a name="l00777"></a>00777                 }
<a name="l00778"></a>00778                 <span class="keywordflow">else</span>
<a name="l00779"></a>00779                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a2cbc6b21679655400ef71f0bc13ca8a9">add_weighted_dq_dq</a>(dq, pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">dual_quat</a>, fac);
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781         }
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     <span class="keywordflow">return</span> contrib;
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a><a class="code" href="../../d9/d2b/armature_8c.html#a4e32a71b63d2dd4dd4d76760936428bf">00787</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a4e32a71b63d2dd4dd4d76760936428bf">pchan_bone_deform</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info, <span class="keywordtype">float</span> weight, <span class="keywordtype">float</span> vec[3], <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *dq,
<a name="l00788"></a>00788                               <span class="keywordtype">float</span> mat[][3], <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *contrib)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790     <span class="keywordtype">float</span> cop[3], bbonemat[3][3];
<a name="l00791"></a>00791     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> bbonedq;
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (!weight)
<a name="l00794"></a>00794         <span class="keywordflow">return</span>;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cop, co);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="keywordflow">if</span> (vec) {
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a>&gt;1)
<a name="l00800"></a>00800             <span class="comment">/* applies on cop and bbonemat */</span>
<a name="l00801"></a>00801             <a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">b_bone_deform</a>(pdef_info, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>, cop, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (mat) ? bbonemat : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00802"></a>00802         <span class="keywordflow">else</span>
<a name="l00803"></a>00803             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, cop);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         vec[0] += (cop[0]-co[0])*weight;
<a name="l00806"></a>00806         vec[1] += (cop[1]-co[1])*weight;
<a name="l00807"></a>00807         vec[2] += (cop[2]-co[2])*weight;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809         <span class="keywordflow">if</span> (mat)
<a name="l00810"></a>00810             <a class="code" href="../../d9/d2b/armature_8c.html#a254080621cb4590b65d72d81e6174e5c">pchan_deform_mat_add</a>(pchan, weight, bbonemat, mat);
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812     <span class="keywordflow">else</span> {
<a name="l00813"></a>00813         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1) {
<a name="l00814"></a>00814             <a class="code" href="../../d9/d2b/armature_8c.html#a6d008b071bab804319222fe0227e6b38">b_bone_deform</a>(pdef_info, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>, cop, &amp;bbonedq, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00815"></a>00815             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a2cbc6b21679655400ef71f0bc13ca8a9">add_weighted_dq_dq</a>(dq, &amp;bbonedq, weight);
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817         <span class="keywordflow">else</span>
<a name="l00818"></a>00818             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a2cbc6b21679655400ef71f0bc13ca8a9">add_weighted_dq_dq</a>(dq, pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">dual_quat</a>, weight);
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     (*contrib) += weight;
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a><a class="code" href="../../d9/d2b/armature_8c.html#a4e4b4d9b9326eca26e1031b1553e6db2">00824</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a7643eae61e23d4b25b41e61536052e04">armature_deform_verts</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *armOb, <a class="code" href="../../de/de7/structObject.html">Object</a> *target, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">float</span> (*vertexCos)[3],
<a name="l00825"></a>00825                            <span class="keywordtype">float</span> (*defMats)[3][3], <span class="keywordtype">int</span> numVerts, <span class="keywordtype">int</span> deformflag,
<a name="l00826"></a>00826                            <span class="keywordtype">float</span> (*prevCos)[3], <span class="keyword">const</span> <span class="keywordtype">char</span> *defgrp_name)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828     <a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info_array;
<a name="l00829"></a>00829     <a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a> *pdef_info = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00830"></a>00830     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm = armOb-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00831"></a>00831     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, **defnrToPC = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00832"></a>00832     <span class="keywordtype">int</span> *defnrToPCIndex = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00833"></a>00833     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dverts = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00834"></a>00834     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg;
<a name="l00835"></a>00835     <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> *dualquats = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00836"></a>00836     <span class="keywordtype">float</span> obinv[4][4], premat[4][4], postmat[4][4];
<a name="l00837"></a>00837     <span class="keyword">const</span> <span class="keywordtype">short</span> use_envelope = deformflag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00ab02e539bc235b4304295e2e0cbf76ba8">ARM_DEF_ENVELOPE</a>;
<a name="l00838"></a>00838     <span class="keyword">const</span> <span class="keywordtype">short</span> use_quaternion = deformflag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00a6a9b161205c05c4f74c9add08242b78a">ARM_DEF_QUATERNION</a>;
<a name="l00839"></a>00839     <span class="keyword">const</span> <span class="keywordtype">short</span> invert_vgroup = deformflag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00a8117ad4aa7c23a504b51d870c0a0ccb4">ARM_DEF_INVERT_VGROUP</a>;
<a name="l00840"></a>00840     <span class="keywordtype">int</span> defbase_tot = 0;       <span class="comment">/* safety for vertexgroup index overflow */</span>
<a name="l00841"></a>00841     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, target_totvert = 0; <span class="comment">/* safety for vertexgroup overflow */</span>
<a name="l00842"></a>00842     <span class="keywordtype">int</span> use_dverts = 0;
<a name="l00843"></a>00843     <span class="keywordtype">int</span> armature_def_nr;
<a name="l00844"></a>00844     <span class="keywordtype">int</span> totchan;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>) <span class="keywordflow">return</span>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obinv, target-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00849"></a>00849     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(premat, target-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00850"></a>00850     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(postmat, obinv, armOb-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00851"></a>00851     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(premat, postmat);
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     <span class="comment">/* bone defmats are already in the channels, chan_mat */</span>
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     <span class="comment">/* initialize B_bone matrices and dual quaternions */</span>
<a name="l00856"></a>00856     totchan = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>);
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (use_quaternion) {
<a name="l00859"></a>00859         dualquats = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a>)*totchan, <span class="stringliteral">&quot;dualquats&quot;</span>);
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     pdef_info_array = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/df4/structbPoseChanDeform.html">bPoseChanDeform</a>)*totchan, <span class="stringliteral">&quot;bPoseChanDeform&quot;</span>);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864     totchan = 0;
<a name="l00865"></a>00865     pdef_info = pdef_info_array;
<a name="l00866"></a>00866     <span class="keywordflow">for</span> (pchan = armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>, pdef_info++) {
<a name="l00867"></a>00867         <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>)) {
<a name="l00868"></a>00868             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> &gt; 1)
<a name="l00869"></a>00869                 <a class="code" href="../../d9/d2b/armature_8c.html#a52ef042340396e7a91cda5e89993d7a4">pchan_b_bone_defmats</a>(pchan, pdef_info, use_quaternion);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (use_quaternion) {
<a name="l00872"></a>00872                 pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">dual_quat</a> = &amp;dualquats[totchan++];
<a name="l00873"></a>00873                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a0df6e83dd1777be727abea688c73f06a">mat4_to_dquat</a>(pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#a74821634c22ca1c5eea803636218adee">dual_quat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>);
<a name="l00874"></a>00874             }
<a name="l00875"></a>00875         }
<a name="l00876"></a>00876     }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     <span class="comment">/* get the def_nr for the overall armature vertex group if present */</span>
<a name="l00879"></a>00879     armature_def_nr = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a3eda6e88bc1982e6b63a8aa2b78e1770">defgroup_name_index</a>(target, defgrp_name);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(target-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) {
<a name="l00882"></a>00882         defbase_tot = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;target-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>);
<a name="l00883"></a>00883 
<a name="l00884"></a>00884         <span class="keywordflow">if</span> (target-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00885"></a>00885             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = target-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00886"></a>00886             dverts = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00887"></a>00887             <span class="keywordflow">if</span> (dverts)
<a name="l00888"></a>00888                 target_totvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890         <span class="keywordflow">else</span> {
<a name="l00891"></a>00891             <a class="code" href="../../dd/d40/structLattice.html">Lattice</a> *lt = target-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00892"></a>00892             dverts = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a4a2b2d1f76c8199226ae49ca62403fea">dvert</a>;
<a name="l00893"></a>00893             <span class="keywordflow">if</span> (dverts)
<a name="l00894"></a>00894                 target_totvert = lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a086be8c4ef28587f6eb08c40d1bab473">pntsu</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a57fa6ffa7aaaed8c191e55d54eeebb74">pntsv</a>*lt-&gt;<a class="code" href="../../dd/d40/structLattice.html#a19be731ba1b95cd1ec5df36229baaee2">pntsw</a>;
<a name="l00895"></a>00895         }
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="comment">/* get a vertex-deform-index to posechannel array */</span>
<a name="l00899"></a>00899     <span class="keywordflow">if</span> (deformflag &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a8bf4daaf356d08df967fc2caf0d2bc00a5ed89fe6fa4c071ff20da36463151513">ARM_DEF_VGROUP</a>) {
<a name="l00900"></a>00900         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(target-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>)) {
<a name="l00901"></a>00901             <span class="comment">/* if we have a DerivedMesh, only use dverts if it has them */</span>
<a name="l00902"></a>00902             <span class="keywordflow">if</span> (dm)
<a name="l00903"></a>00903                 <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, 0, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>))
<a name="l00904"></a>00904                     use_dverts = 1;
<a name="l00905"></a>00905                 <span class="keywordflow">else</span> use_dverts = 0;
<a name="l00906"></a>00906             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dverts) use_dverts = 1;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908             <span class="keywordflow">if</span> (use_dverts) {
<a name="l00909"></a>00909                 defnrToPC = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*defnrToPC) * defbase_tot, <span class="stringliteral">&quot;defnrToBone&quot;</span>);
<a name="l00910"></a>00910                 defnrToPCIndex = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*defnrToPCIndex) * defbase_tot, <span class="stringliteral">&quot;defnrToIndex&quot;</span>);
<a name="l00911"></a>00911                 <span class="keywordflow">for</span> (i = 0, dg = target-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dg; i++, dg = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>) {
<a name="l00912"></a>00912                     defnrToPC[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>);
<a name="l00913"></a>00913                     <span class="comment">/* exclude non-deforming bones */</span>
<a name="l00914"></a>00914                     <span class="keywordflow">if</span> (defnrToPC[i]) {
<a name="l00915"></a>00915                         <span class="keywordflow">if</span> (defnrToPC[i]-&gt;bone-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>) {
<a name="l00916"></a>00916                             defnrToPC[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00917"></a>00917                         }
<a name="l00918"></a>00918                         <span class="keywordflow">else</span> {
<a name="l00919"></a>00919                             defnrToPCIndex[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(&amp;armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>, defnrToPC[i]);
<a name="l00920"></a>00920                         }
<a name="l00921"></a>00921                     }
<a name="l00922"></a>00922                 }
<a name="l00923"></a>00923             }
<a name="l00924"></a>00924         }
<a name="l00925"></a>00925     }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     <span class="keywordflow">for</span> (i = 0; i &lt; numVerts; i++) {
<a name="l00928"></a>00928         <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert;
<a name="l00929"></a>00929         <a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a> sumdq, *dq = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00930"></a>00930         <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, dco[3];
<a name="l00931"></a>00931         <span class="keywordtype">float</span> sumvec[3], summat[3][3];
<a name="l00932"></a>00932         <span class="keywordtype">float</span> *vec = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (*smat)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00933"></a>00933         <span class="keywordtype">float</span> contrib = 0.0f;
<a name="l00934"></a>00934         <span class="keywordtype">float</span> armature_weight = 1.0f; <span class="comment">/* default to 1 if no overall def group */</span>
<a name="l00935"></a>00935         <span class="keywordtype">float</span> prevco_weight = 1.0f;   <span class="comment">/* weight for optional cached vertexcos */</span>
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         <span class="keywordflow">if</span> (use_quaternion) {
<a name="l00938"></a>00938             memset(&amp;sumdq, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/dd3/structDualQuat.html">DualQuat</a>));
<a name="l00939"></a>00939             dq = &amp;sumdq;
<a name="l00940"></a>00940         }
<a name="l00941"></a>00941         <span class="keywordflow">else</span> {
<a name="l00942"></a>00942             sumvec[0] = sumvec[1] = sumvec[2] = 0.0f;
<a name="l00943"></a>00943             vec = sumvec;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945             <span class="keywordflow">if</span> (defMats) {
<a name="l00946"></a>00946                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ab9e4d613e276ebae7b75c67ef34e35a4">zero_m3</a>(summat);
<a name="l00947"></a>00947                 smat = summat;
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949         }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951         <span class="keywordflow">if</span> (use_dverts || armature_def_nr &gt;= 0) {
<a name="l00952"></a>00952             <span class="keywordflow">if</span> (dm)
<a name="l00953"></a>00953                 dvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a618ea310c1eb7d1f120ad2bbbbcef0b2">getVertData</a>(dm, i, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00954"></a>00954             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dverts &amp;&amp; i &lt; target_totvert)
<a name="l00955"></a>00955                 dvert = dverts + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00956"></a>00956             <span class="keywordflow">else</span>
<a name="l00957"></a>00957                 dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959         <span class="keywordflow">else</span>
<a name="l00960"></a>00960             dvert = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962         <span class="keywordflow">if</span> (armature_def_nr &gt;= 0 &amp;&amp; dvert) {
<a name="l00963"></a>00963             armature_weight = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(dvert, armature_def_nr);
<a name="l00964"></a>00964 
<a name="l00965"></a>00965             <span class="keywordflow">if</span> (invert_vgroup)
<a name="l00966"></a>00966                 armature_weight = 1.0f-armature_weight;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968             <span class="comment">/* hackish: the blending factor can be used for blending with prevCos too */</span>
<a name="l00969"></a>00969             <span class="keywordflow">if</span> (prevCos) {
<a name="l00970"></a>00970                 prevco_weight = armature_weight;
<a name="l00971"></a>00971                 armature_weight = 1.0f;
<a name="l00972"></a>00972             }
<a name="l00973"></a>00973         }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975         <span class="comment">/* check if there&#39;s any  point in calculating for this vert */</span>
<a name="l00976"></a>00976         <span class="keywordflow">if</span> (armature_weight == 0.0f)
<a name="l00977"></a>00977             <span class="keywordflow">continue</span>;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979         <span class="comment">/* get the coord we work on */</span>
<a name="l00980"></a>00980         co = prevCos ? prevCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] : vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00981"></a>00981 
<a name="l00982"></a>00982         <span class="comment">/* Apply the object&#39;s matrix */</span>
<a name="l00983"></a>00983         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(premat, co);
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="keywordflow">if</span> (use_dverts &amp;&amp; dvert &amp;&amp; dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>) { <span class="comment">/* use weight groups ? */</span>
<a name="l00986"></a>00986             <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l00987"></a>00987             <span class="keywordtype">int</span> deformed = 0;
<a name="l00988"></a>00988             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990             <span class="keywordflow">for</span> (j = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; j != 0; j--, dw++) {
<a name="l00991"></a>00991                 <span class="keyword">const</span> <span class="keywordtype">int</span> index = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>;
<a name="l00992"></a>00992                 <span class="keywordflow">if</span> (index &lt; defbase_tot &amp;&amp; (pchan = defnrToPC[index])) {
<a name="l00993"></a>00993                     <span class="keywordtype">float</span> weight = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l00994"></a>00994                     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l00995"></a>00995                     pdef_info = pdef_info_array + defnrToPCIndex[index];
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                     deformed = 1;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999                     <span class="keywordflow">if</span> (bone &amp;&amp; bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aae6b76d36509067af4cbedfd21509767">BONE_MULT_VG_ENV</a>) {
<a name="l01000"></a>01000                         weight *= <a class="code" href="../../da/d17/BKE__armature_8h.html#a4047ce9de4bf6ef8d4afe6ae35e8940c">distfactor_to_bone</a>(co, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>,
<a name="l01001"></a>01001                                                      bone-&gt;<a class="code" href="../../de/de0/structBone.html#aa3a081bf3e8f40876c53868e52174190">rad_head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac603bd97e3cb0f73ec55cc73ee8ac1d0">rad_tail</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae41dbb73ded85fe0699b8c7283998ea9">dist</a>);
<a name="l01002"></a>01002                     }
<a name="l01003"></a>01003                     <a class="code" href="../../d9/d2b/armature_8c.html#a4e32a71b63d2dd4dd4d76760936428bf">pchan_bone_deform</a>(pchan, pdef_info, weight, vec, dq, smat, co, &amp;contrib);
<a name="l01004"></a>01004                 }
<a name="l01005"></a>01005             }
<a name="l01006"></a>01006             <span class="comment">/* if there are vertexgroups but not groups with bones</span>
<a name="l01007"></a>01007 <span class="comment">             * (like for softbody groups) */</span>
<a name="l01008"></a>01008             <span class="keywordflow">if</span> (deformed == 0 &amp;&amp; use_envelope) {
<a name="l01009"></a>01009                 pdef_info = pdef_info_array;
<a name="l01010"></a>01010                 <span class="keywordflow">for</span> (pchan = armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>, pdef_info++) {
<a name="l01011"></a>01011                     <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>))
<a name="l01012"></a>01012                         contrib += <a class="code" href="../../d9/d2b/armature_8c.html#afbbbbf02b08bc8fc6fb0dde0f915f3dd">dist_bone_deform</a>(pchan, pdef_info, vec, dq, smat, co);
<a name="l01013"></a>01013                 }
<a name="l01014"></a>01014             }
<a name="l01015"></a>01015         }
<a name="l01016"></a>01016         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (use_envelope) {
<a name="l01017"></a>01017             pdef_info = pdef_info_array;
<a name="l01018"></a>01018             <span class="keywordflow">for</span> (pchan = armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>, pdef_info++) {
<a name="l01019"></a>01019                 <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>))
<a name="l01020"></a>01020                     contrib += <a class="code" href="../../d9/d2b/armature_8c.html#afbbbbf02b08bc8fc6fb0dde0f915f3dd">dist_bone_deform</a>(pchan, pdef_info, vec, dq, smat, co);
<a name="l01021"></a>01021             }
<a name="l01022"></a>01022         }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         <span class="comment">/* actually should be EPSILON? weight values and contrib can be like 10e-39 small */</span>
<a name="l01025"></a>01025         <span class="keywordflow">if</span> (contrib &gt; 0.0001f) {
<a name="l01026"></a>01026             <span class="keywordflow">if</span> (use_quaternion) {
<a name="l01027"></a>01027                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad38295bc1f3b43922757dda77045b532">normalize_dq</a>(dq, contrib);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029                 <span class="keywordflow">if</span> (armature_weight != 1.0f) {
<a name="l01030"></a>01030                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(dco, co);
<a name="l01031"></a>01031                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aab3d569fe0db8cfc0e6b133abadc7367">mul_v3m3_dq</a>( dco, (defMats) ? summat : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,dq);
<a name="l01032"></a>01032                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(dco, co);
<a name="l01033"></a>01033                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(dco, armature_weight);
<a name="l01034"></a>01034                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(co, dco);
<a name="l01035"></a>01035                 }
<a name="l01036"></a>01036                 <span class="keywordflow">else</span>
<a name="l01037"></a>01037                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aab3d569fe0db8cfc0e6b133abadc7367">mul_v3m3_dq</a>( co, (defMats) ? summat : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,dq);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039                 smat = summat;
<a name="l01040"></a>01040             }
<a name="l01041"></a>01041             <span class="keywordflow">else</span> {
<a name="l01042"></a>01042                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, armature_weight/contrib);
<a name="l01043"></a>01043                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, vec, co);
<a name="l01044"></a>01044             }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046             <span class="keywordflow">if</span> (defMats) {
<a name="l01047"></a>01047                 <span class="keywordtype">float</span> pre[3][3], <a class="code" href="../../d0/dea/sp__coletree_8c.html#ab6c0f6f7a979ede50dae233792e4efc7">post</a>[3][3], tmpmat[3][3];
<a name="l01048"></a>01048 
<a name="l01049"></a>01049                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(pre, premat);
<a name="l01050"></a>01050                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(post, postmat);
<a name="l01051"></a>01051                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(tmpmat, defMats[i]);
<a name="l01052"></a>01052 
<a name="l01053"></a>01053                 <span class="keywordflow">if</span> (!use_quaternion) <span class="comment">/* quaternion already is scale corrected */</span>
<a name="l01054"></a>01054                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a55eec16c2fac66336344b9e7f346fe83">mul_m3_fl</a>(smat, armature_weight/contrib);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a19aaec2780694478b53edec408c38c30">mul_serie_m3</a>(defMats[i], tmpmat, pre, smat, post, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01057"></a>01057             }
<a name="l01058"></a>01058         }
<a name="l01059"></a>01059 
<a name="l01060"></a>01060         <span class="comment">/* always, check above code */</span>
<a name="l01061"></a>01061         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(postmat, co);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="comment">/* interpolate with previous modifier position using weight group */</span>
<a name="l01064"></a>01064         <span class="keywordflow">if</span> (prevCos) {
<a name="l01065"></a>01065             <span class="keywordtype">float</span> mw = 1.0f - prevco_weight;
<a name="l01066"></a>01066             vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] = prevco_weight*vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] + mw*co[0];
<a name="l01067"></a>01067             vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] = prevco_weight*vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] + mw*co[1];
<a name="l01068"></a>01068             vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] = prevco_weight*vertexCos[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] + mw*co[2];
<a name="l01069"></a>01069         }
<a name="l01070"></a>01070     }
<a name="l01071"></a>01071 
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (dualquats)
<a name="l01073"></a>01073         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dualquats);
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (defnrToPC)
<a name="l01075"></a>01075         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(defnrToPC);
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (defnrToPCIndex)
<a name="l01077"></a>01077         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(defnrToPCIndex);
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="comment">/* free B_bone matrices */</span>
<a name="l01080"></a>01080     pdef_info = pdef_info_array;
<a name="l01081"></a>01081     <span class="keywordflow">for</span> (pchan = armOb-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>, pdef_info++) {
<a name="l01082"></a>01082         <span class="keywordflow">if</span> (pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">b_bone_mats</a>)
<a name="l01083"></a>01083             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#ab739d29cf3eb9d76eea47f651a20af22">b_bone_mats</a>);
<a name="l01084"></a>01084         <span class="keywordflow">if</span> (pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">b_bone_dual_quats</a>)
<a name="l01085"></a>01085             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pdef_info-&gt;<a class="code" href="../../df/df4/structbPoseChanDeform.html#aaa68a4791908f3a9010b779393801742">b_bone_dual_quats</a>);
<a name="l01086"></a>01086     }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pdef_info_array);
<a name="l01089"></a>01089 }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091 <span class="comment">/* ************ END Armature Deform ******************* */</span>
<a name="l01092"></a>01092 
<a name="l01093"></a><a class="code" href="../../d9/d2b/armature_8c.html#a9f34a24f8ab1ecad863cf90d2ead1683">01093</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a59b75d934d69ec8873c53a10e5a955a2">get_objectspace_bone_matrix</a>(<span class="keyword">struct</span> <a class="code" href="../../de/de0/structBone.html">Bone</a>* bone, <span class="keywordtype">float</span> M_accumulatedMatrix[][4], <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(root),
<a name="l01094"></a>01094                                  <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(posed))
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(M_accumulatedMatrix, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01097"></a>01097 }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 <span class="comment">/* **************** Space to Space API ****************** */</span>
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="comment">/* Convert World-Space Matrix to Pose-Space Matrix */</span>
<a name="l01102"></a><a class="code" href="../../d9/d2b/armature_8c.html#a3b27e5865b527874006c964919bf9346">01102</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#aa0e5968f6eb65b3a357204a2bb88aa10">armature_mat_world_to_pose</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> inmat[][4], <span class="keywordtype">float</span> outmat[][4])
<a name="l01103"></a>01103 {
<a name="l01104"></a>01104     <span class="keywordtype">float</span> obmat[4][4];
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="comment">/* prevent crashes */</span>
<a name="l01107"></a>01107     <span class="keywordflow">if</span> (ob == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01108"></a>01108         <span class="keywordflow">return</span>;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110     <span class="comment">/* get inverse of (armature) object&#39;s matrix  */</span>
<a name="l01111"></a>01111     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(obmat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <span class="comment">/* multiply given matrix by object&#39;s-inverse to find pose-space matrix */</span>
<a name="l01114"></a>01114     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(outmat, inmat, obmat);
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117 <span class="comment">/* Convert World-Space Location to Pose-Space Location</span>
<a name="l01118"></a>01118 <span class="comment"> * NOTE: this cannot be used to convert to pose-space location of the supplied</span>
<a name="l01119"></a>01119 <span class="comment"> *       pose-channel into its local space (i.e. &#39;visual&#39;-keyframing) */</span>
<a name="l01120"></a><a class="code" href="../../d9/d2b/armature_8c.html#a73dcaccc40ecb2e35f45997b73656cdf">01120</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#ab7bf8f232608d4f9cebaa23b0c8c3c87">armature_loc_world_to_pose</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">const</span> <span class="keywordtype">float</span> inloc[3], <span class="keywordtype">float</span> outloc[3])
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122     <span class="keywordtype">float</span> xLocMat[4][4] = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l01123"></a>01123     <span class="keywordtype">float</span> nLocMat[4][4];
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">/* build matrix for location */</span>
<a name="l01126"></a>01126     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(xLocMat[3], inloc);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     <span class="comment">/* get bone-space cursor matrix and extract location */</span>
<a name="l01129"></a>01129     <a class="code" href="../../da/d17/BKE__armature_8h.html#aa0e5968f6eb65b3a357204a2bb88aa10">armature_mat_world_to_pose</a>(ob, xLocMat, nLocMat);
<a name="l01130"></a>01130     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(outloc, nLocMat[3]);
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 <span class="comment">/* Simple helper, computes the offset bone matrix.</span>
<a name="l01134"></a>01134 <span class="comment"> *     offs_bone = yoffs(b-1) + root(b) + bonemat(b).</span>
<a name="l01135"></a>01135 <span class="comment"> * Not exported, as it is only used in this file currently... */</span>
<a name="l01136"></a><a class="code" href="../../d9/d2b/armature_8c.html#ab2a596b20b25ff0fdf68f068201053f6">01136</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#ab2a596b20b25ff0fdf68f068201053f6">get_offset_bone_mat</a>(<a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <span class="keywordtype">float</span> offs_bone[][4])
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138     <span class="keywordflow">if</span> (!bone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>)
<a name="l01139"></a>01139         <span class="keywordflow">return</span>;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141     <span class="comment">/* Bone transform itself. */</span>
<a name="l01142"></a>01142     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(offs_bone, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l01143"></a>01143 
<a name="l01144"></a>01144     <span class="comment">/* The bone&#39;s root offset (is in the parent&#39;s coordinate system). */</span>
<a name="l01145"></a>01145     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(offs_bone[3], bone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>);
<a name="l01146"></a>01146 
<a name="l01147"></a>01147     <span class="comment">/* Get the length translation of parent (length along y axis). */</span>
<a name="l01148"></a>01148     offs_bone[3][1] += bone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l01149"></a>01149 }
<a name="l01150"></a>01150 
<a name="l01151"></a>01151 <span class="comment">/* Construct the matrices (rot/scale and loc) to apply the PoseChannels into the armature (object) space.</span>
<a name="l01152"></a>01152 <span class="comment"> * I.e. (roughly) the &quot;pose_mat(b-1) * yoffs(b-1) * d_root(b) * bone_mat(b)&quot; in the</span>
<a name="l01153"></a>01153 <span class="comment"> *     pose_mat(b)= pose_mat(b-1) * yoffs(b-1) * d_root(b) * bone_mat(b) * chan_mat(b)</span>
<a name="l01154"></a>01154 <span class="comment"> * ...function.</span>
<a name="l01155"></a>01155 <span class="comment"> *</span>
<a name="l01156"></a>01156 <span class="comment"> * This allows to get the transformations of a bone in its object space, *before* constraints (and IK)</span>
<a name="l01157"></a>01157 <span class="comment"> * get applied (used by pose evaluation code).</span>
<a name="l01158"></a>01158 <span class="comment"> * And reverse: to find pchan transformations needed to place a bone at a given loc/rot/scale</span>
<a name="l01159"></a>01159 <span class="comment"> * in object space (used by interactive transform, and snapping code).</span>
<a name="l01160"></a>01160 <span class="comment"> *</span>
<a name="l01161"></a>01161 <span class="comment"> * Note that, with the HINGE/NO_SCALE/NO_LOCAL_LOCATION options, the location matrix</span>
<a name="l01162"></a>01162 <span class="comment"> * will differ from the rotation/scale matrix...</span>
<a name="l01163"></a>01163 <span class="comment"> *</span>
<a name="l01164"></a>01164 <span class="comment"> * NOTE: This cannot be used to convert to pose-space transforms of the supplied</span>
<a name="l01165"></a>01165 <span class="comment"> *       pose-channel into its local space (i.e. &#39;visual&#39;-keyframing).</span>
<a name="l01166"></a>01166 <span class="comment"> *       (note: I don&#39;t understand that, so I keep it :p --mont29).</span>
<a name="l01167"></a>01167 <span class="comment"> */</span>
<a name="l01168"></a><a class="code" href="../../d9/d2b/armature_8c.html#a192afebd72c3c72d5f54c33763f3d6e5">01168</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#ac39d3579212f71cac3e7deb7697273dc">pchan_to_pose_mat</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> rotscale_mat[][4], <span class="keywordtype">float</span> loc_mat[][4])
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, *parbone;
<a name="l01171"></a>01171     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *parchan;
<a name="l01172"></a>01172 
<a name="l01173"></a>01173     <span class="comment">/* set up variables for quicker access below */</span>
<a name="l01174"></a>01174     bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l01175"></a>01175     parbone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#a58c27a1e1006b66e5912c2803271cf5c">parent</a>;
<a name="l01176"></a>01176     parchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keywordflow">if</span> (parchan) {
<a name="l01179"></a>01179         <span class="keywordtype">float</span> offs_bone[4][4];
<a name="l01180"></a>01180         <span class="comment">/* yoffs(b-1) + root(b) + bonemat(b). */</span>
<a name="l01181"></a>01181         <a class="code" href="../../d9/d2b/armature_8c.html#ab2a596b20b25ff0fdf68f068201053f6">get_offset_bone_mat</a>(bone, offs_bone);
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         <span class="comment">/* Compose the rotscale matrix for this bone. */</span>
<a name="l01184"></a>01184         <span class="keywordflow">if</span> ((bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>) &amp;&amp; (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>)) {
<a name="l01185"></a>01185             <span class="comment">/* Parent rest rotation and scale. */</span>
<a name="l01186"></a>01186             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rotscale_mat, parbone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, offs_bone);
<a name="l01187"></a>01187         }
<a name="l01188"></a>01188         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>) {
<a name="l01189"></a>01189             <span class="comment">/* Parent rest rotation and pose scale. */</span>
<a name="l01190"></a>01190             <span class="keywordtype">float</span> tmat[4][4], tscale[3];
<a name="l01191"></a>01191 
<a name="l01192"></a>01192             <span class="comment">/* Extract the scale of the parent pose matrix. */</span>
<a name="l01193"></a>01193             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a245c1bf7630bef5c065994ea56751d21">mat4_to_size</a>(tscale, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01194"></a>01194             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8a7511e7f02ac7530280787b7dd5597b">size_to_mat4</a>(tmat, tscale);
<a name="l01195"></a>01195 
<a name="l01196"></a>01196             <span class="comment">/* Applies the parent pose scale to the rest matrix. */</span>
<a name="l01197"></a>01197             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(tmat, tmat, parbone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rotscale_mat, tmat, offs_bone);
<a name="l01200"></a>01200         }
<a name="l01201"></a>01201         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>) {
<a name="l01202"></a>01202             <span class="comment">/* Parent pose rotation and rest scale (i.e. no scaling). */</span>
<a name="l01203"></a>01203             <span class="keywordtype">float</span> tmat[4][4];
<a name="l01204"></a>01204             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmat, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01205"></a>01205             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(tmat);
<a name="l01206"></a>01206             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rotscale_mat, tmat, offs_bone);
<a name="l01207"></a>01207         }
<a name="l01208"></a>01208         <span class="keywordflow">else</span>
<a name="l01209"></a>01209             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rotscale_mat, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, offs_bone);
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="preprocessor"># if 1</span>
<a name="l01212"></a>01212 <span class="preprocessor"></span>        <span class="comment">/* Compose the loc matrix for this bone. */</span>
<a name="l01213"></a>01213         <span class="comment">/* NOTE: That version deos not modify bone&#39;s loc when HINGE/NO_SCALE options are set. */</span>
<a name="l01214"></a>01214 
<a name="l01215"></a>01215         <span class="comment">/* In this case, use the object&#39;s space *orientation*. */</span>
<a name="l01216"></a>01216         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a96060fca6e8491d622e98f7644d98b17">BONE_NO_LOCAL_LOCATION</a>) {
<a name="l01217"></a>01217             <span class="comment">/* XXX I&#39;m sure that code can be simplified! */</span>
<a name="l01218"></a>01218             <span class="keywordtype">float</span> bone_loc[4][4], bone_rotscale[3][3], tmat4[4][4], tmat3[3][3];
<a name="l01219"></a>01219             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(bone_loc);
<a name="l01220"></a>01220             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(loc_mat);
<a name="l01221"></a>01221             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(tmat4);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(bone_loc[3], parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, offs_bone[3]);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(bone_rotscale);
<a name="l01226"></a>01226             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(tmat3, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01227"></a>01227             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(bone_rotscale, tmat3, bone_rotscale);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(tmat4, bone_rotscale);
<a name="l01230"></a>01230             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(loc_mat, bone_loc, tmat4);
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232         <span class="comment">/* Those flags do not affect position, use plain parent transform space! */</span>
<a name="l01233"></a>01233         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>)) {
<a name="l01234"></a>01234             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(loc_mat, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, offs_bone);
<a name="l01235"></a>01235         }
<a name="l01236"></a>01236         <span class="comment">/* Else (i.e. default, usual case), just use the same matrix for rotation/scaling, and location. */</span>
<a name="l01237"></a>01237         <span class="keywordflow">else</span>
<a name="l01238"></a>01238             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(loc_mat, rotscale_mat);
<a name="l01239"></a>01239 <span class="preprocessor"># endif</span>
<a name="l01240"></a>01240 <span class="preprocessor"></span><span class="preprocessor"># if 0</span>
<a name="l01241"></a>01241 <span class="preprocessor"></span>        <span class="comment">/* Compose the loc matrix for this bone. */</span>
<a name="l01242"></a>01242         <span class="comment">/* NOTE: That version modifies bone&#39;s loc when HINGE/NO_SCALE options are set. */</span>
<a name="l01243"></a>01243 
<a name="l01244"></a>01244         <span class="comment">/* In these cases we need to compute location separately */</span>
<a name="l01245"></a>01245         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; (<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>|<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a96060fca6e8491d622e98f7644d98b17">BONE_NO_LOCAL_LOCATION</a>)) {
<a name="l01246"></a>01246             <span class="keywordtype">float</span> bone_loc[4][4], bone_rotscale[3][3], tmat4[4][4], tmat3[3][3];
<a name="l01247"></a>01247             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(bone_loc);
<a name="l01248"></a>01248             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(loc_mat);
<a name="l01249"></a>01249             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(tmat4);
<a name="l01250"></a>01250 
<a name="l01251"></a>01251             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(bone_loc[3], parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, offs_bone[3]);
<a name="l01252"></a>01252 
<a name="l01253"></a>01253             <span class="comment">/* &quot;No local location&quot; is not transformed by bone matrix. */</span>
<a name="l01254"></a>01254             <span class="comment">/* This only affects orientations (rotations), as scale is always 1.0 here. */</span>
<a name="l01255"></a>01255             <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a96060fca6e8491d622e98f7644d98b17">BONE_NO_LOCAL_LOCATION</a>)
<a name="l01256"></a>01256                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(bone_rotscale);
<a name="l01257"></a>01257             <span class="keywordflow">else</span>
<a name="l01258"></a>01258                 <span class="comment">/* We could also use bone-&gt;bone_mat directly, here... */</span>
<a name="l01259"></a>01259                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(bone_rotscale, offs_bone);
<a name="l01260"></a>01260 
<a name="l01261"></a>01261             <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50aef3f108a1769ded5a8e4f8db09fea47a">BONE_HINGE</a>) {
<a name="l01262"></a>01262                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(tmat3, parbone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01263"></a>01263                 <span class="comment">/* for hinge-only, we use armature *rotation*, but pose mat *scale*! */</span>
<a name="l01264"></a>01264                 <span class="keywordflow">if</span> (!(bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>)) {
<a name="l01265"></a>01265                     <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[3], tsmat[3][3];
<a name="l01266"></a>01266                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a245c1bf7630bef5c065994ea56751d21">mat4_to_size</a>(size, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01267"></a>01267                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a32ceca78461c61d0dbda46632ccb0f8f">size_to_mat3</a>(tsmat, size);
<a name="l01268"></a>01268                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(tmat3, tsmat, tmat3);
<a name="l01269"></a>01269                 }
<a name="l01270"></a>01270                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(bone_rotscale, tmat3, bone_rotscale);
<a name="l01271"></a>01271             }
<a name="l01272"></a>01272             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50acdb43b3d6a3910f883d88922b25ca2bf">BONE_NO_SCALE</a>) {
<a name="l01273"></a>01273                 <span class="comment">/* For no-scale only, normalized parent pose mat is enough! */</span>
<a name="l01274"></a>01274                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(tmat3, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01275"></a>01275                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(tmat3);
<a name="l01276"></a>01276                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(bone_rotscale, tmat3, bone_rotscale);
<a name="l01277"></a>01277             }
<a name="l01278"></a>01278             <span class="comment">/* NO_LOCAL_LOCATION only. */</span>
<a name="l01279"></a>01279             <span class="keywordflow">else</span> {
<a name="l01280"></a>01280                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(tmat3, parchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l01281"></a>01281                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(bone_rotscale, tmat3, bone_rotscale);
<a name="l01282"></a>01282             }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(tmat4, bone_rotscale);
<a name="l01285"></a>01285             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(loc_mat, bone_loc, tmat4);
<a name="l01286"></a>01286         }
<a name="l01287"></a>01287         <span class="comment">/* Else, just use the same matrix for rotation/scaling, and location. */</span>
<a name="l01288"></a>01288         <span class="keywordflow">else</span>
<a name="l01289"></a>01289             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(loc_mat, rotscale_mat);
<a name="l01290"></a>01290 <span class="preprocessor"># endif</span>
<a name="l01291"></a>01291 <span class="preprocessor"></span>    }
<a name="l01292"></a>01292     <span class="comment">/* Root bones. */</span>
<a name="l01293"></a>01293     <span class="keywordflow">else</span> {
<a name="l01294"></a>01294         <span class="comment">/* Rotation/scaling. */</span>
<a name="l01295"></a>01295         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rotscale_mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l01296"></a>01296         <span class="comment">/* Translation. */</span>
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a96060fca6e8491d622e98f7644d98b17">BONE_NO_LOCAL_LOCATION</a>) {
<a name="l01298"></a>01298             <span class="comment">/* Translation of arm_mat, without the rotation. */</span>
<a name="l01299"></a>01299             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(loc_mat);
<a name="l01300"></a>01300             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc_mat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>[3]);
<a name="l01301"></a>01301         }
<a name="l01302"></a>01302         <span class="keywordflow">else</span>
<a name="l01303"></a>01303             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(loc_mat, rotscale_mat);
<a name="l01304"></a>01304     }
<a name="l01305"></a>01305 }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 <span class="comment">/* Convert Pose-Space Matrix to Bone-Space Matrix.</span>
<a name="l01308"></a>01308 <span class="comment"> * NOTE: this cannot be used to convert to pose-space transforms of the supplied</span>
<a name="l01309"></a>01309 <span class="comment"> *       pose-channel into its local space (i.e. &#39;visual&#39;-keyframing) */</span>
<a name="l01310"></a><a class="code" href="../../d9/d2b/armature_8c.html#a4c517e2e7ef22699a4abf6193fd4aa3f">01310</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a19c11057e9bea9a3bff4dcaa8b7d0063">armature_mat_pose_to_bone</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> inmat[][4], <span class="keywordtype">float</span> outmat[][4])
<a name="l01311"></a>01311 {
<a name="l01312"></a>01312     <span class="keywordtype">float</span> rotscale_mat[4][4], loc_mat[4][4], inmat_[4][4];
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     <span class="comment">/* Security, this allows to call with inmat == outmat! */</span>
<a name="l01315"></a>01315     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(inmat_, inmat);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <a class="code" href="../../da/d17/BKE__armature_8h.html#ac39d3579212f71cac3e7deb7697273dc">pchan_to_pose_mat</a>(pchan, rotscale_mat, loc_mat);
<a name="l01318"></a>01318     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a64a4f057663e6d9174264739ac12fd34">invert_m4</a>(rotscale_mat);
<a name="l01319"></a>01319     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a64a4f057663e6d9174264739ac12fd34">invert_m4</a>(loc_mat);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(outmat, rotscale_mat, inmat_);
<a name="l01322"></a>01322     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(outmat[3], loc_mat, inmat_[3]);
<a name="l01323"></a>01323 }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325 <span class="comment">/* Convert Bone-Space Matrix to Pose-Space Matrix. */</span>
<a name="l01326"></a><a class="code" href="../../d9/d2b/armature_8c.html#a28cc92c5e1ca02ddf47227c637405dff">01326</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#aeb07e5cf42aa6166af08341ecf116f03">armature_mat_bone_to_pose</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> inmat[][4], <span class="keywordtype">float</span> outmat[][4])
<a name="l01327"></a>01327 {
<a name="l01328"></a>01328     <span class="keywordtype">float</span> rotscale_mat[4][4], loc_mat[4][4], inmat_[4][4];
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="comment">/* Security, this allows to call with inmat == outmat! */</span>
<a name="l01331"></a>01331     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(inmat_, inmat);
<a name="l01332"></a>01332 
<a name="l01333"></a>01333     <a class="code" href="../../da/d17/BKE__armature_8h.html#ac39d3579212f71cac3e7deb7697273dc">pchan_to_pose_mat</a>(pchan, rotscale_mat, loc_mat);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(outmat, rotscale_mat, inmat_);
<a name="l01336"></a>01336     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(outmat[3], loc_mat, inmat_[3]);
<a name="l01337"></a>01337 }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339 <span class="comment">/* Convert Pose-Space Location to Bone-Space Location</span>
<a name="l01340"></a>01340 <span class="comment"> * NOTE: this cannot be used to convert to pose-space location of the supplied</span>
<a name="l01341"></a>01341 <span class="comment"> *       pose-channel into its local space (i.e. &#39;visual&#39;-keyframing) */</span>
<a name="l01342"></a><a class="code" href="../../d9/d2b/armature_8c.html#ad20c3b98783778c145c5d70c9cdb62f1">01342</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a691955cf12c488503f420770cc11c11d">armature_loc_pose_to_bone</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keyword">const</span> <span class="keywordtype">float</span> inloc[3], <span class="keywordtype">float</span> outloc[3])
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <span class="keywordtype">float</span> xLocMat[4][4] = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l01345"></a>01345     <span class="keywordtype">float</span> nLocMat[4][4];
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <span class="comment">/* build matrix for location */</span>
<a name="l01348"></a>01348     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(xLocMat[3], inloc);
<a name="l01349"></a>01349 
<a name="l01350"></a>01350     <span class="comment">/* get bone-space cursor matrix and extract location */</span>
<a name="l01351"></a>01351     <a class="code" href="../../da/d17/BKE__armature_8h.html#a19c11057e9bea9a3bff4dcaa8b7d0063">armature_mat_pose_to_bone</a>(pchan, xLocMat, nLocMat);
<a name="l01352"></a>01352     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(outloc, nLocMat[3]);
<a name="l01353"></a>01353 }
<a name="l01354"></a>01354 
<a name="l01355"></a><a class="code" href="../../d9/d2b/armature_8c.html#a267444f205ac9fb5ccce60acb32df5e3">01355</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a65de3bcb801a5d105d8b2ac2fdb340a0">armature_mat_pose_to_bone_ex</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> inmat[][4], <span class="keywordtype">float</span> outmat[][4])
<a name="l01356"></a>01356 {
<a name="l01357"></a>01357     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> work_pchan = *pchan;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     <span class="comment">/* recalculate pose matrix with only parent transformations,</span>
<a name="l01360"></a>01360 <span class="comment">     * bone loc/sca/rot is ignored, scene and frame are not used. */</span>
<a name="l01361"></a>01361     <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob, &amp;work_pchan, 0.0f, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="comment">/* find the matrix, need to remove the bone transforms first so this is</span>
<a name="l01364"></a>01364 <span class="comment">     * calculated as a matrix to set rather then a difference ontop of whats</span>
<a name="l01365"></a>01365 <span class="comment">     * already there. */</span>
<a name="l01366"></a>01366     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(outmat);
<a name="l01367"></a>01367     <a class="code" href="../../da/d17/BKE__armature_8h.html#ae95841a135f2f83613e8ba5ee479ad88">pchan_apply_mat4</a>(&amp;work_pchan, outmat, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369     <a class="code" href="../../da/d17/BKE__armature_8h.html#a19c11057e9bea9a3bff4dcaa8b7d0063">armature_mat_pose_to_bone</a>(&amp;work_pchan, inmat, outmat);
<a name="l01370"></a>01370 }
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 <span class="comment">/* same as object_mat3_to_rot() */</span>
<a name="l01373"></a><a class="code" href="../../d9/d2b/armature_8c.html#a34b3d2a421535c1748b8ff89d6d9a4f8">01373</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#ae57c1772a2212dddd16279b937b6d65a">pchan_mat3_to_rot</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> mat[][3], <span class="keywordtype">short</span> use_compat)
<a name="l01374"></a>01374 {
<a name="l01375"></a>01375     <span class="keywordflow">switch</span>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a>) {
<a name="l01376"></a>01376         <span class="keywordflow">case</span> <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>:
<a name="l01377"></a>01377             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a176f538ccb9db7cc95d7699264508b26">mat3_to_quat</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>, mat);
<a name="l01378"></a>01378             <span class="keywordflow">break</span>;
<a name="l01379"></a>01379         <span class="keywordflow">case</span> <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>:
<a name="l01380"></a>01380             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a12d9c8cea99f44ca2e4ec8fab0cf6f24">mat3_to_axis_angle</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>, mat);
<a name="l01381"></a>01381             <span class="keywordflow">break</span>;
<a name="l01382"></a>01382         <span class="keywordflow">default</span>: <span class="comment">/* euler */</span>
<a name="l01383"></a>01383             <span class="keywordflow">if</span> (use_compat)
<a name="l01384"></a>01384                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aecda43d4ff738267956af5f39ac70681">mat3_to_compatible_eulO</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a>, mat);
<a name="l01385"></a>01385             <span class="keywordflow">else</span>
<a name="l01386"></a>01386                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a6e14075421e1717d96f46dbb3a30afed">mat3_to_eulO</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a>, mat);
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 <span class="comment">/* Apply a 4x4 matrix to the pose bone,</span>
<a name="l01391"></a>01391 <span class="comment"> * similar to object_apply_mat4() */</span>
<a name="l01392"></a><a class="code" href="../../d9/d2b/armature_8c.html#a622db1f9f0343178a7be27707b4c33d8">01392</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#ae95841a135f2f83613e8ba5ee479ad88">pchan_apply_mat4</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">short</span> use_compat)
<a name="l01393"></a>01393 {
<a name="l01394"></a>01394     <span class="keywordtype">float</span> <a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>[3][3];
<a name="l01395"></a>01395     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2626c6f2192bb7a832177be746dc9f08">mat4_to_loc_rot_size</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>, rot, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>, mat);
<a name="l01396"></a>01396     <a class="code" href="../../da/d17/BKE__armature_8h.html#ae57c1772a2212dddd16279b937b6d65a">pchan_mat3_to_rot</a>(pchan, rot, use_compat);
<a name="l01397"></a>01397 }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399 <span class="comment">/* Remove rest-position effects from pose-transform for obtaining</span>
<a name="l01400"></a>01400 <span class="comment"> * &#39;visual&#39; transformation of pose-channel.</span>
<a name="l01401"></a>01401 <span class="comment"> * (used by the Visual-Keyframing stuff) */</span>
<a name="l01402"></a><a class="code" href="../../d9/d2b/armature_8c.html#a41a5a38af9d519f39416726796e5914e">01402</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a41a5a38af9d519f39416726796e5914e">armature_mat_pose_to_delta</a>(<span class="keywordtype">float</span> delta_mat[][4], <span class="keywordtype">float</span> pose_mat[][4], <span class="keywordtype">float</span> arm_mat[][4])
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404     <span class="keywordtype">float</span> imat[4][4];
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, arm_mat);
<a name="l01407"></a>01407     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(delta_mat, imat, pose_mat);
<a name="l01408"></a>01408 }
<a name="l01409"></a>01409 
<a name="l01410"></a>01410 <span class="comment">/* **************** Rotation Mode Conversions ****************************** */</span>
<a name="l01411"></a>01411 <span class="comment">/* Used for Objects and Pose Channels, since both can have multiple rotation representations */</span>
<a name="l01412"></a>01412 
<a name="l01413"></a>01413 <span class="comment">/* Called from RNA when rotation mode changes</span>
<a name="l01414"></a>01414 <span class="comment"> * - the result should be that the rotations given in the provided pointers have had conversions</span>
<a name="l01415"></a>01415 <span class="comment"> *   applied (as appropriate), such that the rotation of the element hasn&#39;t &#39;visually&#39; changed  */</span>
<a name="l01416"></a><a class="code" href="../../d9/d2b/armature_8c.html#aa3fb08f7fe5905a0d3ae7ab1dba71290">01416</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#aa3fb08f7fe5905a0d3ae7ab1dba71290">BKE_rotMode_change_values</a> (<span class="keywordtype">float</span> quat[4], <span class="keywordtype">float</span> eul[3], <span class="keywordtype">float</span> axis[3], <span class="keywordtype">float</span> *<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, <span class="keywordtype">short</span> oldMode, <span class="keywordtype">short</span> newMode)
<a name="l01417"></a>01417 {
<a name="l01418"></a>01418     <span class="comment">/* check if any change - if so, need to convert data */</span>
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (newMode &gt; 0) { <span class="comment">/* to euler */</span>
<a name="l01420"></a>01420         <span class="keywordflow">if</span> (oldMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l01421"></a>01421             <span class="comment">/* axis-angle to euler */</span>
<a name="l01422"></a>01422             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa12d17f2566056509d7d2eeb880496d9">axis_angle_to_eulO</a>( eul, newMode,axis, *angle);
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (oldMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l01425"></a>01425             <span class="comment">/* quat to euler */</span>
<a name="l01426"></a>01426             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(quat);
<a name="l01427"></a>01427             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a05f9762601cd080564da744ec893f13e">quat_to_eulO</a>(eul, newMode,quat);
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429         <span class="comment">/* else { no conversion needed } */</span>
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) { <span class="comment">/* to quat */</span>
<a name="l01432"></a>01432         <span class="keywordflow">if</span> (oldMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l01433"></a>01433             <span class="comment">/* axis angle to quat */</span>
<a name="l01434"></a>01434             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a31e0d088e5faae71dd3e9e4232f7c2a5">axis_angle_to_quat</a>(quat, axis, *angle);
<a name="l01435"></a>01435         }
<a name="l01436"></a>01436         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (oldMode &gt; 0) {
<a name="l01437"></a>01437             <span class="comment">/* euler to quat */</span>
<a name="l01438"></a>01438             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a34ccd61e6c7a8438477b35c2242c43a5">eulO_to_quat</a>(quat, eul, oldMode);
<a name="l01439"></a>01439         }
<a name="l01440"></a>01440         <span class="comment">/* else { no conversion needed } */</span>
<a name="l01441"></a>01441     }
<a name="l01442"></a>01442     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) { <span class="comment">/* to axis-angle */</span>
<a name="l01443"></a>01443         <span class="keywordflow">if</span> (oldMode &gt; 0) {
<a name="l01444"></a>01444             <span class="comment">/* euler to axis angle */</span>
<a name="l01445"></a>01445             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a3b7c5f2e7add29b1531d78cab51baefd">eulO_to_axis_angle</a>(axis, angle, eul, oldMode);
<a name="l01446"></a>01446         }
<a name="l01447"></a>01447         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (oldMode == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca3fd6f41388cbe0f034332712de0e0798">ROT_MODE_QUAT</a>) {
<a name="l01448"></a>01448             <span class="comment">/* quat to axis angle */</span>
<a name="l01449"></a>01449             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(quat);
<a name="l01450"></a>01450             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a95e79b80f962335b7165103f7f0f12bf">quat_to_axis_angle</a>(axis, angle, quat);
<a name="l01451"></a>01451         }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453         <span class="comment">/* when converting to axis-angle, we need a special exception for the case when there is no axis */</span>
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(axis[0], axis[1]) &amp;&amp; <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#acc074658bb6b51cde503721347a81b33">IS_EQF</a>(axis[1], axis[2])) {
<a name="l01455"></a>01455             <span class="comment">/* for now, rotate around y-axis then (so that it simply becomes the roll) */</span>
<a name="l01456"></a>01456             axis[1] = 1.0f;
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459 }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461 <span class="comment">/* **************** The new &amp; simple (but OK!) armature evaluation ********* */</span>
<a name="l01462"></a>01462 
<a name="l01463"></a>01463 <span class="comment">/* ****************** And how it works! ****************************************</span>
<a name="l01464"></a>01464 <span class="comment"> *</span>
<a name="l01465"></a>01465 <span class="comment"> * This is the bone transformation trick; they&#39;re hierarchical so each bone(b)</span>
<a name="l01466"></a>01466 <span class="comment"> * is in the coord system of bone(b-1):</span>
<a name="l01467"></a>01467 <span class="comment"> *</span>
<a name="l01468"></a>01468 <span class="comment"> * arm_mat(b)= arm_mat(b-1) * yoffs(b-1) * d_root(b) * bone_mat(b)</span>
<a name="l01469"></a>01469 <span class="comment"> *</span>
<a name="l01470"></a>01470 <span class="comment"> * -&gt; yoffs is just the y axis translation in parent&#39;s coord system</span>
<a name="l01471"></a>01471 <span class="comment"> * -&gt; d_root is the translation of the bone root, also in parent&#39;s coord system</span>
<a name="l01472"></a>01472 <span class="comment"> *</span>
<a name="l01473"></a>01473 <span class="comment"> * pose_mat(b)= pose_mat(b-1) * yoffs(b-1) * d_root(b) * bone_mat(b) * chan_mat(b)</span>
<a name="l01474"></a>01474 <span class="comment"> *</span>
<a name="l01475"></a>01475 <span class="comment"> * we then - in init deform - store the deform in chan_mat, such that:</span>
<a name="l01476"></a>01476 <span class="comment"> *</span>
<a name="l01477"></a>01477 <span class="comment"> * pose_mat(b)= arm_mat(b) * chan_mat(b)</span>
<a name="l01478"></a>01478 <span class="comment"> *</span>
<a name="l01479"></a>01479 <span class="comment"> * *************************************************************************** */</span>
<a name="l01480"></a>01480 <span class="comment">/* Computes vector and roll based on a rotation.</span>
<a name="l01481"></a>01481 <span class="comment"> * &quot;mat&quot; must contain only a rotation, and no scaling. */</span>
<a name="l01482"></a><a class="code" href="../../d9/d2b/armature_8c.html#a6539e8802d157a5e5d69784f01ec4f07">01482</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a2b53ce3fca660bd148f0e11b7d9692fd">mat3_to_vec_roll</a>(<span class="keywordtype">float</span> mat[][3], <span class="keywordtype">float</span> vec[3], <span class="keywordtype">float</span> *roll)
<a name="l01483"></a>01483 {
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (vec)
<a name="l01485"></a>01485         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, mat[1]);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (roll) {
<a name="l01488"></a>01488         <span class="keywordtype">float</span> vecmat[3][3], vecmatinv[3][3], rollmat[3][3];
<a name="l01489"></a>01489 
<a name="l01490"></a>01490         <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(mat[1], 0.0f, vecmat);
<a name="l01491"></a>01491         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(vecmatinv, vecmat);
<a name="l01492"></a>01492         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(rollmat, vecmatinv, mat);
<a name="l01493"></a>01493 
<a name="l01494"></a>01494         *roll = (float)<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(rollmat[2][0], rollmat[2][2]);
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 <span class="comment">/* Calculates the rest matrix of a bone based</span>
<a name="l01499"></a>01499 <span class="comment"> * On its vector and a roll around that vector */</span>
<a name="l01500"></a><a class="code" href="../../d9/d2b/armature_8c.html#a24d92cba75e0d425fe55e2cae9497e79">01500</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keyword">const</span> <span class="keywordtype">float</span> roll, <span class="keywordtype">float</span> mat[][3])
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502     <span class="keywordtype">float</span> nor[3], axis[3], target[3] = {0, 1, 0};
<a name="l01503"></a>01503     <span class="keywordtype">float</span> theta;
<a name="l01504"></a>01504     <span class="keywordtype">float</span> rMatrix[3][3], bMatrix[3][3];
<a name="l01505"></a>01505 
<a name="l01506"></a>01506     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(nor, vec);
<a name="l01507"></a>01507 
<a name="l01508"></a>01508     <span class="comment">/* Find Axis &amp; Amount for bone matrix */</span>
<a name="l01509"></a>01509     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(axis, target, nor);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="comment">/* was 0.0000000000001, caused bug [#23954], smaller values give unstable</span>
<a name="l01512"></a>01512 <span class="comment">     * roll when toggling editmode.</span>
<a name="l01513"></a>01513 <span class="comment">     *</span>
<a name="l01514"></a>01514 <span class="comment">     * was 0.00001, causes bug [#27675], with 0.00000495,</span>
<a name="l01515"></a>01515 <span class="comment">     * so a value inbetween these is needed.</span>
<a name="l01516"></a>01516 <span class="comment">     *</span>
<a name="l01517"></a>01517 <span class="comment">     * was 0.000001, causes bug [#30438] (which is same as [#27675, imho).</span>
<a name="l01518"></a>01518 <span class="comment">     * Reseting it to org value seems to cause no more [#23954]...</span>
<a name="l01519"></a>01519 <span class="comment">     */</span>
<a name="l01520"></a>01520     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(axis,axis) &gt; 1.0e-13f) {
<a name="l01521"></a>01521         <span class="comment">/* if nor is *not* a multiple of target ... */</span>
<a name="l01522"></a>01522         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(axis);
<a name="l01523"></a>01523 
<a name="l01524"></a>01524         theta = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a4a2003033c639cab3de101b1cfe7a595">angle_normalized_v3v3</a>(target, nor);
<a name="l01525"></a>01525 
<a name="l01526"></a>01526         <span class="comment">/* Make Bone matrix*/</span>
<a name="l01527"></a>01527         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a46606cf0bbd44c8a610848bfdaf685c0">vec_rot_to_mat3</a>(bMatrix, axis, theta);
<a name="l01528"></a>01528     }
<a name="l01529"></a>01529     <span class="keywordflow">else</span> {
<a name="l01530"></a>01530         <span class="comment">/* if nor is a multiple of target ... */</span>
<a name="l01531"></a>01531         <span class="keywordtype">float</span> updown;
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         <span class="comment">/* point same direction, or opposite? */</span>
<a name="l01534"></a>01534         updown = (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(target,nor) &gt; 0) ? 1.0f : -1.0f;
<a name="l01535"></a>01535 
<a name="l01536"></a>01536         <span class="comment">/* I think this should work... */</span>
<a name="l01537"></a>01537         bMatrix[0][0] = updown; bMatrix[0][1] = 0.0;    bMatrix[0][2] = 0.0;
<a name="l01538"></a>01538         bMatrix[1][0] = 0.0;    bMatrix[1][1] = updown; bMatrix[1][2] = 0.0;
<a name="l01539"></a>01539         bMatrix[2][0] = 0.0;    bMatrix[2][1] = 0.0;    bMatrix[2][2] = 1.0;
<a name="l01540"></a>01540     }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542     <span class="comment">/* Make Roll matrix */</span>
<a name="l01543"></a>01543     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a46606cf0bbd44c8a610848bfdaf685c0">vec_rot_to_mat3</a>(rMatrix, nor, roll);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <span class="comment">/* Combine and output result */</span>
<a name="l01546"></a>01546     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(mat, rMatrix, bMatrix);
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549 
<a name="l01550"></a>01550 <span class="comment">/* recursive part, calculates restposition of entire tree of children */</span>
<a name="l01551"></a>01551 <span class="comment">/* used by exiting editmode too */</span>
<a name="l01552"></a><a class="code" href="../../d9/d2b/armature_8c.html#a40e1c5c7d3de8e4baac4703df1f2a3b4">01552</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a3932f556348bad6a8bd95a6350b5450f">where_is_armature_bone</a>(<a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <a class="code" href="../../de/de0/structBone.html">Bone</a> *prevbone)
<a name="l01553"></a>01553 {
<a name="l01554"></a>01554     <span class="keywordtype">float</span> vec[3];
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     <span class="comment">/* Bone Space */</span>
<a name="l01557"></a>01557     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6a61049fb891cd38380668926819f823">tail</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>);
<a name="l01558"></a>01558     <a class="code" href="../../da/d17/BKE__armature_8h.html#a24d92cba75e0d425fe55e2cae9497e79">vec_roll_to_mat3</a>(vec, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a46729be80412a30d51f792ef291c5d01">roll</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l01559"></a>01559 
<a name="l01560"></a>01560     bone-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6a61049fb891cd38380668926819f823">tail</a>);
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="comment">/* this is called on old file reading too... */</span>
<a name="l01563"></a>01563     <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a69db347b7b06645a732d0660af547d26">xwidth</a> == 0.0f) {
<a name="l01564"></a>01564         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a69db347b7b06645a732d0660af547d26">xwidth</a> = 0.1f;
<a name="l01565"></a>01565         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a48fe605b53ad8762ce588b7d5e868e64">zwidth</a> = 0.1f;
<a name="l01566"></a>01566         bone-&gt;<a class="code" href="../../de/de0/structBone.html#a89302642d3471b43c244fc2c9e85312e">segments</a> = 1;
<a name="l01567"></a>01567     }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     <span class="keywordflow">if</span> (prevbone) {
<a name="l01570"></a>01570         <span class="keywordtype">float</span> offs_bone[4][4];
<a name="l01571"></a>01571         <span class="comment">/* yoffs(b-1) + root(b) + bonemat(b) */</span>
<a name="l01572"></a>01572         <a class="code" href="../../d9/d2b/armature_8c.html#ab2a596b20b25ff0fdf68f068201053f6">get_offset_bone_mat</a>(bone, offs_bone);
<a name="l01573"></a>01573 
<a name="l01574"></a>01574         <span class="comment">/* Compose the matrix for this bone  */</span>
<a name="l01575"></a>01575         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, prevbone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, offs_bone);
<a name="l01576"></a>01576     }
<a name="l01577"></a>01577     <span class="keywordflow">else</span> {
<a name="l01578"></a>01578         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#acd35ed45db5a3d5e7c16567ebc21fc9e">bone_mat</a>);
<a name="l01579"></a>01579         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>[3], bone-&gt;<a class="code" href="../../de/de0/structBone.html#ad54342335a31a46e52585e6c8cea1907">head</a>);
<a name="l01580"></a>01580     }
<a name="l01581"></a>01581 
<a name="l01582"></a>01582     <span class="comment">/* and the kiddies */</span>
<a name="l01583"></a>01583     prevbone = bone;
<a name="l01584"></a>01584     <span class="keywordflow">for</span> (bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bone; bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l01585"></a>01585         <a class="code" href="../../da/d17/BKE__armature_8h.html#a3932f556348bad6a8bd95a6350b5450f">where_is_armature_bone</a>(bone, prevbone);
<a name="l01586"></a>01586     }
<a name="l01587"></a>01587 }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <span class="comment">/* updates vectors and matrices on rest-position level, only needed</span>
<a name="l01590"></a>01590 <span class="comment"> * after editing armature itself, now only on reading file */</span>
<a name="l01591"></a><a class="code" href="../../d9/d2b/armature_8c.html#ab31d80d83f6765b1f53afa676b332386">01591</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a75f672c0ae20fab2d3bc0be46fc17c17">where_is_armature</a>(<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l01592"></a>01592 {
<a name="l01593"></a>01593     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595     <span class="comment">/* hierarchical from root to children */</span>
<a name="l01596"></a>01596     <span class="keywordflow">for</span> (bone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bone; bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l01597"></a>01597         <a class="code" href="../../da/d17/BKE__armature_8h.html#a3932f556348bad6a8bd95a6350b5450f">where_is_armature_bone</a>(bone, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01598"></a>01598     }
<a name="l01599"></a>01599 }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601 <span class="comment">/* if bone layer is protected, copy the data from from-&gt;pose</span>
<a name="l01602"></a>01602 <span class="comment"> * when used with linked libraries this copies from the linked pose into the local pose */</span>
<a name="l01603"></a><a class="code" href="../../d9/d2b/armature_8c.html#ac84d3743413b7d82c06f40a1798cf79c">01603</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#ac84d3743413b7d82c06f40a1798cf79c">pose_proxy_synchronize</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *from, <span class="keywordtype">int</span> layer_protected)
<a name="l01604"></a>01604 {
<a name="l01605"></a>01605     <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, *frompose = from-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l01606"></a>01606     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchanp, pchanw;
<a name="l01607"></a>01607     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *con;
<a name="l01608"></a>01608     <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01609"></a>01609 
<a name="l01610"></a>01610     <span class="keywordflow">if</span> (frompose == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01611"></a>01611         <span class="keywordflow">return</span>;
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="comment">/* in some cases when rigs change, we cant synchronize</span>
<a name="l01614"></a>01614 <span class="comment">     * to avoid crashing check for possible errors here */</span>
<a name="l01615"></a>01615     <span class="keywordflow">for</span> (pchan = pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01616"></a>01616         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a> &amp; layer_protected) {
<a name="l01617"></a>01617             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(frompose, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01618"></a>01618                 printf(<span class="stringliteral">&quot;failed to sync proxy armature because &#39;%s&#39; is missing pose channel &#39;%s&#39;\n&quot;</span>,
<a name="l01619"></a>01619                        from-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l01620"></a>01620                 error = 1;
<a name="l01621"></a>01621             }
<a name="l01622"></a>01622         }
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="keywordflow">if</span> (error)
<a name="l01626"></a>01626         <span class="keywordflow">return</span>;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628     <span class="comment">/* clear all transformation values from library */</span>
<a name="l01629"></a>01629     <a class="code" href="../../d8/df5/BKE__action_8h.html#a4fd8f1724c534f7777be90116365ddfd">rest_pose</a>(frompose);
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="comment">/* copy over all of the proxy&#39;s bone groups */</span>
<a name="l01632"></a>01632         <span class="comment">/* TODO for later</span>
<a name="l01633"></a>01633 <span class="comment">         * - implement &#39;local&#39; bone groups as for constraints</span>
<a name="l01634"></a>01634 <span class="comment">         * Note: this isn&#39;t trivial, as bones reference groups by index not by pointer,</span>
<a name="l01635"></a>01635 <span class="comment">         *       so syncing things correctly needs careful attention */</span>
<a name="l01636"></a>01636     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a60a155dd4019f3ee9a94c624589701ce">agroups</a>);
<a name="l01637"></a>01637     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#abc6ab715e5696ec3bb40014fc55182c6">BLI_duplicatelist</a>(&amp;pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a60a155dd4019f3ee9a94c624589701ce">agroups</a>, &amp;frompose-&gt;agroups);
<a name="l01638"></a>01638     pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a6fb98a9bd0cdc015572d09d8c0a921b0">active_group</a> = frompose-&gt;active_group;
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <span class="keywordflow">for</span> (pchan = pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01641"></a>01641         pchanp = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(frompose, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l01642"></a>01642 
<a name="l01643"></a>01643         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a> &amp; layer_protected) {
<a name="l01644"></a>01644             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> proxylocal_constraints = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01645"></a>01645 
<a name="l01646"></a>01646             <span class="comment">/* copy posechannel to temp, but restore important pointers */</span>
<a name="l01647"></a>01647             pchanw = *pchanp;
<a name="l01648"></a>01648             pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a70f0584633907a38f8acb51f4420c3dd">prev</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a70f0584633907a38f8acb51f4420c3dd">prev</a>;
<a name="l01649"></a>01649             pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>;
<a name="l01650"></a>01650             pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>;
<a name="l01651"></a>01651             pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#ad63dea990fc5ac499625f4d9ef570de9">child</a> = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad63dea990fc5ac499625f4d9ef570de9">child</a>;
<a name="l01652"></a>01652 
<a name="l01653"></a>01653             <span class="comment">/* this is freed so copy a copy, else undo crashes */</span>
<a name="l01654"></a>01654             <span class="keywordflow">if</span> (pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>) {
<a name="l01655"></a>01655                 pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a> = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>);
<a name="l01656"></a>01656 
<a name="l01657"></a>01657                 <span class="comment">/* use the values from the the existing props */</span>
<a name="l01658"></a>01658                 <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>) {
<a name="l01659"></a>01659                     <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ab62ae750cba82874670a08772429a390">IDP_SyncGroupValues</a>(pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>);
<a name="l01660"></a>01660                 }
<a name="l01661"></a>01661             }
<a name="l01662"></a>01662 
<a name="l01663"></a>01663             <span class="comment">/* constraints - proxy constraints are flushed... local ones are added after</span>
<a name="l01664"></a>01664 <span class="comment">             *     1. extract constraints not from proxy (CONSTRAINT_PROXY_LOCAL) from pchan&#39;s constraints</span>
<a name="l01665"></a>01665 <span class="comment">             *     2. copy proxy-pchan&#39;s constraints on-to new</span>
<a name="l01666"></a>01666 <span class="comment">             *     3. add extracted local constraints back on top</span>
<a name="l01667"></a>01667 <span class="comment">             *</span>
<a name="l01668"></a>01668 <span class="comment">             * Note for copy_constraints: when copying constraints, disable &#39;do_extern&#39; otherwise</span>
<a name="l01669"></a>01669 <span class="comment">             *                            we get the libs direct linked in this blend. */</span>
<a name="l01670"></a>01670             <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a72686b2521e54d0d0d345191b1185ff5">extract_proxylocal_constraints</a>(&amp;proxylocal_constraints, &amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>);
<a name="l01671"></a>01671             <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#aae4fc24d25acff1839e4df3812990864">copy_constraints</a>(&amp;pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>, &amp;pchanp-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01672"></a>01672             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aea47205fbf4fc9965bc2b06e7e3ca75a">BLI_movelisttolist</a>(&amp;pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>, &amp;proxylocal_constraints);
<a name="l01673"></a>01673 
<a name="l01674"></a>01674             <span class="comment">/* constraints - set target ob pointer to own object */</span>
<a name="l01675"></a>01675             <span class="keywordflow">for</span> (con = pchanw.<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con = con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l01676"></a>01676                 <a class="code" href="../../dc/ded/structbConstraintTypeInfo.html">bConstraintTypeInfo</a> *cti = <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a8eac21e0105e441026a6b7cd7d78030d">constraint_get_typeinfo</a>(con);
<a name="l01677"></a>01677                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> targets = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01678"></a>01678                 <a class="code" href="../../d5/d78/structbConstraintTarget.html">bConstraintTarget</a> *ct;
<a name="l01679"></a>01679 
<a name="l01680"></a>01680                 <span class="keywordflow">if</span> (cti &amp;&amp; cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>) {
<a name="l01681"></a>01681                     cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a25b05ed0f4c02b26dbbc775b47d0b934">get_constraint_targets</a>(con, &amp;targets);
<a name="l01682"></a>01682 
<a name="l01683"></a>01683                     <span class="keywordflow">for</span> (ct = targets.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ct; ct = ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a5ea4a1b1fa4761a30cb66c75a8ac9054">next</a>) {
<a name="l01684"></a>01684                         <span class="keywordflow">if</span> (ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> == from)
<a name="l01685"></a>01685                             ct-&gt;<a class="code" href="../../d5/d78/structbConstraintTarget.html#a0f75cb18129bdb2c0aee21ac528b8f5e">tar</a> = ob;
<a name="l01686"></a>01686                     }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688                     <span class="keywordflow">if</span> (cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>)
<a name="l01689"></a>01689                         cti-&gt;<a class="code" href="../../dc/ded/structbConstraintTypeInfo.html#a5afd4078d269cd49108678e99cca935f">flush_constraint_targets</a>(con, &amp;targets, 0);
<a name="l01690"></a>01690                 }
<a name="l01691"></a>01691             }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693             <span class="comment">/* free stuff from current channel */</span>
<a name="l01694"></a>01694             <a class="code" href="../../d8/df5/BKE__action_8h.html#a5c5c36a7ec5f5e2ad9da713268de1872">free_pose_channel</a>(pchan);
<a name="l01695"></a>01695 
<a name="l01696"></a>01696             <span class="comment">/* the final copy */</span>
<a name="l01697"></a>01697             *pchan = pchanw;
<a name="l01698"></a>01698         }
<a name="l01699"></a>01699         <span class="keywordflow">else</span> {
<a name="l01700"></a>01700             <span class="comment">/* always copy custom shape */</span>
<a name="l01701"></a>01701             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5142a64bf664411e5f73166f8305b6c0">custom</a> = pchanp-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5142a64bf664411e5f73166f8305b6c0">custom</a>;
<a name="l01702"></a>01702             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3d057088dabc61fbc5131cb0c4ca158f">custom_tx</a> = pchanp-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a3d057088dabc61fbc5131cb0c4ca158f">custom_tx</a>;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704             <span class="comment">/* ID-Property Syncing */</span>
<a name="l01705"></a>01705             {
<a name="l01706"></a>01706                 <a class="code" href="../../df/d42/structIDProperty.html">IDProperty</a> *prop_orig = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>;
<a name="l01707"></a>01707                 <span class="keywordflow">if</span> (pchanp-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>) {
<a name="l01708"></a>01708                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a> = <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ae80f703da3b22ff05299c00760d1d8cc">IDP_CopyProperty</a>(pchanp-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>);
<a name="l01709"></a>01709                     <span class="keywordflow">if</span> (prop_orig) {
<a name="l01710"></a>01710                         <span class="comment">/* copy existing values across when types match */</span>
<a name="l01711"></a>01711                         <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ab62ae750cba82874670a08772429a390">IDP_SyncGroupValues</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a>, prop_orig);
<a name="l01712"></a>01712                     }
<a name="l01713"></a>01713                 }
<a name="l01714"></a>01714                 <span class="keywordflow">else</span> {
<a name="l01715"></a>01715                     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a053b8b403c11109dcb74d5a31e5b80fc">prop</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01716"></a>01716                 }
<a name="l01717"></a>01717                 <span class="keywordflow">if</span> (prop_orig) {
<a name="l01718"></a>01718                     <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(prop_orig);
<a name="l01719"></a>01719                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(prop_orig);
<a name="l01720"></a>01720                 }
<a name="l01721"></a>01721             }
<a name="l01722"></a>01722         }
<a name="l01723"></a>01723     }
<a name="l01724"></a>01724 }
<a name="l01725"></a>01725 
<a name="l01726"></a><a class="code" href="../../d9/d2b/armature_8c.html#a008c073726456985243fc48e801673b7">01726</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d2b/armature_8c.html#a008c073726456985243fc48e801673b7">rebuild_pose_bone</a>(<a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *parchan, <span class="keywordtype">int</span> counter)
<a name="l01727"></a>01727 {
<a name="l01728"></a>01728     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan = <a class="code" href="../../d8/df5/BKE__action_8h.html#a74ba25276e2aa4b007aafa4a545f649d">verify_pose_channel</a>(pose, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>); <span class="comment">/* verify checks and/or adds */</span>
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a> = bone;
<a name="l01731"></a>01731     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a> = parchan;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     counter++;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     <span class="keywordflow">for</span> (bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#af3f173cbc93a3c319cc0f29dfbbf0878">childbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bone; bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l01736"></a>01736         counter = <a class="code" href="../../d9/d2b/armature_8c.html#a008c073726456985243fc48e801673b7">rebuild_pose_bone</a>(pose, bone, pchan, counter);
<a name="l01737"></a>01737         <span class="comment">/* for quick detecting of next bone in chain, only b-bone uses it now */</span>
<a name="l01738"></a>01738         <span class="keywordflow">if</span> (bone-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)
<a name="l01739"></a>01739             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad63dea990fc5ac499625f4d9ef570de9">child</a> = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(pose, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l01740"></a>01740     }
<a name="l01741"></a>01741 
<a name="l01742"></a>01742     <span class="keywordflow">return</span> counter;
<a name="l01743"></a>01743 }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745 <span class="comment">/* only after leave editmode, duplicating, validating older files, library syncing */</span>
<a name="l01746"></a>01746 <span class="comment">/* NOTE: pose-&gt;flag is set for it */</span>
<a name="l01747"></a><a class="code" href="../../d9/d2b/armature_8c.html#a50343cc7dcf53aefafe1045327796a60">01747</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a565b57760b56c855cc22ee91ff4f6225">armature_rebuild_pose</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm)
<a name="l01748"></a>01748 {
<a name="l01749"></a>01749     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l01750"></a>01750     <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose;
<a name="l01751"></a>01751     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01752"></a>01752     <span class="keywordtype">int</span> counter = 0;
<a name="l01753"></a>01753 
<a name="l01754"></a>01754     <span class="comment">/* only done here */</span>
<a name="l01755"></a>01755     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01756"></a>01756         <span class="comment">/* create new pose */</span>
<a name="l01757"></a>01757         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/de4/structbPose.html">bPose</a>), <span class="stringliteral">&quot;new pose&quot;</span>);
<a name="l01758"></a>01758 
<a name="l01759"></a>01759         <span class="comment">/* set default settings for animviz */</span>
<a name="l01760"></a>01760         <a class="code" href="../../df/dd0/BKE__anim_8h.html#a5d6fe871f52b3912c34e29f29e6968ff">animviz_settings_init</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a66f05f761e3d89a2717137132fff43cc">avs</a>);
<a name="l01761"></a>01761     }
<a name="l01762"></a>01762     pose = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="comment">/* clear */</span>
<a name="l01765"></a>01765     <span class="keywordflow">for</span> (pchan = pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01766"></a>01766         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01767"></a>01767         pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad63dea990fc5ac499625f4d9ef570de9">child</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01768"></a>01768     }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="comment">/* first step, check if all channels are there */</span>
<a name="l01771"></a>01771     <span class="keywordflow">for</span> (bone = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a70ffd5ceaf18be398f1caa3b30151c0b">bonebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bone; bone = bone-&gt;<a class="code" href="../../de/de0/structBone.html#ae63d2260606d516a99ae75fbc7f22e21">next</a>) {
<a name="l01772"></a>01772         counter = <a class="code" href="../../d9/d2b/armature_8c.html#a008c073726456985243fc48e801673b7">rebuild_pose_bone</a>(pose, bone, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, counter);
<a name="l01773"></a>01773     }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775     <span class="comment">/* and a check for garbage */</span>
<a name="l01776"></a>01776     <span class="keywordflow">for</span> (pchan = pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = next) {
<a name="l01777"></a>01777         next = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>;
<a name="l01778"></a>01778         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01779"></a>01779             <a class="code" href="../../d8/df5/BKE__action_8h.html#a5c5c36a7ec5f5e2ad9da713268de1872">free_pose_channel</a>(pchan);
<a name="l01780"></a>01780             <a class="code" href="../../d8/df5/BKE__action_8h.html#af13c0947ece98793cfba086d1b31815b">free_pose_channels_hash</a>(pose);
<a name="l01781"></a>01781             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>, pchan);
<a name="l01782"></a>01782         }
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784     <span class="comment">/* printf(&quot;rebuild pose %s, %d bones\n&quot;, ob-&gt;id.name, counter); */</span>
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     <span class="comment">/* synchronize protected layers with proxy */</span>
<a name="l01787"></a>01787     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a54e05d3611058fa986bd69541f665e23">proxy</a>) {
<a name="l01788"></a>01788         <a class="code" href="../../df/dac/BKE__object_8h.html#add87af12f425412126cc781df6e4bab5">object_copy_proxy_drivers</a>(ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a54e05d3611058fa986bd69541f665e23">proxy</a>);
<a name="l01789"></a>01789         <a class="code" href="../../d9/d2b/armature_8c.html#ac84d3743413b7d82c06f40a1798cf79c">pose_proxy_synchronize</a>(ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a54e05d3611058fa986bd69541f665e23">proxy</a>, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ad2467a0d23798514096ac126d9700b33">layer_protected</a>);
<a name="l01790"></a>01790     }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792     <a class="code" href="../../d8/df5/BKE__action_8h.html#a2217b3c2db934940cd12c0bb795a1a5e">update_pose_constraint_flags</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>); <span class="comment">/* for IK detection for example */</span>
<a name="l01793"></a>01793 
<a name="l01794"></a>01794     <span class="comment">/* the sorting */</span>
<a name="l01795"></a>01795     <span class="keywordflow">if</span> (counter&gt;1)
<a name="l01796"></a>01796         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#aefd9304dddbd2a29813d6ebd178f2a30">DAG_pose_sort</a>(ob);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp;= ~<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483daa8b3bbff9fe194cbe52e3aad051a19a6">POSE_RECALC</a>;
<a name="l01799"></a>01799     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483da6a993a8c5630134f94de6f73c56e0882">POSE_WAS_REBUILT</a>;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <a class="code" href="../../d8/df5/BKE__action_8h.html#a6ff3e52fae5115d5759dedbfd5265926">make_pose_channels_hash</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804 
<a name="l01805"></a>01805 <span class="comment">/* ********************** SPLINE IK SOLVER ******************* */</span>
<a name="l01806"></a>01806 
<a name="l01807"></a>01807 <span class="comment">/* Temporary evaluation tree data used for Spline IK */</span>
<a name="l01808"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html">01808</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a> {
<a name="l01809"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#ae379f096b3f6459bbd87b1365d0d449b">01809</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a0c3455f1e399d37638bcd5727594335a">next</a>, *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#ae379f096b3f6459bbd87b1365d0d449b">prev</a>;
<a name="l01810"></a>01810 
<a name="l01811"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aec33a80f0d1c630b128827dfd1a26981">01811</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aec33a80f0d1c630b128827dfd1a26981">type</a>;                    <span class="comment">/* type of IK that this serves (CONSTRAINT_TYPE_KINEMATIC or ..._SPLINEIK) */</span>
<a name="l01812"></a>01812 
<a name="l01813"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a38c2f687f208d45f86b74a798717d312">01813</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a38c2f687f208d45f86b74a798717d312">free_points</a>;           <span class="comment">/* free the point positions array */</span>
<a name="l01814"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a62ac5e24058ecff0d1b2a7e891428725">01814</a>     <span class="keywordtype">short</span> <a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a62ac5e24058ecff0d1b2a7e891428725">chainlen</a>;              <span class="comment">/* number of bones in the chain */</span>
<a name="l01815"></a>01815 
<a name="l01816"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">01816</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>;               <span class="comment">/* parametric positions for the joints along the curve */</span>
<a name="l01817"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">01817</a>     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> **<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a>;        <span class="comment">/* chain of bones to affect using Spline IK (ordered from the tip) */</span>
<a name="l01818"></a>01818 
<a name="l01819"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a552aac504928e03a5910254f9a1749cd">01819</a>     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a552aac504928e03a5910254f9a1749cd">root</a>;          <span class="comment">/* bone that is the root node of the chain */</span>
<a name="l01820"></a>01820 
<a name="l01821"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">01821</a>     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a>;            <span class="comment">/* constraint for this chain */</span>
<a name="l01822"></a><a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">01822</a>     <a class="code" href="../../d5/d7b/structbSplineIKConstraint.html">bSplineIKConstraint</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a>; <span class="comment">/* constraint settings for this chain */</span>
<a name="l01823"></a>01823 } <a class="code" href="../../d9/d2b/armature_8c.html#af7b729e36c3d8934cd8da96874a37f38">tSplineIK_Tree</a>;
<a name="l01824"></a>01824 
<a name="l01825"></a>01825 <span class="comment">/* ----------- */</span>
<a name="l01826"></a>01826 
<a name="l01827"></a>01827 <span class="comment">/* Tag the bones in the chain formed by the given bone for IK */</span>
<a name="l01828"></a><a class="code" href="../../d9/d2b/armature_8c.html#a10aa4e1844ecb58dc89cadb23b9cd0f6">01828</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a10aa4e1844ecb58dc89cadb23b9cd0f6">splineik_init_tree_from_pchan</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ob), <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan_tip)
<a name="l01829"></a>01829 {
<a name="l01830"></a>01830     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, *pchanRoot = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01831"></a>01831     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchanChain[255];
<a name="l01832"></a>01832     <a class="code" href="../../d8/d41/structbConstraint.html">bConstraint</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01833"></a>01833     <a class="code" href="../../d5/d7b/structbSplineIKConstraint.html">bSplineIKConstraint</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01834"></a>01834     <span class="keywordtype">float</span> boneLengths[255], *jointPoints;
<a name="l01835"></a>01835     <span class="keywordtype">float</span> totLength = 0.0f;
<a name="l01836"></a>01836     <span class="keywordtype">short</span> free_joints = 0;
<a name="l01837"></a>01837     <span class="keywordtype">int</span> segcount = 0;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     <span class="comment">/* find the SplineIK constraint */</span>
<a name="l01840"></a>01840     <span class="keywordflow">for</span> (con = pchan_tip-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; con; con = con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a463805fc5e4f3bfb3f0bf92913808c88">next</a>) {
<a name="l01841"></a>01841         <span class="keywordflow">if</span> (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#a63187d597452da3bb2bd3b52054167cc">type</a> == <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a71924f8e323782bf927aef8aaab46e97">CONSTRAINT_TYPE_SPLINEIK</a>) {
<a name="l01842"></a>01842             ikData = con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adfe30f55cbdd3ae1ae79948b63d3063e">data</a>;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844             <span class="comment">/* target can only be curve */</span>
<a name="l01845"></a>01845             <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>))
<a name="l01846"></a>01846                 <span class="keywordflow">continue</span>;
<a name="l01847"></a>01847             <span class="comment">/* skip if disabled */</span>
<a name="l01848"></a>01848             <span class="keywordflow">if</span> ((con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> == 0.0f) || (con-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#ac6a72c0507023027796fab32f3780463">flag</a> &amp; (<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efdac624d1811979843b913fe2a7c3833c53">CONSTRAINT_DISABLE</a>|<a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a0362894a1749bab66380cae2ce4b1efda3e9dbf2146b5916be569195d1098c5a2">CONSTRAINT_OFF</a>)))
<a name="l01849"></a>01849                 <span class="keywordflow">continue</span>;
<a name="l01850"></a>01850 
<a name="l01851"></a>01851             <span class="comment">/* otherwise, constraint is ok... */</span>
<a name="l01852"></a>01852             <span class="keywordflow">break</span>;
<a name="l01853"></a>01853         }
<a name="l01854"></a>01854     }
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (con == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01856"></a>01856         <span class="keywordflow">return</span>;
<a name="l01857"></a>01857 
<a name="l01858"></a>01858     <span class="comment">/* make sure that the constraint targets are ok</span>
<a name="l01859"></a>01859 <span class="comment">     *     - this is a workaround for a depsgraph bug...</span>
<a name="l01860"></a>01860 <span class="comment">     */</span>
<a name="l01861"></a>01861     <span class="keywordflow">if</span> (ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>) {
<a name="l01862"></a>01862         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864         <span class="comment">/* note: when creating constraints that follow path, the curve gets the CU_PATH set now,</span>
<a name="l01865"></a>01865 <span class="comment">         *       currently for paths to work it needs to go through the bevlist/displist system (ton)</span>
<a name="l01866"></a>01866 <span class="comment">         */</span>
<a name="l01867"></a>01867 
<a name="l01868"></a>01868         <span class="comment">/* only happens on reload file, but violates depsgraph still... fix! */</span>
<a name="l01869"></a>01869         <span class="keywordflow">if</span> ((cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>-&gt;<a class="code" href="../../d3/d20/structPath.html#a15dc781d9ad24530d3a8d218c7b79aca">data</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l01870"></a>01870             <a class="code" href="../../d9/d12/BKE__displist_8h.html#a5ca43234b8f9db71b0318b29716b5487">makeDispListCurveTypes</a>(scene, ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>, 0);
<a name="l01871"></a>01871     }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="comment">/* find the root bone and the chain of bones from the root to the tip</span>
<a name="l01874"></a>01874 <span class="comment">     * NOTE: this assumes that the bones are connected, but that may not be true... */</span>
<a name="l01875"></a>01875     <span class="keywordflow">for</span> (pchan = pchan_tip; pchan &amp;&amp; (segcount &lt; ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a1ab06cba015c9e09e183d550316ca768">chainlen</a>); pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>, segcount++) {
<a name="l01876"></a>01876         <span class="comment">/* store this segment in the chain */</span>
<a name="l01877"></a>01877         pchanChain[segcount] = pchan;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879         <span class="comment">/* if performing rebinding, calculate the length of the bone */</span>
<a name="l01880"></a>01880         boneLengths[segcount] = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l01881"></a>01881         totLength += boneLengths[segcount];
<a name="l01882"></a>01882     }
<a name="l01883"></a>01883 
<a name="l01884"></a>01884     <span class="keywordflow">if</span> (segcount == 0)
<a name="l01885"></a>01885         <span class="keywordflow">return</span>;
<a name="l01886"></a>01886     <span class="keywordflow">else</span>
<a name="l01887"></a>01887         pchanRoot = pchanChain[segcount-1];
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     <span class="comment">/* perform binding step if required */</span>
<a name="l01890"></a>01890     <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887daae9aba138f140ee155f5e0c6da9e1bfc">CONSTRAINT_SPLINEIK_BOUND</a>) == 0) {
<a name="l01891"></a>01891         <span class="keywordtype">float</span> segmentLen = (1.0f / (float)segcount);
<a name="l01892"></a>01892         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01893"></a>01893 
<a name="l01894"></a>01894         <span class="comment">/* setup new empty array for the points list */</span>
<a name="l01895"></a>01895         <span class="keywordflow">if</span> (ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>)
<a name="l01896"></a>01896             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>);
<a name="l01897"></a>01897         ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac2c9ec953f800fb957c75d4a38099426">numpoints</a> = ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a1ab06cba015c9e09e183d550316ca768">chainlen</a>+1;
<a name="l01898"></a>01898         ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac2c9ec953f800fb957c75d4a38099426">numpoints</a>, <span class="stringliteral">&quot;Spline IK Binding&quot;</span>);
<a name="l01899"></a>01899 
<a name="l01900"></a>01900         <span class="comment">/* bind &#39;tip&#39; of chain (i.e. first joint = tip of bone with the Spline IK Constraint) */</span>
<a name="l01901"></a>01901         ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>[0] = 1.0f;
<a name="l01902"></a>01902 
<a name="l01903"></a>01903         <span class="comment">/* perform binding of the joints to parametric positions along the curve based</span>
<a name="l01904"></a>01904 <span class="comment">         * proportion of the total length that each bone occupies</span>
<a name="l01905"></a>01905 <span class="comment">         */</span>
<a name="l01906"></a>01906         <span class="keywordflow">for</span> (i = 0; i &lt; segcount; i++) {
<a name="l01907"></a>01907             <span class="comment">/* &#39;head&#39; joints, traveling towards the root of the chain</span>
<a name="l01908"></a>01908 <span class="comment">             *  - 2 methods; the one chosen depends on whether we&#39;ve got usable lengths</span>
<a name="l01909"></a>01909 <span class="comment">             */</span>
<a name="l01910"></a>01910             <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887da008f3e65694d349b56df3ab5d15c2314">CONSTRAINT_SPLINEIK_EVENSPLITS</a>) || (totLength == 0.0f)) {
<a name="l01911"></a>01911                 <span class="comment">/* 1) equi-spaced joints */</span>
<a name="l01912"></a>01912                 ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>[i+1] = ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - segmentLen;
<a name="l01913"></a>01913             }
<a name="l01914"></a>01914             <span class="keywordflow">else</span> {
<a name="l01915"></a>01915                 <span class="comment">/* 2) to find this point on the curve, we take a step from the previous joint</span>
<a name="l01916"></a>01916 <span class="comment">                 *    a distance given by the proportion that this bone takes</span>
<a name="l01917"></a>01917 <span class="comment">                 */</span>
<a name="l01918"></a>01918                 ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>[i+1] = ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - (boneLengths[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] / totLength);
<a name="l01919"></a>01919             }
<a name="l01920"></a>01920         }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922         <span class="comment">/* spline has now been bound */</span>
<a name="l01923"></a>01923         ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> |= <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887daae9aba138f140ee155f5e0c6da9e1bfc">CONSTRAINT_SPLINEIK_BOUND</a>;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     <span class="comment">/* apply corrections for sensitivity to scaling on a copy of the bind points,</span>
<a name="l01927"></a>01927 <span class="comment">     * since it&#39;s easier to determine the positions of all the joints beforehand this way</span>
<a name="l01928"></a>01928 <span class="comment">     */</span>
<a name="l01929"></a>01929     <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887dae08d2cdee2697d769cf592b224e29df1">CONSTRAINT_SPLINEIK_SCALE_LIMITED</a>) &amp;&amp; (totLength != 0.0f)) {
<a name="l01930"></a>01930         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu = (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *)ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01931"></a>01931         <span class="keywordtype">float</span> splineLen, maxScale;
<a name="l01932"></a>01932         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934         <span class="comment">/* make a copy of the points array, that we&#39;ll store in the tree</span>
<a name="l01935"></a>01935 <span class="comment">         *     - although we could just multiply the points on the fly, this approach means that</span>
<a name="l01936"></a>01936 <span class="comment">         *       we can introduce per-segment stretchiness later if it is necessary</span>
<a name="l01937"></a>01937 <span class="comment">         */</span>
<a name="l01938"></a>01938         jointPoints = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>);
<a name="l01939"></a>01939         free_joints = 1;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941         <span class="comment">/* get the current length of the curve */</span>
<a name="l01942"></a>01942         <span class="comment">/* NOTE: this is assumed to be correct even after the curve was resized */</span>
<a name="l01943"></a>01943         splineLen = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>-&gt;<a class="code" href="../../d3/d20/structPath.html#ac0bc2bd2f6fe492858b63a74005543af">totdist</a>;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         <span class="comment">/* calculate the scale factor to multiply all the path values by so that the</span>
<a name="l01946"></a>01946 <span class="comment">         * bone chain retains its current length, such that</span>
<a name="l01947"></a>01947 <span class="comment">         *     maxScale * splineLen = totLength</span>
<a name="l01948"></a>01948 <span class="comment">         */</span>
<a name="l01949"></a>01949         maxScale = totLength / splineLen;
<a name="l01950"></a>01950 
<a name="l01951"></a>01951         <span class="comment">/* apply scaling correction to all of the temporary points */</span>
<a name="l01952"></a>01952         <span class="comment">/* TODO: this is really not adequate enough on really short chains */</span>
<a name="l01953"></a>01953         <span class="keywordflow">for</span> (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; segcount; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l01954"></a>01954             jointPoints[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] *= maxScale;
<a name="l01955"></a>01955     }
<a name="l01956"></a>01956     <span class="keywordflow">else</span> {
<a name="l01957"></a>01957         <span class="comment">/* just use the existing points array */</span>
<a name="l01958"></a>01958         jointPoints = ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a50b3b161aaa52ff5a9f62e02e43caf63">points</a>;
<a name="l01959"></a>01959         free_joints = 0;
<a name="l01960"></a>01960     }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     <span class="comment">/* make a new Spline-IK chain, and store it in the IK chains */</span>
<a name="l01963"></a>01963     <span class="comment">/* TODO: we should check if there is already an IK chain on this, since that would take presidence... */</span>
<a name="l01964"></a>01964     {
<a name="l01965"></a>01965         <span class="comment">/* make new tree */</span>
<a name="l01966"></a>01966         <a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a> *tree = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a>), <span class="stringliteral">&quot;SplineIK Tree&quot;</span>);
<a name="l01967"></a>01967         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aec33a80f0d1c630b128827dfd1a26981">type</a> = <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#a22745fe3cf64fc34759408bb74cd18f5a71924f8e323782bf927aef8aaab46e97">CONSTRAINT_TYPE_SPLINEIK</a>;
<a name="l01968"></a>01968 
<a name="l01969"></a>01969         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a62ac5e24058ecff0d1b2a7e891428725">chainlen</a> = segcount;
<a name="l01970"></a>01970 
<a name="l01971"></a>01971         <span class="comment">/* copy over the array of links to bones in the chain (from tip to root) */</span>
<a name="l01972"></a>01972         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*)*segcount, <span class="stringliteral">&quot;SplineIK Chain&quot;</span>);
<a name="l01973"></a>01973         memcpy(tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a>, pchanChain, <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a>*)*segcount);
<a name="l01974"></a>01974 
<a name="l01975"></a>01975         <span class="comment">/* store reference to joint position array */</span>
<a name="l01976"></a>01976         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a> = jointPoints;
<a name="l01977"></a>01977         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a38c2f687f208d45f86b74a798717d312">free_points</a> = free_joints;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979         <span class="comment">/* store references to different parts of the chain */</span>
<a name="l01980"></a>01980         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a552aac504928e03a5910254f9a1749cd">root</a> = pchanRoot;
<a name="l01981"></a>01981         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a> = <a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a>;
<a name="l01982"></a>01982         tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a> = <a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a>;
<a name="l01983"></a>01983 
<a name="l01984"></a>01984         <span class="comment">/* AND! link the tree to the root */</span>
<a name="l01985"></a>01985         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pchanRoot-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#afbc80aa935e8bd461de32493694a7bff">siktree</a>, tree);
<a name="l01986"></a>01986     }
<a name="l01987"></a>01987 
<a name="l01988"></a>01988     <span class="comment">/* mark root channel having an IK tree */</span>
<a name="l01989"></a>01989     pchanRoot-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a1782dec86eb400cd32f7aa6f96354650">POSE_IKSPLINE</a>;
<a name="l01990"></a>01990 }
<a name="l01991"></a>01991 
<a name="l01992"></a>01992 <span class="comment">/* Tag which bones are members of Spline IK chains */</span>
<a name="l01993"></a><a class="code" href="../../d9/d2b/armature_8c.html#ab4685eddaf2de62c2f005964d75c1087">01993</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#ab4685eddaf2de62c2f005964d75c1087">splineik_init_tree</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ctime))
<a name="l01994"></a>01994 {
<a name="l01995"></a>01995     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l01996"></a>01996 
<a name="l01997"></a>01997     <span class="comment">/* find the tips of Spline IK chains, which are simply the bones which have been tagged as such */</span>
<a name="l01998"></a>01998     <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l01999"></a>01999         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#abf27c9382f3dd90c6a03b2e8fd69d1fc">constflag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#aa054ea9cc32895cc3299d8e9331ab3e8ac0c0e30c4204303927e602fab84c6cfa">PCHAN_HAS_SPLINEIK</a>)
<a name="l02000"></a>02000             <a class="code" href="../../d9/d2b/armature_8c.html#a10aa4e1844ecb58dc89cadb23b9cd0f6">splineik_init_tree_from_pchan</a>(scene, ob, pchan);
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002 }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004 <span class="comment">/* ----------- */</span>
<a name="l02005"></a>02005 
<a name="l02006"></a>02006 <span class="comment">/* Evaluate spline IK for a given bone */</span>
<a name="l02007"></a><a class="code" href="../../d9/d2b/armature_8c.html#a0ed0a20623295ba338e20a654d734302">02007</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a0ed0a20623295ba338e20a654d734302">splineik_evaluate_bone</a>(<a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a> *tree, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan,
<a name="l02008"></a>02008                                    <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> ctime)
<a name="l02009"></a>02009 {
<a name="l02010"></a>02010     <a class="code" href="../../d5/d7b/structbSplineIKConstraint.html">bSplineIKConstraint</a> *<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a> = tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#aeea071ce26414f46d4c19a2d78cd2969">ikData</a>;
<a name="l02011"></a>02011     <span class="keywordtype">float</span> poseHead[3], poseTail[3], poseMat[4][4];
<a name="l02012"></a>02012     <span class="keywordtype">float</span> splineVec[3], scaleFac, radius =1.0f;
<a name="l02013"></a>02013 
<a name="l02014"></a>02014     <span class="comment">/* firstly, calculate the bone matrix the standard way, since this is needed for roll control */</span>
<a name="l02015"></a>02015     <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(scene, ob, pchan, ctime, 1);
<a name="l02016"></a>02016 
<a name="l02017"></a>02017     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseHead, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l02018"></a>02018     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseTail, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020     <span class="comment">/* step 1: determine the positions for the endpoints of the bone */</span>
<a name="l02021"></a>02021     {
<a name="l02022"></a>02022         <span class="keywordtype">float</span> vec[4], dir[3], rad;
<a name="l02023"></a>02023         <span class="keywordtype">float</span> tailBlendFac = 1.0f;
<a name="l02024"></a>02024 
<a name="l02025"></a>02025         <span class="comment">/* determine if the bone should still be affected by SplineIK */</span>
<a name="l02026"></a>02026         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index+1] &gt;= 1.0f) {
<a name="l02027"></a>02027             <span class="comment">/* spline doesn&#39;t affect the bone anymore, so done... */</span>
<a name="l02028"></a>02028             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>;
<a name="l02029"></a>02029             <span class="keywordflow">return</span>;
<a name="l02030"></a>02030         }
<a name="l02031"></a>02031         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index] &gt;= 1.0f) &amp;&amp; (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index+1] &lt; 1.0f)) {
<a name="l02032"></a>02032             <span class="comment">/* blending factor depends on the amount of the bone still left on the chain */</span>
<a name="l02033"></a>02033             tailBlendFac = (1.0f - tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index+1]) / (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index] - tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index+1]);
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035 
<a name="l02036"></a>02036         <span class="comment">/* tail endpoint */</span>
<a name="l02037"></a>02037         <span class="keywordflow">if</span> (<a class="code" href="../../df/dd0/BKE__anim_8h.html#a36e926e41221928bb037b16aa04becc0">where_on_path</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>, tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index], vec, dir, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;rad, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02038"></a>02038             <span class="comment">/* apply curve&#39;s object-mode transforms to the position</span>
<a name="l02039"></a>02039 <span class="comment">             * unless the option to allow curve to be positioned elsewhere is activated (i.e. no root)</span>
<a name="l02040"></a>02040 <span class="comment">             */</span>
<a name="l02041"></a>02041             <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887daedea10272e2fa8ea1a279386f702f0d4">CONSTRAINT_SPLINEIK_NO_ROOT</a>) == 0)
<a name="l02042"></a>02042                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vec);
<a name="l02043"></a>02043 
<a name="l02044"></a>02044             <span class="comment">/* convert the position to pose-space, then store it */</span>
<a name="l02045"></a>02045             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, vec);
<a name="l02046"></a>02046             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(poseTail, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, vec, tailBlendFac);
<a name="l02047"></a>02047 
<a name="l02048"></a>02048             <span class="comment">/* set the new radius */</span>
<a name="l02049"></a>02049             radius = rad;
<a name="l02050"></a>02050         }
<a name="l02051"></a>02051 
<a name="l02052"></a>02052         <span class="comment">/* head endpoint */</span>
<a name="l02053"></a>02053         <span class="keywordflow">if</span> (<a class="code" href="../../df/dd0/BKE__anim_8h.html#a36e926e41221928bb037b16aa04becc0">where_on_path</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>, tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>[index+1], vec, dir, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;rad, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02054"></a>02054             <span class="comment">/* apply curve&#39;s object-mode transforms to the position</span>
<a name="l02055"></a>02055 <span class="comment">             * unless the option to allow curve to be positioned elsewhere is activated (i.e. no root)</span>
<a name="l02056"></a>02056 <span class="comment">             */</span>
<a name="l02057"></a>02057             <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887daedea10272e2fa8ea1a279386f702f0d4">CONSTRAINT_SPLINEIK_NO_ROOT</a>) == 0)
<a name="l02058"></a>02058                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ae37ab075927997f4fa7866ce69a3f3e9">tar</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vec);
<a name="l02059"></a>02059 
<a name="l02060"></a>02060             <span class="comment">/* store the position, and convert it to pose space */</span>
<a name="l02061"></a>02061             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, vec);
<a name="l02062"></a>02062             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseHead, vec);
<a name="l02063"></a>02063 
<a name="l02064"></a>02064             <span class="comment">/* set the new radius (it should be the average value) */</span>
<a name="l02065"></a>02065             radius = (radius+rad) / 2;
<a name="l02066"></a>02066         }
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069     <span class="comment">/* step 2: determine the implied transform from these endpoints</span>
<a name="l02070"></a>02070 <span class="comment">     *     - splineVec: the vector direction that the spline applies on the bone</span>
<a name="l02071"></a>02071 <span class="comment">     *     - scaleFac: the factor that the bone length is scaled by to get the desired amount</span>
<a name="l02072"></a>02072 <span class="comment">     */</span>
<a name="l02073"></a>02073     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(splineVec, poseTail, poseHead);
<a name="l02074"></a>02074     scaleFac = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(splineVec) / pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>;
<a name="l02075"></a>02075 
<a name="l02076"></a>02076     <span class="comment">/* step 3: compute the shortest rotation needed to map from the bone rotation to the current axis</span>
<a name="l02077"></a>02077 <span class="comment">     *      - this uses the same method as is used for the Damped Track Constraint (see the code there for details)</span>
<a name="l02078"></a>02078 <span class="comment">     */</span>
<a name="l02079"></a>02079     {
<a name="l02080"></a>02080         <span class="keywordtype">float</span> dmat[3][3], rmat[3][3], tmat[3][3];
<a name="l02081"></a>02081         <span class="keywordtype">float</span> raxis[3], rangle;
<a name="l02082"></a>02082 
<a name="l02083"></a>02083         <span class="comment">/* compute the raw rotation matrix from the bone&#39;s current matrix by extracting only the</span>
<a name="l02084"></a>02084 <span class="comment">         * orientation-relevant axes, and normalizing them</span>
<a name="l02085"></a>02085 <span class="comment">         */</span>
<a name="l02086"></a>02086         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rmat[0], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0]);
<a name="l02087"></a>02087         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rmat[1], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l02088"></a>02088         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rmat[2], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[2]);
<a name="l02089"></a>02089         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(rmat);
<a name="l02090"></a>02090 
<a name="l02091"></a>02091         <span class="comment">/* also, normalize the orientation imposed by the bone, now that we&#39;ve extracted the scale factor */</span>
<a name="l02092"></a>02092         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(splineVec);
<a name="l02093"></a>02093 
<a name="l02094"></a>02094         <span class="comment">/* calculate smallest axis-angle rotation necessary for getting from the</span>
<a name="l02095"></a>02095 <span class="comment">         * current orientation of the bone, to the spline-imposed direction</span>
<a name="l02096"></a>02096 <span class="comment">         */</span>
<a name="l02097"></a>02097         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(raxis, rmat[1], splineVec);
<a name="l02098"></a>02098 
<a name="l02099"></a>02099         rangle = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(rmat[1], splineVec);
<a name="l02100"></a>02100         rangle = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(-1.0f, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(1.0f, rangle)));
<a name="l02101"></a>02101 
<a name="l02102"></a>02102         <span class="comment">/* multiply the magnitude of the angle by the influence of the constraint to</span>
<a name="l02103"></a>02103 <span class="comment">         * control the influence of the SplineIK effect</span>
<a name="l02104"></a>02104 <span class="comment">         */</span>
<a name="l02105"></a>02105         rangle *= tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a>;
<a name="l02106"></a>02106 
<a name="l02107"></a>02107         <span class="comment">/* construct rotation matrix from the axis-angle rotation found above</span>
<a name="l02108"></a>02108 <span class="comment">         *  - this call takes care to make sure that the axis provided is a unit vector first</span>
<a name="l02109"></a>02109 <span class="comment">         */</span>
<a name="l02110"></a>02110         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa804c4cef742fd7a1dd820bf0128ad4a">axis_angle_to_mat3</a>(dmat, raxis, rangle);
<a name="l02111"></a>02111 
<a name="l02112"></a>02112         <span class="comment">/* combine these rotations so that the y-axis of the bone is now aligned as the spline dictates,</span>
<a name="l02113"></a>02113 <span class="comment">         * while still maintaining roll control from the existing bone animation</span>
<a name="l02114"></a>02114 <span class="comment">         */</span>
<a name="l02115"></a>02115         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(tmat, dmat, rmat); <span class="comment">/* m1, m3, m2 */</span>
<a name="l02116"></a>02116         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9fe495fab322328da024b78e09e43921">normalize_m3</a>(tmat); <span class="comment">/* attempt to reduce shearing, though I doubt this&#39;ll really help too much now... */</span>
<a name="l02117"></a>02117         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(poseMat, tmat);
<a name="l02118"></a>02118     }
<a name="l02119"></a>02119 
<a name="l02120"></a>02120     <span class="comment">/* step 4: set the scaling factors for the axes */</span>
<a name="l02121"></a>02121     {
<a name="l02122"></a>02122         <span class="comment">/* only multiply the y-axis by the scaling factor to get nice volume-preservation */</span>
<a name="l02123"></a>02123         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[1], scaleFac);
<a name="l02124"></a>02124 
<a name="l02125"></a>02125         <span class="comment">/* set the scaling factors of the x and z axes from... */</span>
<a name="l02126"></a>02126         <span class="keywordflow">switch</span> (ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#a56b3d0f098684f2308503c22eca57641">xzScaleMode</a>) {
<a name="l02127"></a>02127             <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aed59e762d230fbf99f4c6ff30573ec1eaae74fea288b64761016c0b50c19429ca">CONSTRAINT_SPLINEIK_XZS_ORIGINAL</a>:
<a name="l02128"></a>02128             {
<a name="l02129"></a>02129                 <span class="comment">/* original scales get used */</span>
<a name="l02130"></a>02130                 <span class="keywordtype">float</span> scale;
<a name="l02131"></a>02131 
<a name="l02132"></a>02132                 <span class="comment">/* x-axis scale */</span>
<a name="l02133"></a>02133                 scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0]);
<a name="l02134"></a>02134                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[0], scale);
<a name="l02135"></a>02135                 <span class="comment">/* z-axis scale */</span>
<a name="l02136"></a>02136                 scale = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[2]);
<a name="l02137"></a>02137                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[2], scale);
<a name="l02138"></a>02138             }
<a name="l02139"></a>02139                 <span class="keywordflow">break</span>;
<a name="l02140"></a>02140             <span class="keywordflow">case</span> <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aed59e762d230fbf99f4c6ff30573ec1ea52c5f5e4e730eb3a78670eeb6edc4bd9">CONSTRAINT_SPLINEIK_XZS_VOLUMETRIC</a>:
<a name="l02141"></a>02141             {
<a name="l02142"></a>02142                 <span class="comment">/* &#39;volume preservation&#39; */</span>
<a name="l02143"></a>02143                 <span class="keywordtype">float</span> scale;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145                 <span class="comment">/* calculate volume preservation factor which is</span>
<a name="l02146"></a>02146 <span class="comment">                 * basically the inverse of the y-scaling factor</span>
<a name="l02147"></a>02147 <span class="comment">                 */</span>
<a name="l02148"></a>02148                 <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(scaleFac) != 0.0f) {
<a name="l02149"></a>02149                     scale = 1.0f / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(scaleFac);
<a name="l02150"></a>02150 
<a name="l02151"></a>02151                     <span class="comment">/* we need to clamp this within sensible values */</span>
<a name="l02152"></a>02152                     <span class="comment">/* NOTE: these should be fine for now, but should get sanitised in future */</span>
<a name="l02153"></a>02153                     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(scale, 0.0001f, 100000.0f);
<a name="l02154"></a>02154                 }
<a name="l02155"></a>02155                 <span class="keywordflow">else</span>
<a name="l02156"></a>02156                     scale = 1.0f;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158                 <span class="comment">/* apply the scaling */</span>
<a name="l02159"></a>02159                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[0], scale);
<a name="l02160"></a>02160                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[2], scale);
<a name="l02161"></a>02161             }
<a name="l02162"></a>02162                 <span class="keywordflow">break</span>;
<a name="l02163"></a>02163         }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165         <span class="comment">/* finally, multiply the x and z scaling by the radius of the curve too,</span>
<a name="l02166"></a>02166 <span class="comment">         * to allow automatic scales to get tweaked still</span>
<a name="l02167"></a>02167 <span class="comment">         */</span>
<a name="l02168"></a>02168         <span class="keywordflow">if</span> ((ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887dad2b5494b477b43bc2e5e890e93865a32">CONSTRAINT_SPLINEIK_NO_CURVERAD</a>) == 0) {
<a name="l02169"></a>02169             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[0], radius);
<a name="l02170"></a>02170             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(poseMat[2], radius);
<a name="l02171"></a>02171         }
<a name="l02172"></a>02172     }
<a name="l02173"></a>02173 
<a name="l02174"></a>02174     <span class="comment">/* step 5: set the location of the bone in the matrix */</span>
<a name="l02175"></a>02175     <span class="keywordflow">if</span> (ikData-&gt;<a class="code" href="../../d5/d7b/structbSplineIKConstraint.html#ac9e02d45be24f996d141458c20a8b758">flag</a> &amp; <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#aa1118db5d0284a97d9dc7fca1799887daedea10272e2fa8ea1a279386f702f0d4">CONSTRAINT_SPLINEIK_NO_ROOT</a>) {
<a name="l02176"></a>02176         <span class="comment">/* when the &#39;no-root&#39; option is affected, the chain can retain</span>
<a name="l02177"></a>02177 <span class="comment">         * the shape but be moved elsewhere</span>
<a name="l02178"></a>02178 <span class="comment">         */</span>
<a name="l02179"></a>02179         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseHead, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l02180"></a>02180     }
<a name="l02181"></a>02181     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a> &lt; 1.0f) {
<a name="l02182"></a>02182         <span class="comment">/* when the influence is too low</span>
<a name="l02183"></a>02183 <span class="comment">         *  - blend the positions for the &#39;root&#39; bone</span>
<a name="l02184"></a>02184 <span class="comment">         *  - stick to the parent for any other</span>
<a name="l02185"></a>02185 <span class="comment">         */</span>
<a name="l02186"></a>02186         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l02187"></a>02187             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseHead, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>);
<a name="l02188"></a>02188         }
<a name="l02189"></a>02189         <span class="keywordflow">else</span> {
<a name="l02190"></a>02190             <span class="comment">/* FIXME: this introduces popping artifacts when we reach 0.0 */</span>
<a name="l02191"></a>02191             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(poseHead, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, poseHead, tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#acc547af71933537a0c8fd3e59356b610">con</a>-&gt;<a class="code" href="../../d8/d41/structbConstraint.html#adf4a50693080c1083d828f2e88da3156">enforce</a>);
<a name="l02192"></a>02192         }
<a name="l02193"></a>02193     }
<a name="l02194"></a>02194     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(poseMat[3], poseHead);
<a name="l02195"></a>02195 
<a name="l02196"></a>02196     <span class="comment">/* finally, store the new transform */</span>
<a name="l02197"></a>02197     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, poseMat);
<a name="l02198"></a>02198     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, poseHead);
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     <span class="comment">/* recalculate tail, as it&#39;s now outdated after the head gets adjusted above! */</span>
<a name="l02201"></a>02201     <a class="code" href="../../da/d17/BKE__armature_8h.html#a63dd4e4d7623a5645dcabdb7f28a7f63">where_is_pose_bone_tail</a>(pchan);
<a name="l02202"></a>02202 
<a name="l02203"></a>02203     <span class="comment">/* done! */</span>
<a name="l02204"></a>02204     pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> |= <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>;
<a name="l02205"></a>02205 }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207 <span class="comment">/* Evaluate the chain starting from the nominated bone */</span>
<a name="l02208"></a><a class="code" href="../../d9/d2b/armature_8c.html#ad704eaf523255ad3ed058b332e894945">02208</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#ad704eaf523255ad3ed058b332e894945">splineik_execute_tree</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan_root, <span class="keywordtype">float</span> ctime)
<a name="l02209"></a>02209 {
<a name="l02210"></a>02210     <a class="code" href="../../d0/d13/structtSplineIK__Tree.html">tSplineIK_Tree</a> *tree;
<a name="l02211"></a>02211 
<a name="l02212"></a>02212     <span class="comment">/* for each pose-tree, execute it if it is spline, otherwise just free it */</span>
<a name="l02213"></a>02213     <span class="keywordflow">while</span> ((tree = pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#afbc80aa935e8bd461de32493694a7bff">siktree</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02214"></a>02214         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216         <span class="comment">/* walk over each bone in the chain, calculating the effects of spline IK</span>
<a name="l02217"></a>02217 <span class="comment">         *     - the chain is traversed in the opposite order to storage order (i.e. parent to children)</span>
<a name="l02218"></a>02218 <span class="comment">         *       so that dependencies are correct</span>
<a name="l02219"></a>02219 <span class="comment">         */</span>
<a name="l02220"></a>02220         <span class="keywordflow">for</span> (i = tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a62ac5e24058ecff0d1b2a7e891428725">chainlen</a>-1; i &gt;= 0; i--) {
<a name="l02221"></a>02221             <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan = tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02222"></a>02222             <a class="code" href="../../d9/d2b/armature_8c.html#a0ed0a20623295ba338e20a654d734302">splineik_evaluate_bone</a>(tree, scene, ob, pchan, i, ctime);
<a name="l02223"></a>02223         }
<a name="l02224"></a>02224 
<a name="l02225"></a>02225         <span class="comment">/* free the tree info specific to SplineIK trees now */</span>
<a name="l02226"></a>02226         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a>)
<a name="l02227"></a>02227             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a3a15b3aa48e9759c02736ac954c03b8a">chain</a>);
<a name="l02228"></a>02228         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a38c2f687f208d45f86b74a798717d312">free_points</a>)
<a name="l02229"></a>02229             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../d0/d13/structtSplineIK__Tree.html#a89cbf5460cbc72ce56b23e79e209e44c">points</a>);
<a name="l02230"></a>02230 
<a name="l02231"></a>02231         <span class="comment">/* free this tree */</span>
<a name="l02232"></a>02232         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;pchan_root-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#afbc80aa935e8bd461de32493694a7bff">siktree</a>, tree);
<a name="l02233"></a>02233     }
<a name="l02234"></a>02234 }
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 <span class="comment">/* ********************** THE POSE SOLVER ******************* */</span>
<a name="l02237"></a>02237 
<a name="l02238"></a>02238 <span class="comment">/* loc/rot/size to given mat4 */</span>
<a name="l02239"></a><a class="code" href="../../d9/d2b/armature_8c.html#a9c3a7bb65787876c3e7d20d8a83ebc52">02239</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a8522165732c241ac79d83f3e55955931">pchan_to_mat4</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> chan_mat[4][4])
<a name="l02240"></a>02240 {
<a name="l02241"></a>02241     <span class="keywordtype">float</span> smat[3][3];
<a name="l02242"></a>02242     <span class="keywordtype">float</span> rmat[3][3];
<a name="l02243"></a>02243     <span class="keywordtype">float</span> tmat[3][3];
<a name="l02244"></a>02244 
<a name="l02245"></a>02245     <span class="comment">/* get scaling matrix */</span>
<a name="l02246"></a>02246     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a32ceca78461c61d0dbda46632ccb0f8f">size_to_mat3</a>(smat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a9da92496b65a5f7ee51a007b7d30a6e9">size</a>);
<a name="l02247"></a>02247 
<a name="l02248"></a>02248     <span class="comment">/* rotations may either be quats, eulers (with various rotation orders), or axis-angle */</span>
<a name="l02249"></a>02249     <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> &gt; 0) {
<a name="l02250"></a>02250         <span class="comment">/* euler rotations (will cause gimble lock, but this can be alleviated a bit with rotation orders) */</span>
<a name="l02251"></a>02251         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa6973857a6a1d26c0155bb21f4b6de01">eulO_to_mat3</a>(rmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a170758ca33f0507932e671c5449bd541">eul</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a>);
<a name="l02252"></a>02252     }
<a name="l02253"></a>02253     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a06e5397e6647572a9bf92443589285ff">rotmode</a> == <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#a753c8daa50876b6f5773b9ec831dddaca6fd1324ea35af2fbf6879b35d73ea547">ROT_MODE_AXISANGLE</a>) {
<a name="l02254"></a>02254         <span class="comment">/* axis-angle - not really that great for 3D-changing orientations */</span>
<a name="l02255"></a>02255         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aa804c4cef742fd7a1dd820bf0128ad4a">axis_angle_to_mat3</a>(rmat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a333f3e39794d13ca0105efed79e95e62">rotAxis</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#aa3d077b509f2faff5b8391fbb157f0a8">rotAngle</a>);
<a name="l02256"></a>02256     }
<a name="l02257"></a>02257     <span class="keywordflow">else</span> {
<a name="l02258"></a>02258         <span class="comment">/* quats are normalised before use to eliminate scaling issues */</span>
<a name="l02259"></a>02259         <span class="keywordtype">float</span> quat[4];
<a name="l02260"></a>02260 
<a name="l02261"></a>02261         <span class="comment">/* NOTE: we now don&#39;t normalize the stored values anymore, since this was kindof evil in some cases</span>
<a name="l02262"></a>02262 <span class="comment">         * but if this proves to be too problematic, switch back to the old system of operating directly on</span>
<a name="l02263"></a>02263 <span class="comment">         * the stored copy</span>
<a name="l02264"></a>02264 <span class="comment">         */</span>
<a name="l02265"></a>02265         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ac6d9c2d913e7b6f0686db690ba55bc3e">normalize_qt_qt</a>(quat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a6788cc31b26081e0abbb5c3534efa0ba">quat</a>);
<a name="l02266"></a>02266         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ae0343d0ff2af81f054d3916277409507">quat_to_mat3</a>(rmat, quat);
<a name="l02267"></a>02267     }
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     <span class="comment">/* calculate matrix of bone (as 3x3 matrix, but then copy the 4x4) */</span>
<a name="l02270"></a>02270     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(tmat, rmat, smat);
<a name="l02271"></a>02271     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(chan_mat, tmat);
<a name="l02272"></a>02272 
<a name="l02273"></a>02273     <span class="comment">/* prevent action channels breaking chains */</span>
<a name="l02274"></a>02274     <span class="comment">/* need to check for bone here, CONSTRAINT_TYPE_ACTION uses this call */</span>
<a name="l02275"></a>02275     <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || !(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>)) {
<a name="l02276"></a>02276         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(chan_mat[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ac0f475005d700752b614260d043d3100">loc</a>);
<a name="l02277"></a>02277     }
<a name="l02278"></a>02278 }
<a name="l02279"></a>02279 
<a name="l02280"></a>02280 <span class="comment">/* loc/rot/size to mat4 */</span>
<a name="l02281"></a>02281 <span class="comment">/* used in constraint.c too */</span>
<a name="l02282"></a><a class="code" href="../../d9/d2b/armature_8c.html#a246070f781f6c839848d2a55db97bc30">02282</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a2e78133dba2aa52c16143f9cc1f5c53e">pchan_calc_mat</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l02283"></a>02283 {
<a name="l02284"></a>02284     <span class="comment">/* this is just a wrapper around the copy of this function which calculates the matrix</span>
<a name="l02285"></a>02285 <span class="comment">     * and stores the result in any given channel</span>
<a name="l02286"></a>02286 <span class="comment">     */</span>
<a name="l02287"></a>02287     <a class="code" href="../../da/d17/BKE__armature_8h.html#a8522165732c241ac79d83f3e55955931">pchan_to_mat4</a>(pchan, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>);
<a name="l02288"></a>02288 }
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 <span class="preprocessor">#if 0 </span><span class="comment">/* XXX OLD ANIMSYS, NLASTRIPS ARE NO LONGER USED */</span>
<a name="l02291"></a>02291 
<a name="l02292"></a>02292 <span class="comment">/* NLA strip modifiers */</span>
<a name="l02293"></a>02293 <span class="keyword">static</span> <span class="keywordtype">void</span> do_strip_modifiers(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *armob, <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l02294"></a>02294 {
<a name="l02295"></a>02295     <a class="code" href="../../d6/d55/structbActionModifier.html">bActionModifier</a> *amod;
<a name="l02296"></a>02296     <a class="code" href="../../d5/d84/structbActionStrip.html">bActionStrip</a> *strip, *strip2;
<a name="l02297"></a>02297     <span class="keywordtype">float</span> scene_cfra= (float)scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l02298"></a>02298     <span class="keywordtype">int</span> do_modif;
<a name="l02299"></a>02299 
<a name="l02300"></a>02300     for (strip=armob-&gt;nlastrips.first; strip; strip=strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>) {
<a name="l02301"></a>02301         do_modif=0;
<a name="l02302"></a>02302 
<a name="l02303"></a>02303         <span class="keywordflow">if</span> (scene_cfra&gt;=strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4e6af4c6c0ab48d38415b188306d2de8">start</a> &amp;&amp; scene_cfra&lt;=strip-&gt;end)
<a name="l02304"></a>02304             do_modif=1;
<a name="l02305"></a>02305 
<a name="l02306"></a>02306         <span class="keywordflow">if</span> ((scene_cfra &gt; strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a835d71d7c8291316173111f9550e2b81">end</a>) &amp;&amp; (strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#ad7ec9ba02c5f3dce1203a0536e6c7708">flag</a> &amp; <a class="code" href="../../db/db5/DNA__nla__types_8h.html#ac3143e0e96fb3d405cb6160e1a8ab0a3a9dd720684f223211ff0ecde7d17ebf56">ACTSTRIP_HOLDLASTFRAME</a>)) {
<a name="l02307"></a>02307             do_modif=1;
<a name="l02308"></a>02308 
<a name="l02309"></a>02309             <span class="comment">/* if there are any other strips active, ignore modifiers for this strip -</span>
<a name="l02310"></a>02310 <span class="comment">             * &#39;hold&#39; option should only hold action modifiers if there are</span>
<a name="l02311"></a>02311 <span class="comment">             * no other active strips */</span>
<a name="l02312"></a>02312             <span class="keywordflow">for</span> (strip2=strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>; strip2; strip2=strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>) {
<a name="l02313"></a>02313                 <span class="keywordflow">if</span> (strip2 == strip) <span class="keywordflow">continue</span>;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315                 <span class="keywordflow">if</span> (scene_cfra&gt;=strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4e6af4c6c0ab48d38415b188306d2de8">start</a> &amp;&amp; scene_cfra&lt;=strip2-&gt;end) {
<a name="l02316"></a>02316                     <span class="keywordflow">if</span> (!(strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#ad7ec9ba02c5f3dce1203a0536e6c7708">flag</a> &amp; <a class="code" href="../../db/db5/DNA__nla__types_8h.html#ac3143e0e96fb3d405cb6160e1a8ab0a3a5c5edc1435bb060ee42615cbcf76d1dc">ACTSTRIP_MUTE</a>))
<a name="l02317"></a>02317                         do_modif=0;
<a name="l02318"></a>02318                 }
<a name="l02319"></a>02319             }
<a name="l02320"></a>02320 
<a name="l02321"></a>02321             <span class="comment">/* if there are any later, activated, strips with &#39;hold&#39; set, they take precedence,</span>
<a name="l02322"></a>02322 <span class="comment">             * so ignore modifiers for this strip */</span>
<a name="l02323"></a>02323             <span class="keywordflow">for</span> (strip2=strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>; strip2; strip2=strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>) {
<a name="l02324"></a>02324                 <span class="keywordflow">if</span> (scene_cfra &lt; strip2-&gt;start) <span class="keywordflow">continue</span>;
<a name="l02325"></a>02325                 <span class="keywordflow">if</span> ((strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#ad7ec9ba02c5f3dce1203a0536e6c7708">flag</a> &amp; <a class="code" href="../../db/db5/DNA__nla__types_8h.html#ac3143e0e96fb3d405cb6160e1a8ab0a3a9dd720684f223211ff0ecde7d17ebf56">ACTSTRIP_HOLDLASTFRAME</a>) &amp;&amp; !(strip2-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#ad7ec9ba02c5f3dce1203a0536e6c7708">flag</a> &amp; <a class="code" href="../../db/db5/DNA__nla__types_8h.html#ac3143e0e96fb3d405cb6160e1a8ab0a3a5c5edc1435bb060ee42615cbcf76d1dc">ACTSTRIP_MUTE</a>)) {
<a name="l02326"></a>02326                     do_modif=0;
<a name="l02327"></a>02327                 }
<a name="l02328"></a>02328             }
<a name="l02329"></a>02329         }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331         <span class="keywordflow">if</span> (do_modif) {
<a name="l02332"></a>02332             <span class="comment">/* temporal solution to prevent 2 strips accumulating */</span>
<a name="l02333"></a>02333             <span class="keywordflow">if</span> (scene_cfra==strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a835d71d7c8291316173111f9550e2b81">end</a> &amp;&amp; strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a> &amp;&amp; strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4db006cf84d35eed981ef557bdd9f126">next</a>-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#a4e6af4c6c0ab48d38415b188306d2de8">start</a>==scene_cfra)
<a name="l02334"></a>02334                 <span class="keywordflow">continue</span>;
<a name="l02335"></a>02335 
<a name="l02336"></a>02336             <span class="keywordflow">for</span> (amod= strip-&gt;<a class="code" href="../../d5/d84/structbActionStrip.html#aa16f01023db7f917b8a9178ee7cf0268">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; amod; amod= amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aa0e3dcac1921d79fe6c3512b9cc9a762">next</a>) {
<a name="l02337"></a>02337                 <span class="keywordflow">switch</span> (amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aa4c96ed1df076b66e523efd9e2a6466a">type</a>) {
<a name="l02338"></a>02338                 <span class="keywordflow">case</span> <a class="code" href="../../db/db5/DNA__nla__types_8h.html#a37f6752b7e093e267887512c4cb33ad9">ACTSTRIP_MOD_DEFORM</a>:
<a name="l02339"></a>02339                 {
<a name="l02340"></a>02340                     <span class="comment">/* validate first */</span>
<a name="l02341"></a>02341                     <span class="keywordflow">if</span> (amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a56596d41dbe4b9ba69a7aabd9fcbca31">ob</a> &amp;&amp; amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a56596d41dbe4b9ba69a7aabd9fcbca31">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a> &amp;&amp; amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aabaec0cffc7463c709b9163d1d35686e">channel</a>[0]) {
<a name="l02342"></a>02342 
<a name="l02343"></a>02343                         <span class="keywordflow">if</span> ( strcmp(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aabaec0cffc7463c709b9163d1d35686e">channel</a>)==0 ) {
<a name="l02344"></a>02344                             <span class="keywordtype">float</span> mat4[4][4], mat3[3][3];
<a name="l02345"></a>02345 
<a name="l02346"></a>02346                             <a class="code" href="../../d8/d8f/BKE__lattice_8h.html#a80f8584d280abb72b6323997fe03f745">curve_deform_vector</a>(scene, amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a56596d41dbe4b9ba69a7aabd9fcbca31">ob</a>, armob, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>[3], pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], mat3, amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a86d6f750b0bf3398f2f0ed000299b983">no_rot_axis</a>);
<a name="l02347"></a>02347                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat4, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l02348"></a>02348                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad9a7248dd2f3d52b786c2476b05daa76">mul_m4_m3m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, mat3, mat4);
<a name="l02349"></a>02349 
<a name="l02350"></a>02350                         }
<a name="l02351"></a>02351                     }
<a name="l02352"></a>02352                 }
<a name="l02353"></a>02353                     <span class="keywordflow">break</span>;
<a name="l02354"></a>02354                 <span class="keywordflow">case</span> <a class="code" href="../../db/db5/DNA__nla__types_8h.html#a5b114171c4537b36bdd438a4fb7b0a29">ACTSTRIP_MOD_NOISE</a>:
<a name="l02355"></a>02355                 {
<a name="l02356"></a>02356                     <span class="keywordflow">if</span> ( strcmp(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aabaec0cffc7463c709b9163d1d35686e">channel</a>)==0 ) {
<a name="l02357"></a>02357                         <span class="keywordtype">float</span> nor[3], loc[3], ofs;
<a name="l02358"></a>02358                         <span class="keywordtype">float</span> eul[3], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>[3], eulo[3], sizeo[3];
<a name="l02359"></a>02359 
<a name="l02360"></a>02360                         <span class="comment">/* calculate turbulance */</span>
<a name="l02361"></a>02361                         ofs = amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#afe2e88cb92c95f6306def0bfd3a58b74">turbul</a> / 200.0f;
<a name="l02362"></a>02362 
<a name="l02363"></a>02363                         <span class="comment">/* make a copy of starting conditions */</span>
<a name="l02364"></a>02364                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(loc, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l02365"></a>02365                         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#abaa23f334189d294344e4c161701ddb2">mat4_to_eul</a>( eul,pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l02366"></a>02366                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a245c1bf7630bef5c065994ea56751d21">mat4_to_size</a>( size,pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l02367"></a>02367                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(eulo, eul);
<a name="l02368"></a>02368                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sizeo, size);
<a name="l02369"></a>02369 
<a name="l02370"></a>02370                         <span class="comment">/* apply noise to each set of channels */</span>
<a name="l02371"></a>02371                         <span class="keywordflow">if</span> (amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aa34672e837e0d07f60f19b740c0086db">channels</a> &amp; 4) {
<a name="l02372"></a>02372                             <span class="comment">/* for scaling */</span>
<a name="l02373"></a>02373                             nor[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, size[0]+ofs, size[1], size[2], 0, 0) - ofs;
<a name="l02374"></a>02374                             nor[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, size[0], size[1]+ofs, size[2], 0, 0) - ofs;
<a name="l02375"></a>02375                             nor[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, size[0], size[1], size[2]+ofs, 0, 0) - ofs;
<a name="l02376"></a>02376                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(size, nor);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378                             <span class="keywordflow">if</span> (sizeo[0] != 0)
<a name="l02379"></a>02379                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[0], size[0] / sizeo[0]);
<a name="l02380"></a>02380                             <span class="keywordflow">if</span> (sizeo[1] != 0)
<a name="l02381"></a>02381                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1], size[1] / sizeo[1]);
<a name="l02382"></a>02382                             <span class="keywordflow">if</span> (sizeo[2] != 0)
<a name="l02383"></a>02383                                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[2], size[2] / sizeo[2]);
<a name="l02384"></a>02384                         }
<a name="l02385"></a>02385                         <span class="keywordflow">if</span> (amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aa34672e837e0d07f60f19b740c0086db">channels</a> &amp; 2) {
<a name="l02386"></a>02386                             <span class="comment">/* for rotation */</span>
<a name="l02387"></a>02387                             nor[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, eul[0]+ofs, eul[1], eul[2], 0, 0) - ofs;
<a name="l02388"></a>02388                             nor[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, eul[0], eul[1]+ofs, eul[2], 0, 0) - ofs;
<a name="l02389"></a>02389                             nor[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, eul[0], eul[1], eul[2]+ofs, 0, 0) - ofs;
<a name="l02390"></a>02390 
<a name="l02391"></a>02391                             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad1b2afdb475f2fe8056611c91b9a5aa9">compatible_eul</a>(nor, eulo);
<a name="l02392"></a>02392                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(eul, nor);
<a name="l02393"></a>02393                             <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ad1b2afdb475f2fe8056611c91b9a5aa9">compatible_eul</a>(eul, eulo);
<a name="l02394"></a>02394 
<a name="l02395"></a>02395                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acf74612696ab3ca9132d97e7006bd1b7">loc_eul_size_to_mat4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, loc, eul, size);
<a name="l02396"></a>02396                         }
<a name="l02397"></a>02397                         <span class="keywordflow">if</span> (amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#aa34672e837e0d07f60f19b740c0086db">channels</a> &amp; 1) {
<a name="l02398"></a>02398                             <span class="comment">/* for location */</span>
<a name="l02399"></a>02399                             nor[0] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, loc[0]+ofs, loc[1], loc[2], 0, 0) - ofs;
<a name="l02400"></a>02400                             nor[1] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, loc[0], loc[1]+ofs, loc[2], 0, 0) - ofs;
<a name="l02401"></a>02401                             nor[2] = <a class="code" href="../../d1/d65/BLI__noise_8h.html#a1c119d9034dda320335cc260f49d8f43">BLI_gNoise</a>(amod-&gt;<a class="code" href="../../d6/d55/structbActionModifier.html#a76c693daca4949e28de62a87fbcb9aa3">noisesize</a>, loc[0], loc[1], loc[2]+ofs, 0, 0) - ofs;
<a name="l02402"></a>02402 
<a name="l02403"></a>02403                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], loc, nor);
<a name="l02404"></a>02404                         }
<a name="l02405"></a>02405                     }
<a name="l02406"></a>02406                 }
<a name="l02407"></a>02407                     <span class="keywordflow">break</span>;
<a name="l02408"></a>02408                 }
<a name="l02409"></a>02409             }
<a name="l02410"></a>02410         }
<a name="l02411"></a>02411     }
<a name="l02412"></a>02412 }
<a name="l02413"></a>02413 
<a name="l02414"></a>02414 <span class="preprocessor">#endif</span>
<a name="l02415"></a>02415 <span class="preprocessor"></span>
<a name="l02416"></a>02416 <span class="comment">/* calculate tail of posechannel */</span>
<a name="l02417"></a><a class="code" href="../../d9/d2b/armature_8c.html#abedb46e4171e59e9fddd05b74c3ebf20">02417</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a63dd4e4d7623a5645dcabdb7f28a7f63">where_is_pose_bone_tail</a>(<a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan)
<a name="l02418"></a>02418 {
<a name="l02419"></a>02419     <span class="keywordtype">float</span> vec[3];
<a name="l02420"></a>02420 
<a name="l02421"></a>02421     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[1]);
<a name="l02422"></a>02422     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ab7128f767dae0e0af9129bbdc7f26278">length</a>);
<a name="l02423"></a>02423     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, vec);
<a name="l02424"></a>02424 }
<a name="l02425"></a>02425 
<a name="l02426"></a>02426 <span class="comment">/* The main armature solver, does all constraints excluding IK */</span>
<a name="l02427"></a>02427 <span class="comment">/* pchan is validated, as having bone and parent pointer</span>
<a name="l02428"></a>02428 <span class="comment"> * &#39;do_extra&#39;: when zero skips loc/size/rot, constraints and strip modifiers.</span>
<a name="l02429"></a>02429 <span class="comment"> */</span>
<a name="l02430"></a><a class="code" href="../../d9/d2b/armature_8c.html#a009de9c9c870238875ed1da9c8c6319f">02430</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan, <span class="keywordtype">float</span> ctime, <span class="keywordtype">int</span> do_extra)
<a name="l02431"></a>02431 {
<a name="l02432"></a>02432     <span class="comment">/* This gives a chan_mat with actions (ipos) results. */</span>
<a name="l02433"></a>02433     <span class="keywordflow">if</span> (do_extra)
<a name="l02434"></a>02434         <a class="code" href="../../da/d17/BKE__armature_8h.html#a2e78133dba2aa52c16143f9cc1f5c53e">pchan_calc_mat</a>(pchan);
<a name="l02435"></a>02435     <span class="keywordflow">else</span>
<a name="l02436"></a>02436         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>);
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     <span class="comment">/* Construct the posemat based on PoseChannels, that we do before applying constraints. */</span>
<a name="l02439"></a>02439     <span class="comment">/* pose_mat(b) = pose_mat(b-1) * yoffs(b-1) * d_root(b) * bone_mat(b) * chan_mat(b) */</span>
<a name="l02440"></a>02440     <a class="code" href="../../da/d17/BKE__armature_8h.html#aeb07e5cf42aa6166af08341ecf116f03">armature_mat_bone_to_pose</a>(pchan, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>);
<a name="l02441"></a>02441 <span class="preprocessor">#if 0 </span><span class="comment">/* XXX Old code, will remove this later. */</span>
<a name="l02442"></a>02442     {
<a name="l02443"></a>02443         <span class="keywordtype">float</span> rotscale_mat[4][4], loc_mat[4][4];
<a name="l02444"></a>02444         <a class="code" href="../../da/d17/BKE__armature_8h.html#ac39d3579212f71cac3e7deb7697273dc">pchan_to_pose_mat</a>(pchan, rotscale_mat, loc_mat);
<a name="l02445"></a>02445         <span class="comment">/* Rotation and scale. */</span>
<a name="l02446"></a>02446         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, rotscale_mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>);
<a name="l02447"></a>02447         <span class="comment">/* Location. */</span>
<a name="l02448"></a>02448         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], loc_mat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>[3]);
<a name="l02449"></a>02449     }
<a name="l02450"></a>02450 <span class="preprocessor">#endif</span>
<a name="l02451"></a>02451 <span class="preprocessor"></span>
<a name="l02452"></a>02452     <span class="comment">/* Only rootbones get the cyclic offset (unless user doesn&#39;t want that). */</span>
<a name="l02453"></a>02453     <span class="comment">/* XXX That could be a problem for snapping and other &quot;reverse transform&quot; features... */</span>
<a name="l02454"></a>02454     <span class="keywordflow">if</span> (!pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a331eee45a012f6f42d5a52acbf484547">parent</a>) {
<a name="l02455"></a>02455         <span class="keywordflow">if</span> ((pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a2144fe3882bb6af627bc9ea3a99fae38">BONE_NO_CYCLICOFFSET</a>) == 0)
<a name="l02456"></a>02456             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#af0175ae828bd5ae23981bfe981f2bd3c">cyclic_offset</a>);
<a name="l02457"></a>02457     }
<a name="l02458"></a>02458 
<a name="l02459"></a>02459     <span class="keywordflow">if</span> (do_extra) {
<a name="l02460"></a>02460 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX OLD ANIMSYS, NLASTRIPS ARE NO LONGER USED */</span>
<a name="l02461"></a>02461         <span class="comment">/* do NLA strip modifiers - i.e. curve follow */</span>
<a name="l02462"></a>02462         do_strip_modifiers(scene, ob, bone, pchan);
<a name="l02463"></a>02463 <span class="preprocessor">#endif</span>
<a name="l02464"></a>02464 <span class="preprocessor"></span>
<a name="l02465"></a>02465         <span class="comment">/* Do constraints */</span>
<a name="l02466"></a>02466         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l02467"></a>02467             <a class="code" href="../../d0/d58/structbConstraintOb.html">bConstraintOb</a> *cob;
<a name="l02468"></a>02468             <span class="keywordtype">float</span> vec[3];
<a name="l02469"></a>02469 
<a name="l02470"></a>02470             <span class="comment">/* make a copy of location of PoseChannel for later */</span>
<a name="l02471"></a>02471             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l02472"></a>02472 
<a name="l02473"></a>02473             <span class="comment">/* prepare PoseChannel for Constraint solving</span>
<a name="l02474"></a>02474 <span class="comment">             * - makes a copy of matrix, and creates temporary struct to use</span>
<a name="l02475"></a>02475 <span class="comment">             */</span>
<a name="l02476"></a>02476             cob = <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a66ae7f7e0e8d070e5cef7e791045a132">constraints_make_evalob</a>(scene, ob, pchan, <a class="code" href="../../db/d03/DNA__constraint__types_8h.html#adfb54b57e8687ce7b32072d253bfde5ca8f84f807a0f7d3897ed2a2d07dbb93d8">CONSTRAINT_OBTYPE_BONE</a>);
<a name="l02477"></a>02477 
<a name="l02478"></a>02478             <span class="comment">/* Solve PoseChannel&#39;s Constraints */</span>
<a name="l02479"></a>02479             <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#a54c37cdbf9d13a3c52a7adad1d701608">solve_constraints</a>(&amp;pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a0374b80987b804af0b60a4930f3b5e0b">constraints</a>, cob, ctime); <span class="comment">/* ctime doesnt alter objects */</span>
<a name="l02480"></a>02480 
<a name="l02481"></a>02481             <span class="comment">/* cleanup after Constraint Solving</span>
<a name="l02482"></a>02482 <span class="comment">             * - applies matrix back to pchan, and frees temporary struct used</span>
<a name="l02483"></a>02483 <span class="comment">             */</span>
<a name="l02484"></a>02484             <a class="code" href="../../d4/ddd/BKE__constraint_8h.html#afd27f475b6d3ed93b5f045e201dcf687">constraints_clear_evalob</a>(cob);
<a name="l02485"></a>02485 
<a name="l02486"></a>02486             <span class="comment">/* prevent constraints breaking a chain */</span>
<a name="l02487"></a>02487             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ad1063cb445c506fbb2eacef9f453a36e">BONE_CONNECTED</a>) {
<a name="l02488"></a>02488                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3], vec);
<a name="l02489"></a>02489             }
<a name="l02490"></a>02490         }
<a name="l02491"></a>02491     }
<a name="l02492"></a>02492 
<a name="l02493"></a>02493     <span class="comment">/* calculate head */</span>
<a name="l02494"></a>02494     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>[3]);
<a name="l02495"></a>02495     <span class="comment">/* calculate tail */</span>
<a name="l02496"></a>02496     <a class="code" href="../../da/d17/BKE__armature_8h.html#a63dd4e4d7623a5645dcabdb7f28a7f63">where_is_pose_bone_tail</a>(pchan);
<a name="l02497"></a>02497 }
<a name="l02498"></a>02498 
<a name="l02499"></a>02499 <span class="comment">/* This only reads anim data from channels, and writes to channels */</span>
<a name="l02500"></a>02500 <span class="comment">/* This is the only function adding poses */</span>
<a name="l02501"></a><a class="code" href="../../d9/d2b/armature_8c.html#a6b2dfe1644f7c5fda7d7c00c6279b780">02501</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a3fe187591b5f112128d0139196accf48">where_is_pose</a> (<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02502"></a>02502 {
<a name="l02503"></a>02503     <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm;
<a name="l02504"></a>02504     <a class="code" href="../../de/de0/structBone.html">Bone</a> *bone;
<a name="l02505"></a>02505     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l02506"></a>02506     <span class="keywordtype">float</span> imat[4][4];
<a name="l02507"></a>02507     <span class="keywordtype">float</span> ctime;
<a name="l02508"></a>02508 
<a name="l02509"></a>02509     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l02510"></a>02510         <span class="keywordflow">return</span>;
<a name="l02511"></a>02511     arm = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02512"></a>02512 
<a name="l02513"></a>02513     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, arm, scene))
<a name="l02514"></a>02514         <span class="keywordflow">return</span>;
<a name="l02515"></a>02515     <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a64ec87fedfe2de572e1c5418d9eac677">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#adcdc440dbd940088a1e1af80558e483daa8b3bbff9fe194cbe52e3aad051a19a6">POSE_RECALC</a>))
<a name="l02516"></a>02516         <a class="code" href="../../da/d17/BKE__armature_8h.html#a565b57760b56c855cc22ee91ff4f6225">armature_rebuild_pose</a>(ob, arm);
<a name="l02517"></a>02517 
<a name="l02518"></a>02518     ctime = <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(scene); <span class="comment">/* not accurate... */</span>
<a name="l02519"></a>02519 
<a name="l02520"></a>02520     <span class="comment">/* In editmode or restposition we read the data from the bones */</span>
<a name="l02521"></a>02521     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a> || (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac337b0eea0271aed9184660bb1973c1e">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad38d1c1c7e5b42142c4cc02bd6800837afeb06264694b2a1ee2ca0634a0c47732">ARM_RESTPOS</a>)) {
<a name="l02522"></a>02522         <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02523"></a>02523             bone = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>;
<a name="l02524"></a>02524             <span class="keywordflow">if</span> (bone) {
<a name="l02525"></a>02525                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l02526"></a>02526                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a61421ab678dab0140c6d8022b5166ae8">arm_head</a>);
<a name="l02527"></a>02527                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, bone-&gt;<a class="code" href="../../de/de0/structBone.html#a6d1bafbd60d8b4a424cecc108259c781">arm_tail</a>);
<a name="l02528"></a>02528             }
<a name="l02529"></a>02529         }
<a name="l02530"></a>02530     }
<a name="l02531"></a>02531     <span class="keywordflow">else</span> {
<a name="l02532"></a>02532         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>); <span class="comment">/* imat is needed */</span>
<a name="l02533"></a>02533 
<a name="l02534"></a>02534         <span class="comment">/* 1. clear flags */</span>
<a name="l02535"></a>02535         <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02536"></a>02536             pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp;= ~(<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a45df786202540b33bd594ae29438d90f">POSE_CHAIN</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a109821706241e25864cface202adbe0c">POSE_IKTREE</a>|<a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a1782dec86eb400cd32f7aa6f96354650">POSE_IKSPLINE</a>);
<a name="l02537"></a>02537         }
<a name="l02538"></a>02538 
<a name="l02539"></a>02539         <span class="comment">/* 2a. construct the IK tree (standard IK) */</span>
<a name="l02540"></a>02540         <a class="code" href="../../d8/dd6/BIK__api_8h.html#ad072967c06b6de889b726c6be82975b9">BIK_initialize_tree</a>(scene, ob, ctime);
<a name="l02541"></a>02541 
<a name="l02542"></a>02542         <span class="comment">/* 2b. construct the Spline IK trees</span>
<a name="l02543"></a>02543 <span class="comment">         *  - this is not integrated as an IK plugin, since it should be able</span>
<a name="l02544"></a>02544 <span class="comment">         *    to function in conjunction with standard IK</span>
<a name="l02545"></a>02545 <span class="comment">         */</span>
<a name="l02546"></a>02546         <a class="code" href="../../d9/d2b/armature_8c.html#ab4685eddaf2de62c2f005964d75c1087">splineik_init_tree</a>(scene, ob, ctime);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548         <span class="comment">/* 3. the main loop, channels are already hierarchical sorted from root to children */</span>
<a name="l02549"></a>02549         <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02550"></a>02550             <span class="comment">/* 4a. if we find an IK root, we handle it separated */</span>
<a name="l02551"></a>02551             <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a109821706241e25864cface202adbe0c">POSE_IKTREE</a>) {
<a name="l02552"></a>02552                 <a class="code" href="../../d8/dd6/BIK__api_8h.html#a366bffb55af6040aa759ab719d045f4a">BIK_execute_tree</a>(scene, ob, pchan, ctime);
<a name="l02553"></a>02553             }
<a name="l02554"></a>02554             <span class="comment">/* 4b. if we find a Spline IK root, we handle it separated too */</span>
<a name="l02555"></a>02555             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a1782dec86eb400cd32f7aa6f96354650">POSE_IKSPLINE</a>) {
<a name="l02556"></a>02556                 <a class="code" href="../../d9/d2b/armature_8c.html#ad704eaf523255ad3ed058b332e894945">splineik_execute_tree</a>(scene, ob, pchan, ctime);
<a name="l02557"></a>02557             }
<a name="l02558"></a>02558             <span class="comment">/* 5. otherwise just call the normal solver */</span>
<a name="l02559"></a>02559             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a7d2af4aa1ea500333f5342449c1992ce">flag</a> &amp; <a class="code" href="../../dc/d2a/DNA__action__types_8h.html#ac0c689f38e4bba7c1c19bcae920efa78a074da14517697cd7e5574fb16a05d9d9">POSE_DONE</a>)) {
<a name="l02560"></a>02560                 <a class="code" href="../../da/d17/BKE__armature_8h.html#aacfce9f57487a2c2df6850d9b1c2a3ee">where_is_pose_bone</a>(scene, ob, pchan, ctime, 1);
<a name="l02561"></a>02561             }
<a name="l02562"></a>02562         }
<a name="l02563"></a>02563         <span class="comment">/* 6. release the IK tree */</span>
<a name="l02564"></a>02564         <a class="code" href="../../d8/dd6/BIK__api_8h.html#a68a35357321346c85ef36a1a177ce82b">BIK_release_tree</a>(scene, ob, ctime);
<a name="l02565"></a>02565     }
<a name="l02566"></a>02566 
<a name="l02567"></a>02567     <span class="comment">/* calculating deform matrices */</span>
<a name="l02568"></a>02568     <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02569"></a>02569         <span class="keywordflow">if</span> (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>) {
<a name="l02570"></a>02570             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#ac5365d4b57959d83787fe04d546beb1b">arm_mat</a>);
<a name="l02571"></a>02571             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a4651f42d770dea3cd01ee8680356abf0">chan_mat</a>, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#ad23f235559683327d9de9463e878401c">pose_mat</a>, imat);
<a name="l02572"></a>02572         }
<a name="l02573"></a>02573     }
<a name="l02574"></a>02574 }
<a name="l02575"></a>02575 
<a name="l02576"></a>02576 
<a name="l02577"></a>02577 <span class="comment">/* Returns total selected vgroups,</span>
<a name="l02578"></a>02578 <span class="comment"> * wpi.defbase_sel is assumed malloc&#39;d, all values are set */</span>
<a name="l02579"></a><a class="code" href="../../d9/d2b/armature_8c.html#a906bb11008b5d243474966d3d0d31619">02579</a> <span class="keywordtype">int</span> <a class="code" href="../../da/d17/BKE__armature_8h.html#a5a61334aef7488589135bfb9f2f8d447">get_selected_defgroups</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">char</span> *dg_selection, <span class="keywordtype">int</span> defbase_tot)
<a name="l02580"></a>02580 {
<a name="l02581"></a>02581     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *defgroup;
<a name="l02582"></a>02582     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02583"></a>02583     <a class="code" href="../../de/de7/structObject.html">Object</a> *armob = <a class="code" href="../../df/dac/BKE__object_8h.html#a7c81fbe77e3bc5283e2746857d88c94c">object_pose_armature_get</a>(ob);
<a name="l02584"></a>02584     <span class="keywordtype">int</span> dg_flags_sel_tot = 0;
<a name="l02585"></a>02585 
<a name="l02586"></a>02586     <span class="keywordflow">if</span> (armob) {
<a name="l02587"></a>02587         <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose = armob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l02588"></a>02588         <span class="keywordflow">for</span> (i = 0, defgroup = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; i &lt; defbase_tot &amp;&amp; defgroup; defgroup = defgroup-&gt;<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, i++) {
<a name="l02589"></a>02589             <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(pose, defgroup-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>);
<a name="l02590"></a>02590             <span class="keywordflow">if</span> (pchan &amp;&amp; (pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50a176833e258350f5e845cfb780a4c280c">BONE_SELECTED</a>)) {
<a name="l02591"></a>02591                 dg_selection[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02592"></a>02592                 dg_flags_sel_tot++;
<a name="l02593"></a>02593             }
<a name="l02594"></a>02594             <span class="keywordflow">else</span> {
<a name="l02595"></a>02595                 dg_selection[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02596"></a>02596             }
<a name="l02597"></a>02597         }
<a name="l02598"></a>02598     }
<a name="l02599"></a>02599     <span class="keywordflow">else</span> {
<a name="l02600"></a>02600         memset(dg_selection, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * defbase_tot);
<a name="l02601"></a>02601     }
<a name="l02602"></a>02602 
<a name="l02603"></a>02603     <span class="keywordflow">return</span> dg_flags_sel_tot;
<a name="l02604"></a>02604 }
<a name="l02605"></a>02605 
<a name="l02606"></a>02606 <span class="comment">/************** Bounding box ********************/</span>
<a name="l02607"></a><a class="code" href="../../d9/d2b/armature_8c.html#aa0300ee6dc70818afdd6fa4664f40245">02607</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/d2b/armature_8c.html#aa0300ee6dc70818afdd6fa4664f40245">minmax_armature</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3])
<a name="l02608"></a>02608 {
<a name="l02609"></a>02609     <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611     <span class="comment">/* For now, we assume where_is_pose has already been called (hence we have valid data in pachan). */</span>
<a name="l02612"></a>02612     <span class="keywordflow">for</span> (pchan = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pchan; pchan = pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02613"></a>02613         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a45cd2d153728723d688e9c83b1201160">pose_head</a>, min, max);
<a name="l02614"></a>02614         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a5095025766a8ba300df21670591fb943">pose_tail</a>, min, max);
<a name="l02615"></a>02615     }
<a name="l02616"></a>02616 
<a name="l02617"></a>02617     <span class="keywordflow">return</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02618"></a>02618 }
<a name="l02619"></a>02619 
<a name="l02620"></a><a class="code" href="../../d9/d2b/armature_8c.html#a0aa2b1616bba187f8ebf352abca34b73">02620</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d2b/armature_8c.html#a0aa2b1616bba187f8ebf352abca34b73">boundbox_armature</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> *loc, <span class="keywordtype">float</span> *<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l02621"></a>02621 {
<a name="l02622"></a>02622     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *bb;
<a name="l02623"></a>02623     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3];
<a name="l02624"></a>02624     <span class="keywordtype">float</span> mloc[3], msize[3];
<a name="l02625"></a>02625 
<a name="l02626"></a>02626     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02627"></a>02627         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a>), <span class="stringliteral">&quot;Armature boundbox&quot;</span>);
<a name="l02628"></a>02628     bb = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>;
<a name="l02629"></a>02629 
<a name="l02630"></a>02630     <span class="keywordflow">if</span> (!loc)
<a name="l02631"></a>02631         loc = mloc;
<a name="l02632"></a>02632     <span class="keywordflow">if</span> (!size)
<a name="l02633"></a>02633         size = msize;
<a name="l02634"></a>02634 
<a name="l02635"></a>02635     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l02636"></a>02636     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d2b/armature_8c.html#aa0300ee6dc70818afdd6fa4664f40245">minmax_armature</a>(ob, min, max)) {
<a name="l02637"></a>02637         min[0] = min[1] = min[2] = -1.0f;
<a name="l02638"></a>02638         max[0] = max[1] = max[2] = 1.0f;
<a name="l02639"></a>02639     }
<a name="l02640"></a>02640 
<a name="l02641"></a>02641     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(loc, min, max);
<a name="l02642"></a>02642 
<a name="l02643"></a>02643     size[0] = (max[0] - min[0]) / 2.0f;
<a name="l02644"></a>02644     size[1] = (max[1] - min[1]) / 2.0f;
<a name="l02645"></a>02645     size[2] = (max[2] - min[2]) / 2.0f;
<a name="l02646"></a>02646 
<a name="l02647"></a>02647     <a class="code" href="../../df/dac/BKE__object_8h.html#af195012a626e055e795867bdb53d2dd3">boundbox_set_from_min_max</a>(bb, min, max);
<a name="l02648"></a>02648 }
<a name="l02649"></a>02649 
<a name="l02650"></a><a class="code" href="../../d9/d2b/armature_8c.html#ac318de64db76ccf7bf7688f07a076c0a">02650</a> <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *<a class="code" href="../../da/d17/BKE__armature_8h.html#a1fa23f9322fca73f1028af5d120a6454">BKE_armature_get_bb</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02651"></a>02651 {
<a name="l02652"></a>02652     <a class="code" href="../../d9/d2b/armature_8c.html#a0aa2b1616bba187f8ebf352abca34b73">boundbox_armature</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02653"></a>02653 
<a name="l02654"></a>02654     <span class="keywordflow">return</span> ob-&gt;<a class="code" href="../../de/de7/structObject.html#a5513f8ac51a6d67252f5c3ceaf3c34eb">bb</a>;
<a name="l02655"></a>02655 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:53:56 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
