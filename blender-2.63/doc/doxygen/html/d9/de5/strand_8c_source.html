<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: strand.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">strand.c</div>  </div>
</div>
<div class="contents">
<a href="../../d9/de5/strand_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: none of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributors: Brecht Van Lommel.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/def/initrender_8h.html">initrender.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db3/pixelblending_8h.html">pixelblending.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dda/strand_8h.html">strand.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">/* to be removed */</span>
<a name="l00065"></a>00065 <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">float</span> *zco, <span class="keywordtype">float</span> *hoco);
<a name="l00066"></a>00066 <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a3d23e1e42d175fd98e6617e0635aafe6">zspan_scanconvert_strand</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">void</span> *handle, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">void</span> (*func)(<span class="keywordtype">void</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>, <span class="keywordtype">float</span>) );
<a name="l00067"></a>00067 <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a34b656e98ebe13a6250b11cc2f3da4b0">zbufsinglewire</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *ho1, <span class="keywordtype">float</span> *ho2);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">/* *************** */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="../../d9/de5/strand_8c.html#a131096e9a5deffad0e1dd300c648c5b6">00071</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/de5/strand_8c.html#a131096e9a5deffad0e1dd300c648c5b6">strand_eval_width</a>(<a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma, <span class="keywordtype">float</span> strandco)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <span class="keywordtype">float</span> fac;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     strandco= 0.5f*(strandco + 1.0f);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>!=0.0f) {
<a name="l00078"></a>00078         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>&lt;0.0f)
<a name="l00079"></a>00079             fac= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(strandco, 1.0f+ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>);
<a name="l00080"></a>00080         <span class="keywordflow">else</span>
<a name="l00081"></a>00081             fac= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(strandco, 1.0f/(1.0f-ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8d4d1809ebe14e8db75f189f99915984">strand_ease</a>));
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083     <span class="keywordflow">else</span> fac= strandco;
<a name="l00084"></a>00084     
<a name="l00085"></a>00085     <span class="keywordflow">return</span> ((1.0f-fac)*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa72afccc378741af6e29de2e20084420">strand_sta</a> + (fac)*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac6a6784cdee68d2bafdea858c57dffcd">strand_end</a>);
<a name="l00086"></a>00086 }
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="../../d9/de5/strand_8c.html#ae3accfdc6e641b52f5cffd6627472f10">00088</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#ae3accfdc6e641b52f5cffd6627472f10">strand_eval_point</a>(<a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *spoint)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l00091"></a>00091     <a class="code" href="../../de/d59/structStrandBuffer.html">StrandBuffer</a> *strandbuf;
<a name="l00092"></a>00092     <span class="keywordtype">float</span> *simplify;
<a name="l00093"></a>00093     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[4][3], <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[4], <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[3], w, dx, dy, t;
<a name="l00094"></a>00094     <span class="keywordtype">int</span> type;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     strandbuf= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>;
<a name="l00097"></a>00097     ma= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>;
<a name="l00098"></a>00098     t= spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>;
<a name="l00099"></a>00099     type= (strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ad4c20ea25767776b4e98e9302dcfc9ca">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a3eb39e98f95d744e8ef0fd9e5d0023f3">R_STRAND_BSPLINE</a>)? <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aac23e961cc6e76c6a239fa5da744c04d4">KEY_BSPLINE</a>: <a class="code" href="../../de/d41/DNA__key__types_8h.html#a5e66f304417530ef056f13a6a6dc668aa7d099df7300f79faa4419f6a0cc18a61">KEY_CARDINAL</a>;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p[0], sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l00102"></a>00102     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p[1], sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l00103"></a>00103     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p[2], sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l00104"></a>00104     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p[3], sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) {
<a name="l00107"></a>00107         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, p[0]);
<a name="l00108"></a>00108         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, p[1]);
<a name="l00109"></a>00109         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, p[2]);
<a name="l00110"></a>00110         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, p[3]);
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (t == 0.0f) {
<a name="l00114"></a>00114         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, p[1]);
<a name="l00115"></a>00115         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af9e0d8b863f13fd7a58ce90e6be83b60">strandco</a>= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a090c32249fe12fa8ad08fa7bb42fa1d3">dtstrandco</a>= (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a> - sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>);
<a name="l00118"></a>00118         <span class="keywordflow">if</span> (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0] != sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1])
<a name="l00119"></a>00119             spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a090c32249fe12fa8ad08fa7bb42fa1d3">dtstrandco</a> *= 0.5f;
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == 1.0f) {
<a name="l00122"></a>00122         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, p[2]);
<a name="l00123"></a>00123         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af9e0d8b863f13fd7a58ce90e6be83b60">strandco</a>= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a090c32249fe12fa8ad08fa7bb42fa1d3">dtstrandco</a>= (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a> - sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>);
<a name="l00126"></a>00126         <span class="keywordflow">if</span> (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3] != sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2])
<a name="l00127"></a>00127             spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a090c32249fe12fa8ad08fa7bb42fa1d3">dtstrandco</a> *= 0.5f;
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     <span class="keywordflow">else</span> {
<a name="l00130"></a>00130         <a class="code" href="../../d5/d17/BKE__key_8h.html#a77a9ae696ecfa7f2645fc4a6b72fe928">key_curve_position_weights</a>(t, data, type);
<a name="l00131"></a>00131         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>[0]= data[0]*p[0][0] + data[1]*p[1][0] + data[2]*p[2][0] + data[3]*p[3][0];
<a name="l00132"></a>00132         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>[1]= data[0]*p[0][1] + data[1]*p[1][1] + data[2]*p[2][1] + data[3]*p[3][1];
<a name="l00133"></a>00133         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>[2]= data[0]*p[0][2] + data[1]*p[1][2] + data[2]*p[2][2] + data[3]*p[3][2];
<a name="l00134"></a>00134         spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af9e0d8b863f13fd7a58ce90e6be83b60">strandco</a>= (1.0f-t)*sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a> + t*sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#a42113aa739601fb441132be0c9e03adb">strandco</a>;
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <a class="code" href="../../d5/d17/BKE__key_8h.html#a944ba18f6851fa2404cabac072de0469">key_curve_tangent_weights</a>(t, data, type);
<a name="l00138"></a>00138     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aef16473faf1b7d0055778e3fe6cb82cb">dtco</a>[0]= data[0]*p[0][0] + data[1]*p[1][0] + data[2]*p[2][0] + data[3]*p[3][0];
<a name="l00139"></a>00139     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aef16473faf1b7d0055778e3fe6cb82cb">dtco</a>[1]= data[0]*p[0][1] + data[1]*p[1][1] + data[2]*p[2][1] + data[3]*p[3][1];
<a name="l00140"></a>00140     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aef16473faf1b7d0055778e3fe6cb82cb">dtco</a>[2]= data[0]*p[0][2] + data[1]*p[1][2] + data[2]*p[2][2] + data[3]*p[3][2];
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aac1faf5ca9099a3c856a89aba620a928">tan</a>, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aef16473faf1b7d0055778e3fe6cb82cb">dtco</a>);
<a name="l00143"></a>00143     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aedb881747f21529e0a779c0f22da010c">nor</a>, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>);
<a name="l00144"></a>00144     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aedb881747f21529e0a779c0f22da010c">nor</a>);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a>= <a class="code" href="../../d9/de5/strand_8c.html#a131096e9a5deffad0e1dd300c648c5b6">strand_eval_width</a>(ma, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af9e0d8b863f13fd7a58ce90e6be83b60">strandco</a>);
<a name="l00147"></a>00147     
<a name="l00148"></a>00148     <span class="comment">/* simplification */</span>
<a name="l00149"></a>00149     simplify= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a26c0241dd085faa502fa29c40ab0dfab">RE_strandren_get_simplify</a>(strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af6410d72c7e15260c4559439958031dd">obr</a>, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>, 0);
<a name="l00150"></a>00150     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a7c33fe2708a544826a4e8f2663661b1a">alpha</a>= (simplify)? simplify[1]: 1.0f;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="comment">/* outer points */</span>
<a name="l00153"></a>00153     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#aac1faf5ca9099a3c856a89aba620a928">tan</a>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     w= spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>[2]*strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>[2][3] + strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>[3][3];
<a name="l00156"></a>00156     dx= strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ae0265e66e1fd71209f05feac678de81b">winx</a>*cross[0]*strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>[0][0]/w;
<a name="l00157"></a>00157     dy= strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a8026d950bbd43253551e536b26d6fffb">winy</a>*cross[1]*strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>[1][1]/w;
<a name="l00158"></a>00158     w= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dx*dx + dy*dy);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (w &gt; 0.0f) {
<a name="l00161"></a>00161         <span class="keywordflow">if</span> (strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ad4c20ea25767776b4e98e9302dcfc9ca">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57ef394e8a613e63da8a0734424c5627">R_STRAND_B_UNITS</a>) {
<a name="l00162"></a>00162             <span class="keyword">const</span> <span class="keywordtype">float</span> crosslen= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(cross);
<a name="l00163"></a>00163             w= 2.0f*crosslen*strandbuf-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a3f4950d765020fde67a2a94c72b210ef">minwidth</a>/w;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165             <span class="keywordflow">if</span> (spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a> &lt; w) {
<a name="l00166"></a>00166                 spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a7c33fe2708a544826a4e8f2663661b1a">alpha</a>= spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a>/w;
<a name="l00167"></a>00167                 spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a>= w;
<a name="l00168"></a>00168             }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170             <span class="keywordflow">if</span> (simplify)
<a name="l00171"></a>00171                 <span class="comment">/* squared because we only change width, not length */</span>
<a name="l00172"></a>00172                 spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a> *= simplify[0]*simplify[0];
<a name="l00173"></a>00173 
<a name="l00174"></a>00174             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cross, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a>*0.5f/crosslen);
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176         <span class="keywordflow">else</span>
<a name="l00177"></a>00177             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(cross, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a2cb235aa116830e6e716fa40b5aaa9dc">width</a>/w);
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, cross);
<a name="l00181"></a>00181     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, cross);
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a5c85a59bd5aab286ad0cc08b3abbdce1">dsco</a>, cross);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* *************** */</span>
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="../../d9/de5/strand_8c.html#af38305f34f4a9603e4141a6481a6943d">00188</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#af38305f34f4a9603e4141a6481a6943d">interpolate_vec1</a>(<span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> negt, <span class="keywordtype">float</span> *v)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190     v[0]= negt*v1[0] + t*v2[0];
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">00193</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(<span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> negt, <span class="keywordtype">float</span> *v)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     v[0]= negt*v1[0] + t*v2[0];
<a name="l00196"></a>00196     v[1]= negt*v1[1] + t*v2[1];
<a name="l00197"></a>00197     v[2]= negt*v1[2] + t*v2[2];
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="../../d9/de5/strand_8c.html#a6920abdfc9397d6542c97dd7ee8eb589">00200</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a6920abdfc9397d6542c97dd7ee8eb589">interpolate_vec4</a>(<span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> negt, <span class="keywordtype">float</span> *v)
<a name="l00201"></a>00201 {
<a name="l00202"></a>00202     v[0]= negt*v1[0] + t*v2[0];
<a name="l00203"></a>00203     v[1]= negt*v1[1] + t*v2[1];
<a name="l00204"></a>00204     v[2]= negt*v1[2] + t*v2[2];
<a name="l00205"></a>00205     v[3]= negt*v1[3] + t*v2[3];
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="../../d9/de5/strand_8c.html#a7b694d9c5e4032ce12695eda11277fc6">00208</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a7b694d9c5e4032ce12695eda11277fc6">interpolate_shade_result</a>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr1, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr2, <span class="keywordtype">float</span> t, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">int</span> addpassflag)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210     <span class="keywordtype">float</span> negt= 1.0f - t;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <a class="code" href="../../d9/de5/strand_8c.html#a6920abdfc9397d6542c97dd7ee8eb589">interpolate_vec4</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad9100234bef25bcc5128c00fc612f7ca">SCE_PASS_VECTOR</a>) {
<a name="l00215"></a>00215         <a class="code" href="../../d9/de5/strand_8c.html#a6920abdfc9397d6542c97dd7ee8eb589">interpolate_vec4</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#adc32af7dc74b69aee1c837efc37a0a2d">winspeed</a>);
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="comment">/* optim... */</span>
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (addpassflag &amp; ~(SCE_PASS_VECTOR)) {
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>)
<a name="l00220"></a>00220             <a class="code" href="../../d9/de5/strand_8c.html#af38305f34f4a9603e4141a6481a6943d">interpolate_vec1</a>(&amp;shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>, &amp;shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>, t, negt, &amp;shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a71d707c5ef4e2e90d3e491fb2dc9e6bb">z</a>);
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>)
<a name="l00222"></a>00222             <a class="code" href="../../d9/de5/strand_8c.html#a6920abdfc9397d6542c97dd7ee8eb589">interpolate_vec4</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>);
<a name="l00223"></a>00223         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a53ae1d458dab251ffdcc0ccd5312f603">SCE_PASS_NORMAL</a>) {
<a name="l00224"></a>00224             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>);
<a name="l00225"></a>00225             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#afe43a9ba75d5c97880a17442f1901bf8">nor</a>);
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36483eb50364ade6b32ad7f845be7cf">SCE_PASS_EMIT</a>)
<a name="l00228"></a>00228             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>);
<a name="l00229"></a>00229         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>)
<a name="l00230"></a>00230             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>);
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)
<a name="l00232"></a>00232             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)
<a name="l00234"></a>00234             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>);
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>)
<a name="l00236"></a>00236             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>);
<a name="l00237"></a>00237         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>)
<a name="l00238"></a>00238             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>);
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>)
<a name="l00240"></a>00240             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>);
<a name="l00241"></a>00241         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>)
<a name="l00242"></a>00242             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>);
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a818d29498d5d603de4a1ec601a4b416f">SCE_PASS_REFRACT</a>)
<a name="l00244"></a>00244             <a class="code" href="../../d9/de5/strand_8c.html#a01c6345d17cdd49c10f7f2a36c679d3c">interpolate_vec3</a>(shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>, shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>, t, negt, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a6bc46d4fa57b226272668e41a7aa0e01">refr</a>);
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (addpassflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5261e0edfcf5ddc55c459ac175ae55c6">SCE_PASS_MIST</a>)
<a name="l00246"></a>00246             <a class="code" href="../../d9/de5/strand_8c.html#af38305f34f4a9603e4141a6481a6943d">interpolate_vec1</a>(&amp;shr1-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>, &amp;shr2-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>, t, negt, &amp;shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8b6aac3acd4579a2ef03f61218b4994e">mist</a>);
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../d9/de5/strand_8c.html#abacffeb67536696bef7bd52a6ec1b723">00250</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#abacffeb67536696bef7bd52a6ec1b723">strand_apply_shaderesult_alpha</a>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">float</span> alpha)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (alpha &lt; 1.0f) {
<a name="l00253"></a>00253         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] *= alpha;
<a name="l00254"></a>00254         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] *= alpha;
<a name="l00255"></a>00255         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] *= alpha;
<a name="l00256"></a>00256         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3] *= alpha;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[0] *= alpha;
<a name="l00259"></a>00259         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[1] *= alpha;
<a name="l00260"></a>00260         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[2] *= alpha;
<a name="l00261"></a>00261         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3] *= alpha;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> *= alpha;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="../../d9/de5/strand_8c.html#a8428f0b24e89785dc648da26f063df7f">00267</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a8428f0b24e89785dc648da26f063df7f">strand_shade_point</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *spoint)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l00270"></a>00270     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>;
<a name="l00271"></a>00271     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> vlr;
<a name="l00272"></a>00272     <span class="keywordtype">int</span> seed;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     memset(&amp;vlr, 0, <span class="keyword">sizeof</span>(vlr));
<a name="l00275"></a>00275     vlr.<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a>= <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>;
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a993de724ede213103155201135760761">MA_TANGENT_STR</a>)
<a name="l00277"></a>00277         vlr.<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>= &amp;vlr;
<a name="l00280"></a>00280     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0e3e3b0cb1f227dafd027e4af1ea4d4f">v1</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00281"></a>00281     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6e53ebe9ba16707cf6e4d69e0ccda239">v2</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00282"></a>00282     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab318cd1dba4d58bc8613f9a636d30b87">v3</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00283"></a>00283     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>;
<a name="l00284"></a>00284     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>;
<a name="l00285"></a>00285     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     <span class="comment">/* cache for shadow */</span>
<a name="l00288"></a>00288     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#af9cf9373405bb854bf2d0003394e12be">shadowsamplenr</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>]++;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">/* all samples */</span>
<a name="l00291"></a>00291     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= 0xFFFF;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="comment">/* seed RNG for consistent results across tiles */</span>
<a name="l00294"></a>00294     seed = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#add864843502cbf24301455bc84520d09">index</a> + (svert - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>);
<a name="l00295"></a>00295     <a class="code" href="../../d3/d88/BLI__rand_8h.html#aa9035a478fe635e955283d9fb04350f4">BLI_thread_srandom</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, seed);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <a class="code" href="../../da/d3d/shading_8h.html#a3c016cc12a5205ea0491f6a9342498bc">shade_input_set_strand</a>(shi, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>, spoint);
<a name="l00298"></a>00298     <a class="code" href="../../da/d3d/shading_8h.html#a130ea28ead2b85c385d077bc13f44015">shade_input_set_strand_texco</a>(shi, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1], spoint);
<a name="l00299"></a>00299     
<a name="l00300"></a>00300     <span class="comment">/* init material vars */</span>
<a name="l00301"></a>00301     <a class="code" href="../../da/d3d/shading_8h.html#aa0c7c5a131fe6e2e4b82f34bea854d4b">shade_input_init_material</a>(shi);
<a name="l00302"></a>00302     
<a name="l00303"></a>00303     <span class="comment">/* shade */</span>
<a name="l00304"></a>00304     <a class="code" href="../../da/d3d/shading_8h.html#a8168f206084778f328a12710aa9713cd">shade_samples_do_AO</a>(ssamp);
<a name="l00305"></a>00305     <a class="code" href="../../da/d3d/shading_8h.html#ac56b51980287cbeac2c57ef5a9f2877b">shade_input_do_shade</a>(shi, shr);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="comment">/* apply simplification */</span>
<a name="l00308"></a>00308     <a class="code" href="../../d9/de5/strand_8c.html#abacffeb67536696bef7bd52a6ec1b723">strand_apply_shaderesult_alpha</a>(shr, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a7c33fe2708a544826a4e8f2663661b1a">alpha</a>);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="comment">/* include lamphalos for strand, since halo layer was added already */</span>
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a27f1abe07680d03bf8521c9359d04841">R_LAMPHALO</a>)
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5fb3fb260a98ddd57b2d546026e335c1">layflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a64b24285d50b2e2e211a482ab221204d">SCE_LAY_HALO</a>)
<a name="l00313"></a>00313             <a class="code" href="../../d0/d0e/rendercore_8h.html#aa7c1b51d185daf95ec184d43789000db">renderspothalo</a>(shi, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3]);
<a name="l00314"></a>00314     
<a name="l00315"></a>00315     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment">/* *************** */</span>
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="../../db/de2/structStrandShadeCache.html">00320</a> <span class="keyword">struct </span><a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> {
<a name="l00321"></a><a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">00321</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>;
<a name="l00322"></a><a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">00322</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>;
<a name="l00323"></a><a class="code" href="../../db/de2/structStrandShadeCache.html#ad828217eb3c993649134a644540eeef5">00323</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../db/de2/structStrandShadeCache.html#ad828217eb3c993649134a644540eeef5">memarena</a>;
<a name="l00324"></a>00324 };
<a name="l00325"></a>00325 
<a name="l00326"></a><a class="code" href="../../d9/de5/strand_8c.html#af694930eb24017e24eede0dbd42e23fd">00326</a> <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *<a class="code" href="../../d3/dda/strand_8h.html#a8ce046953f4528a78705f0e1ce0581b2">strand_shade_cache_create</a>(<span class="keywordtype">void</span>)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328     <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     cache= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a>), <span class="stringliteral">&quot;StrandShadeCache&quot;</span>);
<a name="l00331"></a>00331     cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;strand_shade_cache_create1 gh&quot;</span>);
<a name="l00332"></a>00332     cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;strand_shade_cache_create2 gh&quot;</span>);
<a name="l00333"></a>00333     cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad828217eb3c993649134a644540eeef5">memarena</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;strand shade cache arena&quot;</span>);
<a name="l00334"></a>00334     
<a name="l00335"></a>00335     <span class="keywordflow">return</span> cache;
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="../../d9/de5/strand_8c.html#aa2adc6114b09c7c589109a97f3551801">00338</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#a5f4a543fd3019888ed126e1158214ef8">strand_shade_cache_free</a>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00341"></a>00341     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a53210a0b5c7bd4568f50f16dd85f04a6">GHashValFreeFP</a>)<a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>);
<a name="l00342"></a>00342     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad828217eb3c993649134a644540eeef5">memarena</a>);
<a name="l00343"></a>00343     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache);
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="../../d9/de5/strand_8c.html#ab63cc0e2171b9d4d9870c22c7d0ede9d">00346</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#ab63cc0e2171b9d4d9870c22c7d0ede9d">strand_shade_get</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *hashshr;
<a name="l00349"></a>00349     <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00350"></a>00350     <span class="keywordtype">int</span> *refcount;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     hashshr= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>, svert);
<a name="l00353"></a>00353     refcount= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (!hashshr) {
<a name="l00356"></a>00356         <span class="comment">/* not shaded yet, shade and insert into hash */</span>
<a name="l00357"></a>00357         p.<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>= (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1] == svert)? 0.0f: 1.0f;
<a name="l00358"></a>00358         <a class="code" href="../../d3/dda/strand_8h.html#ae3accfdc6e641b52f5cffd6627472f10">strand_eval_point</a>(sseg, &amp;p);
<a name="l00359"></a>00359         <a class="code" href="../../d9/de5/strand_8c.html#a8428f0b24e89785dc648da26f063df7f">strand_shade_point</a>(re, ssamp, sseg, svert, &amp;p);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         hashshr= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>), <span class="stringliteral">&quot;HashShadeResult&quot;</span>);
<a name="l00362"></a>00362         *hashshr= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>[0];
<a name="l00363"></a>00363         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>, svert, hashshr);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365     <span class="keywordflow">else</span>
<a name="l00366"></a>00366         <span class="comment">/* already shaded, just copy previous result from hash */</span>
<a name="l00367"></a>00367         ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>[0]= *hashshr;
<a name="l00368"></a>00368     
<a name="l00369"></a>00369     <span class="comment">/* lower reference count and remove if not needed anymore by any samples */</span>
<a name="l00370"></a>00370     (*refcount)--;
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (*refcount == 0) {
<a name="l00372"></a>00372         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>, svert, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a53210a0b5c7bd4568f50f16dd85f04a6">GHashValFreeFP</a>)<a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>);
<a name="l00373"></a>00373         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00374"></a>00374     }
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="../../d9/de5/strand_8c.html#a018394c1cb3b8e4a9a6d15aa623e86cb">00377</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#aa263a8d20265c4f33035d243f399ebc0">strand_shade_segment</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> s, <span class="keywordtype">int</span> addpassflag)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> shr1, shr2;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="comment">/* get shading for two endpoints and interpolate */</span>
<a name="l00382"></a>00382     <a class="code" href="../../d9/de5/strand_8c.html#ab63cc0e2171b9d4d9870c22c7d0ede9d">strand_shade_get</a>(re, cache, ssamp, sseg, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]);
<a name="l00383"></a>00383     shr1= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>[0];
<a name="l00384"></a>00384     <a class="code" href="../../d9/de5/strand_8c.html#ab63cc0e2171b9d4d9870c22c7d0ede9d">strand_shade_get</a>(re, cache, ssamp, sseg, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]);
<a name="l00385"></a>00385     shr2= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>[0];
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <a class="code" href="../../d9/de5/strand_8c.html#a7b694d9c5e4032ce12695eda11277fc6">interpolate_shade_result</a>(&amp;shr1, &amp;shr2, t, ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>, addpassflag);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="comment">/* apply alpha along width */</span>
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a780bc46fc42cf5b1865e286152f3b788">widthfade</a> != 0.0f) {
<a name="l00391"></a>00391         s = 1.0f - <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(s), sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a780bc46fc42cf5b1865e286152f3b788">widthfade</a>);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <a class="code" href="../../d9/de5/strand_8c.html#abacffeb67536696bef7bd52a6ec1b723">strand_apply_shaderesult_alpha</a>(ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>, s);
<a name="l00394"></a>00394     }
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a><a class="code" href="../../d9/de5/strand_8c.html#a4f76cbcdd49ce689b2b0876fd95c8588">00397</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#a20be76a9f588a7eb125240d8fed56955">strand_shade_unref</a>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <span class="keywordtype">int</span> *refcount;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">/* lower reference count and remove if not needed anymore by any samples */</span>
<a name="l00402"></a>00402     refcount= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     (*refcount)--;
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (*refcount == 0) {
<a name="l00406"></a>00406         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad6f0b462d3d004b96a3c5cf08db6aca6">resulthash</a>, svert, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a53210a0b5c7bd4568f50f16dd85f04a6">GHashValFreeFP</a>)<a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>);
<a name="l00407"></a>00407         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="../../d9/de5/strand_8c.html#a78b21e877c12acf3f727422c2e32ebc1">00411</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a78b21e877c12acf3f727422c2e32ebc1">strand_shade_refcount</a>(<a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache, <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <span class="keywordtype">int</span> *refcount= <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (!refcount) {
<a name="l00416"></a>00416         refcount= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#ad828217eb3c993649134a644540eeef5">memarena</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00417"></a>00417         *refcount= 1;
<a name="l00418"></a>00418         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(cache-&gt;<a class="code" href="../../db/de2/structStrandShadeCache.html#a63ccafa6f5a929854298fd058963310e">refcounthash</a>, svert, refcount);
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     <span class="keywordflow">else</span>
<a name="l00421"></a>00421         (*refcount)++;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 <span class="comment">/* *************** */</span>
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="../../df/da8/structStrandPart.html">00426</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> {
<a name="l00427"></a><a class="code" href="../../df/da8/structStrandPart.html#a771afc39a0d7f0ffcc5308f242f2880d">00427</a>     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../df/da8/structStrandPart.html#a771afc39a0d7f0ffcc5308f242f2880d">re</a>;
<a name="l00428"></a><a class="code" href="../../df/da8/structStrandPart.html#a31ea386065a561737b9c372002f2cedd">00428</a>     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *<a class="code" href="../../df/da8/structStrandPart.html#a31ea386065a561737b9c372002f2cedd">zspan</a>;
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="../../df/da8/structStrandPart.html#a2cfec9609b10645513eec4c029541fec">00430</a>     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *<a class="code" href="../../df/da8/structStrandPart.html#a2cfec9609b10645513eec4c029541fec">apixbuf</a>;
<a name="l00431"></a><a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">00431</a>     <span class="keywordtype">int</span> *<a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">totapixbuf</a>;
<a name="l00432"></a><a class="code" href="../../df/da8/structStrandPart.html#aa02a58961037065ffe2342937411be5d">00432</a>     <span class="keywordtype">int</span> *<a class="code" href="../../df/da8/structStrandPart.html#aa02a58961037065ffe2342937411be5d">rectz</a>;
<a name="l00433"></a><a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">00433</a>     <span class="keywordtype">int</span> *<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>;
<a name="l00434"></a><a class="code" href="../../df/da8/structStrandPart.html#a8e1ab7abbbd35eeee3fb6a6892d57704">00434</a>     intptr_t *<a class="code" href="../../df/da8/structStrandPart.html#a8e1ab7abbbd35eeee3fb6a6892d57704">rectdaps</a>;
<a name="l00435"></a><a class="code" href="../../df/da8/structStrandPart.html#aa8f253f6bfc6652235cd526e6b71aa8b">00435</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/da8/structStrandPart.html#aaceb8fea2648a8374338fc03d257c3a6">rectx</a>, <a class="code" href="../../df/da8/structStrandPart.html#aa8f253f6bfc6652235cd526e6b71aa8b">recty</a>;
<a name="l00436"></a><a class="code" href="../../df/da8/structStrandPart.html#ae01686212186436e61ef679f9d79a19a">00436</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/da8/structStrandPart.html#ae01686212186436e61ef679f9d79a19a">sample</a>;
<a name="l00437"></a><a class="code" href="../../df/da8/structStrandPart.html#ad1d5c8cb2df140379e07a058834a198e">00437</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/da8/structStrandPart.html#ad1d5c8cb2df140379e07a058834a198e">shadow</a>;
<a name="l00438"></a><a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">00438</a>     float (*<a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">jit</a>)[2];
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="../../df/da8/structStrandPart.html#a5652cdf62d0ad49ffa12319a0e302bc1">00440</a>     <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *<a class="code" href="../../df/da8/structStrandPart.html#a5652cdf62d0ad49ffa12319a0e302bc1">segment</a>;
<a name="l00441"></a><a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">00441</a>     <span class="keywordtype">float</span> <a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[3], <a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[3];
<a name="l00442"></a>00442 
<a name="l00443"></a><a class="code" href="../../df/da8/structStrandPart.html#ae9a7dcd21b5622abeccc6019e3b44001">00443</a>     <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *<a class="code" href="../../df/da8/structStrandPart.html#ae9a7dcd21b5622abeccc6019e3b44001">cache</a>;
<a name="l00444"></a>00444 } <a class="code" href="../../d9/de5/strand_8c.html#a92707c439d32376d6df622d8b6e21640">StrandPart</a>;
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="../../d2/d2d/structStrandSortSegment.html">00446</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a> {
<a name="l00447"></a><a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad689026eb9f9efc7f20bd54bcee1ec94">00447</a>     <span class="keyword">struct </span><a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a> *<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad689026eb9f9efc7f20bd54bcee1ec94">next</a>;
<a name="l00448"></a><a class="code" href="../../d2/d2d/structStrandSortSegment.html#a1f2a3976cbb81290b443735b013d22b8">00448</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a5322a5a0729346a187b8813794588a44">obi</a>, <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a1f2a3976cbb81290b443735b013d22b8">strand</a>, <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a8035f44ed5ecb91c94c03752ba4c0080">segment</a>;
<a name="l00449"></a><a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">00449</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a>;
<a name="l00450"></a>00450 } <a class="code" href="../../d9/de5/strand_8c.html#aa027fa363e564fc77a8f7d48d1ee8c38">StrandSortSegment</a>;
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="../../d9/de5/strand_8c.html#a08dba87ff9e455875f8ba2bc9bc52014">00452</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/de5/strand_8c.html#a08dba87ff9e455875f8ba2bc9bc52014">compare_strand_segment</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *poin1, <span class="keyword">const</span> <span class="keywordtype">void</span> *poin2)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454     <span class="keyword">const</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a> *seg1= (<span class="keyword">const</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a>*)poin1;
<a name="l00455"></a>00455     <span class="keyword">const</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a> *seg2= (<span class="keyword">const</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a>*)poin2;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (seg1-&gt;<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a> &lt; seg2-&gt;<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a>)
<a name="l00458"></a>00458         <span class="keywordflow">return</span> -1;
<a name="l00459"></a>00459     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (seg1-&gt;<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a> == seg2-&gt;<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a>)
<a name="l00460"></a>00460         <span class="keywordflow">return</span> 0;
<a name="l00461"></a>00461     <span class="keywordflow">else</span>
<a name="l00462"></a>00462         <span class="keywordflow">return</span> 1;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">00465</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(<span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *hoco, <span class="keywordtype">float</span> *zco)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467     <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(co, winmat, hoco);
<a name="l00468"></a>00468     <a class="code" href="../../d9/de5/strand_8c.html#aa8722d8a2999e66ca35652d74615530d">hoco_to_zco</a>(zspan, zco, hoco);
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 
<a name="l00471"></a><a class="code" href="../../d9/de5/strand_8c.html#a2578b98a3d0a6b638376a61ffdf2ffde">00471</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#a2578b98a3d0a6b638376a61ffdf2ffde">strand_project_point</a>(<span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">float</span> winx, <span class="keywordtype">float</span> winy, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *spoint)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, winmat, spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a95aac1828c9ea5c0e0b6af3c04732af7">hoco</a>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     div= 1.0f/spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a95aac1828c9ea5c0e0b6af3c04732af7">hoco</a>[3];
<a name="l00478"></a>00478     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ade5a91eed34291474fa18fe7d80489db">x</a>= spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a95aac1828c9ea5c0e0b6af3c04732af7">hoco</a>[0]*div*winx*0.5f;
<a name="l00479"></a>00479     spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a48554eab038b4d701835c5b43253dbe1">y</a>= spoint-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a95aac1828c9ea5c0e0b6af3c04732af7">hoco</a>[1]*div*winy*0.5f;
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a><a class="code" href="../../d9/de5/strand_8c.html#a11d7ad512a06b01abfa5156a5fce4fda">00482</a> <span class="keyword">static</span> <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *<a class="code" href="../../d9/de5/strand_8c.html#a11d7ad512a06b01abfa5156a5fce4fda">addpsmainAstrand</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484     <a class="code" href="../../da/ddf/structAPixstrMain.html">APixstrMain</a> *psm;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     psm= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/ddf/structAPixstrMain.html">APixstrMain</a>), <span class="stringliteral">&quot;addpsmainA&quot;</span>);
<a name="l00487"></a>00487     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, psm);
<a name="l00488"></a>00488     psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(4096*<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a>),<span class="stringliteral">&quot;pixstr&quot;</span>);
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="keywordflow">return</span> psm-&gt;<a class="code" href="../../da/ddf/structAPixstrMain.html#a4afd520b603a139151814a40c1ba42d3">ps</a>;
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="../../d9/de5/strand_8c.html#ab55838e23296cc651df0dd68bdfb5897">00493</a> <span class="keyword">static</span> <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *<a class="code" href="../../d9/de5/strand_8c.html#ab55838e23296cc651df0dd68bdfb5897">addpsAstrand</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <span class="comment">/* make new PS */</span>
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aeb26aeae46e24938219930ec12955cb4">apstrandmcounter</a>==0) {
<a name="l00497"></a>00497         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9b7847d46658e688003ad36dee30a876">curpstrand</a>= <a class="code" href="../../d9/de5/strand_8c.html#a11d7ad512a06b01abfa5156a5fce4fda">addpsmainAstrand</a>(zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aa8c2f165a3d6f750a37a1740028b8e0a">apsmbase</a>);
<a name="l00498"></a>00498         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aeb26aeae46e24938219930ec12955cb4">apstrandmcounter</a>= 4095;
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     <span class="keywordflow">else</span> {
<a name="l00501"></a>00501         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9b7847d46658e688003ad36dee30a876">curpstrand</a>++;
<a name="l00502"></a>00502         zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#aeb26aeae46e24938219930ec12955cb4">apstrandmcounter</a>--;
<a name="l00503"></a>00503     }
<a name="l00504"></a>00504     <span class="keywordflow">return</span> zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a9b7847d46658e688003ad36dee30a876">curpstrand</a>;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="../../d9/de5/strand_8c.html#adb9669652571819a7dc83e6e367035f1">00507</a> <span class="preprocessor">#define MAX_ZROW    2000</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>
<a name="l00509"></a><a class="code" href="../../d9/de5/strand_8c.html#abf7fc1a5f18913ebb3a0746e308b2511">00509</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#abf7fc1a5f18913ebb3a0746e308b2511">do_strand_fillac</a>(<span class="keywordtype">void</span> *handle, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a>)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511     <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> *spart= (<a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a>*)handle;
<a name="l00512"></a>00512     <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache= spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#ae9a7dcd21b5622abeccc6019e3b44001">cache</a>;
<a name="l00513"></a>00513     <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg= spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a5652cdf62d0ad49ffa12319a0e302bc1">segment</a>;
<a name="l00514"></a>00514     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *apn, *apnew;
<a name="l00515"></a>00515     <span class="keywordtype">float</span> t, s;
<a name="l00516"></a>00516     <span class="keywordtype">int</span> offset, mask, <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a5322a5a0729346a187b8813794588a44">obi</a>, strnr, seg, zverg, bufferz, maskz=0;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     offset = y*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#aaceb8fea2648a8374338fc03d257c3a6">rectx</a> + x;
<a name="l00519"></a>00519     obi= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a> - spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a771afc39a0d7f0ffcc5308f242f2880d">re</a>-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>;
<a name="l00520"></a>00520     strnr= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#add864843502cbf24301455bc84520d09">index</a> + 1;
<a name="l00521"></a>00521     seg= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1] - sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>;
<a name="l00522"></a>00522     mask= (1&lt;&lt;spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#ae01686212186436e61ef679f9d79a19a">sample</a>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="comment">/* check against solid z-buffer */</span>
<a name="l00525"></a>00525     zverg= (int)z;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8e1ab7abbbd35eeee3fb6a6892d57704">rectdaps</a>) {
<a name="l00528"></a>00528         <span class="comment">/* find the z of the sample */</span>
<a name="l00529"></a>00529         <a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *ps;
<a name="l00530"></a>00530         intptr_t *rd= spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8e1ab7abbbd35eeee3fb6a6892d57704">rectdaps</a> + offset;
<a name="l00531"></a>00531         
<a name="l00532"></a>00532         bufferz= 0x7FFFFFFF;
<a name="l00533"></a>00533         <span class="keywordflow">if</span> (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>) maskz= 0x7FFFFFFF;
<a name="l00534"></a>00534         
<a name="l00535"></a>00535         <span class="keywordflow">if</span> (*rd) {  
<a name="l00536"></a>00536             <span class="keywordflow">for</span> (ps= (<a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *)(*rd); ps; ps= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aeb6499e7a3de74d45a89157937d40aa4">next</a>) {
<a name="l00537"></a>00537                 <span class="keywordflow">if</span> (mask &amp; ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#af0b04e6da97ea4a3181f23d4ab49452e">mask</a>) {
<a name="l00538"></a>00538                     bufferz= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a6499b0c851894529dd39cfb0acf90c44">z</a>;
<a name="l00539"></a>00539                     <span class="keywordflow">if</span> (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>)
<a name="l00540"></a>00540                         maskz= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aaa0b5d475fcfbaee352da5641c3ad7e1">maskz</a>;
<a name="l00541"></a>00541                     <span class="keywordflow">break</span>;
<a name="l00542"></a>00542                 }
<a name="l00543"></a>00543             }
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     <span class="keywordflow">else</span> {
<a name="l00547"></a>00547         bufferz= (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#aa02a58961037065ffe2342937411be5d">rectz</a>)? spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#aa02a58961037065ffe2342937411be5d">rectz</a>[offset]: 0x7FFFFFFF;
<a name="l00548"></a>00548         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>)
<a name="l00549"></a>00549             maskz= spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>[offset];
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="preprocessor">#define CHECK_ADD(n) \</span>
<a name="l00553"></a>00553 <span class="preprocessor">    if (apn-&gt;p[n]==strnr &amp;&amp; apn-&gt;obi[n]==obi &amp;&amp; apn-&gt;seg[n]==seg) \</span>
<a name="l00554"></a>00554 <span class="preprocessor">    { if (!(apn-&gt;mask[n] &amp; mask)) { apn-&gt;mask[n] |= mask; apn-&gt;v[n] += t; apn-&gt;u[n] += s; } break; }</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span><span class="preprocessor">#define CHECK_ASSIGN(n) \</span>
<a name="l00556"></a>00556 <span class="preprocessor">    if (apn-&gt;p[n]==0) \</span>
<a name="l00557"></a>00557 <span class="preprocessor">    {apn-&gt;obi[n]= obi; apn-&gt;p[n]= strnr; apn-&gt;z[n]= zverg; apn-&gt;mask[n]= mask; apn-&gt;v[n]= t; apn-&gt;u[n]= s; apn-&gt;seg[n]= seg; break; }</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span>
<a name="l00559"></a>00559     <span class="comment">/* add to pixel list */</span>
<a name="l00560"></a>00560     <span class="keywordflow">if</span> (zverg &lt; bufferz &amp;&amp; (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">totapixbuf</a>[offset] &lt; <a class="code" href="../../d9/de5/strand_8c.html#adb9669652571819a7dc83e6e367035f1">MAX_ZROW</a>)) {
<a name="l00561"></a>00561         <span class="keywordflow">if</span> (!spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a> || zverg &gt; maskz) {
<a name="l00562"></a>00562             t = u*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[0] + v*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[1] + (1.0f-u-v)*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[2];
<a name="l00563"></a>00563             s = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(u*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[0] + v*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[1] + (1.0f-u-v)*spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[2]);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565             apn= spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a2cfec9609b10645513eec4c029541fec">apixbuf</a> + offset;
<a name="l00566"></a>00566             <span class="keywordflow">while</span> (apn) {
<a name="l00567"></a>00567                 <a class="code" href="../../d9/de5/strand_8c.html#a4e8ef8e0409b8f125eceb058d918b647">CHECK_ADD</a>(0);
<a name="l00568"></a>00568                 <a class="code" href="../../d9/de5/strand_8c.html#a4e8ef8e0409b8f125eceb058d918b647">CHECK_ADD</a>(1);
<a name="l00569"></a>00569                 <a class="code" href="../../d9/de5/strand_8c.html#a4e8ef8e0409b8f125eceb058d918b647">CHECK_ADD</a>(2);
<a name="l00570"></a>00570                 <a class="code" href="../../d9/de5/strand_8c.html#a4e8ef8e0409b8f125eceb058d918b647">CHECK_ADD</a>(3);
<a name="l00571"></a>00571                 <a class="code" href="../../d9/de5/strand_8c.html#a819dfac0ba936e5a675b2f72a10e5144">CHECK_ASSIGN</a>(0);
<a name="l00572"></a>00572                 <a class="code" href="../../d9/de5/strand_8c.html#a819dfac0ba936e5a675b2f72a10e5144">CHECK_ASSIGN</a>(1);
<a name="l00573"></a>00573                 <a class="code" href="../../d9/de5/strand_8c.html#a819dfac0ba936e5a675b2f72a10e5144">CHECK_ASSIGN</a>(2);
<a name="l00574"></a>00574                 <a class="code" href="../../d9/de5/strand_8c.html#a819dfac0ba936e5a675b2f72a10e5144">CHECK_ASSIGN</a>(3);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                 apnew= <a class="code" href="../../d9/de5/strand_8c.html#ab55838e23296cc651df0dd68bdfb5897">addpsAstrand</a>(spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a31ea386065a561737b9c372002f2cedd">zspan</a>);
<a name="l00577"></a>00577                 <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a>, *apnew, *apn);
<a name="l00578"></a>00578                 apn-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#af9afccdaf6b0344c73a6b7ac83e4b239">next</a>= apnew;
<a name="l00579"></a>00579                 <a class="code" href="../../d9/de5/strand_8c.html#a819dfac0ba936e5a675b2f72a10e5144">CHECK_ASSIGN</a>(0);
<a name="l00580"></a>00580             }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582             <span class="keywordflow">if</span> (cache) {
<a name="l00583"></a>00583                 <a class="code" href="../../d9/de5/strand_8c.html#a78b21e877c12acf3f727422c2e32ebc1">strand_shade_refcount</a>(cache, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]);
<a name="l00584"></a>00584                 <a class="code" href="../../d9/de5/strand_8c.html#a78b21e877c12acf3f727422c2e32ebc1">strand_shade_refcount</a>(cache, sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]);
<a name="l00585"></a>00585             }
<a name="l00586"></a>00586             spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">totapixbuf</a>[offset]++;
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="comment">/* width is calculated in hoco space, to ensure strands are visible */</span>
<a name="l00592"></a><a class="code" href="../../d9/de5/strand_8c.html#a9aa04af7e193883a11fdd14b4c604c7f">00592</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/de5/strand_8c.html#a9aa04af7e193883a11fdd14b4c604c7f">strand_test_clip</a>(<span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(zspan), <span class="keywordtype">float</span> *<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *zcomp, <span class="keywordtype">float</span> widthx, <span class="keywordtype">float</span> widthy)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <span class="keywordtype">float</span> hoco[4];
<a name="l00595"></a>00595     <span class="keywordtype">int</span> clipflag= 0;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(co, winmat, hoco);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="comment">/* we compare z without perspective division for segment sorting */</span>
<a name="l00600"></a>00600     *zcomp= hoco[2];
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="keywordflow">if</span> (hoco[0]+widthx &lt; bounds[0]*hoco[3]) clipflag |= 1;
<a name="l00603"></a>00603     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hoco[0]-widthx &gt; bounds[1]*hoco[3]) clipflag |= 2;
<a name="l00604"></a>00604     
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (hoco[1]-widthy &gt; bounds[3]*hoco[3]) clipflag |= 4;
<a name="l00606"></a>00606     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hoco[1]+widthy &lt; bounds[2]*hoco[3]) clipflag |= 8;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     clipflag |= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(hoco);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="keywordflow">return</span> clipflag;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a><a class="code" href="../../d9/de5/strand_8c.html#abe5fa0507b13411b41e4e61c4fbeb18c">00613</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#abe5fa0507b13411b41e4e61c4fbeb18c">do_scanconvert_strand</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(re), <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> *spart, <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> dt, <span class="keywordtype">float</span> *co1, <span class="keywordtype">float</span> *co2, <span class="keywordtype">float</span> *co3, <span class="keywordtype">float</span> *co4, <span class="keywordtype">int</span> sample)
<a name="l00614"></a>00614 {
<a name="l00615"></a>00615     <span class="keywordtype">float</span> jco1[3], jco2[3], jco3[3], jco4[3], jx, jy;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(jco1, co1);
<a name="l00618"></a>00618     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(jco2, co2);
<a name="l00619"></a>00619     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(jco3, co3);
<a name="l00620"></a>00620     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(jco4, co4);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">jit</a>) {
<a name="l00623"></a>00623         jx= -spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">jit</a>[sample][0];
<a name="l00624"></a>00624         jy= -spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">jit</a>[sample][1];
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         jco1[0] += jx; jco1[1] += jy;
<a name="l00627"></a>00627         jco2[0] += jx; jco2[1] += jy;
<a name="l00628"></a>00628         jco3[0] += jx; jco3[1] += jy;
<a name="l00629"></a>00629         jco4[0] += jx; jco4[1] += jy;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <span class="comment">/* XXX mblur? */</span>
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#ae01686212186436e61ef679f9d79a19a">sample</a>= sample;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[0]= t-dt;
<a name="l00637"></a>00637     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[0]= -1.0f;
<a name="l00638"></a>00638     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[1]= t-dt;
<a name="l00639"></a>00639     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[1]= 1.0f;
<a name="l00640"></a>00640     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[2]= t;
<a name="l00641"></a>00641     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[2]= 1.0f;
<a name="l00642"></a>00642     <a class="code" href="../../d9/de5/strand_8c.html#a3d23e1e42d175fd98e6617e0635aafe6">zspan_scanconvert_strand</a>(zspan, spart, jco1, jco2, jco3, <a class="code" href="../../d9/de5/strand_8c.html#abf7fc1a5f18913ebb3a0746e308b2511">do_strand_fillac</a>);
<a name="l00643"></a>00643     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[0]= t-dt;
<a name="l00644"></a>00644     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[0]= -1.0f;
<a name="l00645"></a>00645     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[1]= t;
<a name="l00646"></a>00646     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[1]= 1.0f;
<a name="l00647"></a>00647     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#a8f2cc748575d4b2deeb940c34633d385">t</a>[2]= t;
<a name="l00648"></a>00648     spart-&gt;<a class="code" href="../../df/da8/structStrandPart.html#af2d9bd75b25ef9bb82e7b8fd9c54aa2b">s</a>[2]= -1.0f;
<a name="l00649"></a>00649     <a class="code" href="../../d9/de5/strand_8c.html#a3d23e1e42d175fd98e6617e0635aafe6">zspan_scanconvert_strand</a>(zspan, spart, jco1, jco3, jco4, <a class="code" href="../../d9/de5/strand_8c.html#abf7fc1a5f18913ebb3a0746e308b2511">do_strand_fillac</a>);
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a><a class="code" href="../../d9/de5/strand_8c.html#afd21a944eb46ed382f242702b38902af">00652</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d9/de5/strand_8c.html#afd21a944eb46ed382f242702b38902af">strand_render</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> *spart, <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> totzspan, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p1, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p2)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <span class="keywordflow">if</span> (spart) {
<a name="l00655"></a>00655         <span class="keywordtype">float</span> t= p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>;
<a name="l00656"></a>00656         <span class="keywordtype">float</span> dt= p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a> - p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>;
<a name="l00657"></a>00657         <span class="keywordtype">int</span> a;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>) {
<a name="l00660"></a>00660             <span class="keywordflow">for</span> (a=0; a&lt;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>; a++)
<a name="l00661"></a>00661                 <a class="code" href="../../d9/de5/strand_8c.html#abe5fa0507b13411b41e4e61c4fbeb18c">do_scanconvert_strand</a>(re, spart, zspan, t, dt, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>, a);
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663         <span class="keywordflow">else</span>
<a name="l00664"></a>00664             <a class="code" href="../../d9/de5/strand_8c.html#abe5fa0507b13411b41e4e61c4fbeb18c">do_scanconvert_strand</a>(re, spart, zspan, t, dt, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>, 0);
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     <span class="keywordflow">else</span> {
<a name="l00667"></a>00667         <span class="keywordtype">float</span> hoco1[4], hoco2[4];
<a name="l00668"></a>00668         <span class="keywordtype">int</span> a, <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a5322a5a0729346a187b8813794588a44">obi</a>, index;
<a name="l00669"></a>00669   
<a name="l00670"></a>00670         obi= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a> - re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>;
<a name="l00671"></a>00671         index= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#add864843502cbf24301455bc84520d09">index</a>;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, winmat, hoco1);
<a name="l00674"></a>00674         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a13f0a6ecc036e73ed3368700268db0ec">co</a>, winmat, hoco2);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676   
<a name="l00677"></a>00677         <span class="keywordflow">for</span> (a=0; a&lt;totzspan; a++) {
<a name="l00678"></a>00678 <span class="preprocessor">#if 0</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>            <span class="comment">/* render both strand and single pixel wire to counter aliasing */</span>
<a name="l00680"></a>00680             <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(re, &amp;zspan[a], obi, index, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a5a1e7fc2314c517d8bb47b3ab8d6f7b6">clip2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab49bd9e917384e92f96c6dbaef62f729">clip1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab49bd9e917384e92f96c6dbaef62f729">clip1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a5a1e7fc2314c517d8bb47b3ab8d6f7b6">clip2</a>);
<a name="l00681"></a>00681 <span class="preprocessor">#endif</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>            <span class="comment">/* only render a line for now, which makes the shadow map more</span>
<a name="l00683"></a>00683 <span class="comment">             * similar across frames, and so reduces flicker */</span>
<a name="l00684"></a>00684             <a class="code" href="../../d9/de5/strand_8c.html#a34b656e98ebe13a6250b11cc2f3da4b0">zbufsinglewire</a>(&amp;zspan[a], obi, index, hoco1, hoco2);
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a><a class="code" href="../../d9/de5/strand_8c.html#aad2d75d4c6286380281d76c90013c531">00689</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/de5/strand_8c.html#aad2d75d4c6286380281d76c90013c531">strand_segment_recursive</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> *spart, <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> totzspan, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p1, <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p2, <span class="keywordtype">int</span> depth)
<a name="l00690"></a>00690 {
<a name="l00691"></a>00691     <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00692"></a>00692     <a class="code" href="../../de/d59/structStrandBuffer.html">StrandBuffer</a> *buffer= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>;
<a name="l00693"></a>00693     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>, d1[2], d2[2], len1, len2;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (depth == buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a4b60440e76a41cc800085d7de2a8b635">maxdepth</a>)
<a name="l00696"></a>00696         <span class="keywordflow">return</span> 0;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     p.<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>= (p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a> + p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>)*0.5f;
<a name="l00699"></a>00699     <a class="code" href="../../d3/dda/strand_8h.html#ae3accfdc6e641b52f5cffd6627472f10">strand_eval_point</a>(sseg, &amp;p);
<a name="l00700"></a>00700     <a class="code" href="../../d9/de5/strand_8c.html#a2578b98a3d0a6b638376a61ffdf2ffde">strand_project_point</a>(buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ae0265e66e1fd71209f05feac678de81b">winx</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a8026d950bbd43253551e536b26d6fffb">winy</a>, &amp;p);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     d1[0]= (p.<a class="code" href="../../dd/d23/structStrandPoint.html#ade5a91eed34291474fa18fe7d80489db">x</a> - p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ade5a91eed34291474fa18fe7d80489db">x</a>);
<a name="l00703"></a>00703     d1[1]= (p.<a class="code" href="../../dd/d23/structStrandPoint.html#a48554eab038b4d701835c5b43253dbe1">y</a> - p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a48554eab038b4d701835c5b43253dbe1">y</a>);
<a name="l00704"></a>00704     len1= d1[0]*d1[0] + d1[1]*d1[1];
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     d2[0]= (p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ade5a91eed34291474fa18fe7d80489db">x</a> - p.<a class="code" href="../../dd/d23/structStrandPoint.html#ade5a91eed34291474fa18fe7d80489db">x</a>);
<a name="l00707"></a>00707     d2[1]= (p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a48554eab038b4d701835c5b43253dbe1">y</a> - p.<a class="code" href="../../dd/d23/structStrandPoint.html#a48554eab038b4d701835c5b43253dbe1">y</a>);
<a name="l00708"></a>00708     len2= d2[0]*d2[0] + d2[1]*d2[1];
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (len1 == 0.0f || len2 == 0.0f)
<a name="l00711"></a>00711         <span class="keywordflow">return</span> 0;
<a name="l00712"></a>00712     
<a name="l00713"></a>00713     dot= d1[0]*d2[0] + d1[1]*d2[1];
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (dot*dot &gt; sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a>*len1*len2)
<a name="l00715"></a>00715         <span class="keywordflow">return</span> 0;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (spart) {
<a name="l00718"></a>00718         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p.<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, p.<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>, p.<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>);
<a name="l00719"></a>00719         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p.<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, p.<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>, p.<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>);
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">else</span> {
<a name="l00722"></a>00722 <span class="preprocessor">#if 0</span>
<a name="l00723"></a>00723 <span class="preprocessor"></span>        <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p.<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, winmat, p.<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00724"></a>00724         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p.<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, winmat, p.<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00725"></a>00725         p.<a class="code" href="../../dd/d23/structStrandPoint.html#ab49bd9e917384e92f96c6dbaef62f729">clip1</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p.<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00726"></a>00726         p.<a class="code" href="../../dd/d23/structStrandPoint.html#a5a1e7fc2314c517d8bb47b3ab8d6f7b6">clip2</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p.<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00727"></a>00727 <span class="preprocessor">#endif</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>    }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/de5/strand_8c.html#aad2d75d4c6286380281d76c90013c531">strand_segment_recursive</a>(re, winmat, spart, zspan, totzspan, sseg, p1, &amp;p, depth+1))
<a name="l00731"></a>00731         <a class="code" href="../../d9/de5/strand_8c.html#afd21a944eb46ed382f242702b38902af">strand_render</a>(re, sseg, winmat, spart, zspan, totzspan, p1, &amp;p);
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/de5/strand_8c.html#aad2d75d4c6286380281d76c90013c531">strand_segment_recursive</a>(re, winmat, spart, zspan, totzspan, sseg, &amp;p, p2, depth+1))
<a name="l00733"></a>00733         <a class="code" href="../../d9/de5/strand_8c.html#afd21a944eb46ed382f242702b38902af">strand_render</a>(re, sseg, winmat, spart, zspan, totzspan, &amp;p, p2);
<a name="l00734"></a>00734     
<a name="l00735"></a>00735     <span class="keywordflow">return</span> 1;
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a><a class="code" href="../../d9/de5/strand_8c.html#a55a8aeafa411526c3c8fd2f5b8f9c624">00738</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#adb02dabf7d4fa72157389a58f1aa906c">render_strand_segment</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> winmat[][4], <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> *spart, <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> totzspan, <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> *sseg)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740     <a class="code" href="../../de/d59/structStrandBuffer.html">StrandBuffer</a> *buffer= sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>;
<a name="l00741"></a>00741     <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p1= &amp;sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#a828346e9bea10f93f1c3efb4ba3119c6">point1</a>;
<a name="l00742"></a>00742     <a class="code" href="../../dd/d23/structStrandPoint.html">StrandPoint</a> *p2= &amp;sseg-&gt;<a class="code" href="../../dc/d5a/structStrandSegment.html#af4c9bae7aa18d630320c234d86dc0d02">point2</a>;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>= 0.0f;
<a name="l00745"></a>00745     p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab1254d567430ff76ac32327ad92ed76c">t</a>= 1.0f;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <a class="code" href="../../d3/dda/strand_8h.html#ae3accfdc6e641b52f5cffd6627472f10">strand_eval_point</a>(sseg, p1);
<a name="l00748"></a>00748     <a class="code" href="../../d9/de5/strand_8c.html#a2578b98a3d0a6b638376a61ffdf2ffde">strand_project_point</a>(buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ae0265e66e1fd71209f05feac678de81b">winx</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a8026d950bbd43253551e536b26d6fffb">winy</a>, p1);
<a name="l00749"></a>00749     <a class="code" href="../../d3/dda/strand_8h.html#ae3accfdc6e641b52f5cffd6627472f10">strand_eval_point</a>(sseg, p2);
<a name="l00750"></a>00750     <a class="code" href="../../d9/de5/strand_8c.html#a2578b98a3d0a6b638376a61ffdf2ffde">strand_project_point</a>(buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a9b0a4c6ad1abd6ff72f701b16c88d452">winmat</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#ae0265e66e1fd71209f05feac678de81b">winx</a>, buffer-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a8026d950bbd43253551e536b26d6fffb">winy</a>, p2);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (spart) {
<a name="l00753"></a>00753         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>);
<a name="l00754"></a>00754         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>);
<a name="l00755"></a>00755         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac9f98aa625345c9d653a817f59b28099">zco1</a>);
<a name="l00756"></a>00756         <a class="code" href="../../d9/de5/strand_8c.html#a31a5493ce32603ec14c3fa09319fbee8">do_strand_point_project</a>(winmat, zspan, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a8f51e73e06208d97114da76425927eed">zco2</a>);
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758     <span class="keywordflow">else</span> {
<a name="l00759"></a>00759 <span class="preprocessor">#if 0</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span>        <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, winmat, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00761"></a>00761         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, winmat, p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00762"></a>00762         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab9df52fbe68b630a0300b70b20640295">co1</a>, winmat, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00763"></a>00763         <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#af2666664107a3084750be5e90c7da419">co2</a>, winmat, p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00764"></a>00764         p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab49bd9e917384e92f96c6dbaef62f729">clip1</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00765"></a>00765         p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a5a1e7fc2314c517d8bb47b3ab8d6f7b6">clip2</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p1-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00766"></a>00766         p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ab49bd9e917384e92f96c6dbaef62f729">clip1</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a0f974157deacc154fd396a00d07cd784">hoco1</a>);
<a name="l00767"></a>00767         p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#a5a1e7fc2314c517d8bb47b3ab8d6f7b6">clip2</a>= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(p2-&gt;<a class="code" href="../../dd/d23/structStrandPoint.html#ac215cfd5241f7755c82447aa492f3aca">hoco2</a>);
<a name="l00768"></a>00768 <span class="preprocessor">#endif</span>
<a name="l00769"></a>00769 <span class="preprocessor"></span>    }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/de5/strand_8c.html#aad2d75d4c6286380281d76c90013c531">strand_segment_recursive</a>(re, winmat, spart, zspan, totzspan, sseg, p1, p2, 0))
<a name="l00772"></a>00772         <a class="code" href="../../d9/de5/strand_8c.html#afd21a944eb46ed382f242702b38902af">strand_render</a>(re, sseg, winmat, spart, zspan, totzspan, p1, p2);
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="comment">/* render call to fill in strands */</span>
<a name="l00776"></a><a class="code" href="../../d9/de5/strand_8c.html#a9c48750502abbf6e3b74a0487cbd3533">00776</a> <span class="keywordtype">int</span> <a class="code" href="../../df/d9d/zbuf_8h.html#a047cf24106811b6e6be9a132c64827ce">zbuffer_strands_abuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *apixbuf, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *apsmbase, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(negzmask), <span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(sample), <span class="keywordtype">float</span> (*<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>)[2], <span class="keywordtype">float</span> clipcrop, <span class="keywordtype">int</span> shadow, <a class="code" href="../../db/de2/structStrandShadeCache.html">StrandShadeCache</a> *cache)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00779"></a>00779     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *<a class="code" href="../../d2/d2d/structStrandSortSegment.html#a5322a5a0729346a187b8813794588a44">obi</a>;
<a name="l00780"></a>00780     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspan;
<a name="l00781"></a>00781     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *<a class="code" href="../../d2/d2d/structStrandSortSegment.html#a1f2a3976cbb81290b443735b013d22b8">strand</a>=0;
<a name="l00782"></a>00782     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert;
<a name="l00783"></a>00783     <a class="code" href="../../db/d4b/structStrandBound.html">StrandBound</a> *sbound;
<a name="l00784"></a>00784     <a class="code" href="../../df/da8/structStrandPart.html">StrandPart</a> spart;
<a name="l00785"></a>00785     <a class="code" href="../../dc/d5a/structStrandSegment.html">StrandSegment</a> sseg;
<a name="l00786"></a>00786     <a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a> *sortsegments = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *sortseg, *firstseg;
<a name="l00787"></a>00787     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena;
<a name="l00788"></a>00788     <span class="keywordtype">float</span> <a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad0ae28dedd2ae2c066329a85c3910b18">z</a>[4], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[4], obwinmat[4][4];
<a name="l00789"></a>00789     <span class="keywordtype">int</span> a, b, c, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, totsegment, clip[4];
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l00792"></a>00792         <span class="keywordflow">return</span> 0;
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a> == 0)
<a name="l00794"></a>00794         <span class="keywordflow">return</span> 0;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="comment">/* setup StrandPart */</span>
<a name="l00797"></a>00797     memset(&amp;spart, 0, <span class="keyword">sizeof</span>(spart));
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     spart.<a class="code" href="../../df/da8/structStrandPart.html#a771afc39a0d7f0ffcc5308f242f2880d">re</a>= re;
<a name="l00800"></a>00800     spart.<a class="code" href="../../df/da8/structStrandPart.html#aaceb8fea2648a8374338fc03d257c3a6">rectx</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l00801"></a>00801     spart.<a class="code" href="../../df/da8/structStrandPart.html#aa8f253f6bfc6652235cd526e6b71aa8b">recty</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>;
<a name="l00802"></a>00802     spart.<a class="code" href="../../df/da8/structStrandPart.html#a2cfec9609b10645513eec4c029541fec">apixbuf</a>= apixbuf;
<a name="l00803"></a>00803     spart.<a class="code" href="../../df/da8/structStrandPart.html#a31ea386065a561737b9c372002f2cedd">zspan</a>= &amp;zspan;
<a name="l00804"></a>00804     spart.<a class="code" href="../../df/da8/structStrandPart.html#a8e1ab7abbbd35eeee3fb6a6892d57704">rectdaps</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>;
<a name="l00805"></a>00805     spart.<a class="code" href="../../df/da8/structStrandPart.html#aa02a58961037065ffe2342937411be5d">rectz</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>;
<a name="l00806"></a>00806     spart.<a class="code" href="../../df/da8/structStrandPart.html#a38251d7bee94b3570e6a21cab8baa59d">rectmask</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1a79af7085fe5dcf1ea389f52666153a">rectmask</a>;
<a name="l00807"></a>00807     spart.<a class="code" href="../../df/da8/structStrandPart.html#ae9a7dcd21b5622abeccc6019e3b44001">cache</a>= cache;
<a name="l00808"></a>00808     spart.<a class="code" href="../../df/da8/structStrandPart.html#ad1d5c8cb2df140379e07a058834a198e">shadow</a>= shadow;
<a name="l00809"></a>00809     spart.<a class="code" href="../../df/da8/structStrandPart.html#a4138742108c9a66e89bbe3c926a812ba">jit</a>= <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(&amp;zspan, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, clipcrop);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     <span class="comment">/* needed for transform from hoco to zbuffer co */</span>
<a name="l00814"></a>00814     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>= ((float)winx)/2.0f;
<a name="l00815"></a>00815     zspan.<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>= ((float)winy)/2.0f;
<a name="l00816"></a>00816     
<a name="l00817"></a>00817     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l00818"></a>00818     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="comment">/* to center the sample position */</span>
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (!shadow) {
<a name="l00822"></a>00822         zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a> -= 0.5f;
<a name="l00823"></a>00823         zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a> -= 0.5f;
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     zspan.<a class="code" href="../../d2/d95/structZSpan.html#aa8c2f165a3d6f750a37a1740028b8e0a">apsmbase</a>= apsmbase;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="comment">/* clipping setup */</span>
<a name="l00829"></a>00829     bounds[0]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> - winx-1)/(<span class="keywordtype">float</span>)winx;
<a name="l00830"></a>00830     bounds[1]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - winx+1)/(<span class="keywordtype">float</span>)winx;
<a name="l00831"></a>00831     bounds[2]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> - winy-1)/(<span class="keywordtype">float</span>)winy;
<a name="l00832"></a>00832     bounds[3]= (2*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - winy+1)/(<span class="keywordtype">float</span>)winy;
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     memarena= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;strand sort arena&quot;</span>);
<a name="l00835"></a>00835     firstseg= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00836"></a>00836     totsegment= 0;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">/* for all object instances */</span>
<a name="l00839"></a>00839     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i=0; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>, i++) {
<a name="l00840"></a>00840         <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l00841"></a>00841         <span class="keywordtype">float</span> widthx, widthy;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         <span class="keywordflow">if</span> (!obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a> || !(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a09b2691a6cbbfdf69783798db24db9c3">lay</a> &amp; lay))
<a name="l00846"></a>00846             <span class="keywordflow">continue</span>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848         <span class="comment">/* compute matrix and try clipping whole object */</span>
<a name="l00849"></a>00849         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l00850"></a>00850             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obwinmat, winmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l00851"></a>00851         <span class="keywordflow">else</span>
<a name="l00852"></a>00852             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obwinmat, winmat);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854         <span class="comment">/* test if we should skip it */</span>
<a name="l00855"></a>00855         ma = obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <span class="keywordflow">if</span> (shadow &amp;&amp; !(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>))
<a name="l00858"></a>00858             <span class="keywordflow">continue</span>;
<a name="l00859"></a>00859         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!shadow &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0b02e3e0afacbc7473b8ed9984a65c01">MA_ONLYCAST</a>))
<a name="l00860"></a>00860             <span class="keywordflow">continue</span>;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4c69b2c1fc37ba8821d08c42ad636634">boundbox</a>, bounds, obwinmat))
<a name="l00863"></a>00863             <span class="keywordflow">continue</span>;
<a name="l00864"></a>00864         
<a name="l00865"></a>00865         widthx= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#adc27b2e50869f389b7a34e804845acac">maxwidth</a>*obwinmat[0][0];
<a name="l00866"></a>00866         widthy= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#adc27b2e50869f389b7a34e804845acac">maxwidth</a>*obwinmat[1][1];
<a name="l00867"></a>00867 
<a name="l00868"></a>00868         <span class="comment">/* for each bounding box containing a number of strands */</span>
<a name="l00869"></a>00869         sbound= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#af00d74ade5c37f00af2dd76669cb0f8a">bound</a>;
<a name="l00870"></a>00870         <span class="keywordflow">for</span> (c=0; c&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aa744e336644b15244aeb8c91dde4936c">strandbuf</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00024d744b9d32cf89f665232c681825">totbound</a>; c++, sbound++) {
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (<a class="code" href="../../d0/db6/renderdatabase_8h.html#a572048eaa3a480857fb18ded550609f2">clip_render_object</a>(sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#a10cefb70292f40dc1d2ff66530c5e4b4">boundbox</a>, bounds, obwinmat))
<a name="l00872"></a>00872                 <span class="keywordflow">continue</span>;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874             <span class="comment">/* for each strand in this bounding box */</span>
<a name="l00875"></a>00875             <span class="keywordflow">for</span> (a=sbound-&gt;<a class="code" href="../../db/d4b/structStrandBound.html#ab08575b8cb6f47ae376afa33239360f6">start</a>; a&lt;sbound-&gt;end; a++) {
<a name="l00876"></a>00876                 strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, a);
<a name="l00877"></a>00877                 svert= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879                 <span class="comment">/* keep clipping and z depth for 4 control points */</span>
<a name="l00880"></a>00880                 clip[1]= <a class="code" href="../../d9/de5/strand_8c.html#a9aa04af7e193883a11fdd14b4c604c7f">strand_test_clip</a>(obwinmat, &amp;zspan, bounds, svert-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>, &amp;z[1], widthx, widthy);
<a name="l00881"></a>00881                 clip[2]= <a class="code" href="../../d9/de5/strand_8c.html#a9aa04af7e193883a11fdd14b4c604c7f">strand_test_clip</a>(obwinmat, &amp;zspan, bounds, (svert+1)-&gt;<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, &amp;z[2], widthx, widthy);
<a name="l00882"></a>00882                 clip[0]= clip[1]; z[0]= z[1];
<a name="l00883"></a>00883 
<a name="l00884"></a>00884                 <span class="keywordflow">for</span> (b=0; b&lt;strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>-1; b++, svert++) {
<a name="l00885"></a>00885                     <span class="comment">/* compute 4th point clipping and z depth */</span>
<a name="l00886"></a>00886                     <span class="keywordflow">if</span> (b &lt; strand-&gt;totvert-2) {
<a name="l00887"></a>00887                         clip[3]= <a class="code" href="../../d9/de5/strand_8c.html#a9aa04af7e193883a11fdd14b4c604c7f">strand_test_clip</a>(obwinmat, &amp;zspan, bounds, (svert+2)-&gt;<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, &amp;z[3], widthx, widthy);
<a name="l00888"></a>00888                     }
<a name="l00889"></a>00889                     <span class="keywordflow">else</span> {
<a name="l00890"></a>00890                         clip[3]= clip[2]; z[3]= z[2];
<a name="l00891"></a>00891                     }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893                     <span class="comment">/* check clipping and add to sortsegments buffer */</span>
<a name="l00894"></a>00894                     <span class="keywordflow">if</span> (!(clip[0] &amp; clip[1] &amp; clip[2] &amp; clip[3])) {
<a name="l00895"></a>00895                         sortseg= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(memarena, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a>));
<a name="l00896"></a>00896                         sortseg-&gt;obi= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00897"></a>00897                         sortseg-&gt;strand= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#add864843502cbf24301455bc84520d09">index</a>;
<a name="l00898"></a>00898                         sortseg-&gt;segment= b;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900                         sortseg-&gt;z= 0.5f*(z[1] + z[2]);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902                         sortseg-&gt;next= firstseg;
<a name="l00903"></a>00903                         firstseg= sortseg;
<a name="l00904"></a>00904                         totsegment++;
<a name="l00905"></a>00905                     }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907                     <span class="comment">/* shift clipping and z depth */</span>
<a name="l00908"></a>00908                     clip[0]= clip[1]; z[0]= z[1];
<a name="l00909"></a>00909                     clip[1]= clip[2]; z[1]= z[2];
<a name="l00910"></a>00910                     clip[2]= clip[3]; z[2]= z[3];
<a name="l00911"></a>00911                 }
<a name="l00912"></a>00912             }
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914     }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l00917"></a>00917         <span class="comment">/* convert list to array and sort */</span>
<a name="l00918"></a>00918         sortsegments= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a>)*totsegment, <span class="stringliteral">&quot;StrandSortSegment&quot;</span>);
<a name="l00919"></a>00919         <span class="keywordflow">for</span> (a=0, sortseg=firstseg; a&lt;totsegment; a++, sortseg=sortseg-&gt;<a class="code" href="../../d2/d2d/structStrandSortSegment.html#ad689026eb9f9efc7f20bd54bcee1ec94">next</a>)
<a name="l00920"></a>00920             sortsegments[a]= *sortseg;
<a name="l00921"></a>00921         qsort(sortsegments, totsegment, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d2d/structStrandSortSegment.html">StrandSortSegment</a>), <a class="code" href="../../d9/de5/strand_8c.html#a08dba87ff9e455875f8ba2bc9bc52014">compare_strand_segment</a>);
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(memarena);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     spart.<a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">totapixbuf</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;totapixbuf&quot;</span>);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) {
<a name="l00929"></a>00929         <span class="comment">/* render segments in sorted order */</span>
<a name="l00930"></a>00930         sortseg= sortsegments;
<a name="l00931"></a>00931         <span class="keywordflow">for</span> (a=0; a&lt;totsegment; a++, sortseg++) {
<a name="l00932"></a>00932             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l00933"></a>00933                 <span class="keywordflow">break</span>;
<a name="l00934"></a>00934 
<a name="l00935"></a>00935             obi= &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>[sortseg-&gt;obi];
<a name="l00936"></a>00936             obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a3780f9a96ea6bf55040fd7de44894486">obi</a>= <a class="code" href="../../d2/d2d/structStrandSortSegment.html#a5322a5a0729346a187b8813794588a44">obi</a>;
<a name="l00939"></a>00939             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obr, sortseg-&gt;strand);
<a name="l00940"></a>00940             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>;
<a name="l00941"></a>00941             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a>= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a65e1aec132c4f4d5ebbcf22ab9a56d50">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a23b915de538dd5c68a1d8f8f7dc335c6">adaptcos</a>;
<a name="l00942"></a>00942             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a> *= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#afc7eebf874fcce1c4747dce655e7ef99">sqadaptcos</a>;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944             svert= sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a> + sortseg-&gt;segment;
<a name="l00945"></a>00945             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[0]= (sortseg-&gt;segment &gt; 0)? (svert-1): svert;
<a name="l00946"></a>00946             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[1]= svert;
<a name="l00947"></a>00947             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[2]= svert+1;
<a name="l00948"></a>00948             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8d182b83301643e82e7e350521d81cba">v</a>[3]= (sortseg-&gt;segment &lt; sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#a8ac81e021ced8af96a343cd75ca94fdf">strand</a>-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a781b771cdb819318628f2ca3a124a7f2">totvert</a>-2)? svert+2: svert+1;
<a name="l00949"></a>00949             sseg.<a class="code" href="../../dc/d5a/structStrandSegment.html#ae5e154d7fdac1aee02f0325990b4c2b8">shaded</a>= 0;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951             spart.<a class="code" href="../../df/da8/structStrandPart.html#a5652cdf62d0ad49ffa12319a0e302bc1">segment</a>= &amp;sseg;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953             <a class="code" href="../../d3/dda/strand_8h.html#adb02dabf7d4fa72157389a58f1aa906c">render_strand_segment</a>(re, winmat, &amp;spart, &amp;zspan, 1, &amp;sseg);
<a name="l00954"></a>00954         }
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     <span class="keywordflow">if</span> (sortsegments)
<a name="l00958"></a>00958         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sortsegments);
<a name="l00959"></a>00959     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(spart.<a class="code" href="../../df/da8/structStrandPart.html#ac87f9b8a9269bda8854fbfaeea689b98">totapixbuf</a>);
<a name="l00960"></a>00960     
<a name="l00961"></a>00961     <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(&amp;zspan);
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keywordflow">return</span> totsegment;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="comment">/* *************** */</span>
<a name="l00967"></a>00967 
<a name="l00968"></a><a class="code" href="../../d9/de5/strand_8c.html#aeca21f3742da4012b73d840c94bd8d51">00968</a> <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *<a class="code" href="../../d3/dda/strand_8h.html#a54f5f8bfb6f829e604db6598f67ff6e7">cache_strand_surface</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">int</span> timeoffset)
<a name="l00969"></a>00969 {
<a name="l00970"></a>00970     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh;
<a name="l00971"></a>00971     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l00972"></a>00972     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00973"></a>00973     float (*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)[3];
<a name="l00974"></a>00974     <span class="keywordtype">int</span> a, totvert, totface;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l00977"></a>00977     totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordflow">for</span> (mesh = re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; mesh; mesh = mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0cd6eb7fc691e941f6513fb7f0139077">next</a>) {
<a name="l00980"></a>00980         <span class="keywordflow">if</span> ((mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0abbccf31b854cdbab63187a313dfc15">obr</a>.<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>    == obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) &amp;&amp;
<a name="l00981"></a>00981             (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0abbccf31b854cdbab63187a313dfc15">obr</a>.<a class="code" href="../../d2/d24/structObjectRen.html#ae7127a2a88f32e2828d482679fd42dc3">par</a>   == obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#ae7127a2a88f32e2828d482679fd42dc3">par</a>) &amp;&amp;
<a name="l00982"></a>00982             (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0abbccf31b854cdbab63187a313dfc15">obr</a>.<a class="code" href="../../d2/d24/structObjectRen.html#a931f9da68c987f59a6d7e6a904bd1698">index</a> == obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a931f9da68c987f59a6d7e6a904bd1698">index</a>) &amp;&amp;
<a name="l00983"></a>00983             (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>   == totvert) &amp;&amp;
<a name="l00984"></a>00984             (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>   == totface))
<a name="l00985"></a>00985         {
<a name="l00986"></a>00986             <span class="keywordflow">break</span>;
<a name="l00987"></a>00987         }
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="keywordflow">if</span> (!mesh) {
<a name="l00991"></a>00991         mesh= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a>), <span class="stringliteral">&quot;StrandSurface&quot;</span>);
<a name="l00992"></a>00992         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0abbccf31b854cdbab63187a313dfc15">obr</a>= *obr;
<a name="l00993"></a>00993         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>= totvert;
<a name="l00994"></a>00994         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>= totface;
<a name="l00995"></a>00995         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*4*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>, <span class="stringliteral">&quot;StrandSurfFaces&quot;</span>);
<a name="l00996"></a>00996         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfAO&quot;</span>);
<a name="l00997"></a>00997         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfEnv&quot;</span>);
<a name="l00998"></a>00998         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfIndirect&quot;</span>);
<a name="l00999"></a>00999         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>, mesh);
<a name="l01000"></a>01000     }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002     <span class="keywordflow">if</span> (timeoffset == -1 &amp;&amp; !mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>)
<a name="l01003"></a>01003         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>= <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfCo&quot;</span>);
<a name="l01004"></a>01004     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timeoffset == 0 &amp;&amp; !mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>)
<a name="l01005"></a>01005         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>= <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfCo&quot;</span>);
<a name="l01006"></a>01006     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (timeoffset == 1 &amp;&amp; !mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>)
<a name="l01007"></a>01007         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>= <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;StrandSurfCo&quot;</span>);
<a name="l01008"></a>01008     <span class="keywordflow">else</span>
<a name="l01009"></a>01009         <span class="keywordflow">return</span> mesh;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     mvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01012"></a>01012     <span class="keywordflow">for</span> (a=0; a&lt;mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>; a++, mvert++) {
<a name="l01013"></a>01013         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[a], mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01014"></a>01014         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[a]);
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016 
<a name="l01017"></a>01017     mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01018"></a>01018     <span class="keywordflow">for</span> (a=0; a&lt;mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>; a++, mface++) {
<a name="l01019"></a>01019         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a][0]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l01020"></a>01020         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a][1]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l01021"></a>01021         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a][2]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l01022"></a>01022         mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a][3]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="keywordflow">return</span> mesh;
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="../../d9/de5/strand_8c.html#a33fa059eacbf287d7568ac76de534e3e">01028</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#a4a7c6760f1d3ef525640a5f91361de04">free_strand_surface</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <span class="keywordflow">for</span> (mesh=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; mesh; mesh=mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0cd6eb7fc691e941f6513fb7f0139077">next</a>) {
<a name="l01033"></a>01033         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>);
<a name="l01034"></a>01034         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#af5dc62b1e6f4af7c216e89565f6efae2">prevco</a>);
<a name="l01035"></a>01035         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a090a016969d9eb50bb739349c593a69e">nextco</a>);
<a name="l01036"></a>01036         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>);
<a name="l01037"></a>01037         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>);
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>);
<a name="l01039"></a>01039         <span class="keywordflow">if</span> (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>);
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>);
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 
<a name="l01045"></a><a class="code" href="../../d9/de5/strand_8c.html#a42026db50c9e17aa5cac95ab7554c6da">01045</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/dda/strand_8h.html#a9b7689ad448361a2258a0c0dfe82bf3c">strand_minmax</a>(<a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *<a class="code" href="../../d2/d2d/structStrandSortSegment.html#a1f2a3976cbb81290b443735b013d22b8">strand</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <span class="keywordtype">float</span> width)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047     <a class="code" href="../../d5/d1c/structStrandVert.html">StrandVert</a> *svert;
<a name="l01048"></a>01048     <span class="keywordtype">float</span> vec[3], width2= 2.0f*width;
<a name="l01049"></a>01049     <span class="keywordtype">int</span> a;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="keywordflow">for</span> (a=0, svert=strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>; a&lt;strand-&gt;totvert; a++, svert++) {
<a name="l01052"></a>01052         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, svert-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l01053"></a>01053         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vec, min, max);
<a name="l01054"></a>01054         
<a name="l01055"></a>01055         <span class="keywordflow">if</span> (width!=0.0f) {
<a name="l01056"></a>01056             vec[0]+= width; vec[1]+= width; vec[2]+= width;
<a name="l01057"></a>01057             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vec, min, max);
<a name="l01058"></a>01058             vec[0]-= width2; vec[1]-= width2; vec[2]-= width2;
<a name="l01059"></a>01059             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vec, min, max);
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061     }
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:57 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
