<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: meshlaplacian.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">meshlaplacian.c</div>  </div>
</div>
<div class="contents">
<a href="../../d1/d2b/meshlaplacian_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> * meshlaplacian.c: Algorithms using the mesh laplacian.</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dfb/BLI__edgehash_8h.html" title="A general unordered 2-int pair hash table ADT.">BLI_edgehash.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db3/BLI__string_8h.html">BLI_string.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d61/BLF__translation_8h.html">BLF_translation.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#ifdef RIGID_DEFORM</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#include &quot;BLI_polardecomp.h&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dde/ONL__opennl_8h.html">ONL_opennl.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d59/BLO__sys__types_8h.html">BLO_sys_types.h</a>&quot;</span> <span class="comment">// for intptr_t support</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d98/ED__armature_8h.html">ED_armature.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/de3/meshlaplacian_8h.html">meshlaplacian.h</a>&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* ************* XXX *************** */</span>
<a name="l00072"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2ce45548122988eaa3d0b9ec7ecbdd7e">00072</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2ce45548122988eaa3d0b9ec7ecbdd7e">waitcursor</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(val)) {}
<a name="l00073"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa8ada5c6c2c3e62c618f290caf40a61d">00073</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa8ada5c6c2c3e62c618f290caf40a61d">progress_bar</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(dummy_val), <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(dummy)) {}
<a name="l00074"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a723320d7fc3c0775eccb9b4481732181">00074</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a723320d7fc3c0775eccb9b4481732181">start_progress_bar</a>(<span class="keywordtype">void</span>) {}
<a name="l00075"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac304804d3114f6e1dfe518e7387af7b8">00075</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac304804d3114f6e1dfe518e7387af7b8">end_progress_bar</a>(<span class="keywordtype">void</span>) {}
<a name="l00076"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a94ab435a74040b5a63317747695e98cb">00076</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a94ab435a74040b5a63317747695e98cb">error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>) { printf(<span class="stringliteral">&quot;error: %s\n&quot;</span>, str); }
<a name="l00077"></a>00077 <span class="comment">/* ************* XXX *************** */</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">/************************** Laplacian System *****************************/</span>
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html">00082</a> <span class="keyword">struct </span><a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> {
<a name="l00083"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a624284425d2ea58fd6f322a61fd10658">00083</a>     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a3481fa5895ecf7c96e0b6245295428d6">NLContext</a> <a class="code" href="../../d1/d52/structLaplacianSystem.html#a624284425d2ea58fd6f322a61fd10658">context</a>;  <span class="comment">/* opennl context */</span>
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">00085</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>, <a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">00087</a>     <span class="keywordtype">float</span> **<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>;          <span class="comment">/* vertex coordinates */</span>
<a name="l00088"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">00088</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>;           <span class="comment">/* vertex weights for laplacian computation */</span>
<a name="l00089"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">00089</a>     <span class="keywordtype">char</span> *<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>;          <span class="comment">/* vertex pinning */</span>
<a name="l00090"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">00090</a>     int (*<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>)[3];        <span class="comment">/* face vertex indices */</span>
<a name="l00091"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">00091</a>     float (*<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>)[3];   <span class="comment">/* cotangent weights per face */</span>
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">00093</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">areaweights</a>;        <span class="comment">/* use area in cotangent weights? */</span>
<a name="l00094"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">00094</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">storeweights</a>;       <span class="comment">/* store cotangent weights in fweights */</span>
<a name="l00095"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a31431ffeeb36557c159536825a73059a">00095</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html#a31431ffeeb36557c159536825a73059a">nlbegun</a>;            <span class="comment">/* nlBegin(NL_SYSTEM/NL_MATRIX) done */</span>
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">00097</a>     <a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>;     <span class="comment">/* edge hash for construction */</span>
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html">00099</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html">HeatWeighting</a> {
<a name="l00100"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">00100</a>         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a>;
<a name="l00101"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">00101</a>         <span class="keywordtype">int</span> <a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">totvert</a>;
<a name="l00102"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">00102</a>         <span class="keywordtype">int</span> <a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">totface</a>;
<a name="l00103"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">00103</a>         float (*<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>)[3];  <span class="comment">/* vertex coordinates */</span>
<a name="l00104"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">00104</a>         float (*<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>)[3];  <span class="comment">/* vertex normals */</span>
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">00106</a>         float (*<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>)[3];   <span class="comment">/* bone root */</span>
<a name="l00107"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ac190e3778a5d46b17a224cc0e00e802f">00107</a>         float (*<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ac190e3778a5d46b17a224cc0e00e802f">tip</a>)[3];    <span class="comment">/* bone tip */</span>
<a name="l00108"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a230c271d51ab17c83292469e0e031613">00108</a>         float (*<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a230c271d51ab17c83292469e0e031613">source</a>)[3]; <span class="comment">/* vertex source */</span>
<a name="l00109"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">00109</a>         <span class="keywordtype">int</span> <a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">numsource</a>;
<a name="l00110"></a>00110 
<a name="l00111"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">00111</a>         <span class="keywordtype">float</span> *<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>;           <span class="comment">/* diagonal H matrix */</span>
<a name="l00112"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">00112</a>         <span class="keywordtype">float</span> *<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>;           <span class="comment">/* values from all p vectors */</span>
<a name="l00113"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1142901333cc328652a0190bbbe81389">00113</a>         <span class="keywordtype">float</span> *<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1142901333cc328652a0190bbbe81389">mindist</a>;     <span class="comment">/* minimum distance to a bone for all vertices */</span>
<a name="l00114"></a>00114         
<a name="l00115"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">00115</a>         <a class="code" href="../../dc/dad/structBVHTree.html">BVHTree</a>   *<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a>; <span class="comment">/* ray tracing acceleration structure */</span>
<a name="l00116"></a><a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">00116</a>         <a class="code" href="../../d6/da0/structMFace.html">MFace</a>     **<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>;  <span class="comment">/* a face that the vertex belongs to */</span>
<a name="l00117"></a>00117     } <a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="preprocessor">#ifdef RIGID_DEFORM</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>    <span class="keyword">struct </span>RigidDeformation {
<a name="l00121"></a>00121         <a class="code" href="../../d4/d5c/structEditMesh.html">EditMesh</a> *mesh;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         float (*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>)[3][3];
<a name="l00124"></a>00124         float (*rhs)[3];
<a name="l00125"></a>00125         float (*origco)[3];
<a name="l00126"></a>00126         <span class="keywordtype">int</span> thrownerror;
<a name="l00127"></a>00127     } rigid;
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>};
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="comment">/* Laplacian matrix construction */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="comment">/* Computation of these weights for the laplacian is based on:</span>
<a name="l00134"></a>00134 <span class="comment"> * &quot;Discrete Differential-Geometry Operators for Triangulated 2-Manifolds&quot;,</span>
<a name="l00135"></a>00135 <span class="comment"> * Meyer et al, 2002. Section 3.5, formula (8).</span>
<a name="l00136"></a>00136 <span class="comment"> * </span>
<a name="l00137"></a>00137 <span class="comment"> * We do it a bit different by going over faces instead of going over each</span>
<a name="l00138"></a>00138 <span class="comment"> * vertex and adjacent faces, since we don&#39;t store this adjacency. Also, the</span>
<a name="l00139"></a>00139 <span class="comment"> * formulas are tweaked a bit to work for non-manifold meshes. */</span>
<a name="l00140"></a>00140 
<a name="l00141"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abcc017d1e058ee6219021df0a9cbee0f">00141</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abcc017d1e058ee6219021df0a9cbee0f">laplacian_increase_edge_count</a>(<a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *edgehash, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143     <span class="keywordtype">void</span> **<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a7c8a792c7e56ccc5c7c35489b005cfa9">BLI_edgehash_lookup_p</a>(edgehash, v1, v2);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (p)
<a name="l00146"></a>00146         *p = (<span class="keywordtype">void</span>*)((intptr_t)*p + (intptr_t)1);
<a name="l00147"></a>00147     <span class="keywordflow">else</span>
<a name="l00148"></a>00148         <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a2e0f4e2b0d6efaccac6f6d7c595955eb">BLI_edgehash_insert</a>(edgehash, v1, v2, (<span class="keywordtype">void</span>*)(intptr_t)1);
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4b8fce4e1d38e252e59aa2b0d966b9db">00151</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4b8fce4e1d38e252e59aa2b0d966b9db">laplacian_edge_count</a>(<a class="code" href="../../db/d6c/structEdgeHash.html">EdgeHash</a> *edgehash, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(intptr_t)<a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a22081636d4bd43fb323bea9b10b6c67a">BLI_edgehash_lookup</a>(edgehash, v1, v2);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">00156</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(<span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     <span class="keywordtype">float</span> a[3], b[3], c[3], clen;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(a, v2, v1);
<a name="l00161"></a>00161     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(b, v3, v1);
<a name="l00162"></a>00162     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(c, a, b);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     clen = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(c);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (clen == 0.0f)
<a name="l00167"></a>00167         <span class="keywordflow">return</span> 0.0f;
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(a, b)/clen;
<a name="l00170"></a>00170 }
<a name="l00171"></a>00171 
<a name="l00172"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a25045969da98fec86cc8374da9dc112d">00172</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a25045969da98fec86cc8374da9dc112d">laplacian_triangle_area</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <span class="keywordtype">int</span> i1, <span class="keywordtype">int</span> i2, <span class="keywordtype">int</span> i3)
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174     <span class="keywordtype">float</span> t1, t2, t3, len1, len2, len3, area;
<a name="l00175"></a>00175     <span class="keywordtype">float</span> *varea= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>, *v1, *v2, *v3;
<a name="l00176"></a>00176     <span class="keywordtype">int</span> obtuse = 0;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     v1= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i1];
<a name="l00179"></a>00179     v2= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i2];
<a name="l00180"></a>00180     v3= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i3];
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     t1= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v1, v2, v3);
<a name="l00183"></a>00183     t2= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v2, v3, v1);
<a name="l00184"></a>00184     t3= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v3, v1, v2);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span>      (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a39e943df2bf33bb95854bdc955644ac3">angle_v3v3v3</a>(v2, v1, v3) &gt; <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>(90.0f)) obtuse= 1;
<a name="l00187"></a>00187     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a39e943df2bf33bb95854bdc955644ac3">angle_v3v3v3</a>(v1, v2, v3) &gt; <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>(90.0f)) obtuse= 2;
<a name="l00188"></a>00188     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a39e943df2bf33bb95854bdc955644ac3">angle_v3v3v3</a>(v1, v3, v2) &gt; <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>(90.0f)) obtuse= 3;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (obtuse &gt; 0) {
<a name="l00191"></a>00191         area= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(v1, v2, v3);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         varea[i1] += (obtuse == 1)? area: area*0.5f;
<a name="l00194"></a>00194         varea[i2] += (obtuse == 2)? area: area*0.5f;
<a name="l00195"></a>00195         varea[i3] += (obtuse == 3)? area: area*0.5f;
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     <span class="keywordflow">else</span> {
<a name="l00198"></a>00198         len1= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v2, v3);
<a name="l00199"></a>00199         len2= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1, v3);
<a name="l00200"></a>00200         len3= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1, v2);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         t1 *= len1*len1;
<a name="l00203"></a>00203         t2 *= len2*len2;
<a name="l00204"></a>00204         t3 *= len3*len3;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         varea[i1] += (t2 + t3)*0.25f;
<a name="l00207"></a>00207         varea[i2] += (t1 + t3)*0.25f;
<a name="l00208"></a>00208         varea[i3] += (t1 + t2)*0.25f;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad2ca0a0b1647cff71072ce8bcdaed3a0">00212</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad2ca0a0b1647cff71072ce8bcdaed3a0">laplacian_triangle_weights</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <span class="keywordtype">int</span> f, <span class="keywordtype">int</span> i1, <span class="keywordtype">int</span> i2, <span class="keywordtype">int</span> i3)
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214     <span class="keywordtype">float</span> t1, t2, t3;
<a name="l00215"></a>00215     <span class="keywordtype">float</span> *varea= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>, *v1, *v2, *v3;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     v1= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i1];
<a name="l00218"></a>00218     v2= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i2];
<a name="l00219"></a>00219     v3= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[i3];
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">/* instead of *0.5 we divided by the number of faces of the edge, it still</span>
<a name="l00222"></a>00222 <span class="comment">     * needs to be verified that this is indeed the correct thing to do! */</span>
<a name="l00223"></a>00223     t1= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v1, v2, v3)/<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4b8fce4e1d38e252e59aa2b0d966b9db">laplacian_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, i2, i3);
<a name="l00224"></a>00224     t2= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v2, v3, v1)/<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4b8fce4e1d38e252e59aa2b0d966b9db">laplacian_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, i3, i1);
<a name="l00225"></a>00225     t3= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a26815c96b658ec53696badc2099847dd">cotan_weight</a>(v3, v1, v2)/<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4b8fce4e1d38e252e59aa2b0d966b9db">laplacian_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, i1, i2);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i1, i1, (t2+t3)*varea[i1]);
<a name="l00228"></a>00228     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i2, i2, (t1+t3)*varea[i2]);
<a name="l00229"></a>00229     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i3, i3, (t1+t2)*varea[i3]);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i1, i2, -t3*varea[i1]);
<a name="l00232"></a>00232     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i2, i1, -t3*varea[i2]);
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i2, i3, -t1*varea[i2]);
<a name="l00235"></a>00235     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i3, i2, -t1*varea[i3]);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i3, i1, -t2*varea[i3]);
<a name="l00238"></a>00238     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(i1, i3, -t2*varea[i1]);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">storeweights</a>) {
<a name="l00241"></a>00241         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[f][0]= t1*varea[i1];
<a name="l00242"></a>00242         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[f][1]= t2*varea[i2];
<a name="l00243"></a>00243         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[f][2]= t3*varea[i3];
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abf26d701e853b86013a63d95a324cdb0">00247</a> <span class="keyword">static</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abf26d701e853b86013a63d95a324cdb0">laplacian_system_construct_begin</a>(<span class="keywordtype">int</span> totvert, <span class="keywordtype">int</span> totface, <span class="keywordtype">int</span> lsq)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     sys= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a>), <span class="stringliteral">&quot;LaplacianSystem&quot;</span>);
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>*)*totvert, <span class="stringliteral">&quot;LaplacianSystemVerts&quot;</span>);
<a name="l00254"></a>00254     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*totvert, <span class="stringliteral">&quot;LaplacianSystemVpinned&quot;</span>);
<a name="l00255"></a>00255     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*3*totface, <span class="stringliteral">&quot;LaplacianSystemFaces&quot;</span>);
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>= 0;
<a name="l00258"></a>00258     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>= 0;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">areaweights</a>= 1;
<a name="l00261"></a>00261     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">storeweights</a>= 0;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263     <span class="comment">/* create opennl context */</span>
<a name="l00264"></a>00264     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ab1054f9a1b1ab94be7f2c63964c0a34a">nlNewContext</a>();
<a name="l00265"></a>00265     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a478d8f98fe56b4383eeae14bf55bafaf">nlSolverParameteri</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a18fe83c4c3c6b38100da3898d8c717ed">NL_NB_VARIABLES</a>, totvert);
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (lsq)
<a name="l00267"></a>00267         <a class="code" href="../../db/dde/ONL__opennl_8h.html#a478d8f98fe56b4383eeae14bf55bafaf">nlSolverParameteri</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#ab52121ea76b6a5130531959d4213b0a5">NL_LEAST_SQUARES</a>, <a class="code" href="../../db/dde/ONL__opennl_8h.html#ab803a6e79704c5027f50a830dc341d0c">NL_TRUE</a>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a624284425d2ea58fd6f322a61fd10658">context</a>= <a class="code" href="../../db/dde/ONL__opennl_8h.html#a9fb5d3916e99001b17e71ab38646119e">nlGetCurrent</a>();
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">return</span> sys;
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#af33b650c976f963b2db960a9613da9c2">00274</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af33b650c976f963b2db960a9613da9c2">laplacian_add_vertex</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">int</span> pinned)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>]= <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00277"></a>00277     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>[sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>]= pinned;
<a name="l00278"></a>00278     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>++;
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#a7916d4f0b0545e03b658cb1133feff5a">00281</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7916d4f0b0545e03b658cb1133feff5a">laplacian_add_triangle</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> v3)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>[sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>][0]= v1;
<a name="l00284"></a>00284     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>[sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>][1]= v2;
<a name="l00285"></a>00285     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>[sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>][2]= v3;
<a name="l00286"></a>00286     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>++;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2b3b0db5b496a0d202fce1710e40134e">00289</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2b3b0db5b496a0d202fce1710e40134e">laplacian_system_construct_end</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     int (*face)[3];
<a name="l00292"></a>00292     <span class="keywordtype">int</span> a, totvert=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>, totface=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a9dce79414cea61b8e357b4dfb61ceabe">totface</a>;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#affdcec45c0ea4e75c659993318d13af8">laplacian_begin_solve</a>(sys, 0);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totvert, <span class="stringliteral">&quot;LaplacianSystemVarea&quot;</span>);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>= <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#aa74e7b101fe3c5b8acf0f169efdf0cfb">BLI_edgehash_new</a>();
<a name="l00299"></a>00299     <span class="keywordflow">for</span> (a=0, face=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>; a&lt;sys-&gt;totface; a++, face++) {
<a name="l00300"></a>00300         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abcc017d1e058ee6219021df0a9cbee0f">laplacian_increase_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, (*face)[0], (*face)[1]);
<a name="l00301"></a>00301         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abcc017d1e058ee6219021df0a9cbee0f">laplacian_increase_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, (*face)[1], (*face)[2]);
<a name="l00302"></a>00302         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abcc017d1e058ee6219021df0a9cbee0f">laplacian_increase_edge_count</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, (*face)[2], (*face)[0]);
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">areaweights</a>)
<a name="l00306"></a>00306         <span class="keywordflow">for</span> (a=0, face=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>; a&lt;sys-&gt;totface; a++, face++)
<a name="l00307"></a>00307             <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a25045969da98fec86cc8374da9dc112d">laplacian_triangle_area</a>(sys, (*face)[0], (*face)[1], (*face)[2]);
<a name="l00308"></a>00308     
<a name="l00309"></a>00309     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++) {
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">areaweights</a>) {
<a name="l00311"></a>00311             <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>[a] != 0.0f)
<a name="l00312"></a>00312                 sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>[a]= 0.5f/sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>[a];
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314         <span class="keywordflow">else</span>
<a name="l00315"></a>00315             sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>[a]= 1.0f;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <span class="comment">/* for heat weighting */</span>
<a name="l00318"></a>00318         <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>)
<a name="l00319"></a>00319             <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(a, a, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>[a]);
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">storeweights</a>)
<a name="l00323"></a>00323         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totface, <span class="stringliteral">&quot;LaplacianFWeight&quot;</span>);
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="keywordflow">for</span> (a=0, face=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>; a&lt;totface; a++, face++)
<a name="l00326"></a>00326         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad2ca0a0b1647cff71072ce8bcdaed3a0">laplacian_triangle_weights</a>(sys, a, (*face)[0], (*face)[1], (*face)[2]);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>);
<a name="l00329"></a>00329     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>) {
<a name="l00332"></a>00332         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>);
<a name="l00333"></a>00333         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <a class="code" href="../../d5/dfb/BLI__edgehash_8h.html#a14b3a8c9081b5a9c40edd7294856c45c">BLI_edgehash_free</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00337"></a>00337     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a1986ed8ebc785a6165a1c3dcb3b7d1dc">edgehash</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a16779167ca1af374ab37e28cc4e3f382">00340</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a16779167ca1af374ab37e28cc4e3f382">laplacian_system_delete</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys)
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>);
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a7ba49521f0f245034e083b43fa931817">varea</a>);
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>);
<a name="l00345"></a>00345     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>);
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     <a class="code" href="../../db/dde/ONL__opennl_8h.html#aa3cd9a372693b183d71e3a84053262d3">nlDeleteContext</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a624284425d2ea58fd6f322a61fd10658">context</a>);
<a name="l00349"></a>00349     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys);
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#affdcec45c0ea4e75c659993318d13af8">00352</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#affdcec45c0ea4e75c659993318d13af8">laplacian_begin_solve</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <span class="keywordtype">int</span> index)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <span class="keywordtype">int</span> a;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (!sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a31431ffeeb36557c159536825a73059a">nlbegun</a>) {
<a name="l00357"></a>00357         <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (index &gt;= 0) {
<a name="l00360"></a>00360             <span class="keywordflow">for</span> (a=0; a&lt;sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>; a++) {
<a name="l00361"></a>00361                 <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>[a]) {
<a name="l00362"></a>00362                     <a class="code" href="../../db/dde/ONL__opennl_8h.html#aef3296ce010ea7a5107facf759193876">nlSetVariable</a>(0, a, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[a][index]);
<a name="l00363"></a>00363                     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a8dce31ba4248794c9c0317a70c5d78ae">nlLockVariable</a>(a);
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l00369"></a>00369         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a31431ffeeb36557c159536825a73059a">nlbegun</a> = 1;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371 }
<a name="l00372"></a>00372 
<a name="l00373"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a8589d00c548666c71b474ea08dd11f40">00373</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a8589d00c548666c71b474ea08dd11f40">laplacian_add_right_hand_side</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(sys), <span class="keywordtype">int</span> v, <span class="keywordtype">float</span> value)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a7aa28383fe94304ea3cc8b86ac5b9024">nlRightHandSideAdd</a>(0, v, value);
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#a416f8661ace46f3299209d9e35c97f22">00378</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a416f8661ace46f3299209d9e35c97f22">laplacian_system_solve</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l00381"></a>00381     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l00382"></a>00382     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a31431ffeeb36557c159536825a73059a">nlbegun</a> = 0;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">//nlPrintMatrix();</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="keywordflow">return</span> <a class="code" href="../../db/dde/ONL__opennl_8h.html#afae449d3ffbd41c2fdabaf7602e6bbb9">nlSolveAdvanced</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dde/ONL__opennl_8h.html#ab803a6e79704c5027f50a830dc341d0c">NL_TRUE</a>);
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#a051f912feff9a4f28df97ef41bb25179">00389</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a051f912feff9a4f28df97ef41bb25179">laplacian_system_get_solution</a>(<span class="keywordtype">int</span> v)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     <span class="keywordflow">return</span> <a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0, v);
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">/************************* Heat Bone Weighting ******************************/</span>
<a name="l00395"></a>00395 <span class="comment">/* From &quot;Automatic Rigging and Animation of 3D Characters&quot;</span>
<a name="l00396"></a>00396 <span class="comment"> * Ilya Baran and Jovan Popovic, SIGGRAPH 2007 */</span>
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#adab4e1be14327a9397852d62804c7b76">00398</a> <span class="preprocessor">#define C_WEIGHT            1.0f</span>
<a name="l00399"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f12520bf28b3466bd8d3da46c8c46fd">00399</a> <span class="preprocessor"></span><span class="preprocessor">#define WEIGHT_LIMIT_START  0.05f</span>
<a name="l00400"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4e658a832153a40bcd0e0247049f6a30">00400</a> <span class="preprocessor"></span><span class="preprocessor">#define WEIGHT_LIMIT_END    0.025f</span>
<a name="l00401"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af3b47478b75b23d5b910d3c042a66bcb">00401</a> <span class="preprocessor"></span><span class="preprocessor">#define DISTANCE_EPSILON    1e-4f</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>
<a name="l00403"></a><a class="code" href="../../df/d1a/structBVHCallbackUserData.html">00403</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/d1a/structBVHCallbackUserData.html">BVHCallbackUserData</a> {
<a name="l00404"></a><a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">00404</a>     <span class="keywordtype">float</span> <a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>[3];
<a name="l00405"></a><a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">00405</a>     <span class="keywordtype">float</span> <a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>[3];
<a name="l00406"></a><a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">00406</a>     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>;
<a name="l00407"></a>00407 } <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4982dc85d506a9956e85a34c33f916ba">BVHCallbackUserData</a>;
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad11ae05d5e9f4012e6c25a418cecd3a7">00409</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad11ae05d5e9f4012e6c25a418cecd3a7">bvh_callback</a>(<span class="keywordtype">void</span> *userdata, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <a class="code" href="../../d5/d6e/structBVHTreeRay.html">BVHTreeRay</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ray), <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> *hit)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411     <a class="code" href="../../df/d1a/structBVHCallbackUserData.html">BVHCallbackUserData</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = (<span class="keyword">struct </span><a class="code" href="../../df/d1a/structBVHCallbackUserData.html">BVHCallbackUserData</a>*)userdata;
<a name="l00412"></a>00412     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a> + index;
<a name="l00413"></a>00413     float (*verts)[3] = data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>;
<a name="l00414"></a>00414     <span class="keywordtype">float</span> lambda, uv[2], n[3], dir[3];
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(dir, data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aad526aed8e2821b758ed612e91ce2e0b">isect_ray_tri_v3</a>(data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, dir, verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], &amp;lambda, uv)) {
<a name="l00419"></a>00419         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(n, verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]);
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (lambda &lt; 1.0f &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>) &lt; -1e-5f) {
<a name="l00421"></a>00421             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = index;
<a name="l00422"></a>00422             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> *= lambda;
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(dir, data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aad526aed8e2821b758ed612e91ce2e0b">isect_ray_tri_v3</a>(data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, dir, verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], &amp;lambda, uv)) {
<a name="l00429"></a>00429         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(n, verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]);
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (lambda &lt; 1.0f &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, data-&gt;<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>) &lt; -1e-5f) {
<a name="l00431"></a>00431             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = index;
<a name="l00432"></a>00432             hit-&gt;<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> *= lambda;
<a name="l00433"></a>00433         }
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 <span class="comment">/* Raytracing for vertex to bone/vertex visibility */</span>
<a name="l00438"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4792f6eacbea734bbe1e62d31e28fcbb">00438</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4792f6eacbea734bbe1e62d31e28fcbb">heat_ray_tree_create</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>)
<a name="l00439"></a>00439 {
<a name="l00440"></a>00440     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a>;
<a name="l00441"></a>00441     float (*verts)[3] = sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>;
<a name="l00442"></a>00442     <span class="keywordtype">int</span> totface = sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">totface</a>;
<a name="l00443"></a>00443     <span class="keywordtype">int</span> totvert = sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">totvert</a>;
<a name="l00444"></a>00444     <span class="keywordtype">int</span> a;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a> = <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a606a445825afda3db873f4b585f51f5b">BLI_bvhtree_new</a>(totface, 0.0f, 4, 6);
<a name="l00447"></a>00447     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/da0/structMFace.html">MFace</a>*)*totvert, <span class="stringliteral">&quot;HeatVFaces&quot;</span>);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="keywordflow">for</span> (a=0; a&lt;totface; a++) {
<a name="l00450"></a>00450         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = mface+a;
<a name="l00451"></a>00451         <span class="keywordtype">float</span> bb[6];
<a name="l00452"></a>00452 
<a name="l00453"></a>00453         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(bb, bb+3);
<a name="l00454"></a>00454         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>], bb, bb+3);
<a name="l00455"></a>00455         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>], bb, bb+3);
<a name="l00456"></a>00456         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>], bb, bb+3);
<a name="l00457"></a>00457         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00458"></a>00458             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(verts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>], bb, bb+3);
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a5457bfc4e6d161a7c16366a415557f06">BLI_bvhtree_insert</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a>, a, bb, 2);
<a name="l00462"></a>00462         
<a name="l00463"></a>00463         <span class="comment">//Setup inverse pointers to use on isect.orig</span>
<a name="l00464"></a>00464         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= mf;
<a name="l00465"></a>00465         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= mf;
<a name="l00466"></a>00466         sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= mf;
<a name="l00467"></a>00467         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= mf;
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a59fe8fa2e2aa5b7c170fdbb10eb979f8">BLI_bvhtree_balance</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a>); 
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae1b5ce55261e5dde01c4ed0303336b4f">00473</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae1b5ce55261e5dde01c4ed0303336b4f">heat_ray_source_visible</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>, <span class="keywordtype">int</span> <a class="code" href="../../db/d7c/structvertex.html">vertex</a>, <span class="keywordtype">int</span> source)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475     <a class="code" href="../../d7/dd9/structBVHTreeRayHit.html">BVHTreeRayHit</a> hit;
<a name="l00476"></a>00476     <a class="code" href="../../df/d1a/structBVHCallbackUserData.html">BVHCallbackUserData</a> <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00477"></a>00477     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l00478"></a>00478     <span class="keywordtype">float</span> end[3];
<a name="l00479"></a>00479     <span class="keywordtype">int</span> visible;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     mface= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>[vertex];
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (!mface)
<a name="l00483"></a>00483         <span class="keywordflow">return</span> 1;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>= <a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>;
<a name="l00486"></a>00486     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>[vertex]);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>) <span class="comment">/* bone */</span>
<a name="l00489"></a>00489         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(end, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>,
<a name="l00490"></a>00490             sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>[source], sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ac190e3778a5d46b17a224cc0e00e802f">tip</a>[source]);
<a name="l00491"></a>00491     <span class="keywordflow">else</span> <span class="comment">/* vertex */</span>
<a name="l00492"></a>00492         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(end, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a230c271d51ab17c83292469e0e031613">source</a>[source]);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, end, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>);
<a name="l00495"></a>00495     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, 1e-5);
<a name="l00496"></a>00496     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, 1.0f - 2e-5f);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">/* pass normalized vec + distance to bvh */</span>
<a name="l00499"></a>00499     hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#a4f2b11fb74f73302e32f0842c4abee1e">index</a> = -1;
<a name="l00500"></a>00500     hit.<a class="code" href="../../d7/dd9/structBVHTreeRayHit.html#aacc4e450c7e6b40afcdd2da1ef64be6a">dist</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     visible= <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a961a896017037e95a717e06943983f44">BLI_bvhtree_ray_cast</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a>, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ae35631589ec3e9f8bc9fa9fce502af6a">start</a>, data.<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#a0ec8077e586095be017eca1f4a7c4358">vec</a>, 0.0f, &amp;hit, <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad11ae05d5e9f4012e6c25a418cecd3a7">bvh_callback</a>, (<span class="keywordtype">void</span>*)&amp;data) == -1;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordflow">return</span> visible;
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a51554ddbdf272685420afcab93f8aa91">00507</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a51554ddbdf272685420afcab93f8aa91">heat_source_distance</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>, <span class="keywordtype">int</span> <a class="code" href="../../db/d7c/structvertex.html">vertex</a>, <span class="keywordtype">int</span> source)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <span class="keywordtype">float</span> closest[3], d[3], dist, cosine;
<a name="l00510"></a>00510     
<a name="l00511"></a>00511     <span class="comment">/* compute euclidian distance */</span>
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>) <span class="comment">/* bone */</span>
<a name="l00513"></a>00513         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(closest, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>[vertex],
<a name="l00514"></a>00514             sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>[source], sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ac190e3778a5d46b17a224cc0e00e802f">tip</a>[source]);
<a name="l00515"></a>00515     <span class="keywordflow">else</span> <span class="comment">/* vertex */</span>
<a name="l00516"></a>00516         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(closest, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a230c271d51ab17c83292469e0e031613">source</a>[source]);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>[vertex], closest);
<a name="l00519"></a>00519     dist= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(d);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="comment">/* if the vertex normal does not point along the bone, increase distance */</span>
<a name="l00522"></a>00522     cosine= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>[vertex]);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="keywordflow">return</span> dist/(0.5f*(cosine + 1.001f));
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9b80361c6824bd1855e2d932706e388d">00527</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9b80361c6824bd1855e2d932706e388d">heat_source_closest</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>, <span class="keywordtype">int</span> <a class="code" href="../../db/d7c/structvertex.html">vertex</a>, <span class="keywordtype">int</span> source)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <span class="keywordtype">float</span> dist;
<a name="l00530"></a>00530 
<a name="l00531"></a>00531     dist= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a51554ddbdf272685420afcab93f8aa91">heat_source_distance</a>(sys, vertex, source);
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (dist &lt;= sys-&gt;heat.mindist[vertex]*(1.0f + <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af3b47478b75b23d5b910d3c042a66bcb">DISTANCE_EPSILON</a>))
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae1b5ce55261e5dde01c4ed0303336b4f">heat_ray_source_visible</a>(sys, vertex, source))
<a name="l00535"></a>00535             <span class="keywordflow">return</span> 1;
<a name="l00536"></a>00536         
<a name="l00537"></a>00537     <span class="keywordflow">return</span> 0;
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a33680f56c09d1a11f7358b4468e23514">00540</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a33680f56c09d1a11f7358b4468e23514">heat_set_H</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>, <span class="keywordtype">int</span> <a class="code" href="../../db/d7c/structvertex.html">vertex</a>)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="keywordtype">float</span> dist, mindist, h;
<a name="l00543"></a>00543     <span class="keywordtype">int</span> j, numclosest = 0;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     mindist= 1e10;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">/* compute minimum distance */</span>
<a name="l00548"></a>00548     <span class="keywordflow">for</span> (j=0; j&lt;sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">numsource</a>; j++) {
<a name="l00549"></a>00549         dist= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a51554ddbdf272685420afcab93f8aa91">heat_source_distance</a>(sys, vertex, j);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (dist &lt; mindist)
<a name="l00552"></a>00552             mindist= dist;
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1142901333cc328652a0190bbbe81389">mindist</a>[vertex]= mindist;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557     <span class="comment">/* count number of sources with approximately this minimum distance */</span>
<a name="l00558"></a>00558     <span class="keywordflow">for</span> (j=0; j&lt;sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">numsource</a>; j++)
<a name="l00559"></a>00559         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9b80361c6824bd1855e2d932706e388d">heat_source_closest</a>(sys, vertex, j))
<a name="l00560"></a>00560             numclosest++;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>[vertex]= (numclosest &gt; 0)? 1.0f/numclosest: 0.0f;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     <span class="comment">/* compute H entry */</span>
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (numclosest &gt; 0) {
<a name="l00566"></a>00566         mindist= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(mindist, 1e-4f);
<a name="l00567"></a>00567         h= numclosest*<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#adab4e1be14327a9397852d62804c7b76">C_WEIGHT</a>/(mindist*mindist);
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <span class="keywordflow">else</span>
<a name="l00570"></a>00570         h= 0.0f;
<a name="l00571"></a>00571     
<a name="l00572"></a>00572     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>[vertex]= h;
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aaf0d0500ea46c0de92ed207db05d5677">00575</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aaf0d0500ea46c0de92ed207db05d5677">heat_calc_vnormals</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>)
<a name="l00576"></a>00576 {
<a name="l00577"></a>00577     <span class="keywordtype">float</span> fnor[3];
<a name="l00578"></a>00578     <span class="keywordtype">int</span> a, v1, v2, v3, (*face)[3];
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>, <span class="stringliteral">&quot;HeatVNors&quot;</span>);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">for</span> (a=0, face=sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a267db7a789ace0e6bf2ecfd2a44ff561">faces</a>; a&lt;sys-&gt;totface; a++, face++) {
<a name="l00583"></a>00583         v1= (*face)[0];
<a name="l00584"></a>00584         v2= (*face)[1];
<a name="l00585"></a>00585         v3= (*face)[2];
<a name="l00586"></a>00586 
<a name="l00587"></a>00587         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( fnor,sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[v1], sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[v2], sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a867d04db20afe94fc987e3a80242e66e">verts</a>[v3]);
<a name="l00588"></a>00588         
<a name="l00589"></a>00589         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>[v1], fnor);
<a name="l00590"></a>00590         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>[v2], fnor);
<a name="l00591"></a>00591         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>[v3], fnor);
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     <span class="keywordflow">for</span> (a=0; a&lt;sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>; a++)
<a name="l00595"></a>00595         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>[a]);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab24782a44e167985c6018fcca5118a1b">00598</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab24782a44e167985c6018fcca5118a1b">heat_laplacian_create</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>)
<a name="l00599"></a>00599 {
<a name="l00600"></a>00600     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a>, *mf;
<a name="l00601"></a>00601     <span class="keywordtype">int</span> totface= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">totface</a>;
<a name="l00602"></a>00602     <span class="keywordtype">int</span> totvert= sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">totvert</a>;
<a name="l00603"></a>00603     <span class="keywordtype">int</span> a;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">/* heat specific definitions */</span>
<a name="l00606"></a>00606     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1142901333cc328652a0190bbbe81389">mindist</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totvert, <span class="stringliteral">&quot;HeatMinDist&quot;</span>);
<a name="l00607"></a>00607     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totvert, <span class="stringliteral">&quot;HeatH&quot;</span>);
<a name="l00608"></a>00608     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totvert, <span class="stringliteral">&quot;HeatP&quot;</span>);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="comment">/* add verts and faces to laplacian */</span>
<a name="l00611"></a>00611     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++)
<a name="l00612"></a>00612         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af33b650c976f963b2db960a9613da9c2">laplacian_add_vertex</a>(sys, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>[a], 0);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordflow">for</span> (a=0, mf=mface; a&lt;totface; a++, mf++) {
<a name="l00615"></a>00615         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7916d4f0b0545e03b658cb1133feff5a">laplacian_add_triangle</a>(sys, mf-&gt;v1, mf-&gt;v2, mf-&gt;v3);
<a name="l00616"></a>00616         <span class="keywordflow">if</span> (mf-&gt;v4)
<a name="l00617"></a>00617             <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7916d4f0b0545e03b658cb1133feff5a">laplacian_add_triangle</a>(sys, mf-&gt;v1, mf-&gt;v3, mf-&gt;v4);
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="comment">/* for distance computation in set_H */</span>
<a name="l00621"></a>00621     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aaf0d0500ea46c0de92ed207db05d5677">heat_calc_vnormals</a>(sys);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++)
<a name="l00624"></a>00624         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a33680f56c09d1a11f7358b4468e23514">heat_set_H</a>(sys, a);
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad8ca0bcfa145f518602a470396cc1093">00627</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad8ca0bcfa145f518602a470396cc1093">heat_system_free</a>(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a7f17e6306b5a1a4025ea0775631461de">BLI_bvhtree_free</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a95d1fae7c1030d5209011c3d2a8ed066">bvhtree</a>);
<a name="l00630"></a>00630     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1c3a2a4f8453388619636270f920aa5c">vface</a>);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a1142901333cc328652a0190bbbe81389">mindist</a>);
<a name="l00633"></a>00633     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>);
<a name="l00634"></a>00634     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>);
<a name="l00635"></a>00635     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a290d62befab29035f27dc458a39ad2e9">vnors</a>);
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00638"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">00638</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(<span class="keywordtype">float</span> weight)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640     <span class="keywordtype">float</span> t;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">if</span> (weight &lt; <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4e658a832153a40bcd0e0247049f6a30">WEIGHT_LIMIT_END</a>) {
<a name="l00643"></a>00643         <span class="keywordflow">return</span> 0.0f;
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight &lt; <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f12520bf28b3466bd8d3da46c8c46fd">WEIGHT_LIMIT_START</a>) {
<a name="l00646"></a>00646         t= (weight - <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4e658a832153a40bcd0e0247049f6a30">WEIGHT_LIMIT_END</a>)/(<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f12520bf28b3466bd8d3da46c8c46fd">WEIGHT_LIMIT_START</a> - <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4e658a832153a40bcd0e0247049f6a30">WEIGHT_LIMIT_END</a>);
<a name="l00647"></a>00647         <span class="keywordflow">return</span> t*<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f12520bf28b3466bd8d3da46c8c46fd">WEIGHT_LIMIT_START</a>;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649     <span class="keywordflow">else</span>
<a name="l00650"></a>00650         <span class="keywordflow">return</span> weight;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="../../d0/de3/meshlaplacian_8h.html#a68a4584eac6e16956212da24b3c2f79b">00653</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#adcb1d4df2f116a2b0b11fc4bba730fe6">heat_bone_weighting</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">float</span> (*verts)[3], <span class="keywordtype">int</span> numsource, <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> **dgrouplist, <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> **dgroupflip, <span class="keywordtype">float</span> (*root)[3], <span class="keywordtype">float</span> (*tip)[3], <span class="keywordtype">int</span> *selected, <span class="keyword">const</span> <span class="keywordtype">char</span> **err_str)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>;
<a name="l00656"></a>00656     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp;
<a name="l00657"></a>00657     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml;
<a name="l00658"></a>00658     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l00659"></a>00659     <span class="keywordtype">float</span> solution, weight;
<a name="l00660"></a>00660     <span class="keywordtype">int</span> *vertsflipped = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *mask= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00661"></a>00661     <span class="keywordtype">int</span> a, tottri, j, bbone, firstsegment, lastsegment;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l00664"></a>00664     <span class="keywordtype">int</span> use_vert_sel= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00665"></a>00665     <span class="keywordtype">int</span> use_face_sel= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     *err_str= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="comment">/* count triangles and create mask */</span>
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (     (use_face_sel= (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) != 0) ||
<a name="l00671"></a>00671             (use_vert_sel= ((me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#af66396a073d4e81b048ffe20d23fc612">ME_EDIT_VERT_SEL</a>) != 0)))
<a name="l00672"></a>00672     {
<a name="l00673"></a>00673         mask= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;heat_bone_weighting mask&quot;</span>);
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">for</span> (a = 0, mp=me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>; a &lt; me-&gt;totpoly; mp++, a++) {
<a name="l00677"></a>00677         <span class="comment">/*  (added selectedVerts content for vertex mask, they used to just equal 1) */</span>
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (use_vert_sel) {
<a name="l00679"></a>00679             <span class="keywordflow">for</span> (j = 0, ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>; j &lt; mp-&gt;totloop; j++, ml++) {
<a name="l00680"></a>00680                 <span class="keywordflow">if</span> (use_vert_sel) {
<a name="l00681"></a>00681                     mask[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>] = (mvert[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) != 0;
<a name="l00682"></a>00682                 }
<a name="l00683"></a>00683             }
<a name="l00684"></a>00684         }
<a name="l00685"></a>00685         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (use_face_sel) {
<a name="l00686"></a>00686             <span class="keywordflow">if</span> (mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a208492a1db60c4d108f51334e5e80d53">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>) {
<a name="l00687"></a>00687                 <span class="keywordflow">for</span> (j = 0, ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>; j &lt; mp-&gt;totloop; j++, ml++) {
<a name="l00688"></a>00688                     mask[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>] = 1;
<a name="l00689"></a>00689                 }
<a name="l00690"></a>00690             }
<a name="l00691"></a>00691         }
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="comment">/* bone heat needs triangulated faces */</span>
<a name="l00695"></a>00695     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a4c1101fb270465f1f47252ded570f6fb">BKE_mesh_tessface_ensure</a>(me);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="keywordflow">for</span> (tottri = 0, a = 0, mf = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>; a &lt; me-&gt;totface; mf++, a++) {
<a name="l00698"></a>00698         tottri++;
<a name="l00699"></a>00699         <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) tottri++;
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="comment">/* create laplacian */</span>
<a name="l00703"></a>00703     sys = <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abf26d701e853b86013a63d95a324cdb0">laplacian_system_construct_begin</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, tottri, 1);
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a>= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l00706"></a>00706     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">totface</a>= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>;
<a name="l00707"></a>00707     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">totvert</a>= me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00708"></a>00708     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>= verts;
<a name="l00709"></a>00709     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a40aaa30799236191a782fda7719f4c67">root</a>= root;
<a name="l00710"></a>00710     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ac190e3778a5d46b17a224cc0e00e802f">tip</a>= tip;
<a name="l00711"></a>00711     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">numsource</a>= numsource;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4792f6eacbea734bbe1e62d31e28fcbb">heat_ray_tree_create</a>(sys);
<a name="l00714"></a>00714     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab24782a44e167985c6018fcca5118a1b">heat_laplacian_create</a>(sys);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2b3b0db5b496a0d202fce1710e40134e">laplacian_system_construct_end</a>(sys);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (dgroupflip) {
<a name="l00719"></a>00719         vertsflipped = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;vertsflipped&quot;</span>);
<a name="l00720"></a>00720         <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++)
<a name="l00721"></a>00721             vertsflipped[a] = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(ob, a);
<a name="l00722"></a>00722     }
<a name="l00723"></a>00723     
<a name="l00724"></a>00724     <span class="comment">/* compute weights per bone */</span>
<a name="l00725"></a>00725     <span class="keywordflow">for</span> (j=0; j&lt;numsource; j++) {
<a name="l00726"></a>00726         <span class="keywordflow">if</span> (!selected[j])
<a name="l00727"></a>00727             <span class="keywordflow">continue</span>;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         firstsegment= (j == 0 || dgrouplist[j-1] != dgrouplist[j]);
<a name="l00730"></a>00730         lastsegment= (j == numsource-1 || dgrouplist[j] != dgrouplist[j+1]);
<a name="l00731"></a>00731         bbone= !(firstsegment &amp;&amp; lastsegment);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <span class="comment">/* clear weights */</span>
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (bbone &amp;&amp; firstsegment) {
<a name="l00735"></a>00735             <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++) {
<a name="l00736"></a>00736                 <span class="keywordflow">if</span> (mask &amp;&amp; !mask[a])
<a name="l00737"></a>00737                     <span class="keywordflow">continue</span>;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739                 <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgrouplist[j], a);
<a name="l00740"></a>00740                 <span class="keywordflow">if</span> (vertsflipped &amp;&amp; dgroupflip[j] &amp;&amp; vertsflipped[a] &gt;= 0)
<a name="l00741"></a>00741                     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgroupflip[j], vertsflipped[a]);
<a name="l00742"></a>00742             }
<a name="l00743"></a>00743         }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         <span class="comment">/* fill right hand side */</span>
<a name="l00746"></a>00746         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#affdcec45c0ea4e75c659993318d13af8">laplacian_begin_solve</a>(sys, -1);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++)
<a name="l00749"></a>00749             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9b80361c6824bd1855e2d932706e388d">heat_source_closest</a>(sys, a, j))
<a name="l00750"></a>00750                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a8589d00c548666c71b474ea08dd11f40">laplacian_add_right_hand_side</a>(sys, a,
<a name="l00751"></a>00751                     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>[a]*sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>[a]);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="comment">/* solve */</span>
<a name="l00754"></a>00754         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a416f8661ace46f3299209d9e35c97f22">laplacian_system_solve</a>(sys)) {
<a name="l00755"></a>00755             <span class="comment">/* load solution into vertex groups */</span>
<a name="l00756"></a>00756             <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++) {
<a name="l00757"></a>00757                 <span class="keywordflow">if</span> (mask &amp;&amp; !mask[a])
<a name="l00758"></a>00758                     <span class="keywordflow">continue</span>;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760                 solution= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a051f912feff9a4f28df97ef41bb25179">laplacian_system_get_solution</a>(a);
<a name="l00761"></a>00761                 
<a name="l00762"></a>00762                 <span class="keywordflow">if</span> (bbone) {
<a name="l00763"></a>00763                     <span class="keywordflow">if</span> (solution &gt; 0.0f)
<a name="l00764"></a>00764                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a>(ob, dgrouplist[j], a, solution,
<a name="l00765"></a>00765                             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aab3d17cfab2e005aea56e05bb3d59bcf">WEIGHT_ADD</a>);
<a name="l00766"></a>00766                 }
<a name="l00767"></a>00767                 <span class="keywordflow">else</span> {
<a name="l00768"></a>00768                     weight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(solution);
<a name="l00769"></a>00769                     <span class="keywordflow">if</span> (weight &gt; 0.0f)
<a name="l00770"></a>00770                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a>(ob, dgrouplist[j], a, weight,
<a name="l00771"></a>00771                             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a5728db514cd0fa3c032a5df057111454">WEIGHT_REPLACE</a>);
<a name="l00772"></a>00772                     <span class="keywordflow">else</span>
<a name="l00773"></a>00773                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgrouplist[j], a);
<a name="l00774"></a>00774                 }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776                 <span class="comment">/* do same for mirror */</span>
<a name="l00777"></a>00777                 <span class="keywordflow">if</span> (vertsflipped &amp;&amp; dgroupflip[j] &amp;&amp; vertsflipped[a] &gt;= 0) {
<a name="l00778"></a>00778                     <span class="keywordflow">if</span> (bbone) {
<a name="l00779"></a>00779                         <span class="keywordflow">if</span> (solution &gt; 0.0f)
<a name="l00780"></a>00780                             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a>(ob, dgroupflip[j], vertsflipped[a],
<a name="l00781"></a>00781                                 solution, <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aab3d17cfab2e005aea56e05bb3d59bcf">WEIGHT_ADD</a>);
<a name="l00782"></a>00782                     }
<a name="l00783"></a>00783                     <span class="keywordflow">else</span> {
<a name="l00784"></a>00784                         weight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(solution);
<a name="l00785"></a>00785                         <span class="keywordflow">if</span> (weight &gt; 0.0f)
<a name="l00786"></a>00786                             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a1d4a1aa44b097c9ef95d3af01cb0b651">ED_vgroup_vert_add</a>(ob, dgroupflip[j], vertsflipped[a],
<a name="l00787"></a>00787                                 weight, <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a5728db514cd0fa3c032a5df057111454">WEIGHT_REPLACE</a>);
<a name="l00788"></a>00788                         <span class="keywordflow">else</span>
<a name="l00789"></a>00789                             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgroupflip[j], vertsflipped[a]);
<a name="l00790"></a>00790                     }
<a name="l00791"></a>00791                 }
<a name="l00792"></a>00792             }
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*err_str == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00795"></a>00795             *err_str= <span class="stringliteral">&quot;Bone Heat Weighting: failed to find solution for one or more bones&quot;</span>;
<a name="l00796"></a>00796             <span class="keywordflow">break</span>;
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         <span class="comment">/* remove too small vertex weights */</span>
<a name="l00800"></a>00800         <span class="keywordflow">if</span> (bbone &amp;&amp; lastsegment) {
<a name="l00801"></a>00801             <span class="keywordflow">for</span> (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++) {
<a name="l00802"></a>00802                 <span class="keywordflow">if</span> (mask &amp;&amp; !mask[a])
<a name="l00803"></a>00803                     <span class="keywordflow">continue</span>;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805                 weight= <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a9c079eae1403932794b424cff188cd4d">ED_vgroup_vert_weight</a>(ob, dgrouplist[j], a);
<a name="l00806"></a>00806                 weight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(weight);
<a name="l00807"></a>00807                 <span class="keywordflow">if</span> (weight &lt;= 0.0f)
<a name="l00808"></a>00808                     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgrouplist[j], a);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810                 <span class="keywordflow">if</span> (vertsflipped &amp;&amp; dgroupflip[j] &amp;&amp; vertsflipped[a] &gt;= 0) {
<a name="l00811"></a>00811                     weight= <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a9c079eae1403932794b424cff188cd4d">ED_vgroup_vert_weight</a>(ob, dgroupflip[j], vertsflipped[a]);
<a name="l00812"></a>00812                     weight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(weight);
<a name="l00813"></a>00813                     <span class="keywordflow">if</span> (weight &lt;= 0.0f)
<a name="l00814"></a>00814                         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac6c65803672e2577e66ad55184b270e9">ED_vgroup_vert_remove</a>(ob, dgroupflip[j], vertsflipped[a]);
<a name="l00815"></a>00815                 }
<a name="l00816"></a>00816             }
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="comment">/* free */</span>
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (vertsflipped) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vertsflipped);
<a name="l00822"></a>00822     <span class="keywordflow">if</span> (mask) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mask);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad8ca0bcfa145f518602a470396cc1093">heat_system_free</a>(sys);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a16779167ca1af374ab37e28cc4e3f382">laplacian_system_delete</a>(sys);
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 <span class="preprocessor">#ifdef RIGID_DEFORM</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span><span class="comment">/********************** As-Rigid-As-Possible Deformation ******************/</span>
<a name="l00831"></a>00831 <span class="comment">/* From &quot;As-Rigid-As-Possible Surface Modeling&quot;,</span>
<a name="l00832"></a>00832 <span class="comment"> * Olga Sorkine and Marc Alexa, ESGP 2007. */</span>
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 <span class="comment">/* investigate:</span>
<a name="l00835"></a>00835 <span class="comment"> * - transpose R in orthogonal</span>
<a name="l00836"></a>00836 <span class="comment"> * - flipped normals and per face adding</span>
<a name="l00837"></a>00837 <span class="comment"> * - move canceling to transform, make origco pointer</span>
<a name="l00838"></a>00838 <span class="comment"> */</span>
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="keyword">static</span> <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *RigidDeformSystem = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_add_half_edge_to_R(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v1, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v2, <span class="keywordtype">float</span> w)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844     <span class="keywordtype">float</span> e[3], e_[3];
<a name="l00845"></a>00845     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e, sys-&gt;rigid.origco[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>], sys-&gt;rigid.origco[v2-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>]);
<a name="l00848"></a>00848     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e_, v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>, v2-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="comment">/* formula (5) */</span>
<a name="l00851"></a>00851     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l00852"></a>00852         sys-&gt;rigid.R[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] += w*e[0]*e_[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00853"></a>00853         sys-&gt;rigid.R[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] += w*e[1]*e_[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00854"></a>00854         sys-&gt;rigid.R[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>][<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] += w*e[2]*e_[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_add_edge_to_R(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v1, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v2, <span class="keywordtype">float</span> w)
<a name="l00859"></a>00859 {
<a name="l00860"></a>00860     rigid_add_half_edge_to_R(sys, v1, v2, w);
<a name="l00861"></a>00861     rigid_add_half_edge_to_R(sys, v2, v1, w);
<a name="l00862"></a>00862 }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_orthogonalize_R(<span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>[][3])
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866     HMatrix <a class="code" href="../../d3/d41/mathutils__noise_8c.html#a52037c938e3c1b126c6277da5ca689d0">M</a>, Q, S;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8efd369830530951efa924af73e43616">copy_m4_m3</a>(M, R);
<a name="l00869"></a>00869     polar_decomp(M, Q, S);
<a name="l00870"></a>00870     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(R, Q);
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_add_half_edge_to_rhs(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v1, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v2, <span class="keywordtype">float</span> w)
<a name="l00874"></a>00874 {
<a name="l00875"></a>00875     <span class="comment">/* formula (8) */</span>
<a name="l00876"></a>00876     <span class="keywordtype">float</span> Rsum[3][3], rhs[3];
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     <span class="keywordflow">if</span> (sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>])
<a name="l00879"></a>00879         <span class="keywordflow">return</span>;
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac90ef87bc55924ddc815b4b604fd645b">add_m3_m3m3</a>(Rsum, sys-&gt;rigid.R[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>], sys-&gt;rigid.R[v2-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>]);
<a name="l00882"></a>00882     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(Rsum);
<a name="l00883"></a>00883 
<a name="l00884"></a>00884     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(rhs, sys-&gt;rigid.origco[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>], sys-&gt;rigid.origco[v2-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>]);
<a name="l00885"></a>00885     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(Rsum, rhs);
<a name="l00886"></a>00886     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(rhs, 0.5f);
<a name="l00887"></a>00887     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(rhs, w);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(sys-&gt;rigid.rhs[v1-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>], rhs);
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_add_edge_to_rhs(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v1, <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *v2, <span class="keywordtype">float</span> w)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894     rigid_add_half_edge_to_rhs(sys, v1, v2, w);
<a name="l00895"></a>00895     rigid_add_half_edge_to_rhs(sys, v2, v1, w);
<a name="l00896"></a>00896 }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898 <span class="keywordtype">void</span> rigid_deform_iteration()
<a name="l00899"></a>00899 {
<a name="l00900"></a>00900     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys= RigidDeformSystem;
<a name="l00901"></a>00901     <a class="code" href="../../d4/d5c/structEditMesh.html">EditMesh</a> *em;
<a name="l00902"></a>00902     <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *eve;
<a name="l00903"></a>00903     <a class="code" href="../../df/de3/structEditFace.html">EditFace</a> *efa;
<a name="l00904"></a>00904     <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00905"></a>00905 
<a name="l00906"></a>00906     <span class="keywordflow">if</span> (!sys)
<a name="l00907"></a>00907         <span class="keywordflow">return</span>;
<a name="l00908"></a>00908     
<a name="l00909"></a>00909     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a81804eba1305d922f867fcb2b8c337cd">nlMakeCurrent</a>(sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a624284425d2ea58fd6f322a61fd10658">context</a>);
<a name="l00910"></a>00910     em= sys-&gt;rigid.mesh;
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <span class="comment">/* compute R */</span>
<a name="l00913"></a>00913     memset(sys-&gt;rigid.R, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*3*sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>);
<a name="l00914"></a>00914     memset(sys-&gt;rigid.rhs, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>);
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     <span class="keywordflow">for</span> (a=0, efa=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#a042e30bdf43bd7ce153daeb1c45a1007">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; efa; efa=efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#ad758c9e4d1099701b3a011edb045eff2">next</a>, a++) {
<a name="l00917"></a>00917         rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a19439c713d04457bf6fa775e7db7e76f">v2</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][2]);
<a name="l00918"></a>00918         rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a19439c713d04457bf6fa775e7db7e76f">v2</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][0]);
<a name="l00919"></a>00919         rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][1]);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921         <span class="keywordflow">if</span> (efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>) {
<a name="l00922"></a>00922             a++;
<a name="l00923"></a>00923             rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][2]);
<a name="l00924"></a>00924             rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][0]);
<a name="l00925"></a>00925             rigid_add_edge_to_R(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][1]);
<a name="l00926"></a>00926         }
<a name="l00927"></a>00927     }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929     <span class="keywordflow">for</span> (a=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>, a++) {
<a name="l00930"></a>00930         rigid_orthogonalize_R(sys-&gt;rigid.R[a]);
<a name="l00931"></a>00931         eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>= a;
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     
<a name="l00934"></a>00934     <span class="comment">/* compute right hand sides for solving */</span>
<a name="l00935"></a>00935     <span class="keywordflow">for</span> (a=0, efa=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#a042e30bdf43bd7ce153daeb1c45a1007">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; efa; efa=efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#ad758c9e4d1099701b3a011edb045eff2">next</a>, a++) {
<a name="l00936"></a>00936         rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a19439c713d04457bf6fa775e7db7e76f">v2</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][2]);
<a name="l00937"></a>00937         rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a19439c713d04457bf6fa775e7db7e76f">v2</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][0]);
<a name="l00938"></a>00938         rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][1]);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940         <span class="keywordflow">if</span> (efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>) {
<a name="l00941"></a>00941             a++;
<a name="l00942"></a>00942             rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][2]);
<a name="l00943"></a>00943             rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][0]);
<a name="l00944"></a>00944             rigid_add_edge_to_rhs(sys, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>, sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f2b7743485d8768ff569d87a2a6856a">fweights</a>[a][1]);
<a name="l00945"></a>00945         }
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="comment">/* solve for positions, for X,Y and Z separately */</span>
<a name="l00949"></a>00949     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l00950"></a>00950         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#affdcec45c0ea4e75c659993318d13af8">laplacian_begin_solve</a>(sys, i);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952         <span class="keywordflow">for</span> (a=0; a&lt;sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>; a++)
<a name="l00953"></a>00953             <span class="keywordflow">if</span> (!sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a3f1935ad017a1671676652805274c1cb">vpinned</a>[a])
<a name="l00954"></a>00954                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a8589d00c548666c71b474ea08dd11f40">laplacian_add_right_hand_side</a>(sys, a, sys-&gt;rigid.rhs[a][i]);
<a name="l00955"></a>00955 
<a name="l00956"></a>00956         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a416f8661ace46f3299209d9e35c97f22">laplacian_system_solve</a>(sys)) {
<a name="l00957"></a>00957             <span class="keywordflow">for</span> (a=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>, a++)
<a name="l00958"></a>00958                 eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a051f912feff9a4f28df97ef41bb25179">laplacian_system_get_solution</a>(a);
<a name="l00959"></a>00959         }
<a name="l00960"></a>00960         <span class="keywordflow">else</span> {
<a name="l00961"></a>00961             <span class="keywordflow">if</span> (!sys-&gt;rigid.thrownerror) {
<a name="l00962"></a>00962                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a94ab435a74040b5a63317747695e98cb">error</a>(<span class="stringliteral">&quot;RigidDeform: failed to find solution&quot;</span>);
<a name="l00963"></a>00963                 sys-&gt;rigid.thrownerror= 1;
<a name="l00964"></a>00964             }
<a name="l00965"></a>00965             <span class="keywordflow">break</span>;
<a name="l00966"></a>00966         }
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a>00970 <span class="keyword">static</span> <span class="keywordtype">void</span> rigid_laplacian_create(<a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972     <a class="code" href="../../d4/d5c/structEditMesh.html">EditMesh</a> *em = sys-&gt;rigid.mesh;
<a name="l00973"></a>00973     <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *eve;
<a name="l00974"></a>00974     <a class="code" href="../../df/de3/structEditFace.html">EditFace</a> *efa;
<a name="l00975"></a>00975     <span class="keywordtype">int</span> a;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="comment">/* add verts and faces to laplacian */</span>
<a name="l00978"></a>00978     <span class="keywordflow">for</span> (a=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>, a++) {
<a name="l00979"></a>00979         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af33b650c976f963b2db960a9613da9c2">laplacian_add_vertex</a>(sys, eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>, eve-&gt;pinned);
<a name="l00980"></a>00980         eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>= a;
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="keywordflow">for</span> (efa=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#a042e30bdf43bd7ce153daeb1c45a1007">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; efa; efa=efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#ad758c9e4d1099701b3a011edb045eff2">next</a>) {
<a name="l00984"></a>00984         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7916d4f0b0545e03b658cb1133feff5a">laplacian_add_triangle</a>(sys,
<a name="l00985"></a>00985             efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a19439c713d04457bf6fa775e7db7e76f">v2</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>);
<a name="l00986"></a>00986         <span class="keywordflow">if</span> (efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>)
<a name="l00987"></a>00987             <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7916d4f0b0545e03b658cb1133feff5a">laplacian_add_triangle</a>(sys,
<a name="l00988"></a>00988                 efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a526da9c225d6f109b01ae72c3e2e91cc">v1</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#aa3c2c222301f7406b4a1fd217384fc4d">v3</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>, efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a37ac7351e26996af0b0caf6e1e90a5ec">tmp</a>.<a class="code" href="../../d8/d13/structEditVert.html#a853d08c83281f275324d759646b14c9d">l</a>);
<a name="l00989"></a>00989     }
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keywordtype">void</span> rigid_deform_begin(<a class="code" href="../../d4/d5c/structEditMesh.html">EditMesh</a> *em)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *<a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>;
<a name="l00995"></a>00995     <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *eve;
<a name="l00996"></a>00996     <a class="code" href="../../df/de3/structEditFace.html">EditFace</a> *efa;
<a name="l00997"></a>00997     <span class="keywordtype">int</span> a, totvert, totface;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <span class="comment">/* count vertices, triangles */</span>
<a name="l01000"></a>01000     <span class="keywordflow">for</span> (totvert=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>)
<a name="l01001"></a>01001         totvert++;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="keywordflow">for</span> (totface=0, efa=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#a042e30bdf43bd7ce153daeb1c45a1007">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; efa; efa=efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#ad758c9e4d1099701b3a011edb045eff2">next</a>) {
<a name="l01004"></a>01004         totface++;
<a name="l01005"></a>01005         <span class="keywordflow">if</span> (efa-&gt;<a class="code" href="../../df/de3/structEditFace.html#a4b99fd32458e6d8bfb3916b3f86ae80a">v4</a>) totface++;
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="comment">/* create laplacian */</span>
<a name="l01009"></a>01009     sys = <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abf26d701e853b86013a63d95a324cdb0">laplacian_system_construct_begin</a>(totvert, totface, 0);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     sys-&gt;rigid.mesh= em;
<a name="l01012"></a>01012     sys-&gt;rigid.R = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*3*totvert, <span class="stringliteral">&quot;RigidDeformR&quot;</span>);
<a name="l01013"></a>01013     sys-&gt;rigid.rhs = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert, <span class="stringliteral">&quot;RigidDeformRHS&quot;</span>);
<a name="l01014"></a>01014     sys-&gt;rigid.origco = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert, <span class="stringliteral">&quot;RigidDeformCo&quot;</span>);
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="keywordflow">for</span> (a=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>, a++)
<a name="l01017"></a>01017         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sys-&gt;rigid.origco[a], eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a0f06c9e219385beb333f09c4defb6f3f">areaweights</a>= 0;
<a name="l01020"></a>01020     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a70acb57927a2618ec676b77681015055">storeweights</a>= 1;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022     rigid_laplacian_create(sys);
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2b3b0db5b496a0d202fce1710e40134e">laplacian_system_construct_end</a>(sys);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     RigidDeformSystem = <a class="code" href="../../df/d1a/structBVHCallbackUserData.html#ab94f4eb20667d5e363df190834657e09">sys</a>;
<a name="l01027"></a>01027 }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029 <span class="keywordtype">void</span> rigid_deform_end(<span class="keywordtype">int</span> cancel)
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys = RigidDeformSystem;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="keywordflow">if</span> (sys) {
<a name="l01034"></a>01034         <a class="code" href="../../d4/d5c/structEditMesh.html">EditMesh</a> *em = sys-&gt;rigid.mesh;
<a name="l01035"></a>01035         <a class="code" href="../../d8/d13/structEditVert.html">EditVert</a> *eve;
<a name="l01036"></a>01036         <span class="keywordtype">int</span> a;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (cancel)
<a name="l01039"></a>01039             <span class="keywordflow">for</span> (a=0, eve=em-&gt;<a class="code" href="../../d4/d5c/structEditMesh.html#aa30e66f27b47d5c37ed6f4697f189774">verts</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; eve; eve=eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#afdadc729f688f0ebbbb1651ecd991977">next</a>, a++)
<a name="l01040"></a>01040                 <span class="keywordflow">if</span> (!eve-&gt;pinned)
<a name="l01041"></a>01041                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(eve-&gt;<a class="code" href="../../d8/d13/structEditVert.html#a9ebc7ea51cbffb0f8872473ca9c85a55">co</a>, sys-&gt;rigid.origco[a]);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043         <span class="keywordflow">if</span> (sys-&gt;rigid.R) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;rigid.R);
<a name="l01044"></a>01044         <span class="keywordflow">if</span> (sys-&gt;rigid.rhs) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;rigid.rhs);
<a name="l01045"></a>01045         <span class="keywordflow">if</span> (sys-&gt;rigid.origco) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sys-&gt;rigid.origco);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         <span class="comment">/* free */</span>
<a name="l01048"></a>01048         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a16779167ca1af374ab37e28cc4e3f382">laplacian_system_delete</a>(sys);
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     RigidDeformSystem = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 <span class="preprocessor">#endif</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>
<a name="l01055"></a>01055 <span class="comment">/************************** Harmonic Coordinates ****************************/</span>
<a name="l01056"></a>01056 <span class="comment">/* From &quot;Harmonic Coordinates for Character Articulation&quot;,</span>
<a name="l01057"></a>01057 <span class="comment"> * Pushkar Joshi, Mark Meyer, Tony DeRose, Brian Green and Tom Sanocki,</span>
<a name="l01058"></a>01058 <span class="comment"> * SIGGRAPH 2007. */</span>
<a name="l01059"></a>01059 
<a name="l01060"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a002b2f4894492820fe708b1b7e7c5e70">01060</a> <span class="preprocessor">#define EPSILON 0.0001f</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span>
<a name="l01062"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abea462ffbeacfca837ec84b1fae0a8ab">01062</a> <span class="preprocessor">#define MESHDEFORM_TAG_UNTYPED  0</span>
<a name="l01063"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac20d10bb62cfee2b7994d5e5ea5dad01">01063</a> <span class="preprocessor"></span><span class="preprocessor">#define MESHDEFORM_TAG_BOUNDARY 1</span>
<a name="l01064"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#acd613db188960ce6efc7a51dec41e5a5">01064</a> <span class="preprocessor"></span><span class="preprocessor">#define MESHDEFORM_TAG_INTERIOR 2</span>
<a name="l01065"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">01065</a> <span class="preprocessor"></span><span class="preprocessor">#define MESHDEFORM_TAG_EXTERIOR 3</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span>
<a name="l01067"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad518bc39f815a81306067a6d1ac1728a">01067</a> <span class="preprocessor">#define MESHDEFORM_LEN_THRESHOLD 1e-6f</span>
<a name="l01068"></a>01068 <span class="preprocessor"></span>
<a name="l01069"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5af81865f183ff685311eeaba6e273fa">01069</a> <span class="preprocessor">#define MESHDEFORM_MIN_INFLUENCE 0.0005f</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>
<a name="l01071"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae1d788080d1571a9923df7f6378a66a9">01071</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae1d788080d1571a9923df7f6378a66a9">MESHDEFORM_OFFSET</a>[7][3] =
<a name="l01072"></a>01072         {{0,0,0}, {1,0,0}, {-1,0,0}, {0,1,0}, {0,-1,0}, {0,0,1}, {0,0,-1}};
<a name="l01073"></a>01073 
<a name="l01074"></a><a class="code" href="../../de/de6/structMDefBoundIsect.html">01074</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> {
<a name="l01075"></a><a class="code" href="../../de/de6/structMDefBoundIsect.html#af62d8b44553779cdcee9c90e37cef59d">01075</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>[3], <a class="code" href="../../de/de6/structMDefBoundIsect.html#af62d8b44553779cdcee9c90e37cef59d">uvw</a>[4];
<a name="l01076"></a><a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">01076</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/de6/structMDefBoundIsect.html#abe66ff92c16943f8ffca1204686bfb1d">nvert</a>, <a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[4], <a class="code" href="../../de/de6/structMDefBoundIsect.html#a9826ed1044c4b44ba3a4e12437a303b8">facing</a>;
<a name="l01077"></a><a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">01077</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>;
<a name="l01078"></a>01078 } <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a0aaa1c9aee78c5a365287014d457c2bc">MDefBoundIsect</a>;
<a name="l01079"></a>01079 
<a name="l01080"></a><a class="code" href="../../dc/deb/structMDefBindInfluence.html">01080</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a> {
<a name="l01081"></a><a class="code" href="../../dc/deb/structMDefBindInfluence.html#a5187dabee246a52ecccea588cf306582">01081</a>     <span class="keyword">struct </span><a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a> *<a class="code" href="../../dc/deb/structMDefBindInfluence.html#a5187dabee246a52ecccea588cf306582">next</a>;
<a name="l01082"></a><a class="code" href="../../dc/deb/structMDefBindInfluence.html#ac47ab0da8cd1b7c9a115d0e4c9f44d36">01082</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/deb/structMDefBindInfluence.html#ac47ab0da8cd1b7c9a115d0e4c9f44d36">weight</a>;
<a name="l01083"></a><a class="code" href="../../dc/deb/structMDefBindInfluence.html#afd7e199edb269f2d863db6e23a348a6e">01083</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/deb/structMDefBindInfluence.html#afd7e199edb269f2d863db6e23a348a6e">vertex</a>;
<a name="l01084"></a>01084 } <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab47d74bf068ece4662ac66d92d6aad1a">MDefBindInfluence</a>;
<a name="l01085"></a>01085 
<a name="l01086"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html">01086</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> {
<a name="l01087"></a>01087     <span class="comment">/* grid dimensions */</span>
<a name="l01088"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">01088</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[3], <a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[3];
<a name="l01089"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">01089</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[3], <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[3];
<a name="l01090"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">01090</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>, <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>;
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <span class="comment">/* meshes */</span>
<a name="l01093"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">01093</a>     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>;
<a name="l01094"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">01094</a>     float (*<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>)[3];
<a name="l01095"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">01095</a>     float (*<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>)[3];
<a name="l01096"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">01096</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>, <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="comment">/* grids */</span>
<a name="l01099"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">01099</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>;
<a name="l01100"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">01100</a>     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *(*boundisect)[6];
<a name="l01101"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">01101</a>     <span class="keywordtype">int</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>;
<a name="l01102"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">01102</a>     <span class="keywordtype">int</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>;
<a name="l01103"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">01103</a>     <span class="keywordtype">float</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>, *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>;
<a name="l01104"></a>01104 
<a name="l01105"></a>01105     <span class="comment">/* mesh stuff */</span>
<a name="l01106"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">01106</a>     <span class="keywordtype">int</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>;
<a name="l01107"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">01107</a>     <span class="keywordtype">float</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>;
<a name="l01108"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">01108</a>     <a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a> **<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>;
<a name="l01109"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#a02c5996144d1cab424e7c28213f4a054">01109</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/ddf/structMeshDeformBind.html#a02c5996144d1cab424e7c28213f4a054">cagemat</a>[4][4];
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <span class="comment">/* direct solver */</span>
<a name="l01112"></a><a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">01112</a>     <span class="keywordtype">int</span> *<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>;
<a name="l01113"></a>01113 } <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a97afef3f3bbd315b9acf5275f5441438">MeshDeformBind</a>;
<a name="l01114"></a>01114 
<a name="l01115"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html">01115</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/dc5/structMeshDeformIsect.html">MeshDeformIsect</a> {
<a name="l01116"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">01116</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>[3];
<a name="l01117"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">01117</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>[3];
<a name="l01118"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">01118</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">labda</a>;
<a name="l01119"></a>01119 
<a name="l01120"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ab373fec0c327ae9c5cf7225d82fac198">01120</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ab373fec0c327ae9c5cf7225d82fac198">face</a>;
<a name="l01121"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a97cd49112ee4c53717823fa74029a2be">01121</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a97cd49112ee4c53717823fa74029a2be">isect</a>;
<a name="l01122"></a><a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a788651515bc8c0719c4a31d80c3722a3">01122</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a3be2978dbeed2dcfba6a6c63f0c574c2">u</a>, <a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a788651515bc8c0719c4a31d80c3722a3">v</a>;
<a name="l01123"></a>01123     
<a name="l01124"></a>01124 } <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae72683aede8abf51f9a12c8b3aedc138">MeshDeformIsect</a>;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126 <span class="comment">/* ray intersection */</span>
<a name="l01127"></a>01127 
<a name="l01128"></a>01128 <span class="comment">/* our own triangle intersection, so we can fully control the epsilons and</span>
<a name="l01129"></a>01129 <span class="comment"> * prevent corner case from going wrong*/</span>
<a name="l01130"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7eec74172b1f20274cd6794858c43c6c">01130</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7eec74172b1f20274cd6794858c43c6c">meshdeform_tri_intersect</a>(<span class="keywordtype">float</span> orig[3], <span class="keywordtype">float</span> end[3], <span class="keywordtype">float</span> vert0[3],
<a name="l01131"></a>01131     <span class="keywordtype">float</span> vert1[3], <span class="keywordtype">float</span> vert2[3], <span class="keywordtype">float</span> *isectco, <span class="keywordtype">float</span> *uvw)
<a name="l01132"></a>01132 {
<a name="l01133"></a>01133     <span class="keywordtype">float</span> edge1[3], edge2[3], tvec[3], pvec[3], qvec[3];
<a name="l01134"></a>01134     <span class="keywordtype">float</span> det,inv_det, u, v, dir[3], isectdir[3];
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dir, end, orig);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="comment">/* find vectors for two edges sharing vert0 */</span>
<a name="l01139"></a>01139     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge1, vert1, vert0);
<a name="l01140"></a>01140     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(edge2, vert2, vert0);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <span class="comment">/* begin calculating determinant - also used to calculate U parameter */</span>
<a name="l01143"></a>01143     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(pvec, dir, edge2);
<a name="l01144"></a>01144 
<a name="l01145"></a>01145     <span class="comment">/* if determinant is near zero, ray lies in plane of triangle */</span>
<a name="l01146"></a>01146     det = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(edge1, pvec);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (det == 0.0f)
<a name="l01149"></a>01149         <span class="keywordflow">return</span> 0;
<a name="l01150"></a>01150     inv_det = 1.0f / det;
<a name="l01151"></a>01151 
<a name="l01152"></a>01152     <span class="comment">/* calculate distance from vert0 to ray origin */</span>
<a name="l01153"></a>01153     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(tvec, orig, vert0);
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <span class="comment">/* calculate U parameter and test bounds */</span>
<a name="l01156"></a>01156     u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(tvec, pvec) * inv_det;
<a name="l01157"></a>01157     <span class="keywordflow">if</span> (u &lt; -EPSILON || u &gt; 1.0f+<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a002b2f4894492820fe708b1b7e7c5e70">EPSILON</a>)
<a name="l01158"></a>01158         <span class="keywordflow">return</span> 0;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="comment">/* prepare to test V parameter */</span>
<a name="l01161"></a>01161     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(qvec, tvec, edge1);
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="comment">/* calculate V parameter and test bounds */</span>
<a name="l01164"></a>01164     v = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir, qvec) * inv_det;
<a name="l01165"></a>01165     <span class="keywordflow">if</span> (v &lt; -EPSILON || u + v &gt; 1.0f+<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a002b2f4894492820fe708b1b7e7c5e70">EPSILON</a>)
<a name="l01166"></a>01166         <span class="keywordflow">return</span> 0;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     isectco[0]= (1.0f - u - v)*vert0[0] + u*vert1[0] + v*vert2[0];
<a name="l01169"></a>01169     isectco[1]= (1.0f - u - v)*vert0[1] + u*vert1[1] + v*vert2[1];
<a name="l01170"></a>01170     isectco[2]= (1.0f - u - v)*vert0[2] + u*vert1[2] + v*vert2[2];
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     uvw[0]= 1.0f - u - v;
<a name="l01173"></a>01173     uvw[1]= u;
<a name="l01174"></a>01174     uvw[2]= v;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176     <span class="comment">/* check if it is within the length of the line segment */</span>
<a name="l01177"></a>01177     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(isectdir, isectco, orig);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir, isectdir) &lt; -<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a002b2f4894492820fe708b1b7e7c5e70">EPSILON</a>)
<a name="l01180"></a>01180         <span class="keywordflow">return</span> 0;
<a name="l01181"></a>01181     
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir, dir) + <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a002b2f4894492820fe708b1b7e7c5e70">EPSILON</a> &lt; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(isectdir, isectdir))
<a name="l01183"></a>01183         <span class="keywordflow">return</span> 0;
<a name="l01184"></a>01184 
<a name="l01185"></a>01185     <span class="keywordflow">return</span> 1;
<a name="l01186"></a>01186 }
<a name="l01187"></a>01187 
<a name="l01188"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5639c883031f94680f190a1512a35b59">01188</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5639c883031f94680f190a1512a35b59">meshdeform_intersect</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <a class="code" href="../../d5/dc5/structMeshDeformIsect.html">MeshDeformIsect</a> *isec)
<a name="l01189"></a>01189 {
<a name="l01190"></a>01190     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l01191"></a>01191     <span class="keywordtype">float</span> face[4][3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], uvw[3], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, nor[3], end[3];
<a name="l01192"></a>01192     <span class="keywordtype">int</span> f, hit, is= 0, totface;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">labda</a>= 1e10;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196     mface= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>);
<a name="l01197"></a>01197     totface= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(end, isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>);
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="keywordflow">for</span> (f=0; f&lt;totface; f++, mface++) {
<a name="l01202"></a>01202         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face[0], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]);
<a name="l01203"></a>01203         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face[1], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]);
<a name="l01204"></a>01204         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face[2], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]);
<a name="l01205"></a>01205 
<a name="l01206"></a>01206         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01207"></a>01207             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face[3], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]);
<a name="l01208"></a>01208             hit = <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7eec74172b1f20274cd6794858c43c6c">meshdeform_tri_intersect</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, end, face[0], face[1], face[2], co, uvw);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210             <span class="keywordflow">if</span> (hit) {
<a name="l01211"></a>01211                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,face[0], face[1], face[2]);
<a name="l01212"></a>01212             }
<a name="l01213"></a>01213             <span class="keywordflow">else</span> {
<a name="l01214"></a>01214                 hit= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7eec74172b1f20274cd6794858c43c6c">meshdeform_tri_intersect</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, end, face[0], face[2], face[3], co, uvw);
<a name="l01215"></a>01215                 <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,face[0], face[2], face[3]);
<a name="l01216"></a>01216             }
<a name="l01217"></a>01217         }
<a name="l01218"></a>01218         <span class="keywordflow">else</span> {
<a name="l01219"></a>01219             hit= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a7eec74172b1f20274cd6794858c43c6c">meshdeform_tri_intersect</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, end, face[0], face[1], face[2], co, uvw);
<a name="l01220"></a>01220             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( nor,face[0], face[1], face[2]);
<a name="l01221"></a>01221         }
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         <span class="keywordflow">if</span> (hit) {
<a name="l01224"></a>01224             len= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, co)/<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, end);
<a name="l01225"></a>01225             <span class="keywordflow">if</span> (len &lt; isec-&gt;labda) {
<a name="l01226"></a>01226                 isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">labda</a>= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01227"></a>01227                 isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ab373fec0c327ae9c5cf7225d82fac198">face</a> = mface;
<a name="l01228"></a>01228                 isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a97cd49112ee4c53717823fa74029a2be">isect</a>= (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(isec-&gt;<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>, nor) &lt;= 0.0f);
<a name="l01229"></a>01229                 is= 1;
<a name="l01230"></a>01230             }
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232     }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234     <span class="keywordflow">return</span> is;
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01237"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a3f379ca475b241bd396fbe71bf4167f7">01237</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a3f379ca475b241bd396fbe71bf4167f7">meshdeform_ray_tree_intersect</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">float</span> *co1, <span class="keywordtype">float</span> *co2)
<a name="l01238"></a>01238 {
<a name="l01239"></a>01239     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01240"></a>01240     <a class="code" href="../../d5/dc5/structMeshDeformIsect.html">MeshDeformIsect</a> isec;
<a name="l01241"></a>01241     float (*cagecos)[3];
<a name="l01242"></a>01242     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l01243"></a>01243     <span class="keywordtype">float</span> vert[4][3], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, end[3];
<a name="l01244"></a>01244     <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a>[3]= {0, 0, 0}; <span class="comment">//1e-4, 1e-4, 1e-4};</span>
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <span class="comment">/* setup isec */</span>
<a name="l01247"></a>01247     memset(&amp;isec, 0, <span class="keyword">sizeof</span>(isec));
<a name="l01248"></a>01248     isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">labda</a>= 1e10f;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>, co1, epsilon);
<a name="l01251"></a>01251     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(end, co2, epsilon);
<a name="l01252"></a>01252     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>, end, isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ae95bf74eab032b0c2ca76a08d8890760">start</a>);
<a name="l01253"></a>01253 
<a name="l01254"></a>01254     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5639c883031f94680f190a1512a35b59">meshdeform_intersect</a>(mdb, &amp;isec)) {
<a name="l01255"></a>01255         len= isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a0b93f2ba7ff7998386394535aaa6bd57">labda</a>;
<a name="l01256"></a>01256         mface=(<a class="code" href="../../d6/da0/structMFace.html">MFace</a>*)isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#ab373fec0c327ae9c5cf7225d82fac198">face</a>;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258         <span class="comment">/* create MDefBoundIsect */</span>
<a name="l01259"></a>01259         isect= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>, <span class="keyword">sizeof</span>(*isect));
<a name="l01260"></a>01260 
<a name="l01261"></a>01261         <span class="comment">/* compute intersection coordinate */</span>
<a name="l01262"></a>01262         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>[0]= co1[0] + isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>[0]*<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01263"></a>01263         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>[1]= co1[1] + isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>[1]*<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01264"></a>01264         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>[2]= co1[2] + isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a4a545380c45bd4a6efe4d415b7a1eecd">vec</a>[2]*<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(co1, isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>);
<a name="l01267"></a>01267         <span class="keywordflow">if</span> (isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a> &lt; <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad518bc39f815a81306067a6d1ac1728a">MESHDEFORM_LEN_THRESHOLD</a>)
<a name="l01268"></a>01268             isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad518bc39f815a81306067a6d1ac1728a">MESHDEFORM_LEN_THRESHOLD</a>;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[0]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l01271"></a>01271         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[1]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l01272"></a>01272         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[2]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l01273"></a>01273         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[3]= mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l01274"></a>01274         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#abe66ff92c16943f8ffca1204686bfb1d">nvert</a>= (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)? 4: 3;
<a name="l01275"></a>01275 
<a name="l01276"></a>01276         isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9826ed1044c4b44ba3a4e12437a303b8">facing</a>= isec.<a class="code" href="../../d5/dc5/structMeshDeformIsect.html#a97cd49112ee4c53717823fa74029a2be">isect</a>;
<a name="l01277"></a>01277 
<a name="l01278"></a>01278         <span class="comment">/* compute mean value coordinates for interpolation */</span>
<a name="l01279"></a>01279         cagecos= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>;
<a name="l01280"></a>01280         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert[0], cagecos[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]);
<a name="l01281"></a>01281         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert[1], cagecos[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]);
<a name="l01282"></a>01282         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert[2], cagecos[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]);
<a name="l01283"></a>01283         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert[3], cagecos[mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]);
<a name="l01284"></a>01284         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9ad37845c890fd4002636cd5a5145b8d">interp_weights_poly_v3</a>( isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#af62d8b44553779cdcee9c90e37cef59d">uvw</a>,vert, isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#abe66ff92c16943f8ffca1204686bfb1d">nvert</a>, isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#adf3fd794e1184b67be74c92f161b7089">co</a>);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         <span class="keywordflow">return</span> isect;
<a name="l01287"></a>01287     }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01290"></a>01290 }
<a name="l01291"></a>01291 
<a name="l01292"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a31a80c997257eca2456fb9354af4dfcb">01292</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a31a80c997257eca2456fb9354af4dfcb">meshdeform_inside_cage</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01295"></a>01295     <span class="keywordtype">float</span> outside[3], start[3], dir[3];
<a name="l01296"></a>01296     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01299"></a>01299         outside[0] = co[0] + (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[0] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[0] + 1.0f)*MESHDEFORM_OFFSET[i][0];
<a name="l01300"></a>01300         outside[1] = co[1] + (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[1] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[1] + 1.0f)*MESHDEFORM_OFFSET[i][1];
<a name="l01301"></a>01301         outside[2] = co[2] + (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[2] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[2] + 1.0f)*MESHDEFORM_OFFSET[i][2];
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(start, co);
<a name="l01304"></a>01304         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dir, outside, start);
<a name="l01305"></a>01305         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(dir);
<a name="l01306"></a>01306         
<a name="l01307"></a>01307         isect = <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a3f379ca475b241bd396fbe71bf4167f7">meshdeform_ray_tree_intersect</a>(mdb, start, outside);
<a name="l01308"></a>01308         <span class="keywordflow">if</span> (isect &amp;&amp; !isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9826ed1044c4b44ba3a4e12437a303b8">facing</a>)
<a name="l01309"></a>01309             <span class="keywordflow">return</span> 1;
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     <span class="keywordflow">return</span> 0;
<a name="l01313"></a>01313 }
<a name="l01314"></a>01314 
<a name="l01315"></a>01315 <span class="comment">/* solving */</span>
<a name="l01316"></a>01316 
<a name="l01317"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">01317</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> n)
<a name="l01318"></a>01318 {
<a name="l01319"></a>01319     <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>;
<a name="l01320"></a>01320     
<a name="l01321"></a>01321     x += MESHDEFORM_OFFSET[n][0];
<a name="l01322"></a>01322     y += MESHDEFORM_OFFSET[n][1];
<a name="l01323"></a>01323     z += MESHDEFORM_OFFSET[n][2];
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     <span class="keywordflow">if</span> (x &lt; 0 || x &gt;= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>)
<a name="l01326"></a>01326         <span class="keywordflow">return</span> -1;
<a name="l01327"></a>01327     <span class="keywordflow">if</span> (y &lt; 0 || y &gt;= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>)
<a name="l01328"></a>01328         <span class="keywordflow">return</span> -1;
<a name="l01329"></a>01329     <span class="keywordflow">if</span> (z &lt; 0 || z &gt;= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>)
<a name="l01330"></a>01330         <span class="keywordflow">return</span> -1;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <span class="keywordflow">return</span> x + y*size + z*size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab37c8a5ca2a1c3f790d1de3d4b81fe10">01335</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab37c8a5ca2a1c3f790d1de3d4b81fe10">meshdeform_cell_center</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> n, <span class="keywordtype">float</span> *center)
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337     x += MESHDEFORM_OFFSET[n][0];
<a name="l01338"></a>01338     y += MESHDEFORM_OFFSET[n][1];
<a name="l01339"></a>01339     z += MESHDEFORM_OFFSET[n][2];
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     center[0]= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[0] + x*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[0] + mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[0];
<a name="l01342"></a>01342     center[1]= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[1] + y*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[1] + mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[1];
<a name="l01343"></a>01343     center[2]= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[2] + z*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[2] + mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[2];
<a name="l01344"></a>01344 }
<a name="l01345"></a>01345 
<a name="l01346"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a6e6359718d85261ab23d386a47d4c46b">01346</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a6e6359718d85261ab23d386a47d4c46b">meshdeform_add_intersections</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
<a name="l01347"></a>01347 {
<a name="l01348"></a>01348     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01349"></a>01349     <span class="keywordtype">float</span> center[3], ncenter[3];
<a name="l01350"></a>01350     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01353"></a>01353     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab37c8a5ca2a1c3f790d1de3d4b81fe10">meshdeform_cell_center</a>(mdb, x, y, z, 0, center);
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <span class="comment">/* check each outgoing edge for intersection */</span>
<a name="l01356"></a>01356     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01357"></a>01357         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, i) == -1)
<a name="l01358"></a>01358             <span class="keywordflow">continue</span>;
<a name="l01359"></a>01359 
<a name="l01360"></a>01360         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab37c8a5ca2a1c3f790d1de3d4b81fe10">meshdeform_cell_center</a>(mdb, x, y, z, i, ncenter);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362         isect= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a3f379ca475b241bd396fbe71bf4167f7">meshdeform_ray_tree_intersect</a>(mdb, center, ncenter);
<a name="l01363"></a>01363         <span class="keywordflow">if</span> (isect) {
<a name="l01364"></a>01364             mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1]= isect;
<a name="l01365"></a>01365             mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[a]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac20d10bb62cfee2b7994d5e5ea5dad01">MESHDEFORM_TAG_BOUNDARY</a>;
<a name="l01366"></a>01366         }
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a0817737644316d4f19d49878844266ee">01370</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a0817737644316d4f19d49878844266ee">meshdeform_bind_floodfill</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb)
<a name="l01371"></a>01371 {
<a name="l01372"></a>01372     <span class="keywordtype">int</span> *<a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>, *tag= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>;
<a name="l01373"></a>01373     <span class="keywordtype">int</span> a, b, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, xyz[3], stacksize, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     stack= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MeshDeformBindStack&quot;</span>);
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="comment">/* we know lower left corner is EXTERIOR because of padding */</span>
<a name="l01378"></a>01378     tag[0]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>;
<a name="l01379"></a>01379     stack[0]= 0;
<a name="l01380"></a>01380     stacksize= 1;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     <span class="comment">/* floodfill exterior tag */</span>
<a name="l01383"></a>01383     <span class="keywordflow">while</span> (stacksize &gt; 0) {
<a name="l01384"></a>01384         a= stack[--stacksize];
<a name="l01385"></a>01385 
<a name="l01386"></a>01386         xyz[2]= a/(size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>);
<a name="l01387"></a>01387         xyz[1]= (a - xyz[2]*size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)/size;
<a name="l01388"></a>01388         xyz[0]= a - xyz[1]*size - xyz[2]*size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01389"></a>01389 
<a name="l01390"></a>01390         <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01391"></a>01391             b= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, xyz[0], xyz[1], xyz[2], i);
<a name="l01392"></a>01392 
<a name="l01393"></a>01393             <span class="keywordflow">if</span> (b != -1) {
<a name="l01394"></a>01394                 <span class="keywordflow">if</span> (tag[b] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abea462ffbeacfca837ec84b1fae0a8ab">MESHDEFORM_TAG_UNTYPED</a> ||
<a name="l01395"></a>01395                    (tag[b] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac20d10bb62cfee2b7994d5e5ea5dad01">MESHDEFORM_TAG_BOUNDARY</a> &amp;&amp; !mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1])) {
<a name="l01396"></a>01396                     tag[b]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>;
<a name="l01397"></a>01397                     stack[stacksize++]= b;
<a name="l01398"></a>01398                 }
<a name="l01399"></a>01399             }
<a name="l01400"></a>01400         }
<a name="l01401"></a>01401     }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <span class="comment">/* other cells are interior */</span>
<a name="l01404"></a>01404     <span class="keywordflow">for</span> (a=0; a&lt;size*size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; a++)
<a name="l01405"></a>01405         <span class="keywordflow">if</span> (tag[a]==<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abea462ffbeacfca837ec84b1fae0a8ab">MESHDEFORM_TAG_UNTYPED</a>)
<a name="l01406"></a>01406             tag[a]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#acd613db188960ce6efc7a51dec41e5a5">MESHDEFORM_TAG_INTERIOR</a>;
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 <span class="preprocessor">#if 0</span>
<a name="l01409"></a>01409 <span class="preprocessor"></span>    {
<a name="l01410"></a>01410         <span class="keywordtype">int</span> tb, ti, te, ts;
<a name="l01411"></a>01411         tb= ti= te= ts= 0;
<a name="l01412"></a>01412         <span class="keywordflow">for</span> (a=0; a&lt;size*size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; a++)
<a name="l01413"></a>01413             <span class="keywordflow">if</span> (tag[a]==<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac20d10bb62cfee2b7994d5e5ea5dad01">MESHDEFORM_TAG_BOUNDARY</a>)
<a name="l01414"></a>01414                 tb++;
<a name="l01415"></a>01415             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag[a]==<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#acd613db188960ce6efc7a51dec41e5a5">MESHDEFORM_TAG_INTERIOR</a>)
<a name="l01416"></a>01416                 ti++;
<a name="l01417"></a>01417             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag[a]==<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>) {
<a name="l01418"></a>01418                 te++;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420                 <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[a])
<a name="l01421"></a>01421                     ts++;
<a name="l01422"></a>01422             }
<a name="l01423"></a>01423         
<a name="l01424"></a>01424         printf(<span class="stringliteral">&quot;interior %d exterior %d boundary %d semi-boundary %d\n&quot;</span>, ti, te, tb, ts);
<a name="l01425"></a>01425     }
<a name="l01426"></a>01426 <span class="preprocessor">#endif</span>
<a name="l01427"></a>01427 <span class="preprocessor"></span>
<a name="l01428"></a>01428     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(stack);
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae2b37d915c91503d02cba1e852c01b13">01431</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae2b37d915c91503d02cba1e852c01b13">meshdeform_boundary_phi</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(mdb), <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect, <span class="keywordtype">int</span> cagevert)
<a name="l01432"></a>01432 {
<a name="l01433"></a>01433     <span class="keywordtype">int</span> a;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     <span class="keywordflow">for</span> (a=0; a&lt;isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#abe66ff92c16943f8ffca1204686bfb1d">nvert</a>; a++)
<a name="l01436"></a>01436         <span class="keywordflow">if</span> (isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a9b498516f254f3f7125db1fc182f9ec5">v</a>[a] == cagevert)
<a name="l01437"></a>01437             <span class="keywordflow">return</span> isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#af62d8b44553779cdcee9c90e37cef59d">uvw</a>[a];
<a name="l01438"></a>01438     
<a name="l01439"></a>01439     <span class="keywordflow">return</span> 0.0f;
<a name="l01440"></a>01440 }
<a name="l01441"></a>01441 
<a name="l01442"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a46acd9889dfb3b99e12f898d6fe83d53">01442</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a46acd9889dfb3b99e12f898d6fe83d53">meshdeform_interp_w</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">float</span> *gridvec, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(vec), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cagevert))
<a name="l01443"></a>01443 {
<a name="l01444"></a>01444     <span class="keywordtype">float</span> dvec[3], ivec[3], wx, wy, wz, result=0.0f;
<a name="l01445"></a>01445     <span class="keywordtype">float</span> weight, totweight= 0.0f;
<a name="l01446"></a>01446     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, x, y, z;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448     <span class="keywordflow">for</span> (i=0; i&lt;3; i++) {
<a name="l01449"></a>01449         ivec[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= (int)gridvec[i];
<a name="l01450"></a>01450         dvec[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= gridvec[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - ivec[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="keywordflow">for</span> (i=0; i&lt;8; i++) {
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (i &amp; 1) { x= ivec[0]+1; wx= dvec[0]; }
<a name="l01455"></a>01455         <span class="keywordflow">else</span> { x= ivec[0]; wx= 1.0f-dvec[0]; } 
<a name="l01456"></a>01456 
<a name="l01457"></a>01457         <span class="keywordflow">if</span> (i &amp; 2) { y= ivec[1]+1; wy= dvec[1]; }
<a name="l01458"></a>01458         <span class="keywordflow">else</span> { y= ivec[1]; wy= 1.0f-dvec[1]; } 
<a name="l01459"></a>01459 
<a name="l01460"></a>01460         <span class="keywordflow">if</span> (i &amp; 4) { z= ivec[2]+1; wz= dvec[2]; }
<a name="l01461"></a>01461         <span class="keywordflow">else</span> { z= ivec[2]; wz= 1.0f-dvec[2]; } 
<a name="l01462"></a>01462 
<a name="l01463"></a>01463         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(x, 0, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>-1);
<a name="l01464"></a>01464         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(y, 0, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>-1);
<a name="l01465"></a>01465         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(z, 0, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>-1);
<a name="l01466"></a>01466 
<a name="l01467"></a>01467         a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01468"></a>01468         weight= wx*wy*wz;
<a name="l01469"></a>01469         result += weight*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[a];
<a name="l01470"></a>01470         totweight += weight;
<a name="l01471"></a>01471     }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     <span class="keywordflow">if</span> (totweight &gt; 0.0f)
<a name="l01474"></a>01474         result /= totweight;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476     <span class="keywordflow">return</span> result;
<a name="l01477"></a>01477 }
<a name="l01478"></a>01478 
<a name="l01479"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac4d3d3fd0e7b9e56e45a37ddce950a68">01479</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac4d3d3fd0e7b9e56e45a37ddce950a68">meshdeform_check_semibound</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
<a name="l01480"></a>01480 {
<a name="l01481"></a>01481     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483     a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[a] != <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01485"></a>01485         <span class="keywordflow">return</span>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++)
<a name="l01488"></a>01488         <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1]) 
<a name="l01489"></a>01489             mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[a]= 1;
<a name="l01490"></a>01490 }
<a name="l01491"></a>01491 
<a name="l01492"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aadaf2ce87f09ca7713be3c32e8d6741d">01492</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aadaf2ce87f09ca7713be3c32e8d6741d">meshdeform_boundary_total_weight</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
<a name="l01493"></a>01493 {
<a name="l01494"></a>01494     <span class="keywordtype">float</span> weight, totweight= 0.0f;
<a name="l01495"></a>01495     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="comment">/* count weight for neighbor cells */</span>
<a name="l01500"></a>01500     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01501"></a>01501         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, i) == -1)
<a name="l01502"></a>01502             <span class="keywordflow">continue</span>;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504         <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1])
<a name="l01505"></a>01505             weight= 1.0f/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1]-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>;
<a name="l01506"></a>01506         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[a])
<a name="l01507"></a>01507             weight= 1.0f/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[0];
<a name="l01508"></a>01508         <span class="keywordflow">else</span>
<a name="l01509"></a>01509             weight= 0.0f;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511         totweight += weight;
<a name="l01512"></a>01512     }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     <span class="keywordflow">return</span> totweight;
<a name="l01515"></a>01515 }
<a name="l01516"></a>01516 
<a name="l01517"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad87ef466a209683f375332f208e41851">01517</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad87ef466a209683f375332f208e41851">meshdeform_matrix_add_cell</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z)
<a name="l01518"></a>01518 {
<a name="l01519"></a>01519     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01520"></a>01520     <span class="keywordtype">float</span> weight, totweight;
<a name="l01521"></a>01521     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, acenter;
<a name="l01522"></a>01522 
<a name="l01523"></a>01523     acenter= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01524"></a>01524     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[acenter] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01525"></a>01525         <span class="keywordflow">return</span>;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[acenter], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[acenter], 1.0f);
<a name="l01528"></a>01528     
<a name="l01529"></a>01529     totweight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aadaf2ce87f09ca7713be3c32e8d6741d">meshdeform_boundary_total_weight</a>(mdb, x, y, z);
<a name="l01530"></a>01530     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01531"></a>01531         a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, i);
<a name="l01532"></a>01532         <span class="keywordflow">if</span> (a == -1 || mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[a] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01533"></a>01533             <span class="keywordflow">continue</span>;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535         isect= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[acenter][i-1];
<a name="l01536"></a>01536         <span class="keywordflow">if</span> (!isect) {
<a name="l01537"></a>01537             weight= (1.0f/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[0])/totweight;
<a name="l01538"></a>01538             <a class="code" href="../../db/dde/ONL__opennl_8h.html#ae933bc06339e9abed3e98df7630884d8">nlMatrixAdd</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[acenter], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[a], -weight);
<a name="l01539"></a>01539         }
<a name="l01540"></a>01540     }
<a name="l01541"></a>01541 }
<a name="l01542"></a>01542 
<a name="l01543"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af6ceb67dd17346c19805ea09fbef39fc">01543</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af6ceb67dd17346c19805ea09fbef39fc">meshdeform_matrix_add_rhs</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> cagevert)
<a name="l01544"></a>01544 {
<a name="l01545"></a>01545     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01546"></a>01546     <span class="keywordtype">float</span> rhs, weight, totweight;
<a name="l01547"></a>01547     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, acenter;
<a name="l01548"></a>01548 
<a name="l01549"></a>01549     acenter= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01550"></a>01550     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[acenter] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01551"></a>01551         <span class="keywordflow">return</span>;
<a name="l01552"></a>01552 
<a name="l01553"></a>01553     totweight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aadaf2ce87f09ca7713be3c32e8d6741d">meshdeform_boundary_total_weight</a>(mdb, x, y, z);
<a name="l01554"></a>01554     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01555"></a>01555         a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, i);
<a name="l01556"></a>01556         <span class="keywordflow">if</span> (a == -1)
<a name="l01557"></a>01557             <span class="keywordflow">continue</span>;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559         isect= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[acenter][i-1];
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         <span class="keywordflow">if</span> (isect) {
<a name="l01562"></a>01562             weight= (1.0f/isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>)/totweight;
<a name="l01563"></a>01563             rhs= weight*<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae2b37d915c91503d02cba1e852c01b13">meshdeform_boundary_phi</a>(mdb, isect, cagevert);
<a name="l01564"></a>01564             <a class="code" href="../../db/dde/ONL__opennl_8h.html#a7aa28383fe94304ea3cc8b86ac5b9024">nlRightHandSideAdd</a>(0, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[acenter], rhs);
<a name="l01565"></a>01565         }
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a48ad97ee2061d560c9695987fa262d8d">01569</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a48ad97ee2061d560c9695987fa262d8d">meshdeform_matrix_add_semibound_phi</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> cagevert)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571     <a class="code" href="../../de/de6/structMDefBoundIsect.html">MDefBoundIsect</a> *isect;
<a name="l01572"></a>01572     <span class="keywordtype">float</span> rhs, weight, totweight;
<a name="l01573"></a>01573     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a;
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01576"></a>01576     <span class="keywordflow">if</span> (!mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[a])
<a name="l01577"></a>01577         <span class="keywordflow">return</span>;
<a name="l01578"></a>01578     
<a name="l01579"></a>01579     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[a]= 0.0f;
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     totweight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aadaf2ce87f09ca7713be3c32e8d6741d">meshdeform_boundary_total_weight</a>(mdb, x, y, z);
<a name="l01582"></a>01582     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01583"></a>01583         isect= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>[a][i-1];
<a name="l01584"></a>01584 
<a name="l01585"></a>01585         <span class="keywordflow">if</span> (isect) {
<a name="l01586"></a>01586             weight= (1.0f/isect-&gt;<a class="code" href="../../de/de6/structMDefBoundIsect.html#a6e28a4b71b10478dea8903213395a106">len</a>)/totweight;
<a name="l01587"></a>01587             rhs= weight*<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ae2b37d915c91503d02cba1e852c01b13">meshdeform_boundary_phi</a>(mdb, isect, cagevert);
<a name="l01588"></a>01588             mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[a] += rhs;
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 }
<a name="l01592"></a>01592 
<a name="l01593"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa86b03cd6a641415daa88530538b3500">01593</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa86b03cd6a641415daa88530538b3500">meshdeform_matrix_add_exterior_phi</a>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cagevert))
<a name="l01594"></a>01594 {
<a name="l01595"></a>01595     <span class="keywordtype">float</span> phi, totweight;
<a name="l01596"></a>01596     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, acenter;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     acenter= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, 0);
<a name="l01599"></a>01599     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[acenter] != <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a> || mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[acenter])
<a name="l01600"></a>01600         <span class="keywordflow">return</span>;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     phi= 0.0f;
<a name="l01603"></a>01603     totweight= 0.0f;
<a name="l01604"></a>01604     <span class="keywordflow">for</span> (i=1; i&lt;=6; i++) {
<a name="l01605"></a>01605         a= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4f974e96d403d0c4867dd35088e3b80f">meshdeform_index</a>(mdb, x, y, z, i);
<a name="l01606"></a>01606 
<a name="l01607"></a>01607         <span class="keywordflow">if</span> (a != -1 &amp;&amp; mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[a]) {
<a name="l01608"></a>01608             phi += mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[a];
<a name="l01609"></a>01609             totweight += 1.0f;
<a name="l01610"></a>01610         }
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="keywordflow">if</span> (totweight != 0.0f)
<a name="l01614"></a>01614         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[acenter]= phi/totweight;
<a name="l01615"></a>01615 }
<a name="l01616"></a>01616 
<a name="l01617"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5dca39df7cd632f29df7c67d3259f368">01617</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5dca39df7cd632f29df7c67d3259f368">meshdeform_matrix_solve</a>(<a class="code" href="../../de/df2/structMeshDeformModifierData.html">MeshDeformModifierData</a> *mmd, <a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb)
<a name="l01618"></a>01618 {
<a name="l01619"></a>01619     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a3481fa5895ecf7c96e0b6245295428d6">NLContext</a> *context;
<a name="l01620"></a>01620     <span class="keywordtype">float</span> vec[3], gridvec[3];
<a name="l01621"></a>01621     <span class="keywordtype">int</span> a, b, x, y, z, totvar;
<a name="l01622"></a>01622     <span class="keywordtype">char</span> message[256];
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     <span class="comment">/* setup variable indices */</span>
<a name="l01625"></a>01625     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MeshDeformDSvaridx&quot;</span>);
<a name="l01626"></a>01626     <span class="keywordflow">for</span> (a=0, totvar=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; a++)
<a name="l01627"></a>01627         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[a]= (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[a] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)? -1: totvar++;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     <span class="keywordflow">if</span> (totvar == 0) {
<a name="l01630"></a>01630         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>);
<a name="l01631"></a>01631         <span class="keywordflow">return</span>;
<a name="l01632"></a>01632     }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa8ada5c6c2c3e62c618f290caf40a61d">progress_bar</a>(0, <span class="stringliteral">&quot;Starting mesh deform solve&quot;</span>);
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     <span class="comment">/* setup opennl solver */</span>
<a name="l01637"></a>01637     <a class="code" href="../../db/dde/ONL__opennl_8h.html#ab1054f9a1b1ab94be7f2c63964c0a34a">nlNewContext</a>();
<a name="l01638"></a>01638     context= <a class="code" href="../../db/dde/ONL__opennl_8h.html#a9fb5d3916e99001b17e71ab38646119e">nlGetCurrent</a>();
<a name="l01639"></a>01639 
<a name="l01640"></a>01640     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a478d8f98fe56b4383eeae14bf55bafaf">nlSolverParameteri</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a18fe83c4c3c6b38100da3898d8c717ed">NL_NB_VARIABLES</a>, totvar);
<a name="l01641"></a>01641     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a478d8f98fe56b4383eeae14bf55bafaf">nlSolverParameteri</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a11ddde2a39d2538cc634bf2750414a9f">NL_NB_ROWS</a>, totvar);
<a name="l01642"></a>01642     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a478d8f98fe56b4383eeae14bf55bafaf">nlSolverParameteri</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7bcb6a7540b0ded3a8c5a264a7520b8b">NL_NB_RIGHT_HAND_SIDES</a>, 1);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l01645"></a>01645     <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     <span class="comment">/* build matrix */</span>
<a name="l01648"></a>01648     <span class="keywordflow">for</span> (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01649"></a>01649         <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01650"></a>01650             <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01651"></a>01651                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad87ef466a209683f375332f208e41851">meshdeform_matrix_add_cell</a>(mdb, x, y, z);
<a name="l01652"></a>01652 
<a name="l01653"></a>01653     <span class="comment">/* solve for each cage vert */</span>
<a name="l01654"></a>01654     <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>; a++) {
<a name="l01655"></a>01655         <span class="keywordflow">if</span> (a != 0) {
<a name="l01656"></a>01656             <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l01657"></a>01657             <a class="code" href="../../db/dde/ONL__opennl_8h.html#a055e76d818259ca099f34768747045f7">nlBegin</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l01658"></a>01658         }
<a name="l01659"></a>01659 
<a name="l01660"></a>01660         <span class="comment">/* fill in right hand side and solve */</span>
<a name="l01661"></a>01661         <span class="keywordflow">for</span> (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01662"></a>01662             <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01663"></a>01663                 <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01664"></a>01664                     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af6ceb67dd17346c19805ea09fbef39fc">meshdeform_matrix_add_rhs</a>(mdb, x, y, z, a);
<a name="l01665"></a>01665 
<a name="l01666"></a>01666         <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a771e7b6917d1b664d82cfa2ba54db280">NL_MATRIX</a>);
<a name="l01667"></a>01667         <a class="code" href="../../db/dde/ONL__opennl_8h.html#a54fc2191decc6e675c9c9d969d890468">nlEnd</a>(<a class="code" href="../../db/dde/ONL__opennl_8h.html#a7fd5de3ea97068e7853c36d9ea70d12e">NL_SYSTEM</a>);
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 <span class="preprocessor">#if 0</span>
<a name="l01670"></a>01670 <span class="preprocessor"></span>        <a class="code" href="../../db/dde/ONL__opennl_8h.html#a02ef63e101f56a596217bbdab889f351">nlPrintMatrix</a>();
<a name="l01671"></a>01671 <span class="preprocessor">#endif</span>
<a name="l01672"></a>01672 <span class="preprocessor"></span>
<a name="l01673"></a>01673         <span class="keywordflow">if</span> (<a class="code" href="../../db/dde/ONL__opennl_8h.html#afae449d3ffbd41c2fdabaf7602e6bbb9">nlSolveAdvanced</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../db/dde/ONL__opennl_8h.html#ab803a6e79704c5027f50a830dc341d0c">NL_TRUE</a>)) {
<a name="l01674"></a>01674             <span class="keywordflow">for</span> (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01675"></a>01675                 <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01676"></a>01676                     <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01677"></a>01677                         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a48ad97ee2061d560c9695987fa262d8d">meshdeform_matrix_add_semibound_phi</a>(mdb, x, y, z, a);
<a name="l01678"></a>01678 
<a name="l01679"></a>01679             <span class="keywordflow">for</span> (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01680"></a>01680                 <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01681"></a>01681                     <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01682"></a>01682                         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa86b03cd6a641415daa88530538b3500">meshdeform_matrix_add_exterior_phi</a>(mdb, x, y, z, a);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684             <span class="keywordflow">for</span> (b=0; b&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; b++) {
<a name="l01685"></a>01685                 <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[b] != <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01686"></a>01686                     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[b]= <a class="code" href="../../db/dde/ONL__opennl_8h.html#a8beef3987b9c0b7e1aaf82ec70a88ef5">nlGetVariable</a>(0, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[b]);
<a name="l01687"></a>01687                 mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>[b] += mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[b];
<a name="l01688"></a>01688             }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690             <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>) {
<a name="l01691"></a>01691                 <span class="comment">/* static bind : compute weights for each vertex */</span>
<a name="l01692"></a>01692                 <span class="keywordflow">for</span> (b=0; b&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>; b++) {
<a name="l01693"></a>01693                     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>[b]) {
<a name="l01694"></a>01694                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>[b]);
<a name="l01695"></a>01695                         gridvec[0]= (vec[0] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[0] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[0])/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[0];
<a name="l01696"></a>01696                         gridvec[1]= (vec[1] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[1] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[1])/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[1];
<a name="l01697"></a>01697                         gridvec[2]= (vec[2] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[2] - mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[2])/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[2];
<a name="l01698"></a>01698 
<a name="l01699"></a>01699                         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>[b*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a> + a]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a46acd9889dfb3b99e12f898d6fe83d53">meshdeform_interp_w</a>(mdb, gridvec, vec, a);
<a name="l01700"></a>01700                     }
<a name="l01701"></a>01701                 }
<a name="l01702"></a>01702             }
<a name="l01703"></a>01703             <span class="keywordflow">else</span> {
<a name="l01704"></a>01704                 <a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a> *inf;
<a name="l01705"></a>01705 
<a name="l01706"></a>01706                 <span class="comment">/* dynamic bind */</span>
<a name="l01707"></a>01707                 <span class="keywordflow">for</span> (b=0; b&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; b++) {
<a name="l01708"></a>01708                     <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[b] &gt;= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5af81865f183ff685311eeaba6e273fa">MESHDEFORM_MIN_INFLUENCE</a>) {
<a name="l01709"></a>01709                         inf= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>, <span class="keyword">sizeof</span>(*inf));
<a name="l01710"></a>01710                         inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#afd7e199edb269f2d863db6e23a348a6e">vertex</a>= a;
<a name="l01711"></a>01711                         inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#ac47ab0da8cd1b7c9a115d0e4c9f44d36">weight</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>[b];
<a name="l01712"></a>01712                         inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#a5187dabee246a52ecccea588cf306582">next</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>[b];
<a name="l01713"></a>01713                         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>[b]= inf;
<a name="l01714"></a>01714                     }
<a name="l01715"></a>01715                 }
<a name="l01716"></a>01716             }
<a name="l01717"></a>01717         }
<a name="l01718"></a>01718         <span class="keywordflow">else</span> {
<a name="l01719"></a>01719             <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#aa8f7ed8ac604b1d55b0b420634e91ea3">modifier_setError</a>(&amp;mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a88c04e32ecf5158b61a3e5c19dbd6caf">modifier</a>, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="../../d6/d61/BLF__translation_8h.html#a7163975dd2031d6463da225baaf59bfb">TIP_</a>(<span class="stringliteral">&quot;Failed to find bind solution (increase precision?).&quot;</span>));
<a name="l01720"></a>01720             <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a94ab435a74040b5a63317747695e98cb">error</a>(<span class="stringliteral">&quot;Mesh Deform: failed to find bind solution.&quot;</span>);
<a name="l01721"></a>01721             <span class="keywordflow">break</span>;
<a name="l01722"></a>01722         }
<a name="l01723"></a>01723 
<a name="l01724"></a>01724         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(message, <span class="keyword">sizeof</span>(message), <span class="stringliteral">&quot;Mesh deform solve %d / %d       |||&quot;</span>, a+1, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>);
<a name="l01725"></a>01725         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa8ada5c6c2c3e62c618f290caf40a61d">progress_bar</a>((<span class="keywordtype">float</span>)(a+1)/(<span class="keywordtype">float</span>)(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>), message);
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727 
<a name="l01728"></a>01728 <span class="preprocessor">#if 0</span>
<a name="l01729"></a>01729 <span class="preprocessor"></span>    <span class="comment">/* sanity check */</span>
<a name="l01730"></a>01730     <span class="keywordflow">for</span> (b=0; b&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; b++)
<a name="l01731"></a>01731         <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[b] != <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#af7f721424d8f19849014a446612a0d30">MESHDEFORM_TAG_EXTERIOR</a>)
<a name="l01732"></a>01732             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>[b] - 1.0f) &gt; 1e-4)
<a name="l01733"></a>01733                 printf(<span class="stringliteral">&quot;totalphi deficiency [%s|%d] %d: %.10f\n&quot;</span>,
<a name="l01734"></a>01734                     (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[b] == <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#acd613db188960ce6efc7a51dec41e5a5">MESHDEFORM_TAG_INTERIOR</a>)? <span class="stringliteral">&quot;interior&quot;</span>: <span class="stringliteral">&quot;boundary&quot;</span>, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>[b], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>[b], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>[b]);
<a name="l01735"></a>01735 <span class="preprocessor">#endif</span>
<a name="l01736"></a>01736 <span class="preprocessor"></span>    
<a name="l01737"></a>01737     <span class="comment">/* free */</span>
<a name="l01738"></a>01738     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ac97b824d40b3316b80a16bdbf00f5905">varidx</a>);
<a name="l01739"></a>01739 
<a name="l01740"></a>01740     <a class="code" href="../../db/dde/ONL__opennl_8h.html#aa3cd9a372693b183d71e3a84053262d3">nlDeleteContext</a>(context);
<a name="l01741"></a>01741 }
<a name="l01742"></a>01742 
<a name="l01743"></a><a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9a745d41a97ae5fe4ccbc0f4fad330fe">01743</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9a745d41a97ae5fe4ccbc0f4fad330fe">harmonic_coordinates_bind</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(scene), <a class="code" href="../../de/df2/structMeshDeformModifierData.html">MeshDeformModifierData</a> *mmd, <a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb)
<a name="l01744"></a>01744 {
<a name="l01745"></a>01745     <a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a> *inf;
<a name="l01746"></a>01746     <a class="code" href="../../db/dcd/structMDefInfluence.html">MDefInfluence</a> *mdinf;
<a name="l01747"></a>01747     <a class="code" href="../../d1/d4a/structMDefCell.html">MDefCell</a> *cell;
<a name="l01748"></a>01748     <span class="keywordtype">float</span> center[3], vec[3], maxwidth, totweight;
<a name="l01749"></a>01749     <span class="keywordtype">int</span> a, b, x, y, z, totinside, offset;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     <span class="comment">/* compute bounding box of the cage mesh */</span>
<a name="l01752"></a>01752     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>);
<a name="l01753"></a>01753 
<a name="l01754"></a>01754     <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>; a++)
<a name="l01755"></a>01755         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[a], mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>);
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     <span class="comment">/* allocate memory */</span>
<a name="l01758"></a>01758     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>= (2&lt;&lt;(mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a9b0ef007107f67f01b8002fb572e7ddf">gridsize</a>-1)) + 2;
<a name="l01759"></a>01759     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>;
<a name="l01760"></a>01760     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MeshDeformBindTag&quot;</span>);
<a name="l01761"></a>01761     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MeshDeformBindPhi&quot;</span>);
<a name="l01762"></a>01762     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MeshDeformBindTotalPhi&quot;</span>);
<a name="l01763"></a>01763     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MDefBoundIsect&quot;</span>);
<a name="l01764"></a>01764     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MDefSemiBound&quot;</span>);
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>, <span class="stringliteral">&quot;MDefInside&quot;</span>);
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <span class="keywordflow">if</span> (mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#ac8dc3e1427530f9c65d2425d90bbba92">flag</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a673ecdb7c96a65d4a05b664d502220fe">MOD_MDEF_DYNAMIC_BIND</a>)
<a name="l01769"></a>01769         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/deb/structMDefBindInfluence.html">MDefBindInfluence</a>*)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MDefDynGrid&quot;</span>);
<a name="l01770"></a>01770     <span class="keywordflow">else</span>
<a name="l01771"></a>01771         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>, <span class="stringliteral">&quot;MDefWeights&quot;</span>);
<a name="l01772"></a>01772 
<a name="l01773"></a>01773     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;harmonic coords arena&quot;</span>);
<a name="l01774"></a>01774     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="comment">/* make bounding box equal size in all directions, add padding, and compute</span>
<a name="l01777"></a>01777 <span class="comment">     * width of the cells */</span>
<a name="l01778"></a>01778     maxwidth = -1.0f;
<a name="l01779"></a>01779     <span class="keywordflow">for</span> (a=0; a&lt;3; a++)
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a]-mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a] &gt; maxwidth)
<a name="l01781"></a>01781             maxwidth= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a]-mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a];
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="keywordflow">for</span> (a=0; a&lt;3; a++) {
<a name="l01784"></a>01784         center[a]= (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a]+mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a])*0.5f;
<a name="l01785"></a>01785         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a]= center[a] - maxwidth*0.5f;
<a name="l01786"></a>01786         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a]= center[a] + maxwidth*0.5f;
<a name="l01787"></a>01787 
<a name="l01788"></a>01788         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[a]= (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a]-mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a])/(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>-4);
<a name="l01789"></a>01789         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a] -= 2.1f*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[a];
<a name="l01790"></a>01790         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a] += 2.1f*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[a];
<a name="l01791"></a>01791 
<a name="l01792"></a>01792         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[a]= (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af3de206552039640e82099bbb61bdebd">max</a>[a]-mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>[a])/mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>;
<a name="l01793"></a>01793         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a841558c07ef83fb95106b445b98ef057">halfwidth</a>[a]= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[a]*0.5f;
<a name="l01794"></a>01794     }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#aa8ada5c6c2c3e62c618f290caf40a61d">progress_bar</a>(0, <span class="stringliteral">&quot;Setting up mesh deform system&quot;</span>);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     totinside= 0;
<a name="l01799"></a>01799     <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>; a++) {
<a name="l01800"></a>01800         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>[a]);
<a name="l01801"></a>01801         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>[a]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a31a80c997257eca2456fb9354af4dfcb">meshdeform_inside_cage</a>(mdb, vec);
<a name="l01802"></a>01802         <span class="keywordflow">if</span> (mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>[a])
<a name="l01803"></a>01803             totinside++;
<a name="l01804"></a>01804     }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     <span class="comment">/* free temporary MDefBoundIsects */</span>
<a name="l01807"></a>01807     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>);
<a name="l01808"></a>01808     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(<a class="code" href="../../da/db3/BLI__memarena_8h.html#a67cb65f5004785f8cf779c18615df155">BLI_MEMARENA_STD_BUFSIZE</a>, <span class="stringliteral">&quot;harmonic coords arena&quot;</span>);
<a name="l01809"></a>01809 
<a name="l01810"></a>01810     <span class="comment">/* start with all cells untyped */</span>
<a name="l01811"></a>01811     <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; a++)
<a name="l01812"></a>01812         mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>[a]= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abea462ffbeacfca837ec84b1fae0a8ab">MESHDEFORM_TAG_UNTYPED</a>;
<a name="l01813"></a>01813     
<a name="l01814"></a>01814     <span class="comment">/* detect intersections and tag boundary cells */</span>
<a name="l01815"></a>01815     for (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01816"></a>01816         <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01817"></a>01817             <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01818"></a>01818                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a6e6359718d85261ab23d386a47d4c46b">meshdeform_add_intersections</a>(mdb, x, y, z);
<a name="l01819"></a>01819 
<a name="l01820"></a>01820     <span class="comment">/* compute exterior and interior tags */</span>
<a name="l01821"></a>01821     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a0817737644316d4f19d49878844266ee">meshdeform_bind_floodfill</a>(mdb);
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     <span class="keywordflow">for</span> (z=0; z&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; z++)
<a name="l01824"></a>01824         <span class="keywordflow">for</span> (y=0; y&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; y++)
<a name="l01825"></a>01825             <span class="keywordflow">for</span> (x=0; x&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>; x++)
<a name="l01826"></a>01826                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac4d3d3fd0e7b9e56e45a37ddce950a68">meshdeform_check_semibound</a>(mdb, x, y, z);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828     <span class="comment">/* solve */</span>
<a name="l01829"></a>01829     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a5dca39df7cd632f29df7c67d3259f368">meshdeform_matrix_solve</a>(mmd, mdb);
<a name="l01830"></a>01830 
<a name="l01831"></a>01831     <span class="comment">/* assign results */</span>
<a name="l01832"></a>01832     <span class="keywordflow">if</span> (mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#ac8dc3e1427530f9c65d2425d90bbba92">flag</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a673ecdb7c96a65d4a05b664d502220fe">MOD_MDEF_DYNAMIC_BIND</a>) {
<a name="l01833"></a>01833         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#adc358c07a8bcdd723892f1175004637c">totinfluence</a>= 0;
<a name="l01834"></a>01834         <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; a++)
<a name="l01835"></a>01835             <span class="keywordflow">for</span> (inf=mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>[a]; inf; inf=inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#a5187dabee246a52ecccea588cf306582">next</a>)
<a name="l01836"></a>01836                 mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#adc358c07a8bcdd723892f1175004637c">totinfluence</a>++;
<a name="l01837"></a>01837 
<a name="l01838"></a>01838         <span class="comment">/* convert MDefBindInfluences to smaller MDefInfluences */</span>
<a name="l01839"></a>01839         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a8525ae4d16c10f3f37a3bc1a5f46fa36">dyngrid</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d4a/structMDefCell.html">MDefCell</a>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>, <span class="stringliteral">&quot;MDefDynGrid&quot;</span>);
<a name="l01840"></a>01840         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a89f5f33ad3c86ea029ddec13a578b11c">dyninfluences</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/dcd/structMDefInfluence.html">MDefInfluence</a>)*mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#adc358c07a8bcdd723892f1175004637c">totinfluence</a>, <span class="stringliteral">&quot;MDefInfluence&quot;</span>);
<a name="l01841"></a>01841         offset= 0;
<a name="l01842"></a>01842         <span class="keywordflow">for</span> (a=0; a&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a357707937d6ca38d1cfe80deef543b21">size3</a>; a++) {
<a name="l01843"></a>01843             cell= &amp;mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a8525ae4d16c10f3f37a3bc1a5f46fa36">dyngrid</a>[a];
<a name="l01844"></a>01844             cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#a08e9d9145db2452aa3398c38b6f27e7f">offset</a>= offset;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846             totweight= 0.0f;
<a name="l01847"></a>01847             mdinf= mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a89f5f33ad3c86ea029ddec13a578b11c">dyninfluences</a> + cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#a08e9d9145db2452aa3398c38b6f27e7f">offset</a>;
<a name="l01848"></a>01848             <span class="keywordflow">for</span> (inf=mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>[a]; inf; inf=inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#a5187dabee246a52ecccea588cf306582">next</a>, mdinf++) {
<a name="l01849"></a>01849                 mdinf-&gt;<a class="code" href="../../db/dcd/structMDefInfluence.html#aaa9249068891f3e4471dd34a93768b62">weight</a>= inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#ac47ab0da8cd1b7c9a115d0e4c9f44d36">weight</a>;
<a name="l01850"></a>01850                 mdinf-&gt;<a class="code" href="../../db/dcd/structMDefInfluence.html#aca2cd0cc910f15c2c24860e48783132d">vertex</a>= inf-&gt;<a class="code" href="../../dc/deb/structMDefBindInfluence.html#afd7e199edb269f2d863db6e23a348a6e">vertex</a>;
<a name="l01851"></a>01851                 totweight += mdinf-&gt;<a class="code" href="../../db/dcd/structMDefInfluence.html#aaa9249068891f3e4471dd34a93768b62">weight</a>;
<a name="l01852"></a>01852                 cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#afbdb8b6dc82524f070cf8533fea2f19e">totinfluence</a>++;
<a name="l01853"></a>01853             }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855             <span class="keywordflow">if</span> (totweight &gt; 0.0f) {
<a name="l01856"></a>01856                 mdinf= mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a89f5f33ad3c86ea029ddec13a578b11c">dyninfluences</a> + cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#a08e9d9145db2452aa3398c38b6f27e7f">offset</a>;
<a name="l01857"></a>01857                 <span class="keywordflow">for</span> (b=0; b&lt;cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#afbdb8b6dc82524f070cf8533fea2f19e">totinfluence</a>; b++, mdinf++)
<a name="l01858"></a>01858                     mdinf-&gt;<a class="code" href="../../db/dcd/structMDefInfluence.html#aaa9249068891f3e4471dd34a93768b62">weight</a> /= totweight;
<a name="l01859"></a>01859             }
<a name="l01860"></a>01860 
<a name="l01861"></a>01861             offset += cell-&gt;<a class="code" href="../../d1/d4a/structMDefCell.html#afbdb8b6dc82524f070cf8533fea2f19e">totinfluence</a>;
<a name="l01862"></a>01862         }
<a name="l01863"></a>01863 
<a name="l01864"></a>01864         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#ad133406450f26edd932ce27d482c246f">dynverts</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>;
<a name="l01865"></a>01865         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a4239efb94351352a15aa8dd67568a803">dyngridsize</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8c30fbcdf6cf7d6c78613a12e6a63005">size</a>;
<a name="l01866"></a>01866         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#ab48ee942904d51fa534abe1b889b1410">dyncellmin</a>, mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a06966f582e1a92b1d2bd504917ce474b">min</a>);
<a name="l01867"></a>01867         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a3579dc6c8fa0ae0e624923cccfc537dd">dyncellwidth</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab17695ac15b41e2602a5f4c2cd4330cb">width</a>[0];
<a name="l01868"></a>01868         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad46fad35bc28842654f54fb4af086305">dyngrid</a>);
<a name="l01869"></a>01869     }
<a name="l01870"></a>01870     <span class="keywordflow">else</span> {
<a name="l01871"></a>01871         mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a210a992ff7e6b09d721b7998fd929b81">bindweights</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>;
<a name="l01872"></a>01872         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#adc2b1c51cb8153becdaa2091299b05b1">inside</a>);
<a name="l01873"></a>01873     }
<a name="l01874"></a>01874 
<a name="l01875"></a>01875     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a1576d7c7024d2a4e62f1e19460600913">tag</a>);
<a name="l01876"></a>01876     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#af58f21801ebc7d7d6446d679988d2197">phi</a>);
<a name="l01877"></a>01877     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a993f9fbf03bf922dc6f0e1b9045828bc">totalphi</a>);
<a name="l01878"></a>01878     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8818c84d9c6cf8ace9e8c89a7142112e">boundisect</a>);
<a name="l01879"></a>01879     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2b2b88dcbfcbe3e425b67f9bed193ecd">semibound</a>);
<a name="l01880"></a>01880     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5cf245f90e510c0f3b47fe16c509b72c">memarena</a>);
<a name="l01881"></a>01881 }
<a name="l01882"></a>01882 
<a name="l01883"></a>01883 <span class="preprocessor">#if 0</span>
<a name="l01884"></a>01884 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> heat_weighting_bind(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../de/df2/structMeshDeformModifierData.html">MeshDeformModifierData</a> *mmd, <a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> *mdb)
<a name="l01885"></a>01885 {
<a name="l01886"></a>01886     <a class="code" href="../../d1/d52/structLaplacianSystem.html">LaplacianSystem</a> *sys;
<a name="l01887"></a>01887     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm), *mf;
<a name="l01888"></a>01888     <span class="keywordtype">int</span> totvert= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01889"></a>01889     <span class="keywordtype">int</span> totface= dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01890"></a>01890     <span class="keywordtype">float</span> solution, weight;
<a name="l01891"></a>01891     <span class="keywordtype">int</span> a, tottri, j, thrownerror = 0;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>, <span class="stringliteral">&quot;MDefWeights&quot;</span>);
<a name="l01894"></a>01894 
<a name="l01895"></a>01895     <span class="comment">/* count triangles */</span>
<a name="l01896"></a>01896     <span class="keywordflow">for</span> (tottri=0, a=0, mf=mface; a&lt;totface; a++, mf++) {
<a name="l01897"></a>01897         tottri++;
<a name="l01898"></a>01898         <span class="keywordflow">if</span> (mf-&gt;v4) tottri++;
<a name="l01899"></a>01899     }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901     <span class="comment">/* create laplacian */</span>
<a name="l01902"></a>01902     sys = <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#abf26d701e853b86013a63d95a324cdb0">laplacian_system_construct_begin</a>(totvert, tottri, 1);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a750821c3250f51a65e6d7cd28cafd2fc">mface</a>= mface;
<a name="l01905"></a>01905     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a783ceb697fd7d54b75ea8beeb0b10c35">totface</a>= totface;
<a name="l01906"></a>01906     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#af8ac16e2f24fe720732f47c63a3bae2a">totvert</a>= totvert;
<a name="l01907"></a>01907     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a51b24613fa39b5e3bf937e3e8f26ae31">verts</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>;
<a name="l01908"></a>01908     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a230c271d51ab17c83292469e0e031613">source</a> = mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>;
<a name="l01909"></a>01909     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a644394694a6b90a6329facd73334d070">numsource</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>;
<a name="l01910"></a>01910 
<a name="l01911"></a>01911     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a4792f6eacbea734bbe1e62d31e28fcbb">heat_ray_tree_create</a>(sys);
<a name="l01912"></a>01912     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ab24782a44e167985c6018fcca5118a1b">heat_laplacian_create</a>(sys);
<a name="l01913"></a>01913 
<a name="l01914"></a>01914     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2b3b0db5b496a0d202fce1710e40134e">laplacian_system_construct_end</a>(sys);
<a name="l01915"></a>01915 
<a name="l01916"></a>01916     <span class="comment">/* compute weights per bone */</span>
<a name="l01917"></a>01917     <span class="keywordflow">for</span> (j=0; j&lt;mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>; j++) {
<a name="l01918"></a>01918         <span class="comment">/* fill right hand side */</span>
<a name="l01919"></a>01919         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#affdcec45c0ea4e75c659993318d13af8">laplacian_begin_solve</a>(sys, -1);
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++)
<a name="l01922"></a>01922             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9b80361c6824bd1855e2d932706e388d">heat_source_closest</a>(sys, a, j))
<a name="l01923"></a>01923                 <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a8589d00c548666c71b474ea08dd11f40">laplacian_add_right_hand_side</a>(sys, a,
<a name="l01924"></a>01924                     sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#a97aa968d997ff4e7ef47ffcd70335f39">H</a>[a]*sys-&gt;<a class="code" href="../../d1/d52/structLaplacianSystem.html#a25cb0f3742ca03a3e79fb804d6b63366">heat</a>.<a class="code" href="../../d0/d8a/structLaplacianSystem_1_1HeatWeighting.html#ad0b6c5fcc6e52f6024f518c90ea65ff4">p</a>[a]);
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         <span class="comment">/* solve */</span>
<a name="l01927"></a>01927         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a416f8661ace46f3299209d9e35c97f22">laplacian_system_solve</a>(sys)) {
<a name="l01928"></a>01928             <span class="comment">/* load solution into vertex groups */</span>
<a name="l01929"></a>01929             <span class="keywordflow">for</span> (a=0; a&lt;totvert; a++) {
<a name="l01930"></a>01930                 solution= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a051f912feff9a4f28df97ef41bb25179">laplacian_system_get_solution</a>(a);
<a name="l01931"></a>01931                 
<a name="l01932"></a>01932                 weight= <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a414eda95c62c3a33f764984a21a33b95">heat_limit_weight</a>(solution);
<a name="l01933"></a>01933                 <span class="keywordflow">if</span> (weight &gt; 0.0f)
<a name="l01934"></a>01934                     mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>[a*mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a> + j] = weight;
<a name="l01935"></a>01935             }
<a name="l01936"></a>01936         }
<a name="l01937"></a>01937         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!thrownerror) {
<a name="l01938"></a>01938             <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a94ab435a74040b5a63317747695e98cb">error</a>(<span class="stringliteral">&quot;Mesh Deform Heat Weighting:&quot;</span>
<a name="l01939"></a>01939                 <span class="stringliteral">&quot; failed to find solution for one or more vertices&quot;</span>);
<a name="l01940"></a>01940             thrownerror= 1;
<a name="l01941"></a>01941             <span class="keywordflow">break</span>;
<a name="l01942"></a>01942         }
<a name="l01943"></a>01943     }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945     <span class="comment">/* free */</span>
<a name="l01946"></a>01946     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ad8ca0bcfa145f518602a470396cc1093">heat_system_free</a>(sys);
<a name="l01947"></a>01947     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a16779167ca1af374ab37e28cc4e3f382">laplacian_system_delete</a>(sys);
<a name="l01948"></a>01948 
<a name="l01949"></a>01949     mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a210a992ff7e6b09d721b7998fd929b81">bindweights</a>= mdb-&gt;<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a8b18acb15ee1d2f418a0ca8218287473">weights</a>;
<a name="l01950"></a>01950 }
<a name="l01951"></a>01951 <span class="preprocessor">#endif</span>
<a name="l01952"></a>01952 <span class="preprocessor"></span>
<a name="l01953"></a><a class="code" href="../../d1/d98/ED__armature_8h.html#a837742ec0d558dfb273d323ac059dfae">01953</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a834b2d404055a782a8f8a4c314f0eb6f">mesh_deform_bind</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/df2/structMeshDeformModifierData.html">MeshDeformModifierData</a> *mmd, <span class="keywordtype">float</span> *vertexcos, <span class="keywordtype">int</span> totvert, <span class="keywordtype">float</span> cagemat[][4])
<a name="l01954"></a>01954 {
<a name="l01955"></a>01955     <a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a> mdb;
<a name="l01956"></a>01956     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l01957"></a>01957     <span class="keywordtype">int</span> a;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2ce45548122988eaa3d0b9ec7ecbdd7e">waitcursor</a>(1);
<a name="l01960"></a>01960     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a723320d7fc3c0775eccb9b4481732181">start_progress_bar</a>();
<a name="l01961"></a>01961 
<a name="l01962"></a>01962     memset(&amp;mdb, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../dc/ddf/structMeshDeformBind.html">MeshDeformBind</a>));
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     <span class="comment">/* get mesh and cage mesh */</span>
<a name="l01965"></a>01965     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totvert, <span class="stringliteral">&quot;MeshDeformCos&quot;</span>);
<a name="l01966"></a>01966     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>= totvert;
<a name="l01967"></a>01967     
<a name="l01968"></a>01968     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>= <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1becf00e42dabc8360b487414142b0ae">mesh_create_derived_no_deform</a>(scene, mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a0872f7919a2104e473f8ee2934cdbaf5">object</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01969"></a>01969     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>= mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>);
<a name="l01970"></a>01970     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>)*mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>, <span class="stringliteral">&quot;MeshDeformBindCos&quot;</span>);
<a name="l01971"></a>01971     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a02c5996144d1cab424e7c28213f4a054">cagemat</a>, cagemat);
<a name="l01972"></a>01972 
<a name="l01973"></a>01973     mvert= mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>);
<a name="l01974"></a>01974     <span class="keywordflow">for</span> (a=0; a&lt;mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>; a++)
<a name="l01975"></a>01975         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>[a], mvert[a].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l01976"></a>01976     <span class="keywordflow">for</span> (a=0; a&lt;mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>; a++)
<a name="l01977"></a>01977         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>[a], mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a02c5996144d1cab424e7c28213f4a054">cagemat</a>, vertexcos + a*3);
<a name="l01978"></a>01978 
<a name="l01979"></a>01979     <span class="comment">/* solve */</span>
<a name="l01980"></a>01980 <span class="preprocessor">#if 0</span>
<a name="l01981"></a>01981 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#ad50bd3b36bf093769bf2dd2c3e587034">mode</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#aba62be9053ec6b72e8468da4917258b8">MOD_MDEF_VOLUME</a>)
<a name="l01982"></a>01982         <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9a745d41a97ae5fe4ccbc0f4fad330fe">harmonic_coordinates_bind</a>(scene, mmd, &amp;mdb);
<a name="l01983"></a>01983     <span class="keywordflow">else</span>
<a name="l01984"></a>01984         heat_weighting_bind(scene, dm, mmd, &amp;mdb);
<a name="l01985"></a>01985 <span class="preprocessor">#else</span>
<a name="l01986"></a>01986 <span class="preprocessor"></span>    <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a9a745d41a97ae5fe4ccbc0f4fad330fe">harmonic_coordinates_bind</a>(scene, mmd, &amp;mdb);
<a name="l01987"></a>01987 <span class="preprocessor">#endif</span>
<a name="l01988"></a>01988 <span class="preprocessor"></span>
<a name="l01989"></a>01989     <span class="comment">/* assign bind variables */</span>
<a name="l01990"></a>01990     mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#af2857fb00435f5809c4ab37c1e3a7281">bindcagecos</a>= (<span class="keywordtype">float</span>*)mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ab20822ac83aecf5cd767f96038f6763c">cagecos</a>;
<a name="l01991"></a>01991     mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a51bc7f19643fa62c74841cdcc5a2ea2c">totvert</a>= mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#ad86b3793cd47b98d604f09280580b04e">totvert</a>;
<a name="l01992"></a>01992     mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a8d21a0e3e8f264d0a9bbf406a134a46d">totcagevert</a>= mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>;
<a name="l01993"></a>01993     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#afd19a27af793c30a00cc7b86aa32fea1">bindmat</a>, mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a0872f7919a2104e473f8ee2934cdbaf5">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01994"></a>01994 
<a name="l01995"></a>01995     <span class="comment">/* transform bindcagecos to world space */</span>
<a name="l01996"></a>01996     <span class="keywordflow">for</span> (a=0; a&lt;mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a2d2fc6d29d9b26f47eb3bc64d4ab2174">totcagevert</a>; a++)
<a name="l01997"></a>01997         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#a0872f7919a2104e473f8ee2934cdbaf5">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, mmd-&gt;<a class="code" href="../../de/df2/structMeshDeformModifierData.html#af2857fb00435f5809c4ab37c1e3a7281">bindcagecos</a>+a*3);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999     <span class="comment">/* free */</span>
<a name="l02000"></a>02000     mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a660a1af1627c5daa545915a277465a95">cagedm</a>);
<a name="l02001"></a>02001     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mdb.<a class="code" href="../../dc/ddf/structMeshDeformBind.html#a5982491b939e857c002282607729864f">vertexcos</a>);
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <span class="comment">/* compact weights */</span>
<a name="l02004"></a>02004     <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#add0fe1275f3dc882cc09a8ab3fc31b49">modifier_mdef_compact_influences</a>((<a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a>*)mmd);
<a name="l02005"></a>02005 
<a name="l02006"></a>02006     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#ac304804d3114f6e1dfe518e7387af7b8">end_progress_bar</a>();
<a name="l02007"></a>02007     <a class="code" href="../../d1/d2b/meshlaplacian_8c.html#a2ce45548122988eaa3d0b9ec7ecbdd7e">waitcursor</a>(0);
<a name="l02008"></a>02008 }
<a name="l02009"></a>02009 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:33 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
