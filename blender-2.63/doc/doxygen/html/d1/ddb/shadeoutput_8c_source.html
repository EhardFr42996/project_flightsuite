<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: shadeoutput.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">shadeoutput.c</div>  </div>
</div>
<div class="contents">
<a href="../../d1/ddb/shadeoutput_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2006 Blender Foundation</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributors: Hos, Robert Wenzlaff.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/dca/BKE__colortools_8h.html">BKE_colortools.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">/* local include */</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d3a/occlusion_8h.html">occlusion.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db3/pixelblending_8h.html">pixelblending.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d59/sss_8h.html">sss.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span> <span class="comment">/* own include */</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00061"></a>00061 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00062"></a>00062 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00063"></a>00063 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00064"></a>00064 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ac6e0874e641a01ebbd1549300a519d8f">00066</a> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d3d/shading_8h.html#a46ae421aea9ade2d89bbc79729d11438">get_lights</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     
<a name="l00069"></a>00069     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.scemode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad40c9887f83dc3ac92440b0895ae2413">R_PREVIEWBUTS</a>)
<a name="l00070"></a>00070         <span class="keywordflow">return</span> &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights;
<a name="l00071"></a>00071     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>)
<a name="l00072"></a>00072         <span class="keywordflow">return</span> &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>-&gt;<a class="code" href="../../d4/d91/structGroup.html#ad757bf69b6fd15b1d4e0980089d13be1">gobject</a>;
<a name="l00073"></a>00073     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a67df82e791d0a7e8d62425b4d2cbc364">group</a>)
<a name="l00074"></a>00074         <span class="keywordflow">return</span> &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a67df82e791d0a7e8d62425b4d2cbc364">group</a>-&gt;<a class="code" href="../../d4/d91/structGroup.html#ad757bf69b6fd15b1d4e0980089d13be1">gobject</a>;
<a name="l00075"></a>00075     
<a name="l00076"></a>00076     <span class="keywordflow">return</span> &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights;
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#if 0</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> fogcolor(<span class="keywordtype">float</span> *colf, <span class="keywordtype">float</span> *rco, <span class="keywordtype">float</span> *view)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <span class="keywordtype">float</span> alpha, stepsize, startdist, dist, hor[4], zen[3], vec[3], dview[3];
<a name="l00083"></a>00083     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>=0.0f, distfac;
<a name="l00084"></a>00084     
<a name="l00085"></a>00085     hor[0]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr; hor[1]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horg; hor[2]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horb;
<a name="l00086"></a>00086     zen[0]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenr; zen[1]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zeng; zen[2]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.zenb;
<a name="l00087"></a>00087     
<a name="l00088"></a>00088     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, rco);
<a name="l00089"></a>00089     
<a name="l00090"></a>00090     <span class="comment">/* we loop from cur coord to mist start in steps */</span>
<a name="l00091"></a>00091     stepsize= 1.0f;
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     div= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae2f08dc603ae93c402abd918ba4e23e1">ABS</a>(view[2]);
<a name="l00094"></a>00094     dview[0]= view[0]/(stepsize*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l00095"></a>00095     dview[1]= view[1]/(stepsize*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>);
<a name="l00096"></a>00096     dview[2]= -stepsize;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     startdist= -rco[2] + <a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>();
<a name="l00099"></a>00099     <span class="keywordflow">for</span> (dist= startdist; dist&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.miststa; dist-= stepsize) {
<a name="l00100"></a>00100         
<a name="l00101"></a>00101         hor[0]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horr; hor[1]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horg; hor[2]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.horb;
<a name="l00102"></a>00102         alpha= 1.0f;
<a name="l00103"></a>00103         <a class="code" href="../../df/dba/texture_8h.html#a94cf83c880cf8e294c05af423bf2624e">do_sky_tex</a>(vec, vec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, hor, zen, &amp;alpha);
<a name="l00104"></a>00104         
<a name="l00105"></a>00105         distfac= (dist-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.miststa)/<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mistdist;
<a name="l00106"></a>00106         
<a name="l00107"></a>00107         hor[3]= hor[0]*distfac*distfac;
<a name="l00108"></a>00108         
<a name="l00109"></a>00109         <span class="comment">/* premul! */</span>
<a name="l00110"></a>00110         alpha= hor[3];
<a name="l00111"></a>00111         hor[0]= hor[0]*alpha;
<a name="l00112"></a>00112         hor[1]= hor[1]*alpha;
<a name="l00113"></a>00113         hor[2]= hor[2]*alpha;
<a name="l00114"></a>00114         <a class="code" href="../../d2/db3/pixelblending_8h.html#a6e23ebb88a8731ac72aa7cc3ad55844f">addAlphaOverFloat</a>(colf, hor);
<a name="l00115"></a>00115         
<a name="l00116"></a>00116         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vec, dview);
<a name="l00117"></a>00117     }   
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 <span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121 <span class="comment">/* zcor is distance, co the 3d coordinate in eye space, return alpha */</span>
<a name="l00122"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a8006e73ad12c4303dc31429f7b1f2688">00122</a> <span class="keywordtype">float</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#ae00f1b73fedea87dea90430cc5f98c6c">mistfactor</a>(<span class="keywordtype">float</span> zcor, <span class="keywordtype">float</span> <span class="keyword">const</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124     <span class="keywordtype">float</span> fac, hi;
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     fac= zcor - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.miststa; <span class="comment">/* zcor is calculated per pixel */</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="comment">/* fac= -co[2]-R.wrld.miststa; */</span>
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (fac&gt;0.0f) {
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (fac&lt; <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mistdist) {
<a name="l00132"></a>00132             
<a name="l00133"></a>00133             fac= (fac/(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mistdist));
<a name="l00134"></a>00134             
<a name="l00135"></a>00135             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mistype==0) fac*= fac;
<a name="l00136"></a>00136             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mistype==1);
<a name="l00137"></a>00137             <span class="keywordflow">else</span> fac= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(fac);
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139         <span class="keywordflow">else</span> fac= 1.0f;
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141     <span class="keywordflow">else</span> fac= 0.0f;
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     <span class="comment">/* height switched off mist */</span>
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.misthi!=0.0f &amp;&amp; fac!=0.0f) {
<a name="l00145"></a>00145         <span class="comment">/* at height misthi the mist is completely gone */</span>
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         hi= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv[0][2]*co[0]+<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv[1][2]*co[1]+<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv[2][2]*co[2]+<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewinv[3][2];
<a name="l00148"></a>00148         
<a name="l00149"></a>00149         <span class="keywordflow">if</span> (hi&gt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.misthi) fac= 0.0f;
<a name="l00150"></a>00150         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hi&gt;0.0f) {
<a name="l00151"></a>00151             hi= (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.misthi-hi)/<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.misthi;
<a name="l00152"></a>00152             fac*= hi*hi;
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="keywordflow">return</span> (1.0f-fac)* (1.0f-<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.misi);  
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a7218d492ff90c861b84c4cf141a493d9">00159</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a7218d492ff90c861b84c4cf141a493d9">spothalo</a>(<span class="keyword">struct</span> <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> *intens)
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     <span class="keywordtype">double</span> a, b, c, disc, nray[3], npos[3];
<a name="l00162"></a>00162     <span class="keywordtype">double</span> t0, t1 = 0.0f, t2= 0.0f, t3;
<a name="l00163"></a>00163     <span class="keywordtype">float</span> p1[3], p2[3], ladist, maxz = 0.0f, maxy = 0.0f, haint;
<a name="l00164"></a>00164     <span class="keywordtype">int</span> snijp, doclip=1, use_yco=0;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     *intens= 0.0f;
<a name="l00167"></a>00167     haint= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a48596cd2e91be96f0b3ae173e92aef64">haint</a>;
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad1461325b45cf05ec52533e0b5fc9c5b">R_ORTHO</a>) {
<a name="l00170"></a>00170         <span class="comment">/* camera pos (view vector) cannot be used... */</span>
<a name="l00171"></a>00171         <span class="comment">/* camera position (cox,coy,0) rotate around lamp */</span>
<a name="l00172"></a>00172         p1[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0];
<a name="l00173"></a>00173         p1[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1];
<a name="l00174"></a>00174         p1[2]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2];
<a name="l00175"></a>00175         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, p1);
<a name="l00176"></a>00176         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aa82cba6d952e03b608bafb91f38ec937">copy_v3db_v3fl</a>(npos, p1);   <span class="comment">// npos is double!</span>
<a name="l00177"></a>00177         
<a name="l00178"></a>00178         <span class="comment">/* pre-scale */</span>
<a name="l00179"></a>00179         npos[2] *= (double)lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l00180"></a>00180     }
<a name="l00181"></a>00181     <span class="keywordflow">else</span> {
<a name="l00182"></a>00182         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aa82cba6d952e03b608bafb91f38ec937">copy_v3db_v3fl</a>(npos, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>);    <span class="comment">/* in initlamp calculated */</span>
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184     
<a name="l00185"></a>00185     <span class="comment">/* rotate view */</span>
<a name="l00186"></a>00186     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aa82cba6d952e03b608bafb91f38ec937">copy_v3db_v3fl</a>(nray, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00187"></a>00187     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a920354d8c36cc89ae81794020a6190c6">mul_m3_v3_double</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, nray);
<a name="l00188"></a>00188     
<a name="l00189"></a>00189     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a91bffe0ae7ebf43c052eaf29fddd42bf">WO_MIST</a>) {
<a name="l00190"></a>00190         <span class="comment">/* patchy... */</span>
<a name="l00191"></a>00191         haint *= <a class="code" href="../../d0/d0e/rendercore_8h.html#ae00f1b73fedea87dea90430cc5f98c6c">mistfactor</a>(-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2], lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (haint==0.0f) {
<a name="l00193"></a>00193             <span class="keywordflow">return</span>;
<a name="l00194"></a>00194         }
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <span class="comment">/* rotate maxz */</span>
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]==0.0f) doclip= 0;    <span class="comment">/* for when halo at sky */</span>
<a name="l00200"></a>00200     <span class="keywordflow">else</span> {
<a name="l00201"></a>00201         p1[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0];
<a name="l00202"></a>00202         p1[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1];
<a name="l00203"></a>00203         p1[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2];
<a name="l00204"></a>00204     
<a name="l00205"></a>00205         maxz= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[0][2]*p1[0]+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[1][2]*p1[1]+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[2][2]*p1[2];
<a name="l00206"></a>00206         maxz*= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l00207"></a>00207         maxy= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[0][1]*p1[0]+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[1][1]*p1[1]+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>[2][1]*p1[2];
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(nray[2]) &lt; FLT_EPSILON ) use_yco= 1;
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     
<a name="l00212"></a>00212     <span class="comment">/* scale z to make sure volume is normalized */</span> 
<a name="l00213"></a>00213     nray[2] *= (double)lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l00214"></a>00214     <span class="comment">/* nray does not need normalization */</span>
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     ladist= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>;
<a name="l00217"></a>00217     
<a name="l00218"></a>00218     <span class="comment">/* solve */</span>
<a name="l00219"></a>00219     a = nray[0] * nray[0] + nray[1] * nray[1] - nray[2]*nray[2];
<a name="l00220"></a>00220     b = nray[0] * npos[0] + nray[1] * npos[1] - nray[2]*npos[2];
<a name="l00221"></a>00221     c = npos[0] * npos[0] + npos[1] * npos[1] - npos[2]*npos[2];
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     snijp= 0;
<a name="l00224"></a>00224     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(a) &lt; DBL_EPSILON) {
<a name="l00225"></a>00225         <span class="comment">/*</span>
<a name="l00226"></a>00226 <span class="comment">         * Only one intersection point...</span>
<a name="l00227"></a>00227 <span class="comment">         */</span>
<a name="l00228"></a>00228         <span class="keywordflow">return</span>;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="keywordflow">else</span> {
<a name="l00231"></a>00231         disc = b*b - a*c;
<a name="l00232"></a>00232         
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (disc==0.0) {
<a name="l00234"></a>00234             t1=t2= (-b)/ a;
<a name="l00235"></a>00235             snijp= 2;
<a name="l00236"></a>00236         }
<a name="l00237"></a>00237         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (disc &gt; 0.0) {
<a name="l00238"></a>00238             disc = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(disc);
<a name="l00239"></a>00239             t1 = (-b + disc) / a;
<a name="l00240"></a>00240             t2 = (-b - disc) / a;
<a name="l00241"></a>00241             snijp= 2;
<a name="l00242"></a>00242         }
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (snijp==2) {
<a name="l00245"></a>00245         <span class="keywordtype">int</span> ok1=0, ok2=0;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         <span class="comment">/* sort */</span>
<a name="l00248"></a>00248         <span class="keywordflow">if</span> (t1&gt;t2) {
<a name="l00249"></a>00249             a= t1; t1= t2; t2= a;
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">/* z of intersection points with diabolo */</span>
<a name="l00253"></a>00253         p1[2]= npos[2] + t1*nray[2];
<a name="l00254"></a>00254         p2[2]= npos[2] + t2*nray[2];
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">/* evaluate both points */</span>
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (p1[2]&lt;=0.0f) ok1= 1;
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (p2[2]&lt;=0.0f &amp;&amp; t1!=t2) ok2= 1;
<a name="l00259"></a>00259         
<a name="l00260"></a>00260         <span class="comment">/* at least 1 point with negative z */</span>
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (ok1==0 &amp;&amp; ok2==0) <span class="keywordflow">return</span>;
<a name="l00262"></a>00262         
<a name="l00263"></a>00263         <span class="comment">/* intersction point with -ladist, the bottom of the cone */</span>
<a name="l00264"></a>00264         <span class="keywordflow">if</span> (use_yco==0) {
<a name="l00265"></a>00265             t3= ((double)(-ladist)-npos[2])/nray[2];
<a name="l00266"></a>00266                 
<a name="l00267"></a>00267             <span class="comment">/* de we have to replace one of the intersection points? */</span>
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (ok1) {
<a name="l00269"></a>00269                 <span class="keywordflow">if</span> (p1[2]&lt;-ladist) t1= t3;
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271             <span class="keywordflow">else</span> {
<a name="l00272"></a>00272                 t1= t3;
<a name="l00273"></a>00273             }
<a name="l00274"></a>00274             <span class="keywordflow">if</span> (ok2) {
<a name="l00275"></a>00275                 <span class="keywordflow">if</span> (p2[2]&lt;-ladist) t2= t3;
<a name="l00276"></a>00276             }
<a name="l00277"></a>00277             <span class="keywordflow">else</span> {
<a name="l00278"></a>00278                 t2= t3;
<a name="l00279"></a>00279             }
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ok1==0 || ok2==0) <span class="keywordflow">return</span>;
<a name="l00282"></a>00282         
<a name="l00283"></a>00283         <span class="comment">/* at least 1 visible interesction point */</span>
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (t1&lt;0.0 &amp;&amp; t2&lt;0.0) <span class="keywordflow">return</span>;
<a name="l00285"></a>00285         
<a name="l00286"></a>00286         <span class="keywordflow">if</span> (t1&lt;0.0) t1= 0.0;
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (t2&lt;0.0) t2= 0.0;
<a name="l00288"></a>00288         
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (t1==t2) <span class="keywordflow">return</span>;
<a name="l00290"></a>00290         
<a name="l00291"></a>00291         <span class="comment">/* sort again to be sure */</span>
<a name="l00292"></a>00292         <span class="keywordflow">if</span> (t1&gt;t2) {
<a name="l00293"></a>00293             a= t1; t1= t2; t2= a;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295         
<a name="l00296"></a>00296         <span class="comment">/* calculate t0: is the maximum visible z (when halo is intersected by face) */</span> 
<a name="l00297"></a>00297         <span class="keywordflow">if</span> (doclip) {
<a name="l00298"></a>00298             <span class="keywordflow">if</span> (use_yco==0) t0= (maxz-npos[2])/nray[2];
<a name="l00299"></a>00299             <span class="keywordflow">else</span> t0= (maxy-npos[1])/nray[1];
<a name="l00300"></a>00300 
<a name="l00301"></a>00301             <span class="keywordflow">if</span> (t0&lt;t1) <span class="keywordflow">return</span>;
<a name="l00302"></a>00302             <span class="keywordflow">if</span> (t0&lt;t2) t2= t0;
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="comment">/* calc points */</span>
<a name="l00306"></a>00306         p1[0]= npos[0] + t1*nray[0];
<a name="l00307"></a>00307         p1[1]= npos[1] + t1*nray[1];
<a name="l00308"></a>00308         p1[2]= npos[2] + t1*nray[2];
<a name="l00309"></a>00309         p2[0]= npos[0] + t2*nray[0];
<a name="l00310"></a>00310         p2[1]= npos[1] + t2*nray[1];
<a name="l00311"></a>00311         p2[2]= npos[2] + t2*nray[2];
<a name="l00312"></a>00312         
<a name="l00313"></a>00313             
<a name="l00314"></a>00314         <span class="comment">/* now we have 2 points, make three lengths with it */</span>
<a name="l00315"></a>00315         
<a name="l00316"></a>00316         a= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(p1[0]*p1[0]+p1[1]*p1[1]+p1[2]*p1[2]);
<a name="l00317"></a>00317         b= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(p2[0]*p2[0]+p2[1]*p2[1]+p2[2]*p2[2]);
<a name="l00318"></a>00318         c= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(p1, p2);
<a name="l00319"></a>00319         
<a name="l00320"></a>00320         a/= ladist;
<a name="l00321"></a>00321         a= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(a);
<a name="l00322"></a>00322         b/= ladist; 
<a name="l00323"></a>00323         b= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(b);
<a name="l00324"></a>00324         c/= ladist;
<a name="l00325"></a>00325         
<a name="l00326"></a>00326         *intens= c*( (1.0-a)+(1.0-b) );
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="comment">/* WATCH IT: do not clip a,b en c at 1.0, this gives nasty little overflows</span>
<a name="l00329"></a>00329 <span class="comment">         * at the edges (especially with narrow halos) */</span>
<a name="l00330"></a>00330         <span class="keywordflow">if</span> (*intens&lt;=0.0f) <span class="keywordflow">return</span>;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">/* soft area */</span>
<a name="l00333"></a>00333         <span class="comment">/* not needed because t0 has been used for p1/p2 as well */</span>
<a name="l00334"></a>00334         <span class="comment">/* if (doclip &amp;&amp; t0&lt;t2) { */</span>
<a name="l00335"></a>00335         <span class="comment">/*  *intens *= (t0-t1)/(t2-t1); */</span>
<a name="l00336"></a>00336         <span class="comment">/* } */</span>
<a name="l00337"></a>00337         
<a name="l00338"></a>00338         *intens *= haint;
<a name="l00339"></a>00339         
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>) {
<a name="l00341"></a>00341             *intens *= <a class="code" href="../../d9/d30/shadbuf_8h.html#af781091a3e773a0c4d5931ed41850215">shadow_halo</a>(lar, p1, p2);
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343         
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a5e33a93b94b324bc0a0393296ef6e048">00347</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d0e/rendercore_8h.html#aa7c1b51d185daf95ec184d43789000db">renderspothalo</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> col[4], <span class="keywordtype">float</span> alpha)
<a name="l00348"></a>00348 {
<a name="l00349"></a>00349     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>;
<a name="l00350"></a>00350     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l00351"></a>00351     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00352"></a>00352     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00353"></a>00353     
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (alpha==0.0f) <span class="keywordflow">return</span>;
<a name="l00355"></a>00355     
<a name="l00356"></a>00356     lights= <a class="code" href="../../da/d3d/shading_8h.html#a46ae421aea9ade2d89bbc79729d11438">get_lights</a>(shi);
<a name="l00357"></a>00357     <span class="keywordflow">for</span> (go=lights-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l00358"></a>00358         lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (lar==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l00360"></a>00360         
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a> &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a66b81fd98d8f8b3dc52a71f8791a73a9">LA_HALO</a>) &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a> != <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3cbc315c04ee863dd6824193d617381e">LA_SHADBUF_DEEP</a>) &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a48596cd2e91be96f0b3ae173e92aef64">haint</a>&gt;0) {
<a name="l00362"></a>00362             
<a name="l00363"></a>00363             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) 
<a name="l00364"></a>00364                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a> &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a>)==0) 
<a name="l00365"></a>00365                     <span class="keywordflow">continue</span>;
<a name="l00366"></a>00366             <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>)==0) 
<a name="l00367"></a>00367                 <span class="keywordflow">continue</span>;
<a name="l00368"></a>00368             
<a name="l00369"></a>00369             <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a7218d492ff90c861b84c4cf141a493d9">spothalo</a>(lar, shi, &amp;i);
<a name="l00370"></a>00370             <span class="keywordflow">if</span> (i&gt;0.0f) {
<a name="l00371"></a>00371                 col[3]+= i*alpha;           <span class="comment">// all premul</span>
<a name="l00372"></a>00372                 col[0]+= i*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a>*alpha;
<a name="l00373"></a>00373                 col[1]+= i*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac459abfab45ae7ccecdf626896763675">g</a>*alpha;
<a name="l00374"></a>00374                 col[2]+= i*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8df1307b7133d24f3a3b64a1e5eabf11">b</a>*alpha;    
<a name="l00375"></a>00375             }
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378     <span class="comment">/* clip alpha, is needed for unified &#39;alpha threshold&#39; (vanillaRenderPipe.c) */</span>
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (col[3]&gt;1.0f) col[3]= 1.0f;
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="comment">/* ---------------- shaders ----------------------- */</span>
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">00386</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(<span class="keywordtype">double</span> *n)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     <span class="keywordtype">double</span> d;
<a name="l00389"></a>00389     
<a name="l00390"></a>00390     d= n[0]*n[0]+n[1]*n[1]+n[2]*n[2];
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (d&gt;0.00000000000000001) {
<a name="l00393"></a>00393         d= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(d);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         n[0]/=d; 
<a name="l00396"></a>00396         n[1]/=d; 
<a name="l00397"></a>00397         n[2]/=d;
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399     <span class="keywordflow">else</span> {
<a name="l00400"></a>00400         n[0]=n[1]=n[2]= 0.0;
<a name="l00401"></a>00401         d= 0.0;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403     <span class="keywordflow">return</span> d;
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406 <span class="comment">/* mix of &#39;real&#39; fresnel and allowing control. grad defines blending gradient */</span>
<a name="l00407"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3d59007b33831784e67aa077b7e8d302">00407</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(<span class="keywordtype">float</span> *view, <span class="keywordtype">float</span> *vn, <span class="keywordtype">float</span> <a class="code" href="../../df/d5a/svm__noise_8h.html#a24def295b818c408edc87331ff9f3544">grad</a>, <span class="keywordtype">float</span> fac)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="keywordtype">float</span> t1, t2;
<a name="l00410"></a>00410     
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (fac==0.0f) <span class="keywordflow">return</span> 1.0f;
<a name="l00412"></a>00412     
<a name="l00413"></a>00413     t1= (view[0]*vn[0] + view[1]*vn[1] + view[2]*vn[2]);
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (t1&gt;0.0f)  t2= 1.0f+t1;
<a name="l00415"></a>00415     <span class="keywordflow">else</span> t2= 1.0f-t1;
<a name="l00416"></a>00416     
<a name="l00417"></a>00417     t2= grad + (1.0f-<a class="code" href="../../df/d5a/svm__noise_8h.html#a24def295b818c408edc87331ff9f3544">grad</a>)*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(t2, fac);
<a name="l00418"></a>00418     
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (t2&lt;0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00420"></a>00420     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t2&gt;1.0f) <span class="keywordflow">return</span> 1.0f;
<a name="l00421"></a>00421     <span class="keywordflow">return</span> t2;
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">00424</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">saacos_d</a>(<span class="keywordtype">double</span> fac)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (fac&lt;= -1.0) <span class="keywordflow">return</span> <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00427"></a>00427     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac&gt;=1.0) <span class="keywordflow">return</span> 0.0;
<a name="l00428"></a>00428     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(fac);
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="comment">/* Stoke&#39;s form factor. Need doubles here for extreme small area sizes */</span>
<a name="l00432"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfbdf59102be73d6f1b90aa80d7470dd">00432</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfbdf59102be73d6f1b90aa80d7470dd">area_lamp_energy</a>(<span class="keywordtype">float</span> (*area)[3], <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *vn)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434     <span class="keywordtype">double</span> fac;
<a name="l00435"></a>00435     <span class="keywordtype">double</span> vec[4][3];   <span class="comment">/* vectors of rendered co to vertices lamp */</span>
<a name="l00436"></a>00436     <span class="keywordtype">double</span> <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[4][3]; <span class="comment">/* cross products of this */</span>
<a name="l00437"></a>00437     <span class="keywordtype">double</span> rad[4];      <span class="comment">/* angles between vecs */</span>
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4591acef5984747d729c56090e415039">VECSUB</a>(vec[0], co, area[0]);
<a name="l00440"></a>00440     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4591acef5984747d729c56090e415039">VECSUB</a>(vec[1], co, area[1]);
<a name="l00441"></a>00441     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4591acef5984747d729c56090e415039">VECSUB</a>(vec[2], co, area[2]);
<a name="l00442"></a>00442     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4591acef5984747d729c56090e415039">VECSUB</a>(vec[3], co, area[3]);
<a name="l00443"></a>00443     
<a name="l00444"></a>00444     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(vec[0]);
<a name="l00445"></a>00445     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(vec[1]);
<a name="l00446"></a>00446     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(vec[2]);
<a name="l00447"></a>00447     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(vec[3]);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="comment">/* cross product */</span>
<a name="l00450"></a>00450     <a class="code" href="../../d0/d0e/rendercore_8h.html#a5d72195057704ea63ed23ed333779b81">CROSS</a>(cross[0], vec[0], vec[1]);
<a name="l00451"></a>00451     <a class="code" href="../../d0/d0e/rendercore_8h.html#a5d72195057704ea63ed23ed333779b81">CROSS</a>(cross[1], vec[1], vec[2]);
<a name="l00452"></a>00452     <a class="code" href="../../d0/d0e/rendercore_8h.html#a5d72195057704ea63ed23ed333779b81">CROSS</a>(cross[2], vec[2], vec[3]);
<a name="l00453"></a>00453     <a class="code" href="../../d0/d0e/rendercore_8h.html#a5d72195057704ea63ed23ed333779b81">CROSS</a>(cross[3], vec[3], vec[0]);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(cross[0]);
<a name="l00456"></a>00456     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(cross[1]);
<a name="l00457"></a>00457     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(cross[2]);
<a name="l00458"></a>00458     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aafbc184c29e15cde9cc0fcef0c2f8e86">Normalize_d</a>(cross[3]);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="comment">/* angles */</span>
<a name="l00461"></a>00461     rad[0]= vec[0][0]*vec[1][0]+ vec[0][1]*vec[1][1]+ vec[0][2]*vec[1][2];
<a name="l00462"></a>00462     rad[1]= vec[1][0]*vec[2][0]+ vec[1][1]*vec[2][1]+ vec[1][2]*vec[2][2];
<a name="l00463"></a>00463     rad[2]= vec[2][0]*vec[3][0]+ vec[2][1]*vec[3][1]+ vec[2][2]*vec[3][2];
<a name="l00464"></a>00464     rad[3]= vec[3][0]*vec[0][0]+ vec[3][1]*vec[0][1]+ vec[3][2]*vec[0][2];
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     rad[0]= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">saacos_d</a>(rad[0]);
<a name="l00467"></a>00467     rad[1]= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">saacos_d</a>(rad[1]);
<a name="l00468"></a>00468     rad[2]= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">saacos_d</a>(rad[2]);
<a name="l00469"></a>00469     rad[3]= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3b9e51805940fbac48f92b3fcb288b88">saacos_d</a>(rad[3]);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471     <span class="comment">/* Stoke formula */</span>
<a name="l00472"></a>00472     fac=  rad[0]*(vn[0]*cross[0][0]+ vn[1]*cross[0][1]+ vn[2]*cross[0][2]);
<a name="l00473"></a>00473     fac+= rad[1]*(vn[0]*cross[1][0]+ vn[1]*cross[1][1]+ vn[2]*cross[1][2]);
<a name="l00474"></a>00474     fac+= rad[2]*(vn[0]*cross[2][0]+ vn[1]*cross[2][1]+ vn[2]*cross[2][2]);
<a name="l00475"></a>00475     fac+= rad[3]*(vn[0]*cross[3][0]+ vn[1]*cross[3][1]+ vn[2]*cross[3][2]);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (fac&lt;=0.0) <span class="keywordflow">return</span> 0.0;
<a name="l00478"></a>00478     <span class="keywordflow">return</span> fac;
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ab074251161b8c52cd77931c8ebf45952">00481</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ab074251161b8c52cd77931c8ebf45952">area_lamp_energy_multisample</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *vn)
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483     <span class="comment">/* corner vectors are moved around according lamp jitter */</span>
<a name="l00484"></a>00484     <span class="keywordtype">float</span> *jitlamp= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a748a8a5577feef6b154bb0323e567950">jitter</a>, vec[3];
<a name="l00485"></a>00485     <span class="keywordtype">float</span> area[4][3], intens= 0.0f;
<a name="l00486"></a>00486     <span class="keywordtype">int</span> a= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">/* test if co is behind lamp */</span>
<a name="l00489"></a>00489     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, co, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vec, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>) &lt; 0.0f)
<a name="l00491"></a>00491         <span class="keywordflow">return</span> 0.0f;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">while</span> (a--) {
<a name="l00494"></a>00494         vec[0]= jitlamp[0];
<a name="l00495"></a>00495         vec[1]= jitlamp[1];
<a name="l00496"></a>00496         vec[2]= 0.0f;
<a name="l00497"></a>00497         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a11358d16684d5922f50d2f104a4a937d">mat</a>, vec);
<a name="l00498"></a>00498         
<a name="l00499"></a>00499         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(area[0], lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[0], vec);
<a name="l00500"></a>00500         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(area[1], lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[1], vec);
<a name="l00501"></a>00501         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(area[2], lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[2], vec);
<a name="l00502"></a>00502         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(area[3], lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac3f24d6c772d6e36812201c512ef64a0">area</a>[3], vec);
<a name="l00503"></a>00503         
<a name="l00504"></a>00504         intens+= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfbdf59102be73d6f1b90aa80d7470dd">area_lamp_energy</a>(area, co, vn);
<a name="l00505"></a>00505         
<a name="l00506"></a>00506         jitlamp+= 2;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     intens /= (float)lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a94562e35b176cc6c96dc5050f369bfc7">ray_totsamp</a>;
<a name="l00509"></a>00509     
<a name="l00510"></a>00510     <span class="keywordflow">return</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(intens*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a936157286f093a91f329e44848983c82">areasize</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5bea0db868cd90a0df6c8550f6ea5471">k</a>);   <span class="comment">// corrected for buttons size and lar-&gt;dist^2</span>
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">00513</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>(<span class="keywordtype">float</span> inp, <span class="keywordtype">int</span> hard)  
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <span class="keywordtype">float</span> b1;
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     <span class="keywordflow">if</span> (inp&gt;=1.0f) <span class="keywordflow">return</span> 1.0f;
<a name="l00518"></a>00518     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inp&lt;=0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00519"></a>00519     
<a name="l00520"></a>00520     b1= inp*inp;
<a name="l00521"></a>00521     <span class="comment">/* avoid FPE */</span>
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (b1&lt;0.01f) b1= 0.01f;    
<a name="l00523"></a>00523     
<a name="l00524"></a>00524     <span class="keywordflow">if</span> ((hard &amp; 1)==0)  inp= 1.0f;
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (hard &amp; 2)  inp*= b1;
<a name="l00526"></a>00526     b1*= b1;
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (hard &amp; 4)  inp*= b1;
<a name="l00528"></a>00528     b1*= b1;
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (hard &amp; 8)  inp*= b1;
<a name="l00530"></a>00530     b1*= b1;
<a name="l00531"></a>00531     <span class="keywordflow">if</span> (hard &amp; 16) inp*= b1;
<a name="l00532"></a>00532     b1*= b1;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <span class="comment">/* avoid FPE */</span>
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (b1&lt;0.001f) b1= 0.0f;    
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (hard &amp; 32) inp*= b1;
<a name="l00538"></a>00538     b1*= b1;
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (hard &amp; 64) inp*=b1;
<a name="l00540"></a>00540     b1*= b1;
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (hard &amp; 128) inp*=b1;
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (b1&lt;0.001f) b1= 0.0f;    
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (hard &amp; 256) {
<a name="l00546"></a>00546         b1*= b1;
<a name="l00547"></a>00547         inp*=b1;
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     <span class="keywordflow">return</span> inp;
<a name="l00551"></a>00551 }
<a name="l00552"></a>00552 
<a name="l00553"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a19f6d2d3df87163f7b85f2fe8b36eb3a">00553</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a19f6d2d3df87163f7b85f2fe8b36eb3a">Phong_Spec</a>( <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">int</span> hard, <span class="keywordtype">int</span> tangent )
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <span class="keywordtype">float</span> h[3];
<a name="l00556"></a>00556     <span class="keywordtype">float</span> rslt;
<a name="l00557"></a>00557     
<a name="l00558"></a>00558     h[0] = l[0] + v[0];
<a name="l00559"></a>00559     h[1] = l[1] + v[1];
<a name="l00560"></a>00560     h[2] = l[2] + v[2];
<a name="l00561"></a>00561     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00562"></a>00562     
<a name="l00563"></a>00563     rslt = h[0]*n[0] + h[1]*n[1] + h[2]*n[2];
<a name="l00564"></a>00564     <span class="keywordflow">if</span> (tangent) rslt= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - rslt*rslt);
<a name="l00565"></a>00565         
<a name="l00566"></a>00566     <span class="keywordflow">if</span> ( rslt &gt; 0.0f ) rslt= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>(rslt, hard);
<a name="l00567"></a>00567     <span class="keywordflow">else</span> rslt = 0.0f;
<a name="l00568"></a>00568     
<a name="l00569"></a>00569     <span class="keywordflow">return</span> rslt;
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="comment">/* reduced cook torrance spec (for off-specular peak) */</span>
<a name="l00574"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#af03cf4e4af6e92d1af9f745c562db20b">00574</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#af03cf4e4af6e92d1af9f745c562db20b">CookTorr_Spec</a>(<span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">int</span> hard, <span class="keywordtype">int</span> tangent)
<a name="l00575"></a>00575 {
<a name="l00576"></a>00576     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, nh, nv, h[3];
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     h[0]= v[0]+l[0];
<a name="l00579"></a>00579     h[1]= v[1]+l[1];
<a name="l00580"></a>00580     h[2]= v[2]+l[2];
<a name="l00581"></a>00581     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     nh= n[0]*h[0]+n[1]*h[1]+n[2]*h[2];
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (tangent) nh= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nh*nh);
<a name="l00585"></a>00585     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nh&lt;0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00586"></a>00586     
<a name="l00587"></a>00587     nv= n[0]*v[0]+n[1]*v[1]+n[2]*v[2];
<a name="l00588"></a>00588     <span class="keywordflow">if</span> (tangent) nv= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nv*nv);
<a name="l00589"></a>00589     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nv&lt;0.0f) nv= 0.0f;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     i= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>(nh, hard);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     i= i/(0.1f+nv);
<a name="l00594"></a>00594     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">/* Blinn spec */</span>
<a name="l00598"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ac3e0cbc319d9ced77b8cb3bf37d8f500">00598</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ac3e0cbc319d9ced77b8cb3bf37d8f500">Blinn_Spec</a>(<span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> refrac, <span class="keywordtype">float</span> spec_power, <span class="keywordtype">int</span> tangent)
<a name="l00599"></a>00599 {
<a name="l00600"></a>00600     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, nh, nv, nl, vh, h[3];
<a name="l00601"></a>00601     <span class="keywordtype">float</span> a, b, c, <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>=0.0f, <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, f, ang;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (refrac &lt; 1.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00604"></a>00604     <span class="keywordflow">if</span> (spec_power == 0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00605"></a>00605     
<a name="l00606"></a>00606     <span class="comment">/* conversion from &#39;hardness&#39; (1-255) to &#39;spec_power&#39; (50 maps at 0.1) */</span>
<a name="l00607"></a>00607     <span class="keywordflow">if</span> (spec_power&lt;100.0f)
<a name="l00608"></a>00608         spec_power= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(1.0f/spec_power);
<a name="l00609"></a>00609     <span class="keywordflow">else</span> spec_power= 10.0f/spec_power;
<a name="l00610"></a>00610     
<a name="l00611"></a>00611     h[0]= v[0]+l[0];
<a name="l00612"></a>00612     h[1]= v[1]+l[1];
<a name="l00613"></a>00613     h[2]= v[2]+l[2];
<a name="l00614"></a>00614     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     nh= n[0]*h[0]+n[1]*h[1]+n[2]*h[2]; <span class="comment">/* Dot product between surface normal and half-way vector */</span>
<a name="l00617"></a>00617     <span class="keywordflow">if</span> (tangent) nh= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nh*nh);
<a name="l00618"></a>00618     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nh&lt;0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     nv= n[0]*v[0]+n[1]*v[1]+n[2]*v[2]; <span class="comment">/* Dot product between surface normal and view vector */</span>
<a name="l00621"></a>00621     <span class="keywordflow">if</span> (tangent) nv= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nv*nv);
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (nv&lt;=0.01f) nv= 0.01f;               <span class="comment">/* hrms... */</span>
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     nl= n[0]*l[0]+n[1]*l[1]+n[2]*l[2]; <span class="comment">/* Dot product between surface normal and light vector */</span>
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (tangent) nl= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nl*nl);
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (nl&lt;=0.01f) {
<a name="l00627"></a>00627         <span class="keywordflow">return</span> 0.0f;
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     vh= v[0]*h[0]+v[1]*h[1]+v[2]*h[2]; <span class="comment">/* Dot product between view vector and half-way vector */</span>
<a name="l00631"></a>00631     <span class="keywordflow">if</span> (vh&lt;=0.0f) vh= 0.01f;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     a = 1.0f;
<a name="l00634"></a>00634     b = (2.0f*nh*nv)/vh;
<a name="l00635"></a>00635     c = (2.0f*nh*nl)/vh;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="keywordflow">if</span> ( a &lt; b &amp;&amp; a &lt; c ) g = a;
<a name="l00638"></a>00638     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( b &lt; a &amp;&amp; b &lt; c ) g = b;
<a name="l00639"></a>00639     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( c &lt; a &amp;&amp; c &lt; b ) g = c;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>( (<span class="keywordtype">double</span>)((refrac * refrac)+(vh*vh)-1.0f) );
<a name="l00642"></a>00642     f = (((<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>-vh)*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>-vh))/((<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>+vh)*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>+vh)))*(1+((((vh*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>+vh))-1.0f)*((vh*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>+vh))-1.0f))/(((vh*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>-vh))+1.0f)*((vh*(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>-vh))+1.0f))));
<a name="l00643"></a>00643     ang = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(nh);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     i= f * g * <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>((<span class="keywordtype">double</span>)(-(ang*ang) / (2.0f*spec_power*spec_power)));
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (i&lt;0.0f) i= 0.0f;
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/* cartoon render spec */</span>
<a name="l00652"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a2a5631f6d5f7568e7c227c141eec7377">00652</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a2a5631f6d5f7568e7c227c141eec7377">Toon_Spec</a>( <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">float</span> <a class="code" href="../../d2/df6/sculpt_8c.html#a11919b8f48badb89cbb5b795722c22e3">smooth</a>, <span class="keywordtype">int</span> tangent)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <span class="keywordtype">float</span> h[3];
<a name="l00655"></a>00655     <span class="keywordtype">float</span> ang;
<a name="l00656"></a>00656     <span class="keywordtype">float</span> rslt;
<a name="l00657"></a>00657     
<a name="l00658"></a>00658     h[0] = l[0] + v[0];
<a name="l00659"></a>00659     h[1] = l[1] + v[1];
<a name="l00660"></a>00660     h[2] = l[2] + v[2];
<a name="l00661"></a>00661     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00662"></a>00662     
<a name="l00663"></a>00663     rslt = h[0]*n[0] + h[1]*n[1] + h[2]*n[2];
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (tangent) rslt = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - rslt*rslt);
<a name="l00665"></a>00665     
<a name="l00666"></a>00666     ang = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>( rslt ); 
<a name="l00667"></a>00667     
<a name="l00668"></a>00668     <span class="keywordflow">if</span> ( ang &lt; size ) rslt = 1.0f;
<a name="l00669"></a>00669     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ang &gt;= (size + smooth) || smooth == 0.0f ) rslt = 0.0f;
<a name="l00670"></a>00670     <span class="keywordflow">else</span> rslt = 1.0f - ((ang - <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>) / smooth);
<a name="l00671"></a>00671     
<a name="l00672"></a>00672     <span class="keywordflow">return</span> rslt;
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="comment">/* Ward isotropic gaussian spec */</span>
<a name="l00676"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a62520f4987dc0d54f63415848e562369">00676</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a62520f4987dc0d54f63415848e562369">WardIso_Spec</a>( <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> rms, <span class="keywordtype">int</span> tangent)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, nh, nv, nl, h[3], <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, alpha;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="comment">/* half-way vector */</span>
<a name="l00682"></a>00682     h[0] = l[0] + v[0];
<a name="l00683"></a>00683     h[1] = l[1] + v[1];
<a name="l00684"></a>00684     h[2] = l[2] + v[2];
<a name="l00685"></a>00685     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     nh = n[0]*h[0]+n[1]*h[1]+n[2]*h[2]; <span class="comment">/* Dot product between surface normal and half-way vector */</span>
<a name="l00688"></a>00688     <span class="keywordflow">if</span> (tangent) nh = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nh*nh);
<a name="l00689"></a>00689     <span class="keywordflow">if</span> (nh&lt;=0.0f) nh = 0.001f;
<a name="l00690"></a>00690     
<a name="l00691"></a>00691     nv = n[0]*v[0]+n[1]*v[1]+n[2]*v[2]; <span class="comment">/* Dot product between surface normal and view vector */</span>
<a name="l00692"></a>00692     <span class="keywordflow">if</span> (tangent) nv = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nv*nv);
<a name="l00693"></a>00693     <span class="keywordflow">if</span> (nv&lt;=0.0f) nv = 0.001f;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     nl = n[0]*l[0]+n[1]*l[1]+n[2]*l[2]; <span class="comment">/* Dot product between surface normal and light vector */</span>
<a name="l00696"></a>00696     <span class="keywordflow">if</span> (tangent) nl = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#af0b0db393fbb836a8a1a4b9ff47e6980">sasqrt</a>(1.0f - nl*nl);
<a name="l00697"></a>00697     <span class="keywordflow">if</span> (nl&lt;=0.0f) nl = 0.001f;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     angle = <a class="code" href="../../d0/dbc/namespaceKDL.html#a4c38a2bd6500e4df8a3312309a56fa6d">tan</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(nh));
<a name="l00700"></a>00700     alpha = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(rms, 0.001f);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     i= nl * (1.0f/(4.0f*(float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*alpha*alpha)) * (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>( -(angle*angle)/(alpha*alpha))/(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(nv*nl)));
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="comment">/* cartoon render diffuse */</span>
<a name="l00708"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a253766b45f667404aa41cd01cc09110f">00708</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a253766b45f667404aa41cd01cc09110f">Toon_Diff</a>( <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(v), <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">float</span> <a class="code" href="../../d2/df6/sculpt_8c.html#a11919b8f48badb89cbb5b795722c22e3">smooth</a> )
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710     <span class="keywordtype">float</span> rslt, ang;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     rslt = n[0]*l[0] + n[1]*l[1] + n[2]*l[2];
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     ang = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>( (<span class="keywordtype">double</span>)(rslt) );
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">if</span> ( ang &lt; size ) rslt = 1.0f;
<a name="l00717"></a>00717     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ang &gt;= (size + smooth) || smooth == 0.0f ) rslt = 0.0f;
<a name="l00718"></a>00718     <span class="keywordflow">else</span> rslt = 1.0f - ((ang - <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>) / smooth);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordflow">return</span> rslt;
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 <span class="comment">/* Oren Nayar diffuse */</span>
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="comment">/* &#39;nl&#39; is either dot product, or return value of area light */</span>
<a name="l00726"></a>00726 <span class="comment">/* in latter case, only last multiplication uses &#39;nl&#39; */</span>
<a name="l00727"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a24a7f43403ca81a7dda0de571d68b0bf">00727</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a24a7f43403ca81a7dda0de571d68b0bf">OrenNayar_Diff</a>(<span class="keywordtype">float</span> nl, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *l, <span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> rough )
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a><span class="comment">/*, nh*/</span>, nv <span class="comment">/*, vh */</span>, realnl, h[3];
<a name="l00730"></a>00730     <span class="keywordtype">float</span> a, b, t, <a class="code" href="../../de/da0/strsv_8c.html#af5d6242ff783dd9efca51eeec1c234f7">A</a>, <a class="code" href="../../d2/d6c/mball_8c.html#a111da81ae5883147168bbb8366377b10">B</a>;
<a name="l00731"></a>00731     <span class="keywordtype">float</span> Lit_A, View_A, Lit_B[3], View_B[3];
<a name="l00732"></a>00732     
<a name="l00733"></a>00733     h[0]= v[0]+l[0];
<a name="l00734"></a>00734     h[1]= v[1]+l[1];
<a name="l00735"></a>00735     h[2]= v[2]+l[2];
<a name="l00736"></a>00736     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(h);
<a name="l00737"></a>00737     
<a name="l00738"></a>00738     <span class="comment">/* nh= n[0]*h[0]+n[1]*h[1]+n[2]*h[2]; */</span> <span class="comment">/* Dot product between surface normal and half-way vector */</span>
<a name="l00739"></a>00739     <span class="comment">/* if (nh&lt;0.0f) nh = 0.0f; */</span>
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     nv= n[0]*v[0]+n[1]*v[1]+n[2]*v[2]; <span class="comment">/* Dot product between surface normal and view vector */</span>
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (nv&lt;=0.0f) nv= 0.0f;
<a name="l00743"></a>00743     
<a name="l00744"></a>00744     realnl= n[0]*l[0]+n[1]*l[1]+n[2]*l[2]; <span class="comment">/* Dot product between surface normal and light vector */</span>
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (realnl&lt;=0.0f) <span class="keywordflow">return</span> 0.0f;
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (nl&lt;0.0f) <span class="keywordflow">return</span> 0.0f;       <span class="comment">/* value from area light */</span>
<a name="l00747"></a>00747     
<a name="l00748"></a>00748     <span class="comment">/* vh= v[0]*h[0]+v[1]*h[1]+v[2]*h[2]; */</span> <span class="comment">/* Dot product between view vector and halfway vector */</span>
<a name="l00749"></a>00749     <span class="comment">/* if (vh&lt;=0.0f) vh= 0.0f; */</span>
<a name="l00750"></a>00750     
<a name="l00751"></a>00751     Lit_A = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(realnl);
<a name="l00752"></a>00752     View_A = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>( nv );
<a name="l00753"></a>00753     
<a name="l00754"></a>00754     Lit_B[0] = l[0] - (realnl * n[0]);
<a name="l00755"></a>00755     Lit_B[1] = l[1] - (realnl * n[1]);
<a name="l00756"></a>00756     Lit_B[2] = l[2] - (realnl * n[2]);
<a name="l00757"></a>00757     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>( Lit_B );
<a name="l00758"></a>00758     
<a name="l00759"></a>00759     View_B[0] = v[0] - (nv * n[0]);
<a name="l00760"></a>00760     View_B[1] = v[1] - (nv * n[1]);
<a name="l00761"></a>00761     View_B[2] = v[2] - (nv * n[2]);
<a name="l00762"></a>00762     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>( View_B );
<a name="l00763"></a>00763     
<a name="l00764"></a>00764     t = Lit_B[0]*View_B[0] + Lit_B[1]*View_B[1] + Lit_B[2]*View_B[2];
<a name="l00765"></a>00765     <span class="keywordflow">if</span> ( t &lt; 0 ) t = 0;
<a name="l00766"></a>00766     
<a name="l00767"></a>00767     <span class="keywordflow">if</span> ( Lit_A &gt; View_A ) {
<a name="l00768"></a>00768         a = Lit_A;
<a name="l00769"></a>00769         b = View_A;
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="keywordflow">else</span> {
<a name="l00772"></a>00772         a = View_A;
<a name="l00773"></a>00773         b = Lit_A;
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775     
<a name="l00776"></a>00776     A = 1.0f - (0.5f * ((rough * rough) / ((rough * rough) + 0.33f)));
<a name="l00777"></a>00777     B = 0.45f * ((rough * rough) / ((rough * rough) + 0.09f));
<a name="l00778"></a>00778     
<a name="l00779"></a>00779     b*= 0.95f;  <span class="comment">/* prevent tangens from shooting to inf, &#39;nl&#39; can be not a dot product here. */</span>
<a name="l00780"></a>00780                 <span class="comment">/* overflow only happens with extreme size area light, and higher roughness */</span>
<a name="l00781"></a>00781     i = nl * ( A + ( B * t * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(a) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a8399002c5cbbff754c83f8b9ac3d77e8">tanf</a>(b) ) );
<a name="l00782"></a>00782     
<a name="l00783"></a>00783     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786 <span class="comment">/* Minnaert diffuse */</span>
<a name="l00787"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#aa5ea032ce9c206c553ef5d04136ce697">00787</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aa5ea032ce9c206c553ef5d04136ce697">Minnaert_Diff</a>(<span class="keywordtype">float</span> nl, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *v, <span class="keywordtype">float</span> darkness)
<a name="l00788"></a>00788 {
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, nv;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     <span class="comment">/* nl = dot product between surface normal and light vector */</span>
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (nl &lt;= 0.0f)
<a name="l00794"></a>00794         <span class="keywordflow">return</span> 0.0f;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796     <span class="comment">/* nv = dot product between surface normal and view vector */</span>
<a name="l00797"></a>00797     nv = n[0]*v[0]+n[1]*v[1]+n[2]*v[2];
<a name="l00798"></a>00798     <span class="keywordflow">if</span> (nv &lt; 0.0f)
<a name="l00799"></a>00799         nv = 0.0f;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     <span class="keywordflow">if</span> (darkness &lt;= 1.0f)
<a name="l00802"></a>00802         i = nl * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(nv*nl, 0.1f), (darkness - 1.0f) ); <span class="comment">/*The Real model*/</span>
<a name="l00803"></a>00803     <span class="keywordflow">else</span>
<a name="l00804"></a>00804         i = nl * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>( (1.001f - nv), (darkness  - 1.0f) ); <span class="comment">/*Nvidia model*/</span>
<a name="l00805"></a>00805 
<a name="l00806"></a>00806     <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00807"></a>00807 }
<a name="l00808"></a>00808 
<a name="l00809"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a36e0a0370de128548d6eb9c842899608">00809</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a36e0a0370de128548d6eb9c842899608">Fresnel_Diff</a>(<span class="keywordtype">float</span> *vn, <span class="keywordtype">float</span> *lv, <span class="keywordtype">float</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(view), <span class="keywordtype">float</span> fac_i, <span class="keywordtype">float</span> fac)
<a name="l00810"></a>00810 {
<a name="l00811"></a>00811     <span class="keywordflow">return</span> <a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(lv, vn, fac_i, fac);
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 <span class="comment">/* --------------------------------------------- */</span>
<a name="l00815"></a>00815 <span class="comment">/* also called from texture.c */</span>
<a name="l00816"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a756d565cf1184862af4496ef87281f7a">00816</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#ad16b88e414593db21a48ef03fb93487b">calc_R_ref</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l00817"></a>00817 {
<a name="l00818"></a>00818     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="comment">/* shi-&gt;vn dot shi-&gt;view */</span>
<a name="l00821"></a>00821     i= -2*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]);
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[0]= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]);
<a name="l00824"></a>00824     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[1]= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]);
<a name="l00825"></a>00825     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[2]= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]+i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]);
<a name="l00826"></a>00826     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>) {
<a name="l00827"></a>00827         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>) {
<a name="l00828"></a>00828             i= -2*( (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[0])*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a50dd51413314a5cf6f703d3c3ea5f7ec">dxview</a>) +
<a name="l00829"></a>00829                 (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[1])*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+ (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[2])*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2] );
<a name="l00830"></a>00830 
<a name="l00831"></a>00831             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[0]- ( shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a50dd51413314a5cf6f703d3c3ea5f7ec">dxview</a>+i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[0]));
<a name="l00832"></a>00832             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[1]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+ i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[1]));
<a name="l00833"></a>00833             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[2]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]+ i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7a7f348ba95e49394c8391458368ff44">dxno</a>[2]));
<a name="l00834"></a>00834 
<a name="l00835"></a>00835             i= -2*( (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[0])*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+
<a name="l00836"></a>00836                 (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[1])*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8862abe969b127aaa3b804e5b788fb71">dyview</a>)+ (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[2])*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2] );
<a name="l00837"></a>00837 
<a name="l00838"></a>00838             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[0]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+ i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[0]));
<a name="l00839"></a>00839             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[1]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8862abe969b127aaa3b804e5b788fb71">dyview</a>+i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[1]));
<a name="l00840"></a>00840             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[2]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]+ i*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a026bb119c162a3579ff2ce22e939fe33">dyno</a>[2]));
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843         <span class="keywordflow">else</span> {
<a name="l00844"></a>00844 
<a name="l00845"></a>00845             i= -2*( shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a50dd51413314a5cf6f703d3c3ea5f7ec">dxview</a>) +
<a name="l00846"></a>00846                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+ shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2] );
<a name="l00847"></a>00847 
<a name="l00848"></a>00848             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[0]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a50dd51413314a5cf6f703d3c3ea5f7ec">dxview</a>+i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]);
<a name="l00849"></a>00849             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[1]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+ i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]);
<a name="l00850"></a>00850             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af4ef685e54b7368fc2c71649ec69a4a8">dxref</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[2]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]+ i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]);
<a name="l00851"></a>00851 
<a name="l00852"></a>00852             i= -2*( shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+
<a name="l00853"></a>00853                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8862abe969b127aaa3b804e5b788fb71">dyview</a>)+ shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2] );
<a name="l00854"></a>00854 
<a name="l00855"></a>00855             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[0]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]+ i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0]);
<a name="l00856"></a>00856             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[1]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8862abe969b127aaa3b804e5b788fb71">dyview</a>+i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1]);
<a name="l00857"></a>00857             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad8767a5c6ab81123d0372631ebd2785b">dyref</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8922773b465e74358562031abc1561b7">ref</a>[2]- (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]+ i*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2]);
<a name="l00858"></a>00858         }
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="comment">/* called from ray.c */</span>
<a name="l00864"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a3c8a704983685c38a957345bea9fa3c6">00864</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#ab1c128f70cd083eeccf16c2b4157e346">shade_color</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a95f694c6f90519ab830e9b9fa87d62e6">MA_FACETEXTURE</a>)) {
<a name="l00869"></a>00869         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0];
<a name="l00870"></a>00870         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1];
<a name="l00871"></a>00871         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2];
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a53cd927e4c5fffa12f274f6ca24de2c5">MA_FACETEXTURE_ALPHA</a>))
<a name="l00873"></a>00873             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a738a0d7c46ba3b6726d95e0842e020ce">MA_VERTEXCOLP</a>)) {
<a name="l00876"></a>00876         <span class="keywordtype">float</span> neg_alpha = 1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l00877"></a>00877         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l00878"></a>00878         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l00879"></a>00879         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881     
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a>)
<a name="l00883"></a>00883         <a class="code" href="../../d8/d7c/gpu__material_8c.html#ab09827a486fe37e91a118c621f94cfdd">do_material_tex</a>(shi, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae4a30ec1f7d7d6e01e60c93be89bdf2c">fresnel_tra</a>!=0.0f) 
<a name="l00886"></a>00886         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>*= <a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a021f7ea9f2f7721c4e6be2677d269596">fresnel_tra_i</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae4a30ec1f7d7d6e01e60c93be89bdf2c">fresnel_tra</a>);
<a name="l00887"></a>00887     
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (!(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>)) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= 1.0f;
<a name="l00889"></a>00889     
<a name="l00890"></a>00890     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l00891"></a>00891     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l00892"></a>00892     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l00893"></a>00893     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/* ramp for at end of shade */</span>
<a name="l00897"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a450afb8bce0ed55bfccf50d621951252">00897</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a450afb8bce0ed55bfccf50d621951252">ramp_diffuse_result</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00900"></a>00900     <span class="keywordtype">float</span> col[4];
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a64069c881aa121bf9faa495da7768b5f">ramp_col</a>) {
<a name="l00903"></a>00903         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac81c67d463b8f89ed9c0a7af0343a1c3">rampin_col</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a11e09d21303170821bed8b1998b33802">MA_RAMP_IN_RESULT</a>) {
<a name="l00904"></a>00904             <span class="keywordtype">float</span> fac = <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(diff);
<a name="l00905"></a>00905             <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a64069c881aa121bf9faa495da7768b5f">ramp_col</a>, fac, col);
<a name="l00906"></a>00906             
<a name="l00907"></a>00907             <span class="comment">/* blending method */</span>
<a name="l00908"></a>00908             fac= col[3]*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1b8c8eca26238a4bf54476f9e09d19e8">rampfac_col</a>;
<a name="l00909"></a>00909             
<a name="l00910"></a>00910             <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa6ed5c5d201f3bf92a4fa1698c0c3db8">rampblend_col</a>, diff, fac, col);
<a name="l00911"></a>00911         }
<a name="l00912"></a>00912     }
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 <span class="comment">/* r,g,b denote energy, ramp is used with different values to make new material color */</span>
<a name="l00916"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">00916</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">add_to_diffuse</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> is, <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>, <span class="keywordtype">float</span> b)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a64069c881aa121bf9faa495da7768b5f">ramp_col</a> &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a5bbad81bcdfe7179f2bc485fcb440adb">MA_RAMP_COL</a>)) {
<a name="l00921"></a>00921         
<a name="l00922"></a>00922         <span class="comment">/* MA_RAMP_IN_RESULT is exceptional */</span>
<a name="l00923"></a>00923         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac81c67d463b8f89ed9c0a7af0343a1c3">rampin_col</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a11e09d21303170821bed8b1998b33802">MA_RAMP_IN_RESULT</a>) {
<a name="l00924"></a>00924             <span class="comment">// normal add</span>
<a name="l00925"></a>00925             diff[0] += r * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l00926"></a>00926             diff[1] += g * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l00927"></a>00927             diff[2] += b * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l00928"></a>00928         }
<a name="l00929"></a>00929         <span class="keywordflow">else</span> {
<a name="l00930"></a>00930             <span class="keywordtype">float</span> colt[3], col[4];
<a name="l00931"></a>00931             <span class="keywordtype">float</span> fac;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933             <span class="comment">/* input */</span>
<a name="l00934"></a>00934             <span class="keywordflow">switch</span>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ac81c67d463b8f89ed9c0a7af0343a1c3">rampin_col</a>) {
<a name="l00935"></a>00935             <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#abbdef6b070f34e2dd18022f551b97239">MA_RAMP_IN_ENERGY</a>:
<a name="l00936"></a>00936                 <span class="comment">/* should use &#39;rgb_to_grayscale&#39; but we only have a vector version */</span>
<a name="l00937"></a>00937                 fac= 0.3f*r + 0.58f*g + 0.12f*b;
<a name="l00938"></a>00938                 <span class="keywordflow">break</span>;
<a name="l00939"></a>00939             <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#aaa8f887a25814cd8b4bc39fac0c2c1f0">MA_RAMP_IN_SHADER</a>:
<a name="l00940"></a>00940                 fac= is;
<a name="l00941"></a>00941                 <span class="keywordflow">break</span>;
<a name="l00942"></a>00942             <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#afaaa88eaf39be0a9eee089443919c2b1">MA_RAMP_IN_NOR</a>:
<a name="l00943"></a>00943                 fac= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l00944"></a>00944                 <span class="keywordflow">break</span>;
<a name="l00945"></a>00945             <span class="keywordflow">default</span>:
<a name="l00946"></a>00946                 fac= 0.0f;
<a name="l00947"></a>00947                 <span class="keywordflow">break</span>;
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949     
<a name="l00950"></a>00950             <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a64069c881aa121bf9faa495da7768b5f">ramp_col</a>, fac, col);
<a name="l00951"></a>00951             
<a name="l00952"></a>00952             <span class="comment">/* blending method */</span>
<a name="l00953"></a>00953             fac= col[3]*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a1b8c8eca26238a4bf54476f9e09d19e8">rampfac_col</a>;
<a name="l00954"></a>00954             colt[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l00955"></a>00955             colt[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l00956"></a>00956             colt[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958             <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa6ed5c5d201f3bf92a4fa1698c0c3db8">rampblend_col</a>, colt, fac, col);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960             <span class="comment">/* output to */</span>
<a name="l00961"></a>00961             diff[0] += r * colt[0];
<a name="l00962"></a>00962             diff[1] += g * colt[1];
<a name="l00963"></a>00963             diff[2] += b * colt[2];
<a name="l00964"></a>00964         }
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     <span class="keywordflow">else</span> {
<a name="l00967"></a>00967         diff[0] += r * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l00968"></a>00968         diff[1] += g * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l00969"></a>00969         diff[2] += b * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971 }
<a name="l00972"></a>00972 
<a name="l00973"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#ae224a910d48364e33ff718e5ed03a5b7">00973</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ae224a910d48364e33ff718e5ed03a5b7">ramp_spec_result</a>(<span class="keywordtype">float</span> spec_col[3], <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l00974"></a>00974 {
<a name="l00975"></a>00975     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a60395437e9ccda837921ab3bfa8e009c">ramp_spec</a> &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a895dfda706c57d81bebe0fea02649647">rampin_spec</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a11e09d21303170821bed8b1998b33802">MA_RAMP_IN_RESULT</a>)) {
<a name="l00978"></a>00978         <span class="keywordtype">float</span> col[4];
<a name="l00979"></a>00979         <span class="keywordtype">float</span> fac = <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(spec_col);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a60395437e9ccda837921ab3bfa8e009c">ramp_spec</a>, fac, col);
<a name="l00982"></a>00982         
<a name="l00983"></a>00983         <span class="comment">/* blending method */</span>
<a name="l00984"></a>00984         fac= col[3]*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8524a969b588adf479a52c46e981c746">rampfac_spec</a>;
<a name="l00985"></a>00985         
<a name="l00986"></a>00986         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#afea6be46470cd09325faaca5189722ed">rampblend_spec</a>, spec_col, fac, col);
<a name="l00987"></a>00987         
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="comment">/* is = dot product shade, t = spec energy */</span>
<a name="l00992"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a4bb75397c2a55233ce86198cad9aa315">00992</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a4bb75397c2a55233ce86198cad9aa315">do_specular_ramp</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> is, <span class="keywordtype">float</span> t, <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>[3])
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     spec[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>;
<a name="l00997"></a>00997     spec[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac4b4dc6752e596555e0c03f1a22b3037">specg</a>;
<a name="l00998"></a>00998     spec[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7791e978ef33ceb27b4ec0f441a7cc22">specb</a>;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">/* MA_RAMP_IN_RESULT is exception */</span>
<a name="l01001"></a>01001     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a60395437e9ccda837921ab3bfa8e009c">ramp_spec</a> &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a895dfda706c57d81bebe0fea02649647">rampin_spec</a>!=<a class="code" href="../../de/db2/DNA__material__types_8h.html#a11e09d21303170821bed8b1998b33802">MA_RAMP_IN_RESULT</a>)) {
<a name="l01002"></a>01002         <span class="keywordtype">float</span> fac;
<a name="l01003"></a>01003         <span class="keywordtype">float</span> col[4];
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         <span class="comment">/* input */</span>
<a name="l01006"></a>01006         <span class="keywordflow">switch</span>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a895dfda706c57d81bebe0fea02649647">rampin_spec</a>) {
<a name="l01007"></a>01007         <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#abbdef6b070f34e2dd18022f551b97239">MA_RAMP_IN_ENERGY</a>:
<a name="l01008"></a>01008             fac= t;
<a name="l01009"></a>01009             <span class="keywordflow">break</span>;
<a name="l01010"></a>01010         <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#aaa8f887a25814cd8b4bc39fac0c2c1f0">MA_RAMP_IN_SHADER</a>:
<a name="l01011"></a>01011             fac= is;
<a name="l01012"></a>01012             <span class="keywordflow">break</span>;
<a name="l01013"></a>01013         <span class="keywordflow">case</span> <a class="code" href="../../de/db2/DNA__material__types_8h.html#afaaa88eaf39be0a9eee089443919c2b1">MA_RAMP_IN_NOR</a>:
<a name="l01014"></a>01014             fac= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[0] + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[1] + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>[2];
<a name="l01015"></a>01015             <span class="keywordflow">break</span>;
<a name="l01016"></a>01016         <span class="keywordflow">default</span>:
<a name="l01017"></a>01017             fac= 0.0f;
<a name="l01018"></a>01018             <span class="keywordflow">break</span>;
<a name="l01019"></a>01019         }
<a name="l01020"></a>01020         
<a name="l01021"></a>01021         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a721c3ae085220a3753934ebfc4505fba">do_colorband</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a60395437e9ccda837921ab3bfa8e009c">ramp_spec</a>, fac, col);
<a name="l01022"></a>01022         
<a name="l01023"></a>01023         <span class="comment">/* blending method */</span>
<a name="l01024"></a>01024         fac= col[3]*ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a8524a969b588adf479a52c46e981c746">rampfac_spec</a>;
<a name="l01025"></a>01025         
<a name="l01026"></a>01026         <a class="code" href="../../d4/d0f/BKE__material_8h.html#afeb6b89011d7e13f834e085b0597dacd">ramp_blend</a>(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#afea6be46470cd09325faaca5189722ed">rampblend_spec</a>, spec, fac, col);
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028 }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030 <span class="comment">/* pure AO, check for raytrace and world should have been done */</span>
<a name="l01031"></a>01031 <span class="comment">/* preprocess, textures were not done, don&#39;t use shi-&gt;amb for that reason */</span>
<a name="l01032"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a2263b7cf17f6cbb873fb8c5d07e052a2">01032</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#aedd8ad2e96c2da7ee49dc39c0bac2652">ambient_occlusion</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l01033"></a>01033 {
<a name="l01034"></a>01034     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_gather_method == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a870998ec12271918c097d9077d771aef">amb</a>!=0.0f) {
<a name="l01035"></a>01035         <a class="code" href="../../d2/d3a/occlusion_8h.html#a86b5d3866e784ee6effc8ee0fc726690">sample_occ</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi);
<a name="l01036"></a>01036     }
<a name="l01037"></a>01037     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a870998ec12271918c097d9077d771aef">amb</a>!=0.0f) {
<a name="l01038"></a>01038         <a class="code" href="../../d0/d0e/rendercore_8h.html#a6d2a73a5deda9d4e8ec466587ce5ccba">ray_ao</a>(shi, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     <span class="keywordflow">else</span> {
<a name="l01041"></a>01041         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[2]= 1.0f;
<a name="l01042"></a>01042         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01043"></a>01043         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01044"></a>01044     }
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047 
<a name="l01048"></a>01048 <span class="comment">/* wrld mode was checked for */</span>
<a name="l01049"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a96993bab6ec0d0457f33cb84e9bf0776">01049</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a96993bab6ec0d0457f33cb84e9bf0776">ambient_occlusion_apply</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01050"></a>01050 {
<a name="l01051"></a>01051     <span class="keywordtype">float</span> f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aoenergy;
<a name="l01052"></a>01052     <span class="keywordtype">float</span> tmp[3], tmpspec[3];
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keywordflow">if</span> (!((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) || <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_gather_method == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>))
<a name="l01055"></a>01055         <span class="keywordflow">return</span>;
<a name="l01056"></a>01056     <span class="keywordflow">if</span> (f == 0.0f)
<a name="l01057"></a>01057         <span class="keywordflow">return</span>;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomix==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aac5d4e103600441eb820660a344f078b">WO_AOADD</a>) {
<a name="l01060"></a>01060         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01061"></a>01061         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01062"></a>01062         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomix==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac6f043e1d5ffb88a181e5a8b89e86591">WO_AOMUL</a>) {
<a name="l01065"></a>01065         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(tmp, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01066"></a>01066         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(tmpspec, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01067"></a>01067 
<a name="l01068"></a>01068         <span class="keywordflow">if</span> (f == 1.0f) {
<a name="l01069"></a>01069             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, tmp);
<a name="l01070"></a>01070             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, tmpspec);
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072         <span class="keywordflow">else</span> {
<a name="l01073"></a>01073             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, tmp, f);
<a name="l01074"></a>01074             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, tmpspec, f);
<a name="l01075"></a>01075         }
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01079"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a6de0c94aa4c71bddfce9cd19fb903cf2">01079</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#af6bba2bf4eda6fecf904f28acbad74fb">environment_lighting_apply</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01080"></a>01080 {
<a name="l01081"></a>01081     <span class="keywordtype">float</span> f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_env_energy*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>;
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="keywordflow">if</span> (!((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) || <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_gather_method == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>))
<a name="l01084"></a>01084         <span class="keywordflow">return</span>;
<a name="l01085"></a>01085     <span class="keywordflow">if</span> (f == 0.0f)
<a name="l01086"></a>01086         <span class="keywordflow">return</span>;
<a name="l01087"></a>01087     
<a name="l01088"></a>01088     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01089"></a>01089     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01090"></a>01090     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01091"></a>01091 }
<a name="l01092"></a>01092 
<a name="l01093"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#afd6826f5783fdf8a5c1494b2bc3709ee">01093</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#afd6826f5783fdf8a5c1494b2bc3709ee">indirect_lighting_apply</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01094"></a>01094 {
<a name="l01095"></a>01095     <span class="keywordtype">float</span> f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_indirect_energy;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     <span class="keywordflow">if</span> (!((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>) || <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_gather_method == <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a5d51708001bb2594e7c971838337fe93">WO_AOGATHER_APPROX</a>))
<a name="l01098"></a>01098         <span class="keywordflow">return</span>;
<a name="l01099"></a>01099     <span class="keywordflow">if</span> (f == 0.0f)
<a name="l01100"></a>01100         <span class="keywordflow">return</span>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01103"></a>01103     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01104"></a>01104     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>*f;
<a name="l01105"></a>01105 }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 <span class="comment">/* result written in shadfac */</span>
<a name="l01108"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a0f3b34dff97f923e8d70ee44fb4325ff">01108</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#a2e7f93325508f2e4f42355d511b17ab1">lamp_get_shadow</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> inp, <span class="keywordtype">float</span> shadfac[4], <span class="keywordtype">int</span> do_real)
<a name="l01109"></a>01109 {
<a name="l01110"></a>01110     <a class="code" href="../../db/dcd/structLampShadowSubSample.html">LampShadowSubSample</a> *lss= &amp;(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a860a59b39afa231fbffc678adef05b9a">shadsamp</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>].<a class="code" href="../../d8/d3e/structLampShadowSample.html#a7e64f7ba02b3e73f90f38cea4212571f">s</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad5fc0888d8af90fd5b20ea267d7a437a">sample</a>]);
<a name="l01111"></a>01111     
<a name="l01112"></a>01112     <span class="keywordflow">if</span> (do_real || lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#a410c17c7cb3762e41138a08df4537929">samplenr</a>!=shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>) {
<a name="l01113"></a>01113         
<a name="l01114"></a>01114         shadfac[0]= shadfac[1]= shadfac[2]= shadfac[3]= 1.0f;
<a name="l01115"></a>01115         
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l01117"></a>01117             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a140e58d774f55360506b8dd8bebeb553">LA_SHADBUF_IRREGULAR</a>)
<a name="l01118"></a>01118                 shadfac[3]= <a class="code" href="../../d9/d30/shadbuf_8h.html#a1fc452525e32ed37705c35597b174f11">ISB_getshadow</a>(shi, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>);
<a name="l01119"></a>01119             <span class="keywordflow">else</span>
<a name="l01120"></a>01120                 shadfac[3] = <a class="code" href="../../d9/d30/shadbuf_8h.html#a90bba8ef1567f3b648d21a39493a85a7">testshadowbuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>, inp, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a77a160a46e3102c6fef4dcbeab9f8e5d">lbias</a>);
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) {
<a name="l01123"></a>01123             <a class="code" href="../../d0/d0e/rendercore_8h.html#a0a2119f1e2bc6448c9c3265dbba615d0">ray_shadow</a>(shi, lar, shadfac);
<a name="l01124"></a>01124         }
<a name="l01125"></a>01125         
<a name="l01126"></a>01126         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>==0) {
<a name="l01127"></a>01127             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>, shadfac);
<a name="l01128"></a>01128             lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#a410c17c7cb3762e41138a08df4537929">samplenr</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>;
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131     <span class="keywordflow">else</span> {
<a name="l01132"></a>01132         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(shadfac, lss-&gt;<a class="code" href="../../db/dcd/structLampShadowSubSample.html#abbd3a1749d6dd81e9d80ca5f3de2279d">shadfac</a>);
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134 }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="comment">/* lampdistance and spot angle, writes in lv and dist */</span>
<a name="l01137"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#abb9225a2f82f7187c8bac8c82410fc4d">01137</a> <span class="keywordtype">float</span> <a class="code" href="../../d8/d7c/gpu__material_8c.html#afb2bdd1c02f7db58b253ea0d265f499d">lamp_get_visibility</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> lv[3], <span class="keywordtype">float</span> *dist)
<a name="l01138"></a>01138 {
<a name="l01139"></a>01139     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l01140"></a>01140         *dist= 1.0f;
<a name="l01141"></a>01141         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lv, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>);
<a name="l01142"></a>01142         <span class="keywordflow">return</span> 1.0f;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144     <span class="keywordflow">else</span> {
<a name="l01145"></a>01145         <span class="keywordtype">float</span> visifac= 1.0f, t;
<a name="l01146"></a>01146         
<a name="l01147"></a>01147         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(lv, co, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l01148"></a>01148         *dist= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(lv, lv));
<a name="l01149"></a>01149         t= 1.0f/dist[0];
<a name="l01150"></a>01150         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(lv, t);
<a name="l01151"></a>01151         
<a name="l01152"></a>01152         <span class="comment">/* area type has no quad or sphere option */</span>
<a name="l01153"></a>01153         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>) {
<a name="l01154"></a>01154             <span class="comment">/* area is single sided */</span>
<a name="l01155"></a>01155             <span class="comment">//if (dot_v3v3(lv, lar-&gt;vec) &gt; 0.0f)</span>
<a name="l01156"></a>01156             <span class="comment">//  visifac= 1.0f;</span>
<a name="l01157"></a>01157             <span class="comment">//else</span>
<a name="l01158"></a>01158             <span class="comment">//  visifac= 0.0f;</span>
<a name="l01159"></a>01159         }
<a name="l01160"></a>01160         <span class="keywordflow">else</span> {
<a name="l01161"></a>01161             <span class="keywordflow">switch</span>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a552e96ad4c0b8645dfbe85c9aa6eb921">falloff_type</a>)
<a name="l01162"></a>01162             {
<a name="l01163"></a>01163                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a49b0ddce5c0c848a2eb53747bb5f738d">LA_FALLOFF_CONSTANT</a>:
<a name="l01164"></a>01164                     visifac = 1.0f;
<a name="l01165"></a>01165                     <span class="keywordflow">break</span>;
<a name="l01166"></a>01166                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#adb664a05499f6bc8da4c60a8fd181248">LA_FALLOFF_INVLINEAR</a>:
<a name="l01167"></a>01167                     visifac = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a> + dist[0]);
<a name="l01168"></a>01168                     <span class="keywordflow">break</span>;
<a name="l01169"></a>01169                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab77539e65b2ece5b3ebe7287a20025bb">LA_FALLOFF_INVSQUARE</a>:
<a name="l01170"></a>01170                     <span class="comment">/* NOTE: This seems to be a hack since commit r12045 says this</span>
<a name="l01171"></a>01171 <span class="comment">                     * option is similar to old Quad, but with slight changes.</span>
<a name="l01172"></a>01172 <span class="comment">                     * Correct inv square would be (which would be old Quad):</span>
<a name="l01173"></a>01173 <span class="comment">                     * visifac = lar-&gt;distkw / (lar-&gt;distkw + dist[0]*dist[0]);</span>
<a name="l01174"></a>01174 <span class="comment">                     */</span>
<a name="l01175"></a>01175                     visifac = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a> / (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a> + dist[0]*dist[0]);
<a name="l01176"></a>01176                     <span class="keywordflow">break</span>;
<a name="l01177"></a>01177                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a16fdbe0a2c9d247189b0c9d94930cc35">LA_FALLOFF_SLIDERS</a>:
<a name="l01178"></a>01178                     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aa426d637e8e7dbe8cbd851c2d5b91d42">ld1</a>&gt;0.0f)
<a name="l01179"></a>01179                         visifac= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aa426d637e8e7dbe8cbd851c2d5b91d42">ld1</a>*dist[0]);
<a name="l01180"></a>01180                     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad534b1e39f44bfa3def6c9edc21cad50">ld2</a>&gt;0.0f)
<a name="l01181"></a>01181                         visifac*= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac87d813965f10bca880aa6b30e8d7974">distkw</a>/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac87d813965f10bca880aa6b30e8d7974">distkw</a>+lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad534b1e39f44bfa3def6c9edc21cad50">ld2</a>*dist[0]*dist[0]);
<a name="l01182"></a>01182                     <span class="keywordflow">break</span>;
<a name="l01183"></a>01183                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ae2eb7149834494d8227167be577498fe">LA_FALLOFF_CURVE</a>:
<a name="l01184"></a>01184                     visifac = <a class="code" href="../../d4/dca/BKE__colortools_8h.html#a24a039a3e10ecfb8a0cfefc9811f4830">curvemapping_evaluateF</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a23d95b62c92cf51999ddb7e90adcdf8a">curfalloff</a>, 0, dist[0]/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>);
<a name="l01185"></a>01185                     <span class="keywordflow">break</span>;
<a name="l01186"></a>01186             }
<a name="l01187"></a>01187             
<a name="l01188"></a>01188             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a6d59a2aff598eff08f19650920459fa8">LA_SPHERE</a>) {
<a name="l01189"></a>01189                 <span class="keywordtype">float</span> t= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a> - dist[0];
<a name="l01190"></a>01190                 <span class="keywordflow">if</span> (t&lt;=0.0f) 
<a name="l01191"></a>01191                     visifac= 0.0f;
<a name="l01192"></a>01192                 <span class="keywordflow">else</span>
<a name="l01193"></a>01193                     visifac*= t/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#abf6717321e79d3244cdc4ea79c3ed12f">dist</a>;
<a name="l01194"></a>01194             }
<a name="l01195"></a>01195             
<a name="l01196"></a>01196             <span class="keywordflow">if</span> (visifac &gt; 0.0f) {
<a name="l01197"></a>01197                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>) {
<a name="l01198"></a>01198                     <span class="keywordtype">float</span> inpr;
<a name="l01199"></a>01199                     
<a name="l01200"></a>01200                     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab52bf56b834bad1d21c3aaa274943059">LA_SQUARE</a>) {
<a name="l01201"></a>01201                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(lv, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>) &gt; 0.0f) {
<a name="l01202"></a>01202                             <span class="keywordtype">float</span> lvrot[3], x;
<a name="l01203"></a>01203                             
<a name="l01204"></a>01204                             <span class="comment">/* rotate view to lampspace */</span>
<a name="l01205"></a>01205                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lvrot, lv);
<a name="l01206"></a>01206                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, lvrot);
<a name="l01207"></a>01207                             
<a name="l01208"></a>01208                             x = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(lvrot[0]/lvrot[2]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(lvrot[1]/lvrot[2]));
<a name="l01209"></a>01209                             <span class="comment">/* 1.0f/(sqrt(1+x*x)) is equivalent to cos(atan(x)) */</span>
<a name="l01210"></a>01210                             
<a name="l01211"></a>01211                             inpr= 1.0f/(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(1.0f+x*x));
<a name="l01212"></a>01212                         }
<a name="l01213"></a>01213                         <span class="keywordflow">else</span> inpr= 0.0f;
<a name="l01214"></a>01214                     }
<a name="l01215"></a>01215                     <span class="keywordflow">else</span> {
<a name="l01216"></a>01216                         inpr= lv[0]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0]+lv[1]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1]+lv[2]*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2];
<a name="l01217"></a>01217                     }
<a name="l01218"></a>01218                     
<a name="l01219"></a>01219                     t= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>;
<a name="l01220"></a>01220                     <span class="keywordflow">if</span> (inpr&lt;=t) 
<a name="l01221"></a>01221                         visifac= 0.0f;
<a name="l01222"></a>01222                     <span class="keywordflow">else</span> {
<a name="l01223"></a>01223                         t= inpr-t;
<a name="l01224"></a>01224                         <span class="keywordflow">if</span> (t&lt;lar-&gt;spotbl &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a2a5b4e6535eb9e727d0331696ff975ce">spotbl</a>!=0.0f) {
<a name="l01225"></a>01225                             <span class="comment">/* soft area */</span>
<a name="l01226"></a>01226                             <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>= t/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a2a5b4e6535eb9e727d0331696ff975ce">spotbl</a>;
<a name="l01227"></a>01227                             t= i*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01228"></a>01228                             inpr*= (3.0f*t-2.0f*t*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l01229"></a>01229                         }
<a name="l01230"></a>01230                         visifac*= inpr;
<a name="l01231"></a>01231                     }
<a name="l01232"></a>01232                 }
<a name="l01233"></a>01233             }
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235         <span class="keywordflow">if</span> (visifac &lt;= 0.001f) visifac = 0.0f;
<a name="l01236"></a>01236         <span class="keywordflow">return</span> visifac;
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238 }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 <span class="comment">/* function returns raw diff, spec and full shadowed diff in the &#39;shad&#39; pass */</span>
<a name="l01241"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfea97c0ab3261034cbe9e73719daf8c">01241</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfea97c0ab3261034cbe9e73719daf8c">shade_one_light</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">int</span> passflag)
<a name="l01242"></a>01242 {
<a name="l01243"></a>01243     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l01244"></a>01244     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l01245"></a>01245     <span class="keywordtype">float</span> lv[3], lampdist, lacol[3], shadfac[4], lashdw[3];
<a name="l01246"></a>01246     <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, is, i_noshad, inp, *vn, *view, vnor[3], phongcorr=1.0f;
<a name="l01247"></a>01247     <span class="keywordtype">float</span> visifac;
<a name="l01248"></a>01248     
<a name="l01249"></a>01249     vn= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>;
<a name="l01250"></a>01250     view= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>;
<a name="l01251"></a>01251     
<a name="l01252"></a>01252     
<a name="l01253"></a>01253     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a> == 0.0f) <span class="keywordflow">return</span>;
<a name="l01254"></a>01254     <span class="comment">/* only shadow lamps shouldn&#39;t affect shadow-less materials at all */</span>
<a name="l01255"></a>01255     <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>) &amp;&amp; (!(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8aef50483b1dd2de7122dd7da21b1c7">MA_SHADOW</a>) || !(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)))
<a name="l01256"></a>01256         <span class="keywordflow">return</span>;
<a name="l01257"></a>01257     <span class="comment">/* optimization, don&#39;t render fully black lamps */</span>
<a name="l01258"></a>01258     <span class="keywordflow">if</span> (!(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>) &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a> + lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac459abfab45ae7ccecdf626896763675">g</a> + lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8df1307b7133d24f3a3b64a1e5eabf11">b</a> == 0.0f))
<a name="l01259"></a>01259         <span class="keywordflow">return</span>;
<a name="l01260"></a>01260     
<a name="l01261"></a>01261     <span class="comment">/* lampdist, spot angle, area side, ... */</span>
<a name="l01262"></a>01262     visifac= <a class="code" href="../../d8/d7c/gpu__material_8c.html#afb2bdd1c02f7db58b253ea0d265f499d">lamp_get_visibility</a>(lar, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, lv, &amp;lampdist);
<a name="l01263"></a>01263     <span class="keywordflow">if</span> (visifac==0.0f)
<a name="l01264"></a>01264         <span class="keywordflow">return</span>;
<a name="l01265"></a>01265     
<a name="l01266"></a>01266     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a>) {
<a name="l01267"></a>01267         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aacf03d280f4150768590d86d7ac3a542">LA_OSATEX</a>) {
<a name="l01268"></a>01268             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>= 1; <span class="comment">/* signal for multitex() */</span>
<a name="l01269"></a>01269             
<a name="l01270"></a>01270             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac90d38a2bdca62e44ab85b9a593bafbe">dxlv</a>[0]= lv[0] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[0])/lampdist;
<a name="l01271"></a>01271             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac90d38a2bdca62e44ab85b9a593bafbe">dxlv</a>[1]= lv[1] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[1])/lampdist;
<a name="l01272"></a>01272             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac90d38a2bdca62e44ab85b9a593bafbe">dxlv</a>[2]= lv[2] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>[2])/lampdist;
<a name="l01273"></a>01273             
<a name="l01274"></a>01274             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abae44293e402838cf8b4f631432e10d7">dylv</a>[0]= lv[0] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[0])/lampdist;
<a name="l01275"></a>01275             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abae44293e402838cf8b4f631432e10d7">dylv</a>[1]= lv[1] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[1])/lampdist;
<a name="l01276"></a>01276             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abae44293e402838cf8b4f631432e10d7">dylv</a>[2]= lv[2] - (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2]+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>[2])/lampdist;
<a name="l01277"></a>01277         }
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279     
<a name="l01280"></a>01280     <span class="comment">/* lamp color texture */</span>
<a name="l01281"></a>01281     lacol[0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a>;
<a name="l01282"></a>01282     lacol[1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ac459abfab45ae7ccecdf626896763675">g</a>;
<a name="l01283"></a>01283     lacol[2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8df1307b7133d24f3a3b64a1e5eabf11">b</a>;
<a name="l01284"></a>01284     
<a name="l01285"></a>01285     lashdw[0]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a74bda1b10a7cf9499475d3f00c93063a">shdwr</a>;
<a name="l01286"></a>01286     lashdw[1]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b058db79555224c97b8606c5c1d52f0">shdwg</a>;
<a name="l01287"></a>01287     lashdw[2]= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ab932cefb313863f8e1d69d99d9f18a28">shdwb</a>;
<a name="l01288"></a>01288     
<a name="l01289"></a>01289     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>) <a class="code" href="../../df/dba/texture_8h.html#a2d34292e93e416e64d0017ed4429c6c0">do_lamp_tex</a>(lar, lv, shi, lacol, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>);
<a name="l01290"></a>01290     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a151fc803e1c480ea3746f302284d3b41">LA_SHAD_TEX</a>)    <a class="code" href="../../df/dba/texture_8h.html#a2d34292e93e416e64d0017ed4429c6c0">do_lamp_tex</a>(lar, lv, shi, lashdw, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a151fc803e1c480ea3746f302284d3b41">LA_SHAD_TEX</a>);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292         <span class="comment">/* tangent case; calculate fake face normal, aligned with lampvector */</span> 
<a name="l01293"></a>01293         <span class="comment">/* note, vnor==vn is used as tangent trigger for buffer shadow */</span>
<a name="l01294"></a>01294     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) {
<a name="l01295"></a>01295         <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[3], nstrand[3], <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l01296"></a>01296 
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#accc32fc2ffecb51a06017eb26d579997">MA_STR_SURFDIFF</a>) {
<a name="l01298"></a>01298             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c37111d43ccf02243538414f86eec8f">surfnor</a>, vn);
<a name="l01299"></a>01299             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(nstrand, vn, cross);
<a name="l01300"></a>01300 
<a name="l01301"></a>01301             blend= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nstrand, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c37111d43ccf02243538414f86eec8f">surfnor</a>);
<a name="l01302"></a>01302             blend= 1.0f - <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>;
<a name="l01303"></a>01303             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(blend, 0.0f, 1.0f);
<a name="l01304"></a>01304 
<a name="l01305"></a>01305             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(vnor, nstrand, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c37111d43ccf02243538414f86eec8f">surfnor</a>, blend);
<a name="l01306"></a>01306             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vnor);
<a name="l01307"></a>01307         }
<a name="l01308"></a>01308         <span class="keywordflow">else</span> {
<a name="l01309"></a>01309             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, lv, vn);
<a name="l01310"></a>01310             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vnor, cross, vn);
<a name="l01311"></a>01311             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vnor);
<a name="l01312"></a>01312         }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa5c650c3fe62203f51662393764d321c">strand_surfnor</a> &gt; 0.0f) {
<a name="l01315"></a>01315             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa5c650c3fe62203f51662393764d321c">strand_surfnor</a> &gt; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0434a20058fc7a5bd15b42fca3229c65">surfdist</a>) {
<a name="l01316"></a>01316                 blend= (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa5c650c3fe62203f51662393764d321c">strand_surfnor</a> - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0434a20058fc7a5bd15b42fca3229c65">surfdist</a>)/ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa5c650c3fe62203f51662393764d321c">strand_surfnor</a>;
<a name="l01317"></a>01317                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(vnor, vnor, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c37111d43ccf02243538414f86eec8f">surfnor</a>, blend);
<a name="l01318"></a>01318                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vnor);
<a name="l01319"></a>01319             }
<a name="l01320"></a>01320         }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322         vnor[0]= -vnor[0];vnor[1]= -vnor[1];vnor[2]= -vnor[2];
<a name="l01323"></a>01323         vn= vnor;
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>) {
<a name="l01326"></a>01326         <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[3];
<a name="l01327"></a>01327         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, lv, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);
<a name="l01328"></a>01328         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vnor, cross, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>);
<a name="l01329"></a>01329         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vnor);
<a name="l01330"></a>01330         vnor[0]= -vnor[0];vnor[1]= -vnor[1];vnor[2]= -vnor[2];
<a name="l01331"></a>01331         vn= vnor;
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333     
<a name="l01334"></a>01334     <span class="comment">/* dot product and reflectivity */</span>
<a name="l01335"></a>01335     <span class="comment">/* inp = dotproduct, is = shader result, i = lamp energy (with shadow), i_noshad = i without shadow */</span>
<a name="l01336"></a>01336     inp= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vn, lv);
<a name="l01337"></a>01337 
<a name="l01338"></a>01338     <span class="comment">/* phong threshold to prevent backfacing faces having artefacts on ray shadow (terminator problem) */</span>
<a name="l01339"></a>01339     <span class="comment">/* this complex construction screams for a nicer implementation! (ton) */</span>
<a name="l01340"></a>01340     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>) {
<a name="l01341"></a>01341         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8aef50483b1dd2de7122dd7da21b1c7">MA_SHADOW</a>) {
<a name="l01342"></a>01342             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>);
<a name="l01343"></a>01343             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a043bc2e3d922c8bbc7514748aff37df2">MA_RAYBIAS</a>) &amp;&amp; (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) &amp;&amp; (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0d1a791d9808d8bd361e11b0505ddaf6">R_SMOOTH</a>)) {
<a name="l01344"></a>01344                 <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2cf2f167ccb0a07c33ae196131cac32a">smoothresh</a>;
<a name="l01345"></a>01345                 <span class="keywordflow">if</span> (inp&gt;thresh)
<a name="l01346"></a>01346                     phongcorr= (inp-<a class="code" href="../../d2/d6c/mball_8c.html#aac8fef4e3b3d833f16d5cef8ddce1ae1">thresh</a>)/(inp*(1.0f-thresh));
<a name="l01347"></a>01347                 <span class="keywordflow">else</span>
<a name="l01348"></a>01348                     phongcorr= 0.0f;
<a name="l01349"></a>01349             }
<a name="l01350"></a>01350             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a912fa107db5d0015dfca622824074f34">sbias</a>!=0.0f &amp;&amp; ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>)) {
<a name="l01351"></a>01351                 <span class="keywordflow">if</span> (inp&gt;ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a912fa107db5d0015dfca622824074f34">sbias</a>)
<a name="l01352"></a>01352                     phongcorr= (inp-ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a912fa107db5d0015dfca622824074f34">sbias</a>)/(inp*(1.0f-ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a912fa107db5d0015dfca622824074f34">sbias</a>));
<a name="l01353"></a>01353                 <span class="keywordflow">else</span>
<a name="l01354"></a>01354                     phongcorr= 0.0f;
<a name="l01355"></a>01355             }
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357     }
<a name="l01358"></a>01358     
<a name="l01359"></a>01359     <span class="comment">/* diffuse shaders */</span>
<a name="l01360"></a>01360     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aae2ddb1afedc2c63b748c2af6da2dbcd">LA_NO_DIFF</a>) {
<a name="l01361"></a>01361         is= 0.0f;   <span class="comment">// skip shaders</span>
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l01364"></a>01364         is= 0.5f*inp + 0.5f;
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366     <span class="keywordflow">else</span> {
<a name="l01367"></a>01367         
<a name="l01368"></a>01368         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>)
<a name="l01369"></a>01369             inp= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ab074251161b8c52cd77931c8ebf45952">area_lamp_energy_multisample</a>(lar, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, vn);
<a name="l01370"></a>01370         
<a name="l01371"></a>01371         <span class="comment">/* diffuse shaders (oren nayer gets inp from area light) */</span>
<a name="l01372"></a>01372         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab9a01719eea0346bf10eb3d5ae20a906">diff_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#af4a08811e19417ae4d979f29cc94cde7">MA_DIFF_ORENNAYAR</a>) is= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a24a7f43403ca81a7dda0de571d68b0bf">OrenNayar_Diff</a>(inp, vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#abbaeac8374986ca82670ff0d7749c566">roughness</a>);
<a name="l01373"></a>01373         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab9a01719eea0346bf10eb3d5ae20a906">diff_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a42394b5d2d25a3f014214529462fca34">MA_DIFF_TOON</a>) is= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a253766b45f667404aa41cd01cc09110f">Toon_Diff</a>(vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[0], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[1]);
<a name="l01374"></a>01374         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab9a01719eea0346bf10eb3d5ae20a906">diff_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a13203920f1d7400dc547c71c085c42ee">MA_DIFF_MINNAERT</a>) is= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#aa5ea032ce9c206c553ef5d04136ce697">Minnaert_Diff</a>(inp, vn, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a40486a8cd163fec0286803a1f5396cf8">darkness</a>);
<a name="l01375"></a>01375         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab9a01719eea0346bf10eb3d5ae20a906">diff_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ae6d42ca3890f9713c84e6c61d35f8374">MA_DIFF_FRESNEL</a>) is= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a36e0a0370de128548d6eb9c842899608">Fresnel_Diff</a>(vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[0], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[1]);
<a name="l01376"></a>01376         <span class="keywordflow">else</span> is= inp;   <span class="comment">// Lambert</span>
<a name="l01377"></a>01377     }
<a name="l01378"></a>01378     
<a name="l01379"></a>01379     <span class="comment">/* &#39;is&#39; is diffuse */</span>
<a name="l01380"></a>01380     <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef8bf00cf7a52e2e5568f5e4d4ca6e5">shade_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a3b66392468b7adad2b659d0c5ea970cc">MA_CUBIC</a>) &amp;&amp; is&gt;0.0f &amp;&amp; is&lt;1.0f)
<a name="l01381"></a>01381         is= 3.0f*is*is - 2.0f*is*is*is; <span class="comment">// nicer termination of shades</span>
<a name="l01382"></a>01382 
<a name="l01383"></a>01383     i= is*phongcorr;
<a name="l01384"></a>01384     
<a name="l01385"></a>01385     <span class="keywordflow">if</span> (i&gt;0.0f) {
<a name="l01386"></a>01386         i*= visifac*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9f7cd87aad2d9142049f3e3f8b4b8726">refl</a>;
<a name="l01387"></a>01387     }
<a name="l01388"></a>01388     i_noshad= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01389"></a>01389     
<a name="l01390"></a>01390     vn= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>;    <span class="comment">// bring back original vector, we use special specular shaders for tangent</span>
<a name="l01391"></a>01391     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>)
<a name="l01392"></a>01392         vn= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a14240470b0aeda0355fefdc03b7dbb27">tang</a>;
<a name="l01393"></a>01393     
<a name="l01394"></a>01394     <span class="comment">/* init transp shadow */</span>
<a name="l01395"></a>01395     shadfac[0]= shadfac[1]= shadfac[2]= shadfac[3]= 1.0f;
<a name="l01396"></a>01396     
<a name="l01397"></a>01397     <span class="comment">/* shadow and spec, (visifac==0 outside spot) */</span>
<a name="l01398"></a>01398     <span class="keywordflow">if</span> (visifac&gt; 0.0f) {
<a name="l01399"></a>01399         
<a name="l01400"></a>01400         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>)) {
<a name="l01401"></a>01401             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#aa8aef50483b1dd2de7122dd7da21b1c7">MA_SHADOW</a>) {
<a name="l01402"></a>01402                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> || (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>)) {
<a name="l01403"></a>01403                     
<a name="l01404"></a>01404                     <span class="keywordflow">if</span> (vn==vnor)   <span class="comment">/* tangent trigger */</span>
<a name="l01405"></a>01405                         <a class="code" href="../../da/d3d/shading_8h.html#a2e7f93325508f2e4f42355d511b17ab1">lamp_get_shadow</a>(lar, shi, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, lv), shadfac, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>);
<a name="l01406"></a>01406                     <span class="keywordflow">else</span>
<a name="l01407"></a>01407                         <a class="code" href="../../da/d3d/shading_8h.html#a2e7f93325508f2e4f42355d511b17ab1">lamp_get_shadow</a>(lar, shi, inp, shadfac, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>);
<a name="l01408"></a>01408                         
<a name="l01409"></a>01409                     <span class="comment">/* warning, here it skips the loop */</span>
<a name="l01410"></a>01410                     <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>) &amp;&amp; i&gt;0.0f) {
<a name="l01411"></a>01411                         
<a name="l01412"></a>01412                         shadfac[3]= i*lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>*(1.0f-shadfac[3]);
<a name="l01413"></a>01413                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*(1.0f-lashdw[0]);
<a name="l01414"></a>01414                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*(1.0f-lashdw[1]);
<a name="l01415"></a>01415                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*(1.0f-lashdw[2]);
<a name="l01416"></a>01416                         
<a name="l01417"></a>01417                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>*(1.0f-lashdw[0]);
<a name="l01418"></a>01418                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac4b4dc6752e596555e0c03f1a22b3037">specg</a>*(1.0f-lashdw[1]);
<a name="l01419"></a>01419                         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2] -= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7791e978ef33ceb27b4ec0f441a7cc22">specb</a>*(1.0f-lashdw[2]);
<a name="l01420"></a>01420                         
<a name="l01421"></a>01421                         <span class="keywordflow">return</span>;
<a name="l01422"></a>01422                     }
<a name="l01423"></a>01423                     
<a name="l01424"></a>01424                     i*= shadfac[3];
<a name="l01425"></a>01425                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[3] = shadfac[3]; <span class="comment">/* store this for possible check in troublesome cases */</span>
<a name="l01426"></a>01426                 }
<a name="l01427"></a>01427             }
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429         
<a name="l01430"></a>01430         <span class="comment">/* in case &#39;no diffuse&#39; we still do most calculus, spec can be in shadow.*/</span>
<a name="l01431"></a>01431         <span class="keywordflow">if</span> (!(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#aae2ddb1afedc2c63b748c2af6da2dbcd">LA_NO_DIFF</a>)) {
<a name="l01432"></a>01432             <span class="keywordflow">if</span> (i&gt;0.0f) {
<a name="l01433"></a>01433                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a059921799bee67e88ec82e1409bf4f87">MA_SHADOW_TRA</a>)
<a name="l01434"></a>01434                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">add_to_diffuse</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, shi, is, i*shadfac[0]*lacol[0], i*shadfac[1]*lacol[1], i*shadfac[2]*lacol[2]);
<a name="l01435"></a>01435                 <span class="keywordflow">else</span>
<a name="l01436"></a>01436                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">add_to_diffuse</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, shi, is, i*lacol[0], i*lacol[1], i*lacol[2]);
<a name="l01437"></a>01437             }
<a name="l01438"></a>01438             <span class="comment">/* add light for colored shadow */</span>
<a name="l01439"></a>01439             <span class="keywordflow">if</span> (i_noshad&gt;i &amp;&amp; !(lashdw[0]==0 &amp;&amp; lashdw[1]==0 &amp;&amp; lashdw[2]==0)) {
<a name="l01440"></a>01440                 <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">add_to_diffuse</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>, shi, is, lashdw[0]*(i_noshad-i)*lacol[0], lashdw[1]*(i_noshad-i)*lacol[1], lashdw[2]*(i_noshad-i)*lacol[2]);
<a name="l01441"></a>01441             }
<a name="l01442"></a>01442             <span class="keywordflow">if</span> (i_noshad&gt;0.0f) {
<a name="l01443"></a>01443                 <span class="keywordflow">if</span> (passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)) {
<a name="l01444"></a>01444                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad53b0a03481460ea78600a467ba70cc4">add_to_diffuse</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shi, is, i_noshad*lacol[0], i_noshad*lacol[1], i_noshad*lacol[2]);
<a name="l01445"></a>01445                 }
<a name="l01446"></a>01446                 <span class="keywordflow">else</span>
<a name="l01447"></a>01447                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>);
<a name="l01448"></a>01448             }
<a name="l01449"></a>01449         }
<a name="l01450"></a>01450         
<a name="l01451"></a>01451         <span class="comment">/* specularity */</span>
<a name="l01452"></a>01452         shadfac[3]*= phongcorr; <span class="comment">/* note, shadfac not allowed to be stored nonlocal */</span>
<a name="l01453"></a>01453         
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (shadfac[3]&gt;0.0f &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>!=0.0f &amp;&amp; !(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a134042cbd75d17448cbb831d0f5d2dca">LA_NO_SPEC</a>) &amp;&amp; !(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a7aedd84c62b0b5bb61bda4d66ef1511e">LA_ONLYSHADOW</a>)) {
<a name="l01455"></a>01455             
<a name="l01456"></a>01456             <span class="keywordflow">if</span> (!(passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)));
<a name="l01457"></a>01457             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l01458"></a>01458                 <span class="keywordtype">float</span> t;
<a name="l01459"></a>01459                 <span class="comment">/* hemi uses no spec shaders (yet) */</span>
<a name="l01460"></a>01460                 
<a name="l01461"></a>01461                 lv[0]+= view[0];
<a name="l01462"></a>01462                 lv[1]+= view[1];
<a name="l01463"></a>01463                 lv[2]+= view[2];
<a name="l01464"></a>01464                 
<a name="l01465"></a>01465                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lv);
<a name="l01466"></a>01466                 
<a name="l01467"></a>01467                 t= vn[0]*lv[0]+vn[1]*lv[1]+vn[2]*lv[2];
<a name="l01468"></a>01468                 
<a name="l01469"></a>01469                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l01470"></a>01470                     t= 0.5f*t+0.5f;
<a name="l01471"></a>01471                 }
<a name="l01472"></a>01472                 
<a name="l01473"></a>01473                 t= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>*<a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>(t, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>);
<a name="l01474"></a>01474                 
<a name="l01475"></a>01475                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]+= t*(lacol[0] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>);
<a name="l01476"></a>01476                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]+= t*(lacol[1] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac4b4dc6752e596555e0c03f1a22b3037">specg</a>);
<a name="l01477"></a>01477                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]+= t*(lacol[2] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7791e978ef33ceb27b4ec0f441a7cc22">specb</a>);
<a name="l01478"></a>01478             }
<a name="l01479"></a>01479             <span class="keywordflow">else</span> {
<a name="l01480"></a>01480                 <span class="comment">/* specular shaders */</span>
<a name="l01481"></a>01481                 <span class="keywordtype">float</span> specfac, t;
<a name="l01482"></a>01482                 
<a name="l01483"></a>01483                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a5388526dd73549bd5c619609f90b0b95">spec_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#ab12dc756f128323778af7092b97cb28c">MA_SPEC_PHONG</a>) 
<a name="l01484"></a>01484                     specfac= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a19f6d2d3df87163f7b85f2fe8b36eb3a">Phong_Spec</a>(vn, lv, view, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>, (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) || (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>));
<a name="l01485"></a>01485                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a5388526dd73549bd5c619609f90b0b95">spec_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a8f674cef8579061befa7a6ebb55b9b68">MA_SPEC_COOKTORR</a>) 
<a name="l01486"></a>01486                     specfac= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#af03cf4e4af6e92d1af9f745c562db20b">CookTorr_Spec</a>(vn, lv, view, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>, (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) || (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>));
<a name="l01487"></a>01487                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a5388526dd73549bd5c619609f90b0b95">spec_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#a8b93358f061af9e66aef89625e013b59">MA_SPEC_BLINN</a>) 
<a name="l01488"></a>01488                     specfac= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ac3e0cbc319d9ced77b8cb3bf37d8f500">Blinn_Spec</a>(vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#afeb21165f67d74e9f7e790339ca84474">refrac</a>, (<span class="keywordtype">float</span>)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>, (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) || (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>));
<a name="l01489"></a>01489                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a5388526dd73549bd5c619609f90b0b95">spec_shader</a>==<a class="code" href="../../de/db2/DNA__material__types_8h.html#af1e546bffa8d3fcb67f657d281117d64">MA_SPEC_WARDISO</a>)
<a name="l01490"></a>01490                     specfac= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a62520f4987dc0d54f63415848e562369">WardIso_Spec</a>( vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a53416d0f8bb47b62e637ec8ebed26cbc">rms</a>, (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) || (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>));
<a name="l01491"></a>01491                 <span class="keywordflow">else</span> 
<a name="l01492"></a>01492                     specfac= <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a2a5631f6d5f7568e7c227c141eec7377">Toon_Spec</a>(vn, lv, view, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[2], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef81449c94bb93de33d3fc0be563b9d">param</a>[3], (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a0bad37ed77b794694465e759d5608266">R_TANGENT</a>) || (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#abf6fc702f8ddb5b25ce336fe7f1acb22">MA_TANGENT_V</a>));
<a name="l01493"></a>01493                 
<a name="l01494"></a>01494                 <span class="comment">/* area lamp correction */</span>
<a name="l01495"></a>01495                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a0f089dd53e59d56d00b73493496fa2c3">LA_AREA</a>) specfac*= inp;
<a name="l01496"></a>01496                 
<a name="l01497"></a>01497                 t= shadfac[3]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6b9f98c85ad4d52fd145478c69031689">spec</a>*visifac*specfac;
<a name="l01498"></a>01498                 
<a name="l01499"></a>01499                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ac9fbe75e0474b2f1f77854988a10cc68">MA_RAMP_SPEC</a>) {
<a name="l01500"></a>01500                     <span class="keywordtype">float</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ad41f5027c52d07f258337a69bddd7ded">spec</a>[3];
<a name="l01501"></a>01501                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a4bb75397c2a55233ce86198cad9aa315">do_specular_ramp</a>(shi, specfac, t, spec);
<a name="l01502"></a>01502                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]+= t*(lacol[0] * spec[0]);
<a name="l01503"></a>01503                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]+= t*(lacol[1] * spec[1]);
<a name="l01504"></a>01504                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]+= t*(lacol[2] * spec[2]);
<a name="l01505"></a>01505                 }
<a name="l01506"></a>01506                 <span class="keywordflow">else</span> {
<a name="l01507"></a>01507                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0]+= t*(lacol[0] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5805268c49f3af32d489fcfec7a58f64">specr</a>);
<a name="l01508"></a>01508                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1]+= t*(lacol[1] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac4b4dc6752e596555e0c03f1a22b3037">specg</a>);
<a name="l01509"></a>01509                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]+= t*(lacol[2] * shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7791e978ef33ceb27b4ec0f441a7cc22">specb</a>);
<a name="l01510"></a>01510                 }
<a name="l01511"></a>01511             }
<a name="l01512"></a>01512         }
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 }
<a name="l01515"></a>01515 
<a name="l01516"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a22ca827c42b230c7af0fd9bc0ddb0a25">01516</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a22ca827c42b230c7af0fd9bc0ddb0a25">shade_lamp_loop_only_shadow</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01517"></a>01517 {
<a name="l01518"></a>01518     
<a name="l01519"></a>01519     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>) {
<a name="l01520"></a>01520         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>;
<a name="l01521"></a>01521         <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l01522"></a>01522         <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l01523"></a>01523         <span class="keywordtype">float</span> inpr, lv[3];
<a name="l01524"></a>01524         <span class="keywordtype">float</span> <span class="comment">/* *view, */</span> shadfac[4];
<a name="l01525"></a>01525         <span class="keywordtype">float</span> ir, accum, visifac, lampdist;
<a name="l01526"></a>01526         <span class="keywordtype">float</span> shaded = 0.0f, lightness = 0.0f;
<a name="l01527"></a>01527         
<a name="l01528"></a>01528 
<a name="l01529"></a>01529         <span class="comment">/* view= shi-&gt;view; */</span> <span class="comment">/* UNUSED */</span>
<a name="l01530"></a>01530         accum= ir= 0.0f;
<a name="l01531"></a>01531         
<a name="l01532"></a>01532         lights= <a class="code" href="../../da/d3d/shading_8h.html#a46ae421aea9ade2d89bbc79729d11438">get_lights</a>(shi);
<a name="l01533"></a>01533         <span class="keywordflow">for</span> (go=lights-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l01534"></a>01534             lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l01535"></a>01535             <span class="keywordflow">if</span> (lar==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l01536"></a>01536             
<a name="l01537"></a>01537             <span class="comment">/* yafray: ignore shading by photonlights, not used in Blender */</span>
<a name="l01538"></a>01538             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3702fbb4c76f7b3c21aa19942dc26b5d">LA_YF_PHOTON</a>) <span class="keywordflow">continue</span>;
<a name="l01539"></a>01539             
<a name="l01540"></a>01540             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a>)==0) <span class="keywordflow">continue</span>;
<a name="l01541"></a>01541             <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>)==0) <span class="keywordflow">continue</span>;
<a name="l01542"></a>01542             
<a name="l01543"></a>01543             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> || (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>)) {
<a name="l01544"></a>01544                 visifac= <a class="code" href="../../d8/d7c/gpu__material_8c.html#afb2bdd1c02f7db58b253ea0d265f499d">lamp_get_visibility</a>(lar, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, lv, &amp;lampdist);
<a name="l01545"></a>01545                 ir+= 1.0f;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547                 <span class="keywordflow">if</span> (visifac &lt;= 0.0f) {
<a name="l01548"></a>01548                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>)
<a name="l01549"></a>01549                         accum+= 1.0f;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551                     <span class="keywordflow">continue</span>;
<a name="l01552"></a>01552                 }
<a name="l01553"></a>01553                 inpr= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, lv);
<a name="l01554"></a>01554                 <span class="keywordflow">if</span> (inpr &lt;= 0.0f) {
<a name="l01555"></a>01555                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>)
<a name="l01556"></a>01556                         accum+= 1.0f;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558                     <span class="keywordflow">continue</span>;
<a name="l01559"></a>01559                 }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561                 <a class="code" href="../../da/d3d/shading_8h.html#a2e7f93325508f2e4f42355d511b17ab1">lamp_get_shadow</a>(lar, shi, inpr, shadfac, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>);
<a name="l01562"></a>01562 
<a name="l01563"></a>01563                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>) {
<a name="l01564"></a>01564                     <span class="comment">/* Old &quot;Shadows Only&quot; */</span>
<a name="l01565"></a>01565                     accum+= (1.0f-visifac) + (visifac)*<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shadfac)*shadfac[3];
<a name="l01566"></a>01566                 }
<a name="l01567"></a>01567                 <span class="keywordflow">else</span> {
<a name="l01568"></a>01568                     shaded += <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shadfac)*shadfac[3] * visifac * lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l01569"></a>01569 
<a name="l01570"></a>01570                     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8542808a8b070a3006582b15a60079a4">MA_SO_SHADOW</a>) {
<a name="l01571"></a>01571                         lightness += visifac * lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a>;
<a name="l01572"></a>01572                     }
<a name="l01573"></a>01573                 }
<a name="l01574"></a>01574             }
<a name="l01575"></a>01575         }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577         <span class="comment">/* Apply shadows as alpha */</span>
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (ir&gt;0.0f) {
<a name="l01579"></a>01579             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>) {
<a name="l01580"></a>01580                 accum = 1.0f - accum/ir;
<a name="l01581"></a>01581             }
<a name="l01582"></a>01582             <span class="keywordflow">else</span> {
<a name="l01583"></a>01583                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8542808a8b070a3006582b15a60079a4">MA_SO_SHADOW</a>) {
<a name="l01584"></a>01584                     <span class="keywordflow">if</span> (lightness &gt; 0.0f) {
<a name="l01585"></a>01585                         <span class="comment">/* Get shadow value from between 0.0f and non-shadowed lightness */</span>
<a name="l01586"></a>01586                         accum = (lightness - shaded) / (lightness);
<a name="l01587"></a>01587                     }
<a name="l01588"></a>01588                     <span class="keywordflow">else</span> {
<a name="l01589"></a>01589                         accum = 0.0f;
<a name="l01590"></a>01590                     }
<a name="l01591"></a>01591                 }
<a name="l01592"></a>01592                 <span class="keywordflow">else</span> { <span class="comment">/* shadowonly_flag == MA_SO_SHADED */</span>
<a name="l01593"></a>01593                     <span class="comment">/* Use shaded value */</span>
<a name="l01594"></a>01594                     accum = 1.0f - shaded;
<a name="l01595"></a>01595             }}
<a name="l01596"></a>01596 
<a name="l01597"></a>01597             shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>)*(accum);
<a name="l01598"></a>01598             <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>&lt;0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>=0.0f;
<a name="l01599"></a>01599         }
<a name="l01600"></a>01600         <span class="keywordflow">else</span> {
<a name="l01601"></a>01601             <span class="comment">/* If &quot;fully shaded&quot;, use full alpha even on areas that have no lights */</span>
<a name="l01602"></a>01602             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#af1b935719ce658378a452742e7df81ac">MA_SO_SHADED</a>) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>=shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01603"></a>01603             <span class="keywordflow">else</span> shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= 0.f;
<a name="l01604"></a>01604         }
<a name="l01605"></a>01605     }
<a name="l01606"></a>01606     
<a name="l01607"></a>01607     <span class="comment">/* quite disputable this...  also note it doesn&#39;t mirror-raytrace */</span>    
<a name="l01608"></a>01608     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>)) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>!=0.0f) {
<a name="l01609"></a>01609         <span class="keywordtype">float</span> f;
<a name="l01610"></a>01610         
<a name="l01611"></a>01611         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>) {
<a name="l01612"></a>01612             f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aoenergy*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>;
<a name="l01613"></a>01613             
<a name="l01614"></a>01614             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.aomix==<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aac5d4e103600441eb820660a344f078b">WO_AOADD</a>) {
<a name="l01615"></a>01615                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>) {
<a name="l01616"></a>01616                     f= f*(1.0f - <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>));
<a name="l01617"></a>01617                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> + f)*f;
<a name="l01618"></a>01618                 }
<a name="l01619"></a>01619                 <span class="keywordflow">else</span> {
<a name="l01620"></a>01620                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> -= f*<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01621"></a>01621                     <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>&lt;0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>=0.0f;
<a name="l01622"></a>01622                 }
<a name="l01623"></a>01623             }
<a name="l01624"></a>01624             <span class="keywordflow">else</span> <span class="comment">/* AO Multiply */</span>
<a name="l01625"></a>01625                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= (1.0f - f)*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> + f*(1.0f - (1.0f - shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>)*<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>));
<a name="l01626"></a>01626         }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>) {
<a name="l01629"></a>01629             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aa3ac55f5156a1f2cd689f501ce58c8ab">shadowonly_flag</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a8bcf07fbd4171ce29a812d7b48e20bcb">MA_SO_OLD</a>) {
<a name="l01630"></a>01630                 f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_env_energy*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>*(1.0f - <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>));
<a name="l01631"></a>01631                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> + f)*f;
<a name="l01632"></a>01632             }
<a name="l01633"></a>01633             <span class="keywordflow">else</span> {
<a name="l01634"></a>01634                 f= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.ao_env_energy*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afb86c90a2f9fc60ebd3bba0a1985e4af">amb</a>;
<a name="l01635"></a>01635                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> -= f*<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a97cc96e7c7c3e3a53867bec210eeeb7f">rgb_to_grayscale</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01636"></a>01636                 <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>&lt;0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>=0.0f;
<a name="l01637"></a>01637             }
<a name="l01638"></a>01638         }
<a name="l01639"></a>01639     }
<a name="l01640"></a>01640 }
<a name="l01641"></a>01641 
<a name="l01642"></a>01642 <span class="comment">/* let&#39;s map negative light as if it mirrors positive light, otherwise negative values disappear */</span>
<a name="l01643"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a51373460d2889f9cb804abd9e2c13457">01643</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a51373460d2889f9cb804abd9e2c13457">wrld_exposure_correct</a>(<span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>[3])
<a name="l01644"></a>01644 {
<a name="l01645"></a>01645     
<a name="l01646"></a>01646     diff[0]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.linfac*(1.0f-<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>( diff[0]*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.logfac) );
<a name="l01647"></a>01647     diff[1]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.linfac*(1.0f-<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>( diff[1]*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.logfac) );
<a name="l01648"></a>01648     diff[2]= <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.linfac*(1.0f-<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>( diff[2]*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.logfac) );
<a name="l01649"></a>01649 }
<a name="l01650"></a>01650 
<a name="l01651"></a><a class="code" href="../../d1/ddb/shadeoutput_8c.html#a1e84ab8780351df9a3537d0288fc961d">01651</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d3d/shading_8h.html#af495abf2cafb74fc342922572bcfb310">shade_lamp_loop</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l01652"></a>01652 {
<a name="l01653"></a>01653     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l01654"></a>01654     <span class="keywordtype">int</span> passflag= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a>;
<a name="l01655"></a>01655     
<a name="l01656"></a>01656     memset(shr, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>));
<a name="l01657"></a>01657     
<a name="l01658"></a>01658     <span class="keywordflow">if</span> (!(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>)) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a> = 1.0f;
<a name="l01659"></a>01659     
<a name="l01660"></a>01660     <span class="comment">/* separate loop */</span>
<a name="l01661"></a>01661     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acbcd1a76590cdcea3e105151927ec33d">MA_ONLYSHADOW</a>) {
<a name="l01662"></a>01662         <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a22ca827c42b230c7af0fd9bc0ddb0a25">shade_lamp_loop_only_shadow</a>(shi, shr);
<a name="l01663"></a>01663         <span class="keywordflow">return</span>;
<a name="l01664"></a>01664     }
<a name="l01665"></a>01665     
<a name="l01666"></a>01666     <span class="comment">/* envmap hack, always reset */</span>
<a name="l01667"></a>01667     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[3]= 0.0f;
<a name="l01668"></a>01668     
<a name="l01669"></a>01669     <span class="comment">/* material color itself */</span>
<a name="l01670"></a>01670     <span class="keywordflow">if</span> (passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>)) {
<a name="l01671"></a>01671         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a95f694c6f90519ab830e9b9fa87d62e6">MA_FACETEXTURE</a>)) {
<a name="l01672"></a>01672             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0];
<a name="l01673"></a>01673             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1];
<a name="l01674"></a>01674             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2];
<a name="l01675"></a>01675             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a53cd927e4c5fffa12f274f6ca24de2c5">MA_FACETEXTURE_ALPHA</a>))
<a name="l01676"></a>01676                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l01677"></a>01677         }
<a name="l01678"></a>01678         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a738a0d7c46ba3b6726d95e0842e020ce">MA_VERTEXCOLP</a>)) {
<a name="l01679"></a>01679             <span class="keywordtype">float</span> neg_alpha = 1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l01680"></a>01680             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l01681"></a>01681             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l01682"></a>01682             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*neg_alpha + shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3];
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4a2e1eeb040d8e99f888fe4ba999f9d5">texco</a>) {
<a name="l01685"></a>01685             <a class="code" href="../../d8/d7c/gpu__material_8c.html#ab09827a486fe37e91a118c621f94cfdd">do_material_tex</a>(shi, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l01686"></a>01686             <span class="keywordflow">if</span> (!(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>)) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a> = 1.0f;
<a name="l01687"></a>01687         }
<a name="l01688"></a>01688         
<a name="l01689"></a>01689         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01690"></a>01690         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01691"></a>01691         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01692"></a>01692         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01693"></a>01693 
<a name="l01694"></a>01694         <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4194cd3d6b882eab15895c35e9e4df98">sss_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a585644fc49f4cd9ef4411239035da901">MA_DIFF_SSS</a>) &amp;&amp; !<a class="code" href="../../d8/d59/sss_8h.html#a88abb0d4810ede2c367363a5e38a4c49">sss_pass_done</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, ma)) {
<a name="l01695"></a>01695             <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a> == 0.0f) {
<a name="l01696"></a>01696                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= 1.0f;
<a name="l01697"></a>01697                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[0]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[1]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[2]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3]= 1.0f;
<a name="l01698"></a>01698             }
<a name="l01699"></a>01699             <span class="keywordflow">else</span> {
<a name="l01700"></a>01700                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01701"></a>01701                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01702"></a>01702                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01703"></a>01703                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01704"></a>01704                 
<a name="l01705"></a>01705                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[0]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[0], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01706"></a>01706                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[1]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[1], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01707"></a>01707                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[2]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[2], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01708"></a>01708                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3], ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>);
<a name="l01709"></a>01709             }
<a name="l01710"></a>01710         }
<a name="l01711"></a>01711     }
<a name="l01712"></a>01712     
<a name="l01713"></a>01713     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a711a44cc51cfb78f529c3ac59306e756">MA_SHLESS</a>) {
<a name="l01714"></a>01714         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>;
<a name="l01715"></a>01715         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>;
<a name="l01716"></a>01716         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>;
<a name="l01717"></a>01717         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01718"></a>01718         <span class="keywordflow">return</span>;
<a name="l01719"></a>01719     }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721     <span class="keywordflow">if</span> ( (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a964d5c8ee254af6ab1a167cb8e5e36d9">MA_VERTEXCOL</a>|<a class="code" href="../../de/db2/DNA__material__types_8h.html#a738a0d7c46ba3b6726d95e0842e020ce">MA_VERTEXCOLP</a>))== <a class="code" href="../../de/db2/DNA__material__types_8h.html#a964d5c8ee254af6ab1a167cb8e5e36d9">MA_VERTEXCOL</a> ) {   <span class="comment">// vertexcolor light</span>
<a name="l01722"></a>01722         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[0]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3]);
<a name="l01723"></a>01723         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[1]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3]);
<a name="l01724"></a>01724         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>+shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[2]*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3277a1d352b5a03266a3e29bb0b73a47">vcol</a>[3]);
<a name="l01725"></a>01725     }
<a name="l01726"></a>01726     <span class="keywordflow">else</span> {
<a name="l01727"></a>01727         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>;
<a name="l01728"></a>01728         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aca79c2c087d25d8f2653aa1858644a4c">g</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>;
<a name="l01729"></a>01729         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a65508eadac1439c5bc133bb290d6ba8f">b</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aea9ee587634002c443a05d336f8b13fa">emit</a>;
<a name="l01730"></a>01730     }
<a name="l01731"></a>01731     
<a name="l01732"></a>01732     <span class="comment">/* AO pass */</span>
<a name="l01733"></a>01733     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; (<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>|<a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>)) {
<a name="l01734"></a>01734         <span class="keywordflow">if</span> (((passflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>))) ||
<a name="l01735"></a>01735             (passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>)))
<a name="l01736"></a>01736         {
<a name="l01737"></a>01737             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>) {
<a name="l01738"></a>01738                 <span class="comment">/* AO was calculated for scanline already */</span>
<a name="l01739"></a>01739                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> || shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8efc677eeb02c1f42b70c0bcf0027baf">volume_depth</a>)
<a name="l01740"></a>01740                     <a class="code" href="../../da/d3d/shading_8h.html#aedd8ad2e96c2da7ee49dc39c0bac2652">ambient_occlusion</a>(shi);
<a name="l01741"></a>01741                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a8f963f020e1c8f2a3ac935dd93ea2da2">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01742"></a>01742                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#aef21ece387f433b7c0ee99a38bf23baa">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>); <span class="comment">// XXX multiply</span>
<a name="l01743"></a>01743                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a1326474f281bc61cfd3e1eb930b43b32">indirect</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>); <span class="comment">// XXX multiply</span>
<a name="l01744"></a>01744             }
<a name="l01745"></a>01745         }
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747     
<a name="l01748"></a>01748     <span class="comment">/* lighting pass */</span>
<a name="l01749"></a>01749     <span class="keywordflow">if</span> (passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)) {
<a name="l01750"></a>01750         <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l01751"></a>01751         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>;
<a name="l01752"></a>01752         <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l01753"></a>01753         
<a name="l01754"></a>01754         lights= <a class="code" href="../../da/d3d/shading_8h.html#a46ae421aea9ade2d89bbc79729d11438">get_lights</a>(shi);
<a name="l01755"></a>01755         <span class="keywordflow">for</span> (go=lights-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l01756"></a>01756             lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l01757"></a>01757             <span class="keywordflow">if</span> (lar==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l01758"></a>01758             
<a name="l01759"></a>01759             <span class="comment">/* yafray: ignore shading by photonlights, not used in Blender */</span>
<a name="l01760"></a>01760             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3702fbb4c76f7b3c21aa19942dc26b5d">LA_YF_PHOTON</a>) <span class="keywordflow">continue</span>;
<a name="l01761"></a>01761             
<a name="l01762"></a>01762             <span class="comment">/* test for lamp layer */</span>
<a name="l01763"></a>01763             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a>)==0) <span class="keywordflow">continue</span>;
<a name="l01764"></a>01764             <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>)==0) <span class="keywordflow">continue</span>;
<a name="l01765"></a>01765             
<a name="l01766"></a>01766             <span class="comment">/* accumulates in shr-&gt;diff and shr-&gt;spec and shr-&gt;shad (diffuse with shadow!) */</span>
<a name="l01767"></a>01767             <a class="code" href="../../d1/ddb/shadeoutput_8c.html#adfea97c0ab3261034cbe9e73719daf8c">shade_one_light</a>(lar, shi, shr, passflag);
<a name="l01768"></a>01768         }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         <span class="comment">/* this check is to prevent only shadow lamps from producing negative</span>
<a name="l01771"></a>01771 <span class="comment">         * colors.*/</span>
<a name="l01772"></a>01772         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0] = 0;
<a name="l01773"></a>01773         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1] = 0;
<a name="l01774"></a>01774         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2] = 0;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0] = 0;
<a name="l01777"></a>01777         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1] = 0;
<a name="l01778"></a>01778         <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2] &lt; 0) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2] = 0;
<a name="l01779"></a>01779                         
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4194cd3d6b882eab15895c35e9e4df98">sss_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a585644fc49f4cd9ef4411239035da901">MA_DIFF_SSS</a>) {
<a name="l01781"></a>01781             <span class="keywordtype">float</span> sss[3], col[3], invalpha, texfac= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9d4ee8da747a37dcb0c3234ebf8be090">sss_texfac</a>;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783             <span class="comment">/* this will return false in the preprocess stage */</span>
<a name="l01784"></a>01784             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d59/sss_8h.html#a12341872e0f273e701db748112e60b7e">sample_sss</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, ma, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, sss)) {
<a name="l01785"></a>01785                 invalpha= (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3] &gt; FLT_EPSILON)? 1.0f/shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>[3]: 1.0f;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (texfac==0.0f) {
<a name="l01788"></a>01788                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>);
<a name="l01789"></a>01789                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(col, invalpha);
<a name="l01790"></a>01790                 }
<a name="l01791"></a>01791                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (texfac==1.0f) {
<a name="l01792"></a>01792                     col[0]= col[1]= col[2]= 1.0f;
<a name="l01793"></a>01793                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(col, invalpha);
<a name="l01794"></a>01794                 }
<a name="l01795"></a>01795                 <span class="keywordflow">else</span> {
<a name="l01796"></a>01796                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a37b2fcfeb57e1ca44c82fbd3d6d2c5d4">col</a>);
<a name="l01797"></a>01797                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(col, invalpha);
<a name="l01798"></a>01798                     col[0]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(col[0], 1.0f-texfac);
<a name="l01799"></a>01799                     col[1]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(col[1], 1.0f-texfac);
<a name="l01800"></a>01800                     col[2]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(col[2], 1.0f-texfac);
<a name="l01801"></a>01801                 }
<a name="l01802"></a>01802 
<a name="l01803"></a>01803                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]= sss[0]*col[0];
<a name="l01804"></a>01804                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]= sss[1]*col[1];
<a name="l01805"></a>01805                 shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]= sss[2]*col[2];
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)    {
<a name="l01808"></a>01808                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0];
<a name="l01809"></a>01809                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1];
<a name="l01810"></a>01810                     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2];
<a name="l01811"></a>01811                 }
<a name="l01812"></a>01812             }
<a name="l01813"></a>01813         }
<a name="l01814"></a>01814         
<a name="l01815"></a>01815         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a>)    
<a name="l01816"></a>01816             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>);   <span class="comment">/* note, no &#39;;&#39; ! */</span>
<a name="l01817"></a>01817         <span class="keywordflow">else</span>
<a name="l01818"></a>01818             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>);
<a name="l01819"></a>01819             
<a name="l01820"></a>01820         <span class="comment">/* calculate shadow pass, we use a multiplication mask */</span>
<a name="l01821"></a>01821         <span class="comment">/* if diff = 0,0,0 it doesn&#39;t matter what the shadow pass is, so leave it as is */</span>
<a name="l01822"></a>01822         <span class="keywordflow">if</span> (passflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abd6b74153f40d08f810295d1e39eaaa2">SCE_PASS_SHADOW</a> &amp;&amp; !(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]==0.0f &amp;&amp; shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]==0.0f &amp;&amp; shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]==0.0f)) {
<a name="l01823"></a>01823             <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0]!=0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0]/shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[0];
<a name="l01824"></a>01824             <span class="comment">/* can&#39;t determine proper shadow from shad/diff (0/0), so use shadow intensity */</span>
<a name="l01825"></a>01825             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0]==0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[0]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[3];
<a name="l01826"></a>01826 
<a name="l01827"></a>01827             <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1]!=0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1]/shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[1];
<a name="l01828"></a>01828             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1]==0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[1]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[3];
<a name="l01829"></a>01829 
<a name="l01830"></a>01830             <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2]!=0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2]/shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>[2];
<a name="l01831"></a>01831             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2]==0.0f) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[2]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a242f75dbd0148faee3b17e95abf31970">shad</a>[3];
<a name="l01832"></a>01832         }
<a name="l01833"></a>01833         
<a name="l01834"></a>01834         <span class="comment">/* exposure correction */</span>
<a name="l01835"></a>01835         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.exp!=0.0f || <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.range!=1.0f) &amp;&amp; !<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.sss_points) {
<a name="l01836"></a>01836             <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a51373460d2889f9cb804abd9e2c13457">wrld_exposure_correct</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);   <span class="comment">/* has no spec! */</span>
<a name="l01837"></a>01837             <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a51373460d2889f9cb804abd9e2c13457">wrld_exposure_correct</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l01838"></a>01838         }
<a name="l01839"></a>01839     }
<a name="l01840"></a>01840     
<a name="l01841"></a>01841     <span class="comment">/* alpha in end, spec can influence it */</span>
<a name="l01842"></a>01842     <span class="keywordflow">if</span> (passflag &amp; (<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>)) {
<a name="l01843"></a>01843         <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae4a30ec1f7d7d6e01e60c93be89bdf2c">fresnel_tra</a>!=0.0f) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>))
<a name="l01844"></a>01844             shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>*= <a class="code" href="../../da/d3d/shading_8h.html#aa11ccdbc8b020c463d1731fa1415bbac">fresnel_fac</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a021f7ea9f2f7721c4e6be2677d269596">fresnel_tra_i</a>, ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ae4a30ec1f7d7d6e01e60c93be89bdf2c">fresnel_tra</a>);
<a name="l01845"></a>01845             
<a name="l01846"></a>01846         <span class="comment">/* note: shi-&gt;mode! */</span>
<a name="l01847"></a>01847         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a> &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>|<a class="code" href="../../de/db2/DNA__material__types_8h.html#a2f301bfe492802b8461b969fc72b3652">MA_RAYTRANSP</a>))) {
<a name="l01848"></a>01848             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a62e41d3ea3d5ed39f0e2301d409c38c1">spectra</a>!=0.0f) {
<a name="l01849"></a>01849                 <span class="keywordtype">float</span> t = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[0], shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[1], shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>[2]);
<a name="l01850"></a>01850                 t *= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a62e41d3ea3d5ed39f0e2301d409c38c1">spectra</a>;
<a name="l01851"></a>01851                 <span class="keywordflow">if</span> (t&gt;1.0f) t= 1.0f;
<a name="l01852"></a>01852                 shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>= (1.0f-t)*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>+t;
<a name="l01853"></a>01853             }
<a name="l01854"></a>01854         }
<a name="l01855"></a>01855     }
<a name="l01856"></a>01856     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aabd5fc2267edddd2f776d35293662b60">alpha</a>;
<a name="l01857"></a>01857     
<a name="l01858"></a>01858     <span class="comment">/* from now stuff everything in shr-&gt;combined: ambient, AO, ramps, exposure */</span>
<a name="l01859"></a>01859     <span class="keywordflow">if</span> (!(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4194cd3d6b882eab15895c35e9e4df98">sss_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a585644fc49f4cd9ef4411239035da901">MA_DIFF_SSS</a>) || !<a class="code" href="../../d8/d59/sss_8h.html#a88abb0d4810ede2c367363a5e38a4c49">sss_pass_done</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, ma)) {
<a name="l01860"></a>01860         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af0e0e8839056799ccca22fb9c4a0451e">R_SHADOW</a>) {
<a name="l01861"></a>01861             <span class="comment">/* add AO in combined? */</span>
<a name="l01862"></a>01862             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a318ce0a82b265f4b6ad43e4ce3339a49">WO_AMB_OCC</a>)
<a name="l01863"></a>01863                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a24ace58d0d0d66e045061e0591d7a7c5">SCE_PASS_AO</a>)
<a name="l01864"></a>01864                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a96993bab6ec0d0457f33cb84e9bf0776">ambient_occlusion_apply</a>(shi, shr);
<a name="l01865"></a>01865 
<a name="l01866"></a>01866             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a4d18b5135c2c7db33052c0a41f534a2f">WO_ENV_LIGHT</a>)
<a name="l01867"></a>01867                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1f15c7c41dbf511dd638d5025fd295da">SCE_PASS_ENVIRONMENT</a>)
<a name="l01868"></a>01868                     <a class="code" href="../../da/d3d/shading_8h.html#af6bba2bf4eda6fecf904f28acbad74fb">environment_lighting_apply</a>(shi, shr);
<a name="l01869"></a>01869 
<a name="l01870"></a>01870             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.wrld.mode &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>)
<a name="l01871"></a>01871                 <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3815d3ce741d6756606c70d40a1e2475">SCE_PASS_INDIRECT</a>)
<a name="l01872"></a>01872                     <a class="code" href="../../d1/ddb/shadeoutput_8c.html#afd6826f5783fdf8a5c1494b2bc3709ee">indirect_lighting_apply</a>(shi, shr);
<a name="l01873"></a>01873         }
<a name="l01874"></a>01874         
<a name="l01875"></a>01875         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0]+= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a56eee57ffdf9f02ab159afaf391f599b">ambr</a>;
<a name="l01876"></a>01876         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1]+= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5244edfcdbd24937cc45c832a1ed481d">ambg</a>;
<a name="l01877"></a>01877         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2]+= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5d82ef6ebef011a44e03414609806ba3">ambb</a>;
<a name="l01878"></a>01878         
<a name="l01879"></a>01879         <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a5bbad81bcdfe7179f2bc485fcb440adb">MA_RAMP_COL</a>) <a class="code" href="../../d1/ddb/shadeoutput_8c.html#a450afb8bce0ed55bfccf50d621951252">ramp_diffuse_result</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shi);
<a name="l01880"></a>01880     }
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ac9fbe75e0474b2f1f77854988a10cc68">MA_RAMP_SPEC</a>) <a class="code" href="../../d1/ddb/shadeoutput_8c.html#ae224a910d48364e33ff718e5ed03a5b7">ramp_spec_result</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>, shi);
<a name="l01883"></a>01883     
<a name="l01884"></a>01884     <span class="comment">/* refcol is for envmap only */</span>
<a name="l01885"></a>01885     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0]!=0.0f) {
<a name="l01886"></a>01886         <span class="keywordtype">float</span> <a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>[3];
<a name="l01887"></a>01887         
<a name="l01888"></a>01888         result[0]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[1] + (1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ad4145c34ca408955784e2fdd23c2d216">mirr</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0])*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0];
<a name="l01889"></a>01889         result[1]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a81bee106e6df70a3f16844ce36f84e1d">mirg</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[2] + (1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a81bee106e6df70a3f16844ce36f84e1d">mirg</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0])*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1];
<a name="l01890"></a>01890         result[2]= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8134198d223e10b503401a057c503f2a">mirb</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[3] + (1.0f - shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8134198d223e10b503401a057c503f2a">mirb</a>*shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a839a9d88596652f0868ec4c7b4d1d0ca">refcol</a>[0])*shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2];
<a name="l01891"></a>01891         
<a name="l01892"></a>01892         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (passflag &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e9639bb6059fca6eb49c9f99065734e">SCE_PASS_REFLECT</a>)
<a name="l01893"></a>01893             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac9208ad1f6e709cb9003be2491fac7ed">refl</a>, result, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l01894"></a>01894         
<a name="l01895"></a>01895         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; SCE_PASS_REFLECT)
<a name="l01896"></a>01896             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, result);
<a name="l01897"></a>01897             
<a name="l01898"></a>01898     }
<a name="l01899"></a>01899     
<a name="l01900"></a>01900     <span class="comment">/* and add emit and spec */</span>
<a name="l01901"></a>01901     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36483eb50364ade6b32ad7f845be7cf">SCE_PASS_EMIT</a>)
<a name="l01902"></a>01902         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a5d238bbbe32561288bc81b4852c9e497">emit</a>);
<a name="l01903"></a>01903     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>)
<a name="l01904"></a>01904         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a2e5275e9a88f747ecaeb3ce35aee1624">spec</a>);
<a name="l01905"></a>01905     
<a name="l01906"></a>01906     <span class="comment">/* modulate by the object color */</span>
<a name="l01907"></a>01907     <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef8bf00cf7a52e2e5568f5e4d4ca6e5">shade_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a3cf28a61d64b3d405e65968fc22519d0">MA_OBCOLOR</a>) &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>) {
<a name="l01908"></a>01908         <span class="keywordflow">if</span> (!(ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a4194cd3d6b882eab15895c35e9e4df98">sss_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a585644fc49f4cd9ef4411239035da901">MA_DIFF_SSS</a>) || !<a class="code" href="../../d8/d59/sss_8h.html#a88abb0d4810ede2c367363a5e38a4c49">sss_pass_done</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, ma)) {
<a name="l01909"></a>01909             <span class="keywordtype">float</span> obcol[4];
<a name="l01910"></a>01910 
<a name="l01911"></a>01911             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(obcol, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4c1b357960580f8c11b177ccf9ceccb8">col</a>);
<a name="l01912"></a>01912             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(obcol[3], 0.0f, 1.0f);
<a name="l01913"></a>01913 
<a name="l01914"></a>01914             shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] *= obcol[0];
<a name="l01915"></a>01915             shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] *= obcol[1];
<a name="l01916"></a>01916             shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] *= obcol[2];
<a name="l01917"></a>01917             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#aa90a73c1c53e06b3fc175f94616aeea3">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> *= obcol[3];
<a name="l01918"></a>01918         }
<a name="l01919"></a>01919     }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3]= shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>;
<a name="l01922"></a>01922 }
<a name="l01923"></a>01923 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:54 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
