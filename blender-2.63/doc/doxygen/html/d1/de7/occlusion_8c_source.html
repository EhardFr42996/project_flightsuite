<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: occlusion.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">occlusion.c</div>  </div>
</div>
<div class="contents">
<a href="../../d1/de7/occlusion_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* </span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00006"></a>00006 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00007"></a>00007 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00008"></a>00008 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00016"></a>00016 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00017"></a>00017 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * The Original Code is Copyright (C) 2008 Blender Foundation.</span>
<a name="l00020"></a>00020 <span class="comment"> * All rights reserved.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * Contributor(s): Brecht Van Lommel.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d49/RE__shader__ext_8h.html">RE_shader_ext.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">/* local includes */</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d3a/occlusion_8h.html">occlusion.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d05/pixelshading_8h.html">pixelshading.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">/* ------------------------- Declarations --------------------------- */</span>
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aa96cda3dc4327fc103977fd4483aefb2">00066</a> <span class="preprocessor">#define INVALID_INDEX ((int)(~0))</span>
<a name="l00067"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a8c827faf307c77be8e926ab83420b53d">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define INVPI 0.31830988618379069f</span>
<a name="l00068"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define TOTCHILD 8</span>
<a name="l00069"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a4f73a2c875a455a94665a1fab2ad8e31">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define CACHE_STEP 3</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="../../d6/d37/structOcclusionCacheSample.html">00071</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> {
<a name="l00072"></a><a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a35bc139aa16ed07d92d73690120df40b">00072</a>     <span class="keywordtype">float</span> <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ad57e054b757213530d673bff6787b578">co</a>[3], <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a35bc139aa16ed07d92d73690120df40b">n</a>[3], <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[3], <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[3], <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[3], <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>, <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a43524cbdcde4458d587a29210b010dbd">dist2</a>;
<a name="l00073"></a><a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aed22957eb1d7d278dc93f90f64338ede">00073</a>     <span class="keywordtype">int</span> <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a5d993212b07302368c9edd1fdf64fe39">x</a>, <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aed22957eb1d7d278dc93f90f64338ede">y</a>, <a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ac1a1f81ad9b151a4fadb88f9cd0fcd02">filled</a>;
<a name="l00074"></a>00074 } <a class="code" href="../../d1/de7/occlusion_8c.html#ac5b535015d46d6e3984c0a970ba8756b">OcclusionCacheSample</a>;
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="../../d5/d68/structOcclusionCache.html">00076</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> {
<a name="l00077"></a><a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">00077</a>     <a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> *<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>;
<a name="l00078"></a><a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">00078</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/d68/structOcclusionCache.html#aa198fda31766a23e5437fbf2785785b0">x</a>, <a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">y</a>, <a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a>, <a class="code" href="../../d5/d68/structOcclusionCache.html#a489501c813fcd5ead2c9f5337bc3764b">h</a>, <a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>;
<a name="l00079"></a>00079 } <a class="code" href="../../d1/de7/occlusion_8c.html#a2525d52f17b59f41332bde1b56b2ff12">OcclusionCache</a>;
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="../../d4/d76/structOccFace.html">00081</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> {
<a name="l00082"></a><a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">00082</a>     <span class="keywordtype">int</span> <a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>;
<a name="l00083"></a><a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">00083</a>     <span class="keywordtype">int</span> <a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>;
<a name="l00084"></a>00084 } <a class="code" href="../../d1/de7/occlusion_8c.html#ac98492982f761da3b1a7a636958cd81c">OccFace</a>;
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="../../de/d2f/structOccNode.html">00086</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> {
<a name="l00087"></a><a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">00087</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>[3], <a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>;
<a name="l00088"></a><a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">00088</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>[9], <a class="code" href="../../de/d2f/structOccNode.html#a362e7fab1ebc60d7dcd86abeef7ba25a">dco</a>;
<a name="l00089"></a><a class="code" href="../../de/d2f/structOccNode.html#a53bff691dc5ccdffb25dfef89b757571">00089</a>     <span class="keywordtype">float</span> <a class="code" href="../../de/d2f/structOccNode.html#a3d7cc3cd0cc1682b303b4f95530da51e">occlusion</a>, <a class="code" href="../../de/d2f/structOccNode.html#a53bff691dc5ccdffb25dfef89b757571">rad</a>[3];
<a name="l00090"></a><a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">00090</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a>;
<a name="l00091"></a>00091     <span class="keyword">union </span>{
<a name="l00092"></a>00092         <span class="comment">//OccFace face;</span>
<a name="l00093"></a><a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">00093</a>         <span class="keywordtype">int</span> <a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>;
<a name="l00094"></a><a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">00094</a>         <span class="keyword">struct </span><a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>;
<a name="l00095"></a>00095     } <a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>];
<a name="l00096"></a>00096 } <a class="code" href="../../d1/de7/occlusion_8c.html#a651d132c73cb9dd068a6017ae0e0b6ea">OccNode</a>;
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html">00098</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> {
<a name="l00099"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">00099</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>;
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">00101</a>     float (*<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>)[3];     <span class="comment">/* temporary during build */</span>
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">00103</a>     <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>;      <span class="comment">/* instance and face indices */</span>
<a name="l00104"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">00104</a>     <span class="keywordtype">float</span> *<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>;   <span class="comment">/* occlusion for faces */</span>
<a name="l00105"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">00105</a>     float (*<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>)[3];    <span class="comment">/* radiance for faces */</span>
<a name="l00106"></a>00106     
<a name="l00107"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">00107</a>     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">00109</a>     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> **<a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">stack</a>[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l00110"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">00110</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">maxdepth</a>;
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">00112</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>;
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a9c07b6d0946b7ce52663dfa17e9f0f5a">00114</a>     <span class="keywordtype">float</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#a9c07b6d0946b7ce52663dfa17e9f0f5a">error</a>;
<a name="l00115"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#ae87341d820cf6ab12fbf4076aba3f2e9">00115</a>     <span class="keywordtype">float</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#ae87341d820cf6ab12fbf4076aba3f2e9">distfac</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">00117</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>;
<a name="l00118"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a17ccf14a2f79f79715dee1293bd675c2">00118</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#a17ccf14a2f79f79715dee1293bd675c2">totbuildthread</a>;
<a name="l00119"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">00119</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">00121</a>     <a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>;
<a name="l00122"></a>00122 } <a class="code" href="../../d1/de7/occlusion_8c.html#ab66a510dd4824c85e18260fcfc100307">OcclusionTree</a>;
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="../../df/dee/structOcclusionThread.html">00124</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dee/structOcclusionThread.html">OcclusionThread</a> {
<a name="l00125"></a><a class="code" href="../../df/dee/structOcclusionThread.html#a4a0406e48dc8e97dbd89c0cbf7cd8635">00125</a>     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../df/dee/structOcclusionThread.html#a4a0406e48dc8e97dbd89c0cbf7cd8635">re</a>;
<a name="l00126"></a><a class="code" href="../../df/dee/structOcclusionThread.html#a84323dbf05aa889cb74a3d204ef65918">00126</a>     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *<a class="code" href="../../df/dee/structOcclusionThread.html#a84323dbf05aa889cb74a3d204ef65918">mesh</a>;
<a name="l00127"></a><a class="code" href="../../df/dee/structOcclusionThread.html#a7a8a079fd87ba36e19cfdb11703247c1">00127</a>     float (*<a class="code" href="../../df/dee/structOcclusionThread.html#a7a8a079fd87ba36e19cfdb11703247c1">faceao</a>)[3];
<a name="l00128"></a><a class="code" href="../../df/dee/structOcclusionThread.html#a70127ec4b4bc515353aed5b685b26683">00128</a>     float (*<a class="code" href="../../df/dee/structOcclusionThread.html#a70127ec4b4bc515353aed5b685b26683">faceenv</a>)[3];
<a name="l00129"></a><a class="code" href="../../df/dee/structOcclusionThread.html#abfdac9e57f330bed9a192bd4923e9fb0">00129</a>     float (*<a class="code" href="../../df/dee/structOcclusionThread.html#abfdac9e57f330bed9a192bd4923e9fb0">faceindirect</a>)[3];
<a name="l00130"></a><a class="code" href="../../df/dee/structOcclusionThread.html#ac593e4abb3b8b807648a8ae20cec2c1c">00130</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dee/structOcclusionThread.html#a0d889f185a69517fb9941e91927f94d9">begin</a>, <a class="code" href="../../df/dee/structOcclusionThread.html#ac593e4abb3b8b807648a8ae20cec2c1c">end</a>;
<a name="l00131"></a><a class="code" href="../../df/dee/structOcclusionThread.html#af848832fc76be985fa1690a0cbf80359">00131</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dee/structOcclusionThread.html#af848832fc76be985fa1690a0cbf80359">thread</a>;
<a name="l00132"></a>00132 } <a class="code" href="../../d1/de7/occlusion_8c.html#acedade9262e46b444e439043f9a181af">OcclusionThread</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="../../d4/d92/structOcclusionBuildThread.html">00134</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d92/structOcclusionBuildThread.html">OcclusionBuildThread</a> {
<a name="l00135"></a><a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a59d9c726b1d823958669e2acbac57367">00135</a>     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a59d9c726b1d823958669e2acbac57367">tree</a>;
<a name="l00136"></a><a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a40b4fff94eced581a04b89b5babbd3fa">00136</a>     <span class="keywordtype">int</span> <a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a87060618fd5544a547979a47648f6258">begin</a>, <a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a40b4fff94eced581a04b89b5babbd3fa">end</a>, <a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a794fe9eed0d90f0f0426a77f0cbbc990">depth</a>;
<a name="l00137"></a><a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a294d4ded8c5ee265e72f373287a336c3">00137</a>     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a294d4ded8c5ee265e72f373287a336c3">node</a>;
<a name="l00138"></a>00138 } <a class="code" href="../../d1/de7/occlusion_8c.html#ae1fe2de953e297904fb80965ac87f319">OcclusionBuildThread</a>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="comment">/* ------------------------- Shading --------------------------- */</span>
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="keyword">extern</span> <a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>; <span class="comment">// meh</span>
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a7e7e4d5ea754863758ce722fbe734f50">00144</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a7e7e4d5ea754863758ce722fbe734f50">occ_shade</a>(<a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">float</span> *rad)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l00147"></a>00147     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a04459ca02eeeb903829f68764bc98ef9">shr</a>;
<a name="l00148"></a>00148     <span class="keywordtype">float</span> l, u, v, *v1, *v2, *v3;
<a name="l00149"></a>00149     
<a name="l00150"></a>00150     <span class="comment">/* init */</span>
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l00152"></a>00152         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c69ba091ed77f7eb35827b464f8293c">u</a>= u= 0.5f;
<a name="l00153"></a>00153         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a252fb3fb012292cbafd278f216da83b9">v</a>= v= 0.5f;
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     <span class="keywordflow">else</span> {
<a name="l00156"></a>00156         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c69ba091ed77f7eb35827b464f8293c">u</a>= u= 1.0f/3.0f;
<a name="l00157"></a>00157         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a252fb3fb012292cbafd278f216da83b9">v</a>= v= 1.0f/3.0f;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">/* setup render coordinates */</span>
<a name="l00161"></a>00161     v1= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00162"></a>00162     v2= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00163"></a>00163     v3= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>;
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     <span class="comment">/* renderco */</span>
<a name="l00166"></a>00166     l= 1.0f-u-v;
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[0]= l*v3[0]+u*v1[0]+v*v2[0];
<a name="l00169"></a>00169     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[1]= l*v3[1]+u*v1[1]+v*v2[1];
<a name="l00170"></a>00170     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>[2]= l*v3[2]+u*v1[2]+v*v2[2];
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <a class="code" href="../../da/d3d/shading_8h.html#a2fbc51b35063837281057ec90573a79c">shade_input_set_triangle_i</a>(shi, obi, vlr, 0, 1, 2);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">/* set up view vector */</span>
<a name="l00175"></a>00175     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l00176"></a>00176     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00177"></a>00177     
<a name="l00178"></a>00178     <span class="comment">/* cache for shadow */</span>
<a name="l00179"></a>00179     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#acddae7233c3d277d52ee99cb75272aa2">samplenr</a>++;
<a name="l00180"></a>00180     
<a name="l00181"></a>00181     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>= 0; <span class="comment">// TODO</span>
<a name="l00182"></a>00182     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>= 0;
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     <a class="code" href="../../da/d3d/shading_8h.html#a2e7d2d748fbf7f08e521ee0d65c0c692">shade_input_set_normals</a>(shi);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="comment">/* no normal flip */</span>
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac7c88ebbd25cdabe29be8fb909195f84">flippednor</a>)
<a name="l00188"></a>00188         <a class="code" href="../../da/d3d/shading_8h.html#a7525ce28b0e4710ec11b405aa40a0491">shade_input_flip_normals</a>(shi);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>, 0.0001f); <span class="comment">/* ugly.. */</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">/* not a pretty solution, but fixes common cases */</span>
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> &amp;&amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a87014edc673c17c72d0cf437921da147">OB_NEG_SCALE</a>) {
<a name="l00194"></a>00194         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6bc47e93fcf9cf33252c93280653fd11">vn</a>);
<a name="l00195"></a>00195         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>);
<a name="l00196"></a>00196         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2c2e4145529a7185b8b6ef79571e84ee">nmapnorm</a>);
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="comment">/* init material vars */</span>
<a name="l00200"></a>00200     <span class="comment">// note, keep this synced with render_types.h</span>
<a name="l00201"></a>00201     memcpy(&amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae29fcda3d2afcb662348380f6db8cea2">r</a>, &amp;shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a9e892cbd7e25b6fd5ee00c383cd9cacf">r</a>, 23*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00202"></a>00202     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2a5e7d77ff13b4d28f322eebbb07c8c6">har</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#af7e6796633eed3cf2fe85a929fd11199">har</a>;
<a name="l00203"></a>00203     
<a name="l00204"></a>00204     <span class="comment">/* render */</span>
<a name="l00205"></a>00205     <a class="code" href="../../da/d3d/shading_8h.html#af478c72371d2e749f171cf985baa9dcb">shade_input_set_shade_texco</a>(shi);
<a name="l00206"></a>00206     <a class="code" href="../../da/d3d/shading_8h.html#a1091bd5b76b59935ebd79d3a42e129d4">shade_material_loop</a>(shi, shr); <span class="comment">/* todo: nodes */</span>
<a name="l00207"></a>00207     
<a name="l00208"></a>00208     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rad, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a10c8e6811be4dd35f39d3bc264c6f2c4">00211</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a10c8e6811be4dd35f39d3bc264c6f2c4">occ_build_shade</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> ssamp;
<a name="l00214"></a>00214     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00215"></a>00215     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l00216"></a>00216     <span class="keywordtype">int</span> a;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     R= *re;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">/* setup shade sample with correct passes */</span>
<a name="l00221"></a>00221     memset(&amp;ssamp, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a>));
<a name="l00222"></a>00222     ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>[0].<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>;
<a name="l00223"></a>00223     ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>[0].<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a88d3ba13dfd64dda48ec35ad3ba928ab">SCE_PASS_DIFFUSE</a>|<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4b1485f58943e899a42e74b89f33a982">SCE_PASS_RGBA</a>;
<a name="l00224"></a>00224     ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>[0].<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a>= ~(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a02bf21100b24bc0a3d33e0215c6f41d1">SCE_PASS_SPEC</a>);
<a name="l00225"></a>00225     ssamp.<a class="code" href="../../da/d1b/structShadeSample.html#a82b8b3cc4641dfe4c564e204de17e017">tot</a>= 1;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>; a++) {
<a name="l00228"></a>00228         obi= &amp;R.<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>[tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a].<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>];
<a name="l00229"></a>00229         vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a].<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <a class="code" href="../../d1/de7/occlusion_8c.html#a7e7e4d5ea754863758ce722fbe734f50">occ_shade</a>(&amp;ssamp, obi, vlr, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>[a]);
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="comment">/* ------------------------- Spherical Harmonics --------------------------- */</span>
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">/* Use 2nd order SH =&gt; 9 coefficients, stored in this order:</span>
<a name="l00238"></a>00238 <span class="comment"> * 0 = (0,0),</span>
<a name="l00239"></a>00239 <span class="comment"> * 1 = (1,-1), 2 = (1,0), 3 = (1,1),</span>
<a name="l00240"></a>00240 <span class="comment"> * 4 = (2,-2), 5 = (2,-1), 6 = (2,0), 7 = (2,1), 8 = (2,2) */</span>
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="../../d1/de7/occlusion_8c.html#afaeed93c31a06f863c5e4017bc1205f3">00242</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#afaeed93c31a06f863c5e4017bc1205f3">sh_copy</a>(<span class="keywordtype">float</span> *shresult, <span class="keywordtype">float</span> *sh)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     memcpy(shresult, sh, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*9);
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a7cfada049262f96e550d31e6a82ccbcb">00247</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a7cfada049262f96e550d31e6a82ccbcb">sh_mul</a>(<span class="keywordtype">float</span> *sh, <span class="keywordtype">float</span> f)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">for</span> (i=0; i&lt;9; i++)
<a name="l00252"></a>00252         sh[i] *= f;
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a57282fbc70837fde9094084691da51e3">00255</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a57282fbc70837fde9094084691da51e3">sh_add</a>(<span class="keywordtype">float</span> *shresult, <span class="keywordtype">float</span> *sh1, <span class="keywordtype">float</span> *sh2)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="keywordflow">for</span> (i=0; i&lt;9; i++)
<a name="l00260"></a>00260         shresult[i]= sh1[i] + sh2[i];
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a30e40429949a892076217ab4b26e5598">00263</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a30e40429949a892076217ab4b26e5598">sh_from_disc</a>(<span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> area, <span class="keywordtype">float</span> *shresult)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265     <span class="comment">/* See formula (3) in:</span>
<a name="l00266"></a>00266 <span class="comment">     * &quot;An Efficient Representation for Irradiance Environment Maps&quot; */</span>
<a name="l00267"></a>00267     <span class="keywordtype">float</span> sh[9], x, y, z;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     x= n[0];
<a name="l00270"></a>00270     y= n[1];
<a name="l00271"></a>00271     z= n[2];
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     sh[0]= 0.282095f;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     sh[1]= 0.488603f*y;
<a name="l00276"></a>00276     sh[2]= 0.488603f*z;
<a name="l00277"></a>00277     sh[3]= 0.488603f*x;
<a name="l00278"></a>00278     
<a name="l00279"></a>00279     sh[4]= 1.092548f*x*y;
<a name="l00280"></a>00280     sh[5]= 1.092548f*y*z;
<a name="l00281"></a>00281     sh[6]= 0.315392f*(3.0f*z*z - 1.0f);
<a name="l00282"></a>00282     sh[7]= 1.092548f*x*z;
<a name="l00283"></a>00283     sh[8]= 0.546274f*(x*x - y*y);
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <a class="code" href="../../d1/de7/occlusion_8c.html#a7cfada049262f96e550d31e6a82ccbcb">sh_mul</a>(sh, area);
<a name="l00286"></a>00286     <a class="code" href="../../d1/de7/occlusion_8c.html#afaeed93c31a06f863c5e4017bc1205f3">sh_copy</a>(shresult, sh);
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aee5cc4c2daea9fabf3a758910f1b15ab">00289</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#aee5cc4c2daea9fabf3a758910f1b15ab">sh_eval</a>(<span class="keywordtype">float</span> *sh, <span class="keywordtype">float</span> *v)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <span class="comment">/* See formula (13) in:</span>
<a name="l00292"></a>00292 <span class="comment">     * &quot;An Efficient Representation for Irradiance Environment Maps&quot; */</span>
<a name="l00293"></a>00293     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> c1 = 0.429043f, c2 = 0.511664f, c3 = 0.743125f;
<a name="l00294"></a>00294     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> c4 = 0.886227f, c5 = 0.247708f;
<a name="l00295"></a>00295     <span class="keywordtype">float</span> x, y, z, <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     x= v[0];
<a name="l00298"></a>00298     y= v[1];
<a name="l00299"></a>00299     z= v[2];
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     sum= c1*sh[8]*(x*x - y*y);
<a name="l00302"></a>00302     sum += c3*sh[6]*z*z;
<a name="l00303"></a>00303     sum += c4*sh[0];
<a name="l00304"></a>00304     sum += -c5*sh[6];
<a name="l00305"></a>00305     sum += 2.0f*c1*(sh[4]*x*y + sh[7]*x*z + sh[5]*y*z);
<a name="l00306"></a>00306     sum += 2.0f*c2*(sh[3]*x + sh[1]*y + sh[2]*z);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">return</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="comment">/* ------------------------------ Building --------------------------------- */</span>
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">00313</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *face, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> normal[3], <span class="keywordtype">float</span> *area)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00316"></a>00316     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l00317"></a>00317     <span class="keywordtype">float</span> v1[3], v2[3], v3[3], v4[3];
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     obi= &amp;R.<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>[face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>];
<a name="l00320"></a>00320     vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>, face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>);
<a name="l00321"></a>00321     
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (co) {
<a name="l00323"></a>00323         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l00324"></a>00324             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(co, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00325"></a>00325         <span class="keywordflow">else</span>
<a name="l00326"></a>00326             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a324f7ddc4d04ef772a00ef7b80cfdef3">cent_tri_v3</a>(co, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l00329"></a>00329             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, co);
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (normal) {
<a name="l00333"></a>00333         normal[0]= -vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[0];
<a name="l00334"></a>00334         normal[1]= -vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[1];
<a name="l00335"></a>00335         normal[2]= -vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ae81ece36296681818fedd6236761ac7b">n</a>[2];
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l00338"></a>00338             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, normal);
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (area) {
<a name="l00342"></a>00342         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00343"></a>00343         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00344"></a>00344         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v3, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v4, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) {
<a name="l00348"></a>00348             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v1);
<a name="l00349"></a>00349             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v2);
<a name="l00350"></a>00350             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v3);
<a name="l00351"></a>00351             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v4);
<a name="l00352"></a>00352         }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="comment">/* todo: correct area for instances */</span>
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l00356"></a>00356             *area= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7051e542338c420d180a6c728a3952a8">area_quad_v3</a>(v1, v2, v3, v4);
<a name="l00357"></a>00357         <span class="keywordflow">else</span>
<a name="l00358"></a>00358             *area= <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(v1, v2, v3);
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">00362</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node)
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *child;
<a name="l00365"></a>00365     <span class="keywordtype">float</span> occ, area, totarea, rad[3];
<a name="l00366"></a>00366     <span class="keywordtype">int</span> a, b, indirect= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     occ= 0.0f;
<a name="l00369"></a>00369     totarea= 0.0f;
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (indirect) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(rad);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> &amp; (1&lt;&lt;b)) {
<a name="l00374"></a>00374             a= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>;
<a name="l00375"></a>00375             <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(&amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a], 0, 0, &amp;area);
<a name="l00376"></a>00376             occ += area*tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[a];
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (indirect) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(rad, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>[a], area);
<a name="l00378"></a>00378             totarea += area;
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>) {
<a name="l00381"></a>00381             child= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>;
<a name="l00382"></a>00382             <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(tree, child);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384             occ += child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>*child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a3d7cc3cd0cc1682b303b4f95530da51e">occlusion</a>;
<a name="l00385"></a>00385             <span class="keywordflow">if</span> (indirect) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(rad, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a53bff691dc5ccdffb25dfef89b757571">rad</a>, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>);
<a name="l00386"></a>00386             totarea += child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="keywordflow">if</span> (totarea != 0.0f) {
<a name="l00391"></a>00391         occ /= totarea;
<a name="l00392"></a>00392         <span class="keywordflow">if</span> (indirect) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(rad, 1.0f/totarea);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394     
<a name="l00395"></a>00395     node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a3d7cc3cd0cc1682b303b4f95530da51e">occlusion</a>= occ;
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (indirect) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a53bff691dc5ccdffb25dfef89b757571">rad</a>, rad);
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a0e13f4724613fba9b1dd20686b9fa664">00399</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a0e13f4724613fba9b1dd20686b9fa664">occ_find_bbox_axis</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>)
<a name="l00400"></a>00400 {
<a name="l00401"></a>00401     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, maxlen= -1.0f;
<a name="l00402"></a>00402     <span class="keywordtype">int</span> a, axis = 0;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keywordflow">for</span> (a = begin; a &lt; end; a++) {
<a name="l00407"></a>00407         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[a], min, max);
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="keywordflow">for</span> (a=0; a&lt;3; a++) {
<a name="l00411"></a>00411         len= max[a] - min[a];
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <span class="keywordflow">if</span> (len &gt; maxlen) {
<a name="l00414"></a>00414             maxlen= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00415"></a>00415             axis= a;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="keywordflow">return</span> axis;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a5c87f6455f4076c7762ec7c2c266ce20">00422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a5c87f6455f4076c7762ec7c2c266ce20">occ_node_from_face</a>(<a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *face, <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <span class="keywordtype">float</span> n[3];
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(face, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, n, &amp;node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>);
<a name="l00427"></a>00427     node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a362e7fab1ebc60d7dcd86abeef7ba25a">dco</a>= 0.0f;
<a name="l00428"></a>00428     <a class="code" href="../../d1/de7/occlusion_8c.html#a30e40429949a892076217ab4b26e5598">sh_from_disc</a>(n, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>);
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aa5388f0b6a6f2f5f22f86e39b1f6c8fd">00431</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#aa5388f0b6a6f2f5f22f86e39b1f6c8fd">occ_build_dco</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> *dco)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433     <span class="keywordtype">int</span> b;
<a name="l00434"></a>00434     <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l00435"></a>00435         <span class="keywordtype">float</span> dist, d[3], nco[3];
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> &amp; (1&lt;&lt;b)) {
<a name="l00438"></a>00438             <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>+node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>, nco, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>) {
<a name="l00441"></a>00441             <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *child= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>;
<a name="l00442"></a>00442             <a class="code" href="../../d1/de7/occlusion_8c.html#aa5388f0b6a6f2f5f22f86e39b1f6c8fd">occ_build_dco</a>(tree, child, co, dco);
<a name="l00443"></a>00443             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(nco, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>);
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445         <span class="keywordflow">else</span> {
<a name="l00446"></a>00446             <span class="keywordflow">continue</span>;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d, nco, co);
<a name="l00450"></a>00450         dist= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, d);
<a name="l00451"></a>00451         <span class="keywordflow">if</span> (dist &gt; *dco)
<a name="l00452"></a>00452             *dco= dist;
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">00456</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span> *<a class="code" href="../../d8/d40/btDbvt_8cpp.html#ad08f07bba2ea0c5c64802b70c686fc68">split</a>)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], mid;
<a name="l00459"></a>00459     <span class="keywordtype">int</span> axis, a, enda;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="comment">/* split in middle of boundbox. this seems faster than median split</span>
<a name="l00462"></a>00462 <span class="comment">     * on complex scenes, possibly since it avoids two distant faces to</span>
<a name="l00463"></a>00463 <span class="comment">     * be in the same node better? */</span>
<a name="l00464"></a>00464     axis= <a class="code" href="../../d1/de7/occlusion_8c.html#a0e13f4724613fba9b1dd20686b9fa664">occ_find_bbox_axis</a>(tree, begin, end, min, max);
<a name="l00465"></a>00465     mid= 0.5f*(min[axis]+max[axis]);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     a= begin;
<a name="l00468"></a>00468     enda= end;
<a name="l00469"></a>00469     <span class="keywordflow">while</span> (a&lt;enda) {
<a name="l00470"></a>00470         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[a][axis] &gt; mid) {
<a name="l00471"></a>00471             enda--;
<a name="l00472"></a>00472             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../d4/d76/structOccFace.html">OccFace</a>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a], tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[enda]);
<a name="l00473"></a>00473             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[a][0], tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[enda][0]);
<a name="l00474"></a>00474             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[a][1], tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[enda][1]);
<a name="l00475"></a>00475             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[a][2], tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[enda][2]);
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         <span class="keywordflow">else</span>
<a name="l00478"></a>00478             a++;
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     *split= enda;
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aaf2458972888af6105ed4056252a334a">00484</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#aaf2458972888af6105ed4056252a334a">occ_build_8_split</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span> *offset, <span class="keywordtype">int</span> *count)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     <span class="comment">/* split faces into eight groups */</span>
<a name="l00487"></a>00487     <span class="keywordtype">int</span> b, splitx, splity[2], splitz[4];
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, begin, end, &amp;splitx);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">/* force split if none found, to deal with degenerate geometry */</span>
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (splitx == begin || splitx == end)
<a name="l00493"></a>00493         splitx= (begin+end)/2;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, begin, splitx, &amp;splity[0]);
<a name="l00496"></a>00496     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, splitx, end, &amp;splity[1]);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, begin, splity[0], &amp;splitz[0]);
<a name="l00499"></a>00499     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, splity[0], splitx, &amp;splitz[1]);
<a name="l00500"></a>00500     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, splitx, splity[1], &amp;splitz[2]);
<a name="l00501"></a>00501     <a class="code" href="../../d1/de7/occlusion_8c.html#ae9392a68b8205b164db8f4f07588a1d8">occ_build_split</a>(tree, splity[1], end, &amp;splitz[3]);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     offset[0]= begin;
<a name="l00504"></a>00504     offset[1]= splitz[0];
<a name="l00505"></a>00505     offset[2]= splity[0];
<a name="l00506"></a>00506     offset[3]= splitz[1];
<a name="l00507"></a>00507     offset[4]= splitx;
<a name="l00508"></a>00508     offset[5]= splitz[2];
<a name="l00509"></a>00509     offset[6]= splity[1];
<a name="l00510"></a>00510     offset[7]= splitz[3];
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="keywordflow">for</span> (b=0; b&lt;7; b++)
<a name="l00513"></a>00513         count[b]= offset[b+1] - offset[b];
<a name="l00514"></a>00514     count[7]= end - offset[7];
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">occ_build_recursive</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node, <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span> depth);
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a6c913815971bdff87935e53f99f98f4d">00519</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d1/de7/occlusion_8c.html#a6c913815971bdff87935e53f99f98f4d">exec_occ_build</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <a class="code" href="../../d4/d92/structOcclusionBuildThread.html">OcclusionBuildThread</a> *othread= (<a class="code" href="../../d4/d92/structOcclusionBuildThread.html">OcclusionBuildThread</a>*)data;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">occ_build_recursive</a>(othread-&gt;<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a59d9c726b1d823958669e2acbac57367">tree</a>, othread-&gt;<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a294d4ded8c5ee265e72f373287a336c3">node</a>, othread-&gt;<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a87060618fd5544a547979a47648f6258">begin</a>, othread-&gt;<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a40b4fff94eced581a04b89b5babbd3fa">end</a>, othread-&gt;<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a794fe9eed0d90f0f0426a77f0cbbc990">depth</a>);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordflow">return</span> 0;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">00528</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">occ_build_recursive</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node, <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end, <span class="keywordtype">int</span> depth)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l00531"></a>00531     <a class="code" href="../../d4/d92/structOcclusionBuildThread.html">OcclusionBuildThread</a> othreads[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l00532"></a>00532     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *child, tmpnode;
<a name="l00533"></a>00533     <span class="comment">/* OccFace *face; */</span>
<a name="l00534"></a>00534     <span class="keywordtype">int</span> a, b, totthread=0, offset[<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>], count[<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>];
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="comment">/* add a new node */</span>
<a name="l00537"></a>00537     node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a3d7cc3cd0cc1682b303b4f95530da51e">occlusion</a>= 1.0f;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     <span class="comment">/* leaf node with only children */</span>
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (end - begin &lt;= <a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>) {
<a name="l00541"></a>00541         <span class="keywordflow">for</span> (a=begin, b=0; a&lt;end; a++, b++) {
<a name="l00542"></a>00542             <span class="comment">/* face= &amp;tree-&gt;face[a]; */</span>
<a name="l00543"></a>00543             node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>= a;
<a name="l00544"></a>00544             node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> |= (1&lt;&lt;b);
<a name="l00545"></a>00545         }
<a name="l00546"></a>00546     }
<a name="l00547"></a>00547     <span class="keywordflow">else</span> {
<a name="l00548"></a>00548         <span class="comment">/* order faces */</span>
<a name="l00549"></a>00549         <a class="code" href="../../d1/de7/occlusion_8c.html#aaf2458972888af6105ed4056252a334a">occ_build_8_split</a>(tree, begin, end, offset, count);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (depth == 1 &amp;&amp; tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>)
<a name="l00552"></a>00552             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../d1/de7/occlusion_8c.html#a6c913815971bdff87935e53f99f98f4d">exec_occ_build</a>, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a17ccf14a2f79f79715dee1293bd675c2">totbuildthread</a>);
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l00555"></a>00555             <span class="keywordflow">if</span> (count[b] == 0) {
<a name="l00556"></a>00556                 node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00557"></a>00557             }
<a name="l00558"></a>00558             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count[b] == 1) {
<a name="l00559"></a>00559                 <span class="comment">/* face= &amp;tree-&gt;face[offset[b]]; */</span>
<a name="l00560"></a>00560                 node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>= offset[b];
<a name="l00561"></a>00561                 node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> |= (1&lt;&lt;b);
<a name="l00562"></a>00562             }
<a name="l00563"></a>00563             <span class="keywordflow">else</span> {
<a name="l00564"></a>00564                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>)
<a name="l00565"></a>00565                     <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567                 child= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a>));
<a name="l00568"></a>00568                 node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>= child;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570                 <span class="comment">/* keep track of maximum depth for stack */</span>
<a name="l00571"></a>00571                 <span class="keywordflow">if</span> (depth+1 &gt; tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">maxdepth</a>)
<a name="l00572"></a>00572                     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">maxdepth</a>= depth+1;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574                 <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>)
<a name="l00575"></a>00575                     <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577                 <span class="keywordflow">if</span> (depth == 1 &amp;&amp; tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>) {
<a name="l00578"></a>00578                     othreads[totthread].<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a59d9c726b1d823958669e2acbac57367">tree</a>= tree;
<a name="l00579"></a>00579                     othreads[totthread].<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a294d4ded8c5ee265e72f373287a336c3">node</a>= child;
<a name="l00580"></a>00580                     othreads[totthread].<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a87060618fd5544a547979a47648f6258">begin</a>= offset[b];
<a name="l00581"></a>00581                     othreads[totthread].<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a40b4fff94eced581a04b89b5babbd3fa">end</a>= offset[b]+count[b];
<a name="l00582"></a>00582                     othreads[totthread].<a class="code" href="../../d4/d92/structOcclusionBuildThread.html#a794fe9eed0d90f0f0426a77f0cbbc990">depth</a>= depth+1;
<a name="l00583"></a>00583                     <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;othreads[totthread]);
<a name="l00584"></a>00584                     totthread++;
<a name="l00585"></a>00585                 }
<a name="l00586"></a>00586                 <span class="keywordflow">else</span>
<a name="l00587"></a>00587                     <a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">occ_build_recursive</a>(tree, child, offset[b], offset[b]+count[b], depth+1);
<a name="l00588"></a>00588             }
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <span class="keywordflow">if</span> (depth == 1 &amp;&amp; tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>)
<a name="l00592"></a>00592             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <span class="comment">/* combine area, position and sh */</span>
<a name="l00596"></a>00596     <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l00597"></a>00597         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> &amp; (1&lt;&lt;b)) {
<a name="l00598"></a>00598             child= &amp;tmpnode;
<a name="l00599"></a>00599             <a class="code" href="../../d1/de7/occlusion_8c.html#a5c87f6455f4076c7762ec7c2c266ce20">occ_node_from_face</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>+node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>, &amp;tmpnode);
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601         <span class="keywordflow">else</span> {
<a name="l00602"></a>00602             child= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>;
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (child) {
<a name="l00606"></a>00606             node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a> += child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>;
<a name="l00607"></a>00607             <a class="code" href="../../d1/de7/occlusion_8c.html#a57282fbc70837fde9094084691da51e3">sh_add</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>);
<a name="l00608"></a>00608             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, child-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>);
<a name="l00609"></a>00609         }
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a> != 0.0f)
<a name="l00613"></a>00613         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, 1.0f/node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="comment">/* compute maximum distance from center */</span>
<a name="l00616"></a>00616     node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a362e7fab1ebc60d7dcd86abeef7ba25a">dco</a>= 0.0f;
<a name="l00617"></a>00617     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a> &gt; 0.0f)
<a name="l00618"></a>00618         <a class="code" href="../../d1/de7/occlusion_8c.html#aa5388f0b6a6f2f5f22f86e39b1f6c8fd">occ_build_dco</a>(tree, node, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, &amp;node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a362e7fab1ebc60d7dcd86abeef7ba25a">dco</a>);
<a name="l00619"></a>00619 }
<a name="l00620"></a>00620 
<a name="l00621"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a239033227b9126a1a3ff5724e1a6cb0c">00621</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a239033227b9126a1a3ff5724e1a6cb0c">occ_build_sh_normalize</a>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623     <span class="comment">/* normalize spherical harmonics to not include area, so</span>
<a name="l00624"></a>00624 <span class="comment">     * we can clamp the dot product and then mutliply by area */</span>
<a name="l00625"></a>00625     <span class="keywordtype">int</span> b;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a> != 0.0f)
<a name="l00628"></a>00628         <a class="code" href="../../d1/de7/occlusion_8c.html#a7cfada049262f96e550d31e6a82ccbcb">sh_mul</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>, 1.0f/node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> &amp; (1&lt;&lt;b));
<a name="l00632"></a>00632         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>)
<a name="l00633"></a>00633             <a class="code" href="../../d1/de7/occlusion_8c.html#a239033227b9126a1a3ff5724e1a6cb0c">occ_build_sh_normalize</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>);
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a353d8ce319c2b193e95e5aa12a81ef79">00637</a> <span class="keyword">static</span> <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *<a class="code" href="../../d1/de7/occlusion_8c.html#a353d8ce319c2b193e95e5aa12a81ef79">occ_tree_build</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree;
<a name="l00640"></a>00640     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00641"></a>00641     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00642"></a>00642     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l00643"></a>00643     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00644"></a>00644     <span class="keywordtype">int</span> a, b, c, totface;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <span class="comment">/* count */</span>
<a name="l00647"></a>00647     totface= 0;
<a name="l00648"></a>00648     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l00649"></a>00649         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00650"></a>00650         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00651"></a>00651             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00652"></a>00652             <span class="keywordflow">else</span> vlr++;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654             ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656             <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef8bf00cf7a52e2e5568f5e4d4ca6e5">shade_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab8ca00252c48545c835ce23b7cec5642">MA_APPROX_OCCLUSION</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>))
<a name="l00657"></a>00657                 totface++;
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659     }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (totface == 0)
<a name="l00662"></a>00662         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00663"></a>00663     
<a name="l00664"></a>00664     tree= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a>), <span class="stringliteral">&quot;OcclusionTree&quot;</span>);
<a name="l00665"></a>00665     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>= totface;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     <span class="comment">/* parameters */</span>
<a name="l00668"></a>00668     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a9c07b6d0946b7ce52663dfa17e9f0f5a">error</a>= <a class="code" href="../../d8/d53/BKE__scene_8h.html#ade9cc4e19dfd3c786b4d8637e649cf61">get_render_aosss_error</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a26cc93d2a15bb8120edd21656b8bd5ac">ao_approx_error</a>);
<a name="l00669"></a>00669     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae87341d820cf6ab12fbf4076aba3f2e9">distfac</a>= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a5cd59ca82119bab5bd4228f39e203ab4">aomode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#af9df71003fc7bf243ade0852c76fec5b">WO_AODIST</a>)? re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a8a1541901444080fa3ddca3d3bf6da5d">aodistfac</a>: 0.0f;
<a name="l00670"></a>00670     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a2c668f38eb11846d65e1df44b1dd969a">ao_indirect_energy</a> &gt; 0.0f &amp;&amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aea187ee925e4082c730847109f483609">ao_indirect_bounces</a> &gt; 0);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="comment">/* allocation */</span>
<a name="l00673"></a>00673     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(0x8000 * <span class="keyword">sizeof</span>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a>), <span class="stringliteral">&quot;occ tree arena&quot;</span>);
<a name="l00674"></a>00674     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>);
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a5cd59ca82119bab5bd4228f39e203ab4">aomode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#aabafcf4b3cd2731d6b8dba3086ee40a8">WO_AOCACHE</a>)
<a name="l00677"></a>00677         tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a>)*<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>, <span class="stringliteral">&quot;OcclusionCache&quot;</span>);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d76/structOccFace.html">OccFace</a>)*totface, <span class="stringliteral">&quot;OcclusionFace&quot;</span>);
<a name="l00680"></a>00680     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totface, <span class="stringliteral">&quot;OcclusionCo&quot;</span>);
<a name="l00681"></a>00681     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*totface, <span class="stringliteral">&quot;OcclusionOcclusion&quot;</span>);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>)
<a name="l00684"></a>00684         tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*totface, <span class="stringliteral">&quot;OcclusionRad&quot;</span>);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/* make array of face pointers */</span>
<a name="l00687"></a>00687     <span class="keywordflow">for</span> (b=0, c=0, obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>, c++) {
<a name="l00688"></a>00688         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00689"></a>00689         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00690"></a>00690             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00691"></a>00691             <span class="keywordflow">else</span> vlr++;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693             ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695             <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#aeef8bf00cf7a52e2e5568f5e4d4ca6e5">shade_flag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab8ca00252c48545c835ce23b7cec5642">MA_APPROX_OCCLUSION</a>) &amp;&amp; (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>)) {
<a name="l00696"></a>00696                 tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[b].<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>= c;
<a name="l00697"></a>00697                 tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[b].<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>= a;
<a name="l00698"></a>00698                 tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[b]= 1.0f;
<a name="l00699"></a>00699                 <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(&amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[b], tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>[b], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); 
<a name="l00700"></a>00700                 b++;
<a name="l00701"></a>00701             }
<a name="l00702"></a>00702         }
<a name="l00703"></a>00703     }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     <span class="comment">/* threads */</span>
<a name="l00706"></a>00706     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a17ccf14a2f79f79715dee1293bd675c2">totbuildthread</a>= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a> &gt; 1 &amp;&amp; totface &gt; 10000)? 8: 1;
<a name="l00707"></a>00707     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa5432a8c65f48ff089d2019da8a6d5f1">dothreadedbuild</a>= (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a17ccf14a2f79f79715dee1293bd675c2">totbuildthread</a> &gt; 1);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     <span class="comment">/* recurse */</span>
<a name="l00710"></a>00710     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a>));
<a name="l00711"></a>00711     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">maxdepth</a>= 1;
<a name="l00712"></a>00712     <a class="code" href="../../d1/de7/occlusion_8c.html#a69eb66927d905cd808da67de82212ae6">occ_build_recursive</a>(tree, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>, 0, totface, 1);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>) {
<a name="l00715"></a>00715         <a class="code" href="../../d1/de7/occlusion_8c.html#a10c8e6811be4dd35f39d3bc264c6f2c4">occ_build_shade</a>(re, tree);
<a name="l00716"></a>00716         <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(tree, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>);
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718     
<a name="l00719"></a>00719     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>);
<a name="l00720"></a>00720     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0ba15e1ddc799b0dac9da7650d457b9e">co</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <a class="code" href="../../d1/de7/occlusion_8c.html#a239033227b9126a1a3ff5724e1a6cb0c">occ_build_sh_normalize</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>; a++)
<a name="l00725"></a>00725         tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">stack</a>[a]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a>)*<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>*(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aa4ac566881a48331cc733e53cb7655e2">maxdepth</a>+1), <span class="stringliteral">&quot;OccStack&quot;</span>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordflow">return</span> tree;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a5eb2b32c8a1066cb10d688aa2df5ee4b">00730</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a5eb2b32c8a1066cb10d688aa2df5ee4b">occ_free_tree</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732     <span class="keywordtype">int</span> a;
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (tree) {
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>) <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ad1a06c6a62bb24e63af1688871ee4cd6">arena</a>);
<a name="l00736"></a>00736         <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>; a++)
<a name="l00737"></a>00737             <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">stack</a>[a])
<a name="l00738"></a>00738                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">stack</a>[a]);
<a name="l00739"></a>00739         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>);
<a name="l00740"></a>00740         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>);
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>);
<a name="l00742"></a>00742         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>);
<a name="l00743"></a>00743         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree);
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 <span class="comment">/* ------------------------- Traversal --------------------------- */</span>
<a name="l00748"></a>00748 
<a name="l00749"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aad58a6d3be7f82ee5edcb84c177da1f5">00749</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#aad58a6d3be7f82ee5edcb84c177da1f5">occ_solid_angle</a>(<a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node, <span class="keyword">const</span> <span class="keywordtype">float</span> v[3], <span class="keywordtype">float</span> d2, <span class="keywordtype">float</span> invd2, <span class="keyword">const</span> <span class="keywordtype">float</span> receivenormal[3])
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751     <span class="keywordtype">float</span> dotreceive, dotemit;
<a name="l00752"></a>00752     <span class="keywordtype">float</span> ev[3];
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     ev[0]= -v[0]*invd2;
<a name="l00755"></a>00755     ev[1]= -v[1]*invd2;
<a name="l00756"></a>00756     ev[2]= -v[2]*invd2;
<a name="l00757"></a>00757     dotemit= <a class="code" href="../../d1/de7/occlusion_8c.html#aee5cc4c2daea9fabf3a758910f1b15ab">sh_eval</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a486b5b5cc308e505d19efd1bbe0808c5">sh</a>, ev);
<a name="l00758"></a>00758     dotreceive= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(receivenormal, v)*invd2;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(dotemit, 0.0f, 1.0f);
<a name="l00761"></a>00761     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(dotreceive, 0.0f, 1.0f);
<a name="l00762"></a>00762     
<a name="l00763"></a>00763     <span class="keywordflow">return</span> ((node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>*dotemit*dotreceive)/(d2 + node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>*<a class="code" href="../../d1/de7/occlusion_8c.html#a8c827faf307c77be8e926ab83420b53d">INVPI</a>))*<a class="code" href="../../d1/de7/occlusion_8c.html#a8c827faf307c77be8e926ab83420b53d">INVPI</a>;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">00766</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(<span class="keywordtype">float</span> result[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> fac)
<a name="l00767"></a>00767 {
<a name="l00768"></a>00768     result[0]= v1[0] + fac*(v2[0] - v1[0]);
<a name="l00769"></a>00769     result[1]= v1[1] + fac*(v2[1] - v1[1]);
<a name="l00770"></a>00770     result[2]= v1[2] + fac*(v2[2] - v1[2]);
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a59662ec937e207a7bede5e131a987374">00773</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a59662ec937e207a7bede5e131a987374">occ_visible_quad</a>(<span class="keywordtype">float</span> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> *v1, <span class="keyword">const</span> <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> q0[3], <span class="keywordtype">float</span> q1[3], <span class="keywordtype">float</span> q2[3], <span class="keywordtype">float</span> q3[3])
<a name="l00774"></a>00774 {
<a name="l00775"></a>00775     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a> = 1e-6f;
<a name="l00776"></a>00776     <span class="keywordtype">float</span> c, sd[3];
<a name="l00777"></a>00777     
<a name="l00778"></a>00778     c= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, p);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="comment">/* signed distances from the vertices to the plane. */</span>
<a name="l00781"></a>00781     sd[0]= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v0) - c;
<a name="l00782"></a>00782     sd[1]= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v1) - c;
<a name="l00783"></a>00783     sd[2]= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v2) - c;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[0]) &lt; epsilon) sd[0] = 0.0f;
<a name="l00786"></a>00786     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[1]) &lt; epsilon) sd[1] = 0.0f;
<a name="l00787"></a>00787     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[2]) &lt; epsilon) sd[2] = 0.0f;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="keywordflow">if</span> (sd[0] &gt; 0) {
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l00791"></a>00791             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00792"></a>00792                 <span class="comment">// +++</span>
<a name="l00793"></a>00793                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00794"></a>00794                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00795"></a>00795                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00796"></a>00796                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00797"></a>00797             }
<a name="l00798"></a>00798             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00799"></a>00799                 <span class="comment">// ++-</span>
<a name="l00800"></a>00800                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00801"></a>00801                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00802"></a>00802                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00803"></a>00803                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q3, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00804"></a>00804             }
<a name="l00805"></a>00805             <span class="keywordflow">else</span> {
<a name="l00806"></a>00806                 <span class="comment">// ++0</span>
<a name="l00807"></a>00807                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00808"></a>00808                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00809"></a>00809                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00810"></a>00810                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00811"></a>00811             }
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l00814"></a>00814             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00815"></a>00815                 <span class="comment">// +-+</span>
<a name="l00816"></a>00816                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00817"></a>00817                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q1, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00818"></a>00818                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00819"></a>00819                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, v2);
<a name="l00820"></a>00820             }
<a name="l00821"></a>00821             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00822"></a>00822                 <span class="comment">// +--</span>
<a name="l00823"></a>00823                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00824"></a>00824                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q1, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00825"></a>00825                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00826"></a>00826                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00827"></a>00827             }
<a name="l00828"></a>00828             <span class="keywordflow">else</span> {
<a name="l00829"></a>00829                 <span class="comment">// +-0</span>
<a name="l00830"></a>00830                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00831"></a>00831                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q1, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00832"></a>00832                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00833"></a>00833                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836         <span class="keywordflow">else</span> {
<a name="l00837"></a>00837             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00838"></a>00838                 <span class="comment">// +0+</span>
<a name="l00839"></a>00839                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00840"></a>00840                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00841"></a>00841                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00842"></a>00842                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00843"></a>00843             }
<a name="l00844"></a>00844             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00845"></a>00845                 <span class="comment">// +0-</span>
<a name="l00846"></a>00846                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00847"></a>00847                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00848"></a>00848                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00849"></a>00849                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00850"></a>00850             }
<a name="l00851"></a>00851             <span class="keywordflow">else</span> {
<a name="l00852"></a>00852                 <span class="comment">// +00</span>
<a name="l00853"></a>00853                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00854"></a>00854                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00855"></a>00855                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00856"></a>00856                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00857"></a>00857             }
<a name="l00858"></a>00858         }
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[0] &lt; 0) {
<a name="l00861"></a>00861         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l00862"></a>00862             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00863"></a>00863                 <span class="comment">// -++</span>
<a name="l00864"></a>00864                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q0, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00865"></a>00865                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00866"></a>00866                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00867"></a>00867                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q3, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00868"></a>00868             }
<a name="l00869"></a>00869             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00870"></a>00870                 <span class="comment">// -+-</span>
<a name="l00871"></a>00871                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q0, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00872"></a>00872                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00873"></a>00873                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00874"></a>00874                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00875"></a>00875             }
<a name="l00876"></a>00876             <span class="keywordflow">else</span> {
<a name="l00877"></a>00877                 <span class="comment">// -+0</span>
<a name="l00878"></a>00878                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q0, v0, v1, (sd[0]/(sd[0]-sd[1])));
<a name="l00879"></a>00879                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00880"></a>00880                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00881"></a>00881                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00882"></a>00882             }
<a name="l00883"></a>00883         }
<a name="l00884"></a>00884         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l00885"></a>00885             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00886"></a>00886                 <span class="comment">// --+</span>
<a name="l00887"></a>00887                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q0, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00888"></a>00888                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q1, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00889"></a>00889                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00890"></a>00890                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00891"></a>00891             }
<a name="l00892"></a>00892             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00893"></a>00893                 <span class="comment">// ---</span>
<a name="l00894"></a>00894                 <span class="keywordflow">return</span> 0;
<a name="l00895"></a>00895             }
<a name="l00896"></a>00896             <span class="keywordflow">else</span> {
<a name="l00897"></a>00897                 <span class="comment">// --0</span>
<a name="l00898"></a>00898                 <span class="keywordflow">return</span> 0;
<a name="l00899"></a>00899             }
<a name="l00900"></a>00900         }
<a name="l00901"></a>00901         <span class="keywordflow">else</span> {
<a name="l00902"></a>00902             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00903"></a>00903                 <span class="comment">// -0+</span>
<a name="l00904"></a>00904                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q0, v0, v2, (sd[0]/(sd[0]-sd[2])));
<a name="l00905"></a>00905                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00906"></a>00906                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00907"></a>00907                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00908"></a>00908             }
<a name="l00909"></a>00909             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00910"></a>00910                 <span class="comment">// -0-</span>
<a name="l00911"></a>00911                 <span class="keywordflow">return</span> 0;
<a name="l00912"></a>00912             }
<a name="l00913"></a>00913             <span class="keywordflow">else</span> {
<a name="l00914"></a>00914                 <span class="comment">// -00</span>
<a name="l00915"></a>00915                 <span class="keywordflow">return</span> 0;
<a name="l00916"></a>00916             }
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918     }
<a name="l00919"></a>00919     <span class="keywordflow">else</span> {
<a name="l00920"></a>00920         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l00921"></a>00921             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00922"></a>00922                 <span class="comment">// 0++</span>
<a name="l00923"></a>00923                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00924"></a>00924                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00925"></a>00925                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00926"></a>00926                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00927"></a>00927             }
<a name="l00928"></a>00928             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00929"></a>00929                 <span class="comment">// 0+-</span>
<a name="l00930"></a>00930                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00931"></a>00931                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00932"></a>00932                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q2, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00933"></a>00933                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00934"></a>00934             }
<a name="l00935"></a>00935             <span class="keywordflow">else</span> {
<a name="l00936"></a>00936                 <span class="comment">// 0+0</span>
<a name="l00937"></a>00937                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00938"></a>00938                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00939"></a>00939                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00940"></a>00940                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00941"></a>00941             }
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l00944"></a>00944             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00945"></a>00945                 <span class="comment">// 0-+</span>
<a name="l00946"></a>00946                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00947"></a>00947                 <a class="code" href="../../d1/de7/occlusion_8c.html#a55bd934ef8c83d1a997579fa99e2d6fd">VecAddDir</a>(q1, v1, v2, (sd[1]/(sd[1]-sd[2])));
<a name="l00948"></a>00948                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00949"></a>00949                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00950"></a>00950             }
<a name="l00951"></a>00951             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00952"></a>00952                 <span class="comment">// 0--</span>
<a name="l00953"></a>00953                 <span class="keywordflow">return</span> 0;
<a name="l00954"></a>00954             }
<a name="l00955"></a>00955             <span class="keywordflow">else</span> {
<a name="l00956"></a>00956                 <span class="comment">// 0-0</span>
<a name="l00957"></a>00957                 <span class="keywordflow">return</span> 0;
<a name="l00958"></a>00958             }
<a name="l00959"></a>00959         }
<a name="l00960"></a>00960         <span class="keywordflow">else</span> {
<a name="l00961"></a>00961             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l00962"></a>00962                 <span class="comment">// 00+</span>
<a name="l00963"></a>00963                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l00964"></a>00964                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l00965"></a>00965                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l00966"></a>00966                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l00967"></a>00967             }
<a name="l00968"></a>00968             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l00969"></a>00969                 <span class="comment">// 00-</span>
<a name="l00970"></a>00970                 <span class="keywordflow">return</span> 0;
<a name="l00971"></a>00971             }
<a name="l00972"></a>00972             <span class="keywordflow">else</span> {
<a name="l00973"></a>00973                 <span class="comment">// 000</span>
<a name="l00974"></a>00974                 <span class="keywordflow">return</span> 0;
<a name="l00975"></a>00975             }
<a name="l00976"></a>00976         }
<a name="l00977"></a>00977     }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordflow">return</span> 1;
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="comment">/* altivec optimization, this works, but is unused */</span>
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 <span class="preprocessor">#if 0</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span><span class="preprocessor">#include &lt;Accelerate/Accelerate.h&gt;</span>
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l00988"></a>00988     vFloat v;
<a name="l00989"></a>00989     <span class="keywordtype">float</span> f[4];
<a name="l00990"></a>00990 } vFloatResult;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keyword">static</span> vFloat vec_splat_float(<span class="keywordtype">float</span> val)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <span class="keywordflow">return</span> (vFloat) {val, val, val, val};
<a name="l00995"></a>00995 }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">occ_quad_form_factor</a>(<span class="keywordtype">float</span> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *q0, <span class="keywordtype">float</span> *q1, <span class="keywordtype">float</span> *q2, <span class="keywordtype">float</span> *q3)
<a name="l00998"></a>00998 {
<a name="l00999"></a>00999     vFloat vcos, rlen, vrx, vry, vrz, vsrx, vsry, vsrz, gx, gy, gz, vangle;
<a name="l01000"></a>01000     vUInt8 <a class="code" href="../../d1/d22/stdosl_8h.html#a223c99c5a2abf0efde88e9da56bae327">rotate</a> = (vUInt8) {4,5,6,7,8,9,10,11,12,13,14,15,0,1,2,3};
<a name="l01001"></a>01001     vFloatResult vresult;
<a name="l01002"></a>01002     <span class="keywordtype">float</span> result;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="comment">/* compute r* */</span>
<a name="l01005"></a>01005     vrx = (vFloat) {q0[0], q1[0], q2[0], q3[0]} - vec_splat_float(p[0]);
<a name="l01006"></a>01006     vry = (vFloat) {q0[1], q1[1], q2[1], q3[1]} - vec_splat_float(p[1]);
<a name="l01007"></a>01007     vrz = (vFloat) {q0[2], q1[2], q2[2], q3[2]} - vec_splat_float(p[2]);
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     <span class="comment">/* normalize r* */</span>
<a name="l01010"></a>01010     rlen = vec_rsqrte(vrx*vrx + vry*vry + vrz*vrz + vec_splat_float(1e-16f));
<a name="l01011"></a>01011     vrx = vrx*rlen;
<a name="l01012"></a>01012     vry = vry*rlen;
<a name="l01013"></a>01013     vrz = vrz*rlen;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="comment">/* rotate r* for cross and dot */</span>
<a name="l01016"></a>01016     vsrx= vec_perm(vrx, vrx, rotate);
<a name="l01017"></a>01017     vsry= vec_perm(vry, vry, rotate);
<a name="l01018"></a>01018     vsrz= vec_perm(vrz, vrz, rotate);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <span class="comment">/* cross product */</span>
<a name="l01021"></a>01021     gx = vsry*vrz - vsrz*vry;
<a name="l01022"></a>01022     gy = vsrz*vrx - vsrx*vrz;
<a name="l01023"></a>01023     gz = vsrx*vry - vsry*vrx;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="comment">/* normalize */</span>
<a name="l01026"></a>01026     rlen = vec_rsqrte(gx*gx + gy*gy + gz*gz + vec_splat_float(1e-16f));
<a name="l01027"></a>01027     gx = gx*rlen;
<a name="l01028"></a>01028     gy = gy*rlen;
<a name="l01029"></a>01029     gz = gz*rlen;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031     <span class="comment">/* angle */</span>
<a name="l01032"></a>01032     vcos = vrx*vsrx + vry*vsry + vrz*vsrz;
<a name="l01033"></a>01033     vcos= vec_max(vec_min(vcos, vec_splat_float(1.0f)), vec_splat_float(-1.0f));
<a name="l01034"></a>01034     vangle= vacosf(vcos);
<a name="l01035"></a>01035 
<a name="l01036"></a>01036     <span class="comment">/* dot */</span>
<a name="l01037"></a>01037     vresult.v = (vec_splat_float(n[0])*gx +
<a name="l01038"></a>01038                  vec_splat_float(n[1])*gy +
<a name="l01039"></a>01039                  vec_splat_float(n[2])*gz)*vangle;
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     result= (vresult.f[0] + vresult.f[1] + vresult.f[2] + vresult.f[3])*(0.5f/(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l01042"></a>01042     result= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="keywordflow">return</span> result;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047 <span class="preprocessor">#endif</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>
<a name="l01049"></a>01049 <span class="comment">/* SSE optimization, acos code doesn&#39;t work */</span>
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="preprocessor">#if 0</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>
<a name="l01053"></a>01053 <span class="preprocessor">#include &lt;xmmintrin.h&gt;</span>
<a name="l01054"></a>01054 
<a name="l01055"></a>01055 <span class="keyword">static</span> __m128 sse_approx_acos(__m128 x)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057     <span class="comment">/* needs a better approximation than taylor expansion of acos, since that</span>
<a name="l01058"></a>01058 <span class="comment">     * gives big erros for near 1.0 values, sqrt(2*x)*acos(1-x) should work</span>
<a name="l01059"></a>01059 <span class="comment">     * better, see http://www.tom.womack.net/projects/sse-fast-arctrig.html */</span>
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="keywordflow">return</span> _mm_set_ps1(1.0f);
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">occ_quad_form_factor</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *q0, <span class="keywordtype">float</span> *q1, <span class="keywordtype">float</span> *q2, <span class="keywordtype">float</span> *q3)
<a name="l01065"></a>01065 {
<a name="l01066"></a>01066     <span class="keywordtype">float</span> r0[3], r1[3], r2[3], r3[3], g0[3], g1[3], g2[3], g3[3];
<a name="l01067"></a>01067     <span class="keywordtype">float</span> a1, a2, a3, a4, dot1, dot2, dot3, dot4, result;
<a name="l01068"></a>01068     <span class="keywordtype">float</span> fresult[4] <a class="code" href="../../d7/d38/util__opencl_8h.html#abd062009d355453e86013d3c02318e6b">__attribute__</a>((aligned(16)));
<a name="l01069"></a>01069     __m128 qx, qy, qz, rx, ry, rz, rlen, srx, sry, srz, gx, gy, gz, glen, rcos, <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, aresult;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     <span class="comment">/* compute r */</span>
<a name="l01072"></a>01072     qx = _mm_set_ps(q3[0], q2[0], q1[0], q0[0]);
<a name="l01073"></a>01073     qy = _mm_set_ps(q3[1], q2[1], q1[1], q0[1]);
<a name="l01074"></a>01074     qz = _mm_set_ps(q3[2], q2[2], q1[2], q0[2]);
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     rx = qx - _mm_set_ps1(p[0]);
<a name="l01077"></a>01077     ry = qy - _mm_set_ps1(p[1]);
<a name="l01078"></a>01078     rz = qz - _mm_set_ps1(p[2]);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="comment">/* normalize r */</span>
<a name="l01081"></a>01081     rlen = _mm_rsqrt_ps(rx*rx + ry*ry + rz*rz + _mm_set_ps1(1e-16f));
<a name="l01082"></a>01082     rx = rx*rlen;
<a name="l01083"></a>01083     ry = ry*rlen;
<a name="l01084"></a>01084     rz = rz*rlen;
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     <span class="comment">/* cross product */</span>
<a name="l01087"></a>01087     srx = _mm_shuffle_ps(rx, rx, _MM_SHUFFLE(0,3,2,1));
<a name="l01088"></a>01088     sry = _mm_shuffle_ps(ry, ry, _MM_SHUFFLE(0,3,2,1));
<a name="l01089"></a>01089     srz = _mm_shuffle_ps(rz, rz, _MM_SHUFFLE(0,3,2,1));
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     gx = sry*rz - srz*ry;
<a name="l01092"></a>01092     gy = srz*rx - srx*rz;
<a name="l01093"></a>01093     gz = srx*ry - sry*rx;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="comment">/* normalize g */</span>
<a name="l01096"></a>01096     glen = _mm_rsqrt_ps(gx*gx + gy*gy + gz*gz + _mm_set_ps1(1e-16f));
<a name="l01097"></a>01097     gx = gx*glen;
<a name="l01098"></a>01098     gy = gy*glen;
<a name="l01099"></a>01099     gz = gz*glen;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <span class="comment">/* compute angle */</span>
<a name="l01102"></a>01102     rcos = rx*srx + ry*sry + rz*srz;
<a name="l01103"></a>01103     rcos= _mm_max_ps(_mm_min_ps(rcos, _mm_set_ps1(1.0f)), _mm_set_ps1(-1.0f));
<a name="l01104"></a>01104 
<a name="l01105"></a>01105     angle = sse_approx_cos(rcos);
<a name="l01106"></a>01106     aresult = (_mm_set_ps1(n[0])*gx + _mm_set_ps1(n[1])*gy + _mm_set_ps1(n[2])*gz)*angle;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="comment">/* sum together */</span>
<a name="l01109"></a>01109     result= (fresult[0] + fresult[1] + fresult[2] + fresult[3])*(0.5f/(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l01110"></a>01110     result= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="keywordflow">return</span> result;
<a name="l01113"></a>01113 }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 <span class="preprocessor">#endif</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>
<a name="l01117"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">01117</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(<span class="keywordtype">float</span> *n)
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119     <span class="keywordtype">float</span> d;
<a name="l01120"></a>01120     
<a name="l01121"></a>01121     d= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, n);
<a name="l01122"></a>01122 
<a name="l01123"></a>01123     <span class="keywordflow">if</span> (d &gt; 1.0e-35<a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a>) {
<a name="l01124"></a>01124         d= 1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d);
<a name="l01125"></a>01125 
<a name="l01126"></a>01126         n[0] *= d; 
<a name="l01127"></a>01127         n[1] *= d; 
<a name="l01128"></a>01128         n[2] *= d;
<a name="l01129"></a>01129     } 
<a name="l01130"></a>01130 }
<a name="l01131"></a>01131 
<a name="l01132"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">01132</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">occ_quad_form_factor</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p[3], <span class="keyword">const</span> <span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q3[3])
<a name="l01133"></a>01133 {
<a name="l01134"></a>01134     <span class="keywordtype">float</span> r0[3], r1[3], r2[3], r3[3], g0[3], g1[3], g2[3], g3[3];
<a name="l01135"></a>01135     <span class="keywordtype">float</span> a1, a2, a3, a4, dot1, dot2, dot3, dot4, result;
<a name="l01136"></a>01136 
<a name="l01137"></a>01137     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r0, q0, p);
<a name="l01138"></a>01138     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r1, q1, p);
<a name="l01139"></a>01139     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r2, q2, p);
<a name="l01140"></a>01140     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r3, q3, p);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142     <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(r0);
<a name="l01143"></a>01143     <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(r1);
<a name="l01144"></a>01144     <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(r2);
<a name="l01145"></a>01145     <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(r3);
<a name="l01146"></a>01146 
<a name="l01147"></a>01147     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g0, r1, r0); <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(g0);
<a name="l01148"></a>01148     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g1, r2, r1); <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(g1);
<a name="l01149"></a>01149     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g2, r3, r2); <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(g2);
<a name="l01150"></a>01150     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g3, r0, r3); <a class="code" href="../../d1/de7/occlusion_8c.html#a0fd3c7b5622cb8c2905ce7d04fd09b3f">normalizef</a>(g3);
<a name="l01151"></a>01151 
<a name="l01152"></a>01152     a1= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r0, r1));
<a name="l01153"></a>01153     a2= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r1, r2));
<a name="l01154"></a>01154     a3= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r2, r3));
<a name="l01155"></a>01155     a4= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r3, r0));
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     dot1= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g0);
<a name="l01158"></a>01158     dot2= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g1);
<a name="l01159"></a>01159     dot3= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g2);
<a name="l01160"></a>01160     dot4= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g3);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     result= (a1*dot1 + a2*dot2 + a3*dot3 + a4*dot4)*0.5f/(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l01163"></a>01163     result= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165     <span class="keywordflow">return</span> result;
<a name="l01166"></a>01166 }
<a name="l01167"></a>01167 
<a name="l01168"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ac70a0a0ebfc80e8c028c4e1615ccadf9">01168</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/de7/occlusion_8c.html#ac70a0a0ebfc80e8c028c4e1615ccadf9">occ_form_factor</a>(<a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *face, <span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> *n)
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l01171"></a>01171     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr;
<a name="l01172"></a>01172     <span class="keywordtype">float</span> v1[3], v2[3], v3[3], v4[3], q0[3], q1[3], q2[3], q3[3], contrib= 0.0f;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     obi= &amp;R.<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>[face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>];
<a name="l01175"></a>01175     vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>, face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01178"></a>01178     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01179"></a>01179     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v3, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>) {
<a name="l01182"></a>01182         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v1);
<a name="l01183"></a>01183         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v2);
<a name="l01184"></a>01184         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v3);
<a name="l01185"></a>01185     }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (<a class="code" href="../../d1/de7/occlusion_8c.html#a59662ec937e207a7bede5e131a987374">occ_visible_quad</a>(p, n, v1, v2, v3, q0, q1, q2, q3))
<a name="l01188"></a>01188         contrib += <a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">occ_quad_form_factor</a>(p, n, q0, q1, q2, q3);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l01191"></a>01191         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v4, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l01193"></a>01193             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v4);
<a name="l01194"></a>01194 
<a name="l01195"></a>01195         <span class="keywordflow">if</span> (<a class="code" href="../../d1/de7/occlusion_8c.html#a59662ec937e207a7bede5e131a987374">occ_visible_quad</a>(p, n, v1, v3, v4, q0, q1, q2, q3))
<a name="l01196"></a>01196             contrib += <a class="code" href="../../d1/de7/occlusion_8c.html#a1d4b003134b7354ec69edf52d2819574">occ_quad_form_factor</a>(p, n, q0, q1, q2, q3);
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">return</span> contrib;
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01202"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a6278923ea8c302c2c4e0257db72c242e">01202</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#a6278923ea8c302c2c4e0257db72c242e">occ_lookup</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *exclude, <span class="keywordtype">float</span> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#ac25299c567fdbf4895a991a0df73bf9c">pp</a>, <span class="keywordtype">float</span> *pn, <span class="keywordtype">float</span> *occ, <span class="keywordtype">float</span> rad[3], <span class="keywordtype">float</span> bentn[3])
<a name="l01203"></a>01203 {
<a name="l01204"></a>01204     <a class="code" href="../../de/d2f/structOccNode.html">OccNode</a> *node, **<a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a>;
<a name="l01205"></a>01205     <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *face;
<a name="l01206"></a>01206     <span class="keywordtype">float</span> resultocc, resultrad[3], v[3], p[3], n[3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], invd2;
<a name="l01207"></a>01207     <span class="keywordtype">float</span> distfac, fac, <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>, d2, weight, emitarea;
<a name="l01208"></a>01208     <span class="keywordtype">int</span> b, f, totstack;
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     <span class="comment">/* init variables */</span>
<a name="l01211"></a>01211     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, pp);
<a name="l01212"></a>01212     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(n, pn);
<a name="l01213"></a>01213     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(p, n, 1e-4f);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (bentn)
<a name="l01216"></a>01216         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bentn, n);
<a name="l01217"></a>01217     
<a name="l01218"></a>01218     error= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a9c07b6d0946b7ce52663dfa17e9f0f5a">error</a>;
<a name="l01219"></a>01219     distfac= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae87341d820cf6ab12fbf4076aba3f2e9">distfac</a>;
<a name="l01220"></a>01220 
<a name="l01221"></a>01221     resultocc= 0.0f;
<a name="l01222"></a>01222     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(resultrad);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="comment">/* init stack */</span>
<a name="l01225"></a>01225     stack= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#aff8f035f854bf1334812e07e4aec712b">stack</a>[thread];
<a name="l01226"></a>01226     stack[0]= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>;
<a name="l01227"></a>01227     totstack= 1;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     <span class="keywordflow">while</span> (totstack) {
<a name="l01230"></a>01230         <span class="comment">/* pop point off the stack */</span>
<a name="l01231"></a>01231         node= stack[--totstack];
<a name="l01232"></a>01232 
<a name="l01233"></a>01233         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#abfa91e066bd96a8bd8510217ce539807">co</a>, p);
<a name="l01234"></a>01234         d2= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v, v) + 1e-16f;
<a name="l01235"></a>01235         emitarea= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a9bd9cfd95704e0f307f150f5b346593e">area</a>, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a362e7fab1ebc60d7dcd86abeef7ba25a">dco</a>);
<a name="l01236"></a>01236 
<a name="l01237"></a>01237         <span class="keywordflow">if</span> (d2*error &gt; emitarea) {
<a name="l01238"></a>01238             <span class="keywordflow">if</span> (distfac != 0.0f) {
<a name="l01239"></a>01239                 fac= 1.0f/(1.0f + distfac*d2);
<a name="l01240"></a>01240                 <span class="keywordflow">if</span> (fac &lt; 0.01f)
<a name="l01241"></a>01241                     <span class="keywordflow">continue</span>;
<a name="l01242"></a>01242             }
<a name="l01243"></a>01243             <span class="keywordflow">else</span>
<a name="l01244"></a>01244                 fac= 1.0f;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246             <span class="comment">/* accumulate occlusion from spherical harmonics */</span>
<a name="l01247"></a>01247             invd2 = 1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d2);
<a name="l01248"></a>01248             weight= <a class="code" href="../../d1/de7/occlusion_8c.html#aad58a6d3be7f82ee5edcb84c177da1f5">occ_solid_angle</a>(node, v, d2, invd2, n);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250             <span class="keywordflow">if</span> (rad)
<a name="l01251"></a>01251                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(resultrad, node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a53bff691dc5ccdffb25dfef89b757571">rad</a>, weight*fac);
<a name="l01252"></a>01252 
<a name="l01253"></a>01253             weight *= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#a3d7cc3cd0cc1682b303b4f95530da51e">occlusion</a>;
<a name="l01254"></a>01254 
<a name="l01255"></a>01255             <span class="keywordflow">if</span> (bentn) {
<a name="l01256"></a>01256                 bentn[0] -= weight*invd2*v[0];
<a name="l01257"></a>01257                 bentn[1] -= weight*invd2*v[1];
<a name="l01258"></a>01258                 bentn[2] -= weight*invd2*v[2];
<a name="l01259"></a>01259             }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261             resultocc += weight*fac;
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263         <span class="keywordflow">else</span> {
<a name="l01264"></a>01264             <span class="comment">/* traverse into children */</span>
<a name="l01265"></a>01265             <span class="keywordflow">for</span> (b=0; b&lt;<a class="code" href="../../d1/de7/occlusion_8c.html#a302c739fe5e3cf17e78530e03688b008">TOTCHILD</a>; b++) {
<a name="l01266"></a>01266                 <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aff1031b05db91d7b535263ed0d9d449a">childflag</a> &amp; (1&lt;&lt;b)) {
<a name="l01267"></a>01267                     f= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#ae0a3fa265a7d48be3b4ed78ee9969670">face</a>;
<a name="l01268"></a>01268                     face= &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[f];
<a name="l01269"></a>01269 
<a name="l01270"></a>01270                     <span class="comment">/* accumulate occlusion with face form factor */</span>
<a name="l01271"></a>01271                     <span class="keywordflow">if</span> (!exclude || !(face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a> == exclude-&gt;<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a> &amp;&amp; face-&gt;<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a> == exclude-&gt;<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>)) {
<a name="l01272"></a>01272                         <span class="keywordflow">if</span> (bentn || distfac != 0.0f) {
<a name="l01273"></a>01273                             <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(face, co, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); 
<a name="l01274"></a>01274                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(v, co, p);
<a name="l01275"></a>01275                             d2= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v, v) + 1e-16f;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277                             fac= (distfac == 0.0f)? 1.0f: 1.0f/(1.0f + distfac*d2);
<a name="l01278"></a>01278                             <span class="keywordflow">if</span> (fac &lt; 0.01f)
<a name="l01279"></a>01279                                 <span class="keywordflow">continue</span>;
<a name="l01280"></a>01280                         }
<a name="l01281"></a>01281                         <span class="keywordflow">else</span>
<a name="l01282"></a>01282                             fac= 1.0f;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                         weight= <a class="code" href="../../d1/de7/occlusion_8c.html#ac70a0a0ebfc80e8c028c4e1615ccadf9">occ_form_factor</a>(face, p, n);
<a name="l01285"></a>01285 
<a name="l01286"></a>01286                         <span class="keywordflow">if</span> (rad)
<a name="l01287"></a>01287                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(resultrad, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>[f], weight*fac);
<a name="l01288"></a>01288 
<a name="l01289"></a>01289                         weight *= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[f];
<a name="l01290"></a>01290 
<a name="l01291"></a>01291                         <span class="keywordflow">if</span> (bentn) {
<a name="l01292"></a>01292                             invd2= 1.0f/<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d2);
<a name="l01293"></a>01293                             bentn[0] -= weight*invd2*v[0];
<a name="l01294"></a>01294                             bentn[1] -= weight*invd2*v[1];
<a name="l01295"></a>01295                             bentn[2] -= weight*invd2*v[2];
<a name="l01296"></a>01296                         }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298                         resultocc += weight*fac;
<a name="l01299"></a>01299                     }
<a name="l01300"></a>01300                 }
<a name="l01301"></a>01301                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>) {
<a name="l01302"></a>01302                     <span class="comment">/* push child on the stack */</span>
<a name="l01303"></a>01303                     stack[totstack++]= node-&gt;<a class="code" href="../../de/d2f/structOccNode.html#aab82b62ecf387df2eeecfd1d00739bf7">child</a>[b].<a class="code" href="../../de/d2f/structOccNode.html#a4a558e7cc82318701af8a78eb0005d14">node</a>;
<a name="l01304"></a>01304                 }
<a name="l01305"></a>01305             }
<a name="l01306"></a>01306         }
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     <span class="keywordflow">if</span> (occ) *occ= resultocc;
<a name="l01310"></a>01310     <span class="keywordflow">if</span> (rad) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rad, resultrad);
<a name="l01311"></a>01311 <span class="preprocessor">#if 0</span>
<a name="l01312"></a>01312 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (rad &amp;&amp; exclude) {
<a name="l01313"></a>01313         <span class="keywordtype">int</span> a;
<a name="l01314"></a>01314         <span class="keywordflow">for</span> (a=0; a&lt;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>; a++)
<a name="l01315"></a>01315             <span class="keywordflow">if</span> ((tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a].<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a> == exclude-&gt;<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a> &amp;&amp; tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[a].<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a> == exclude-&gt;<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>))
<a name="l01316"></a>01316                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rad, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>[a]);
<a name="l01317"></a>01317     }
<a name="l01318"></a>01318 <span class="preprocessor">#endif</span>
<a name="l01319"></a>01319 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (bentn) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(bentn);
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ae831ddaaadfb9a5df5dc3da49a1d2ed1">01322</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#ae831ddaaadfb9a5df5dc3da49a1d2ed1">occ_compute_bounces</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> totbounce)
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324     float (*rad)[3], (*sum)[3], (*tmp)[3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], n[3], occ;
<a name="l01325"></a>01325     <span class="keywordtype">int</span> bounce, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     rad= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>, <span class="stringliteral">&quot;OcclusionBounceRad&quot;</span>);
<a name="l01328"></a>01328     <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>);
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="keywordflow">for</span> (bounce=1; bounce&lt;totbounce; bounce++) {
<a name="l01331"></a>01331         <span class="keywordflow">for</span> (i=0; i&lt;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>; i++) {
<a name="l01332"></a>01332             <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(&amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[i], co, n, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01333"></a>01333             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, n, 1e-8f);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335             <a class="code" href="../../d1/de7/occlusion_8c.html#a6278923ea8c302c2c4e0257db72c242e">occ_lookup</a>(tree, 0, &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[i], co, n, &amp;occ, rad[i], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01336"></a>01336             rad[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0]= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(rad[i][0], 0.0f);
<a name="l01337"></a>01337             rad[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1]= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(rad[i][1], 0.0f);
<a name="l01338"></a>01338             rad[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2]= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(rad[i][2], 0.0f);
<a name="l01339"></a>01339             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(<a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>[i], rad[i]);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01342"></a>01342                 <span class="keywordflow">break</span>;
<a name="l01343"></a>01343         }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01346"></a>01346             <span class="keywordflow">break</span>;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348         tmp= tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>;
<a name="l01349"></a>01349         tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>= rad;
<a name="l01350"></a>01350         rad= tmp;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352         <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(tree, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>);
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rad);
<a name="l01356"></a>01356     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>);
<a name="l01357"></a>01357     tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae52324aa5a8d6c6778753fb6ba62712b">rad</a>= <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     <span class="keywordflow">if</span> (!re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01360"></a>01360         <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(tree, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>);
<a name="l01361"></a>01361 }
<a name="l01362"></a>01362 
<a name="l01363"></a><a class="code" href="../../d1/de7/occlusion_8c.html#abf9f35ebee90942d9f306245dae83181">01363</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#abf9f35ebee90942d9f306245dae83181">occ_compute_passes</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">int</span> totpass)
<a name="l01364"></a>01364 {
<a name="l01365"></a>01365     <span class="keywordtype">float</span> *occ, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], n[3];
<a name="l01366"></a>01366     <span class="keywordtype">int</span> pass, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01367"></a>01367     
<a name="l01368"></a>01368     occ= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>, <span class="stringliteral">&quot;OcclusionPassOcc&quot;</span>);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <span class="keywordflow">for</span> (pass=0; pass&lt;totpass; pass++) {
<a name="l01371"></a>01371         <span class="keywordflow">for</span> (i=0; i&lt;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>; i++) {
<a name="l01372"></a>01372             <a class="code" href="../../d1/de7/occlusion_8c.html#ab8f2200937f4a72e78beee05a4f1e382">occ_face</a>(&amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[i], co, n, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01373"></a>01373             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(n);
<a name="l01374"></a>01374             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(co, n, 1e-8f);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376             <a class="code" href="../../d1/de7/occlusion_8c.html#a6278923ea8c302c2c4e0257db72c242e">occ_lookup</a>(tree, 0, &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0fa4731ff32165e876090013307c43c6">face</a>[i], co, n, &amp;occ[i], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01377"></a>01377             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01378"></a>01378                 <span class="keywordflow">break</span>;
<a name="l01379"></a>01379         }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01382"></a>01382             <span class="keywordflow">break</span>;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="keywordflow">for</span> (i=0; i&lt;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a6271f14085a1e6f8e24cd9854b990ec1">totface</a>; i++) {
<a name="l01385"></a>01385             tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] -= occ[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; <span class="comment">//MAX2(1.0f-occ[i], 0.0f);</span>
<a name="l01386"></a>01386             <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[i] &lt; 0.0f)
<a name="l01387"></a>01387                 tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#afb59c8e6f4d63d1ca5ec647b0444ad4a">occlusion</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= 0.0f;
<a name="l01388"></a>01388         }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390         <a class="code" href="../../d1/de7/occlusion_8c.html#a4f2ae69984f9ed6c6e4255ee94d8c77c">occ_sum_occlusion</a>(tree, tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a4fe61b447c6c370b51f93469a42879ae">root</a>);
<a name="l01391"></a>01391     }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(occ);
<a name="l01394"></a>01394 }
<a name="l01395"></a>01395 
<a name="l01396"></a><a class="code" href="../../d1/de7/occlusion_8c.html#afcf49c6f060b2564d9535210ccb13afc">01396</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#afcf49c6f060b2564d9535210ccb13afc">sample_occ_tree</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> *exclude, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *n, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">int</span> onlyshadow, <span class="keywordtype">float</span> *ao, <span class="keywordtype">float</span> *env, <span class="keywordtype">float</span> *indirect)
<a name="l01397"></a>01397 {
<a name="l01398"></a>01398     <span class="keywordtype">float</span> nn[3], bn[3], fac, occ, occlusion, correction, rad[3];
<a name="l01399"></a>01399     <span class="keywordtype">int</span> envcolor;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401     envcolor= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a1effce8171c99d65c3e8d3468223f7bf">aocolor</a>;
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (onlyshadow)
<a name="l01403"></a>01403         envcolor= <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ac0edbc46dbeb07bbfca2204a4f04d4b9">WO_AOPLAIN</a>;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(nn, n);
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <a class="code" href="../../d1/de7/occlusion_8c.html#a6278923ea8c302c2c4e0257db72c242e">occ_lookup</a>(tree, thread, exclude, co, nn, &amp;occ, (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>)? rad: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (env &amp;&amp; envcolor)? bn: NULL);
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     correction= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ab9a03d8004400632bfa8f6c7e2214665">ao_approx_correction</a>;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     occlusion= (1.0f-correction)*(1.0f-occ);
<a name="l01412"></a>01412     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(occlusion, 0.0f, 1.0f);
<a name="l01413"></a>01413     <span class="keywordflow">if</span> (correction != 0.0f)
<a name="l01414"></a>01414         occlusion += correction*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-occ);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     <span class="keywordflow">if</span> (env) {
<a name="l01417"></a>01417         <span class="comment">/* sky shading using bent normal */</span>
<a name="l01418"></a>01418         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(envcolor, <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a028c847b8a3dcf8459e74f92ddc57da7">WO_AOSKYCOL</a>, <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a3399876ee52643e8a0b29e174a3d15be">WO_AOSKYTEX</a>)) {
<a name="l01419"></a>01419             fac= 0.5f * (1.0f + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(bn, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a6bf0db97e581a6aac25c9dfb18518110">grvec</a>));
<a name="l01420"></a>01420             env[0]= (1.0f-fac)*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a> + fac*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a571f06069d46e1f6946d58ab52d32ac8">zenr</a>;
<a name="l01421"></a>01421             env[1]= (1.0f-fac)*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a5a4b17af92505404808f2edc8154ad62">horg</a> + fac*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a1cb75dcd8f1fda2cf31f1533bdbd93fd">zeng</a>;
<a name="l01422"></a>01422             env[2]= (1.0f-fac)*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#ab6522efbf6e1ae8daf0cd5f95a6024d3">horb</a> + fac*re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a9163d49766cb0595b1806333bbcfbbd9">zenb</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(env, occlusion);
<a name="l01425"></a>01425         }
<a name="l01426"></a>01426         <span class="keywordflow">else</span> {
<a name="l01427"></a>01427             env[0]= occlusion;
<a name="l01428"></a>01428             env[1]= occlusion;
<a name="l01429"></a>01429             env[2]= occlusion;
<a name="l01430"></a>01430         }
<a name="l01431"></a>01431 <span class="preprocessor">#if 0</span>
<a name="l01432"></a>01432 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {  <span class="comment">/* WO_AOSKYTEX */</span>
<a name="l01433"></a>01433             <span class="keywordtype">float</span> dxyview[3];
<a name="l01434"></a>01434             bn[0]= -bn[0];
<a name="l01435"></a>01435             bn[1]= -bn[1];
<a name="l01436"></a>01436             bn[2]= -bn[2];
<a name="l01437"></a>01437             dxyview[0]= 1.0f;
<a name="l01438"></a>01438             dxyview[1]= 1.0f;
<a name="l01439"></a>01439             dxyview[2]= 0.0f;
<a name="l01440"></a>01440             <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(ao, co, bn, dxyview);
<a name="l01441"></a>01441         }
<a name="l01442"></a>01442 <span class="preprocessor">#endif</span>
<a name="l01443"></a>01443 <span class="preprocessor"></span>    }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="keywordflow">if</span> (ao) {
<a name="l01446"></a>01446         ao[0]= occlusion;
<a name="l01447"></a>01447         ao[1]= occlusion;
<a name="l01448"></a>01448         ao[2]= occlusion;
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(indirect, rad);
<a name="l01452"></a>01452     <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(indirect);
<a name="l01453"></a>01453 }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 <span class="comment">/* ---------------------------- Caching ------------------------------- */</span>
<a name="l01456"></a>01456 
<a name="l01457"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">01457</a> <span class="keyword">static</span> <a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> *<a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">find_occ_sample</a>(<a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *cache, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01458"></a>01458 {
<a name="l01459"></a>01459     x -= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#aa198fda31766a23e5437fbf2785785b0">x</a>;
<a name="l01460"></a>01460     y -= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">y</a>;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     x /= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>;
<a name="l01463"></a>01463     y /= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>;
<a name="l01464"></a>01464     x *= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>;
<a name="l01465"></a>01465     y *= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="keywordflow">if</span> (x &lt; 0 || x &gt;= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a> || y &lt; 0 || y &gt;= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a489501c813fcd5ead2c9f5337bc3764b">h</a>)
<a name="l01468"></a>01468         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01469"></a>01469     <span class="keywordflow">else</span>
<a name="l01470"></a>01470         <span class="keywordflow">return</span> &amp;cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>[y*cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a> + x];
<a name="l01471"></a>01471 }
<a name="l01472"></a>01472 
<a name="l01473"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aa09085a4eb96ec88c478834fa99b0108">01473</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/de7/occlusion_8c.html#aa09085a4eb96ec88c478834fa99b0108">sample_occ_cache</a>(<a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *n, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> <a class="code" href="../../df/d68/classthread.html">thread</a>, <span class="keywordtype">float</span> *ao, <span class="keywordtype">float</span> *env, <span class="keywordtype">float</span> *indirect)
<a name="l01474"></a>01474 {
<a name="l01475"></a>01475     <a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *cache;
<a name="l01476"></a>01476     <a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> *samples[4], *sample;
<a name="l01477"></a>01477     <span class="keywordtype">float</span> wn[4], wz[4], wb[4], tx, ty, w, totw, mino, maxo;
<a name="l01478"></a>01478     <span class="keywordtype">float</span> d[3], dist2;
<a name="l01479"></a>01479     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, x1, y1, x2, y2;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (!tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>)
<a name="l01482"></a>01482         <span class="keywordflow">return</span> 0;
<a name="l01483"></a>01483     
<a name="l01484"></a>01484     <span class="comment">/* first try to find a sample in the same pixel */</span>
<a name="l01485"></a>01485     cache= &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>[thread];
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a> &amp;&amp; cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>) {
<a name="l01488"></a>01488         sample= &amp;cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>[(y-cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">y</a>)*cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a> + (x-cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#aa198fda31766a23e5437fbf2785785b0">x</a>)];
<a name="l01489"></a>01489         <span class="keywordflow">if</span> (sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ac1a1f81ad9b151a4fadb88f9cd0fcd02">filled</a>) {
<a name="l01490"></a>01490             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d, sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ad57e054b757213530d673bff6787b578">co</a>, co);
<a name="l01491"></a>01491             dist2= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, d);
<a name="l01492"></a>01492             <span class="keywordflow">if</span> (dist2 &lt; 0.5f*sample-&gt;dist2 &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a35bc139aa16ed07d92d73690120df40b">n</a>, n) &gt; 0.98f) {
<a name="l01493"></a>01493                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ao, sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>);
<a name="l01494"></a>01494                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(env, sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>);
<a name="l01495"></a>01495                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(indirect, sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>);
<a name="l01496"></a>01496                 <span class="keywordflow">return</span> 1;
<a name="l01497"></a>01497             }
<a name="l01498"></a>01498         }
<a name="l01499"></a>01499     }
<a name="l01500"></a>01500     <span class="keywordflow">else</span>
<a name="l01501"></a>01501         <span class="keywordflow">return</span> 0;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503     <span class="comment">/* try to interpolate between 4 neighboring pixels */</span>
<a name="l01504"></a>01504     samples[0]= <a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">find_occ_sample</a>(cache, x, y);
<a name="l01505"></a>01505     samples[1]= <a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">find_occ_sample</a>(cache, x+cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>, y);
<a name="l01506"></a>01506     samples[2]= <a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">find_occ_sample</a>(cache, x, y+cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>);
<a name="l01507"></a>01507     samples[3]= <a class="code" href="../../d1/de7/occlusion_8c.html#a27837c493b655f46afa1e80755f458fb">find_occ_sample</a>(cache, x+cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>, y+cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="keywordflow">for</span> (i=0; i&lt;4; i++)
<a name="l01510"></a>01510         <span class="keywordflow">if</span> (!samples[i] || !samples[i]-&gt;filled)
<a name="l01511"></a>01511             <span class="keywordflow">return</span> 0;
<a name="l01512"></a>01512 
<a name="l01513"></a>01513     <span class="comment">/* require intensities not being too different */</span>
<a name="l01514"></a>01514     mino= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4d4b0f047377c6f1fcad38649103df05">MIN4</a>(samples[0]-&gt;intensity, samples[1]-&gt;intensity, samples[2]-&gt;intensity, samples[3]-&gt;intensity);
<a name="l01515"></a>01515     maxo= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1c0ced76b86284f7e93f9b48cf41b665">MAX4</a>(samples[0]-&gt;intensity, samples[1]-&gt;intensity, samples[2]-&gt;intensity, samples[3]-&gt;intensity);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     <span class="keywordflow">if</span> (maxo - mino &gt; 0.05f)
<a name="l01518"></a>01518         <span class="keywordflow">return</span> 0;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     <span class="comment">/* compute weighted interpolation between samples */</span>
<a name="l01521"></a>01521     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(ao);
<a name="l01522"></a>01522     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(env);
<a name="l01523"></a>01523     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(indirect);
<a name="l01524"></a>01524     totw= 0.0f;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     x1= samples[0]-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a5d993212b07302368c9edd1fdf64fe39">x</a>;
<a name="l01527"></a>01527     y1= samples[0]-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aed22957eb1d7d278dc93f90f64338ede">y</a>;
<a name="l01528"></a>01528     x2= samples[3]-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a5d993212b07302368c9edd1fdf64fe39">x</a>;
<a name="l01529"></a>01529     y2= samples[3]-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aed22957eb1d7d278dc93f90f64338ede">y</a>;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     tx= (float)(x2 - x)/(float)(x2 - x1);
<a name="l01532"></a>01532     ty= (float)(y2 - y)/(float)(y2 - y1);
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     wb[3]= (1.0f-tx)*(1.0f-ty);
<a name="l01535"></a>01535     wb[2]= (tx)*(1.0f-ty);
<a name="l01536"></a>01536     wb[1]= (1.0f-tx)*(ty);
<a name="l01537"></a>01537     wb[0]= tx*ty;
<a name="l01538"></a>01538 
<a name="l01539"></a>01539     <span class="keywordflow">for</span> (i=0; i&lt;4; i++) {
<a name="l01540"></a>01540         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d, samples[i]-&gt;co, co);
<a name="l01541"></a>01541         <span class="comment">//dist2= dot_v3v3(d, d);</span>
<a name="l01542"></a>01542 
<a name="l01543"></a>01543         wz[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= 1.0f; <span class="comment">//(samples[i]-&gt;dist2/(1e-4f + dist2));</span>
<a name="l01544"></a>01544         wn[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(samples[i]-&gt;n, n), 32.0f);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546         w= wb[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*wn[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*wz[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01547"></a>01547 
<a name="l01548"></a>01548         totw += w;
<a name="l01549"></a>01549         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(ao, samples[i]-&gt;ao, w);
<a name="l01550"></a>01550         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(env, samples[i]-&gt;env, w);
<a name="l01551"></a>01551         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(indirect, samples[i]-&gt;indirect, w);
<a name="l01552"></a>01552     }
<a name="l01553"></a>01553 
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (totw &gt;= 0.9f) {
<a name="l01555"></a>01555         totw= 1.0f/totw;
<a name="l01556"></a>01556         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ao, totw);
<a name="l01557"></a>01557         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(env, totw);
<a name="l01558"></a>01558         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(indirect, totw);
<a name="l01559"></a>01559         <span class="keywordflow">return</span> 1;
<a name="l01560"></a>01560     }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="keywordflow">return</span> 0;
<a name="l01563"></a>01563 }
<a name="l01564"></a>01564 
<a name="l01565"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ae7aea35d213094c001c3398cf0332ac4">01565</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/de7/occlusion_8c.html#ae7aea35d213094c001c3398cf0332ac4">sample_occ_surface</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l01566"></a>01566 {
<a name="l01567"></a>01567     <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>;
<a name="l01568"></a>01568     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a00758fa5bf0a222c4d4bf64849a6780d">surface</a>;
<a name="l01569"></a>01569     <span class="keywordtype">int</span> *face, *index = <a class="code" href="../../d0/db6/renderdatabase_8h.html#aa1a1f05f460a62b6c0dba354c1f5302f">RE_strandren_get_face</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a>, strand, 0);
<a name="l01570"></a>01570     <span class="keywordtype">float</span> w[4], *co1, *co2, *co3, *co4;
<a name="l01571"></a>01571 
<a name="l01572"></a>01572     <span class="keywordflow">if</span> (mesh &amp;&amp; mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a> &amp;&amp; mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a> &amp;&amp; mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a> &amp;&amp; index) {
<a name="l01573"></a>01573         face= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[*index];
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         co1= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[0]];
<a name="l01576"></a>01576         co2= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[1]];
<a name="l01577"></a>01577         co3= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[2]];
<a name="l01578"></a>01578         co4= (face[3])? mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[3]]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01579"></a>01579 
<a name="l01580"></a>01580         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6c56a0f699c1c3585b26b6e8e9d16fd0">interp_weights_face_v3</a>(w, co1, co2, co3, co4, strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a13f75b31cf1e0e298a9a48dc5fa4b8fd">vert</a>-&gt;<a class="code" href="../../d5/d1c/structStrandVert.html#aa93bd90499c3ed74bffbb19f988d0221">co</a>);
<a name="l01581"></a>01581 
<a name="l01582"></a>01582         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01583"></a>01583         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01584"></a>01584         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[0]], w[0]);
<a name="l01587"></a>01587         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[0]], w[0]);
<a name="l01588"></a>01588         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[0]], w[0]);
<a name="l01589"></a>01589         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[1]], w[1]);
<a name="l01590"></a>01590         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[1]], w[1]);
<a name="l01591"></a>01591         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[1]], w[1]);
<a name="l01592"></a>01592         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[2]], w[2]);
<a name="l01593"></a>01593         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[2]], w[2]);
<a name="l01594"></a>01594         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[2]], w[2]);
<a name="l01595"></a>01595         <span class="keywordflow">if</span> (face[3]) {
<a name="l01596"></a>01596             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[3]], w[3]);
<a name="l01597"></a>01597             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[3]], w[3]);
<a name="l01598"></a>01598             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>, mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[3]], w[3]);
<a name="l01599"></a>01599         }
<a name="l01600"></a>01600     }
<a name="l01601"></a>01601     <span class="keywordflow">else</span> {
<a name="l01602"></a>01602         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[0]= 1.0f;
<a name="l01603"></a>01603         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[1]= 1.0f;
<a name="l01604"></a>01604         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[2]= 1.0f;
<a name="l01605"></a>01605         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01606"></a>01606         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608 }
<a name="l01609"></a>01609 
<a name="l01610"></a>01610 <span class="comment">/* ------------------------- External Functions --------------------------- */</span>
<a name="l01611"></a>01611 
<a name="l01612"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a2caa4b5e7fb4ec02ee3b5f18a3c90c33">01612</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d1/de7/occlusion_8c.html#a2caa4b5e7fb4ec02ee3b5f18a3c90c33">exec_strandsurface_sample</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614     <a class="code" href="../../df/dee/structOcclusionThread.html">OcclusionThread</a> *othread= (<a class="code" href="../../df/dee/structOcclusionThread.html">OcclusionThread</a>*)data;
<a name="l01615"></a>01615     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re= othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#a4a0406e48dc8e97dbd89c0cbf7cd8635">re</a>;
<a name="l01616"></a>01616     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh= othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#a84323dbf05aa889cb74a3d204ef65918">mesh</a>;
<a name="l01617"></a>01617     <span class="keywordtype">float</span> ao[3], env[3], indirect[3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], n[3], *co1, *co2, *co3, *co4;
<a name="l01618"></a>01618     <span class="keywordtype">int</span> a, *face;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="keywordflow">for</span> (a=othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#a0d889f185a69517fb9941e91927f94d9">begin</a>; a&lt;othread-&gt;end; a++) {
<a name="l01621"></a>01621         face= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a];
<a name="l01622"></a>01622         co1= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[0]];
<a name="l01623"></a>01623         co2= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[1]];
<a name="l01624"></a>01624         co3= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[2]];
<a name="l01625"></a>01625 
<a name="l01626"></a>01626         <span class="keywordflow">if</span> (face[3]) {
<a name="l01627"></a>01627             co4= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a>[face[3]];
<a name="l01628"></a>01628 
<a name="l01629"></a>01629             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(co, co1, co3);
<a name="l01630"></a>01630             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>( n,co1, co2, co3, co4);
<a name="l01631"></a>01631         }
<a name="l01632"></a>01632         <span class="keywordflow">else</span> {
<a name="l01633"></a>01633             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a324f7ddc4d04ef772a00ef7b80cfdef3">cent_tri_v3</a>(co, co1, co2, co3);
<a name="l01634"></a>01634             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>( n,co1, co2, co3);
<a name="l01635"></a>01635         }
<a name="l01636"></a>01636         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(n);
<a name="l01637"></a>01637 
<a name="l01638"></a>01638         <a class="code" href="../../d1/de7/occlusion_8c.html#afcf49c6f060b2564d9535210ccb13afc">sample_occ_tree</a>(re, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, co, n, othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#af848832fc76be985fa1690a0cbf80359">thread</a>, 0, ao, env, indirect);
<a name="l01639"></a>01639         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#a7a8a079fd87ba36e19cfdb11703247c1">faceao</a>[a], ao);
<a name="l01640"></a>01640         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#a70127ec4b4bc515353aed5b685b26683">faceenv</a>[a], env);
<a name="l01641"></a>01641         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(othread-&gt;<a class="code" href="../../df/dee/structOcclusionThread.html#abfdac9e57f330bed9a192bd4923e9fb0">faceindirect</a>[a], indirect);
<a name="l01642"></a>01642     }
<a name="l01643"></a>01643 
<a name="l01644"></a>01644     <span class="keywordflow">return</span> 0;
<a name="l01645"></a>01645 }
<a name="l01646"></a>01646 
<a name="l01647"></a><a class="code" href="../../d1/de7/occlusion_8c.html#a9fa15dc14cb441bf33e1e7e82ba71fdb">01647</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d3a/occlusion_8h.html#acdcc581028d4df27fb1e8888e198f1a6">make_occ_tree</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l01648"></a>01648 {
<a name="l01649"></a>01649     <a class="code" href="../../df/dee/structOcclusionThread.html">OcclusionThread</a> othreads[<a class="code" href="../../df/dbb/BLI__threads_8h.html#ac92e31b380a75299968d08895ba7e875">BLENDER_MAX_THREADS</a>];
<a name="l01650"></a>01650     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree;
<a name="l01651"></a>01651     <a class="code" href="../../d3/d79/structStrandSurface.html">StrandSurface</a> *mesh;
<a name="l01652"></a>01652     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l01653"></a>01653     <span class="keywordtype">float</span> ao[3], env[3], indirect[3], (*faceao)[3], (*faceenv)[3], (*faceindirect)[3];
<a name="l01654"></a>01654     <span class="keywordtype">int</span> a, totface, totthread, *face, *count;
<a name="l01655"></a>01655 
<a name="l01656"></a>01656     <span class="comment">/* ugly, needed for occ_face */</span>
<a name="l01657"></a>01657     R= *re;
<a name="l01658"></a>01658 
<a name="l01659"></a>01659     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Occlusion preprocessing&quot;</span>;
<a name="l01660"></a>01660     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l01661"></a>01661     
<a name="l01662"></a>01662     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>= tree= <a class="code" href="../../d1/de7/occlusion_8c.html#a353d8ce319c2b193e95e5aa12a81ef79">occ_tree_build</a>(re);
<a name="l01663"></a>01663     
<a name="l01664"></a>01664     <span class="keywordflow">if</span> (tree) {
<a name="l01665"></a>01665         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a9f6aefec9fcc6da75801b359ec336ec4">ao_approx_passes</a> &gt; 0)
<a name="l01666"></a>01666             <a class="code" href="../../d1/de7/occlusion_8c.html#abf9f35ebee90942d9f306245dae83181">occ_compute_passes</a>(re, tree, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a9f6aefec9fcc6da75801b359ec336ec4">ao_approx_passes</a>);
<a name="l01667"></a>01667         <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#a0bba2cd1df2eb39dff274155de134deb">doindirect</a> &amp;&amp; (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#ab22674234b5c090b07634ed24c7d844d">WO_INDIRECT_LIGHT</a>))
<a name="l01668"></a>01668             <a class="code" href="../../d1/de7/occlusion_8c.html#ae831ddaaadfb9a5df5dc3da49a1d2ed1">occ_compute_bounces</a>(re, tree, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7ff188495fc706d16dbfdd0c2df00797">wrld</a>.<a class="code" href="../../d7/d3f/structWorld.html#aea187ee925e4082c730847109f483609">ao_indirect_bounces</a>);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670         <span class="keywordflow">for</span> (mesh=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35cb36eff15c08185b1c0a73b09aa574">strandsurface</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; mesh; mesh=mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a0cd6eb7fc691e941f6513fb7f0139077">next</a>) {
<a name="l01671"></a>01671             <span class="keywordflow">if</span> (!mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a> || !mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#acd62a8413e443f78103e709126d0150a">co</a> || !mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>)
<a name="l01672"></a>01672                 <span class="keywordflow">continue</span>;
<a name="l01673"></a>01673 
<a name="l01674"></a>01674             count= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>, <span class="stringliteral">&quot;OcclusionCount&quot;</span>);
<a name="l01675"></a>01675             faceao= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>, <span class="stringliteral">&quot;StrandSurfFaceAO&quot;</span>);
<a name="l01676"></a>01676             faceenv= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>, <span class="stringliteral">&quot;StrandSurfFaceEnv&quot;</span>);
<a name="l01677"></a>01677             faceindirect= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*3*mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>, <span class="stringliteral">&quot;StrandSurfFaceIndirect&quot;</span>);
<a name="l01678"></a>01678 
<a name="l01679"></a>01679             totthread= (mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a> &gt; 10000)? re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>: 1;
<a name="l01680"></a>01680             totface= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>/totthread;
<a name="l01681"></a>01681             for (a=0; a&lt;totthread; a++) {
<a name="l01682"></a>01682                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#a4a0406e48dc8e97dbd89c0cbf7cd8635">re</a>= re;
<a name="l01683"></a>01683                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#a7a8a079fd87ba36e19cfdb11703247c1">faceao</a>= faceao;
<a name="l01684"></a>01684                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#a70127ec4b4bc515353aed5b685b26683">faceenv</a>= faceenv;
<a name="l01685"></a>01685                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#abfdac9e57f330bed9a192bd4923e9fb0">faceindirect</a>= faceindirect;
<a name="l01686"></a>01686                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#af848832fc76be985fa1690a0cbf80359">thread</a>= a;
<a name="l01687"></a>01687                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#a84323dbf05aa889cb74a3d204ef65918">mesh</a>= mesh;
<a name="l01688"></a>01688                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#a0d889f185a69517fb9941e91927f94d9">begin</a>= a*totface;
<a name="l01689"></a>01689                 othreads[a].<a class="code" href="../../df/dee/structOcclusionThread.html#ac593e4abb3b8b807648a8ae20cec2c1c">end</a>= (a == totthread-1)? mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>: (a+1)*totface;
<a name="l01690"></a>01690             }
<a name="l01691"></a>01691 
<a name="l01692"></a>01692             <span class="keywordflow">if</span> (totthread == 1) {
<a name="l01693"></a>01693                 <a class="code" href="../../d1/de7/occlusion_8c.html#a2caa4b5e7fb4ec02ee3b5f18a3c90c33">exec_strandsurface_sample</a>(&amp;othreads[0]);
<a name="l01694"></a>01694             }
<a name="l01695"></a>01695             <span class="keywordflow">else</span> {
<a name="l01696"></a>01696                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../d1/de7/occlusion_8c.html#a2caa4b5e7fb4ec02ee3b5f18a3c90c33">exec_strandsurface_sample</a>, totthread);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698                 <span class="keywordflow">for</span> (a=0; a&lt;totthread; a++)
<a name="l01699"></a>01699                     <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, &amp;othreads[a]);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l01702"></a>01702             }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704             <span class="keywordflow">for</span> (a=0; a&lt;mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afb601af4f53c8df1e2b9d9b843882d7a">totface</a>; a++) {
<a name="l01705"></a>01705                 face= mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ac2fa71da33d28d6fef53c893e3c20192">face</a>[a];
<a name="l01706"></a>01706 
<a name="l01707"></a>01707                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ao, faceao[a]);
<a name="l01708"></a>01708                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(env, faceenv[a]);
<a name="l01709"></a>01709                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(indirect, faceindirect[a]);
<a name="l01710"></a>01710 
<a name="l01711"></a>01711                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[0]], ao);
<a name="l01712"></a>01712                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[0]], env);
<a name="l01713"></a>01713                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[0]], indirect);
<a name="l01714"></a>01714                 count[face[0]]++;
<a name="l01715"></a>01715                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[1]], ao);
<a name="l01716"></a>01716                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[1]], env);
<a name="l01717"></a>01717                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[1]], indirect);
<a name="l01718"></a>01718                 count[face[1]]++;
<a name="l01719"></a>01719                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[2]], ao);
<a name="l01720"></a>01720                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[2]], env);
<a name="l01721"></a>01721                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[2]], indirect);
<a name="l01722"></a>01722                 count[face[2]]++;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724                 <span class="keywordflow">if</span> (face[3]) {
<a name="l01725"></a>01725                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[face[3]], ao);
<a name="l01726"></a>01726                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[face[3]], env);
<a name="l01727"></a>01727                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[face[3]], indirect);
<a name="l01728"></a>01728                     count[face[3]]++;
<a name="l01729"></a>01729                 }
<a name="l01730"></a>01730             }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732             <span class="keywordflow">for</span> (a=0; a&lt;mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#afcdcd67587da48e91422e6d2c9192e29">totvert</a>; a++) {
<a name="l01733"></a>01733                 <span class="keywordflow">if</span> (count[a]) {
<a name="l01734"></a>01734                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a2ad4ca3b14b25eb26421d4c6a8e020d0">ao</a>[a], 1.0f/count[a]);
<a name="l01735"></a>01735                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#ae7c70b3a7d439923db1ec55293e2254e">env</a>[a], 1.0f/count[a]);
<a name="l01736"></a>01736                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(mesh-&gt;<a class="code" href="../../d3/d79/structStrandSurface.html#a36589ebd4f3c70c91293d41dafff07c2">indirect</a>[a], 1.0f/count[a]);
<a name="l01737"></a>01737                 }
<a name="l01738"></a>01738             }
<a name="l01739"></a>01739 
<a name="l01740"></a>01740             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(count);
<a name="l01741"></a>01741             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(faceao);
<a name="l01742"></a>01742             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(faceenv);
<a name="l01743"></a>01743             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(faceindirect);
<a name="l01744"></a>01744         }
<a name="l01745"></a>01745     }
<a name="l01746"></a>01746 }
<a name="l01747"></a>01747 
<a name="l01748"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ae01f83cdf9bab36296fdc6d47991a317">01748</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d3a/occlusion_8h.html#aea80338f1dca4aa15fca8a840ab4a071">free_occ</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l01749"></a>01749 {
<a name="l01750"></a>01750     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>) {
<a name="l01751"></a>01751         <a class="code" href="../../d1/de7/occlusion_8c.html#a5eb2b32c8a1066cb10d688aa2df5ee4b">occ_free_tree</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>);
<a name="l01752"></a>01752         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01753"></a>01753     }
<a name="l01754"></a>01754 }
<a name="l01755"></a>01755 
<a name="l01756"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ae66ae2ce5408ea0dc462c35c13590651">01756</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d3a/occlusion_8h.html#a86b5d3866e784ee6effc8ee0fc726690">sample_occ</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi)
<a name="l01757"></a>01757 {
<a name="l01758"></a>01758     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>;
<a name="l01759"></a>01759     <a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *cache;
<a name="l01760"></a>01760     <a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> *sample;
<a name="l01761"></a>01761     <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> exclude;
<a name="l01762"></a>01762     <span class="keywordtype">int</span> onlyshadow;
<a name="l01763"></a>01763 
<a name="l01764"></a>01764     <span class="keywordflow">if</span> (tree) {
<a name="l01765"></a>01765         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a5640a40dab35f170786c22cd4411b2fd">strand</a>) {
<a name="l01766"></a>01766             <a class="code" href="../../d1/de7/occlusion_8c.html#ae7aea35d213094c001c3398cf0332ac4">sample_occ_surface</a>(shi);
<a name="l01767"></a>01767         }
<a name="l01768"></a>01768         <span class="comment">/* try to get result from the cache if possible */</span>
<a name="l01769"></a>01769         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>!=0 || !<a class="code" href="../../d1/de7/occlusion_8c.html#aa09085a4eb96ec88c478834fa99b0108">sample_occ_cache</a>(tree, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>)) {
<a name="l01770"></a>01770             <span class="comment">/* no luck, let&#39;s sample the occlusion */</span>
<a name="l01771"></a>01771             exclude.<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> - re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>;
<a name="l01772"></a>01772             exclude.<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af721989ef4a8a22ba8a0f80e6d2960ee">index</a>;
<a name="l01773"></a>01773             onlyshadow= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acbcd1a76590cdcea3e105151927ec33d">MA_ONLYSHADOW</a>);
<a name="l01774"></a>01774             <a class="code" href="../../d1/de7/occlusion_8c.html#afcf49c6f060b2564d9535210ccb13afc">sample_occ_tree</a>(re, tree, &amp;exclude, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, onlyshadow, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01775"></a>01775 
<a name="l01776"></a>01776             <span class="comment">/* fill result into sample, each time */</span>
<a name="l01777"></a>01777             <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>) {
<a name="l01778"></a>01778                 cache= &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>];
<a name="l01779"></a>01779 
<a name="l01780"></a>01780                 <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a> &amp;&amp; cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>) {
<a name="l01781"></a>01781                     sample= &amp;cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>[(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>-cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">y</a>)*cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a> + (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>-cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#aa198fda31766a23e5437fbf2785785b0">x</a>)];
<a name="l01782"></a>01782                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ad57e054b757213530d673bff6787b578">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l01783"></a>01783                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a35bc139aa16ed07d92d73690120df40b">n</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>);
<a name="l01784"></a>01784                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01785"></a>01785                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01786"></a>01786                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01787"></a>01787                     sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[2]);
<a name="l01788"></a>01788                     sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>, <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[2]));
<a name="l01789"></a>01789                     sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>, <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[2]));
<a name="l01790"></a>01790                     sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a43524cbdcde4458d587a29210b010dbd">dist2</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>) + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l01791"></a>01791                     sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ac1a1f81ad9b151a4fadb88f9cd0fcd02">filled</a>= 1;
<a name="l01792"></a>01792                 }
<a name="l01793"></a>01793             }
<a name="l01794"></a>01794         }
<a name="l01795"></a>01795     }
<a name="l01796"></a>01796     <span class="keywordflow">else</span> {
<a name="l01797"></a>01797         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[0]= 1.0f;
<a name="l01798"></a>01798         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[1]= 1.0f;
<a name="l01799"></a>01799         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>[2]= 1.0f;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[0]= 0.0f;
<a name="l01802"></a>01802         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[1]= 0.0f;
<a name="l01803"></a>01803         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>[2]= 0.0f;
<a name="l01804"></a>01804 
<a name="l01805"></a>01805         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[0]= 0.0f;
<a name="l01806"></a>01806         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[1]= 0.0f;
<a name="l01807"></a>01807         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>[2]= 0.0f;
<a name="l01808"></a>01808     }
<a name="l01809"></a>01809 }
<a name="l01810"></a>01810 
<a name="l01811"></a><a class="code" href="../../d1/de7/occlusion_8c.html#ac5b49199e453eae39de3067e5963bd1a">01811</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d3a/occlusion_8h.html#a66ac91c1a47400dadf41169d34d6e225">cache_occ_samples</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../da/d1b/structShadeSample.html">ShadeSample</a> *ssamp)
<a name="l01812"></a>01812 {
<a name="l01813"></a>01813     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>;
<a name="l01814"></a>01814     <a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> ps;
<a name="l01815"></a>01815     <a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *cache;
<a name="l01816"></a>01816     <a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a> *sample;
<a name="l01817"></a>01817     <a class="code" href="../../d4/d76/structOccFace.html">OccFace</a> exclude;
<a name="l01818"></a>01818     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi;
<a name="l01819"></a>01819     intptr_t *rd=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01820"></a>01820     <span class="keywordtype">int</span> *ro=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *rp=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *rz=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, onlyshadow;
<a name="l01821"></a>01821     <span class="keywordtype">int</span> x, y, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = <a class="code" href="../../d1/de7/occlusion_8c.html#a4f73a2c875a455a94665a1fab2ad8e31">CACHE_STEP</a>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     <span class="keywordflow">if</span> (!tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>)
<a name="l01824"></a>01824         <span class="keywordflow">return</span>;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826     cache= &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>];
<a name="l01827"></a>01827     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l01828"></a>01828     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a489501c813fcd5ead2c9f5337bc3764b">h</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>;
<a name="l01829"></a>01829     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#aa198fda31766a23e5437fbf2785785b0">x</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l01830"></a>01830     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#add988d9c5e2f2f66ebb4932af33a991b">y</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l01831"></a>01831     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>= <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l01832"></a>01832     cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d37/structOcclusionCacheSample.html">OcclusionCacheSample</a>)*cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a>*cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a489501c813fcd5ead2c9f5337bc3764b">h</a>, <span class="stringliteral">&quot;OcclusionCacheSample&quot;</span>);
<a name="l01833"></a>01833     sample= cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>;
<a name="l01834"></a>01834 
<a name="l01835"></a>01835     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>) {
<a name="l01836"></a>01836         rd= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>;
<a name="l01837"></a>01837     }
<a name="l01838"></a>01838     <span class="keywordflow">else</span> {
<a name="l01839"></a>01839         <span class="comment">/* fake pixel struct for non-osa */</span>
<a name="l01840"></a>01840         ps.<a class="code" href="../../d3/d84/structPixStr.html#aeb6499e7a3de74d45a89157937d40aa4">next</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01841"></a>01841         ps.<a class="code" href="../../d3/d84/structPixStr.html#af0b04e6da97ea4a3181f23d4ab49452e">mask</a>= 0xFFFF;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         ro= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a52f4f2e4cceaff5e79ad83bc44587151">recto</a>;
<a name="l01844"></a>01844         rp= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a19296bd81488c2b963562b2aa11ded26">rectp</a>;
<a name="l01845"></a>01845         rz= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a1faa352cc1d38c2071cc27d89b2db2da">rectz</a>;
<a name="l01846"></a>01846     }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848     <span class="comment">/* compute a sample at every step pixels */</span>
<a name="l01849"></a>01849     <span class="keywordflow">for</span> (y=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>; y&lt;pa-&gt;disprect.ymax; y++) {
<a name="l01850"></a>01850         <span class="keywordflow">for</span> (x=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>; x&lt;pa-&gt;disprect.xmax; x++, sample++, rd++, ro++, rp++, rz++) {
<a name="l01851"></a>01851             <span class="keywordflow">if</span> (!(((x - pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> + step) % step) == 0 || x == pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a>-1))
<a name="l01852"></a>01852                 <span class="keywordflow">continue</span>;
<a name="l01853"></a>01853             <span class="keywordflow">if</span> (!(((y - pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> + step) % step) == 0 || y == pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a>-1))
<a name="l01854"></a>01854                 <span class="keywordflow">continue</span>;
<a name="l01855"></a>01855 
<a name="l01856"></a>01856             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9ca16656c20ef54ab0c08a15185f51e5">osa</a>) {
<a name="l01857"></a>01857                 <span class="keywordflow">if</span> (!*rd) <span class="keywordflow">continue</span>;
<a name="l01858"></a>01858 
<a name="l01859"></a>01859                 <a class="code" href="../../da/d3d/shading_8h.html#a2a2af45cc4a08fddc6436fee0aff80c9">shade_samples_fill_with_ps</a>(ssamp, (<a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *)(*rd), x, y);
<a name="l01860"></a>01860             }
<a name="l01861"></a>01861             <span class="keywordflow">else</span> {
<a name="l01862"></a>01862                 <span class="keywordflow">if</span> (!*rp) <span class="keywordflow">continue</span>;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864                 ps.<a class="code" href="../../d3/d84/structPixStr.html#a0a00df3d865726292458897c2c5348e7">obi</a>= *ro;
<a name="l01865"></a>01865                 ps.<a class="code" href="../../d3/d84/structPixStr.html#a738ddb004590b1337443255887450ef2">facenr</a>= *rp;
<a name="l01866"></a>01866                 ps.<a class="code" href="../../d3/d84/structPixStr.html#a6499b0c851894529dd39cfb0acf90c44">z</a>= *rz;
<a name="l01867"></a>01867                 <a class="code" href="../../da/d3d/shading_8h.html#a2a2af45cc4a08fddc6436fee0aff80c9">shade_samples_fill_with_ps</a>(ssamp, &amp;ps, x, y);
<a name="l01868"></a>01868             }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870             shi= ssamp-&gt;<a class="code" href="../../da/d1b/structShadeSample.html#a46b5a804dfa5f48cc5dad12b23b07e15">shi</a>;
<a name="l01871"></a>01871             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>) {
<a name="l01872"></a>01872                 onlyshadow= (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#acbcd1a76590cdcea3e105151927ec33d">MA_ONLYSHADOW</a>);
<a name="l01873"></a>01873                 exclude.<a class="code" href="../../d4/d76/structOccFace.html#ae2272f08cf87858c22d5aab62227436c">obi</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> - re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>;
<a name="l01874"></a>01874                 exclude.<a class="code" href="../../d4/d76/structOccFace.html#a17b43485a489c1c1521e1ee2d94f6730">facenr</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af721989ef4a8a22ba8a0f80e6d2960ee">index</a>;
<a name="l01875"></a>01875                 <a class="code" href="../../d1/de7/occlusion_8c.html#afcf49c6f060b2564d9535210ccb13afc">sample_occ_tree</a>(re, tree, &amp;exclude, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>, onlyshadow, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01876"></a>01876 
<a name="l01877"></a>01877                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ad57e054b757213530d673bff6787b578">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>);
<a name="l01878"></a>01878                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a35bc139aa16ed07d92d73690120df40b">n</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8b4416f6cf0e7faa5b20e3605c7152d">vno</a>);
<a name="l01879"></a>01879                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ae5cc5c94173becd83eeaa2ed90079e3e">ao</a>);
<a name="l01880"></a>01880                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a9ca21f57be2f41ba861153068002805b">env</a>);
<a name="l01881"></a>01881                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a063daaf399c9ab13a82670795f61b843">indirect</a>);
<a name="l01882"></a>01882                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa9450f69b167c5404aa7e513709884e7">ao</a>[2]);
<a name="l01883"></a>01883                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>, <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a8097c443a8b14fda26237d98eebfea75">env</a>[2]));
<a name="l01884"></a>01884                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa780158ab196ddc6c56e28ae0632daed">intensity</a>, <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[0], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[1], sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aa8f09b6c8cd656ef7078c34db778a3b2">indirect</a>[2]));
<a name="l01885"></a>01885                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a43524cbdcde4458d587a29210b010dbd">dist2</a>= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a812b91cdefe816876f2c3828e42b61f5">dxco</a>) + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a6c6d3730800279e594e30edfe07cc1e2">dyco</a>);
<a name="l01886"></a>01886                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#a5d993212b07302368c9edd1fdf64fe39">x</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>;
<a name="l01887"></a>01887                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#aed22957eb1d7d278dc93f90f64338ede">y</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>;
<a name="l01888"></a>01888                 sample-&gt;<a class="code" href="../../d6/d37/structOcclusionCacheSample.html#ac1a1f81ad9b151a4fadb88f9cd0fcd02">filled</a>= 1;
<a name="l01889"></a>01889             }
<a name="l01890"></a>01890 
<a name="l01891"></a>01891             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l01892"></a>01892                 <span class="keywordflow">break</span>;
<a name="l01893"></a>01893         }
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895 }
<a name="l01896"></a>01896 
<a name="l01897"></a><a class="code" href="../../d1/de7/occlusion_8c.html#aee1738bd0b864d75e3dc67677d58a967">01897</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d3a/occlusion_8h.html#a73b007f52bf034f1829088356eab466c">free_occ_samples</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa)
<a name="l01898"></a>01898 {
<a name="l01899"></a>01899     <a class="code" href="../../dd/d3d/structOcclusionTree.html">OcclusionTree</a> *tree= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a48d62d5ab41a4ccf7ee1323c3f0b5919">occlusiontree</a>;
<a name="l01900"></a>01900     <a class="code" href="../../d5/d68/structOcclusionCache.html">OcclusionCache</a> *cache;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     <span class="keywordflow">if</span> (tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>) {
<a name="l01903"></a>01903         cache= &amp;tree-&gt;<a class="code" href="../../dd/d3d/structOcclusionTree.html#ae7b8e99a81519a3c4c324bb989e1fd3d">cache</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>];
<a name="l01904"></a>01904 
<a name="l01905"></a>01905         <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>)
<a name="l01906"></a>01906             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a441d8e246823fa217f87a61bd5c4a1f1">sample</a>);
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#ad89c2b492127c8a6b350ca8e34abe047">w</a>= 0;
<a name="l01909"></a>01909         cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a489501c813fcd5ead2c9f5337bc3764b">h</a>= 0;
<a name="l01910"></a>01910         cache-&gt;<a class="code" href="../../d5/d68/structOcclusionCache.html#a0e5f85e045805f6cf35529ee370fcef3">step</a>= 0;
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:41 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
