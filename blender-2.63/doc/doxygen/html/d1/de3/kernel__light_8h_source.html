<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: kernel_light.h Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">kernel_light.h</div>  </div>
</div>
<div class="contents">
<a href="../../d1/de3/kernel__light_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright 2011, Blender Foundation.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a127a92451281fa5863da396ed5cd581a">CCL_NAMESPACE_BEGIN</a>
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="../../d2/d36/structLightSample.html">00021</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> {
<a name="l00022"></a><a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">00022</a>     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a>;
<a name="l00023"></a><a class="code" href="../../d2/d36/structLightSample.html#a6ea93f4ab16e793d659804b0b4aafbfb">00023</a>     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d2/d36/structLightSample.html#a6ea93f4ab16e793d659804b0b4aafbfb">D</a>;
<a name="l00024"></a><a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">00024</a>     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a>;
<a name="l00025"></a><a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">00025</a>     <span class="keywordtype">float</span> <a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a>;
<a name="l00026"></a><a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">00026</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a>;
<a name="l00027"></a><a class="code" href="../../d2/d36/structLightSample.html#a71110ee6f301acc3b19c88009448105a">00027</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d36/structLightSample.html#a71110ee6f301acc3b19c88009448105a">prim</a>;
<a name="l00028"></a><a class="code" href="../../d2/d36/structLightSample.html#acc5a337835b1e88fe146ccb112d3458c">00028</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d36/structLightSample.html#acc5a337835b1e88fe146ccb112d3458c">shader</a>;
<a name="l00029"></a><a class="code" href="../../d2/d36/structLightSample.html#aed133357dbd109a6620ce482c79c138b">00029</a>     <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638">LightType</a> <a class="code" href="../../d2/d36/structLightSample.html#aed133357dbd109a6620ce482c79c138b">type</a>;
<a name="l00030"></a>00030 } <a class="code" href="../../d1/de3/kernel__light_8h.html#aec0f7a0a82cf1f9e4ad60f1e96bf5868">LightSample</a>;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">/* Regular Light */</span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a04d0cf2a2cff06f675ec2ae46e185d95">00034</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d1/de3/kernel__light_8h.html#a04d0cf2a2cff06f675ec2ae46e185d95">disk_light_sample</a>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a> v, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv)
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> ru, rv;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038     <a class="code" href="../../d9/d90/util__math_8h.html#a762284acca7756084879a6674135e63f">make_orthonormals</a>(v, &amp;ru, &amp;rv);
<a name="l00039"></a>00039     <a class="code" href="../../d8/dab/kernel__montecarlo_8h.html#a5db99745d7377ad4dbe4d83facc78e68">to_unit_disk</a>(&amp;randu, &amp;randv);
<a name="l00040"></a>00040 
<a name="l00041"></a>00041     <span class="keywordflow">return</span> ru*randu + rv*randv;
<a name="l00042"></a>00042 }
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a9bb49f6780a0866265ea2f938e7c6530">00044</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d1/de3/kernel__light_8h.html#a9bb49f6780a0866265ea2f938e7c6530">distant_light_sample</a>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>, <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046     <span class="keywordflow">return</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(D + <a class="code" href="../../d1/de3/kernel__light_8h.html#a04d0cf2a2cff06f675ec2ae46e185d95">disk_light_sample</a>(D, randu, randv)*size);
<a name="l00047"></a>00047 }
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#acdcac9fce971098ed493da76db5958d3">00049</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d1/de3/kernel__light_8h.html#acdcac9fce971098ed493da76db5958d3">sphere_light_sample</a>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../db/d68/imageprocess_8c.html#adcc0b55f9250038f53e2a10446ed89f5">P</a>, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> center, <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051     <span class="keywordflow">return</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a04d0cf2a2cff06f675ec2ae46e185d95">disk_light_sample</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(P - center), randu, randv)*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a2084b8055923060ed93b7ac49a2df4f5">00054</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d1/de3/kernel__light_8h.html#a2084b8055923060ed93b7ac49a2df4f5">area_light_sample</a>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a> axisu, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> axisv, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     randu = randu - 0.5f;
<a name="l00057"></a>00057     randv = randv - 0.5f;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059     <span class="keywordflow">return</span> axisu*randu + axisv*randv;
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#af113b4998b796ab456adee43a14f8e64">00062</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d1/de3/kernel__light_8h.html#af113b4998b796ab456adee43a14f8e64">background_light_sample</a>(KernelGlobals *kg, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv, <span class="keywordtype">float</span> *pdf)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064     <span class="comment">/* for the following, the CDF values are actually a pair of floats, with the</span>
<a name="l00065"></a>00065 <span class="comment">       function value as X and the actual CDF as Y.  The last entry&#39;s function</span>
<a name="l00066"></a>00066 <span class="comment">       value is the CDF total. */</span>
<a name="l00067"></a>00067     <span class="keywordtype">int</span> res = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_background_res;
<a name="l00068"></a>00068     <span class="keywordtype">int</span> cdf_count = res + 1;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="comment">/* this is basically std::lower_bound as used by pbrt */</span>
<a name="l00071"></a>00071     <span class="keywordtype">int</span> first = 0;
<a name="l00072"></a>00072     <span class="keywordtype">int</span> count = res;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="keywordflow">while</span>(count &gt; 0) {
<a name="l00075"></a>00075         <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = count &gt;&gt; 1;
<a name="l00076"></a>00076         <span class="keywordtype">int</span> middle = first + <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, middle).y &lt; randv) {
<a name="l00079"></a>00079             first = middle + 1;
<a name="l00080"></a>00080             count -= step + 1;
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082         <span class="keywordflow">else</span>
<a name="l00083"></a>00083             count = <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="keywordtype">int</span> index_v = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(0, first - 1);
<a name="l00087"></a>00087     <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a866efec0712485a0f5b56618ae436ec3">kernel_assert</a>(index_v &gt;= 0 &amp;&amp; index_v &lt; res);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_v = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, index_v);
<a name="l00090"></a>00090     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_next_v = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, index_v + 1);
<a name="l00091"></a>00091     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_last_v = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, res);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     <span class="comment">/* importance-sampled V direction */</span>
<a name="l00094"></a>00094     <span class="keywordtype">float</span> dv = (randv - cdf_v.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a>) / (cdf_next_v.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a> - cdf_v.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a>);
<a name="l00095"></a>00095     <span class="keywordtype">float</span> v = (index_v + dv) / res;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="comment">/* this is basically std::lower_bound as used by pbrt */</span>
<a name="l00098"></a>00098     first = 0;
<a name="l00099"></a>00099     count = res;
<a name="l00100"></a>00100     <span class="keywordflow">while</span>(count &gt; 0) {
<a name="l00101"></a>00101         <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = count &gt;&gt; 1;
<a name="l00102"></a>00102         <span class="keywordtype">int</span> middle = first + <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * cdf_count + middle).y &lt; randu) {
<a name="l00105"></a>00105             first = middle + 1;
<a name="l00106"></a>00106             count -= step + 1;
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108         <span class="keywordflow">else</span>
<a name="l00109"></a>00109             count = <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>;
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordtype">int</span> index_u = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(0, first - 1);
<a name="l00113"></a>00113     <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a866efec0712485a0f5b56618ae436ec3">kernel_assert</a>(index_u &gt;= 0 &amp;&amp; index_u &lt; res);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_u = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * cdf_count + index_u);
<a name="l00116"></a>00116     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_next_u = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * cdf_count + index_u + 1);
<a name="l00117"></a>00117     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_last_u = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * cdf_count + res);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">/* importance-sampled U direction */</span>
<a name="l00120"></a>00120     <span class="keywordtype">float</span> du = (randu - cdf_u.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a>) / (cdf_next_u.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a> - cdf_u.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a>);
<a name="l00121"></a>00121     <span class="keywordtype">float</span> u = (index_u + du) / res;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="comment">/* compute pdf */</span>
<a name="l00124"></a>00124     <span class="keywordtype">float</span> denom = cdf_last_u.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a> * cdf_last_v.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a>;
<a name="l00125"></a>00125     <span class="keywordtype">float</span> sin_theta = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(<a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a> * v);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="keywordflow">if</span>(sin_theta == 0.0f || denom == 0.0f)
<a name="l00128"></a>00128         *pdf = 0.0f;
<a name="l00129"></a>00129     <span class="keywordflow">else</span>
<a name="l00130"></a>00130         *pdf = (cdf_u.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a> * cdf_v.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a>)/(2.0f * <a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a> * <a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a> * sin_theta * denom);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     *pdf *= <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_lights;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="comment">/* compute direction */</span>
<a name="l00135"></a>00135     <span class="keywordflow">return</span> -<a class="code" href="../../d8/dab/kernel__montecarlo_8h.html#a88e7be63596ad2804dcec557ccd0ed34">equirectangular_to_direction</a>(u, v);
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a8f1bea1b4bd1e43c5f10e6e5fa786ccd">00138</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a8f1bea1b4bd1e43c5f10e6e5fa786ccd">background_light_pdf</a>(KernelGlobals *kg, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> direction)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> uv = <a class="code" href="../../d8/dab/kernel__montecarlo_8h.html#acb003e94c9be86fe2e1d975a32de3474">direction_to_equirectangular</a>(direction);
<a name="l00141"></a>00141     <span class="keywordtype">int</span> res = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_background_res;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordtype">float</span> sin_theta = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(uv.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a> * <a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a>);
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">if</span>(sin_theta == 0.0f)
<a name="l00146"></a>00146         <span class="keywordflow">return</span> 0.0f;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordtype">int</span> index_u = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>((<span class="keywordtype">int</span>)(uv.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a> * res), 0, res - 1);
<a name="l00149"></a>00149     <span class="keywordtype">int</span> index_v = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>((<span class="keywordtype">int</span>)(uv.<a class="code" href="../../d8/d34/structfloat2.html#a0f1298f22c4ee20a369cd3b9c25b2cc6">y</a> * res), 0, res - 1);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <span class="comment">/* pdfs in V direction */</span>
<a name="l00152"></a>00152     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_last_u = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * (res + 1) + res);
<a name="l00153"></a>00153     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_last_v = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, res);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="keywordtype">float</span> denom = cdf_last_u.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a> * cdf_last_v.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keywordflow">if</span>(denom == 0.0f)
<a name="l00158"></a>00158         <span class="keywordflow">return</span> 0.0f;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">/* pdfs in U direction */</span>
<a name="l00161"></a>00161     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_u = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_conditional_cdf, index_v * (res + 1) + index_u);
<a name="l00162"></a>00162     <a class="code" href="../../d8/d34/structfloat2.html">float2</a> cdf_v = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_background_marginal_cdf, index_v);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordtype">float</span> pdf = (cdf_u.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a> * cdf_v.<a class="code" href="../../d8/d34/structfloat2.html#a0bb68b4a8de04ffea5f7aae53c48a613">x</a>)/(2.0f * <a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a> * <a class="code" href="../../d9/d90/util__math_8h.html#ab9c3c609e1d02430671de0a109410ac8">M_PI_F</a> * sin_theta * denom);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="keywordflow">return</span> pdf * <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_lights;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#aeec25363067d5a5f4695b6bbb31cd07b">00169</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#aeec25363067d5a5f4695b6bbb31cd07b">regular_light_sample</a>(KernelGlobals *kg, <span class="keywordtype">int</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>,
<a name="l00170"></a>00170     <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../db/d68/imageprocess_8c.html#adcc0b55f9250038f53e2a10446ed89f5">P</a>, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls, <span class="keywordtype">float</span> *pdf)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> data0 = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_data, point*<a class="code" href="../../d4/d05/kernel__types_8h.html#a95551497e5c6280149bbcf7716b08ad1">LIGHT_SIZE</a> + 0);
<a name="l00173"></a>00173     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> data1 = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_data, point*<a class="code" href="../../d4/d05/kernel__types_8h.html#a95551497e5c6280149bbcf7716b08ad1">LIGHT_SIZE</a> + 1);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638">LightType</a> type = (<a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638">LightType</a>)<a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(data0.<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a>);
<a name="l00176"></a>00176     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#aed133357dbd109a6620ce482c79c138b">type</a> = type;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordflow">if</span>(type == <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638a8ff6529b7fccbc0e2de788ec4fb93955">LIGHT_DISTANT</a>) {
<a name="l00179"></a>00179         <span class="comment">/* distant light */</span>
<a name="l00180"></a>00180         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a> = <a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(data0.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, data0.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, data0.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00181"></a>00181         <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = data1.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="keywordflow">if</span>(size &gt; 0.0f)
<a name="l00184"></a>00184             D = <a class="code" href="../../d1/de3/kernel__light_8h.html#a9bb49f6780a0866265ea2f938e7c6530">distant_light_sample</a>(D, size, randu, randv);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> = <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00187"></a>00187         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a> = <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00188"></a>00188         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6ea93f4ab16e793d659804b0b4aafbfb">D</a> = -<a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00189"></a>00189         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a> = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 <span class="preprocessor">#ifdef __BACKGROUND_MIS__</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type == <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638a99b64d93fc67c275192cf880466350fb">LIGHT_BACKGROUND</a>) {
<a name="l00193"></a>00193         <span class="comment">/* infinite area light (e.g. light dome or env light) */</span>
<a name="l00194"></a>00194         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a> = <a class="code" href="../../d1/de3/kernel__light_8h.html#af113b4998b796ab456adee43a14f8e64">background_light_sample</a>(kg, randu, randv, pdf);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> = <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00197"></a>00197         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a> = <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00198"></a>00198         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6ea93f4ab16e793d659804b0b4aafbfb">D</a> = -<a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00199"></a>00199         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a> = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 <span class="preprocessor">#endif</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
<a name="l00203"></a>00203         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> = <a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(data0.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, data0.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, data0.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <span class="keywordflow">if</span>(type == <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638abdec4858df81ac7fc719321ed2b4fe7c">LIGHT_POINT</a>) {
<a name="l00206"></a>00206             <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = data1.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>;
<a name="l00207"></a>00207 
<a name="l00208"></a>00208             <span class="comment">/* sphere light */</span>
<a name="l00209"></a>00209             <span class="keywordflow">if</span>(size &gt; 0.0f)
<a name="l00210"></a>00210                 ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> += <a class="code" href="../../d1/de3/kernel__light_8h.html#acdcac9fce971098ed493da76db5958d3">sphere_light_sample</a>(P, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a>, size, randu, randv);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212             ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a> = <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(P - ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a>);
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214         <span class="keywordflow">else</span> {
<a name="l00215"></a>00215             <span class="comment">/* area light */</span>
<a name="l00216"></a>00216             <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> data2 = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_data, point*<a class="code" href="../../d4/d05/kernel__types_8h.html#a95551497e5c6280149bbcf7716b08ad1">LIGHT_SIZE</a> + 2);
<a name="l00217"></a>00217             <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> data3 = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_data, point*<a class="code" href="../../d4/d05/kernel__types_8h.html#a95551497e5c6280149bbcf7716b08ad1">LIGHT_SIZE</a> + 3);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> axisu = <a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(data1.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, data1.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, data2.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00220"></a>00220             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> axisv = <a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(data2.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, data2.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, data2.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00221"></a>00221             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a> = <a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(data3.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>, data3.<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a>, data3.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223             ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> += <a class="code" href="../../d1/de3/kernel__light_8h.html#a2084b8055923060ed93b7ac49a2df4f5">area_light_sample</a>(axisu, axisv, randu, randv);
<a name="l00224"></a>00224             ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a> = <a class="code" href="../../da/d6c/voxel_8c.html#acd4207c685797d5be90a34456ff9d2e7">D</a>;
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a> = 0.0f;
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#acc5a337835b1e88fe146ccb112d3458c">shader</a> = <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(data1.<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a>);
<a name="l00231"></a>00231     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a> = ~0;
<a name="l00232"></a>00232     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a71110ee6f301acc3b19c88009448105a">prim</a> = ~0;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a286cd67e26b45dfe9273a6af2924ad8e">00235</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a286cd67e26b45dfe9273a6af2924ad8e">regular_light_pdf</a>(KernelGlobals *kg,
<a name="l00236"></a>00236     <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> Ng, <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>, <span class="keywordtype">float</span> t)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <span class="keywordtype">float</span> pdf = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_lights;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">if</span>(t == <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>)
<a name="l00241"></a>00241         <span class="keywordflow">return</span> pdf;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keywordtype">float</span> cos_pi = <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(Ng, I);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="keywordflow">if</span>(cos_pi &lt;= 0.0f)
<a name="l00246"></a>00246         <span class="keywordflow">return</span> 0.0f;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="keywordflow">return</span> t*t*pdf/cos_pi;
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="comment">/* Triangle Light */</span>
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a2a29de9db84858ead7b9eb463a1d7ec6">00253</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a2a29de9db84858ead7b9eb463a1d7ec6">triangle_light_sample</a>(KernelGlobals *kg, <span class="keywordtype">int</span> prim, <span class="keywordtype">int</span> <span class="keywordtype">object</span>,
<a name="l00254"></a>00254     <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls)
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256     <span class="comment">/* triangle, so get position, normal, shader */</span>
<a name="l00257"></a>00257     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> = <a class="code" href="../../d2/d77/kernel__triangle_8h.html#ae9bffaab5f61573bb28f2578f416136f">triangle_sample_MT</a>(kg, prim, randu, randv);
<a name="l00258"></a>00258     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a> = <a class="code" href="../../d2/d77/kernel__triangle_8h.html#a0351c851c260d9c9dc17d744808247cb">triangle_normal_MT</a>(kg, prim, &amp;ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#acc5a337835b1e88fe146ccb112d3458c">shader</a>);
<a name="l00259"></a>00259     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a> = object;
<a name="l00260"></a>00260     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a71110ee6f301acc3b19c88009448105a">prim</a> = prim;
<a name="l00261"></a>00261     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a> = 0.0f;
<a name="l00262"></a>00262     ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#aed133357dbd109a6620ce482c79c138b">type</a> = <a class="code" href="../../d4/d05/kernel__types_8h.html#adc3ec8293e6a97ebe43f0196b9a7f638a093d80dabff7744f1d8889c901e511e4">LIGHT_AREA</a>;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="preprocessor">#ifdef __INSTANCING__</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span>    <span class="comment">/* instance transform */</span>
<a name="l00266"></a>00266     <span class="keywordflow">if</span>(ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a> &gt;= 0) {
<a name="l00267"></a>00267         <a class="code" href="../../db/d80/kernel__object_8h.html#adc0b4795ec94b1ed6fc430a6cb4c3409">object_position_transform</a>(kg, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a>, &amp;ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a>);
<a name="l00268"></a>00268         <a class="code" href="../../db/d80/kernel__object_8h.html#a7596ca674fff81468c3095104cabc623">object_normal_transform</a>(kg, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a79c865e345aab58fc0fe9d89629faebb">object</a>, &amp;ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a>);
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270 <span class="preprocessor">#endif</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>}
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a10cc4329d5869d19ecd05bb6e0640a1e">00273</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a10cc4329d5869d19ecd05bb6e0640a1e">triangle_light_pdf</a>(KernelGlobals *kg,
<a name="l00274"></a>00274     <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> Ng, <span class="keyword">const</span> <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>, <span class="keywordtype">float</span> t)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="keywordtype">float</span> cos_pi = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(Ng, I));
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="keywordflow">if</span>(cos_pi == 0.0f)
<a name="l00279"></a>00279         <span class="keywordflow">return</span> 0.0f;
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     <span class="keywordflow">return</span> (t*t*<a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.pdf_triangles)/cos_pi;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment">/* Light Distribution */</span>
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a88264760bfada82d468cb0c1cc3703ab">00286</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a88264760bfada82d468cb0c1cc3703ab">light_distribution_sample</a>(KernelGlobals *kg, <span class="keywordtype">float</span> randt)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288     <span class="comment">/* this is basically std::upper_bound as used by pbrt, to find a point light or</span>
<a name="l00289"></a>00289 <span class="comment">       triangle to emit from, proportional to area. a good improvement would be to</span>
<a name="l00290"></a>00290 <span class="comment">       also sample proportional to power, though it&#39;s not so well defined with</span>
<a name="l00291"></a>00291 <span class="comment">       OSL shaders. */</span>
<a name="l00292"></a>00292     <span class="keywordtype">int</span> first = 0;
<a name="l00293"></a>00293     <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a> = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.num_distribution + 1;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="keywordflow">while</span>(len &gt; 0) {
<a name="l00296"></a>00296         <span class="keywordtype">int</span> half_len = len &gt;&gt; 1;
<a name="l00297"></a>00297         <span class="keywordtype">int</span> middle = first + half_len;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="keywordflow">if</span>(randt &lt; <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_distribution, middle).x) {
<a name="l00300"></a>00300             len = half_len;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">else</span> {
<a name="l00303"></a>00303             first = middle + 1;
<a name="l00304"></a>00304             len = len - half_len - 1;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     first = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(0, first-1);
<a name="l00309"></a>00309     <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a866efec0712485a0f5b56618ae436ec3">kernel_assert</a>(first &gt;= 0 &amp;&amp; first &lt; <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#a102e98d86573e1b464010a99208ae91d">kernel_data</a>.integrator.num_distribution);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordflow">return</span> first;
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 <span class="comment">/* Generic Light */</span>
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#abbcadf04635c64c4a220a01f12629c73">00316</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#abbcadf04635c64c4a220a01f12629c73">light_sample</a>(KernelGlobals *kg, <span class="keywordtype">float</span> randt, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../db/d68/imageprocess_8c.html#adcc0b55f9250038f53e2a10446ed89f5">P</a>, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls, <span class="keywordtype">float</span> *pdf)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <span class="comment">/* sample index */</span>
<a name="l00319"></a>00319     <span class="keywordtype">int</span> index = <a class="code" href="../../d1/de3/kernel__light_8h.html#a88264760bfada82d468cb0c1cc3703ab">light_distribution_sample</a>(kg, randt);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <span class="comment">/* fetch light data */</span>
<a name="l00322"></a>00322     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> l = <a class="code" href="../../dc/d9e/kernel__compat__cpu_8h.html#ae2fef9c7b0fd15d8b61a1b6ff548f518">kernel_tex_fetch</a>(__light_distribution, index);
<a name="l00323"></a>00323     <span class="keywordtype">int</span> prim = <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(l.<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a>);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordflow">if</span>(prim &gt;= 0) {
<a name="l00326"></a>00326         <span class="keywordtype">int</span> <span class="keywordtype">object</span> = <a class="code" href="../../d9/d90/util__math_8h.html#af763dc486760e407ea4d067e3b81301b">__float_as_int</a>(l.<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a>);
<a name="l00327"></a>00327         <a class="code" href="../../d1/de3/kernel__light_8h.html#a2a29de9db84858ead7b9eb463a1d7ec6">triangle_light_sample</a>(kg, prim, <span class="keywordtype">object</span>, randu, randv, ls);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329     <span class="keywordflow">else</span> {
<a name="l00330"></a>00330         <span class="keywordtype">int</span> <a class="code" href="../../d8/dae/structpoint.html">point</a> = -prim-1;
<a name="l00331"></a>00331         <a class="code" href="../../d1/de3/kernel__light_8h.html#aeec25363067d5a5f4695b6bbb31cd07b">regular_light_sample</a>(kg, point, randu, randv, P, ls, pdf);
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="comment">/* compute incoming direction and distance */</span>
<a name="l00335"></a>00335     <span class="keywordflow">if</span>(ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a> != <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>)
<a name="l00336"></a>00336         ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6ea93f4ab16e793d659804b0b4aafbfb">D</a> = <a class="code" href="../../d9/d90/util__math_8h.html#adfd142447140877b57ee0cbf8f73cff8">normalize_len</a>(ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a6667ce45da8f28cb5d78e492d01fd186">P</a> - P, &amp;ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a7e7780c22559f91e8d40cab49939eaab">t</a>);
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#aba52b4bd6a5cb3d5b49a35365cb46430">00339</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#aba52b4bd6a5cb3d5b49a35365cb46430">light_sample_pdf</a>(KernelGlobals *kg, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>, <span class="keywordtype">float</span> t)
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341     <span class="keywordtype">float</span> pdf;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span>(ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a71110ee6f301acc3b19c88009448105a">prim</a> != ~0)
<a name="l00344"></a>00344         pdf = <a class="code" href="../../d1/de3/kernel__light_8h.html#a10cc4329d5869d19ecd05bb6e0640a1e">triangle_light_pdf</a>(kg, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a>, I, t);
<a name="l00345"></a>00345     <span class="keywordflow">else</span>
<a name="l00346"></a>00346         pdf = <a class="code" href="../../d1/de3/kernel__light_8h.html#a286cd67e26b45dfe9273a6af2924ad8e">regular_light_pdf</a>(kg, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a>, I, t);
<a name="l00347"></a>00347     
<a name="l00348"></a>00348     <span class="keywordflow">return</span> pdf;
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a79a2c0137f50fcfb3b795f51a1e377ab">00351</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a79a2c0137f50fcfb3b795f51a1e377ab">light_select</a>(KernelGlobals *kg, <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> randu, <span class="keywordtype">float</span> randv, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../db/d68/imageprocess_8c.html#adcc0b55f9250038f53e2a10446ed89f5">P</a>, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls, <span class="keywordtype">float</span> *pdf)
<a name="l00352"></a>00352 {
<a name="l00353"></a>00353     <a class="code" href="../../d1/de3/kernel__light_8h.html#aeec25363067d5a5f4695b6bbb31cd07b">regular_light_sample</a>(kg, index, randu, randv, P, ls, pdf);
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="../../d1/de3/kernel__light_8h.html#a37199fe46bb9464bd5f476dfe76b771b">00356</a> <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a208309018bbf41da4094eb99cf27210c">__device</a> <span class="keywordtype">float</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a37199fe46bb9464bd5f476dfe76b771b">light_select_pdf</a>(KernelGlobals *kg, <a class="code" href="../../d2/d36/structLightSample.html">LightSample</a> *ls, <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>, <span class="keywordtype">float</span> t)
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358     <span class="keywordflow">return</span> <a class="code" href="../../d1/de3/kernel__light_8h.html#a286cd67e26b45dfe9273a6af2924ad8e">regular_light_pdf</a>(kg, ls-&gt;<a class="code" href="../../d2/d36/structLightSample.html#a5133a15d875b81da537c793aac718efc">Ng</a>, I, t);
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#ae0c27e57708248c67409956ddc159e18">CCL_NAMESPACE_END</a>
<a name="l00362"></a>00362 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:26 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
