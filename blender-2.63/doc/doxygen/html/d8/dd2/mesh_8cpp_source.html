<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: mesh.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">mesh.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d8/dd2/mesh_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright 2011, Blender Foundation.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;bvh.h&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d2b/bvh__build_8h.html">bvh_build.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="../../db/de9/device_8h.html">device.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/df4/shader_8h.html">shader.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/dd3/light_8h.html">light.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d3b/mesh_8h.html">mesh.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d10/object_8h.html">object.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d83/scene_8h.html">scene.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/ddd/osl__globals_8h.html">osl_globals.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d34/util__cache_8h.html">util_cache.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d42/util__foreach_8h.html">util_foreach.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d74/util__progress_8h.html">util_progress.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d01/util__set_8h.html">util_set.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#a127a92451281fa5863da396ed5cd581a">CCL_NAMESPACE_BEGIN</a>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/* Mesh */</span>
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="../../da/d29/structMesh.html#a50506ac70d3c9bb1fe299eba1defaf07">00040</a> <a class="code" href="../../da/d29/structMesh.html#a50506ac70d3c9bb1fe299eba1defaf07">Mesh::Mesh</a>()
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042     <a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> = <span class="keyword">true</span>;
<a name="l00043"></a>00043     <a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a> = <span class="keyword">false</span>;
<a name="l00044"></a>00044     <a class="code" href="../../da/d29/structMesh.html#a5930551cf13bdccb7d547c0a9f1252e6">transform_negative_scaled</a> = <span class="keyword">false</span>;
<a name="l00045"></a>00045     <a class="code" href="../../da/d29/structMesh.html#aa4278390724eee554c15afec17766db2">displacement_method</a> = <a class="code" href="../../da/d29/structMesh.html#a331ada60000f6153350fabe737778897ab59af13d22e9e93ad6682d4e93160da6">DISPLACE_BUMP</a>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a> = 0;
<a name="l00050"></a>00050     <a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a> = 0;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a1ec5a719eb773d1494df7e39d490bca6">mesh</a> = <span class="keyword">this</span>;
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="../../da/d29/structMesh.html#a5efe4da1a4c0971cfb037bd70304c303">00055</a> <a class="code" href="../../da/d29/structMesh.html#a5efe4da1a4c0971cfb037bd70304c303">Mesh::~Mesh</a>()
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057     <span class="keyword">delete</span> <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>;
<a name="l00058"></a>00058 }
<a name="l00059"></a>00059 
<a name="l00060"></a><a class="code" href="../../da/d29/structMesh.html#af8418abea6e6019bc824a477a8b6fbe8">00060</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#af8418abea6e6019bc824a477a8b6fbe8">Mesh::reserve</a>(<span class="keywordtype">int</span> numverts, <span class="keywordtype">int</span> numtris)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062     <span class="comment">/* reserve space to add verts and triangles later */</span>
<a name="l00063"></a>00063     <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.resize(numverts);
<a name="l00064"></a>00064     <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.resize(numtris);
<a name="l00065"></a>00065     <a class="code" href="../../da/d29/structMesh.html#abcb2483f9ba4edd4e37be3a6afb75640">shader</a>.resize(numtris);
<a name="l00066"></a>00066     <a class="code" href="../../da/d29/structMesh.html#a39a60f6529f96fadaa3f10e995cdc95a">smooth</a>.resize(numtris);
<a name="l00067"></a>00067     <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a3309b22e7c4d6bf41732172d8b038bee">reserve</a>(numverts, numtris);
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="../../da/d29/structMesh.html#a7008e23cbaacd2878b7e81a01ac5d96b">00070</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#a7008e23cbaacd2878b7e81a01ac5d96b">Mesh::clear</a>()
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072     <span class="comment">/* clear all verts and triangles */</span>
<a name="l00073"></a>00073     <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.clear();
<a name="l00074"></a>00074     <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.clear();
<a name="l00075"></a>00075     <a class="code" href="../../da/d29/structMesh.html#abcb2483f9ba4edd4e37be3a6afb75640">shader</a>.clear();
<a name="l00076"></a>00076     <a class="code" href="../../da/d29/structMesh.html#a39a60f6529f96fadaa3f10e995cdc95a">smooth</a>.clear();
<a name="l00077"></a>00077 
<a name="l00078"></a>00078     <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#ae265bbc6c6e50ba7cbf11c57d6c5d647">clear</a>();
<a name="l00079"></a>00079     <a class="code" href="../../da/d29/structMesh.html#aacb9299857c7521104235ddfde925294">used_shaders</a>.clear();
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a> = <span class="keyword">false</span>;
<a name="l00082"></a>00082     <a class="code" href="../../da/d29/structMesh.html#a5930551cf13bdccb7d547c0a9f1252e6">transform_negative_scaled</a> = <span class="keyword">false</span>;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="../../da/d29/structMesh.html#acf7807bd963745adbd387517c10a2f89">00085</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#acf7807bd963745adbd387517c10a2f89">Mesh::add_triangle</a>(<span class="keywordtype">int</span> v0, <span class="keywordtype">int</span> v1, <span class="keywordtype">int</span> v2, <span class="keywordtype">int</span> shader_, <span class="keywordtype">bool</span> smooth_)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087     <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> t;
<a name="l00088"></a>00088     t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[0] = v0;
<a name="l00089"></a>00089     t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[1] = v1;
<a name="l00090"></a>00090     t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[2] = v2;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.push_back(t);
<a name="l00093"></a>00093     <a class="code" href="../../da/d29/structMesh.html#abcb2483f9ba4edd4e37be3a6afb75640">shader</a>.push_back(shader_);
<a name="l00094"></a>00094     <a class="code" href="../../da/d29/structMesh.html#a39a60f6529f96fadaa3f10e995cdc95a">smooth</a>.push_back(smooth_);
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../da/d29/structMesh.html#a1bd48298143b511667f21f3b810a43cc">00097</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#a1bd48298143b511667f21f3b810a43cc">Mesh::compute_bounds</a>()
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> bnds;
<a name="l00100"></a>00100     <span class="keywordtype">size_t</span> verts_size = <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size();
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; verts_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00103"></a>00103         bnds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105     <span class="comment">/* happens mostly on empty meshes */</span>
<a name="l00106"></a>00106     <span class="keywordflow">if</span>(!bnds.<a class="code" href="../../d3/d8a/structBoundBox.html#a0af6f16297901cfb91cace9e11baf95a">valid</a>())
<a name="l00107"></a>00107         bnds.<a class="code" href="../../d3/d8a/structBoundBox.html#a28545c59ba52827abe56f12f63ba6369">grow</a>(<a class="code" href="../../d7/dad/util__types_8h.html#a957c369f48bce1b714e6c7d54130207b">make_float3</a>(0.0f, 0.0f, 0.0f));
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <a class="code" href="../../da/d29/structMesh.html#ab0f0bda29a80342cef2f56a5dad1fde0">bounds</a> = bnds;
<a name="l00110"></a>00110 }
<a name="l00111"></a>00111 
<a name="l00112"></a><a class="code" href="../../da/d29/structMesh.html#af166e566e1c399a3e2b2e08e4f84de89">00112</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#af166e566e1c399a3e2b2e08e4f84de89">Mesh::add_face_normals</a>()
<a name="l00113"></a>00113 {
<a name="l00114"></a>00114     <span class="comment">/* don&#39;t compute if already there */</span>
<a name="l00115"></a>00115     <span class="keywordflow">if</span>(<a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a0b2903041946465190f49d0cbc9ab965">Attribute::STD_FACE_NORMAL</a>))
<a name="l00116"></a>00116         <span class="keywordflow">return</span>;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="comment">/* get attributes */</span>
<a name="l00119"></a>00119     <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *attr_fN = <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#ae4c625a3f1c42c43d71d3abcc2b9fc3d">add</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a0b2903041946465190f49d0cbc9ab965">Attribute::STD_FACE_NORMAL</a>);
<a name="l00120"></a>00120     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *fN = attr_fN-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <span class="comment">/* compute face normals */</span>
<a name="l00123"></a>00123     <span class="keywordtype">size_t</span> triangles_size = <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size();
<a name="l00124"></a>00124     <span class="keywordtype">bool</span> flip = <a class="code" href="../../da/d29/structMesh.html#a5930551cf13bdccb7d547c0a9f1252e6">transform_negative_scaled</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">if</span>(triangles_size) {
<a name="l00127"></a>00127         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *verts_ptr = &amp;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0];
<a name="l00128"></a>00128         <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> *triangles_ptr = &amp;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[0];
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; triangles_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00131"></a>00131             <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> t = triangles_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00132"></a>00132             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v0 = verts_ptr[t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[0]];
<a name="l00133"></a>00133             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v1 = verts_ptr[t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[1]];
<a name="l00134"></a>00134             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> v2 = verts_ptr[t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[2]];
<a name="l00135"></a>00135 
<a name="l00136"></a>00136             fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(<a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>(v1 - v0, v2 - v0));
<a name="l00137"></a>00137 
<a name="l00138"></a>00138             <span class="keywordflow">if</span>(flip)
<a name="l00139"></a>00139                 fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142 }
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="../../da/d29/structMesh.html#a5178916266e0d01a55b44d4a538a2ecd">00144</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#a5178916266e0d01a55b44d4a538a2ecd">Mesh::add_vertex_normals</a>()
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <span class="comment">/* don&#39;t compute if already there */</span>
<a name="l00147"></a>00147     <span class="keywordflow">if</span>(<a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a7c914206abb66e161e8b04d5c77b944d">Attribute::STD_VERTEX_NORMAL</a>))
<a name="l00148"></a>00148         <span class="keywordflow">return</span>;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">/* get attributes */</span>
<a name="l00151"></a>00151     <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *attr_fN = <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a0b2903041946465190f49d0cbc9ab965">Attribute::STD_FACE_NORMAL</a>);
<a name="l00152"></a>00152     <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *attr_vN = <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#ae4c625a3f1c42c43d71d3abcc2b9fc3d">add</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a7c914206abb66e161e8b04d5c77b944d">Attribute::STD_VERTEX_NORMAL</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *fN = attr_fN-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00155"></a>00155     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *vN = attr_vN-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">/* compute vertex normals */</span>
<a name="l00158"></a>00158     memset(vN, 0, <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size()*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a>));
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordtype">size_t</span> verts_size = <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size();
<a name="l00161"></a>00161     <span class="keywordtype">size_t</span> triangles_size = <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size();
<a name="l00162"></a>00162     <span class="keywordtype">bool</span> flip = <a class="code" href="../../da/d29/structMesh.html#a5930551cf13bdccb7d547c0a9f1252e6">transform_negative_scaled</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordflow">if</span>(triangles_size) {
<a name="l00165"></a>00165         <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> *triangles_ptr = &amp;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[0];
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; triangles_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00168"></a>00168             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> j = 0; j &lt; 3; j++)
<a name="l00169"></a>00169                 vN[triangles_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].v[j]] += fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; verts_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00173"></a>00173         vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l00174"></a>00174         <span class="keywordflow">if</span>(flip)
<a name="l00175"></a>00175             vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="../../da/d29/structMesh.html#a08336faf042be360bb51708dba77ea12">00179</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#a08336faf042be360bb51708dba77ea12">Mesh::pack_normals</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *normal, <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *<a class="code" href="../../df/dae/BKE__mball_8h.html#aec2d752753646f357110ad531816727d">vnormal</a>)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181     <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *attr_fN = <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a0b2903041946465190f49d0cbc9ab965">Attribute::STD_FACE_NORMAL</a>);
<a name="l00182"></a>00182     <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *attr_vN = <a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a7c914206abb66e161e8b04d5c77b944d">Attribute::STD_VERTEX_NORMAL</a>);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *fN = attr_fN-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00185"></a>00185     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *vN = attr_vN-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00186"></a>00186     <span class="keywordtype">int</span> shader_id = 0;
<a name="l00187"></a>00187     <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> last_shader = -1;
<a name="l00188"></a>00188     <span class="keywordtype">bool</span> last_smooth = <span class="keyword">false</span>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordtype">size_t</span> triangles_size = <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size();
<a name="l00191"></a>00191     <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> *shader_ptr = (<a class="code" href="../../da/d29/structMesh.html#abcb2483f9ba4edd4e37be3a6afb75640">shader</a>.size())? &amp;<a class="code" href="../../da/d29/structMesh.html#abcb2483f9ba4edd4e37be3a6afb75640">shader</a>[0]: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; triangles_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00194"></a>00194         normal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dd/d9d/structfloat4.html#ab60e7164162636ef8d0315cf18269b0f">x</a> = fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>;
<a name="l00195"></a>00195         normal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dd/d9d/structfloat4.html#a72bce4984c96cef3d6a50adcbce6e388">y</a> = fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>;
<a name="l00196"></a>00196         normal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dd/d9d/structfloat4.html#a898443ac0132ee9f149661c63882361b">z</a> = fN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="comment">/* stuff shader id in here too */</span>
<a name="l00199"></a>00199         <span class="keywordflow">if</span>(shader_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != last_shader || last_smooth != <a class="code" href="../../da/d29/structMesh.html#a39a60f6529f96fadaa3f10e995cdc95a">smooth</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {
<a name="l00200"></a>00200             last_shader = shader_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00201"></a>00201             last_smooth = <a class="code" href="../../da/d29/structMesh.html#a39a60f6529f96fadaa3f10e995cdc95a">smooth</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00202"></a>00202             shader_id = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a9b9f9b773599a3854705c15816d61fba">shader_manager</a>-&gt;<a class="code" href="../../dc/d18/classShaderManager.html#a8b93ab3624512d5ff9e9c1cbeb6988b1">get_shader_id</a>(last_shader, <span class="keyword">this</span>, last_smooth);
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         normal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dd/d9d/structfloat4.html#ae3ef7af10eec7945566a363866321e26">w</a> = <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(shader_id);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="keywordtype">size_t</span> verts_size = <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size();
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; verts_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00211"></a>00211         vnormal[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].x, vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].y, vN[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].z, 0.0f);
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="../../da/d29/structMesh.html#a545dabcffebe7c6fa0c457a906a2e256">00214</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#a545dabcffebe7c6fa0c457a906a2e256">Mesh::pack_verts</a>(<a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *tri_verts, <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *tri_vindex, <span class="keywordtype">size_t</span> vert_offset)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <span class="keywordtype">size_t</span> verts_size = <a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size();
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keywordflow">if</span>(verts_size) {
<a name="l00219"></a>00219         <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *verts_ptr = &amp;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0];
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; verts_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00222"></a>00222             <a class="code" href="../../d9/d19/structfloat3.html">float3</a> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = verts_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00223"></a>00223             tri_verts[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(p.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, p.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, p.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>, 0.0f);
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordtype">size_t</span> triangles_size = <a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size();
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="keywordflow">if</span>(triangles_size) {
<a name="l00230"></a>00230         <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> *triangles_ptr = &amp;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>[0];
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; triangles_size; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00233"></a>00233             <a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html">Triangle</a> t = triangles_ptr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00234"></a>00234 
<a name="l00235"></a>00235             tri_vindex[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(
<a name="l00236"></a>00236                 <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[0] + vert_offset),
<a name="l00237"></a>00237                 <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[1] + vert_offset),
<a name="l00238"></a>00238                 <a class="code" href="../../d9/d90/util__math_8h.html#ac9ce7ae1b5293d954bab7162f36ab478">__int_as_float</a>(t.<a class="code" href="../../d4/d2b/structMesh_1_1Triangle.html#a309eee4f616f16a731b9aed5bbd87fe7">v</a>[2] + vert_offset),
<a name="l00239"></a>00239                 0);
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241     }
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="../../da/d29/structMesh.html#ab400967b9aa142474280169a50b14169">00244</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#ab400967b9aa142474280169a50b14169">Mesh::compute_bvh</a>(<a class="code" href="../../d9/d80/classSceneParams.html">SceneParams</a> *params, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <a class="code" href="../../de/de7/structObject.html">Object</a> object;
<a name="l00247"></a>00247     <span class="keywordtype">object</span>.<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a> = <span class="keyword">this</span>;
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     vector&lt;Object*&gt; objects;
<a name="l00250"></a>00250     objects.push_back(&amp;<span class="keywordtype">object</span>);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="keywordflow">if</span>(<a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a> &amp;&amp; !<a class="code" href="../../da/d29/structMesh.html#a1f0c6f704b564ea340a46fc9dfd7e106">need_update_rebuild</a>) {
<a name="l00253"></a>00253         progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Refitting BVH&quot;</span>);
<a name="l00254"></a>00254         <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>-&gt;<a class="code" href="../../de/de9/classBVH.html#ae199debd1dc22c528aca9175aec4e680">objects</a> = objects;
<a name="l00255"></a>00255         <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>-&gt;<a class="code" href="../../de/de9/classBVH.html#a42649619788d30e3451ad5a9a3e16c8d">refit</a>(progress);
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     <span class="keywordflow">else</span> {
<a name="l00258"></a>00258         progress.<a class="code" href="../../d8/da7/classProgress.html#a57c23faa5b6433d255a4d50891ba5c55">set_substatus</a>(<span class="stringliteral">&quot;Building BVH&quot;</span>);
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a> bparams;
<a name="l00261"></a>00261         bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#ae30cb72a824a5774c82c62bea4cb46f8">use_cache</a> = params-&gt;<a class="code" href="../../d9/d80/classSceneParams.html#a3bc6be957c19e0c869d4dd15c319643d">use_bvh_cache</a>;
<a name="l00262"></a>00262         bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#a496eb122cef31cc965cd6570992daa8b">use_spatial_split</a> = params-&gt;<a class="code" href="../../d9/d80/classSceneParams.html#a6ecdad815bb26683b3d195e4056b2cbc">use_bvh_spatial_split</a>;
<a name="l00263"></a>00263         bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#afeb8f1d8925362247de00e156cd4dd84">use_qbvh</a> = params-&gt;<a class="code" href="../../d9/d80/classSceneParams.html#aac68c910f9799a2d791129469d1d7b70">use_qbvh</a>;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="keyword">delete</span> <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>;
<a name="l00266"></a>00266         <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a> = <a class="code" href="../../de/de9/classBVH.html#a48bf4d666e249f0f107bf3474cbae33a">BVH::create</a>(bparams, objects);
<a name="l00267"></a>00267         <a class="code" href="../../da/d29/structMesh.html#a784ad077c47efe7eaa1103fcd72b5019">bvh</a>-&gt;<a class="code" href="../../de/de9/classBVH.html#a7cab038c6312055ec0855b70758e130d">build</a>(progress);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a><a class="code" href="../../da/d29/structMesh.html#ae334e9bcc6b133d8a5cfebf16e41b5e0">00271</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d29/structMesh.html#ae334e9bcc6b133d8a5cfebf16e41b5e0">Mesh::tag_update</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">bool</span> rebuild)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273     <a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> = <span class="keyword">true</span>;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span>(rebuild) {
<a name="l00276"></a>00276         <a class="code" href="../../da/d29/structMesh.html#a1f0c6f704b564ea340a46fc9dfd7e106">need_update_rebuild</a> = <span class="keyword">true</span>;
<a name="l00277"></a>00277         scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abbbb6b9e88a1e3a7cba60bc806ac6652">light_manager</a>-&gt;<a class="code" href="../../d8/dbd/classLightManager.html#ab9c4542c974577b6c63eb8357d45bbc2">need_update</a> = <span class="keyword">true</span>;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     <span class="keywordflow">else</span> {
<a name="l00280"></a>00280         <span class="keywordflow">foreach</span>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> sindex, <a class="code" href="../../da/d29/structMesh.html#aacb9299857c7521104235ddfde925294">used_shaders</a>)
<a name="l00281"></a>00281             <span class="keywordflow">if</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a73fd646df998091980bf7f3d25a9aa07">shaders</a>[sindex]-&gt;has_surface_emission)
<a name="l00282"></a>00282                 scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abbbb6b9e88a1e3a7cba60bc806ac6652">light_manager</a>-&gt;<a class="code" href="../../d8/dbd/classLightManager.html#ab9c4542c974577b6c63eb8357d45bbc2">need_update</a> = <span class="keyword">true</span>;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae724067d534bb304123b2b89949065b9">mesh_manager</a>-&gt;<a class="code" href="../../db/da4/classMeshManager.html#a2802a16bd10c62661bf690fb25a773be">need_update</a> = <span class="keyword">true</span>;
<a name="l00286"></a>00286     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a78b24e7f9b520dd223f9056fa6cbc86e">object_manager</a>-&gt;<a class="code" href="../../d6/d6f/classObjectManager.html#ab27f4d17c5f72d0339c080528550bfb1">need_update</a> = <span class="keyword">true</span>;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">/* Mesh Manager */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="../../db/da4/classMeshManager.html#a87930269930f1e8496882e810ad76d3c">00291</a> <a class="code" href="../../db/da4/classMeshManager.html#a87930269930f1e8496882e810ad76d3c">MeshManager::MeshManager</a>()
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293     <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00294"></a>00294     <a class="code" href="../../db/da4/classMeshManager.html#a2802a16bd10c62661bf690fb25a773be">need_update</a> = <span class="keyword">true</span>;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a><a class="code" href="../../db/da4/classMeshManager.html#ace7dacf73cefd94a8df4cd14a39985ae">00297</a> <a class="code" href="../../db/da4/classMeshManager.html#ace7dacf73cefd94a8df4cd14a39985ae">MeshManager::~MeshManager</a>()
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <span class="keyword">delete</span> <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a>;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a><a class="code" href="../../db/da4/classMeshManager.html#a20c58ab7d64046ee2bf2347f4d24424c">00302</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#a20c58ab7d64046ee2bf2347f4d24424c">MeshManager::update_osl_attributes</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, vector&lt;AttributeRequestSet&gt;&amp; mesh_attributes)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304 <span class="preprocessor">#ifdef WITH_OSL</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>    <span class="comment">/* for OSL, a hash map is used to lookup the attribute by name. */</span>
<a name="l00306"></a>00306     OSLGlobals *og = (OSLGlobals*)device-&gt;<a class="code" href="../../da/da1/structDevice.html#acd49cd6a044436c7102a60c49b5287d5">osl_memory</a>();
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     og-&gt;object_name_map.clear();
<a name="l00309"></a>00309     og-&gt;attribute_map.clear();
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     og-&gt;attribute_map.resize(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>.size());
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00314"></a>00314         <span class="comment">/* set object name to object index map */</span>
<a name="l00315"></a>00315         <a class="code" href="../../de/de7/structObject.html">Object</a> *<span class="keywordtype">object</span> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00316"></a>00316         og-&gt;object_name_map[<span class="keywordtype">object</span>-&gt;name] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <span class="comment">/* set object attributes */</span>
<a name="l00319"></a>00319         <span class="keywordflow">foreach</span>(ParamValue&amp; attr, object-&gt;<a class="code" href="../../de/de7/structObject.html#a6a9ec6af627a50592454fd5a556e7c01">attributes</a>) {
<a name="l00320"></a>00320             <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#aaf3e3181e030bede0126b025e5fe3e17">OSLGlobals::Attribute</a> osl_attr;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322             osl_attr.<a class="code" href="../../d7/d7e/structCamera.html#abd4c2c91f9398b35caaa737a7bc6da3b">type</a> = attr.type();
<a name="l00323"></a>00323             osl_attr.elem = <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00ba1b2a815fba46fcce75cc1c0059c342c8">ATTR_ELEMENT_VALUE</a>;
<a name="l00324"></a>00324             osl_attr.value = attr;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326             og-&gt;attribute_map[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][attr.name()] = osl_attr;
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="comment">/* find mesh attributes */</span>
<a name="l00330"></a>00330         <span class="keywordtype">size_t</span> j;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="keywordflow">for</span>(j = 0; j &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size(); j++)
<a name="l00333"></a>00333             <span class="keywordflow">if</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>[j] == object-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>)
<a name="l00334"></a>00334                 <span class="keywordflow">break</span>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336         <a class="code" href="../../d8/dcd/classAttributeRequestSet.html">AttributeRequestSet</a>&amp; attributes = mesh_attributes[j];
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="comment">/* set object attributes */</span>
<a name="l00339"></a>00339         <span class="keywordflow">foreach</span>(<a class="code" href="../../d5/d57/classAttributeRequest.html">AttributeRequest</a>&amp; req, attributes.<a class="code" href="../../d8/dcd/classAttributeRequestSet.html#a341d937b81509da412fa8622a65e5ec2">requests</a>) {
<a name="l00340"></a>00340             <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#aaf3e3181e030bede0126b025e5fe3e17">OSLGlobals::Attribute</a> osl_attr;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342             osl_attr.elem = req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a>;
<a name="l00343"></a>00343             osl_attr.offset = req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345             <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#aad2f7dbf078147e5be2b21be18db11f6">type</a> == TypeDesc::TypeFloat)
<a name="l00346"></a>00346                 osl_attr.type = TypeDesc::TypeFloat;
<a name="l00347"></a>00347             <span class="keywordflow">else</span>
<a name="l00348"></a>00348                 osl_attr.type = TypeDesc::TypeColor;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350             <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a382e7b4c090e34a1825dd701e685e31f">std</a> != <a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a81a8991367af97be19ddfbfa59cbbe4b">Attribute::STD_NONE</a>) {
<a name="l00351"></a>00351                 <span class="comment">/* if standard attribute, add lookup by std:: name convention */</span>
<a name="l00352"></a>00352                 ustring stdname = ustring(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;std::&quot;</span>) + <a class="code" href="../../de/d9d/classAttribute.html#a413b5504d312752d8ad5fa1f60ea0b57">Attribute::standard_name</a>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a382e7b4c090e34a1825dd701e685e31f">std</a>).c_str());
<a name="l00353"></a>00353                 og-&gt;attribute_map[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][stdname] = osl_attr;
<a name="l00354"></a>00354             }
<a name="l00355"></a>00355             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#adf3ceef7c839d90c69f6c39466fed936">name</a> != ustring()) {
<a name="l00356"></a>00356                 <span class="comment">/* add lookup by mesh attribute name */</span>
<a name="l00357"></a>00357                 og-&gt;attribute_map[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][req.<a class="code" href="../../d5/d57/classAttributeRequest.html#adf3ceef7c839d90c69f6c39466fed936">name</a>] = osl_attr;
<a name="l00358"></a>00358             }
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361 <span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>}
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="../../db/da4/classMeshManager.html#ab17d4a5639ef65055c2f979ecddac02d">00364</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#ab17d4a5639ef65055c2f979ecddac02d">MeshManager::update_svm_attributes</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, vector&lt;AttributeRequestSet&gt;&amp; mesh_attributes)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="comment">/* for SVM, the attributes_map table is used to lookup the offset of an</span>
<a name="l00367"></a>00367 <span class="comment">     * attribute, based on a unique shader attribute id. */</span>
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="comment">/* compute array stride */</span>
<a name="l00370"></a>00370     <span class="keywordtype">int</span> attr_map_stride = 0;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00373"></a>00373         attr_map_stride = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>(attr_map_stride, mesh_attributes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>());
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">if</span>(attr_map_stride == 0)
<a name="l00376"></a>00376         <span class="keywordflow">return</span>;
<a name="l00377"></a>00377     
<a name="l00378"></a>00378     <span class="comment">/* create attribute map */</span>
<a name="l00379"></a>00379     <a class="code" href="../../da/d09/structuint4.html">uint4</a> *attr_map = dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a588ef209bc3f7718fb36ca1ba06efb5b">attributes_map</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a275d21478206cb19c6b55441892f9ba8">resize</a>(attr_map_stride*scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>.size());
<a name="l00380"></a>00380     memset(attr_map, 0, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a588ef209bc3f7718fb36ca1ba06efb5b">attributes_map</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a338470e5181d2d9bc374679fd88a1275">size</a>()*<span class="keyword">sizeof</span>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#ad46b2ebcd4c426b06cda147ddc1001e7">uint</a>));
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00383"></a>00383         <a class="code" href="../../de/de7/structObject.html">Object</a> *<span class="keywordtype">object</span> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">/* find mesh attributes */</span>
<a name="l00386"></a>00386         <span class="keywordtype">size_t</span> j;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="keywordflow">for</span>(j = 0; j &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size(); j++)
<a name="l00389"></a>00389             <span class="keywordflow">if</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>[j] == object-&gt;<a class="code" href="../../de/de7/structObject.html#ad755772f4633cd0ef94a05738ffb5e84">mesh</a>)
<a name="l00390"></a>00390                 <span class="keywordflow">break</span>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <a class="code" href="../../d8/dcd/classAttributeRequestSet.html">AttributeRequestSet</a>&amp; attributes = mesh_attributes[j];
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="comment">/* set object attributes */</span>
<a name="l00395"></a>00395         j = 0;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">foreach</span>(<a class="code" href="../../d5/d57/classAttributeRequest.html">AttributeRequest</a>&amp; req, attributes.<a class="code" href="../../d8/dcd/classAttributeRequestSet.html#a341d937b81509da412fa8622a65e5ec2">requests</a>) {
<a name="l00398"></a>00398             <span class="keywordtype">int</span> index = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*attr_map_stride + j;
<a name="l00399"></a>00399             <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> id;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401             <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a382e7b4c090e34a1825dd701e685e31f">std</a> == <a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a81a8991367af97be19ddfbfa59cbbe4b">Attribute::STD_NONE</a>)
<a name="l00402"></a>00402                 <span class="keywordtype">id</span> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a9b9f9b773599a3854705c15816d61fba">shader_manager</a>-&gt;<a class="code" href="../../dc/d18/classShaderManager.html#a41a7642dac82b90d5cc17fc77bbda30e">get_attribute_id</a>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#adf3ceef7c839d90c69f6c39466fed936">name</a>);
<a name="l00403"></a>00403             <span class="keywordflow">else</span>
<a name="l00404"></a>00404                 <span class="keywordtype">id</span> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a9b9f9b773599a3854705c15816d61fba">shader_manager</a>-&gt;<a class="code" href="../../dc/d18/classShaderManager.html#a41a7642dac82b90d5cc17fc77bbda30e">get_attribute_id</a>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a382e7b4c090e34a1825dd701e685e31f">std</a>);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406             attr_map[index].<a class="code" href="../../da/d09/structuint4.html#a1eaef42c15f1cce507424651b135aa35">x</a> = id;
<a name="l00407"></a>00407             attr_map[index].<a class="code" href="../../da/d09/structuint4.html#a46d6aabe879f6a70a68535bdb89c0f0a">y</a> = req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a>;
<a name="l00408"></a>00408             attr_map[index].<a class="code" href="../../da/d09/structuint4.html#acc37cf324e31e1b504e3b5e8bb5560e5">z</a> = req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410             <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#aad2f7dbf078147e5be2b21be18db11f6">type</a> == TypeDesc::TypeFloat)
<a name="l00411"></a>00411                 attr_map[index].<a class="code" href="../../da/d09/structuint4.html#aed60a1ceeffe013097fff51a6292eebc">w</a> = <a class="code" href="../../de/df0/svm__types_8h.html#aeb62efcd71fcd03659ccb0bb1860f4f5a3a0713122c7fd67713a563ed7ea043b7">NODE_ATTR_FLOAT</a>;
<a name="l00412"></a>00412             <span class="keywordflow">else</span>
<a name="l00413"></a>00413                 attr_map[index].<a class="code" href="../../da/d09/structuint4.html#aed60a1ceeffe013097fff51a6292eebc">w</a> = <a class="code" href="../../de/df0/svm__types_8h.html#aeb62efcd71fcd03659ccb0bb1860f4f5a97e49472bfa1ac51d74b156b51fd9a8b">NODE_ATTR_FLOAT3</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             j++;
<a name="l00416"></a>00416         }
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">/* copy to device */</span>
<a name="l00420"></a>00420     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ae618c7fdec7d935d9b466de62b8483bf">data</a>.<a class="code" href="../../d3/d17/structKernelData.html#af7407b8cef2f6a09a68990ad326d0a04">bvh</a>.<a class="code" href="../../db/dfc/structKernelBVH.html#a6d76093674d8c9d00d7511f66ebdb49a">attributes_map_stride</a> = attr_map_stride;
<a name="l00421"></a>00421     device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__attributes_map&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a588ef209bc3f7718fb36ca1ba06efb5b">attributes_map</a>);
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a><a class="code" href="../../db/da4/classMeshManager.html#ab3770612f3318f4ebdb2d5ee52b33d65">00424</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#ab3770612f3318f4ebdb2d5ee52b33d65">MeshManager::device_update_attributes</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Mesh&quot;</span>, <span class="stringliteral">&quot;Computing attributes&quot;</span>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="comment">/* gather per mesh requested attributes. as meshes may have multiple</span>
<a name="l00429"></a>00429 <span class="comment">     * shaders assigned, this merges the requested attributes that have</span>
<a name="l00430"></a>00430 <span class="comment">     * been set per shader by the shader manager */</span>
<a name="l00431"></a>00431     vector&lt;AttributeRequestSet&gt; mesh_attributes(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size());
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00434"></a>00434         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">foreach</span>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> sindex, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#aacb9299857c7521104235ddfde925294">used_shaders</a>) {
<a name="l00437"></a>00437             <a class="code" href="../../d9/d69/classShader.html">Shader</a> *shader = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a73fd646df998091980bf7f3d25a9aa07">shaders</a>[sindex];
<a name="l00438"></a>00438             mesh_attributes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].add(shader-&gt;<a class="code" href="../../d9/d69/classShader.html#abdf32fb6f28e2f6794acd73b3da681d5">attributes</a>);
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">/* mesh attribute are stored in a single array per data type. here we fill</span>
<a name="l00443"></a>00443 <span class="comment">     * those arrays, and set the offset and element type to create attribute</span>
<a name="l00444"></a>00444 <span class="comment">     * maps next */</span>
<a name="l00445"></a>00445     vector&lt;float&gt; attr_float;
<a name="l00446"></a>00446     vector&lt;float4&gt; attr_float3;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00449"></a>00449         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00450"></a>00450         <a class="code" href="../../d8/dcd/classAttributeRequestSet.html">AttributeRequestSet</a>&amp; attributes = mesh_attributes[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <span class="comment">/* todo: we now store std and name attributes from requests even if</span>
<a name="l00453"></a>00453 <span class="comment">           they actually refer to the same mesh attributes, optimize */</span>
<a name="l00454"></a>00454         <span class="keywordflow">foreach</span>(<a class="code" href="../../d5/d57/classAttributeRequest.html">AttributeRequest</a>&amp; req, attributes.<a class="code" href="../../d8/dcd/classAttributeRequestSet.html#a341d937b81509da412fa8622a65e5ec2">requests</a>) {
<a name="l00455"></a>00455             <a class="code" href="../../de/d9d/classAttribute.html">Attribute</a> *mattr = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#a47b390949dc3e3c1df16d2407b306f79">find</a>(req);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457             <span class="comment">/* todo: get rid of this exception */</span>
<a name="l00458"></a>00458             <span class="keywordflow">if</span>(!mattr &amp;&amp; req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a382e7b4c090e34a1825dd701e685e31f">std</a> == <a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a4ebcf92fb5535ae4aa459a72e74450d1">Attribute::STD_GENERATED</a>) {
<a name="l00459"></a>00459                 mattr = mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ab623287f5b19c2cd9962ba04980ce99f">attributes</a>.<a class="code" href="../../db/db7/classAttributeSet.html#ae4c625a3f1c42c43d71d3abcc2b9fc3d">add</a>(<a class="code" href="../../de/d9d/classAttribute.html#afd388ea45f5b26b5bffa07d0b55180d6a4ebcf92fb5535ae4aa459a72e74450d1">Attribute::STD_GENERATED</a>);
<a name="l00460"></a>00460                 <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size())
<a name="l00461"></a>00461                     memcpy(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>(), &amp;mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>[0], <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d19/structfloat3.html">float3</a>)*mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size());
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464             <span class="comment">/* attribute not found */</span>
<a name="l00465"></a>00465             <span class="keywordflow">if</span>(!mattr) {
<a name="l00466"></a>00466                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a> = <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00ba161157b8a25bcc2e15c9481dbb9c19a9">ATTR_ELEMENT_NONE</a>;
<a name="l00467"></a>00467                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> = 0;
<a name="l00468"></a>00468                 <span class="keywordflow">continue</span>;
<a name="l00469"></a>00469             }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471             <span class="comment">/* we abuse AttributeRequest to pass on info like element and</span>
<a name="l00472"></a>00472 <span class="comment">               offset, it doesn&#39;t really make sense but is convenient */</span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474             <span class="comment">/* store element and type */</span>
<a name="l00475"></a>00475             <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a5bb4838663ba53611726acb587044ad1">element</a> == <a class="code" href="../../de/d9d/classAttribute.html#a9caaa6fba716408ab8e5617565dbe5f3ab84dd18ead4e89b0bc02e386974f0be7">Attribute::VERTEX</a>)
<a name="l00476"></a>00476                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a> = <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00ba9481878f51916108d37a109ffadd5512">ATTR_ELEMENT_VERTEX</a>;
<a name="l00477"></a>00477             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a5bb4838663ba53611726acb587044ad1">element</a> == <a class="code" href="../../de/d9d/classAttribute.html#a9caaa6fba716408ab8e5617565dbe5f3a517345d60ccbadbb7cd1b7c99754d70f">Attribute::FACE</a>)
<a name="l00478"></a>00478                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a> = <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00bad37d589c8f2c51098d0c665f51421013">ATTR_ELEMENT_FACE</a>;
<a name="l00479"></a>00479             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a5bb4838663ba53611726acb587044ad1">element</a> == <a class="code" href="../../de/d9d/classAttribute.html#a9caaa6fba716408ab8e5617565dbe5f3a2f8483acc8a097cb1cd9af2318cf2a0f">Attribute::CORNER</a>)
<a name="l00480"></a>00480                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a> = <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00ba6b51105bd20a418ec78282021543beef">ATTR_ELEMENT_CORNER</a>;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482             req.<a class="code" href="../../d5/d57/classAttributeRequest.html#aad2f7dbf078147e5be2b21be18db11f6">type</a> = mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a7068061dcae4868169315e474db971e2">type</a>;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484             <span class="comment">/* store attribute data in arrays */</span>
<a name="l00485"></a>00485             <span class="keywordtype">size_t</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a80dbda6be6e9ee81b6e43234bddc3aad">element_size</a>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size(), mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size());
<a name="l00486"></a>00486 
<a name="l00487"></a>00487             <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a7068061dcae4868169315e474db971e2">type</a> == TypeDesc::TypeFloat) {
<a name="l00488"></a>00488                 <span class="keywordtype">float</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a4e2e54cf3698339c517ce8e75ce87d9f">data_float</a>();
<a name="l00489"></a>00489                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> = attr_float.size();
<a name="l00490"></a>00490 
<a name="l00491"></a>00491                 <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> k = 0; k &lt; <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; k++)
<a name="l00492"></a>00492                     attr_float.push_back(data[k]);
<a name="l00493"></a>00493             }
<a name="l00494"></a>00494             <span class="keywordflow">else</span> {
<a name="l00495"></a>00495                 <a class="code" href="../../d9/d19/structfloat3.html">float3</a> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#aec67bc7e28824eeea0ab22dab30add28">data_float3</a>();
<a name="l00496"></a>00496                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> = attr_float3.size();
<a name="l00497"></a>00497 
<a name="l00498"></a>00498                 <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> k = 0; k &lt; <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; k++) {
<a name="l00499"></a>00499                     <a class="code" href="../../d9/d19/structfloat3.html">float3</a> f3 = data[k];
<a name="l00500"></a>00500                     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> f4 = <a class="code" href="../../d7/dad/util__types_8h.html#ad9525818d6a0cc831304da5a7a33a519">make_float4</a>(f3.<a class="code" href="../../d9/d19/structfloat3.html#af621f02abb1c788738fe61ea9807ff9c">x</a>, f3.<a class="code" href="../../d9/d19/structfloat3.html#aa6147d421a81889971f8c66aa92abf0d">y</a>, f3.<a class="code" href="../../d9/d19/structfloat3.html#a772dffd42d89f350c5a1b766c4703245">z</a>, 0.0f);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502                     attr_float3.push_back(f4);
<a name="l00503"></a>00503                 }
<a name="l00504"></a>00504             }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506             <span class="comment">/* mesh vertex/triangle index is global, not per object, so we sneak</span>
<a name="l00507"></a>00507 <span class="comment">               a correction for that in here */</span>
<a name="l00508"></a>00508             <span class="keywordflow">if</span>(req.<a class="code" href="../../d5/d57/classAttributeRequest.html#ab778c7ea5bb4eac408e137d173c7ebf2">element</a> == <a class="code" href="../../d4/d05/kernel__types_8h.html#aa4d02792048211391c0e1343a5aef00ba9481878f51916108d37a109ffadd5512">ATTR_ELEMENT_VERTEX</a>)
<a name="l00509"></a>00509                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> -= mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a>;
<a name="l00510"></a>00510             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a5bb4838663ba53611726acb587044ad1">element</a> == <a class="code" href="../../de/d9d/classAttribute.html#a9caaa6fba716408ab8e5617565dbe5f3a517345d60ccbadbb7cd1b7c99754d70f">Attribute::FACE</a>)
<a name="l00511"></a>00511                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> -= mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>;
<a name="l00512"></a>00512             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(mattr-&gt;<a class="code" href="../../de/d9d/classAttribute.html#a5bb4838663ba53611726acb587044ad1">element</a> == <a class="code" href="../../de/d9d/classAttribute.html#a9caaa6fba716408ab8e5617565dbe5f3a2f8483acc8a097cb1cd9af2318cf2a0f">Attribute::CORNER</a>)
<a name="l00513"></a>00513                 req.<a class="code" href="../../d5/d57/classAttributeRequest.html#a1a55741a0921686bcbdee380891c1a75">offset</a> -= 3*mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515             <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     <span class="comment">/* create attribute lookup maps */</span>
<a name="l00520"></a>00520     <span class="keywordflow">if</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a4a8bf1fa448a8f24fb1662f976101909">params</a>.<a class="code" href="../../d9/d80/classSceneParams.html#a31e359a6370ccdc9f12ac21f460d154e">shadingsystem</a> == <a class="code" href="../../d9/d80/classSceneParams.html#a795e7c8c2b14ba5085816b9e2ee6517ca797903f7d6195067772efb961a00aea6">SceneParams::OSL</a>)
<a name="l00521"></a>00521         <a class="code" href="../../db/da4/classMeshManager.html#a20c58ab7d64046ee2bf2347f4d24424c">update_osl_attributes</a>(device, scene, mesh_attributes);
<a name="l00522"></a>00522     <span class="keywordflow">else</span>
<a name="l00523"></a>00523         <a class="code" href="../../db/da4/classMeshManager.html#ab17d4a5639ef65055c2f979ecddac02d">update_svm_attributes</a>(device, dscene, scene, mesh_attributes);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="comment">/* copy to device */</span>
<a name="l00528"></a>00528     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Mesh&quot;</span>, <span class="stringliteral">&quot;Copying Attributes to device&quot;</span>);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">if</span>(attr_float.size()) {
<a name="l00531"></a>00531         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aca4ed1d25b361c8644fefe76bf7c4a6e">attributes_float</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a2613de8cfa6d9b53e4ec476b3a76944b">copy</a>(&amp;attr_float[0], attr_float.size());
<a name="l00532"></a>00532         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__attributes_float&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aca4ed1d25b361c8644fefe76bf7c4a6e">attributes_float</a>);
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     <span class="keywordflow">if</span>(attr_float3.size()) {
<a name="l00535"></a>00535         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aedfdeda6425faa841989df70d954e539">attributes_float3</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a2613de8cfa6d9b53e4ec476b3a76944b">copy</a>(&amp;attr_float3[0], attr_float3.size());
<a name="l00536"></a>00536         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__attributes_float3&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aedfdeda6425faa841989df70d954e539">attributes_float3</a>);
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="../../db/da4/classMeshManager.html#a1fccc5e676ec1b67dadbdcb63092236c">00540</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#a1fccc5e676ec1b67dadbdcb63092236c">MeshManager::device_update_mesh</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="comment">/* count and update offsets */</span>
<a name="l00543"></a>00543     <span class="keywordtype">size_t</span> vert_size = 0;
<a name="l00544"></a>00544     <span class="keywordtype">size_t</span> tri_size = 0;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>) {
<a name="l00547"></a>00547         mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a> = vert_size;
<a name="l00548"></a>00548         mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a> = tri_size;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550         vert_size += mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a970aeed1a5d2b4a0064ba17b126cfd8c">verts</a>.size();
<a name="l00551"></a>00551         tri_size += mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a2b30e4823d6d0d17c115018065bd1e91">triangles</a>.size();
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="keywordflow">if</span>(tri_size == 0)
<a name="l00555"></a>00555         <span class="keywordflow">return</span>;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557     <span class="comment">/* normals */</span>
<a name="l00558"></a>00558     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Mesh&quot;</span>, <span class="stringliteral">&quot;Computing normals&quot;</span>);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *normal = dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a89b344720433845cdaed5271d19e45bd">tri_normal</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a275d21478206cb19c6b55441892f9ba8">resize</a>(tri_size);
<a name="l00561"></a>00561     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *<a class="code" href="../../df/dae/BKE__mball_8h.html#aec2d752753646f357110ad531816727d">vnormal</a> = dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0eb9b80a95d9e4135bacf9b1b6295e45">tri_vnormal</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a275d21478206cb19c6b55441892f9ba8">resize</a>(vert_size);
<a name="l00562"></a>00562     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *tri_verts = dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a45700f137b80c938281a9f2e1fe78abb">tri_verts</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a275d21478206cb19c6b55441892f9ba8">resize</a>(vert_size);
<a name="l00563"></a>00563     <a class="code" href="../../dd/d9d/structfloat4.html">float4</a> *tri_vindex = dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ad1640fd77bf4645d4f4e5526f8646f8b">tri_vindex</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a275d21478206cb19c6b55441892f9ba8">resize</a>(tri_size);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>) {
<a name="l00566"></a>00566         mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a08336faf042be360bb51708dba77ea12">pack_normals</a>(scene, &amp;normal[mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>], &amp;vnormal[mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a>]);
<a name="l00567"></a>00567         mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a545dabcffebe7c6fa0c457a906a2e256">pack_verts</a>(&amp;tri_verts[mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a>], &amp;tri_vindex[mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a34ff5afdde9317660f592704a81f76c9">tri_offset</a>], mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a3d5bf036b8395b6f761f6ce2fa0ada6e">vert_offset</a>);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <span class="comment">/* vertex coordinates */</span>
<a name="l00573"></a>00573     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Mesh&quot;</span>, <span class="stringliteral">&quot;Copying Mesh to device&quot;</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__tri_normal&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a89b344720433845cdaed5271d19e45bd">tri_normal</a>);
<a name="l00576"></a>00576     device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__tri_vnormal&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0eb9b80a95d9e4135bacf9b1b6295e45">tri_vnormal</a>);
<a name="l00577"></a>00577     device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__tri_verts&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a45700f137b80c938281a9f2e1fe78abb">tri_verts</a>);
<a name="l00578"></a>00578     device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__tri_vindex&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ad1640fd77bf4645d4f4e5526f8646f8b">tri_vindex</a>);
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00581"></a><a class="code" href="../../db/da4/classMeshManager.html#afe822f62904f40326666e6ea66b535bc">00581</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#afe822f62904f40326666e6ea66b535bc">MeshManager::device_update_bvh</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00582"></a>00582 {
<a name="l00583"></a>00583     <span class="comment">/* bvh build */</span>
<a name="l00584"></a>00584     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Scene BVH&quot;</span>, <span class="stringliteral">&quot;Building&quot;</span>);
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <a class="code" href="../../d2/d2f/classBVHParams.html">BVHParams</a> bparams;
<a name="l00587"></a>00587     bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#aa4e6c9a60f45df41f40dc130f43b5278">top_level</a> = <span class="keyword">true</span>;
<a name="l00588"></a>00588     bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#afeb8f1d8925362247de00e156cd4dd84">use_qbvh</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a4a8bf1fa448a8f24fb1662f976101909">params</a>.<a class="code" href="../../d9/d80/classSceneParams.html#aac68c910f9799a2d791129469d1d7b70">use_qbvh</a>;
<a name="l00589"></a>00589     bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#a496eb122cef31cc965cd6570992daa8b">use_spatial_split</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a4a8bf1fa448a8f24fb1662f976101909">params</a>.<a class="code" href="../../d9/d80/classSceneParams.html#a6ecdad815bb26683b3d195e4056b2cbc">use_bvh_spatial_split</a>;
<a name="l00590"></a>00590     bparams.<a class="code" href="../../d2/d2f/classBVHParams.html#ae30cb72a824a5774c82c62bea4cb46f8">use_cache</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a4a8bf1fa448a8f24fb1662f976101909">params</a>.<a class="code" href="../../d9/d80/classSceneParams.html#a3bc6be957c19e0c869d4dd15c319643d">use_bvh_cache</a>;
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keyword">delete</span> <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a>;
<a name="l00593"></a>00593     <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a> = <a class="code" href="../../de/de9/classBVH.html#a48bf4d666e249f0f107bf3474cbae33a">BVH::create</a>(bparams, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>);
<a name="l00594"></a>00594     <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a>-&gt;<a class="code" href="../../de/de9/classBVH.html#a7cab038c6312055ec0855b70758e130d">build</a>(progress);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="comment">/* copy to device */</span>
<a name="l00599"></a>00599     progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(<span class="stringliteral">&quot;Updating Scene BVH&quot;</span>, <span class="stringliteral">&quot;Copying BVH to device&quot;</span>);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     <a class="code" href="../../de/d0d/structPackedBVH.html">PackedBVH</a>&amp; pack = <a class="code" href="../../db/da4/classMeshManager.html#a94c3eef2acd80d8c4254e6912974e47e">bvh</a>-&gt;<a class="code" href="../../de/de9/classBVH.html#a65205d94d4e9ec72616df4dcfcbd8453">pack</a>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00604"></a>00604         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0a79969d6824d29eae159b39acce8284">bvh_nodes</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>((<a class="code" href="../../dd/d9d/structfloat4.html">float4</a>*)&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a6f81673a27a5d60b8a8c5184de565002">nodes</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00605"></a>00605         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__bvh_nodes&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0a79969d6824d29eae159b39acce8284">bvh_nodes</a>);
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00608"></a>00608         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a921b49600c59d2a0aae898fd0bb36bd0">object_node</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>((<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>*)&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#afea6eefd0cf97e4c4eafe6f3948850c7">object_node</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00609"></a>00609         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__object_node&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a921b49600c59d2a0aae898fd0bb36bd0">object_node</a>);
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00612"></a>00612         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a539ede37902f4b27499d6dcdeff7fa93">tri_woop</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>(&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a03664b13bffd0884698d7ec4f55ac30d">tri_woop</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00613"></a>00613         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__tri_woop&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a539ede37902f4b27499d6dcdeff7fa93">tri_woop</a>);
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00616"></a>00616         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a26ffea9b73bc87b2ed1ccb546d851cb3">prim_visibility</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>((<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>*)&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a8f2ebc3a422647e2e6a3e23a56f84189">prim_visibility</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00617"></a>00617         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__prim_visibility&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a26ffea9b73bc87b2ed1ccb546d851cb3">prim_visibility</a>);
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00620"></a>00620         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a4931bed89a83aaba8308f4a1b3c09fe9">prim_index</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>((<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>*)&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#a2034647abb8db604bcefae9fbca12b38">prim_index</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00621"></a>00621         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__prim_index&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a4931bed89a83aaba8308f4a1b3c09fe9">prim_index</a>);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623     <span class="keywordflow">if</span>(pack.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>()) {
<a name="l00624"></a>00624         dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a48f199a98b72579a2fc32920f9d9263f">prim_object</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#aa4c2bab31a3d525e8528d007f788488e">reference</a>((<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>*)&amp;pack.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>[0], pack.<a class="code" href="../../de/d0d/structPackedBVH.html#af3cd5b46fa79244964c913685af3c326">prim_object</a>.<a class="code" href="../../d2/d41/classarray.html#a0ef7bb1d23e7c7aed6feb0397652626d">size</a>());
<a name="l00625"></a>00625         device-&gt;<a class="code" href="../../da/da1/structDevice.html#aad6e67caa123846e3c63a5d602528228">tex_alloc</a>(<span class="stringliteral">&quot;__prim_object&quot;</span>, dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a48f199a98b72579a2fc32920f9d9263f">prim_object</a>);
<a name="l00626"></a>00626     }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ae618c7fdec7d935d9b466de62b8483bf">data</a>.<a class="code" href="../../d3/d17/structKernelData.html#af7407b8cef2f6a09a68990ad326d0a04">bvh</a>.<a class="code" href="../../db/dfc/structKernelBVH.html#a4b76c40a35ff701b430e5b5d44f617ba">root</a> = pack.<a class="code" href="../../de/d0d/structPackedBVH.html#afc8883f1bede1dfaffdfaebf03c1e800">root_index</a>;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a><a class="code" href="../../db/da4/classMeshManager.html#adb670140a07a56642c311e21453a1350">00631</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#adb670140a07a56642c311e21453a1350">MeshManager::device_update</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/da7/classProgress.html">Progress</a>&amp; progress)
<a name="l00632"></a>00632 {
<a name="l00633"></a>00633     <span class="keywordflow">if</span>(!<a class="code" href="../../db/da4/classMeshManager.html#a2802a16bd10c62661bf690fb25a773be">need_update</a>)
<a name="l00634"></a>00634         <span class="keywordflow">return</span>;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="comment">/* update normals */</span>
<a name="l00637"></a>00637     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>) {
<a name="l00638"></a>00638         <span class="keywordflow">foreach</span>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a> shader, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#aacb9299857c7521104235ddfde925294">used_shaders</a>)
<a name="l00639"></a>00639             <span class="keywordflow">if</span>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a73fd646df998091980bf7f3d25a9aa07">shaders</a>[shader]-&gt;need_update_attributes)
<a name="l00640"></a>00640                 mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> = <span class="keyword">true</span>;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642         <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a>) {
<a name="l00643"></a>00643             mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#af166e566e1c399a3e2b2e08e4f84de89">add_face_normals</a>();
<a name="l00644"></a>00644             mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a5178916266e0d01a55b44d4a538a2ecd">add_vertex_normals</a>();
<a name="l00645"></a>00645 
<a name="l00646"></a>00646             <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <span class="comment">/* device update */</span>
<a name="l00651"></a>00651     <a class="code" href="../../db/da4/classMeshManager.html#a8c6bfee7c68b20d5bfafb42dc360d930">device_free</a>(device, dscene);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <a class="code" href="../../db/da4/classMeshManager.html#a1fccc5e676ec1b67dadbdcb63092236c">device_update_mesh</a>(device, dscene, scene, progress);
<a name="l00654"></a>00654     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <a class="code" href="../../db/da4/classMeshManager.html#ab3770612f3318f4ebdb2d5ee52b33d65">device_update_attributes</a>(device, dscene, scene, progress);
<a name="l00657"></a>00657     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="comment">/* update displacement */</span>
<a name="l00660"></a>00660     <span class="keywordtype">bool</span> displacement_done = <span class="keyword">false</span>;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>)
<a name="l00663"></a>00663         <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> &amp;&amp; <a class="code" href="../../db/da4/classMeshManager.html#a488972740eab6fd3ea8608fae628e981">displace</a>(device, scene, mesh, progress))
<a name="l00664"></a>00664             displacement_done = <span class="keyword">true</span>;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="comment">/* todo: properly handle cancel halfway displacement */</span>
<a name="l00667"></a>00667     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="comment">/* device re-update after displacement */</span>
<a name="l00670"></a>00670     <span class="keywordflow">if</span>(displacement_done) {
<a name="l00671"></a>00671         <a class="code" href="../../db/da4/classMeshManager.html#a8c6bfee7c68b20d5bfafb42dc360d930">device_free</a>(device, dscene);
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         <a class="code" href="../../db/da4/classMeshManager.html#a1fccc5e676ec1b67dadbdcb63092236c">device_update_mesh</a>(device, dscene, scene, progress);
<a name="l00674"></a>00674         <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         <a class="code" href="../../db/da4/classMeshManager.html#ab3770612f3318f4ebdb2d5ee52b33d65">device_update_attributes</a>(device, dscene, scene, progress);
<a name="l00677"></a>00677         <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     <span class="comment">/* update bvh */</span>
<a name="l00681"></a>00681     <span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, num_instance_bvh = 0;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>)
<a name="l00684"></a>00684         <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> &amp;&amp; !mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>)
<a name="l00685"></a>00685             num_instance_bvh++;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <span class="keywordflow">foreach</span>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#adc6d149de421e262c999dd6734c5151b">meshes</a>) {
<a name="l00688"></a>00688         <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a>) {
<a name="l00689"></a>00689             mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a1bd48298143b511667f21f3b810a43cc">compute_bounds</a>();
<a name="l00690"></a>00690 
<a name="l00691"></a>00691             <span class="keywordflow">if</span>(!mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a5b74bdac20c3ccd4ed35f4814442caec">transform_applied</a>) {
<a name="l00692"></a>00692                 <span class="keywordtype">string</span> msg = <span class="stringliteral">&quot;Updating Mesh BVH &quot;</span>;
<a name="l00693"></a>00693                 <span class="keywordflow">if</span>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ace5911118ffad8c5940f42219d21b647">name</a> == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00694"></a>00694                     msg += <a class="code" href="../../df/d14/util__string_8cpp.html#a9975215953965d1131e6dccd370e4351">string_printf</a>(<span class="stringliteral">&quot;%u/%u&quot;</span>, (<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>)(i+1), (<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a91ad9478d81a7aaf2593e8d9c3d06a14">uint</a>)num_instance_bvh);
<a name="l00695"></a>00695                 <span class="keywordflow">else</span>
<a name="l00696"></a>00696                     msg += <a class="code" href="../../df/d14/util__string_8cpp.html#a9975215953965d1131e6dccd370e4351">string_printf</a>(<span class="stringliteral">&quot;%s %u/%u&quot;</span>, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ace5911118ffad8c5940f42219d21b647">name</a>.c_str(), (<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#ad46b2ebcd4c426b06cda147ddc1001e7">uint</a>)(i+1), (<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#ad46b2ebcd4c426b06cda147ddc1001e7">uint</a>)num_instance_bvh);
<a name="l00697"></a>00697                 progress.<a class="code" href="../../d8/da7/classProgress.html#a7ba3f5bca3cbb8acd28275747285bf8b">set_status</a>(msg, <span class="stringliteral">&quot;Building BVH&quot;</span>);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699                 mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ab400967b9aa142474280169a50b14169">compute_bvh</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a4a8bf1fa448a8f24fb1662f976101909">params</a>, progress);
<a name="l00700"></a>00700             }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702             <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704             mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae0e24aad0bc33e4ae0db3dc8e1877047">need_update</a> = <span class="keyword">false</span>;
<a name="l00705"></a>00705             mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a1f0c6f704b564ea340a46fc9dfd7e106">need_update_rebuild</a> = <span class="keyword">false</span>;
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         i++;
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     
<a name="l00711"></a>00711     <span class="keywordflow">foreach</span>(<a class="code" href="../../d9/d69/classShader.html">Shader</a> *shader, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a73fd646df998091980bf7f3d25a9aa07">shaders</a>)
<a name="l00712"></a>00712         shader-&gt;<a class="code" href="../../d9/d69/classShader.html#adbd5f6ec6bf6c3d67300527619773ba2">need_update_attributes</a> = <span class="keyword">false</span>;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <span class="keywordflow">foreach</span>(<a class="code" href="../../de/de7/structObject.html">Object</a> *<span class="keywordtype">object</span>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ae8e53f973297c858c89fcec9d93ac174">objects</a>)
<a name="l00715"></a>00715         <span class="keywordtype">object</span>-&gt;compute_bounds();
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">if</span>(progress.<a class="code" href="../../d8/da7/classProgress.html#a48f1435962a9a4448f7d2f32996e0f61">get_cancel</a>()) <span class="keywordflow">return</span>;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719     <a class="code" href="../../db/da4/classMeshManager.html#afe822f62904f40326666e6ea66b535bc">device_update_bvh</a>(device, dscene, scene, progress);
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <a class="code" href="../../db/da4/classMeshManager.html#a2802a16bd10c62661bf690fb25a773be">need_update</a> = <span class="keyword">false</span>;
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a><a class="code" href="../../db/da4/classMeshManager.html#a8c6bfee7c68b20d5bfafb42dc360d930">00724</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#a8c6bfee7c68b20d5bfafb42dc360d930">MeshManager::device_free</a>(<a class="code" href="../../da/da1/structDevice.html">Device</a> *device, <a class="code" href="../../db/d5b/classDeviceScene.html">DeviceScene</a> *dscene)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0a79969d6824d29eae159b39acce8284">bvh_nodes</a>);
<a name="l00727"></a>00727     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a921b49600c59d2a0aae898fd0bb36bd0">object_node</a>);
<a name="l00728"></a>00728     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a539ede37902f4b27499d6dcdeff7fa93">tri_woop</a>);
<a name="l00729"></a>00729     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a26ffea9b73bc87b2ed1ccb546d851cb3">prim_visibility</a>);
<a name="l00730"></a>00730     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a4931bed89a83aaba8308f4a1b3c09fe9">prim_index</a>);
<a name="l00731"></a>00731     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a48f199a98b72579a2fc32920f9d9263f">prim_object</a>);
<a name="l00732"></a>00732     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a89b344720433845cdaed5271d19e45bd">tri_normal</a>);
<a name="l00733"></a>00733     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0eb9b80a95d9e4135bacf9b1b6295e45">tri_vnormal</a>);
<a name="l00734"></a>00734     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ad1640fd77bf4645d4f4e5526f8646f8b">tri_vindex</a>);
<a name="l00735"></a>00735     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a45700f137b80c938281a9f2e1fe78abb">tri_verts</a>);
<a name="l00736"></a>00736     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a588ef209bc3f7718fb36ca1ba06efb5b">attributes_map</a>);
<a name="l00737"></a>00737     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aca4ed1d25b361c8644fefe76bf7c4a6e">attributes_float</a>);
<a name="l00738"></a>00738     device-&gt;<a class="code" href="../../da/da1/structDevice.html#a9658a15fec92a2b45c2cffe7bc0036dc">tex_free</a>(dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aedfdeda6425faa841989df70d954e539">attributes_float3</a>);
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0a79969d6824d29eae159b39acce8284">bvh_nodes</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00741"></a>00741     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a921b49600c59d2a0aae898fd0bb36bd0">object_node</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00742"></a>00742     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a539ede37902f4b27499d6dcdeff7fa93">tri_woop</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00743"></a>00743     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a26ffea9b73bc87b2ed1ccb546d851cb3">prim_visibility</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00744"></a>00744     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a4931bed89a83aaba8308f4a1b3c09fe9">prim_index</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00745"></a>00745     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a48f199a98b72579a2fc32920f9d9263f">prim_object</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00746"></a>00746     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a89b344720433845cdaed5271d19e45bd">tri_normal</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00747"></a>00747     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a0eb9b80a95d9e4135bacf9b1b6295e45">tri_vnormal</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00748"></a>00748     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#ad1640fd77bf4645d4f4e5526f8646f8b">tri_vindex</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00749"></a>00749     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a45700f137b80c938281a9f2e1fe78abb">tri_verts</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00750"></a>00750     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#a588ef209bc3f7718fb36ca1ba06efb5b">attributes_map</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00751"></a>00751     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aca4ed1d25b361c8644fefe76bf7c4a6e">attributes_float</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00752"></a>00752     dscene-&gt;<a class="code" href="../../db/d5b/classDeviceScene.html#aedfdeda6425faa841989df70d954e539">attributes_float3</a>.<a class="code" href="../../dd/d7d/classdevice__vector.html#a7746a4d2ff613ed100e6072da0f721a9">clear</a>();
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="../../db/da4/classMeshManager.html#a9d5fe3126ea4df5162f48bbde5632ca1">00755</a> <span class="keywordtype">void</span> <a class="code" href="../../db/da4/classMeshManager.html#a9d5fe3126ea4df5162f48bbde5632ca1">MeshManager::tag_update</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757     <a class="code" href="../../db/da4/classMeshManager.html#a2802a16bd10c62661bf690fb25a773be">need_update</a> = <span class="keyword">true</span>;
<a name="l00758"></a>00758     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a78b24e7f9b520dd223f9056fa6cbc86e">object_manager</a>-&gt;<a class="code" href="../../d6/d6f/classObjectManager.html#ab27f4d17c5f72d0339c080528550bfb1">need_update</a> = <span class="keyword">true</span>;
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <a class="code" href="../../d5/d05/kernel__compat__cuda_8h.html#ae0c27e57708248c67409956ddc159e18">CCL_NAMESPACE_END</a>
<a name="l00762"></a>00762 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:32 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
