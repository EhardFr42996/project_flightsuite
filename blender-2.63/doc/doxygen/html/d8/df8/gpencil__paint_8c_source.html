<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: gpencil_paint.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">gpencil_paint.c</div>  </div>
</div>
<div class="contents">
<a href="../../d8/df8/gpencil__paint_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2008, Blender Foundation, Joshua Leung</span>
<a name="l00019"></a>00019 <span class="comment"> * This is a new part of Blender</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Joshua Leung</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df0/BKE__gpencil_8h.html">BKE_gpencil.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html">DNA_gpencil_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html">DNA_windowmanager_types.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d63/UI__view2d_8h.html">UI_view2d.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dea/ED__gpencil_8h.html">ED_gpencil.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d14/gpencil__intern_8h.html">gpencil_intern.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">/* ******************************************* */</span>
<a name="l00068"></a>00068 <span class="comment">/* &#39;Globals&#39; and Defines */</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">/* Temporary &#39;Stroke&#39; Operation data */</span>
<a name="l00071"></a><a class="code" href="../../d5/dec/structtGPsdata.html">00071</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> {
<a name="l00072"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">00072</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>;       <span class="comment">/* current scene from context */</span>
<a name="l00073"></a>00073     
<a name="l00074"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a5c5789b8d612565c1ff574acf3815abf">00074</a>     <a class="code" href="../../dc/da4/structwmWindow.html">wmWindow</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a5c5789b8d612565c1ff574acf3815abf">win</a>;      <span class="comment">/* window where painting originated */</span>
<a name="l00075"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">00075</a>     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>;        <span class="comment">/* area where painting originated */</span>
<a name="l00076"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">00076</a>     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>;        <span class="comment">/* region where painting originated */</span>
<a name="l00077"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">00077</a>     <a class="code" href="../../d7/de3/structView2D.html">View2D</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>;        <span class="comment">/* needed for GP_STROKE_2DSPACE */</span>
<a name="l00078"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">00078</a>     <a class="code" href="../../da/d10/structrctf.html">rctf</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>;      <span class="comment">/* for using the camera rect within the 3d view */</span>
<a name="l00079"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a510d3d61190470468bad334fa8144b2a">00079</a>     <a class="code" href="../../da/d10/structrctf.html">rctf</a> <a class="code" href="../../d5/dec/structtGPsdata.html#a510d3d61190470468bad334fa8144b2a">subrect_data</a>;
<a name="l00080"></a>00080     
<a name="l00081"></a>00081     
<a name="l00082"></a>00082 <span class="preprocessor">#if 0 // XXX review this 2d image stuff...</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>    <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;        <span class="comment">/* needed for GP_STROKE_2DIMAGE */</span>
<a name="l00084"></a>00084     <span class="keyword">struct </span>IBufViewSettings {
<a name="l00085"></a>00085         <span class="keywordtype">int</span> offsx, offsy;           <span class="comment">/* offsets */</span>
<a name="l00086"></a>00086         <span class="keywordtype">int</span> sizex, sizey;           <span class="comment">/* dimensions to use as scale-factor */</span>
<a name="l00087"></a>00087     } im2d_settings;    <span class="comment">/* needed for GP_STROKE_2DIMAGE */</span>
<a name="l00088"></a>00088 <span class="preprocessor">#endif</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>    
<a name="l00090"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a4568c66f455aca073f275f6171d06648">00090</a>     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> <a class="code" href="../../d5/dec/structtGPsdata.html#a4568c66f455aca073f275f6171d06648">ownerPtr</a>;<span class="comment">/* pointer to owner of gp-datablock */</span>
<a name="l00091"></a><a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">00091</a>     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;       <span class="comment">/* gp-datablock layer comes from */</span>
<a name="l00092"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">00092</a>     <a class="code" href="../../da/d7e/structbGPDlayer.html">bGPDlayer</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>;     <span class="comment">/* layer we&#39;re working on */</span>
<a name="l00093"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">00093</a>     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>;     <span class="comment">/* frame we&#39;re working on */</span>
<a name="l00094"></a>00094     
<a name="l00095"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">00095</a>     <span class="keywordtype">short</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>;       <span class="comment">/* current status of painting */</span>
<a name="l00096"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">00096</a>     <span class="keywordtype">short</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>;    <span class="comment">/* mode for painting */</span>
<a name="l00097"></a>00097     
<a name="l00098"></a><a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">00098</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[2];        <span class="comment">/* current mouse-position */</span>
<a name="l00099"></a><a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">00099</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[2];       <span class="comment">/* previous recorded mouse-position */</span>
<a name="l00100"></a>00100     
<a name="l00101"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">00101</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>;     <span class="comment">/* current stylus pressure */</span>
<a name="l00102"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">00102</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>;    <span class="comment">/* previous stylus pressure */</span>
<a name="l00103"></a>00103     
<a name="l00104"></a><a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">00104</a>     <span class="keywordtype">short</span> <a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>;       <span class="comment">/* radius of influence for eraser */</span>
<a name="l00105"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">00105</a>     <span class="keywordtype">short</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a>;        <span class="comment">/* flags that can get set during runtime */</span>
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="../../d5/dec/structtGPsdata.html#af2132776ee46a1493be565f144f06141">00107</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dec/structtGPsdata.html#af2132776ee46a1493be565f144f06141">imat</a>[4][4];   <span class="comment">/* inverted transformation matrix applying when converting coords from screen-space</span>
<a name="l00108"></a>00108 <span class="comment">                         * to region space */</span>
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">00110</a>     <span class="keywordtype">float</span> <a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[4]; <span class="comment">/* custom color for (?) */</span>
<a name="l00111"></a>00111 } <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acd9a6e4e6ea3c7794cd77fa5dfbe98ce">tGPsdata</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="comment">/* values for tGPsdata-&gt;status */</span>
<a name="l00114"></a>00114 <span class="keyword">enum</span> {
<a name="l00115"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a117dbf3e1c6793e7afb66cfb4f55c7ef">00115</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a117dbf3e1c6793e7afb66cfb4f55c7ef">GP_STATUS_IDLING</a> = 0,   <span class="comment">/* stroke isn&#39;t in progress yet */</span>
<a name="l00116"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">00116</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>,     <span class="comment">/* a stroke is in progress */</span>
<a name="l00117"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">00117</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>,        <span class="comment">/* something wasn&#39;t correctly set up */</span>
<a name="l00118"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7af10dbe4a0912e9d91fd23d0a56614dba">00118</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7af10dbe4a0912e9d91fd23d0a56614dba">GP_STATUS_DONE</a>          <span class="comment">/* painting done */</span>
<a name="l00119"></a>00119 };
<a name="l00120"></a>00120 
<a name="l00121"></a>00121 <span class="comment">/* Return flags for adding points to stroke buffer */</span>
<a name="l00122"></a>00122 <span class="keyword">enum</span> {
<a name="l00123"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3ca411b7dec5a2cc0d547b40e2db0ceb995">00123</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3ca411b7dec5a2cc0d547b40e2db0ceb995">GP_STROKEADD_INVALID</a>    = -2,       <span class="comment">/* error occurred - insufficient info to do so */</span>
<a name="l00124"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cacc17d22c728c52591de2101a75f19620">00124</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cacc17d22c728c52591de2101a75f19620">GP_STROKEADD_OVERFLOW</a>   = -1,       <span class="comment">/* error occurred - cannot fit any more points */</span>
<a name="l00125"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cab8496e7751575b7a09c4863535d76e83">00125</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cab8496e7751575b7a09c4863535d76e83">GP_STROKEADD_NORMAL</a>,                <span class="comment">/* point was successfully added */</span>
<a name="l00126"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3caa7215e5402c5438fb85e015b8bff2106">00126</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3caa7215e5402c5438fb85e015b8bff2106">GP_STROKEADD_FULL</a>                   <span class="comment">/* cannot add any more points to buffer */</span>
<a name="l00127"></a>00127 };
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/* Runtime flags */</span>
<a name="l00130"></a>00130 <span class="keyword">enum</span> {
<a name="l00131"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">00131</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>       = (1&lt;&lt;0),   <span class="comment">/* operator just started */</span>
<a name="l00132"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a7f3a3004dd6c590b1f9ae3a0bc2da7ad">00132</a>     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a7f3a3004dd6c590b1f9ae3a0bc2da7ad">GP_PAINTFLAG_STROKEADDED</a>    = (1&lt;&lt;1)    <span class="comment">/* stroke was already added during draw session */</span>
<a name="l00133"></a>00133 };
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">/* ------ */</span>
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="comment">/* maximum sizes of gp-session buffer */</span>
<a name="l00138"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2df51ff1927fa0f65293f7a40d741ca4">00138</a> <span class="preprocessor">#define GP_STROKE_BUFFER_MAX    5000</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>
<a name="l00140"></a>00140 <span class="comment">/* Macros for accessing sensitivity thresholds... */</span>
<a name="l00141"></a>00141     <span class="comment">/* minimum number of pixels mouse should move before new point created */</span>
<a name="l00142"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a945998cb6f349dc265255fe595458235">00142</a> <span class="preprocessor">#define MIN_MANHATTEN_PX    (U.gp_manhattendist)</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>    <span class="comment">/* minimum length of new segment before new point can be added */</span>
<a name="l00144"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab04d7efa0aa4d3653f7f2aa2660bcc5b">00144</a> <span class="preprocessor">#define MIN_EUCLIDEAN_PX    (U.gp_euclideandist)</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="comment">/* ------ */</span>
<a name="l00147"></a>00147 <span class="comment">/* Forward defines for some functions... */</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">gp_session_validatebuffer</a>(<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>);
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">/* ******************************************* */</span>
<a name="l00152"></a>00152 <span class="comment">/* Context Wrangling... */</span>
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 <span class="comment">/* check if context is suitable for drawing */</span>
<a name="l00155"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a67e8a78ecbce67aa070abc354e4f1255">00155</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a67e8a78ecbce67aa070abc354e4f1255">gpencil_draw_poll</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d12/ED__screen_8h.html#ad26d7d88648e865cde6cca20f026ac66">ED_operator_regionactive</a>(C)) {
<a name="l00158"></a>00158         <span class="comment">/* check if current context can support GPencil data */</span>
<a name="l00159"></a>00159         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d13/gpencil__edit_8c.html#ac2d9a15a8bf2418b19c1e5b7101fd7a2">gpencil_data_get_pointers</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00160"></a>00160             <span class="comment">/* check if Grease Pencil isn&#39;t already running */</span>
<a name="l00161"></a>00161             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d8f/gpencil__undo_8c.html#a67414a9863ddd079f85ac56f091d3e2f">ED_gpencil_session_active</a>() == 0)
<a name="l00162"></a>00162                 <span class="keywordflow">return</span> 1;
<a name="l00163"></a>00163             <span class="keywordflow">else</span>
<a name="l00164"></a>00164                 <a class="code" href="../../df/d01/BKE__context_8h.html#adb80273514fd122e9b437f8849ced258">CTX_wm_operator_poll_msg_set</a>(C, <span class="stringliteral">&quot;Grease Pencil operator is already active&quot;</span>);
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166         <span class="keywordflow">else</span> {
<a name="l00167"></a>00167             <a class="code" href="../../df/d01/BKE__context_8h.html#adb80273514fd122e9b437f8849ced258">CTX_wm_operator_poll_msg_set</a>(C, <span class="stringliteral">&quot;Failed to find Grease Pencil data to draw into&quot;</span>);
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170     <span class="keywordflow">else</span> {
<a name="l00171"></a>00171         <a class="code" href="../../df/d01/BKE__context_8h.html#adb80273514fd122e9b437f8849ced258">CTX_wm_operator_poll_msg_set</a>(C, <span class="stringliteral">&quot;Active region not set&quot;</span>);
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     <span class="keywordflow">return</span> 0;
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">/* check if projecting strokes into 3d-geometry in the 3D-View */</span>
<a name="l00178"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">00178</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">gpencil_project_check</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00181"></a>00181     <span class="keywordflow">return</span> ((gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a9dd7d3e1648c80abe3cd67be622a1087">GP_STROKE_3DSPACE</a>) &amp;&amp; (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; (<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a0c50e8058cd049e9149bb3bb76bce045">GP_DATA_DEPTH_VIEW</a> | <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a529f36469455be7c564513f59eb75be2">GP_DATA_DEPTH_STROKE</a>)));
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="comment">/* ******************************************* */</span>
<a name="l00185"></a>00185 <span class="comment">/* Calculations/Conversions */</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 <span class="comment">/* Utilities --------------------------------- */</span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="comment">/* get the reference point for stroke-point conversions */</span>
<a name="l00190"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a753e284e9181e106b10ac17266535dbd">00190</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a753e284e9181e106b10ac17266535dbd">gp_get_3d_reference</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">float</span> vec[3])
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00193"></a>00193     <span class="keywordtype">float</span> *fp= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>, v3d);
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     <span class="comment">/* the reference point used depends on the owner... */</span>
<a name="l00196"></a>00196 <span class="preprocessor">#if 0 // XXX: disabled for now, since we can&#39;t draw relative to the owner yet</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a4568c66f455aca073f275f6171d06648">ownerPtr</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a41f868aea62068fbbfa36c1a5dbe30f9">type</a> == &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#aada94b4b642ee7efbcc6ac0dadc8c4b2">RNA_Object</a>) {
<a name="l00198"></a>00198         <a class="code" href="../../de/de7/structObject.html">Object</a> *ob= (<a class="code" href="../../de/de7/structObject.html">Object</a> *)p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a4568c66f455aca073f275f6171d06648">ownerPtr</a>.<a class="code" href="../../dd/d80/structPointerRNA.html#a18702e1d8f8c1a63389b3a322536e0e6">data</a>;
<a name="l00199"></a>00199         
<a name="l00200"></a>00200         <span class="comment">/* active Object </span>
<a name="l00201"></a>00201 <span class="comment">         *  - use relative distance of 3D-cursor from object center </span>
<a name="l00202"></a>00202 <span class="comment">         */</span>
<a name="l00203"></a>00203         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec, fp, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>);
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205     <span class="keywordflow">else</span>
<a name="l00206"></a>00206 <span class="preprocessor">#endif  </span>
<a name="l00207"></a>00207 <span class="preprocessor"></span>    {
<a name="l00208"></a>00208         <span class="comment">/* use 3D-cursor */</span>
<a name="l00209"></a>00209         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, fp);
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/* Stroke Editing ---------------------------- */</span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">/* check if the current mouse position is suitable for adding a new point */</span>
<a name="l00216"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a46b9975674ad4cfa38e3ace14b31a7e7">00216</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a46b9975674ad4cfa38e3ace14b31a7e7">gp_stroke_filtermval</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">int</span> pmval[2])
<a name="l00217"></a>00217 {
<a name="l00218"></a>00218     <span class="keywordtype">int</span> dx= <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(mval[0] - pmval[0]);
<a name="l00219"></a>00219     <span class="keywordtype">int</span> dy= <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(mval[1] - pmval[1]);
<a name="l00220"></a>00220     
<a name="l00221"></a>00221     <span class="comment">/* if buffer is empty, just let this go through (i.e. so that dots will work) */</span>
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> == 0)
<a name="l00223"></a>00223         <span class="keywordflow">return</span> 1;
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     <span class="comment">/* check if mouse moved at least certain distance on both axes (best case) </span>
<a name="l00226"></a>00226 <span class="comment">     *  - aims to eliminate some jitter-noise from input when trying to draw straight lines freehand</span>
<a name="l00227"></a>00227 <span class="comment">     */</span>
<a name="l00228"></a>00228     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((dx &gt; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a945998cb6f349dc265255fe595458235">MIN_MANHATTEN_PX</a>) &amp;&amp; (dy &gt; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a945998cb6f349dc265255fe595458235">MIN_MANHATTEN_PX</a>))
<a name="l00229"></a>00229         <span class="keywordflow">return</span> 1;
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     <span class="comment">/* check if the distance since the last point is significant enough </span>
<a name="l00232"></a>00232 <span class="comment">     *  - prevents points being added too densely</span>
<a name="l00233"></a>00233 <span class="comment">     *  - distance here doesn&#39;t use sqrt to prevent slowness... we should still be safe from overflows though</span>
<a name="l00234"></a>00234 <span class="comment">     */</span>
<a name="l00235"></a>00235     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((dx*dx + dy*dy) &gt; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab04d7efa0aa4d3653f7f2aa2660bcc5b">MIN_EUCLIDEAN_PX</a>*<a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab04d7efa0aa4d3653f7f2aa2660bcc5b">MIN_EUCLIDEAN_PX</a>)
<a name="l00236"></a>00236         <span class="keywordflow">return</span> 1;
<a name="l00237"></a>00237     
<a name="l00238"></a>00238     <span class="comment">/* mouse &#39;didn&#39;t move&#39; */</span>
<a name="l00239"></a>00239     <span class="keywordflow">else</span>
<a name="l00240"></a>00240         <span class="keywordflow">return</span> 0;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* convert screen-coordinates to buffer-coordinates */</span>
<a name="l00244"></a>00244 <span class="comment">// XXX this method needs a total overhaul!</span>
<a name="l00245"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">00245</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">float</span> out[3], <span class="keywordtype">float</span> *depth)
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00248"></a>00248     
<a name="l00249"></a>00249     <span class="comment">/* in 3d-space - pt-&gt;x/y/z are 3 side-by-side floats */</span>
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a9dd7d3e1648c80abe3cd67be622a1087">GP_STROKE_3DSPACE</a>) {
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">gpencil_project_check</a>(p) &amp;&amp; (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a729a85a720484c9f13cf2cd27d25b2dc">ED_view3d_autodist_simple</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, mval, out, 0, depth))) {
<a name="l00252"></a>00252             <span class="comment">/* projecting onto 3D-Geometry</span>
<a name="l00253"></a>00253 <span class="comment">             *  - nothing more needs to be done here, since view_autodist_simple() has already done it</span>
<a name="l00254"></a>00254 <span class="comment">             */</span>
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256         <span class="keywordflow">else</span> {
<a name="l00257"></a>00257             <span class="keywordtype">int</span> mval_prj[2];
<a name="l00258"></a>00258             <span class="keywordtype">float</span> rvec[3], dvec[3];
<a name="l00259"></a>00259             <span class="keywordtype">float</span> mval_f[2];
<a name="l00260"></a>00260 
<a name="l00261"></a>00261             <span class="comment">/* Current method just converts each point in screen-coordinates to</span>
<a name="l00262"></a>00262 <span class="comment">             * 3D-coordinates using the 3D-cursor as reference. In general, this</span>
<a name="l00263"></a>00263 <span class="comment">             * works OK, but it could of course be improved.</span>
<a name="l00264"></a>00264 <span class="comment">             *</span>
<a name="l00265"></a>00265 <span class="comment">             * TODO:</span>
<a name="l00266"></a>00266 <span class="comment">             *  - investigate using nearest point(s) on a previous stroke as</span>
<a name="l00267"></a>00267 <span class="comment">             *    reference point instead or as offset, for easier stroke matching</span>
<a name="l00268"></a>00268 <span class="comment">             */</span>
<a name="l00269"></a>00269             
<a name="l00270"></a>00270             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a753e284e9181e106b10ac17266535dbd">gp_get_3d_reference</a>(p, rvec);
<a name="l00271"></a>00271             
<a name="l00272"></a>00272             <span class="comment">/* method taken from editview.c - mouse_cursor() */</span>
<a name="l00273"></a>00273             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a3f4393c9c8a64399c8a2b6c1980ff260">project_int_noclip</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, rvec, mval_prj);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a377b8132a50113311bd5d7d76aa30700">VECSUB2D</a>(mval_f, mval_prj, mval);
<a name="l00276"></a>00276             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ae4c98073cdfe1ff7ff50c08cb53b4228">ED_view3d_win_to_delta</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, mval_f, dvec);
<a name="l00277"></a>00277             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(out, rvec, dvec);
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     <span class="comment">/* 2d - on &#39;canvas&#39; (assume that p-&gt;v2d is set) */</span>
<a name="l00282"></a>00282     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>) &amp;&amp; (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>)) {
<a name="l00283"></a>00283         <a class="code" href="../../d5/d63/UI__view2d_8h.html#acb43bece9ce784b1daa91efb77069e78">UI_view2d_region_to_view</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>, mval[0], mval[1], &amp;out[0], &amp;out[1]);
<a name="l00284"></a>00284         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(out, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#af2132776ee46a1493be565f144f06141">imat</a>, out);
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286     
<a name="l00287"></a>00287 <span class="preprocessor">#if 0</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>    <span class="comment">/* 2d - on image &#39;canvas&#39; (assume that p-&gt;v2d is set) */</span>
<a name="l00289"></a>00289     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#af888e4e158b9676e4ad3d58579d9d13c">GP_STROKE_2DIMAGE</a>) {
<a name="l00290"></a>00290         <span class="keywordtype">int</span> sizex, sizey, offsx, offsy;
<a name="l00291"></a>00291         
<a name="l00292"></a>00292         <span class="comment">/* get stored settings </span>
<a name="l00293"></a>00293 <span class="comment">         *  - assume that these have been set already (there are checks that set sane &#39;defaults&#39; just in case)</span>
<a name="l00294"></a>00294 <span class="comment">         */</span>
<a name="l00295"></a>00295         sizex= p-&gt;im2d_settings.sizex;
<a name="l00296"></a>00296         sizey= p-&gt;im2d_settings.sizey;
<a name="l00297"></a>00297         offsx= p-&gt;im2d_settings.offsx;
<a name="l00298"></a>00298         offsy= p-&gt;im2d_settings.offsy;
<a name="l00299"></a>00299         
<a name="l00300"></a>00300         <span class="comment">/* calculate new points */</span>
<a name="l00301"></a>00301         out[0]= (float)(mval[0] - offsx) / (float)sizex;
<a name="l00302"></a>00302         out[1]= (float)(mval[1] - offsy) / (float)sizey;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 <span class="preprocessor">#endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>    
<a name="l00306"></a>00306     <span class="comment">/* 2d - relative to screen (viewport area) */</span>
<a name="l00307"></a>00307     <span class="keywordflow">else</span> {
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { <span class="comment">/* normal 3D view */</span>
<a name="l00309"></a>00309             out[0] = (float)(mval[0]) / (float)(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>) * 100;
<a name="l00310"></a>00310             out[1] = (float)(mval[1]) / (float)(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>) * 100;
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312         <span class="keywordflow">else</span> { <span class="comment">/* camera view, use subrect */</span>
<a name="l00313"></a>00313             out[0]= ((mval[0] - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) / ((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>))) * 100;
<a name="l00314"></a>00314             out[1]= ((mval[1] - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) / ((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>))) * 100;
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="comment">/* add current stroke-point to buffer (returns whether point was successfully added) */</span>
<a name="l00320"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">00320</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">gp_stroke_addpoint</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">float</span> pressure)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00323"></a>00323     <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pt;
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="comment">/* check painting mode */</span>
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>) {
<a name="l00327"></a>00327         <span class="comment">/* straight lines only - i.e. only store start and end point in buffer */</span>
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> == 0) {
<a name="l00329"></a>00329             <span class="comment">/* first point in buffer (start point) */</span>
<a name="l00330"></a>00330             pt= (<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>);
<a name="l00331"></a>00331             
<a name="l00332"></a>00332             <span class="comment">/* store settings */</span>
<a name="l00333"></a>00333             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(&amp;pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, mval);
<a name="l00334"></a>00334             pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>= pressure;
<a name="l00335"></a>00335             
<a name="l00336"></a>00336             <span class="comment">/* increment buffer size */</span>
<a name="l00337"></a>00337             gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>++;
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339         <span class="keywordflow">else</span> {
<a name="l00340"></a>00340             <span class="comment">/* normally, we just reset the endpoint to the latest value </span>
<a name="l00341"></a>00341 <span class="comment">             *  - assume that pointers for this are always valid...</span>
<a name="l00342"></a>00342 <span class="comment">             */</span>
<a name="l00343"></a>00343             pt= ((<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) + 1);
<a name="l00344"></a>00344             
<a name="l00345"></a>00345             <span class="comment">/* store settings */</span>
<a name="l00346"></a>00346             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(&amp;pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, mval);
<a name="l00347"></a>00347             pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>= pressure;
<a name="l00348"></a>00348             
<a name="l00349"></a>00349             <span class="comment">/* if this is just the second point we&#39;ve added, increment the buffer size</span>
<a name="l00350"></a>00350 <span class="comment">             * so that it will be drawn properly...</span>
<a name="l00351"></a>00351 <span class="comment">             * otherwise, just leave it alone, otherwise we get problems</span>
<a name="l00352"></a>00352 <span class="comment">             */</span>
<a name="l00353"></a>00353             <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> != 2)
<a name="l00354"></a>00354                 gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>= 2;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         
<a name="l00357"></a>00357         <span class="comment">/* can keep carrying on this way :) */</span>
<a name="l00358"></a>00358         <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cab8496e7751575b7a09c4863535d76e83">GP_STROKEADD_NORMAL</a>;
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba44edb318a529be4708e2c7c7e2ae77d7">GP_PAINTMODE_DRAW</a>) { <span class="comment">/* normal drawing */</span>
<a name="l00361"></a>00361         <span class="comment">/* check if still room in buffer */</span>
<a name="l00362"></a>00362         <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> &gt;= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2df51ff1927fa0f65293f7a40d741ca4">GP_STROKE_BUFFER_MAX</a>)
<a name="l00363"></a>00363             <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cacc17d22c728c52591de2101a75f19620">GP_STROKEADD_OVERFLOW</a>;
<a name="l00364"></a>00364         
<a name="l00365"></a>00365         <span class="comment">/* get pointer to destination point */</span>
<a name="l00366"></a>00366         pt= ((<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) + gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>);
<a name="l00367"></a>00367         
<a name="l00368"></a>00368         <span class="comment">/* store settings */</span>
<a name="l00369"></a>00369         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(&amp;pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, mval);
<a name="l00370"></a>00370         pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>= pressure;
<a name="l00371"></a>00371         
<a name="l00372"></a>00372         <span class="comment">/* increment counters */</span>
<a name="l00373"></a>00373         gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>++;
<a name="l00374"></a>00374         
<a name="l00375"></a>00375         <span class="comment">/* check if another operation can still occur */</span>
<a name="l00376"></a>00376         <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2df51ff1927fa0f65293f7a40d741ca4">GP_STROKE_BUFFER_MAX</a>)
<a name="l00377"></a>00377             <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3caa7215e5402c5438fb85e015b8bff2106">GP_STROKEADD_FULL</a>;
<a name="l00378"></a>00378         <span class="keywordflow">else</span>
<a name="l00379"></a>00379             <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cab8496e7751575b7a09c4863535d76e83">GP_STROKEADD_NORMAL</a>;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>) {
<a name="l00382"></a>00382         <span class="comment">/* get pointer to destination point */</span>
<a name="l00383"></a>00383         pt= (<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">/* store settings */</span>
<a name="l00386"></a>00386         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(&amp;pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, mval);
<a name="l00387"></a>00387         pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>= pressure;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <span class="comment">/* if there&#39;s stroke for this poly line session add (or replace last) point</span>
<a name="l00390"></a>00390 <span class="comment">         * to stroke. This allows to draw lines more interactively (see new segment</span>
<a name="l00391"></a>00391 <span class="comment">         * during mouse slide, i.e.) </span>
<a name="l00392"></a>00392 <span class="comment">         */</span>
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a7f3a3004dd6c590b1f9ae3a0bc2da7ad">GP_PAINTFLAG_STROKEADDED</a>) {
<a name="l00394"></a>00394             <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gps= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00395"></a>00395             <a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a> *pts;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397             <span class="comment">/* first time point is adding to temporary buffer -- need to allocate new point in stroke */</span>
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> == 0) {
<a name="l00399"></a>00399                 gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>+1));
<a name="l00400"></a>00400                 gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>++;
<a name="l00401"></a>00401             }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403             pts = &amp;gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>[gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>-1];
<a name="l00404"></a>00404 
<a name="l00405"></a>00405             <span class="comment">/* special case for poly lines: normally, depth is needed only when creating new stroke from buffer,</span>
<a name="l00406"></a>00406 <span class="comment">             * but poly lines are converting to stroke instantly, so initialize depth buffer before converting coordinates </span>
<a name="l00407"></a>00407 <span class="comment">             */</span>
<a name="l00408"></a>00408             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">gpencil_project_check</a>(p)) {
<a name="l00409"></a>00409                 <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a5f8982ad793ea8e5611a4be40deda650">view3d_region_operator_needs_opengl</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a5c5789b8d612565c1ff574acf3815abf">win</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>);
<a name="l00412"></a>00412                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a9685a729e5c8773d46ccd24e8faf4199">ED_view3d_autodist_init</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, v3d, (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a529f36469455be7c564513f59eb75be2">GP_DATA_DEPTH_STROKE</a>) ? 1:0);
<a name="l00413"></a>00413             }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             <span class="comment">/* convert screen-coordinates to appropriate coordinates (and store them) */</span>
<a name="l00416"></a>00416             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a>(p, &amp;pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;pts-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418             <span class="comment">/* copy pressure */</span>
<a name="l00419"></a>00419             pts-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a19dbfae864672c65b28bf1420d5095dd">pressure</a>= pt-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>;
<a name="l00420"></a>00420         }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422         <span class="comment">/* increment counters */</span>
<a name="l00423"></a>00423         <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> == 0)
<a name="l00424"></a>00424             gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>++;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cab8496e7751575b7a09c4863535d76e83">GP_STROKEADD_NORMAL</a>;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     
<a name="l00429"></a>00429     <span class="comment">/* return invalid state for now... */</span>
<a name="l00430"></a>00430     <span class="keywordflow">return</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3ca411b7dec5a2cc0d547b40e2db0ceb995">GP_STROKEADD_INVALID</a>;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="comment">/* temp struct for gp_stroke_smooth() */</span>
<a name="l00435"></a><a class="code" href="../../dc/db0/structtGpSmoothCo.html">00435</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/db0/structtGpSmoothCo.html">tGpSmoothCo</a> {
<a name="l00436"></a><a class="code" href="../../dc/db0/structtGpSmoothCo.html#aa345913c3eb5ca5b9e5134d1dc9356d9">00436</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/db0/structtGpSmoothCo.html#aa345913c3eb5ca5b9e5134d1dc9356d9">x</a>;
<a name="l00437"></a><a class="code" href="../../dc/db0/structtGpSmoothCo.html#a7b100492423e05d0771357ca2e2ebeb3">00437</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/db0/structtGpSmoothCo.html#a7b100492423e05d0771357ca2e2ebeb3">y</a>;
<a name="l00438"></a>00438 } <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af291add6b758cca560b729caae54b95e">tGpSmoothCo</a>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">/* smooth a stroke (in buffer) before storing it */</span>
<a name="l00441"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a11b9e687ad41adcc2becb4468f4d534b">00441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a11b9e687ad41adcc2becb4468f4d534b">gp_stroke_smooth</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00444"></a>00444     <a class="code" href="../../dc/db0/structtGpSmoothCo.html">tGpSmoothCo</a> *smoothArray, *spc;
<a name="l00445"></a>00445     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0, cmx=gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>;
<a name="l00446"></a>00446     
<a name="l00447"></a>00447     <span class="comment">/* only smooth if smoothing is enabled, and we&#39;re not doing a straight line */</span>
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.gp_settings &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a2a7a8faa53b140bed62ccd2185464cbf">GP_PAINT_DOSMOOTH</a>) || <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>, <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>, <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>))
<a name="l00449"></a>00449         <span class="keywordflow">return</span>;
<a name="l00450"></a>00450     
<a name="l00451"></a>00451     <span class="comment">/* don&#39;t try if less than 2 points in buffer */</span>
<a name="l00452"></a>00452     <span class="keywordflow">if</span> ((cmx &lt;= 2) || (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l00453"></a>00453         <span class="keywordflow">return</span>;
<a name="l00454"></a>00454     
<a name="l00455"></a>00455     <span class="comment">/* create a temporary smoothing coordinates buffer, use to store calculated values to prevent sequential error */</span>
<a name="l00456"></a>00456     smoothArray = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/db0/structtGpSmoothCo.html">tGpSmoothCo</a>)*cmx, <span class="stringliteral">&quot;gp_stroke_smooth smoothArray&quot;</span>);
<a name="l00457"></a>00457     
<a name="l00458"></a>00458     <span class="comment">/* first pass: calculate smoothing coordinates using weighted-averages */</span>
<a name="l00459"></a>00459     <span class="keywordflow">for</span> (i=0, spc=smoothArray; i &lt; gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>; i++, spc++) {
<a name="l00460"></a>00460         <span class="keyword">const</span> <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pc= (((<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l00461"></a>00461         <span class="keyword">const</span> <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pb= (i-1 &gt; 0)?(pc-1):(pc);
<a name="l00462"></a>00462         <span class="keyword">const</span> <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pa= (i-2 &gt; 0)?(pc-2):(pb);
<a name="l00463"></a>00463         <span class="keyword">const</span> <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pd= (i+1 &lt; cmx)?(pc+1):(pc);
<a name="l00464"></a>00464         <span class="keyword">const</span> <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pe= (i+2 &lt; cmx)?(pc+2):(pd);
<a name="l00465"></a>00465         
<a name="l00466"></a>00466         spc-&gt;<a class="code" href="../../dc/db0/structtGpSmoothCo.html#aa345913c3eb5ca5b9e5134d1dc9356d9">x</a>= (int)(0.1*pa-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a> + 0.2*pb-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a> + 0.4*pc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a> + 0.2*pd-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a> + 0.1*pe-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>);
<a name="l00467"></a>00467         spc-&gt;<a class="code" href="../../dc/db0/structtGpSmoothCo.html#a7b100492423e05d0771357ca2e2ebeb3">y</a>= (int)(0.1*pa-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a36b0c5e51f64f5e368fa4dff95df9087">y</a> + 0.2*pb-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a36b0c5e51f64f5e368fa4dff95df9087">y</a> + 0.4*pc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a36b0c5e51f64f5e368fa4dff95df9087">y</a> + 0.2*pd-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a36b0c5e51f64f5e368fa4dff95df9087">y</a> + 0.1*pe-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a36b0c5e51f64f5e368fa4dff95df9087">y</a>);
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469     
<a name="l00470"></a>00470     <span class="comment">/* second pass: apply smoothed coordinates */</span>
<a name="l00471"></a>00471     <span class="keywordflow">for</span> (i=0, spc=smoothArray; i &lt; gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>; i++, spc++) {
<a name="l00472"></a>00472         <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *pc= (((<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(&amp;pc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;spc-&gt;<a class="code" href="../../dc/db0/structtGpSmoothCo.html#aa345913c3eb5ca5b9e5134d1dc9356d9">x</a>);
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     
<a name="l00477"></a>00477     <span class="comment">/* free temp array */</span>
<a name="l00478"></a>00478     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(smoothArray);
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="comment">/* simplify a stroke (in buffer) before storing it </span>
<a name="l00482"></a>00482 <span class="comment"> *  - applies a reverse Chaikin filter</span>
<a name="l00483"></a>00483 <span class="comment"> *  - code adapted from etch-a-ton branch (editarmature_sketch.c)</span>
<a name="l00484"></a>00484 <span class="comment"> */</span>
<a name="l00485"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#acfcda4c9390e5116af88894d387b4cd1">00485</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acfcda4c9390e5116af88894d387b4cd1">gp_stroke_simplify</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00488"></a>00488     <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *old_points= (<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>;
<a name="l00489"></a>00489     <span class="keywordtype">short</span> num_points= gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>;
<a name="l00490"></a>00490     <span class="keywordtype">short</span> flag= gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a>;
<a name="l00491"></a>00491     <span class="keywordtype">short</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l00492"></a>00492     
<a name="l00493"></a>00493     <span class="comment">/* only simplify if simplification is enabled, and we&#39;re not doing a straight line */</span>
<a name="l00494"></a>00494     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!(<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.gp_settings &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a4259522585d3badf163e10c0d25e1724">GP_PAINT_DOSIMPLIFY</a>) || (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>))
<a name="l00495"></a>00495         <span class="keywordflow">return</span>;
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     <span class="comment">/* don&#39;t simplify if less than 4 points in buffer */</span>
<a name="l00498"></a>00498     <span class="keywordflow">if</span> ((num_points &lt;= 4) || (old_points == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l00499"></a>00499         <span class="keywordflow">return</span>;
<a name="l00500"></a>00500         
<a name="l00501"></a>00501     <span class="comment">/* clear buffer (but don&#39;t free mem yet) so that we can write to it </span>
<a name="l00502"></a>00502 <span class="comment">     *  - firstly set sbuffer to NULL, so a new one is allocated</span>
<a name="l00503"></a>00503 <span class="comment">     *  - secondly, reset flag after, as it gets cleared auto</span>
<a name="l00504"></a>00504 <span class="comment">     */</span>
<a name="l00505"></a>00505     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00506"></a>00506     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">gp_session_validatebuffer</a>(p);
<a name="l00507"></a>00507     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> = flag;
<a name="l00508"></a>00508     
<a name="l00509"></a>00509 <span class="comment">/* macro used in loop to get position of new point</span>
<a name="l00510"></a>00510 <span class="comment"> *  - used due to the mixture of datatypes in use here</span>
<a name="l00511"></a>00511 <span class="comment"> */</span>
<a name="l00512"></a>00512 <span class="preprocessor">#define GP_SIMPLIFY_AVPOINT(offs, sfac) \</span>
<a name="l00513"></a>00513 <span class="preprocessor">    { \</span>
<a name="l00514"></a>00514 <span class="preprocessor">        co[0] += (float)(old_points[offs].x * sfac); \</span>
<a name="l00515"></a>00515 <span class="preprocessor">        co[1] += (float)(old_points[offs].y * sfac); \</span>
<a name="l00516"></a>00516 <span class="preprocessor">        pressure += old_points[offs].pressure * sfac; \</span>
<a name="l00517"></a>00517 <span class="preprocessor">    }</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span>    
<a name="l00519"></a>00519     <span class="keywordflow">for</span> (i = 0, j = 0; i &lt; num_points; i++) {
<a name="l00520"></a>00520         <span class="keywordflow">if</span> (i - j == 3) {
<a name="l00521"></a>00521             <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2], pressure;
<a name="l00522"></a>00522             <span class="keywordtype">int</span> mco[2];
<a name="l00523"></a>00523             
<a name="l00524"></a>00524             <span class="comment">/* initialize values */</span>
<a name="l00525"></a>00525             co[0]= 0;
<a name="l00526"></a>00526             co[1]= 0;
<a name="l00527"></a>00527             pressure = 0;
<a name="l00528"></a>00528             
<a name="l00529"></a>00529             <span class="comment">/* using macro, calculate new point */</span>
<a name="l00530"></a>00530             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acab514002a9a640e6deb8b249128b632">GP_SIMPLIFY_AVPOINT</a>(j, -0.25f);
<a name="l00531"></a>00531             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acab514002a9a640e6deb8b249128b632">GP_SIMPLIFY_AVPOINT</a>(j+1, 0.75f);
<a name="l00532"></a>00532             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acab514002a9a640e6deb8b249128b632">GP_SIMPLIFY_AVPOINT</a>(j+2, 0.75f);
<a name="l00533"></a>00533             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acab514002a9a640e6deb8b249128b632">GP_SIMPLIFY_AVPOINT</a>(j+3, -0.25f);
<a name="l00534"></a>00534             
<a name="l00535"></a>00535             <span class="comment">/* set values for adding */</span>
<a name="l00536"></a>00536             mco[0]= (int)co[0];
<a name="l00537"></a>00537             mco[1]= (int)co[1];
<a name="l00538"></a>00538             
<a name="l00539"></a>00539             <span class="comment">/* ignore return values on this... assume to be ok for now */</span>
<a name="l00540"></a>00540             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">gp_stroke_addpoint</a>(p, mco, pressure);
<a name="l00541"></a>00541             
<a name="l00542"></a>00542             j += 2;
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544     } 
<a name="l00545"></a>00545     
<a name="l00546"></a>00546     <span class="comment">/* free old buffer */</span>
<a name="l00547"></a>00547     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(old_points);
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="comment">/* make a new stroke from the buffer data */</span>
<a name="l00552"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a424e0528814e65cf89a8d569e8750371">00552</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a424e0528814e65cf89a8d569e8750371">gp_stroke_newfrombuffer</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00553"></a>00553 {
<a name="l00554"></a>00554     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00555"></a>00555     <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gps;
<a name="l00556"></a>00556     <a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a> *pt;
<a name="l00557"></a>00557     <a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *ptc;
<a name="l00558"></a>00558     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>;
<a name="l00559"></a>00559     <span class="comment">/* since strokes are so fine, when using their depth we need a margin otherwise they might get missed */</span>
<a name="l00560"></a>00560     <span class="keywordtype">int</span> depth_margin = (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a529f36469455be7c564513f59eb75be2">GP_DATA_DEPTH_STROKE</a>) ? 4 : 0;
<a name="l00561"></a>00561     
<a name="l00562"></a>00562     <span class="comment">/* get total number of points to allocate space for </span>
<a name="l00563"></a>00563 <span class="comment">     *  - drawing straight-lines only requires the endpoints</span>
<a name="l00564"></a>00564 <span class="comment">     */</span>
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>)
<a name="l00566"></a>00566         totelem = (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> &gt;= 2) ? 2: gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>;
<a name="l00567"></a>00567     <span class="keywordflow">else</span>
<a name="l00568"></a>00568         totelem = gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>;
<a name="l00569"></a>00569     
<a name="l00570"></a>00570     <span class="comment">/* exit with error if no valid points from this stroke */</span>
<a name="l00571"></a>00571     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (totelem == 0) {
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00573"></a>00573             printf(<span class="stringliteral">&quot;Error: No valid points in stroke buffer to convert (tot=%d)\n&quot;</span>, gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>);
<a name="l00574"></a>00574         <span class="keywordflow">return</span>;
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576     
<a name="l00577"></a>00577     <span class="comment">/* special case for poly line -- for already added stroke during session</span>
<a name="l00578"></a>00578 <span class="comment">     * coordinates are getting added to stroke immediately to allow more</span>
<a name="l00579"></a>00579 <span class="comment">     * interactive behavior */</span>
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>) {
<a name="l00581"></a>00581         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a7f3a3004dd6c590b1f9ae3a0bc2da7ad">GP_PAINTFLAG_STROKEADDED</a>)
<a name="l00582"></a>00582             <span class="keywordflow">return</span>;
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="comment">/* allocate memory for a new stroke */</span>
<a name="l00586"></a>00586     gps= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a>), <span class="stringliteral">&quot;gp_stroke&quot;</span>);
<a name="l00587"></a>00587     
<a name="l00588"></a>00588     <span class="comment">/* copy appropriate settings for stroke */</span>
<a name="l00589"></a>00589     gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>= <a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>;
<a name="l00590"></a>00590     gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a7669e2642e7942ea3db45b90381e012c">thickness</a>= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#aec274984dec865a805ce31bed1f039d8">thickness</a>;
<a name="l00591"></a>00591     gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a>= gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a>;
<a name="l00592"></a>00592     
<a name="l00593"></a>00593     <span class="comment">/* allocate enough memory for a continuous array for storage points */</span>
<a name="l00594"></a>00594     gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>, <span class="stringliteral">&quot;gp_stroke_points&quot;</span>);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596     <span class="comment">/* set pointer to first non-initialized point */</span>
<a name="l00597"></a>00597     pt= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a> + (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a41d64e907d93a316f1b41e35cabf13c6">totelem</a>);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="comment">/* copy points from the buffer to the stroke */</span>
<a name="l00600"></a>00600     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>) {
<a name="l00601"></a>00601         <span class="comment">/* straight lines only -&gt; only endpoints */</span>
<a name="l00602"></a>00602         {
<a name="l00603"></a>00603             <span class="comment">/* first point */</span>
<a name="l00604"></a>00604             ptc= gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>;
<a name="l00605"></a>00605             
<a name="l00606"></a>00606             <span class="comment">/* convert screen-coordinates to appropriate coordinates (and store them) */</span>
<a name="l00607"></a>00607             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a>(p, &amp;ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00608"></a>00608             
<a name="l00609"></a>00609             <span class="comment">/* copy pressure */</span>
<a name="l00610"></a>00610             pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a19dbfae864672c65b28bf1420d5095dd">pressure</a>= ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>;
<a name="l00611"></a>00611             
<a name="l00612"></a>00612             pt++;
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614             
<a name="l00615"></a>00615         <span class="keywordflow">if</span> (totelem == 2) {
<a name="l00616"></a>00616             <span class="comment">/* last point if applicable */</span>
<a name="l00617"></a>00617             ptc= ((<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a> *)gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) + (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> - 1);
<a name="l00618"></a>00618             
<a name="l00619"></a>00619             <span class="comment">/* convert screen-coordinates to appropriate coordinates (and store them) */</span>
<a name="l00620"></a>00620             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a>(p, &amp;ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00621"></a>00621             
<a name="l00622"></a>00622             <span class="comment">/* copy pressure */</span>
<a name="l00623"></a>00623             pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a19dbfae864672c65b28bf1420d5095dd">pressure</a>= ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>;
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>) {
<a name="l00627"></a>00627         <span class="comment">/* first point */</span>
<a name="l00628"></a>00628         ptc= gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630         <span class="comment">/* convert screen-coordinates to appropriate coordinates (and store them) */</span>
<a name="l00631"></a>00631         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a>(p, &amp;ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">/* copy pressure */</span>
<a name="l00634"></a>00634         pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a19dbfae864672c65b28bf1420d5095dd">pressure</a>= ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>;
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636     <span class="keywordflow">else</span> {
<a name="l00637"></a>00637         <span class="keywordtype">float</span> *depth_arr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00638"></a>00638         
<a name="l00639"></a>00639         <span class="comment">/* get an array of depths, far depths are blended */</span>
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">gpencil_project_check</a>(p)) {
<a name="l00641"></a>00641             <span class="keywordtype">int</span> mval[2], mval_prev[2]= {0};
<a name="l00642"></a>00642             <span class="keywordtype">int</span> interp_depth = 0;
<a name="l00643"></a>00643             <span class="keywordtype">int</span> found_depth = 0;
<a name="l00644"></a>00644             
<a name="l00645"></a>00645             depth_arr= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>, <span class="stringliteral">&quot;depth_points&quot;</span>);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647             <span class="keywordflow">for</span> (i=0, ptc=gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>; i &lt; gpd-&gt;sbuffer_size; i++, ptc++, pt++) {
<a name="l00648"></a>00648                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(mval, &amp;ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a54119a60d54afcd9accabc6799d25e49">ED_view3d_autodist_depth</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, mval, depth_margin, depth_arr+i) == 0) &amp;&amp;
<a name="l00651"></a>00651                     (i &amp;&amp; (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad562bc41b6afbbfaf0e6644acd93dfbc">ED_view3d_autodist_depth_seg</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, mval, mval_prev, depth_margin + 1, depth_arr+i) == 0))
<a name="l00652"></a>00652                 ) {
<a name="l00653"></a>00653                     interp_depth= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00654"></a>00654                 }
<a name="l00655"></a>00655                 <span class="keywordflow">else</span> {
<a name="l00656"></a>00656                     found_depth= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00657"></a>00657                 }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a61f53fd66f5167cc8e68279a88d719a0">copy_v2_v2_int</a>(mval_prev, mval);
<a name="l00660"></a>00660             }
<a name="l00661"></a>00661             
<a name="l00662"></a>00662             <span class="keywordflow">if</span> (found_depth == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00663"></a>00663                 <span class="comment">/* eeh... not much we can do.. :/, ignore depth in this case, use the 3D cursor */</span>
<a name="l00664"></a>00664                 <span class="keywordflow">for</span> (i=gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>-1; i &gt;= 0; i--)
<a name="l00665"></a>00665                     depth_arr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0.9999f;
<a name="l00666"></a>00666             }
<a name="l00667"></a>00667             <span class="keywordflow">else</span> {
<a name="l00668"></a>00668                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#ab4d2f5058c094dffc0009bd91a79c1ef">GP_DATA_DEPTH_STROKE_ENDPOINTS</a>) {
<a name="l00669"></a>00669                     <span class="comment">/* remove all info between the valid endpoints */</span>
<a name="l00670"></a>00670                     <span class="keywordtype">int</span> first_valid = 0;
<a name="l00671"></a>00671                     <span class="keywordtype">int</span> last_valid = 0;
<a name="l00672"></a>00672                     
<a name="l00673"></a>00673                     <span class="keywordflow">for</span> (i=0; i &lt; gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>; i++) {
<a name="l00674"></a>00674                         <span class="keywordflow">if</span> (depth_arr[i] != <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>)
<a name="l00675"></a>00675                             <span class="keywordflow">break</span>;
<a name="l00676"></a>00676                     }
<a name="l00677"></a>00677                     first_valid= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00678"></a>00678                     
<a name="l00679"></a>00679                     <span class="keywordflow">for</span> (i=gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>-1; i &gt;= 0; i--) {
<a name="l00680"></a>00680                         <span class="keywordflow">if</span> (depth_arr[i] != <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>)
<a name="l00681"></a>00681                             <span class="keywordflow">break</span>;
<a name="l00682"></a>00682                     }
<a name="l00683"></a>00683                     last_valid= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00684"></a>00684                     
<a name="l00685"></a>00685                     <span class="comment">/* invalidate non-endpoints, so only blend between first and last */</span>
<a name="l00686"></a>00686                     <span class="keywordflow">for</span> (i=first_valid+1; i &lt; last_valid; i++)
<a name="l00687"></a>00687                         depth_arr[i]= <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00688"></a>00688                     
<a name="l00689"></a>00689                     interp_depth= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00690"></a>00690                 }
<a name="l00691"></a>00691                 
<a name="l00692"></a>00692                 <span class="keywordflow">if</span> (interp_depth) {
<a name="l00693"></a>00693                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3d69a68d0af9dbd05ccf8af4a86bef2d">interp_sparse_array</a>(depth_arr, gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>, <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>);
<a name="l00694"></a>00694                 }
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697         
<a name="l00698"></a>00698         
<a name="l00699"></a>00699         pt= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>;
<a name="l00700"></a>00700         
<a name="l00701"></a>00701         <span class="comment">/* convert all points (normal behavior) */</span>
<a name="l00702"></a>00702         <span class="keywordflow">for</span> (i=0, ptc=gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>; i &lt; gpd-&gt;sbuffer_size &amp;&amp; ptc; i++, ptc++, pt++) {
<a name="l00703"></a>00703             <span class="comment">/* convert screen-coordinates to appropriate coordinates (and store them) */</span>
<a name="l00704"></a>00704             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3522cfa3f19c0d0bf9707b8d977c50a1">gp_stroke_convertcoords</a>(p, &amp;ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#ac6e8fe844d135d7fff3bb409bd76ecdd">x</a>, &amp;pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, depth_arr ? depth_arr+i:<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00705"></a>00705             
<a name="l00706"></a>00706             <span class="comment">/* copy pressure */</span>
<a name="l00707"></a>00707             pt-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a19dbfae864672c65b28bf1420d5095dd">pressure</a>= ptc-&gt;<a class="code" href="../../d1/d5d/structtGPspoint.html#a4da6ecd5c8aa96bed2b6279ac763a38d">pressure</a>;
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         
<a name="l00710"></a>00710         <span class="keywordflow">if</span> (depth_arr)
<a name="l00711"></a>00711             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(depth_arr);
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713     
<a name="l00714"></a>00714     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> |= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a7f3a3004dd6c590b1f9ae3a0bc2da7ad">GP_PAINTFLAG_STROKEADDED</a>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="comment">/* add stroke to frame */</span>
<a name="l00717"></a>00717     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>, gps);
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 <span class="comment">/* --- &#39;Eraser&#39; for &#39;Paint&#39; Tool ------ */</span>
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="comment">/* eraser tool - remove segment from stroke/split stroke (after lasso inside) */</span>
<a name="l00723"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#aa78572c93d22e67948ed24da1829d167">00723</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#aa78572c93d22e67948ed24da1829d167">gp_stroke_eraser_splitdel</a> (<a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf, <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gps, <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725     <a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a> *pt_tmp= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>;
<a name="l00726"></a>00726     <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gsn = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <span class="comment">/* if stroke only had two points, get rid of stroke */</span>
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> == 2) {
<a name="l00730"></a>00730         <span class="comment">/* free stroke points, then stroke */</span>
<a name="l00731"></a>00731         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pt_tmp);
<a name="l00732"></a>00732         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>, gps);
<a name="l00733"></a>00733         
<a name="l00734"></a>00734         <span class="comment">/* nothing left in stroke, so stop */</span>
<a name="l00735"></a>00735         <span class="keywordflow">return</span> 1;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">/* if last segment, just remove segment from the stroke */</span>
<a name="l00739"></a>00739     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> - 2) {
<a name="l00740"></a>00740         <span class="comment">/* allocate new points array, and assign most of the old stroke there */</span>
<a name="l00741"></a>00741         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>--;
<a name="l00742"></a>00742         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>, <span class="stringliteral">&quot;gp_stroke_points&quot;</span>);
<a name="l00743"></a>00743         memcpy(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>, pt_tmp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>);
<a name="l00744"></a>00744         
<a name="l00745"></a>00745         <span class="comment">/* free temp buffer */</span>
<a name="l00746"></a>00746         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pt_tmp);
<a name="l00747"></a>00747         
<a name="l00748"></a>00748         <span class="comment">/* nothing left in stroke, so stop */</span>
<a name="l00749"></a>00749         <span class="keywordflow">return</span> 1;
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752     <span class="comment">/* if first segment, just remove segment from the stroke */</span>
<a name="l00753"></a>00753     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0) {
<a name="l00754"></a>00754         <span class="comment">/* allocate new points array, and assign most of the old stroke there */</span>
<a name="l00755"></a>00755         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>--;
<a name="l00756"></a>00756         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>, <span class="stringliteral">&quot;gp_stroke_points&quot;</span>);
<a name="l00757"></a>00757         memcpy(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>, pt_tmp + 1, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>);
<a name="l00758"></a>00758         
<a name="l00759"></a>00759         <span class="comment">/* free temp buffer */</span>
<a name="l00760"></a>00760         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pt_tmp);
<a name="l00761"></a>00761         
<a name="l00762"></a>00762         <span class="comment">/* no break here, as there might still be stuff to remove in this stroke */</span>
<a name="l00763"></a>00763         <span class="keywordflow">return</span> 0;
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     <span class="comment">/* segment occurs in &#39;middle&#39; of stroke, so split */</span>
<a name="l00767"></a>00767     <span class="keywordflow">else</span> {
<a name="l00768"></a>00768         <span class="comment">/* duplicate stroke, and assign &#39;later&#39; data to that stroke */</span>
<a name="l00769"></a>00769         gsn= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(gps);
<a name="l00770"></a>00770         gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a26047bb6e0a36dacb47d55ccf70c898a">prev</a>= gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#aeec4e6a65ac743fd5a2a3ede11f2f85e">next</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00771"></a>00771         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a9c299678f8810312806da26e6132ccc7">BLI_insertlinkafter</a>(&amp;gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>, gps, gsn);
<a name="l00772"></a>00772         
<a name="l00773"></a>00773         gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> - <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00774"></a>00774         gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>, <span class="stringliteral">&quot;gp_stroke_points&quot;</span>);
<a name="l00775"></a>00775         memcpy(gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>, pt_tmp + i, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gsn-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>);
<a name="l00776"></a>00776         
<a name="l00777"></a>00777         <span class="comment">/* adjust existing stroke  */</span>
<a name="l00778"></a>00778         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>= <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00779"></a>00779         gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>, <span class="stringliteral">&quot;gp_stroke_points&quot;</span>);
<a name="l00780"></a>00780         memcpy(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>, pt_tmp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a>)*i);
<a name="l00781"></a>00781         
<a name="l00782"></a>00782         <span class="comment">/* free temp buffer */</span>
<a name="l00783"></a>00783         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pt_tmp);
<a name="l00784"></a>00784         
<a name="l00785"></a>00785         <span class="comment">/* nothing left in stroke, so stop */</span>
<a name="l00786"></a>00786         <span class="keywordflow">return</span> 1;
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">/* eraser tool - check if part of stroke occurs within last segment drawn by eraser */</span>
<a name="l00791"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a5f1b26010f6bf8eb85bc8cd70f19772c">00791</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a5f1b26010f6bf8eb85bc8cd70f19772c">gp_stroke_eraser_strokeinside</a> (<span class="keywordtype">int</span> mval[], <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(mvalo[]), <span class="keywordtype">short</span> rad, <span class="keywordtype">short</span> x0, <span class="keywordtype">short</span> y0, <span class="keywordtype">short</span> x1, <span class="keywordtype">short</span> y1)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     <span class="comment">/* simple within-radius check for now */</span>
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a6a58fc5fd283afc4ff383ea12e5f8e17">edge_inside_circle</a>(mval[0], mval[1], rad, x0, y0, x1, y1))
<a name="l00795"></a>00795         <span class="keywordflow">return</span> 1;
<a name="l00796"></a>00796     
<a name="l00797"></a>00797     <span class="comment">/* not inside */</span>
<a name="l00798"></a>00798     <span class="keywordflow">return</span> 0;
<a name="l00799"></a>00799 } 
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 <span class="comment">/* eraser tool - evaluation per stroke */</span>
<a name="l00802"></a>00802 <span class="comment">// TODO: this could really do with some optimization (KD-Tree/BVH?)</span>
<a name="l00803"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a9e8a280afa482c299eec2ff6b8fbf343">00803</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a9e8a280afa482c299eec2ff6b8fbf343">gp_stroke_eraser_dostroke</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">int</span> mval[], <span class="keywordtype">int</span> mvalo[], <span class="keywordtype">short</span> rad, <a class="code" href="../../d0/d28/structrcti.html">rcti</a> *rect, <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf, <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gps)
<a name="l00804"></a>00804 {
<a name="l00805"></a>00805     <a class="code" href="../../d2/da9/structbGPDspoint.html">bGPDspoint</a> *pt1, *pt2;
<a name="l00806"></a>00806     <span class="keywordtype">int</span> x0=0, y0=0, x1=0, y1=0;
<a name="l00807"></a>00807     <span class="keywordtype">int</span> xyval[2];
<a name="l00808"></a>00808     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00809"></a>00809     
<a name="l00810"></a>00810     <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> == 0) {
<a name="l00811"></a>00811         <span class="comment">/* just free stroke */</span>
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>) 
<a name="l00813"></a>00813             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>);
<a name="l00814"></a>00814         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>, gps);
<a name="l00815"></a>00815     }
<a name="l00816"></a>00816     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a> == 1) {
<a name="l00817"></a>00817         <span class="comment">/* get coordinates */</span>
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a9dd7d3e1648c80abe3cd67be622a1087">GP_STROKE_3DSPACE</a>) {
<a name="l00819"></a>00819             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, &amp;gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, xyval);
<a name="l00820"></a>00820             x0= xyval[0];
<a name="l00821"></a>00821             y0= xyval[1];
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>) {           
<a name="l00824"></a>00824             <a class="code" href="../../d5/d63/UI__view2d_8h.html#accea1c4009d4c24471c1fcf6889fa6f5">UI_view2d_view_to_region</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>, gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a>, &amp;x0, &amp;y0);
<a name="l00825"></a>00825         }
<a name="l00826"></a>00826 <span class="preprocessor">#if 0</span>
<a name="l00827"></a>00827 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#af888e4e158b9676e4ad3d58579d9d13c">GP_STROKE_2DIMAGE</a>) {           
<a name="l00828"></a>00828             <span class="keywordtype">int</span> offsx, offsy, sizex, sizey;
<a name="l00829"></a>00829             
<a name="l00830"></a>00830             <span class="comment">/* get stored settings */</span>
<a name="l00831"></a>00831             sizex= p-&gt;im2d_settings.sizex;
<a name="l00832"></a>00832             sizey= p-&gt;im2d_settings.sizey;
<a name="l00833"></a>00833             offsx= p-&gt;im2d_settings.offsx;
<a name="l00834"></a>00834             offsy= p-&gt;im2d_settings.offsy;
<a name="l00835"></a>00835             
<a name="l00836"></a>00836             <span class="comment">/* calculate new points */</span>
<a name="l00837"></a>00837             x0= (int)((gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> * sizex) + offsx);
<a name="l00838"></a>00838             y0= (int)((gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> * sizey) + offsy);
<a name="l00839"></a>00839         }
<a name="l00840"></a>00840 <span class="preprocessor">#endif</span>
<a name="l00841"></a>00841 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
<a name="l00842"></a>00842             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { <span class="comment">/* normal 3D view */</span>
<a name="l00843"></a>00843                 x0= (int)(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>);
<a name="l00844"></a>00844                 y0= (int)(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>);
<a name="l00845"></a>00845             }
<a name="l00846"></a>00846             <span class="keywordflow">else</span> { <span class="comment">/* camera view, use subrect */</span>
<a name="l00847"></a>00847                 x0= (int)((gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00848"></a>00848                 y0= (int)((gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00849"></a>00849             }
<a name="l00850"></a>00850         }
<a name="l00851"></a>00851         
<a name="l00852"></a>00852         <span class="comment">/* do boundbox check first */</span>
<a name="l00853"></a>00853         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a1242dd13fb888a0146765107474fffb4">BLI_in_rcti</a>(rect, x0, y0)) {
<a name="l00854"></a>00854             <span class="comment">/* only check if point is inside */</span>
<a name="l00855"></a>00855             <span class="keywordflow">if</span> ( ((x0-mval[0])*(x0-mval[0]) + (y0-mval[1])*(y0-mval[1])) &lt;= rad*rad ) {
<a name="l00856"></a>00856                 <span class="comment">/* free stroke */</span>
<a name="l00857"></a>00857                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a>);
<a name="l00858"></a>00858                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>, gps);
<a name="l00859"></a>00859             }
<a name="l00860"></a>00860         }
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862     <span class="keywordflow">else</span> {  
<a name="l00863"></a>00863         <span class="comment">/* loop over the points in the stroke, checking for intersections </span>
<a name="l00864"></a>00864 <span class="comment">         *  - an intersection will require the stroke to be split</span>
<a name="l00865"></a>00865 <span class="comment">         */</span>
<a name="l00866"></a>00866         <span class="keywordflow">for</span> (i=0; (i+1) &lt; gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a6af828382e340e5590e3e39369e1ec6f">totpoints</a>; i++) {
<a name="l00867"></a>00867             <span class="comment">/* get points to work with */</span>
<a name="l00868"></a>00868             pt1= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00869"></a>00869             pt2= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#a3891196ee51074815ea4e3a4bed391d4">points</a> + i + 1;
<a name="l00870"></a>00870             
<a name="l00871"></a>00871             <span class="comment">/* get coordinates */</span>
<a name="l00872"></a>00872             <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a9dd7d3e1648c80abe3cd67be622a1087">GP_STROKE_3DSPACE</a>) {
<a name="l00873"></a>00873                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, &amp;pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, xyval);
<a name="l00874"></a>00874                 x0= xyval[0];
<a name="l00875"></a>00875                 y0= xyval[1];
<a name="l00876"></a>00876                 
<a name="l00877"></a>00877                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, &amp;pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, xyval);
<a name="l00878"></a>00878                 x1= xyval[0];
<a name="l00879"></a>00879                 y1= xyval[1];
<a name="l00880"></a>00880             }
<a name="l00881"></a>00881             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>) {
<a name="l00882"></a>00882                 <a class="code" href="../../d5/d63/UI__view2d_8h.html#accea1c4009d4c24471c1fcf6889fa6f5">UI_view2d_view_to_region</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>, pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a>, &amp;x0, &amp;y0);
<a name="l00883"></a>00883                 
<a name="l00884"></a>00884                 <a class="code" href="../../d5/d63/UI__view2d_8h.html#accea1c4009d4c24471c1fcf6889fa6f5">UI_view2d_view_to_region</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>, pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a>, pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a>, &amp;x1, &amp;y1);
<a name="l00885"></a>00885             }
<a name="l00886"></a>00886 <span class="preprocessor">#if 0</span>
<a name="l00887"></a>00887 <span class="preprocessor"></span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#ab5b3fa71d57d24ff323ca89dc6ab5043">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#af888e4e158b9676e4ad3d58579d9d13c">GP_STROKE_2DIMAGE</a>) {
<a name="l00888"></a>00888                 <span class="keywordtype">int</span> offsx, offsy, sizex, sizey;
<a name="l00889"></a>00889                 
<a name="l00890"></a>00890                 <span class="comment">/* get stored settings */</span>
<a name="l00891"></a>00891                 sizex= p-&gt;im2d_settings.sizex;
<a name="l00892"></a>00892                 sizey= p-&gt;im2d_settings.sizey;
<a name="l00893"></a>00893                 offsx= p-&gt;im2d_settings.offsx;
<a name="l00894"></a>00894                 offsy= p-&gt;im2d_settings.offsy;
<a name="l00895"></a>00895                 
<a name="l00896"></a>00896                 <span class="comment">/* calculate new points */</span>
<a name="l00897"></a>00897                 x0= (int)((pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> * sizex) + offsx);
<a name="l00898"></a>00898                 y0= (int)((pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> * sizey) + offsy);
<a name="l00899"></a>00899                 
<a name="l00900"></a>00900                 x1= (int)((pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> * sizex) + offsx);
<a name="l00901"></a>00901                 y1= (int)((pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> * sizey) + offsy);
<a name="l00902"></a>00902             }
<a name="l00903"></a>00903 <span class="preprocessor">#endif</span>
<a name="l00904"></a>00904 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) { <span class="comment">/* normal 3D view */</span>
<a name="l00906"></a>00906                     x0= (int)(pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>);
<a name="l00907"></a>00907                     y0= (int)(pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>);
<a name="l00908"></a>00908                     x1= (int)(pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>);
<a name="l00909"></a>00909                     y1= (int)(pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100 * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>);
<a name="l00910"></a>00910                 }
<a name="l00911"></a>00911                 <span class="keywordflow">else</span> { <span class="comment">/* camera view, use subrect */</span> 
<a name="l00912"></a>00912                     x0= (int)((pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00913"></a>00913                     y0= (int)((pt1-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00914"></a>00914                     x1= (int)((pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a07757596a1355d02f8172a85235652d1">x</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00915"></a>00915                     y1= (int)((pt2-&gt;<a class="code" href="../../d2/da9/structbGPDspoint.html#a8ff1f342e89c7b7589e7b345185c8fce">y</a> / 100) * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)) + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00916"></a>00916                 }
<a name="l00917"></a>00917             }
<a name="l00918"></a>00918             
<a name="l00919"></a>00919             <span class="comment">/* check that point segment of the boundbox of the eraser stroke */</span>
<a name="l00920"></a>00920             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a1242dd13fb888a0146765107474fffb4">BLI_in_rcti</a>(rect, x0, y0) || <a class="code" href="../../d5/d44/BLI__rect_8h.html#a1242dd13fb888a0146765107474fffb4">BLI_in_rcti</a>(rect, x1, y1)) {
<a name="l00921"></a>00921                 <span class="comment">/* check if point segment of stroke had anything to do with</span>
<a name="l00922"></a>00922 <span class="comment">                 * eraser region  (either within stroke painted, or on its lines)</span>
<a name="l00923"></a>00923 <span class="comment">                 *  - this assumes that linewidth is irrelevant</span>
<a name="l00924"></a>00924 <span class="comment">                 */</span>
<a name="l00925"></a>00925                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a5f1b26010f6bf8eb85bc8cd70f19772c">gp_stroke_eraser_strokeinside</a>(mval, mvalo, rad, x0, y0, x1, y1)) {
<a name="l00926"></a>00926                     <span class="comment">/* if function returns true, break this loop (as no more point to check) */</span>
<a name="l00927"></a>00927                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#aa78572c93d22e67948ed24da1829d167">gp_stroke_eraser_splitdel</a>(gpf, gps, i))
<a name="l00928"></a>00928                         <span class="keywordflow">break</span>;
<a name="l00929"></a>00929                 }
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931         }
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="comment">/* erase strokes which fall under the eraser strokes */</span>
<a name="l00936"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a494a55bc6b57c0f947316ea092d8d247">00936</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a494a55bc6b57c0f947316ea092d8d247">gp_stroke_doeraser</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <a class="code" href="../../d7/dcf/structbGPDframe.html">bGPDframe</a> *gpf= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>;
<a name="l00939"></a>00939     <a class="code" href="../../d8/d2d/structbGPDstroke.html">bGPDstroke</a> *gps, *gpn;
<a name="l00940"></a>00940     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> rect;
<a name="l00941"></a>00941     
<a name="l00942"></a>00942     <span class="comment">/* rect is rectangle of eraser */</span>
<a name="l00943"></a>00943     rect.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0] - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>;
<a name="l00944"></a>00944     rect.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1] - p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>;
<a name="l00945"></a>00945     rect.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0] + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>;
<a name="l00946"></a>00946     rect.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1] + p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>;
<a name="l00947"></a>00947     
<a name="l00948"></a>00948     <span class="comment">/* loop over strokes, checking segments for intersections */</span>
<a name="l00949"></a>00949     <span class="keywordflow">for</span> (gps= gpf-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#abfcf891752f8fbe98056b519135c52a2">strokes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; gps; gps= gpn) {
<a name="l00950"></a>00950         gpn= gps-&gt;<a class="code" href="../../d8/d2d/structbGPDstroke.html#aeec4e6a65ac743fd5a2a3ede11f2f85e">next</a>;
<a name="l00951"></a>00951         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a9e8a280afa482c299eec2ff6b8fbf343">gp_stroke_eraser_dostroke</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>, &amp;rect, gpf, gps);
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 <span class="comment">/* ******************************************* */</span>
<a name="l00956"></a>00956 <span class="comment">/* Sketching Operator */</span>
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="comment">/* clear the session buffers (call this before AND after a paint operation) */</span>
<a name="l00959"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">00959</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">gp_session_validatebuffer</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>;
<a name="l00962"></a>00962     
<a name="l00963"></a>00963     <span class="comment">/* clear memory of buffer (or allocate it if starting a new session) */</span>
<a name="l00964"></a>00964     <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) {
<a name="l00965"></a>00965         <span class="comment">//printf(&quot;\t\tGP - reset sbuffer\n&quot;);</span>
<a name="l00966"></a>00966         memset(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a>)*<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2df51ff1927fa0f65293f7a40d741ca4">GP_STROKE_BUFFER_MAX</a>);
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968     <span class="keywordflow">else</span> {
<a name="l00969"></a>00969         <span class="comment">//printf(&quot;\t\tGP - allocate sbuffer\n&quot;);</span>
<a name="l00970"></a>00970         gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5d/structtGPspoint.html">tGPspoint</a>)*<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2df51ff1927fa0f65293f7a40d741ca4">GP_STROKE_BUFFER_MAX</a>, <span class="stringliteral">&quot;gp_session_strokebuffer&quot;</span>);
<a name="l00971"></a>00971     }
<a name="l00972"></a>00972     
<a name="l00973"></a>00973     <span class="comment">/* reset indices */</span>
<a name="l00974"></a>00974     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a> = 0;
<a name="l00975"></a>00975     
<a name="l00976"></a>00976     <span class="comment">/* reset flags */</span>
<a name="l00977"></a>00977     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a>= 0;
<a name="l00978"></a>00978 }
<a name="l00979"></a>00979 
<a name="l00980"></a>00980 <span class="comment">/* (re)init new painting data */</span>
<a name="l00981"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab2bc6e27670e00974b39a54339a7891b">00981</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab2bc6e27670e00974b39a54339a7891b">gp_session_initdata</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> **gpd_ptr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00984"></a>00984     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *curarea= <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l00985"></a>00985     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar= <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00986"></a>00986     
<a name="l00987"></a>00987     <span class="comment">/* make sure the active view (at the starting time) is a 3d-view */</span>
<a name="l00988"></a>00988     <span class="keywordflow">if</span> (curarea == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00989"></a>00989         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l00990"></a>00990         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l00991"></a>00991             printf(<span class="stringliteral">&quot;Error: No active view for painting\n&quot;</span>);
<a name="l00992"></a>00992         <span class="keywordflow">return</span> 0;
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994     
<a name="l00995"></a>00995     <span class="comment">/* pass on current scene and window */</span>
<a name="l00996"></a>00996     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00997"></a>00997     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a5c5789b8d612565c1ff574acf3815abf">win</a>= <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C);
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#af2132776ee46a1493be565f144f06141">imat</a>);
<a name="l01000"></a>01000     
<a name="l01001"></a>01001     <span class="keywordflow">switch</span> (curarea-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a>) {
<a name="l01002"></a>01002         <span class="comment">/* supported views first */</span>
<a name="l01003"></a>01003         <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>:
<a name="l01004"></a>01004         {
<a name="l01005"></a>01005             <span class="comment">// View3D *v3d= curarea-&gt;spacedata.first;</span>
<a name="l01006"></a>01006             <span class="comment">// RegionView3D *rv3d= ar-&gt;regiondata;</span>
<a name="l01007"></a>01007             
<a name="l01008"></a>01008             <span class="comment">/* set current area </span>
<a name="l01009"></a>01009 <span class="comment">             *  - must verify that region data is 3D-view (and not something else)</span>
<a name="l01010"></a>01010 <span class="comment">             */</span>
<a name="l01011"></a>01011             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>= curarea;
<a name="l01012"></a>01012             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>= ar;
<a name="l01013"></a>01013             
<a name="l01014"></a>01014             <span class="keywordflow">if</span> (ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01015"></a>01015                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01016"></a>01016                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01017"></a>01017                     printf(<span class="stringliteral">&quot;Error: 3D-View active region doesn&#39;t have any region data, so cannot be drawable\n&quot;</span>);
<a name="l01018"></a>01018                 <span class="keywordflow">return</span> 0;
<a name="l01019"></a>01019             }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor">#if 0 // XXX will this sort of antiquated stuff be restored?</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>            <span class="comment">/* check that gpencil data is allowed to be drawn */</span>
<a name="l01023"></a>01023             <span class="keywordflow">if</span> ((v3d-&gt;flag2 &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a60d9805a7770386f3b587f599083ec80">V3D_DISPGP</a>)==0) {
<a name="l01024"></a>01024                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01025"></a>01025                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01026"></a>01026                     printf(<span class="stringliteral">&quot;Error: In active view, Grease Pencil not shown\n&quot;</span>);
<a name="l01027"></a>01027                 <span class="keywordflow">return</span> 0;
<a name="l01028"></a>01028             }
<a name="l01029"></a>01029 <span class="preprocessor">#endif</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>        }
<a name="l01031"></a>01031             <span class="keywordflow">break</span>;
<a name="l01032"></a>01032 
<a name="l01033"></a>01033         <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca2ef41082c072d92dbf2d57e20442751d">SPACE_NODE</a>:
<a name="l01034"></a>01034         {
<a name="l01035"></a>01035             <span class="comment">//SpaceNode *snode= curarea-&gt;spacedata.first;</span>
<a name="l01036"></a>01036             
<a name="l01037"></a>01037             <span class="comment">/* set current area */</span>
<a name="l01038"></a>01038             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>= curarea;
<a name="l01039"></a>01039             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>= ar;
<a name="l01040"></a>01040             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>= &amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>;
<a name="l01041"></a>01041             
<a name="l01042"></a>01042 <span class="preprocessor">#if 0 // XXX will this sort of antiquated stuff be restored?</span>
<a name="l01043"></a>01043 <span class="preprocessor"></span>            <span class="comment">/* check that gpencil data is allowed to be drawn */</span>
<a name="l01044"></a>01044             <span class="keywordflow">if</span> ((snode-&gt;flag &amp; <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5c7b6c6011859ce4e315fe4537482542">SNODE_DISPGP</a>)==0) {
<a name="l01045"></a>01045                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01046"></a>01046                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01047"></a>01047                     printf(<span class="stringliteral">&quot;Error: In active view, Grease Pencil not shown\n&quot;</span>);
<a name="l01048"></a>01048                 <span class="keywordflow">return</span> 0;
<a name="l01049"></a>01049             }
<a name="l01050"></a>01050 <span class="preprocessor">#endif</span>
<a name="l01051"></a>01051 <span class="preprocessor"></span>        }
<a name="l01052"></a>01052             <span class="keywordflow">break</span>;
<a name="l01053"></a>01053 <span class="preprocessor">#if 0 // XXX these other spaces will come over time...</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caa78bb4ba1705225aa14af78400406414">SPACE_SEQ</a>:
<a name="l01055"></a>01055         {
<a name="l01056"></a>01056             <a class="code" href="../../df/d05/structSpaceSeq.html">SpaceSeq</a> *sseq= curarea-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01057"></a>01057             
<a name="l01058"></a>01058             <span class="comment">/* set current area */</span>
<a name="l01059"></a>01059             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>= curarea;
<a name="l01060"></a>01060             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>= ar;
<a name="l01061"></a>01061             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>= &amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>;
<a name="l01062"></a>01062             
<a name="l01063"></a>01063             <span class="comment">/* check that gpencil data is allowed to be drawn */</span>
<a name="l01064"></a>01064             <span class="keywordflow">if</span> (sseq-&gt;<a class="code" href="../../df/d05/structSpaceSeq.html#a1690fabe7e2ef701c6a63ed2b2406840">mainb</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a96a14c1d0d09435eec4c738a35bd37a9">SEQ_DRAW_SEQUENCE</a>) {
<a name="l01065"></a>01065                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01066"></a>01066                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01067"></a>01067                     printf(<span class="stringliteral">&quot;Error: In active view (sequencer), active mode doesn&#39;t support Grease Pencil\n&quot;</span>);
<a name="l01068"></a>01068                 <span class="keywordflow">return</span> 0;
<a name="l01069"></a>01069             }
<a name="l01070"></a>01070             <span class="keywordflow">if</span> ((sseq-&gt;<a class="code" href="../../df/d05/structSpaceSeq.html#aca0b0fbbe6d90b6142f329dc071ec048">flag</a> &amp; <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a3fe96f84cac6771a0de423b4494f5a30">SEQ_DRAW_GPENCIL</a>)==0) {
<a name="l01071"></a>01071                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01072"></a>01072                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01073"></a>01073                     printf(<span class="stringliteral">&quot;Error: In active view, Grease Pencil not shown\n&quot;</span>);
<a name="l01074"></a>01074                 <span class="keywordflow">return</span> 0;
<a name="l01075"></a>01075             }
<a name="l01076"></a>01076         }
<a name="l01077"></a>01077             <span class="keywordflow">break</span>;  
<a name="l01078"></a>01078 <span class="preprocessor">#endif</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>:
<a name="l01080"></a>01080         {
<a name="l01081"></a>01081             <span class="comment">//SpaceImage *sima= curarea-&gt;spacedata.first;</span>
<a name="l01082"></a>01082             
<a name="l01083"></a>01083             <span class="comment">/* set the current area */</span>
<a name="l01084"></a>01084             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>= curarea;
<a name="l01085"></a>01085             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>= ar;
<a name="l01086"></a>01086             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>= &amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>;
<a name="l01087"></a>01087             <span class="comment">//p-&gt;ibuf= BKE_image_get_ibuf(sima-&gt;image, &amp;sima-&gt;iuser);</span>
<a name="l01088"></a>01088             
<a name="l01089"></a>01089 <span class="preprocessor">#if 0 // XXX disabled for now</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span>            <span class="comment">/* check that gpencil data is allowed to be drawn */</span>
<a name="l01091"></a>01091             <span class="keywordflow">if</span> ((sima-&gt;flag &amp; <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a8c28bdfe0e0ded4e840fe4550dd2a59d">SI_DISPGP</a>)==0) {
<a name="l01092"></a>01092                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01093"></a>01093                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01094"></a>01094                     printf(<span class="stringliteral">&quot;Error: In active view, Grease Pencil not shown\n&quot;</span>);
<a name="l01095"></a>01095                 <span class="keywordflow">return</span> 0;
<a name="l01096"></a>01096             }
<a name="l01097"></a>01097 <span class="preprocessor">#endif</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span>        }
<a name="l01099"></a>01099             <span class="keywordflow">break</span>;
<a name="l01100"></a>01100         <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca02bf62758ff66d33c28826738012179d">SPACE_CLIP</a>:
<a name="l01101"></a>01101         {
<a name="l01102"></a>01102             <a class="code" href="../../dc/dd5/structSpaceClip.html">SpaceClip</a> *sc= curarea-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104             <span class="comment">/* set the current area */</span>
<a name="l01105"></a>01105             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>= curarea;
<a name="l01106"></a>01106             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>= ar;
<a name="l01107"></a>01107             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9ac4b03ca3b70789f027a99925bd0a63">v2d</a>= &amp;ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a3abcb927aedd966f98e3417897e2c243">v2d</a>;
<a name="l01108"></a>01108             <span class="comment">//p-&gt;ibuf= BKE_image_get_ibuf(sima-&gt;image, &amp;sima-&gt;iuser);</span>
<a name="l01109"></a>01109 
<a name="l01110"></a>01110             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#af2132776ee46a1493be565f144f06141">imat</a>, sc-&gt;<a class="code" href="../../dc/dd5/structSpaceClip.html#a703b3e170ef0f5b7379f020b42872458">unistabmat</a>);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112             <span class="comment">/* custom color for new layer */</span>
<a name="l01113"></a>01113             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[0]= 1.0f;
<a name="l01114"></a>01114             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[1]= 0.0f;
<a name="l01115"></a>01115             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[2]= 0.5f;
<a name="l01116"></a>01116             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[3]= 0.9f;
<a name="l01117"></a>01117         }
<a name="l01118"></a>01118             <span class="keywordflow">break</span>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120         <span class="comment">/* unsupported views */</span>
<a name="l01121"></a>01121         <span class="keywordflow">default</span>:
<a name="l01122"></a>01122         {
<a name="l01123"></a>01123             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01124"></a>01124             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01125"></a>01125                 printf(<span class="stringliteral">&quot;Error: Active view not appropriate for Grease Pencil drawing\n&quot;</span>);
<a name="l01126"></a>01126             <span class="keywordflow">return</span> 0;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128             <span class="keywordflow">break</span>;
<a name="l01129"></a>01129     }
<a name="l01130"></a>01130     
<a name="l01131"></a>01131     <span class="comment">/* get gp-data */</span>
<a name="l01132"></a>01132     gpd_ptr= <a class="code" href="../../dd/d13/gpencil__edit_8c.html#ac2d9a15a8bf2418b19c1e5b7101fd7a2">gpencil_data_get_pointers</a>(C, &amp;p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a4568c66f455aca073f275f6171d06648">ownerPtr</a>);
<a name="l01133"></a>01133     <span class="keywordflow">if</span> (gpd_ptr == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01134"></a>01134         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01136"></a>01136             printf(<span class="stringliteral">&quot;Error: Current context doesn&#39;t allow for any Grease Pencil data\n&quot;</span>);
<a name="l01137"></a>01137         <span class="keywordflow">return</span> 0;
<a name="l01138"></a>01138     }
<a name="l01139"></a>01139     <span class="keywordflow">else</span> {
<a name="l01140"></a>01140         <span class="comment">/* if no existing GPencil block exists, add one */</span>
<a name="l01141"></a>01141         <span class="keywordflow">if</span> (*gpd_ptr == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01142"></a>01142             *gpd_ptr= <a class="code" href="../../da/df0/BKE__gpencil_8h.html#a9fe0f187ec9a3de592f34ba8204710ee">gpencil_data_addnew</a>(<span class="stringliteral">&quot;GPencil&quot;</span>);
<a name="l01143"></a>01143         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>= *gpd_ptr;
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d8f/gpencil__undo_8c.html#a67414a9863ddd079f85ac56f091d3e2f">ED_gpencil_session_active</a>()==0) {
<a name="l01147"></a>01147         <span class="comment">/* initialize undo stack,</span>
<a name="l01148"></a>01148 <span class="comment">         * also, existing undo stack would make buffer drawn */</span>
<a name="l01149"></a>01149         <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a07db7e5eb2a7cc7c637f4a73198385f5">gpencil_undo_init</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>);
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151     
<a name="l01152"></a>01152     <span class="comment">/* clear out buffer (stored in gp-data), in case something contaminated it */</span>
<a name="l01153"></a>01153     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">gp_session_validatebuffer</a>(p);
<a name="l01154"></a>01154     
<a name="l01155"></a>01155 <span class="preprocessor">#if 0</span>
<a name="l01156"></a>01156 <span class="preprocessor"></span>    <span class="comment">/* set &#39;default&#39; im2d_settings just in case something that uses this doesn&#39;t set it */</span>
<a name="l01157"></a>01157     p-&gt;im2d_settings.sizex= 1;
<a name="l01158"></a>01158     p-&gt;im2d_settings.sizey= 1;
<a name="l01159"></a>01159 <span class="preprocessor">#endif</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span>
<a name="l01161"></a>01161     <span class="keywordflow">return</span> 1;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 <span class="comment">/* init new painting session */</span>
<a name="l01165"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a7d55d4978dc58b4f22c0e06cc8f2afcc">01165</a> <span class="keyword">static</span> <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a7d55d4978dc58b4f22c0e06cc8f2afcc">gp_session_initpaint</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="comment">/* create new context data */</span>
<a name="l01170"></a>01170     p= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a>), <span class="stringliteral">&quot;GPencil Drawing Data&quot;</span>);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab2bc6e27670e00974b39a54339a7891b">gp_session_initdata</a>(C, p);
<a name="l01173"></a>01173     
<a name="l01174"></a>01174     <span class="comment">/* return context data for running paint operator */</span>
<a name="l01175"></a>01175     <span class="keywordflow">return</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01176"></a>01176 }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178 <span class="comment">/* cleanup after a painting session */</span>
<a name="l01179"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#ac3b6d78824f6e8a4af07184b0efe2032">01179</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ac3b6d78824f6e8a4af07184b0efe2032">gp_session_cleanup</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01180"></a>01180 {
<a name="l01181"></a>01181     <a class="code" href="../../dd/d52/structbGPdata.html">bGPdata</a> *gpd= (<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>) ? p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01182"></a>01182     
<a name="l01183"></a>01183     <span class="comment">/* error checking */</span>
<a name="l01184"></a>01184     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (gpd == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01185"></a>01185         <span class="keywordflow">return</span>;
<a name="l01186"></a>01186     
<a name="l01187"></a>01187     <span class="comment">/* free stroke buffer */</span>
<a name="l01188"></a>01188     <span class="keywordflow">if</span> (gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>) {
<a name="l01189"></a>01189         <span class="comment">//printf(&quot;\t\tGP - free sbuffer\n&quot;);</span>
<a name="l01190"></a>01190         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>);
<a name="l01191"></a>01191         gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#aa9db6076fff73f7036fd5ef7df652f57">sbuffer</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01192"></a>01192     }
<a name="l01193"></a>01193     
<a name="l01194"></a>01194     <span class="comment">/* clear flags */</span>
<a name="l01195"></a>01195     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#ae924cfd0e5e06ec06bfbf340b75f305c">sbuffer_size</a>= 0;
<a name="l01196"></a>01196     gpd-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a>= 0;
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="comment">/* init new stroke */</span>
<a name="l01200"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a333aa2de21dc3da24327d32ef3a5c5fb">01200</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a333aa2de21dc3da24327d32ef3a5c5fb">gp_paint_initstroke</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <span class="keywordtype">short</span> paintmode)
<a name="l01201"></a>01201 {   
<a name="l01202"></a>01202     <span class="comment">/* get active layer (or add a new one if non-existent) */</span>
<a name="l01203"></a>01203     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>= <a class="code" href="../../da/df0/BKE__gpencil_8h.html#aba6a49d3fb59896e03b341306b8eaf71">gpencil_layer_getactive</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>);
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01205"></a>01205         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>= <a class="code" href="../../da/df0/BKE__gpencil_8h.html#a0a50e64a9d66fc68422a7338e95459a8">gpencil_layer_addnew</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>[3])
<a name="l01208"></a>01208             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#a1eb88e913670beeb80bc2a72423f8edb">color</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a9cf91078dcbd7afa8905b23823a1a5a5">custom_color</a>);
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>-&gt;<a class="code" href="../../da/d7e/structbGPDlayer.html#aed047c52577f6e0e3560c80bb65e1359">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a1bb3a52d41441645b284a37edf6114de">GP_LAYER_LOCKED</a>) {
<a name="l01211"></a>01211         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01212"></a>01212         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01213"></a>01213             printf(<span class="stringliteral">&quot;Error: Cannot paint on locked layer\n&quot;</span>);
<a name="l01214"></a>01214         <span class="keywordflow">return</span>;
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216         
<a name="l01217"></a>01217     <span class="comment">/* get active frame (add a new one if not matching frame) */</span>
<a name="l01218"></a>01218     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>= <a class="code" href="../../da/df0/BKE__gpencil_8h.html#a17486f39ff094d731afe33bcf6780c16">gpencil_layer_getframe</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>, 1);
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01220"></a>01220         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01221"></a>01221         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01222"></a>01222             printf(<span class="stringliteral">&quot;Error: No frame created (gpencil_paint_init)\n&quot;</span>);
<a name="l01223"></a>01223         <span class="keywordflow">return</span>;
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225     <span class="keywordflow">else</span>
<a name="l01226"></a>01226         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#ab649348d35f3a7e3b0c4942ccfee5c1f">flag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a27a62c89a0bd5ff69c7435b6b0cd5470">GP_FRAME_PAINT</a>;
<a name="l01227"></a>01227     
<a name="l01228"></a>01228     <span class="comment">/* set &#39;eraser&#39; for this stroke if using eraser */</span>
<a name="l01229"></a>01229     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>= paintmode;
<a name="l01230"></a>01230     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>)
<a name="l01231"></a>01231         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a5c69576e65da3f1f8a5e32235068b124">GP_STROKE_ERASER</a>;
<a name="l01232"></a>01232         
<a name="l01233"></a>01233     <span class="comment">/* set &#39;initial run&#39; flag, which is only used to denote when a new stroke is starting */</span>
<a name="l01234"></a>01234     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> |= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>;
<a name="l01235"></a>01235     
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <span class="comment">/* when drawing in the camera view, in 2D space, set the subrect */</span>
<a name="l01238"></a>01238     <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#adfc7186f4a8ded638b410777348e85fb">GP_DATA_VIEWALIGN</a>)) {
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l01240"></a>01240             <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01241"></a>01241             <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243             <span class="comment">/* for camera view set the subrect */</span>
<a name="l01244"></a>01244             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>) {
<a name="l01245"></a>01245                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a349ace3e118822009091d74b91175218">ED_view3d_calc_camera_border</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, v3d, rv3d, &amp;p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a510d3d61190470468bad334fa8144b2a">subrect_data</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>); <span class="comment">/* no shift */</span>
<a name="l01246"></a>01246                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a67cd5fd46a04e2a53dc68fd3847257a5">subrect</a>= &amp;p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a510d3d61190470468bad334fa8144b2a">subrect_data</a>;
<a name="l01247"></a>01247             }
<a name="l01248"></a>01248         }
<a name="l01249"></a>01249     }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251     <span class="comment">/* check if points will need to be made in view-aligned space */</span>
<a name="l01252"></a>01252     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#adfc7186f4a8ded638b410777348e85fb">GP_DATA_VIEWALIGN</a>) {
<a name="l01253"></a>01253         <span class="keywordflow">switch</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a>) {
<a name="l01254"></a>01254             <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>:
<a name="l01255"></a>01255             {
<a name="l01256"></a>01256                 <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01257"></a>01257                 <span class="keywordtype">float</span> rvec[3];
<a name="l01258"></a>01258                 
<a name="l01259"></a>01259                 <span class="comment">/* get reference point for 3d space placement */</span>
<a name="l01260"></a>01260                 <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a753e284e9181e106b10ac17266535dbd">gp_get_3d_reference</a>(p, rvec);
<a name="l01261"></a>01261                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a06acdefee150e80f06f802aeba637f6e">initgrabz</a>(rv3d, rvec[0], rvec[1], rvec[2]);
<a name="l01262"></a>01262                 
<a name="l01263"></a>01263                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a9dd7d3e1648c80abe3cd67be622a1087">GP_STROKE_3DSPACE</a>;
<a name="l01264"></a>01264             }
<a name="l01265"></a>01265                 <span class="keywordflow">break</span>;
<a name="l01266"></a>01266             
<a name="l01267"></a>01267             <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca2ef41082c072d92dbf2d57e20442751d">SPACE_NODE</a>:
<a name="l01268"></a>01268             {
<a name="l01269"></a>01269                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>;
<a name="l01270"></a>01270             }
<a name="l01271"></a>01271                 <span class="keywordflow">break</span>;
<a name="l01272"></a>01272 <span class="preprocessor">#if 0 // XXX other spacetypes to be restored in due course</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caa78bb4ba1705225aa14af78400406414">SPACE_SEQ</a>:
<a name="l01274"></a>01274             {
<a name="l01275"></a>01275                 <a class="code" href="../../df/d05/structSpaceSeq.html">SpaceSeq</a> *sseq= (<a class="code" href="../../df/d05/structSpaceSeq.html">SpaceSeq</a> *)p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01276"></a>01276                 <span class="keywordtype">int</span> rectx, recty;
<a name="l01277"></a>01277                 <span class="keywordtype">float</span> zoom, zoomx, zoomy;
<a name="l01278"></a>01278                 
<a name="l01279"></a>01279                 <span class="comment">/* set draw 2d-stroke flag */</span>
<a name="l01280"></a>01280                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#af888e4e158b9676e4ad3d58579d9d13c">GP_STROKE_2DIMAGE</a>;
<a name="l01281"></a>01281                 
<a name="l01282"></a>01282                 <span class="comment">/* calculate zoom factor */</span>
<a name="l01283"></a>01283                 zoom= (<span class="keywordtype">float</span>)(<a class="code" href="../../d0/d85/ED__sequencer_8h.html#ae7dff8d73b2d3e54c568816b9b367a9b">SEQ_ZOOM_FAC</a>(sseq-&gt;zoom));
<a name="l01284"></a>01284                 <span class="keywordflow">if</span> (sseq-&gt;<a class="code" href="../../df/d05/structSpaceSeq.html#a1690fabe7e2ef701c6a63ed2b2406840">mainb</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#ad5b89b5996803f2f045d524b8d5fad70">SEQ_DRAW_IMG_IMBUF</a>) {
<a name="l01285"></a>01285                     zoomx = zoom * (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a> / p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>);
<a name="l01286"></a>01286                     zoomy = zoom;
<a name="l01287"></a>01287                 } 
<a name="l01288"></a>01288                 <span class="keywordflow">else</span>
<a name="l01289"></a>01289                     zoomx = zoomy = zoom;
<a name="l01290"></a>01290                 
<a name="l01291"></a>01291                 <span class="comment">/* calculate rect size to use to calculate the size of the drawing area</span>
<a name="l01292"></a>01292 <span class="comment">                 *  - We use the size of the output image not the size of the ibuf being shown</span>
<a name="l01293"></a>01293 <span class="comment">                 *    as it is too messy getting the ibuf (and could be too slow). This should be</span>
<a name="l01294"></a>01294 <span class="comment">                 *    a reasonable for most cases anyway.</span>
<a name="l01295"></a>01295 <span class="comment">                 */</span>
<a name="l01296"></a>01296                 rectx= (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a> * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afac89783028ff848f111de04e0c29fbe">xsch</a>) / 100;
<a name="l01297"></a>01297                 recty= (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a> * p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aca3c1ebdf50a6c74730e19e24983217d">ysch</a>) / 100; 
<a name="l01298"></a>01298                 
<a name="l01299"></a>01299                 <span class="comment">/* set offset and scale values for opertations to use */</span>
<a name="l01300"></a>01300                 p-&gt;im2d_settings.sizex= (int)(zoomx * rectx);
<a name="l01301"></a>01301                 p-&gt;im2d_settings.sizey= (int)(zoomy * recty);
<a name="l01302"></a>01302                 p-&gt;im2d_settings.offsx= (int)((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a8875e00cdc1e130b8267c63b9cc0558e">winx</a>-p-&gt;im2d_settings.sizex)/2 + sseq-&gt;xof);
<a name="l01303"></a>01303                 p-&gt;im2d_settings.offsy= (int)((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a9bf030bfae8e6e6ff63acd63f0d499df">winy</a>-p-&gt;im2d_settings.sizey)/2 + sseq-&gt;yof);
<a name="l01304"></a>01304             }
<a name="l01305"></a>01305                 <span class="keywordflow">break</span>;
<a name="l01306"></a>01306 <span class="preprocessor">#endif</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752cab0433b569331024d6cf6123194fc10a2">SPACE_IMAGE</a>:
<a name="l01308"></a>01308             {
<a name="l01309"></a>01309                 <a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *sima= (<a class="code" href="../../db/d0f/structSpaceImage.html">SpaceImage</a> *)p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01310"></a>01310                 
<a name="l01311"></a>01311                 <span class="comment">/* only set these flags if the image editor doesn&#39;t have an image active,</span>
<a name="l01312"></a>01312 <span class="comment">                 * otherwise user will be confused by strokes not appearing after they&#39;re drawn</span>
<a name="l01313"></a>01313 <span class="comment">                 *</span>
<a name="l01314"></a>01314 <span class="comment">                 * Admittedly, this is a bit hacky, but it works much nicer from an ergonomic standpoint!</span>
<a name="l01315"></a>01315 <span class="comment">                 */</span>
<a name="l01316"></a>01316                 <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, sima, sima-&gt;<a class="code" href="../../db/d0f/structSpaceImage.html#abcf13b6f77c9da7cf19c58a26c9a6006">image</a>)) {
<a name="l01317"></a>01317                     <span class="comment">/* make strokes be drawn in screen space */</span>
<a name="l01318"></a>01318                     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp;= ~<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>;
<a name="l01319"></a>01319                     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp;= ~<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#adfc7186f4a8ded638b410777348e85fb">GP_DATA_VIEWALIGN</a>;
<a name="l01320"></a>01320                 }   
<a name="l01321"></a>01321                 <span class="keywordflow">else</span>
<a name="l01322"></a>01322                     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>;
<a name="l01323"></a>01323             }
<a name="l01324"></a>01324                 <span class="keywordflow">break</span>;
<a name="l01325"></a>01325                 
<a name="l01326"></a>01326             <span class="keywordflow">case</span> <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752ca02bf62758ff66d33c28826738012179d">SPACE_CLIP</a>:
<a name="l01327"></a>01327             {
<a name="l01328"></a>01328                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> |= <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#aa0455c790fc4603575475beb9af7e3f8">GP_STROKE_2DSPACE</a>;
<a name="l01329"></a>01329             }
<a name="l01330"></a>01330                 <span class="keywordflow">break</span>;
<a name="l01331"></a>01331         }
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="comment">/* finish off a stroke (clears buffer, but doesn&#39;t finish the paint operation) */</span>
<a name="l01336"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#aef9687b393f029bdf7f37e0a4e95577a">01336</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#aef9687b393f029bdf7f37e0a4e95577a">gp_paint_strokeend</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01337"></a>01337 {
<a name="l01338"></a>01338     <span class="comment">/* for surface sketching, need to set the right OpenGL context stuff so that </span>
<a name="l01339"></a>01339 <span class="comment">     * the conversions will project the values correctly...</span>
<a name="l01340"></a>01340 <span class="comment">     */</span>
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2f6d666f599d76e4e70e3343357cc9a2">gpencil_project_check</a>(p)) {
<a name="l01342"></a>01342         <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01343"></a>01343         
<a name="l01344"></a>01344         <span class="comment">/* need to restore the original projection settings before packing up */</span>
<a name="l01345"></a>01345         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a5f8982ad793ea8e5611a4be40deda650">view3d_region_operator_needs_opengl</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a5c5789b8d612565c1ff574acf3815abf">win</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>);
<a name="l01346"></a>01346         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a9685a729e5c8773d46ccd24e8faf4199">ED_view3d_autodist_init</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>, v3d, (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a0024340d665a66ff94987ec02932cbef">flag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a529f36469455be7c564513f59eb75be2">GP_DATA_DEPTH_STROKE</a>) ? 1:0);
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348     
<a name="l01349"></a>01349     <span class="comment">/* check if doing eraser or not */</span>
<a name="l01350"></a>01350     <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>-&gt;<a class="code" href="../../dd/d52/structbGPdata.html#a94da0585a6043ddf7a3c1b1f5728225f">sbuffer_sflag</a> &amp; <a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a5c69576e65da3f1f8a5e32235068b124">GP_STROKE_ERASER</a>) == 0) {
<a name="l01351"></a>01351         <span class="comment">/* smooth stroke before transferring? */</span>
<a name="l01352"></a>01352         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a11b9e687ad41adcc2becb4468f4d534b">gp_stroke_smooth</a>(p);
<a name="l01353"></a>01353         
<a name="l01354"></a>01354         <span class="comment">/* simplify stroke before transferring? */</span>
<a name="l01355"></a>01355         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#acfcda4c9390e5116af88894d387b4cd1">gp_stroke_simplify</a>(p);
<a name="l01356"></a>01356         
<a name="l01357"></a>01357         <span class="comment">/* transfer stroke to frame */</span>
<a name="l01358"></a>01358         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a424e0528814e65cf89a8d569e8750371">gp_stroke_newfrombuffer</a>(p);
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     
<a name="l01361"></a>01361     <span class="comment">/* clean up buffer now */</span>
<a name="l01362"></a>01362     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ef16a202f0d00b4dd159c051aea0055">gp_session_validatebuffer</a>(p);
<a name="l01363"></a>01363 }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="comment">/* finish off stroke painting operation */</span>
<a name="l01366"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ee1ab7418ccdd14144c681d0fc2d3e8">01366</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ee1ab7418ccdd14144c681d0fc2d3e8">gp_paint_cleanup</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01367"></a>01367 {
<a name="l01368"></a>01368     <span class="comment">/* p-&gt;gpd==NULL happens when stroke failed to initialize,</span>
<a name="l01369"></a>01369 <span class="comment">     * for example. when GP is hidden in current space (sergey) */</span>
<a name="l01370"></a>01370     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>) {
<a name="l01371"></a>01371         <span class="comment">/* finish off a stroke */</span>
<a name="l01372"></a>01372         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#aef9687b393f029bdf7f37e0a4e95577a">gp_paint_strokeend</a>(p);
<a name="l01373"></a>01373     }
<a name="l01374"></a>01374     
<a name="l01375"></a>01375     <span class="comment">/* &quot;unlock&quot; frame */</span>
<a name="l01376"></a>01376     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>)
<a name="l01377"></a>01377         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>-&gt;<a class="code" href="../../d7/dcf/structbGPDframe.html#ab649348d35f3a7e3b0c4942ccfee5c1f">flag</a> &amp;= ~<a class="code" href="../../d6/dcb/DNA__gpencil__types_8h.html#a27a62c89a0bd5ff69c7435b6b0cd5470">GP_FRAME_PAINT</a>;
<a name="l01378"></a>01378 }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380 <span class="comment">/* ------------------------------- */</span>
<a name="l01381"></a>01381 
<a name="l01382"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">01382</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01383"></a>01383 {
<a name="l01384"></a>01384     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01385"></a>01385     
<a name="l01386"></a>01386     <span class="comment">/* clear undo stack */</span>
<a name="l01387"></a>01387     <a class="code" href="../../d2/d14/gpencil__intern_8h.html#ab978608df68aabb36f8c46e3f055559d">gpencil_undo_finish</a>();
<a name="l01388"></a>01388     
<a name="l01389"></a>01389     <span class="comment">/* restore cursor to indicate end of drawing */</span>
<a name="l01390"></a>01390     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ab8500ccfbffb6b57f4e0645e0f9a4759">WM_cursor_restore</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C));
<a name="l01391"></a>01391     
<a name="l01392"></a>01392     <span class="comment">/* don&#39;t assume that operator data exists at all */</span>
<a name="l01393"></a>01393     <span class="keywordflow">if</span> (p) {
<a name="l01394"></a>01394         <span class="comment">/* check size of buffer before cleanup, to determine if anything happened here */</span>
<a name="l01395"></a>01395         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>) {
<a name="l01396"></a>01396             <span class="comment">// TODO clear radial cursor thing</span>
<a name="l01397"></a>01397             <span class="comment">// XXX draw_sel_circle(NULL, p.mvalo, 0, p.radius, 0);</span>
<a name="l01398"></a>01398         }
<a name="l01399"></a>01399         
<a name="l01400"></a>01400         <span class="comment">/* cleanup */</span>
<a name="l01401"></a>01401         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ee1ab7418ccdd14144c681d0fc2d3e8">gp_paint_cleanup</a>(p);
<a name="l01402"></a>01402         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ac3b6d78824f6e8a4af07184b0efe2032">gp_session_cleanup</a>(p);
<a name="l01403"></a>01403         
<a name="l01404"></a>01404         <span class="comment">/* finally, free the temp data */</span>
<a name="l01405"></a>01405         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(p);   
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407     
<a name="l01408"></a>01408     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01409"></a>01409 }
<a name="l01410"></a>01410 
<a name="l01411"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a269f1ad47955875dad107b73052db3eb">01411</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a269f1ad47955875dad107b73052db3eb">gpencil_draw_cancel</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01412"></a>01412 {
<a name="l01413"></a>01413     <span class="comment">/* this is just a wrapper around exit() */</span>
<a name="l01414"></a>01414     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01415"></a>01415     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01416"></a>01416 }
<a name="l01417"></a>01417 
<a name="l01418"></a>01418 <span class="comment">/* ------------------------------- */</span>
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 
<a name="l01421"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#af2d9782fdc6fb1c18a7ab773139ab443">01421</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af2d9782fdc6fb1c18a7ab773139ab443">gpencil_draw_init</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01422"></a>01422 {
<a name="l01423"></a>01423     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l01424"></a>01424     <span class="keywordtype">int</span> paintmode= <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;mode&quot;</span>);
<a name="l01425"></a>01425     
<a name="l01426"></a>01426     <span class="comment">/* check context */</span>
<a name="l01427"></a>01427     p= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a7d55d4978dc58b4f22c0e06cc8f2afcc">gp_session_initpaint</a>(C);
<a name="l01428"></a>01428     <span class="keywordflow">if</span> ((p == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>)) {
<a name="l01429"></a>01429         <span class="comment">/* something wasn&#39;t set correctly in context */</span>
<a name="l01430"></a>01430         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01431"></a>01431         <span class="keywordflow">return</span> 0;
<a name="l01432"></a>01432     }
<a name="l01433"></a>01433     
<a name="l01434"></a>01434     <span class="comment">/* init painting data */</span>
<a name="l01435"></a>01435     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a333aa2de21dc3da24327d32ef3a5c5fb">gp_paint_initstroke</a>(p, paintmode);
<a name="l01436"></a>01436     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>) {
<a name="l01437"></a>01437         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01438"></a>01438         <span class="keywordflow">return</span> 0;
<a name="l01439"></a>01439     }
<a name="l01440"></a>01440     
<a name="l01441"></a>01441     <span class="comment">/* radius for eraser circle is defined in userprefs now */</span>
<a name="l01442"></a>01442     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#afd6a921dac5f4347c3a7363d8ac4c0f2">radius</a>= <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.gp_eraser;
<a name="l01443"></a>01443     
<a name="l01444"></a>01444     <span class="comment">/* everything is now setup ok */</span>
<a name="l01445"></a>01445     <span class="keywordflow">return</span> 1;
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 <span class="comment">/* ------------------------------- */</span>
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 <span class="comment">/* update UI indicators of status, including cursor and header prints */</span>
<a name="l01451"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#affe2cef0d2ef9a8963ec453907e8fe11">01451</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#affe2cef0d2ef9a8963ec453907e8fe11">gpencil_draw_status_indicators</a> (<a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453     <span class="comment">/* header prints */</span>
<a name="l01454"></a>01454     <span class="keywordflow">switch</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>) {
<a name="l01455"></a>01455         <span class="keywordflow">case</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>:
<a name="l01456"></a>01456             <span class="comment">/* only print this for paint-sessions, otherwise it gets annoying */</span>
<a name="l01457"></a>01457             <span class="keywordflow">if</span> (<a class="code" href="../../d7/dea/ED__gpencil_8h.html#a117dea1881a58b9e1a122465823efcc0">GPENCIL_SKETCH_SESSIONS_ON</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>))
<a name="l01458"></a>01458                 <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <span class="stringliteral">&quot;Grease Pencil: Drawing/erasing stroke... Release to end stroke&quot;</span>);
<a name="l01459"></a>01459             <span class="keywordflow">break</span>;
<a name="l01460"></a>01460         
<a name="l01461"></a>01461         <span class="keywordflow">case</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a117dbf3e1c6793e7afb66cfb4f55c7ef">GP_STATUS_IDLING</a>:
<a name="l01462"></a>01462             <span class="comment">/* print status info */</span>
<a name="l01463"></a>01463             <span class="keywordflow">switch</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>) {
<a name="l01464"></a>01464                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>:
<a name="l01465"></a>01465                     <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <span class="stringliteral">&quot;Grease Pencil Erase Session: Hold and drag LMB or RMB to erase | ESC/Enter to end&quot;</span>);
<a name="l01466"></a>01466                     <span class="keywordflow">break</span>;
<a name="l01467"></a>01467                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>:
<a name="l01468"></a>01468                     <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <span class="stringliteral">&quot;Grease Pencil Line Session: Hold and drag LMB to draw | ESC/Enter to end&quot;</span>);
<a name="l01469"></a>01469                     <span class="keywordflow">break</span>;
<a name="l01470"></a>01470                 <span class="keywordflow">case</span> <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba44edb318a529be4708e2c7c7e2ae77d7">GP_PAINTMODE_DRAW</a>:
<a name="l01471"></a>01471                     <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <span class="stringliteral">&quot;Grease Pencil Freehand Session: Hold and drag LMB to draw | ESC/Enter to end&quot;</span>);
<a name="l01472"></a>01472                     <span class="keywordflow">break</span>;
<a name="l01473"></a>01473                     
<a name="l01474"></a>01474                 <span class="keywordflow">default</span>: <span class="comment">/* unhandled future cases */</span>
<a name="l01475"></a>01475                     <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <span class="stringliteral">&quot;Grease Pencil Session: ESC/Enter to end&quot;</span>);
<a name="l01476"></a>01476                     <span class="keywordflow">break</span>;
<a name="l01477"></a>01477             }
<a name="l01478"></a>01478             <span class="keywordflow">break</span>;
<a name="l01479"></a>01479             
<a name="l01480"></a>01480         <span class="keywordflow">case</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>:
<a name="l01481"></a>01481         <span class="keywordflow">case</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7af10dbe4a0912e9d91fd23d0a56614dba">GP_STATUS_DONE</a>:
<a name="l01482"></a>01482             <span class="comment">/* clear status string */</span>
<a name="l01483"></a>01483             <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01484"></a>01484             <span class="keywordflow">break</span>;
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486 }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488 <span class="comment">/* ------------------------------- */</span>
<a name="l01489"></a>01489 
<a name="l01490"></a>01490 <span class="comment">/* create a new stroke point at the point indicated by the painting context */</span>
<a name="l01491"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a03f0dbbc1a080405ce974f31f8f720e2">01491</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a03f0dbbc1a080405ce974f31f8f720e2">gpencil_draw_apply</a> (<a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>)
<a name="l01492"></a>01492 {
<a name="l01493"></a>01493     <span class="comment">/* handle drawing/erasing -&gt; test for erasing first */</span>
<a name="l01494"></a>01494     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>) {
<a name="l01495"></a>01495         <span class="comment">/* do &#39;live&#39; erasing now */</span>
<a name="l01496"></a>01496         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a494a55bc6b57c0f947316ea092d8d247">gp_stroke_doeraser</a>(p);
<a name="l01497"></a>01497         
<a name="l01498"></a>01498         <span class="comment">/* store used values */</span>
<a name="l01499"></a>01499         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[0]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0];
<a name="l01500"></a>01500         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[1]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1];
<a name="l01501"></a>01501         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>;
<a name="l01502"></a>01502     }
<a name="l01503"></a>01503     <span class="comment">/* only add current point to buffer if mouse moved (even though we got an event, it might be just noise) */</span>
<a name="l01504"></a>01504     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a46b9975674ad4cfa38e3ace14b31a7e7">gp_stroke_filtermval</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>)) {
<a name="l01505"></a>01505         <span class="comment">/* try to add point */</span>
<a name="l01506"></a>01506         <span class="keywordtype">short</span> ok= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">gp_stroke_addpoint</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>);
<a name="l01507"></a>01507         
<a name="l01508"></a>01508         <span class="comment">/* handle errors while adding point */</span>
<a name="l01509"></a>01509         <span class="keywordflow">if</span> ((ok == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3caa7215e5402c5438fb85e015b8bff2106">GP_STROKEADD_FULL</a>) || (ok == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3cacc17d22c728c52591de2101a75f19620">GP_STROKEADD_OVERFLOW</a>)) {
<a name="l01510"></a>01510             <span class="comment">/* finish off old stroke */</span>
<a name="l01511"></a>01511             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#aef9687b393f029bdf7f37e0a4e95577a">gp_paint_strokeend</a>(p);
<a name="l01512"></a>01512             
<a name="l01513"></a>01513             <span class="comment">/* start a new stroke, starting from previous point */</span>
<a name="l01514"></a>01514             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">gp_stroke_addpoint</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>);
<a name="l01515"></a>01515             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a2a124b9f74c7801bea93e23cbff5c2fe">gp_stroke_addpoint</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>);
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ok == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#abe974f22edeef8189603ba75fd90ff3ca411b7dec5a2cc0d547b40e2db0ceb995">GP_STROKEADD_INVALID</a>) {
<a name="l01518"></a>01518             <span class="comment">/* the painting operation cannot continue... */</span>
<a name="l01519"></a>01519             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;Cannot paint stroke&quot;</span>);
<a name="l01520"></a>01520             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01521"></a>01521             
<a name="l01522"></a>01522             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01523"></a>01523                 printf(<span class="stringliteral">&quot;Error: Grease-Pencil Paint - Add Point Invalid\n&quot;</span>);
<a name="l01524"></a>01524             <span class="keywordflow">return</span>;
<a name="l01525"></a>01525         }
<a name="l01526"></a>01526         
<a name="l01527"></a>01527         <span class="comment">/* store used values */</span>
<a name="l01528"></a>01528         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[0]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0];
<a name="l01529"></a>01529         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[1]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1];
<a name="l01530"></a>01530         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>;
<a name="l01531"></a>01531     }
<a name="l01532"></a>01532 }
<a name="l01533"></a>01533 
<a name="l01534"></a>01534 <span class="comment">/* handle draw event */</span>
<a name="l01535"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#ad5f10dcff68e37edcedb8de7fd143efb">01535</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ad5f10dcff68e37edcedb8de7fd143efb">gpencil_draw_apply_event</a> (<a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01536"></a>01536 {
<a name="l01537"></a>01537     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01538"></a>01538     <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> itemptr;
<a name="l01539"></a>01539     <span class="keywordtype">float</span> mousef[2];
<a name="l01540"></a>01540     <span class="keywordtype">int</span> tablet=0;
<a name="l01541"></a>01541 
<a name="l01542"></a>01542     <span class="comment">/* convert from window-space to area-space mouse coordintes */</span>
<a name="l01543"></a>01543     <span class="comment">// NOTE: float to ints conversions, +1 factor is probably used to ensure a bit more accurate rounding...</span>
<a name="l01544"></a>01544     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0]= <span class="keyword">event</span>-&gt;mval[0] + 1;
<a name="l01545"></a>01545     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1]= <span class="keyword">event</span>-&gt;mval[1] + 1;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     <span class="comment">/* handle pressure sensitivity (which is supplied by tablets) */</span>
<a name="l01548"></a>01548     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a276cd44fa9cab09b621a83980b335b47">custom</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a0dbe462839c84a02b2d3698e720ed27d">EVT_DATA_TABLET</a>) {
<a name="l01549"></a>01549         <a class="code" href="../../d3/d0b/structwmTabletData.html">wmTabletData</a> *wmtab= <span class="keyword">event</span>-&gt;customdata;
<a name="l01550"></a>01550         
<a name="l01551"></a>01551         tablet= (wmtab-&gt;<a class="code" href="../../d3/d0b/structwmTabletData.html#a25cff19785a3b589057c8d8324420cbd">Active</a> != <a class="code" href="../../d1/d40/wm__event__types_8h.html#a92e0ec16911af8a6cb6ea9214ce89fb7">EVT_TABLET_NONE</a>);
<a name="l01552"></a>01552         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>= wmtab-&gt;<a class="code" href="../../d3/d0b/structwmTabletData.html#a6456330e282f7e3e622d09741b3ddb60">Pressure</a>;
<a name="l01553"></a>01553         
<a name="l01554"></a>01554         <span class="comment">//if (wmtab-&gt;Active == EVT_TABLET_ERASER)</span>
<a name="l01555"></a>01555             <span class="comment">// TODO... this should get caught by the keymaps which call drawing in the first place</span>
<a name="l01556"></a>01556     }
<a name="l01557"></a>01557     <span class="keywordflow">else</span>
<a name="l01558"></a>01558         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>= 1.0f;
<a name="l01559"></a>01559     
<a name="l01560"></a>01560     <span class="comment">/* fill in stroke data (not actually used directly by gpencil_draw_apply) */</span>
<a name="l01561"></a>01561     <a class="code" href="../../d3/d10/rna__access_8c.html#a79f02ed37d6dff0e7fd3a13eed9c5c4f">RNA_collection_add</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;itemptr);
<a name="l01562"></a>01562     
<a name="l01563"></a>01563     mousef[0]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0];
<a name="l01564"></a>01564     mousef[1]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1];
<a name="l01565"></a>01565     <a class="code" href="../../d3/d10/rna__access_8c.html#ad8067a3fc34e361ac2283352ff2f906c">RNA_float_set_array</a>(&amp;itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mousef);
<a name="l01566"></a>01566     <a class="code" href="../../d3/d10/rna__access_8c.html#aa36f2cf0133a312c322490ba0bff9b72">RNA_float_set</a>(&amp;itemptr, <span class="stringliteral">&quot;pressure&quot;</span>, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>);
<a name="l01567"></a>01567     <a class="code" href="../../d3/d10/rna__access_8c.html#a1741c6fd78b5d828bb7b83517e2766db">RNA_boolean_set</a>(&amp;itemptr, <span class="stringliteral">&quot;is_start&quot;</span>, (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>));
<a name="l01568"></a>01568     
<a name="l01569"></a>01569     <span class="comment">/* special exception for start of strokes (i.e. maybe for just a dot) */</span>
<a name="l01570"></a>01570     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>) {
<a name="l01571"></a>01571         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp;= ~<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>;
<a name="l01572"></a>01572         
<a name="l01573"></a>01573         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[0]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0];
<a name="l01574"></a>01574         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[1]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1];
<a name="l01575"></a>01575         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>;
<a name="l01576"></a>01576         
<a name="l01577"></a>01577         <span class="comment">/* special exception here for too high pressure values on first touch in</span>
<a name="l01578"></a>01578 <span class="comment">         *  windows for some tablets, then we just skip first touch ..  </span>
<a name="l01579"></a>01579 <span class="comment">         */</span>
<a name="l01580"></a>01580         <span class="keywordflow">if</span> (tablet &amp;&amp; (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a> &gt;= 0.99f))
<a name="l01581"></a>01581             <span class="keywordflow">return</span>;
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583     
<a name="l01584"></a>01584     <span class="comment">/* apply the current latest drawing point */</span>
<a name="l01585"></a>01585     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a03f0dbbc1a080405ce974f31f8f720e2">gpencil_draw_apply</a>(op, p);
<a name="l01586"></a>01586     
<a name="l01587"></a>01587     <span class="comment">/* force refresh */</span>
<a name="l01588"></a>01588     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a0429a4b4e1c447bfb76739bec61697fc">ar</a>); <span class="comment">/* just active area for now, since doing whole screen is too slow */</span>
<a name="l01589"></a>01589 }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591 <span class="comment">/* ------------------------------- */</span>
<a name="l01592"></a>01592 
<a name="l01593"></a>01593 <span class="comment">/* operator &#39;redo&#39; (i.e. after changing some properties, but also for repeat last) */</span>
<a name="l01594"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a48e9e4e66fccaa73021eed50d3b8ef26">01594</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a48e9e4e66fccaa73021eed50d3b8ef26">gpencil_draw_exec</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01595"></a>01595 {
<a name="l01596"></a>01596     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01597"></a>01597     
<a name="l01598"></a>01598     <span class="comment">//printf(&quot;GPencil - Starting Re-Drawing\n&quot;);</span>
<a name="l01599"></a>01599     
<a name="l01600"></a>01600     <span class="comment">/* try to initialize context data needed while drawing */</span>
<a name="l01601"></a>01601     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/df8/gpencil__paint_8c.html#af2d9782fdc6fb1c18a7ab773139ab443">gpencil_draw_init</a>(C, op)) {
<a name="l01602"></a>01602         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l01603"></a>01603         <span class="comment">//printf(&quot;\tGP - no valid data\n&quot;);</span>
<a name="l01604"></a>01604         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01605"></a>01605     }
<a name="l01606"></a>01606     <span class="keywordflow">else</span>
<a name="l01607"></a>01607         p= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01608"></a>01608     
<a name="l01609"></a>01609     <span class="comment">//printf(&quot;\tGP - Start redrawing stroke\n&quot;);</span>
<a name="l01610"></a>01610     
<a name="l01611"></a>01611     <span class="comment">/* loop over the stroke RNA elements recorded (i.e. progress of mouse movement),</span>
<a name="l01612"></a>01612 <span class="comment">     * setting the relevant values in context at each step, then applying</span>
<a name="l01613"></a>01613 <span class="comment">     */</span>
<a name="l01614"></a>01614     <a class="code" href="../../de/ddf/RNA__access_8h.html#a0310a34930fc9ac8d15a39c38d3dd429">RNA_BEGIN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, itemptr, <span class="stringliteral">&quot;stroke&quot;</span>) {
<a name="l01615"></a>01615         <span class="keywordtype">float</span> mousef[2];
<a name="l01616"></a>01616         
<a name="l01617"></a>01617         <span class="comment">//printf(&quot;\t\tGP - stroke elem\n&quot;);</span>
<a name="l01618"></a>01618         
<a name="l01619"></a>01619         <span class="comment">/* get relevant data for this point from stroke */</span>
<a name="l01620"></a>01620         <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(&amp;itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mousef);
<a name="l01621"></a>01621         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0] = (int)mousef[0];
<a name="l01622"></a>01622         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1] = (int)mousef[1];
<a name="l01623"></a>01623         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>= <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(&amp;itemptr, <span class="stringliteral">&quot;pressure&quot;</span>);
<a name="l01624"></a>01624         
<a name="l01625"></a>01625         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(&amp;itemptr, <span class="stringliteral">&quot;is_start&quot;</span>)) {
<a name="l01626"></a>01626             <span class="comment">/* if first-run flag isn&#39;t set already (i.e. not true first stroke),</span>
<a name="l01627"></a>01627 <span class="comment">             * then we must terminate the previous one first before continuing</span>
<a name="l01628"></a>01628 <span class="comment">             */</span>
<a name="l01629"></a>01629             <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>) == 0) {
<a name="l01630"></a>01630                 <span class="comment">// TODO: both of these ops can set error-status, but we probably don&#39;t need to worry</span>
<a name="l01631"></a>01631                 <a class="code" href="../../d8/df8/gpencil__paint_8c.html#aef9687b393f029bdf7f37e0a4e95577a">gp_paint_strokeend</a>(p);
<a name="l01632"></a>01632                 <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a333aa2de21dc3da24327d32ef3a5c5fb">gp_paint_initstroke</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>);
<a name="l01633"></a>01633             }
<a name="l01634"></a>01634         }
<a name="l01635"></a>01635         
<a name="l01636"></a>01636         <span class="comment">/* if first run, set previous data too */</span>
<a name="l01637"></a>01637         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>) {
<a name="l01638"></a>01638             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp;= ~<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>;
<a name="l01639"></a>01639             
<a name="l01640"></a>01640             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[0]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[0];
<a name="l01641"></a>01641             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#adb470a331f0ac85226a178ef42a01371">mvalo</a>[1]= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ab3fa3188b2cc1e181f960d09ebb08e80">mval</a>[1];
<a name="l01642"></a>01642             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a65d4b6c5fa53c0f4a771ebdde77a1c3c">opressure</a>= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a571c1760d6c0a4a1c767d5711a716293">pressure</a>;
<a name="l01643"></a>01643         }
<a name="l01644"></a>01644         
<a name="l01645"></a>01645         <span class="comment">/* apply this data as necessary now (as per usual) */</span>
<a name="l01646"></a>01646         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a03f0dbbc1a080405ce974f31f8f720e2">gpencil_draw_apply</a>(op, p);
<a name="l01647"></a>01647     }
<a name="l01648"></a>01648     <a class="code" href="../../de/ddf/RNA__access_8h.html#a245d0341a908eab74fc30b93cf24a74d">RNA_END</a>;
<a name="l01649"></a>01649     
<a name="l01650"></a>01650     <span class="comment">//printf(&quot;\tGP - done\n&quot;);</span>
<a name="l01651"></a>01651     
<a name="l01652"></a>01652     <span class="comment">/* cleanup */</span>
<a name="l01653"></a>01653     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01654"></a>01654     
<a name="l01655"></a>01655     <span class="comment">/* refreshes */</span>
<a name="l01656"></a>01656     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a4d138b3b2f069a9db1d8cc28c7ed071d">NC_SCREEN</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aeab12aa02a0566181ca86214c661faca">ND_GPENCIL</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); <span class="comment">// XXX need a nicer one that will work  </span>
<a name="l01657"></a>01657     
<a name="l01658"></a>01658     <span class="comment">/* done */</span>
<a name="l01659"></a>01659     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01660"></a>01660 }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662 <span class="comment">/* ------------------------------- */</span>
<a name="l01663"></a>01663 
<a name="l01664"></a>01664 <span class="comment">/* start of interactive drawing part of operator */</span>
<a name="l01665"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a10961fb86c3696ac79c12867d858baaa">01665</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a10961fb86c3696ac79c12867d858baaa">gpencil_draw_invoke</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01666"></a>01666 {
<a name="l01667"></a>01667     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01668"></a>01668     <a class="code" href="../../dc/da4/structwmWindow.html">wmWindow</a> *win= <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C);
<a name="l01669"></a>01669     
<a name="l01670"></a>01670     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01671"></a>01671         printf(<span class="stringliteral">&quot;GPencil - Starting Drawing\n&quot;</span>);
<a name="l01672"></a>01672     
<a name="l01673"></a>01673     <span class="comment">/* try to initialize context data needed while drawing */</span>
<a name="l01674"></a>01674     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/df8/gpencil__paint_8c.html#af2d9782fdc6fb1c18a7ab773139ab443">gpencil_draw_init</a>(C, op)) {
<a name="l01675"></a>01675         <span class="keywordflow">if</span> (op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>) 
<a name="l01676"></a>01676             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>);
<a name="l01677"></a>01677         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01678"></a>01678             printf(<span class="stringliteral">&quot;\tGP - no valid data\n&quot;</span>);
<a name="l01679"></a>01679         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01680"></a>01680     }
<a name="l01681"></a>01681     <span class="keywordflow">else</span>
<a name="l01682"></a>01682         p= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01683"></a>01683     
<a name="l01684"></a>01684     <span class="comment">// TODO: set any additional settings that we can take from the events?</span>
<a name="l01685"></a>01685     <span class="comment">// TODO? if tablet is erasing, force eraser to be on?</span>
<a name="l01686"></a>01686     
<a name="l01687"></a>01687     <span class="comment">// TODO: move cursor setting stuff to stroke-start so that paintmode can be changed midway...</span>
<a name="l01688"></a>01688     
<a name="l01689"></a>01689     <span class="comment">/* if eraser is on, draw radial aid */</span>
<a name="l01690"></a>01690     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>) {
<a name="l01691"></a>01691         <span class="comment">// TODO: this involves mucking around with radial control, so we leave this for now..</span>
<a name="l01692"></a>01692     }
<a name="l01693"></a>01693     
<a name="l01694"></a>01694     <span class="comment">/* set cursor */</span>
<a name="l01695"></a>01695     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>)
<a name="l01696"></a>01696         <a class="code" href="../../de/d3c/wm__cursors_8c.html#a04d16b0d6c38bc563f9d78f47f1ba7ed">WM_cursor_modal</a>(win, <a class="code" href="../../db/da6/wm__cursors_8h.html#a737c1bdca78a4eec48fa026fcca3dd9baee0d08866702d9ed8ada3198e182bb36">BC_CROSSCURSOR</a>); <span class="comment">// XXX need a better cursor</span>
<a name="l01697"></a>01697     <span class="keywordflow">else</span>
<a name="l01698"></a>01698         <a class="code" href="../../de/d3c/wm__cursors_8c.html#a04d16b0d6c38bc563f9d78f47f1ba7ed">WM_cursor_modal</a>(win, <a class="code" href="../../db/da6/wm__cursors_8h.html#a737c1bdca78a4eec48fa026fcca3dd9bac0fddbbd7979467ade7f6b355de8cb73">BC_PAINTBRUSHCURSOR</a>);
<a name="l01699"></a>01699     
<a name="l01700"></a>01700     <span class="comment">/* special hack: if there was an initial event, then we were invoked via a hotkey, and </span>
<a name="l01701"></a>01701 <span class="comment">     * painting should start immediately. Otherwise, this was called from a toolbar, in which</span>
<a name="l01702"></a>01702 <span class="comment">     * case we should wait for the mouse to be clicked.</span>
<a name="l01703"></a>01703 <span class="comment">     */</span>
<a name="l01704"></a>01704     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l01705"></a>01705         <span class="comment">/* hotkey invoked - start drawing */</span>
<a name="l01706"></a>01706         <span class="comment">//printf(&quot;\tGP - set first spot\n&quot;);</span>
<a name="l01707"></a>01707         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>;
<a name="l01708"></a>01708         
<a name="l01709"></a>01709         <span class="comment">/* handle the initial drawing - i.e. for just doing a simple dot */</span>
<a name="l01710"></a>01710         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ad5f10dcff68e37edcedb8de7fd143efb">gpencil_draw_apply_event</a>(op, event);
<a name="l01711"></a>01711     }
<a name="l01712"></a>01712     <span class="keywordflow">else</span> {
<a name="l01713"></a>01713         <span class="comment">/* toolbar invoked - don&#39;t start drawing yet... */</span>
<a name="l01714"></a>01714         <span class="comment">//printf(&quot;\tGP - hotkey invoked... waiting for click-drag\n&quot;);</span>
<a name="l01715"></a>01715     }
<a name="l01716"></a>01716     
<a name="l01717"></a>01717     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a4d138b3b2f069a9db1d8cc28c7ed071d">NC_SCREEN</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aeab12aa02a0566181ca86214c661faca">ND_GPENCIL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01718"></a>01718     <span class="comment">/* add a modal handler for this operator, so that we can then draw continuous strokes */</span>
<a name="l01719"></a>01719     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l01720"></a>01720     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01721"></a>01721 }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723 <span class="comment">/* gpencil modal operator stores area, which can be removed while using it (like fullscreen) */</span>
<a name="l01724"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1f2510c34193f5a79698cde44df7b581">01724</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1f2510c34193f5a79698cde44df7b581">gpencil_area_exists</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *satest)
<a name="l01725"></a>01725 {
<a name="l01726"></a>01726     <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *sc= <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C);
<a name="l01727"></a>01727     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa;
<a name="l01728"></a>01728     
<a name="l01729"></a>01729     <span class="keywordflow">for</span> (sa= sc-&gt;<a class="code" href="../../de/de7/structbScreen.html#ae2f4a800c4c58fe953d91fe8136a0d0f">areabase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sa; sa= sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a884b59339f5c0d55408f8727bfc799b7">next</a>) {
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (sa==satest)
<a name="l01731"></a>01731             <span class="keywordflow">return</span> 1;
<a name="l01732"></a>01732     }
<a name="l01733"></a>01733     
<a name="l01734"></a>01734     <span class="keywordflow">return</span> 0;
<a name="l01735"></a>01735 }
<a name="l01736"></a>01736 
<a name="l01737"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a221a6fbd8c618da1bd52945f403b9753">01737</a> <span class="keyword">static</span> <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a221a6fbd8c618da1bd52945f403b9753">gpencil_stroke_begin</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01738"></a>01738 {
<a name="l01739"></a>01739     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="comment">/* we must check that we&#39;re still within the area that we&#39;re set up to work from</span>
<a name="l01742"></a>01742 <span class="comment">     * otherwise we could crash (see bug #20586)</span>
<a name="l01743"></a>01743 <span class="comment">     */</span>
<a name="l01744"></a>01744     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C) != p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>) {
<a name="l01745"></a>01745         printf(<span class="stringliteral">&quot;\t\t\tGP - wrong area execution abort!\n&quot;</span>);
<a name="l01746"></a>01746         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>;
<a name="l01747"></a>01747     }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749     <span class="comment">//printf(&quot;\t\tGP - start stroke\n&quot;);</span>
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     <span class="comment">/* we may need to set up paint env again if we&#39;re resuming */</span>
<a name="l01752"></a>01752     <span class="comment">// XXX: watch it with the paintmode! in future, it&#39;d be nice to allow changing paint-mode when in sketching-sessions</span>
<a name="l01753"></a>01753     <span class="comment">// XXX: with tablet events, we may event want to check for eraser here, for nicer tablet support</span>
<a name="l01754"></a>01754 
<a name="l01755"></a>01755     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df8/gpencil__paint_8c.html#ab2bc6e27670e00974b39a54339a7891b">gp_session_initdata</a>(C, p))
<a name="l01756"></a>01756         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a333aa2de21dc3da24327d32ef3a5c5fb">gp_paint_initstroke</a>(p, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a>);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> != <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>)
<a name="l01759"></a>01759         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>;
<a name="l01760"></a>01760 
<a name="l01761"></a>01761     <span class="keywordflow">return</span> op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01762"></a>01762 }
<a name="l01763"></a>01763 
<a name="l01764"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a730269bb8afbc49cdc90e83cf9e5d1fb">01764</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a730269bb8afbc49cdc90e83cf9e5d1fb">gpencil_stroke_end</a>(<a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01765"></a>01765 {
<a name="l01766"></a>01766     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a3ee1ab7418ccdd14144c681d0fc2d3e8">gp_paint_cleanup</a>(p);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a799051de91e870d36e9751f90c2faa34">gpencil_undo_push</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>);
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ac3b6d78824f6e8a4af07184b0efe2032">gp_session_cleanup</a>(p);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a117dbf3e1c6793e7afb66cfb4f55c7ef">GP_STATUS_IDLING</a>;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#ae7a16899943d44a2a2d73e1e087082ba">gpd</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01777"></a>01777     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7e4ef336b0a749e1d565c2a6aa1e9e48">gpl</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01778"></a>01778     p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a134de67574e78e1fef9433f1f020c535">gpf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 <span class="comment">/* events handling during interactive drawing part of operator */</span>
<a name="l01782"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a16f78c3fbc3da38f39a1fec4add6962f">01782</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a16f78c3fbc3da38f39a1fec4add6962f">gpencil_draw_modal</a> (<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01783"></a>01783 {
<a name="l01784"></a>01784     <a class="code" href="../../d5/dec/structtGPsdata.html">tGPsdata</a> *<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>= op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l01785"></a>01785     <span class="keywordtype">int</span> estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>; <span class="comment">/* default exit state - not handled, so let others have a share of the pie */</span>
<a name="l01786"></a>01786     
<a name="l01787"></a>01787     <span class="comment">// if (event-&gt;type == NDOF_MOTION)</span>
<a name="l01788"></a>01788     <span class="comment">//  return OPERATOR_PASS_THROUGH;</span>
<a name="l01789"></a>01789     <span class="comment">// -------------------------------</span>
<a name="l01790"></a>01790     <span class="comment">// [mce] Not quite what I was looking</span>
<a name="l01791"></a>01791     <span class="comment">// for, but a good start! GP continues to</span>
<a name="l01792"></a>01792     <span class="comment">// draw on the screen while the 3D mouse</span>
<a name="l01793"></a>01793     <span class="comment">// moves the viewpoint. Problem is that</span>
<a name="l01794"></a>01794     <span class="comment">// the stroke is converted to 3D only after</span>
<a name="l01795"></a>01795     <span class="comment">// it is finished. This approach should work</span>
<a name="l01796"></a>01796     <span class="comment">// better in tools that immediately apply</span>
<a name="l01797"></a>01797     <span class="comment">// in 3D space.</span>
<a name="l01798"></a>01798 
<a name="l01799"></a>01799     <span class="comment">//printf(&quot;\tGP - handle modal event...\n&quot;);</span>
<a name="l01800"></a>01800     
<a name="l01801"></a>01801     <span class="comment">/* exit painting mode (and/or end current stroke) */</span>
<a name="l01802"></a>01802     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0388eda1f65113c4a15720e037c11cb4">ELEM4</a>(event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a6c861c5ebabe8fe076ed84a2aaa7a1a0">RETKEY</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#aafdc675e684c8485e8e27c7f2bafcbef">PADENTER</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#abe3de76b73fb856d283d4da41ad109e8">ESCKEY</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a59b43db62ffa0d14bb076092d862d2cd">SPACEKEY</a>)) {
<a name="l01803"></a>01803         <span class="comment">/* exit() ends the current stroke before cleaning up */</span>
<a name="l01804"></a>01804         <span class="comment">//printf(&quot;\t\tGP - end of paint op + end of stroke\n&quot;);</span>
<a name="l01805"></a>01805         p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7af10dbe4a0912e9d91fd23d0a56614dba">GP_STATUS_DONE</a>;
<a name="l01806"></a>01806         estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01807"></a>01807     }
<a name="l01808"></a>01808     
<a name="l01809"></a>01809     <span class="comment">/* toggle painting mode upon mouse-button movement */</span>
<a name="l01810"></a>01810     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>)) {
<a name="l01811"></a>01811         <span class="comment">/* if painting, end stroke */</span>
<a name="l01812"></a>01812         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>) {
<a name="l01813"></a>01813             <span class="keywordtype">int</span> sketch= 0;
<a name="l01814"></a>01814             <span class="comment">/* basically, this should be mouse-button up = end stroke </span>
<a name="l01815"></a>01815 <span class="comment">             * BUT what happens next depends on whether we &#39;painting sessions&#39; is enabled</span>
<a name="l01816"></a>01816 <span class="comment">             */</span>
<a name="l01817"></a>01817             sketch |= <a class="code" href="../../d7/dea/ED__gpencil_8h.html#a117dea1881a58b9e1a122465823efcc0">GPENCIL_SKETCH_SESSIONS_ON</a>(p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a37ed3e802e2f8d029c89e831e7da92b3">scene</a>);
<a name="l01818"></a>01818             <span class="comment">/* polyline drawing is also &#39;sketching&#39; -- all knots should be added during one session */</span>
<a name="l01819"></a>01819             sketch |= p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a55c22bea0495d91b5932b1cf764f22da">paintmode</a> == <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>;
<a name="l01820"></a>01820 
<a name="l01821"></a>01821             <span class="keywordflow">if</span> (sketch) {
<a name="l01822"></a>01822                 <span class="comment">/* end stroke only, and then wait to resume painting soon */</span>
<a name="l01823"></a>01823                 <span class="comment">//printf(&quot;\t\tGP - end stroke only\n&quot;);</span>
<a name="l01824"></a>01824                 <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a730269bb8afbc49cdc90e83cf9e5d1fb">gpencil_stroke_end</a>(op);
<a name="l01825"></a>01825                 
<a name="l01826"></a>01826                 <span class="comment">/* we&#39;ve just entered idling state, so this event was processed (but no others yet) */</span>
<a name="l01827"></a>01827                 estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829                 <span class="comment">/* stroke could be smoothed, send notifier to refresh screen */</span>
<a name="l01830"></a>01830                 <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a4d138b3b2f069a9db1d8cc28c7ed071d">NC_SCREEN</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aeab12aa02a0566181ca86214c661faca">ND_GPENCIL</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01831"></a>01831             }
<a name="l01832"></a>01832             <span class="keywordflow">else</span> {
<a name="l01833"></a>01833                 <span class="comment">//printf(&quot;\t\tGP - end of stroke + op\n&quot;);</span>
<a name="l01834"></a>01834                 p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a>= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7af10dbe4a0912e9d91fd23d0a56614dba">GP_STATUS_DONE</a>;
<a name="l01835"></a>01835                 estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01836"></a>01836             }
<a name="l01837"></a>01837         }
<a name="l01838"></a>01838         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a4ce6386082cecfa0645ced2216d04172">val</a> == <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>) {
<a name="l01839"></a>01839             <span class="comment">/* not painting, so start stroke (this should be mouse-button down) */</span>
<a name="l01840"></a>01840             p= <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a221a6fbd8c618da1bd52945f403b9753">gpencil_stroke_begin</a>(C, op);
<a name="l01841"></a>01841 
<a name="l01842"></a>01842             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>) {
<a name="l01843"></a>01843                 estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01844"></a>01844             }
<a name="l01845"></a>01845         } 
<a name="l01846"></a>01846         <span class="keywordflow">else</span> {
<a name="l01847"></a>01847             p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a117dbf3e1c6793e7afb66cfb4f55c7ef">GP_STATUS_IDLING</a>;
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849     }
<a name="l01850"></a>01850     
<a name="l01851"></a>01851     <span class="comment">/* handle mode-specific events */</span>
<a name="l01852"></a>01852     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7a0ca92c5937e42dcb23de34b57cadaaf2">GP_STATUS_PAINTING</a>) {
<a name="l01853"></a>01853         <span class="comment">/* handle painting mouse-movements? */</span>
<a name="l01854"></a>01854         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a99234bdab7c4336e174cd0db37044412">INBETWEEN_MOUSEMOVE</a>) || (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a199a5b8727245043c763e77e2a09c7ac">flags</a> &amp; <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1b70d876770ccff427513794d6b0b2a7a5904254554ebd7518ad02ae69f64cbad">GP_PAINTFLAG_FIRSTRUN</a>)) {
<a name="l01855"></a>01855             <span class="comment">/* handle drawing event */</span>
<a name="l01856"></a>01856             <span class="comment">//printf(&quot;\t\tGP - add point\n&quot;);</span>
<a name="l01857"></a>01857             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#ad5f10dcff68e37edcedb8de7fd143efb">gpencil_draw_apply_event</a>(op, event);
<a name="l01858"></a>01858             
<a name="l01859"></a>01859             <span class="comment">/* finish painting operation if anything went wrong just now */</span>
<a name="l01860"></a>01860             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a6f01c6eba72d5a0b5b3be70484fa2ff7">status</a> == <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a79e9f285d34216706a748fd7ba8941b7aa75982c65533db57555d77fdc92afeeb">GP_STATUS_ERROR</a>) {
<a name="l01861"></a>01861                 printf(<span class="stringliteral">&quot;\t\t\t\tGP - add error done!\n&quot;</span>);
<a name="l01862"></a>01862                 estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01863"></a>01863             }
<a name="l01864"></a>01864             <span class="keywordflow">else</span> {
<a name="l01865"></a>01865                 <span class="comment">/* event handled, so just tag as running modal */</span>
<a name="l01866"></a>01866                 <span class="comment">//printf(&quot;\t\t\t\tGP - add point handled!\n&quot;);</span>
<a name="l01867"></a>01867                 estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01868"></a>01868             }
<a name="l01869"></a>01869         }
<a name="l01870"></a>01870         <span class="comment">/* there shouldn&#39;t be any other events, but just in case there are, let&#39;s swallow them </span>
<a name="l01871"></a>01871 <span class="comment">         * (i.e. to prevent problems with with undo)</span>
<a name="l01872"></a>01872 <span class="comment">         */</span>
<a name="l01873"></a>01873         <span class="keywordflow">else</span> {
<a name="l01874"></a>01874             <span class="comment">/* swallow event to save ourselves trouble */</span>
<a name="l01875"></a>01875             estate = <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l01876"></a>01876         }
<a name="l01877"></a>01877     }
<a name="l01878"></a>01878     
<a name="l01879"></a>01879     <span class="comment">/* gpencil modal operator stores area, which can be removed while using it (like fullscreen) */</span>
<a name="l01880"></a>01880     <span class="keywordflow">if</span> (0==<a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1f2510c34193f5a79698cde44df7b581">gpencil_area_exists</a>(C, p-&gt;<a class="code" href="../../d5/dec/structtGPsdata.html#a7ba5b85ca4590e0967bb23c6ed740751">sa</a>))
<a name="l01881"></a>01881         estate= <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01882"></a>01882     <span class="keywordflow">else</span>
<a name="l01883"></a>01883         <span class="comment">/* update status indicators - cursor, header, etc. */</span>
<a name="l01884"></a>01884         <a class="code" href="../../d8/df8/gpencil__paint_8c.html#affe2cef0d2ef9a8963ec453907e8fe11">gpencil_draw_status_indicators</a>(p);
<a name="l01885"></a>01885     
<a name="l01886"></a>01886     <span class="comment">/* process last operations before exiting */</span>
<a name="l01887"></a>01887     <span class="keywordflow">switch</span> (estate) {
<a name="l01888"></a>01888         <span class="keywordflow">case</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>:
<a name="l01889"></a>01889             <span class="comment">/* one last flush before we&#39;re done */</span>
<a name="l01890"></a>01890             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01891"></a>01891             <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a4d138b3b2f069a9db1d8cc28c7ed071d">NC_SCREEN</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#aeab12aa02a0566181ca86214c661faca">ND_GPENCIL</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); <span class="comment">// XXX need a nicer one that will work</span>
<a name="l01892"></a>01892             <span class="keywordflow">break</span>;
<a name="l01893"></a>01893             
<a name="l01894"></a>01894         <span class="keywordflow">case</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>:
<a name="l01895"></a>01895             <a class="code" href="../../d8/df8/gpencil__paint_8c.html#af27f813414b67a4347b72a7600fd76fa">gpencil_draw_exit</a>(C, op);
<a name="l01896"></a>01896             <span class="keywordflow">break</span>;
<a name="l01897"></a>01897 
<a name="l01898"></a>01898         <span class="keywordflow">case</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>|<a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>:
<a name="l01899"></a>01899             <span class="comment">/* event doesn&#39;t need to be handled */</span>
<a name="l01900"></a>01900             <span class="comment">//printf(&quot;unhandled event -&gt; %d (mmb? = %d | mmv? = %d)\n&quot;, event-&gt;type, event-&gt;type == MIDDLEMOUSE, event-&gt;type==MOUSEMOVE);</span>
<a name="l01901"></a>01901             <span class="keywordflow">break</span>;
<a name="l01902"></a>01902     }
<a name="l01903"></a>01903     
<a name="l01904"></a>01904     <span class="comment">/* return status code */</span>
<a name="l01905"></a>01905     <span class="keywordflow">return</span> estate;
<a name="l01906"></a>01906 }
<a name="l01907"></a>01907 
<a name="l01908"></a>01908 <span class="comment">/* ------------------------------- */</span>
<a name="l01909"></a>01909 
<a name="l01910"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#adc4a73636bbdcdeb11fa55606bed8ffc">01910</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> <a class="code" href="../../d8/df8/gpencil__paint_8c.html#adc4a73636bbdcdeb11fa55606bed8ffc">prop_gpencil_drawmodes</a>[] = {
<a name="l01911"></a>01911     {<a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba44edb318a529be4708e2c7c7e2ae77d7">GP_PAINTMODE_DRAW</a>, <span class="stringliteral">&quot;DRAW&quot;</span>, 0, <span class="stringliteral">&quot;Draw Freehand&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l01912"></a>01912     {<a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba82539b05e79220d265f3a8f1c7b8fb60">GP_PAINTMODE_DRAW_STRAIGHT</a>, <span class="stringliteral">&quot;DRAW_STRAIGHT&quot;</span>, 0, <span class="stringliteral">&quot;Draw Straight Lines&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l01913"></a>01913     {<a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba11631e65e97566f363de1d05ac65e3db">GP_PAINTMODE_DRAW_POLY</a>, <span class="stringliteral">&quot;DRAW_POLY&quot;</span>, 0, <span class="stringliteral">&quot;Draw Poly Line&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l01914"></a>01914     {<a class="code" href="../../d2/d14/gpencil__intern_8h.html#a446332dd259a23fc477a26aa9fa55ecba1c4db5bd5eab3337183a09c7490e5533">GP_PAINTMODE_ERASER</a>, <span class="stringliteral">&quot;ERASER&quot;</span>, 0, <span class="stringliteral">&quot;Eraser&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l01915"></a>01915     {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}
<a name="l01916"></a>01916 };
<a name="l01917"></a>01917 
<a name="l01918"></a><a class="code" href="../../d8/df8/gpencil__paint_8c.html#a1641548afea248bd6b4dacef9b3de018">01918</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d14/gpencil__intern_8h.html#a81bb1ec901fce9b9790b5ef52e8b7dd4">GPENCIL_OT_draw</a> (<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01919"></a>01919 {
<a name="l01920"></a>01920     <span class="comment">/* identifiers */</span>
<a name="l01921"></a>01921     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Grease Pencil Draw&quot;</span>;
<a name="l01922"></a>01922     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;GPENCIL_OT_draw&quot;</span>;
<a name="l01923"></a>01923     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Make annotations on the active data&quot;</span>;
<a name="l01924"></a>01924     
<a name="l01925"></a>01925     <span class="comment">/* api callbacks */</span>
<a name="l01926"></a>01926     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a48e9e4e66fccaa73021eed50d3b8ef26">gpencil_draw_exec</a>;
<a name="l01927"></a>01927     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a10961fb86c3696ac79c12867d858baaa">gpencil_draw_invoke</a>;
<a name="l01928"></a>01928     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a16f78c3fbc3da38f39a1fec4add6962f">gpencil_draw_modal</a>;
<a name="l01929"></a>01929     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a269f1ad47955875dad107b73052db3eb">gpencil_draw_cancel</a>;
<a name="l01930"></a>01930     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d8/df8/gpencil__paint_8c.html#a67e8a78ecbce67aa070abc354e4f1255">gpencil_draw_poll</a>;
<a name="l01931"></a>01931     
<a name="l01932"></a>01932     <span class="comment">/* flags */</span>
<a name="l01933"></a>01933     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>|<a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l01934"></a>01934     
<a name="l01935"></a>01935     <span class="comment">/* settings for drawing */</span>
<a name="l01936"></a>01936     <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;mode&quot;</span>, prop_gpencil_drawmodes, 0, <span class="stringliteral">&quot;Mode&quot;</span>, <span class="stringliteral">&quot;Way to interpret mouse movements&quot;</span>);
<a name="l01937"></a>01937     
<a name="l01938"></a>01938     <a class="code" href="../../dc/d7e/rna__define_8c.html#a5861cf8175d4ffb61082e2bbeff84fd0">RNA_def_collection_runtime</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a0c09154eb5eafa1601572b2cd89cf35a">RNA_OperatorStrokeElement</a>, <span class="stringliteral">&quot;Stroke&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01939"></a>01939 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:23 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
