<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: view3d_draw.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">view3d_draw.c</div>  </div>
</div>
<div class="contents">
<a href="../../d8/d7f/view3d__draw_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2008 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * </span>
<a name="l00022"></a>00022 <span class="comment"> * Contributor(s): Blender Foundation</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html">DNA_customdata_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3b/DNA__world__types_8h.html">DNA_world_types.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dff/BKE__camera_8h.html" title="Camera datablock and utility functions.">BKE_camera.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d5e/BKE__customdata_8h.html" title="CustomData interface, see also DNA_customdata_types.h.">BKE_customdata.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da3/BKE__screen_8h.html">BKE_screen.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d47/BKE__unit_8h.html">BKE_unit.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd4/BKE__movieclip_8h.html">BKE_movieclip.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../db/da9/RE__engine_8h.html">RE_engine.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dfd/RE__pipeline_8h.html">RE_pipeline.h</a>&quot;</span>    <span class="comment">// make_stars</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d71/BIF__glutil_8h.html">BIF_glutil.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d5d/BLF__api_8h.html">BLF_api.h</a>&quot;</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d98/ED__armature_8h.html">ED_armature.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df9/ED__keyframing_8h.html">ED_keyframing.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dea/ED__gpencil_8h.html">ED_gpencil.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d5f/ED__space__api_8h.html">ED_space_api.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d85/ED__screen__types_8h.html">ED_screen_types.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df2/ED__transform_8h.html">ED_transform.h</a>&quot;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d1e/UI__interface_8h.html">UI_interface.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/de1/UI__interface__icons_8h.html">UI_interface_icons.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/df0/GPU__draw_8h.html">GPU_draw.h</a>&quot;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d68/GPU__material_8h.html">GPU_material.h</a>&quot;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="../../da/deb/GPU__extensions_8h.html">GPU_extensions.h</a>&quot;</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/df4/view3d__intern_8h.html">view3d_intern.h</a>&quot;</span>  <span class="comment">// own include</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a129ee04bac1fe07f40f01a315e43faee">00099</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a129ee04bac1fe07f40f01a315e43faee">star_stuff_init_func</a>(<span class="keywordtype">void</span>)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0xFFFFFF);
<a name="l00102"></a>00102     glPointSize(1.0);
<a name="l00103"></a>00103     glBegin(GL_POINTS);
<a name="l00104"></a>00104 }
<a name="l00105"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0e901c3928a64a844f946ac6d8395dd9">00105</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0e901c3928a64a844f946ac6d8395dd9">star_stuff_vertex_func</a>(<span class="keywordtype">float</span>*<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00106"></a>00106 {
<a name="l00107"></a>00107     glVertex3fv(i);
<a name="l00108"></a>00108 }
<a name="l00109"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a568fd5e7a5017382aa951803f55593ea">00109</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a568fd5e7a5017382aa951803f55593ea">star_stuff_term_func</a>(<span class="keywordtype">void</span>)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111     glEnd();
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a052760f4ecb04c7293a351916f30b313">00114</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a052760f4ecb04c7293a351916f30b313">circf</a>(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> rad)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     GLUquadricObj *qobj = gluNewQuadric(); 
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     gluQuadricDrawStyle(qobj, GLU_FILL); 
<a name="l00119"></a>00119     
<a name="l00120"></a>00120     glPushMatrix(); 
<a name="l00121"></a>00121     
<a name="l00122"></a>00122     glTranslatef(x, y, 0.0);
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     gluDisk(qobj, 0.0,  rad, 32, 1);
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     glPopMatrix(); 
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     gluDeleteQuadric(qobj);
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a30827d412673b6d41bb128255520a525">00131</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a30827d412673b6d41bb128255520a525">circ</a>(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> rad)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     GLUquadricObj *qobj = gluNewQuadric(); 
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     gluQuadricDrawStyle(qobj, GLU_SILHOUETTE); 
<a name="l00136"></a>00136     
<a name="l00137"></a>00137     glPushMatrix(); 
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     glTranslatef(x, y, 0.0);
<a name="l00140"></a>00140     
<a name="l00141"></a>00141     gluDisk(qobj, 0.0,  rad, 32, 1);
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     glPopMatrix(); 
<a name="l00144"></a>00144     
<a name="l00145"></a>00145     gluDeleteQuadric(qobj);
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">/* ********* custom clipping *********** */</span>
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a6927fbc12e58028d1aca101f2a1b1ab1">00151</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a6927fbc12e58028d1aca101f2a1b1ab1">view3d_draw_clipping</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> *bb = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af03bef54d5f4dbf31d2f73a8d0c83d0a">clipbb</a>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (bb) {
<a name="l00156"></a>00156         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> clipping_index[6][4] = {{0, 1, 2, 3},
<a name="l00157"></a>00157                                                     {0, 4, 5, 1},
<a name="l00158"></a>00158                                                     {4, 7, 6, 5},
<a name="l00159"></a>00159                                                     {7, 3, 2, 6},
<a name="l00160"></a>00160                                                     {1, 5, 6, 2},
<a name="l00161"></a>00161                                                     {7, 4, 0, 3}};
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <a class="code" href="../../de/d96/UI__resources_8h.html#a56c7a350537a25b88d0532488032aef6">UI_ThemeColorShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, -8);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         glEnableClientState(GL_VERTEX_ARRAY);
<a name="l00166"></a>00166         glVertexPointer(3, GL_FLOAT, 0, bb-&gt;<a class="code" href="../../d3/d8a/structBoundBox.html#ad1955c11c5a6c98f2c8b714c20337fb3">vec</a>);
<a name="l00167"></a>00167         glDrawElements(GL_QUADS, <span class="keyword">sizeof</span>(clipping_index) / <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), GL_UNSIGNED_INT, clipping_index);
<a name="l00168"></a>00168         glDisableClientState(GL_VERTEX_ARRAY);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a9b5dc22683fa5f5595f422db10ed4c98">00173</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a403862b556efefe2375ce8cf99110fd5">ED_view3d_clipping_set</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     <span class="keywordtype">double</span> plane[4];
<a name="l00176"></a>00176     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot = (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2f24be354ab2bdec931764dda203ca3c">viewlock</a>) ? 4 : 6;
<a name="l00177"></a>00177     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="keywordflow">for</span> (a = 0; a &lt; tot; a++) {
<a name="l00180"></a>00180         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a69a23e3f6e31da176ecbe98504fabdbd">copy_v4db_v4fl</a>(plane, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aaaae1e0d5b26cd575c7cb7dd5b5861ee">clip</a>[a]);
<a name="l00181"></a>00181         glClipPlane(GL_CLIP_PLANE0 + a, plane);
<a name="l00182"></a>00182         glEnable(GL_CLIP_PLANE0 + a);
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* use these to temp disable/enable clipping when &#39;rv3d-&gt;rflag &amp; RV3D_CLIPPING&#39; is set */</span>
<a name="l00187"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa4cf5dc6374c7b1e81b8322fad984ece">00187</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa4cf5dc6374c7b1e81b8322fad984ece">ED_view3d_clipping_disable</a>(<span class="keywordtype">void</span>)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">for</span> (a = 0; a &lt; 6; a++) {
<a name="l00192"></a>00192         glDisable(GL_CLIP_PLANE0 + a);
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 }
<a name="l00195"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#acc257e842dc24b77a88376dee00f5f07">00195</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#acc257e842dc24b77a88376dee00f5f07">ED_view3d_clipping_enable</a>(<span class="keywordtype">void</span>)
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">for</span> (a = 0; a &lt; 6; a++) {
<a name="l00200"></a>00200         glEnable(GL_CLIP_PLANE0 + a);
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad3d9c4328e9a3204e32908843c180a20">00204</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad3d9c4328e9a3204e32908843c180a20">view3d_clipping_test</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keywordtype">float</span> clip[][4])
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     <span class="keywordtype">float</span> view[3];
<a name="l00207"></a>00207     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(view, vec);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (0.0f &lt; clip[0][3] + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, clip[0]))
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (0.0f &lt; clip[1][3] + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, clip[1]))
<a name="l00211"></a>00211             <span class="keywordflow">if</span> (0.0f &lt; clip[2][3] + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, clip[2]))
<a name="l00212"></a>00212                 <span class="keywordflow">if</span> (0.0f &lt; clip[3][3] + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, clip[3]))
<a name="l00213"></a>00213                     <span class="keywordflow">return</span> 0;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">return</span> 1;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">/* for &#39;local&#39; ED_view3d_clipping_local must run first</span>
<a name="l00219"></a>00219 <span class="comment"> * then all comparisons can be done in localspace */</span>
<a name="l00220"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a5e9c200355fde15f117726f989c19f63">00220</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d, <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keyword">const</span> <span class="keywordtype">int</span> is_local)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222     <span class="keywordflow">return</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad3d9c4328e9a3204e32908843c180a20">view3d_clipping_test</a>(vec, is_local ? rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#adec948da4b698e358f4792080f80dde3">clip_local</a> : rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aaaae1e0d5b26cd575c7cb7dd5b5861ee">clip</a>);
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">/* ********* end custom clipping *********** */</span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">00228</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">double</span> wx, <span class="keywordtype">double</span> wy, <span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> dx)
<a name="l00229"></a>00229 {   
<a name="l00230"></a>00230     <span class="keywordtype">double</span> verts[2][2];
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     x += (wx);
<a name="l00233"></a>00233     y += (wy);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="comment">/* set fixed &#39;Y&#39; */</span>
<a name="l00236"></a>00236     verts[0][1] = 0.0f;
<a name="l00237"></a>00237     verts[1][1] = (double)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239     <span class="comment">/* iter over &#39;X&#39; */</span>
<a name="l00240"></a>00240     verts[0][0] = verts[1][0] = x - dx *floor(x / dx);
<a name="l00241"></a>00241     glEnableClientState(GL_VERTEX_ARRAY);
<a name="l00242"></a>00242     glVertexPointer(2, GL_DOUBLE, 0, verts);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keywordflow">while</span> (verts[0][0] &lt; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>) {
<a name="l00245"></a>00245         glDrawArrays(GL_LINES, 0, 2);
<a name="l00246"></a>00246         verts[0][0] = verts[1][0] = verts[0][0] + dx;
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">/* set fixed &#39;X&#39; */</span>
<a name="l00250"></a>00250     verts[0][0] = 0.0f;
<a name="l00251"></a>00251     verts[1][0] = (double)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">/* iter over &#39;Y&#39; */</span>
<a name="l00254"></a>00254     verts[0][1] = verts[1][1] = y - dx *floor(y / dx);
<a name="l00255"></a>00255     <span class="keywordflow">while</span> (verts[0][1] &lt; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>) {
<a name="l00256"></a>00256         glDrawArrays(GL_LINES, 0, 2);
<a name="l00257"></a>00257         verts[0][1] = verts[1][1] = verts[0][1] + dx;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     glDisableClientState(GL_VERTEX_ARRAY);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">00263</a> <span class="preprocessor">#define GRID_MIN_PX 6.0f</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>
<a name="l00265"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a668c054ea0fa239d9f5b11ccb2a36eb9">00265</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a668c054ea0fa239d9f5b11ccb2a36eb9">drawgrid</a>(<a class="code" href="../../d8/da3/structUnitSettings.html">UnitSettings</a> *unit, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keyword">const</span> <span class="keywordtype">char</span> **grid_unit)
<a name="l00266"></a>00266 {
<a name="l00267"></a>00267     <span class="comment">/* extern short bgpicmode; */</span>
<a name="l00268"></a>00268     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l00269"></a>00269     <span class="keywordtype">double</span> wx, wy, x, y, fw, fx, fy, dx;
<a name="l00270"></a>00270     <span class="keywordtype">double</span> vec4[4];
<a name="l00271"></a>00271     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col[3], col2[3];
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     fx = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[3][0];
<a name="l00274"></a>00274     fy = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[3][1];
<a name="l00275"></a>00275     fw = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[3][3];
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     wx = (ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> / 2.0); <span class="comment">/* because of rounding errors, grid at wrong location */</span>
<a name="l00278"></a>00278     wy = (ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> / 2.0);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     x = (wx) * fx / fw;
<a name="l00281"></a>00281     y = (wy) * fy / fw;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     vec4[0] = vec4[1] = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a>;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     vec4[2] = 0.0;
<a name="l00286"></a>00286     vec4[3] = 1.0;
<a name="l00287"></a>00287     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a45d1a0bdd850cc5ba78032f37abec9c7">mul_m4_v4d</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, vec4);
<a name="l00288"></a>00288     fx = vec4[0];
<a name="l00289"></a>00289     fy = vec4[1];
<a name="l00290"></a>00290     fw = vec4[3];
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     dx = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(x - (wx) * fx / fw);
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (dx == 0) dx = <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(y - (wy) * fy / fw);
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     glDepthMask(0);     <span class="comment">// disable write in zbuffer</span>
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="comment">/* check zoom out */</span>
<a name="l00298"></a>00298     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00299"></a>00299     
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (unit-&gt;<a class="code" href="../../d8/da3/structUnitSettings.html#a3ac319ff602239809e75b3939a014846">system</a>) {
<a name="l00301"></a>00301         <span class="comment">/* Use GRID_MIN_PX*2 for units because very very small grid</span>
<a name="l00302"></a>00302 <span class="comment">         * items are less useful when dealing with units */</span>
<a name="l00303"></a>00303         <span class="keywordtype">void</span> *usys;
<a name="l00304"></a>00304         <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00305"></a>00305         <span class="keywordtype">double</span> dx_scalar;
<a name="l00306"></a>00306         <span class="keywordtype">float</span> blend_fac;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <a class="code" href="../../dd/d47/BKE__unit_8h.html#a9bceacecd685b282f5dbd4eb47daba64">bUnit_GetSystem</a>(&amp;usys, &amp;len, unit-&gt;<a class="code" href="../../d8/da3/structUnitSettings.html#a3ac319ff602239809e75b3939a014846">system</a>, <a class="code" href="../../dd/d47/BKE__unit_8h.html#a4779c1dd27e30d714b820dfc6adfb66b">B_UNIT_LENGTH</a>);
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (usys) {
<a name="l00311"></a>00311             i = <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00312"></a>00312             <span class="keywordflow">while</span> (i--) {
<a name="l00313"></a>00313                 <span class="keywordtype">double</span> scalar = <a class="code" href="../../dd/d47/BKE__unit_8h.html#a13a6f3cdbc2ba7ce961a663a3bb3610a">bUnit_GetScaler</a>(usys, i);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315                 dx_scalar = dx * scalar / unit-&gt;<a class="code" href="../../d8/da3/structUnitSettings.html#a0c970043cd1006145890fee0041a5161">scale_length</a>;
<a name="l00316"></a>00316                 <span class="keywordflow">if</span> (dx_scalar &lt; (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 2))
<a name="l00317"></a>00317                     <span class="keywordflow">continue</span>;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319                 <span class="comment">/* Store the smallest drawn grid size units name so users know how big each grid cell is */</span>
<a name="l00320"></a>00320                 <span class="keywordflow">if</span> (*grid_unit == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00321"></a>00321                     *grid_unit = <a class="code" href="../../dd/d47/BKE__unit_8h.html#a994876bbf5847e8e99102e3093bdc754">bUnit_GetNameDisplay</a>(usys, i);
<a name="l00322"></a>00322                     rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> = (scalar * v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a>) / unit-&gt;<a class="code" href="../../d8/da3/structUnitSettings.html#a0c970043cd1006145890fee0041a5161">scale_length</a>;
<a name="l00323"></a>00323                 }
<a name="l00324"></a>00324                 blend_fac = 1 - ((<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 2) / dx_scalar);
<a name="l00325"></a>00325 
<a name="l00326"></a>00326                 <span class="comment">/* tweak to have the fade a bit nicer */</span>
<a name="l00327"></a>00327                 blend_fac = (blend_fac * blend_fac) * 2.0f;
<a name="l00328"></a>00328                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(blend_fac, 0.3f, 1.0f);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 
<a name="l00331"></a>00331                 <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, blend_fac);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx_scalar);
<a name="l00334"></a>00334             }
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     <span class="keywordflow">else</span> {
<a name="l00338"></a>00338         <span class="keywordtype">short</span> sublines = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a69fc4ce9fb26597c3bc6d254aaab798e">gridsubdiv</a>;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (dx &lt; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a>) {
<a name="l00341"></a>00341             rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> *= sublines;
<a name="l00342"></a>00342             dx *= sublines;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344             <span class="keywordflow">if</span> (dx &lt; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a>) {
<a name="l00345"></a>00345                 rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> *= sublines;
<a name="l00346"></a>00346                 dx *= sublines;
<a name="l00347"></a>00347 
<a name="l00348"></a>00348                 <span class="keywordflow">if</span> (dx &lt; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a>) {
<a name="l00349"></a>00349                     rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> *= sublines;
<a name="l00350"></a>00350                     dx *= sublines;
<a name="l00351"></a>00351                     <span class="keywordflow">if</span> (dx &lt; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a>) ;
<a name="l00352"></a>00352                     <span class="keywordflow">else</span> {
<a name="l00353"></a>00353                         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00354"></a>00354                         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00355"></a>00355                     }
<a name="l00356"></a>00356                 }
<a name="l00357"></a>00357                 <span class="keywordflow">else</span> {  <span class="comment">// start blending out</span>
<a name="l00358"></a>00358                     <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, dx / (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 6));
<a name="l00359"></a>00359                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361                     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00362"></a>00362                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, sublines * dx);
<a name="l00363"></a>00363                 }
<a name="l00364"></a>00364             }
<a name="l00365"></a>00365             <span class="keywordflow">else</span> {  <span class="comment">// start blending out (GRID_MIN_PX &lt; dx &lt; (GRID_MIN_PX*10))</span>
<a name="l00366"></a>00366                 <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, dx / (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 6));
<a name="l00367"></a>00367                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00370"></a>00370                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, sublines * dx);
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373         <span class="keywordflow">else</span> {
<a name="l00374"></a>00374             <span class="keywordflow">if</span> (dx &gt; (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 10)) {      <span class="comment">// start blending in</span>
<a name="l00375"></a>00375                 rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> /= sublines;
<a name="l00376"></a>00376                 dx /= sublines;
<a name="l00377"></a>00377                 <span class="keywordflow">if</span> (dx &gt; (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 10)) {      <span class="comment">// start blending in</span>
<a name="l00378"></a>00378                     rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> /= sublines;
<a name="l00379"></a>00379                     dx /= sublines;
<a name="l00380"></a>00380                     <span class="keywordflow">if</span> (dx &gt; (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 10)) {
<a name="l00381"></a>00381                         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00382"></a>00382                         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00383"></a>00383                     }
<a name="l00384"></a>00384                     <span class="keywordflow">else</span> {
<a name="l00385"></a>00385                         <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, dx / (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 6));
<a name="l00386"></a>00386                         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00387"></a>00387                         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00388"></a>00388                         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx * sublines);
<a name="l00389"></a>00389                     }
<a name="l00390"></a>00390                 }
<a name="l00391"></a>00391                 <span class="keywordflow">else</span> {
<a name="l00392"></a>00392                     <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, dx / (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 6));
<a name="l00393"></a>00393                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00394"></a>00394                     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00395"></a>00395                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx * sublines);
<a name="l00396"></a>00396                 }
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398             <span class="keywordflow">else</span> {
<a name="l00399"></a>00399                 <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, dx / (<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a09e9947a76924997c8a2d9a417bbaf11">GRID_MIN_PX</a> * 6));
<a name="l00400"></a>00400                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx);
<a name="l00401"></a>00401                 <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>);
<a name="l00402"></a>00402                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a673c6e503f0768f6dd4a2944130626ec">drawgrid_draw</a>(ar, wx, wy, x, y, dx * sublines);
<a name="l00403"></a>00403             }
<a name="l00404"></a>00404         }
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     x += (wx);
<a name="l00409"></a>00409     y += (wy);
<a name="l00410"></a>00410     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, col);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l00413"></a>00413     
<a name="l00414"></a>00414     <span class="comment">/* center cross */</span>
<a name="l00415"></a>00415     <span class="comment">/* horizontal line */</span>
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab17ef620b0bbd3984797f7b2ce8ae0e8">RV3D_VIEW_RIGHT</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aa3aa72b66eac1968a06a39f969e219c6">RV3D_VIEW_LEFT</a>))
<a name="l00417"></a>00417         <a class="code" href="../../de/d96/UI__resources_8h.html#a0987940839c284639e62eaa495a117a3">UI_make_axis_color</a>(col, col2, <span class="charliteral">&#39;Y&#39;</span>);
<a name="l00418"></a>00418     <span class="keywordflow">else</span> <a class="code" href="../../de/d96/UI__resources_8h.html#a0987940839c284639e62eaa495a117a3">UI_make_axis_color</a>(col, col2, <span class="charliteral">&#39;X&#39;</span>);
<a name="l00419"></a>00419     glColor3ubv(col2);
<a name="l00420"></a>00420     
<a name="l00421"></a>00421     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(0.0,  y,  (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>,  y); 
<a name="l00422"></a>00422     
<a name="l00423"></a>00423     <span class="comment">/* vertical line */</span>
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ac5acba0a848d6772d09d715df8c0da68">RV3D_VIEW_TOP</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a800b582984a6cef2a8f4244ec5931ce9">RV3D_VIEW_BOTTOM</a>))
<a name="l00425"></a>00425         <a class="code" href="../../de/d96/UI__resources_8h.html#a0987940839c284639e62eaa495a117a3">UI_make_axis_color</a>(col, col2, <span class="charliteral">&#39;Y&#39;</span>);
<a name="l00426"></a>00426     <span class="keywordflow">else</span> <a class="code" href="../../de/d96/UI__resources_8h.html#a0987940839c284639e62eaa495a117a3">UI_make_axis_color</a>(col, col2, <span class="charliteral">&#39;Z&#39;</span>);
<a name="l00427"></a>00427     glColor3ubv(col2);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a7354f70d0e522da34583d29bbec4d194">fdrawline</a>(x, 0.0, x, (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>); 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     glDepthMask(1);     <span class="comment">// enable write in zbuffer</span>
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 <span class="preprocessor">#undef GRID_MIN_PX</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span>
<a name="l00435"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#afae188aa33a39b0e9126e5d641a2774c">00435</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#afae188aa33a39b0e9126e5d641a2774c">drawfloor</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keyword">const</span> <span class="keywordtype">char</span> **grid_unit)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437     <span class="keywordtype">float</span> grid, grid_scale;
<a name="l00438"></a>00438     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col_grid[3];
<a name="l00439"></a>00439     <span class="keyword">const</span> <span class="keywordtype">int</span> gridlines = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aadccf98762844bc1640c456817d65ae0">gridlines</a> / 2;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aadccf98762844bc1640c456817d65ae0">gridlines</a> &lt; 3) <span class="keywordflow">return</span>;
<a name="l00442"></a>00442     
<a name="l00443"></a>00443     grid_scale = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a>;
<a name="l00444"></a>00444     <span class="comment">/* use &#39;grid_scale&#39; instead of &#39;v3d-&gt;grid&#39; from now on */</span>
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <span class="comment">/* apply units */</span>
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a3ac319ff602239809e75b3939a014846">system</a>) {
<a name="l00448"></a>00448         <span class="keywordtype">void</span> *usys;
<a name="l00449"></a>00449         <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451         <a class="code" href="../../dd/d47/BKE__unit_8h.html#a9bceacecd685b282f5dbd4eb47daba64">bUnit_GetSystem</a>(&amp;usys, &amp;len, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a3ac319ff602239809e75b3939a014846">system</a>, <a class="code" href="../../dd/d47/BKE__unit_8h.html#a4779c1dd27e30d714b820dfc6adfb66b">B_UNIT_LENGTH</a>);
<a name="l00452"></a>00452 
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (usys) {
<a name="l00454"></a>00454             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = <a class="code" href="../../dd/d47/BKE__unit_8h.html#a721e61cb6935c5690589506832567956">bUnit_GetBaseUnit</a>(usys);
<a name="l00455"></a>00455             *grid_unit = <a class="code" href="../../dd/d47/BKE__unit_8h.html#a994876bbf5847e8e99102e3093bdc754">bUnit_GetNameDisplay</a>(usys, i);
<a name="l00456"></a>00456             grid_scale = (grid_scale * (float)<a class="code" href="../../dd/d47/BKE__unit_8h.html#a13a6f3cdbc2ba7ce961a663a3bb3610a">bUnit_GetScaler</a>(usys, i)) / scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>.<a class="code" href="../../d8/da3/structUnitSettings.html#a0c970043cd1006145890fee0041a5161">scale_length</a>;
<a name="l00457"></a>00457         }
<a name="l00458"></a>00458     }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     grid = gridlines * grid_scale;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>) glDepthMask(0);  <span class="comment">// for zbuffer-select</span>
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a295ee87ce46db238cf7fd0adeddcf83d">TH_GRID</a>, col_grid);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="comment">/* draw the Y axis and/or grid lines */</span>
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a37adbba9358d3056e49aa538bd0bd960">gridflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aefc15bee33771395e1804b1d33b61969">V3D_SHOW_FLOOR</a>) {
<a name="l00468"></a>00468         <span class="keywordtype">float</span> vert[4][3] = {{0.0f}};
<a name="l00469"></a>00469         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col_bg[3];
<a name="l00470"></a>00470         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col_grid_emphasise[3], col_grid_light[3];
<a name="l00471"></a>00471         <span class="keywordtype">int</span> a;
<a name="l00472"></a>00472         <span class="keywordtype">int</span> prev_emphasise = -1;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, col_bg);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="comment">/* emphasise division lines lighter instead of darker, if background is darker than grid */</span>
<a name="l00477"></a>00477         <a class="code" href="../../de/d96/UI__resources_8h.html#ae87f6e896bf12f03976d7781a0787aba">UI_GetColorPtrShade3ubv</a>(col_grid, col_grid_light, 10);
<a name="l00478"></a>00478         <a class="code" href="../../de/d96/UI__resources_8h.html#ae87f6e896bf12f03976d7781a0787aba">UI_GetColorPtrShade3ubv</a>(col_grid, col_grid_emphasise,
<a name="l00479"></a>00479                                 (((col_grid[0] + col_grid[1] + col_grid[2]) + 30) &gt;
<a name="l00480"></a>00480                                  (col_bg[0] + col_bg[1] + col_bg[2])) ? 20 : -10);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="comment">/* set fixed axis */</span>
<a name="l00483"></a>00483         vert[0][0] = vert[2][1] = grid;
<a name="l00484"></a>00484         vert[1][0] = vert[3][1] = -grid;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         glEnableClientState(GL_VERTEX_ARRAY);
<a name="l00487"></a>00487         glVertexPointer(3, GL_FLOAT, 0, vert);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="keywordflow">for</span> (a = -gridlines; a &lt;= gridlines; a++) {
<a name="l00490"></a>00490             <span class="keyword">const</span> <span class="keywordtype">float</span> line = a * grid_scale;
<a name="l00491"></a>00491             <span class="keyword">const</span> <span class="keywordtype">int</span> is_emphasise = (a % 10) == 0;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493             <span class="keywordflow">if</span> (is_emphasise != prev_emphasise) {
<a name="l00494"></a>00494                 glColor3ubv(is_emphasise ? col_grid_emphasise : col_grid_light);
<a name="l00495"></a>00495                 prev_emphasise = is_emphasise;
<a name="l00496"></a>00496             }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498             <span class="comment">/* set variable axis */</span>
<a name="l00499"></a>00499             vert[0][1] = vert[1][1] =
<a name="l00500"></a>00500             vert[2][0] = vert[3][0] = line;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502             glDrawArrays(GL_LINES, 0, 4);
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         glDisableClientState(GL_VERTEX_ARRAY);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <a class="code" href="../../da/deb/GPU__extensions_8h.html#ac53f460dc44712717c4a4369c248912e">GPU_print_error</a>(<span class="stringliteral">&quot;sdsd&quot;</span>);
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509     
<a name="l00510"></a>00510     <span class="comment">/* draw the Z axis line */</span>  
<a name="l00511"></a>00511     <span class="comment">/* check for the &#39;show Z axis&#39; preference */</span>
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a37adbba9358d3056e49aa538bd0bd960">gridflag</a> &amp; (<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab1f13e12fbc9aa7dfde7a301ace8ad8c">V3D_SHOW_X</a> | <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a96ee39bb05d78d9409d861aec5d57026">V3D_SHOW_Y</a> | <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a7a6ddc772c2839589a2b23ec7fed2d91">V3D_SHOW_Z</a>)) {
<a name="l00513"></a>00513         <span class="keywordtype">int</span> axis;
<a name="l00514"></a>00514         <span class="keywordflow">for</span> (axis = 0; axis &lt; 3; axis++) {
<a name="l00515"></a>00515             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a37adbba9358d3056e49aa538bd0bd960">gridflag</a> &amp; (<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab1f13e12fbc9aa7dfde7a301ace8ad8c">V3D_SHOW_X</a> &lt;&lt; axis)) {
<a name="l00516"></a>00516                 <span class="keywordtype">float</span> vert[3];
<a name="l00517"></a>00517                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> tcol[3];
<a name="l00518"></a>00518 
<a name="l00519"></a>00519                 <a class="code" href="../../de/d96/UI__resources_8h.html#a0987940839c284639e62eaa495a117a3">UI_make_axis_color</a>(col_grid, tcol, <span class="charliteral">&#39;X&#39;</span> + axis);
<a name="l00520"></a>00520                 glColor3ubv(tcol);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522                 glBegin(GL_LINE_STRIP);
<a name="l00523"></a>00523                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(vert);
<a name="l00524"></a>00524                 vert[axis] = grid;
<a name="l00525"></a>00525                 glVertex3fv(vert);
<a name="l00526"></a>00526                 vert[axis] = -grid;
<a name="l00527"></a>00527                 glVertex3fv(vert);
<a name="l00528"></a>00528                 glEnd();
<a name="l00529"></a>00529             }
<a name="l00530"></a>00530         }
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>) glDepthMask(1);
<a name="l00537"></a>00537     
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa3a737c48569fcd4ccf21ac58488b525">00540</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa3a737c48569fcd4ccf21ac58488b525">drawcursor</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="keywordtype">int</span> mx, my, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2];
<a name="l00543"></a>00543     <span class="keywordtype">int</span> flag;
<a name="l00544"></a>00544     
<a name="l00545"></a>00545     <span class="comment">/* we don&#39;t want the clipping for cursor */</span>
<a name="l00546"></a>00546     flag = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a>;
<a name="l00547"></a>00547     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> = 0;
<a name="l00548"></a>00548     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a32a0da6e4b20f5f14379c629f423f865">project_int</a>(ar, <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a56c6dfa9088d0f90552a67074a359c97">give_cursor</a>(scene, v3d), co);
<a name="l00549"></a>00549     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> = flag;
<a name="l00550"></a>00550     
<a name="l00551"></a>00551     mx = co[0];
<a name="l00552"></a>00552     my = co[1];
<a name="l00553"></a>00553     
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (mx != <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a9f2d1998b6b3d4dd9472a8092725e0ef">IS_CLIPPED</a>) {
<a name="l00555"></a>00555         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0); 
<a name="l00556"></a>00556         <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0xFF);
<a name="l00557"></a>00557         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a30827d412673b6d41bb128255520a525">circ</a>((<span class="keywordtype">float</span>)mx, (<span class="keywordtype">float</span>)my, 10.0);
<a name="l00558"></a>00558         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(4); 
<a name="l00559"></a>00559         <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0xFFFFFF);
<a name="l00560"></a>00560         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a30827d412673b6d41bb128255520a525">circ</a>((<span class="keywordtype">float</span>)mx, (<span class="keywordtype">float</span>)my, 10.0);
<a name="l00561"></a>00561         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l00562"></a>00562         <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0x0);
<a name="l00563"></a>00563         
<a name="l00564"></a>00564         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#af04b403c3fb94451facdc3a4fca476fc">sdrawline</a>(mx - 20, my, mx - 5, my);
<a name="l00565"></a>00565         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#af04b403c3fb94451facdc3a4fca476fc">sdrawline</a>(mx + 5, my, mx + 20, my);
<a name="l00566"></a>00566         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#af04b403c3fb94451facdc3a4fca476fc">sdrawline</a>(mx, my - 20, mx, my - 5);
<a name="l00567"></a>00567         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#af04b403c3fb94451facdc3a4fca476fc">sdrawline</a>(mx, my + 5, mx, my + 20);
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a>00571 <span class="comment">/* Draw a live substitute of the view icon, which is always shown</span>
<a name="l00572"></a>00572 <span class="comment"> * colors copied from transform_manipulator.c, we should keep these matching. */</span>
<a name="l00573"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a9c402a26b0c7abe32748e5426d1ee59c">00573</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a9c402a26b0c7abe32748e5426d1ee59c">draw_view_axis</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575     <span class="keyword">const</span> <span class="keywordtype">float</span> k = <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.rvisize;   <span class="comment">/* axis size */</span>
<a name="l00576"></a>00576     <span class="keyword">const</span> <span class="keywordtype">float</span> toll = 0.5;      <span class="comment">/* used to see when view is quasi-orthogonal */</span>
<a name="l00577"></a>00577     <span class="keyword">const</span> <span class="keywordtype">float</span> start = k + 1.0f; <span class="comment">/* axis center in screen coordinates, x=y */</span>
<a name="l00578"></a>00578     <span class="keywordtype">float</span> ydisp = 0.0;          <span class="comment">/* vertical displacement to allow obj info text */</span>
<a name="l00579"></a>00579     <span class="keywordtype">int</span> bright = 25 * (float)<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.rvibright + 5; <span class="comment">/* axis alpha (rvibright has range 0-10) */</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <span class="keywordtype">float</span> vec[3];
<a name="l00582"></a>00582     <span class="keywordtype">float</span> dx, dy;
<a name="l00583"></a>00583     
<a name="l00584"></a>00584     <span class="comment">/* thickness of lines is proportional to k */</span>
<a name="l00585"></a>00585     glLineWidth(2);
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     glEnable(GL_BLEND);
<a name="l00588"></a>00588     glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="comment">/* X */</span>
<a name="l00591"></a>00591     vec[0] = 1;
<a name="l00592"></a>00592     vec[1] = vec[2] = 0;
<a name="l00593"></a>00593     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a5b66d29020ddf25dfef66674677e84ff">viewquat</a>, vec);
<a name="l00594"></a>00594     dx = vec[0] * k;
<a name="l00595"></a>00595     dy = vec[1] * k;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     glColor4ub(220, 0, 0, bright);
<a name="l00598"></a>00598     glBegin(GL_LINES);
<a name="l00599"></a>00599     glVertex2f(start, start + ydisp);
<a name="l00600"></a>00600     glVertex2f(start + dx, start + dy + ydisp);
<a name="l00601"></a>00601     glEnd();
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx) &gt; toll || <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy) &gt; toll) {
<a name="l00604"></a>00604         <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(start + dx + 2, start + dy + ydisp + 2, 0.0f, <span class="stringliteral">&quot;x&quot;</span>, 1);
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606     
<a name="l00607"></a>00607     <span class="comment">/* BLF_draw_default disables blending */</span>
<a name="l00608"></a>00608     glEnable(GL_BLEND);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     <span class="comment">/* Y */</span>
<a name="l00611"></a>00611     vec[1] = 1;
<a name="l00612"></a>00612     vec[0] = vec[2] = 0;
<a name="l00613"></a>00613     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a5b66d29020ddf25dfef66674677e84ff">viewquat</a>, vec);
<a name="l00614"></a>00614     dx = vec[0] * k;
<a name="l00615"></a>00615     dy = vec[1] * k;
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     glColor4ub(0, 220, 0, bright);
<a name="l00618"></a>00618     glBegin(GL_LINES);
<a name="l00619"></a>00619     glVertex2f(start, start + ydisp);
<a name="l00620"></a>00620     glVertex2f(start + dx, start + dy + ydisp);
<a name="l00621"></a>00621     glEnd();
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx) &gt; toll || <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy) &gt; toll) {
<a name="l00624"></a>00624         <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(start + dx + 2, start + dy + ydisp + 2, 0.0f, <span class="stringliteral">&quot;y&quot;</span>, 1);
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     glEnable(GL_BLEND);
<a name="l00628"></a>00628     
<a name="l00629"></a>00629     <span class="comment">/* Z */</span>
<a name="l00630"></a>00630     vec[2] = 1;
<a name="l00631"></a>00631     vec[1] = vec[0] = 0;
<a name="l00632"></a>00632     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a5b66d29020ddf25dfef66674677e84ff">viewquat</a>, vec);
<a name="l00633"></a>00633     dx = vec[0] * k;
<a name="l00634"></a>00634     dy = vec[1] * k;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     glColor4ub(30, 30, 220, bright);
<a name="l00637"></a>00637     glBegin(GL_LINES);
<a name="l00638"></a>00638     glVertex2f(start, start + ydisp);
<a name="l00639"></a>00639     glVertex2f(start + dx, start + dy + ydisp);
<a name="l00640"></a>00640     glEnd();
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dx) &gt; toll || <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(dy) &gt; toll) {
<a name="l00643"></a>00643         <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(start + dx + 2, start + dy + ydisp + 2, 0.0f, <span class="stringliteral">&quot;z&quot;</span>, 1);
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <span class="comment">/* restore line-width */</span>
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     glLineWidth(1.0);
<a name="l00649"></a>00649     glDisable(GL_BLEND);
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652 <span class="comment">/* draw center and axis of rotation for ongoing 3D mouse navigation */</span>
<a name="l00653"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a407fbaf3b1e04c51c650e4e76981032d">00653</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a407fbaf3b1e04c51c650e4e76981032d">draw_rotation_guide</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655     <span class="keywordtype">float</span> o[3]; <span class="comment">// center of rotation</span>
<a name="l00656"></a>00656     <span class="keywordtype">float</span> end[3]; <span class="comment">// endpoints for drawing</span>
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="keywordtype">float</span> color[4] = {0.0f, 0.4235f, 1.0f, 1.0f}; <span class="comment">// bright blue so it matches device LEDs</span>
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(o, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a6ce0a5c0ad773034009ed39f47a26061">ofs</a>);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     glEnable(GL_BLEND);
<a name="l00663"></a>00663     glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
<a name="l00664"></a>00664     glShadeModel(GL_SMOOTH);
<a name="l00665"></a>00665     glPointSize(5);
<a name="l00666"></a>00666     glEnable(GL_POINT_SMOOTH);
<a name="l00667"></a>00667     glDepthMask(0); <span class="comment">// don&#39;t overwrite zbuf</span>
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a6ba7ae8df160c278ede21475e264b912">rot_angle</a> != 0.f) {
<a name="l00670"></a>00670         <span class="comment">// -- draw rotation axis --</span>
<a name="l00671"></a>00671         <span class="keywordtype">float</span> scaled_axis[3];
<a name="l00672"></a>00672         <span class="keyword">const</span> <span class="keywordtype">float</span> scale = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a5a4f191256ccc5c28828b922636ca588">dist</a>;
<a name="l00673"></a>00673         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad32a55246dbd69dbd150cd3fe480c734">mul_v3_v3fl</a>(scaled_axis, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a42d0fd2fe9e2c0fbc38f4512329bb087">rot_axis</a>, scale);
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         glBegin(GL_LINE_STRIP);
<a name="l00677"></a>00677         color[3] = 0.f; <span class="comment">// more transparent toward the ends</span>
<a name="l00678"></a>00678         glColor4fv(color);
<a name="l00679"></a>00679         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(end, o, scaled_axis);
<a name="l00680"></a>00680         glVertex3fv(end);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682         <span class="comment">// color[3] = 0.2f + fabsf(rv3d-&gt;rot_angle); // modulate opacity with angle</span>
<a name="l00683"></a>00683         <span class="comment">// ^^ neat idea, but angle is frame-rate dependent, so it&#39;s usually close to 0.2</span>
<a name="l00684"></a>00684 
<a name="l00685"></a>00685         color[3] = 0.5f; <span class="comment">// more opaque toward the center</span>
<a name="l00686"></a>00686         glColor4fv(color);
<a name="l00687"></a>00687         glVertex3fv(o);
<a name="l00688"></a>00688 
<a name="l00689"></a>00689         color[3] = 0.f;
<a name="l00690"></a>00690         glColor4fv(color);
<a name="l00691"></a>00691         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(end, o, scaled_axis);
<a name="l00692"></a>00692         glVertex3fv(end);
<a name="l00693"></a>00693         glEnd();
<a name="l00694"></a>00694         
<a name="l00695"></a>00695         <span class="comment">// -- draw ring around rotation center --</span>
<a name="l00696"></a>00696         {
<a name="l00697"></a>00697 <span class="preprocessor">#define     ROT_AXIS_DETAIL 13</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span>
<a name="l00699"></a>00699             <span class="keyword">const</span> <span class="keywordtype">float</span> s = 0.05f * scale;
<a name="l00700"></a>00700             <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = 2.f * (float)(<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a5651841c5c9de2329b7591f26d8d551b">ROT_AXIS_DETAIL</a>);
<a name="l00701"></a>00701             <span class="keywordtype">float</span> <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>;
<a name="l00702"></a>00702             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704             <span class="keywordtype">float</span> q[4]; <span class="comment">// rotate ring so it&#39;s perpendicular to axis</span>
<a name="l00705"></a>00705             <span class="keyword">const</span> <span class="keywordtype">int</span> upright = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a42d0fd2fe9e2c0fbc38f4512329bb087">rot_axis</a>[2]) &gt;= 0.95f;
<a name="l00706"></a>00706             <span class="keywordflow">if</span> (!upright) {
<a name="l00707"></a>00707                 <span class="keyword">const</span> <span class="keywordtype">float</span> up[3] = {0.f, 0.f, 1.f};
<a name="l00708"></a>00708                 <span class="keywordtype">float</span> vis_angle, vis_axis[3];
<a name="l00709"></a>00709 
<a name="l00710"></a>00710                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(vis_axis, up, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a42d0fd2fe9e2c0fbc38f4512329bb087">rot_axis</a>);
<a name="l00711"></a>00711                 vis_angle = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ae7aa722c12d27ad606ae1011f0432b00">acosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(up, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a42d0fd2fe9e2c0fbc38f4512329bb087">rot_axis</a>));
<a name="l00712"></a>00712                 <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a31e0d088e5faae71dd3e9e4232f7c2a5">axis_angle_to_quat</a>(q, vis_axis, vis_angle);
<a name="l00713"></a>00713             }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715             color[3] = 0.25f; <span class="comment">// somewhat faint</span>
<a name="l00716"></a>00716             glColor4fv(color);
<a name="l00717"></a>00717             glBegin(GL_LINE_LOOP);
<a name="l00718"></a>00718             <span class="keywordflow">for</span> (i = 0, angle = 0.f; i &lt; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a5651841c5c9de2329b7591f26d8d551b">ROT_AXIS_DETAIL</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, angle += <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>) {
<a name="l00719"></a>00719                 <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3] = {s * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(angle), s * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(angle), 0.0f};
<a name="l00720"></a>00720 
<a name="l00721"></a>00721                 <span class="keywordflow">if</span> (!upright) {
<a name="l00722"></a>00722                     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(q, p);
<a name="l00723"></a>00723                 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(p, o);
<a name="l00726"></a>00726                 glVertex3fv(p);
<a name="l00727"></a>00727             }
<a name="l00728"></a>00728             glEnd();
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 <span class="preprocessor">#undef      ROT_AXIS_DETAIL</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>        }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         color[3] = 1.f; <span class="comment">// solid dot</span>
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735     <span class="keywordflow">else</span>
<a name="l00736"></a>00736         color[3] = 0.5f;  <span class="comment">// see-through dot</span>
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">// -- draw rotation center --</span>
<a name="l00739"></a>00739     glColor4fv(color);
<a name="l00740"></a>00740     glBegin(GL_POINTS);
<a name="l00741"></a>00741     glVertex3fv(o);
<a name="l00742"></a>00742     glEnd();
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// find screen coordinates for rotation center, then draw pretty icon</span>
<a name="l00745"></a>00745     <span class="comment">// mul_m4_v3(rv3d-&gt;persinv, rot_center);</span>
<a name="l00746"></a>00746     <span class="comment">// UI_icon_draw(rot_center[0], rot_center[1], ICON_NDOF_TURN);</span>
<a name="l00747"></a>00747     <span class="comment">// ^^ just playing around, does not work</span>
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     glDisable(GL_BLEND);
<a name="l00750"></a>00750     glDisable(GL_POINT_SMOOTH);
<a name="l00751"></a>00751     glDepthMask(1);
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aed7865fc395c28d8d0ffb090d6b67b3c">00754</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aed7865fc395c28d8d0ffb090d6b67b3c">draw_view_icon</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756     <a class="code" href="../../de/d96/UI__resources_8h.html#a417b8dd4eb2a193adc74b00ff7319def">BIFIconID</a> icon;
<a name="l00757"></a>00757     
<a name="l00758"></a>00758     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ac5acba0a848d6772d09d715df8c0da68">RV3D_VIEW_TOP</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a800b582984a6cef2a8f4244ec5931ce9">RV3D_VIEW_BOTTOM</a>))
<a name="l00759"></a>00759         icon = ICON_AXIS_TOP;
<a name="l00760"></a>00760     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aed9a26ef0efa80c319cb14716ec229f6">RV3D_VIEW_FRONT</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5512e0f1ec94b225df69916eff1726a6">RV3D_VIEW_BACK</a>))
<a name="l00761"></a>00761         icon = ICON_AXIS_FRONT;
<a name="l00762"></a>00762     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab17ef620b0bbd3984797f7b2ce8ae0e8">RV3D_VIEW_RIGHT</a>, <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aa3aa72b66eac1968a06a39f969e219c6">RV3D_VIEW_LEFT</a>))
<a name="l00763"></a>00763         icon = ICON_AXIS_SIDE;
<a name="l00764"></a>00764     <span class="keywordflow">else</span> <span class="keywordflow">return</span>;
<a name="l00765"></a>00765     
<a name="l00766"></a>00766     glEnable(GL_BLEND);
<a name="l00767"></a>00767     glBlendFunc(GL_SRC_ALPHA,  GL_ONE_MINUS_SRC_ALPHA); 
<a name="l00768"></a>00768     
<a name="l00769"></a>00769     <a class="code" href="../../d8/de1/UI__interface__icons_8h.html#a56d1cf9aeb53e23b3eefc13be1124a9e">UI_icon_draw</a>(5.0, 5.0, icon);
<a name="l00770"></a>00770     
<a name="l00771"></a>00771     glDisable(GL_BLEND);
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#afa0a722123a8f159f74989fab8e4fb31">00774</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d8/d7f/view3d__draw_8c.html#afa0a722123a8f159f74989fab8e4fb31">view3d_get_name</a>(<a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d)
<a name="l00775"></a>00775 {
<a name="l00776"></a>00776     <span class="keyword">const</span> <span class="keywordtype">char</span> *name = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00777"></a>00777     
<a name="l00778"></a>00778     <span class="keywordflow">switch</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>) {
<a name="l00779"></a>00779         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aed9a26ef0efa80c319cb14716ec229f6">RV3D_VIEW_FRONT</a>:
<a name="l00780"></a>00780             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Front Ortho&quot;</span>;
<a name="l00781"></a>00781             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Front Persp&quot;</span>;
<a name="l00782"></a>00782             <span class="keywordflow">break</span>;
<a name="l00783"></a>00783         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5512e0f1ec94b225df69916eff1726a6">RV3D_VIEW_BACK</a>:
<a name="l00784"></a>00784             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Back Ortho&quot;</span>;
<a name="l00785"></a>00785             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Back Persp&quot;</span>;
<a name="l00786"></a>00786             <span class="keywordflow">break</span>;
<a name="l00787"></a>00787         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ac5acba0a848d6772d09d715df8c0da68">RV3D_VIEW_TOP</a>:
<a name="l00788"></a>00788             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Top Ortho&quot;</span>;
<a name="l00789"></a>00789             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Top Persp&quot;</span>;
<a name="l00790"></a>00790             <span class="keywordflow">break</span>;
<a name="l00791"></a>00791         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a800b582984a6cef2a8f4244ec5931ce9">RV3D_VIEW_BOTTOM</a>:
<a name="l00792"></a>00792             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Bottom Ortho&quot;</span>;
<a name="l00793"></a>00793             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Bottom Persp&quot;</span>;
<a name="l00794"></a>00794             <span class="keywordflow">break</span>;
<a name="l00795"></a>00795         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab17ef620b0bbd3984797f7b2ce8ae0e8">RV3D_VIEW_RIGHT</a>:
<a name="l00796"></a>00796             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Right Ortho&quot;</span>;
<a name="l00797"></a>00797             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Right Persp&quot;</span>;
<a name="l00798"></a>00798             <span class="keywordflow">break</span>;
<a name="l00799"></a>00799         <span class="keywordflow">case</span> <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#aa3aa72b66eac1968a06a39f969e219c6">RV3D_VIEW_LEFT</a>:
<a name="l00800"></a>00800             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) name = <span class="stringliteral">&quot;Left Ortho&quot;</span>;
<a name="l00801"></a>00801             <span class="keywordflow">else</span> name = <span class="stringliteral">&quot;Left Persp&quot;</span>;
<a name="l00802"></a>00802             <span class="keywordflow">break</span>;
<a name="l00803"></a>00803             
<a name="l00804"></a>00804         <span class="keywordflow">default</span>:
<a name="l00805"></a>00805             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>) {
<a name="l00806"></a>00806                 <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>) &amp;&amp; (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#afd7fa4376c670f245aeed7a7116c7005">OB_CAMERA</a>)) {
<a name="l00807"></a>00807                     <a class="code" href="../../d7/d7e/structCamera.html">Camera</a> *cam;
<a name="l00808"></a>00808                     cam = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00809"></a>00809                     name = (cam-&gt;<a class="code" href="../../d7/d7e/structCamera.html#abd4c2c91f9398b35caaa737a7bc6da3b">type</a> != <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a75085da10f07c9a36e9a305ca2ecc6d8">CAM_ORTHO</a>) ? <span class="stringliteral">&quot;Camera Persp&quot;</span> : <span class="stringliteral">&quot;Camera Ortho&quot;</span>;
<a name="l00810"></a>00810                 }
<a name="l00811"></a>00811                 <span class="keywordflow">else</span> {
<a name="l00812"></a>00812                     name = <span class="stringliteral">&quot;Object as Camera&quot;</span>;
<a name="l00813"></a>00813                 }
<a name="l00814"></a>00814             }
<a name="l00815"></a>00815             <span class="keywordflow">else</span> {
<a name="l00816"></a>00816                 name = (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>) ? <span class="stringliteral">&quot;User Ortho&quot;</span> : <span class="stringliteral">&quot;User Persp&quot;</span>;
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818             <span class="keywordflow">break</span>;
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820     
<a name="l00821"></a>00821     <span class="keywordflow">return</span> name;
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a40d88582e428f0c6dbf1516028f4e55d">00824</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a40d88582e428f0c6dbf1516028f4e55d">draw_viewport_name</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l00825"></a>00825 {
<a name="l00826"></a>00826     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l00827"></a>00827     <span class="keyword">const</span> <span class="keywordtype">char</span> *name = <a class="code" href="../../d8/d7f/view3d__draw_8c.html#afa0a722123a8f159f74989fab8e4fb31">view3d_get_name</a>(v3d, rv3d);
<a name="l00828"></a>00828     <span class="keywordtype">char</span> tmpstr[24];
<a name="l00829"></a>00829     
<a name="l00830"></a>00830     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a7e87bb98f5f62744d30d1accb87cc664">localvd</a>) {
<a name="l00831"></a>00831         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(tmpstr, <span class="keyword">sizeof</span>(tmpstr), <span class="stringliteral">&quot;%s (Local)&quot;</span>, name);
<a name="l00832"></a>00832         name = tmpstr;
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (name) {
<a name="l00836"></a>00836         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l00837"></a>00837         <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(22,  ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> - 17, 0.0f, name, <span class="keyword">sizeof</span>(tmpstr));
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839 }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841 <span class="comment">/* draw info beside axes in bottom left-corner: </span>
<a name="l00842"></a>00842 <span class="comment"> * framenum, object name, bone name (if available), marker name (if available)</span>
<a name="l00843"></a>00843 <span class="comment"> */</span>
<a name="l00844"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a992bbd27274a7c22f27ed7722eee62d3">00844</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a992bbd27274a7c22f27ed7722eee62d3">draw_selected_name</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00845"></a>00845 {
<a name="l00846"></a>00846     <span class="keywordtype">char</span> info[256], *markern;
<a name="l00847"></a>00847     <span class="keywordtype">short</span> offset = 30;
<a name="l00848"></a>00848     
<a name="l00849"></a>00849     <span class="comment">/* get name of marker on current frame (if available) */</span>
<a name="l00850"></a>00850     markern = <a class="code" href="../../d8/d53/BKE__scene_8h.html#a445f2eea7e4e6bae699e484d61e49838">scene_find_marker_name</a>(scene, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l00851"></a>00851     
<a name="l00852"></a>00852     <span class="comment">/* check if there is an object */</span>
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (ob) {
<a name="l00854"></a>00854         <span class="comment">/* name(s) to display depends on type of object */</span>
<a name="l00855"></a>00855         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>) {
<a name="l00856"></a>00856             <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00857"></a>00857             <span class="keywordtype">char</span> *name = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00858"></a>00858             
<a name="l00859"></a>00859             <span class="comment">/* show name of active bone too (if possible) */</span>
<a name="l00860"></a>00860             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#adb3f7d11765ffd0276f5a68739e69d65">edbo</a>) {
<a name="l00861"></a>00861 
<a name="l00862"></a>00862                 <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>)
<a name="l00863"></a>00863                     name = ((<a class="code" href="../../da/d29/structEditBone.html">EditBone</a> *)arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac80d7a4b51181d91973980e19375019a">act_edbone</a>)-&gt;name;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865             }
<a name="l00866"></a>00866             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550acfed9b4bf4a7e2d3c5ae0b3571e38950">OB_MODE_POSE</a>) {
<a name="l00867"></a>00867                 <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>) {
<a name="l00868"></a>00868 
<a name="l00869"></a>00869                     <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a7050e920284a4c3c13fab5c79c141a48">layer</a> &amp; arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#ac14cfbfc02b044a0a9b933dcbe002780">layer</a>)
<a name="l00870"></a>00870                         name = arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872                 }
<a name="l00873"></a>00873             }
<a name="l00874"></a>00874             <span class="keywordflow">if</span> (name &amp;&amp; markern)
<a name="l00875"></a>00875                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s %s &lt;%s&gt;&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, name, markern);
<a name="l00876"></a>00876             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (name)
<a name="l00877"></a>00877                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s %s&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, name);
<a name="l00878"></a>00878             <span class="keywordflow">else</span>
<a name="l00879"></a>00879                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2);
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a648672abc238f500c884f10b9416cb27">OB_LATTICE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>)) {
<a name="l00882"></a>00882             <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00883"></a>00883             <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00884"></a>00884             <span class="keywordtype">char</span> shapes[<a class="code" href="../../d1/db4/DNA__defs_8h.html#ac7c0207aa5a0e10d378be03b68041350">MAX_NAME</a> + 10];
<a name="l00885"></a>00885             
<a name="l00886"></a>00886             <span class="comment">/* try to display active shapekey too */</span>
<a name="l00887"></a>00887             shapes[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00888"></a>00888             key = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l00889"></a>00889             <span class="keywordflow">if</span> (key) {
<a name="l00890"></a>00890                 kb = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a> - 1);
<a name="l00891"></a>00891                 <span class="keywordflow">if</span> (kb) {
<a name="l00892"></a>00892                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(shapes, <span class="keyword">sizeof</span>(shapes), <span class="stringliteral">&quot;: %s &quot;</span>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>);
<a name="l00893"></a>00893                     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#af406445af536997110fc334c24854005">shapeflag</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ad1667fc11fcfbed9a6bef142eeae94ee">OB_SHAPE_LOCK</a>) {
<a name="l00894"></a>00894                         strcat(shapes, <span class="stringliteral">&quot; (Pinned)&quot;</span>);
<a name="l00895"></a>00895                     }
<a name="l00896"></a>00896                 }
<a name="l00897"></a>00897             }
<a name="l00898"></a>00898             
<a name="l00899"></a>00899             <span class="keywordflow">if</span> (markern)
<a name="l00900"></a>00900                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s %s &lt;%s&gt;&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, shapes, markern);
<a name="l00901"></a>00901             <span class="keywordflow">else</span>
<a name="l00902"></a>00902                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s %s&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, shapes);
<a name="l00903"></a>00903         }
<a name="l00904"></a>00904         <span class="keywordflow">else</span> {
<a name="l00905"></a>00905             <span class="comment">/* standard object */</span>
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (markern)
<a name="l00907"></a>00907                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s &lt;%s&gt;&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, markern);
<a name="l00908"></a>00908             <span class="keywordflow">else</span>
<a name="l00909"></a>00909                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) %s&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2);
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911         
<a name="l00912"></a>00912         <span class="comment">/* color depends on whether there is a keyframe */</span>
<a name="l00913"></a>00913         <span class="keywordflow">if</span> (<a class="code" href="../../db/d4b/keyframing_8c.html#a4cda2e124c74f3f41223a506596cf574">id_frame_has_keyframe</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ob, <span class="comment">/*BKE_curframe(scene)*/</span> (<span class="keywordtype">float</span>)(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>), <a class="code" href="../../da/df9/ED__keyframing_8h.html#a0f8d1b1217f7ecc8169839e15056a1d5a59cde8742d6436ab6868e5c6d02f2ca6">ANIMFILTER_KEYS_LOCAL</a>))
<a name="l00914"></a>00914             <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a99466ebe41be745cf51950acc8423924">TH_VERTEX_SELECT</a>);
<a name="l00915"></a>00915         <span class="keywordflow">else</span>
<a name="l00916"></a>00916             <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l00917"></a>00917     }
<a name="l00918"></a>00918     <span class="keywordflow">else</span> {
<a name="l00919"></a>00919         <span class="comment">/* no object */</span>
<a name="l00920"></a>00920         <span class="keywordflow">if</span> (markern)
<a name="l00921"></a>00921             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d) &lt;%s&gt;&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, markern);
<a name="l00922"></a>00922         <span class="keywordflow">else</span>
<a name="l00923"></a>00923             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(info, <span class="keyword">sizeof</span>(info), <span class="stringliteral">&quot;(%d)&quot;</span>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l00924"></a>00924         
<a name="l00925"></a>00925         <span class="comment">/* color is always white */</span>
<a name="l00926"></a>00926         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l00927"></a>00927     }
<a name="l00928"></a>00928     
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a64d0bac516201640cc856e5428bca351">USER_SHOW_ROTVIEWICON</a>)
<a name="l00930"></a>00930         offset = 14 + (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.rvisize * 2);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <a class="code" href="../../df/d5d/BLF__api_8h.html#a9b623b39b9d6f9049b0777f431d8e76e">BLF_draw_default</a>(offset,  10, 0.0f, info, <span class="keyword">sizeof</span>(info));
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a367c4bd962dfda37e0cf5eeb6e94ad69">00935</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a367c4bd962dfda37e0cf5eeb6e94ad69">view3d_camera_border</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d,
<a name="l00936"></a>00936                                  <a class="code" href="../../da/d10/structrctf.html">rctf</a> *viewborder_r, <span class="keywordtype">short</span> no_shift, <span class="keywordtype">short</span> no_zoom)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <a class="code" href="../../d4/daf/structCameraParams.html">CameraParams</a> params;
<a name="l00939"></a>00939     <a class="code" href="../../da/d10/structrctf.html">rctf</a> rect_view, rect_camera;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">/* get viewport viewplane */</span>
<a name="l00942"></a>00942     <a class="code" href="../../d2/dff/BKE__camera_8h.html#a114faeb2a77048e814e5a120d29026b3">camera_params_init</a>(&amp;params);
<a name="l00943"></a>00943     <a class="code" href="../../d2/dff/BKE__camera_8h.html#a2c373e6795dbb537d98547fdc4e5addf">camera_params_from_view3d</a>(&amp;params, v3d, rv3d);
<a name="l00944"></a>00944     <span class="keywordflow">if</span> (no_zoom)
<a name="l00945"></a>00945         params.<a class="code" href="../../d4/daf/structCameraParams.html#a434fdd5fd869725d57df6c4127ede5a7">zoom</a> = 1.0f;
<a name="l00946"></a>00946     <a class="code" href="../../d2/dff/BKE__camera_8h.html#af290ff2b9dc901aae0f54d62f44c0e1a">camera_params_compute_viewplane</a>(&amp;params, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>, 1.0f, 1.0f);
<a name="l00947"></a>00947     rect_view = params.<a class="code" href="../../d4/daf/structCameraParams.html#ac9c3eb8d20281908932c41b6e370abbd">viewplane</a>;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="comment">/* get camera viewplane */</span>
<a name="l00950"></a>00950     <a class="code" href="../../d2/dff/BKE__camera_8h.html#a114faeb2a77048e814e5a120d29026b3">camera_params_init</a>(&amp;params);
<a name="l00951"></a>00951     <a class="code" href="../../d2/dff/BKE__camera_8h.html#ac561da82b9e128bc2020a2d4e4d2ddd8">camera_params_from_object</a>(&amp;params, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>);
<a name="l00952"></a>00952     <span class="keywordflow">if</span> (no_shift) {
<a name="l00953"></a>00953         params.<a class="code" href="../../d4/daf/structCameraParams.html#af5ace798d9dad9f6560630373ba278c9">shiftx</a> = 0.0f;
<a name="l00954"></a>00954         params.<a class="code" href="../../d4/daf/structCameraParams.html#a1c3926b9baef104772ac603f7425dc93">shifty</a> = 0.0f;
<a name="l00955"></a>00955     }
<a name="l00956"></a>00956     <a class="code" href="../../d2/dff/BKE__camera_8h.html#af290ff2b9dc901aae0f54d62f44c0e1a">camera_params_compute_viewplane</a>(&amp;params, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afac89783028ff848f111de04e0c29fbe">xsch</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aca3c1ebdf50a6c74730e19e24983217d">ysch</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>);
<a name="l00957"></a>00957     rect_camera = params.<a class="code" href="../../d4/daf/structCameraParams.html#ac9c3eb8d20281908932c41b6e370abbd">viewplane</a>;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="comment">/* get camera border within viewport */</span>
<a name="l00960"></a>00960     viewborder_r-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = ((rect_camera.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) / (rect_view.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)) * ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l00961"></a>00961     viewborder_r-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = ((rect_camera.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) / (rect_view.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>)) * ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l00962"></a>00962     viewborder_r-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = ((rect_camera.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) / (rect_view.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)) * ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l00963"></a>00963     viewborder_r-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = ((rect_camera.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) / (rect_view.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - rect_view.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>)) * ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a508bc9f826f982b86a12c8d43f3f0e98">00966</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aedad8f71cc33ab4f2dceabd8fe5737f2">ED_view3d_calc_camera_border_size</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d, <span class="keywordtype">float</span> size_r[2])
<a name="l00967"></a>00967 {
<a name="l00968"></a>00968     <a class="code" href="../../da/d10/structrctf.html">rctf</a> viewborder;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a367c4bd962dfda37e0cf5eeb6e94ad69">view3d_camera_border</a>(scene, ar, v3d, rv3d, &amp;viewborder, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00971"></a>00971     size_r[0] = viewborder.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> - viewborder.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l00972"></a>00972     size_r[1] = viewborder.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> - viewborder.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a4c0a015c3de9550858388e8d956987c2">00975</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a349ace3e118822009091d74b91175218">ED_view3d_calc_camera_border</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d,
<a name="l00976"></a>00976                                   <a class="code" href="../../da/d10/structrctf.html">rctf</a> *viewborder_r, <span class="keywordtype">short</span> no_shift)
<a name="l00977"></a>00977 {
<a name="l00978"></a>00978     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a367c4bd962dfda37e0cf5eeb6e94ad69">view3d_camera_border</a>(scene, ar, v3d, rv3d, viewborder_r, no_shift, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a67fe21f9010b6a624fb2f41c2ab9b97a">00981</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a67fe21f9010b6a624fb2f41c2ab9b97a">drawviewborder_grid3</a>(<span class="keywordtype">float</span> x1, <span class="keywordtype">float</span> x2, <span class="keywordtype">float</span> y1, <span class="keywordtype">float</span> y2, <span class="keywordtype">float</span> fac)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983     <span class="keywordtype">float</span> x3, y3, x4, y4;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     x3 = x1 + fac * (x2 - x1);
<a name="l00986"></a>00986     y3 = y1 + fac * (y2 - y1);
<a name="l00987"></a>00987     x4 = x1 + (1.0f - fac) * (x2 - x1);
<a name="l00988"></a>00988     y4 = y1 + (1.0f - fac) * (y2 - y1);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     glBegin(GL_LINES);
<a name="l00991"></a>00991     glVertex2f(x1, y3);
<a name="l00992"></a>00992     glVertex2f(x2, y3);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     glVertex2f(x1, y4);
<a name="l00995"></a>00995     glVertex2f(x2, y4);
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     glVertex2f(x3, y1);
<a name="l00998"></a>00998     glVertex2f(x3, y2);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     glVertex2f(x4, y1);
<a name="l01001"></a>01001     glVertex2f(x4, y2);
<a name="l01002"></a>01002     glEnd();
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 <span class="comment">/* harmonious triangle */</span>
<a name="l01006"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">01006</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">drawviewborder_triangle</a>(<span class="keywordtype">float</span> x1, <span class="keywordtype">float</span> x2, <span class="keywordtype">float</span> y1, <span class="keywordtype">float</span> y2, <span class="keyword">const</span> <span class="keywordtype">char</span> golden, <span class="keyword">const</span> <span class="keywordtype">char</span> dir)
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008     <span class="keywordtype">float</span> ofs;
<a name="l01009"></a>01009     <span class="keywordtype">float</span> w = x2 - x1;
<a name="l01010"></a>01010     <span class="keywordtype">float</span> h = y2 - y1;
<a name="l01011"></a>01011 
<a name="l01012"></a>01012     glBegin(GL_LINES);
<a name="l01013"></a>01013     <span class="keywordflow">if</span> (w &gt; h) {
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (golden) {
<a name="l01015"></a>01015             ofs = w * (1.0f - (1.0f / 1.61803399f));
<a name="l01016"></a>01016         }
<a name="l01017"></a>01017         <span class="keywordflow">else</span> {
<a name="l01018"></a>01018             ofs = h * (h / w);
<a name="l01019"></a>01019         }
<a name="l01020"></a>01020         <span class="keywordflow">if</span> (dir == <span class="charliteral">&#39;B&#39;</span>) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, y1, y2);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         glVertex2f(x1, y1);
<a name="l01023"></a>01023         glVertex2f(x2, y2);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025         glVertex2f(x2, y1);
<a name="l01026"></a>01026         glVertex2f(x1 + (w - ofs), y2);
<a name="l01027"></a>01027 
<a name="l01028"></a>01028         glVertex2f(x1, y2);
<a name="l01029"></a>01029         glVertex2f(x1 + ofs, y1);
<a name="l01030"></a>01030     }
<a name="l01031"></a>01031     <span class="keywordflow">else</span> {
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (golden) {
<a name="l01033"></a>01033             ofs = h * (1.0f - (1.0f / 1.61803399f));
<a name="l01034"></a>01034         }
<a name="l01035"></a>01035         <span class="keywordflow">else</span> {
<a name="l01036"></a>01036             ofs = w * (w / h);
<a name="l01037"></a>01037         }
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (dir == <span class="charliteral">&#39;B&#39;</span>) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, x1, x2);
<a name="l01039"></a>01039 
<a name="l01040"></a>01040         glVertex2f(x1, y1);
<a name="l01041"></a>01041         glVertex2f(x2, y2);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043         glVertex2f(x2, y1);
<a name="l01044"></a>01044         glVertex2f(x1, y1 + ofs);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046         glVertex2f(x1, y2);
<a name="l01047"></a>01047         glVertex2f(x2, y1 + (h - ofs));
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049     glEnd();
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 
<a name="l01052"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a1f5c4857c4d46bd3751ce09f3161e055">01052</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a1f5c4857c4d46bd3751ce09f3161e055">drawviewborder</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l01053"></a>01053 {
<a name="l01054"></a>01054     <span class="keywordtype">float</span> fac, a;
<a name="l01055"></a>01055     <span class="keywordtype">float</span> x1, x2, y1, y2;
<a name="l01056"></a>01056     <span class="keywordtype">float</span> x1i, x2i, y1i, y2i;
<a name="l01057"></a>01057     <span class="keywordtype">float</span> x3, y3, x4, y4;
<a name="l01058"></a>01058     <a class="code" href="../../da/d10/structrctf.html">rctf</a> viewborder;
<a name="l01059"></a>01059     <a class="code" href="../../d7/d7e/structCamera.html">Camera</a> *ca = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01060"></a>01060     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = (<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01061"></a>01061     
<a name="l01062"></a>01062     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01063"></a>01063         <span class="keywordflow">return</span>;
<a name="l01064"></a>01064     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#afd7fa4376c670f245aeed7a7116c7005">OB_CAMERA</a>)
<a name="l01065"></a>01065         ca = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01066"></a>01066     
<a name="l01067"></a>01067     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a349ace3e118822009091d74b91175218">ED_view3d_calc_camera_border</a>(scene, ar, v3d, rv3d, &amp;viewborder, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01068"></a>01068     <span class="comment">/* the offsets */</span>
<a name="l01069"></a>01069     x1 = viewborder.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01070"></a>01070     y1 = viewborder.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01071"></a>01071     x2 = viewborder.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01072"></a>01072     y2 = viewborder.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01073"></a>01073     
<a name="l01074"></a>01074     <span class="comment">/* apply offsets so the real 3D camera shows through */</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="comment">/* note: quite un-scientific but without this bit extra</span>
<a name="l01077"></a>01077 <span class="comment">     * 0.0001 on the lower left the 2D border sometimes</span>
<a name="l01078"></a>01078 <span class="comment">     * obscures the 3D camera border */</span>
<a name="l01079"></a>01079     <span class="comment">/* note: with VIEW3D_CAMERA_BORDER_HACK defined this error isn&#39;t noticeable</span>
<a name="l01080"></a>01080 <span class="comment">     * but keep it here in case we need to remove the workaround */</span>
<a name="l01081"></a>01081     x1i = (int)(x1 - 1.0001f);
<a name="l01082"></a>01082     y1i = (int)(y1 - 1.0001f);
<a name="l01083"></a>01083     x2i = (int)(x2 + (1.0f - 0.0001f));
<a name="l01084"></a>01084     y2i = (int)(y2 + (1.0f - 0.0001f));
<a name="l01085"></a>01085     
<a name="l01086"></a>01086     <span class="comment">/* passepartout, specified in camera edit buttons */</span>
<a name="l01087"></a>01087     <span class="keywordflow">if</span> (ca &amp;&amp; (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad56527aff42496f598ee9357b1244ae4">flag</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a30f7e93e83ee6e0ccd626f68f7d08be4">CAM_SHOWPASSEPARTOUT</a>) &amp;&amp; ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ab6d918212ec9726f3cb13d9ab1b26105">passepartalpha</a> &gt; 0.000001f) {
<a name="l01088"></a>01088         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ab6d918212ec9726f3cb13d9ab1b26105">passepartalpha</a> == 1.0f) {
<a name="l01089"></a>01089             glColor3f(0, 0, 0);
<a name="l01090"></a>01090         }
<a name="l01091"></a>01091         <span class="keywordflow">else</span> {
<a name="l01092"></a>01092             glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
<a name="l01093"></a>01093             glEnable(GL_BLEND);
<a name="l01094"></a>01094             glColor4f(0, 0, 0, ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ab6d918212ec9726f3cb13d9ab1b26105">passepartalpha</a>);
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096         <span class="keywordflow">if</span> (x1i &gt; 0.0f)
<a name="l01097"></a>01097             glRectf(0.0, (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>, x1i, 0.0);
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (x2i &lt; (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>)
<a name="l01099"></a>01099             glRectf(x2i, (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>, (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>, 0.0);
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (y2i &lt; (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>)
<a name="l01101"></a>01101             glRectf(x1i, (<span class="keywordtype">float</span>)ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>, x2i, y2i);
<a name="l01102"></a>01102         <span class="keywordflow">if</span> (y2i &gt; 0.0f)
<a name="l01103"></a>01103             glRectf(x1i, y1i, x2i, 0.0);
<a name="l01104"></a>01104         
<a name="l01105"></a>01105         glDisable(GL_BLEND);
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="comment">/* edge */</span>
<a name="l01109"></a>01109     glPolygonMode(GL_FRONT_AND_BACK, GL_LINE);  
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>);
<a name="l01114"></a>01114         
<a name="l01115"></a>01115     glRectf(x1i, y1i, x2i, y2i);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117 <span class="preprocessor">#ifdef VIEW3D_CAMERA_BORDER_HACK</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d02/drawobject_8c.html#a71099a3582be86b2e37722350e075ca1">view3d_camera_border_hack_test</a> == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l01119"></a>01119         glColor4fv(<a class="code" href="../../d3/d02/drawobject_8c.html#ab91afbad0100d3d6d371eea756b6f8b7">view3d_camera_border_hack_col</a>);
<a name="l01120"></a>01120         glRectf(x1i + 1, y1i + 1, x2i - 1, y2i - 1);
<a name="l01121"></a>01121         <a class="code" href="../../d3/d02/drawobject_8c.html#a71099a3582be86b2e37722350e075ca1">view3d_camera_border_hack_test</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123 <span class="preprocessor">#endif</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span>
<a name="l01125"></a>01125     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(3);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     <span class="comment">/* outer line not to confuse with object selecton */</span>
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a29858847f0ed499c53439f50c35cb02a">V3D_LOCK_CAMERA</a>) {
<a name="l01129"></a>01129         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a65e3169909737674a0536441605a5754">TH_REDALERT</a>);
<a name="l01130"></a>01130         glRectf(x1i - 1, y1i - 1, x2i + 1, y2i + 1);
<a name="l01131"></a>01131     }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>);
<a name="l01134"></a>01134     glRectf(x1i, y1i, x2i, y2i);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">/* border */</span>
<a name="l01137"></a>01137     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1766e76e06a3443cee3f58368e490b17">R_BORDER</a>) {
<a name="l01138"></a>01138         
<a name="l01139"></a>01139         <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0);
<a name="l01140"></a>01140         x3 = x1 + scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aaaf1a7daed17e111b846fe8632874e5d">border</a>.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> * (x2 - x1);
<a name="l01141"></a>01141         y3 = y1 + scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aaaf1a7daed17e111b846fe8632874e5d">border</a>.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> * (y2 - y1);
<a name="l01142"></a>01142         x4 = x1 + scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aaaf1a7daed17e111b846fe8632874e5d">border</a>.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> * (x2 - x1);
<a name="l01143"></a>01143         y4 = y1 + scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aaaf1a7daed17e111b846fe8632874e5d">border</a>.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> * (y2 - y1);
<a name="l01144"></a>01144         
<a name="l01145"></a>01145         <a class="code" href="../../dd/d44/BIF__gl_8h.html#a39d48f66c1c3fb25c3fcc6c069bfadf7">cpack</a>(0x4040FF);
<a name="l01146"></a>01146         glRectf(x3,  y3,  x4,  y4); 
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     <span class="comment">/* safety border */</span>
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (ca) {
<a name="l01151"></a>01151         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#af7c17c6fa3059ce169a87b968e12df65">CAM_DTX_CENTER</a>) {
<a name="l01152"></a>01152             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01153"></a>01153 
<a name="l01154"></a>01154             x3 = x1 + 0.5f * (x2 - x1);
<a name="l01155"></a>01155             y3 = y1 + 0.5f * (y2 - y1);
<a name="l01156"></a>01156 
<a name="l01157"></a>01157             glBegin(GL_LINES);
<a name="l01158"></a>01158             glVertex2f(x1, y3);
<a name="l01159"></a>01159             glVertex2f(x2, y3);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161             glVertex2f(x3, y1);
<a name="l01162"></a>01162             glVertex2f(x3, y2);
<a name="l01163"></a>01163             glEnd();
<a name="l01164"></a>01164         }
<a name="l01165"></a>01165 
<a name="l01166"></a>01166         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a5e36eed94701b8346f734760130e4dcb">CAM_DTX_CENTER_DIAG</a>) {
<a name="l01167"></a>01167             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169             glBegin(GL_LINES);
<a name="l01170"></a>01170             glVertex2f(x1, y1);
<a name="l01171"></a>01171             glVertex2f(x2, y2);
<a name="l01172"></a>01172 
<a name="l01173"></a>01173             glVertex2f(x1, y2);
<a name="l01174"></a>01174             glVertex2f(x2, y1);
<a name="l01175"></a>01175             glEnd();
<a name="l01176"></a>01176         }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a2f10b1c614710a1eed81cc1c7cf43714">CAM_DTX_THIRDS</a>) {
<a name="l01179"></a>01179             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01180"></a>01180             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a67fe21f9010b6a624fb2f41c2ab9b97a">drawviewborder_grid3</a>(x1, x2, y1, y2, 1.0f / 3.0f);
<a name="l01181"></a>01181         }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a28a058f6e4f5689bd1eac20a5a5d211d">CAM_DTX_GOLDEN</a>) {
<a name="l01184"></a>01184             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01185"></a>01185             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a67fe21f9010b6a624fb2f41c2ab9b97a">drawviewborder_grid3</a>(x1, x2, y1, y2, 1.0f - (1.0f / 1.61803399f));
<a name="l01186"></a>01186         }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a0f9e680888b6e726ea20371398180da7">CAM_DTX_GOLDEN_TRI_A</a>) {
<a name="l01189"></a>01189             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01190"></a>01190             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">drawviewborder_triangle</a>(x1, x2, y1, y2, 0, <span class="charliteral">&#39;A&#39;</span>);
<a name="l01191"></a>01191         }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a96c77d786e798f0abfdadc904e04e254">CAM_DTX_GOLDEN_TRI_B</a>) {
<a name="l01194"></a>01194             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01195"></a>01195             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">drawviewborder_triangle</a>(x1, x2, y1, y2, 0, <span class="charliteral">&#39;B&#39;</span>);
<a name="l01196"></a>01196         }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#afeb71fcc5c766ab4a9df7fb7035302ff">CAM_DTX_HARMONY_TRI_A</a>) {
<a name="l01199"></a>01199             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01200"></a>01200             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">drawviewborder_triangle</a>(x1, x2, y1, y2, 1, <span class="charliteral">&#39;A&#39;</span>);
<a name="l01201"></a>01201         }
<a name="l01202"></a>01202 
<a name="l01203"></a>01203         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad8c965ae0c6e4fb365e70412adc9f0d0">dtx</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a63eeeefee77b750ecbe6853c97e1890f">CAM_DTX_HARMONY_TRI_B</a>) {
<a name="l01204"></a>01204             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01205"></a>01205             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac0157ab33ef997d9d1dbacdfd9e548c8">drawviewborder_triangle</a>(x1, x2, y1, y2, 1, <span class="charliteral">&#39;B&#39;</span>);
<a name="l01206"></a>01206         }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <span class="keywordflow">if</span> (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad56527aff42496f598ee9357b1244ae4">flag</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a36b023062c4d496763eae938aa884e77">CAM_SHOWTITLESAFE</a>) {
<a name="l01209"></a>01209             fac = 0.1;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211             a = fac * (x2 - x1);
<a name="l01212"></a>01212             x1 += a;
<a name="l01213"></a>01213             x2 -= a;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215             a = fac * (y2 - y1);
<a name="l01216"></a>01216             y1 += a;
<a name="l01217"></a>01217             y2 -= a;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219             <a class="code" href="../../de/d96/UI__resources_8h.html#aab13d790796ae30ec4c04bee02f85595">UI_ThemeColorBlendShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.25, 0);
<a name="l01220"></a>01220 
<a name="l01221"></a>01221             <a class="code" href="../../d8/d1e/UI__interface_8h.html#a8fc510c8382c62a5af3a095e218d8f3d">uiSetRoundBox</a>(<a class="code" href="../../d8/d1e/UI__interface_8h.html#ab39a415800ebd0d977c477376649649ba7e9af1d815f4277196ed35a049f74148">UI_CNR_ALL</a>);
<a name="l01222"></a>01222             <a class="code" href="../../d8/d1e/UI__interface_8h.html#a363d654a8d24625cd68b8d30e8005609">uiDrawBox</a>(GL_LINE_LOOP, x1, y1, x2, y2, 12.0);
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224         <span class="keywordflow">if</span> (ca &amp;&amp; (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad56527aff42496f598ee9357b1244ae4">flag</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a1de0ce847be8902e5a7ceb08e2aafb10">CAM_SHOWSENSOR</a>)) {
<a name="l01225"></a>01225             <span class="comment">/* determine sensor fit, and get sensor x/y, for auto fit we</span>
<a name="l01226"></a>01226 <span class="comment">             * assume and square sensor and only use sensor_x */</span>
<a name="l01227"></a>01227             <span class="keywordtype">float</span> sizex = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#afac89783028ff848f111de04e0c29fbe">xsch</a> * scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a>;
<a name="l01228"></a>01228             <span class="keywordtype">float</span> sizey = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aca3c1ebdf50a6c74730e19e24983217d">ysch</a> * scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>;
<a name="l01229"></a>01229             <span class="keywordtype">int</span> sensor_fit = <a class="code" href="../../d2/dff/BKE__camera_8h.html#af580761b65f49ae6a5d28d43a230ee83">camera_sensor_fit</a>(ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a0ed5613b5883c690ae6b8cf690a36d11">sensor_fit</a>, sizex, sizey);
<a name="l01230"></a>01230             <span class="keywordtype">float</span> sensor_x = ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#acdf39c5ffbd9b9363fd230256a6a5bef">sensor_x</a>;
<a name="l01231"></a>01231             <span class="keywordtype">float</span> sensor_y = (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a0ed5613b5883c690ae6b8cf690a36d11">sensor_fit</a> == <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a7cfd9f3a93c7ffd7ee104c8b560d1d5f">CAMERA_SENSOR_FIT_AUTO</a>) ? ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#acdf39c5ffbd9b9363fd230256a6a5bef">sensor_x</a> : ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a18c42686b5afa4583d29abdf269d2948">sensor_y</a>;
<a name="l01232"></a>01232 
<a name="l01233"></a>01233             <span class="comment">/* determine sensor plane */</span>
<a name="l01234"></a>01234             <a class="code" href="../../da/d10/structrctf.html">rctf</a> rect;
<a name="l01235"></a>01235 
<a name="l01236"></a>01236             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (sensor_fit == <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a4ffc97a71a38fa5e791161fddf1e07c4">CAMERA_SENSOR_FIT_HOR</a>) {
<a name="l01237"></a>01237                 <span class="keywordtype">float</span> sensor_scale = (x2i - x1i) / sensor_x;
<a name="l01238"></a>01238                 <span class="keywordtype">float</span> sensor_height = sensor_scale * sensor_y;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240                 rect.xmin = x1i;
<a name="l01241"></a>01241                 rect.xmax = x2i;
<a name="l01242"></a>01242                 rect.ymin = (y1i + y2i) * 0.5f - sensor_height * 0.5f;
<a name="l01243"></a>01243                 rect.ymax = rect.ymin + sensor_height;
<a name="l01244"></a>01244             }
<a name="l01245"></a>01245             <span class="keywordflow">else</span> {
<a name="l01246"></a>01246                 <span class="keywordtype">float</span> sensor_scale = (y2i - y1i) / sensor_y;
<a name="l01247"></a>01247                 <span class="keywordtype">float</span> sensor_width = sensor_scale * sensor_x;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249                 rect.xmin = (x1i + x2i) * 0.5f - sensor_width * 0.5f;
<a name="l01250"></a>01250                 rect.xmax = rect.xmin + sensor_width;
<a name="l01251"></a>01251                 rect.ymin = y1i;
<a name="l01252"></a>01252                 rect.ymax = y2i;
<a name="l01253"></a>01253             }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255             <span class="comment">/* draw */</span>
<a name="l01256"></a>01256             <a class="code" href="../../de/d96/UI__resources_8h.html#a56c7a350537a25b88d0532488032aef6">UI_ThemeColorShade</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, 100);
<a name="l01257"></a>01257             <a class="code" href="../../d8/d1e/UI__interface_8h.html#a363d654a8d24625cd68b8d30e8005609">uiDrawBox</a>(GL_LINE_LOOP, rect.xmin, rect.ymin, rect.xmax, rect.ymax, 2.0f);
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#a97e0af63da34003debb284a98403315d">setlinestyle</a>(0);
<a name="l01262"></a>01262     glPolygonMode(GL_FRONT_AND_BACK, GL_FILL);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     <span class="comment">/* camera name - draw in highlighted text color */</span>
<a name="l01265"></a>01265     <span class="keywordflow">if</span> (ca &amp;&amp; (ca-&gt;<a class="code" href="../../d7/d7e/structCamera.html#ad56527aff42496f598ee9357b1244ae4">flag</a> &amp; <a class="code" href="../../d6/d3b/DNA__camera__types_8h.html#a5ed095d241c6ba372349092c95f76a3b">CAM_SHOWNAME</a>)) {
<a name="l01266"></a>01266         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l01267"></a>01267         <a class="code" href="../../df/d5d/BLF__api_8h.html#a9b623b39b9d6f9049b0777f431d8e76e">BLF_draw_default</a>(x1i, y1i - 15, 0.0f, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a> + 2, <span class="keyword">sizeof</span>(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) - 2);
<a name="l01268"></a>01268         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>);
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272 <span class="comment">/* *********************** backdraw for selection *************** */</span>
<a name="l01273"></a>01273 
<a name="l01274"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac4f84eec90b44328a068bf25afdb8db4">01274</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac4f84eec90b44328a068bf25afdb8db4">backdrawview3d</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l01275"></a>01275 {
<a name="l01276"></a>01276     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01277"></a>01277     <span class="keyword">struct </span><a class="code" href="../../d3/da9/structBase.html">Base</a> *base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>;
<a name="l01278"></a>01278     <span class="keywordtype">int</span> multisample_enabled;
<a name="l01279"></a>01279     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> winrct;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> == <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keywordflow">if</span> (base &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; (<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a> | <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) ||
<a name="l01284"></a>01284                  <a class="code" href="../../d8/d86/BKE__paint_8h.html#a56fc7a16c6dcfa3dd82680c86385e45f">paint_facesel_test</a>(base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>)))
<a name="l01285"></a>01285     {
<a name="l01286"></a>01286         <span class="comment">/* do nothing */</span>
<a name="l01287"></a>01287     }
<a name="l01288"></a>01288     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((base &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>)) &amp;&amp;
<a name="l01289"></a>01289              scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a> &amp;&amp; (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a1a36b13607238910a064c1b9b61430e5">imapaint</a>.<a class="code" href="../../d1/d54/structImagePaintSettings.html#a44a27926e561e1929e10d196516c328a">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a5b182dab648e4616a42d075acfbcaf0c">IMAGEPAINT_PROJECT_DISABLE</a>))
<a name="l01290"></a>01290     {
<a name="l01291"></a>01291         <span class="comment">/* do nothing */</span>
<a name="l01292"></a>01292     }
<a name="l01293"></a>01293     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((base &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a20027b5f4381f062402af134bcefe889">OB_MODE_PARTICLE_EDIT</a>)) &amp;&amp;
<a name="l01294"></a>01294              v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> &gt; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a112caf28bb615ee6c87ff744d1228182">OB_WIRE</a> &amp;&amp; (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab80fcf8e0e16083a2ef8e7ca72cb6a39">V3D_ZBUF_SELECT</a>))
<a name="l01295"></a>01295     {
<a name="l01296"></a>01296         <span class="comment">/* do nothing */</span>
<a name="l01297"></a>01297     }
<a name="l01298"></a>01298     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a> &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> &gt; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a112caf28bb615ee6c87ff744d1228182">OB_WIRE</a> &amp;&amp;
<a name="l01299"></a>01299              (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ab80fcf8e0e16083a2ef8e7ca72cb6a39">V3D_ZBUF_SELECT</a>)) {
<a name="l01300"></a>01300         <span class="comment">/* do nothing */</span>
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <span class="keywordflow">else</span> {
<a name="l01303"></a>01303         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp;= ~<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a89e41f856a5c6e5a3018c00b04a7cfbc">V3D_INVALID_BACKBUF</a>;
<a name="l01304"></a>01304         <span class="keywordflow">return</span>;
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     <span class="keywordflow">if</span> (!(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a89e41f856a5c6e5a3018c00b04a7cfbc">V3D_INVALID_BACKBUF</a>) ) <span class="keywordflow">return</span>;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309 <span class="comment">//  if (test) {</span>
<a name="l01310"></a>01310 <span class="comment">//      if (qtest()) {</span>
<a name="l01311"></a>01311 <span class="comment">//          addafterqueue(ar-&gt;win, BACKBUFDRAW, 1);</span>
<a name="l01312"></a>01312 <span class="comment">//          return;</span>
<a name="l01313"></a>01313 <span class="comment">//      }</span>
<a name="l01314"></a>01314 <span class="comment">//  }</span>
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> &gt; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a112caf28bb615ee6c87ff744d1228182">OB_WIRE</a>) v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01317"></a>01317     
<a name="l01318"></a>01318     <span class="comment">/* dithering and AA break color coding, so disable */</span>
<a name="l01319"></a>01319     glDisable(GL_DITHER);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321     multisample_enabled = glIsEnabled(GL_MULTISAMPLE_ARB);
<a name="l01322"></a>01322     <span class="keywordflow">if</span> (multisample_enabled)
<a name="l01323"></a>01323         glDisable(GL_MULTISAMPLE_ARB);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325     <a class="code" href="../../d1/d12/ED__screen_8h.html#ab8d29f0c43d7e2e8e7f0b69de1d914d6">region_scissor_winrct</a>(ar, &amp;winrct);
<a name="l01326"></a>01326     glScissor(winrct.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, winrct.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>, winrct.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - winrct.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, winrct.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - winrct.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     glClearColor(0.0, 0.0, 0.0, 0.0); 
<a name="l01329"></a>01329     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) {
<a name="l01330"></a>01330         glEnable(GL_DEPTH_TEST);
<a name="l01331"></a>01331         glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333     <span class="keywordflow">else</span> {
<a name="l01334"></a>01334         glClear(GL_COLOR_BUFFER_BIT);
<a name="l01335"></a>01335         glDisable(GL_DEPTH_TEST);
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l01339"></a>01339         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a403862b556efefe2375ce8cf99110fd5">ED_view3d_clipping_set</a>(rv3d);
<a name="l01340"></a>01340     
<a name="l01341"></a>01341     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.f |= <a class="code" href="../../d1/d8c/BKE__global_8h.html#a956e0b2eee9cc0a798faf39ca1df10e6">G_BACKBUFSEL</a>;
<a name="l01342"></a>01342     
<a name="l01343"></a>01343     <span class="keywordflow">if</span> (base &amp;&amp; (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a>))
<a name="l01344"></a>01344         <a class="code" href="../../d3/d02/drawobject_8c.html#a1fb22168e4ee2362f1bb110ef88c65fb">draw_object_backbufsel</a>(scene, v3d, rv3d, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp;= ~<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a89e41f856a5c6e5a3018c00b04a7cfbc">V3D_INVALID_BACKBUF</a>;
<a name="l01347"></a>01347     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#aa9ecd99451bb9e0b9c7d54100a2ec6bc">swap</a> = 0; <span class="comment">/* mark invalid backbuf for wm draw */</span>
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.f &amp;= ~<a class="code" href="../../d1/d8c/BKE__global_8h.html#a956e0b2eee9cc0a798faf39ca1df10e6">G_BACKBUFSEL</a>;
<a name="l01350"></a>01350     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01351"></a>01351     glDisable(GL_DEPTH_TEST);
<a name="l01352"></a>01352     glEnable(GL_DITHER);
<a name="l01353"></a>01353     <span class="keywordflow">if</span> (multisample_enabled)
<a name="l01354"></a>01354         glEnable(GL_MULTISAMPLE_ARB);
<a name="l01355"></a>01355 
<a name="l01356"></a>01356     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l01357"></a>01357         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa4cf5dc6374c7b1e81b8322fad984ece">ED_view3d_clipping_disable</a>();
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     <span class="comment">/* it is important to end a view in a transform compatible with buttons */</span>
<a name="l01360"></a>01360 <span class="comment">//  persp(PERSP_WIN);  // set ortho</span>
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 }
<a name="l01363"></a>01363 
<a name="l01364"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a2e078962d8a4d2214c1b136276d00a42">01364</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a679f6c1cdac2d683e9bdbf2d1ecb8ba8">view3d_validate_backbuf</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc)
<a name="l01365"></a>01365 {
<a name="l01366"></a>01366     <span class="keywordflow">if</span> (vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a>-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a89e41f856a5c6e5a3018c00b04a7cfbc">V3D_INVALID_BACKBUF</a>)
<a name="l01367"></a>01367         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac4f84eec90b44328a068bf25afdb8db4">backdrawview3d</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>, vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>, vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a>);
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 <span class="comment">/* samples a single pixel (copied from vpaint) */</span>
<a name="l01371"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ace4025a55a962f66db95377e75f4da66">01371</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aba40efd013e32afa64b4059112bcaede">view3d_sample_backbuf</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
<a name="l01372"></a>01372 {
<a name="l01373"></a>01373     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col;
<a name="l01374"></a>01374     
<a name="l01375"></a>01375     <span class="keywordflow">if</span> (x &gt;= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> || y &gt;= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>) <span class="keywordflow">return</span> 0;
<a name="l01376"></a>01376     x += vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l01377"></a>01377     y += vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l01378"></a>01378     
<a name="l01379"></a>01379     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a679f6c1cdac2d683e9bdbf2d1ecb8ba8">view3d_validate_backbuf</a>(vc);
<a name="l01380"></a>01380 
<a name="l01381"></a>01381     glReadPixels(x,  y, 1, 1, GL_RGBA, GL_UNSIGNED_BYTE,  &amp;col);
<a name="l01382"></a>01382     glReadBuffer(GL_BACK);  
<a name="l01383"></a>01383     
<a name="l01384"></a>01384     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8c/BKE__global_8h.html#ab29b2916516ef2ec36d2f8f85ae20a78">ENDIAN_ORDER</a> == <a class="code" href="../../d1/d8c/BKE__global_8h.html#a497f70c46327d9156e6cf4d2d77a4500">B_ENDIAN</a>) <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ae65963c3712c0a69691ab4e1e2dd32ed">SWITCH_INT</a>(col);
<a name="l01385"></a>01385     
<a name="l01386"></a>01386     <span class="keywordflow">return</span> <a class="code" href="../../df/d4d/wm__subwindow_8c.html#a9ee3b53c087965dadbc7b770ffc56100">WM_framebuffer_to_index</a>(col);
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 <span class="comment">/* reads full rect, converts indices */</span>
<a name="l01390"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a114389bfe89f699969c6c0676cdfa3c2">01390</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a67a338f046919216d96ba482e7cd1e06">view3d_read_backbuf</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keywordtype">short</span> xmin, <span class="keywordtype">short</span> ymin, <span class="keywordtype">short</span> xmax, <span class="keywordtype">short</span> ymax)
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *dr, *rd;
<a name="l01393"></a>01393     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, *ibuf1;
<a name="l01394"></a>01394     <span class="keywordtype">int</span> a;
<a name="l01395"></a>01395     <span class="keywordtype">short</span> xminc, yminc, xmaxc, ymaxc, xs, ys;
<a name="l01396"></a>01396     
<a name="l01397"></a>01397     <span class="comment">/* clip */</span>
<a name="l01398"></a>01398     <span class="keywordflow">if</span> (xmin &lt; 0) xminc = 0; <span class="keywordflow">else</span> xminc = xmin;
<a name="l01399"></a>01399     <span class="keywordflow">if</span> (xmax &gt;= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>) xmaxc = vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> - 1; <span class="keywordflow">else</span> xmaxc = xmax;
<a name="l01400"></a>01400     <span class="keywordflow">if</span> (xminc &gt; xmaxc) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     <span class="keywordflow">if</span> (ymin &lt; 0) yminc = 0; <span class="keywordflow">else</span> yminc = ymin;
<a name="l01403"></a>01403     <span class="keywordflow">if</span> (ymax &gt;= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>) ymaxc = vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> - 1; <span class="keywordflow">else</span> ymaxc = ymax;
<a name="l01404"></a>01404     <span class="keywordflow">if</span> (yminc &gt; ymaxc) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01405"></a>01405     
<a name="l01406"></a>01406     ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>((xmaxc - xminc + 1), (ymaxc - yminc + 1), 32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a679f6c1cdac2d683e9bdbf2d1ecb8ba8">view3d_validate_backbuf</a>(vc); 
<a name="l01409"></a>01409     
<a name="l01410"></a>01410     glReadPixels(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> + xminc,
<a name="l01411"></a>01411                  vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> + yminc,
<a name="l01412"></a>01412                  (xmaxc - xminc + 1),
<a name="l01413"></a>01413                  (ymaxc - yminc + 1),
<a name="l01414"></a>01414                  GL_RGBA, GL_UNSIGNED_BYTE, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>);
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     glReadBuffer(GL_BACK);  
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8c/BKE__global_8h.html#ab29b2916516ef2ec36d2f8f85ae20a78">ENDIAN_ORDER</a> == <a class="code" href="../../d1/d8c/BKE__global_8h.html#a497f70c46327d9156e6cf4d2d77a4500">B_ENDIAN</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aadf6bf75e8af0e36aae058351ad1ac72">IMB_convert_rgba_to_abgr</a>(ibuf);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     a = (xmaxc - xminc + 1) * (ymaxc - yminc + 1);
<a name="l01421"></a>01421     dr = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l01422"></a>01422     <span class="keywordflow">while</span> (a--) {
<a name="l01423"></a>01423         <span class="keywordflow">if</span> (*dr) *dr = <a class="code" href="../../df/d4d/wm__subwindow_8c.html#a9ee3b53c087965dadbc7b770ffc56100">WM_framebuffer_to_index</a>(*dr);
<a name="l01424"></a>01424         dr++;
<a name="l01425"></a>01425     }
<a name="l01426"></a>01426     
<a name="l01427"></a>01427     <span class="comment">/* put clipped result back, if needed */</span>
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (xminc == xmin &amp;&amp; xmaxc == xmax &amp;&amp; yminc == ymin &amp;&amp; ymaxc == ymax)
<a name="l01429"></a>01429         <span class="keywordflow">return</span> ibuf;
<a name="l01430"></a>01430     
<a name="l01431"></a>01431     ibuf1 = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>( (xmax - xmin + 1), (ymax - ymin + 1), 32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l01432"></a>01432     rd = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l01433"></a>01433     dr = ibuf1-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435     <span class="keywordflow">for</span> (ys = ymin; ys &lt;= ymax; ys++) {
<a name="l01436"></a>01436         <span class="keywordflow">for</span> (xs = xmin; xs &lt;= xmax; xs++, dr++) {
<a name="l01437"></a>01437             <span class="keywordflow">if</span> (xs &gt;= xminc &amp;&amp; xs &lt;= xmaxc &amp;&amp; ys &gt;= yminc &amp;&amp; ys &lt;= ymaxc) {
<a name="l01438"></a>01438                 *dr = *rd;
<a name="l01439"></a>01439                 rd++;
<a name="l01440"></a>01440             }
<a name="l01441"></a>01441         }
<a name="l01442"></a>01442     }
<a name="l01443"></a>01443     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l01444"></a>01444     <span class="keywordflow">return</span> ibuf1;
<a name="l01445"></a>01445 }
<a name="l01446"></a>01446 
<a name="l01447"></a>01447 <span class="comment">/* smart function to sample a rect spiralling outside, nice for backbuf selection */</span>
<a name="l01448"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a9a57a60782dd80ac421f4804e63f43f4">01448</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac058a8ae08ac7b3043c0a19cdeafe0a8">view3d_sample_backbuf_rect</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keyword">const</span> <span class="keywordtype">int</span> mval[2], <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>,
<a name="l01449"></a>01449                                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <span class="keywordtype">int</span> *dist, <span class="keywordtype">short</span> strict,
<a name="l01450"></a>01450                                         <span class="keywordtype">void</span> *handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> (*indextest)(<span class="keywordtype">void</span> *handle, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>))
<a name="l01451"></a>01451 {
<a name="l01452"></a>01452     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *buf;
<a name="l01453"></a>01453     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *bufmin, *bufmax, *tbuf;
<a name="l01454"></a>01454     <span class="keywordtype">int</span> minx, miny;
<a name="l01455"></a>01455     <span class="keywordtype">int</span> a, b, rc, nr, amount, dirvec[4][2];
<a name="l01456"></a>01456     <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a> = 0;
<a name="l01457"></a>01457     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index = 0;
<a name="l01458"></a>01458     <span class="keywordtype">short</span> indexok = 0;  
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     amount = (size - 1) / 2;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     minx = mval[0] - (amount + 1);
<a name="l01463"></a>01463     miny = mval[1] - (amount + 1);
<a name="l01464"></a>01464     buf = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a67a338f046919216d96ba482e7cd1e06">view3d_read_backbuf</a>(vc, minx, miny, minx + size - 1, miny + size - 1);
<a name="l01465"></a>01465     <span class="keywordflow">if</span> (!buf) <span class="keywordflow">return</span> 0;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     rc = 0;
<a name="l01468"></a>01468     
<a name="l01469"></a>01469     dirvec[0][0] = 1; dirvec[0][1] = 0;
<a name="l01470"></a>01470     dirvec[1][0] = 0; dirvec[1][1] = -<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01471"></a>01471     dirvec[2][0] = -1; dirvec[2][1] = 0;
<a name="l01472"></a>01472     dirvec[3][0] = 0; dirvec[3][1] = <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01473"></a>01473     
<a name="l01474"></a>01474     bufmin = buf-&gt;rect;
<a name="l01475"></a>01475     tbuf = buf-&gt;rect;
<a name="l01476"></a>01476     bufmax = buf-&gt;rect + size * <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01477"></a>01477     tbuf += amount * size + amount;
<a name="l01478"></a>01478     
<a name="l01479"></a>01479     <span class="keywordflow">for</span> (nr = 1; nr &lt;= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; nr++) {
<a name="l01480"></a>01480         
<a name="l01481"></a>01481         <span class="keywordflow">for</span> (a = 0; a &lt; 2; a++) {
<a name="l01482"></a>01482             <span class="keywordflow">for</span> (b = 0; b &lt; nr; b++, distance++) {
<a name="l01483"></a>01483                 <span class="keywordflow">if</span> (*tbuf &amp;&amp; *tbuf &gt;= min &amp;&amp; *tbuf &lt; max) { <span class="comment">//we got a hit</span>
<a name="l01484"></a>01484                     <span class="keywordflow">if</span> (strict) {
<a name="l01485"></a>01485                         indexok =  indextest(handle, *tbuf - min + 1);
<a name="l01486"></a>01486                         <span class="keywordflow">if</span> (indexok) {
<a name="l01487"></a>01487                             *dist = (short) <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>( (<span class="keywordtype">float</span>)<a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>);
<a name="l01488"></a>01488                             index = *tbuf - min + 1;
<a name="l01489"></a>01489                             <span class="keywordflow">goto</span> exit; 
<a name="l01490"></a>01490                         }                       
<a name="l01491"></a>01491                     }
<a name="l01492"></a>01492                     <span class="keywordflow">else</span> {
<a name="l01493"></a>01493                         *dist = (short) <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>( (<span class="keywordtype">float</span>)<a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>); <span class="comment">// XXX, this distance is wrong -</span>
<a name="l01494"></a>01494                         index = *tbuf - min + 1; <span class="comment">// messy yah, but indices start at 1</span>
<a name="l01495"></a>01495                         <span class="keywordflow">goto</span> exit;
<a name="l01496"></a>01496                     }           
<a name="l01497"></a>01497                 }
<a name="l01498"></a>01498                 
<a name="l01499"></a>01499                 tbuf += (dirvec[rc][0] + dirvec[rc][1]);
<a name="l01500"></a>01500                 
<a name="l01501"></a>01501                 <span class="keywordflow">if</span> (tbuf &lt; bufmin || tbuf &gt;= bufmax) {
<a name="l01502"></a>01502                     <span class="keywordflow">goto</span> exit;
<a name="l01503"></a>01503                 }
<a name="l01504"></a>01504             }
<a name="l01505"></a>01505             rc++;
<a name="l01506"></a>01506             rc &amp;= 3;
<a name="l01507"></a>01507         }
<a name="l01508"></a>01508     }
<a name="l01509"></a>01509 
<a name="l01510"></a>01510 exit:
<a name="l01511"></a>01511     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(buf);
<a name="l01512"></a>01512     <span class="keywordflow">return</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l01513"></a>01513 }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515 
<a name="l01516"></a>01516 <span class="comment">/* ************************************************************* */</span>
<a name="l01517"></a>01517 
<a name="l01518"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">01518</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">draw_bgpic</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keywordtype">int</span> foreground)
<a name="l01519"></a>01519 {
<a name="l01520"></a>01520     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01521"></a>01521     <a class="code" href="../../df/da6/structBGpic.html">BGpic</a> *bgpic;
<a name="l01522"></a>01522     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l01523"></a>01523     <a class="code" href="../../d0/d44/structMovieClip.html">MovieClip</a> *clip;
<a name="l01524"></a>01524     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *freeibuf;
<a name="l01525"></a>01525     <span class="keywordtype">float</span> vec[4], fac, asp, zoomx, zoomy;
<a name="l01526"></a>01526     <span class="keywordtype">float</span> x1, y1, x2, y2, cx, cy;
<a name="l01527"></a>01527     <span class="keywordtype">int</span> fg_flag = foreground ? <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#acbd3652bae9102106501d10686dba5ed">V3D_BGPIC_FOREGROUND</a> : 0;
<a name="l01528"></a>01528 
<a name="l01529"></a>01529     <span class="keywordflow">for</span> (bgpic = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a3246c1cbdd50c393126180ae4446992e">bgpicbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; bgpic; bgpic = bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a81c485660f1feac2cfa5c5813153c2f0">next</a>) {
<a name="l01530"></a>01530 
<a name="l01531"></a>01531         <span class="keywordflow">if</span> ((bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#adb21637102569a032fc7f3bfa233bf11">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#acbd3652bae9102106501d10686dba5ed">V3D_BGPIC_FOREGROUND</a>) != fg_flag)
<a name="l01532"></a>01532             <span class="keywordflow">continue</span>;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534         <span class="keywordflow">if</span> ((bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aca418e05c3efdd93a5994fa6b400e49d">view</a> == 0) || <span class="comment">/* zero for any */</span>
<a name="l01535"></a>01535             (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aca418e05c3efdd93a5994fa6b400e49d">view</a> &amp; (1 &lt;&lt; rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a>)) || <span class="comment">/* check agaist flags */</span>
<a name="l01536"></a>01536             (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a> &amp;&amp; bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aca418e05c3efdd93a5994fa6b400e49d">view</a> == (1 &lt;&lt; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a08aad6d7a43a0eb6a69a4cc148bae306">RV3D_VIEW_CAMERA</a>)))
<a name="l01537"></a>01537         {
<a name="l01538"></a>01538             <span class="comment">/* disable individual images */</span>
<a name="l01539"></a>01539             <span class="keywordflow">if</span> ((bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#adb21637102569a032fc7f3bfa233bf11">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a6f2b17340f0cde675cd632e50abef58d">V3D_BGPIC_DISABLED</a>))
<a name="l01540"></a>01540                 <span class="keywordflow">continue</span>;
<a name="l01541"></a>01541 
<a name="l01542"></a>01542             freeibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01543"></a>01543             <span class="keywordflow">if</span> (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a4add81ee58f8d5bbff9b666b6a288ae3">source</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ac360c572b3851d3bebbcc9a46212bd50">V3D_BGPIC_IMAGE</a>) {
<a name="l01544"></a>01544                 ima = bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a826bef753b14debc45e2cacc6dc3c6f2">ima</a>;
<a name="l01545"></a>01545                 <span class="keywordflow">if</span> (ima == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01546"></a>01546                     <span class="keywordflow">continue</span>;
<a name="l01547"></a>01547                 <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(&amp;bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a16f3925559495b9236d5e8160bc8f842">iuser</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>, 0);
<a name="l01548"></a>01548                 ibuf = <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, &amp;bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a16f3925559495b9236d5e8160bc8f842">iuser</a>);
<a name="l01549"></a>01549             }
<a name="l01550"></a>01550             <span class="keywordflow">else</span> {
<a name="l01551"></a>01551                 clip = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01552"></a>01552 
<a name="l01553"></a>01553                 <span class="keywordflow">if</span> (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#adb21637102569a032fc7f3bfa233bf11">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4a8355ae6babc9dc61d4f4a2cb0e62a3">V3D_BGPIC_CAMERACLIP</a>) {
<a name="l01554"></a>01554                     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>)
<a name="l01555"></a>01555                         clip = <a class="code" href="../../df/dac/BKE__object_8h.html#ae5d85ba23fc1190fb741a7f16b0bbf0f">object_get_movieclip</a>(scene, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>, 1);
<a name="l01556"></a>01556                 }
<a name="l01557"></a>01557                 <span class="keywordflow">else</span> clip = bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a91d17a6f72f3226ca9f26dab51697941">clip</a>;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559                 <span class="keywordflow">if</span> (clip == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01560"></a>01560                     <span class="keywordflow">continue</span>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562                 <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a48e73a7c78eb9b4fe5072c5030ee0b5e">BKE_movieclip_user_set_frame</a>(&amp;bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a02e7a4c50629113cede4eb090d183251">cuser</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l01563"></a>01563                 ibuf = <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a8f77cec36c003927660d27501ca7f610">BKE_movieclip_get_ibuf</a>(clip, &amp;bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a02e7a4c50629113cede4eb090d183251">cuser</a>);
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                 <span class="comment">/* working with ibuf from image and clip has got different workflow now.</span>
<a name="l01566"></a>01566 <span class="comment">                 * ibuf acquired from clip is referenced by cache system and should</span>
<a name="l01567"></a>01567 <span class="comment">                 * be dereferenced after usage. */</span>
<a name="l01568"></a>01568                 freeibuf = ibuf;
<a name="l01569"></a>01569             }
<a name="l01570"></a>01570 
<a name="l01571"></a>01571             <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01572"></a>01572                 <span class="keywordflow">continue</span>;
<a name="l01573"></a>01573 
<a name="l01574"></a>01574             <span class="keywordflow">if</span> ((ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> != 4) { <span class="comment">/* invalid image format */</span>
<a name="l01575"></a>01575                 <span class="keywordflow">if</span> (freeibuf)
<a name="l01576"></a>01576                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(freeibuf);
<a name="l01577"></a>01577 
<a name="l01578"></a>01578                 <span class="keywordflow">continue</span>;
<a name="l01579"></a>01579             }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01582"></a>01582                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a3af34b4b5c6b91ddf5b872fcb9e2d66c">IMB_rect_from_float</a>(ibuf);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584             <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>) {
<a name="l01585"></a>01585                 <a class="code" href="../../da/d10/structrctf.html">rctf</a> vb;
<a name="l01586"></a>01586 
<a name="l01587"></a>01587                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a349ace3e118822009091d74b91175218">ED_view3d_calc_camera_border</a>(scene, ar, v3d, rv3d, &amp;vb, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01588"></a>01588 
<a name="l01589"></a>01589                 x1 = vb.<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>;
<a name="l01590"></a>01590                 y1 = vb.<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>;
<a name="l01591"></a>01591                 x2 = vb.<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>;
<a name="l01592"></a>01592                 y2 = vb.<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>;
<a name="l01593"></a>01593             }
<a name="l01594"></a>01594             <span class="keywordflow">else</span> {
<a name="l01595"></a>01595                 <span class="keywordtype">float</span> sco[2];
<a name="l01596"></a>01596                 <span class="keyword">const</span> <span class="keywordtype">float</span> mval_f[2] = {1.0f, 0.0f};
<a name="l01597"></a>01597 
<a name="l01598"></a>01598                 <span class="comment">/* calc window coord */</span>
<a name="l01599"></a>01599                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a06acdefee150e80f06f802aeba637f6e">initgrabz</a>(rv3d, 0.0, 0.0, 0.0);
<a name="l01600"></a>01600                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ae4c98073cdfe1ff7ff50c08cb53b4228">ED_view3d_win_to_delta</a>(ar, mval_f, vec);
<a name="l01601"></a>01601                 fac = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[0]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[1]), <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[2]))); <span class="comment">/* largest abs axis */</span>
<a name="l01602"></a>01602                 fac = 1.0f / fac;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604                 asp = ( (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) / (float)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01605"></a>01605 
<a name="l01606"></a>01606                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(vec);
<a name="l01607"></a>01607                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a5629edcde50e9e9a70b2d3d8afd92487">ED_view3d_project_float_v2</a>(ar, vec, sco, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>);
<a name="l01608"></a>01608                 cx = sco[0];
<a name="l01609"></a>01609                 cy = sco[1];
<a name="l01610"></a>01610 
<a name="l01611"></a>01611                 x1 =  cx + fac * (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#ae838987e0608d08218ac4d40d7639917">xof</a> - bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aa69f261d327c47f6679ee23deacec49b">size</a>);
<a name="l01612"></a>01612                 y1 =  cy + asp * fac * (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a2530df98c03151c7c66f5ca1f107816a">yof</a> - bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aa69f261d327c47f6679ee23deacec49b">size</a>);
<a name="l01613"></a>01613                 x2 =  cx + fac * (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#ae838987e0608d08218ac4d40d7639917">xof</a> + bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aa69f261d327c47f6679ee23deacec49b">size</a>);
<a name="l01614"></a>01614                 y2 =  cy + asp * fac * (bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a2530df98c03151c7c66f5ca1f107816a">yof</a> + bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#aa69f261d327c47f6679ee23deacec49b">size</a>);
<a name="l01615"></a>01615             }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617             <span class="comment">/* complete clip? */</span>
<a name="l01618"></a>01618 
<a name="l01619"></a>01619             <span class="keywordflow">if</span> (x2 &lt; 0 || y2 &lt; 0 || x1 &gt; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> || y1 &gt; ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>) {
<a name="l01620"></a>01620                 <span class="keywordflow">if</span> (freeibuf)
<a name="l01621"></a>01621                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(freeibuf);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623                 <span class="keywordflow">continue</span>;
<a name="l01624"></a>01624             }
<a name="l01625"></a>01625 
<a name="l01626"></a>01626             zoomx = (x2 - x1) / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01627"></a>01627             zoomy = (y2 - y1) / ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629             <span class="comment">/* for some reason; zoomlevels down refuses to use GL_ALPHA_SCALE */</span>
<a name="l01630"></a>01630             <span class="keywordflow">if</span> (zoomx &lt; 1.0f || zoomy &lt; 1.0f) {
<a name="l01631"></a>01631                 <span class="keywordtype">float</span> tzoom = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(zoomx, zoomy);
<a name="l01632"></a>01632                 <span class="keywordtype">int</span> mip = 0;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634                 <span class="keywordflow">if</span> ((ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>) != 0) {
<a name="l01635"></a>01635                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a28b4c6392d1dd04e9e31c4993998f825">IMB_remakemipmap</a>(ibuf, 0);
<a name="l01636"></a>01636                     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac1e5b2a8a51c011aa409f9cc18da7973">IB_MIPMAP_INVALID</a>;
<a name="l01637"></a>01637                 }
<a name="l01638"></a>01638                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0] == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01639"></a>01639                     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a8904a6dde2816ac8cb9ecc2467907018">IMB_makemipmap</a>(ibuf, 0);
<a name="l01640"></a>01640 
<a name="l01641"></a>01641                 <span class="keywordflow">while</span> (tzoom &lt; 1.0f &amp;&amp; mip &lt; 8 &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[mip]) {
<a name="l01642"></a>01642                     tzoom *= 2.0f;
<a name="l01643"></a>01643                     zoomx *= 2.0f;
<a name="l01644"></a>01644                     zoomy *= 2.0f;
<a name="l01645"></a>01645                     mip++;
<a name="l01646"></a>01646                 }
<a name="l01647"></a>01647                 <span class="keywordflow">if</span> (mip &gt; 0)
<a name="l01648"></a>01648                     ibuf = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[mip - 1];
<a name="l01649"></a>01649             }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glDisable(GL_DEPTH_TEST);
<a name="l01652"></a>01652             glDepthMask(0);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654             glEnable(GL_BLEND);
<a name="l01655"></a>01655             glBlendFunc(GL_SRC_ALPHA,  GL_ONE_MINUS_SRC_ALPHA);
<a name="l01656"></a>01656 
<a name="l01657"></a>01657             glMatrixMode(GL_PROJECTION);
<a name="l01658"></a>01658             glPushMatrix();
<a name="l01659"></a>01659             glMatrixMode(GL_MODELVIEW);
<a name="l01660"></a>01660             glPushMatrix();
<a name="l01661"></a>01661             <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l01662"></a>01662 
<a name="l01663"></a>01663             glPixelZoom(zoomx, zoomy);
<a name="l01664"></a>01664             glColor4f(1.0f, 1.0f, 1.0f, 1.0f - bgpic-&gt;<a class="code" href="../../df/da6/structBGpic.html#a5a89e8b0956561adca4171d164802e57">blend</a>);
<a name="l01665"></a>01665             <a class="code" href="../../d9/d71/BIF__glutil_8h.html#ac573d112048ba54a7ad1a14235a19601">glaDrawPixelsTex</a>(x1, y1, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, GL_UNSIGNED_BYTE, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>);
<a name="l01666"></a>01666 
<a name="l01667"></a>01667             glPixelZoom(1.0, 1.0);
<a name="l01668"></a>01668             glPixelTransferf(GL_ALPHA_SCALE, 1.0f);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670             glMatrixMode(GL_PROJECTION);
<a name="l01671"></a>01671             glPopMatrix();
<a name="l01672"></a>01672             glMatrixMode(GL_MODELVIEW);
<a name="l01673"></a>01673             glPopMatrix();
<a name="l01674"></a>01674 
<a name="l01675"></a>01675             glDisable(GL_BLEND);
<a name="l01676"></a>01676 
<a name="l01677"></a>01677             glDepthMask(1);
<a name="l01678"></a>01678             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glEnable(GL_DEPTH_TEST);
<a name="l01679"></a>01679 
<a name="l01680"></a>01680             <span class="keywordflow">if</span> (freeibuf)
<a name="l01681"></a>01681                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(freeibuf);
<a name="l01682"></a>01682         }
<a name="l01683"></a>01683     }
<a name="l01684"></a>01684 }
<a name="l01685"></a>01685 
<a name="l01686"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a18fcdbc95fe2646515262fb2d2bd401e">01686</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a18fcdbc95fe2646515262fb2d2bd401e">draw_bgpics</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keywordtype">int</span> foreground)
<a name="l01687"></a>01687 {
<a name="l01688"></a>01688     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ae499c49f7386e6b6491b237dd2f6dc1d">V3D_DISPBGPICS</a>) == 0)
<a name="l01691"></a>01691         <span class="keywordflow">return</span>;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>)
<a name="l01694"></a>01694         <span class="keywordflow">return</span>;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696     <span class="keywordflow">if</span> ((rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ae271a0ebf5f72fba42b4703e1084a351">RV3D_VIEW_USER</a>) || (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> != <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>)) {
<a name="l01697"></a>01697         <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>) {
<a name="l01698"></a>01698             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">draw_bgpic</a>(scene, ar, v3d, foreground);
<a name="l01699"></a>01699         }
<a name="l01700"></a>01700     }
<a name="l01701"></a>01701     <span class="keywordflow">else</span> {
<a name="l01702"></a>01702             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">draw_bgpic</a>(scene, ar, v3d, foreground);
<a name="l01703"></a>01703     }
<a name="l01704"></a>01704 }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706 <span class="comment">/* ****************** View3d afterdraw *************** */</span>
<a name="l01707"></a>01707 
<a name="l01708"></a><a class="code" href="../../dd/d83/structView3DAfter.html">01708</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> {
<a name="l01709"></a><a class="code" href="../../dd/d83/structView3DAfter.html#a98e92dd57996d69dab64921f19eabdb0">01709</a>     <span class="keyword">struct </span><a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>, *<a class="code" href="../../dd/d83/structView3DAfter.html#a98e92dd57996d69dab64921f19eabdb0">prev</a>;
<a name="l01710"></a><a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">01710</a>     <span class="keyword">struct </span><a class="code" href="../../d3/da9/structBase.html">Base</a> *<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>;
<a name="l01711"></a><a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">01711</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">flag</a>;
<a name="l01712"></a>01712 } <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a98ced4d88bb2e35221f2fda7110793d5">View3DAfter</a>;
<a name="l01713"></a>01713 
<a name="l01714"></a>01714 <span class="comment">/* temp storage of Objects that need to be drawn as last */</span>
<a name="l01715"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a62d12554313bcbe2e30a7e7eda84aa59">01715</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a62d12554313bcbe2e30a7e7eda84aa59">add_view3d_after</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb, <a class="code" href="../../d3/da9/structBase.html">Base</a> *base, <span class="keywordtype">int</span> <a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a>)
<a name="l01716"></a>01716 {
<a name="l01717"></a>01717     <a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *v3da = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a>), <span class="stringliteral">&quot;View 3d after&quot;</span>);
<a name="l01718"></a>01718     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, v3da);
<a name="l01719"></a>01719     v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a> = base;
<a name="l01720"></a>01720     v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">flag</a> = <a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a>;
<a name="l01721"></a>01721 }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723 <span class="comment">/* disables write in zbuffer and draws it over */</span>
<a name="l01724"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a550f7bebb476cdc02c1977a27df544f1">01724</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a550f7bebb476cdc02c1977a27df544f1">view3d_draw_transp</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l01725"></a>01725 {
<a name="l01726"></a>01726     <a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *v3da, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01727"></a>01727     
<a name="l01728"></a>01728     glDepthMask(0);
<a name="l01729"></a>01729     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01730"></a>01730     
<a name="l01731"></a>01731     <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l01732"></a>01732         next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l01733"></a>01733         <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">flag</a>);
<a name="l01734"></a>01734         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>, v3da);
<a name="l01735"></a>01735         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01738"></a>01738     
<a name="l01739"></a>01739     glDepthMask(1);
<a name="l01740"></a>01740     
<a name="l01741"></a>01741 }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 <span class="comment">/* clears zbuffer and draws it over */</span>
<a name="l01744"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a66a9d3a01ae913dcf53f82294ac4212b">01744</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a66a9d3a01ae913dcf53f82294ac4212b">view3d_draw_xray</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keywordtype">int</span> <a class="code" href="../../d1/d79/btDbvtBroadphase_8cpp.html#a19b1dda96df6332570b535a0683d8076">clear</a>)
<a name="l01745"></a>01745 {
<a name="l01746"></a>01746     <a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *v3da, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748     <span class="keywordflow">if</span> (clear &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>)
<a name="l01749"></a>01749         glClear(GL_DEPTH_BUFFER_BIT);
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01752"></a>01752     <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l01753"></a>01753         next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l01754"></a>01754         <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">flag</a>);
<a name="l01755"></a>01755         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>, v3da);
<a name="l01756"></a>01756         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l01757"></a>01757     }
<a name="l01758"></a>01758     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="comment">/* clears zbuffer and draws it over */</span>
<a name="l01763"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a209d1d806c4fa0f8a25c6ca0b3c812e0">01763</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a209d1d806c4fa0f8a25c6ca0b3c812e0">view3d_draw_xraytransp</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keywordtype">int</span> <a class="code" href="../../d1/d79/btDbvtBroadphase_8cpp.html#a19b1dda96df6332570b535a0683d8076">clear</a>)
<a name="l01764"></a>01764 {
<a name="l01765"></a>01765     <a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *v3da, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l01766"></a>01766 
<a name="l01767"></a>01767     <span class="keywordflow">if</span> (clear &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>)
<a name="l01768"></a>01768         glClear(GL_DEPTH_BUFFER_BIT);
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01771"></a>01771     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01772"></a>01772     
<a name="l01773"></a>01773     <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l01774"></a>01774         next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l01775"></a>01775         <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#af07ed26afb2547ae9ca82c66fa704777">flag</a>);
<a name="l01776"></a>01776         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>, v3da);
<a name="l01777"></a>01777         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l01778"></a>01778     }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01781"></a>01781     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783 }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 <span class="comment">/* *********************** */</span>
<a name="l01786"></a>01786 
<a name="l01787"></a>01787 <span class="comment">/*</span>
<a name="l01788"></a>01788 <span class="comment"> * In most cases call draw_dupli_objects,</span>
<a name="l01789"></a>01789 <span class="comment"> * draw_dupli_objects_color was added because when drawing set dupli&#39;s</span>
<a name="l01790"></a>01790 <span class="comment"> * we need to force the color</span>
<a name="l01791"></a>01791 <span class="comment"> */</span>
<a name="l01792"></a>01792 
<a name="l01793"></a>01793 <span class="preprocessor">#if 0</span>
<a name="l01794"></a>01794 <span class="preprocessor"></span><span class="keywordtype">int</span> dupli_ob_sort(<span class="keywordtype">void</span> *arg1, <span class="keywordtype">void</span> *arg2)
<a name="l01795"></a>01795 {
<a name="l01796"></a>01796     <span class="keywordtype">void</span> *p1 = ((<a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *)arg1)-&gt;ob;
<a name="l01797"></a>01797     <span class="keywordtype">void</span> *p2 = ((<a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *)arg2)-&gt;ob;
<a name="l01798"></a>01798     <span class="keywordtype">int</span> val = 0;
<a name="l01799"></a>01799     <span class="keywordflow">if</span> (p1 &lt; p2) val = -1;
<a name="l01800"></a>01800     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p1 &gt; p2) val = 1;
<a name="l01801"></a>01801     <span class="keywordflow">return</span> val;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 <span class="preprocessor">#endif</span>
<a name="l01804"></a>01804 <span class="preprocessor"></span>
<a name="l01805"></a>01805 
<a name="l01806"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a3cb401a96e5d973dc4aa6635fb4d7aa6">01806</a> <span class="keyword">static</span> <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *<a class="code" href="../../d8/d7f/view3d__draw_8c.html#a3cb401a96e5d973dc4aa6635fb4d7aa6">dupli_step</a>(<a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob)
<a name="l01807"></a>01807 {
<a name="l01808"></a>01808     <span class="keywordflow">while</span> (dob &amp;&amp; dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a773b85a90ed4f86fe3fbaac4f97aae30">no_draw</a>)
<a name="l01809"></a>01809         dob = dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>;
<a name="l01810"></a>01810     <span class="keywordflow">return</span> dob;
<a name="l01811"></a>01811 }
<a name="l01812"></a>01812 
<a name="l01813"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">01813</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">draw_dupli_objects_color</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d3/da9/structBase.html">Base</a> *base, <span class="keywordtype">int</span> color)
<a name="l01814"></a>01814 {
<a name="l01815"></a>01815     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01816"></a>01816     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb;
<a name="l01817"></a>01817     <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob_prev = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *dob, *dob_next = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01818"></a>01818     <a class="code" href="../../d3/da9/structBase.html">Base</a> tbase;
<a name="l01819"></a>01819     <a class="code" href="../../d3/d8a/structBoundBox.html">BoundBox</a> bb, *bb_tmp; <span class="comment">/* use a copy because draw_object, calls clear_mesh_caches */</span>
<a name="l01820"></a>01820     GLuint displist = 0;
<a name="l01821"></a>01821     <span class="keywordtype">short</span> transflag, use_displist = -1;  <span class="comment">/* -1 is initialize */</span>
<a name="l01822"></a>01822     <span class="keywordtype">char</span> dt, dtx;
<a name="l01823"></a>01823     
<a name="l01824"></a>01824     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#afc7a8aca0c2cf33c6323883e313362b0">restrictflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a405802c89add02dcf80f5fbcce040b09">OB_RESTRICT_VIEW</a>) <span class="keywordflow">return</span>;
<a name="l01825"></a>01825     
<a name="l01826"></a>01826     tbase.<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ac31d50d415c660a44c0ccdc6b4854721">OB_FROMDUPLI</a> | base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a>;
<a name="l01827"></a>01827     lb = <a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(scene, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>);
<a name="l01828"></a>01828     <span class="comment">// BLI_sortlist(lb, dupli_ob_sort); // might be nice to have if we have a dupli list with mixed objects.</span>
<a name="l01829"></a>01829 
<a name="l01830"></a>01830     dob = <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a3cb401a96e5d973dc4aa6635fb4d7aa6">dupli_step</a>(lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l01831"></a>01831     <span class="keywordflow">if</span> (dob) dob_next = <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a3cb401a96e5d973dc4aa6635fb4d7aa6">dupli_step</a>(dob-&gt;next);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     <span class="keywordflow">for</span> (; dob; dob_prev = dob, dob = dob_next, dob_next = dob_next ? <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a3cb401a96e5d973dc4aa6635fb4d7aa6">dupli_step</a>(dob_next-&gt;next) : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01834"></a>01834         tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> = dob-&gt;ob;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836         <span class="comment">/* extra service: draw the duplicator in drawtype of parent */</span>
<a name="l01837"></a>01837         <span class="comment">/* MIN2 for the drawtype to allow bounding box objects in groups for lods */</span>
<a name="l01838"></a>01838         dt = tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a849f37900ed7ea1f55647f7f4f8ed123">dt</a>;   tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a849f37900ed7ea1f55647f7f4f8ed123">dt</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a849f37900ed7ea1f55647f7f4f8ed123">dt</a>, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a849f37900ed7ea1f55647f7f4f8ed123">dt</a>);
<a name="l01839"></a>01839         dtx = tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2e4203e6270100e25ef3d5ec64fc31a6">dtx</a>; tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2e4203e6270100e25ef3d5ec64fc31a6">dtx</a> = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2e4203e6270100e25ef3d5ec64fc31a6">dtx</a>;
<a name="l01840"></a>01840 
<a name="l01841"></a>01841         <span class="comment">/* negative scale flag has to propagate */</span>
<a name="l01842"></a>01842         transflag = tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a>;
<a name="l01843"></a>01843         <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a87014edc673c17c72d0cf437921da147">OB_NEG_SCALE</a>)
<a name="l01844"></a>01844             tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> ^= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a87014edc673c17c72d0cf437921da147">OB_NEG_SCALE</a>;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846         <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(color, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.5);
<a name="l01847"></a>01847 
<a name="l01848"></a>01848         <span class="comment">/* generate displist, test for new object */</span>
<a name="l01849"></a>01849         <span class="keywordflow">if</span> (dob_prev &amp;&amp; dob_prev-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a> != dob-&gt;ob) {
<a name="l01850"></a>01850             <span class="keywordflow">if</span> (use_displist == 1)
<a name="l01851"></a>01851                 glDeleteLists(displist, 1);
<a name="l01852"></a>01852 
<a name="l01853"></a>01853             use_displist = -1;
<a name="l01854"></a>01854         }
<a name="l01855"></a>01855 
<a name="l01856"></a>01856         <span class="comment">/* generate displist */</span>
<a name="l01857"></a>01857         <span class="keywordflow">if</span> (use_displist == -1) {
<a name="l01858"></a>01858 
<a name="l01859"></a>01859             <span class="comment">/* note, since this was added, its checked dob-&gt;type==OB_DUPLIGROUP</span>
<a name="l01860"></a>01860 <span class="comment">             * however this is very slow, it was probably needed for the NLA</span>
<a name="l01861"></a>01861 <span class="comment">             * offset feature (used in group-duplicate.blend but no longer works in 2.5)</span>
<a name="l01862"></a>01862 <span class="comment">             * so for now it should be ok to - campbell */</span>
<a name="l01863"></a>01863 
<a name="l01864"></a>01864             <span class="keywordflow">if</span> (<span class="comment">/* if this is the last no need  to make a displist */</span>
<a name="l01865"></a>01865                 (dob_next == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || dob_next-&gt;ob != dob-&gt;ob) ||
<a name="l01866"></a>01866                 <span class="comment">/* lamp drawing messes with matrices, could be handled smarter... but this works */</span>
<a name="l01867"></a>01867                 (dob-&gt;ob-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>) ||
<a name="l01868"></a>01868                 (dob-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#aa1086c43316c4611714f7e459356873e">OB_DUPLIGROUP</a> &amp;&amp; dob-&gt;animated) ||
<a name="l01869"></a>01869                 !(bb_tmp = <a class="code" href="../../df/dac/BKE__object_8h.html#a06d0e9b4ebc3a7cf0f99a8916f90a851">object_get_boundbox</a>(dob-&gt;ob)))
<a name="l01870"></a>01870             {
<a name="l01871"></a>01871                 <span class="comment">// printf(&quot;draw_dupli_objects_color: skipping displist for %s\n&quot;, dob-&gt;ob-&gt;id.name+2);</span>
<a name="l01872"></a>01872                 use_displist = 0;
<a name="l01873"></a>01873             }
<a name="l01874"></a>01874             <span class="keywordflow">else</span> {
<a name="l01875"></a>01875                 <span class="comment">// printf(&quot;draw_dupli_objects_color: using displist for %s\n&quot;, dob-&gt;ob-&gt;id.name+2);</span>
<a name="l01876"></a>01876                 bb = *bb_tmp; <span class="comment">/* must make a copy  */</span>
<a name="l01877"></a>01877 
<a name="l01878"></a>01878                 <span class="comment">/* disable boundbox check for list creation */</span>
<a name="l01879"></a>01879                 <a class="code" href="../../df/dac/BKE__object_8h.html#a6b92082bae205be8b962fe1b13056cc7">object_boundbox_flag</a>(dob-&gt;ob, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#acac2082733d5040325372a484145fd58">OB_BB_DISABLED</a>, 1);
<a name="l01880"></a>01880                 <span class="comment">/* need this for next part of code */</span>
<a name="l01881"></a>01881                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(dob-&gt;ob-&gt;obmat);    <span class="comment">/* obmat gets restored */</span>
<a name="l01882"></a>01882 
<a name="l01883"></a>01883                 displist = glGenLists(1);
<a name="l01884"></a>01884                 glNewList(displist, GL_COMPILE);
<a name="l01885"></a>01885                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, &amp;tbase, <a class="code" href="../../d4/df4/view3d__intern_8h.html#a865840f950d43c02ac67cce1663bd822">DRAW_CONSTCOLOR</a>);
<a name="l01886"></a>01886                 glEndList();
<a name="l01887"></a>01887 
<a name="l01888"></a>01888                 use_displist = 1;
<a name="l01889"></a>01889                 <a class="code" href="../../df/dac/BKE__object_8h.html#a6b92082bae205be8b962fe1b13056cc7">object_boundbox_flag</a>(dob-&gt;ob, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#acac2082733d5040325372a484145fd58">OB_BB_DISABLED</a>, 0);
<a name="l01890"></a>01890             }
<a name="l01891"></a>01891         }
<a name="l01892"></a>01892         <span class="keywordflow">if</span> (use_displist) {
<a name="l01893"></a>01893             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a22a8b7985dcd174e9add6f20aa37a962">glMultMatrixf</a>(dob-&gt;mat);
<a name="l01894"></a>01894             <span class="keywordflow">if</span> (<a class="code" href="../../d4/df4/view3d__intern_8h.html#a6bfc52d69da31d8e5c9a2eb4384fd90a">ED_view3d_boundbox_clip</a>(rv3d, dob-&gt;mat, &amp;bb))
<a name="l01895"></a>01895                 glCallList(displist);
<a name="l01896"></a>01896             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l01897"></a>01897         }
<a name="l01898"></a>01898         <span class="keywordflow">else</span> {
<a name="l01899"></a>01899             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(dob-&gt;ob-&gt;obmat, dob-&gt;mat);
<a name="l01900"></a>01900             <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, &amp;tbase, <a class="code" href="../../d4/df4/view3d__intern_8h.html#a865840f950d43c02ac67cce1663bd822">DRAW_CONSTCOLOR</a>);
<a name="l01901"></a>01901         }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903         tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a849f37900ed7ea1f55647f7f4f8ed123">dt</a> = dt;
<a name="l01904"></a>01904         tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a2e4203e6270100e25ef3d5ec64fc31a6">dtx</a> = dtx;
<a name="l01905"></a>01905         tbase.<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> = transflag;
<a name="l01906"></a>01906     }
<a name="l01907"></a>01907     
<a name="l01908"></a>01908     <span class="comment">/* Transp afterdraw disabled, afterdraw only stores base pointers, and duplis can be same obj */</span>
<a name="l01909"></a>01909     
<a name="l01910"></a>01910     <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb);  <span class="comment">/* does restore */</span>
<a name="l01911"></a>01911     
<a name="l01912"></a>01912     <span class="keywordflow">if</span> (use_displist)
<a name="l01913"></a>01913         glDeleteLists(displist, 1);
<a name="l01914"></a>01914 }
<a name="l01915"></a>01915 
<a name="l01916"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#af13d35d2ec0e792ba7fe69d09edf0efa">01916</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#af13d35d2ec0e792ba7fe69d09edf0efa">draw_dupli_objects</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d3/da9/structBase.html">Base</a> *base)
<a name="l01917"></a>01917 {
<a name="l01918"></a>01918     <span class="comment">/* define the color here so draw_dupli_objects_color can be called</span>
<a name="l01919"></a>01919 <span class="comment">     * from the set loop */</span>
<a name="l01920"></a>01920     
<a name="l01921"></a>01921     <span class="keywordtype">int</span> color = (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) ? <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531acf22ebe596e9394104b732b077cbec7a">TH_SELECT</a> : <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>;
<a name="l01922"></a>01922     <span class="comment">/* debug */</span>
<a name="l01923"></a>01923     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a> &amp;&amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a3f0daef111a437533e48f6209429b49f">dup_group</a>-&gt;<a class="code" href="../../d4/d91/structGroup.html#ab7e17dc53d15eeb5f6c4c7789d92b969">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> &lt; 1)
<a name="l01924"></a>01924         color = <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a65e3169909737674a0536441605a5754">TH_REDALERT</a>;
<a name="l01925"></a>01925     
<a name="l01926"></a>01926     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">draw_dupli_objects_color</a>(scene, ar, v3d, base, color);
<a name="l01927"></a>01927 }
<a name="l01928"></a>01928 
<a name="l01929"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a2ad8f4308756d7d8e3055de02afc4298">01929</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a2f07e89d6671d0005f67f00162c0a16b">view3d_update_depths_rect</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../de/ddc/structViewDepths.html">ViewDepths</a> *d, <a class="code" href="../../d0/d28/structrcti.html">rcti</a> *rect)
<a name="l01930"></a>01930 {
<a name="l01931"></a>01931     <span class="keywordtype">int</span> x, y, w, h; 
<a name="l01932"></a>01932     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> r;
<a name="l01933"></a>01933     <span class="comment">/* clamp rect by area */</span>
<a name="l01934"></a>01934 
<a name="l01935"></a>01935     r.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = 0;
<a name="l01936"></a>01936     r.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> - 1;
<a name="l01937"></a>01937     r.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = 0;
<a name="l01938"></a>01938     r.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> - 1;
<a name="l01939"></a>01939 
<a name="l01940"></a>01940     <span class="comment">/* Constrain rect to depth bounds */</span>
<a name="l01941"></a>01941     <a class="code" href="../../d5/d44/BLI__rect_8h.html#abefa6d62a6bf5021bb1567112c87fd09">BLI_isect_rcti</a>(&amp;r, rect, rect);
<a name="l01942"></a>01942 
<a name="l01943"></a>01943     <span class="comment">/* assign values to compare with the ViewDepths */</span>
<a name="l01944"></a>01944     x = rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l01945"></a>01945     y = rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947     w = rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> - rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l01948"></a>01948     h = rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> - rect-&gt;<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <span class="keywordflow">if</span> (w &lt;= 0 || h &lt;= 0) {
<a name="l01951"></a>01951         <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>)
<a name="l01952"></a>01952             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>);
<a name="l01953"></a>01953         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01954"></a>01954 
<a name="l01955"></a>01955         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01956"></a>01956     }
<a name="l01957"></a>01957     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> != w ||
<a name="l01958"></a>01958              d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a> != h ||
<a name="l01959"></a>01959              d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#aa4c9df5488ba47b2d2902aa4bc0659fe">x</a> != x ||
<a name="l01960"></a>01960              d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a243c8290bd36ea6adf95d361ba349ed4">y</a> != y ||
<a name="l01961"></a>01961              d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>
<a name="l01962"></a>01962              )
<a name="l01963"></a>01963     {
<a name="l01964"></a>01964         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#aa4c9df5488ba47b2d2902aa4bc0659fe">x</a> = x;
<a name="l01965"></a>01965         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a243c8290bd36ea6adf95d361ba349ed4">y</a> = y;
<a name="l01966"></a>01966         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> = w;
<a name="l01967"></a>01967         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a> = h;
<a name="l01968"></a>01968 
<a name="l01969"></a>01969         <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>)
<a name="l01970"></a>01970             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> * d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a>, <span class="stringliteral">&quot;View depths Subset&quot;</span>);
<a name="l01973"></a>01973         
<a name="l01974"></a>01974         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01975"></a>01975     }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a>) {
<a name="l01978"></a>01978         glReadPixels(ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> + d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#aa4c9df5488ba47b2d2902aa4bc0659fe">x</a>, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> + d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a243c8290bd36ea6adf95d361ba349ed4">y</a>, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a>, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a>, GL_DEPTH_COMPONENT, GL_FLOAT, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>);
<a name="l01979"></a>01979         glGetDoublev(GL_DEPTH_RANGE, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#ab2f63c3341a75c5e907f9263cb199947">depth_range</a>);
<a name="l01980"></a>01980         d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01981"></a>01981     }
<a name="l01982"></a>01982 }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 <span class="comment">/* note, with nouveau drivers the glReadPixels() is very slow. [#24339] */</span>
<a name="l01985"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#ae37522512d9a7cd3a3deef979c3415da">01985</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a3a39dc2a210c2b1ad135b918c288d1c4">ED_view3d_depth_update</a>(<a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar)
<a name="l01986"></a>01986 {
<a name="l01987"></a>01987     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l01988"></a>01988     
<a name="l01989"></a>01989     <span class="comment">/* Create storage for, and, if necessary, copy depth buffer */</span>
<a name="l01990"></a>01990     <span class="keywordflow">if</span> (!rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad42475ca8dcac3b4e0560c71f462f39c">depths</a>) rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad42475ca8dcac3b4e0560c71f462f39c">depths</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/ddc/structViewDepths.html">ViewDepths</a>), <span class="stringliteral">&quot;ViewDepths&quot;</span>);
<a name="l01991"></a>01991     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad42475ca8dcac3b4e0560c71f462f39c">depths</a>) {
<a name="l01992"></a>01992         <a class="code" href="../../de/ddc/structViewDepths.html">ViewDepths</a> *d = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad42475ca8dcac3b4e0560c71f462f39c">depths</a>;
<a name="l01993"></a>01993         <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> != ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> ||
<a name="l01994"></a>01994             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a> != ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> ||
<a name="l01995"></a>01995             !d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>)
<a name="l01996"></a>01996         {
<a name="l01997"></a>01997             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l01998"></a>01998             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a> = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l01999"></a>01999             <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>)
<a name="l02000"></a>02000                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>);
<a name="l02001"></a>02001             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> * d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a>, <span class="stringliteral">&quot;View depths&quot;</span>);
<a name="l02002"></a>02002             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a> = 1;
<a name="l02003"></a>02003         }
<a name="l02004"></a>02004         
<a name="l02005"></a>02005         <span class="keywordflow">if</span> (d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a>) {
<a name="l02006"></a>02006             glReadPixels(ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a>, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a>,
<a name="l02007"></a>02007                          GL_DEPTH_COMPONENT, GL_FLOAT, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>);
<a name="l02008"></a>02008             
<a name="l02009"></a>02009             glGetDoublev(GL_DEPTH_RANGE, d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#ab2f63c3341a75c5e907f9263cb199947">depth_range</a>);
<a name="l02010"></a>02010             
<a name="l02011"></a>02011             d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a65b72121e9e8424ac4d9e1bfdcbce9b0">damaged</a> = 0;
<a name="l02012"></a>02012         }
<a name="l02013"></a>02013     }
<a name="l02014"></a>02014 }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016 <span class="comment">/* utility function to find the closest Z value, use for autodepth */</span>
<a name="l02017"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a20a7005c6675084fa5e91d0a2ca3b5a7">02017</a> <span class="keywordtype">float</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a75ce319b146658617fde9f5768d56302">view3d_depth_near</a>(<a class="code" href="../../de/ddc/structViewDepths.html">ViewDepths</a> *d)
<a name="l02018"></a>02018 {
<a name="l02019"></a>02019     <span class="comment">/* convert to float for comparisons */</span>
<a name="l02020"></a>02020     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f8c71de251bfd53efeee45aaf0a8470">near</a> = (float)d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#ab2f63c3341a75c5e907f9263cb199947">depth_range</a>[0];
<a name="l02021"></a>02021     <span class="keyword">const</span> <span class="keywordtype">float</span> far_real = (<span class="keywordtype">float</span>)d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#ab2f63c3341a75c5e907f9263cb199947">depth_range</a>[1];
<a name="l02022"></a>02022     <span class="keywordtype">float</span> <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a0996c29b5fdd7baa181e30274b2378b7">far</a> = far_real;
<a name="l02023"></a>02023 
<a name="l02024"></a>02024     <span class="keyword">const</span> <span class="keywordtype">float</span> *depths = d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a8920463bc49ebed8f94ba29f3799c18b">depths</a>;
<a name="l02025"></a>02025     <span class="keywordtype">float</span> depth = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l02026"></a>02026     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = (int)d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#a7d5ae2ae3beb30d48970bed2edaf4241">w</a> * (<span class="keywordtype">int</span>)d-&gt;<a class="code" href="../../de/ddc/structViewDepths.html#adab32ddd3abf0aebbfb51d12e82c4c70">h</a>; <span class="comment">/* cast to avoid short overflow */</span>
<a name="l02027"></a>02027 
<a name="l02028"></a>02028     <span class="comment">/* far is both the starting &#39;far&#39; value</span>
<a name="l02029"></a>02029 <span class="comment">     * and the closest value found. */</span>  
<a name="l02030"></a>02030     <span class="keywordflow">while</span> (i--) {
<a name="l02031"></a>02031         depth = *depths++;
<a name="l02032"></a>02032         <span class="keywordflow">if</span> ((depth &lt; far) &amp;&amp; (depth &gt; <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f8c71de251bfd53efeee45aaf0a8470">near</a>)) {
<a name="l02033"></a>02033             far = depth;
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035     }
<a name="l02036"></a>02036 
<a name="l02037"></a>02037     <span class="keywordflow">return</span> far == far_real ? <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a> : <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a0996c29b5fdd7baa181e30274b2378b7">far</a>;
<a name="l02038"></a>02038 }
<a name="l02039"></a>02039 
<a name="l02040"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#ac8d83754637082084057505f4e1d7768">02040</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac8d83754637082084057505f4e1d7768">draw_depth_gpencil</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l02041"></a>02041 {
<a name="l02042"></a>02042     <span class="keywordtype">short</span> zbuf = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>;
<a name="l02043"></a>02043     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02044"></a>02044 
<a name="l02045"></a>02045     <a class="code" href="../../d4/df4/view3d__intern_8h.html#a4af4b66d19b682419c20727b7f918b4c">setwinmatrixview3d</a>(ar, v3d, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);  <span class="comment">/* 0= no pick rect */</span>
<a name="l02046"></a>02046     <a class="code" href="../../d4/df4/view3d__intern_8h.html#a9ec7a204dbff86083f5b312ed53ba86b">setviewmatrixview3d</a>(scene, v3d, rv3d);  <span class="comment">/* note: calls where_is_object for camera... */</span>
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02049"></a>02049     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ac8b049c589a4159afee5f4d0114dbed7">persinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>);
<a name="l02050"></a>02050     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052     glClear(GL_DEPTH_BUFFER_BIT);
<a name="l02053"></a>02053 
<a name="l02054"></a>02054     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02055"></a>02055 
<a name="l02056"></a>02056     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02057"></a>02057     glEnable(GL_DEPTH_TEST);
<a name="l02058"></a>02058 
<a name="l02059"></a>02059     <a class="code" href="../../dd/d3e/drawgpencil_8c.html#a89baec14d65520d28457c45cedcde6a1">draw_gpencil_view3d</a>(scene, v3d, ar, 1);
<a name="l02060"></a>02060     
<a name="l02061"></a>02061     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = zbuf;
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 }
<a name="l02064"></a>02064 
<a name="l02065"></a><a class="code" href="../../d4/df4/view3d__intern_8h.html#a0bfcaebe0a1f2edcf495ed574e665bd7">02065</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#afc42bf8956affceefb3d6afa9ecbc2aa">draw_depth</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <span class="keywordtype">int</span> (*func)(<span class="keywordtype">void</span> *))
<a name="l02066"></a>02066 {
<a name="l02067"></a>02067     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02068"></a>02068     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l02069"></a>02069     <span class="keywordtype">short</span> zbuf = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>;
<a name="l02070"></a>02070     <span class="keywordtype">short</span> <a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a>;
<a name="l02071"></a>02071     <span class="keywordtype">float</span> glalphaclip = <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.glalphaclip;
<a name="l02072"></a>02072     <span class="keywordtype">int</span> obcenter_dia = <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.obcenter_dia;
<a name="l02073"></a>02073     <span class="comment">/* temp set drawtype to solid */</span>
<a name="l02074"></a>02074     
<a name="l02075"></a>02075     <span class="comment">/* Setting these temporarily is not nice */</span>
<a name="l02076"></a>02076     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp;= ~<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5556e5caae70d11b0f6aacf0ebb02f2f">V3D_SELECT_OUTLINE</a>;
<a name="l02077"></a>02077     <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.glalphaclip = 0.5; <span class="comment">/* not that nice but means we wont zoom into billboards */</span>
<a name="l02078"></a>02078     <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.obcenter_dia = 0;
<a name="l02079"></a>02079     
<a name="l02080"></a>02080     <a class="code" href="../../d4/df4/view3d__intern_8h.html#a4af4b66d19b682419c20727b7f918b4c">setwinmatrixview3d</a>(ar, v3d, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);  <span class="comment">/* 0= no pick rect */</span>
<a name="l02081"></a>02081     <a class="code" href="../../d4/df4/view3d__intern_8h.html#a9ec7a204dbff86083f5b312ed53ba86b">setviewmatrixview3d</a>(scene, v3d, rv3d);  <span class="comment">/* note: calls where_is_object for camera... */</span>
<a name="l02082"></a>02082     
<a name="l02083"></a>02083     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02084"></a>02084     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ac8b049c589a4159afee5f4d0114dbed7">persinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>);
<a name="l02085"></a>02085     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02086"></a>02086     
<a name="l02087"></a>02087     glClear(GL_DEPTH_BUFFER_BIT);
<a name="l02088"></a>02088     
<a name="l02089"></a>02089     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02090"></a>02090 <span class="comment">//  persp(PERSP_STORE);  // store correct view for persp(PERSP_VIEW) calls</span>
<a name="l02091"></a>02091     
<a name="l02092"></a>02092     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>) {
<a name="l02093"></a>02093         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a403862b556efefe2375ce8cf99110fd5">ED_view3d_clipping_set</a>(rv3d);
<a name="l02094"></a>02094     }
<a name="l02095"></a>02095     
<a name="l02096"></a>02096     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02097"></a>02097     glEnable(GL_DEPTH_TEST);
<a name="l02098"></a>02098     
<a name="l02099"></a>02099     <span class="comment">/* draw set first */</span>
<a name="l02100"></a>02100     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>) {
<a name="l02101"></a>02101         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter;
<a name="l02102"></a>02102         <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>, sce_iter, base)) {
<a name="l02103"></a>02103             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02104"></a>02104                 <span class="keywordflow">if</span> (func == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || func(base)) {
<a name="l02105"></a>02105                     <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, 0);
<a name="l02106"></a>02106                     <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l02107"></a>02107                         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">draw_dupli_objects_color</a>(scene, ar, v3d, base, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>);
<a name="l02108"></a>02108                     }
<a name="l02109"></a>02109                 }
<a name="l02110"></a>02110             }
<a name="l02111"></a>02111         }
<a name="l02112"></a>02112     }
<a name="l02113"></a>02113     
<a name="l02114"></a>02114     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l02115"></a>02115         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02116"></a>02116             <span class="keywordflow">if</span> (func == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || func(base)) {
<a name="l02117"></a>02117                 <span class="comment">/* dupli drawing */</span>
<a name="l02118"></a>02118                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l02119"></a>02119                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#af13d35d2ec0e792ba7fe69d09edf0efa">draw_dupli_objects</a>(scene, ar, v3d, base);
<a name="l02120"></a>02120                 }
<a name="l02121"></a>02121                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, 0);
<a name="l02122"></a>02122             }
<a name="l02123"></a>02123         }
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125     
<a name="l02126"></a>02126     <span class="comment">/* this isn&#39;t that nice, draw xray objects as if they are normal */</span>
<a name="l02127"></a>02127     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> ||
<a name="l02128"></a>02128         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> ||
<a name="l02129"></a>02129         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l02130"></a>02130     {
<a name="l02131"></a>02131         <a class="code" href="../../dd/d83/structView3DAfter.html">View3DAfter</a> *v3da, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>;
<a name="l02132"></a>02132         <span class="keywordtype">int</span> mask_orig;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02135"></a>02135         
<a name="l02136"></a>02136         <span class="comment">/* transp materials can change the depth mask, see #21388 */</span>
<a name="l02137"></a>02137         glGetIntegerv(GL_DEPTH_WRITEMASK, &amp;mask_orig);
<a name="l02138"></a>02138 
<a name="l02139"></a>02139 
<a name="l02140"></a>02140         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> || v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l02141"></a>02141             glDepthFunc(GL_ALWAYS); <span class="comment">/* always write into the depth bufer, overwriting front z values */</span>
<a name="l02142"></a>02142             <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l02143"></a>02143                 next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l02144"></a>02144                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, 0);
<a name="l02145"></a>02145             }
<a name="l02146"></a>02146             glDepthFunc(GL_LEQUAL); <span class="comment">/* Now write the depth buffer normally */</span>
<a name="l02147"></a>02147         }
<a name="l02148"></a>02148 
<a name="l02149"></a>02149         <span class="comment">/* draw 3 passes, transp/xray/xraytransp */</span>
<a name="l02150"></a>02150         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02151"></a>02151         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02152"></a>02152         <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l02153"></a>02153             next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l02154"></a>02154             <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, 0);
<a name="l02155"></a>02155             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>, v3da);
<a name="l02156"></a>02156             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l02157"></a>02157         }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02160"></a>02160         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02161"></a>02161         <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l02162"></a>02162             next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l02163"></a>02163             <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, 0);
<a name="l02164"></a>02164             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>, v3da);
<a name="l02165"></a>02165             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l02166"></a>02166         }
<a name="l02167"></a>02167 
<a name="l02168"></a>02168         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02169"></a>02169         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02170"></a>02170         <span class="keywordflow">for</span> (v3da = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; v3da; v3da = next) {
<a name="l02171"></a>02171             next = v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#aec4d7e0afebf923e789929c91a1e6a86">next</a>;
<a name="l02172"></a>02172             <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, v3da-&gt;<a class="code" href="../../dd/d83/structView3DAfter.html#a6aea350e3530af08bbe44e2b054a2e5d">base</a>, 0);
<a name="l02173"></a>02173             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>, v3da);
<a name="l02174"></a>02174             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(v3da);
<a name="l02175"></a>02175         }
<a name="l02176"></a>02176 
<a name="l02177"></a>02177         
<a name="l02178"></a>02178         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a6c3dbc2765218b5850a40f3afc522d42">xray</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02179"></a>02179         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ae22790924a440701ed3d01ad4db5eee2">transp</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02180"></a>02180 
<a name="l02181"></a>02181         glDepthMask(mask_orig);
<a name="l02182"></a>02182     }
<a name="l02183"></a>02183     
<a name="l02184"></a>02184     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02185"></a>02185         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa4cf5dc6374c7b1e81b8322fad984ece">ED_view3d_clipping_disable</a>();
<a name="l02186"></a>02186     
<a name="l02187"></a>02187     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = zbuf;
<a name="l02188"></a>02188     <span class="keywordflow">if</span> (!v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glDisable(GL_DEPTH_TEST);
<a name="l02189"></a>02189 
<a name="l02190"></a>02190     <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.glalphaclip = glalphaclip;
<a name="l02191"></a>02191     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> = <a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a>;
<a name="l02192"></a>02192     <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.obcenter_dia = obcenter_dia;
<a name="l02193"></a>02193 }
<a name="l02194"></a>02194 
<a name="l02195"></a><a class="code" href="../../df/de9/structView3DShadow.html">02195</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/de9/structView3DShadow.html">View3DShadow</a> {
<a name="l02196"></a><a class="code" href="../../df/de9/structView3DShadow.html#a046f466a25d6e4e46c461cc682359d73">02196</a>     <span class="keyword">struct </span><a class="code" href="../../df/de9/structView3DShadow.html">View3DShadow</a> *<a class="code" href="../../df/de9/structView3DShadow.html#ab0c3dfc6eac4c1984ac0767d7876b671">next</a>, *<a class="code" href="../../df/de9/structView3DShadow.html#a046f466a25d6e4e46c461cc682359d73">prev</a>;
<a name="l02197"></a><a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">02197</a>     <a class="code" href="../../db/d52/structGPULamp.html">GPULamp</a> *<a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>;
<a name="l02198"></a>02198 } <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ac4d59aec6a779c9bcd3fd2b880fc7da7">View3DShadow</a>;
<a name="l02199"></a>02199 
<a name="l02200"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a7c0e2318233f91848f98daaf1451af91">02200</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a7c0e2318233f91848f98daaf1451af91">gpu_render_lamp_update</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/de7/structObject.html">Object</a> *par,
<a name="l02201"></a>02201                                    <span class="keywordtype">float</span> obmat[][4], <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *shadows)
<a name="l02202"></a>02202 {
<a name="l02203"></a>02203     <a class="code" href="../../db/d52/structGPULamp.html">GPULamp</a> *<a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>;
<a name="l02204"></a>02204     <a class="code" href="../../d5/d72/structLamp.html">Lamp</a> *la = (<a class="code" href="../../d5/d72/structLamp.html">Lamp</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02205"></a>02205     <a class="code" href="../../df/de9/structView3DShadow.html">View3DShadow</a> *shadow;
<a name="l02206"></a>02206     
<a name="l02207"></a>02207     lamp = <a class="code" href="../../de/d68/GPU__material_8h.html#ad0b9a0859082d74d915374f04fecb433">GPU_lamp_from_blender</a>(scene, ob, par);
<a name="l02208"></a>02208     
<a name="l02209"></a>02209     <span class="keywordflow">if</span> (lamp) {
<a name="l02210"></a>02210         <a class="code" href="../../de/d68/GPU__material_8h.html#afaf1fbd4065e29400ca94b19c27bc1f3">GPU_lamp_update</a>(lamp, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a>, (ob-&gt;<a class="code" href="../../de/de7/structObject.html#afc7a8aca0c2cf33c6323883e313362b0">restrictflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#ab94b52225b1bb3d5083e9855b32902d0">OB_RESTRICT_RENDER</a>), obmat);
<a name="l02211"></a>02211         <a class="code" href="../../de/d68/GPU__material_8h.html#a41e7c921a7b85b1654ea3389789d0440">GPU_lamp_update_colors</a>(lamp, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a78ed635336937d2f878451f2ad65e849">r</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#ae84f4026e3ea64b20481dfcfa0c66f3f">g</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a2dee0a9717f05d6faff57abed6dd39dc">b</a>, la-&gt;<a class="code" href="../../d5/d72/structLamp.html#a92ccf572420771f58d0907c0ae410c42">energy</a>);
<a name="l02212"></a>02212         
<a name="l02213"></a>02213         <span class="keywordflow">if</span> ((ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> &amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a>) &amp;&amp; <a class="code" href="../../de/d68/GPU__material_8h.html#a179f580ca91bc9eb8d779d9bc2b10ce0">GPU_lamp_has_shadow_buffer</a>(lamp)) {
<a name="l02214"></a>02214             shadow = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/de9/structView3DShadow.html">View3DShadow</a>), <span class="stringliteral">&quot;View3DShadow&quot;</span>);
<a name="l02215"></a>02215             shadow-&gt;lamp = <a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>;
<a name="l02216"></a>02216             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(shadows, shadow);
<a name="l02217"></a>02217         }
<a name="l02218"></a>02218     }
<a name="l02219"></a>02219 }
<a name="l02220"></a>02220 
<a name="l02221"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa1559ec45f96cc92b59be961c608d75c">02221</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa1559ec45f96cc92b59be961c608d75c">gpu_update_lamps_shadows</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l02222"></a>02222 {
<a name="l02223"></a>02223     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> shadows;
<a name="l02224"></a>02224     <a class="code" href="../../df/de9/structView3DShadow.html">View3DShadow</a> *shadow;
<a name="l02225"></a>02225     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter;
<a name="l02226"></a>02226     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l02227"></a>02227     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l02228"></a>02228     
<a name="l02229"></a>02229     shadows.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = shadows.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02230"></a>02230     
<a name="l02231"></a>02231     <span class="comment">/* update lamp transform and gather shadow lamps */</span>
<a name="l02232"></a>02232     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene, sce_iter, base)) {
<a name="l02233"></a>02233         ob = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>;
<a name="l02234"></a>02234         
<a name="l02235"></a>02235         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>)
<a name="l02236"></a>02236             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a7c0e2318233f91848f98daaf1451af91">gpu_render_lamp_update</a>(scene, v3d, ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, &amp;shadows);
<a name="l02237"></a>02237         
<a name="l02238"></a>02238         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l02239"></a>02239             <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob;
<a name="l02240"></a>02240             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(scene, ob);
<a name="l02241"></a>02241             
<a name="l02242"></a>02242             <span class="keywordflow">for</span> (dob = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dob; dob = dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>)
<a name="l02243"></a>02243                 <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1514ec0465b89013544107c908e7abca">OB_LAMP</a>)
<a name="l02244"></a>02244                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a7c0e2318233f91848f98daaf1451af91">gpu_render_lamp_update</a>(scene, v3d, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>, ob, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#a30eca7be3df2308e3e320b7e80159689">mat</a>, &amp;shadows);
<a name="l02245"></a>02245             
<a name="l02246"></a>02246             <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb);
<a name="l02247"></a>02247         }
<a name="l02248"></a>02248     }
<a name="l02249"></a>02249     
<a name="l02250"></a>02250     <span class="comment">/* render shadows after updating all lamps, nested object_duplilist</span>
<a name="l02251"></a>02251 <span class="comment">     * don&#39;t work correct since it&#39;s replacing object matrices */</span>
<a name="l02252"></a>02252     <span class="keywordflow">for</span> (shadow = shadows.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; shadow; shadow = shadow-&gt;<a class="code" href="../../df/de9/structView3DShadow.html#ab0c3dfc6eac4c1984ac0767d7876b671">next</a>) {
<a name="l02253"></a>02253         <span class="comment">/* this needs to be done better .. */</span>
<a name="l02254"></a>02254         <span class="keywordtype">float</span> viewmat[4][4], winmat[4][4];
<a name="l02255"></a>02255         <span class="keywordtype">int</span> drawtype, lay, winsize, flag2 = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a>;
<a name="l02256"></a>02256         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> ar = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02257"></a>02257         <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> rv3d = {{{0}}};
<a name="l02258"></a>02258         
<a name="l02259"></a>02259         drawtype = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a>;
<a name="l02260"></a>02260         lay = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a>;
<a name="l02261"></a>02261         
<a name="l02262"></a>02262         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> = <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a02098d23ce96d480e90882bed52cb89d">OB_SOLID</a>;
<a name="l02263"></a>02263         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp;= <a class="code" href="../../de/d68/GPU__material_8h.html#a7198b3890d9aade959185a9887e91506">GPU_lamp_shadow_layer</a>(shadow-&gt;<a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>);
<a name="l02264"></a>02264         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp;= ~<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a0f1d810430681f2fbfcef43c2887a38f">V3D_SOLID_TEX</a>;
<a name="l02265"></a>02265         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> |= <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a> | <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#afb3cea5af9bdf7d33facf737c539460b">V3D_RENDER_SHADOW</a>;
<a name="l02266"></a>02266         
<a name="l02267"></a>02267         <a class="code" href="../../de/d68/GPU__material_8h.html#a75008e08825f5719cd57e6ea3c9ea3fa">GPU_lamp_shadow_buffer_bind</a>(shadow-&gt;<a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>, viewmat, &amp;winsize, winmat);
<a name="l02268"></a>02268 
<a name="l02269"></a>02269         ar.<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a> = &amp;rv3d;
<a name="l02270"></a>02270         ar.<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> = <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>;
<a name="l02271"></a>02271         rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> = <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>;
<a name="l02272"></a>02272         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, winmat);
<a name="l02273"></a>02273         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, viewmat);
<a name="l02274"></a>02274         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02275"></a>02275         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02276"></a>02276         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ac8b049c589a4159afee5f4d0114dbed7">persinv</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>);
<a name="l02277"></a>02277 
<a name="l02278"></a>02278         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad53d0aa8d7153cb4a42d2949cd2e03fb">ED_view3d_draw_offscreen</a>(scene, v3d, &amp;ar, winsize, winsize, viewmat, winmat, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02279"></a>02279         <a class="code" href="../../de/d68/GPU__material_8h.html#a5b2fd3c550656f172356001f843d5712">GPU_lamp_shadow_buffer_unbind</a>(shadow-&gt;<a class="code" href="../../df/de9/structView3DShadow.html#aa06c7b4d50bebaeb825ee9f636c334bd">lamp</a>);
<a name="l02280"></a>02280         
<a name="l02281"></a>02281         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> = drawtype;
<a name="l02282"></a>02282         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> = lay;
<a name="l02283"></a>02283         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> = flag2;
<a name="l02284"></a>02284     }
<a name="l02285"></a>02285     
<a name="l02286"></a>02286     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;shadows);
<a name="l02287"></a>02287 }
<a name="l02288"></a>02288 
<a name="l02289"></a>02289 <span class="comment">/* *********************** customdata **************** */</span>
<a name="l02290"></a>02290 
<a name="l02291"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0c6a570d3967e8fe297e5b0027928a26">02291</a> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad56e510116a3957fd69b7392bc6d7014">ED_view3d_datamask</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d)
<a name="l02292"></a>02292 {
<a name="l02293"></a>02293     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask = 0;
<a name="l02294"></a>02294 
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a12c14080c880d52c6a50c271e8bb87f8">OB_TEXTURE</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c65a551de1e814cda97b11b53904c8e">OB_MATERIAL</a>) ||
<a name="l02296"></a>02296         ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a02098d23ce96d480e90882bed52cb89d">OB_SOLID</a>) &amp;&amp; (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a0f1d810430681f2fbfcef43c2887a38f">V3D_SOLID_TEX</a>)))
<a name="l02297"></a>02297     {
<a name="l02298"></a>02298         mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a> | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>;
<a name="l02299"></a>02299 
<a name="l02300"></a>02300         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a041ff0e68dd0152e85ceddddc9b53cdc">scene_use_new_shading_nodes</a>(scene)) {
<a name="l02301"></a>02301             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a9c65a551de1e814cda97b11b53904c8e">OB_MATERIAL</a>)
<a name="l02302"></a>02302                 mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>;
<a name="l02303"></a>02303         }
<a name="l02304"></a>02304         <span class="keywordflow">else</span> {
<a name="l02305"></a>02305             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a966786bdf5ea4102e08aeeec6fcc65ab">gm</a>.<a class="code" href="../../d4/d6e/structGameData.html#a6cede4314df04c85946a10fbd7e109f0">matmode</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a488f8a5dafd4bf3954c021a5a9ffecc6">GAME_MAT_GLSL</a>)
<a name="l02306"></a>02306                 mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a3ac9841cc077e80db505a80862c7c788">CD_MASK_ORCO</a>;
<a name="l02307"></a>02307         }
<a name="l02308"></a>02308     }
<a name="l02309"></a>02309 
<a name="l02310"></a>02310     <span class="keywordflow">return</span> mask;
<a name="l02311"></a>02311 }
<a name="l02312"></a>02312 
<a name="l02313"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a68b81b8f204168417aeb949a1fb4f1bf">02313</a> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a4071e9013ae81fb7bb66fc84b0b34c70">ED_view3d_object_datamask</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l02314"></a>02314 {
<a name="l02315"></a>02315     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a> ? scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a040bbb56eb7746d04c4ae455e5b1c638">basact</a>-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02316"></a>02316     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask = 0;
<a name="l02317"></a>02317 
<a name="l02318"></a>02318     <span class="keywordflow">if</span> (ob) {
<a name="l02319"></a>02319         <span class="comment">/* check if we need tfaces &amp; mcols due to face select or texture paint */</span>
<a name="l02320"></a>02320         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d86/BKE__paint_8h.html#a56fc7a16c6dcfa3dd82680c86385e45f">paint_facesel_test</a>(ob) || (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550aefdee3fdb0d4e936026d0fbdeb55852d">OB_MODE_TEXTURE_PAINT</a>)) {
<a name="l02321"></a>02321             mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a8a8015f5b251bbf4a32f7c83554209b4">CD_MASK_MTFACE</a> | <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>;
<a name="l02322"></a>02322         }
<a name="l02323"></a>02323 
<a name="l02324"></a>02324         <span class="comment">/* check if we need mcols due to vertex paint or weightpaint */</span>
<a name="l02325"></a>02325         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>) {
<a name="l02326"></a>02326             mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a39309592e425ee3db512c41152ed8ea4">CD_MASK_MCOL</a>;
<a name="l02327"></a>02327         }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) {
<a name="l02330"></a>02330             mask |= <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e6aa6e2e4639941b0029226411d6a04">CD_MASK_PREVIEW_MCOL</a>;
<a name="l02331"></a>02331         }
<a name="l02332"></a>02332     }
<a name="l02333"></a>02333 
<a name="l02334"></a>02334     <span class="keywordflow">return</span> mask;
<a name="l02335"></a>02335 }
<a name="l02336"></a>02336 
<a name="l02337"></a>02337 <span class="comment">/* goes over all modes and view3d settings */</span>
<a name="l02338"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a232f9201c3b7952b7cfb26e6f609ce21">02338</a> <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#acea0129ba5bb9e2e2adc7b6fa644b1ba">ED_view3d_screen_datamask</a>(<a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *screen)
<a name="l02339"></a>02339 {
<a name="l02340"></a>02340     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = screen-&gt;<a class="code" href="../../de/de7/structbScreen.html#a98cbd326f3b4179f769d007556e14999">scene</a>;
<a name="l02341"></a>02341     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a2ffccc8a0150d2fe6f44a2407a542b30">CustomDataMask</a> mask = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>;
<a name="l02342"></a>02342     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa;
<a name="l02343"></a>02343     
<a name="l02344"></a>02344     <span class="comment">/* check if we need tfaces &amp; mcols due to view mode */</span>
<a name="l02345"></a>02345     <span class="keywordflow">for</span> (sa = screen-&gt;<a class="code" href="../../de/de7/structbScreen.html#ae2f4a800c4c58fe953d91fe8136a0d0f">areabase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sa; sa = sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a884b59339f5c0d55408f8727bfc799b7">next</a>) {
<a name="l02346"></a>02346         <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l02347"></a>02347             mask |= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad56e510116a3957fd69b7392bc6d7014">ED_view3d_datamask</a>(scene, (<a class="code" href="../../d6/deb/structView3D.html">View3D</a> *)sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a3e912d89fe2993ce473b0718900723d4">spacedata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l02348"></a>02348         }
<a name="l02349"></a>02349     }
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     mask |= <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a4071e9013ae81fb7bb66fc84b0b34c70">ED_view3d_object_datamask</a>(scene);
<a name="l02352"></a>02352 
<a name="l02353"></a>02353     <span class="keywordflow">return</span> mask;
<a name="l02354"></a>02354 }
<a name="l02355"></a>02355 
<a name="l02356"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a86ce4e771d4d5cac35844799c97229fb">02356</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1f6baef610a4921212d438e765ff80d4">ED_view3d_update_viewmat</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> viewmat[][4], <span class="keywordtype">float</span> winmat[][4])
<a name="l02357"></a>02357 {
<a name="l02358"></a>02358     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02359"></a>02359 
<a name="l02360"></a>02360     <span class="comment">/* setup window matrices */</span>
<a name="l02361"></a>02361     <span class="keywordflow">if</span> (winmat)
<a name="l02362"></a>02362         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, winmat);
<a name="l02363"></a>02363     <span class="keywordflow">else</span>
<a name="l02364"></a>02364         <a class="code" href="../../d4/df4/view3d__intern_8h.html#a4af4b66d19b682419c20727b7f918b4c">setwinmatrixview3d</a>(ar, v3d, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);  <span class="comment">/* NULL= no pickrect */</span>
<a name="l02365"></a>02365 
<a name="l02366"></a>02366     <span class="comment">/* setup view matrix */</span>
<a name="l02367"></a>02367     <span class="keywordflow">if</span> (viewmat)
<a name="l02368"></a>02368         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, viewmat);
<a name="l02369"></a>02369     <span class="keywordflow">else</span>
<a name="l02370"></a>02370         <a class="code" href="../../d4/df4/view3d__intern_8h.html#a9ec7a204dbff86083f5b312ed53ba86b">setviewmatrixview3d</a>(scene, v3d, rv3d);  <span class="comment">/* note: calls where_is_object for camera... */</span>
<a name="l02371"></a>02371 
<a name="l02372"></a>02372     <span class="comment">/* update utilitity matrices */</span>
<a name="l02373"></a>02373     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02374"></a>02374     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ac8b049c589a4159afee5f4d0114dbed7">persinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>);
<a name="l02375"></a>02375     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     <span class="comment">/* calculate pixelsize factor once, is used for lamps and obcenters */</span>
<a name="l02378"></a>02378     {
<a name="l02379"></a>02379         <span class="comment">/* note:  &#39;1.0f / len_v3(v1)&#39;  replaced  &#39;len_v3(rv3d-&gt;viewmat[0])&#39;</span>
<a name="l02380"></a>02380 <span class="comment">         * because of float point precision problems at large values [#23908] */</span>
<a name="l02381"></a>02381         <span class="keywordtype">float</span> v1[3], v2[3];
<a name="l02382"></a>02382         <span class="keywordtype">float</span> len1, len2;
<a name="l02383"></a>02383 
<a name="l02384"></a>02384         v1[0] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[0][0];
<a name="l02385"></a>02385         v1[1] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[1][0];
<a name="l02386"></a>02386         v1[2] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[2][0];
<a name="l02387"></a>02387 
<a name="l02388"></a>02388         v2[0] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[0][1];
<a name="l02389"></a>02389         v2[1] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[1][1];
<a name="l02390"></a>02390         v2[2] = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>[2][1];
<a name="l02391"></a>02391 
<a name="l02392"></a>02392         len1 = 1.0f / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(v1);
<a name="l02393"></a>02393         len2 = 1.0f / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(v2);
<a name="l02394"></a>02394 
<a name="l02395"></a>02395         rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aa2e5b4ca245017bd7242b4e2eb03d52e">pixsize</a> = (2.0f * <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(len1, len2)) / (<span class="keywordtype">float</span>)<a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>);
<a name="l02396"></a>02396     }
<a name="l02397"></a>02397 }
<a name="l02398"></a>02398 
<a name="l02399"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0ef33fe3c3fa42af53d87c44989c4693">02399</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0ef33fe3c3fa42af53d87c44989c4693">view3d_main_area_setup_view</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keywordtype">float</span> viewmat[][4], <span class="keywordtype">float</span> winmat[][4])
<a name="l02400"></a>02400 {
<a name="l02401"></a>02401     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02402"></a>02402 
<a name="l02403"></a>02403     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1f6baef610a4921212d438e765ff80d4">ED_view3d_update_viewmat</a>(scene, v3d, ar, viewmat, winmat);
<a name="l02404"></a>02404 
<a name="l02405"></a>02405     <span class="comment">/* set for opengl */</span>
<a name="l02406"></a>02406     glMatrixMode(GL_PROJECTION);
<a name="l02407"></a>02407     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>);
<a name="l02408"></a>02408     glMatrixMode(GL_MODELVIEW);
<a name="l02409"></a>02409     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02410"></a>02410 }
<a name="l02411"></a>02411 
<a name="l02412"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a78f2dfb696dd66a196d252f85354617b">02412</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad53d0aa8d7153cb4a42d2949cd2e03fb">ED_view3d_draw_offscreen</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar,
<a name="l02413"></a>02413                               <span class="keywordtype">int</span> winx, <span class="keywordtype">int</span> winy, <span class="keywordtype">float</span> viewmat[][4], <span class="keywordtype">float</span> winmat[][4],
<a name="l02414"></a>02414                               <span class="keywordtype">int</span> <a class="code" href="../../d6/db3/file__draw_8c.html#ac8f40d7d46805f84008e39a0e29040e6">draw_background</a>)
<a name="l02415"></a>02415 {
<a name="l02416"></a>02416     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02417"></a>02417     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l02418"></a>02418     <span class="keywordtype">float</span> backcol[3];
<a name="l02419"></a>02419     <span class="keywordtype">int</span> bwinx, bwiny;
<a name="l02420"></a>02420     <a class="code" href="../../d0/d28/structrcti.html">rcti</a> brect;
<a name="l02421"></a>02421     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *bg_ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02422"></a>02422 
<a name="l02423"></a>02423     glPushMatrix();
<a name="l02424"></a>02424 
<a name="l02425"></a>02425     <span class="comment">/* set temporary new size */</span>
<a name="l02426"></a>02426     bwinx = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l02427"></a>02427     bwiny = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l02428"></a>02428     brect = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>;
<a name="l02429"></a>02429     
<a name="l02430"></a>02430     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> = winx;
<a name="l02431"></a>02431     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> = winy;
<a name="l02432"></a>02432     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> = 0;
<a name="l02433"></a>02433     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> = 0;
<a name="l02434"></a>02434     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#aed85b3972f94e2946a2bfcb60e036986">xmax</a> = winx;
<a name="l02435"></a>02435     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a5e0cd2b56e95eba87777402106f57a9a">ymax</a> = winy;
<a name="l02436"></a>02436     
<a name="l02437"></a>02437     
<a name="l02438"></a>02438     <span class="comment">/* set flags */</span>
<a name="l02439"></a>02439     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.f |= <a class="code" href="../../d1/d8c/BKE__global_8h.html#a21b53c6c4fd77a9107e749bba55056d1">G_RENDER_OGL</a>;
<a name="l02440"></a>02440 
<a name="l02441"></a>02441     <span class="comment">/* free images which can have changed on frame-change</span>
<a name="l02442"></a>02442 <span class="comment">     * warning! can be slow so only free animated images - campbell */</span>
<a name="l02443"></a>02443     <a class="code" href="../../d3/df0/GPU__draw_8h.html#abfdde74f99c1df684bfca5f4ddcbf518">GPU_free_images_anim</a>();
<a name="l02444"></a>02444     
<a name="l02445"></a>02445     <span class="comment">/* shadow buffers, before we setup matrices */</span>
<a name="l02446"></a>02446     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d02/drawobject_8c.html#aca409cda616fd2a1eb6eb2dc5b124fac">draw_glsl_material</a>(scene, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, v3d, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a>))
<a name="l02447"></a>02447         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa1559ec45f96cc92b59be961c608d75c">gpu_update_lamps_shadows</a>(scene, v3d);
<a name="l02448"></a>02448 
<a name="l02449"></a>02449     <span class="comment">/* if scene has got active clip, use it for render backdrop */</span>
<a name="l02450"></a>02450     <span class="keywordflow">if</span> (draw_background &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a5ff6096f2dbaa433889794ded2733521">clip</a> &amp;&amp; rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a> &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>) {
<a name="l02451"></a>02451         <a class="code" href="../../d8/dac/structMovieClipUser.html">MovieClipUser</a> user = {0};
<a name="l02452"></a>02452 
<a name="l02453"></a>02453         <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a48e73a7c78eb9b4fe5072c5030ee0b5e">BKE_movieclip_user_set_frame</a>(&amp;user, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l02454"></a>02454         bg_ibuf = <a class="code" href="../../d9/dd4/BKE__movieclip_8h.html#a8f77cec36c003927660d27501ca7f610">BKE_movieclip_get_ibuf</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a5ff6096f2dbaa433889794ded2733521">clip</a>, &amp;user);
<a name="l02455"></a>02455     }
<a name="l02456"></a>02456 
<a name="l02457"></a>02457     <span class="keywordflow">if</span> (!bg_ibuf) {
<a name="l02458"></a>02458         <span class="comment">/* set background color, fallback on the view background color</span>
<a name="l02459"></a>02459 <span class="comment">         * (if active clip is set but frame is failed to load fallback to horizon color as background) */</span>
<a name="l02460"></a>02460         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>) {
<a name="l02461"></a>02461             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l02462"></a>02462                 <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ac0586614af7cf4cfa2c1718015b85383">linearrgb_to_srgb_v3_v3</a>(backcol, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a>);
<a name="l02463"></a>02463             <span class="keywordflow">else</span>
<a name="l02464"></a>02464                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(backcol, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a>);
<a name="l02465"></a>02465             glClearColor(backcol[0], backcol[1], backcol[2], 0.0);
<a name="l02466"></a>02466         }
<a name="l02467"></a>02467         <span class="keywordflow">else</span> {
<a name="l02468"></a>02468             <a class="code" href="../../de/d96/UI__resources_8h.html#a726a719a5a3b6b944d24fbcab8ed29c6">UI_ThemeClearColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>);
<a name="l02469"></a>02469         }
<a name="l02470"></a>02470     }
<a name="l02471"></a>02471 
<a name="l02472"></a>02472     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
<a name="l02473"></a>02473 
<a name="l02474"></a>02474     <span class="keywordflow">if</span> (bg_ibuf) {
<a name="l02475"></a>02475         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *pixels, *cp, *dst_cp;
<a name="l02476"></a>02476         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02477"></a>02477 
<a name="l02478"></a>02478         <span class="keywordflow">if</span> (bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; !bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>)
<a name="l02479"></a>02479             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a3af34b4b5c6b91ddf5b872fcb9e2d66c">IMB_rect_from_float</a>(bg_ibuf);
<a name="l02480"></a>02480 
<a name="l02481"></a>02481         dst_cp = pixels = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(4 * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) * bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, <span class="stringliteral">&quot;draw offscreen clip pixels&quot;</span>);
<a name="l02482"></a>02482         cp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l02483"></a>02483         for (i = 0; i &lt; bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; i++, cp += 4, dst_cp += 4) {
<a name="l02484"></a>02484             dst_cp[0] = cp[0];
<a name="l02485"></a>02485             dst_cp[1] = cp[1];
<a name="l02486"></a>02486             dst_cp[2] = cp[2];
<a name="l02487"></a>02487             dst_cp[3] = 255;
<a name="l02488"></a>02488         }
<a name="l02489"></a>02489 
<a name="l02490"></a>02490         glMatrixMode(GL_PROJECTION);
<a name="l02491"></a>02491         glPushMatrix();
<a name="l02492"></a>02492         glMatrixMode(GL_MODELVIEW);
<a name="l02493"></a>02493         glPushMatrix();
<a name="l02494"></a>02494         <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l02495"></a>02495 
<a name="l02496"></a>02496         glPixelZoom((<span class="keywordtype">float</span>)winx / bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (<span class="keywordtype">float</span>)winy / bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l02497"></a>02497         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#ac573d112048ba54a7ad1a14235a19601">glaDrawPixelsTex</a>(0, 0, bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, bg_ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, GL_UNSIGNED_BYTE, pixels);
<a name="l02498"></a>02498 
<a name="l02499"></a>02499         glPixelZoom(1.0, 1.0);
<a name="l02500"></a>02500 
<a name="l02501"></a>02501         glMatrixMode(GL_PROJECTION);
<a name="l02502"></a>02502         glPopMatrix();
<a name="l02503"></a>02503         glMatrixMode(GL_MODELVIEW);
<a name="l02504"></a>02504         glPopMatrix();
<a name="l02505"></a>02505 
<a name="l02506"></a>02506         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(bg_ibuf);
<a name="l02507"></a>02507         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pixels);
<a name="l02508"></a>02508     }
<a name="l02509"></a>02509 
<a name="l02510"></a>02510     <span class="comment">/* setup view matrices */</span>
<a name="l02511"></a>02511     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0ef33fe3c3fa42af53d87c44989c4693">view3d_main_area_setup_view</a>(scene, v3d, ar, viewmat, winmat);
<a name="l02512"></a>02512 
<a name="l02513"></a>02513     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02514"></a>02514         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a6927fbc12e58028d1aca101f2a1b1ab1">view3d_draw_clipping</a>(rv3d);
<a name="l02515"></a>02515 
<a name="l02516"></a>02516     <span class="comment">/* set zbuffer */</span>
<a name="l02517"></a>02517     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> &gt; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a112caf28bb615ee6c87ff744d1228182">OB_WIRE</a>) {
<a name="l02518"></a>02518         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02519"></a>02519         glEnable(GL_DEPTH_TEST);
<a name="l02520"></a>02520     }
<a name="l02521"></a>02521     <span class="keywordflow">else</span>
<a name="l02522"></a>02522         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02523"></a>02523 
<a name="l02524"></a>02524     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02525"></a>02525         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a403862b556efefe2375ce8cf99110fd5">ED_view3d_clipping_set</a>(rv3d);
<a name="l02526"></a>02526 
<a name="l02527"></a>02527     <span class="comment">/* draw set first */</span>
<a name="l02528"></a>02528     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>) {
<a name="l02529"></a>02529         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter;
<a name="l02530"></a>02530         <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>, sce_iter, base)) {
<a name="l02531"></a>02531             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02532"></a>02532                 <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.6f);
<a name="l02533"></a>02533                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, <a class="code" href="../../d4/df4/view3d__intern_8h.html#a865840f950d43c02ac67cce1663bd822">DRAW_CONSTCOLOR</a> | <a class="code" href="../../d4/df4/view3d__intern_8h.html#aabb48674b87768c6adcfb2873ef4c6b3">DRAW_SCENESET</a>);
<a name="l02534"></a>02534                 
<a name="l02535"></a>02535                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>)
<a name="l02536"></a>02536                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">draw_dupli_objects_color</a>(scene, ar, v3d, base, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>);
<a name="l02537"></a>02537             }
<a name="l02538"></a>02538         }
<a name="l02539"></a>02539     }
<a name="l02540"></a>02540     
<a name="l02541"></a>02541     <span class="comment">/* then draw not selected and the duplis, but skip editmode object */</span>
<a name="l02542"></a>02542     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l02543"></a>02543         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02544"></a>02544             <span class="comment">/* dupli drawing */</span>
<a name="l02545"></a>02545             <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>)
<a name="l02546"></a>02546                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#af13d35d2ec0e792ba7fe69d09edf0efa">draw_dupli_objects</a>(scene, ar, v3d, base);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548             <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, 0);
<a name="l02549"></a>02549         }
<a name="l02550"></a>02550     }
<a name="l02551"></a>02551 
<a name="l02552"></a>02552     <span class="comment">/* must be before xray draw which clears the depth buffer */</span>
<a name="l02553"></a>02553     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glDisable(GL_DEPTH_TEST);
<a name="l02554"></a>02554     <a class="code" href="../../dd/d3e/drawgpencil_8c.html#a89baec14d65520d28457c45cedcde6a1">draw_gpencil_view3d</a>(scene, v3d, ar, 1);
<a name="l02555"></a>02555     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glEnable(GL_DEPTH_TEST);
<a name="l02556"></a>02556 
<a name="l02557"></a>02557     <span class="comment">/* transp and X-ray afterdraw stuff */</span>
<a name="l02558"></a>02558     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a550f7bebb476cdc02c1977a27df544f1">view3d_draw_transp</a>(scene, ar, v3d);
<a name="l02559"></a>02559     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)       <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a66a9d3a01ae913dcf53f82294ac4212b">view3d_draw_xray</a>(scene, ar, v3d, 1);         <span class="comment">// clears zbuffer if it is used!</span>
<a name="l02560"></a>02560     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a209d1d806c4fa0f8a25c6ca0b3c812e0">view3d_draw_xraytransp</a>(scene, ar, v3d, 1);
<a name="l02561"></a>02561 
<a name="l02562"></a>02562     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02563"></a>02563         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa4cf5dc6374c7b1e81b8322fad984ece">ED_view3d_clipping_disable</a>();
<a name="l02564"></a>02564 
<a name="l02565"></a>02565     <span class="comment">/* cleanup */</span>
<a name="l02566"></a>02566     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) {
<a name="l02567"></a>02567         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02568"></a>02568         glDisable(GL_DEPTH_TEST);
<a name="l02569"></a>02569     }
<a name="l02570"></a>02570 
<a name="l02571"></a>02571     <span class="comment">/* draw grease-pencil stuff */</span>
<a name="l02572"></a>02572     <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l02573"></a>02573 
<a name="l02574"></a>02574     <span class="comment">/* draw grease-pencil stuff - needed to get paint-buffer shown too (since it&#39;s 2D) */</span>
<a name="l02575"></a>02575     <a class="code" href="../../dd/d3e/drawgpencil_8c.html#a89baec14d65520d28457c45cedcde6a1">draw_gpencil_view3d</a>(scene, v3d, ar, 0);
<a name="l02576"></a>02576 
<a name="l02577"></a>02577     <span class="comment">/* freeing the images again here could be done after the operator runs, leaving for now */</span>
<a name="l02578"></a>02578     <a class="code" href="../../d3/df0/GPU__draw_8h.html#abfdde74f99c1df684bfca5f4ddcbf518">GPU_free_images_anim</a>();
<a name="l02579"></a>02579 
<a name="l02580"></a>02580     <span class="comment">/* restore size */</span>
<a name="l02581"></a>02581     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a> = bwinx;
<a name="l02582"></a>02582     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> = bwiny;
<a name="l02583"></a>02583     ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a> = brect;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585     glPopMatrix();
<a name="l02586"></a>02586 
<a name="l02587"></a>02587     <span class="comment">// XXX, without this the sequencer flickers with opengl draw enabled, need to find out why - campbell</span>
<a name="l02588"></a>02588     glColor4ub(255, 255, 255, 255);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.f &amp;= ~<a class="code" href="../../d1/d8c/BKE__global_8h.html#a21b53c6c4fd77a9107e749bba55056d1">G_RENDER_OGL</a>;
<a name="l02591"></a>02591 }
<a name="l02592"></a>02592 
<a name="l02593"></a>02593 <span class="comment">/* utility func for ED_view3d_draw_offscreen */</span>
<a name="l02594"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#afac550d0e9a9e7484309b7850e95d027">02594</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/d6a/ED__view3d_8h.html#a17f8f66dd5b0b3a2462093be68a2e954">ED_view3d_draw_offscreen_imbuf</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar,
<a name="l02595"></a>02595                                       <span class="keywordtype">int</span> sizex, <span class="keywordtype">int</span> sizey, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flag, <span class="keywordtype">int</span> <a class="code" href="../../d6/db3/file__draw_8c.html#ac8f40d7d46805f84008e39a0e29040e6">draw_background</a>, <span class="keywordtype">char</span> err_out[256])
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>;
<a name="l02598"></a>02598     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l02599"></a>02599     <a class="code" href="../../d0/d4e/structGPUOffScreen.html">GPUOffScreen</a> *ofs;
<a name="l02600"></a>02600     
<a name="l02601"></a>02601     <span class="comment">/* state changes make normal drawing go weird otherwise */</span>
<a name="l02602"></a>02602     glPushAttrib(GL_LIGHTING_BIT);
<a name="l02603"></a>02603 
<a name="l02604"></a>02604     <span class="comment">/* bind */</span>
<a name="l02605"></a>02605     ofs = <a class="code" href="../../da/deb/GPU__extensions_8h.html#ad65ddee19cc4570e1a645bf6b8467c43">GPU_offscreen_create</a>(sizex, sizey, err_out);
<a name="l02606"></a>02606     <span class="keywordflow">if</span> (ofs == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02607"></a>02607         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02608"></a>02608 
<a name="l02609"></a>02609     <a class="code" href="../../da/deb/GPU__extensions_8h.html#ac8e011dc3d41559656f0475f84337c2a">GPU_offscreen_bind</a>(ofs);
<a name="l02610"></a>02610 
<a name="l02611"></a>02611     <span class="comment">/* render 3d view */</span>
<a name="l02612"></a>02612     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a> &amp;&amp; v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>) {
<a name="l02613"></a>02613         <a class="code" href="../../d4/daf/structCameraParams.html">CameraParams</a> params;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615         <a class="code" href="../../d2/dff/BKE__camera_8h.html#a114faeb2a77048e814e5a120d29026b3">camera_params_init</a>(&amp;params);
<a name="l02616"></a>02616         <a class="code" href="../../d2/dff/BKE__camera_8h.html#ac561da82b9e128bc2020a2d4e4d2ddd8">camera_params_from_object</a>(&amp;params, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>);
<a name="l02617"></a>02617         <a class="code" href="../../d2/dff/BKE__camera_8h.html#af290ff2b9dc901aae0f54d62f44c0e1a">camera_params_compute_viewplane</a>(&amp;params, sizex, sizey, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>);
<a name="l02618"></a>02618         <a class="code" href="../../d2/dff/BKE__camera_8h.html#a892ebdf01c9cd451ee7244f472dcaba3">camera_params_compute_matrix</a>(&amp;params);
<a name="l02619"></a>02619 
<a name="l02620"></a>02620         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad53d0aa8d7153cb4a42d2949cd2e03fb">ED_view3d_draw_offscreen</a>(scene, v3d, ar, sizex, sizey, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, params.<a class="code" href="../../d4/daf/structCameraParams.html#a231ce565968a26a1ec032de9d5940a89">winmat</a>, draw_background);
<a name="l02621"></a>02621     }
<a name="l02622"></a>02622     <span class="keywordflow">else</span> {
<a name="l02623"></a>02623         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad53d0aa8d7153cb4a42d2949cd2e03fb">ED_view3d_draw_offscreen</a>(scene, v3d, ar, sizex, sizey, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, draw_background);
<a name="l02624"></a>02624     }
<a name="l02625"></a>02625 
<a name="l02626"></a>02626     <span class="comment">/* read in pixels &amp; stamp */</span>
<a name="l02627"></a>02627     ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(sizex, sizey, 32, flag);
<a name="l02628"></a>02628 
<a name="l02629"></a>02629     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)
<a name="l02630"></a>02630         <a class="code" href="../../da/deb/GPU__extensions_8h.html#a70b0d437029c608fb1902a3e7cbba7a2">GPU_offscreen_read_pixels</a>(ofs, GL_FLOAT, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>);
<a name="l02631"></a>02631     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>)
<a name="l02632"></a>02632         <a class="code" href="../../da/deb/GPU__extensions_8h.html#a70b0d437029c608fb1902a3e7cbba7a2">GPU_offscreen_read_pixels</a>(ofs, GL_UNSIGNED_BYTE, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>);
<a name="l02633"></a>02633     
<a name="l02634"></a>02634     <span class="comment">//if ((scene-&gt;r.stamp &amp; R_STAMP_ALL) &amp;&amp; (scene-&gt;r.stamp &amp; R_STAMP_DRAW))</span>
<a name="l02635"></a>02635     <span class="comment">//  BKE_stamp_buf(scene, NULL, rr-&gt;rectf, rr-&gt;rectx, rr-&gt;recty, 4);</span>
<a name="l02636"></a>02636 
<a name="l02637"></a>02637     <span class="comment">/* unbind */</span>
<a name="l02638"></a>02638     <a class="code" href="../../da/deb/GPU__extensions_8h.html#a3785c640c7153b8e878e627e0e2734ee">GPU_offscreen_unbind</a>(ofs);
<a name="l02639"></a>02639     <a class="code" href="../../da/deb/GPU__extensions_8h.html#a4755e5521ad93638f24b62582f9e89de">GPU_offscreen_free</a>(ofs);
<a name="l02640"></a>02640 
<a name="l02641"></a>02641     glPopAttrib();
<a name="l02642"></a>02642     
<a name="l02643"></a>02643     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>)
<a name="l02644"></a>02644         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a3af34b4b5c6b91ddf5b872fcb9e2d66c">IMB_rect_from_float</a>(ibuf);
<a name="l02645"></a>02645     
<a name="l02646"></a>02646     <span class="keywordflow">return</span> ibuf;
<a name="l02647"></a>02647 }
<a name="l02648"></a>02648 
<a name="l02649"></a>02649 <span class="comment">/* creates own 3d views, used by the sequencer */</span>
<a name="l02650"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa83a0229a2b5ea4203887277ff661380">02650</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d8/d6a/ED__view3d_8h.html#afee08c80472fa2b49f4430e82a90533f">ED_view3d_draw_offscreen_imbuf_simple</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *camera, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height,
<a name="l02651"></a>02651                                              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flag, <span class="keywordtype">int</span> drawtype, <span class="keywordtype">int</span> <a class="code" href="../../d6/db3/file__draw_8c.html#ac8f40d7d46805f84008e39a0e29040e6">draw_background</a>, <span class="keywordtype">char</span> err_out[256])
<a name="l02652"></a>02652 {
<a name="l02653"></a>02653     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> v3d = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02654"></a>02654     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> ar = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l02655"></a>02655     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> rv3d = {{{0}}};
<a name="l02656"></a>02656 
<a name="l02657"></a>02657     <span class="comment">/* connect data */</span>
<a name="l02658"></a>02658     v3d.<a class="code" href="../../d6/deb/structView3D.html#ac9200c617c4513e638686629876c28ca">regionbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = v3d.<a class="code" href="../../d6/deb/structView3D.html#ac9200c617c4513e638686629876c28ca">regionbase</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = &amp;ar;
<a name="l02659"></a>02659     ar.<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a> = &amp;rv3d;
<a name="l02660"></a>02660     ar.<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> = <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>;
<a name="l02661"></a>02661 
<a name="l02662"></a>02662     v3d.<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a> = camera;
<a name="l02663"></a>02663     v3d.<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a506dd867fc58506c37c1e56f6b134056">lay</a>;
<a name="l02664"></a>02664     v3d.<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> = drawtype;
<a name="l02665"></a>02665     v3d.<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> = <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>;
<a name="l02666"></a>02666 
<a name="l02667"></a>02667     rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> = <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>;
<a name="l02668"></a>02668 
<a name="l02669"></a>02669     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>, v3d.<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02670"></a>02670     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>);
<a name="l02671"></a>02671     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>);
<a name="l02672"></a>02672 
<a name="l02673"></a>02673     {
<a name="l02674"></a>02674         <a class="code" href="../../d4/daf/structCameraParams.html">CameraParams</a> params;
<a name="l02675"></a>02675 
<a name="l02676"></a>02676         <a class="code" href="../../d2/dff/BKE__camera_8h.html#a114faeb2a77048e814e5a120d29026b3">camera_params_init</a>(&amp;params);
<a name="l02677"></a>02677         <a class="code" href="../../d2/dff/BKE__camera_8h.html#ac561da82b9e128bc2020a2d4e4d2ddd8">camera_params_from_object</a>(&amp;params, v3d.<a class="code" href="../../d6/deb/structView3D.html#a4eb998ff28617b65a2e6c431f319ac9a">camera</a>);
<a name="l02678"></a>02678         <a class="code" href="../../d2/dff/BKE__camera_8h.html#af290ff2b9dc901aae0f54d62f44c0e1a">camera_params_compute_viewplane</a>(&amp;params, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>);
<a name="l02679"></a>02679         <a class="code" href="../../d2/dff/BKE__camera_8h.html#a892ebdf01c9cd451ee7244f472dcaba3">camera_params_compute_matrix</a>(&amp;params);
<a name="l02680"></a>02680 
<a name="l02681"></a>02681         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, params.<a class="code" href="../../d4/daf/structCameraParams.html#a231ce565968a26a1ec032de9d5940a89">winmat</a>);
<a name="l02682"></a>02682         v3d.<a class="code" href="../../d6/deb/structView3D.html#aba3819f92b7807dcb98e1bc8605be7cb">near</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#a6fdd84ec4312347929d3b560fd1f603e">clipsta</a>;
<a name="l02683"></a>02683         v3d.<a class="code" href="../../d6/deb/structView3D.html#af51cbdca30d806138c2b3a734b4df2b5">far</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#addd6d77879aab2484838c2c66861422e">clipend</a>;
<a name="l02684"></a>02684         v3d.<a class="code" href="../../d6/deb/structView3D.html#a11bb79c913de7b38d21b9a3bece7c767">lens</a> = params.<a class="code" href="../../d4/daf/structCameraParams.html#a9e47f7eafc02d81f208f55b92275ee66">lens</a>;
<a name="l02685"></a>02685     }
<a name="l02686"></a>02686 
<a name="l02687"></a>02687     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02688"></a>02688     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#ac8b049c589a4159afee5f4d0114dbed7">persinv</a>, rv3d.<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>);
<a name="l02689"></a>02689 
<a name="l02690"></a>02690     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a17f8f66dd5b0b3a2462093be68a2e954">ED_view3d_draw_offscreen_imbuf</a>(scene, &amp;v3d, &amp;ar, width, height, flag, draw_background, err_out);
<a name="l02691"></a>02691 
<a name="l02692"></a>02692     <span class="comment">// seq_view3d_cb(scene, cfra, render_size, seqrectx, seqrecty);</span>
<a name="l02693"></a>02693 }
<a name="l02694"></a>02694 
<a name="l02695"></a>02695 
<a name="l02696"></a>02696 <span class="comment">/* NOTE: the info that this uses is updated in ED_refresh_viewport_fps(), </span>
<a name="l02697"></a>02697 <span class="comment"> * which currently gets called during SCREEN_OT_animation_step.</span>
<a name="l02698"></a>02698 <span class="comment"> */</span>
<a name="l02699"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a2bd3ca5b8e53baa0ed00ae546d6b0d3f">02699</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a2bd3ca5b8e53baa0ed00ae546d6b0d3f">draw_viewport_fps</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar)
<a name="l02700"></a>02700 {
<a name="l02701"></a>02701     <a class="code" href="../../da/dda/structScreenFrameRateInfo.html">ScreenFrameRateInfo</a> *fpsi = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a63fc7eaaf0da3042f687458e69d45de1">fps_info</a>;
<a name="l02702"></a>02702     <span class="keywordtype">float</span> fps;
<a name="l02703"></a>02703     <span class="keywordtype">char</span> printable[16];
<a name="l02704"></a>02704     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, tot;
<a name="l02705"></a>02705     
<a name="l02706"></a>02706     <span class="keywordflow">if</span> (!fpsi || !fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a12031a2e035a497a80e5b8a96a65cc02">lredrawtime</a> || !fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a111f06489ef9e85a6244f63eb261205a">redrawtime</a>)
<a name="l02707"></a>02707         <span class="keywordflow">return</span>;
<a name="l02708"></a>02708     
<a name="l02709"></a>02709     printable[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l02710"></a>02710     
<a name="l02711"></a>02711 <span class="preprocessor">#if 0</span>
<a name="l02712"></a>02712 <span class="preprocessor"></span>    <span class="comment">/* this is too simple, better do an average */</span>
<a name="l02713"></a>02713     fps = (float)(1.0 / (fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a12031a2e035a497a80e5b8a96a65cc02">lredrawtime</a> - fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a111f06489ef9e85a6244f63eb261205a">redrawtime</a>))
<a name="l02714"></a>02714 #<span class="keywordflow">else</span>
<a name="l02715"></a>02715     fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a72cd1305e7f0c3f1456ead29ca4ec818">redrawtimes_fps</a>[fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a62b4de4353ced35b3d6405c59511aef1">redrawtime_index</a>] = (<span class="keywordtype">float</span>)(1.0 / (fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a12031a2e035a497a80e5b8a96a65cc02">lredrawtime</a> - fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a111f06489ef9e85a6244f63eb261205a">redrawtime</a>));
<a name="l02716"></a>02716     
<a name="l02717"></a>02717     <span class="keywordflow">for</span> (i = 0, tot = 0, fps = 0.0f; i &lt; <a class="code" href="../../d1/d85/ED__screen__types_8h.html#aebf6db3065e6a7c2abe525c21b09145e">REDRAW_FRAME_AVERAGE</a>; i++) {
<a name="l02718"></a>02718         <span class="keywordflow">if</span> (fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a72cd1305e7f0c3f1456ead29ca4ec818">redrawtimes_fps</a>[i]) {
<a name="l02719"></a>02719             fps += fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a72cd1305e7f0c3f1456ead29ca4ec818">redrawtimes_fps</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02720"></a>02720             tot++;
<a name="l02721"></a>02721         }
<a name="l02722"></a>02722     }
<a name="l02723"></a>02723     <span class="keywordflow">if</span> (tot) {
<a name="l02724"></a>02724         fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a62b4de4353ced35b3d6405c59511aef1">redrawtime_index</a> = (fpsi-&gt;<a class="code" href="../../da/dda/structScreenFrameRateInfo.html#a62b4de4353ced35b3d6405c59511aef1">redrawtime_index</a> + 1) % REDRAW_FRAME_AVERAGE;
<a name="l02725"></a>02725         
<a name="l02726"></a>02726         <span class="comment">//fpsi-&gt;redrawtime_index++;</span>
<a name="l02727"></a>02727         <span class="comment">//if (fpsi-&gt;redrawtime &gt;= REDRAW_FRAME_AVERAGE)</span>
<a name="l02728"></a>02728         <span class="comment">//  fpsi-&gt;redrawtime = 0;</span>
<a name="l02729"></a>02729         
<a name="l02730"></a>02730         fps = fps / tot;
<a name="l02731"></a>02731     }
<a name="l02732"></a>02732 <span class="preprocessor">#endif</span>
<a name="l02733"></a>02733 <span class="preprocessor"></span>
<a name="l02734"></a>02734           <span class="comment">/* is this more then half a frame behind? */</span>
<a name="l02735"></a>02735           <span class="keywordflow">if</span> (fps + 0.5f &lt; (<span class="keywordtype">float</span>)(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac92ca5ab87034a348decad7ee8d4bd1b">FPS</a>)) {
<a name="l02736"></a>02736         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a65e3169909737674a0536441605a5754">TH_REDALERT</a>);
<a name="l02737"></a>02737         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(printable, <span class="keyword">sizeof</span>(printable), <span class="stringliteral">&quot;fps: %.2f&quot;</span>, fps);
<a name="l02738"></a>02738     } 
<a name="l02739"></a>02739     <span class="keywordflow">else</span> {
<a name="l02740"></a>02740         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l02741"></a>02741         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(printable, <span class="keyword">sizeof</span>(printable), <span class="stringliteral">&quot;fps: %i&quot;</span>, (<span class="keywordtype">int</span>)(fps + 0.5f));
<a name="l02742"></a>02742     }
<a name="l02743"></a>02743     
<a name="l02744"></a>02744     <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(22,  ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> - 17, 0.0f, printable, <span class="keyword">sizeof</span>(printable));
<a name="l02745"></a>02745 }
<a name="l02746"></a>02746 
<a name="l02747"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a052c10d72b13256b5f2ff968000b0c5c">02747</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a052c10d72b13256b5f2ff968000b0c5c">view3d_main_area_draw_engine</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar)
<a name="l02748"></a>02748 {
<a name="l02749"></a>02749     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02750"></a>02750     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02751"></a>02751     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l02752"></a>02752     <a class="code" href="../../d3/dd4/structRenderEngineType.html">RenderEngineType</a> *type;
<a name="l02753"></a>02753 
<a name="l02754"></a>02754     <span class="comment">/* create render engine */</span>
<a name="l02755"></a>02755     <span class="keywordflow">if</span> (!rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>) {
<a name="l02756"></a>02756         type = <a class="code" href="../../db/da9/RE__engine_8h.html#a089bd866025f458b251f1f643d13d065">RE_engines_find</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4d4d1d058ba7c96ba3510f5101165b7f">engine</a>);
<a name="l02757"></a>02757 
<a name="l02758"></a>02758         <span class="keywordflow">if</span> (!(type-&gt;<a class="code" href="../../d3/dd4/structRenderEngineType.html#a8368f7fd2c6f61b8ab51d72c413a4acc">view_update</a> &amp;&amp; type-&gt;<a class="code" href="../../d3/dd4/structRenderEngineType.html#a72aff3e3f66543bd5ba117abaab870f9">view_draw</a>))
<a name="l02759"></a>02759             <span class="keywordflow">return</span> 0;
<a name="l02760"></a>02760 
<a name="l02761"></a>02761         rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a> = <a class="code" href="../../db/da9/RE__engine_8h.html#a07ff487b08ae939362e205a0694ca43d">RE_engine_create</a>(type);
<a name="l02762"></a>02762         type-&gt;<a class="code" href="../../d3/dd4/structRenderEngineType.html#a8368f7fd2c6f61b8ab51d72c413a4acc">view_update</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>, C);
<a name="l02763"></a>02763     }
<a name="l02764"></a>02764 
<a name="l02765"></a>02765     <span class="comment">/* setup view matrices */</span>
<a name="l02766"></a>02766     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0ef33fe3c3fa42af53d87c44989c4693">view3d_main_area_setup_view</a>(scene, v3d, ar, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02767"></a>02767 
<a name="l02768"></a>02768     <span class="comment">/* background draw */</span>
<a name="l02769"></a>02769     glClearColor(0.0f, 0.0f, 0.0f, 0.0f);
<a name="l02770"></a>02770     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
<a name="l02771"></a>02771 
<a name="l02772"></a>02772     <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l02773"></a>02773 
<a name="l02774"></a>02774     <span class="comment">/* render result draw */</span>
<a name="l02775"></a>02775     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ae499c49f7386e6b6491b237dd2f6dc1d">V3D_DISPBGPICS</a>)
<a name="l02776"></a>02776         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">draw_bgpic</a>(scene, ar, v3d, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02777"></a>02777     <span class="keywordflow">else</span>
<a name="l02778"></a>02778         <a class="code" href="../../d9/d71/BIF__glutil_8h.html#abb1d29a680f38aab6a24d35cd1fd9e89">fdrawcheckerboard</a>(0, 0, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>, ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>);
<a name="l02779"></a>02779 
<a name="l02780"></a>02780     type = rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>-&gt;<a class="code" href="../../d1/d10/structRenderEngine.html#a1c64523867cd63df7acc20c674779545">type</a>;
<a name="l02781"></a>02781     type-&gt;<a class="code" href="../../d3/dd4/structRenderEngineType.html#a72aff3e3f66543bd5ba117abaab870f9">view_draw</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>, C);
<a name="l02782"></a>02782 
<a name="l02783"></a>02783     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ae499c49f7386e6b6491b237dd2f6dc1d">V3D_DISPBGPICS</a>)
<a name="l02784"></a>02784         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#ad5742a4b3b83aa3b1715c701f810b594">draw_bgpic</a>(scene, ar, v3d, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02785"></a>02785 
<a name="l02786"></a>02786     <span class="keywordflow">return</span> 1;
<a name="l02787"></a>02787 }
<a name="l02788"></a>02788 
<a name="l02789"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a100e9434c4fd3f6c44901411103fa441">02789</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a100e9434c4fd3f6c44901411103fa441">view3d_main_area_draw_engine_info</a>(<a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar)
<a name="l02790"></a>02790 {
<a name="l02791"></a>02791     <span class="keywordflow">if</span> (!rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a> || !rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>-&gt;<a class="code" href="../../d1/d10/structRenderEngine.html#a23210a399a18a7cabb81af40c447f600">text</a>)
<a name="l02792"></a>02792         <span class="keywordflow">return</span>;
<a name="l02793"></a>02793 
<a name="l02794"></a>02794     <a class="code" href="../../d1/d12/ED__screen_8h.html#af13129f0751550ca4cedc989379d2af7">ED_region_info_draw</a>(ar, rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>-&gt;<a class="code" href="../../d1/d10/structRenderEngine.html#a23210a399a18a7cabb81af40c447f600">text</a>, 1, 0.25);
<a name="l02795"></a>02795 }
<a name="l02796"></a>02796 
<a name="l02797"></a>02797 <span class="comment">/* warning: this function has duplicate drawing in ED_view3d_draw_offscreen() */</span>
<a name="l02798"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a064a755fcf5476d4ab03e19ad2b3a878">02798</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a064a755fcf5476d4ab03e19ad2b3a878">view3d_main_area_draw_objects</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keyword">const</span> <span class="keywordtype">char</span> **grid_unit)
<a name="l02799"></a>02799 {
<a name="l02800"></a>02800     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02801"></a>02801     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02802"></a>02802     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l02803"></a>02803     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l02804"></a>02804     <span class="keywordtype">float</span> backcol[3];
<a name="l02805"></a>02805     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lay_used;
<a name="l02806"></a>02806 
<a name="l02807"></a>02807     <span class="comment">/* shadow buffers, before we setup matrices */</span>
<a name="l02808"></a>02808     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d02/drawobject_8c.html#aca409cda616fd2a1eb6eb2dc5b124fac">draw_glsl_material</a>(scene, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, v3d, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a>))
<a name="l02809"></a>02809         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa1559ec45f96cc92b59be961c608d75c">gpu_update_lamps_shadows</a>(scene, v3d);
<a name="l02810"></a>02810     
<a name="l02811"></a>02811     <span class="comment">/* reset default OpenGL lights if needed (i.e. after preferences have been altered) */</span>
<a name="l02812"></a>02812     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a06f5743b14c7028d2dc2786d27106ca9">RV3D_GPULIGHT_UPDATE</a>) {
<a name="l02813"></a>02813         rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp;= ~<a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a06f5743b14c7028d2dc2786d27106ca9">RV3D_GPULIGHT_UPDATE</a>;
<a name="l02814"></a>02814         <a class="code" href="../../d3/df0/GPU__draw_8h.html#a11ec1773775fbc6588b9c18e1a649190">GPU_default_lights</a>();
<a name="l02815"></a>02815     }
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     <span class="comment">/* clear background */</span>
<a name="l02818"></a>02818     <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>) {
<a name="l02819"></a>02819         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l02820"></a>02820             <a class="code" href="../../d8/de1/BLI__math__color_8h.html#ac0586614af7cf4cfa2c1718015b85383">linearrgb_to_srgb_v3_v3</a>(backcol, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a>);
<a name="l02821"></a>02821         <span class="keywordflow">else</span>
<a name="l02822"></a>02822             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(backcol, &amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#af555a01e6a98f5768255cd8be50d0a6a">horr</a>);
<a name="l02823"></a>02823         glClearColor(backcol[0], backcol[1], backcol[2], 0.0);
<a name="l02824"></a>02824     }
<a name="l02825"></a>02825     <span class="keywordflow">else</span>
<a name="l02826"></a>02826         <a class="code" href="../../de/d96/UI__resources_8h.html#a726a719a5a3b6b944d24fbcab8ed29c6">UI_ThemeClearColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>);
<a name="l02827"></a>02827 
<a name="l02828"></a>02828     glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
<a name="l02829"></a>02829     
<a name="l02830"></a>02830     <span class="comment">/* setup view matrices */</span>
<a name="l02831"></a>02831     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0ef33fe3c3fa42af53d87c44989c4693">view3d_main_area_setup_view</a>(scene, v3d, ar, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02832"></a>02832 
<a name="l02833"></a>02833     <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a41326a4e6f68c93133ddffa468c2705b">ED_region_draw_cb_draw</a>(C, ar, <a class="code" href="../../d0/d5f/ED__space__api_8h.html#afbab0cee361ee5097843d87297280597">REGION_DRAW_PRE_VIEW</a>);
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02836"></a>02836         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a6927fbc12e58028d1aca101f2a1b1ab1">view3d_draw_clipping</a>(rv3d);
<a name="l02837"></a>02837     
<a name="l02838"></a>02838     <span class="comment">/* set zbuffer after we draw clipping region */</span>
<a name="l02839"></a>02839     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> &gt; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a112caf28bb615ee6c87ff744d1228182">OB_WIRE</a>) {
<a name="l02840"></a>02840         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02841"></a>02841         glEnable(GL_DEPTH_TEST);
<a name="l02842"></a>02842     }
<a name="l02843"></a>02843     <span class="keywordflow">else</span>
<a name="l02844"></a>02844         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02845"></a>02845 
<a name="l02846"></a>02846     <span class="comment">/* enables anti-aliasing for 3D view drawing */</span>
<a name="l02847"></a>02847 <span class="preprocessor">#if 0</span>
<a name="l02848"></a>02848 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.gameflags &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#afde0938d7aef90b66196aff4a3645aae">USER_DISABLE_AA</a>))
<a name="l02849"></a>02849         glEnable(GL_MULTISAMPLE_ARB);
<a name="l02850"></a>02850 <span class="preprocessor">#endif</span>
<a name="l02851"></a>02851 <span class="preprocessor"></span>
<a name="l02852"></a>02852     <span class="comment">// needs to be done always, gridview is adjusted in drawgrid() now</span>
<a name="l02853"></a>02853     rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a977e0f2bd3b4f04e9f46534104461bf9">gridview</a> = v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a>;
<a name="l02854"></a>02854 
<a name="l02855"></a>02855     <span class="keywordflow">if</span> ((rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ae1cde58bc1011bac27095a74be8a32a9">view</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#ae271a0ebf5f72fba42b4703e1084a351">RV3D_VIEW_USER</a>) || (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> != <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#af086af25ae5c28a12be8eb6f7687c6dd">RV3D_ORTHO</a>)) {
<a name="l02856"></a>02856         <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) == 0) {
<a name="l02857"></a>02857             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#afae188aa33a39b0e9126e5d641a2774c">drawfloor</a>(scene, v3d, grid_unit);
<a name="l02858"></a>02858         }
<a name="l02859"></a>02859         <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>) {
<a name="l02860"></a>02860             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>) {
<a name="l02861"></a>02861                 <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aefac18ed3d1ded63b012f79a3ca8ddb2">world</a>-&gt;<a class="code" href="../../d7/d3f/structWorld.html#a97cd565855bf995024151e5a6ad307dc">mode</a> &amp; <a class="code" href="../../d7/d3b/DNA__world__types_8h.html#a79f2ef6e8ebb56410e467840c5527254">WO_STARS</a>) {
<a name="l02862"></a>02862                     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ac4d3d24f538e74cab2213a294bdac8a1">RE_make_stars</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, scene, <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a129ee04bac1fe07f40f01a315e43faee">star_stuff_init_func</a>, <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a0e901c3928a64a844f946ac6d8395dd9">star_stuff_vertex_func</a>,
<a name="l02863"></a>02863                                   <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a568fd5e7a5017382aa951803f55593ea">star_stuff_term_func</a>);
<a name="l02864"></a>02864                 }
<a name="l02865"></a>02865             }
<a name="l02866"></a>02866         }
<a name="l02867"></a>02867     }
<a name="l02868"></a>02868     <span class="keywordflow">else</span> {
<a name="l02869"></a>02869         <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) == 0) {
<a name="l02870"></a>02870             <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l02871"></a>02871             <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a668c054ea0fa239d9f5b11ccb2a36eb9">drawgrid</a>(&amp;scene-&gt;<a class="code" href="../../d9/d27/structScene.html#abe370ff027b47b00fb8a81620639eff4">unit</a>, ar, v3d, grid_unit);
<a name="l02872"></a>02872             <span class="comment">/* XXX make function? replaces persp(1) */</span>
<a name="l02873"></a>02873             glMatrixMode(GL_PROJECTION);
<a name="l02874"></a>02874             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#af0a3443cecc10c7a942137d9d234af6f">winmat</a>);
<a name="l02875"></a>02875             glMatrixMode(GL_MODELVIEW);
<a name="l02876"></a>02876             <a class="code" href="../../dd/d44/BIF__gl_8h.html#a968938b254020ac622d83a3ab1226f4a">glLoadMatrixf</a>(rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>);
<a name="l02877"></a>02877         }
<a name="l02878"></a>02878     }
<a name="l02879"></a>02879 
<a name="l02880"></a>02880     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a18fcdbc95fe2646515262fb2d2bd401e">draw_bgpics</a>(scene, ar, v3d, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l02881"></a>02881 
<a name="l02882"></a>02882     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02883"></a>02883         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a403862b556efefe2375ce8cf99110fd5">ED_view3d_clipping_set</a>(rv3d);
<a name="l02884"></a>02884 
<a name="l02885"></a>02885     <span class="comment">/* draw set first */</span>
<a name="l02886"></a>02886     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>) {
<a name="l02887"></a>02887         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter;
<a name="l02888"></a>02888         <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#af89a023123108ed72002144681d7621b">set</a>, sce_iter, base)) {
<a name="l02889"></a>02889             
<a name="l02890"></a>02890             <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02891"></a>02891                 
<a name="l02892"></a>02892                 <a class="code" href="../../de/d96/UI__resources_8h.html#ad4ede272051fd08d70f30570ad85a852">UI_ThemeColorBlend</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a2f524dc89597307994ab7d91402f79cf">TH_BACK</a>, 0.6f);
<a name="l02893"></a>02893                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, <a class="code" href="../../d4/df4/view3d__intern_8h.html#a865840f950d43c02ac67cce1663bd822">DRAW_CONSTCOLOR</a> | <a class="code" href="../../d4/df4/view3d__intern_8h.html#aabb48674b87768c6adcfb2873ef4c6b3">DRAW_SCENESET</a>);
<a name="l02894"></a>02894                 
<a name="l02895"></a>02895                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l02896"></a>02896                     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aefa77e9dda16749d50df893910b1c461">draw_dupli_objects_color</a>(scene, ar, v3d, base, <a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a35a1ce14aa2c5a004ba0af0ce628b3dd">TH_WIRE</a>);
<a name="l02897"></a>02897                 }
<a name="l02898"></a>02898             }
<a name="l02899"></a>02899         }
<a name="l02900"></a>02900         
<a name="l02901"></a>02901         <span class="comment">/* Transp and X-ray afterdraw stuff for sets is done later */</span>
<a name="l02902"></a>02902     }
<a name="l02903"></a>02903 
<a name="l02904"></a>02904     lay_used = 0;
<a name="l02905"></a>02905 
<a name="l02906"></a>02906     <span class="comment">/* then draw not selected and the duplis, but skip editmode object */</span>
<a name="l02907"></a>02907     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l02908"></a>02908         lay_used |= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a> &amp; ((1 &lt;&lt; 20) - 1);
<a name="l02909"></a>02909 
<a name="l02910"></a>02910         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02911"></a>02911             
<a name="l02912"></a>02912             <span class="comment">/* dupli drawing */</span>
<a name="l02913"></a>02913             <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>) {
<a name="l02914"></a>02914                 <a class="code" href="../../d8/d7f/view3d__draw_8c.html#af13d35d2ec0e792ba7fe69d09edf0efa">draw_dupli_objects</a>(scene, ar, v3d, base);
<a name="l02915"></a>02915             }
<a name="l02916"></a>02916             <span class="keywordflow">if</span> ((base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) == 0) {
<a name="l02917"></a>02917                 <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> != scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>)
<a name="l02918"></a>02918                     <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, 0);
<a name="l02919"></a>02919             }
<a name="l02920"></a>02920         }
<a name="l02921"></a>02921     }
<a name="l02922"></a>02922 
<a name="l02923"></a>02923     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ade0b8e83e6981b379cba6c6266cfbaa3">lay_used</a> != lay_used) { <span class="comment">/* happens when loading old files or loading with UI load */</span>
<a name="l02924"></a>02924         <span class="comment">/* find header and force tag redraw */</span>
<a name="l02925"></a>02925         <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa = <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l02926"></a>02926         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar_header = <a class="code" href="../../d7/da3/BKE__screen_8h.html#a5094bc7dbca089e838bcd5fc9bcb52a7">BKE_area_find_region_type</a>(sa, <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2ab7e0b51ce129a8b256dc705a06c4c4e8">RGN_TYPE_HEADER</a>);
<a name="l02927"></a>02927         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(ar_header); <span class="comment">/* can be NULL */</span>
<a name="l02928"></a>02928         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#ade0b8e83e6981b379cba6c6266cfbaa3">lay_used</a> = lay_used;
<a name="l02929"></a>02929     }
<a name="l02930"></a>02930 
<a name="l02931"></a>02931     <span class="comment">/* draw selected and editmode */</span>
<a name="l02932"></a>02932     <span class="keywordflow">for</span> (base = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; base; base = base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>) {
<a name="l02933"></a>02933         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a45ac0a23240ec719b0952d62190e9130">lay</a> &amp; base-&gt;<a class="code" href="../../d3/da9/structBase.html#a8c3a6cb18ff56393b617978c497c54aa">lay</a>) {
<a name="l02934"></a>02934             <span class="keywordflow">if</span> (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a> == scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a> || (base-&gt;<a class="code" href="../../d3/da9/structBase.html#a0e10616272837fff209501e1cd7fb26b">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>) )
<a name="l02935"></a>02935                 <a class="code" href="../../d3/d02/drawobject_8c.html#a7b8c6cefd30eb439ad84f5ff8db81b85">draw_object</a>(scene, ar, v3d, base, 0);
<a name="l02936"></a>02936         }
<a name="l02937"></a>02937     }
<a name="l02938"></a>02938 
<a name="l02939"></a>02939     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a18fcdbc95fe2646515262fb2d2bd401e">draw_bgpics</a>(scene, ar, v3d, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02940"></a>02940 
<a name="l02941"></a>02941 <span class="comment">//  REEB_draw();</span>
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) == 0) {
<a name="l02944"></a>02944         <span class="comment">/* must be before xray draw which clears the depth buffer */</span>
<a name="l02945"></a>02945         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glDisable(GL_DEPTH_TEST);
<a name="l02946"></a>02946         <a class="code" href="../../dd/d3e/drawgpencil_8c.html#a89baec14d65520d28457c45cedcde6a1">draw_gpencil_view3d</a>(scene, v3d, ar, 1);
<a name="l02947"></a>02947         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glEnable(GL_DEPTH_TEST);
<a name="l02948"></a>02948     }
<a name="l02949"></a>02949 
<a name="l02950"></a>02950     <span class="comment">/* Transp and X-ray afterdraw stuff */</span>
<a name="l02951"></a>02951     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aa50bdf2e33288df03e6ee33f75806c4f">afterdraw_transp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a550f7bebb476cdc02c1977a27df544f1">view3d_draw_transp</a>(scene, ar, v3d);
<a name="l02952"></a>02952     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a5ebc452868e0552460b5e249d101d464">afterdraw_xray</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a66a9d3a01ae913dcf53f82294ac4212b">view3d_draw_xray</a>(scene, ar, v3d, 1);         <span class="comment">// clears zbuffer if it is used!</span>
<a name="l02953"></a>02953     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aff04d5222f4500dd8529d2cd590ec582">afterdraw_xraytransp</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a209d1d806c4fa0f8a25c6ca0b3c812e0">view3d_draw_xraytransp</a>(scene, ar, v3d, 1);
<a name="l02954"></a>02954     
<a name="l02955"></a>02955     <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a41326a4e6f68c93133ddffa468c2705b">ED_region_draw_cb_draw</a>(C, ar, <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a3e6b57328ed92de959be772232b63718">REGION_DRAW_POST_VIEW</a>);
<a name="l02956"></a>02956 
<a name="l02957"></a>02957     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>)
<a name="l02958"></a>02958         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa4cf5dc6374c7b1e81b8322fad984ece">ED_view3d_clipping_disable</a>();
<a name="l02959"></a>02959     
<a name="l02960"></a>02960     <a class="code" href="../../d8/df2/ED__transform_8h.html#a715261718abde5d8e3f07d534be8e604">BIF_draw_manipulator</a>(C);
<a name="l02961"></a>02961 
<a name="l02962"></a>02962 <span class="preprocessor">#if 0</span>
<a name="l02963"></a>02963 <span class="preprocessor"></span>    <span class="comment">/* Disable back anti-aliasing */</span>
<a name="l02964"></a>02964     <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.gameflags &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#afde0938d7aef90b66196aff4a3645aae">USER_DISABLE_AA</a>))
<a name="l02965"></a>02965         glDisable(GL_MULTISAMPLE_ARB);
<a name="l02966"></a>02966 <span class="preprocessor">#endif</span>
<a name="l02967"></a>02967 <span class="preprocessor"></span>
<a name="l02968"></a>02968     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) {
<a name="l02969"></a>02969         v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02970"></a>02970         glDisable(GL_DEPTH_TEST);
<a name="l02971"></a>02971     }
<a name="l02972"></a>02972 
<a name="l02973"></a>02973     <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) == 0) {
<a name="l02974"></a>02974         <a class="code" href="../../d0/d92/editarmature__sketch_8c.html#a6ecff5cf00ce242f6dc1f18d10ae061b">BDR_drawSketch</a>(C);
<a name="l02975"></a>02975     }
<a name="l02976"></a>02976 
<a name="l02977"></a>02977     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.ndof_flag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a8a30658e277c7b201270a828ae9916a1">NDOF_SHOW_GUIDE</a>) &amp;&amp; (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2f24be354ab2bdec931764dda203ca3c">viewlock</a> != <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a440490fbb1bd93b56d293e192829503e">RV3D_LOCKED</a>) &amp;&amp; (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> != <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>))
<a name="l02978"></a>02978         <span class="comment">// TODO: draw something else (but not this) during fly mode</span>
<a name="l02979"></a>02979         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a407fbaf3b1e04c51c650e4e76981032d">draw_rotation_guide</a>(rv3d);
<a name="l02980"></a>02980 
<a name="l02981"></a>02981 }
<a name="l02982"></a>02982 
<a name="l02983"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a96458b61cc61d3073f56b9c6dcc388e7">02983</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a96458b61cc61d3073f56b9c6dcc388e7">view3d_main_area_draw_info</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar, <span class="keyword">const</span> <span class="keywordtype">char</span> *grid_unit)
<a name="l02984"></a>02984 {
<a name="l02985"></a>02985     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02986"></a>02986     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l02987"></a>02987     <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d = <a class="code" href="../../df/d01/BKE__context_8h.html#af03543cb8e3fa2c39bb777962a6eae13">CTX_wm_region_view3d</a>(C);
<a name="l02988"></a>02988     <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *screen = <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C);
<a name="l02989"></a>02989 
<a name="l02990"></a>02990     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l02991"></a>02991 
<a name="l02992"></a>02992     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8f435c152f17185773a21cd8b7067ebb">persp</a> == <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a4c869f8f07a58e54e43d35474bbe4757">RV3D_CAMOB</a>)
<a name="l02993"></a>02993         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a1f5c4857c4d46bd3751ce09f3161e055">drawviewborder</a>(scene, ar, v3d);
<a name="l02994"></a>02994 
<a name="l02995"></a>02995     <span class="keywordflow">if</span> ((v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a70f4e893f7a84825c972ac65835d02bb">flag2</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5cb67e48c19ed7b93ea2d25ad4e7ee80">V3D_RENDER_OVERRIDE</a>) == 0) {
<a name="l02996"></a>02996         <span class="comment">/* draw grease-pencil stuff - needed to get paint-buffer shown too (since it&#39;s 2D) */</span>
<a name="l02997"></a>02997         <span class="comment">//  if (v3d-&gt;flag2 &amp; V3D_DISPGP)</span>
<a name="l02998"></a>02998         <a class="code" href="../../dd/d3e/drawgpencil_8c.html#a89baec14d65520d28457c45cedcde6a1">draw_gpencil_view3d</a>(scene, v3d, ar, 0);
<a name="l02999"></a>02999 
<a name="l03000"></a>03000         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aa3a737c48569fcd4ccf21ac58488b525">drawcursor</a>(scene, ar, v3d);
<a name="l03001"></a>03001     }
<a name="l03002"></a>03002     
<a name="l03003"></a>03003     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a64d0bac516201640cc856e5428bca351">USER_SHOW_ROTVIEWICON</a>)
<a name="l03004"></a>03004         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a9c402a26b0c7abe32748e5426d1ee59c">draw_view_axis</a>(rv3d);
<a name="l03005"></a>03005     <span class="keywordflow">else</span>    
<a name="l03006"></a>03006         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#aed7865fc395c28d8d0ffb090d6b67b3c">draw_view_icon</a>(rv3d);
<a name="l03007"></a>03007     
<a name="l03008"></a>03008     ob = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>;
<a name="l03009"></a>03009     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a60647a00ce7654e0651a1dece8880d0f">USER_DRAWVIEWINFO</a>)
<a name="l03010"></a>03010         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a992bbd27274a7c22f27ed7722eee62d3">draw_selected_name</a>(scene, ob);
<a name="l03011"></a>03011 
<a name="l03012"></a>03012     <span class="keywordflow">if</span> (rv3d-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a2edbfa90c097636953f1a14fb0b12115">render_engine</a>) {
<a name="l03013"></a>03013         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a100e9434c4fd3f6c44901411103fa441">view3d_main_area_draw_engine_info</a>(rv3d, ar);
<a name="l03014"></a>03014         <span class="keywordflow">return</span>;
<a name="l03015"></a>03015     }
<a name="l03016"></a>03016 
<a name="l03017"></a>03017     <span class="keywordflow">if</span> ((<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a131ffc0054af0ae1e30c645724263bdd">USER_SHOW_FPS</a>) &amp;&amp; screen-&gt;<a class="code" href="../../de/de7/structbScreen.html#aceeb55809d2fb599d429d03df9c60b99">animtimer</a>) {
<a name="l03018"></a>03018         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a2bd3ca5b8e53baa0ed00ae546d6b0d3f">draw_viewport_fps</a>(scene, ar);
<a name="l03019"></a>03019     }
<a name="l03020"></a>03020     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.uiflag &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#ae6770672589db3bc67cec713dd359b81">USER_SHOW_VIEWPORTNAME</a>) {
<a name="l03021"></a>03021         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a40d88582e428f0c6dbf1516028f4e55d">draw_viewport_name</a>(ar, v3d);
<a name="l03022"></a>03022     }
<a name="l03023"></a>03023 
<a name="l03024"></a>03024     <span class="keywordflow">if</span> (grid_unit) { <span class="comment">/* draw below the viewport name */</span>
<a name="l03025"></a>03025         <span class="keywordtype">char</span> numstr[32] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03026"></a>03026 
<a name="l03027"></a>03027         <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531aff83a64859a3ca49a01a88357acaf007">TH_TEXT_HI</a>);
<a name="l03028"></a>03028         <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a> != 1.0f) {
<a name="l03029"></a>03029             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(numstr, <span class="keyword">sizeof</span>(numstr), <span class="stringliteral">&quot;%s x %.4g&quot;</span>, grid_unit, v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#aaee600b6bd2db36f2d2b53d433ffa4eb">grid</a>);
<a name="l03030"></a>03030         }
<a name="l03031"></a>03031 
<a name="l03032"></a>03032         <a class="code" href="../../df/d5d/BLF__api_8h.html#a65a4b770f9f92cded5435cbef278ad99">BLF_draw_default_ascii</a>(22,  ar-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a> - (<a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#ae6770672589db3bc67cec713dd359b81">USER_SHOW_VIEWPORTNAME</a> ? 40 : 20), 0.0f,
<a name="l03033"></a>03033                                numstr[0] ? numstr : grid_unit, <span class="keyword">sizeof</span>(numstr));
<a name="l03034"></a>03034     }
<a name="l03035"></a>03035 }
<a name="l03036"></a>03036 
<a name="l03037"></a><a class="code" href="../../d8/d7f/view3d__draw_8c.html#a96f6cc5a0affb74ca0feba5e4bacfa52">03037</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a96f6cc5a0affb74ca0feba5e4bacfa52">view3d_main_area_draw</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar)
<a name="l03038"></a>03038 {
<a name="l03039"></a>03039     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l03040"></a>03040     <span class="keyword">const</span> <span class="keywordtype">char</span> *grid_unit = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03041"></a>03041 
<a name="l03042"></a>03042     <span class="comment">/* draw viewport using external renderer? */</span>
<a name="l03043"></a>03043     <span class="keywordflow">if</span> (!(v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a591cd4c57e5a79352f6733f6fa2bc1c9">drawtype</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5ffb4ceb8fefd165399fc583a8f9d893">OB_RENDER</a> &amp;&amp; <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a052c10d72b13256b5f2ff968000b0c5c">view3d_main_area_draw_engine</a>(C, ar))) {
<a name="l03044"></a>03044         <span class="comment">/* draw viewport using opengl */</span>
<a name="l03045"></a>03045         <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a064a755fcf5476d4ab03e19ad2b3a878">view3d_main_area_draw_objects</a>(C, ar, &amp;grid_unit);
<a name="l03046"></a>03046         <a class="code" href="../../d1/d12/ED__screen_8h.html#a2c148e08841a7ffb64470f579a1b6658">ED_region_pixelspace</a>(ar);
<a name="l03047"></a>03047     }
<a name="l03048"></a>03048     
<a name="l03049"></a>03049     <a class="code" href="../../d8/d7f/view3d__draw_8c.html#a96458b61cc61d3073f56b9c6dcc388e7">view3d_main_area_draw_info</a>(C, ar, grid_unit);
<a name="l03050"></a>03050 
<a name="l03051"></a>03051     v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#a97a32d38ce1481d61d60dc677693ce5d">flag</a> |= <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a89e41f856a5c6e5a3018c00b04a7cfbc">V3D_INVALID_BACKBUF</a>;
<a name="l03052"></a>03052 }
<a name="l03053"></a>03053 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:55:03 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
