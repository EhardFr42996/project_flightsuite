<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: ntl_ray.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">ntl_ray.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d8/d13/ntl__ray_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * El&#39;Beem - Free Surface Fluid Simulation with the Lattice Boltzmann Method</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright 2003-2006 Nils Thuerey</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * main renderer class</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *****************************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df0/utilities_8h.html">utilities.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/dbe/ntl__ray_8h.html">ntl_ray.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d8d/ntl__world_8h.html">ntl_world.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d07/ntl__geometryobject_8h.html">ntl_geometryobject.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dc8/ntl__geometryshader_8h.html">ntl_geometryshader.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">/* Minimum value for refl/refr to be traced */</span>
<a name="l00022"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a547863a5c920280475f2514d322acae2">00022</a> <span class="preprocessor">#define RAY_THRESHOLD 0.001</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>
<a name="l00024"></a>00024 <span class="preprocessor">#if GFX_PRECISION==1</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="comment">// float values</span>
<a name="l00027"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#af944e16ac9e8c746ceef1f03ce91aa3d">00027</a> <span class="comment"></span><span class="preprocessor">#define RAY_MINCONTRIB (1e-04)</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 <span class="preprocessor">#else </span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="comment">// double values</span>
<a name="l00032"></a>00032 <span class="comment"></span><span class="preprocessor">#define RAY_MINCONTRIB (1e-05)</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#endif </span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">/******************************************************************************</span>
<a name="l00041"></a>00041 <span class="comment"> * Constructor</span>
<a name="l00042"></a>00042 <span class="comment"> *****************************************************************************/</span>
<a name="l00043"></a><a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0">00043</a> <a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0" title="Initialize ray memebers, prints error message.">ntlRay::ntlRay</a>( <span class="keywordtype">void</span> )
<a name="l00044"></a>00044   : mOrigin(0.0)
<a name="l00045"></a>00045   , mDirection(0.0)
<a name="l00046"></a>00046   , mvNormal(0.0)
<a name="l00047"></a>00047   , mDepth(0)
<a name="l00048"></a>00048   , mpGlob(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00049"></a>00049   , mIsRefracted(0)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051   <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlRay::ntlRay()&quot;</span>,<span class="stringliteral">&quot;Don&#39;t use uninitialized rays !&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#af2f6eab59be57681799dbee88ff4c4a7">SIMWORLD_GENERICERROR</a>);
<a name="l00052"></a>00052     <span class="keywordflow">return</span>;
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">/******************************************************************************</span>
<a name="l00057"></a>00057 <span class="comment"> * Copy - Constructor</span>
<a name="l00058"></a>00058 <span class="comment"> *****************************************************************************/</span>
<a name="l00059"></a><a class="code" href="../../d4/d54/classntlRay.html#aa1f0575bb9db21d40c2e9bcfdbbf317e">00059</a> <a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0" title="Initialize ray memebers, prints error message.">ntlRay::ntlRay</a>( <span class="keyword">const</span> <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> &amp;r )
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061   <span class="comment">// copy it! initialization is not enough!</span>
<a name="l00062"></a>00062   mOrigin    = r.mOrigin;
<a name="l00063"></a>00063   mDirection = r.mDirection;
<a name="l00064"></a>00064   mvNormal   = r.mvNormal;
<a name="l00065"></a>00065   mDepth     = r.mDepth;
<a name="l00066"></a>00066   mIsRefracted  = r.mIsRefracted;
<a name="l00067"></a>00067   mIsReflected  = r.mIsReflected;
<a name="l00068"></a>00068     mContribution = r.mContribution;
<a name="l00069"></a>00069   mpGlob        = r.mpGlob;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">// get new ID</span>
<a name="l00072"></a>00072     <span class="keywordflow">if</span>(mpGlob) {
<a name="l00073"></a>00073         mID           = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a98dd709280ef10a41d64139e5985938c" title="Return the ray counter.">getCounterRays</a>()+1;
<a name="l00074"></a>00074         mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aba05a611aa44528467ee7a1b72a91a05" title="Set the ray counter.">setCounterRays</a>( mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a98dd709280ef10a41d64139e5985938c" title="Return the ray counter.">getCounterRays</a>()+1 );
<a name="l00075"></a>00075     } <span class="keywordflow">else</span> {
<a name="l00076"></a>00076         mID = 0;
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/******************************************************************************</span>
<a name="l00082"></a>00082 <span class="comment"> * Constructor with explicit parameters and global render object</span>
<a name="l00083"></a>00083 <span class="comment"> *****************************************************************************/</span>
<a name="l00084"></a><a class="code" href="../../d4/d54/classntlRay.html#a56ae4e8e0007e067b09ac7e04ce047e3">00084</a> <a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0" title="Initialize ray memebers, prints error message.">ntlRay::ntlRay</a>(<span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;o, <span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;d, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> contrib, <a class="code" href="../../d0/d95/classntlRenderGlobals.html" title="Class that handles global rendering parameters.">ntlRenderGlobals</a> *glob)
<a name="l00085"></a>00085   : mOrigin( o )
<a name="l00086"></a>00086   , mDirection( d )
<a name="l00087"></a>00087   , mvNormal(0.0)
<a name="l00088"></a>00088   , mDepth( i )
<a name="l00089"></a>00089     , mContribution( contrib )
<a name="l00090"></a>00090   , mpGlob( glob )
<a name="l00091"></a>00091   , mIsRefracted( 0 )
<a name="l00092"></a>00092     , mIsReflected( 0 )
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094     <span class="comment">// get new ID</span>
<a name="l00095"></a>00095     <span class="keywordflow">if</span>(mpGlob) {
<a name="l00096"></a>00096         mID           = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a98dd709280ef10a41d64139e5985938c" title="Return the ray counter.">getCounterRays</a>()+1;
<a name="l00097"></a>00097         mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aba05a611aa44528467ee7a1b72a91a05" title="Set the ray counter.">setCounterRays</a>( mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a98dd709280ef10a41d64139e5985938c" title="Return the ray counter.">getCounterRays</a>()+1 );
<a name="l00098"></a>00098     } <span class="keywordflow">else</span> {
<a name="l00099"></a>00099         mID = 0;
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">/******************************************************************************</span>
<a name="l00106"></a>00106 <span class="comment"> * Destructor</span>
<a name="l00107"></a>00107 <span class="comment"> *****************************************************************************/</span>
<a name="l00108"></a><a class="code" href="../../d4/d54/classntlRay.html#a6d32619b266f30591f92d3f3b1d5d909">00108</a> <a class="code" href="../../d4/d54/classntlRay.html#a6d32619b266f30591f92d3f3b1d5d909" title="Destructor.">ntlRay::~ntlRay</a>()
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110   <span class="comment">/* nothing to do... */</span>
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">/******************************************************************************</span>
<a name="l00116"></a>00116 <span class="comment"> * AABB</span>
<a name="l00117"></a>00117 <span class="comment"> *****************************************************************************/</span>
<a name="l00118"></a>00118 <span class="comment">/* for AABB intersect */</span>
<a name="l00119"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">00119</a> <span class="preprocessor">#define NUMDIM 3</span>
<a name="l00120"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define RIGHT  0</span>
<a name="l00121"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define LEFT   1</span>
<a name="l00122"></a><a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define MIDDLE 2</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00125"></a>00125 <span class="preprocessor">#ifndef ELBEEM_PLUGIN</span>
<a name="l00126"></a><a class="code" href="../../d4/d54/classntlRay.html#a0b7bb821a84f552b2243c1eb192c295e">00126</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="../../d4/d54/classntlRay.html#a0b7bb821a84f552b2243c1eb192c295e" title="intersect ray with AABB">ntlRay::intersectFrontAABB</a>(<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mStart, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mEnd, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> &amp;t, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;retnormal,<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;retcoord)<span class="keyword"> const</span>
<a name="l00127"></a>00127 <span class="keyword"></span>{
<a name="l00128"></a>00128   <span class="keywordtype">char</span>   inside = <span class="keyword">true</span>;   <span class="comment">/* inside box? */</span>
<a name="l00129"></a>00129   <span class="keywordtype">char</span>   hit    = <span class="keyword">false</span>;  <span class="comment">/* ray hits box? */</span>
<a name="l00130"></a>00130   <span class="keywordtype">int</span>    whichPlane;      <span class="comment">/* intersection plane */</span>
<a name="l00131"></a>00131   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> candPlane[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];  <span class="comment">/* candidate plane */</span>
<a name="l00132"></a>00132   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> quadrant[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];   <span class="comment">/* quadrants */</span>
<a name="l00133"></a>00133   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> maxT[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];       <span class="comment">/* max intersection T for planes */</span>
<a name="l00134"></a>00134   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  coord;           <span class="comment">/* intersection point */</span>
<a name="l00135"></a>00135   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  dir = mDirection;
<a name="l00136"></a>00136   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  origin = mOrigin;
<a name="l00137"></a>00137   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  normal(0.0, 0.0, 0.0);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   t = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="comment">/* check intersection planes for AABB */</span>
<a name="l00142"></a>00142   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00143"></a>00143     <span class="keywordflow">if</span>(origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {
<a name="l00144"></a>00144       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00145"></a>00145       candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00146"></a>00146       inside = <span class="keyword">false</span>;
<a name="l00147"></a>00147     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(origin[i] &gt; mEnd[i]) {
<a name="l00148"></a>00148       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00149"></a>00149       candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00150"></a>00150       inside = <span class="keyword">false</span>;
<a name="l00151"></a>00151     } <span class="keywordflow">else</span> {
<a name="l00152"></a>00152       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>;
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="comment">/* inside AABB? */</span>
<a name="l00157"></a>00157   <span class="keywordflow">if</span>(!inside) {
<a name="l00158"></a>00158     <span class="comment">/* get t distances to planes */</span>
<a name="l00159"></a>00159     <span class="comment">/* treat too small direction components as paralell */</span>
<a name="l00160"></a>00160     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00161"></a>00161       <span class="keywordflow">if</span>((quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) &gt; <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>()) ) {
<a name="l00162"></a>00162                 maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) / dir[i];
<a name="l00163"></a>00163       } <span class="keywordflow">else</span> {
<a name="l00164"></a>00164                 maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = -1;
<a name="l00165"></a>00165       }
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     <span class="comment">/* largest max t */</span>
<a name="l00169"></a>00169     whichPlane = 0;
<a name="l00170"></a>00170     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00171"></a>00171       <span class="keywordflow">if</span>(maxT[whichPlane] &lt; maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) whichPlane = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     
<a name="l00174"></a>00174     <span class="comment">/* check final candidate */</span>
<a name="l00175"></a>00175     hit  = <span class="keyword">true</span>;
<a name="l00176"></a>00176     <span class="keywordflow">if</span>(maxT[whichPlane] &gt;= 0.0) {
<a name="l00177"></a>00177 
<a name="l00178"></a>00178       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00179"></a>00179                 <span class="keywordflow">if</span>(whichPlane != <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00180"></a>00180                     coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + maxT[whichPlane] * dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00181"></a>00181                     <span class="keywordflow">if</span>( (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() ) || 
<a name="l00182"></a>00182                             (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &gt; mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]  +<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() )  ) {
<a name="l00183"></a>00183                         <span class="comment">/* no hit... */</span>
<a name="l00184"></a>00184                         hit  = <span class="keyword">false</span>;
<a name="l00185"></a>00185                     } 
<a name="l00186"></a>00186                 }
<a name="l00187"></a>00187                 <span class="keywordflow">else</span> {
<a name="l00188"></a>00188                     coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00189"></a>00189                 }      
<a name="l00190"></a>00190       }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192       <span class="comment">/* AABB hit... */</span>
<a name="l00193"></a>00193       <span class="keywordflow">if</span>( hit ) {
<a name="l00194"></a>00194                 t = maxT[whichPlane];   
<a name="l00195"></a>00195                 <span class="keywordflow">if</span>(quadrant[whichPlane]==<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>) normal[whichPlane] = 1.0;
<a name="l00196"></a>00196                 <span class="keywordflow">else</span> normal[whichPlane] = -1.0;
<a name="l00197"></a>00197       }
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     
<a name="l00200"></a>00200 
<a name="l00201"></a>00201   } <span class="keywordflow">else</span> {
<a name="l00202"></a>00202     <span class="comment">/* inside AABB... */</span>
<a name="l00203"></a>00203     t  = 0.0;
<a name="l00204"></a>00204     coord = origin;
<a name="l00205"></a>00205     <span class="keywordflow">return</span>;
<a name="l00206"></a>00206   }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208   <span class="keywordflow">if</span>(t == <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) t = -1.0;
<a name="l00209"></a>00209   retnormal = normal;
<a name="l00210"></a>00210   retcoord = coord;
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00214"></a><a class="code" href="../../d4/d54/classntlRay.html#a945c96fa92906ead704257171f50cd11">00214</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d54/classntlRay.html#a945c96fa92906ead704257171f50cd11" title="intersect ray with AABB">ntlRay::intersectBackAABB</a>(<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mStart, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mEnd, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> &amp;t, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;retnormal,<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;retcoord)<span class="keyword"> const</span>
<a name="l00215"></a>00215 <span class="keyword"></span>{
<a name="l00216"></a>00216   <span class="keywordtype">char</span>   hit    = <span class="keyword">false</span>;  <span class="comment">/* ray hits box? */</span>
<a name="l00217"></a>00217   <span class="keywordtype">int</span>    whichPlane;      <span class="comment">/* intersection plane */</span>
<a name="l00218"></a>00218   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> candPlane[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>]; <span class="comment">/* candidate plane */</span>
<a name="l00219"></a>00219   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> quadrant[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];  <span class="comment">/* quadrants */</span>
<a name="l00220"></a>00220   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> maxT[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];    <span class="comment">/* max intersection T for planes */</span>
<a name="l00221"></a>00221   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  coord;           <span class="comment">/* intersection point */</span>
<a name="l00222"></a>00222   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  dir = mDirection;
<a name="l00223"></a>00223   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  origin = mOrigin;
<a name="l00224"></a>00224   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  normal(0.0, 0.0, 0.0);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   t = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00227"></a>00227   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00228"></a>00228     <span class="keywordflow">if</span>(origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {
<a name="l00229"></a>00229       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00230"></a>00230       candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00231"></a>00231     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(origin[i] &gt; mEnd[i]) {
<a name="l00232"></a>00232       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00233"></a>00233       candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00234"></a>00234     } <span class="keywordflow">else</span> {
<a name="l00235"></a>00235       <span class="keywordflow">if</span>(dir[i] &gt; 0) {
<a name="l00236"></a>00236                 quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00237"></a>00237                 candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00238"></a>00238       } <span class="keywordflow">else</span> 
<a name="l00239"></a>00239                 <span class="keywordflow">if</span>(dir[i] &lt; 0) {
<a name="l00240"></a>00240                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00241"></a>00241                     candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00242"></a>00242                 } <span class="keywordflow">else</span> {
<a name="l00243"></a>00243                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>;
<a name="l00244"></a>00244                 }
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246   }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">/* get t distances to planes */</span>
<a name="l00250"></a>00250     <span class="comment">/* treat too small direction components as paralell */</span>
<a name="l00251"></a>00251     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00252"></a>00252         <span class="keywordflow">if</span>((quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) &gt; <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>()) ) {
<a name="l00253"></a>00253             maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) / dir[i];
<a name="l00254"></a>00254         } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255             maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     
<a name="l00259"></a>00259     <span class="comment">/* largest max t */</span>
<a name="l00260"></a>00260     whichPlane = 0;
<a name="l00261"></a>00261     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00262"></a>00262         <span class="keywordflow">if</span>(maxT[whichPlane] &gt; maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) whichPlane = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     
<a name="l00265"></a>00265     <span class="comment">/* check final candidate */</span>
<a name="l00266"></a>00266     hit  = <span class="keyword">true</span>;
<a name="l00267"></a>00267     <span class="keywordflow">if</span>(maxT[whichPlane] != <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) {
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00270"></a>00270             <span class="keywordflow">if</span>(whichPlane != <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00271"></a>00271                 coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + maxT[whichPlane] * dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00272"></a>00272                 <span class="keywordflow">if</span>( (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() ) || 
<a name="l00273"></a>00273                         (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &gt; mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]  +<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() )  ) {
<a name="l00274"></a>00274                     <span class="comment">/* no hit... */</span>
<a name="l00275"></a>00275                     hit  = <span class="keyword">false</span>;
<a name="l00276"></a>00276                 } 
<a name="l00277"></a>00277             }
<a name="l00278"></a>00278             <span class="keywordflow">else</span> {
<a name="l00279"></a>00279                 coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00280"></a>00280             }      
<a name="l00281"></a>00281         }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="comment">/* AABB hit... */</span>
<a name="l00284"></a>00284         <span class="keywordflow">if</span>( hit ) {
<a name="l00285"></a>00285             t = maxT[whichPlane];
<a name="l00286"></a>00286     
<a name="l00287"></a>00287             <span class="keywordflow">if</span>(quadrant[whichPlane]==<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>) normal[whichPlane] = 1.0;
<a name="l00288"></a>00288             <span class="keywordflow">else</span> normal[whichPlane] = -1.0;
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291     
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="keywordflow">if</span>(t == <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) t = -1.0;
<a name="l00294"></a>00294   retnormal = normal;
<a name="l00295"></a>00295   retcoord = coord;
<a name="l00296"></a>00296 }
<a name="l00297"></a>00297 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>
<a name="l00300"></a><a class="code" href="../../d4/d54/classntlRay.html#a512138dec3e5d7b627e98b03224c5dd5">00300</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d54/classntlRay.html#a512138dec3e5d7b627e98b03224c5dd5" title="intersect ray with AABB">ntlRay::intersectCompleteAABB</a>(<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mStart, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> mEnd, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> &amp;tmin, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> &amp;tmax)<span class="keyword"> const</span>
<a name="l00301"></a>00301 <span class="keyword"></span>{
<a name="l00302"></a>00302   <span class="keywordtype">char</span>   inside = <span class="keyword">true</span>;   <span class="comment">/* inside box? */</span>
<a name="l00303"></a>00303   <span class="keywordtype">char</span>   hit    = <span class="keyword">false</span>;  <span class="comment">/* ray hits box? */</span>
<a name="l00304"></a>00304   <span class="keywordtype">int</span>    whichPlane;      <span class="comment">/* intersection plane */</span>
<a name="l00305"></a>00305   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> candPlane[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>]; <span class="comment">/* candidate plane */</span>
<a name="l00306"></a>00306   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> quadrant[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];  <span class="comment">/* quadrants */</span>
<a name="l00307"></a>00307   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> maxT[<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>];    <span class="comment">/* max intersection T for planes */</span>
<a name="l00308"></a>00308   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  coord;           <span class="comment">/* intersection point */</span>
<a name="l00309"></a>00309   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  dir = mDirection;
<a name="l00310"></a>00310   <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>  origin = mOrigin;
<a name="l00311"></a>00311   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> t = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="comment">/* check intersection planes for AABB */</span>
<a name="l00314"></a>00314   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00315"></a>00315     <span class="keywordflow">if</span>(origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {
<a name="l00316"></a>00316       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00317"></a>00317       candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00318"></a>00318       inside = <span class="keyword">false</span>;
<a name="l00319"></a>00319     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(origin[i] &gt; mEnd[i]) {
<a name="l00320"></a>00320       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00321"></a>00321       candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00322"></a>00322       inside = <span class="keyword">false</span>;
<a name="l00323"></a>00323     } <span class="keywordflow">else</span> {
<a name="l00324"></a>00324       <span class="comment">/* intersect with backside */</span>
<a name="l00325"></a>00325       <span class="keywordflow">if</span>(dir[i] &gt; 0) {
<a name="l00326"></a>00326                 quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00327"></a>00327                 candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00328"></a>00328       } <span class="keywordflow">else</span> 
<a name="l00329"></a>00329                 <span class="keywordflow">if</span>(dir[i] &lt; 0) {
<a name="l00330"></a>00330                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00331"></a>00331                     candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00332"></a>00332                 } <span class="keywordflow">else</span> {
<a name="l00333"></a>00333                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>;
<a name="l00334"></a>00334                 }
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338   <span class="comment">/* get t distances to planes */</span>
<a name="l00339"></a>00339   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00340"></a>00340     <span class="keywordflow">if</span>((quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) &gt; <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>()) ) {
<a name="l00341"></a>00341       maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) / dir[i];
<a name="l00342"></a>00342     } <span class="keywordflow">else</span> {
<a name="l00343"></a>00343       maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345   }
<a name="l00346"></a>00346  
<a name="l00347"></a>00347   <span class="comment">/* largest max t */</span>
<a name="l00348"></a>00348   whichPlane = 0;
<a name="l00349"></a>00349   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00350"></a>00350     <span class="keywordflow">if</span>( ((maxT[whichPlane] &lt; maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>])&amp;&amp;(maxT[i]!=<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>)) ||
<a name="l00351"></a>00351                 (maxT[whichPlane]==<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) )
<a name="l00352"></a>00352       whichPlane = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00353"></a>00353   }
<a name="l00354"></a>00354     
<a name="l00355"></a>00355   <span class="comment">/* check final candidate */</span>
<a name="l00356"></a>00356   hit  = <span class="keyword">true</span>;
<a name="l00357"></a>00357   <span class="keywordflow">if</span>(maxT[whichPlane]&lt;<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) {
<a name="l00358"></a>00358     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00359"></a>00359       <span class="keywordflow">if</span>(whichPlane != <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00360"></a>00360                 coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + maxT[whichPlane] * dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00361"></a>00361                 <span class="keywordflow">if</span>( (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() ) || 
<a name="l00362"></a>00362                         (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &gt; mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]  +<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() )  ) {
<a name="l00363"></a>00363                     <span class="comment">/* no hit... */</span>
<a name="l00364"></a>00364                     hit  = <span class="keyword">false</span>;
<a name="l00365"></a>00365                 } 
<a name="l00366"></a>00366       }
<a name="l00367"></a>00367       <span class="keywordflow">else</span> { coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];   }      
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">/* AABB hit... */</span>
<a name="l00371"></a>00371     <span class="keywordflow">if</span>( hit ) {
<a name="l00372"></a>00372       t = maxT[whichPlane]; 
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374   }
<a name="l00375"></a>00375   tmin = t;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   <span class="comment">/* now the backside */</span>
<a name="l00378"></a>00378   t = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00379"></a>00379   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00380"></a>00380     <span class="keywordflow">if</span>(origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) {
<a name="l00381"></a>00381       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00382"></a>00382       candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00383"></a>00383     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(origin[i] &gt; mEnd[i]) {
<a name="l00384"></a>00384       quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00385"></a>00385       candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00386"></a>00386     } <span class="keywordflow">else</span> {
<a name="l00387"></a>00387       <span class="keywordflow">if</span>(dir[i] &gt; 0) {
<a name="l00388"></a>00388                 quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a437ef08681e7210d6678427030446a54">LEFT</a>;
<a name="l00389"></a>00389                 candPlane [<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00390"></a>00390       } <span class="keywordflow">else</span> 
<a name="l00391"></a>00391                 <span class="keywordflow">if</span>(dir[i] &lt; 0) {
<a name="l00392"></a>00392                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a80fb826a684cf3f0d306b22aa100ddac">RIGHT</a>;
<a name="l00393"></a>00393                     candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00394"></a>00394                 } <span class="keywordflow">else</span> {
<a name="l00395"></a>00395                     quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>;
<a name="l00396"></a>00396                 }
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398   }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   <span class="comment">/* get t distances to planes */</span>
<a name="l00402"></a>00402   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00403"></a>00403     <span class="keywordflow">if</span>((quadrant[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] != <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#aca9273d6ac9c58c83cbd0820cb8356e1">MIDDLE</a>) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) &gt; <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>()) ) {
<a name="l00404"></a>00404       maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) / dir[i];
<a name="l00405"></a>00405     } <span class="keywordflow">else</span> {
<a name="l00406"></a>00406       maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408   }
<a name="l00409"></a>00409     
<a name="l00410"></a>00410   <span class="comment">/* smallest max t */</span>
<a name="l00411"></a>00411   whichPlane = 0;
<a name="l00412"></a>00412   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00413"></a>00413     <span class="keywordflow">if</span>(maxT[whichPlane] &gt; maxT[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) whichPlane = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415     
<a name="l00416"></a>00416   <span class="comment">/* check final candidate */</span>
<a name="l00417"></a>00417   hit  = <span class="keyword">true</span>;
<a name="l00418"></a>00418   <span class="keywordflow">if</span>(maxT[whichPlane] != <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>) {
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#ae8685a1d1ee367b8eae892349a17c30a">NUMDIM</a>;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00421"></a>00421       <span class="keywordflow">if</span>(whichPlane != <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00422"></a>00422                 coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = origin[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + maxT[whichPlane] * dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00423"></a>00423                 <span class="keywordflow">if</span>( (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &lt; mStart[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() ) || 
<a name="l00424"></a>00424                         (coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] &gt; mEnd[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]  +<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() )  ) {
<a name="l00425"></a>00425                     <span class="comment">/* no hit... */</span>
<a name="l00426"></a>00426                     hit  = <span class="keyword">false</span>;
<a name="l00427"></a>00427                 } 
<a name="l00428"></a>00428       }
<a name="l00429"></a>00429       <span class="keywordflow">else</span> {
<a name="l00430"></a>00430                 coord[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = candPlane[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00431"></a>00431       }      
<a name="l00432"></a>00432     }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="comment">/* AABB hit... */</span>
<a name="l00435"></a>00435     <span class="keywordflow">if</span>( hit ) {
<a name="l00436"></a>00436       t = maxT[whichPlane];
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439    
<a name="l00440"></a>00440   tmax = t;
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="comment">/******************************************************************************</span>
<a name="l00446"></a>00446 <span class="comment"> * Determine color of this ray by tracing through the scene</span>
<a name="l00447"></a>00447 <span class="comment"> *****************************************************************************/</span>
<a name="l00448"></a><a class="code" href="../../d4/d54/classntlRay.html#a9b40d3db954354a668a83ec535ba8b4a">00448</a> <span class="keyword">const</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> <a class="code" href="../../d4/d54/classntlRay.html#a9b40d3db954354a668a83ec535ba8b4a" title="main ray recursion function">ntlRay::shade</a>() <span class="comment">//const</span>
<a name="l00449"></a>00449 {
<a name="l00450"></a>00450 <span class="preprocessor">#ifndef ELBEEM_PLUGIN</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span>  <a class="code" href="../../df/dc9/classntlGeometryObject.html">ntlGeometryObject</a>           *closest = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00452"></a>00452   <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a>                      minT = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00453"></a>00453   vector&lt;ntlLightObject*&gt;     *lightlist = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aabc05df7672ba10b1135a3e5059fa3da" title="Returns the light object list.">getLightList</a>();
<a name="l00454"></a>00454   mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a233a16d3f2479007eb9b69bacc01ed33" title="Set the ray shades counter.">setCounterShades</a>( mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a9035d4aaefaf01c63baafdfe8a1131ed" title="Return the ray shades counter.">getCounterShades</a>()+1 );
<a name="l00455"></a>00455     <span class="keywordtype">bool</span> intersectionInside = 0;
<a name="l00456"></a>00456     <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(std::endl&lt;&lt;<span class="stringliteral">&quot;New Ray: depth &quot;</span>&lt;&lt;mDepth&lt;&lt;<span class="stringliteral">&quot;, org &quot;</span>&lt;&lt;mOrigin&lt;&lt;<span class="stringliteral">&quot;, dir &quot;</span>&lt;&lt;mDirection );
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <span class="comment">/* check if this ray contributes enough */</span>
<a name="l00459"></a>00459     <span class="keywordflow">if</span>(mContribution &lt;= <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#af944e16ac9e8c746ceef1f03ce91aa3d" title="Minimal contribution for rays to be traced on.">RAY_MINCONTRIB</a>) {
<a name="l00460"></a>00460         <span class="comment">//return ntlColor(0.0);</span>
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462     
<a name="l00463"></a>00463   <span class="comment">/* find closes object that intersects */</span>
<a name="l00464"></a>00464     <a class="code" href="../../d8/da3/classntlTriangle.html">ntlTriangle</a> *tri = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00465"></a>00465     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> normal;
<a name="l00466"></a>00466     mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#a879f01c1b3b756fccce9f2f183120f1f">intersectScene</a>(*<span class="keyword">this</span>, minT, normal, tri, 0);
<a name="l00467"></a>00467     <span class="keywordflow">if</span>(minT&gt;0) {
<a name="l00468"></a>00468         closest = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#ad969c8c72eed5dd5ae5153905c20525b">getObject</a>( tri-&gt;<a class="code" href="../../d8/da3/classntlTriangle.html#a6b372ba18721551342c1aaca034c1ae9">getObjectId</a>() );
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   <span class="comment">/* object hit... */</span>
<a name="l00472"></a>00472   <span class="keywordflow">if</span> (closest != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> triangleNormal = tri-&gt;<a class="code" href="../../d8/da3/classntlTriangle.html#a91f54d3e9becba4cf852eb3b1de2d8f4">getNormal</a>();
<a name="l00475"></a>00475         <span class="keywordflow">if</span>( <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac3d13e3c585e0ebebbb788e81b459a18">equal</a>(triangleNormal, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(0.0)) ) <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;ntlRay warning: trinagle normal= 0 &quot;</span>); <span class="comment">// DEBUG</span>
<a name="l00476"></a>00476         <span class="comment">/* intersection on inside faces? if yes invert normal afterwards */</span>
<a name="l00477"></a>00477         <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> valDN; <span class="comment">// = mDirection | normal;</span>
<a name="l00478"></a>00478         valDN = <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(mDirection, triangleNormal);
<a name="l00479"></a>00479         <span class="keywordflow">if</span>( valDN &gt; 0.0) {
<a name="l00480"></a>00480             intersectionInside = 1;
<a name="l00481"></a>00481             normal = normal * -1.0;
<a name="l00482"></a>00482             triangleNormal = triangleNormal * -1.0;
<a name="l00483"></a>00483         } 
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="comment">/* ... -&gt; do reflection */</span>
<a name="l00486"></a>00486     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> intersectionPosition(mOrigin + (mDirection * (minT)) );
<a name="l00487"></a>00487     <a class="code" href="../../d5/d60/classntlMaterial.html" title="Properties of an geo object, describing the reflection properties of the surface.">ntlMaterial</a> *clossurf = closest-&gt;<a class="code" href="../../df/dc9/classntlGeometryObject.html#a8c1f5e050f7951a6bf3f32b01fd135d8">getMaterial</a>();
<a name="l00488"></a>00488         <span class="comment">/*if(mpGlob-&gt;getDebugOut() &gt; 5) {</span>
<a name="l00489"></a>00489 <span class="comment">            errorOut(&quot;Ray hit: at &quot;&lt;&lt;intersectionPosition&lt;&lt;&quot; n:&quot;&lt;&lt;normal&lt;&lt;&quot;    dn:&quot;&lt;&lt;valDN&lt;&lt;&quot; ins:&quot;&lt;&lt;intersectionInside&lt;&lt;&quot;  cl:&quot;&lt;&lt;((unsigned int)closest) ); </span>
<a name="l00490"></a>00490 <span class="comment">            errorOut(&quot; t1:&quot;&lt;&lt;mpGlob-&gt;getRenderScene()-&gt;getVertex(tri-&gt;getPoints()[0])&lt;&lt;&quot; t2:&quot;&lt;&lt;mpGlob-&gt;getRenderScene()-&gt;getVertex(tri-&gt;getPoints()[1])&lt;&lt;&quot; t3:&quot;&lt;&lt;mpGlob-&gt;getScene()-&gt;getVertex(tri-&gt;getPoints()[2]) ); </span>
<a name="l00491"></a>00491 <span class="comment">            errorOut(&quot; trin:&quot;&lt;&lt;tri-&gt;getNormal() );</span>
<a name="l00492"></a>00492 <span class="comment">        } // debug */</span>
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="comment">/* current transparence and reflectivity */</span>
<a name="l00495"></a>00495         <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> currTrans = clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#a5a20f6d4ca16af519f3a4273976a38f3" title="Returns the transparence component.">getTransparence</a>();
<a name="l00496"></a>00496         <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> currRefl = clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#a24800481c3b75957e3aaedbc43fa2349" title="Returns the mirror component.">getMirror</a>();
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">/* correct intersectopm position */</span>
<a name="l00499"></a>00499     intersectionPosition += ( triangleNormal*<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() );
<a name="l00500"></a>00500         <span class="comment">/* reflection at normal */</span>
<a name="l00501"></a>00501         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> reflectedDir = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac43d14a1c6daaaff84ddd054b5c4db7d">getNormalized</a>( <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a0c4b104248c053b23dd5ca946468df0b">reflectVector</a>(mDirection, normal) );
<a name="l00502"></a>00502         <span class="keywordtype">int</span> badRefl = 0;
<a name="l00503"></a>00503         <span class="keywordflow">if</span>(<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(reflectedDir, triangleNormal)&lt;0.0 ) {
<a name="l00504"></a>00504             badRefl = 1;
<a name="l00505"></a>00505             <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) { <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;Ray Bad reflection...!&quot;</span>); }
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="comment">/* refraction direction, depending on in/outside hit */</span>
<a name="l00509"></a>00509         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> refractedDir;
<a name="l00510"></a>00510         <span class="keywordtype">int</span> refRefl = 0;
<a name="l00511"></a>00511         <span class="comment">/* refraction at normal is handled by inverting normal before */</span>
<a name="l00512"></a>00512         <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> myRefIndex = 1.0;
<a name="l00513"></a>00513         <span class="keywordflow">if</span>((currTrans&gt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a547863a5c920280475f2514d322acae2">RAY_THRESHOLD</a>)||(clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#a49c977ca28e231ec52ffce90ebf2c0d5" title="Get Fresnel flag.">getFresnel</a>())) {
<a name="l00514"></a>00514             <span class="keywordflow">if</span>(intersectionInside) {
<a name="l00515"></a>00515                 myRefIndex = 1.0/clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#aec840648c868a9edf25700411e9fe2c5" title="Returns the refraction index component.">getRefracIndex</a>();
<a name="l00516"></a>00516             } <span class="keywordflow">else</span> {
<a name="l00517"></a>00517                 myRefIndex = clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#aec840648c868a9edf25700411e9fe2c5" title="Returns the refraction index component.">getRefracIndex</a>();
<a name="l00518"></a>00518             }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520             refractedDir = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ad2d311a3e311556897e451416dddc5af">refractVector</a>(mDirection, normal, myRefIndex , (<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a>)(1.0) <span class="comment">/* global ref index */</span>, refRefl);
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="comment">/* calculate fresnel? */</span>
<a name="l00524"></a>00524         <span class="keywordflow">if</span>(clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#a49c977ca28e231ec52ffce90ebf2c0d5" title="Get Fresnel flag.">getFresnel</a>()) {
<a name="l00525"></a>00525             <span class="comment">// for total reflection, just set trans to 0</span>
<a name="l00526"></a>00526             <span class="keywordflow">if</span>(refRefl) {
<a name="l00527"></a>00527                 currRefl = 1.0; currTrans = 0.0;
<a name="l00528"></a>00528             } <span class="keywordflow">else</span> {
<a name="l00529"></a>00529                 <span class="comment">// calculate fresnel coefficients</span>
<a name="l00530"></a>00530                 clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#ad22242bad81cb69e144ca4730b857cde" title="Calculate reflectance and refratance from Fresnel&#39;s law.">calculateFresnel</a>( mDirection, normal, myRefIndex, currRefl,currTrans );
<a name="l00531"></a>00531             }
<a name="l00532"></a>00532         }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> reflectedRay(intersectionPosition, reflectedDir, mDepth+1, mContribution*currRefl, mpGlob);
<a name="l00535"></a>00535         reflectedRay.<a class="code" href="../../d4/d54/classntlRay.html#af69dedcdd6f1dd1b0a39ef5913168df2">setNormal</a>( normal );
<a name="l00536"></a>00536     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> currentColor(0.0);
<a name="l00537"></a>00537     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> highlightColor(0.0);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     <span class="comment">/* first add reflected ambient color */</span>
<a name="l00540"></a>00540     currentColor += (clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#abc82a80acccaa28fcc0fcfeed13f48b4" title="Returns the ambience.">getAmbientRefl</a>() * mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aab5f27c4168ccf503680270d0e393820" title="Return the ambient color.">getAmbientLight</a>() );
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="comment">/* calculate lighting, not on the insides of objects... */</span>
<a name="l00543"></a>00543         <span class="keywordflow">if</span>(!intersectionInside) {
<a name="l00544"></a>00544             <span class="keywordflow">for</span> (vector&lt;ntlLightObject*&gt;::iterator iter = lightlist-&gt;begin();
<a name="l00545"></a>00545                      iter != lightlist-&gt;end();
<a name="l00546"></a>00546                      iter++) {
<a name="l00547"></a>00547                 
<a name="l00548"></a>00548                 <span class="comment">/* let light illuminate point */</span>
<a name="l00549"></a>00549                 currentColor += (*iter)-&gt;illuminatePoint( reflectedRay, closest, highlightColor );
<a name="l00550"></a>00550                 
<a name="l00551"></a>00551             } <span class="comment">// for all lights</span>
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">// recurse ?</span>
<a name="l00555"></a>00555     <span class="keywordflow">if</span> ((mDepth &lt; mpGlob-&gt;getRayMaxDepth() )&amp;&amp;(currRefl&gt;<a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a547863a5c920280475f2514d322acae2">RAY_THRESHOLD</a>)) {
<a name="l00556"></a>00556 
<a name="l00557"></a>00557                 <span class="keywordflow">if</span>(badRefl) {
<a name="l00558"></a>00558                     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> intersectionPosition2;
<a name="l00559"></a>00559                     <a class="code" href="../../df/dc9/classntlGeometryObject.html">ntlGeometryObject</a>           *closest2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00560"></a>00560                     <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a>                      minT2 = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a104146d3d42b0ca57494dd2621bd02cd">GFX_REAL_MAX</a>;
<a name="l00561"></a>00561                     <a class="code" href="../../d8/da3/classntlTriangle.html">ntlTriangle</a> *tri2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00562"></a>00562                     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> normal2;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564                     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> refractionPosition2(mOrigin + (mDirection * minT) );
<a name="l00565"></a>00565                     refractionPosition2 -= (triangleNormal*<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() );
<a name="l00566"></a>00566 
<a name="l00567"></a>00567                     <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> reflectedRay2 = <a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0" title="Initialize ray memebers, prints error message.">ntlRay</a>(refractionPosition2, reflectedDir, mDepth+1, mContribution*currRefl, mpGlob);
<a name="l00568"></a>00568                     mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#a879f01c1b3b756fccce9f2f183120f1f">intersectScene</a>(reflectedRay2, minT2, normal2, tri2, 0);
<a name="l00569"></a>00569                     <span class="keywordflow">if</span>(minT2&gt;0) {
<a name="l00570"></a>00570                         closest2 = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#ad969c8c72eed5dd5ae5153905c20525b">getObject</a>( tri2-&gt;<a class="code" href="../../d8/da3/classntlTriangle.html#a6b372ba18721551342c1aaca034c1ae9">getObjectId</a>() );
<a name="l00571"></a>00571                     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573                     <span class="comment">/* object hit... */</span>
<a name="l00574"></a>00574                     <span class="keywordflow">if</span> (closest2 != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00575"></a>00575                         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> triangleNormal2 = tri2-&gt;<a class="code" href="../../d8/da3/classntlTriangle.html#a91f54d3e9becba4cf852eb3b1de2d8f4">getNormal</a>();
<a name="l00576"></a>00576                         <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> valDN2; 
<a name="l00577"></a>00577                         valDN2 = <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>(reflectedDir, triangleNormal2);
<a name="l00578"></a>00578                         <span class="keywordflow">if</span>( valDN2 &gt; 0.0) {
<a name="l00579"></a>00579                             triangleNormal2 = triangleNormal2 * -1.0;
<a name="l00580"></a>00580                             intersectionPosition2 = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(intersectionPosition + (reflectedDir * (minT2)) );
<a name="l00581"></a>00581                             <span class="comment">/* correct intersection position and create new reflected ray */</span>
<a name="l00582"></a>00582                             intersectionPosition2 += ( triangleNormal2*<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() );
<a name="l00583"></a>00583                             reflectedRay = <a class="code" href="../../d4/d54/classntlRay.html#ae98f11407a1ec3d8426545dc88c383c0" title="Initialize ray memebers, prints error message.">ntlRay</a>(intersectionPosition2, reflectedDir, mDepth+1, mContribution*currRefl, mpGlob);
<a name="l00584"></a>00584                         } <span class="keywordflow">else</span> { 
<a name="l00585"></a>00585                             <span class="comment">// ray seems to work, continue normally ?</span>
<a name="l00586"></a>00586                         }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588                     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                 }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592       <span class="comment">// add mirror color multiplied by mirror factor of surface</span>
<a name="l00593"></a>00593             <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;Reflected ray from depth &quot;</span>&lt;&lt;mDepth&lt;&lt;<span class="stringliteral">&quot;, dir &quot;</span>&lt;&lt;reflectedDir );
<a name="l00594"></a>00594             <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> reflectedColor = reflectedRay.<a class="code" href="../../d4/d54/classntlRay.html#a9b40d3db954354a668a83ec535ba8b4a" title="main ray recursion function">shade</a>() * currRefl;
<a name="l00595"></a>00595             currentColor += reflectedColor;
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="comment">/* Trace another ray on for transparent objects */</span>
<a name="l00599"></a>00599     <span class="keywordflow">if</span>(currTrans &gt; <a class="code" href="../../d8/d13/ntl__ray_8cpp.html#a547863a5c920280475f2514d322acae2">RAY_THRESHOLD</a>) {
<a name="l00600"></a>00600       <span class="comment">/* position at the other side of the surface, along ray */</span>
<a name="l00601"></a>00601       <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> refraction_position(mOrigin + (mDirection * minT) );
<a name="l00602"></a>00602       refraction_position += (mDirection * <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>());
<a name="l00603"></a>00603             refraction_position -= (triangleNormal*<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a244bf4934c8f31a401e82947e85a4c4b">getVecEpsilon</a>() );
<a name="l00604"></a>00604       <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> refracCol(0.0);         <span class="comment">/* refracted color */</span>
<a name="l00605"></a>00605 
<a name="l00606"></a>00606       <span class="comment">/* trace refracted ray */</span>
<a name="l00607"></a>00607       <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> transRay(refraction_position, refractedDir, mDepth+1, mContribution*currTrans, mpGlob);
<a name="l00608"></a>00608       transRay.<a class="code" href="../../d4/d54/classntlRay.html#aa4d21228ee79d7c51faac0f4a2da96e2" title="Set the refraction flag for refracted rays.">setRefracted</a>(1);
<a name="l00609"></a>00609             transRay.<a class="code" href="../../d4/d54/classntlRay.html#af69dedcdd6f1dd1b0a39ef5913168df2">setNormal</a>( normal );
<a name="l00610"></a>00610       <span class="keywordflow">if</span>(mDepth &lt; mpGlob-&gt;getRayMaxDepth() ) {
<a name="l00611"></a>00611                 <span class="comment">// full reflection should make sure refracindex&amp;fresnel are on...</span>
<a name="l00612"></a>00612                 <span class="keywordflow">if</span>((0)||(!refRefl)) {
<a name="l00613"></a>00613                     <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;Refracted ray from depth &quot;</span>&lt;&lt;mDepth&lt;&lt;<span class="stringliteral">&quot;, dir &quot;</span>&lt;&lt;refractedDir );
<a name="l00614"></a>00614                     refracCol = transRay.<a class="code" href="../../d4/d54/classntlRay.html#a9b40d3db954354a668a83ec535ba8b4a" title="main ray recursion function">shade</a>();
<a name="l00615"></a>00615                 } <span class="keywordflow">else</span> { 
<a name="l00616"></a>00616                     <span class="comment">//we shouldnt reach this!</span>
<a name="l00617"></a>00617                     <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;Fully reflected ray from depth &quot;</span>&lt;&lt;mDepth&lt;&lt;<span class="stringliteral">&quot;, dir &quot;</span>&lt;&lt;reflectedDir );
<a name="l00618"></a>00618                     refracCol = reflectedRay.<a class="code" href="../../d4/d54/classntlRay.html#a9b40d3db954354a668a83ec535ba8b4a" title="main ray recursion function">shade</a>();
<a name="l00619"></a>00619                 }
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621             <span class="comment">//errMsg(&quot;REFMIR&quot;,&quot;t&quot;&lt;&lt;currTrans&lt;&lt;&quot; thres&quot;&lt;&lt;RAY_THRESHOLD&lt;&lt;&quot; mirr&quot;&lt;&lt;currRefl&lt;&lt;&quot; refRefl&quot;&lt;&lt;refRefl&lt;&lt;&quot; md&quot;&lt;&lt;mDepth);</span>
<a name="l00622"></a>00622 
<a name="l00623"></a>00623       <span class="comment">/* calculate color */</span>
<a name="l00624"></a>00624             <span class="comment">// use transadditive setting!?</span>
<a name="l00625"></a>00625       <span class="comment">/* additive transparency &quot;light amplification&quot; */</span>
<a name="l00626"></a>00626       <span class="comment">//? ntlColor add_col = currentColor + refracCol * currTrans;</span>
<a name="l00627"></a>00627       <span class="comment">/* mix additive and subtractive */</span>
<a name="l00628"></a>00628             <span class="comment">//? add_col += sub_col;</span>
<a name="l00629"></a>00629             <span class="comment">//? currentColor += (refracCol * currTrans);</span>
<a name="l00630"></a>00630 
<a name="l00631"></a>00631       <span class="comment">/* subtractive transparency, more realistic */</span>
<a name="l00632"></a>00632       <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> sub_col = (refracCol * currTrans) + ( currentColor * (1.0-currTrans) );
<a name="l00633"></a>00633             currentColor = sub_col;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="comment">/* add highlights (should not be affected by transparence as the diffuse reflections */</span>
<a name="l00638"></a>00638         currentColor += highlightColor;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="comment">/* attentuate as a last step*/</span>
<a name="l00641"></a>00641         <span class="comment">/* check if we&#39;re on the inside or outside */</span>
<a name="l00642"></a>00642         <span class="keywordflow">if</span>(intersectionInside) {
<a name="l00643"></a>00643             <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> kr,kg,kb;    <span class="comment">/* attentuation */</span>
<a name="l00644"></a>00644             <span class="comment">/* calculate attentuation */</span>
<a name="l00645"></a>00645             <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> attCol = clossurf-&gt;<a class="code" href="../../d5/d60/classntlMaterial.html#a0b006c39350f06cd437c42a55fcce3c6" title="Returns the transparency attentuation.">getTransAttCol</a>();
<a name="l00646"></a>00646             kr = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>( attCol[0] * minT );
<a name="l00647"></a>00647             kg = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>( attCol[1] * minT );
<a name="l00648"></a>00648             kb = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>( attCol[2] * minT );
<a name="l00649"></a>00649             currentColor = currentColor * <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(kr,kg,kb);
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="comment">/* done... */</span>
<a name="l00653"></a>00653         <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 5) { <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;Ray &quot;</span>&lt;&lt;mDepth&lt;&lt;<span class="stringliteral">&quot; color &quot;</span>&lt;&lt;currentColor ); }
<a name="l00654"></a>00654     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(currentColor);
<a name="l00655"></a>00655   }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span>  <span class="comment">/* no object hit -&gt; ray goes to infinity */</span>
<a name="l00659"></a>00659   <span class="keywordflow">return</span> mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a562f3f334dc350a4f187c3bac6d46d75" title="Return the background color.">getBackgroundCol</a>(); 
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="comment">/******************************************************************************</span>
<a name="l00665"></a>00665 <span class="comment"> ******************************************************************************</span>
<a name="l00666"></a>00666 <span class="comment"> ******************************************************************************</span>
<a name="l00667"></a>00667 <span class="comment"> * scene implementation</span>
<a name="l00668"></a>00668 <span class="comment"> ******************************************************************************</span>
<a name="l00669"></a>00669 <span class="comment"> ******************************************************************************</span>
<a name="l00670"></a>00670 <span class="comment"> *****************************************************************************/</span>
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="comment">/******************************************************************************</span>
<a name="l00675"></a>00675 <span class="comment"> * Constructor</span>
<a name="l00676"></a>00676 <span class="comment"> *****************************************************************************/</span>
<a name="l00677"></a><a class="code" href="../../dd/d46/classntlScene.html#a6f360301e553b27651153a852f0667a1">00677</a> <a class="code" href="../../dd/d46/classntlScene.html#a6f360301e553b27651153a852f0667a1">ntlScene::ntlScene</a>( <a class="code" href="../../d0/d95/classntlRenderGlobals.html" title="Class that handles global rendering parameters.">ntlRenderGlobals</a> *glob, <span class="keywordtype">bool</span> del ) :
<a name="l00678"></a>00678     mpGlob( glob ), mSceneDel(del),
<a name="l00679"></a>00679     mpTree( <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ),
<a name="l00680"></a>00680     mDisplayListId( -1 ), 
<a name="l00681"></a>00681     mSceneBuilt( false ), mFirstInitDone( false )
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 <span class="comment">/******************************************************************************</span>
<a name="l00687"></a>00687 <span class="comment"> * Destructor</span>
<a name="l00688"></a>00688 <span class="comment"> *****************************************************************************/</span>
<a name="l00689"></a><a class="code" href="../../dd/d46/classntlScene.html#a4fcc3d59cf2efe88c44050d9e774a38a">00689</a> <a class="code" href="../../dd/d46/classntlScene.html#a4fcc3d59cf2efe88c44050d9e774a38a">ntlScene::~ntlScene</a>()
<a name="l00690"></a>00690 {
<a name="l00691"></a>00691     <span class="keywordflow">if</span>(mpTree != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keyword">delete</span> mpTree;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <span class="comment">// cleanup lists, only if this is the rendering cleanup scene</span>
<a name="l00694"></a>00694     <span class="keywordflow">if</span>(mSceneDel) 
<a name="l00695"></a>00695     {
<a name="l00696"></a>00696         <span class="keywordflow">for</span> (vector&lt;ntlGeometryClass*&gt;::iterator iter = mGeos.begin();
<a name="l00697"></a>00697                 iter != mGeos.end(); iter++) {
<a name="l00698"></a>00698             <span class="comment">//errMsg(&quot;ntlScene::~ntlScene&quot;,&quot;Deleting obj &quot;&lt;&lt;(*iter)-&gt;getName() );</span>
<a name="l00699"></a>00699             <span class="keyword">delete</span> (*iter);
<a name="l00700"></a>00700         }
<a name="l00701"></a>00701         <span class="keywordflow">for</span> (vector&lt;ntlLightObject*&gt;::iterator iter = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aabc05df7672ba10b1135a3e5059fa3da" title="Returns the light object list.">getLightList</a>()-&gt;begin();
<a name="l00702"></a>00702                  iter != mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aabc05df7672ba10b1135a3e5059fa3da" title="Returns the light object list.">getLightList</a>()-&gt;end(); iter++) {
<a name="l00703"></a>00703             <span class="keyword">delete</span> (*iter);
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705         <span class="keywordflow">for</span> (vector&lt;ntlMaterial*&gt;::iterator iter = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a84d31b05d957e34c82f47526d3600cf5" title="Returns the property object list.">getMaterials</a>()-&gt;begin();
<a name="l00706"></a>00706                  iter != mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a84d31b05d957e34c82f47526d3600cf5" title="Returns the property object list.">getMaterials</a>()-&gt;end(); iter++) {
<a name="l00707"></a>00707             <span class="keyword">delete</span> (*iter);
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlScene::~ntlScene&quot;</span>,<span class="stringliteral">&quot;Deleted, ObjFree:&quot;</span>&lt;&lt;mSceneDel);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="comment">/******************************************************************************</span>
<a name="l00715"></a>00715 <span class="comment"> * Build the scene arrays (obj, tris etc.)</span>
<a name="l00716"></a>00716 <span class="comment"> *****************************************************************************/</span>
<a name="l00717"></a><a class="code" href="../../dd/d46/classntlScene.html#aeae84245423a31b212567b722225340d">00717</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/d46/classntlScene.html#aeae84245423a31b212567b722225340d">ntlScene::buildScene</a>(<span class="keywordtype">double</span> time,<span class="keywordtype">bool</span> firstInit)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719     <span class="keyword">const</span> <span class="keywordtype">bool</span> buildInfo=<span class="keyword">true</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <span class="keywordflow">if</span>(firstInit) {
<a name="l00722"></a>00722         mObjects.clear();
<a name="l00723"></a>00723         <span class="comment">/* init geometry array, first all standard objects */</span>
<a name="l00724"></a>00724         <span class="keywordflow">for</span> (vector&lt;ntlGeometryClass*&gt;::iterator iter = mGeos.begin();
<a name="l00725"></a>00725                 iter != mGeos.end(); iter++) {
<a name="l00726"></a>00726             <span class="keywordtype">bool</span> geoinit = <span class="keyword">false</span>;
<a name="l00727"></a>00727             <span class="keywordtype">int</span> tid = (*iter)-&gt;getTypeId();
<a name="l00728"></a>00728             <span class="keywordflow">if</span>(tid &amp; <a class="code" href="../../d5/d54/ntl__geometryclass_8h.html#a86dbc36f45003a861298bbe1acba1876" title="geometry class type ids">GEOCLASSTID_OBJECT</a>) {
<a name="l00729"></a>00729                 <a class="code" href="../../df/dc9/classntlGeometryObject.html">ntlGeometryObject</a> *geoobj = (<a class="code" href="../../df/dc9/classntlGeometryObject.html">ntlGeometryObject</a>*)(*iter);
<a name="l00730"></a>00730                 geoinit = <span class="keyword">true</span>;
<a name="l00731"></a>00731                 mObjects.push_back( geoobj );
<a name="l00732"></a>00732                 <span class="keywordflow">if</span>(buildInfo) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::BuildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;added GeoObj &quot;</span>&lt;&lt;geoobj-&gt;<a class="code" href="../../dd/dcf/classntlGeometryClass.html#aa0433486901f2f913b7ca5c80a0de218">getName</a>()&lt;&lt;<span class="stringliteral">&quot; Id:&quot;</span>&lt;&lt;geoobj-&gt;<a class="code" href="../../dd/dcf/classntlGeometryClass.html#ae237ae7421caa9ae7ca3ba54e5185ad6">getObjectId</a>(), 5 );
<a name="l00733"></a>00733             }
<a name="l00734"></a>00734             <span class="comment">//if(geoshad) {</span>
<a name="l00735"></a>00735             <span class="keywordflow">if</span>(tid &amp; <a class="code" href="../../d5/d54/ntl__geometryclass_8h.html#aee7e36237cd69151e1b7d37e56634bd5">GEOCLASSTID_SHADER</a>) {
<a name="l00736"></a>00736                 <a class="code" href="../../de/d7b/classntlGeometryShader.html">ntlGeometryShader</a> *geoshad = (<a class="code" href="../../de/d7b/classntlGeometryShader.html">ntlGeometryShader</a>*)(*iter);
<a name="l00737"></a>00737                 geoinit = <span class="keyword">true</span>;
<a name="l00738"></a>00738                 <span class="keywordflow">if</span>(!mFirstInitDone) {
<a name="l00739"></a>00739                     <span class="comment">// only on first init</span>
<a name="l00740"></a>00740                     geoshad-&gt;<a class="code" href="../../de/d7b/classntlGeometryShader.html#a8c8adab175b9b802c81450d4d2bf49a8">initializeShader</a>();
<a name="l00741"></a>00741                 }
<a name="l00742"></a>00742                 <span class="keywordflow">for</span> (vector&lt;ntlGeometryObject*&gt;::iterator siter = geoshad-&gt;<a class="code" href="../../de/d7b/classntlGeometryShader.html#ae42bb95c128da4a79cdbf8f4aac58614">getObjectsBegin</a>();
<a name="l00743"></a>00743                         siter != geoshad-&gt;<a class="code" href="../../de/d7b/classntlGeometryShader.html#ab8d50fa1906aae9aa1485d024a4cf739">getObjectsEnd</a>();
<a name="l00744"></a>00744                         siter++) {
<a name="l00745"></a>00745                     <span class="keywordflow">if</span>(buildInfo) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::BuildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;added shader geometry &quot;</span>&lt;&lt;(*siter)-&gt;getName()&lt;&lt;<span class="stringliteral">&quot; Id:&quot;</span>&lt;&lt;(*siter)-&gt;getObjectId(), 5 );
<a name="l00746"></a>00746                     mObjects.push_back( (*siter) );
<a name="l00747"></a>00747                 }
<a name="l00748"></a>00748             }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750             <span class="keywordflow">if</span>(!geoinit) {
<a name="l00751"></a>00751                 <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlScene::BuildScene&quot;</span>,<span class="stringliteral">&quot;Invalid geometry class!&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a74894721e682bda2c22d5dacda988cad">SIMWORLD_INITERROR</a>);
<a name="l00752"></a>00752                 <span class="keywordflow">return</span>;
<a name="l00753"></a>00753             }
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment">// collect triangles</span>
<a name="l00758"></a>00758     mTriangles.clear();
<a name="l00759"></a>00759     mVertices.clear();
<a name="l00760"></a>00760     mVertNormals.clear();
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <span class="comment">/* for test mode deactivate transparencies etc. */</span>
<a name="l00763"></a>00763     <span class="keywordflow">if</span>( mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a941417878f1c51efb2e4fa97c67c2b28" title="get test mode flag">getTestMode</a>() ) {
<a name="l00764"></a>00764         <a class="code" href="../../de/df0/utilities_8h.html#a2b390eed962d9bee00ce58c1f6bfd159">debugOut</a>(<span class="stringliteral">&quot;ntlScene::buildScene : Test Mode activated!&quot;</span>, 2);
<a name="l00765"></a>00765         <span class="comment">// assign random colors to dark materials</span>
<a name="l00766"></a>00766         <span class="keywordtype">int</span> matCounter = 0;
<a name="l00767"></a>00767         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> stdCols[] = { <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0,0,1.0), <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0,1.0,0), <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(1.0,0.7,0) , <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.7,0,0.6) };
<a name="l00768"></a>00768         <span class="keywordtype">int</span> stdColNum = 4;
<a name="l00769"></a>00769         <span class="keywordflow">for</span> (vector&lt;ntlMaterial*&gt;::iterator iter = mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a84d31b05d957e34c82f47526d3600cf5" title="Returns the property object list.">getMaterials</a>()-&gt;begin();
<a name="l00770"></a>00770                      iter != mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a84d31b05d957e34c82f47526d3600cf5" title="Returns the property object list.">getMaterials</a>()-&gt;end(); iter++) {
<a name="l00771"></a>00771             (*iter)-&gt;setTransparence(0.0);
<a name="l00772"></a>00772             (*iter)-&gt;setMirror(0.0);
<a name="l00773"></a>00773             (*iter)-&gt;setFresnel(<span class="keyword">false</span>);
<a name="l00774"></a>00774             <span class="comment">// too dark?</span>
<a name="l00775"></a>00775             <span class="keywordflow">if</span>( <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>((*iter)-&gt;getDiffuseRefl()) &lt;0.01) {
<a name="l00776"></a>00776                 (*iter)-&gt;setDiffuseRefl( stdCols[matCounter] );
<a name="l00777"></a>00777                 matCounter ++;
<a name="l00778"></a>00778                 matCounter = matCounter%stdColNum;
<a name="l00779"></a>00779             }
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782         <span class="comment">// restrict output file size to 400</span>
<a name="l00783"></a>00783         <span class="keywordtype">float</span> downscale = 1.0;
<a name="l00784"></a>00784         <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a06513df9ceb9069240f3a977df2ad10e" title="Return the x resolution.">getResX</a>() &gt; 400){ downscale = 400.0/(float)mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a06513df9ceb9069240f3a977df2ad10e" title="Return the x resolution.">getResX</a>(); }
<a name="l00785"></a>00785         <span class="keywordflow">if</span>(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a82b18e58d875cf198373380a657f444e" title="Return the y resolution.">getResY</a>() &gt; 400){ 
<a name="l00786"></a>00786             <span class="keywordtype">float</span> downscale2 = 400.0/(float)mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a82b18e58d875cf198373380a657f444e" title="Return the y resolution.">getResY</a>(); 
<a name="l00787"></a>00787             <span class="keywordflow">if</span>(downscale2&lt;downscale) downscale=downscale2;
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789         mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a3f34f2738a0031b6e351eb49a3a3a8dd" title="Set the x resolution.">setResX</a>( (<span class="keywordtype">int</span>)(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a06513df9ceb9069240f3a977df2ad10e" title="Return the x resolution.">getResX</a>() * downscale) );
<a name="l00790"></a>00790         mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ac321a2a093286f2a96e9d22ebce99d20" title="Set the y resolution.">setResY</a>( (<span class="keywordtype">int</span>)(mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a82b18e58d875cf198373380a657f444e" title="Return the y resolution.">getResY</a>() * downscale) );
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="comment">/* collect triangles from objects */</span>
<a name="l00795"></a>00795     <span class="keywordtype">int</span> idCnt = 0;          <span class="comment">// give IDs to objects</span>
<a name="l00796"></a>00796     <span class="keywordtype">bool</span> debugTriCollect = <span class="keyword">false</span>;
<a name="l00797"></a>00797     <span class="keywordflow">if</span>(debugTriCollect) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Start...&quot;</span>,5);
<a name="l00798"></a>00798   <span class="keywordflow">for</span> (vector&lt;ntlGeometryObject*&gt;::iterator iter = mObjects.begin();
<a name="l00799"></a>00799        iter != mObjects.end();
<a name="l00800"></a>00800        iter++) {
<a name="l00801"></a>00801         <span class="comment">/* only add visible objects */</span>
<a name="l00802"></a>00802         <span class="keywordflow">if</span>(firstInit) {
<a name="l00803"></a>00803             <span class="keywordflow">if</span>(debugTriCollect) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Collect init of &quot;</span>&lt;&lt;(*iter)-&gt;getName()&lt;&lt;<span class="stringliteral">&quot; idCnt:&quot;</span>&lt;&lt;idCnt, 4 );
<a name="l00804"></a>00804             (*iter)-&gt;initialize( mpGlob ); }
<a name="l00805"></a>00805         <span class="keywordflow">if</span>(debugTriCollect) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Collecting tris from &quot;</span>&lt;&lt;(*iter)-&gt;getName(), 4 );
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordtype">int</span> vstart = mVertNormals.size();
<a name="l00808"></a>00808         (*iter)-&gt;setObjectId(idCnt);
<a name="l00809"></a>00809         (*iter)-&gt;getTriangles(time, &amp;mTriangles, &amp;mVertices, &amp;mVertNormals, idCnt);
<a name="l00810"></a>00810         (*iter)-&gt;applyTransformation(time, &amp;mVertices, &amp;mVertNormals, vstart, mVertices.size(), false );
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">if</span>(debugTriCollect) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Done with &quot;</span>&lt;&lt;(*iter)-&gt;getName()&lt;&lt;<span class="stringliteral">&quot; totTris:&quot;</span>&lt;&lt;mTriangles.size()&lt;&lt;<span class="stringliteral">&quot; totVerts:&quot;</span>&lt;&lt;mVertices.size()&lt;&lt;<span class="stringliteral">&quot; totNorms:&quot;</span>&lt;&lt;mVertNormals.size(), 4 );
<a name="l00813"></a>00813         idCnt ++;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">if</span>(debugTriCollect) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;End&quot;</span>,5);
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="comment">/* calculate triangle normals, and initialize flags */</span>
<a name="l00819"></a>00819   <span class="keywordflow">for</span> (vector&lt;ntlTriangle&gt;::iterator iter = mTriangles.begin();
<a name="l00820"></a>00820        iter != mTriangles.end();
<a name="l00821"></a>00821        iter++) {
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <span class="comment">// calculate normal from triangle points</span>
<a name="l00824"></a>00824         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> normal = 
<a name="l00825"></a>00825             <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>( (<a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a>)( (mVertices[(*iter).getPoints()[2]] - mVertices[(*iter).getPoints()[0]]) *-1.0),  <span class="comment">// BLITZ minus sign right??</span>
<a name="l00826"></a>00826             (<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>)(mVertices[(*iter).getPoints()[1]] - mVertices[(*iter).getPoints()[0]]) );
<a name="l00827"></a>00827         <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(normal);
<a name="l00828"></a>00828         (*iter).setNormal( normal );
<a name="l00829"></a>00829     }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="comment">// scene geometry built </span>
<a name="l00834"></a>00834     mSceneBuilt = <span class="keyword">true</span>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="comment">// init shaders that require complete geometry</span>
<a name="l00837"></a>00837     <span class="keywordflow">if</span>(!mFirstInitDone) {
<a name="l00838"></a>00838         <span class="comment">// only on first init</span>
<a name="l00839"></a>00839         <span class="keywordflow">for</span> (vector&lt;ntlGeometryClass*&gt;::iterator iter = mGeos.begin();
<a name="l00840"></a>00840                 iter != mGeos.end(); iter++) {
<a name="l00841"></a>00841             <span class="keywordflow">if</span>( (*iter)-&gt;getTypeId() &amp; <a class="code" href="../../d5/d54/ntl__geometryclass_8h.html#aee7e36237cd69151e1b7d37e56634bd5">GEOCLASSTID_SHADER</a> ) {
<a name="l00842"></a>00842                 <a class="code" href="../../de/d7b/classntlGeometryShader.html">ntlGeometryShader</a> *geoshad = (<a class="code" href="../../de/d7b/classntlGeometryShader.html">ntlGeometryShader</a>*)(*iter);
<a name="l00843"></a>00843                 <span class="keywordflow">if</span>(geoshad-&gt;<a class="code" href="../../de/d7b/classntlGeometryShader.html#ac6f557c052636ee76a06780f3cb21260">postGeoConstrInit</a>( mpGlob )) {
<a name="l00844"></a>00844                     <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<span class="stringliteral">&quot;Init failed for object &#39;&quot;</span>&lt;&lt; (*iter)-&gt;getName() &lt;&lt;<span class="stringliteral">&quot;&#39; !&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a74894721e682bda2c22d5dacda988cad">SIMWORLD_INITERROR</a> );
<a name="l00845"></a>00845                     <span class="keywordflow">return</span>;
<a name="l00846"></a>00846                 }
<a name="l00847"></a>00847             }
<a name="l00848"></a>00848         }
<a name="l00849"></a>00849         mFirstInitDone = <span class="keyword">true</span>;
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="comment">// check unused attributes (for classes and objects!)</span>
<a name="l00853"></a>00853   <span class="keywordflow">for</span> (vector&lt;ntlGeometryObject*&gt;::iterator iter = mObjects.begin(); iter != mObjects.end(); iter++) {
<a name="l00854"></a>00854         <span class="keywordflow">if</span>((*iter)-&gt;getAttributeList()-&gt;checkUnusedParams()) {
<a name="l00855"></a>00855             (*iter)-&gt;getAttributeList()-&gt;print(); <span class="comment">// DEBUG</span>
<a name="l00856"></a>00856             <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<span class="stringliteral">&quot;Unused params for object &#39;&quot;</span>&lt;&lt; (*iter)-&gt;getName() &lt;&lt;<span class="stringliteral">&quot;&#39; !&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a74894721e682bda2c22d5dacda988cad">SIMWORLD_INITERROR</a> );
<a name="l00857"></a>00857             <span class="keywordflow">return</span>;
<a name="l00858"></a>00858         }
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     <span class="keywordflow">for</span> (vector&lt;ntlGeometryClass*&gt;::iterator iter = mGeos.begin(); iter != mGeos.end(); iter++) { 
<a name="l00861"></a>00861         <span class="keywordflow">if</span>((*iter)-&gt;getAttributeList()-&gt;checkUnusedParams()) {
<a name="l00862"></a>00862             (*iter)-&gt;getAttributeList()-&gt;print(); <span class="comment">// DEBUG</span>
<a name="l00863"></a>00863             <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlScene::buildScene&quot;</span>,<span class="stringliteral">&quot;Unused params for object &#39;&quot;</span>&lt;&lt; (*iter)-&gt;getName() &lt;&lt;<span class="stringliteral">&quot;&#39; !&quot;</span>, <a class="code" href="../../de/df0/utilities_8h.html#a74894721e682bda2c22d5dacda988cad">SIMWORLD_INITERROR</a> );
<a name="l00864"></a>00864             <span class="keywordflow">return</span>;
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870 <span class="comment">/******************************************************************************</span>
<a name="l00871"></a>00871 <span class="comment"> * Prepare the scene triangles and maps for raytracing</span>
<a name="l00872"></a>00872 <span class="comment"> *****************************************************************************/</span>
<a name="l00873"></a><a class="code" href="../../dd/d46/classntlScene.html#a1b0b0dc9f277fde547a3637f687c9361">00873</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/d46/classntlScene.html#a1b0b0dc9f277fde547a3637f687c9361" title="Prepare the scene triangles and maps for raytracing.">ntlScene::prepareScene</a>(<span class="keywordtype">double</span> time)
<a name="l00874"></a>00874 {
<a name="l00875"></a>00875     <span class="comment">/* init triangles... */</span>
<a name="l00876"></a>00876     <a class="code" href="../../dd/d46/classntlScene.html#aeae84245423a31b212567b722225340d">buildScene</a>(time, <span class="keyword">false</span>);
<a name="l00877"></a>00877     <span class="comment">// what for currently not used ???</span>
<a name="l00878"></a>00878     <span class="keywordflow">if</span>(mpTree != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keyword">delete</span> mpTree;
<a name="l00879"></a>00879     mpTree = <span class="keyword">new</span> <a class="code" href="../../d7/d9b/classntlTree.html" title="Class for a bsp tree for triangles.">ntlTree</a>( 
<a name="l00880"></a>00880 #           <span class="keywordflow">if</span> <a class="code" href="../../d1/d24/solver__class_8h.html#a96bae72446ecaf0a3c3b9c81f2e4e966" title="debug coordinate accesses and the like? (much slower)">FSGR_STRICT_DEBUG</a>!=1
<a name="l00881"></a>00881             mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a3edb00bc3b944d01ac748f107355872d" title="get Maximum depth for BSP tree">getTreeMaxDepth</a>(), mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5a895282115dd22a4ec53a5b44743f14" title="get Maxmimum nr of triangles per BSP tree node">getTreeMaxTriangles</a>(), 
<a name="l00882"></a>00882 <span class="preprocessor">#           else</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>            mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a3edb00bc3b944d01ac748f107355872d" title="get Maximum depth for BSP tree">getTreeMaxDepth</a>()/3*2, mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5a895282115dd22a4ec53a5b44743f14" title="get Maxmimum nr of triangles per BSP tree node">getTreeMaxTriangles</a>()*2, 
<a name="l00884"></a>00884 <span class="preprocessor">#           endif</span>
<a name="l00885"></a>00885 <span class="preprocessor"></span>            <span class="keyword">this</span>, <a class="code" href="../../dc/dbe/ntl__ray_8h.html#ad16aabe4ad275186120f5fc48f7fe7a5">TRI_GEOMETRY</a> );
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     <span class="comment">//debMsgStd(&quot;ntlScene::prepareScene&quot;,DM_MSG,&quot;Stats - tris:&quot;&lt;&lt; (int)mTriangles.size()&lt;&lt;&quot; verts:&quot;&lt;&lt;mVertices.size()&lt;&lt;&quot; vnorms:&quot;&lt;&lt;mVertNormals.size(), 5 );</span>
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 <span class="comment">/******************************************************************************</span>
<a name="l00890"></a>00890 <span class="comment"> * Do some memory cleaning, when frame is finished</span>
<a name="l00891"></a>00891 <span class="comment"> *****************************************************************************/</span>
<a name="l00892"></a><a class="code" href="../../dd/d46/classntlScene.html#a77b604a1ec69f7205b39a143c77d7ee6">00892</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/d46/classntlScene.html#a77b604a1ec69f7205b39a143c77d7ee6" title="Do some memory cleaning, when frame is finished.">ntlScene::cleanupScene</a>( <span class="keywordtype">void</span> )
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894     mTriangles.clear();
<a name="l00895"></a>00895     mVertices.clear();
<a name="l00896"></a>00896     mVertNormals.clear();
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <span class="keywordflow">if</span>(mpTree != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keyword">delete</span> mpTree;
<a name="l00899"></a>00899     mpTree = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00900"></a>00900 }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="comment">/******************************************************************************</span>
<a name="l00904"></a>00904 <span class="comment"> * Intersect a ray with the scene triangles</span>
<a name="l00905"></a>00905 <span class="comment"> *****************************************************************************/</span>
<a name="l00906"></a><a class="code" href="../../dd/d46/classntlScene.html#a879f01c1b3b756fccce9f2f183120f1f">00906</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/d46/classntlScene.html#a879f01c1b3b756fccce9f2f183120f1f">ntlScene::intersectScene</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> &amp;r, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> &amp;<a class="code" href="../../d1/d22/stdosl_8h.html#a4d04eb0874bac8d51beb2f1d36fe6107">distance</a>, <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> &amp;normal, <a class="code" href="../../d8/da3/classntlTriangle.html">ntlTriangle</a> *&amp;tri,<span class="keywordtype">int</span> flags)<span class="keyword"> const</span>
<a name="l00907"></a>00907 <span class="keyword"></span>{
<a name="l00908"></a>00908     distance = -1.0;
<a name="l00909"></a>00909   mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a165a2600c3e9212b7c7c5b58425e6bea" title="Set the scenen intersection counter.">setCounterSceneInter</a>( mpGlob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a0aec52a0271565fc5877af29c30b234c" title="Return the scene intersection counter.">getCounterSceneInter</a>()+1 );
<a name="l00910"></a>00910     mpTree-&gt;<a class="code" href="../../d7/d9b/classntlTree.html#abb9c303733ddf0681d266efc55bf7e3d" title="intersect ray with BSPtree">intersect</a>(r, distance, normal, tri, flags, <span class="keyword">false</span>);
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:37 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
