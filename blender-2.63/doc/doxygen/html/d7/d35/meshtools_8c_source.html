<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: meshtools.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">meshtools.c</div>  </div>
</div>
<div class="contents">
<a href="../../d7/d35/meshtools_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2004 by Blender Foundation</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="comment">/*</span>
<a name="l00034"></a>00034 <span class="comment"> * meshtools.c: no editmode (violated already :), tools operating on meshes</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d41/DNA__key__types_8h.html">DNA_key_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span> <span class="comment">/* for randome face sorting */</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d0f/BKE__material_8h.html" title="General operations, lookup, etc. for materials.">BKE_material.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d37/BKE__multires_8h.html">BKE_multires.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d59/BLO__sys__types_8h.html">BLO_sys_types.h</a>&quot;</span> <span class="comment">// for intptr_t support</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7a/ED__object_8h.html">ED_object.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* own include */</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d5c/mesh__intern_8h.html">mesh_intern.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d48/uvedit__intern_8h.html">uvedit_intern.h</a>&quot;</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/* * ********************** no editmode!!! *********** */</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">/*********************** JOIN ***************************/</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">/* join selected meshes into the active mesh, context sensitive</span>
<a name="l00090"></a>00090 <span class="comment"> * return 0 if no join is made (error) and 1 if the join is done */</span>
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a5f9b33ba54119d964a670187c5a862db">00092</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ae634aabc7891dbbc75a8d50db827fd4e">join_mesh_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = <a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C);
<a name="l00095"></a>00095     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00096"></a>00096     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00097"></a>00097     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> **matar, *ma;
<a name="l00098"></a>00098     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00099"></a>00099     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert, *mv;
<a name="l00100"></a>00100     <a class="code" href="../../d6/ded/structMEdge.html">MEdge</a> *medge = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00101"></a>00101     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00102"></a>00102     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *mloop = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00103"></a>00103     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key, *nkey = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00104"></a>00104     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb, *okb, *kbn;
<a name="l00105"></a>00105     <span class="keywordtype">float</span> imat[4][4], cmat[4][4], *fp1, *fp2, curpos;
<a name="l00106"></a>00106     <span class="keywordtype">int</span> a, b, totcol, totmat = 0, totedge = 0, <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a> = 0, ok = 0;
<a name="l00107"></a>00107     <span class="keywordtype">int</span> totloop = 0, totpoly = 0, vertofs, *matmap = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00108"></a>00108     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, index, haskey = 0, edgeofs, loopofs, polyofs;
<a name="l00109"></a>00109     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg, *odg;
<a name="l00110"></a>00110     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert;
<a name="l00111"></a>00111     <a class="code" href="../../df/d04/structCustomData.html">CustomData</a> vdata, edata, fdata, ldata, pdata;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>) {
<a name="l00114"></a>00114         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Cant join while in editmode&quot;</span>);
<a name="l00115"></a>00115         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <span class="comment">/* ob is the object we are adding geometry to */</span>
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (!ob || ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00120"></a>00120         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Active object is not a mesh&quot;</span>);
<a name="l00121"></a>00121         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     <span class="comment">/* count &amp; check */</span>
<a name="l00125"></a>00125     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, selected_editable_bases) {
<a name="l00126"></a>00126         <span class="keywordflow">if</span> (base-&gt;object-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00127"></a>00127             me = base-&gt;object-&gt;data;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129             <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a> += me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00130"></a>00130             totedge += me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>;
<a name="l00131"></a>00131             totloop += me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>;
<a name="l00132"></a>00132             totpoly += me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>;
<a name="l00133"></a>00133             totmat += base-&gt;object-&gt;totcol;
<a name="l00134"></a>00134             
<a name="l00135"></a>00135             <span class="keywordflow">if</span> (base-&gt;object == ob)
<a name="l00136"></a>00136                 ok = 1;
<a name="l00137"></a>00137             
<a name="l00138"></a>00138             <span class="comment">/* check for shapekeys */</span>
<a name="l00139"></a>00139             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>)
<a name="l00140"></a>00140                 haskey++;
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00144"></a>00144     
<a name="l00145"></a>00145     <span class="comment">/* that way the active object is always selected */</span> 
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (ok == 0) {
<a name="l00147"></a>00147         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Active object is not a selected mesh&quot;</span>);
<a name="l00148"></a>00148         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150     
<a name="l00151"></a>00151     <span class="comment">/* only join meshes if there are verts to join, there aren&#39;t too many, and we only had one mesh selected */</span>
<a name="l00152"></a>00152     me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00153"></a>00153     key = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a> == 0 || <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a> == me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>) {
<a name="l00156"></a>00156         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;No mesh data to join&quot;</span>);
<a name="l00157"></a>00157         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a> &gt; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a8bf8170452d77e61032a6f0a0cb4620f">MESH_MAX_VERTS</a>) {
<a name="l00161"></a>00161         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Joining results in %d vertices, limit is &quot;</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a6df1d22fb5f09eccc23b9f399670cfd7">STRINGIFY</a>(<a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a8bf8170452d77e61032a6f0a0cb4620f">MESH_MAX_VERTS</a>), <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>);
<a name="l00162"></a>00162         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;      
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="comment">/* new material indices and material array */</span>
<a name="l00166"></a>00166     matar = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *) * totmat, <span class="stringliteral">&quot;join_mesh matar&quot;</span>);
<a name="l00167"></a>00167     <span class="keywordflow">if</span> (totmat) matmap = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * totmat, <span class="stringliteral">&quot;join_mesh matmap&quot;</span>);
<a name="l00168"></a>00168     totcol = ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>;
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     <span class="comment">/* obact materials in new main array, is nicer start! */</span>
<a name="l00171"></a>00171     <span class="keywordflow">for</span> (a = 0; a &lt; ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; a++) {
<a name="l00172"></a>00172         matar[a] = <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(ob, a + 1);
<a name="l00173"></a>00173         <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)matar[a]);
<a name="l00174"></a>00174         <span class="comment">/* increase id-&gt;us : will be lowered later */</span>
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="comment">/* - if destination mesh had shapekeys, move them somewhere safe, and set up placeholders</span>
<a name="l00178"></a>00178 <span class="comment">     *  with arrays that are large enough to hold shapekey data for all meshes</span>
<a name="l00179"></a>00179 <span class="comment">     * -    if destination mesh didn&#39;t have shapekeys, but we encountered some in the meshes we&#39;re </span>
<a name="l00180"></a>00180 <span class="comment">     *  joining, set up a new keyblock and assign to the mesh</span>
<a name="l00181"></a>00181 <span class="comment">     */</span>
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (key) {
<a name="l00183"></a>00183         <span class="comment">/* make a duplicate copy that will only be used here... (must remember to free it!) */</span>
<a name="l00184"></a>00184         nkey = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8fb643b558a887ed5f9b5020491e54aa">copy_key</a>(key);
<a name="l00185"></a>00185         
<a name="l00186"></a>00186         <span class="comment">/* for all keys in old block, clear data-arrays */</span>
<a name="l00187"></a>00187         <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00188"></a>00188             <span class="keywordflow">if</span> (kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>);
<a name="l00189"></a>00189             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>, <span class="stringliteral">&quot;join_shapekey&quot;</span>);
<a name="l00190"></a>00190             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>;
<a name="l00191"></a>00191             kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (haskey) {
<a name="l00195"></a>00195         <span class="comment">/* add a new key-block and add to the mesh */</span>
<a name="l00196"></a>00196         key = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a> = <a class="code" href="../../d5/d17/BKE__key_8h.html#a572a6d784e2dc2f6a88ad40435a7ddb5">add_key</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)me);
<a name="l00197"></a>00197         key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> = <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>;
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     <span class="comment">/* first pass over objects - copying materials and vertexgroups across */</span>
<a name="l00201"></a>00201     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, selected_editable_bases)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203         <span class="comment">/* only act if a mesh, and not the one we&#39;re joining to */</span>
<a name="l00204"></a>00204         <span class="keywordflow">if</span> ((ob != base-&gt;object) &amp;&amp; (base-&gt;object-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>)) {
<a name="l00205"></a>00205             me = base-&gt;object-&gt;data;
<a name="l00206"></a>00206             
<a name="l00207"></a>00207             <span class="comment">/* Join this object&#39;s vertex groups to the base one&#39;s */</span>
<a name="l00208"></a>00208             <span class="keywordflow">for</span> (dg = base-&gt;object-&gt;defbase.first; dg; dg = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>) {
<a name="l00209"></a>00209                 <span class="comment">/* See if this group exists in the object (if it doesn&#39;t, add it to the end) */</span>
<a name="l00210"></a>00210                 <span class="keywordflow">if</span> (!<a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob, dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>)) {
<a name="l00211"></a>00211                     odg = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a>), <span class="stringliteral">&quot;join deformGroup&quot;</span>);
<a name="l00212"></a>00212                     memcpy(odg, dg, <span class="keyword">sizeof</span>(<a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a>));
<a name="l00213"></a>00213                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>, odg);
<a name="l00214"></a>00214                 }
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> == 0)
<a name="l00217"></a>00217                 ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> = 1;
<a name="l00218"></a>00218             
<a name="l00219"></a>00219             
<a name="l00220"></a>00220             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>) {
<a name="l00221"></a>00221                 <span class="comment">/* Add this object&#39;s materials to the base one&#39;s if they don&#39;t exist already (but only if limits not exceeded yet) */</span>
<a name="l00222"></a>00222                 <span class="keywordflow">if</span> (totcol &lt; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ff476c1139fb6a63d420b961ec849f1">MAXMAT</a>) {
<a name="l00223"></a>00223                     <span class="keywordflow">for</span> (a = 1; a &lt;= base-&gt;object-&gt;totcol; a++) {
<a name="l00224"></a>00224                         ma = <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(base-&gt;object, a);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226                         <span class="keywordflow">for</span> (b = 0; b &lt; totcol; b++) {
<a name="l00227"></a>00227                             <span class="keywordflow">if</span> (ma == matar[b]) <span class="keywordflow">break</span>;
<a name="l00228"></a>00228                         }
<a name="l00229"></a>00229                         <span class="keywordflow">if</span> (b == totcol) {
<a name="l00230"></a>00230                             matar[b] = ma;
<a name="l00231"></a>00231                             <span class="keywordflow">if</span> (ma) {
<a name="l00232"></a>00232                                 <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a3fc06eed9b3244922dd05906dcc58cde">id</a>);
<a name="l00233"></a>00233                             }
<a name="l00234"></a>00234                             totcol++;
<a name="l00235"></a>00235                         }
<a name="l00236"></a>00236                         <span class="keywordflow">if</span> (totcol &gt;= <a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ff476c1139fb6a63d420b961ec849f1">MAXMAT</a>)
<a name="l00237"></a>00237                             <span class="keywordflow">break</span>;
<a name="l00238"></a>00238                     }
<a name="l00239"></a>00239                 }
<a name="l00240"></a>00240                 
<a name="l00241"></a>00241                 <span class="comment">/* if this mesh has shapekeys, check if destination mesh already has matching entries too */</span>
<a name="l00242"></a>00242                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a> &amp;&amp; key) {
<a name="l00243"></a>00243                     <span class="keywordflow">for</span> (kb = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00244"></a>00244                         <span class="comment">/* if key doesn&#39;t exist in destination mesh, add it */</span>
<a name="l00245"></a>00245                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d17/BKE__key_8h.html#a0b9d3a0e7ee3c7208fac589ebed998a8">key_get_named_keyblock</a>(key, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00246"></a>00246                             <span class="comment">/* copy this existing one over to the new shapekey block */</span>
<a name="l00247"></a>00247                             kbn = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(kb);
<a name="l00248"></a>00248                             kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a1b6ca93b4a4aaba67a6871533a843392">prev</a> = kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00249"></a>00249                             
<a name="l00250"></a>00250                             <span class="comment">/* adjust settings to fit (allocate a new data-array) */</span>
<a name="l00251"></a>00251                             kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>, <span class="stringliteral">&quot;joined_shapekey&quot;</span>);
<a name="l00252"></a>00252                             kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a48866fbfcc064f4777e2d2841ce42fe4">totelem</a> = <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>;
<a name="l00253"></a>00253                             kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#abda21fe031a8e4727049c5feac82fe5a">weights</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00254"></a>00254                             
<a name="l00255"></a>00255                             okb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00256"></a>00256                             curpos = (okb) ? okb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> : -0.1f;
<a name="l00257"></a>00257                             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#af4673161e52f45eb6c8efc3ea71939fa">type</a> == <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>)
<a name="l00258"></a>00258                                 kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> = curpos + 0.1f;
<a name="l00259"></a>00259                             <span class="keywordflow">else</span>
<a name="l00260"></a>00260                                 kbn-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a5003a4f223b4bc0aa395b50f11a67fcc">pos</a> = curpos;
<a name="l00261"></a>00261                             
<a name="l00262"></a>00262                             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kbn);
<a name="l00263"></a>00263                             key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a21e6fccec22d25490e947c74e127f2e7">totkey</a>++;
<a name="l00264"></a>00264                             <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d1/d9e/structKey.html#a21e6fccec22d25490e947c74e127f2e7">totkey</a> == 1) key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ac66292f02aa3b6c694a1fcd14e4218e2">refkey</a> = kbn;
<a name="l00265"></a>00265                             
<a name="l00266"></a>00266                             <span class="comment">// XXX 2.5 Animato</span>
<a name="l00267"></a>00267 <span class="preprocessor">#if 0</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>                            <span class="comment">/* also, copy corresponding ipo-curve to ipo-block if applicable */</span>
<a name="l00269"></a>00269                             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>-&gt;ipo &amp;&amp; key-&gt;ipo) {
<a name="l00270"></a>00270                                 <span class="comment">// FIXME... this is a luxury item!</span>
<a name="l00271"></a>00271                                 puts(<span class="stringliteral">&quot;FIXME: ignoring IPO&#39;s when joining shapekeys on Meshes for now...&quot;</span>);
<a name="l00272"></a>00272                             }
<a name="l00273"></a>00273 <span class="preprocessor">#endif</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>                        }
<a name="l00275"></a>00275                     }
<a name="l00276"></a>00276                 }
<a name="l00277"></a>00277             }
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00281"></a>00281     
<a name="l00282"></a>00282     <span class="comment">/* setup new data for destination mesh */</span>
<a name="l00283"></a>00283     memset(&amp;vdata, 0, <span class="keyword">sizeof</span>(vdata));
<a name="l00284"></a>00284     memset(&amp;edata, 0, <span class="keyword">sizeof</span>(edata));
<a name="l00285"></a>00285     memset(&amp;fdata, 0, <span class="keyword">sizeof</span>(fdata));
<a name="l00286"></a>00286     memset(&amp;ldata, 0, <span class="keyword">sizeof</span>(ldata));
<a name="l00287"></a>00287     memset(&amp;pdata, 0, <span class="keyword">sizeof</span>(pdata));
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     mvert = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;vdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aeaf3e06503363d78080a7e479645964d">CD_MVERT</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>);
<a name="l00290"></a>00290     medge = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;edata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a656806a32e0c556097f3fd15e872aa19">CD_MEDGE</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, totedge);
<a name="l00291"></a>00291     mloop = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;ldata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a954e0eba673d507df6a5210a389364f5">CD_MLOOP</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, totloop);
<a name="l00292"></a>00292     mpoly = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;pdata, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a05108c9597b8051246fc8fbc09caa56d">CD_CALLOC</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, totpoly);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     vertofs = 0;
<a name="l00295"></a>00295     edgeofs = 0;
<a name="l00296"></a>00296     loopofs = 0;
<a name="l00297"></a>00297     polyofs = 0;
<a name="l00298"></a>00298     
<a name="l00299"></a>00299     <span class="comment">/* inverse transform for all selected meshes in this object */</span>
<a name="l00300"></a>00300     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00301"></a>00301     
<a name="l00302"></a>00302     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, selected_editable_bases)
<a name="l00303"></a>00303     {
<a name="l00304"></a>00304         <span class="comment">/* only join if this is a mesh */</span>
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (base-&gt;object-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00306"></a>00306             me = base-&gt;object-&gt;data;
<a name="l00307"></a>00307             
<a name="l00308"></a>00308             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>) {
<a name="l00309"></a>00309                 <span class="comment">/* standard data */</span>
<a name="l00310"></a>00310                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa46e0b153272a33dad4550379e5f7955">CustomData_merge</a>(&amp;me-&gt;vdata, &amp;vdata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>);
<a name="l00311"></a>00311                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;me-&gt;vdata, &amp;vdata, 0, vertofs, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l00312"></a>00312                 
<a name="l00313"></a>00313                 <span class="comment">/* vertex groups */</span>
<a name="l00314"></a>00314                 dvert = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ad7c68e821437b13392ebdd3f7a41faf0">CustomData_get</a>(&amp;vdata, vertofs, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a46e655a33ee15daada322dea203b832a">CD_MDEFORMVERT</a>);
<a name="l00315"></a>00315                 
<a name="l00316"></a>00316                 <span class="comment">/* NB: vertex groups here are new version */</span>
<a name="l00317"></a>00317                 <span class="keywordflow">if</span> (dvert) {
<a name="l00318"></a>00318                     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; i++) {
<a name="l00319"></a>00319                         <span class="keywordflow">for</span> (j = 0; j &lt; dvert[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; j++) {
<a name="l00320"></a>00320                             <span class="comment">/*  Find the old vertex group */</span>
<a name="l00321"></a>00321                             odg = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;base-&gt;object-&gt;defbase, dvert[i].<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[j].<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>);
<a name="l00322"></a>00322                             <span class="keywordflow">if</span> (odg) {
<a name="l00323"></a>00323                                 <span class="comment">/*  Search for a match in the new object, and set new index */</span>
<a name="l00324"></a>00324                                 <span class="keywordflow">for</span> (dg = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, index = 0; dg; dg = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>, index++) {
<a name="l00325"></a>00325                                     <span class="keywordflow">if</span> (!strcmp(dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, odg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>)) {
<a name="l00326"></a>00326                                         dvert[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[j].<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> = index;
<a name="l00327"></a>00327                                         <span class="keywordflow">break</span>;
<a name="l00328"></a>00328                                     }
<a name="l00329"></a>00329                                 }
<a name="l00330"></a>00330                             }
<a name="l00331"></a>00331                         }
<a name="l00332"></a>00332                     }
<a name="l00333"></a>00333                 }
<a name="l00334"></a>00334                 
<a name="l00335"></a>00335                 <span class="comment">/* if this is the object we&#39;re merging into, no need to do anything */</span>
<a name="l00336"></a>00336                 <span class="keywordflow">if</span> (base-&gt;object != ob) {
<a name="l00337"></a>00337                     <span class="comment">/* watch this: switch matmul order really goes wrong */</span>
<a name="l00338"></a>00338                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(cmat, imat, base-&gt;object-&gt;obmat);
<a name="l00339"></a>00339                     
<a name="l00340"></a>00340                     <span class="comment">/* transform vertex coordinates into new space */</span>
<a name="l00341"></a>00341                     <span class="keywordflow">for</span> (a = 0, mv = mvert; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, mv++) {
<a name="l00342"></a>00342                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cmat, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00343"></a>00343                     }
<a name="l00344"></a>00344                     
<a name="l00345"></a>00345                     <span class="comment">/* for each shapekey in destination mesh:</span>
<a name="l00346"></a>00346 <span class="comment">                     *  - if there&#39;s a matching one, copy it across (will need to transform vertices into new space...)</span>
<a name="l00347"></a>00347 <span class="comment">                     *  - otherwise, just copy own coordinates of mesh (no need to transform vertex coordinates into new space)</span>
<a name="l00348"></a>00348 <span class="comment">                     */</span>
<a name="l00349"></a>00349                     <span class="keywordflow">if</span> (key) {
<a name="l00350"></a>00350                         <span class="comment">/* if this mesh has any shapekeys, check first, otherwise just copy coordinates */</span>
<a name="l00351"></a>00351                         <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00352"></a>00352                             <span class="comment">/* get pointer to where to write data for this mesh in shapekey&#39;s data array */</span>
<a name="l00353"></a>00353                             fp1 = ((<span class="keywordtype">float</span> *)kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) + (vertofs * 3);
<a name="l00354"></a>00354                             
<a name="l00355"></a>00355                             <span class="comment">/* check if this mesh has such a shapekey */</span>
<a name="l00356"></a>00356                             okb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a0b9d3a0e7ee3c7208fac589ebed998a8">key_get_named_keyblock</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>);
<a name="l00357"></a>00357                             <span class="keywordflow">if</span> (okb) {
<a name="l00358"></a>00358                                 <span class="comment">/* copy this mesh&#39;s shapekey to the destination shapekey (need to transform first) */</span>
<a name="l00359"></a>00359                                 fp2 = ((<span class="keywordtype">float</span> *)(okb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>));
<a name="l00360"></a>00360                                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, fp1 += 3, fp2 += 3) {
<a name="l00361"></a>00361                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp1, fp2);
<a name="l00362"></a>00362                                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(cmat, fp1);
<a name="l00363"></a>00363                                 }
<a name="l00364"></a>00364                             }
<a name="l00365"></a>00365                             <span class="keywordflow">else</span> {
<a name="l00366"></a>00366                                 <span class="comment">/* copy this mesh&#39;s vertex coordinates to the destination shapekey */</span>
<a name="l00367"></a>00367                                 mv = mvert;
<a name="l00368"></a>00368                                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, fp1 += 3, mv++) {
<a name="l00369"></a>00369                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp1, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00370"></a>00370                                 }
<a name="l00371"></a>00371                             }
<a name="l00372"></a>00372                         }
<a name="l00373"></a>00373                     }
<a name="l00374"></a>00374                 }
<a name="l00375"></a>00375                 <span class="keywordflow">else</span> {
<a name="l00376"></a>00376                     <span class="comment">/* for each shapekey in destination mesh:</span>
<a name="l00377"></a>00377 <span class="comment">                     *  - if it was an &#39;original&#39;, copy the appropriate data from nkey</span>
<a name="l00378"></a>00378 <span class="comment">                     *  - otherwise, copy across plain coordinates (no need to transform coordinates)</span>
<a name="l00379"></a>00379 <span class="comment">                     */</span>
<a name="l00380"></a>00380                     <span class="keywordflow">if</span> (key) {
<a name="l00381"></a>00381                         <span class="keywordflow">for</span> (kb = key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kb; kb = kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#ac20a23b2cb5a21986a4c762933f8a95b">next</a>) {
<a name="l00382"></a>00382                             <span class="comment">/* get pointer to where to write data for this mesh in shapekey&#39;s data array */</span>
<a name="l00383"></a>00383                             fp1 = ((<span class="keywordtype">float</span> *)kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>) + (vertofs * 3);
<a name="l00384"></a>00384                             
<a name="l00385"></a>00385                             <span class="comment">/* check if this was one of the original shapekeys */</span>
<a name="l00386"></a>00386                             okb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a0b9d3a0e7ee3c7208fac589ebed998a8">key_get_named_keyblock</a>(nkey, kb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>);
<a name="l00387"></a>00387                             <span class="keywordflow">if</span> (okb) {
<a name="l00388"></a>00388                                 <span class="comment">/* copy this mesh&#39;s shapekey to the destination shapekey */</span>
<a name="l00389"></a>00389                                 fp2 = ((<span class="keywordtype">float</span> *)(okb-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#aec4b55f1b0c4c1e0c60a77f7ffb80401">data</a>));
<a name="l00390"></a>00390                                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, fp1 += 3, fp2 += 3) {
<a name="l00391"></a>00391                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp1, fp2);
<a name="l00392"></a>00392                                 }
<a name="l00393"></a>00393                             }
<a name="l00394"></a>00394                             <span class="keywordflow">else</span> {
<a name="l00395"></a>00395                                 <span class="comment">/* copy base-coordinates to the destination shapekey */</span>
<a name="l00396"></a>00396                                 mv = mvert;
<a name="l00397"></a>00397                                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, fp1 += 3, mv++) {
<a name="l00398"></a>00398                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(fp1, mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>);
<a name="l00399"></a>00399                                 }
<a name="l00400"></a>00400                             }
<a name="l00401"></a>00401                         }
<a name="l00402"></a>00402                     }
<a name="l00403"></a>00403                 }
<a name="l00404"></a>00404                 
<a name="l00405"></a>00405                 <span class="comment">/* advance mvert pointer to end of base mesh&#39;s data */</span>
<a name="l00406"></a>00406                 mvert += me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408             
<a name="l00409"></a>00409             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>) {
<a name="l00410"></a>00410                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa46e0b153272a33dad4550379e5f7955">CustomData_merge</a>(&amp;me-&gt;edata, &amp;edata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, totedge);
<a name="l00411"></a>00411                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;me-&gt;edata, &amp;edata, 0, edgeofs, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>);
<a name="l00412"></a>00412                 
<a name="l00413"></a>00413                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>; a++, medge++) {
<a name="l00414"></a>00414                     medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a42030809efbf6c6d2b3fe156966075fd">v1</a> += vertofs;
<a name="l00415"></a>00415                     medge-&gt;<a class="code" href="../../d6/ded/structMEdge.html#a62ddab48309048adbaea38a5d4f5ebaa">v2</a> += vertofs;
<a name="l00416"></a>00416                 }
<a name="l00417"></a>00417             }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>) {
<a name="l00420"></a>00420                 <span class="keywordflow">if</span> (base-&gt;object != ob)
<a name="l00421"></a>00421                     <a class="code" href="../../d1/d37/BKE__multires_8h.html#a8b9578c1caa1e443f9d7e9020c68ccab">multiresModifier_prepare_join</a>(scene, base-&gt;object, ob);
<a name="l00422"></a>00422                 
<a name="l00423"></a>00423                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa46e0b153272a33dad4550379e5f7955">CustomData_merge</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;ldata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, totloop);
<a name="l00424"></a>00424                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, &amp;ldata, 0, loopofs, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00425"></a>00425                 
<a name="l00426"></a>00426                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; a++, mloop++) {
<a name="l00427"></a>00427                     mloop-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a> += vertofs;
<a name="l00428"></a>00428                     mloop-&gt;<a class="code" href="../../d7/d72/structMLoop.html#aac384cc2036c69025c5574e665ee85f4">e</a> += edgeofs;
<a name="l00429"></a>00429                 }
<a name="l00430"></a>00430             }
<a name="l00431"></a>00431             
<a name="l00432"></a>00432             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l00433"></a>00433                 <span class="comment">/* make mapping for materials */</span>
<a name="l00434"></a>00434                 <span class="keywordflow">for</span> (a = 1; a &lt;= base-&gt;object-&gt;totcol; a++) {
<a name="l00435"></a>00435                     ma = <a class="code" href="../../d4/d0f/BKE__material_8h.html#a941f5112d1047bcbcf3e2212685296a5">give_current_material</a>(base-&gt;object, a);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                     <span class="keywordflow">for</span> (b = 0; b &lt; totcol; b++) {
<a name="l00438"></a>00438                         <span class="keywordflow">if</span> (ma == matar[b]) {
<a name="l00439"></a>00439                             matmap[a - 1] = b;
<a name="l00440"></a>00440                             <span class="keywordflow">break</span>;
<a name="l00441"></a>00441                         }
<a name="l00442"></a>00442                     }
<a name="l00443"></a>00443                 }
<a name="l00444"></a>00444                 
<a name="l00445"></a>00445                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#aa46e0b153272a33dad4550379e5f7955">CustomData_merge</a>(&amp;me-&gt;pdata, &amp;pdata, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a7567efbca3712fc24b23bbe17a945322">CD_MASK_MESH</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, totpoly);
<a name="l00446"></a>00446                 <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af1e725b5bdefd0984a84f2b7734af349">CustomData_copy_data</a>(&amp;me-&gt;pdata, &amp;pdata, 0, polyofs, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>);
<a name="l00447"></a>00447                 
<a name="l00448"></a>00448                 <span class="keywordflow">for</span> (a = 0; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; a++, mpoly++) {
<a name="l00449"></a>00449                     mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> += loopofs;
<a name="l00450"></a>00450                     mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#afaa3e20eadbc3dfe52d47c0a10dd0c7f">mat_nr</a> = matmap ? matmap[(int)mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#afaa3e20eadbc3dfe52d47c0a10dd0c7f">mat_nr</a>] : 0;
<a name="l00451"></a>00451                 }
<a name="l00452"></a>00452                 
<a name="l00453"></a>00453                 polyofs += me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>;
<a name="l00454"></a>00454             }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456             <span class="comment">/* these are used for relinking (cannot be set earlier, </span>
<a name="l00457"></a>00457 <span class="comment">             * or else reattaching goes wrong)</span>
<a name="l00458"></a>00458 <span class="comment">             */</span>
<a name="l00459"></a>00459             vertofs += me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00460"></a>00460             edgeofs += me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>;
<a name="l00461"></a>00461             loopofs += me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>;
<a name="l00462"></a>00462             
<a name="l00463"></a>00463             <span class="comment">/* free base, now that data is merged */</span>
<a name="l00464"></a>00464             <span class="keywordflow">if</span> (base-&gt;object != ob)
<a name="l00465"></a>00465                 <a class="code" href="../../da/d7a/ED__object_8h.html#af606d9df3349e6cc4267296011bf4f12">ED_base_object_free_and_unlink</a>(bmain, scene, base);
<a name="l00466"></a>00466         }
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00469"></a>00469     
<a name="l00470"></a>00470     <span class="comment">/* return to mesh we&#39;re merging to */</span>
<a name="l00471"></a>00471     me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00472"></a>00472     
<a name="l00473"></a>00473     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;vdata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l00474"></a>00474     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;edata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a>);
<a name="l00475"></a>00475     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l00476"></a>00476     <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a0ccefe4320d605b7cb632fa86bbb0ef1">CustomData_free</a>(&amp;me-&gt;pdata, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> = <a class="code" href="../../d1/d52/structLaplacianSystem.html#a8d5b057906fd82ad56e5a64489b4b4ef">totvert</a>;
<a name="l00479"></a>00479     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a686df37ba278d2bdc080e4d5a0f70dd5">totedge</a> = totedge;
<a name="l00480"></a>00480     me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a> = totloop;
<a name="l00481"></a>00481     me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> = totpoly;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     me-&gt;vdata = vdata;
<a name="l00484"></a>00484     me-&gt;edata = edata;
<a name="l00485"></a>00485     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a> = ldata;
<a name="l00486"></a>00486     me-&gt;pdata = pdata;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#adc8217e8a6385eec61318e5f7489b462">mesh_update_customdata_pointers</a>(me, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>); <span class="comment">/* BMESH_TODO, check if this arg can be failse, non urgent - campbell */</span>
<a name="l00489"></a>00489     
<a name="l00490"></a>00490     <span class="comment">/* old material array */</span>
<a name="l00491"></a>00491     <span class="keywordflow">for</span> (a = 1; a &lt;= ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>; a++) {
<a name="l00492"></a>00492         ma = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a545b54048d299d5d9b5f49d6a80f1a9f">mat</a>[a - 1];
<a name="l00493"></a>00493         <span class="keywordflow">if</span> (ma) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a3fc06eed9b3244922dd05906dcc58cde">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="keywordflow">for</span> (a = 1; a &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac7bd892579cf8a793973b2ce2491ec06">totcol</a>; a++) {
<a name="l00496"></a>00496         ma = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a4fdee04a24d1a821f3bfa659b3bd8156">mat</a>[a - 1];
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (ma) ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a3fc06eed9b3244922dd05906dcc58cde">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a545b54048d299d5d9b5f49d6a80f1a9f">mat</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a545b54048d299d5d9b5f49d6a80f1a9f">mat</a>);
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a58e55b421436f3c376299a2179619150">matbits</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a58e55b421436f3c376299a2179619150">matbits</a>);
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a4fdee04a24d1a821f3bfa659b3bd8156">mat</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a4fdee04a24d1a821f3bfa659b3bd8156">mat</a>);
<a name="l00502"></a>00502     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a545b54048d299d5d9b5f49d6a80f1a9f">mat</a> = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a4fdee04a24d1a821f3bfa659b3bd8156">mat</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00503"></a>00503     ob-&gt;<a class="code" href="../../de/de7/structObject.html#a58e55b421436f3c376299a2179619150">matbits</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00504"></a>00504     
<a name="l00505"></a>00505     <span class="keywordflow">if</span> (totcol) {
<a name="l00506"></a>00506         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a4fdee04a24d1a821f3bfa659b3bd8156">mat</a> = matar;
<a name="l00507"></a>00507         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a545b54048d299d5d9b5f49d6a80f1a9f">mat</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *) * totcol, <span class="stringliteral">&quot;join obmatar&quot;</span>);
<a name="l00508"></a>00508         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a58e55b421436f3c376299a2179619150">matbits</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * totcol, <span class="stringliteral">&quot;join obmatbits&quot;</span>);
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510     <span class="keywordflow">else</span>
<a name="l00511"></a>00511         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(matar);
<a name="l00512"></a>00512     
<a name="l00513"></a>00513     ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a> = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac7bd892579cf8a793973b2ce2491ec06">totcol</a> = totcol;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (matmap) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(matmap);
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     <span class="comment">/* other mesh users */</span>
<a name="l00518"></a>00518     <a class="code" href="../../d4/d0f/BKE__material_8h.html#ac2bb0bdbe524ea6b63503a1d9540a522">test_object_materials</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)me);
<a name="l00519"></a>00519     
<a name="l00520"></a>00520     <span class="comment">/* free temp copy of destination shapekeys (if applicable) */</span>
<a name="l00521"></a>00521     <span class="keywordflow">if</span> (nkey) {
<a name="l00522"></a>00522         <span class="comment">// XXX 2.5 Animato</span>
<a name="l00523"></a>00523 <span class="preprocessor">#if 0</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>        <span class="comment">/* free it&#39;s ipo too - both are not actually freed from memory yet as ID-blocks */</span>
<a name="l00525"></a>00525         <span class="keywordflow">if</span> (nkey-&gt;ipo) {
<a name="l00526"></a>00526             <a class="code" href="../../db/d48/BKE__ipo_8h.html#a695b4e38f6038c948ae6077436343cf6">free_ipo</a>(nkey-&gt;ipo);
<a name="l00527"></a>00527             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a506519dfdc231b82be806d4b53a09a4c">ipo</a>, nkey-&gt;ipo);
<a name="l00528"></a>00528             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nkey-&gt;ipo);
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530 <span class="preprocessor">#endif</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>        
<a name="l00532"></a>00532         <a class="code" href="../../d5/d17/BKE__key_8h.html#a0fbd53478c90d90e72e93775bd6dde4b">free_key</a>(nkey);
<a name="l00533"></a>00533         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a1194bb31422b5ad4cd169ea17a08c0a6">key</a>, nkey);
<a name="l00534"></a>00534         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nkey);
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     
<a name="l00537"></a>00537     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a1916587a9ec19eb3543b1c1bc54a8ded">DAG_scene_sort</a>(bmain, scene);   <span class="comment">// removed objects, need to rebuild dag before editmode call</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 <span class="preprocessor">#if 0</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span>    <a class="code" href="../../da/d7a/ED__object_8h.html#abf5a8346ea6543e8d977bfe1358c5c35">ED_object_enter_editmode</a>(C, <a class="code" href="../../da/d7a/ED__object_8h.html#a660a08f2196e720360e276ccf8125171">EM_WAITCURSOR</a>);
<a name="l00541"></a>00541     <a class="code" href="../../da/d7a/ED__object_8h.html#a3dc41f10c2da040464140768d2898865">ED_object_exit_editmode</a>(C, <a class="code" href="../../da/d7a/ED__object_8h.html#a56f58f037f42277d234426571ee2de12">EM_FREEDATA</a> | <a class="code" href="../../da/d7a/ED__object_8h.html#a660a08f2196e720360e276ccf8125171">EM_WAITCURSOR</a> | <a class="code" href="../../da/d7a/ED__object_8h.html#a58e84e1ebbb3942ca4d7722b6c19c61d">EM_DO_UNDO</a>);
<a name="l00542"></a>00542 <span class="preprocessor">#else</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>    <span class="comment">/* toggle editmode using lower level functions so this can be called from python */</span>
<a name="l00544"></a>00544     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ad0ae502cbe75c98b006bf5864e8a5dfe">EDBM_mesh_make</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>, scene, ob);
<a name="l00545"></a>00545     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a49439770c1f71ab91942cc040effcca0">EDBM_mesh_load</a>(ob);
<a name="l00546"></a>00546     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a02b853112680711d30075d378c60e77c">EDBM_mesh_free</a>(me-&gt;edit_btmesh);
<a name="l00547"></a>00547     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(me-&gt;edit_btmesh);
<a name="l00548"></a>00548     me-&gt;edit_btmesh = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00549"></a>00549     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a189b3a96923b2425ee7c0990c0b3fd20">OB_RECALC_OB</a> | <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l00550"></a>00550 <span class="preprocessor">#endif</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>    <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2072407a0c536bf373bd0b6b7c159c5c">ND_OB_ACTIVE</a>, scene);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="comment">/*********************** JOIN AS SHAPES ***************************/</span>
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <span class="comment">/* Append selected meshes vertex locations as shapes of the active mesh, </span>
<a name="l00559"></a>00559 <span class="comment"> * return 0 if no join is made (error) and 1 of the join is done */</span>
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a92a5a37d0e34503db166481e7d7cbec6">00561</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aa196d9e419c7068ab85c9f1ae2ebac5a">join_mesh_shapes_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00564"></a>00564     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00565"></a>00565     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00566"></a>00566     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *selme = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00567"></a>00567     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00568"></a>00568     <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a>;
<a name="l00569"></a>00569     <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb;
<a name="l00570"></a>00570     <span class="keywordtype">int</span> ok = 0, nonequal_verts = 0;
<a name="l00571"></a>00571     
<a name="l00572"></a>00572     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, selected_editable_bases) {
<a name="l00573"></a>00573         <span class="keywordflow">if</span> (base-&gt;object == ob) <span class="keywordflow">continue</span>;
<a name="l00574"></a>00574         
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (base-&gt;object-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00576"></a>00576             selme = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)base-&gt;object-&gt;data;
<a name="l00577"></a>00577             
<a name="l00578"></a>00578             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (selme-&gt;totvert == me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>)
<a name="l00579"></a>00579                 ok++;
<a name="l00580"></a>00580             <span class="keywordflow">else</span>
<a name="l00581"></a>00581                 nonequal_verts = 1;
<a name="l00582"></a>00582         }
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00585"></a>00585     
<a name="l00586"></a>00586     <span class="keywordflow">if</span> (!ok) {
<a name="l00587"></a>00587         <span class="keywordflow">if</span> (nonequal_verts)
<a name="l00588"></a>00588             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Selected meshes must have equal numbers of vertices&quot;</span>);
<a name="l00589"></a>00589         <span class="keywordflow">else</span>
<a name="l00590"></a>00590             <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;No additional selected meshes with equal vertex count to join&quot;</span>);
<a name="l00591"></a>00591         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l00592"></a>00592     }
<a name="l00593"></a>00593     
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (key == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00595"></a>00595         key = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad5e8f2b7e52cbc5caf836c656db83589">key</a> = <a class="code" href="../../d5/d17/BKE__key_8h.html#a572a6d784e2dc2f6a88ad40435a7ddb5">add_key</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)me);
<a name="l00596"></a>00596         key-&gt;type = <a class="code" href="../../de/d41/DNA__key__types_8h.html#a14061dd054afd472999a4f4f6cdf3923a166121abc12de1fb379b9e6956f45c67">KEY_RELATIVE</a>;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <span class="comment">/* first key added, so it was the basis. initialize it with the existing mesh */</span>
<a name="l00599"></a>00599         kb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a118d62c847e0e2e8423ee54247fd3128">add_keyblock</a>(key, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00600"></a>00600         <a class="code" href="../../d5/d17/BKE__key_8h.html#a8ec9247863e7792c9cb12f6e075341f6">mesh_to_key</a>(me, kb);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602     
<a name="l00603"></a>00603     <span class="comment">/* now ready to add new keys from selected meshes */</span>
<a name="l00604"></a>00604     <a class="code" href="../../df/d01/BKE__context_8h.html#a63ffcaf5af72270fb66c773139bdedb2">CTX_DATA_BEGIN</a>(C, <a class="code" href="../../d3/da9/structBase.html">Base</a> *, base, selected_editable_bases)
<a name="l00605"></a>00605     {
<a name="l00606"></a>00606         <span class="keywordflow">if</span> (base-&gt;object == ob) <span class="keywordflow">continue</span>;
<a name="l00607"></a>00607         
<a name="l00608"></a>00608         <span class="keywordflow">if</span> (base-&gt;object-&gt;type == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a>) {
<a name="l00609"></a>00609             selme = (<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)base-&gt;object-&gt;data;
<a name="l00610"></a>00610             
<a name="l00611"></a>00611             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (selme-&gt;totvert == me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>) {
<a name="l00612"></a>00612                 dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a0cb599f3f397fcb5f99b02677bf3b0ec">mesh_get_derived_deform</a>(scene, base-&gt;object, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l00613"></a>00613                 
<a name="l00614"></a>00614                 <span class="keywordflow">if</span> (!dm) <span class="keywordflow">continue</span>;
<a name="l00615"></a>00615                     
<a name="l00616"></a>00616                 kb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a118d62c847e0e2e8423ee54247fd3128">add_keyblock</a>(key, base-&gt;object-&gt;id.name + 2);
<a name="l00617"></a>00617                 
<a name="l00618"></a>00618                 <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#aebd0bdc75ce6be70e08f6b3026b2694c">DM_to_meshkey</a>(dm, me, kb);
<a name="l00619"></a>00619                 
<a name="l00620"></a>00620                 dm-&gt;release(dm);
<a name="l00621"></a>00621             }
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624     <a class="code" href="../../df/d01/BKE__context_8h.html#af19e54c354c69aacc4c6f2e2fcafde0f">CTX_DATA_END</a>;
<a name="l00625"></a>00625     
<a name="l00626"></a>00626     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2072407a0c536bf373bd0b6b7c159c5c">ND_OB_ACTIVE</a>, scene);
<a name="l00627"></a>00627     
<a name="l00628"></a>00628     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="comment">/* ********************* MESH VERTEX OCTREE LOOKUP ************* */</span>
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="comment">/* important note; this is unfinished, needs better API for editmode, and custom threshold */</span>
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">00635</a> <span class="preprocessor">#define MOC_RES         8</span>
<a name="l00636"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a51ebb3c25af3926ebefbe14451bbbd91">00636</a> <span class="preprocessor"></span><span class="preprocessor">#define MOC_NODE_RES    8</span>
<a name="l00637"></a><a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">00637</a> <span class="preprocessor"></span><span class="preprocessor">#define MOC_THRESH      0.00002f</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span>
<a name="l00639"></a><a class="code" href="../../da/d34/structMocNode.html">00639</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d34/structMocNode.html">MocNode</a> {
<a name="l00640"></a><a class="code" href="../../da/d34/structMocNode.html#a14f449645f736deefcdc2f62723f6bf2">00640</a>     <span class="keyword">struct </span><a class="code" href="../../da/d34/structMocNode.html">MocNode</a> *<a class="code" href="../../da/d34/structMocNode.html#a14f449645f736deefcdc2f62723f6bf2">next</a>;
<a name="l00641"></a><a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">00641</a>     intptr_t <a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">index</a>[<a class="code" href="../../d7/d35/meshtools_8c.html#a51ebb3c25af3926ebefbe14451bbbd91">MOC_NODE_RES</a>];
<a name="l00642"></a>00642 } <a class="code" href="../../d7/d35/meshtools_8c.html#a6c291aa5183580aa20b7f91b9480c37a">MocNode</a>;
<a name="l00643"></a>00643 
<a name="l00644"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a6b96c1de68b4bd72811de00597327be2">00644</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a6b96c1de68b4bd72811de00597327be2">mesh_octree_get_base_offs</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>)
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646     <span class="keywordtype">int</span> vx, vy, vz;
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     vx = floor( (co[0] - offs[0]) / div[0]);
<a name="l00649"></a>00649     vy = floor( (co[1] - offs[1]) / div[1]);
<a name="l00650"></a>00650     vz = floor( (co[2] - offs[2]) / div[2]);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(vx, 0, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 1);
<a name="l00653"></a>00653     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(vy, 0, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 1);
<a name="l00654"></a>00654     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(vz, 0, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 1);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="keywordflow">return</span> (vx * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a>) + vy * MOC_RES + vz;
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 
<a name="l00659"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">00659</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(<a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **bt, intptr_t <a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">index</a>)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (*bt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00662"></a>00662         *bt = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d34/structMocNode.html">MocNode</a>), <span class="stringliteral">&quot;MocNode&quot;</span>);
<a name="l00663"></a>00663         (*bt)-&gt;index[0] = <a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">index</a>;
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665     <span class="keywordflow">else</span> {
<a name="l00666"></a>00666         <span class="keywordtype">int</span> a;
<a name="l00667"></a>00667         <span class="keywordflow">for</span> (a = 0; a &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a51ebb3c25af3926ebefbe14451bbbd91">MOC_NODE_RES</a>; a++) {
<a name="l00668"></a>00668             <span class="keywordflow">if</span> ((*bt)-&gt;index[a] == index)
<a name="l00669"></a>00669                 <span class="keywordflow">return</span>;
<a name="l00670"></a>00670             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*bt)-&gt;index[a] == 0) {
<a name="l00671"></a>00671                 (*bt)-&gt;index[a] = <a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">index</a>;
<a name="l00672"></a>00672                 <span class="keywordflow">return</span>;
<a name="l00673"></a>00673             }
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675         <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(&amp;(*bt)-&gt;next, index);
<a name="l00676"></a>00676     }
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a><a class="code" href="../../d7/d35/meshtools_8c.html#ab6a994eff3ab0f3f2b1b7585a4c18adf">00679</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/d35/meshtools_8c.html#ab6a994eff3ab0f3f2b1b7585a4c18adf">mesh_octree_free_node</a>(<a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **bt)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     <span class="keywordflow">if</span> ( (*bt)-&gt;next) {
<a name="l00682"></a>00682         <a class="code" href="../../d7/d35/meshtools_8c.html#ab6a994eff3ab0f3f2b1b7585a4c18adf">mesh_octree_free_node</a>(&amp;(*bt)-&gt;next);
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(*bt);
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 <span class="comment">/* temporal define, just to make nicer code below */</span>
<a name="l00689"></a><a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">00689</a> <span class="preprocessor">#define MOC_INDEX(vx, vy, vz)  (((vx) * MOC_RES * MOC_RES) + (vy) * MOC_RES + (vz))</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>
<a name="l00691"></a><a class="code" href="../../d7/d35/meshtools_8c.html#abbd0d9aef23b925bc64415d7f09807cc">00691</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/d35/meshtools_8c.html#abbd0d9aef23b925bc64415d7f09807cc">mesh_octree_add_nodes</a>(<a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **basetable, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>, <span class="keywordtype">float</span> *<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, intptr_t <a class="code" href="../../da/d34/structMocNode.html#a73e3bc001e9c2520d8fb69b42bb70888">index</a>)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693     <span class="keywordtype">float</span> fx, fy, fz;
<a name="l00694"></a>00694     <span class="keywordtype">int</span> vx, vy, vz;
<a name="l00695"></a>00695     
<a name="l00696"></a>00696     <span class="keywordflow">if</span> (!finite(co[0]) ||
<a name="l00697"></a>00697         !finite(co[1]) ||
<a name="l00698"></a>00698         !finite(co[2]))
<a name="l00699"></a>00699     {
<a name="l00700"></a>00700         <span class="keywordflow">return</span>;
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702     
<a name="l00703"></a>00703     fx = (co[0] - offs[0]) / div[0];
<a name="l00704"></a>00704     fy = (co[1] - offs[1]) / div[1];
<a name="l00705"></a>00705     fz = (co[2] - offs[2]) / div[2];
<a name="l00706"></a>00706     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(fx, 0.0f, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>);
<a name="l00707"></a>00707     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(fy, 0.0f, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>);
<a name="l00708"></a>00708     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(fz, 0.0f, <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     vx = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fx);
<a name="l00711"></a>00711     vy = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fy);
<a name="l00712"></a>00712     vz = (int)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(fz);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx, vy, vz), index);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">if</span> (vx &gt; 0)
<a name="l00717"></a>00717         <span class="keywordflow">if</span> (fx - ((<span class="keywordtype">float</span>)vx) - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &lt; 0.0f)
<a name="l00718"></a>00718             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx - 1, vy, vz), index);
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (vx &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 2)
<a name="l00720"></a>00720         <span class="keywordflow">if</span> (fx - ((<span class="keywordtype">float</span>)vx) + <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &gt; 1.0f)
<a name="l00721"></a>00721             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx + 1, vy, vz), index);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (vy &gt; 0)
<a name="l00724"></a>00724         <span class="keywordflow">if</span> (fy - ((<span class="keywordtype">float</span>)vy) - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &lt; 0.0f)
<a name="l00725"></a>00725             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx, vy - 1, vz), index);
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (vy &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 2)
<a name="l00727"></a>00727         <span class="keywordflow">if</span> (fy - ((<span class="keywordtype">float</span>)vy) + <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &gt; 1.0f)
<a name="l00728"></a>00728             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx, vy + 1, vz), index);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (vz &gt; 0)
<a name="l00731"></a>00731         <span class="keywordflow">if</span> (fz - ((<span class="keywordtype">float</span>)vz) - <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &lt; 0.0f)
<a name="l00732"></a>00732             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx, vy, vz - 1), index);
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (vz &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> - 2)
<a name="l00734"></a>00734         <span class="keywordflow">if</span> (fz - ((<span class="keywordtype">float</span>)vz) + <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a> &gt; 1.0f)
<a name="l00735"></a>00735             <a class="code" href="../../d7/d35/meshtools_8c.html#a5b592d0dc4a9dde5484294e151e29e9d">mesh_octree_add_node</a>(basetable + <a class="code" href="../../d7/d35/meshtools_8c.html#ab7e5f8961dd9eaff5d5abafcfae1ac2e">MOC_INDEX</a>(vx, vy, vz + 1), index);
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="../../d7/d35/meshtools_8c.html#afd887b971e6a4880419a8f09b13affe2">00739</a> <span class="keyword">static</span> intptr_t <a class="code" href="../../d7/d35/meshtools_8c.html#afd887b971e6a4880419a8f09b13affe2">mesh_octree_find_index</a>(<a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **bt, <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l00740"></a>00740 {
<a name="l00741"></a>00741     <span class="keywordtype">float</span> *vec;
<a name="l00742"></a>00742     <span class="keywordtype">int</span> a;
<a name="l00743"></a>00743     
<a name="l00744"></a>00744     <span class="keywordflow">if</span> (*bt == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00745"></a>00745         <span class="keywordflow">return</span> -1;
<a name="l00746"></a>00746     
<a name="l00747"></a>00747     <span class="keywordflow">for</span> (a = 0; a &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a51ebb3c25af3926ebefbe14451bbbd91">MOC_NODE_RES</a>; a++) {
<a name="l00748"></a>00748         <span class="keywordflow">if</span> ((*bt)-&gt;index[a]) {
<a name="l00749"></a>00749             <span class="comment">/* does mesh verts and editmode, code looks potential dangerous, octree should really be filled OK! */</span>
<a name="l00750"></a>00750             <span class="keywordflow">if</span> (mvert) {
<a name="l00751"></a>00751                 vec = (mvert + (*bt)-&gt;index[a] - 1)-&gt;co;
<a name="l00752"></a>00752                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a38c22cf1e33ef0dd26cb0317cf341c73">compare_v3v3</a>(vec, co, <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>))
<a name="l00753"></a>00753                     <span class="keywordflow">return</span> (*bt)-&gt;index[a] - 1;
<a name="l00754"></a>00754             }
<a name="l00755"></a>00755             <span class="keywordflow">else</span> {
<a name="l00756"></a>00756                 <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve = (<a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *)((*bt)-&gt;index[a]);
<a name="l00757"></a>00757                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a38c22cf1e33ef0dd26cb0317cf341c73">compare_v3v3</a>(eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>, co, <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>))
<a name="l00758"></a>00758                     <span class="keywordflow">return</span> (*bt)-&gt;index[a];
<a name="l00759"></a>00759             }
<a name="l00760"></a>00760         }
<a name="l00761"></a>00761         <span class="keywordflow">else</span> <span class="keywordflow">return</span> -1;
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763     <span class="keywordflow">if</span> ( (*bt)-&gt;next)
<a name="l00764"></a>00764         <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#afd887b971e6a4880419a8f09b13affe2">mesh_octree_find_index</a>(&amp;(*bt)-&gt;next, mvert, co);
<a name="l00765"></a>00765     
<a name="l00766"></a>00766     <span class="keywordflow">return</span> -1;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00770"></a><a class="code" href="../../d7/d35/meshtools_8c.html#ae0806484720dd424e53ea053a3cd1309">00770</a>     <a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **<a class="code" href="../../d7/d35/meshtools_8c.html#ae0806484720dd424e53ea053a3cd1309">table</a>;
<a name="l00771"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">00771</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a95306f188b8885dc64be154d19f1232c">offs</a>[3], <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>[3];
<a name="l00772"></a>00772 } <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a> = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, {0, 0, 0}, {0, 0, 0}};
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 <span class="comment">/* mode is &#39;s&#39; start, or &#39;e&#39; end, or &#39;u&#39; use */</span>
<a name="l00775"></a>00775 <span class="comment">/* if end, ob can be NULL */</span>
<a name="l00776"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a4ff531245bf4c70c7c972327eeee79f3">00776</a> intptr_t <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">char</span> mode)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <a class="code" href="../../da/d34/structMocNode.html">MocNode</a> **bt;
<a name="l00779"></a>00779     
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;u&#39;</span>) {        <span class="comment">/* use table */</span>
<a name="l00781"></a>00781         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00782"></a>00782             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, em, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;s&#39;</span>);
<a name="l00783"></a>00783 
<a name="l00784"></a>00784         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table) {
<a name="l00785"></a>00785             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00786"></a>00786             bt = <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table + <a class="code" href="../../d7/d35/meshtools_8c.html#a6b96c1de68b4bd72811de00597327be2">mesh_octree_get_base_offs</a>(co, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div);
<a name="l00787"></a>00787             <span class="keywordflow">if</span> (em)
<a name="l00788"></a>00788                 <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#afd887b971e6a4880419a8f09b13affe2">mesh_octree_find_index</a>(bt, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, co);
<a name="l00789"></a>00789             <span class="keywordflow">else</span>
<a name="l00790"></a>00790                 <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#afd887b971e6a4880419a8f09b13affe2">mesh_octree_find_index</a>(bt, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>, co);
<a name="l00791"></a>00791         }
<a name="l00792"></a>00792         <span class="keywordflow">return</span> -1;
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;s&#39;</span>) {   <span class="comment">/* start table */</span>
<a name="l00795"></a>00795         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00796"></a>00796         <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3];
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         <span class="comment">/* we compute own bounding box and don&#39;t reuse ob-&gt;bb because</span>
<a name="l00799"></a>00799 <span class="comment">         * we are using the undeformed coordinates*/</span>
<a name="l00800"></a>00800         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a329751705c70a4b2fd8a24744f172bb2">INIT_MINMAX</a>(min, max);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802         <span class="keywordflow">if</span> (em &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a> == em) {
<a name="l00803"></a>00803             <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l00804"></a>00804             <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l00805"></a>00805             
<a name="l00806"></a>00806             <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (eve, &amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>) {
<a name="l00807"></a>00807                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>, min, max);
<a name="l00808"></a>00808             }
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810         <span class="keywordflow">else</span> {      
<a name="l00811"></a>00811             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00812"></a>00812             <span class="keywordtype">int</span> a;
<a name="l00813"></a>00813             
<a name="l00814"></a>00814             <span class="keywordflow">for</span> (a = 0, mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>; a &lt; me-&gt;totvert; a++, mvert++)
<a name="l00815"></a>00815                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, min, max);
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817         
<a name="l00818"></a>00818         <span class="comment">/* for quick unit coordinate calculus */</span>
<a name="l00819"></a>00819         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs, min);
<a name="l00820"></a>00820         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs[0] -= <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;        <span class="comment">/* we offset it 1 threshold unit extra */</span>
<a name="l00821"></a>00821         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs[1] -= <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;
<a name="l00822"></a>00822         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs[2] -= <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;
<a name="l00823"></a>00823         
<a name="l00824"></a>00824         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div, max, min);
<a name="l00825"></a>00825         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[0] += 2 * <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;   <span class="comment">/* and divide with 2 threshold unit more extra (try 8x8 unit grid on paint) */</span>
<a name="l00826"></a>00826         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[1] += 2 * <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;
<a name="l00827"></a>00827         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[2] += 2 * <a class="code" href="../../d7/d35/meshtools_8c.html#adddb6e7d389cd321388c85ea4371282f">MOC_THRESH</a>;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div, 1.0f / <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a>);
<a name="l00830"></a>00830         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[0] == 0.0f) <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[0] = 1.0f;
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[1] == 0.0f) <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[1] = 1.0f;
<a name="l00832"></a>00832         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[2] == 0.0f) <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div[2] = 1.0f;
<a name="l00833"></a>00833             
<a name="l00834"></a>00834         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table) <span class="comment">/* happens when entering this call without ending it */</span>
<a name="l00835"></a>00835             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, em, co, <span class="charliteral">&#39;e&#39;</span>);
<a name="l00836"></a>00836         
<a name="l00837"></a>00837         <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *), <span class="stringliteral">&quot;sym table&quot;</span>);
<a name="l00838"></a>00838         
<a name="l00839"></a>00839         <span class="keywordflow">if</span> (em &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a> == em) {
<a name="l00840"></a>00840             <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve;
<a name="l00841"></a>00841             <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843             <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (eve, &amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>) {
<a name="l00844"></a>00844                 <a class="code" href="../../d7/d35/meshtools_8c.html#abbd0d9aef23b925bc64415d7f09807cc">mesh_octree_add_nodes</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table, eve-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div, (intptr_t)(eve));
<a name="l00845"></a>00845             }
<a name="l00846"></a>00846         }
<a name="l00847"></a>00847         <span class="keywordflow">else</span> {      
<a name="l00848"></a>00848             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00849"></a>00849             <span class="keywordtype">int</span> a;
<a name="l00850"></a>00850             
<a name="l00851"></a>00851             <span class="keywordflow">for</span> (a = 0, mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>; a &lt; me-&gt;totvert; a++, mvert++)
<a name="l00852"></a>00852                 <a class="code" href="../../d7/d35/meshtools_8c.html#abbd0d9aef23b925bc64415d7f09807cc">mesh_octree_add_nodes</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table, mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.offs, <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.div, a + 1);
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;e&#39;</span>) { <span class="comment">/* end table */</span>
<a name="l00856"></a>00856         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table) {
<a name="l00857"></a>00857             <span class="keywordtype">int</span> a;
<a name="l00858"></a>00858             
<a name="l00859"></a>00859             <span class="keywordflow">for</span> (a = 0, bt = <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table; a &lt; <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a> * <a class="code" href="../../d7/d35/meshtools_8c.html#a1f890e5d634ab571d8dd610083f86795">MOC_RES</a>; a++, bt++) {
<a name="l00860"></a>00860                 <span class="keywordflow">if</span> (*bt) <a class="code" href="../../d7/d35/meshtools_8c.html#ab6a994eff3ab0f3f2b1b7585a4c18adf">mesh_octree_free_node</a>(bt);
<a name="l00861"></a>00861             }
<a name="l00862"></a>00862             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table);
<a name="l00863"></a>00863             <a class="code" href="../../d7/d35/meshtools_8c.html#a2d6e315697854a9bfd12c5208c13b184">MeshOctree</a>.table = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00864"></a>00864         }
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866     <span class="keywordflow">return</span> 0;
<a name="l00867"></a>00867 }
<a name="l00868"></a>00868 
<a name="l00869"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a8786d5aea96d17aa2a4346749a1d1807">00869</a> <a class="code" href="../../db/d5d/structMirrTopoStore__t.html">MirrTopoStore_t</a> <a class="code" href="../../d7/d35/meshtools_8c.html#a8786d5aea96d17aa2a4346749a1d1807">mesh_topo_store</a> = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, -1. - 1, -1};
<a name="l00870"></a>00870 
<a name="l00871"></a>00871 <span class="comment">/* mode is &#39;s&#39; start, or &#39;e&#39; end, or &#39;u&#39; use */</span>
<a name="l00872"></a>00872 <span class="comment">/* if end, ob can be NULL */</span>
<a name="l00873"></a>00873 <span class="comment">/* note, is supposed return -1 on error, which callers are currently checking for, but is not used so far */</span>
<a name="l00874"></a><a class="code" href="../../d7/d35/meshtools_8c.html#acc626d5e5605562dec239d61d2123c93">00874</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3c8665b18a239636c5f8051e7dc547be">mesh_mirrtopo_table</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">char</span> mode)
<a name="l00875"></a>00875 {
<a name="l00876"></a>00876     <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;u&#39;</span>) {        <span class="comment">/* use table */</span>
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (<a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3deb2f74fb42f4c98454c49abdec8cd9">ED_mesh_mirrtopo_recalc_check</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a>, &amp;mesh_topo_store)) {
<a name="l00878"></a>00878             <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3c8665b18a239636c5f8051e7dc547be">mesh_mirrtopo_table</a>(ob, <span class="charliteral">&#39;s&#39;</span>);
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;s&#39;</span>) { <span class="comment">/* start table */</span>
<a name="l00882"></a>00882         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a59f430bdd02e0b8160d247f3b974abad">ED_mesh_mirrtopo_init</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a>, &amp;mesh_topo_store, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <span class="charliteral">&#39;e&#39;</span>) { <span class="comment">/* end table */</span>
<a name="l00885"></a>00885         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a9530ab6c17a68f34b530f074bb7dd66f">ED_mesh_mirrtopo_free</a>(&amp;mesh_topo_store);
<a name="l00886"></a>00886     }
<a name="l00887"></a>00887     <span class="keywordflow">return</span> 0;
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a11c38dbeb3b58900212ed875bdc1390f">00890</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a11c38dbeb3b58900212ed875bdc1390f">mesh_get_x_mirror_vert_spacial</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> index)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00893"></a>00893     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00894"></a>00894     <span class="keywordtype">float</span> vec[3];
<a name="l00895"></a>00895     
<a name="l00896"></a>00896     mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a> + index;
<a name="l00897"></a>00897     vec[0] = -mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l00898"></a>00898     vec[1] = mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l00899"></a>00899     vec[2] = mvert-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l00900"></a>00900     
<a name="l00901"></a>00901     <span class="keywordflow">return</span> <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vec, <span class="charliteral">&#39;u&#39;</span>);
<a name="l00902"></a>00902 }
<a name="l00903"></a>00903 
<a name="l00904"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a68777513023344df93634fcb3e6c63b6">00904</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a68777513023344df93634fcb3e6c63b6">mesh_get_x_mirror_vert_topo</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> index)
<a name="l00905"></a>00905 {
<a name="l00906"></a>00906     <span class="keywordflow">if</span> (<a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3c8665b18a239636c5f8051e7dc547be">mesh_mirrtopo_table</a>(ob, <span class="charliteral">&#39;u&#39;</span>) == -1)
<a name="l00907"></a>00907         <span class="keywordflow">return</span> -1;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="keywordflow">return</span> mesh_topo_store.<a class="code" href="../../db/d5d/structMirrTopoStore__t.html#a054f4fb9ba516f11630cb85a1a783c19">index_lookup</a>[index];
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a19a8836fc7f9e3a34ef4f556e087b339">00912</a> <span class="keywordtype">int</span> <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> index)
<a name="l00913"></a>00913 {
<a name="l00914"></a>00914     <span class="keywordflow">if</span> (((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;editflag &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a8f914757b1b9493014237f078540f8c5">ME_EDIT_MIRROR_TOPO</a>) {
<a name="l00915"></a>00915         <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a68777513023344df93634fcb3e6c63b6">mesh_get_x_mirror_vert_topo</a>(ob, index);
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="keywordflow">else</span> {
<a name="l00918"></a>00918         <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a11c38dbeb3b58900212ed875bdc1390f">mesh_get_x_mirror_vert_spacial</a>(ob, index);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920     <span class="keywordflow">return</span> 0;
<a name="l00921"></a>00921 }
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a4094d3f6b7e24bba85f7459ca2cd97e7">00923</a> <span class="keyword">static</span> <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *<a class="code" href="../../d7/d35/meshtools_8c.html#a4094d3f6b7e24bba85f7459ca2cd97e7">editbmesh_get_x_mirror_vert_spacial</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)
<a name="l00924"></a>00924 {
<a name="l00925"></a>00925     <span class="keywordtype">float</span> vec[3];
<a name="l00926"></a>00926     intptr_t poinval;
<a name="l00927"></a>00927     
<a name="l00928"></a>00928     <span class="comment">/* ignore nan verts */</span>
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (!finite(co[0]) ||
<a name="l00930"></a>00930         !finite(co[1]) ||
<a name="l00931"></a>00931         !finite(co[2])
<a name="l00932"></a>00932         )
<a name="l00933"></a>00933         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00934"></a>00934     
<a name="l00935"></a>00935     vec[0] = -co[0];
<a name="l00936"></a>00936     vec[1] = co[1];
<a name="l00937"></a>00937     vec[2] = co[2];
<a name="l00938"></a>00938     
<a name="l00939"></a>00939     poinval = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, em, vec, <span class="charliteral">&#39;u&#39;</span>);
<a name="l00940"></a>00940     <span class="keywordflow">if</span> (poinval != -1)
<a name="l00941"></a>00941         <span class="keywordflow">return</span> (<a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *)(poinval);
<a name="l00942"></a>00942     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 
<a name="l00945"></a><a class="code" href="../../d7/d35/meshtools_8c.html#aae6cceb79e4b44d7def5279f167ef518">00945</a> <span class="keyword">static</span> <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *<a class="code" href="../../d7/d35/meshtools_8c.html#aae6cceb79e4b44d7def5279f167ef518">editbmesh_get_x_mirror_vert_topo</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">struct</span> <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve, <span class="keywordtype">int</span> index)
<a name="l00946"></a>00946 {
<a name="l00947"></a>00947     intptr_t poinval;
<a name="l00948"></a>00948     <span class="keywordflow">if</span> (<a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3c8665b18a239636c5f8051e7dc547be">mesh_mirrtopo_table</a>(ob, <span class="charliteral">&#39;u&#39;</span>) == -1)
<a name="l00949"></a>00949         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="keywordflow">if</span> (index == -1) {
<a name="l00952"></a>00952         <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l00953"></a>00953         <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v;
<a name="l00954"></a>00954         
<a name="l00955"></a>00955         index = 0;
<a name="l00956"></a>00956         <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (v, &amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa40e4413e8bcf7618b57cbbbc6b56382b">BM_VERTS_OF_MESH</a>) {
<a name="l00957"></a>00957             <span class="keywordflow">if</span> (v == eve)
<a name="l00958"></a>00958                 <span class="keywordflow">break</span>;
<a name="l00959"></a>00959             index++;
<a name="l00960"></a>00960         }
<a name="l00961"></a>00961         
<a name="l00962"></a>00962         <span class="keywordflow">if</span> (index == em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a>) {
<a name="l00963"></a>00963             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00964"></a>00964         }
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967     poinval = mesh_topo_store.<a class="code" href="../../db/d5d/structMirrTopoStore__t.html#a054f4fb9ba516f11630cb85a1a783c19">index_lookup</a>[index];
<a name="l00968"></a>00968 
<a name="l00969"></a>00969     <span class="keywordflow">if</span> (poinval != -1)
<a name="l00970"></a>00970         <span class="keywordflow">return</span> (<a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *)(poinval);
<a name="l00971"></a>00971     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00972"></a>00972 }   
<a name="l00973"></a>00973 
<a name="l00974"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a9ecc51b601d6020285a93a40c3426dea">00974</a> <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *<a class="code" href="../../d5/dd6/ED__mesh_8h.html#a4cd246a2756ca4d7edb1c448d28e48d7">editbmesh_get_x_mirror_vert</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">struct</span> <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *eve, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">int</span> index)
<a name="l00975"></a>00975 {
<a name="l00976"></a>00976     <span class="keywordflow">if</span> (((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;editflag &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a8f914757b1b9493014237f078540f8c5">ME_EDIT_MIRROR_TOPO</a>) {
<a name="l00977"></a>00977         <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aae6cceb79e4b44d7def5279f167ef518">editbmesh_get_x_mirror_vert_topo</a>(ob, em, eve, index);
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979     <span class="keywordflow">else</span> {
<a name="l00980"></a>00980         <span class="keywordflow">return</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a4094d3f6b7e24bba85f7459ca2cd97e7">editbmesh_get_x_mirror_vert_spacial</a>(ob, em, co);
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 <span class="preprocessor">#if 0</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span>
<a name="l00986"></a>00986 <span class="keyword">static</span> <span class="keywordtype">float</span> *editmesh_get_mirror_uv(<a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em, <span class="keywordtype">int</span> axis, <span class="keywordtype">float</span> *uv, <span class="keywordtype">float</span> *mirrCent, <span class="keywordtype">float</span> *face_cent)
<a name="l00987"></a>00987 {
<a name="l00988"></a>00988     <span class="keywordtype">float</span> vec[2];
<a name="l00989"></a>00989     <span class="keywordtype">float</span> cent_vec[2];
<a name="l00990"></a>00990     <span class="keywordtype">float</span> cent[2];
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     <span class="comment">/* ignore nan verts */</span>
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a04f8ed7ab399e64ec13a184438279a23">isnan</a>(uv[0]) || !finite(uv[0]) ||
<a name="l00994"></a>00994         <a class="code" href="../../d1/d22/stdosl_8h.html#a04f8ed7ab399e64ec13a184438279a23">isnan</a>(uv[1]) || !finite(uv[1])
<a name="l00995"></a>00995         )
<a name="l00996"></a>00996         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     <span class="keywordflow">if</span> (axis) {
<a name="l00999"></a>00999         vec[0] = uv[0];
<a name="l01000"></a>01000         vec[1] = -((uv[1]) - mirrCent[1]) + mirrCent[1];
<a name="l01001"></a>01001 
<a name="l01002"></a>01002         cent_vec[0] = face_cent[0];
<a name="l01003"></a>01003         cent_vec[1] = -((face_cent[1]) - mirrCent[1]) + mirrCent[1];
<a name="l01004"></a>01004     }
<a name="l01005"></a>01005     <span class="keywordflow">else</span> {
<a name="l01006"></a>01006         vec[0] = -((uv[0]) - mirrCent[0]) + mirrCent[0];
<a name="l01007"></a>01007         vec[1] = uv[1];
<a name="l01008"></a>01008 
<a name="l01009"></a>01009         cent_vec[0] = -((face_cent[0]) - mirrCent[0]) + mirrCent[0];
<a name="l01010"></a>01010         cent_vec[1] = face_cent[1];
<a name="l01011"></a>01011     }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013     <span class="comment">/* TODO - Optimize */</span>
<a name="l01014"></a>01014     {
<a name="l01015"></a>01015         <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l01016"></a>01016         <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *efa;
<a name="l01017"></a>01017         
<a name="l01018"></a>01018         <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (efa, &amp;iter, em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fabe0fe60283f43cd8ce697d52d24a3c1e">BM_FACES_OF_MESH</a>) {
<a name="l01019"></a>01019             <a class="code" href="../../d3/d48/uvedit__intern_8h.html#a58729de750ab3a26484d057c978c7b49">poly_uv_center</a>(em, efa, cent);
<a name="l01020"></a>01020             
<a name="l01021"></a>01021             <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(cent[0] - cent_vec[0]) &lt; 0.001) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(cent[1] - cent_vec[1]) &lt; 0.001) ) {
<a name="l01022"></a>01022                 <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> liter;
<a name="l01023"></a>01023                 <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l;
<a name="l01024"></a>01024                 
<a name="l01025"></a>01025                 <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (l, &amp;liter, efa, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1faf52ecdfb30814f26ead38881b29c7375">BM_LOOPS_OF_FACE</a>) {
<a name="l01026"></a>01026                     <a class="code" href="../../d6/d90/structMLoopUV.html">MLoopUV</a> *luv = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#abd885f96566fa49036c6219d971cc809">CustomData_bmesh_get</a>(&amp;em-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#abee9716c152e57c29af7d211ced0e178">ldata</a>, l-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a164c8c2d0c397a56c211f1f0a0db7bc6">head</a>.<a class="code" href="../../d5/d3a/structBMHeader.html#aab6fc118de69cdb678fe6aaba4ec75be">data</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#acc4311230a2627e6cbaf767a15b3aaa2">CD_MLOOPUV</a>);
<a name="l01027"></a>01027                     <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(luv-&gt;<a class="code" href="../../d6/d90/structMLoopUV.html#ac544e39393bf4b87a7addbcb03198a1f">uv</a>[0] - vec[0]) &lt; 0.001) &amp;&amp; (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(luv-&gt;<a class="code" href="../../d6/d90/structMLoopUV.html#ac544e39393bf4b87a7addbcb03198a1f">uv</a>[1] - vec[1]) &lt; 0.001) ) {
<a name="l01028"></a>01028                         <span class="keywordflow">return</span> luv-&gt;<a class="code" href="../../d6/d90/structMLoopUV.html#ac544e39393bf4b87a7addbcb03198a1f">uv</a>;
<a name="l01029"></a>01029                                 
<a name="l01030"></a>01030                     }
<a name="l01031"></a>01031                 }
<a name="l01032"></a>01032             }
<a name="l01033"></a>01033         }
<a name="l01034"></a>01034     }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01037"></a>01037 }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 <span class="preprocessor">#endif</span>
<a name="l01040"></a>01040 <span class="preprocessor"></span>
<a name="l01041"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a0fef0aa894abeb31ebe158a0ef170190">01041</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a0fef0aa894abeb31ebe158a0ef170190">mirror_facehash</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ptr)
<a name="l01042"></a>01042 {
<a name="l01043"></a>01043     <span class="keyword">const</span> <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf = ptr;
<a name="l01044"></a>01044     <span class="keywordtype">int</span> v0, v1;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01047"></a>01047         v0 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a4d4b0f047377c6f1fcad38649103df05">MIN4</a>(mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>);
<a name="l01048"></a>01048         v1 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a1c0ced76b86284f7e93f9b48cf41b665">MAX4</a>(mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>);
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050     <span class="keywordflow">else</span> {
<a name="l01051"></a>01051         v0 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ac3da33d7f6d37d12b507020daa54e774">MIN3</a>(mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>);
<a name="l01052"></a>01052         v1 = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>);
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     <span class="keywordflow">return</span> ((v0 * 39) ^ (v1 * 31));
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a><a class="code" href="../../d7/d35/meshtools_8c.html#abc324c7467ee61902477005b6118d719">01058</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#abc324c7467ee61902477005b6118d719">mirror_facerotation</a>(<a class="code" href="../../d6/da0/structMFace.html">MFace</a> *a, <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *b)
<a name="l01059"></a>01059 {
<a name="l01060"></a>01060     <span class="keywordflow">if</span> (b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01062"></a>01062             <span class="keywordflow">return</span> 0;
<a name="l01063"></a>01063         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01064"></a>01064             <span class="keywordflow">return</span> 1;
<a name="l01065"></a>01065         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01066"></a>01066             <span class="keywordflow">return</span> 2;
<a name="l01067"></a>01067         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01068"></a>01068             <span class="keywordflow">return</span> 3;
<a name="l01069"></a>01069     }
<a name="l01070"></a>01070     <span class="keywordflow">else</span> {
<a name="l01071"></a>01071         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>)
<a name="l01072"></a>01072             <span class="keywordflow">return</span> 0;
<a name="l01073"></a>01073         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>)
<a name="l01074"></a>01074             <span class="keywordflow">return</span> 1;
<a name="l01075"></a>01075         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> &amp;&amp; a-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> == b-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>)
<a name="l01076"></a>01076             <span class="keywordflow">return</span> 2;
<a name="l01077"></a>01077     }
<a name="l01078"></a>01078     
<a name="l01079"></a>01079     <span class="keywordflow">return</span> -1;
<a name="l01080"></a>01080 }
<a name="l01081"></a>01081 
<a name="l01082"></a><a class="code" href="../../d7/d35/meshtools_8c.html#a4ff58e1a7b00a5713665006e1a2b4a3a">01082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d35/meshtools_8c.html#a4ff58e1a7b00a5713665006e1a2b4a3a">mirror_facecmp</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *a, <span class="keyword">const</span> <span class="keywordtype">void</span> *b)
<a name="l01083"></a>01083 {
<a name="l01084"></a>01084     <span class="keywordflow">return</span> (<a class="code" href="../../d7/d35/meshtools_8c.html#abc324c7467ee61902477005b6118d719">mirror_facerotation</a>((<a class="code" href="../../d6/da0/structMFace.html">MFace</a> *)a, (<a class="code" href="../../d6/da0/structMFace.html">MFace</a> *)b) == -1);
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="comment">/* BMESH_TODO, convert to MPoly (functions above also) */</span>
<a name="l01088"></a><a class="code" href="../../d7/d35/meshtools_8c.html#ab43be643f113414ea7adad85e076aa82">01088</a> <span class="keywordtype">int</span> *<a class="code" href="../../d5/dd6/ED__mesh_8h.html#ac04cfa2fa2b90fc2e287c270850539fd">mesh_get_x_mirror_faces</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em)
<a name="l01089"></a>01089 {
<a name="l01090"></a>01090     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01091"></a>01091     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv, *mvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>;
<a name="l01092"></a>01092     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> mirrormf, *mf, *hashmf, *mface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l01093"></a>01093     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *fhash;
<a name="l01094"></a>01094     <span class="keywordtype">int</span> *mirrorverts, *mirrorfaces;
<a name="l01095"></a>01095     <span class="keywordtype">int</span> a;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097     mirrorverts = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;MirrorVerts&quot;</span>);
<a name="l01098"></a>01098     mirrorfaces = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 2 * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>, <span class="stringliteral">&quot;MirrorFaces&quot;</span>);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, em, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;s&#39;</span>);
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     <span class="keywordflow">for</span> (a = 0, mv = mvert; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; a++, mv++)
<a name="l01103"></a>01103         mirrorverts[a] = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(ob, a);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, em, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;e&#39;</span>);
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     fhash = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/d35/meshtools_8c.html#a0fef0aa894abeb31ebe158a0ef170190">mirror_facehash</a>, <a class="code" href="../../d7/d35/meshtools_8c.html#a4ff58e1a7b00a5713665006e1a2b4a3a">mirror_facecmp</a>, <span class="stringliteral">&quot;mirror_facehash gh&quot;</span>);
<a name="l01108"></a>01108     <span class="keywordflow">for</span> (a = 0, mf = mface; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a++, mf++)
<a name="l01109"></a>01109         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(fhash, mf, mf);
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <span class="keywordflow">for</span> (a = 0, mf = mface; a &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a++, mf++) {
<a name="l01112"></a>01112         mirrormf.<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> = mirrorverts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l01113"></a>01113         mirrormf.<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a> = mirrorverts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l01114"></a>01114         mirrormf.<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a> = mirrorverts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l01115"></a>01115         mirrormf.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> = (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) ? mirrorverts[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>] : 0;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         <span class="comment">/* make sure v4 is not 0 if a quad */</span>
<a name="l01118"></a>01118         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; mirrormf.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> == 0) {
<a name="l01119"></a>01119             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, mirrormf.<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>, mirrormf.<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>);
<a name="l01120"></a>01120             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, mirrormf.<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>, mirrormf.<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>);
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123         hashmf = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(fhash, &amp;mirrormf);
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (hashmf) {
<a name="l01125"></a>01125             mirrorfaces[a * 2] = hashmf - mface;
<a name="l01126"></a>01126             mirrorfaces[a * 2 + 1] = <a class="code" href="../../d7/d35/meshtools_8c.html#abc324c7467ee61902477005b6118d719">mirror_facerotation</a>(&amp;mirrormf, hashmf);
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128         <span class="keywordflow">else</span>
<a name="l01129"></a>01129             mirrorfaces[a * 2] = -1;
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(fhash, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01133"></a>01133     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mirrorverts);
<a name="l01134"></a>01134     
<a name="l01135"></a>01135     <span class="keywordflow">return</span> mirrorfaces;
<a name="l01136"></a>01136 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:33 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
