<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: node_composite_outputFile.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">node_composite_outputFile.c</div>  </div>
</div>
<div class="contents">
<a href="../../d7/dbf/node__composite__outputFile_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2006 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dd9/BLI__path__util_8h.html">BLI_path_util.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d04/node__composite__util_8h.html">node_composite_util.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d13/openexr__multi_8h.html">intern/openexr/openexr_multi.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">/* **************** OUTPUT FILE ******************** */</span>
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a50e048ece028c8cdf79fcee4dccc20f2">00048</a> <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *<a class="code" href="../../d4/d91/BKE__node_8h.html#a75e76ad21aa89db3cfd5a9025265e029">ntreeCompositOutputFileAddSocket</a>(<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *ntree, <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *im_format)
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00051"></a>00051     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock = <a class="code" href="../../d4/d91/BKE__node_8h.html#aae580ede2ac6b1b63fd398d9ef54f95f">nodeAddSocket</a>(ntree, node, <a class="code" href="../../d4/d91/BKE__node_8h.html#a39f69a51ecc17c4bb41f0b8089cc3082">SOCK_IN</a>, name, <a class="code" href="../../d3/d27/DNA__node__types_8h.html#ab154e8443a228bbc7869bde335815870">SOCK_RGBA</a>);
<a name="l00052"></a>00052     
<a name="l00053"></a>00053     <span class="comment">/* create format data for the input socket */</span>
<a name="l00054"></a>00054     <a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html">NodeImageMultiFileSocket</a> *sockdata = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html">NodeImageMultiFileSocket</a>), <span class="stringliteral">&quot;socket image format&quot;</span>);
<a name="l00055"></a>00055     sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a> = sockdata;
<a name="l00056"></a>00056     sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#afd060eba8e422df29c23adc0f0a45aed">struct_type</a> = <a class="code" href="../../d3/d27/DNA__node__types_8h.html#ac688a487b9fe84c0414141f6f3787c40">SOCK_STRUCT_OUTPUT_FILE</a>;
<a name="l00057"></a>00057     
<a name="l00058"></a>00058     <span class="keywordflow">if</span> (im_format) {
<a name="l00059"></a>00059         sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#a2d8e65a251b5553c5408d6ac0d0e1553">format</a>= *im_format;
<a name="l00060"></a>00060         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d77/BKE__image_8h.html#ad71ebb55de689c8115e846c8cac9d731">BKE_imtype_is_movie</a>(sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#a2d8e65a251b5553c5408d6ac0d0e1553">format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>)) {
<a name="l00061"></a>00061             sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#a2d8e65a251b5553c5408d6ac0d0e1553">format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>;
<a name="l00062"></a>00062         }
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064     <span class="comment">/* use node data format by default */</span>
<a name="l00065"></a>00065     sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#aad1224be3c8a8ea2e328cf277308a126">use_node_format</a> = 1;
<a name="l00066"></a>00066     
<a name="l00067"></a>00067     nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a59ff4eaf265d2baab1f40e23806e2270">active_input</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(&amp;node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>, sock);
<a name="l00068"></a>00068     
<a name="l00069"></a>00069     <span class="keywordflow">return</span> sock;
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a759dfc0245488c282a5eb57b526ea268">00072</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d91/BKE__node_8h.html#a47dbf5a0c2ac233192356c9775abfcf1">ntreeCompositOutputFileRemoveActiveSocket</a>(<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *ntree, <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node)
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00075"></a>00075     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>, nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a59ff4eaf265d2baab1f40e23806e2270">active_input</a>);
<a name="l00076"></a>00076     <span class="keywordtype">int</span> totinputs = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>);
<a name="l00077"></a>00077     
<a name="l00078"></a>00078     <span class="keywordflow">if</span> (!sock)
<a name="l00079"></a>00079         <span class="keywordflow">return</span> 0;
<a name="l00080"></a>00080     
<a name="l00081"></a>00081     <span class="keywordflow">if</span> (nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a59ff4eaf265d2baab1f40e23806e2270">active_input</a> == totinputs-1)
<a name="l00082"></a>00082         --nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a59ff4eaf265d2baab1f40e23806e2270">active_input</a>;
<a name="l00083"></a>00083     
<a name="l00084"></a>00084     <span class="comment">/* free format data */</span>
<a name="l00085"></a>00085     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a>);
<a name="l00086"></a>00086     
<a name="l00087"></a>00087     <a class="code" href="../../d4/d91/BKE__node_8h.html#aa4faf2c04a65b1932766577b93c6ed6d">nodeRemoveSocket</a>(ntree, node, sock);
<a name="l00088"></a>00088     <span class="keywordflow">return</span> 1;
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a46644fb98c1e8ff4efdc43ccdc31fccf">00091</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a46644fb98c1e8ff4efdc43ccdc31fccf">init_output_file</a>(<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *ntree, <a class="code" href="../../dc/daa/structbNode.html">bNode</a>* node, <a class="code" href="../../dd/dc3/structbNodeTemplate.html">bNodeTemplate</a> *ntemp)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a>), <span class="stringliteral">&quot;node image multi file&quot;</span>);
<a name="l00094"></a>00094     <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *format = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00095"></a>00095     node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>= nimf;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (ntemp-&gt;<a class="code" href="../../dd/dc3/structbNodeTemplate.html#a0d02b1ee85f65ab6aaa7a1bd9eae65e6">scene</a>) {
<a name="l00098"></a>00098         <a class="code" href="../../d3/d27/structRenderData.html">RenderData</a> *rd = &amp;ntemp-&gt;<a class="code" href="../../dd/dc3/structbNodeTemplate.html#a0d02b1ee85f65ab6aaa7a1bd9eae65e6">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>;
<a name="l00099"></a>00099         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a81532adedc5406e16391c70d4ca8135a">base_path</a>, rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#a67d0217c5d024ae2ee50bcbe547c4772">pic</a>, <span class="keyword">sizeof</span>(nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a81532adedc5406e16391c70d4ca8135a">base_path</a>));
<a name="l00100"></a>00100         nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a233b5dd501e075a4873a7bbdd612cab1">format</a> = rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#a53cdd260f397aa4d2bead55f90780180">im_format</a>;
<a name="l00101"></a>00101         
<a name="l00102"></a>00102         format = &amp;rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#a53cdd260f397aa4d2bead55f90780180">im_format</a>;
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104     
<a name="l00105"></a>00105     <span class="comment">/* add one socket by default */</span>
<a name="l00106"></a>00106     <a class="code" href="../../d4/d91/BKE__node_8h.html#a75e76ad21aa89db3cfd5a9025265e029">ntreeCompositOutputFileAddSocket</a>(ntree, node, <span class="stringliteral">&quot;Image&quot;</span>, format);
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2ad7714e8175b08539cd7442dddee15d">00109</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2ad7714e8175b08539cd7442dddee15d">free_output_file</a>(<a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock;
<a name="l00112"></a>00112     
<a name="l00113"></a>00113     <span class="comment">/* free storage data in sockets */</span>
<a name="l00114"></a>00114     <span class="keywordflow">for</span> (sock=node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sock; sock=sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>) {
<a name="l00115"></a>00115         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a>);
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>);
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a17f69b777c1acfadb82038a726fa24f1">00121</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a17f69b777c1acfadb82038a726fa24f1">copy_output_file</a>(<span class="keyword">struct</span> <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <span class="keyword">struct</span> <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *target)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock, *newsock;
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     target-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>);
<a name="l00126"></a>00126     
<a name="l00127"></a>00127     <span class="comment">/* duplicate storage data in sockets */</span>
<a name="l00128"></a>00128     <span class="keywordflow">for</span> (sock=node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, newsock=target-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sock &amp;&amp; newsock; sock=sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>, newsock=newsock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>) {
<a name="l00129"></a>00129         newsock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a>);
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#acba7fb6a97502d37a5f12a466d9b82c1">00133</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#acba7fb6a97502d37a5f12a466d9b82c1">update_output_file</a>(<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ntree), <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock;
<a name="l00136"></a>00136     
<a name="l00137"></a>00137     <span class="comment">/* automatically update the socket type based on linked input */</span>
<a name="l00138"></a>00138     <span class="keywordflow">for</span> (sock=node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; sock; sock=sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>) {
<a name="l00139"></a>00139         <span class="keywordflow">if</span> (sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a2c66abc5a509d2688c720bdef242d472">link</a>) {
<a name="l00140"></a>00140             <span class="keywordtype">int</span> linktype = sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a2c66abc5a509d2688c720bdef242d472">link</a>-&gt;<a class="code" href="../../dc/d21/structbNodeLink.html#a49a00b03dce8dca5e7bc76670fc72da4">fromsock</a>-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#ac06da7586b2ece1c92acaebc2ad2d26a">type</a>;
<a name="l00141"></a>00141             <span class="keywordflow">if</span> (linktype != sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#ac06da7586b2ece1c92acaebc2ad2d26a">type</a>)
<a name="l00142"></a>00142                 <a class="code" href="../../d4/d91/BKE__node_8h.html#aed4dae208600f3c7749616de1293f382">nodeSocketSetType</a>(sock, linktype);
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="comment">/* write input data into individual files */</span>
<a name="l00148"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#aff45b2627c9e80cd46b57fc479c39f65">00148</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#aff45b2627c9e80cd46b57fc479c39f65">exec_output_file_singlelayer</a>(<a class="code" href="../../d3/d27/structRenderData.html">RenderData</a> *rd, <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **in)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main; <span class="comment">/* TODO, have this passed along */</span>
<a name="l00151"></a>00151     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf= node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00152"></a>00152     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock;
<a name="l00153"></a>00153     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00154"></a>00154     <span class="keywordtype">int</span> has_preview = 0;
<a name="l00155"></a>00155     
<a name="l00156"></a>00156     <span class="keywordflow">for</span> (sock=node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i=0; sock; sock=sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>, ++i) {
<a name="l00157"></a>00157         <span class="keywordflow">if</span> (in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>) {
<a name="l00158"></a>00158             <a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html">NodeImageMultiFileSocket</a> *sockdata = sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a16dd98d87c594f25bb0676986a13dd9e">storage</a>;
<a name="l00159"></a>00159             <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *format = (sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#aad1224be3c8a8ea2e328cf277308a126">use_node_format</a> ? &amp;nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a233b5dd501e075a4873a7bbdd612cab1">format</a> : &amp;sockdata-&gt;<a class="code" href="../../de/df3/structNodeImageMultiFileSocket.html#a2d8e65a251b5553c5408d6ac0d0e1553">format</a>);
<a name="l00160"></a>00160             <span class="keywordtype">char</span> path[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00161"></a>00161             <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00162"></a>00162             <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *cbuf;
<a name="l00163"></a>00163             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00164"></a>00164             
<a name="l00165"></a>00165             <span class="keywordflow">switch</span> (format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a>) {
<a name="l00166"></a>00166             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a287d5c3977c63b08defd82725b085d47">R_IMF_PLANES_BW</a>:
<a name="l00167"></a>00167                 cbuf = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a380ab284f2b0ec68b7d2a3b6c76d52d4">typecheck_compbuf</a>(in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>);
<a name="l00168"></a>00168                 <span class="keywordflow">break</span>;
<a name="l00169"></a>00169             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>:
<a name="l00170"></a>00170                 cbuf = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a380ab284f2b0ec68b7d2a3b6c76d52d4">typecheck_compbuf</a>(in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../df/d04/node__composite__util_8h.html#a5aa8382431fb940cabf97ee3a1bc5fe6">CB_VEC3</a>);
<a name="l00171"></a>00171                 <span class="keywordflow">break</span>;
<a name="l00172"></a>00172             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>:
<a name="l00173"></a>00173                 cbuf = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a380ab284f2b0ec68b7d2a3b6c76d52d4">typecheck_compbuf</a>(in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../df/d04/node__composite__util_8h.html#a609b7804bac7fbaac234d44e3cc02835">CB_RGBA</a>);
<a name="l00174"></a>00174                 <span class="keywordflow">break</span>;
<a name="l00175"></a>00175             }
<a name="l00176"></a>00176             
<a name="l00177"></a>00177             ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>, format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a>, 0);
<a name="l00178"></a>00178             <span class="comment">/* XXX have to set this explicitly it seems */</span>
<a name="l00179"></a>00179             <span class="keywordflow">switch</span> (format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a>) {
<a name="l00180"></a>00180             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a287d5c3977c63b08defd82725b085d47">R_IMF_PLANES_BW</a>:   ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> = 1; <span class="keywordflow">break</span>;
<a name="l00181"></a>00181             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>:  ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> = 3; <span class="keywordflow">break</span>;
<a name="l00182"></a>00182             <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>: ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> = 4; <span class="keywordflow">break</span>;
<a name="l00183"></a>00183             }
<a name="l00184"></a>00184             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a> = cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>;
<a name="l00185"></a>00185             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a79237e9965b157b0e3ebd899ce7f09b5">dither</a> = rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#a89a7fef2712484fede8eb8887f55a72b">dither_intensity</a>;
<a name="l00186"></a>00186             
<a name="l00187"></a>00187             <span class="keywordflow">if</span> (rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l00188"></a>00188                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>;
<a name="l00189"></a>00189             
<a name="l00190"></a>00190             <span class="comment">/* get full path */</span>
<a name="l00191"></a>00191             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(path, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a81532adedc5406e16391c70d4ca8135a">base_path</a>, sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a08af833b0a18870a5dd633ede04e1ac8">name</a>);
<a name="l00192"></a>00192             <a class="code" href="../../d2/d77/BKE__image_8h.html#a0f3fdbde463db462bc2d403426c6fda7">BKE_makepicstring</a>(filename, path, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>, format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>, (rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0f397dbc57d5dfaaee5dab7176f96ab6">R_EXTENSION</a>), <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00193"></a>00193             
<a name="l00194"></a>00194             <span class="keywordflow">if</span> (0 == <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d51fd72d99219f6a0dcce17d7f572ff">BKE_write_ibuf</a>(ibuf, filename, format))
<a name="l00195"></a>00195                 printf(<span class="stringliteral">&quot;Cannot save Node File Output to %s\n&quot;</span>, filename);
<a name="l00196"></a>00196             <span class="keywordflow">else</span>
<a name="l00197"></a>00197                 printf(<span class="stringliteral">&quot;Saved: %s\n&quot;</span>, filename);
<a name="l00198"></a>00198             
<a name="l00199"></a>00199             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l00200"></a>00200             
<a name="l00201"></a>00201             <span class="comment">/* simply pick the first valid input for preview */</span>
<a name="l00202"></a>00202             <span class="keywordflow">if</span> (!has_preview) {
<a name="l00203"></a>00203                 <a class="code" href="../../d1/d38/node__composite__util_8c.html#a5f71d8306afe6e837189edc2e8e4d6ec">generate_preview</a>(rd, node, cbuf);
<a name="l00204"></a>00204                 has_preview = 1;
<a name="l00205"></a>00205             }
<a name="l00206"></a>00206             
<a name="l00207"></a>00207             <span class="keywordflow">if</span> (in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> != cbuf) 
<a name="l00208"></a>00208                 <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(cbuf);
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/* write input data into layers */</span>
<a name="l00214"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#ad91334462ce2ce8040164aa64d9e2910">00214</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#ad91334462ce2ce8040164aa64d9e2910">exec_output_file_multilayer</a>(<a class="code" href="../../d3/d27/structRenderData.html">RenderData</a> *rd, <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **in)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main; <span class="comment">/* TODO, have this passed along */</span>
<a name="l00217"></a>00217     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf= node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00218"></a>00218     <span class="keywordtype">void</span> *exrhandle= <a class="code" href="../../d2/d16/openexr__api_8cpp.html#acab8d9a93ff6717492709808d7f1ff0b">IMB_exr_get_handle</a>();
<a name="l00219"></a>00219     <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00220"></a>00220     <a class="code" href="../../dd/d4e/structbNodeSocket.html">bNodeSocket</a> *sock;
<a name="l00221"></a>00221     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00222"></a>00222     <span class="comment">/* Must have consistent pixel size for exr file, simply take the first valid input size. */</span>
<a name="l00223"></a>00223     <span class="keywordtype">int</span> rectx = -1;
<a name="l00224"></a>00224     <span class="keywordtype">int</span> recty = -1;
<a name="l00225"></a>00225     <span class="keywordtype">int</span> has_preview = 0;
<a name="l00226"></a>00226     
<a name="l00227"></a>00227     <a class="code" href="../../d2/d77/BKE__image_8h.html#a0f3fdbde463db462bc2d403426c6fda7">BKE_makepicstring</a>(filename, nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a81532adedc5406e16391c70d4ca8135a">base_path</a>, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>, (rd-&gt;<a class="code" href="../../d3/d27/structRenderData.html#ad853a19c13a6c728a07b82fbb9f52bc6">scemode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0f397dbc57d5dfaaee5dab7176f96ab6">R_EXTENSION</a>), <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00228"></a>00228     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(filename);
<a name="l00229"></a>00229     
<a name="l00230"></a>00230     <span class="keywordflow">for</span> (sock=node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a299fd2f4ec8c8b867ae921a4a8b958e3">inputs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i=0; sock; sock=sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a7e1f426e43244487e24f9cc94e4d407b">next</a>, ++i) {
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (in[i]-&gt;<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>) {
<a name="l00232"></a>00232             <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *cbuf = in[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;<a class="code" href="../../de/d8a/structbNodeStack.html#a7df6710a4f38c0bf036156c5a6d4fe46">data</a>;
<a name="l00233"></a>00233             <span class="keywordtype">char</span> layname[<a class="code" href="../../d7/d13/openexr__multi_8h.html#a261abb0df924c81c776951dbd2c8c22e">EXR_LAY_MAXNAME</a>];
<a name="l00234"></a>00234             <span class="keywordtype">char</span> channelname[<a class="code" href="../../d7/d13/openexr__multi_8h.html#a756da066ae7bf596a12009b3b5f4e032">EXR_PASS_MAXNAME</a>];
<a name="l00235"></a>00235             <span class="keywordtype">char</span> *channelname_ext;
<a name="l00236"></a>00236             
<a name="l00237"></a>00237             <span class="keywordflow">if</span> (cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#afe97991879c28617a739401c30164d9e">rect_procedural</a>) {
<a name="l00238"></a>00238                 printf(<span class="stringliteral">&quot;Error writing multilayer EXR: Procedural buffer not supported\n&quot;</span>);
<a name="l00239"></a>00239                 <span class="keywordflow">continue</span>;
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241             <span class="keywordflow">if</span> (rectx &lt; 0) {
<a name="l00242"></a>00242                 rectx = cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>;
<a name="l00243"></a>00243                 recty = cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>;
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a> != rectx || cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a> != recty) {
<a name="l00246"></a>00246                 printf(<span class="stringliteral">&quot;Error: Multilayer EXR output node %s expects same resolution for all input buffers. Layer %s skipped.\n&quot;</span>, node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a5d65cbe1159d2c591a3ba7815817b0c4">name</a>, sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a08af833b0a18870a5dd633ede04e1ac8">name</a>);
<a name="l00247"></a>00247                 <span class="keywordflow">continue</span>;
<a name="l00248"></a>00248             }
<a name="l00249"></a>00249             
<a name="l00250"></a>00250             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(layname, sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a08af833b0a18870a5dd633ede04e1ac8">name</a>, <span class="keyword">sizeof</span>(layname));
<a name="l00251"></a>00251             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(channelname, sock-&gt;<a class="code" href="../../dd/d4e/structbNodeSocket.html#a08af833b0a18870a5dd633ede04e1ac8">name</a>, <span class="keyword">sizeof</span>(channelname)-2);
<a name="l00252"></a>00252             channelname_ext = channelname + <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(channelname);
<a name="l00253"></a>00253             
<a name="l00254"></a>00254             <span class="comment">/* create channels */</span>
<a name="l00255"></a>00255             <span class="keywordflow">switch</span> (cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a30f16acd6a84c370ce27661f385a8ea1">type</a>) {
<a name="l00256"></a>00256             <span class="keywordflow">case</span> <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>:
<a name="l00257"></a>00257                 strcpy(channelname_ext, <span class="stringliteral">&quot;.V&quot;</span>);
<a name="l00258"></a>00258                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 1, rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>);
<a name="l00259"></a>00259                 <span class="keywordflow">break</span>;
<a name="l00260"></a>00260             <span class="keywordflow">case</span> <a class="code" href="../../df/d04/node__composite__util_8h.html#aad48490d194738d1ac6a2687c730f635">CB_VEC2</a>:
<a name="l00261"></a>00261                 strcpy(channelname_ext, <span class="stringliteral">&quot;.X&quot;</span>);
<a name="l00262"></a>00262                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 2, 2*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>);
<a name="l00263"></a>00263                 strcpy(channelname_ext, <span class="stringliteral">&quot;.Y&quot;</span>);
<a name="l00264"></a>00264                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 2, 2*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+1);
<a name="l00265"></a>00265                 <span class="keywordflow">break</span>;
<a name="l00266"></a>00266             <span class="keywordflow">case</span> <a class="code" href="../../df/d04/node__composite__util_8h.html#a5aa8382431fb940cabf97ee3a1bc5fe6">CB_VEC3</a>:
<a name="l00267"></a>00267                 strcpy(channelname_ext, <span class="stringliteral">&quot;.X&quot;</span>);
<a name="l00268"></a>00268                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 3, 3*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>);
<a name="l00269"></a>00269                 strcpy(channelname_ext, <span class="stringliteral">&quot;.Y&quot;</span>);
<a name="l00270"></a>00270                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 3, 3*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+1);
<a name="l00271"></a>00271                 strcpy(channelname_ext, <span class="stringliteral">&quot;.Z&quot;</span>);
<a name="l00272"></a>00272                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 3, 3*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+2);
<a name="l00273"></a>00273                 <span class="keywordflow">break</span>;
<a name="l00274"></a>00274             <span class="keywordflow">case</span> <a class="code" href="../../df/d04/node__composite__util_8h.html#a609b7804bac7fbaac234d44e3cc02835">CB_RGBA</a>:
<a name="l00275"></a>00275                 strcpy(channelname_ext, <span class="stringliteral">&quot;.R&quot;</span>);
<a name="l00276"></a>00276                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 4, 4*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>);
<a name="l00277"></a>00277                 strcpy(channelname_ext, <span class="stringliteral">&quot;.G&quot;</span>);
<a name="l00278"></a>00278                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 4, 4*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+1);
<a name="l00279"></a>00279                 strcpy(channelname_ext, <span class="stringliteral">&quot;.B&quot;</span>);
<a name="l00280"></a>00280                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 4, 4*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+2);
<a name="l00281"></a>00281                 strcpy(channelname_ext, <span class="stringliteral">&quot;.A&quot;</span>);
<a name="l00282"></a>00282                 <a class="code" href="../../d2/d16/openexr__api_8cpp.html#af46c9ed1c9d7b085fe9ecd2a196c8f22">IMB_exr_add_channel</a>(exrhandle, layname, channelname, 4, 4*rectx, cbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>+3);
<a name="l00283"></a>00283                 <span class="keywordflow">break</span>;
<a name="l00284"></a>00284             }
<a name="l00285"></a>00285             
<a name="l00286"></a>00286             <span class="comment">/* simply pick the first valid input for preview */</span>
<a name="l00287"></a>00287             <span class="keywordflow">if</span> (!has_preview) {
<a name="l00288"></a>00288                 <a class="code" href="../../d1/d38/node__composite__util_8c.html#a5f71d8306afe6e837189edc2e8e4d6ec">generate_preview</a>(rd, node, cbuf);
<a name="l00289"></a>00289                 has_preview = 1;
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293     
<a name="l00294"></a>00294     <span class="comment">/* when the filename has no permissions, this can fail */</span>
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d16/openexr__api_8cpp.html#a518eea856a5d7ec47d51af6db8672b94">IMB_exr_begin_write</a>(exrhandle, filename, rectx, recty, nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a233b5dd501e075a4873a7bbdd612cab1">format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#ad5f4a2d09c8c7b6f0cd5072daba6f186">exr_codec</a>)) {
<a name="l00296"></a>00296         <a class="code" href="../../d2/d16/openexr__api_8cpp.html#a901c060dfa7ffee5eab01845c25fbf0b">IMB_exr_write_channels</a>(exrhandle);
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">else</span> {
<a name="l00299"></a>00299         <span class="comment">/* TODO, get the error from openexr&#39;s exception */</span>
<a name="l00300"></a>00300         <span class="comment">/* XXX nice way to do report? */</span>
<a name="l00301"></a>00301         printf(<span class="stringliteral">&quot;Error Writing Render Result, see console\n&quot;</span>);
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     
<a name="l00304"></a>00304     <a class="code" href="../../d2/d16/openexr__api_8cpp.html#a42e5c3cfa8fd0b40713429c8187dc9c0">IMB_exr_close</a>(exrhandle);
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a><a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2481b61758b6deaceb15927d2d720c6f">00307</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2481b61758b6deaceb15927d2d720c6f">exec_output_file</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **in, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(out))
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <a class="code" href="../../d3/d27/structRenderData.html">RenderData</a> *rd= <a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l00310"></a>00310     <a class="code" href="../../d9/df1/structNodeImageMultiFile.html">NodeImageMultiFile</a> *nimf= node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00311"></a>00311     
<a name="l00312"></a>00312     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering) {
<a name="l00313"></a>00313         <span class="comment">/* only output files when rendering a sequence -</span>
<a name="l00314"></a>00314 <span class="comment">         * otherwise, it overwrites the output files just </span>
<a name="l00315"></a>00315 <span class="comment">         * scrubbing through the timeline when the compositor updates */</span>
<a name="l00316"></a>00316         <span class="keywordflow">return</span>;
<a name="l00317"></a>00317     }
<a name="l00318"></a>00318     
<a name="l00319"></a>00319     <span class="keywordflow">if</span> (nimf-&gt;<a class="code" href="../../d9/df1/structNodeImageMultiFile.html#a233b5dd501e075a4873a7bbdd612cab1">format</a>.<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>)
<a name="l00320"></a>00320         <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#ad91334462ce2ce8040164aa64d9e2910">exec_output_file_multilayer</a>(rd, node, in);
<a name="l00321"></a>00321     <span class="keywordflow">else</span>
<a name="l00322"></a>00322         <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#aff45b2627c9e80cd46b57fc479c39f65">exec_output_file_singlelayer</a>(rd, node, in);
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="../../d0/d05/NOD__composite_8h.html#a59ebe2992ef6ab5592b00f628524d8e7">00325</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a8f8c90c6b71656856a7b428ea202c54a">register_node_type_cmp_output_file</a>(<a class="code" href="../../d7/d11/structbNodeTreeType.html">bNodeTreeType</a> *ttype)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <span class="keyword">static</span> <a class="code" href="../../dd/d0c/structbNodeType.html">bNodeType</a> ntype;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <a class="code" href="../../d4/d91/BKE__node_8h.html#ad72f02bc8d3724fd040a4c7b04c7ae6b">node_type_base</a>(ttype, &amp;ntype, <a class="code" href="../../d4/d91/BKE__node_8h.html#a993ae4ed5e6e026e42a3f81b3ef71787">CMP_NODE_OUTPUT_FILE</a>, <span class="stringliteral">&quot;File Output&quot;</span>, <a class="code" href="../../d4/d91/BKE__node_8h.html#a0c1dfc239a1caee873fa06628a828b02">NODE_CLASS_OUTPUT</a>, <a class="code" href="../../d3/d27/DNA__node__types_8h.html#a0925ab7ab82c3540f1bb95a217e2367e">NODE_OPTIONS</a>|<a class="code" href="../../d3/d27/DNA__node__types_8h.html#aa3a4e7cc34cf1a7854820ce5ca7b4184">NODE_PREVIEW</a>);
<a name="l00330"></a>00330     <a class="code" href="../../d4/d91/BKE__node_8h.html#a28da87d7bde19fc52db8a347dfbcdb33">node_type_socket_templates</a>(&amp;ntype, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00331"></a>00331     <a class="code" href="../../d4/d91/BKE__node_8h.html#a1e52ce207d6deb6a922816062c31793b">node_type_size</a>(&amp;ntype, 140, 80, 300);
<a name="l00332"></a>00332     <a class="code" href="../../d4/d91/BKE__node_8h.html#af530927053fe9c1d51c34c39db8ea8a1">node_type_init</a>(&amp;ntype, <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a46644fb98c1e8ff4efdc43ccdc31fccf">init_output_file</a>);
<a name="l00333"></a>00333     <a class="code" href="../../d4/d91/BKE__node_8h.html#aef8267492dd0b028ecb667853276428a">node_type_storage</a>(&amp;ntype, <span class="stringliteral">&quot;NodeImageMultiFile&quot;</span>, <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2ad7714e8175b08539cd7442dddee15d">free_output_file</a>, <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a17f69b777c1acfadb82038a726fa24f1">copy_output_file</a>);
<a name="l00334"></a>00334     <a class="code" href="../../d4/d91/BKE__node_8h.html#a2818d72fc7a8ea04349e6459fd8e971a">node_type_update</a>(&amp;ntype, <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#acba7fb6a97502d37a5f12a466d9b82c1">update_output_file</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00335"></a>00335     <a class="code" href="../../d4/d91/BKE__node_8h.html#a3d52173ccbf8815125bcb79c234503d0">node_type_exec</a>(&amp;ntype, <a class="code" href="../../d7/dbf/node__composite__outputFile_8c.html#a2481b61758b6deaceb15927d2d720c6f">exec_output_file</a>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <a class="code" href="../../d4/d91/BKE__node_8h.html#aca0dd5d95b739964ba75c4d656922373">nodeRegisterType</a>(ttype, &amp;ntype);
<a name="l00338"></a>00338 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:35 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
