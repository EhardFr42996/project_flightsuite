<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: node_composite_defocus.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">node_composite_defocus.c</div>  </div>
</div>
<div class="contents">
<a href="../../d0/daf/node__composite__defocus_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version. </span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2006 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d04/node__composite__util_8h.html">node_composite_util.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/* ************ qdn: Defocus node ****************** */</span>
<a name="l00036"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ade287e4508626be8a7e4d53de0bd1285">00036</a> <span class="keyword">static</span> <a class="code" href="../../d1/da2/structbNodeSocketTemplate.html">bNodeSocketTemplate</a> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ade287e4508626be8a7e4d53de0bd1285">cmp_node_defocus_in</a>[]= {
<a name="l00037"></a>00037     {   <a class="code" href="../../d3/d27/DNA__node__types_8h.html#ab154e8443a228bbc7869bde335815870">SOCK_RGBA</a>, 1, <span class="stringliteral">&quot;Image&quot;</span>,          1.0f, 1.0f, 1.0f, 1.0f},
<a name="l00038"></a>00038     {   <a class="code" href="../../d3/d27/DNA__node__types_8h.html#a8e6e748887f7b8c2fa267b03e905d417">SOCK_FLOAT</a>, 1, <span class="stringliteral">&quot;Z&quot;</span>,         1.0f, 1.0f, 1.0f, 1.0f, 0.0f, 1.0f, <a class="code" href="../../de/d7e/RNA__types_8h.html#afc8d3af46d7ce49bb3e75305354fd9bcaaaf43117563adf0a1560ab45f242f8e6">PROP_FACTOR</a>},
<a name="l00039"></a>00039     {   -1, 0, <span class="stringliteral">&quot;&quot;</span>   }
<a name="l00040"></a>00040 };
<a name="l00041"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#aff9ea65e9697303da4cb3f5420dbb500">00041</a> <span class="keyword">static</span> <a class="code" href="../../d1/da2/structbNodeSocketTemplate.html">bNodeSocketTemplate</a> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#aff9ea65e9697303da4cb3f5420dbb500">cmp_node_defocus_out</a>[]= {
<a name="l00042"></a>00042     {   <a class="code" href="../../d3/d27/DNA__node__types_8h.html#ab154e8443a228bbc7869bde335815870">SOCK_RGBA</a>, 0, <span class="stringliteral">&quot;Image&quot;</span>},
<a name="l00043"></a>00043     {   -1, 0, <span class="stringliteral">&quot;&quot;</span>   }
<a name="l00044"></a>00044 };
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">// line coefs for point sampling &amp; scancon. data.</span>
<a name="l00048"></a><a class="code" href="../../d9/d85/structBokehCoeffs.html">00048</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d85/structBokehCoeffs.html">BokehCoeffs</a> {
<a name="l00049"></a><a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">00049</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#a942116dd274df234ae11ae269123a475">dx</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#af3067971bee302589813b20d65a8cb3f">dy</a>;
<a name="l00050"></a><a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">00050</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">ls_y</a>;
<a name="l00051"></a><a class="code" href="../../d9/d85/structBokehCoeffs.html#a01fb9f093644f052ea93f63a786c324c">00051</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d85/structBokehCoeffs.html#a488187ac71d3e89a57d4a678d095257a">min_x</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#a01fb9f093644f052ea93f63a786c324c">min_y</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#a55cf4bc05eb2a2f47efb3efc0736c6eb">max_x</a>, <a class="code" href="../../d9/d85/structBokehCoeffs.html#a1f2992003b76771a6e72a1ad3bf1721e">max_y</a>;
<a name="l00052"></a>00052 } <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ae05d333702d604e1777785d4ab57b801">BokehCoeffs</a>;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="comment">// returns array of BokehCoeffs</span>
<a name="l00055"></a>00055 <span class="comment">// returns length of array in &#39;len_bkh&#39;,</span>
<a name="l00056"></a>00056 <span class="comment">// radius squared of inscribed disk in &#39;inradsq&#39;, needed in getWeight() test,</span>
<a name="l00057"></a>00057 <span class="comment">// BKH[8] is the data returned for the bokeh shape &amp; bkh_b[4] is it&#39;s 2d bound</span>
<a name="l00058"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#abe37b8db004836fcc40f59e22a548d90">00058</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#abe37b8db004836fcc40f59e22a548d90">makeBokeh</a>(<span class="keywordtype">char</span> bktype, <span class="keywordtype">char</span> ro, <span class="keywordtype">int</span>* len_bkh, <span class="keywordtype">float</span>* inradsq, <a class="code" href="../../d9/d85/structBokehCoeffs.html">BokehCoeffs</a> BKH[8], <span class="keywordtype">float</span> bkh_b[4])
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060     <span class="keywordtype">float</span> x0, x1, y0, y1, dx, dy, iDxy;
<a name="l00061"></a>00061     <span class="comment">/* ro now is in radians. */</span>
<a name="l00062"></a>00062     <span class="keywordtype">float</span> w = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1e-6f, ro);  <span class="comment">// never reported stangely enough, but a zero offset causes missing center line...</span>
<a name="l00063"></a>00063     <span class="keywordtype">float</span> wi = <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a5f7516f6821a4fe7671e385b9b01f6cb">DEG2RADF</a>(360.f/bktype);
<a name="l00064"></a>00064     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, ov, nv;
<a name="l00065"></a>00065     
<a name="l00066"></a>00066     <span class="comment">// bktype must be at least 3 &amp; &lt;= 8</span>
<a name="l00067"></a>00067     bktype = (bktype&lt;3) ? 3 : ((bktype&gt;8) ? 8 : bktype);
<a name="l00068"></a>00068     *len_bkh = bktype;
<a name="l00069"></a>00069     *inradsq = -1.f;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="keywordflow">for</span> (i=0; i&lt;(*len_bkh); i++) {
<a name="l00072"></a>00072         x0 = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(w);
<a name="l00073"></a>00073         y0 = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(w);
<a name="l00074"></a>00074         w += wi;
<a name="l00075"></a>00075         x1 = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(w);
<a name="l00076"></a>00076         y1 = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(w);
<a name="l00077"></a>00077         <span class="keywordflow">if</span> ((*inradsq)&lt;0.f) {
<a name="l00078"></a>00078             <span class="comment">// radius squared of inscribed disk</span>
<a name="l00079"></a>00079             <span class="keywordtype">float</span> idx=(x0+x1)*0.5f, idy=(y0+y1)*0.5f;
<a name="l00080"></a>00080             *inradsq = idx*idx + idy*idy;
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082         BKH[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a> = x0;
<a name="l00083"></a>00083         BKH[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a> = y0;
<a name="l00084"></a>00084         dx = x1-x0, dy = y1-y0;
<a name="l00085"></a>00085         iDxy = 1.f / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(dx*dx + dy*dy);
<a name="l00086"></a>00086         dx *= iDxy;
<a name="l00087"></a>00087         dy *= iDxy;
<a name="l00088"></a>00088         BKH[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a942116dd274df234ae11ae269123a475">dx</a> = dx;
<a name="l00089"></a>00089         BKH[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>].<a class="code" href="../../d9/d85/structBokehCoeffs.html#af3067971bee302589813b20d65a8cb3f">dy</a> = dy;
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">// precalc scanconversion data</span>
<a name="l00093"></a>00093     <span class="comment">// bokeh bound, not transformed, for scanconvert</span>
<a name="l00094"></a>00094     bkh_b[0] = bkh_b[2] = 1e10f;    <span class="comment">// xmin/ymin</span>
<a name="l00095"></a>00095     bkh_b[1] = bkh_b[3] = -1e10f;   <span class="comment">// xmax/ymax</span>
<a name="l00096"></a>00096     ov = (*len_bkh) - 1;
<a name="l00097"></a>00097     <span class="keywordflow">for</span> (nv=0; nv&lt;(*len_bkh); nv++) {
<a name="l00098"></a>00098         bkh_b[0] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(bkh_b[0], BKH[nv].x0);  <span class="comment">// xmin</span>
<a name="l00099"></a>00099         bkh_b[1] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(bkh_b[1], BKH[nv].x0);  <span class="comment">// xmax</span>
<a name="l00100"></a>00100         bkh_b[2] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(bkh_b[2], BKH[nv].y0);  <span class="comment">// ymin</span>
<a name="l00101"></a>00101         bkh_b[3] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(bkh_b[3], BKH[nv].y0);  <span class="comment">// ymax</span>
<a name="l00102"></a>00102         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a488187ac71d3e89a57d4a678d095257a">min_x</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(BKH[ov].x0, BKH[nv].x0);
<a name="l00103"></a>00103         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a55cf4bc05eb2a2f47efb3efc0736c6eb">max_x</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(BKH[ov].x0, BKH[nv].x0);
<a name="l00104"></a>00104         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a01fb9f093644f052ea93f63a786c324c">min_y</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(BKH[ov].y0, BKH[nv].y0);
<a name="l00105"></a>00105         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a1f2992003b76771a6e72a1ad3bf1721e">max_y</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(BKH[ov].y0, BKH[nv].y0);
<a name="l00106"></a>00106         dy = BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a> - BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a>;
<a name="l00107"></a>00107         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a> = (BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a> - BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a>) / ((dy==0.f) ? 1.f : dy);
<a name="l00108"></a>00108         BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">ls_y</a> = (BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a>==0.f) ? 1.f : (1.f/BKH[nv].ls_x);
<a name="l00109"></a>00109         ov = nv;
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="comment">// test if u/v inside shape &amp; returns weight value</span>
<a name="l00114"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ac02bcff61124956b84ffd0dd1a8c09d1">00114</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ac02bcff61124956b84ffd0dd1a8c09d1">getWeight</a>(<a class="code" href="../../d9/d85/structBokehCoeffs.html">BokehCoeffs</a>* BKH, <span class="keywordtype">int</span> len_bkh, <span class="keywordtype">float</span> u, <span class="keywordtype">float</span> v, <span class="keywordtype">float</span> rad, <span class="keywordtype">float</span> inradsq)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <a class="code" href="../../d9/d85/structBokehCoeffs.html">BokehCoeffs</a>* bc = BKH;
<a name="l00117"></a>00117     <span class="keywordtype">float</span> cdist, irad = (rad==0.f) ? 1.f : (1.f/rad);
<a name="l00118"></a>00118     u *= irad;
<a name="l00119"></a>00119     v *= irad;
<a name="l00120"></a>00120  
<a name="l00121"></a>00121     <span class="comment">// early out test1: if point outside outer unit disk, it cannot be inside shape</span>
<a name="l00122"></a>00122     cdist = u*u + v*v;
<a name="l00123"></a>00123     <span class="keywordflow">if</span> (cdist&gt;1.f) <span class="keywordflow">return</span> 0.f;
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     <span class="comment">// early out test2: if point inside or on inner disk, point must be inside shape</span>
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (cdist&lt;=inradsq) <span class="keywordflow">return</span> 1.f;
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     <span class="keywordflow">while</span> (len_bkh--) {
<a name="l00129"></a>00129         <span class="keywordflow">if</span> ((bc-&gt;<a class="code" href="../../d9/d85/structBokehCoeffs.html#af3067971bee302589813b20d65a8cb3f">dy</a>*(u - bc-&gt;<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a>) - bc-&gt;<a class="code" href="../../d9/d85/structBokehCoeffs.html#a942116dd274df234ae11ae269123a475">dx</a>*(v - bc-&gt;<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a>)) &gt; 0.f) <span class="keywordflow">return</span> 0.f;
<a name="l00130"></a>00130         bc++;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132     <span class="keywordflow">return</span> 1.f;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">// QMC.seq. for sampling, A.Keller, EMS</span>
<a name="l00136"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a24cb467c9dcbb0d7027912deea6d53c2">00136</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a24cb467c9dcbb0d7027912deea6d53c2">RI_vdC</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bits, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> r)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138     bits = ( bits &lt;&lt; 16) | ( bits &gt;&gt; 16);
<a name="l00139"></a>00139     bits = ((bits &amp; 0x00ff00ff) &lt;&lt; 8) | ((bits &amp; 0xff00ff00) &gt;&gt; 8);
<a name="l00140"></a>00140     bits = ((bits &amp; 0x0f0f0f0f) &lt;&lt; 4) | ((bits &amp; 0xf0f0f0f0) &gt;&gt; 4);
<a name="l00141"></a>00141     bits = ((bits &amp; 0x33333333) &lt;&lt; 2) | ((bits &amp; 0xcccccccc) &gt;&gt; 2);
<a name="l00142"></a>00142     bits = ((bits &amp; 0x55555555) &lt;&lt; 1) | ((bits &amp; 0xaaaaaaaa) &gt;&gt; 1);
<a name="l00143"></a>00143     bits ^= r;
<a name="l00144"></a>00144     <span class="keywordflow">return</span> (<span class="keywordtype">float</span>)((double)bits / 4294967296.0);
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="comment">// single channel IIR gaussian filtering</span>
<a name="l00148"></a>00148 <span class="comment">// much faster than anything else, constant time independent of width</span>
<a name="l00149"></a>00149 <span class="comment">// should extend to multichannel and make this a node, could be useful</span>
<a name="l00150"></a>00150 <span class="comment">// note: this is an almost exact copy of &#39;IIR_gauss&#39;</span>
<a name="l00151"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a81ea358108352c9d3889b1327b907b87">00151</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a81ea358108352c9d3889b1327b907b87">IIR_gauss_single</a>(<a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a>* buf, <span class="keywordtype">float</span> sigma)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="keywordtype">double</span> q, q2, sc, cf[4], tsM[9], tsu[3], tsv[3];
<a name="l00154"></a>00154     <span class="keywordtype">float</span> *<a class="code" href="../../de/da0/strsv_8c.html#a5ae25df4ee72f83efb4a3683c970678f">X</a>, *Y, *W;
<a name="l00155"></a>00155     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, x, y, sz;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">// single channel only for now</span>
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a30f16acd6a84c370ce27661f385a8ea1">type</a> != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) <span class="keywordflow">return</span>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">// &lt;0.5 not valid, though can have a possibly useful sort of sharpening effect</span>
<a name="l00161"></a>00161     <span class="keywordflow">if</span> (sigma &lt; 0.5f) <span class="keywordflow">return</span>;
<a name="l00162"></a>00162     
<a name="l00163"></a>00163     <span class="comment">// see &quot;Recursive Gabor Filtering&quot; by Young/VanVliet</span>
<a name="l00164"></a>00164     <span class="comment">// all factors here in double.prec. Required, because for single.prec it seems to blow up if sigma &gt; ~200</span>
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (sigma &gt;= 3.556f)
<a name="l00166"></a>00166         q = 0.9804f*(sigma - 3.556f) + 2.5091f;
<a name="l00167"></a>00167     <span class="keywordflow">else</span> <span class="comment">// sigma &gt;= 0.5</span>
<a name="l00168"></a>00168         q = (0.0561f*sigma + 0.5784f)*sigma - 0.2568f;
<a name="l00169"></a>00169     q2 = q*q;
<a name="l00170"></a>00170     sc = (1.1668 + q)*(3.203729649  + (2.21566 + q)*q);
<a name="l00171"></a>00171     <span class="comment">// no gabor filtering here, so no complex multiplies, just the regular coefs.</span>
<a name="l00172"></a>00172     <span class="comment">// all negated here, so as not to have to recalc Triggs/Sdika matrix</span>
<a name="l00173"></a>00173     cf[1] = q*(5.788961737 + (6.76492 + 3.0*q)*q)/ sc;
<a name="l00174"></a>00174     cf[2] = -q2*(3.38246 + 3.0*q)/sc;
<a name="l00175"></a>00175     <span class="comment">// 0 &amp; 3 unchanged</span>
<a name="l00176"></a>00176     cf[3] = q2*q/sc;
<a name="l00177"></a>00177     cf[0] = 1.0 - cf[1] - cf[2] - cf[3];
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="comment">// Triggs/Sdika border corrections,</span>
<a name="l00180"></a>00180     <span class="comment">// it seems to work, not entirely sure if it is actually totally correct,</span>
<a name="l00181"></a>00181     <span class="comment">// Besides J.M.Geusebroek&#39;s anigauss.c (see http://www.science.uva.nl/~mark),</span>
<a name="l00182"></a>00182     <span class="comment">// found one other implementation by Cristoph Lampert,</span>
<a name="l00183"></a>00183     <span class="comment">// but neither seem to be quite the same, result seems to be ok sofar anyway.</span>
<a name="l00184"></a>00184     <span class="comment">// Extra scale factor here to not have to do it in filter,</span>
<a name="l00185"></a>00185     <span class="comment">// though maybe this had something to with the precision errors</span>
<a name="l00186"></a>00186     sc = cf[0]/((1.0 + cf[1] - cf[2] + cf[3])*(1.0 - cf[1] - cf[2] - cf[3])*(1.0 + cf[2] + (cf[1] - cf[3])*cf[3]));
<a name="l00187"></a>00187     tsM[0] = sc*(-cf[3]*cf[1] + 1.0 - cf[3]*cf[3] - cf[2]);
<a name="l00188"></a>00188     tsM[1] = sc*((cf[3] + cf[1])*(cf[2] + cf[3]*cf[1]));
<a name="l00189"></a>00189     tsM[2] = sc*(cf[3]*(cf[1] + cf[3]*cf[2]));
<a name="l00190"></a>00190     tsM[3] = sc*(cf[1] + cf[3]*cf[2]);
<a name="l00191"></a>00191     tsM[4] = sc*(-(cf[2] - 1.0)*(cf[2] + cf[3]*cf[1]));
<a name="l00192"></a>00192     tsM[5] = sc*(-(cf[3]*cf[1] + cf[3]*cf[3] + cf[2] - 1.0)*cf[3]);
<a name="l00193"></a>00193     tsM[6] = sc*(cf[3]*cf[1] + cf[2] + cf[1]*cf[1] - cf[2]*cf[2]);
<a name="l00194"></a>00194     tsM[7] = sc*(cf[1]*cf[2] + cf[3]*cf[2]*cf[2] - cf[1]*cf[3]*cf[3] - cf[3]*cf[3]*cf[3] - cf[3]*cf[2] + cf[3]);
<a name="l00195"></a>00195     tsM[8] = sc*(cf[3]*(cf[1] + cf[3]*cf[2]));
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="preprocessor">#define YVV(L)\</span>
<a name="l00198"></a>00198 <span class="preprocessor">{\</span>
<a name="l00199"></a>00199 <span class="preprocessor">    W[0] = cf[0]*X[0] + cf[1]*X[0] + cf[2]*X[0] + cf[3]*X[0];\</span>
<a name="l00200"></a>00200 <span class="preprocessor">    W[1] = cf[0]*X[1] + cf[1]*W[0] + cf[2]*X[0] + cf[3]*X[0];\</span>
<a name="l00201"></a>00201 <span class="preprocessor">    W[2] = cf[0]*X[2] + cf[1]*W[1] + cf[2]*W[0] + cf[3]*X[0];\</span>
<a name="l00202"></a>00202 <span class="preprocessor">    for (i=3; i&lt;L; i++)\</span>
<a name="l00203"></a>00203 <span class="preprocessor">        W[i] = cf[0]*X[i] + cf[1]*W[i-1] + cf[2]*W[i-2] + cf[3]*W[i-3];\</span>
<a name="l00204"></a>00204 <span class="preprocessor">    tsu[0] = W[L-1] - X[L-1];\</span>
<a name="l00205"></a>00205 <span class="preprocessor">    tsu[1] = W[L-2] - X[L-1];\</span>
<a name="l00206"></a>00206 <span class="preprocessor">    tsu[2] = W[L-3] - X[L-1];\</span>
<a name="l00207"></a>00207 <span class="preprocessor">    tsv[0] = tsM[0]*tsu[0] + tsM[1]*tsu[1] + tsM[2]*tsu[2] + X[L-1];\</span>
<a name="l00208"></a>00208 <span class="preprocessor">    tsv[1] = tsM[3]*tsu[0] + tsM[4]*tsu[1] + tsM[5]*tsu[2] + X[L-1];\</span>
<a name="l00209"></a>00209 <span class="preprocessor">    tsv[2] = tsM[6]*tsu[0] + tsM[7]*tsu[1] + tsM[8]*tsu[2] + X[L-1];\</span>
<a name="l00210"></a>00210 <span class="preprocessor">    Y[L-1] = cf[0]*W[L-1] + cf[1]*tsv[0] + cf[2]*tsv[1] + cf[3]*tsv[2];\</span>
<a name="l00211"></a>00211 <span class="preprocessor">    Y[L-2] = cf[0]*W[L-2] + cf[1]*Y[L-1] + cf[2]*tsv[0] + cf[3]*tsv[1];\</span>
<a name="l00212"></a>00212 <span class="preprocessor">    Y[L-3] = cf[0]*W[L-3] + cf[1]*Y[L-2] + cf[2]*Y[L-1] + cf[3]*tsv[0];\</span>
<a name="l00213"></a>00213 <span class="preprocessor">    for (i=L-4; i&gt;=0; i--)\</span>
<a name="l00214"></a>00214 <span class="preprocessor">        Y[i] = cf[0]*W[i] + cf[1]*Y[i+1] + cf[2]*Y[i+2] + cf[3]*Y[i+3];\</span>
<a name="l00215"></a>00215 <span class="preprocessor">}</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span>
<a name="l00217"></a>00217     <span class="comment">// intermediate buffers</span>
<a name="l00218"></a>00218     sz = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00219"></a>00219     Y = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(sz*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;IIR_gauss Y buf&quot;</span>);
<a name="l00220"></a>00220     W = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(sz*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;IIR_gauss W buf&quot;</span>);
<a name="l00221"></a>00221     <span class="comment">// H</span>
<a name="l00222"></a>00222     <span class="keywordflow">for</span> (y=0; y&lt;buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++) {
<a name="l00223"></a>00223         X = &amp;buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[y*buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>];
<a name="l00224"></a>00224         <a class="code" href="../../d1/d38/node__composite__util_8c.html#afa437d0d49705ca15c4b76c91de72370">YVV</a>(buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>);
<a name="l00225"></a>00225         memcpy(X, Y, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     <span class="comment">// V</span>
<a name="l00228"></a>00228     X = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="stringliteral">&quot;IIR_gauss X buf&quot;</span>);
<a name="l00229"></a>00229     <span class="keywordflow">for</span> (x=0; x&lt;buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>; x++) {
<a name="l00230"></a>00230         <span class="keywordflow">for</span> (y=0; y&lt;buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++)
<a name="l00231"></a>00231             X[y] = buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[x + y*buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>];
<a name="l00232"></a>00232         <a class="code" href="../../d1/d38/node__composite__util_8c.html#afa437d0d49705ca15c4b76c91de72370">YVV</a>(buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00233"></a>00233         <span class="keywordflow">for</span> (y=0; y&lt;buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++)
<a name="l00234"></a>00234             buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[x + y*buf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>] = Y[y];
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(X);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(W);
<a name="l00239"></a>00239     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(Y);
<a name="l00240"></a>00240 <span class="preprocessor">#undef YVV</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>}
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a199c24e400e950aba8c0f73d151c6413">00243</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a199c24e400e950aba8c0f73d151c6413">defocus_blur</a>(<a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *<span class="keyword">new</span>, <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *img, <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *zbuf, <span class="keywordtype">float</span> inpval, <span class="keywordtype">int</span> no_zbuf)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <a class="code" href="../../d4/d94/structNodeDefocus.html">NodeDefocus</a> *nqd = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00246"></a>00246     <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *wts;       <span class="comment">// weights buffer</span>
<a name="l00247"></a>00247     <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *crad;      <span class="comment">// CoC radius buffer</span>
<a name="l00248"></a>00248     <a class="code" href="../../d9/d85/structBokehCoeffs.html">BokehCoeffs</a> BKH[8]; <span class="comment">// bokeh shape data, here never &gt; 8 pts.</span>
<a name="l00249"></a>00249     <span class="keywordtype">float</span> bkh_b[4] = {0};   <span class="comment">// shape 2D bound</span>
<a name="l00250"></a>00250     <span class="keywordtype">float</span> cam_fdist=1, cam_invfdist=1, cam_lens=35;
<a name="l00251"></a>00251     <span class="keywordtype">float</span> dof_sp, maxfgc, bk_hn_theta=0, inradsq=0;
<a name="l00252"></a>00252     <span class="keywordtype">int</span> y, len_bkh=0, ydone=0;
<a name="l00253"></a>00253     <span class="keywordtype">float</span> aspect, aperture;
<a name="l00254"></a>00254     <span class="keywordtype">int</span> minsz;
<a name="l00255"></a>00255     <span class="comment">//float bcrad, nmaxc, scf;</span>
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     <span class="comment">// get some required params from the current scene camera</span>
<a name="l00258"></a>00258     <span class="comment">// (ton) this is wrong, needs fixed</span>
<a name="l00259"></a>00259     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene= (<a class="code" href="../../d9/d27/structScene.html">Scene</a>*)node-&gt;<a class="code" href="../../dc/daa/structbNode.html#a4054a28b64f94943286ab0e0df99afba">id</a>;
<a name="l00260"></a>00260     <a class="code" href="../../de/de7/structObject.html">Object</a>* camob = (scene)? scene-&gt;<a class="code" href="../../d9/d27/structScene.html#ad050647276d4d850d127173450933107">camera</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (camob &amp;&amp; camob-&gt;type==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#afd7fa4376c670f245aeed7a7116c7005">OB_CAMERA</a>) {
<a name="l00262"></a>00262         <a class="code" href="../../d7/d7e/structCamera.html">Camera</a>* cam = (<a class="code" href="../../d7/d7e/structCamera.html">Camera</a>*)camob-&gt;data;
<a name="l00263"></a>00263         cam_lens = cam-&gt;<a class="code" href="../../d7/d7e/structCamera.html#a480d411803627517badcebf58c28d0da">lens</a>;
<a name="l00264"></a>00264         cam_fdist = <a class="code" href="../../d2/dff/BKE__camera_8h.html#aa5e61ab28c19d40aef25d90946ccde3d">object_camera_dof_distance</a>(camob);
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (cam_fdist==0.0f) cam_fdist = 1e10f; <span class="comment">/* if the dof is 0.0 then set it be be far away */</span>
<a name="l00266"></a>00266         cam_invfdist = 1.f/cam_fdist;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="comment">// guess work here.. best match with raytraced result</span>
<a name="l00270"></a>00270     minsz = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00271"></a>00271     dof_sp = (float)minsz / (16.f / cam_lens);  <span class="comment">// &lt;- == aspect * MIN2(img-&gt;x, img-&gt;y) / tan(0.5f * fov);</span>
<a name="l00272"></a>00272     
<a name="l00273"></a>00273     <span class="comment">// aperture</span>
<a name="l00274"></a>00274     aspect = (img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a> &gt; img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>) ? (img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a> / (<span class="keywordtype">float</span>)img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>) : (img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a> / (<span class="keywordtype">float</span>)img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00275"></a>00275     aperture = 0.5f*(cam_lens / (aspect*32.f)) / nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a03ea5920af39877090db3a22a36b01c9">fstop</a>;
<a name="l00276"></a>00276     
<a name="l00277"></a>00277     <span class="comment">// if not disk, make bokeh coefficients and other needed data</span>
<a name="l00278"></a>00278     <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a>!=0) {
<a name="l00279"></a>00279         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#abe37b8db004836fcc40f59e22a548d90">makeBokeh</a>(nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a>, nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#af600ecc90204f54b70262013d7d16d82">rotation</a>, &amp;len_bkh, &amp;inradsq, BKH, bkh_b);
<a name="l00280"></a>00280         bk_hn_theta = 0.5 * nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a> * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(2.0 * <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a>);    <span class="comment">// weight factor</span>
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282     
<a name="l00283"></a>00283     <span class="comment">// accumulated weights</span>
<a name="l00284"></a>00284     wts = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a089de797ec2258f13c526e3f20784bfb">alloc_compbuf</a>(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>, <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>, 1);
<a name="l00285"></a>00285     <span class="comment">// CoC radius buffer</span>
<a name="l00286"></a>00286     crad = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a089de797ec2258f13c526e3f20784bfb">alloc_compbuf</a>(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>, <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>, 1);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="comment">// if &#39;no_zbuf&#39; flag set (which is always set if input is not an image),</span>
<a name="l00289"></a>00289     <span class="comment">// values are instead interpreted directly as blur radius values</span>
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (no_zbuf) {
<a name="l00291"></a>00291         <span class="comment">// to prevent *reaaallly* big radius values and impossible calculation times,</span>
<a name="l00292"></a>00292         <span class="comment">// limit the maximum to half the image width or height, whichever is smaller</span>
<a name="l00293"></a>00293         <span class="keywordtype">float</span> maxr = 0.5f*(float)<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00294"></a>00294         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="keywordflow">for</span> (p=0; p&lt;(<span class="keywordtype">unsigned</span> int)(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>*img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>); p++) {
<a name="l00297"></a>00297             crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] = zbuf ? (zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]*nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a936a9530879c2a3f0824e8d34dc778f1">scale</a>) : inpval;
<a name="l00298"></a>00298             <span class="comment">// bug #5921, limit minimum</span>
<a name="l00299"></a>00299             crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(1e-5f, crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[p]);
<a name="l00300"></a>00300             crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[p], maxr);
<a name="l00301"></a>00301             <span class="comment">// if maxblur!=0, limit maximum</span>
<a name="l00302"></a>00302             <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a31cf47f54a99b3e03683a6903f0ef8f9">maxblur</a> != 0.f) crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[p], nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a31cf47f54a99b3e03683a6903f0ef8f9">maxblur</a>);
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305     <span class="keywordflow">else</span> {
<a name="l00306"></a>00306         <span class="keywordtype">float</span> wt;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="comment">// actual zbuffer.</span>
<a name="l00309"></a>00309         <span class="comment">// separate foreground from background CoC&#39;s</span>
<a name="l00310"></a>00310         <span class="comment">// then blur background and blend in again with foreground,</span>
<a name="l00311"></a>00311         <span class="comment">// improves the &#39;blurred foreground overlapping in-focus midground&#39; sharp boundary problem.</span>
<a name="l00312"></a>00312         <span class="comment">// wts buffer here used for blendmask</span>
<a name="l00313"></a>00313         maxfgc = 0.f; <span class="comment">// maximum foreground CoC radius</span>
<a name="l00314"></a>00314         <span class="keywordflow">for</span> (y=0; y&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++) {
<a name="l00315"></a>00315             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = y * img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>;
<a name="l00316"></a>00316             <span class="keywordtype">int</span> x;
<a name="l00317"></a>00317             <span class="keywordflow">for</span> (x=0; x&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>; x++) {
<a name="l00318"></a>00318                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> px = p + x;
<a name="l00319"></a>00319                 <span class="keywordtype">float</span> iZ = (zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px]==0.f) ? 0.f : (1.f/zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px]);
<a name="l00320"></a>00320                 crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 0.5f*(aperture*(dof_sp*(cam_invfdist - iZ) - 1.f));
<a name="l00321"></a>00321                 <span class="keywordflow">if</span> (crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] &lt;= 0.f) {
<a name="l00322"></a>00322                     wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 1.f;
<a name="l00323"></a>00323                     crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = -crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px];
<a name="l00324"></a>00324                     <span class="keywordflow">if</span> (crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] &gt; maxfgc) maxfgc = crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px];
<a name="l00325"></a>00325                 }
<a name="l00326"></a>00326                 <span class="keywordflow">else</span> crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 0;
<a name="l00327"></a>00327             }
<a name="l00328"></a>00328         }
<a name="l00329"></a>00329         
<a name="l00330"></a>00330         <span class="comment">// fast blur...</span>
<a name="l00331"></a>00331         <span class="comment">// bug #6656 part 1, probably when previous node_composite.c was split into separate files, it was not properly updated</span>
<a name="l00332"></a>00332         <span class="comment">// to include recent cvs commits (well, at least not defocus node), so this part was missing...</span>
<a name="l00333"></a>00333         wt = aperture*128.f;
<a name="l00334"></a>00334         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a81ea358108352c9d3889b1327b907b87">IIR_gauss_single</a>(crad, wt);
<a name="l00335"></a>00335         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a81ea358108352c9d3889b1327b907b87">IIR_gauss_single</a>(wts, wt);
<a name="l00336"></a>00336         
<a name="l00337"></a>00337         <span class="comment">// bug #6656 part 2a, although foreground blur is not based anymore on closest object,</span>
<a name="l00338"></a>00338         <span class="comment">// the rescaling op below was still based on that anyway, and unlike the comment in below code,</span>
<a name="l00339"></a>00339         <span class="comment">// the difference is therefore not always that small at all...</span>
<a name="l00340"></a>00340         <span class="comment">// so for now commented out, not sure if this is going to cause other future problems, lets just wait and see...</span>
<a name="l00341"></a>00341         <span class="comment">/*</span>
<a name="l00342"></a>00342 <span class="comment">        // find new maximum to scale it back to original</span>
<a name="l00343"></a>00343 <span class="comment">        // (could skip this, not strictly necessary, in general, difference is quite small, but just in case...)</span>
<a name="l00344"></a>00344 <span class="comment">        nmaxc = 0;</span>
<a name="l00345"></a>00345 <span class="comment">        for (p=0; p&lt;(img-&gt;x*img-&gt;y); p++)</span>
<a name="l00346"></a>00346 <span class="comment">            if (crad-&gt;rect[p] &gt; nmaxc) nmaxc = crad-&gt;rect[p];</span>
<a name="l00347"></a>00347 <span class="comment">        // rescale factor</span>
<a name="l00348"></a>00348 <span class="comment">        scf = (nmaxc==0.f) ? 1.f: (maxfgc / nmaxc);</span>
<a name="l00349"></a>00349 <span class="comment">        */</span>
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="comment">// and blend...</span>
<a name="l00352"></a>00352         <span class="keywordflow">for</span> (y=0; y&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++) {
<a name="l00353"></a>00353             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = y*img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>;
<a name="l00354"></a>00354             <span class="keywordtype">int</span> x;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356             <span class="keywordflow">for</span> (x=0; x&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>; x++) {
<a name="l00357"></a>00357                 <span class="keywordtype">unsigned</span> px = p + x;
<a name="l00358"></a>00358                 <span class="keywordflow">if</span> (zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px]!=0.f) {
<a name="l00359"></a>00359                     <span class="keywordtype">float</span> iZ = (zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px]==0.f) ? 0.f : (1.f/zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px]);
<a name="l00360"></a>00360                     
<a name="l00361"></a>00361                     <span class="comment">// bug #6656 part 2b, do not rescale</span>
<a name="l00362"></a>00362                     <span class="comment">/*</span>
<a name="l00363"></a>00363 <span class="comment">                    bcrad = 0.5f*fabs(aperture*(dof_sp*(cam_invfdist - iZ) - 1.f));</span>
<a name="l00364"></a>00364 <span class="comment">                    // scale crad back to original maximum and blend</span>
<a name="l00365"></a>00365 <span class="comment">                    crad-&gt;rect[px] = bcrad + wts-&gt;rect[px]*(scf*crad-&gt;rect[px] - bcrad);</span>
<a name="l00366"></a>00366 <span class="comment">                    */</span>
<a name="l00367"></a>00367                     crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 0.5f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(aperture*(dof_sp*(cam_invfdist - iZ) - 1.f));
<a name="l00368"></a>00368                     
<a name="l00369"></a>00369                     <span class="comment">// &#39;bug&#39; #6615, limit minimum radius to 1 pixel, not really a solution, but somewhat mitigates the problem</span>
<a name="l00370"></a>00370                     crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px], 0.5f);
<a name="l00371"></a>00371                     <span class="comment">// if maxblur!=0, limit maximum</span>
<a name="l00372"></a>00372                     <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a31cf47f54a99b3e03683a6903f0ef8f9">maxblur</a> != 0.f) crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px], nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a31cf47f54a99b3e03683a6903f0ef8f9">maxblur</a>);
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374                 <span class="keywordflow">else</span> crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 0.f;
<a name="l00375"></a>00375                 <span class="comment">// clear weights for next part</span>
<a name="l00376"></a>00376                 wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[px] = 0.f;
<a name="l00377"></a>00377             }
<a name="l00378"></a>00378             <span class="comment">// esc set by main calling process</span>
<a name="l00379"></a>00379             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa630997609916544ff15aaa45a2f639e">exec</a> &amp; <a class="code" href="../../d4/d91/BKE__node_8h.html#ac20bfa82bfa40e0dbcb4c41c2d5ee603">NODE_BREAK</a>)
<a name="l00380"></a>00380                 <span class="keywordflow">break</span>;
<a name="l00381"></a>00381         }
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">//------------------------------------------------------------------</span>
<a name="l00385"></a>00385     <span class="comment">// main loop</span>
<a name="l00386"></a>00386 <span class="preprocessor">#ifndef __APPLE__ </span><span class="comment">/* can crash on Mac, see bug #22856, disabled for now */</span>
<a name="l00387"></a>00387 <span class="preprocessor">#ifdef __INTEL_COMPILER </span><span class="comment">/* icc doesn&#39;t like the compound statement -- internal error: 0_1506 */</span>
<a name="l00388"></a>00388 <span class="preprocessor">    #pragma omp parallel for private(y) if (!nqd-&gt;preview) schedule(guided)</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span><span class="preprocessor">    #pragma omp parallel for private(y) if (!nqd-&gt;preview &amp;&amp; img-&gt;y*img-&gt;x &gt; 16384) schedule(guided)</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (y=0; y&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>; y++) {
<a name="l00394"></a>00394         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, p4, zp, cp, cp4;
<a name="l00395"></a>00395         <span class="keywordtype">float</span> *ctcol, u, v, ct_crad, cR2=0;
<a name="l00396"></a>00396         <span class="keywordtype">int</span> x, sx, sy;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398         <span class="comment">// some sort of visual feedback would be nice, or at least this text in the renderwin header</span>
<a name="l00399"></a>00399         <span class="comment">// but for now just print some info in the console every 8 scanlines.</span>
<a name="l00400"></a>00400 <span class="preprocessor">        #pragma omp critical</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>        {
<a name="l00402"></a>00402             <span class="keywordflow">if</span> (((ydone &amp; 7)==0) || (ydone==(img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>-1))) {
<a name="l00403"></a>00403                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background==0) {
<a name="l00404"></a>00404                     printf(<span class="stringliteral">&quot;\rdefocus: Processing Line %d of %d ... &quot;</span>, ydone+1, img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>);
<a name="l00405"></a>00405                     fflush(stdout);
<a name="l00406"></a>00406                 }
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409             ydone++;
<a name="l00410"></a>00410         }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         <span class="comment">// esc set by main calling process. don&#39;t break because openmp doesn&#39;t</span>
<a name="l00413"></a>00413         <span class="comment">// allow it, just continue and do nothing </span>
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa630997609916544ff15aaa45a2f639e">exec</a> &amp; <a class="code" href="../../d4/d91/BKE__node_8h.html#ac20bfa82bfa40e0dbcb4c41c2d5ee603">NODE_BREAK</a>)
<a name="l00415"></a>00415             <span class="keywordflow">continue</span>;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         zp = y * img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>;
<a name="l00418"></a>00418         <span class="keywordflow">for</span> (x=0; x&lt;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>; x++) {
<a name="l00419"></a>00419             cp = zp + x;
<a name="l00420"></a>00420             cp4 = cp * img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a30f16acd6a84c370ce27661f385a8ea1">type</a>;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             <span class="comment">// Circle of Confusion radius for current pixel</span>
<a name="l00423"></a>00423             cR2 = ct_crad = crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp];
<a name="l00424"></a>00424             <span class="comment">// skip if zero (border render)</span>
<a name="l00425"></a>00425             <span class="keywordflow">if</span> (ct_crad==0.f) {
<a name="l00426"></a>00426                 <span class="comment">// related to bug #5921, forgot output image when skipping 0 radius values</span>
<a name="l00427"></a>00427                 <span class="keyword">new</span>-&gt;rect[cp4] = img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp4];
<a name="l00428"></a>00428                 <span class="keywordflow">if</span> (new-&gt;type != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00429"></a>00429                     <span class="keyword">new</span>-&gt;rect[cp4+1] = img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp4+1];
<a name="l00430"></a>00430                     <span class="keyword">new</span>-&gt;rect[cp4+2] = img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp4+2];
<a name="l00431"></a>00431                     <span class="keyword">new</span>-&gt;rect[cp4+3] = img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp4+3];
<a name="l00432"></a>00432                 }
<a name="l00433"></a>00433                 <span class="keywordflow">continue</span>;
<a name="l00434"></a>00434             }
<a name="l00435"></a>00435             cR2 *= cR2;
<a name="l00436"></a>00436             
<a name="l00437"></a>00437             <span class="comment">// pixel color</span>
<a name="l00438"></a>00438             ctcol = &amp;img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp4];
<a name="l00439"></a>00439             
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (!nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#abec6764c609f1b735d82873ca7ee753d">preview</a>) {
<a name="l00441"></a>00441                 <span class="keywordtype">int</span> xs, xe, ys, ye;
<a name="l00442"></a>00442                 <span class="keywordtype">float</span> lwt, wtcol[4] = {0}, aacol[4] = {0};
<a name="l00443"></a>00443                 <span class="keywordtype">float</span> wt;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445                 <span class="comment">// shape weight</span>
<a name="l00446"></a>00446                 <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a>==0) <span class="comment">// disk</span>
<a name="l00447"></a>00447                     wt = 1.f/((float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*cR2);
<a name="l00448"></a>00448                 <span class="keywordflow">else</span>
<a name="l00449"></a>00449                     wt = 1.f/(cR2*bk_hn_theta);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                 <span class="comment">// weighted color</span>
<a name="l00452"></a>00452                 wtcol[0] = wt*ctcol[0];
<a name="l00453"></a>00453                 <span class="keywordflow">if</span> (new-&gt;type != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00454"></a>00454                     wtcol[1] = wt*ctcol[1];
<a name="l00455"></a>00455                     wtcol[2] = wt*ctcol[2];
<a name="l00456"></a>00456                     wtcol[3] = wt*ctcol[3];
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459                 <span class="comment">// macro for background blur overlap test</span>
<a name="l00460"></a>00460                 <span class="comment">// unfortunately, since this is done per pixel,</span>
<a name="l00461"></a>00461                 <span class="comment">// it has a very significant negative impact on processing time...</span>
<a name="l00462"></a>00462                 <span class="comment">// (eg. aa disk blur without test: 112 sec, vs with test: 176 sec...)</span>
<a name="l00463"></a>00463                 <span class="comment">// iff center blur radius &gt; threshold</span>
<a name="l00464"></a>00464                 <span class="comment">// and if overlap pixel in focus, do nothing, else add color/weigbt</span>
<a name="l00465"></a>00465                 <span class="comment">// (threshold constant is dependent on amount of blur)</span>
<a name="l00466"></a>00466 <span class="preprocessor">                #define TESTBG1(c, w) {\</span>
<a name="l00467"></a>00467 <span class="preprocessor">                    if (ct_crad &gt; nqd-&gt;bthresh) {\</span>
<a name="l00468"></a>00468 <span class="preprocessor">                        if (crad-&gt;rect[p] &gt; nqd-&gt;bthresh) {\</span>
<a name="l00469"></a>00469 <span class="preprocessor">                            new-&gt;rect[p] += c[0];\</span>
<a name="l00470"></a>00470 <span class="preprocessor">                            wts-&gt;rect[p] += w;\</span>
<a name="l00471"></a>00471 <span class="preprocessor">                        }\</span>
<a name="l00472"></a>00472 <span class="preprocessor">                    }\</span>
<a name="l00473"></a>00473 <span class="preprocessor">                    else {\</span>
<a name="l00474"></a>00474 <span class="preprocessor">                        new-&gt;rect[p] += c[0];\</span>
<a name="l00475"></a>00475 <span class="preprocessor">                        wts-&gt;rect[p] += w;\</span>
<a name="l00476"></a>00476 <span class="preprocessor">                    }\</span>
<a name="l00477"></a>00477 <span class="preprocessor">                }</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">                #define TESTBG4(c, w) {\</span>
<a name="l00479"></a>00479 <span class="preprocessor">                    if (ct_crad &gt; nqd-&gt;bthresh) {\</span>
<a name="l00480"></a>00480 <span class="preprocessor">                        if (crad-&gt;rect[p] &gt; nqd-&gt;bthresh) {\</span>
<a name="l00481"></a>00481 <span class="preprocessor">                            new-&gt;rect[p4] += c[0];\</span>
<a name="l00482"></a>00482 <span class="preprocessor">                            new-&gt;rect[p4+1] += c[1];\</span>
<a name="l00483"></a>00483 <span class="preprocessor">                            new-&gt;rect[p4+2] += c[2];\</span>
<a name="l00484"></a>00484 <span class="preprocessor">                            new-&gt;rect[p4+3] += c[3];\</span>
<a name="l00485"></a>00485 <span class="preprocessor">                            wts-&gt;rect[p] += w;\</span>
<a name="l00486"></a>00486 <span class="preprocessor">                        }\</span>
<a name="l00487"></a>00487 <span class="preprocessor">                    }\</span>
<a name="l00488"></a>00488 <span class="preprocessor">                    else {\</span>
<a name="l00489"></a>00489 <span class="preprocessor">                        new-&gt;rect[p4] += c[0];\</span>
<a name="l00490"></a>00490 <span class="preprocessor">                        new-&gt;rect[p4+1] += c[1];\</span>
<a name="l00491"></a>00491 <span class="preprocessor">                        new-&gt;rect[p4+2] += c[2];\</span>
<a name="l00492"></a>00492 <span class="preprocessor">                        new-&gt;rect[p4+3] += c[3];\</span>
<a name="l00493"></a>00493 <span class="preprocessor">                        wts-&gt;rect[p] += w;\</span>
<a name="l00494"></a>00494 <span class="preprocessor">                    }\</span>
<a name="l00495"></a>00495 <span class="preprocessor">                }</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a> == 0) {
<a name="l00497"></a>00497                     <span class="comment">// Disk</span>
<a name="l00498"></a>00498                     <span class="keywordtype">int</span> _x, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, di;
<a name="l00499"></a>00499                     <span class="keywordtype">float</span> Dj, <a class="code" href="../../d2/d6c/mball_8c.html#a0acb682b8260ab1c60b918599864e2e5">T</a>;
<a name="l00500"></a>00500                     <span class="comment">// AA pixel</span>
<a name="l00501"></a>00501 <span class="preprocessor">                    #define AAPIX(a, b) {\</span>
<a name="l00502"></a>00502 <span class="preprocessor">                        int _ny = b;\</span>
<a name="l00503"></a>00503 <span class="preprocessor">                        if ((_ny &gt;= 0) &amp;&amp; (_ny &lt; new-&gt;y)) {\</span>
<a name="l00504"></a>00504 <span class="preprocessor">                            int _nx = a;\</span>
<a name="l00505"></a>00505 <span class="preprocessor">                            if ((_nx &gt;=0) &amp;&amp; (_nx &lt; new-&gt;x)) {\</span>
<a name="l00506"></a>00506 <span class="preprocessor">                                p = _ny*new-&gt;x + _nx;\</span>
<a name="l00507"></a>00507 <span class="preprocessor">                                if (new-&gt;type==CB_VAL) {\</span>
<a name="l00508"></a>00508 <span class="preprocessor">                                    TESTBG1(aacol, lwt);\</span>
<a name="l00509"></a>00509 <span class="preprocessor">                                }\</span>
<a name="l00510"></a>00510 <span class="preprocessor">                                else {\</span>
<a name="l00511"></a>00511 <span class="preprocessor">                                    p4 = p * new-&gt;type;\</span>
<a name="l00512"></a>00512 <span class="preprocessor">                                    TESTBG4(aacol, lwt);\</span>
<a name="l00513"></a>00513 <span class="preprocessor">                                }\</span>
<a name="l00514"></a>00514 <span class="preprocessor">                            }\</span>
<a name="l00515"></a>00515 <span class="preprocessor">                        }\</span>
<a name="l00516"></a>00516 <span class="preprocessor">                    }</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>                    <span class="comment">// circle scanline</span>
<a name="l00518"></a>00518 <span class="preprocessor">                    #define CSCAN(a, b) {\</span>
<a name="l00519"></a>00519 <span class="preprocessor">                        int _ny = y + b;\</span>
<a name="l00520"></a>00520 <span class="preprocessor">                        if ((_ny &gt;= 0) &amp;&amp; (_ny &lt; new-&gt;y)) {\</span>
<a name="l00521"></a>00521 <span class="preprocessor">                            xs = x - a + 1;\</span>
<a name="l00522"></a>00522 <span class="preprocessor">                            if (xs &lt; 0) xs = 0;\</span>
<a name="l00523"></a>00523 <span class="preprocessor">                            xe = x + a;\</span>
<a name="l00524"></a>00524 <span class="preprocessor">                            if (xe &gt; new-&gt;x) xe = new-&gt;x;\</span>
<a name="l00525"></a>00525 <span class="preprocessor">                            p = _ny*new-&gt;x + xs;\</span>
<a name="l00526"></a>00526 <span class="preprocessor">                            if (new-&gt;type==CB_VAL) {\</span>
<a name="l00527"></a>00527 <span class="preprocessor">                                for (_x=xs; _x&lt;xe; _x++, p++) TESTBG1(wtcol, wt);\</span>
<a name="l00528"></a>00528 <span class="preprocessor">                            }\</span>
<a name="l00529"></a>00529 <span class="preprocessor">                            else {\</span>
<a name="l00530"></a>00530 <span class="preprocessor">                                p4 = p * new-&gt;type;\</span>
<a name="l00531"></a>00531 <span class="preprocessor">                                for (_x=xs; _x&lt;xe; _x++, p++, p4+=new-&gt;type) TESTBG4(wtcol, wt);\</span>
<a name="l00532"></a>00532 <span class="preprocessor">                            }\</span>
<a name="l00533"></a>00533 <span class="preprocessor">                        }\</span>
<a name="l00534"></a>00534 <span class="preprocessor">                    }</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>
<a name="l00536"></a>00536                     i = ceil(ct_crad);
<a name="l00537"></a>00537                     j = 0;
<a name="l00538"></a>00538                     T = 0;
<a name="l00539"></a>00539                     <span class="keywordflow">while</span> (i &gt; j) {
<a name="l00540"></a>00540                         Dj = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(cR2 - j*j);
<a name="l00541"></a>00541                         Dj -= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#addfa7d645df6e3c96924f253d8fb9b48">floorf</a>(Dj);
<a name="l00542"></a>00542                         di = 0;
<a name="l00543"></a>00543                         <span class="keywordflow">if</span> (Dj &gt; T) { i--;  di = 1; }
<a name="l00544"></a>00544                         T = Dj;
<a name="l00545"></a>00545                         aacol[0] = wtcol[0]*Dj;
<a name="l00546"></a>00546                         <span class="keywordflow">if</span> (new-&gt;type != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00547"></a>00547                             aacol[1] = wtcol[1]*Dj;
<a name="l00548"></a>00548                             aacol[2] = wtcol[2]*Dj;
<a name="l00549"></a>00549                             aacol[3] = wtcol[3]*Dj;
<a name="l00550"></a>00550                         }
<a name="l00551"></a>00551                         lwt = wt*Dj;
<a name="l00552"></a>00552                         <span class="keywordflow">if</span> (i!=j) {
<a name="l00553"></a>00553                             <span class="comment">// outer pixels</span>
<a name="l00554"></a>00554                             <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x+j, y+i)
<a name="l00555"></a>00555                             <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x+j, y-i)
<a name="l00556"></a>00556                             <span class="keywordflow">if</span> (j) {
<a name="l00557"></a>00557                                 <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x-j, y+i) <span class="comment">// BL</span>
<a name="l00558"></a>00558                                 <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x-j, y-i) <span class="comment">// TL</span>
<a name="l00559"></a>00559                             }
<a name="l00560"></a>00560                             <span class="keywordflow">if</span> (di) { <span class="comment">// only when i changed, interior of outer section</span>
<a name="l00561"></a>00561                                 <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a78b08387758081be4156cd640b6b4a72">CSCAN</a>(j, i) <span class="comment">// bottom</span>
<a name="l00562"></a>00562                                 <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a78b08387758081be4156cd640b6b4a72">CSCAN</a>(j, -i) <span class="comment">// top</span>
<a name="l00563"></a>00563                             }
<a name="l00564"></a>00564                         }
<a name="l00565"></a>00565                         <span class="comment">// lower mid section</span>
<a name="l00566"></a>00566                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x+i, y+j)
<a name="l00567"></a>00567                         <span class="keywordflow">if</span> (i) <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x-i, y+j)
<a name="l00568"></a>00568                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a78b08387758081be4156cd640b6b4a72">CSCAN</a>(i, j)
<a name="l00569"></a>00569                         <span class="comment">// upper mid section</span>
<a name="l00570"></a>00570                         <span class="keywordflow">if</span> (j) {
<a name="l00571"></a>00571                             <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x+i, y-j)
<a name="l00572"></a>00572                             <span class="keywordflow">if</span> (i) <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a83df56e3fbd21b430b3beccd672d8a28">AAPIX</a>(x-i, y-j)
<a name="l00573"></a>00573                             <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a78b08387758081be4156cd640b6b4a72">CSCAN</a>(i, -j)
<a name="l00574"></a>00574                         }
<a name="l00575"></a>00575                         j++;
<a name="l00576"></a>00576                     }
<a name="l00577"></a>00577 <span class="preprocessor">                    #undef CSCAN</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span><span class="preprocessor">                    #undef AAPIX</span>
<a name="l00579"></a>00579 <span class="preprocessor"></span>                }
<a name="l00580"></a>00580                 <span class="keywordflow">else</span> {
<a name="l00581"></a>00581                     <span class="comment">// n-agonal</span>
<a name="l00582"></a>00582                     <span class="keywordtype">int</span> ov, nv;
<a name="l00583"></a>00583                     <span class="keywordtype">float</span> mind, maxd, lwt;
<a name="l00584"></a>00584                     ys = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>((<span class="keywordtype">int</span>)floor(bkh_b[2]*ct_crad + y), 0);
<a name="l00585"></a>00585                     ye = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>((<span class="keywordtype">int</span>)ceil(bkh_b[3]*ct_crad + y), new-&gt;y - 1);
<a name="l00586"></a>00586                     <span class="keywordflow">for</span> (sy=ys; sy&lt;=ye; sy++) {
<a name="l00587"></a>00587                         <span class="keywordtype">float</span> fxs = 1e10f, fxe = -1e10f;
<a name="l00588"></a>00588                         <span class="keywordtype">float</span> yf = (sy - y)/ct_crad;
<a name="l00589"></a>00589                         <span class="keywordtype">int</span> found = 0;
<a name="l00590"></a>00590                         ov = len_bkh - 1;
<a name="l00591"></a>00591                         mind = maxd = 0;
<a name="l00592"></a>00592                         <span class="keywordflow">for</span> (nv=0; nv&lt;len_bkh; nv++) {
<a name="l00593"></a>00593                             <span class="keywordflow">if</span> ((BKH[nv].max_y &gt;= yf) &amp;&amp; (BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a01fb9f093644f052ea93f63a786c324c">min_y</a> &lt;= yf)) {
<a name="l00594"></a>00594                                 <span class="keywordtype">float</span> tx = BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a> + BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a>*(yf - BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a>);
<a name="l00595"></a>00595                                 <span class="keywordflow">if</span> (tx &lt; fxs) { fxs = tx;  mind = BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a>; }
<a name="l00596"></a>00596                                 <span class="keywordflow">if</span> (tx &gt; fxe) { fxe = tx;  maxd = BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a851e8f812fceee400d3a1767e4fcf03f">ls_x</a>; }
<a name="l00597"></a>00597                                 <span class="keywordflow">if</span> (++found == 2) <span class="keywordflow">break</span>;
<a name="l00598"></a>00598                             }
<a name="l00599"></a>00599                             ov = nv;
<a name="l00600"></a>00600                         }
<a name="l00601"></a>00601                         <span class="keywordflow">if</span> (found) {
<a name="l00602"></a>00602                             fxs = fxs*ct_crad + x;
<a name="l00603"></a>00603                             fxe = fxe*ct_crad + x;
<a name="l00604"></a>00604                             xs = (int)floor(fxs), xe = (int)ceil(fxe);
<a name="l00605"></a>00605                             <span class="comment">// AA hack for first and last x pixel, near vertical edges only</span>
<a name="l00606"></a>00606                             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(mind) &lt;= 1.f) {
<a name="l00607"></a>00607                                 <span class="keywordflow">if</span> ((xs &gt;= 0) &amp;&amp; (xs &lt; <span class="keyword">new</span>-&gt;x)) {
<a name="l00608"></a>00608                                     lwt = 1.f-(fxs - xs);
<a name="l00609"></a>00609                                     aacol[0] = wtcol[0]*lwt;
<a name="l00610"></a>00610                                     p = xs + sy*<span class="keyword">new</span>-&gt;x;
<a name="l00611"></a>00611                                     <span class="keywordflow">if</span> (new-&gt;type==<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00612"></a>00612                                         lwt *= wt;
<a name="l00613"></a>00613                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a5de3bfb2e3b604650ce632488c176d39">TESTBG1</a>(aacol, lwt);
<a name="l00614"></a>00614                                     }
<a name="l00615"></a>00615                                     <span class="keywordflow">else</span> {
<a name="l00616"></a>00616                                         p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00617"></a>00617                                         aacol[1] = wtcol[1]*lwt;
<a name="l00618"></a>00618                                         aacol[2] = wtcol[2]*lwt;
<a name="l00619"></a>00619                                         aacol[3] = wtcol[3]*lwt;
<a name="l00620"></a>00620                                         lwt *= wt;
<a name="l00621"></a>00621                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a019354fadb02d9d4bc163ef9a0acf16f">TESTBG4</a>(aacol, lwt);
<a name="l00622"></a>00622                                     }
<a name="l00623"></a>00623                                 }
<a name="l00624"></a>00624                             }
<a name="l00625"></a>00625                             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(maxd) &lt;= 1.f) {
<a name="l00626"></a>00626                                 <span class="keywordflow">if</span> ((xe &gt;= 0) &amp;&amp; (xe &lt; new-&gt;x)) {
<a name="l00627"></a>00627                                     lwt = 1.f-(xe - fxe);
<a name="l00628"></a>00628                                     aacol[0] = wtcol[0]*lwt;
<a name="l00629"></a>00629                                     p = xe + sy*<span class="keyword">new</span>-&gt;x;
<a name="l00630"></a>00630                                     <span class="keywordflow">if</span> (new-&gt;type==<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00631"></a>00631                                         lwt *= wt;
<a name="l00632"></a>00632                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a5de3bfb2e3b604650ce632488c176d39">TESTBG1</a>(aacol, lwt);
<a name="l00633"></a>00633                                     }
<a name="l00634"></a>00634                                     <span class="keywordflow">else</span> {
<a name="l00635"></a>00635                                         p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00636"></a>00636                                         aacol[1] = wtcol[1]*lwt;
<a name="l00637"></a>00637                                         aacol[2] = wtcol[2]*lwt;
<a name="l00638"></a>00638                                         aacol[3] = wtcol[3]*lwt;
<a name="l00639"></a>00639                                         lwt *= wt;
<a name="l00640"></a>00640                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a019354fadb02d9d4bc163ef9a0acf16f">TESTBG4</a>(aacol, lwt);
<a name="l00641"></a>00641                                     }
<a name="l00642"></a>00642                                 }
<a name="l00643"></a>00643                             }
<a name="l00644"></a>00644                             xs = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(xs+1, 0);
<a name="l00645"></a>00645                             xe = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(xe, new-&gt;x);
<a name="l00646"></a>00646                             <span class="comment">// remaining interior scanline</span>
<a name="l00647"></a>00647                             p = sy*<span class="keyword">new</span>-&gt;x + xs;
<a name="l00648"></a>00648                             <span class="keywordflow">if</span> (new-&gt;type==<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00649"></a>00649                                 <span class="keywordflow">for</span> (sx=xs; sx&lt;xe; sx++, p++) <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a5de3bfb2e3b604650ce632488c176d39">TESTBG1</a>(wtcol, wt);
<a name="l00650"></a>00650                             }
<a name="l00651"></a>00651                             <span class="keywordflow">else</span> {
<a name="l00652"></a>00652                                 p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00653"></a>00653                                 <span class="keywordflow">for</span> (sx=xs; sx&lt;xe; sx++, p++, p4+=<span class="keyword">new</span>-&gt;type) <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a019354fadb02d9d4bc163ef9a0acf16f">TESTBG4</a>(wtcol, wt);
<a name="l00654"></a>00654                             }
<a name="l00655"></a>00655                         }
<a name="l00656"></a>00656                     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658                     <span class="comment">// now traverse in opposite direction, y scanlines,</span>
<a name="l00659"></a>00659                     <span class="comment">// but this time only draw the near horizontal edges,</span>
<a name="l00660"></a>00660                     <span class="comment">// applying same AA hack as above</span>
<a name="l00661"></a>00661                     xs = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>((<span class="keywordtype">int</span>)floor(bkh_b[0]*ct_crad + x), 0);
<a name="l00662"></a>00662                     xe = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>((<span class="keywordtype">int</span>)ceil(bkh_b[1]*ct_crad + x), img-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a> - 1);
<a name="l00663"></a>00663                     <span class="keywordflow">for</span> (sx=xs; sx&lt;=xe; sx++) {
<a name="l00664"></a>00664                         <span class="keywordtype">float</span> xf = (sx - x)/ct_crad;
<a name="l00665"></a>00665                         <span class="keywordtype">float</span> fys = 1e10f, fye = -1e10f;
<a name="l00666"></a>00666                         <span class="keywordtype">int</span> found = 0;
<a name="l00667"></a>00667                         ov = len_bkh - 1;
<a name="l00668"></a>00668                         mind = maxd = 0;
<a name="l00669"></a>00669                         <span class="keywordflow">for</span> (nv=0; nv&lt;len_bkh; nv++) {
<a name="l00670"></a>00670                             <span class="keywordflow">if</span> ((BKH[nv].max_x &gt;= xf) &amp;&amp; (BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a488187ac71d3e89a57d4a678d095257a">min_x</a> &lt;= xf)) {
<a name="l00671"></a>00671                                 <span class="keywordtype">float</span> ty = BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#aa8a4153961040c2c3cda23bc4cd3891e">y0</a> + BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">ls_y</a>*(xf - BKH[ov].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a243e33ef6f8bcdfe2b2cb6e723b50de2">x0</a>);
<a name="l00672"></a>00672                                 <span class="keywordflow">if</span> (ty &lt; fys) { fys = ty;  mind = BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">ls_y</a>; }
<a name="l00673"></a>00673                                 <span class="keywordflow">if</span> (ty &gt; fye) { fye = ty;  maxd = BKH[nv].<a class="code" href="../../d9/d85/structBokehCoeffs.html#a14f6570527d1b1bd30c608f1d0e4a0c3">ls_y</a>; }
<a name="l00674"></a>00674                                 <span class="keywordflow">if</span> (++found == 2) <span class="keywordflow">break</span>;
<a name="l00675"></a>00675                             }
<a name="l00676"></a>00676                             ov = nv;
<a name="l00677"></a>00677                         }
<a name="l00678"></a>00678                         <span class="keywordflow">if</span> (found) {
<a name="l00679"></a>00679                             fys = fys*ct_crad + y;
<a name="l00680"></a>00680                             fye = fye*ct_crad + y;
<a name="l00681"></a>00681                             <span class="comment">// near horizontal edges only, line slope &lt;= 1</span>
<a name="l00682"></a>00682                             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(mind) &lt;= 1.f) {
<a name="l00683"></a>00683                                 <span class="keywordtype">int</span> iys = (int)floor(fys);
<a name="l00684"></a>00684                                 <span class="keywordflow">if</span> ((iys &gt;= 0) &amp;&amp; (iys &lt; <span class="keyword">new</span>-&gt;y)) {
<a name="l00685"></a>00685                                     lwt = 1.f - (fys - iys);
<a name="l00686"></a>00686                                     aacol[0] = wtcol[0]*lwt;
<a name="l00687"></a>00687                                     p = sx + iys*<span class="keyword">new</span>-&gt;x;
<a name="l00688"></a>00688                                     <span class="keywordflow">if</span> (new-&gt;type==<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00689"></a>00689                                         lwt *= wt;
<a name="l00690"></a>00690                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a5de3bfb2e3b604650ce632488c176d39">TESTBG1</a>(aacol, lwt);
<a name="l00691"></a>00691                                     }
<a name="l00692"></a>00692                                     <span class="keywordflow">else</span> {
<a name="l00693"></a>00693                                         p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00694"></a>00694                                         aacol[1] = wtcol[1]*lwt;
<a name="l00695"></a>00695                                         aacol[2] = wtcol[2]*lwt;
<a name="l00696"></a>00696                                         aacol[3] = wtcol[3]*lwt;
<a name="l00697"></a>00697                                         lwt *= wt;
<a name="l00698"></a>00698                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a019354fadb02d9d4bc163ef9a0acf16f">TESTBG4</a>(aacol, lwt);
<a name="l00699"></a>00699                                     }
<a name="l00700"></a>00700                                 }
<a name="l00701"></a>00701                             }
<a name="l00702"></a>00702                             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(maxd) &lt;= 1.f) {
<a name="l00703"></a>00703                                 <span class="keywordtype">int</span> iye = ceil(fye);
<a name="l00704"></a>00704                                 <span class="keywordflow">if</span> ((iye &gt;= 0) &amp;&amp; (iye &lt; new-&gt;y)) {
<a name="l00705"></a>00705                                     lwt = 1.f - (iye - fye);
<a name="l00706"></a>00706                                     aacol[0] = wtcol[0]*lwt;
<a name="l00707"></a>00707                                     p = sx + iye*<span class="keyword">new</span>-&gt;x;
<a name="l00708"></a>00708                                     <span class="keywordflow">if</span> (new-&gt;type==<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00709"></a>00709                                         lwt *= wt;
<a name="l00710"></a>00710                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a5de3bfb2e3b604650ce632488c176d39">TESTBG1</a>(aacol, lwt);
<a name="l00711"></a>00711                                     }
<a name="l00712"></a>00712                                     <span class="keywordflow">else</span> {
<a name="l00713"></a>00713                                         p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00714"></a>00714                                         aacol[1] = wtcol[1]*lwt;
<a name="l00715"></a>00715                                         aacol[2] = wtcol[2]*lwt;
<a name="l00716"></a>00716                                         aacol[3] = wtcol[3]*lwt;
<a name="l00717"></a>00717                                         lwt *= wt;
<a name="l00718"></a>00718                                         <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a019354fadb02d9d4bc163ef9a0acf16f">TESTBG4</a>(aacol, lwt);
<a name="l00719"></a>00719                                     }
<a name="l00720"></a>00720                                 }
<a name="l00721"></a>00721                             }
<a name="l00722"></a>00722                         }
<a name="l00723"></a>00723                     }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725                 }
<a name="l00726"></a>00726 <span class="preprocessor">                #undef TESTBG4</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span><span class="preprocessor">                #undef TESTBG1</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730             <span class="keywordflow">else</span> {
<a name="l00731"></a>00731                 <span class="comment">// sampled, simple rejection sampling here, good enough</span>
<a name="l00732"></a>00732                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxsam, s, ui = <a class="code" href="../../d3/d88/BLI__rand_8h.html#aed3a0fd477063acc5f19de297b4c4bec">BLI_rand</a>()*<a class="code" href="../../d3/d88/BLI__rand_8h.html#aed3a0fd477063acc5f19de297b4c4bec">BLI_rand</a>();
<a name="l00733"></a>00733                 <span class="keywordtype">float</span> wcor, cpr = <a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>(), lwt;
<a name="l00734"></a>00734                 <span class="keywordflow">if</span> (no_zbuf)
<a name="l00735"></a>00735                     maxsam = nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a475d6ba2ada232b7c05f0db7f6fc922a">samples</a>;  <span class="comment">// no zbuffer input, use sample value directly</span>
<a name="l00736"></a>00736                 <span class="keywordflow">else</span> {
<a name="l00737"></a>00737                     <span class="comment">// depth adaptive sampling hack, the more out of focus, the more samples taken, 16 minimum.</span>
<a name="l00738"></a>00738                     maxsam = (int)(0.5f + nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a475d6ba2ada232b7c05f0db7f6fc922a">samples</a>*(1.f-(<span class="keywordtype">float</span>)<a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(-<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(zbuf-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[cp] - cam_fdist))));
<a name="l00739"></a>00739                     <span class="keywordflow">if</span> (maxsam &lt; 16) maxsam = 16;
<a name="l00740"></a>00740                 }
<a name="l00741"></a>00741                 wcor = 1.f/(float)maxsam;
<a name="l00742"></a>00742                 <span class="keywordflow">for</span> (s=0; s&lt;maxsam; ++s) {
<a name="l00743"></a>00743                     u = ct_crad*(2.f*<a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a24cb467c9dcbb0d7027912deea6d53c2">RI_vdC</a>(s, ui) - 1.f);
<a name="l00744"></a>00744                     v = ct_crad*(2.f*(s + cpr)/(<span class="keywordtype">float</span>)maxsam - 1.f);
<a name="l00745"></a>00745                     sx = (int)(x + u + 0.5f), sy = (int)(y + v + 0.5f);
<a name="l00746"></a>00746                     <span class="keywordflow">if</span> ((sx&lt;0) || (sx &gt;= <span class="keyword">new</span>-&gt;x) || (sy&lt;0) || (sy &gt;= <span class="keyword">new</span>-&gt;y)) <span class="keywordflow">continue</span>;
<a name="l00747"></a>00747                     p = sx + sy*<span class="keyword">new</span>-&gt;x;
<a name="l00748"></a>00748                     p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00749"></a>00749                     <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a>==0) <span class="comment">// Disk</span>
<a name="l00750"></a>00750                         lwt = ((u*u + v*v)&lt;=cR2) ? wcor : 0.f;
<a name="l00751"></a>00751                     <span class="keywordflow">else</span>    <span class="comment">// AA not needed here</span>
<a name="l00752"></a>00752                         lwt = wcor * <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#ac02bcff61124956b84ffd0dd1a8c09d1">getWeight</a>(BKH, len_bkh, u, v, ct_crad, inradsq);
<a name="l00753"></a>00753                     <span class="comment">// prevent background bleeding onto in-focus pixels, user-option</span>
<a name="l00754"></a>00754                     <span class="keywordflow">if</span> (ct_crad &gt; nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ad9f66a717444b424b18218ba97fa4b9b">bthresh</a>) {  <span class="comment">// if center blur &gt; threshold</span>
<a name="l00755"></a>00755                         <span class="keywordflow">if</span> (crad-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[p] &gt; nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ad9f66a717444b424b18218ba97fa4b9b">bthresh</a>) { <span class="comment">// if overlap pixel in focus, do nothing, else add color/weigbt</span>
<a name="l00756"></a>00756                             <span class="keyword">new</span>-&gt;rect[p4] += ctcol[0] * lwt;
<a name="l00757"></a>00757                             <span class="keywordflow">if</span> (new-&gt;type != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00758"></a>00758                                 <span class="keyword">new</span>-&gt;rect[p4+1] += ctcol[1] * lwt;
<a name="l00759"></a>00759                                 <span class="keyword">new</span>-&gt;rect[p4+2] += ctcol[2] * lwt;
<a name="l00760"></a>00760                                 <span class="keyword">new</span>-&gt;rect[p4+3] += ctcol[3] * lwt;
<a name="l00761"></a>00761                             }
<a name="l00762"></a>00762                             wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] += lwt;
<a name="l00763"></a>00763                         }
<a name="l00764"></a>00764                     }
<a name="l00765"></a>00765                     <span class="keywordflow">else</span> {
<a name="l00766"></a>00766                         <span class="keyword">new</span>-&gt;rect[p4] += ctcol[0] * lwt;
<a name="l00767"></a>00767                         <span class="keywordflow">if</span> (new-&gt;type != <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00768"></a>00768                             <span class="keyword">new</span>-&gt;rect[p4+1] += ctcol[1] * lwt;
<a name="l00769"></a>00769                             <span class="keyword">new</span>-&gt;rect[p4+2] += ctcol[2] * lwt;
<a name="l00770"></a>00770                             <span class="keyword">new</span>-&gt;rect[p4+3] += ctcol[3] * lwt;
<a name="l00771"></a>00771                         }
<a name="l00772"></a>00772                         wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>] += lwt;
<a name="l00773"></a>00773                     }
<a name="l00774"></a>00774                 }
<a name="l00775"></a>00775             }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     
<a name="l00780"></a>00780     <span class="comment">// finally, normalize</span>
<a name="l00781"></a>00781     <span class="keywordflow">for</span> (y=0; y&lt;<span class="keyword">new</span>-&gt;y; y++) {
<a name="l00782"></a>00782         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = y * <span class="keyword">new</span>-&gt;x;
<a name="l00783"></a>00783         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p4 = p * <span class="keyword">new</span>-&gt;type;
<a name="l00784"></a>00784         <span class="keywordtype">int</span> x;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786         <span class="keywordflow">for</span> (x=0; x&lt;<span class="keyword">new</span>-&gt;x; x++) {
<a name="l00787"></a>00787             <span class="keywordtype">float</span> dv = (wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]==0.f) ? 1.f : (1.f/wts-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a662b5e94dd3842022801d866545ffc31">rect</a>[p]);
<a name="l00788"></a>00788             <span class="keyword">new</span>-&gt;rect[p4] *= dv;
<a name="l00789"></a>00789             <span class="keywordflow">if</span> (new-&gt;type!=<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>) {
<a name="l00790"></a>00790                 <span class="keyword">new</span>-&gt;rect[p4+1] *= dv;
<a name="l00791"></a>00791                 <span class="keyword">new</span>-&gt;rect[p4+2] *= dv;
<a name="l00792"></a>00792                 <span class="keyword">new</span>-&gt;rect[p4+3] *= dv;
<a name="l00793"></a>00793             }
<a name="l00794"></a>00794             p++;
<a name="l00795"></a>00795             p4 += <span class="keyword">new</span>-&gt;type;
<a name="l00796"></a>00796         }
<a name="l00797"></a>00797     }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799     <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(crad);
<a name="l00800"></a>00800     <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(wts);
<a name="l00801"></a>00801     
<a name="l00802"></a>00802     printf(<span class="stringliteral">&quot;Done\n&quot;</span>);
<a name="l00803"></a>00803 }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a6c03e6a49455ddef2f6dd1d937c6eefb">00806</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a6c03e6a49455ddef2f6dd1d937c6eefb">node_composit_exec_defocus</a>(<span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>), <a class="code" href="../../dc/daa/structbNode.html">bNode</a> *node, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **in, <a class="code" href="../../de/d8a/structbNodeStack.html">bNodeStack</a> **out)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     <a class="code" href="../../de/d2a/structCompBuf.html">CompBuf</a> *<span class="keyword">new</span>, *old, *zbuf_use = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *img = in[0]-&gt;<a class="code" href="../../de/d8a/structbNodeStack.html#a7df6710a4f38c0bf036156c5a6d4fe46">data</a>, *zbuf = in[1]-&gt;<a class="code" href="../../de/d8a/structbNodeStack.html#a7df6710a4f38c0bf036156c5a6d4fe46">data</a>;
<a name="l00809"></a>00809     <a class="code" href="../../d4/d94/structNodeDefocus.html">NodeDefocus</a> *nqd = node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a>;
<a name="l00810"></a>00810     <span class="keywordtype">int</span> no_zbuf = nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a9c482a4c7c446a5f7f9eaf254e57380c">no_zbuf</a>;
<a name="l00811"></a>00811     
<a name="l00812"></a>00812     <span class="keywordflow">if</span> ((img==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) || (out[0]-&gt;hasoutput==0)) <span class="keywordflow">return</span>;
<a name="l00813"></a>00813     
<a name="l00814"></a>00814     <span class="comment">// if image not valid type or fstop==infinite (128), nothing to do, pass in to out</span>
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (((img-&gt;type!=<a class="code" href="../../df/d04/node__composite__util_8h.html#a609b7804bac7fbaac234d44e3cc02835">CB_RGBA</a>) &amp;&amp; (img-&gt;type!=<a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>)) || ((no_zbuf==0) &amp;&amp; (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a03ea5920af39877090db3a22a36b01c9">fstop</a>==128.f))) {
<a name="l00816"></a>00816         out[0]-&gt;<a class="code" href="../../de/d8a/structbNodeStack.html#a7df6710a4f38c0bf036156c5a6d4fe46">data</a> = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a379837fd96ea65461fb8e3804de04d4f">pass_on_compbuf</a>(img);
<a name="l00817"></a>00817         <span class="keywordflow">return</span>;
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     
<a name="l00820"></a>00820     <span class="keywordflow">if</span> (zbuf!=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00821"></a>00821         <span class="comment">// Zbuf input, check to make sure, single channel, same size</span>
<a name="l00822"></a>00822         <span class="comment">// doesn&#39;t have to be actual zbuffer, but must be value type</span>
<a name="l00823"></a>00823         <span class="keywordflow">if</span> ((zbuf-&gt;x != img-&gt;x) || (zbuf-&gt;y != img-&gt;y)) {
<a name="l00824"></a>00824             <span class="comment">// could do a scale here instead...</span>
<a name="l00825"></a>00825             printf(<span class="stringliteral">&quot;Z input must be same size as image !\n&quot;</span>);
<a name="l00826"></a>00826             <span class="keywordflow">return</span>;
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828         zbuf_use = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a380ab284f2b0ec68b7d2a3b6c76d52d4">typecheck_compbuf</a>(zbuf, <a class="code" href="../../df/d04/node__composite__util_8h.html#a008dc92c3c80a36d5fb539609e22bd41">CB_VAL</a>);
<a name="l00829"></a>00829     }
<a name="l00830"></a>00830     <span class="keywordflow">else</span> no_zbuf = 1;   <span class="comment">// no zbuffer input</span>
<a name="l00831"></a>00831         
<a name="l00832"></a>00832     <span class="comment">// ok, process</span>
<a name="l00833"></a>00833     old = img;
<a name="l00834"></a>00834     <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a626d50aee3c6d1ae9d7a96bf08aabd30">gamco</a>) {
<a name="l00835"></a>00835         <span class="comment">// gamma correct, blender func is simplified, fixed value &amp; RGBA only,</span>
<a name="l00836"></a>00836         <span class="comment">// should make user param. also depremul and premul afterwards, gamma</span>
<a name="l00837"></a>00837         <span class="comment">// correction can&#39;t work with premul alpha</span>
<a name="l00838"></a>00838         old = <a class="code" href="../../d1/d38/node__composite__util_8c.html#ab077f2f47e97b77fa40698813f4d809a">dupalloc_compbuf</a>(img);
<a name="l00839"></a>00839         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ab7371be9bd30479a18b19df4c814a11e">premul_compbuf</a>(old, 1);
<a name="l00840"></a>00840         <a class="code" href="../../d1/d38/node__composite__util_8c.html#a8cf4a386b5da9fd11ec382a569e1b369">gamma_correct_compbuf</a>(old, 0);
<a name="l00841"></a>00841         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ab7371be9bd30479a18b19df4c814a11e">premul_compbuf</a>(old, 0);
<a name="l00842"></a>00842     }
<a name="l00843"></a>00843     
<a name="l00844"></a>00844     <span class="keyword">new</span> = <a class="code" href="../../d1/d38/node__composite__util_8c.html#a089de797ec2258f13c526e3f20784bfb">alloc_compbuf</a>(old-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a6751cf1f2512bb9acb960191722c0c97">x</a>, old-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#aca69b1dc577080d9b88b6413d6d2c2e8">y</a>, old-&gt;<a class="code" href="../../de/d2a/structCompBuf.html#a30f16acd6a84c370ce27661f385a8ea1">type</a>, 1);
<a name="l00845"></a>00845     <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a199c24e400e950aba8c0f73d151c6413">defocus_blur</a>(node, <span class="keyword">new</span>, old, zbuf_use, in[1]-&gt;vec[0]*nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a936a9530879c2a3f0824e8d34dc778f1">scale</a>, no_zbuf);
<a name="l00846"></a>00846     
<a name="l00847"></a>00847     <span class="keywordflow">if</span> (nqd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a626d50aee3c6d1ae9d7a96bf08aabd30">gamco</a>) {
<a name="l00848"></a>00848         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ab7371be9bd30479a18b19df4c814a11e">premul_compbuf</a>(<span class="keyword">new</span>, 1);
<a name="l00849"></a>00849         <a class="code" href="../../d1/d38/node__composite__util_8c.html#a8cf4a386b5da9fd11ec382a569e1b369">gamma_correct_compbuf</a>(<span class="keyword">new</span>, 1);
<a name="l00850"></a>00850         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ab7371be9bd30479a18b19df4c814a11e">premul_compbuf</a>(<span class="keyword">new</span>, 0);
<a name="l00851"></a>00851         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(old);
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa630997609916544ff15aaa45a2f639e">exec</a> &amp; <a class="code" href="../../d4/d91/BKE__node_8h.html#ac20bfa82bfa40e0dbcb4c41c2d5ee603">NODE_BREAK</a>) {
<a name="l00854"></a>00854         <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(<span class="keyword">new</span>);
<a name="l00855"></a>00855         <span class="keyword">new</span>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00856"></a>00856     }   
<a name="l00857"></a>00857     out[0]-&gt;<a class="code" href="../../de/d8a/structbNodeStack.html#a7df6710a4f38c0bf036156c5a6d4fe46">data</a> = <span class="keyword">new</span>;
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (zbuf_use &amp;&amp; (zbuf_use != zbuf)) <a class="code" href="../../d1/d38/node__composite__util_8c.html#ac4ff3c9d76cd76ddf861c93b6234cadc">free_compbuf</a>(zbuf_use);
<a name="l00859"></a>00859 }
<a name="l00860"></a>00860 
<a name="l00861"></a><a class="code" href="../../d0/daf/node__composite__defocus_8c.html#aa996cb5450037f95ed73197f2d9acbf6">00861</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#aa996cb5450037f95ed73197f2d9acbf6">node_composit_init_defocus</a>(<a class="code" href="../../d9/da9/structbNodeTree.html">bNodeTree</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ntree), <a class="code" href="../../dc/daa/structbNode.html">bNode</a>* node, <a class="code" href="../../dd/dc3/structbNodeTemplate.html">bNodeTemplate</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ntemp))
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     <span class="comment">/* qdn: defocus node */</span>
<a name="l00864"></a>00864     <a class="code" href="../../d4/d94/structNodeDefocus.html">NodeDefocus</a> *nbd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d94/structNodeDefocus.html">NodeDefocus</a>), <span class="stringliteral">&quot;node defocus data&quot;</span>);
<a name="l00865"></a>00865     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ac15de4b043f9ea0df2fead4ec1c831cf">bktype</a> = 0;
<a name="l00866"></a>00866     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#af600ecc90204f54b70262013d7d16d82">rotation</a> = 0.0f;
<a name="l00867"></a>00867     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#abec6764c609f1b735d82873ca7ee753d">preview</a> = 1;
<a name="l00868"></a>00868     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a626d50aee3c6d1ae9d7a96bf08aabd30">gamco</a> = 0;
<a name="l00869"></a>00869     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a475d6ba2ada232b7c05f0db7f6fc922a">samples</a> = 16;
<a name="l00870"></a>00870     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a03ea5920af39877090db3a22a36b01c9">fstop</a> = 128.f;
<a name="l00871"></a>00871     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a31cf47f54a99b3e03683a6903f0ef8f9">maxblur</a> = 0;
<a name="l00872"></a>00872     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#ad9f66a717444b424b18218ba97fa4b9b">bthresh</a> = 1.f;
<a name="l00873"></a>00873     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a936a9530879c2a3f0824e8d34dc778f1">scale</a> = 1.f;
<a name="l00874"></a>00874     nbd-&gt;<a class="code" href="../../d4/d94/structNodeDefocus.html#a9c482a4c7c446a5f7f9eaf254e57380c">no_zbuf</a> = 1;
<a name="l00875"></a>00875     node-&gt;<a class="code" href="../../dc/daa/structbNode.html#aa64d6ff9becb0b14722a85e5b337f874">storage</a> = nbd;
<a name="l00876"></a>00876 }
<a name="l00877"></a>00877 
<a name="l00878"></a><a class="code" href="../../d0/d05/NOD__composite_8h.html#ae55e10de68fa45cd650f5841c3918cfd">00878</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a443e9bbb30c7362fd5ace6c7613e2b37">register_node_type_cmp_defocus</a>(<a class="code" href="../../d7/d11/structbNodeTreeType.html">bNodeTreeType</a> *ttype)
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880     <span class="keyword">static</span> <a class="code" href="../../dd/d0c/structbNodeType.html">bNodeType</a> ntype;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <a class="code" href="../../d4/d91/BKE__node_8h.html#ad72f02bc8d3724fd040a4c7b04c7ae6b">node_type_base</a>(ttype, &amp;ntype, <a class="code" href="../../dc/d4f/rna__nodetree__types_8h.html#a2086c1d38c6ebfa4ff268bf267b7920a">CMP_NODE_DEFOCUS</a>, <span class="stringliteral">&quot;Defocus&quot;</span>, <a class="code" href="../../d4/d91/BKE__node_8h.html#ad0e69ae167f6bf3a2d3488a66b2aafd3">NODE_CLASS_OP_FILTER</a>, <a class="code" href="../../d3/d27/DNA__node__types_8h.html#a0925ab7ab82c3540f1bb95a217e2367e">NODE_OPTIONS</a>);
<a name="l00883"></a>00883     <a class="code" href="../../d4/d91/BKE__node_8h.html#a28da87d7bde19fc52db8a347dfbcdb33">node_type_socket_templates</a>(&amp;ntype, cmp_node_defocus_in, cmp_node_defocus_out);
<a name="l00884"></a>00884     <a class="code" href="../../d4/d91/BKE__node_8h.html#a1e52ce207d6deb6a922816062c31793b">node_type_size</a>(&amp;ntype, 150, 120, 200);
<a name="l00885"></a>00885     <a class="code" href="../../d4/d91/BKE__node_8h.html#af530927053fe9c1d51c34c39db8ea8a1">node_type_init</a>(&amp;ntype, <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#aa996cb5450037f95ed73197f2d9acbf6">node_composit_init_defocus</a>);
<a name="l00886"></a>00886     <a class="code" href="../../d4/d91/BKE__node_8h.html#aef8267492dd0b028ecb667853276428a">node_type_storage</a>(&amp;ntype, <span class="stringliteral">&quot;NodeDefocus&quot;</span>, <a class="code" href="../../de/d31/node__util_8c.html#a30537877797c9f13f5508c849596432e">node_free_standard_storage</a>, <a class="code" href="../../de/d31/node__util_8c.html#aa7937efd6419c88ff52306841c4091dc">node_copy_standard_storage</a>);
<a name="l00887"></a>00887     <a class="code" href="../../d4/d91/BKE__node_8h.html#a3d52173ccbf8815125bcb79c234503d0">node_type_exec</a>(&amp;ntype, <a class="code" href="../../d0/daf/node__composite__defocus_8c.html#a6c03e6a49455ddef2f6dd1d937c6eefb">node_composit_exec_defocus</a>);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <a class="code" href="../../d4/d91/BKE__node_8h.html#aca0dd5d95b739964ba75c4d656922373">nodeRegisterType</a>(ttype, &amp;ntype);
<a name="l00890"></a>00890 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:35 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
