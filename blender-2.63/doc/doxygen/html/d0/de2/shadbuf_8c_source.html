<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: shadbuf.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">shadbuf.c</div>  </div>
</div>
<div class="contents">
<a href="../../d0/de2/shadbuf_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): 2004-2006, Blender Foundation</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d49/BLI__jitter_8h.html">BLI_jitter.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">/* XXX, could be better implemented... this is for endian issues */</span>
<a name="l00063"></a>00063 <span class="preprocessor">#ifdef __BIG_ENDIAN__</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#  define RCOMP 3</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#  define GCOMP 2</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#  define BCOMP 1</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#  define ACOMP 0</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00069"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a43dd91ba755212aa295213c9129d8726">00069</a> <span class="preprocessor"></span><span class="preprocessor">#  define RCOMP 0</span>
<a name="l00070"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">00070</a> <span class="preprocessor"></span><span class="preprocessor">#  define GCOMP 1</span>
<a name="l00071"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">00071</a> <span class="preprocessor"></span><span class="preprocessor">#  define BCOMP 2</span>
<a name="l00072"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">00072</a> <span class="preprocessor"></span><span class="preprocessor">#  define ACOMP 3</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00076"></a>00076 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00077"></a>00077 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00078"></a>00078 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00079"></a>00079 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/* initshadowbuf() in convertBlenderScene.c */</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00086"></a>00086 
<a name="l00087"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a44fdcec02bb8f7f3c14364ba628ec4dc">00087</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a44fdcec02bb8f7f3c14364ba628ec4dc">copy_to_ztile</a>(<span class="keywordtype">int</span> *rectz, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> tile, <span class="keywordtype">char</span> *r1)
<a name="l00088"></a>00088 {
<a name="l00089"></a>00089     <span class="keywordtype">int</span> len4, *rz;  
<a name="l00090"></a>00090     <span class="keywordtype">int</span> x2, y2;
<a name="l00091"></a>00091     
<a name="l00092"></a>00092     x2= x1+tile;
<a name="l00093"></a>00093     y2= y1+tile;
<a name="l00094"></a>00094     <span class="keywordflow">if</span> (x2&gt;=size) x2= size-1;
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (y2&gt;=size) y2= size-1;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (x1&gt;=x2 || y1&gt;=y2) <span class="keywordflow">return</span>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     len4= 4*(x2- x1);
<a name="l00100"></a>00100     rz= rectz + size*y1 + x1;
<a name="l00101"></a>00101     <span class="keywordflow">for</span> (; y1&lt;y2; y1++) {
<a name="l00102"></a>00102         memcpy(r1, rz, len4);
<a name="l00103"></a>00103         rz+= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00104"></a>00104         r1+= len4;
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">#if 0</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> sizeoflampbuf(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111     <span class="keywordtype">int</span> num,count=0;
<a name="l00112"></a>00112     <span class="keywordtype">char</span> *cp;
<a name="l00113"></a>00113     
<a name="l00114"></a>00114     cp= shb-&gt;cbuf;
<a name="l00115"></a>00115     num= (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>)/256;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">while</span> (num--) count+= *(cp++);
<a name="l00118"></a>00118     
<a name="l00119"></a>00119     <span class="keywordflow">return</span> 256*count;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 <span class="preprocessor">#endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a>00123 <span class="comment">/* not threadsafe... */</span>
<a name="l00124"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a2cb9239d7f09e1328108f439107578e0">00124</a> <span class="keyword">static</span> <span class="keywordtype">float</span> *<a class="code" href="../../d0/de2/shadbuf_8c.html#a2cb9239d7f09e1328108f439107578e0">give_jitter_tab</a>(<span class="keywordtype">int</span> samp)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <span class="comment">/* these are all possible jitter tables, takes up some</span>
<a name="l00127"></a>00127 <span class="comment">     * 12k, not really bad!</span>
<a name="l00128"></a>00128 <span class="comment">     * For soft shadows, it saves memory and render time</span>
<a name="l00129"></a>00129 <span class="comment">     */</span>
<a name="l00130"></a>00130     <span class="keyword">static</span> <span class="keywordtype">int</span> tab[17]={1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256};
<a name="l00131"></a>00131     <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>[1496][2];
<a name="l00132"></a>00132     <span class="keyword">static</span> <span class="keywordtype">char</span> ctab[17]= {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
<a name="l00133"></a>00133     <span class="keywordtype">int</span> a, offset=0;
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (samp&lt;2) samp= 2;
<a name="l00136"></a>00136     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (samp&gt;16) samp= 16;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="keywordflow">for</span> (a=0; a&lt;samp-1; a++) offset+= tab[a];
<a name="l00139"></a>00139 
<a name="l00140"></a>00140     <span class="keywordflow">if</span> (ctab[samp]==0) {
<a name="l00141"></a>00141         ctab[samp]= 1;
<a name="l00142"></a>00142         <a class="code" href="../../d5/d49/BLI__jitter_8h.html#a67dcc4bd0504529117baebe79c486330">BLI_initjit</a>(jit[offset], samp*samp);
<a name="l00143"></a>00143     }
<a name="l00144"></a>00144         
<a name="l00145"></a>00145     <span class="keywordflow">return</span> jit[offset];
<a name="l00146"></a>00146     
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a3794e005fcd95713e779008844e231a7">00149</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a3794e005fcd95713e779008844e231a7">make_jitter_weight_tab</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <span class="keywordtype">short</span> filtertype) 
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151     <span class="keywordtype">float</span> *<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>, totw= 0.0f;
<a name="l00152"></a>00152     <span class="keywordtype">int</span> samp= <a class="code" href="../../d8/d53/BKE__scene_8h.html#a3794116b5c2e9ce6c720c460c61f8000">get_render_shadow_samples</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a2f9893cfb0b535c3a6fa3346f7c7b79b">samp</a>);
<a name="l00153"></a>00153     <span class="keywordtype">int</span> a, tot=samp*samp;
<a name="l00154"></a>00154     
<a name="l00155"></a>00155     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*tot, <span class="stringliteral">&quot;weight tab lamp&quot;</span>);
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     <span class="keywordflow">for</span> (jit= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac88ceaccc14be47c5a0eacaeb307f589">jit</a>, a=0; a&lt;tot; a++, jit+=2) {
<a name="l00158"></a>00158         <span class="keywordflow">if</span> (filtertype==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#afe6933d24bcf6f226c4ce70a22756228">LA_SHADBUF_TENT</a>)
<a name="l00159"></a>00159             shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>[a]= 0.71f - <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(jit[0]*jit[0] + jit[1]*jit[1]);
<a name="l00160"></a>00160         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filtertype==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a8424bcfea2f93cb75f46e68455fc581f">LA_SHADBUF_GAUSS</a>)
<a name="l00161"></a>00161             shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>[a]= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ae148598e550ce2cec7dda12d8283b833">RE_filter_value</a>(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119953142b5a77a099b57309faf761cc">R_FILTER_GAUSS</a>, 1.8f*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(jit[0]*jit[0] + jit[1]*jit[1]));
<a name="l00162"></a>00162         <span class="keywordflow">else</span>
<a name="l00163"></a>00163             shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>[a]= 1.0f;
<a name="l00164"></a>00164         
<a name="l00165"></a>00165         totw+= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>[a];
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     totw= 1.0f/totw;
<a name="l00169"></a>00169     <span class="keywordflow">for</span> (a=0; a&lt;tot; a++) {
<a name="l00170"></a>00170         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>[a]*= totw;
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#af433bb1f11f0aea949cb89be7ca12da9">00174</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#af433bb1f11f0aea949cb89be7ca12da9">verg_deepsample</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *poin1, <span class="keyword">const</span> <span class="keywordtype">void</span> *poin2)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176     <span class="keyword">const</span> <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *ds1= (<span class="keyword">const</span> <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>*)poin1;
<a name="l00177"></a>00177     <span class="keyword">const</span> <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *ds2= (<span class="keyword">const</span> <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>*)poin2;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="keywordflow">if</span> (ds1-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a> &lt; ds2-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>) <span class="keywordflow">return</span> -1;
<a name="l00180"></a>00180     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ds1-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a> == ds2-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>) <span class="keywordflow">return</span> 0;
<a name="l00181"></a>00181     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 1;
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a9c3c03a8e37dbc40275e507383cc81a9">00184</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a9c3c03a8e37dbc40275e507383cc81a9">compress_deepsamples</a>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *dsample, <span class="keywordtype">int</span> tot, <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a>)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <span class="comment">/* uses doubles to avoid overflows and other numerical issues,</span>
<a name="l00187"></a>00187 <span class="comment">     * could be improved */</span>
<a name="l00188"></a>00188     <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *ds, *newds;
<a name="l00189"></a>00189     <span class="keywordtype">float</span> v;
<a name="l00190"></a>00190     <span class="keywordtype">double</span> slope, slopemin, slopemax, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, newmin, newmax;
<a name="l00191"></a>00191     <span class="keywordtype">int</span> a, first, z, newtot= 0;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="preprocessor">#if 0</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (print) {
<a name="l00195"></a>00195         <span class="keywordflow">for</span> (a=0, ds=dsample; a&lt;tot; a++, ds++)
<a name="l00196"></a>00196             printf(<span class="stringliteral">&quot;%lf,%f &quot;</span>, ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>/(<span class="keywordtype">double</span>)0x7FFFFFFF, ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>);
<a name="l00197"></a>00197         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 <span class="preprocessor">#endif</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>
<a name="l00201"></a>00201     <span class="comment">/* read from and write into same array */</span>
<a name="l00202"></a>00202     ds= dsample;
<a name="l00203"></a>00203     newds= dsample;
<a name="l00204"></a>00204     a= 0;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">/* as long as we are not at the end of the array */</span>
<a name="l00207"></a>00207     <span class="keywordflow">for</span> (a++, ds++; a&lt;tot; a++, ds++) {
<a name="l00208"></a>00208         slopemin= 0.0f;
<a name="l00209"></a>00209         slopemax= 0.0f;
<a name="l00210"></a>00210         first= 1;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="keywordflow">for</span> (; a&lt;tot; a++, ds++) {
<a name="l00213"></a>00213             <span class="comment">//dz= ds-&gt;z - newds-&gt;z;</span>
<a name="l00214"></a>00214             <span class="keywordflow">if</span> (ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a> == newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>) {
<a name="l00215"></a>00215                 <span class="comment">/* still in same z position, simply check</span>
<a name="l00216"></a>00216 <span class="comment">                 * visibility difference against epsilon */</span>
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> - ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>) &lt;= epsilon)) {
<a name="l00218"></a>00218                     <span class="keywordflow">break</span>;
<a name="l00219"></a>00219                 }
<a name="l00220"></a>00220             }
<a name="l00221"></a>00221             <span class="keywordflow">else</span> {
<a name="l00222"></a>00222                 <span class="comment">/* compute slopes */</span>
<a name="l00223"></a>00223                 div= (double)0x7FFFFFFF/((<span class="keywordtype">double</span>)ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a> - (double)newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>);
<a name="l00224"></a>00224                 min= ((ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> - <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a>) - newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>)*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00225"></a>00225                 max= ((ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> + <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a>) - newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>)*<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227                 <span class="comment">/* adapt existing slopes */</span>
<a name="l00228"></a>00228                 <span class="keywordflow">if</span> (first) {
<a name="l00229"></a>00229                     newmin= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>;
<a name="l00230"></a>00230                     newmax= <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>;
<a name="l00231"></a>00231                     first= 0;
<a name="l00232"></a>00232                 }
<a name="l00233"></a>00233                 <span class="keywordflow">else</span> {
<a name="l00234"></a>00234                     newmin= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(slopemin, min);
<a name="l00235"></a>00235                     newmax= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(slopemax, max);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237                     <span class="comment">/* verify if there is still space between the slopes */</span>
<a name="l00238"></a>00238                     <span class="keywordflow">if</span> (newmin &gt; newmax) {
<a name="l00239"></a>00239                         ds--;
<a name="l00240"></a>00240                         a--;
<a name="l00241"></a>00241                         <span class="keywordflow">break</span>;
<a name="l00242"></a>00242                     }
<a name="l00243"></a>00243                 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245                 slopemin= newmin;
<a name="l00246"></a>00246                 slopemax= newmax;
<a name="l00247"></a>00247             }
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (a == tot) {
<a name="l00251"></a>00251             ds--;
<a name="l00252"></a>00252             a--;
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="comment">/* always previous z */</span>
<a name="l00256"></a>00256         z= ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (first || a==tot-1) {
<a name="l00259"></a>00259             <span class="comment">/* if slopes were not initialized, use last visibility */</span>
<a name="l00260"></a>00260             v= ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>;
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262         <span class="keywordflow">else</span> {
<a name="l00263"></a>00263             <span class="comment">/* compute visibility at center between slopes at z */</span>
<a name="l00264"></a>00264             slope= (slopemin+slopemax)*0.5f;
<a name="l00265"></a>00265             v= newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> + slope*((z - newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>)/(<span class="keywordtype">double</span>)0x7FFFFFFF);
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268         newds++;
<a name="l00269"></a>00269         newtot++;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= z;
<a name="l00272"></a>00272         newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= v;
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (newtot == 0 || (newds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> != (newds-1)-&gt;v))
<a name="l00276"></a>00276         newtot++;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="preprocessor">#if 0</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (print) {
<a name="l00280"></a>00280         <span class="keywordflow">for</span> (a=0, ds=dsample; a&lt;newtot; a++, ds++)
<a name="l00281"></a>00281             printf(<span class="stringliteral">&quot;%lf,%f &quot;</span>, ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>/(<span class="keywordtype">double</span>)0x7FFFFFFF, ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>);
<a name="l00282"></a>00282         printf(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 <span class="preprocessor">#endif</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>
<a name="l00286"></a>00286     <span class="keywordflow">return</span> newtot;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a742434ef45a89632c70537125f9f6add">00289</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a742434ef45a89632c70537125f9f6add">deep_alpha</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">int</span> obinr, <span class="keywordtype">int</span> facenr, <span class="keywordtype">int</span> strand)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi= &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>[obinr];
<a name="l00292"></a>00292     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (strand) {
<a name="l00295"></a>00295         <a class="code" href="../../d4/db8/structStrandRen.html">StrandRen</a> *strand= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ad9901d1e73727834b3cd61ead5f2b3d1">RE_findOrAddStrand</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>, facenr-1);
<a name="l00296"></a>00296         ma= strand-&gt;<a class="code" href="../../d4/db8/structStrandRen.html#a2b5942820a4b7259f3633f3cc6f49f82">buffer</a>-&gt;<a class="code" href="../../de/d59/structStrandBuffer.html#a2b02f0c69b00f6576d8a0a53a625e3d3">ma</a>;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">else</span> {
<a name="l00299"></a>00299         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>, (facenr-1) &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac1ba251e205ec58bf4d88f687b64314f">RE_QUAD_MASK</a>);
<a name="l00300"></a>00300         ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l00301"></a>00301     }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <span class="keywordflow">return</span> ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a0d7be284a93e101bc31ae4a3df31b9ce">shad_alpha</a>;
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a2549c3484bc22e1217c27355153d1489">00306</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a2549c3484bc22e1217c27355153d1489">compress_deepshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apixbuf, <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *apixbufstrand)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308     <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample;
<a name="l00309"></a>00309     <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *ds[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>], *sampleds[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>], *dsb, *newbuf;
<a name="l00310"></a>00310     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *ap, *apn;
<a name="l00311"></a>00311     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *aps, *apns;
<a name="l00312"></a>00312     <span class="keywordtype">float</span> visibility;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="keyword">const</span> <span class="keywordtype">int</span> totbuf= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>;
<a name="l00315"></a>00315     <span class="keyword">const</span> <span class="keywordtype">float</span> totbuf_f= (float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>;
<a name="l00316"></a>00316     <span class="keyword">const</span> <span class="keywordtype">float</span> totbuf_f_inv= 1.0f/totbuf_f;
<a name="l00317"></a>00317     <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordtype">int</span> a, b, c, tot, minz, found, prevtot, newtot;
<a name="l00320"></a>00320     <span class="keywordtype">int</span> sampletot[<a class="code" href="../../da/d3d/shading_8h.html#ae12664b8b8032e5c586be14f2bdbdf8c">RE_MAX_OSA</a>], totsample = 0, totsamplec = 0;
<a name="l00321"></a>00321     
<a name="l00322"></a>00322     shsample= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a>), <span class="stringliteral">&quot;shad sample buf&quot;</span>);
<a name="l00323"></a>00323     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>, shsample);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, <span class="stringliteral">&quot;deeptotbuf&quot;</span>);
<a name="l00326"></a>00326     shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>*)*size*size, <span class="stringliteral">&quot;deepbuf&quot;</span>);
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     ap= apixbuf;
<a name="l00329"></a>00329     aps= apixbufstrand;
<a name="l00330"></a>00330     <span class="keywordflow">for</span> (a=0; a&lt;size*<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; a++, ap++, aps++) {
<a name="l00331"></a>00331         <span class="comment">/* count number of samples */</span>
<a name="l00332"></a>00332         <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++)
<a name="l00333"></a>00333             sampletot[c]= 0;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         tot= 0;
<a name="l00336"></a>00336         <span class="keywordflow">for</span> (apn=ap; apn; apn=apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>)
<a name="l00337"></a>00337             <span class="keywordflow">for</span> (b=0; b&lt;4; b++)
<a name="l00338"></a>00338                 <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[b])
<a name="l00339"></a>00339                     <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++)
<a name="l00340"></a>00340                         <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[b] &amp; (1&lt;&lt;c))
<a name="l00341"></a>00341                             sampletot[c]++;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <span class="keywordflow">if</span> (apixbufstrand) {
<a name="l00344"></a>00344             <span class="keywordflow">for</span> (apns=aps; apns; apns=apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#af9afccdaf6b0344c73a6b7ac83e4b239">next</a>)
<a name="l00345"></a>00345                 <span class="keywordflow">for</span> (b=0; b&lt;4; b++)
<a name="l00346"></a>00346                     <span class="keywordflow">if</span> (apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[b])
<a name="l00347"></a>00347                         <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++)
<a name="l00348"></a>00348                             <span class="keywordflow">if</span> (apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#ad364f0d58dd4f232b6a2830735a4e4fd">mask</a>[b] &amp; (1&lt;&lt;c))
<a name="l00349"></a>00349                                 sampletot[c]++;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++)
<a name="l00353"></a>00353             tot += sampletot[c];
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (tot == 0) {
<a name="l00356"></a>00356             shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00357"></a>00357             shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[a]= 0;
<a name="l00358"></a>00358             <span class="keywordflow">continue</span>;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="comment">/* fill samples */</span>
<a name="l00362"></a>00362         ds[0]= sampleds[0]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>)*tot*2, <span class="stringliteral">&quot;deepsample&quot;</span>);
<a name="l00363"></a>00363         <span class="keywordflow">for</span> (c=1; c&lt;totbuf; c++)
<a name="l00364"></a>00364             ds[c]= sampleds[c]= sampleds[c-1] + sampletot[c-1]*2;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <span class="keywordflow">for</span> (apn=ap; apn; apn=apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>) {
<a name="l00367"></a>00367             <span class="keywordflow">for</span> (b=0; b&lt;4; b++) {
<a name="l00368"></a>00368                 <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[b]) {
<a name="l00369"></a>00369                     <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++) {
<a name="l00370"></a>00370                         <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[b] &amp; (1&lt;&lt;c)) {
<a name="l00371"></a>00371                             <span class="comment">/* two entries to create step profile */</span>
<a name="l00372"></a>00372                             ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[b];
<a name="l00373"></a>00373                             ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= 1.0f; <span class="comment">/* not used */</span>
<a name="l00374"></a>00374                             ds[c]++;
<a name="l00375"></a>00375                             ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a16e1e6c2c4e481c1f0c948225f3d7524">z</a>[b];
<a name="l00376"></a>00376                             ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a742434ef45a89632c70537125f9f6add">deep_alpha</a>(re, apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[b], apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[b], 0);
<a name="l00377"></a>00377                             ds[c]++;
<a name="l00378"></a>00378                         }
<a name="l00379"></a>00379                     }
<a name="l00380"></a>00380                 }
<a name="l00381"></a>00381             }
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (apixbufstrand) {
<a name="l00385"></a>00385             <span class="keywordflow">for</span> (apns=aps; apns; apns=apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#af9afccdaf6b0344c73a6b7ac83e4b239">next</a>) {
<a name="l00386"></a>00386                 <span class="keywordflow">for</span> (b=0; b&lt;4; b++) {
<a name="l00387"></a>00387                     <span class="keywordflow">if</span> (apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[b]) {
<a name="l00388"></a>00388                         <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++) {
<a name="l00389"></a>00389                             <span class="keywordflow">if</span> (apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#ad364f0d58dd4f232b6a2830735a4e4fd">mask</a>[b] &amp; (1&lt;&lt;c)) {
<a name="l00390"></a>00390                                 <span class="comment">/* two entries to create step profile */</span>
<a name="l00391"></a>00391                                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a44600065ce92f1fdc276dcc2e1dd2d02">z</a>[b];
<a name="l00392"></a>00392                                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= 1.0f; <span class="comment">/* not used */</span>
<a name="l00393"></a>00393                                 ds[c]++;
<a name="l00394"></a>00394                                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a44600065ce92f1fdc276dcc2e1dd2d02">z</a>[b];
<a name="l00395"></a>00395                                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a742434ef45a89632c70537125f9f6add">deep_alpha</a>(re, apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a4f1ac6e74901eb3c0b288e0711861893">obi</a>[b], apns-&gt;<a class="code" href="../../dd/d9e/structAPixstrand.html#a58c61d51532431ed884163434f3cfe77">p</a>[b], 1);
<a name="l00396"></a>00396                                 ds[c]++;
<a name="l00397"></a>00397                             }
<a name="l00398"></a>00398                         }
<a name="l00399"></a>00399                     }
<a name="l00400"></a>00400                 }
<a name="l00401"></a>00401             }
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++) {
<a name="l00405"></a>00405             <span class="comment">/* sort by increasing z */</span>
<a name="l00406"></a>00406             qsort(sampleds[c], sampletot[c], <span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>)*2, <a class="code" href="../../d0/de2/shadbuf_8c.html#af433bb1f11f0aea949cb89be7ca12da9">verg_deepsample</a>);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408             <span class="comment">/* sum visibility, replacing alpha values */</span>
<a name="l00409"></a>00409             visibility= 1.0f;
<a name="l00410"></a>00410             ds[c]= sampleds[c];
<a name="l00411"></a>00411 
<a name="l00412"></a>00412             <span class="keywordflow">for</span> (b=0; b&lt;sampletot[c]; b++) {
<a name="l00413"></a>00413                 <span class="comment">/* two entries creating step profile */</span>
<a name="l00414"></a>00414                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= visibility;
<a name="l00415"></a>00415                 ds[c]++;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417                 visibility *= 1.0f-ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>;
<a name="l00418"></a>00418                 ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= visibility;
<a name="l00419"></a>00419                 ds[c]++;
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             <span class="comment">/* halfway trick, probably won&#39;t work well for volumes? */</span>
<a name="l00423"></a>00423             ds[c]= sampleds[c];
<a name="l00424"></a>00424             <span class="keywordflow">for</span> (b=0; b&lt;sampletot[c]; b++) {
<a name="l00425"></a>00425                 <span class="keywordflow">if</span> (b+1 &lt; sampletot[c]) {
<a name="l00426"></a>00426                     ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= (ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>&gt;&gt;1) + ((ds[c]+2)-&gt;z&gt;&gt;1);
<a name="l00427"></a>00427                     ds[c]++;
<a name="l00428"></a>00428                     ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= (ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>&gt;&gt;1) + ((ds[c]+2)-&gt;z&gt;&gt;1);
<a name="l00429"></a>00429                     ds[c]++;
<a name="l00430"></a>00430                 }
<a name="l00431"></a>00431                 <span class="keywordflow">else</span> {
<a name="l00432"></a>00432                     ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= (ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>&gt;&gt;1) + (0x7FFFFFFF&gt;&gt;1);
<a name="l00433"></a>00433                     ds[c]++;
<a name="l00434"></a>00434                     ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= (ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>&gt;&gt;1) + (0x7FFFFFFF&gt;&gt;1);
<a name="l00435"></a>00435                     ds[c]++;
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439             <span class="comment">/* init for merge loop */</span>
<a name="l00440"></a>00440             ds[c]= sampleds[c];
<a name="l00441"></a>00441             sampletot[c] *= 2;
<a name="l00442"></a>00442         }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444         shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>)*tot*2, <span class="stringliteral">&quot;deepsample&quot;</span>);
<a name="l00445"></a>00445         shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[a]= 0;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <span class="comment">/* merge buffers */</span>
<a name="l00448"></a>00448         dsb= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a];
<a name="l00449"></a>00449         <span class="keywordflow">while</span> (1) {
<a name="l00450"></a>00450             minz= 0;
<a name="l00451"></a>00451             found= 0;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453             <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++) {
<a name="l00454"></a>00454                 <span class="keywordflow">if</span> (sampletot[c] &amp;&amp; (!found || ds[c]-&gt;z &lt; minz)) {
<a name="l00455"></a>00455                     minz= ds[c]-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>;
<a name="l00456"></a>00456                     found= 1;
<a name="l00457"></a>00457                 }
<a name="l00458"></a>00458             }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460             <span class="keywordflow">if</span> (!found)
<a name="l00461"></a>00461                 <span class="keywordflow">break</span>;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463             dsb-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>= minz;
<a name="l00464"></a>00464             dsb-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= 0.0f;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466             visibility= 0.0f;
<a name="l00467"></a>00467             <span class="keywordflow">for</span> (c=0; c&lt;totbuf; c++) {
<a name="l00468"></a>00468                 <span class="keywordflow">if</span> (sampletot[c] &amp;&amp; ds[c]-&gt;z == minz) {
<a name="l00469"></a>00469                     ds[c]++;
<a name="l00470"></a>00470                     sampletot[c]--;
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                 <span class="keywordflow">if</span> (sampleds[c] == ds[c])
<a name="l00474"></a>00474                     visibility += totbuf_f_inv;
<a name="l00475"></a>00475                 <span class="keywordflow">else</span>
<a name="l00476"></a>00476                     visibility += (ds[c]-1)-&gt;v / totbuf_f;
<a name="l00477"></a>00477             }
<a name="l00478"></a>00478 
<a name="l00479"></a>00479             dsb-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>= visibility;
<a name="l00480"></a>00480             dsb++;
<a name="l00481"></a>00481             shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[a]++;
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         prevtot= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[a];
<a name="l00485"></a>00485         totsample += prevtot;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         newtot= <a class="code" href="../../d0/de2/shadbuf_8c.html#a9c3c03a8e37dbc40275e507383cc81a9">compress_deepsamples</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a], prevtot, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a5694fd352fb297566c4eabd3f99da595">compressthresh</a>);
<a name="l00488"></a>00488         shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[a]= newtot;
<a name="l00489"></a>00489         totsamplec += newtot;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (newtot &lt; prevtot) {
<a name="l00492"></a>00492             newbuf= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>)*newtot, <span class="stringliteral">&quot;cdeepsample&quot;</span>);
<a name="l00493"></a>00493             memcpy(newbuf, shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a], <span class="keyword">sizeof</span>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a>)*newtot);
<a name="l00494"></a>00494             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a]);
<a name="l00495"></a>00495             shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[a]= newbuf;
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(sampleds[0]);
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="comment">//printf(&quot;%d -&gt; %d, ratio %f\n&quot;, totsample, totsamplec, (float)totsamplec/(float)totsample);</span>
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 <span class="comment">/* create Z tiles (for compression): this system is 24 bits!!! */</span>
<a name="l00505"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a82b3c6840995f8db65a9192d0f2b56a6">00505</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a82b3c6840995f8db65a9192d0f2b56a6">compress_shadowbuf</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <span class="keywordtype">int</span> *rectz, <span class="keywordtype">int</span> square)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507     <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample;
<a name="l00508"></a>00508     <span class="keywordtype">float</span> dist;
<a name="l00509"></a>00509     uintptr_t *ztile;
<a name="l00510"></a>00510     <span class="keywordtype">int</span> *rz, *rz1, verg, verg1, <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l00511"></a>00511     <span class="keywordtype">int</span> a, x, y, minx, miny, byt1, byt2;
<a name="l00512"></a>00512     <span class="keywordtype">char</span> *rc, *rcline, *ctile, *zt;
<a name="l00513"></a>00513     
<a name="l00514"></a>00514     shsample= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a>), <span class="stringliteral">&quot;shad sample buf&quot;</span>);
<a name="l00515"></a>00515     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>, shsample);
<a name="l00516"></a>00516     
<a name="l00517"></a>00517     shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( <span class="keyword">sizeof</span>(uintptr_t)*(size*size)/256, <span class="stringliteral">&quot;initshadbuf2&quot;</span>);
<a name="l00518"></a>00518     shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>( (size*size)/256, <span class="stringliteral">&quot;initshadbuf3&quot;</span>);
<a name="l00519"></a>00519     
<a name="l00520"></a>00520     ztile= (uintptr_t *)shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>;
<a name="l00521"></a>00521     ctile= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>;
<a name="l00522"></a>00522     
<a name="l00523"></a>00523     <span class="comment">/* help buffer */</span>
<a name="l00524"></a>00524     rcline= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(256*4+<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;makeshadbuf2&quot;</span>);
<a name="l00525"></a>00525     
<a name="l00526"></a>00526     <span class="keywordflow">for</span> (y=0; y&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; y+=16) {
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (y&lt; size/2) miny= y+15-size/2;
<a name="l00528"></a>00528         <span class="keywordflow">else</span> miny= y-size/2;    
<a name="l00529"></a>00529         
<a name="l00530"></a>00530         <span class="keywordflow">for</span> (x=0; x&lt;<a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>; x+=16) {
<a name="l00531"></a>00531             
<a name="l00532"></a>00532             <span class="comment">/* is tile within spotbundle? */</span>
<a name="l00533"></a>00533             a= size/2;
<a name="l00534"></a>00534             <span class="keywordflow">if</span> (x&lt; a) minx= x+15-a;
<a name="l00535"></a>00535             <span class="keywordflow">else</span> minx= x-a; 
<a name="l00536"></a>00536             
<a name="l00537"></a>00537             dist= <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>( (<span class="keywordtype">float</span>)(minx*minx+miny*miny) );
<a name="l00538"></a>00538             
<a name="l00539"></a>00539             <span class="keywordflow">if</span> (square==0 &amp;&amp; dist&gt;(<span class="keywordtype">float</span>)(a+12)) {  <span class="comment">/* 12, tested with a onlyshadow lamp */</span>
<a name="l00540"></a>00540                 a= 256; verg= 0; <span class="comment">/* 0x80000000; */</span> <span class="comment">/* 0x7FFFFFFF; */</span>
<a name="l00541"></a>00541                 rz1= (&amp;verg)+1;
<a name="l00542"></a>00542             } 
<a name="l00543"></a>00543             <span class="keywordflow">else</span> {
<a name="l00544"></a>00544                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a44fdcec02bb8f7f3c14364ba628ec4dc">copy_to_ztile</a>(rectz, size, x, y, 16, rcline);
<a name="l00545"></a>00545                 rz1= (<span class="keywordtype">int</span> *)rcline;
<a name="l00546"></a>00546                 
<a name="l00547"></a>00547                 verg= (*rz1 &amp; 0xFFFFFF00);
<a name="l00548"></a>00548                 
<a name="l00549"></a>00549                 <span class="keywordflow">for</span> (a=0;a&lt;256;a++,rz1++) {
<a name="l00550"></a>00550                     <span class="keywordflow">if</span> ( (*rz1 &amp; 0xFFFFFF00) !=verg) <span class="keywordflow">break</span>;
<a name="l00551"></a>00551                 }
<a name="l00552"></a>00552             }
<a name="l00553"></a>00553             <span class="keywordflow">if</span> (a==256) { <span class="comment">/* complete empty tile */</span>
<a name="l00554"></a>00554                 *ctile= 0;
<a name="l00555"></a>00555                 *ztile= *(rz1-1);
<a name="l00556"></a>00556             }
<a name="l00557"></a>00557             <span class="keywordflow">else</span> {
<a name="l00558"></a>00558                 
<a name="l00559"></a>00559                 <span class="comment">/* ACOMP etc. are defined to work L/B endian */</span>
<a name="l00560"></a>00560                 
<a name="l00561"></a>00561                 rc= rcline;
<a name="l00562"></a>00562                 rz1= (<span class="keywordtype">int</span> *)rcline;
<a name="l00563"></a>00563                 verg=  rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">ACOMP</a>];
<a name="l00564"></a>00564                 verg1= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>];
<a name="l00565"></a>00565                 rc+= 4;
<a name="l00566"></a>00566                 byt1= 1; byt2= 1;
<a name="l00567"></a>00567                 <span class="keywordflow">for</span> (a=1;a&lt;256;a++,rc+=4) {
<a name="l00568"></a>00568                     byt1 &amp;= (verg==rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">ACOMP</a>]);
<a name="l00569"></a>00569                     byt2 &amp;= (verg1==rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>]);
<a name="l00570"></a>00570                     
<a name="l00571"></a>00571                     <span class="keywordflow">if</span> (byt1==0) <span class="keywordflow">break</span>;
<a name="l00572"></a>00572                 }
<a name="l00573"></a>00573                 <span class="keywordflow">if</span> (byt1 &amp;&amp; byt2) { <span class="comment">/* only store byte */</span>
<a name="l00574"></a>00574                     *ctile= 1;
<a name="l00575"></a>00575                     *ztile= (uintptr_t)<a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(256+4, <span class="stringliteral">&quot;tile1&quot;</span>);
<a name="l00576"></a>00576                     rz= (<span class="keywordtype">int</span> *)*ztile;
<a name="l00577"></a>00577                     *rz= *rz1;
<a name="l00578"></a>00578                     
<a name="l00579"></a>00579                     zt= (<span class="keywordtype">char</span> *)(rz+1);
<a name="l00580"></a>00580                     rc= rcline;
<a name="l00581"></a>00581                     <span class="keywordflow">for</span> (a=0; a&lt;256; a++, zt++, rc+=4) *zt= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>];
<a name="l00582"></a>00582                 }
<a name="l00583"></a>00583                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (byt1) {        <span class="comment">/* only store short */</span>
<a name="l00584"></a>00584                     *ctile= 2;
<a name="l00585"></a>00585                     *ztile= (uintptr_t)<a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(2*256+4,<span class="stringliteral">&quot;Tile2&quot;</span>);
<a name="l00586"></a>00586                     rz= (<span class="keywordtype">int</span> *)*ztile;
<a name="l00587"></a>00587                     *rz= *rz1;
<a name="l00588"></a>00588                     
<a name="l00589"></a>00589                     zt= (<span class="keywordtype">char</span> *)(rz+1);
<a name="l00590"></a>00590                     rc= rcline;
<a name="l00591"></a>00591                     <span class="keywordflow">for</span> (a=0; a&lt;256; a++, zt+=2, rc+=4) {
<a name="l00592"></a>00592                         zt[0]= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>];
<a name="l00593"></a>00593                         zt[1]= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>];
<a name="l00594"></a>00594                     }
<a name="l00595"></a>00595                 }
<a name="l00596"></a>00596                 <span class="keywordflow">else</span> {          <span class="comment">/* store triple */</span>
<a name="l00597"></a>00597                     *ctile= 3;
<a name="l00598"></a>00598                     *ztile= (uintptr_t)<a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(3*256,<span class="stringliteral">&quot;Tile3&quot;</span>);
<a name="l00599"></a>00599 
<a name="l00600"></a>00600                     zt= (<span class="keywordtype">char</span> *)*ztile;
<a name="l00601"></a>00601                     rc= rcline;
<a name="l00602"></a>00602                     <span class="keywordflow">for</span> (a=0; a&lt;256; a++, zt+=3, rc+=4) {
<a name="l00603"></a>00603                         zt[0]= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">ACOMP</a>];
<a name="l00604"></a>00604                         zt[1]= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>];
<a name="l00605"></a>00605                         zt[2]= rc[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>];
<a name="l00606"></a>00606                     }
<a name="l00607"></a>00607                 }
<a name="l00608"></a>00608             }
<a name="l00609"></a>00609             ztile++;
<a name="l00610"></a>00610             ctile++;
<a name="l00611"></a>00611         }
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rcline);
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="comment">/* sets start/end clipping. lar-&gt;shb should be initialized */</span>
<a name="l00618"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a44e0126dcd9a83f128dcd30d643b5360">00618</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a44e0126dcd9a83f128dcd30d643b5360">shadowbuf_autoclip</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00621"></a>00621     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00622"></a>00622     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00623"></a>00623     <a class="code" href="../../db/dcb/structVertRen.html">VertRen</a> *ver= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00624"></a>00624     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00625"></a>00625     <span class="keywordtype">float</span> minz, maxz, vec[3], <a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>[4][4], obviewmat[4][4];
<a name="l00626"></a>00626     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a> = -1;
<a name="l00627"></a>00627     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, maxtotvert, <a class="code" href="../../d6/d7a/structRender.html#a4bf4f0b482e1d05c2662f09cf5b1dfa3">ok</a>= 1;
<a name="l00628"></a>00628     <span class="keywordtype">char</span> *clipflag;
<a name="l00629"></a>00629     
<a name="l00630"></a>00630     minz= 1.0e30f; maxz= -1.0e30f;
<a name="l00631"></a>00631     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(viewmat, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac60eb776f17863e2e49eb745c2de382c">viewmat</a>);
<a name="l00632"></a>00632     
<a name="l00633"></a>00633     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1337605158cc594cf324bdbe8b1818ce">LA_LAYER_SHADOW</a>)) lay= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     maxtotvert= 0;
<a name="l00636"></a>00636     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>)
<a name="l00637"></a>00637         maxtotvert= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>, maxtotvert);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     clipflag= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*maxtotvert, <span class="stringliteral">&quot;autoclipflag&quot;</span>);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="comment">/* set clip in vertices when face visible */</span>
<a name="l00642"></a>00642     <span class="keywordflow">for</span> (i=0, obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l00643"></a>00643         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l00646"></a>00646             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obviewmat, viewmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l00647"></a>00647         <span class="keywordflow">else</span>
<a name="l00648"></a>00648             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obviewmat, viewmat);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         memset(clipflag, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="comment">/* clear clip, is being set if face is visible (clip is calculated for real later) */</span>
<a name="l00653"></a>00653         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00654"></a>00654             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00655"></a>00655             <span class="keywordflow">else</span> vlr++;
<a name="l00656"></a>00656             
<a name="l00657"></a>00657             <span class="comment">/* note; these conditions are copied from zbuffer_shadow() */</span>
<a name="l00658"></a>00658             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!= ma) {
<a name="l00659"></a>00659                 ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l00660"></a>00660                 ok= 1;
<a name="l00661"></a>00661                 <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>)==0) ok= 0;
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663             
<a name="l00664"></a>00664             <span class="keywordflow">if</span> (ok &amp;&amp; (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay)) {
<a name="l00665"></a>00665                 clipflag[vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>]= 1;
<a name="l00666"></a>00666                 clipflag[vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>]= 1;
<a name="l00667"></a>00667                 clipflag[vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>]= 1;
<a name="l00668"></a>00668                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) clipflag[vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a794b6d0bc0b91e4c4f8e7fd848115492">index</a>]= 1;
<a name="l00669"></a>00669             }               
<a name="l00670"></a>00670         }       
<a name="l00671"></a>00671         
<a name="l00672"></a>00672         <span class="comment">/* calculate min and max */</span>
<a name="l00673"></a>00673         <span class="keywordflow">for</span> (a=0; a&lt; obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aafa884c417cfd0bd7cc05e47b14d6aa3">totvert</a>;a++) {
<a name="l00674"></a>00674             <span class="keywordflow">if</span> ((a &amp; 255)==0) ver= <a class="code" href="../../d0/db6/renderdatabase_8h.html#ae5848046c72d3ac828293cfac233cae4">RE_findOrAddVert</a>(obr, a);
<a name="l00675"></a>00675             <span class="keywordflow">else</span> ver++;
<a name="l00676"></a>00676             
<a name="l00677"></a>00677             <span class="keywordflow">if</span> (clipflag[a]) {
<a name="l00678"></a>00678                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, ver-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l00679"></a>00679                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obviewmat, vec);
<a name="l00680"></a>00680                 <span class="comment">/* Z on visible side of lamp space */</span>
<a name="l00681"></a>00681                 <span class="keywordflow">if</span> (vec[2] &lt; 0.0f) {
<a name="l00682"></a>00682                     <span class="keywordtype">float</span> inpr, z= -vec[2];
<a name="l00683"></a>00683                     
<a name="l00684"></a>00684                     <span class="comment">/* since vec is rotated in lampspace, this is how to get the cosine of angle */</span>
<a name="l00685"></a>00685                     <span class="comment">/* precision is set 20% larger */</span>
<a name="l00686"></a>00686                     vec[2]*= 1.2f;
<a name="l00687"></a>00687                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vec);
<a name="l00688"></a>00688                     inpr= - vec[2];
<a name="l00689"></a>00689 
<a name="l00690"></a>00690                     <span class="keywordflow">if</span> (inpr&gt;=lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>) {
<a name="l00691"></a>00691                         <span class="keywordflow">if</span> (z&lt;minz) minz= z;
<a name="l00692"></a>00692                         <span class="keywordflow">if</span> (z&gt;maxz) maxz= z;
<a name="l00693"></a>00693                     }
<a name="l00694"></a>00694                 }
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(clipflag);
<a name="l00700"></a>00700     
<a name="l00701"></a>00701     <span class="comment">/* set clipping min and max */</span>
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (minz &lt; maxz) {
<a name="l00703"></a>00703         <span class="keywordtype">float</span> delta= (maxz - minz); <span class="comment">/* threshold to prevent precision issues */</span>
<a name="l00704"></a>00704         
<a name="l00705"></a>00705         <span class="comment">//printf(&quot;minz %f maxz %f delta %f\n&quot;, minz, maxz, delta);</span>
<a name="l00706"></a>00706         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af4f46b1eb94f0ddc1a3b233ca25ee387">bufflag</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#afc1c44025fbb4060806e0360e18213a3">LA_SHADBUF_AUTO_START</a>)
<a name="l00707"></a>00707             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a01fb870e42d9156a0652efec4ca7916e">d</a>= minz - delta*0.02f;    <span class="comment">/* 0.02 is arbitrary... needs more thinking! */</span>
<a name="l00708"></a>00708         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af4f46b1eb94f0ddc1a3b233ca25ee387">bufflag</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2f70aa92b974d0e66bce2423bdb8ef69">LA_SHADBUF_AUTO_END</a>)
<a name="l00709"></a>00709             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a4641c5202eb0dd7996aab19e58c8f4ed">clipend</a>= maxz + delta*0.1f;
<a name="l00710"></a>00710         
<a name="l00711"></a>00711         <span class="comment">/* bias was calculated as percentage, we scale it to prevent animation issues */</span>
<a name="l00712"></a>00712         delta= (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a0776d980bc866638e62fba74ea2ff501">clipend</a>-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ad6212b72bf2041f77f73e679eafe333b">clipsta</a>)/(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a4641c5202eb0dd7996aab19e58c8f4ed">clipend</a>-lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a01fb870e42d9156a0652efec4ca7916e">d</a>);
<a name="l00713"></a>00713         <span class="comment">//printf(&quot;bias delta %f\n&quot;, delta);</span>
<a name="l00714"></a>00714         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>= (int) (delta*(<span class="keywordtype">float</span>)lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>);
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a74de079eec04e2916beba4ae53b1871b">00718</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a74de079eec04e2916beba4ae53b1871b">makeflatshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> *jitbuf)
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l00721"></a>00721     <span class="keywordtype">int</span> *rectz, <a class="code" href="../../d6/d7a/structRender.html#a81d67d16df22ac8f7ecac228724410cc">samples</a>;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="comment">/* zbuffering */</span>
<a name="l00724"></a>00724     rectz= <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>, <span class="stringliteral">&quot;makeshadbuf&quot;</span>);
<a name="l00725"></a>00725     
<a name="l00726"></a>00726     <span class="keywordflow">for</span> (samples=0; samples&lt;shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>; samples++) {
<a name="l00727"></a>00727         <a class="code" href="../../df/d9d/zbuf_8h.html#a42a096cb948243e4668cf3cf97c50453">zbuffer_shadow</a>(re, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, lar, rectz, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>, jitbuf[2*samples], jitbuf[2*samples+1]);
<a name="l00728"></a>00728         <span class="comment">/* create Z tiles (for compression): this system is 24 bits!!! */</span>
<a name="l00729"></a>00729         <a class="code" href="../../d0/de2/shadbuf_8c.html#a82b3c6840995f8db65a9192d0f2b56a6">compress_shadowbuf</a>(shb, rectz, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ab52bf56b834bad1d21c3aaa274943059">LA_SQUARE</a>);
<a name="l00730"></a>00730 
<a name="l00731"></a>00731         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>))
<a name="l00732"></a>00732             <span class="keywordflow">break</span>;
<a name="l00733"></a>00733     }
<a name="l00734"></a>00734     
<a name="l00735"></a>00735     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(rectz);
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a30f305dc5d34a39f8a672100f7970a9a">00738</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a30f305dc5d34a39f8a672100f7970a9a">makedeepshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> *jitbuf)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l00741"></a>00741     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apixbuf;
<a name="l00742"></a>00742     <a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a> *apixbufstrand= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00743"></a>00743     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> apsmbase= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <span class="comment">/* zbuffering */</span>
<a name="l00746"></a>00746     apixbuf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a>)*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>, <span class="stringliteral">&quot;APixbuf&quot;</span>);
<a name="l00747"></a>00747     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>)
<a name="l00748"></a>00748         apixbufstrand= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d9e/structAPixstrand.html">APixstrand</a>)*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>, <span class="stringliteral">&quot;APixbufstrand&quot;</span>);
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     <a class="code" href="../../df/d9d/zbuf_8h.html#ac9b62ae9cd0a1822f72017bf52a668d5">zbuffer_abuf_shadow</a>(re, lar, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, apixbuf, apixbufstrand, &amp;apsmbase, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>,
<a name="l00751"></a>00751         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>, (<span class="keywordtype">float</span>(*)[2])jitbuf);
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="comment">/* create Z tiles (for compression): this system is 24 bits!!! */</span>
<a name="l00754"></a>00754     <a class="code" href="../../d0/de2/shadbuf_8c.html#a2549c3484bc22e1217c27355153d1489">compress_deepshadowbuf</a>(re, shb, apixbuf, apixbufstrand);
<a name="l00755"></a>00755     
<a name="l00756"></a>00756     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(apixbuf);
<a name="l00757"></a>00757     <span class="keywordflow">if</span> (apixbufstrand)
<a name="l00758"></a>00758         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(apixbufstrand);
<a name="l00759"></a>00759     <a class="code" href="../../df/d9d/zbuf_8h.html#a7f3263aa851e14a4695cc307d8433696">freepsA</a>(&amp;apsmbase);
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a3e273e2851457fa26bf7a9be1ece75be">00762</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#a05b20c49c3623cdd0b22d12bdae59ec5">makeshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l00765"></a>00765     <span class="keywordtype">float</span> wsize, *jitbuf, twozero[2]= {0.0f, 0.0f}, <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, temp;
<a name="l00766"></a>00766     
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#af4f46b1eb94f0ddc1a3b233ca25ee387">bufflag</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#afc1c44025fbb4060806e0360e18213a3">LA_SHADBUF_AUTO_START</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a2f70aa92b974d0e66bce2423bdb8ef69">LA_SHADBUF_AUTO_END</a>))
<a name="l00768"></a>00768         <a class="code" href="../../d0/de2/shadbuf_8c.html#a44e0126dcd9a83f128dcd30d643b5360">shadowbuf_autoclip</a>(re, lar);
<a name="l00769"></a>00769     
<a name="l00770"></a>00770     <span class="comment">/* just to enforce identical behavior of all irregular buffers */</span>
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a140e58d774f55360506b8dd8bebeb553">LA_SHADBUF_IRREGULAR</a>)
<a name="l00772"></a>00772         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>= 1024;
<a name="l00773"></a>00773     
<a name="l00774"></a>00774     <span class="comment">/* matrices and window: in winmat the transformation is being put,</span>
<a name="l00775"></a>00775 <span class="comment">     * transforming from observer view to lamp view, including lamp window matrix */</span>
<a name="l00776"></a>00776     
<a name="l00777"></a>00777     <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a9919bda67bdd98aab6f6fe7c13b64682">spotsi</a>);
<a name="l00778"></a>00778     temp= 0.5f*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>)/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(<a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>);
<a name="l00779"></a>00779     shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#af0792ff5c665b82267e97de54f07ec0d">pixsize</a>= (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a01fb870e42d9156a0652efec4ca7916e">d</a>)/temp;
<a name="l00780"></a>00780     wsize= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#af0792ff5c665b82267e97de54f07ec0d">pixsize</a>*(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>/2.0f);
<a name="l00781"></a>00781     
<a name="l00782"></a>00782     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8e39ae9dcc346cc95db26002260d0ee7">perspective_m4</a>( shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>,-wsize, wsize, -wsize, wsize, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a01fb870e42d9156a0652efec4ca7916e">d</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a4641c5202eb0dd7996aab19e58c8f4ed">clipend</a>);
<a name="l00783"></a>00783     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac60eb776f17863e2e49eb745c2de382c">viewmat</a>);
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#ae107928b769864b5f00b97be13e28338">LA_SHADBUF_REGULAR</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a04f7a5531fb598ef1de609b9f3dec4e6">LA_SHADBUF_HALFWAY</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3cbc315c04ee863dd6824193d617381e">LA_SHADBUF_DEEP</a>)) {
<a name="l00786"></a>00786         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a26ae7b2dabe29efbf27d4a8df48c0db6">buffers</a>;
<a name="l00787"></a>00787 
<a name="l00788"></a>00788         <span class="comment">/* jitter, weights - not threadsafe! */</span>
<a name="l00789"></a>00789         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00790"></a>00790         shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac88ceaccc14be47c5a0eacaeb307f589">jit</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a2cb9239d7f09e1328108f439107578e0">give_jitter_tab</a>(<a class="code" href="../../d8/d53/BKE__scene_8h.html#a3794116b5c2e9ce6c720c460c61f8000">get_render_shadow_samples</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a2f9893cfb0b535c3a6fa3346f7c7b79b">samp</a>));
<a name="l00791"></a>00791         <a class="code" href="../../d0/de2/shadbuf_8c.html#a3794e005fcd95713e779008844e231a7">make_jitter_weight_tab</a>(re, shb, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6b9deafce0f3aaa480198addf2f5c7f0">filtertype</a>);
<a name="l00792"></a>00792         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00793"></a>00793         
<a name="l00794"></a>00794         <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>==4) jitbuf= <a class="code" href="../../d0/de2/shadbuf_8c.html#a2cb9239d7f09e1328108f439107578e0">give_jitter_tab</a>(2);
<a name="l00795"></a>00795         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>==9) jitbuf= <a class="code" href="../../d0/de2/shadbuf_8c.html#a2cb9239d7f09e1328108f439107578e0">give_jitter_tab</a>(3);
<a name="l00796"></a>00796         <span class="keywordflow">else</span> jitbuf= twozero;
<a name="l00797"></a>00797         
<a name="l00798"></a>00798         <span class="comment">/* zbuffering */</span>
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a> == <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a3cbc315c04ee863dd6824193d617381e">LA_SHADBUF_DEEP</a>) {
<a name="l00800"></a>00800             <a class="code" href="../../d0/de2/shadbuf_8c.html#a30f305dc5d34a39f8a672100f7970a9a">makedeepshadowbuf</a>(re, lar, jitbuf);
<a name="l00801"></a>00801             shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>= 1;
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803         <span class="keywordflow">else</span>
<a name="l00804"></a>00804             <a class="code" href="../../d0/de2/shadbuf_8c.html#a74de079eec04e2916beba4ae53b1871b">makeflatshadowbuf</a>(re, lar, jitbuf);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         <span class="comment">/* printf(&quot;lampbuf %d\n&quot;, sizeoflampbuf(shb)); */</span>
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808 }
<a name="l00809"></a>00809 
<a name="l00810"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aea8f6926c60b1cbe2acd3a5236f09fc6">00810</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d0/de2/shadbuf_8c.html#aea8f6926c60b1cbe2acd3a5236f09fc6">do_shadow_thread</a>(<span class="keywordtype">void</span> *re_v)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re= (<a class="code" href="../../d6/d7a/structRender.html">Render</a>*)re_v;
<a name="l00813"></a>00813     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="keywordflow">do</span> {
<a name="l00816"></a>00816         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00817"></a>00817         <span class="keywordflow">for</span> (lar=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar=lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>) {
<a name="l00818"></a>00818             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> &amp;&amp; !lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aba5dd87ddfa513666a4edf457ba5752b">thread_assigned</a>) {
<a name="l00819"></a>00819                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aba5dd87ddfa513666a4edf457ba5752b">thread_assigned</a>= 1;
<a name="l00820"></a>00820                 <span class="keywordflow">break</span>;
<a name="l00821"></a>00821             }
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         <span class="comment">/* if type is irregular, this only sets the perspective matrix and autoclips */</span>
<a name="l00826"></a>00826         <span class="keywordflow">if</span> (lar) {
<a name="l00827"></a>00827             <a class="code" href="../../d9/d30/shadbuf_8h.html#a05b20c49c3623cdd0b22d12bdae59ec5">makeshadowbuf</a>(re, lar);
<a name="l00828"></a>00828             <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00829"></a>00829             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a108d9f0071790332a2c0e269f9f611ca">thread_ready</a>= 1;
<a name="l00830"></a>00830             <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832     } <span class="keywordflow">while</span> (lar &amp;&amp; !re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>));
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a49a1889dfc7f713bea473df89aa705d6">00837</a> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a49a1889dfc7f713bea473df89aa705d6">g_break</a>= 0;
<a name="l00838"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a1bd59aee3c15b50d3c11222baea3e228">00838</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a1bd59aee3c15b50d3c11222baea3e228">thread_break</a>(<span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(arg))
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840     <span class="keywordflow">return</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a49a1889dfc7f713bea473df89aa705d6">g_break</a>;
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aacabbd2e2b4f817ce6e5db8c2eecd66c">00843</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#abe33e41b98914c843082883abbd8b81a">threaded_makeshadowbufs</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l00846"></a>00846     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00847"></a>00847     <span class="keywordtype">int</span> a, totthread= 0;
<a name="l00848"></a>00848     int (*<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>)(<span class="keywordtype">void</span> *);
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="comment">/* count number of threads to use */</span>
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering) {
<a name="l00852"></a>00852         <span class="keywordflow">for</span> (lar=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>)
<a name="l00853"></a>00853             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>)
<a name="l00854"></a>00854                 totthread++;
<a name="l00855"></a>00855         
<a name="l00856"></a>00856         totthread= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totthread, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a9edbf2d157a2d3765e97eba62f07ff68">threads</a>);
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858     <span class="keywordflow">else</span>
<a name="l00859"></a>00859         totthread= 1; <span class="comment">/* preview render */</span>
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <span class="keywordflow">if</span> (totthread &lt;= 1) {
<a name="l00862"></a>00862         <span class="keywordflow">for</span> (lar=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>) {
<a name="l00863"></a>00863             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <span class="keywordflow">break</span>;
<a name="l00864"></a>00864             <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l00865"></a>00865                 <span class="comment">/* if type is irregular, this only sets the perspective matrix and autoclips */</span>
<a name="l00866"></a>00866                 <a class="code" href="../../d9/d30/shadbuf_8h.html#a05b20c49c3623cdd0b22d12bdae59ec5">makeshadowbuf</a>(re, lar);
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870     <span class="keywordflow">else</span> {
<a name="l00871"></a>00871         <span class="comment">/* swap test break function */</span>
<a name="l00872"></a>00872         <a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>;
<a name="l00873"></a>00873         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a1bd59aee3c15b50d3c11222baea3e228">thread_break</a>;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <span class="keywordflow">for</span> (lar=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>) {
<a name="l00876"></a>00876             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aba5dd87ddfa513666a4edf457ba5752b">thread_assigned</a>= 0;
<a name="l00877"></a>00877             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a108d9f0071790332a2c0e269f9f611ca">thread_ready</a>= 0;
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../d0/de2/shadbuf_8c.html#aea8f6926c60b1cbe2acd3a5236f09fc6">do_shadow_thread</a>, totthread);
<a name="l00881"></a>00881         
<a name="l00882"></a>00882         <span class="keywordflow">for</span> (a=0; a&lt;totthread; a++)
<a name="l00883"></a>00883             <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, re);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885         <span class="comment">/* keep rendering as long as there are shadow buffers not ready */</span>
<a name="l00886"></a>00886         <span class="keywordflow">do</span> {
<a name="l00887"></a>00887             <span class="keywordflow">if</span> ((g_break=<a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)))
<a name="l00888"></a>00888                 <span class="keywordflow">break</span>;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890             <a class="code" href="../../df/d73/time_8c.html#a43667128024aa660ab9adfbd5df9e88a">PIL_sleep_ms</a>(50);
<a name="l00891"></a>00891 
<a name="l00892"></a>00892             <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00893"></a>00893             <span class="keywordflow">for</span> (lar=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a88d5216a0bcb1ace64bea62a8bc1d7e2">lampren</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; lar; lar= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3b4ea7183acf0e18204489be6f7d995b">next</a>)
<a name="l00894"></a>00894                 <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> &amp;&amp; !lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a108d9f0071790332a2c0e269f9f611ca">thread_ready</a>)
<a name="l00895"></a>00895                     <span class="keywordflow">break</span>;
<a name="l00896"></a>00896             <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00897"></a>00897         } <span class="keywordflow">while</span> (lar);
<a name="l00898"></a>00898     
<a name="l00899"></a>00899         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l00900"></a>00900 
<a name="l00901"></a>00901         <span class="comment">/* unset threadsafety */</span>
<a name="l00902"></a>00902         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>= <a class="code" href="../../d6/d95/rayshade_8c.html#addcfe7c39a71dffc8e622f705df6d5d1">test_break</a>;
<a name="l00903"></a>00903         g_break= 0;
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905 }
<a name="l00906"></a>00906 
<a name="l00907"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a80cff1f96b37e87d12e74aee04ec00a9">00907</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#a3b4d8f31d04b053984b2e3249f369871">freeshadowbuf</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l00908"></a>00908 {
<a name="l00909"></a>00909     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l00910"></a>00910         <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l00911"></a>00911         <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample;
<a name="l00912"></a>00912         <span class="keywordtype">int</span> b, v;
<a name="l00913"></a>00913         
<a name="l00914"></a>00914         <span class="keywordflow">for</span> (shsample= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; shsample; shsample= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a02424859f13d2584a8dbdda997f68e9d">next</a>) {
<a name="l00915"></a>00915             <span class="keywordflow">if</span> (shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>) {
<a name="l00916"></a>00916                 v= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l00917"></a>00917                 <span class="keywordflow">for</span> (b=0; b&lt;v; b++)
<a name="l00918"></a>00918                     <span class="keywordflow">if</span> (shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[b])
<a name="l00919"></a>00919                         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[b]);
<a name="l00920"></a>00920                     
<a name="l00921"></a>00921                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>);
<a name="l00922"></a>00922                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>);
<a name="l00923"></a>00923             }
<a name="l00924"></a>00924             <span class="keywordflow">else</span> {
<a name="l00925"></a>00925                 intptr_t *ztile= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>;
<a name="l00926"></a>00926                 <span class="keywordtype">char</span> *ctile= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>;
<a name="l00927"></a>00927                 
<a name="l00928"></a>00928                 v= (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>)/256;
<a name="l00929"></a>00929                 <span class="keywordflow">for</span> (b=0; b&lt;v; b++, ztile++, ctile++)
<a name="l00930"></a>00930                     <span class="keywordflow">if</span> (*ctile) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>((<span class="keywordtype">void</span> *) *ztile);
<a name="l00931"></a>00931                 
<a name="l00932"></a>00932                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>);
<a name="l00933"></a>00933                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>);
<a name="l00934"></a>00934             }
<a name="l00935"></a>00935         }
<a name="l00936"></a>00936         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>);
<a name="l00937"></a>00937         
<a name="l00938"></a>00938         <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>);
<a name="l00939"></a>00939         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>);
<a name="l00940"></a>00940         
<a name="l00941"></a>00941         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00942"></a>00942     }
<a name="l00943"></a>00943 }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945 
<a name="l00946"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">00946</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">firstreadshadbuf</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample, <span class="keywordtype">int</span> **rz, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> nr)
<a name="l00947"></a>00947 {
<a name="l00948"></a>00948     <span class="comment">/* return a 1 if fully compressed shadbuf-tile &amp;&amp; z==const */</span>
<a name="l00949"></a>00949     <span class="keywordtype">int</span> ofs;
<a name="l00950"></a>00950     <span class="keywordtype">char</span> *ct;
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     <span class="keywordflow">if</span> (shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>)
<a name="l00953"></a>00953         <span class="keywordflow">return</span> 0;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955     <span class="comment">/* always test borders of shadowbuffer */</span>
<a name="l00956"></a>00956     <span class="keywordflow">if</span> (xs&lt;0) xs= 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xs&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) xs= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>-1;
<a name="l00957"></a>00957     <span class="keywordflow">if</span> (ys&lt;0) ys= 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ys&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) ys= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>-1;
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="comment">/* calc z */</span>
<a name="l00960"></a>00960     ofs= (ys&gt;&gt;4)*(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>&gt;&gt;4) + (xs&gt;&gt;4);
<a name="l00961"></a>00961     ct= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>+ofs;
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (*ct==0) {
<a name="l00963"></a>00963         <span class="keywordflow">if</span> (nr==0) {
<a name="l00964"></a>00964             *rz= *( (<span class="keywordtype">int</span> **)(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>+ofs) );
<a name="l00965"></a>00965             <span class="keywordflow">return</span> 1;
<a name="l00966"></a>00966         }
<a name="l00967"></a>00967         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*rz!= *( (<span class="keywordtype">int</span> **)(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>+ofs) )) <span class="keywordflow">return</span> 0;
<a name="l00968"></a>00968         
<a name="l00969"></a>00969         <span class="keywordflow">return</span> 1;
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971     
<a name="l00972"></a>00972     <span class="keywordflow">return</span> 0;
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a9bf767ac8f01f6b6f0654e3a59b8ec03">00975</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a9bf767ac8f01f6b6f0654e3a59b8ec03">readdeepvisibility</a>(<a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *dsample, <span class="keywordtype">int</span> tot, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> bias, <span class="keywordtype">float</span> *biast)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977     <a class="code" href="../../d1/dc8/structDeepSample.html">DeepSample</a> *ds, *prevds;
<a name="l00978"></a>00978     <span class="keywordtype">float</span> t;
<a name="l00979"></a>00979     <span class="keywordtype">int</span> a;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     <span class="comment">/* tricky stuff here; we use ints which can overflow easily with bias values */</span>
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     ds= dsample;
<a name="l00984"></a>00984     <span class="keywordflow">for</span> (a=0; a&lt;tot &amp;&amp; (z-bias &gt; ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>); a++, ds++) {}
<a name="l00985"></a>00985 
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (a == tot) {
<a name="l00987"></a>00987         <span class="keywordflow">if</span> (biast)
<a name="l00988"></a>00988             *biast= 0.0f;
<a name="l00989"></a>00989         <span class="keywordflow">return</span> (ds-1)-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>; <span class="comment">/* completely behind all samples */</span>
<a name="l00990"></a>00990     }
<a name="l00991"></a>00991     
<a name="l00992"></a>00992     <span class="comment">/* check if this read needs bias blending */</span>
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (biast) {
<a name="l00994"></a>00994         <span class="keywordflow">if</span> (z &gt; ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>)
<a name="l00995"></a>00995             *biast= (float)(z - ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>)/(float)bias;
<a name="l00996"></a>00996         <span class="keywordflow">else</span>
<a name="l00997"></a>00997             *biast= 0.0f;
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="keywordflow">if</span> (a == 0)
<a name="l01001"></a>01001         <span class="keywordflow">return</span> 1.0f; <span class="comment">/* completely in front of all samples */</span>
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     <span class="comment">/* converting to float early here because ds-&gt;z - prevds-&gt;z can overflow */</span>
<a name="l01004"></a>01004     prevds= ds-1;
<a name="l01005"></a>01005     t= ((float)(z-bias) - (float)prevds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>)/((float)ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a> - (<span class="keywordtype">float</span>)prevds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a2b3824e1f1199d691bb6f8b95bbdc0c9">z</a>);
<a name="l01006"></a>01006     <span class="keywordflow">return</span> t*ds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a> + (1.0f-t)*prevds-&gt;<a class="code" href="../../d1/dc8/structDeepSample.html#a23a036a1dfee6b2cf0c1249aeae799d5">v</a>;
<a name="l01007"></a>01007 }
<a name="l01008"></a>01008 
<a name="l01009"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#af020061550a85357ba561e780a7e68f1">01009</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#af020061550a85357ba561e780a7e68f1">readdeepshadowbuf</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample, <span class="keywordtype">int</span> bias, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> zs)
<a name="l01010"></a>01010 {
<a name="l01011"></a>01011     <span class="keywordtype">float</span> v, biasv, biast;
<a name="l01012"></a>01012     <span class="keywordtype">int</span> ofs, tot;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keywordflow">if</span> (zs &lt; - 0x7FFFFE00 + bias)
<a name="l01015"></a>01015         <span class="keywordflow">return</span> 1.0; <span class="comment">/* extreme close to clipstart */</span>
<a name="l01016"></a>01016 
<a name="l01017"></a>01017     <span class="comment">/* calc z */</span>
<a name="l01018"></a>01018     ofs= ys*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a> + xs;
<a name="l01019"></a>01019     tot= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a8ecf5ea56bc2fae0228013ccea29afa7">totbuf</a>[ofs];
<a name="l01020"></a>01020     <span class="keywordflow">if</span> (tot == 0)
<a name="l01021"></a>01021         <span class="keywordflow">return</span> 1.0f;
<a name="l01022"></a>01022 
<a name="l01023"></a>01023     v= <a class="code" href="../../d0/de2/shadbuf_8c.html#a9bf767ac8f01f6b6f0654e3a59b8ec03">readdeepvisibility</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[ofs], tot, zs, bias, &amp;biast);
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="keywordflow">if</span> (biast != 0.0f) {
<a name="l01026"></a>01026         <span class="comment">/* in soft bias area */</span>
<a name="l01027"></a>01027         biasv= <a class="code" href="../../d0/de2/shadbuf_8c.html#a9bf767ac8f01f6b6f0654e3a59b8ec03">readdeepvisibility</a>(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>[ofs], tot, zs, 0, 0);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         biast= biast*biast;
<a name="l01030"></a>01030         <span class="keywordflow">return</span> (1.0f-biast)*v + biast*biasv;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="keywordflow">return</span> v;
<a name="l01034"></a>01034 }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">/* return 1.0 : fully in light */</span>
<a name="l01037"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aee7b8380459c2160ccaf4f5aba260bfa">01037</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#aee7b8380459c2160ccaf4f5aba260bfa">readshadowbuf</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample, <span class="keywordtype">int</span> bias, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> zs) 
<a name="l01038"></a>01038 {
<a name="l01039"></a>01039     <span class="keywordtype">float</span> temp;
<a name="l01040"></a>01040     <span class="keywordtype">int</span> *rz, ofs;
<a name="l01041"></a>01041     <span class="keywordtype">int</span> zsamp=0;
<a name="l01042"></a>01042     <span class="keywordtype">char</span> *ct, *cz;
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="comment">/* simpleclip */</span>
<a name="l01045"></a>01045     <span class="comment">/* if (xs&lt;0 || ys&lt;0) return 1.0; */</span>
<a name="l01046"></a>01046     <span class="comment">/* if (xs&gt;=shb-&gt;size || ys&gt;=shb-&gt;size) return 1.0; */</span>
<a name="l01047"></a>01047     
<a name="l01048"></a>01048     <span class="comment">/* always test borders of shadowbuffer */</span>
<a name="l01049"></a>01049     <span class="keywordflow">if</span> (xs&lt;0) xs= 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xs&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) xs= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>-1;
<a name="l01050"></a>01050     <span class="keywordflow">if</span> (ys&lt;0) ys= 0; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ys&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) ys= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>-1;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052     <span class="keywordflow">if</span> (shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#af68e239726fcb2a843013971383ff013">deepbuf</a>)
<a name="l01053"></a>01053         <span class="keywordflow">return</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#af020061550a85357ba561e780a7e68f1">readdeepshadowbuf</a>(shb, shsample, bias, xs, ys, zs);
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     <span class="comment">/* calc z */</span>
<a name="l01056"></a>01056     ofs= (ys&gt;&gt;4)*(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>&gt;&gt;4) + (xs&gt;&gt;4);
<a name="l01057"></a>01057     ct= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>+ofs;
<a name="l01058"></a>01058     rz= *( (<span class="keywordtype">int</span> **)(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>+ofs) );
<a name="l01059"></a>01059 
<a name="l01060"></a>01060     <span class="keywordflow">if</span> (*ct==3) {
<a name="l01061"></a>01061         ct= ((<span class="keywordtype">char</span> *)rz)+3*16*(ys &amp; 15)+3*(xs &amp; 15);
<a name="l01062"></a>01062         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01063"></a>01063         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">ACOMP</a>]= ct[0];
<a name="l01064"></a>01064         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>]= ct[1];
<a name="l01065"></a>01065         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[2];
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ct==2) {
<a name="l01068"></a>01068         ct= ((<span class="keywordtype">char</span> *)rz);
<a name="l01069"></a>01069         ct+= 4+2*16*(ys &amp; 15)+2*(xs &amp; 15);
<a name="l01070"></a>01070         zsamp= *rz;
<a name="l01071"></a>01071     
<a name="l01072"></a>01072         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01073"></a>01073         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>]= ct[0];
<a name="l01074"></a>01074         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[1];
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ct==1) {
<a name="l01077"></a>01077         ct= ((<span class="keywordtype">char</span> *)rz);
<a name="l01078"></a>01078         ct+= 4+16*(ys &amp; 15)+(xs &amp; 15);
<a name="l01079"></a>01079         zsamp= *rz;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01082"></a>01082         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[0];
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085     <span class="keywordflow">else</span> {
<a name="l01086"></a>01086         <span class="comment">/* got warning on this for 64 bits.... */</span>
<a name="l01087"></a>01087         <span class="comment">/* but it&#39;s working code! in this case rz is not a pointer but zvalue (ton) */</span>
<a name="l01088"></a>01088         zsamp= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(rz);
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="comment">/* tricky stuff here; we use ints which can overflow easily with bias values */</span>
<a name="l01092"></a>01092     
<a name="l01093"></a>01093     <span class="keywordflow">if</span> (zsamp &gt; zs) <span class="keywordflow">return</span> 1.0;         <span class="comment">/* absolute no shadow */</span>
<a name="l01094"></a>01094     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zs &lt; - 0x7FFFFE00 + bias) <span class="keywordflow">return</span> 1.0;  <span class="comment">/* extreme close to clipstart */</span>
<a name="l01095"></a>01095     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zsamp &lt; zs-bias) <span class="keywordflow">return</span> 0.0;   <span class="comment">/* absolute in shadow */</span>
<a name="l01096"></a>01096     <span class="keywordflow">else</span> {                  <span class="comment">/* soft area */</span>
<a name="l01097"></a>01097         
<a name="l01098"></a>01098         temp=  ( (float)(zs- zsamp) )/(<span class="keywordtype">float</span>)bias;
<a name="l01099"></a>01099         <span class="keywordflow">return</span> 1.0f - temp*temp;
<a name="l01100"></a>01100             
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102 }
<a name="l01103"></a>01103 
<a name="l01104"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a79f3518d4b3a9e4899d619ddfda01450">01104</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a79f3518d4b3a9e4899d619ddfda01450">shadowbuf_project_co</a>(<span class="keywordtype">float</span> *x, <span class="keywordtype">float</span> *y, <span class="keywordtype">float</span> *z, <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l01105"></a>01105 {
<a name="l01106"></a>01106     <span class="keywordtype">float</span> hco[4], <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= 0.5f*(float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(hco, co);
<a name="l01109"></a>01109     hco[3]= 1.0f;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, hco);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     *x= size*(1.0f+hco[0]/hco[3]);
<a name="l01114"></a>01114     *y= size*(1.0f+hco[1]/hco[3]);
<a name="l01115"></a>01115     <span class="keywordflow">if</span> (z) *z= (hco[2]/hco[3]);
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="comment">/* the externally called shadow testing (reading) function */</span>
<a name="l01119"></a>01119 <span class="comment">/* return 1.0: no shadow at all */</span>
<a name="l01120"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aebae9ef5ec38874b4ce5dcb20c0e6a28">01120</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#a90bba8ef1567f3b648d21a39493a85a7">testshadowbuf</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dxco[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dyco[3], <span class="keywordtype">float</span> inp, <span class="keywordtype">float</span> mat_bias)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122     <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample;
<a name="l01123"></a>01123     <span class="keywordtype">float</span> fac, dco[3], dx[3], dy[3], shadfac=0.0f;
<a name="l01124"></a>01124     <span class="keywordtype">float</span> xs1, ys1, zs1, *<a class="code" href="../../d5/d5f/interface__widgets_8c.html#a36d1e43f9712c82a34c10ca190b7fd9b">jit</a>, *weight, xres, yres, biasf;
<a name="l01125"></a>01125     <span class="keywordtype">int</span> xs, ys, zs, bias, *rz;
<a name="l01126"></a>01126     <span class="keywordtype">short</span> a, num;
<a name="l01127"></a>01127     
<a name="l01128"></a>01128     <span class="comment">/* crash preventer */</span>
<a name="l01129"></a>01129     <span class="keywordflow">if</span> (shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01130"></a>01130         <span class="keywordflow">return</span> 1.0f;
<a name="l01131"></a>01131     
<a name="l01132"></a>01132     <span class="comment">/* when facing away, assume fully in shadow */</span>
<a name="l01133"></a>01133     <span class="keywordflow">if</span> (inp &lt;= 0.0f)
<a name="l01134"></a>01134         <span class="keywordflow">return</span> 0.0f;
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">/* project coordinate to pixel space */</span>
<a name="l01137"></a>01137     <a class="code" href="../../d0/de2/shadbuf_8c.html#a79f3518d4b3a9e4899d619ddfda01450">shadowbuf_project_co</a>(&amp;xs1, &amp;ys1, &amp;zs1, shb, co);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <span class="comment">/* clip z coordinate, z is projected so that (-1.0, 1.0) matches</span>
<a name="l01140"></a>01140 <span class="comment">     * (clipstart, clipend), so we can do this simple test */</span>
<a name="l01141"></a>01141     <span class="keywordflow">if</span> (zs1&gt;=1.0f)
<a name="l01142"></a>01142         <span class="keywordflow">return</span> 0.0f;
<a name="l01143"></a>01143     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zs1&lt;= -1.0f)
<a name="l01144"></a>01144         <span class="keywordflow">return</span> 1.0f;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     zs= ((float)0x7FFFFFFF)*zs1;
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="comment">/* take num*num samples, increase area with fac */</span>
<a name="l01149"></a>01149     num= <a class="code" href="../../d8/d53/BKE__scene_8h.html#a3794116b5c2e9ce6c720c460c61f8000">get_render_shadow_samples</a>(&amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a2f9893cfb0b535c3a6fa3346f7c7b79b">samp</a>);
<a name="l01150"></a>01150     num= num*num;
<a name="l01151"></a>01151     fac= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a402c5e66dea73848bb2d758f5e277429">soft</a>;
<a name="l01152"></a>01152     
<a name="l01153"></a>01153     <span class="comment">/* compute z bias */</span>
<a name="l01154"></a>01154     <span class="keywordflow">if</span> (mat_bias!=0.0f) biasf= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>*mat_bias;
<a name="l01155"></a>01155     <span class="keywordflow">else</span> biasf= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>;
<a name="l01156"></a>01156     <span class="comment">/* with inp==1.0, bias is half the size. correction value was 1.1, giving errors </span>
<a name="l01157"></a>01157 <span class="comment">     * on cube edges, with one side being almost frontal lighted (ton)  */</span>
<a name="l01158"></a>01158     bias= (1.5f-inp*inp)*biasf;
<a name="l01159"></a>01159     
<a name="l01160"></a>01160     <span class="comment">/* in case of no filtering we can do things simpler */</span>
<a name="l01161"></a>01161     <span class="keywordflow">if</span> (num==1) {
<a name="l01162"></a>01162         <span class="keywordflow">for</span> (shsample= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; shsample; shsample= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a02424859f13d2584a8dbdda997f68e9d">next</a>)
<a name="l01163"></a>01163             shadfac += <a class="code" href="../../d0/de2/shadbuf_8c.html#aee7b8380459c2160ccaf4f5aba260bfa">readshadowbuf</a>(shb, shsample, bias, (<span class="keywordtype">int</span>)xs1, (<span class="keywordtype">int</span>)ys1, zs);
<a name="l01164"></a>01164         
<a name="l01165"></a>01165         <span class="keywordflow">return</span> shadfac/(float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>;
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="comment">/* calculate filter size */</span>
<a name="l01169"></a>01169     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(dco, co, dxco);
<a name="l01170"></a>01170     <a class="code" href="../../d0/de2/shadbuf_8c.html#a79f3518d4b3a9e4899d619ddfda01450">shadowbuf_project_co</a>(&amp;dx[0], &amp;dx[1], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, shb, dco);
<a name="l01171"></a>01171     dx[0]= xs1 - dx[0];
<a name="l01172"></a>01172     dx[1]= ys1 - dx[1];
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(dco, co, dyco);
<a name="l01175"></a>01175     <a class="code" href="../../d0/de2/shadbuf_8c.html#a79f3518d4b3a9e4899d619ddfda01450">shadowbuf_project_co</a>(&amp;dy[0], &amp;dy[1], <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, shb, dco);
<a name="l01176"></a>01176     dy[0]= xs1 - dy[0];
<a name="l01177"></a>01177     dy[1]= ys1 - dy[1];
<a name="l01178"></a>01178     
<a name="l01179"></a>01179     xres= fac*(<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dx[0]) + <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dy[0]));
<a name="l01180"></a>01180     yres= fac*(<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dx[1]) + <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(dy[1]));
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (xres&lt;1.0f) xres= 1.0f;
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (yres&lt;1.0f) yres= 1.0f;
<a name="l01183"></a>01183     
<a name="l01184"></a>01184     <span class="comment">/* make xs1/xs1 corner of sample area */</span>
<a name="l01185"></a>01185     xs1 -= xres*0.5f;
<a name="l01186"></a>01186     ys1 -= yres*0.5f;
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     <span class="comment">/* in case we have a constant value in a tile, we can do quicker lookup */</span>
<a name="l01189"></a>01189     <span class="keywordflow">if</span> (xres&lt;16.0f &amp;&amp; yres&lt;16.0f) {
<a name="l01190"></a>01190         shsample= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01191"></a>01191         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">firstreadshadbuf</a>(shb, shsample, &amp;rz, (<span class="keywordtype">int</span>)xs1, (<span class="keywordtype">int</span>)ys1, 0)) {
<a name="l01192"></a>01192             <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">firstreadshadbuf</a>(shb, shsample, &amp;rz, (<span class="keywordtype">int</span>)(xs1+xres), (<span class="keywordtype">int</span>)ys1, 1)) {
<a name="l01193"></a>01193                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">firstreadshadbuf</a>(shb, shsample, &amp;rz, (<span class="keywordtype">int</span>)xs1, (<span class="keywordtype">int</span>)(ys1+yres), 1)) {
<a name="l01194"></a>01194                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a56fb9c3d7cf8a080f8ab8a3fe735381a">firstreadshadbuf</a>(shb, shsample, &amp;rz, (<span class="keywordtype">int</span>)(xs1+xres), (<span class="keywordtype">int</span>)(ys1+yres), 1)) {
<a name="l01195"></a>01195                         <span class="keywordflow">return</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#aee7b8380459c2160ccaf4f5aba260bfa">readshadowbuf</a>(shb, shsample, bias,(<span class="keywordtype">int</span>)xs1, (<span class="keywordtype">int</span>)ys1, zs);
<a name="l01196"></a>01196                     }
<a name="l01197"></a>01197                 }
<a name="l01198"></a>01198             }
<a name="l01199"></a>01199         }
<a name="l01200"></a>01200     }
<a name="l01201"></a>01201     
<a name="l01202"></a>01202     <span class="comment">/* full jittered shadow buffer lookup */</span>
<a name="l01203"></a>01203     <span class="keywordflow">for</span> (shsample= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; shsample; shsample= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a02424859f13d2584a8dbdda997f68e9d">next</a>) {
<a name="l01204"></a>01204         jit= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac88ceaccc14be47c5a0eacaeb307f589">jit</a>;
<a name="l01205"></a>01205         weight= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a42b6570861745d7d955da5a7f3c032cd">weight</a>;
<a name="l01206"></a>01206         
<a name="l01207"></a>01207         <span class="keywordflow">for</span> (a=num; a&gt;0; a--, jit+=2, weight++) {
<a name="l01208"></a>01208             <span class="comment">/* instead of jit i tried random: ugly! */</span>
<a name="l01209"></a>01209             <span class="comment">/* note: the plus 0.5 gives best sampling results, jit goes from -0.5 to 0.5 */</span>
<a name="l01210"></a>01210             <span class="comment">/* xs1 and ys1 are already corrected to be corner of sample area */</span>
<a name="l01211"></a>01211             xs= xs1 + xres*(jit[0] + 0.5f);
<a name="l01212"></a>01212             ys= ys1 + yres*(jit[1] + 0.5f);
<a name="l01213"></a>01213             
<a name="l01214"></a>01214             shadfac+= *weight * <a class="code" href="../../d0/de2/shadbuf_8c.html#aee7b8380459c2160ccaf4f5aba260bfa">readshadowbuf</a>(shb, shsample, bias, xs, ys, zs);
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="comment">/* Renormalizes for the sample number: */</span>
<a name="l01219"></a>01219     <span class="keywordflow">return</span> shadfac/(float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>;
<a name="l01220"></a>01220 }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 <span class="comment">/* different function... sampling behind clipend can be LIGHT, bias is negative! */</span>
<a name="l01223"></a>01223 <span class="comment">/* return: light */</span>
<a name="l01224"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a22243088778107cf04742042eb84a22d">01224</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a22243088778107cf04742042eb84a22d">readshadowbuf_halo</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample, <span class="keywordtype">int</span> xs, <span class="keywordtype">int</span> ys, <span class="keywordtype">int</span> zs)
<a name="l01225"></a>01225 {
<a name="l01226"></a>01226     <span class="keywordtype">float</span> temp;
<a name="l01227"></a>01227     <span class="keywordtype">int</span> *rz, ofs;
<a name="l01228"></a>01228     <span class="keywordtype">int</span> bias, zbias, zsamp;
<a name="l01229"></a>01229     <span class="keywordtype">char</span> *ct, *cz;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="comment">/* negative! The other side is more important */</span>
<a name="l01232"></a>01232     bias= -shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>;
<a name="l01233"></a>01233     
<a name="l01234"></a>01234     <span class="comment">/* simpleclip */</span>
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (xs&lt;0 || ys&lt;0) <span class="keywordflow">return</span> 0.0;
<a name="l01236"></a>01236     <span class="keywordflow">if</span> (xs&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a> || ys&gt;=shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) <span class="keywordflow">return</span> 0.0;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="comment">/* calc z */</span>
<a name="l01239"></a>01239     ofs= (ys&gt;&gt;4)*(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>&gt;&gt;4) + (xs&gt;&gt;4);
<a name="l01240"></a>01240     ct= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a804885362ad58a4a275e65ad28a64174">cbuf</a>+ofs;
<a name="l01241"></a>01241     rz= *( (<span class="keywordtype">int</span> **)(shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a921f26c0813d3317033342c066b9b808">zbuf</a>+ofs) );
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     <span class="keywordflow">if</span> (*ct==3) {
<a name="l01244"></a>01244         ct= ((<span class="keywordtype">char</span> *)rz)+3*16*(ys &amp; 15)+3*(xs &amp; 15);
<a name="l01245"></a>01245         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01246"></a>01246         zsamp= 0;
<a name="l01247"></a>01247         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a280adf0fb0ab44be784454b447d36ad9">ACOMP</a>]= ct[0];
<a name="l01248"></a>01248         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>]= ct[1];
<a name="l01249"></a>01249         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[2];
<a name="l01250"></a>01250     }
<a name="l01251"></a>01251     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ct==2) {
<a name="l01252"></a>01252         ct= ((<span class="keywordtype">char</span> *)rz);
<a name="l01253"></a>01253         ct+= 4+2*16*(ys &amp; 15)+2*(xs &amp; 15);
<a name="l01254"></a>01254         zsamp= *rz;
<a name="l01255"></a>01255     
<a name="l01256"></a>01256         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01257"></a>01257         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#a2beec72a32b22eaaf4743697e057e5bf">BCOMP</a>]= ct[0];
<a name="l01258"></a>01258         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[1];
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ct==1) {
<a name="l01261"></a>01261         ct= ((<span class="keywordtype">char</span> *)rz);
<a name="l01262"></a>01262         ct+= 4+16*(ys &amp; 15)+(xs &amp; 15);
<a name="l01263"></a>01263         zsamp= *rz;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265         cz= (<span class="keywordtype">char</span> *)&amp;zsamp;
<a name="l01266"></a>01266         cz[<a class="code" href="../../d0/de2/shadbuf_8c.html#afc5b6810d6f07f5d10163c70b505717c">GCOMP</a>]= ct[0];
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     }
<a name="l01269"></a>01269     <span class="keywordflow">else</span> {
<a name="l01270"></a>01270         <span class="comment">/* same as before */</span>
<a name="l01271"></a>01271         <span class="comment">/* still working code! (ton) */</span>
<a name="l01272"></a>01272         zsamp= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#afe52e69b7f74d4e0319b467db917c08c">GET_INT_FROM_POINTER</a>(rz);
<a name="l01273"></a>01273     }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     <span class="comment">/* NO schadow when sampled at &#39;eternal&#39; distance */</span>
<a name="l01276"></a>01276 
<a name="l01277"></a>01277     <span class="keywordflow">if</span> (zsamp &gt;= 0x7FFFFE00) <span class="keywordflow">return</span> 1.0;
<a name="l01278"></a>01278 
<a name="l01279"></a>01279     <span class="keywordflow">if</span> (zsamp &gt; zs) <span class="keywordflow">return</span> 1.0;         <span class="comment">/* absolute no shadww */</span>
<a name="l01280"></a>01280     <span class="keywordflow">else</span> {
<a name="l01281"></a>01281         <span class="comment">/* bias is negative, so the (zs-bias) can be beyond 0x7fffffff */</span>
<a name="l01282"></a>01282         zbias= 0x7fffffff - zs;
<a name="l01283"></a>01283         <span class="keywordflow">if</span> (zbias &gt; -bias) {
<a name="l01284"></a>01284             <span class="keywordflow">if</span> ( zsamp &lt; zs-bias) <span class="keywordflow">return</span> 0.0;   <span class="comment">/* absolute in shadow */</span>
<a name="l01285"></a>01285         }
<a name="l01286"></a>01286         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0.0;    <span class="comment">/* absolute shadow */</span>
<a name="l01287"></a>01287     }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="comment">/* soft area */</span>
<a name="l01290"></a>01290     
<a name="l01291"></a>01291     temp=  ( (float)(zs- zsamp) )/(<span class="keywordtype">float</span>)bias;
<a name="l01292"></a>01292     <span class="keywordflow">return</span> 1.0f - temp*temp;
<a name="l01293"></a>01293 }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295 
<a name="l01296"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#af781091a3e773a0c4d5931ed41850215">01296</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#af781091a3e773a0c4d5931ed41850215">shadow_halo</a>(<a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[3])
<a name="l01297"></a>01297 {
<a name="l01298"></a>01298     <span class="comment">/* p1 p2 already are rotated in spot-space */</span>
<a name="l01299"></a>01299     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l01300"></a>01300     <a class="code" href="../../dc/d40/structShadSampleBuf.html">ShadSampleBuf</a> *shsample;
<a name="l01301"></a>01301     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[4], siz;
<a name="l01302"></a>01302     <span class="keywordtype">float</span> labda, labdao, labdax, labday, ldx, ldy;
<a name="l01303"></a>01303     <span class="keywordtype">float</span> zf, xf1, yf1, zf1, xf2, yf2, zf2;
<a name="l01304"></a>01304     <span class="keywordtype">float</span> count, lightcount;
<a name="l01305"></a>01305     <span class="keywordtype">int</span> x, y, z, xs1, ys1;
<a name="l01306"></a>01306     <span class="keywordtype">int</span> dx = 0, dy = 0;
<a name="l01307"></a>01307     
<a name="l01308"></a>01308     siz= 0.5f*(float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l01309"></a>01309     
<a name="l01310"></a>01310     co[0]= p1[0];
<a name="l01311"></a>01311     co[1]= p1[1];
<a name="l01312"></a>01312     co[2]= p1[2]/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l01313"></a>01313     co[3]= 1.0;
<a name="l01314"></a>01314     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, co); <span class="comment">/* rational hom co */</span>
<a name="l01315"></a>01315     xf1= siz*(1.0f+co[0]/co[3]);
<a name="l01316"></a>01316     yf1= siz*(1.0f+co[1]/co[3]);
<a name="l01317"></a>01317     zf1= (co[2]/co[3]);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 
<a name="l01320"></a>01320     co[0]= p2[0];
<a name="l01321"></a>01321     co[1]= p2[1];
<a name="l01322"></a>01322     co[2]= p2[2]/lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l01323"></a>01323     co[3]= 1.0;
<a name="l01324"></a>01324     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, co); <span class="comment">/* rational hom co */</span>
<a name="l01325"></a>01325     xf2= siz*(1.0f+co[0]/co[3]);
<a name="l01326"></a>01326     yf2= siz*(1.0f+co[1]/co[3]);
<a name="l01327"></a>01327     zf2= (co[2]/co[3]);
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="comment">/* the 2dda (a pixel line formula) */</span>
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     xs1= (int)xf1;
<a name="l01332"></a>01332     ys1= (int)yf1;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     <span class="keywordflow">if</span> (xf1 != xf2) {
<a name="l01335"></a>01335         <span class="keywordflow">if</span> (xf2-xf1 &gt; 0.0f) {
<a name="l01336"></a>01336             labdax= (xf1-xs1-1.0f)/(xf1-xf2);
<a name="l01337"></a>01337             ldx= -shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>/(xf1-xf2);
<a name="l01338"></a>01338             dx= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>;
<a name="l01339"></a>01339         }
<a name="l01340"></a>01340         <span class="keywordflow">else</span> {
<a name="l01341"></a>01341             labdax= (xf1-xs1)/(xf1-xf2);
<a name="l01342"></a>01342             ldx= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>/(xf1-xf2);
<a name="l01343"></a>01343             dx= -shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>;
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345     }
<a name="l01346"></a>01346     <span class="keywordflow">else</span> {
<a name="l01347"></a>01347         labdax= 1.0;
<a name="l01348"></a>01348         ldx= 0.0;
<a name="l01349"></a>01349     }
<a name="l01350"></a>01350 
<a name="l01351"></a>01351     <span class="keywordflow">if</span> (yf1 != yf2) {
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (yf2-yf1 &gt; 0.0f) {
<a name="l01353"></a>01353             labday= (yf1-ys1-1.0f)/(yf1-yf2);
<a name="l01354"></a>01354             ldy= -shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>/(yf1-yf2);
<a name="l01355"></a>01355             dy= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>;
<a name="l01356"></a>01356         }
<a name="l01357"></a>01357         <span class="keywordflow">else</span> {
<a name="l01358"></a>01358             labday= (yf1-ys1)/(yf1-yf2);
<a name="l01359"></a>01359             ldy= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>/(yf1-yf2);
<a name="l01360"></a>01360             dy= -shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a3fa619ee8dbabc78b8001d18f270e672">shadhalostep</a>;
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     <span class="keywordflow">else</span> {
<a name="l01364"></a>01364         labday= 1.0;
<a name="l01365"></a>01365         ldy= 0.0;
<a name="l01366"></a>01366     }
<a name="l01367"></a>01367     
<a name="l01368"></a>01368     x= xs1;
<a name="l01369"></a>01369     y= ys1;
<a name="l01370"></a>01370     labda= count= lightcount= 0.0;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372 <span class="comment">/* printf(&quot;start %x %x  \n&quot;, (int)(0x7FFFFFFF*zf1), (int)(0x7FFFFFFF*zf2)); */</span>
<a name="l01373"></a>01373 
<a name="l01374"></a>01374     <span class="keywordflow">while</span> (1) {
<a name="l01375"></a>01375         labdao= labda;
<a name="l01376"></a>01376         
<a name="l01377"></a>01377         <span class="keywordflow">if</span> (labdax==labday) {
<a name="l01378"></a>01378             labdax+= ldx;
<a name="l01379"></a>01379             x+= dx;
<a name="l01380"></a>01380             labday+= ldy;
<a name="l01381"></a>01381             y+= dy;
<a name="l01382"></a>01382         }
<a name="l01383"></a>01383         <span class="keywordflow">else</span> {
<a name="l01384"></a>01384             <span class="keywordflow">if</span> (labdax&lt;labday) {
<a name="l01385"></a>01385                 labdax+= ldx;
<a name="l01386"></a>01386                 x+= dx;
<a name="l01387"></a>01387             }
<a name="l01388"></a>01388             <span class="keywordflow">else</span> {
<a name="l01389"></a>01389                 labday+= ldy;
<a name="l01390"></a>01390                 y+= dy;
<a name="l01391"></a>01391             }
<a name="l01392"></a>01392         }
<a name="l01393"></a>01393         
<a name="l01394"></a>01394         labda= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(labdax, labday);
<a name="l01395"></a>01395         <span class="keywordflow">if</span> (labda==labdao || labda&gt;=1.0f) <span class="keywordflow">break</span>;
<a name="l01396"></a>01396         
<a name="l01397"></a>01397         zf= zf1 + labda*(zf2-zf1);
<a name="l01398"></a>01398         count+= (float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a03c28058fc6dd81eb47e594e86964d8b">totbuf</a>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (zf&lt;= -1.0f) lightcount += 1.0f; <span class="comment">/* close to the spot */</span>
<a name="l01401"></a>01401         <span class="keywordflow">else</span> {
<a name="l01402"></a>01402         
<a name="l01403"></a>01403             <span class="comment">/* make sure, behind the clipend we extend halolines. */</span>
<a name="l01404"></a>01404             <span class="keywordflow">if</span> (zf&gt;=1.0f) z= 0x7FFFF000;
<a name="l01405"></a>01405             <span class="keywordflow">else</span> z= (int)(0x7FFFF000*zf);
<a name="l01406"></a>01406             
<a name="l01407"></a>01407             <span class="keywordflow">for</span> (shsample= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a75094fa690036ed87bdc3bef2a6cb9b9">buffers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; shsample; shsample= shsample-&gt;<a class="code" href="../../dc/d40/structShadSampleBuf.html#a02424859f13d2584a8dbdda997f68e9d">next</a>)
<a name="l01408"></a>01408                 lightcount+= <a class="code" href="../../d0/de2/shadbuf_8c.html#a22243088778107cf04742042eb84a22d">readshadowbuf_halo</a>(shb, shsample, x, y, z);
<a name="l01409"></a>01409             
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411     }
<a name="l01412"></a>01412     
<a name="l01413"></a>01413     <span class="keywordflow">if</span> (count!=0.0f) <span class="keywordflow">return</span> (lightcount/count);
<a name="l01414"></a>01414     <span class="keywordflow">return</span> 0.0f;
<a name="l01415"></a>01415     
<a name="l01416"></a>01416 }
<a name="l01417"></a>01417 
<a name="l01418"></a>01418 
<a name="l01419"></a>01419 <span class="comment">/* ********************* Irregular Shadow Buffer (ISB) ************* */</span>
<a name="l01420"></a>01420 <span class="comment">/* ********** storage of all view samples in a raster of lists ***** */</span>
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 <span class="comment">/* based on several articles describing this method, like:</span>
<a name="l01423"></a>01423 <span class="comment"> * The Irregular Z-Buffer and its Application to Shadow Mapping</span>
<a name="l01424"></a>01424 <span class="comment"> * Gregory S. Johnson - William R. Mark - Christopher A. Burns</span>
<a name="l01425"></a>01425 <span class="comment"> * and</span>
<a name="l01426"></a>01426 <span class="comment"> * Alias-Free Shadow Maps</span>
<a name="l01427"></a>01427 <span class="comment"> * Timo Aila and Samuli Laine</span>
<a name="l01428"></a>01428 <span class="comment"> */</span>
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 <span class="comment">/* bsp structure (actually kd tree) */</span>
<a name="l01431"></a>01431 
<a name="l01432"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">01432</a> <span class="preprocessor">#define BSPMAX_SAMPLE   128</span>
<a name="l01433"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a5f2f14d6308c85fef237a5f907c14f8f">01433</a> <span class="preprocessor"></span><span class="preprocessor">#define BSPMAX_DEPTH    32</span>
<a name="l01434"></a>01434 <span class="preprocessor"></span>
<a name="l01435"></a>01435 <span class="comment">/* aligned with struct rctf */</span>
<a name="l01436"></a><a class="code" href="../../d9/d84/structBoxf.html">01436</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d84/structBoxf.html">Boxf</a> {
<a name="l01437"></a><a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">01437</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a>, <a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a>;
<a name="l01438"></a><a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">01438</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a>, <a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a>;
<a name="l01439"></a><a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">01439</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a>, <a class="code" href="../../d9/d84/structBoxf.html#a92e375ea5a0d58ec8c604e254d77d969">zmax</a>;
<a name="l01440"></a>01440 } <a class="code" href="../../d0/de2/shadbuf_8c.html#aca37df1970d2f269fcff43ba9c5083aa">Boxf</a>;
<a name="l01441"></a>01441 
<a name="l01442"></a><a class="code" href="../../db/d5b/structISBBranch.html">01442</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> {
<a name="l01443"></a><a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">01443</a>     <span class="keyword">struct </span><a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>, *<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>;
<a name="l01444"></a><a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">01444</a>     <span class="keywordtype">float</span> <a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[2];
<a name="l01445"></a><a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">01445</a>     <a class="code" href="../../d9/d84/structBoxf.html">Boxf</a> <a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>;
<a name="l01446"></a><a class="code" href="../../db/d5b/structISBBranch.html#a2d37db95d13830af33e67e910cd69ec2">01446</a>     <span class="keywordtype">short</span> <a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>, <a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>, <a class="code" href="../../db/d5b/structISBBranch.html#adcefdfdd994f8b65cb29a321122ed14e">full</a>, <a class="code" href="../../db/d5b/structISBBranch.html#a2d37db95d13830af33e67e910cd69ec2">unused</a>;
<a name="l01447"></a><a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">01447</a>     <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> **<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>;
<a name="l01448"></a>01448 } <a class="code" href="../../d0/de2/shadbuf_8c.html#a8d5074dc7df39a709da885544d6cf1e6">ISBBranch</a>;
<a name="l01449"></a>01449 
<a name="l01450"></a><a class="code" href="../../dc/d7b/structBSPFace.html">01450</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> {
<a name="l01451"></a><a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">01451</a>     <a class="code" href="../../d9/d84/structBoxf.html">Boxf</a> <a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>;
<a name="l01452"></a><a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">01452</a>     <span class="keywordtype">float</span> *<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>, *<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>, *<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>, *<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>;
<a name="l01453"></a><a class="code" href="../../dc/d7b/structBSPFace.html#a8fcf699604e04790a04e16739ae1e80c">01453</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/d7b/structBSPFace.html#a8fcf699604e04790a04e16739ae1e80c">obi</a>;        <span class="comment">/* object for face lookup */</span>
<a name="l01454"></a><a class="code" href="../../dc/d7b/structBSPFace.html#aa57e0629644ed99a829b811804b9f97e">01454</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/d7b/structBSPFace.html#aa57e0629644ed99a829b811804b9f97e">facenr</a>;     <span class="comment">/* index to retrieve VlakRen */</span>
<a name="l01455"></a><a class="code" href="../../dc/d7b/structBSPFace.html#a27af46ac5f9a142610601ef6b43b176a">01455</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/d7b/structBSPFace.html#a27af46ac5f9a142610601ef6b43b176a">type</a>;       <span class="comment">/* only for strand now */</span>
<a name="l01456"></a><a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">01456</a>     <span class="keywordtype">short</span> <a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>, <a class="code" href="../../dc/d7b/structBSPFace.html#a033d17075b6913e69afbd8ee469669ef">is_full</a>;
<a name="l01457"></a>01457     
<a name="l01458"></a>01458     <span class="comment">/* strand caching data, optimize for point_behind_strand() */</span>
<a name="l01459"></a><a class="code" href="../../dc/d7b/structBSPFace.html#ab7abcadb96d4f114d15c7453b86830d9">01459</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/d7b/structBSPFace.html#ad1e714ae6be7dca381510e4fe5d7d7ad">radline</a>, <a class="code" href="../../dc/d7b/structBSPFace.html#ab7abcadb96d4f114d15c7453b86830d9">radline_end</a>, <a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>;
<a name="l01460"></a><a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">01460</a>     <span class="keywordtype">float</span> <a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[3], <a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>[3], <a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[3];
<a name="l01461"></a>01461 } <a class="code" href="../../d0/de2/shadbuf_8c.html#a92df6046bb9113de36250447bd2cefa7">BSPFace</a>;
<a name="l01462"></a>01462 
<a name="l01463"></a>01463 <span class="comment">/* boxes are in lamp projection */</span>
<a name="l01464"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a1c4e0f6415764831e32f087917c4cace">01464</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a1c4e0f6415764831e32f087917c4cace">init_box</a>(<a class="code" href="../../d9/d84/structBoxf.html">Boxf</a> *box)
<a name="l01465"></a>01465 {
<a name="l01466"></a>01466     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = 1000000.0f;
<a name="l01467"></a>01467     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> = 0;
<a name="l01468"></a>01468     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = 1000000.0f;
<a name="l01469"></a>01469     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> = 0;
<a name="l01470"></a>01470     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a>= 0x7FFFFFFF;
<a name="l01471"></a>01471     box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a92e375ea5a0d58ec8c604e254d77d969">zmax</a>= - 0x7FFFFFFF;
<a name="l01472"></a>01472 }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474 <span class="comment">/* use v1 to calculate boundbox */</span>
<a name="l01475"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">01475</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(<a class="code" href="../../d9/d84/structBoxf.html">Boxf</a> *box, <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3])
<a name="l01476"></a>01476 {
<a name="l01477"></a>01477     <span class="keywordflow">if</span> (v1[0] &lt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = v1[0];
<a name="l01478"></a>01478     <span class="keywordflow">if</span> (v1[0] &gt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> = v1[0];
<a name="l01479"></a>01479     <span class="keywordflow">if</span> (v1[1] &lt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = v1[1];
<a name="l01480"></a>01480     <span class="keywordflow">if</span> (v1[1] &gt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> = v1[1];
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (v1[2] &lt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a>= v1[2];
<a name="l01482"></a>01482     <span class="keywordflow">if</span> (v1[2] &gt; box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a92e375ea5a0d58ec8c604e254d77d969">zmax</a>) box-&gt;<a class="code" href="../../d9/d84/structBoxf.html#a92e375ea5a0d58ec8c604e254d77d969">zmax</a>= v1[2];
<a name="l01483"></a>01483 }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485 <span class="comment">/* use v1 to calculate boundbox */</span>
<a name="l01486"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">01486</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">bound_rectf</a>(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *box, <span class="keyword">const</span> <span class="keywordtype">float</span> v1[2])
<a name="l01487"></a>01487 {
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (v1[0] &lt; box-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>) box-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a> = v1[0];
<a name="l01489"></a>01489     <span class="keywordflow">if</span> (v1[0] &gt; box-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>) box-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a> = v1[0];
<a name="l01490"></a>01490     <span class="keywordflow">if</span> (v1[1] &lt; box-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>) box-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a> = v1[1];
<a name="l01491"></a>01491     <span class="keywordflow">if</span> (v1[1] &gt; box-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>) box-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a> = v1[1];
<a name="l01492"></a>01492 }
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 <span class="comment">/* halfway splitting, for initializing a more regular tree */</span>
<a name="l01496"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">01496</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">isb_bsp_split_init</a>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *mem, <span class="keywordtype">int</span> level)
<a name="l01497"></a>01497 {
<a name="l01498"></a>01498     
<a name="l01499"></a>01499     <span class="comment">/* if level &gt; 0 we create new branches and go deeper*/</span>
<a name="l01500"></a>01500     <span class="keywordflow">if</span> (level &gt; 0) {
<a name="l01501"></a>01501         <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *<a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, *right;
<a name="l01502"></a>01502         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01503"></a>01503         
<a name="l01504"></a>01504         <span class="comment">/* splitpoint */</span>
<a name="l01505"></a>01505         root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0]= 0.5f*(root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a>+root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a>);
<a name="l01506"></a>01506         root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1]= 0.5f*(root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a>+root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a>);
<a name="l01507"></a>01507         
<a name="l01508"></a>01508         <span class="comment">/* find best splitpoint */</span>
<a name="l01509"></a>01509         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a>-root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> &gt; root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a>-root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a>)
<a name="l01510"></a>01510             i= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>= 0;
<a name="l01511"></a>01511         <span class="keywordflow">else</span>
<a name="l01512"></a>01512             i= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>= 1;
<a name="l01513"></a>01513         
<a name="l01514"></a>01514         left= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l01515"></a>01515         right= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l01516"></a>01516         
<a name="l01517"></a>01517         <span class="comment">/* box info */</span>
<a name="l01518"></a>01518         left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>;
<a name="l01519"></a>01519         right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>;
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (i==0) {
<a name="l01521"></a>01521             left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0];
<a name="l01522"></a>01522             right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0];
<a name="l01523"></a>01523         }
<a name="l01524"></a>01524         <span class="keywordflow">else</span> {
<a name="l01525"></a>01525             left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1];
<a name="l01526"></a>01526             right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1];
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528         <a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">isb_bsp_split_init</a>(left, mem, level-1);
<a name="l01529"></a>01529         <a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">isb_bsp_split_init</a>(right, mem, level-1);
<a name="l01530"></a>01530     }
<a name="l01531"></a>01531     <span class="keywordflow">else</span> {
<a name="l01532"></a>01532         <span class="comment">/* we add sample array */</span>
<a name="l01533"></a>01533         root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l01534"></a>01534     }
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537 <span class="comment">/* note; if all samples on same location we just spread them over 2 new branches */</span>
<a name="l01538"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a862909db83c96b6d68f91499ddc1af87">01538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a862909db83c96b6d68f91499ddc1af87">isb_bsp_split</a>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *mem)
<a name="l01539"></a>01539 {
<a name="l01540"></a>01540     <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *<a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, *right;
<a name="l01541"></a>01541     <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *samples[<a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>];
<a name="l01542"></a>01542     <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01543"></a>01543 
<a name="l01544"></a>01544     <span class="comment">/* splitpoint */</span>
<a name="l01545"></a>01545     root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0]= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1]= 0.0f;
<a name="l01546"></a>01546     <span class="keywordflow">for</span> (a=<a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>-1; a&gt;=0; a--) {
<a name="l01547"></a>01547         root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0]+= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a]-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[0];
<a name="l01548"></a>01548         root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1]+= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a]-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[1];
<a name="l01549"></a>01549     }
<a name="l01550"></a>01550     root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0]/= <a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>;
<a name="l01551"></a>01551     root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1]/= <a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>;
<a name="l01552"></a>01552     
<a name="l01553"></a>01553     <span class="comment">/* find best splitpoint */</span>
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a>-root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> &gt; root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a>-root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a>)
<a name="l01555"></a>01555         i= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>= 0;
<a name="l01556"></a>01556     <span class="keywordflow">else</span>
<a name="l01557"></a>01557         i= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>= 1;
<a name="l01558"></a>01558     
<a name="l01559"></a>01559     <span class="comment">/* new branches */</span>
<a name="l01560"></a>01560     left= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l01561"></a>01561     right= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l01562"></a>01562 
<a name="l01563"></a>01563     <span class="comment">/* new sample array */</span>
<a name="l01564"></a>01564     left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *));
<a name="l01565"></a>01565     right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>= samples; <span class="comment">// tmp</span>
<a name="l01566"></a>01566     
<a name="l01567"></a>01567     <span class="comment">/* split samples */</span>
<a name="l01568"></a>01568     <span class="keywordflow">for</span> (a=<a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>-1; a&gt;=0; a--) {
<a name="l01569"></a>01569         <span class="keywordtype">int</span> comp= 0;
<a name="l01570"></a>01570         <span class="comment">/* this prevents adding samples all to 1 branch when divider is equal to samples */</span>
<a name="l01571"></a>01571         <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a]-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[i] == root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[i])
<a name="l01572"></a>01572             comp= a &amp; 1;
<a name="l01573"></a>01573         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a]-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[i] &lt; root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[i])
<a name="l01574"></a>01574             comp= 1;
<a name="l01575"></a>01575         
<a name="l01576"></a>01576         <span class="keywordflow">if</span> (comp==1) {
<a name="l01577"></a>01577             left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>]= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a];
<a name="l01578"></a>01578             left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>++;
<a name="l01579"></a>01579         }
<a name="l01580"></a>01580         <span class="keywordflow">else</span> {
<a name="l01581"></a>01581             right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>]= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a];
<a name="l01582"></a>01582             right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>++;
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584     }
<a name="l01585"></a>01585     
<a name="l01586"></a>01586     <span class="comment">/* copy samples from tmp */</span>
<a name="l01587"></a>01587     memcpy(root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>, samples, right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>*(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *)));
<a name="l01588"></a>01588     right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>;
<a name="l01589"></a>01589     root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01590"></a>01590     
<a name="l01591"></a>01591     <span class="comment">/* box info */</span>
<a name="l01592"></a>01592     left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>;
<a name="l01593"></a>01593     right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>= root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>;
<a name="l01594"></a>01594     <span class="keywordflow">if</span> (i==0) {
<a name="l01595"></a>01595         left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0];
<a name="l01596"></a>01596         right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0];
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598     <span class="keywordflow">else</span> {
<a name="l01599"></a>01599         left-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1];
<a name="l01600"></a>01600         right-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1];
<a name="l01601"></a>01601     }
<a name="l01602"></a>01602 }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 <span class="comment">/* inserts sample in main tree, also splits on threshold */</span>
<a name="l01605"></a>01605 <span class="comment">/* returns 1 if error */</span>
<a name="l01606"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a6ec54820d738c24927558640a0c4cf65">01606</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a6ec54820d738c24927558640a0c4cf65">isb_bsp_insert</a>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena, <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *sample)
<a name="l01607"></a>01607 {
<a name="l01608"></a>01608     <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *bspn= root;
<a name="l01609"></a>01609     <span class="keywordtype">float</span> *zco= sample-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>;
<a name="l01610"></a>01610     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>= 0;
<a name="l01611"></a>01611     
<a name="l01612"></a>01612     <span class="comment">/* debug counter, also used to check if something was filled in ever */</span>
<a name="l01613"></a>01613     root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>++;
<a name="l01614"></a>01614     
<a name="l01615"></a>01615     <span class="comment">/* going over branches until last one found */</span>
<a name="l01616"></a>01616     <span class="keywordflow">while</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>) {
<a name="l01617"></a>01617         <span class="keywordflow">if</span> (zco[bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>] &lt;= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>])
<a name="l01618"></a>01618             bspn= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>;
<a name="l01619"></a>01619         <span class="keywordflow">else</span>
<a name="l01620"></a>01620             bspn= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>;
<a name="l01621"></a>01621         i++;
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623     <span class="comment">/* bspn now is the last branch */</span>
<a name="l01624"></a>01624     
<a name="l01625"></a>01625     <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>==<a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>) {
<a name="l01626"></a>01626         printf(<span class="stringliteral">&quot;error in bsp branch\n&quot;</span>);    <span class="comment">/* only for debug, cannot happen */</span>
<a name="l01627"></a>01627         <span class="keywordflow">return</span> 1;
<a name="l01628"></a>01628     }
<a name="l01629"></a>01629     
<a name="l01630"></a>01630     <span class="comment">/* insert */</span>
<a name="l01631"></a>01631     bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>]= sample;
<a name="l01632"></a>01632     bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>++;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634     <span class="comment">/* split if allowed and needed */</span>
<a name="l01635"></a>01635     <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>==<a class="code" href="../../d0/de2/shadbuf_8c.html#aa1519beab4d1f39fce4dba4ef9e5d39f">BSPMAX_SAMPLE</a>) {
<a name="l01636"></a>01636         <span class="keywordflow">if</span> (i==<a class="code" href="../../d0/de2/shadbuf_8c.html#a5f2f14d6308c85fef237a5f907c14f8f">BSPMAX_DEPTH</a>) {
<a name="l01637"></a>01637             bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>--;    <span class="comment">/* stop filling in... will give errors */</span>
<a name="l01638"></a>01638             <span class="keywordflow">return</span> 1;
<a name="l01639"></a>01639         }
<a name="l01640"></a>01640         <a class="code" href="../../d0/de2/shadbuf_8c.html#a862909db83c96b6d68f91499ddc1af87">isb_bsp_split</a>(bspn, memarena);
<a name="l01641"></a>01641     }
<a name="l01642"></a>01642     <span class="keywordflow">return</span> 0;
<a name="l01643"></a>01643 }
<a name="l01644"></a>01644 
<a name="l01645"></a>01645 <span class="comment">/* initialize vars in face, for optimal point-in-face test */</span>
<a name="l01646"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a9ce484b3511a23e3bd443469d102e1e0">01646</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a9ce484b3511a23e3bd443469d102e1e0">bspface_init_strand</a>(<a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> *face) 
<a name="l01647"></a>01647 {
<a name="l01648"></a>01648     
<a name="l01649"></a>01649     face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ad1e714ae6be7dca381510e4fe5d7d7ad">radline</a>= 0.5f* <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>);
<a name="l01650"></a>01650     
<a name="l01651"></a>01651     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>);
<a name="l01652"></a>01652     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>)
<a name="l01653"></a>01653         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>);
<a name="l01654"></a>01654     <span class="keywordflow">else</span>
<a name="l01655"></a>01655         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>);
<a name="l01656"></a>01656     
<a name="l01657"></a>01657     face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[0]= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>[0]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[0];
<a name="l01658"></a>01658     face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[1]= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>[1]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[1];
<a name="l01659"></a>01659     face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[2]= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#af039add9324641f83c2e7d2cba8d6043">vec2</a>[2]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[2];
<a name="l01660"></a>01660     
<a name="l01661"></a>01661     face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[0]*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[0]+ face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[1]*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[1];
<a name="l01662"></a>01662     
<a name="l01663"></a>01663     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>!=0.0f) {
<a name="l01664"></a>01664         face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab7abcadb96d4f114d15c7453b86830d9">radline_end</a>= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ad1e714ae6be7dca381510e4fe5d7d7ad">radline</a>/<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>);
<a name="l01665"></a>01665         face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>= 1.0f/face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>;
<a name="l01666"></a>01666     }
<a name="l01667"></a>01667 }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 <span class="comment">/* brought back to a simple 2d case */</span>
<a name="l01670"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aa06b265e5c34b8f1a7b09b45c909c1cf">01670</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#aa06b265e5c34b8f1a7b09b45c909c1cf">point_behind_strand</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> *face)
<a name="l01671"></a>01671 {
<a name="l01672"></a>01672     <span class="comment">/* v1 - v2 is radius, v1 - v3 length */</span>
<a name="l01673"></a>01673     <span class="keywordtype">float</span> dist, rc[2], pt[2];
<a name="l01674"></a>01674     
<a name="l01675"></a>01675     <span class="comment">/* using code from dist_to_line_segment_v2(), distance vec to line-piece */</span>
<a name="l01676"></a>01676 
<a name="l01677"></a>01677     <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>==0.0f) {
<a name="l01678"></a>01678         rc[0]= p[0]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[0];
<a name="l01679"></a>01679         rc[1]= p[1]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[1];
<a name="l01680"></a>01680         dist= (float)(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(rc[0]*rc[0]+ rc[1]*rc[1]));
<a name="l01681"></a>01681         
<a name="l01682"></a>01682         <span class="keywordflow">if</span> (dist &lt; face-&gt;radline)
<a name="l01683"></a>01683             <span class="keywordflow">return</span> 1;
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685     <span class="keywordflow">else</span> {
<a name="l01686"></a>01686         <span class="keywordtype">float</span> labda= ( face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[0]*(p[0]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[0]) + face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[1]*(p[1]-face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[1]) )*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab67a2b60e4698c805d800210b271ed08">len</a>;
<a name="l01687"></a>01687         
<a name="l01688"></a>01688         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (labda &gt; -face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#ab7abcadb96d4f114d15c7453b86830d9">radline_end</a> &amp;&amp; labda &lt; 1.0f+face-&gt;radline_end) {
<a name="l01689"></a>01689             <span class="comment">/* hesse for dist: */</span>
<a name="l01690"></a>01690             <span class="comment">//dist= (float)(fabs( (p[0]-vec2[0])*rc[1] + (p[1]-vec2[1])*rc[0])/len);</span>
<a name="l01691"></a>01691             
<a name="l01692"></a>01692             pt[0]= labda*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[0]+face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[0];
<a name="l01693"></a>01693             pt[1]= labda*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[1]+face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[1];
<a name="l01694"></a>01694             
<a name="l01695"></a>01695             rc[0]= pt[0]-p[0];
<a name="l01696"></a>01696             rc[1]= pt[1]-p[1];
<a name="l01697"></a>01697             dist= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(rc[0]*rc[0]+ rc[1]*rc[1]);
<a name="l01698"></a>01698             
<a name="l01699"></a>01699             <span class="keywordflow">if</span> (dist &lt; face-&gt;radline) {
<a name="l01700"></a>01700                 <span class="keywordtype">float</span> zval= face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a770f56dc8cd46ff2e5d19b7ead3e75d6">vec1</a>[2] + labda*face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1bccb00ee7d6f0f7a55e453b71a5340e">rc</a>[2];
<a name="l01701"></a>01701                 <span class="keywordflow">if</span> (p[2] &gt; zval)
<a name="l01702"></a>01702                     <span class="keywordflow">return</span> 1;
<a name="l01703"></a>01703             }
<a name="l01704"></a>01704         }
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706     <span class="keywordflow">return</span> 0;
<a name="l01707"></a>01707 }
<a name="l01708"></a>01708 
<a name="l01709"></a>01709 
<a name="l01710"></a>01710 <span class="comment">/* return 1 if inside. code derived from src/parametrizer.c */</span>
<a name="l01711"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#aa472bc73884f2cebd2f6fda41b912a0d">01711</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#aa472bc73884f2cebd2f6fda41b912a0d">point_behind_tria2d</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01712"></a>01712 {
<a name="l01713"></a>01713     <span class="keywordtype">float</span> a[2], c[2], h[2], <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l01714"></a>01714     <span class="keywordtype">float</span> u, v;
<a name="l01715"></a>01715     
<a name="l01716"></a>01716     a[0] = v2[0] - v1[0];
<a name="l01717"></a>01717     a[1] = v2[1] - v1[1];
<a name="l01718"></a>01718     c[0] = v3[0] - v1[0];
<a name="l01719"></a>01719     c[1] = v3[1] - v1[1];
<a name="l01720"></a>01720     
<a name="l01721"></a>01721     div = a[0]*c[1] - a[1]*c[0];
<a name="l01722"></a>01722     <span class="keywordflow">if</span> (div==0.0f)
<a name="l01723"></a>01723         <span class="keywordflow">return</span> 0;
<a name="l01724"></a>01724     
<a name="l01725"></a>01725     h[0] = p[0] - v1[0];
<a name="l01726"></a>01726     h[1] = p[1] - v1[1];
<a name="l01727"></a>01727     
<a name="l01728"></a>01728     div = 1.0f/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l01729"></a>01729     
<a name="l01730"></a>01730     u = (h[0]*c[1] - h[1]*c[0])*div;
<a name="l01731"></a>01731     <span class="keywordflow">if</span> (u &gt;= 0.0f) {
<a name="l01732"></a>01732         v = (a[0]*h[1] - a[1]*h[0])*div;
<a name="l01733"></a>01733         <span class="keywordflow">if</span> (v &gt;= 0.0f) {
<a name="l01734"></a>01734             <span class="keywordflow">if</span> ( u + v &lt;= 1.0f) {
<a name="l01735"></a>01735                 <span class="comment">/* inside, now check if point p is behind */</span>
<a name="l01736"></a>01736                 <span class="keywordtype">float</span> z=  (1.0f-u-v)*v1[2] + u*v2[2] + v*v3[2];
<a name="l01737"></a>01737                 <span class="keywordflow">if</span> (z &lt;= p[2])
<a name="l01738"></a>01738                     <span class="keywordflow">return</span> 1;
<a name="l01739"></a>01739             }
<a name="l01740"></a>01740         }
<a name="l01741"></a>01741     }
<a name="l01742"></a>01742     
<a name="l01743"></a>01743     <span class="keywordflow">return</span> 0;
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a>01746 <span class="preprocessor">#if 0</span>
<a name="l01747"></a>01747 <span class="preprocessor"></span><span class="comment">/* tested these calls, but it gives inaccuracy, &#39;side&#39; cannot be found reliably using v3 */</span>
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 <span class="comment">/* check if line v1-v2 has all rect points on other side of point v3 */</span>
<a name="l01750"></a>01750 <span class="keyword">static</span> <span class="keywordtype">int</span> rect_outside_line(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *rect, <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01751"></a>01751 {
<a name="l01752"></a>01752     <span class="keywordtype">float</span> a, b, c;
<a name="l01753"></a>01753     <span class="keywordtype">int</span> side;
<a name="l01754"></a>01754     
<a name="l01755"></a>01755     <span class="comment">/* line formula for v1-v2 */</span>
<a name="l01756"></a>01756     a= v2[1]-v1[1];
<a name="l01757"></a>01757     b= v1[0]-v2[0];
<a name="l01758"></a>01758     c= -a*v1[0] - b*v1[1];
<a name="l01759"></a>01759     side= a*v3[0] + b*v3[1] + c &lt; 0.0f;
<a name="l01760"></a>01760     
<a name="l01761"></a>01761     <span class="comment">/* the four quad points */</span>
<a name="l01762"></a>01762     <span class="keywordflow">if</span> ( side==(rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>*a + rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>*b + c &gt;= 0.0f) )
<a name="l01763"></a>01763         <span class="keywordflow">if</span> ( side==(rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>*a + rect-&gt;<a class="code" href="../../da/d10/structrctf.html#aeea1ce7886a81f1099e897d587012013">ymin</a>*b + c &gt;= 0.0f) )
<a name="l01764"></a>01764             <span class="keywordflow">if</span> ( side==(rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a76a664abf5a6971d8cc82d85c31a1178">xmax</a>*a + rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>*b + c &gt;= 0.0f) )
<a name="l01765"></a>01765                 <span class="keywordflow">if</span> ( side==(rect-&gt;<a class="code" href="../../da/d10/structrctf.html#a9d7813796d160db4cdb7b9c749a8901d">xmin</a>*a + rect-&gt;<a class="code" href="../../da/d10/structrctf.html#ab8c08095a5b34878ced13a9b3026b74f">ymax</a>*b + c &gt;= 0.0f) )
<a name="l01766"></a>01766                     <span class="keywordflow">return</span> 1;
<a name="l01767"></a>01767     <span class="keywordflow">return</span> 0;
<a name="l01768"></a>01768 }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="comment">/* check if one of the triangle edges separates all rect points on 1 side */</span>
<a name="l01771"></a>01771 <span class="keyword">static</span> <span class="keywordtype">int</span> rect_isect_tria(<a class="code" href="../../da/d10/structrctf.html">rctf</a> *rect, <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01772"></a>01772 {
<a name="l01773"></a>01773     <span class="keywordflow">if</span> (rect_outside_line(rect, v1, v2, v3))
<a name="l01774"></a>01774         <span class="keywordflow">return</span> 0;
<a name="l01775"></a>01775     <span class="keywordflow">if</span> (rect_outside_line(rect, v2, v3, v1))
<a name="l01776"></a>01776         <span class="keywordflow">return</span> 0;
<a name="l01777"></a>01777     <span class="keywordflow">if</span> (rect_outside_line(rect, v3, v1, v2))
<a name="l01778"></a>01778         <span class="keywordflow">return</span> 0;
<a name="l01779"></a>01779     <span class="keywordflow">return</span> 1;
<a name="l01780"></a>01780 }
<a name="l01781"></a>01781 <span class="preprocessor">#endif</span>
<a name="l01782"></a>01782 <span class="preprocessor"></span>
<a name="l01783"></a>01783 <span class="comment">/* if face overlaps a branch, it executes func. recursive */</span>
<a name="l01784"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">01784</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *bspn, <a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> *face)
<a name="l01785"></a>01785 {
<a name="l01786"></a>01786     
<a name="l01787"></a>01787     <span class="comment">/* are we descending? */</span>
<a name="l01788"></a>01788     <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>) {
<a name="l01789"></a>01789         <span class="comment">/* hrmf, the box struct cannot be addressed with index */</span>
<a name="l01790"></a>01790         <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a23e7f98a2740ce57221e41ec4e0c0f89">index</a>==0) {
<a name="l01791"></a>01791             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> &lt;= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0])
<a name="l01792"></a>01792                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>(bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>, face);
<a name="l01793"></a>01793             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> &gt; bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[0])
<a name="l01794"></a>01794                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>(bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>, face);
<a name="l01795"></a>01795         }
<a name="l01796"></a>01796         <span class="keywordflow">else</span> {
<a name="l01797"></a>01797             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> &lt;= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1])
<a name="l01798"></a>01798                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>(bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>, face);
<a name="l01799"></a>01799             <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> &gt; bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a7fbbd00608596d4a222032a4c26a1079">divider</a>[1])
<a name="l01800"></a>01800                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>(bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>, face);
<a name="l01801"></a>01801         }
<a name="l01802"></a>01802     }
<a name="l01803"></a>01803     <span class="keywordflow">else</span> {
<a name="l01804"></a>01804         <span class="comment">/* else: end branch reached */</span>
<a name="l01805"></a>01805         <span class="keywordtype">int</span> a;
<a name="l01806"></a>01806         
<a name="l01807"></a>01807         <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>==0) <span class="keywordflow">return</span>;
<a name="l01808"></a>01808         
<a name="l01809"></a>01809         <span class="comment">/* check for nodes entirely in shadow, can be skipped */</span>
<a name="l01810"></a>01810         <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>==bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#adcefdfdd994f8b65cb29a321122ed14e">full</a>)
<a name="l01811"></a>01811             <span class="keywordflow">return</span>;
<a name="l01812"></a>01812         
<a name="l01813"></a>01813         <span class="comment">/* if bsp node is entirely in front of face, give up */</span>
<a name="l01814"></a>01814         <span class="keywordflow">if</span> (bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a92e375ea5a0d58ec8c604e254d77d969">zmax</a> &lt; face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a>)
<a name="l01815"></a>01815             <span class="keywordflow">return</span>;
<a name="l01816"></a>01816         
<a name="l01817"></a>01817         <span class="comment">/* if face boundbox is outside of branch rect, give up */</span>
<a name="l01818"></a>01818         <span class="keywordflow">if</span> (0==<a class="code" href="../../d5/d44/BLI__rect_8h.html#a0d49c0e9c2375707f05bbc7b00c857dd">BLI_isect_rctf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, (<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l01819"></a>01819             <span class="keywordflow">return</span>;
<a name="l01820"></a>01820         
<a name="l01821"></a>01821         <span class="comment">/* test all points inside branch */</span>
<a name="l01822"></a>01822         <span class="keywordflow">for</span> (a=bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>-1; a&gt;=0; a--) {
<a name="l01823"></a>01823             <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *samp= bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a];
<a name="l01824"></a>01824             
<a name="l01825"></a>01825             <span class="keywordflow">if</span> ((samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a8efe32eb55d3b43887a2165d646c8558">facenr</a>!=face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#aa57e0629644ed99a829b811804b9f97e">facenr</a> || samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a89de5ebd4b44c8e0c3256935b0d70755">obi</a>!=face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a8fcf699604e04790a04e16739ae1e80c">obi</a>) &amp;&amp; samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>) {
<a name="l01826"></a>01826                 <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#aa80e2e21d851f9ab441c17a537a29d89">zmin</a> &lt; samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[2]) {
<a name="l01827"></a>01827                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d44/BLI__rect_8h.html#a6601514c8df73c1e060cb2b3f4887b09">BLI_in_rctf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[0], samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>[1])) {
<a name="l01828"></a>01828                         <span class="keywordtype">int</span> inshadow= 0;
<a name="l01829"></a>01829                         
<a name="l01830"></a>01830                         <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a27af46ac5f9a142610601ef6b43b176a">type</a>) {
<a name="l01831"></a>01831                             <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#aa06b265e5c34b8f1a7b09b45c909c1cf">point_behind_strand</a>(samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>, face))
<a name="l01832"></a>01832                                 inshadow= 1;
<a name="l01833"></a>01833                         }
<a name="l01834"></a>01834                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d0/de2/shadbuf_8c.html#aa472bc73884f2cebd2f6fda41b912a0d">point_behind_tria2d</a>(samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>))
<a name="l01835"></a>01835                             inshadow= 1;
<a name="l01836"></a>01836                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a> &amp;&amp; <a class="code" href="../../d0/de2/shadbuf_8c.html#aa472bc73884f2cebd2f6fda41b912a0d">point_behind_tria2d</a>(samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>, face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>))
<a name="l01837"></a>01837                             inshadow= 1;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839                         <span class="keywordflow">if</span> (inshadow) {
<a name="l01840"></a>01840                             *(samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>) += face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>;
<a name="l01841"></a>01841                             <span class="comment">/* optimize; is_full means shad_alpha==4096 */</span>
<a name="l01842"></a>01842                             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (*(samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>) &gt;= 4096 || face-&gt;<a class="code" href="../../dc/d7b/structBSPFace.html#a033d17075b6913e69afbd8ee469669ef">is_full</a>) {
<a name="l01843"></a>01843                                 bspn-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#adcefdfdd994f8b65cb29a321122ed14e">full</a>++;
<a name="l01844"></a>01844                                 samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01845"></a>01845                             }
<a name="l01846"></a>01846                         }
<a name="l01847"></a>01847                     }
<a name="l01848"></a>01848                 }
<a name="l01849"></a>01849             }
<a name="l01850"></a>01850         }
<a name="l01851"></a>01851     }
<a name="l01852"></a>01852 }
<a name="l01853"></a>01853 
<a name="l01854"></a>01854 <span class="comment">/* based on available samples, recalculate the bounding box for bsp nodes, recursive */</span>
<a name="l01855"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a7002fa4b17c45d554187b6e3bf1c715c">01855</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a7002fa4b17c45d554187b6e3bf1c715c">isb_bsp_recalc_box</a>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root)
<a name="l01856"></a>01856 {
<a name="l01857"></a>01857     <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>) {
<a name="l01858"></a>01858         <a class="code" href="../../d0/de2/shadbuf_8c.html#a7002fa4b17c45d554187b6e3bf1c715c">isb_bsp_recalc_box</a>(root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a752cf681dd67e1d12f59cae69cd285d4">left</a>);
<a name="l01859"></a>01859         <a class="code" href="../../d0/de2/shadbuf_8c.html#a7002fa4b17c45d554187b6e3bf1c715c">isb_bsp_recalc_box</a>(root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a296447f51a936c2f89a501e35691f520">right</a>);
<a name="l01860"></a>01860     }
<a name="l01861"></a>01861     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>) {
<a name="l01862"></a>01862         <span class="keywordtype">int</span> a;
<a name="l01863"></a>01863         
<a name="l01864"></a>01864         <a class="code" href="../../d0/de2/shadbuf_8c.html#a1c4e0f6415764831e32f087917c4cace">init_box</a>(&amp;root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>);
<a name="l01865"></a>01865         <span class="keywordflow">for</span> (a=root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a112085dc2f35e0a9553a3d69eb9b119d">totsamp</a>-1; a&gt;=0; a--)
<a name="l01866"></a>01866             <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a114a5a0a42bbfb57edf60999fac83c7c">samples</a>[a]-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>);
<a name="l01867"></a>01867     }   
<a name="l01868"></a>01868 }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870 <span class="comment">/* callback function for zbuf clip */</span>
<a name="l01871"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a43e9bbd8bc96f0cb6924eea6f8bc9ebf">01871</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a43e9bbd8bc96f0cb6924eea6f8bc9ebf">isb_bsp_test_strand</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4)
<a name="l01872"></a>01872 {
<a name="l01873"></a>01873     <a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> face;
<a name="l01874"></a>01874     
<a name="l01875"></a>01875     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>= v1;
<a name="l01876"></a>01876     face.<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>= v2;
<a name="l01877"></a>01877     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>= v3;
<a name="l01878"></a>01878     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>= v4;
<a name="l01879"></a>01879     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a8fcf699604e04790a04e16739ae1e80c">obi</a>= obi;
<a name="l01880"></a>01880     face.<a class="code" href="../../dc/d7b/structBSPFace.html#aa57e0629644ed99a829b811804b9f97e">facenr</a>= zvlnr &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l01881"></a>01881     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a27af46ac5f9a142610601ef6b43b176a">type</a>= <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>;
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l01883"></a>01883         face.<a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>= (short)ceil(4096.0f*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>/(<span class="keywordtype">float</span>)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa);
<a name="l01884"></a>01884     <span class="keywordflow">else</span>
<a name="l01885"></a>01885         face.<a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>= (short)ceil(4096.0f*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>);
<a name="l01886"></a>01886     
<a name="l01887"></a>01887     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a033d17075b6913e69afbd8ee469669ef">is_full</a>= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>==1.0f);
<a name="l01888"></a>01888     
<a name="l01889"></a>01889     <span class="comment">/* setup boundbox */</span>
<a name="l01890"></a>01890     <a class="code" href="../../d0/de2/shadbuf_8c.html#a1c4e0f6415764831e32f087917c4cace">init_box</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>);
<a name="l01891"></a>01891     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v1);
<a name="l01892"></a>01892     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v2);
<a name="l01893"></a>01893     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v3);
<a name="l01894"></a>01894     <span class="keywordflow">if</span> (v4)
<a name="l01895"></a>01895         <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v4);
<a name="l01896"></a>01896     
<a name="l01897"></a>01897     <span class="comment">/* optimize values */</span>
<a name="l01898"></a>01898     <a class="code" href="../../d0/de2/shadbuf_8c.html#a9ce484b3511a23e3bd443469d102e1e0">bspface_init_strand</a>(&amp;face);
<a name="l01899"></a>01899     
<a name="l01900"></a>01900     <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>((<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *)zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>, &amp;face);
<a name="l01901"></a>01901     
<a name="l01902"></a>01902 }
<a name="l01903"></a>01903 
<a name="l01904"></a>01904 <span class="comment">/* callback function for zbuf clip */</span>
<a name="l01905"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a104d36ceb11a6495cad0c921c6ad9273">01905</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a104d36ceb11a6495cad0c921c6ad9273">isb_bsp_test_face</a>(<a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> *zspan, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> zvlnr, <span class="keywordtype">float</span> *v1, <span class="keywordtype">float</span> *v2, <span class="keywordtype">float</span> *v3, <span class="keywordtype">float</span> *v4) 
<a name="l01906"></a>01906 {
<a name="l01907"></a>01907     <a class="code" href="../../dc/d7b/structBSPFace.html">BSPFace</a> face;
<a name="l01908"></a>01908     
<a name="l01909"></a>01909     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a1278af672e4e35fa6ae83d10b7a283be">v1</a>= v1;
<a name="l01910"></a>01910     face.<a class="code" href="../../dc/d7b/structBSPFace.html#afa7f206b3692ac587d598dd05fd8df53">v2</a>= v2;
<a name="l01911"></a>01911     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a7ddc0fc5536d5e2470fa54a8131434ff">v3</a>= v3;
<a name="l01912"></a>01912     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a8304ff14cc62eb69583df292a065047e">v4</a>= v4;
<a name="l01913"></a>01913     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a8fcf699604e04790a04e16739ae1e80c">obi</a>= obi;
<a name="l01914"></a>01914     face.<a class="code" href="../../dc/d7b/structBSPFace.html#aa57e0629644ed99a829b811804b9f97e">facenr</a>= zvlnr &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l01915"></a>01915     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a27af46ac5f9a142610601ef6b43b176a">type</a>= 0;
<a name="l01916"></a>01916     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l01917"></a>01917         face.<a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>= (short)ceil(4096.0f*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>/(<span class="keywordtype">float</span>)<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa);
<a name="l01918"></a>01918     <span class="keywordflow">else</span>
<a name="l01919"></a>01919         face.<a class="code" href="../../dc/d7b/structBSPFace.html#a616d7beee5e6b1513db9de4170276edd">shad_alpha</a>= (short)ceil(4096.0f*zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>);
<a name="l01920"></a>01920     
<a name="l01921"></a>01921     face.<a class="code" href="../../dc/d7b/structBSPFace.html#a033d17075b6913e69afbd8ee469669ef">is_full</a>= (zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>==1.0f);
<a name="l01922"></a>01922     
<a name="l01923"></a>01923     <span class="comment">/* setup boundbox */</span>
<a name="l01924"></a>01924     <a class="code" href="../../d0/de2/shadbuf_8c.html#a1c4e0f6415764831e32f087917c4cace">init_box</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>);
<a name="l01925"></a>01925     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v1);
<a name="l01926"></a>01926     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v2);
<a name="l01927"></a>01927     <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v3);
<a name="l01928"></a>01928     <span class="keywordflow">if</span> (v4)
<a name="l01929"></a>01929         <a class="code" href="../../d0/de2/shadbuf_8c.html#a847bcac44f279c31c2a02c2139e97723">bound_boxf</a>(&amp;face.<a class="code" href="../../dc/d7b/structBSPFace.html#a75d44f2960bd52b372de6e33149ae127">box</a>, v4);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931     <a class="code" href="../../d0/de2/shadbuf_8c.html#a1213e25a0da88b0ae1752decb22a60bf">isb_bsp_face_inside</a>((<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *)zspan-&gt;<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>, &amp;face);
<a name="l01932"></a>01932 }
<a name="l01933"></a>01933 
<a name="l01934"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">01934</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">testclip_minmax</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> ho[4], <span class="keyword">const</span> <span class="keywordtype">float</span> minmax[4])
<a name="l01935"></a>01935 {
<a name="l01936"></a>01936     <span class="keywordtype">float</span> wco= ho[3];
<a name="l01937"></a>01937     <span class="keywordtype">int</span> flag= 0;
<a name="l01938"></a>01938     
<a name="l01939"></a>01939     <span class="keywordflow">if</span> ( ho[0] &gt; minmax[1]*wco) flag = 1;
<a name="l01940"></a>01940     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ho[0]&lt; minmax[0]*wco) flag = 2;
<a name="l01941"></a>01941     
<a name="l01942"></a>01942     <span class="keywordflow">if</span> ( ho[1] &gt; minmax[3]*wco) flag |= 4;
<a name="l01943"></a>01943     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ho[1]&lt; minmax[2]*wco) flag |= 8;
<a name="l01944"></a>01944     
<a name="l01945"></a>01945     <span class="keywordflow">return</span> flag;
<a name="l01946"></a>01946 }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948 <span class="comment">/* main loop going over all faces and check in bsp overlaps, fill in shadfac values */</span>
<a name="l01949"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#afdcf7c01a2d1503c35e5cb6ed43ae3cb">01949</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#afdcf7c01a2d1503c35e5cb6ed43ae3cb">isb_bsp_fillfaces</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root)
<a name="l01950"></a>01950 {
<a name="l01951"></a>01951     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l01952"></a>01952     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l01953"></a>01953     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l01954"></a>01954     <a class="code" href="../../d2/d95/structZSpan.html">ZSpan</a> zspan, zspanstrand;
<a name="l01955"></a>01955     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01956"></a>01956     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *ma= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01957"></a>01957     <span class="keywordtype">float</span> minmaxf[4], winmat[4][4];
<a name="l01958"></a>01958     <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l01959"></a>01959     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, a, ok=1, lay= -1;
<a name="l01960"></a>01960     
<a name="l01961"></a>01961     <span class="comment">/* further optimize, also sets minz maxz */</span>
<a name="l01962"></a>01962     <a class="code" href="../../d0/de2/shadbuf_8c.html#a7002fa4b17c45d554187b6e3bf1c715c">isb_bsp_recalc_box</a>(root);
<a name="l01963"></a>01963     
<a name="l01964"></a>01964     <span class="comment">/* extra clipping for minmax */</span>
<a name="l01965"></a>01965     minmaxf[0]= (2.0f*root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> - size-2.0f)/size;
<a name="l01966"></a>01966     minmaxf[1]= (2.0f*root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#a9e00717c6cda2f01106220301980c099">xmax</a> - size+2.0f)/size;
<a name="l01967"></a>01967     minmaxf[2]= (2.0f*root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> - size-2.0f)/size;
<a name="l01968"></a>01968     minmaxf[3]= (2.0f*root-&gt;<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ad4c34b3bc3071b6e0baa837d64e0e2b8">ymax</a> - size+2.0f)/size;
<a name="l01969"></a>01969     
<a name="l01970"></a>01970     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1337605158cc594cf324bdbe8b1818ce">LA_LAYER_SHADOW</a>)) lay= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;
<a name="l01971"></a>01971     
<a name="l01972"></a>01972     <span class="comment">/* (ab)use zspan, since we use zbuffer clipping code */</span>
<a name="l01973"></a>01973     <a class="code" href="../../df/d9d/zbuf_8h.html#a1fb1992eda330b65fa0a8a11b8748ecb">zbuf_alloc_span</a>(&amp;zspan, size, size, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a009950f9a9e7f4fa4709c80fa7e82089">clipcrop</a>);
<a name="l01974"></a>01974     
<a name="l01975"></a>01975     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a507f58331206b11d2534a43054dc438a">zmulx</a>=  ((float)size)/2.0f;
<a name="l01976"></a>01976     zspan.<a class="code" href="../../d2/d95/structZSpan.html#adae5adddd27c7e9875b1d31464f37d76">zmuly</a>=  ((float)size)/2.0f;
<a name="l01977"></a>01977     zspan.<a class="code" href="../../d2/d95/structZSpan.html#ae49f5caeb59db8175fc053af87eb3076">zofsx</a>= -0.5f;
<a name="l01978"></a>01978     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a273980e41207b7fcb38d198aea62a5e7">zofsy</a>= -0.5f;
<a name="l01979"></a>01979     
<a name="l01980"></a>01980     <span class="comment">/* pass on bsp root to zspan */</span>
<a name="l01981"></a>01981     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a61c5c3796d566b7bf38504102cc3cea1">rectz</a>= (<span class="keywordtype">int</span> *)root;
<a name="l01982"></a>01982     
<a name="l01983"></a>01983     <span class="comment">/* filling methods */</span>
<a name="l01984"></a>01984     zspanstrand= zspan;
<a name="l01985"></a>01985     <span class="comment">//  zspan.zbuflinefunc= zbufline_onlyZ;</span>
<a name="l01986"></a>01986     zspan.<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a104d36ceb11a6495cad0c921c6ad9273">isb_bsp_test_face</a>;
<a name="l01987"></a>01987     zspanstrand.<a class="code" href="../../d2/d95/structZSpan.html#a2fc033667d3026b74c4353ccb77b8865">zbuffunc</a>= <a class="code" href="../../d0/de2/shadbuf_8c.html#a43e9bbd8bc96f0cb6924eea6f8bc9ebf">isb_bsp_test_strand</a>;
<a name="l01988"></a>01988     
<a name="l01989"></a>01989     <span class="keywordflow">for</span> (i=0, obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; i++, obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l01990"></a>01990         obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l01991"></a>01991 
<a name="l01992"></a>01992         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l01993"></a>01993             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(winmat, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l01994"></a>01994         <span class="keywordflow">else</span>
<a name="l01995"></a>01995             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(winmat, shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>);
<a name="l01996"></a>01996 
<a name="l01997"></a>01997         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l01998"></a>01998             
<a name="l01999"></a>01999             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l02000"></a>02000             <span class="keywordflow">else</span> vlr++;
<a name="l02001"></a>02001             
<a name="l02002"></a>02002             <span class="comment">/* note, these conditions are copied in shadowbuf_autoclip() */</span>
<a name="l02003"></a>02003             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>!= ma) {
<a name="l02004"></a>02004                 ma= vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>;
<a name="l02005"></a>02005                 ok= 1;
<a name="l02006"></a>02006                 <span class="keywordflow">if</span> ((ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a57a66e703cc7c97d7e2feb1f6b5bccc6">MA_SHADBUF</a>)==0) ok= 0;
<a name="l02007"></a>02007                 <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>) ok= 0;
<a name="l02008"></a>02008                 zspanstrand.<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>= zspan.<a class="code" href="../../d2/d95/structZSpan.html#ad13eaf111ea483ec2fb1bb3362df35a6">shad_alpha</a>= ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a0d7be284a93e101bc31ae4a3df31b9ce">shad_alpha</a>;
<a name="l02009"></a>02009             }
<a name="l02010"></a>02010             
<a name="l02011"></a>02011             <span class="keywordflow">if</span> (ok &amp;&amp; (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a> &amp; lay)) {
<a name="l02012"></a>02012                 <span class="keywordtype">float</span> hoco[4][4];
<a name="l02013"></a>02013                 <span class="keywordtype">int</span> c1, c2, c3, c4=0;
<a name="l02014"></a>02014                 <span class="keywordtype">int</span> d1, d2, d3, d4=0;
<a name="l02015"></a>02015                 <span class="keywordtype">int</span> partclip;
<a name="l02016"></a>02016                 
<a name="l02017"></a>02017                 <span class="comment">/* create hocos per face, it is while render */</span>
<a name="l02018"></a>02018                 <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, hoco[0]); d1= <a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">testclip_minmax</a>(hoco[0], minmaxf);
<a name="l02019"></a>02019                 <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a04c76ece1792f1c07dd601b11254d846">v2</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, hoco[1]); d2= <a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">testclip_minmax</a>(hoco[1], minmaxf);
<a name="l02020"></a>02020                 <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#abc220dbcc598d6e4533377e07cf956b9">v3</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, hoco[2]); d3= <a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">testclip_minmax</a>(hoco[2], minmaxf);
<a name="l02021"></a>02021                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02022"></a>02022                     <a class="code" href="../../df/d9d/zbuf_8h.html#ad93b4beaa7403eec42729787b46e3e35">projectvert</a>(vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>, winmat, hoco[3]); d4= <a class="code" href="../../d0/de2/shadbuf_8c.html#af326f004df0626d932264f785e652c8e">testclip_minmax</a>(hoco[3], minmaxf);
<a name="l02023"></a>02023                 }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025                 <span class="comment">/* minmax clipping */</span>
<a name="l02026"></a>02026                 <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) partclip= d1 &amp; d2 &amp; d3 &amp; d4;
<a name="l02027"></a>02027                 <span class="keywordflow">else</span> partclip= d1 &amp; d2 &amp; d3;
<a name="l02028"></a>02028                 
<a name="l02029"></a>02029                 <span class="keywordflow">if</span> (partclip==0) {
<a name="l02030"></a>02030                     
<a name="l02031"></a>02031                     <span class="comment">/* window clipping */</span>
<a name="l02032"></a>02032                     c1= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(hoco[0]); 
<a name="l02033"></a>02033                     c2= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(hoco[1]); 
<a name="l02034"></a>02034                     c3= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(hoco[2]); 
<a name="l02035"></a>02035                     <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l02036"></a>02036                         c4= <a class="code" href="../../df/d9d/zbuf_8h.html#afd0363389290972e0d09995ffc48bb20">testclip</a>(hoco[3]); 
<a name="l02037"></a>02037                     
<a name="l02038"></a>02038                     <span class="comment">/* ***** NO WIRE YET */</span>         
<a name="l02039"></a>02039                     <span class="keywordflow">if</span> (ma-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#ace7b0e47f96304e3d85afdf3d6f4ee51">MA_TYPE_WIRE</a>) {
<a name="l02040"></a>02040                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>)
<a name="l02041"></a>02041                             <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(&amp;zspan, i, a+1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, hoco[0], hoco[1], hoco[2], hoco[3], c1, c2, c3, c4);
<a name="l02042"></a>02042                         <span class="keywordflow">else</span>
<a name="l02043"></a>02043                             <a class="code" href="../../df/d9d/zbuf_8h.html#ac0f510fa38ce19161cb1302a96b1fd60">zbufclipwire</a>(&amp;zspan, i, a+1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#af73e66397d7c5354576cd1d966b7d31f">ec</a>, hoco[0], hoco[1], hoco[2], 0, c1, c2, c3, 0);
<a name="l02044"></a>02044                     }
<a name="l02045"></a>02045                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ac1f0e575388f0de96ebaec99757d6de3">v4</a>) {
<a name="l02046"></a>02046                         <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a57dbe7a8068e51a089d1751108471aa4">R_STRAND</a>)
<a name="l02047"></a>02047                             <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(&amp;zspanstrand, i, a+1, hoco[0], hoco[1], hoco[2], hoco[3], c1, c2, c3, c4);
<a name="l02048"></a>02048                         <span class="keywordflow">else</span>
<a name="l02049"></a>02049                             <a class="code" href="../../df/d9d/zbuf_8h.html#a1256d6f42a663f322b2627b78625b1ae">zbufclip4</a>(&amp;zspan, i, a+1, hoco[0], hoco[1], hoco[2], hoco[3], c1, c2, c3, c4);
<a name="l02050"></a>02050                     }
<a name="l02051"></a>02051                     <span class="keywordflow">else</span>
<a name="l02052"></a>02052                         <a class="code" href="../../df/d9d/zbuf_8h.html#a3db40f6c1f27e8cd4ecd6ed7ce367a5c">zbufclip</a>(&amp;zspan, i, a+1, hoco[0], hoco[1], hoco[2], c1, c2, c3);
<a name="l02053"></a>02053                     
<a name="l02054"></a>02054                 }
<a name="l02055"></a>02055             }
<a name="l02056"></a>02056         }
<a name="l02057"></a>02057     }
<a name="l02058"></a>02058     
<a name="l02059"></a>02059     <a class="code" href="../../df/d9d/zbuf_8h.html#ae5adde957e1f7d437dc9ab8f867b2105">zbuf_free_span</a>(&amp;zspan);
<a name="l02060"></a>02060 }
<a name="l02061"></a>02061 
<a name="l02062"></a>02062 <span class="comment">/* returns 1 when the viewpixel is visible in lampbuffer */</span>
<a name="l02063"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">02063</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">viewpixel_to_lampbuf</a>(<a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb, <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> co_r[3])
<a name="l02064"></a>02064 {
<a name="l02065"></a>02065     <span class="keywordtype">float</span> hoco[4], v1[3], nor[3];
<a name="l02066"></a>02066     <span class="keywordtype">float</span> dface, fac, siz;
<a name="l02067"></a>02067     
<a name="l02068"></a>02068     <a class="code" href="../../d0/db6/renderdatabase_8h.html#a8202c2b146c33a708bb4045dfd5aee87">RE_vlakren_get_normal</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, obi, vlr, nor);
<a name="l02069"></a>02069     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#ad00653a4aaa14efe7934baa17225e145">v1</a>-&gt;<a class="code" href="../../db/dcb/structVertRen.html#a99943e087d353404599bd07028959ac0">co</a>);
<a name="l02070"></a>02070     <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a4dc9d0598f1e1b4ec75a1710cccd03fb">R_TRANSFORMED</a>)
<a name="l02071"></a>02071         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, v1);
<a name="l02072"></a>02072 
<a name="l02073"></a>02073     <span class="comment">/* from shadepixel() */</span>
<a name="l02074"></a>02074     dface = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v1, nor);
<a name="l02075"></a>02075     hoco[3]= 1.0f;
<a name="l02076"></a>02076     
<a name="l02077"></a>02077     <span class="comment">/* ortho viewplane cannot intersect using view vector originating in (0,0,0) */</span>
<a name="l02078"></a>02078     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.r.mode &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad1461325b45cf05ec52533e0b5fc9c5b">R_ORTHO</a>) {
<a name="l02079"></a>02079         <span class="comment">/* x and y 3d coordinate can be derived from pixel coord and winmat */</span>
<a name="l02080"></a>02080         <span class="keywordtype">float</span> fx= 2.0f/(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[0][0]);
<a name="l02081"></a>02081         <span class="keywordtype">float</span> fy= 2.0f/(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[1][1]);
<a name="l02082"></a>02082         
<a name="l02083"></a>02083         hoco[0]= (x - 0.5f*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winx)*fx - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[3][0]/<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[0][0];
<a name="l02084"></a>02084         hoco[1]= (y - 0.5f*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winy)*fy - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[3][1]/<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.winmat[1][1];
<a name="l02085"></a>02085         
<a name="l02086"></a>02086         <span class="comment">/* using a*x + b*y + c*z = d equation, (a b c) is normal */</span>
<a name="l02087"></a>02087         <span class="keywordflow">if</span> (nor[2]!=0.0f)
<a name="l02088"></a>02088             hoco[2]= (dface - nor[0]*hoco[0] - nor[1]*hoco[1])/nor[2];
<a name="l02089"></a>02089         <span class="keywordflow">else</span>
<a name="l02090"></a>02090             hoco[2]= 0.0f;
<a name="l02091"></a>02091     }
<a name="l02092"></a>02092     <span class="keywordflow">else</span> {
<a name="l02093"></a>02093         <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, view[3];
<a name="l02094"></a>02094         
<a name="l02095"></a>02095         <a class="code" href="../../d0/d0e/rendercore_8h.html#af170a4376e3760003c79d828fe89c7d0">calc_view_vector</a>(view, x, y);
<a name="l02096"></a>02096         
<a name="l02097"></a>02097         div = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, view);
<a name="l02098"></a>02098         <span class="keywordflow">if</span> (div==0.0f) 
<a name="l02099"></a>02099             <span class="keywordflow">return</span> 0;
<a name="l02100"></a>02100         
<a name="l02101"></a>02101         fac= dface/<a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l02102"></a>02102         
<a name="l02103"></a>02103         hoco[0]= fac*view[0];
<a name="l02104"></a>02104         hoco[1]= fac*view[1];
<a name="l02105"></a>02105         hoco[2]= fac*view[2];
<a name="l02106"></a>02106     }
<a name="l02107"></a>02107     
<a name="l02108"></a>02108     <span class="comment">/* move 3d vector to lampbuf */</span>
<a name="l02109"></a>02109     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, hoco);  <span class="comment">/* rational hom co */</span>
<a name="l02110"></a>02110     
<a name="l02111"></a>02111     <span class="comment">/* clip We can test for -1.0/1.0 because of the properties of the</span>
<a name="l02112"></a>02112 <span class="comment">     * coordinate transformations. */</span>
<a name="l02113"></a>02113     fac= <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(hoco[3]);
<a name="l02114"></a>02114     <span class="keywordflow">if</span> (hoco[0]&lt;-fac || hoco[0]&gt;fac)
<a name="l02115"></a>02115         <span class="keywordflow">return</span> 0;
<a name="l02116"></a>02116     <span class="keywordflow">if</span> (hoco[1]&lt;-fac || hoco[1]&gt;fac)
<a name="l02117"></a>02117         <span class="keywordflow">return</span> 0;
<a name="l02118"></a>02118     <span class="keywordflow">if</span> (hoco[2]&lt;-fac || hoco[2]&gt;fac)
<a name="l02119"></a>02119         <span class="keywordflow">return</span> 0;
<a name="l02120"></a>02120     
<a name="l02121"></a>02121     siz= 0.5f*(float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l02122"></a>02122     co_r[0]= siz*(1.0f+hoco[0]/hoco[3]) -0.5f;
<a name="l02123"></a>02123     co_r[1]= siz*(1.0f+hoco[1]/hoco[3]) -0.5f;
<a name="l02124"></a>02124     co_r[2]= ((float)0x7FFFFFFF)*(hoco[2]/hoco[3]);
<a name="l02125"></a>02125     
<a name="l02126"></a>02126     <span class="comment">/* XXXX bias, much less than normal shadbuf, or do we need a constant? */</span>
<a name="l02127"></a>02127     co_r[2] -= 0.05f*shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a0741421a00c022bbf00d2878ca53e1d8">bias</a>;
<a name="l02128"></a>02128     
<a name="l02129"></a>02129     <span class="keywordflow">return</span> 1;
<a name="l02130"></a>02130 }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132 <span class="comment">/* storage of shadow results, solid osa and transp case */</span>
<a name="l02133"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#ad2d61a33eaf1b5ecff4b4a1d1f790894">02133</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#ad2d61a33eaf1b5ecff4b4a1d1f790894">isb_add_shadfac</a>(<a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a> **isbsapp, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *mem, <span class="keywordtype">int</span> obi, <span class="keywordtype">int</span> facenr, <span class="keywordtype">short</span> shadfac, <span class="keywordtype">short</span> samples)
<a name="l02134"></a>02134 {
<a name="l02135"></a>02135     <a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a> *<span class="keyword">new</span>;
<a name="l02136"></a>02136     <span class="keywordtype">float</span> shadfacf;
<a name="l02137"></a>02137     
<a name="l02138"></a>02138     <span class="comment">/* in osa case, the samples were filled in with factor 1.0/R.osa. if fewer samples we have to correct */</span>
<a name="l02139"></a>02139     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l02140"></a>02140         shadfacf= ((float)shadfac*<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)/(4096.0f*samples);
<a name="l02141"></a>02141     <span class="keywordflow">else</span>
<a name="l02142"></a>02142         shadfacf= ((float)shadfac)/(4096.0f);
<a name="l02143"></a>02143     
<a name="l02144"></a>02144     <span class="keyword">new</span>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a>));
<a name="l02145"></a>02145     <span class="keyword">new</span>-&gt;obi= obi;
<a name="l02146"></a>02146     <span class="keyword">new</span>-&gt;facenr= facenr &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l02147"></a>02147     <span class="keyword">new</span>-&gt;shadfac= shadfacf;
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (*isbsapp)
<a name="l02149"></a>02149         <span class="keyword">new</span>-&gt;next= (*isbsapp);
<a name="l02150"></a>02150     <span class="keywordflow">else</span>
<a name="l02151"></a>02151         <span class="keyword">new</span>-&gt;next= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02152"></a>02152     
<a name="l02153"></a>02153     *isbsapp= <span class="keyword">new</span>;
<a name="l02154"></a>02154 }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156 <span class="comment">/* adding samples, solid case */</span>
<a name="l02157"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#afc0a5030b4bdde58b085504d4164d6f9">02157</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#afc0a5030b4bdde58b085504d4164d6f9">isb_add_samples</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena, <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> **samplebuf)
<a name="l02158"></a>02158 {
<a name="l02159"></a>02159     <span class="keywordtype">int</span> xi, yi, *xcos, *ycos;
<a name="l02160"></a>02160     <span class="keywordtype">int</span> sample, bsp_err= 0;
<a name="l02161"></a>02161     
<a name="l02162"></a>02162     <span class="comment">/* bsp split doesn&#39;t like to handle regular sequences */</span>
<a name="l02163"></a>02163     xcos= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;xcos&quot;</span>);
<a name="l02164"></a>02164     ycos= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ycos&quot;</span>);
<a name="l02165"></a>02165     <span class="keywordflow">for</span> (xi=0; xi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; xi++)
<a name="l02166"></a>02166         xcos[xi]= xi;
<a name="l02167"></a>02167     <span class="keywordflow">for</span> (yi=0; yi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; yi++)
<a name="l02168"></a>02168         ycos[yi]= yi;
<a name="l02169"></a>02169     <a class="code" href="../../d3/d88/BLI__rand_8h.html#ac2f28f8410100a0a1a6d72e04c6eb956">BLI_array_randomize</a>(xcos, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, 12345);
<a name="l02170"></a>02170     <a class="code" href="../../d3/d88/BLI__rand_8h.html#ac2f28f8410100a0a1a6d72e04c6eb956">BLI_array_randomize</a>(ycos, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 54321);
<a name="l02171"></a>02171     
<a name="l02172"></a>02172     <span class="keywordflow">for</span> (sample=0; sample&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); sample++) {
<a name="l02173"></a>02173         <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *samp= samplebuf[sample], *samp1;
<a name="l02174"></a>02174         
<a name="l02175"></a>02175         <span class="keywordflow">for</span> (yi=0; yi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; yi++) {
<a name="l02176"></a>02176             <span class="keywordtype">int</span> y= ycos[yi];
<a name="l02177"></a>02177             <span class="keywordflow">for</span> (xi=0; xi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; xi++) {
<a name="l02178"></a>02178                 <span class="keywordtype">int</span> x= xcos[xi];
<a name="l02179"></a>02179                 samp1= samp + y*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a> + x;
<a name="l02180"></a>02180                 <span class="keywordflow">if</span> (samp1-&gt;facenr)
<a name="l02181"></a>02181                     bsp_err |= <a class="code" href="../../d0/de2/shadbuf_8c.html#a6ec54820d738c24927558640a0c4cf65">isb_bsp_insert</a>(root, memarena, samp1);
<a name="l02182"></a>02182             }
<a name="l02183"></a>02183             <span class="keywordflow">if</span> (bsp_err) <span class="keywordflow">break</span>;
<a name="l02184"></a>02184         }
<a name="l02185"></a>02185     }   
<a name="l02186"></a>02186     
<a name="l02187"></a>02187     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(xcos);
<a name="l02188"></a>02188     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ycos);
<a name="l02189"></a>02189 
<a name="l02190"></a>02190     <span class="keywordflow">return</span> bsp_err;
<a name="l02191"></a>02191 }
<a name="l02192"></a>02192 
<a name="l02193"></a>02193 <span class="comment">/* solid version */</span>
<a name="l02194"></a>02194 <span class="comment">/* lar-&gt;shb, pa-&gt;rectz and pa-&gt;rectp should exist */</span>
<a name="l02195"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a25183f93eb253475b99c5129e7af59e3">02195</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#a25183f93eb253475b99c5129e7af59e3">isb_make_buffer</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l02196"></a>02196 {
<a name="l02197"></a>02197     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l02198"></a>02198     <a class="code" href="../../dd/df9/structISBData.html">ISBData</a> *isbdata;
<a name="l02199"></a>02199     <a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *samp, *samplebuf[16];    <span class="comment">/* should be RE_MAX_OSA */</span>
<a name="l02200"></a>02200     <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> root;
<a name="l02201"></a>02201     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena;
<a name="l02202"></a>02202     intptr_t *rd;
<a name="l02203"></a>02203     <span class="keywordtype">int</span> *recto, *rectp, x, y, sindex, sample, bsp_err=0;
<a name="l02204"></a>02204     
<a name="l02205"></a>02205     <span class="comment">/* storage for shadow, per thread */</span>
<a name="l02206"></a>02206     isbdata= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>];
<a name="l02207"></a>02207     
<a name="l02208"></a>02208     <span class="comment">/* to map the shi-&gt;xs and ys coordinate */</span>
<a name="l02209"></a>02209     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#aec7bd65e2cefaf0f2b1d0f49c8be78e8">minx</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l02210"></a>02210     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#ae40171a59b7ca48f6ead476dc125b538">miny</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l02211"></a>02211     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a598172f720c295ebd86a7c3aa20cb44a">rectx</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l02212"></a>02212     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a2f5a4c7415adfb63aad36a366e62c84c">recty</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>;
<a name="l02213"></a>02213     
<a name="l02214"></a>02214     <span class="comment">/* branches are added using memarena (32k branches) */</span>
<a name="l02215"></a>02215     memarena = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(0x8000 * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>), <span class="stringliteral">&quot;isb arena&quot;</span>);
<a name="l02216"></a>02216     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(memarena);
<a name="l02217"></a>02217     
<a name="l02218"></a>02218     <span class="comment">/* samplebuf is in camera view space (pixels) */</span>
<a name="l02219"></a>02219     <span class="keywordflow">for</span> (sample=0; sample&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); sample++)
<a name="l02220"></a>02220         samplebuf[sample]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a>)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;isb samplebuf&quot;</span>);
<a name="l02221"></a>02221     
<a name="l02222"></a>02222     <span class="comment">/* for end result, ISBSamples point to this in non OSA case, otherwise to pixstruct-&gt;shadfac */</span>
<a name="l02223"></a>02223     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa==0)
<a name="l02224"></a>02224         isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">short</span>), <span class="stringliteral">&quot;isb shadfacs&quot;</span>);
<a name="l02225"></a>02225     
<a name="l02226"></a>02226     <span class="comment">/* setup bsp root */</span>
<a name="l02227"></a>02227     memset(&amp;root, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l02228"></a>02228     root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = (float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l02229"></a>02229     root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = (<span class="keywordtype">float</span>)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l02230"></a>02230     
<a name="l02231"></a>02231     <span class="comment">/* create the sample buffers */</span>
<a name="l02232"></a>02232     <span class="keywordflow">for</span> (sindex=0, y=0; y&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; y++) {
<a name="l02233"></a>02233         <span class="keywordflow">for</span> (x=0; x&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; x++, sindex++) {
<a name="l02234"></a>02234             
<a name="l02235"></a>02235             <span class="comment">/* this makes it a long function, but splitting it out would mean 10+ arguments */</span>
<a name="l02236"></a>02236             <span class="comment">/* first check OSA case */</span>
<a name="l02237"></a>02237             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l02238"></a>02238                 rd= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a> + sindex;
<a name="l02239"></a>02239                 <span class="keywordflow">if</span> (*rd) {
<a name="l02240"></a>02240                     <span class="keywordtype">float</span> xs= (float)(x + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>);
<a name="l02241"></a>02241                     <span class="keywordtype">float</span> ys= (float)(y + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>);
<a name="l02242"></a>02242                     
<a name="l02243"></a>02243                     <span class="keywordflow">for</span> (sample=0; sample&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; sample++) {
<a name="l02244"></a>02244                         <a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *ps= (<a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *)(*rd);
<a name="l02245"></a>02245                         <span class="keywordtype">int</span> mask= (1&lt;&lt;sample);
<a name="l02246"></a>02246                         
<a name="l02247"></a>02247                         <span class="keywordflow">while</span> (ps) {
<a name="l02248"></a>02248                             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#af0b04e6da97ea4a3181f23d4ab49452e">mask</a> &amp; mask)
<a name="l02249"></a>02249                                 <span class="keywordflow">break</span>;
<a name="l02250"></a>02250                             ps= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aeb6499e7a3de74d45a89157937d40aa4">next</a>;
<a name="l02251"></a>02251                         }
<a name="l02252"></a>02252                         <span class="keywordflow">if</span> (ps &amp;&amp; ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a738ddb004590b1337443255887450ef2">facenr</a>&gt;0) {
<a name="l02253"></a>02253                             <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi= &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance[ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a0a00df3d865726292458897c2c5348e7">obi</a>];
<a name="l02254"></a>02254                             <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02255"></a>02255                             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, (ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a738ddb004590b1337443255887450ef2">facenr</a>-1) &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac1ba251e205ec58bf4d88f687b64314f">RE_QUAD_MASK</a>);
<a name="l02256"></a>02256                             
<a name="l02257"></a>02257                             samp= samplebuf[sample] + sindex;
<a name="l02258"></a>02258                             <span class="comment">/* convert image plane pixel location to lamp buffer space */</span>
<a name="l02259"></a>02259                             <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">viewpixel_to_lampbuf</a>(shb, obi, vlr, xs + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[sample][0], ys + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[sample][1], samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>)) {
<a name="l02260"></a>02260                                 samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a89de5ebd4b44c8e0c3256935b0d70755">obi</a>= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a0a00df3d865726292458897c2c5348e7">obi</a>;
<a name="l02261"></a>02261                                 samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a8efe32eb55d3b43887a2165d646c8558">facenr</a>= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a738ddb004590b1337443255887450ef2">facenr</a> &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l02262"></a>02262                                 ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#ad8fe1f099aa238fd118e98d24cfdfebd">shadfac</a>= 0;
<a name="l02263"></a>02263                                 samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>= &amp;ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#ad8fe1f099aa238fd118e98d24cfdfebd">shadfac</a>;
<a name="l02264"></a>02264                                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">bound_rectf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>);
<a name="l02265"></a>02265                             }
<a name="l02266"></a>02266                         }
<a name="l02267"></a>02267                     }
<a name="l02268"></a>02268                 }
<a name="l02269"></a>02269             }
<a name="l02270"></a>02270             <span class="keywordflow">else</span> {
<a name="l02271"></a>02271                 rectp= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a19296bd81488c2b963562b2aa11ded26">rectp</a> + sindex;
<a name="l02272"></a>02272                 recto= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a52f4f2e4cceaff5e79ad83bc44587151">recto</a> + sindex;
<a name="l02273"></a>02273                 <span class="keywordflow">if</span> (*rectp&gt;0) {
<a name="l02274"></a>02274                     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi= &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance[*recto];
<a name="l02275"></a>02275                     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02276"></a>02276                     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, (*rectp-1) &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac1ba251e205ec58bf4d88f687b64314f">RE_QUAD_MASK</a>);
<a name="l02277"></a>02277                     <span class="keywordtype">float</span> xs= (float)(x + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>);
<a name="l02278"></a>02278                     <span class="keywordtype">float</span> ys= (float)(y + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>);
<a name="l02279"></a>02279                     
<a name="l02280"></a>02280                     samp= samplebuf[0] + sindex;
<a name="l02281"></a>02281                     <span class="comment">/* convert image plane pixel location to lamp buffer space */</span>
<a name="l02282"></a>02282                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">viewpixel_to_lampbuf</a>(shb, obi, vlr, xs, ys, samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>)) {
<a name="l02283"></a>02283                         samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a89de5ebd4b44c8e0c3256935b0d70755">obi</a>= *recto;
<a name="l02284"></a>02284                         samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a8efe32eb55d3b43887a2165d646c8558">facenr</a>= *rectp &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l02285"></a>02285                         samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a3daf90693eee90a3eaa5b66685b51c11">shadfac</a>= isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a> + sindex;
<a name="l02286"></a>02286                         <a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">bound_rectf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, samp-&gt;<a class="code" href="../../dc/d7a/structISBSample.html#a7cab1238b0ad55b36fb7e753d29149ae">zco</a>);
<a name="l02287"></a>02287                     }
<a name="l02288"></a>02288                 }
<a name="l02289"></a>02289             }
<a name="l02290"></a>02290         }
<a name="l02291"></a>02291     }
<a name="l02292"></a>02292     
<a name="l02293"></a>02293     <span class="comment">/* simple method to see if we have samples */</span>
<a name="l02294"></a>02294     <span class="keywordflow">if</span> (root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> != (<span class="keywordtype">float</span>)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) {
<a name="l02295"></a>02295         <span class="comment">/* now create a regular split, root.box has the initial bounding box of all pixels */</span>
<a name="l02296"></a>02296         <span class="comment">/* split bsp 8 levels deep, in regular grid (16 x 16) */</span>
<a name="l02297"></a>02297         <a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">isb_bsp_split_init</a>(&amp;root, memarena, 8);
<a name="l02298"></a>02298         
<a name="l02299"></a>02299         <span class="comment">/* insert all samples in BSP now */</span>
<a name="l02300"></a>02300         bsp_err= <a class="code" href="../../d0/de2/shadbuf_8c.html#afc0a5030b4bdde58b085504d4164d6f9">isb_add_samples</a>(pa, &amp;root, memarena, samplebuf);
<a name="l02301"></a>02301             
<a name="l02302"></a>02302         <span class="keywordflow">if</span> (bsp_err==0) {
<a name="l02303"></a>02303             <span class="comment">/* go over all faces and fill in shadow values */</span>
<a name="l02304"></a>02304             
<a name="l02305"></a>02305             <a class="code" href="../../d0/de2/shadbuf_8c.html#afdcf7c01a2d1503c35e5cb6ed43ae3cb">isb_bsp_fillfaces</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar, &amp;root);  <span class="comment">/* shb-&gt;persmat should have been calculated */</span>
<a name="l02306"></a>02306             
<a name="l02307"></a>02307             <span class="comment">/* copy shadow samples to persistent buffer, reduce memory overhead */</span>
<a name="l02308"></a>02308             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l02309"></a>02309                 <a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a> **isbsa= isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *), <span class="stringliteral">&quot;isb shadfacs&quot;</span>);
<a name="l02310"></a>02310                 
<a name="l02311"></a>02311                 isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(0x8000 * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a>), <span class="stringliteral">&quot;isb arena&quot;</span>);
<a name="l02312"></a>02312                 <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>);
<a name="l02313"></a>02313 
<a name="l02314"></a>02314                 <span class="keywordflow">for</span> (rd= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a25d7aa76b8c733135024df0612df4c71">rectdaps</a>, x=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; x&gt;0; x--, rd++, isbsa++) {
<a name="l02315"></a>02315                     
<a name="l02316"></a>02316                     <span class="keywordflow">if</span> (*rd) {
<a name="l02317"></a>02317                         <a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *ps= (<a class="code" href="../../d3/d84/structPixStr.html">PixStr</a> *)(*rd);
<a name="l02318"></a>02318                         <span class="keywordflow">while</span> (ps) {
<a name="l02319"></a>02319                             <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#ad8fe1f099aa238fd118e98d24cfdfebd">shadfac</a>)
<a name="l02320"></a>02320                                 <a class="code" href="../../d0/de2/shadbuf_8c.html#ad2d61a33eaf1b5ecff4b4a1d1f790894">isb_add_shadfac</a>(isbsa, isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>, ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a0a00df3d865726292458897c2c5348e7">obi</a>, ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#a738ddb004590b1337443255887450ef2">facenr</a>, ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#ad8fe1f099aa238fd118e98d24cfdfebd">shadfac</a>, <a class="code" href="../../d0/d0e/rendercore_8h.html#a4b7639b6addcc7e447572d581a9fe70c">count_mask</a>(ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#af0b04e6da97ea4a3181f23d4ab49452e">mask</a>));
<a name="l02321"></a>02321                             ps= ps-&gt;<a class="code" href="../../d3/d84/structPixStr.html#aeb6499e7a3de74d45a89157937d40aa4">next</a>;
<a name="l02322"></a>02322                         }
<a name="l02323"></a>02323                     }
<a name="l02324"></a>02324                 }
<a name="l02325"></a>02325             }
<a name="l02326"></a>02326         }
<a name="l02327"></a>02327     }
<a name="l02328"></a>02328     <span class="keywordflow">else</span> {
<a name="l02329"></a>02329         <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>) {
<a name="l02330"></a>02330             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>);
<a name="l02331"></a>02331             isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02332"></a>02332         }
<a name="l02333"></a>02333     }
<a name="l02334"></a>02334 
<a name="l02335"></a>02335     <span class="comment">/* free BSP */</span>
<a name="l02336"></a>02336     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(memarena);
<a name="l02337"></a>02337     
<a name="l02338"></a>02338     <span class="comment">/* free samples */</span>
<a name="l02339"></a>02339     <span class="keywordflow">for</span> (x=0; x&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); x++)
<a name="l02340"></a>02340         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(samplebuf[x]);
<a name="l02341"></a>02341     
<a name="l02342"></a>02342     <span class="keywordflow">if</span> (bsp_err) printf(<span class="stringliteral">&quot;error in filling bsp\n&quot;</span>);
<a name="l02343"></a>02343 }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345 <span class="comment">/* add sample to buffer, isbsa is the root sample in a buffer */</span>
<a name="l02346"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a0a1d8a6e9dc020e3aee2186c86a22fe4">02346</a> <span class="keyword">static</span> <a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> *<a class="code" href="../../d0/de2/shadbuf_8c.html#a0a1d8a6e9dc020e3aee2186c86a22fe4">isb_alloc_sample_transp</a>(<a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> **isbsa, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *mem)
<a name="l02347"></a>02347 {
<a name="l02348"></a>02348     <a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> *<span class="keyword">new</span>;
<a name="l02349"></a>02349     
<a name="l02350"></a>02350     <span class="keyword">new</span>= <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(mem, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a>));
<a name="l02351"></a>02351     <span class="keywordflow">if</span> (*isbsa)
<a name="l02352"></a>02352         <span class="keyword">new</span>-&gt;next= (*isbsa);
<a name="l02353"></a>02353     <span class="keywordflow">else</span>
<a name="l02354"></a>02354         <span class="keyword">new</span>-&gt;next= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02355"></a>02355     
<a name="l02356"></a>02356     *isbsa= <span class="keyword">new</span>;
<a name="l02357"></a>02357     <span class="keywordflow">return</span> <span class="keyword">new</span>;
<a name="l02358"></a>02358 }
<a name="l02359"></a>02359 
<a name="l02360"></a>02360 <span class="comment">/* adding samples in BSP, transparent case */</span>
<a name="l02361"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#ac231293782d239d9a0422b09dcaa5315">02361</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#ac231293782d239d9a0422b09dcaa5315">isb_add_samples_transp</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> *root, <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena, <a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> ***samplebuf)
<a name="l02362"></a>02362 {
<a name="l02363"></a>02363     <span class="keywordtype">int</span> xi, yi, *xcos, *ycos;
<a name="l02364"></a>02364     <span class="keywordtype">int</span> sample, bsp_err= 0;
<a name="l02365"></a>02365     
<a name="l02366"></a>02366     <span class="comment">/* bsp split doesn&#39;t like to handle regular sequences */</span>
<a name="l02367"></a>02367     xcos= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;xcos&quot;</span>);
<a name="l02368"></a>02368     ycos= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>( pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;ycos&quot;</span>);
<a name="l02369"></a>02369     <span class="keywordflow">for</span> (xi=0; xi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; xi++)
<a name="l02370"></a>02370         xcos[xi]= xi;
<a name="l02371"></a>02371     <span class="keywordflow">for</span> (yi=0; yi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; yi++)
<a name="l02372"></a>02372         ycos[yi]= yi;
<a name="l02373"></a>02373     <a class="code" href="../../d3/d88/BLI__rand_8h.html#ac2f28f8410100a0a1a6d72e04c6eb956">BLI_array_randomize</a>(xcos, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>, 12345);
<a name="l02374"></a>02374     <a class="code" href="../../d3/d88/BLI__rand_8h.html#ac2f28f8410100a0a1a6d72e04c6eb956">BLI_array_randomize</a>(ycos, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, 54321);
<a name="l02375"></a>02375     
<a name="l02376"></a>02376     <span class="keywordflow">for</span> (sample=0; sample&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); sample++) {
<a name="l02377"></a>02377         <a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> **samp= samplebuf[sample], *samp1;
<a name="l02378"></a>02378         
<a name="l02379"></a>02379         <span class="keywordflow">for</span> (yi=0; yi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; yi++) {
<a name="l02380"></a>02380             <span class="keywordtype">int</span> y= ycos[yi];
<a name="l02381"></a>02381             <span class="keywordflow">for</span> (xi=0; xi&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; xi++) {
<a name="l02382"></a>02382                 <span class="keywordtype">int</span> x= xcos[xi];
<a name="l02383"></a>02383                 
<a name="l02384"></a>02384                 samp1= *(samp + y*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a> + x);
<a name="l02385"></a>02385                 <span class="keywordflow">while</span> (samp1) {
<a name="l02386"></a>02386                     bsp_err |= <a class="code" href="../../d0/de2/shadbuf_8c.html#a6ec54820d738c24927558640a0c4cf65">isb_bsp_insert</a>(root, memarena, (<a class="code" href="../../dc/d7a/structISBSample.html">ISBSample</a> *)samp1);
<a name="l02387"></a>02387                     samp1= samp1-&gt;next;
<a name="l02388"></a>02388                 }
<a name="l02389"></a>02389             }
<a name="l02390"></a>02390             <span class="keywordflow">if</span> (bsp_err) <span class="keywordflow">break</span>;
<a name="l02391"></a>02391         }
<a name="l02392"></a>02392     }   
<a name="l02393"></a>02393     
<a name="l02394"></a>02394     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(xcos);
<a name="l02395"></a>02395     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ycos);
<a name="l02396"></a>02396     
<a name="l02397"></a>02397     <span class="keywordflow">return</span> bsp_err;
<a name="l02398"></a>02398 }
<a name="l02399"></a>02399 
<a name="l02400"></a>02400 
<a name="l02401"></a>02401 <span class="comment">/* Ztransp version */</span>
<a name="l02402"></a>02402 <span class="comment">/* lar-&gt;shb, pa-&gt;rectz and pa-&gt;rectp should exist */</span>
<a name="l02403"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#acbdbc8e10cbed128b618b293df85f643">02403</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/de2/shadbuf_8c.html#acbdbc8e10cbed128b618b293df85f643">isb_make_buffer_transp</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apixbuf, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar)
<a name="l02404"></a>02404 {
<a name="l02405"></a>02405     <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>;
<a name="l02406"></a>02406     <a class="code" href="../../dd/df9/structISBData.html">ISBData</a> *isbdata;
<a name="l02407"></a>02407     <a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a> *samp, **samplebuf[16];  <span class="comment">/* MAX_OSA */</span>
<a name="l02408"></a>02408     <a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a> root;
<a name="l02409"></a>02409     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *memarena;
<a name="l02410"></a>02410     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *ap;
<a name="l02411"></a>02411     <span class="keywordtype">int</span> x, y, sindex, sample, bsp_err=0;
<a name="l02412"></a>02412     
<a name="l02413"></a>02413     <span class="comment">/* storage for shadow, per thread */</span>
<a name="l02414"></a>02414     isbdata= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>];
<a name="l02415"></a>02415     
<a name="l02416"></a>02416     <span class="comment">/* to map the shi-&gt;xs and ys coordinate */</span>
<a name="l02417"></a>02417     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#aec7bd65e2cefaf0f2b1d0f49c8be78e8">minx</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l02418"></a>02418     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#ae40171a59b7ca48f6ead476dc125b538">miny</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l02419"></a>02419     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a598172f720c295ebd86a7c3aa20cb44a">rectx</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>;
<a name="l02420"></a>02420     isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a2f5a4c7415adfb63aad36a366e62c84c">recty</a>= pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>;
<a name="l02421"></a>02421     
<a name="l02422"></a>02422     <span class="comment">/* branches are added using memarena (32k branches) */</span>
<a name="l02423"></a>02423     memarena = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(0x8000 * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>), <span class="stringliteral">&quot;isb arena&quot;</span>);
<a name="l02424"></a>02424     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(memarena);
<a name="l02425"></a>02425     
<a name="l02426"></a>02426     <span class="comment">/* samplebuf is in camera view space (pixels) */</span>
<a name="l02427"></a>02427     <span class="keywordflow">for</span> (sample=0; sample&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); sample++)
<a name="l02428"></a>02428         samplebuf[sample]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *)*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>, <span class="stringliteral">&quot;isb alpha samplebuf&quot;</span>);
<a name="l02429"></a>02429     
<a name="l02430"></a>02430     <span class="comment">/* setup bsp root */</span>
<a name="l02431"></a>02431     memset(&amp;root, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d5b/structISBBranch.html">ISBBranch</a>));
<a name="l02432"></a>02432     root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> = (float)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l02433"></a>02433     root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ae876051bc87cc4b3a62d2b800cc20663">ymin</a> = (<span class="keywordtype">float</span>)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>;
<a name="l02434"></a>02434 
<a name="l02435"></a>02435     <span class="comment">/* create the sample buffers */</span>
<a name="l02436"></a>02436     <span class="keywordflow">for</span> (ap= apixbuf, sindex=0, y=0; y&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; y++) {
<a name="l02437"></a>02437         <span class="keywordflow">for</span> (x=0; x&lt;pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>; x++, sindex++, ap++) {
<a name="l02438"></a>02438             
<a name="l02439"></a>02439             <span class="keywordflow">if</span> (ap-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]) {
<a name="l02440"></a>02440                 <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apn;
<a name="l02441"></a>02441                 <span class="keywordtype">float</span> xs= (float)(x + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>);
<a name="l02442"></a>02442                 <span class="keywordtype">float</span> ys= (float)(y + pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#adc3eb3416f7d07972dd32c555fbf5b64">disprect</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>);
<a name="l02443"></a>02443                 
<a name="l02444"></a>02444                 <span class="keywordflow">for</span> (apn=ap; apn; apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>) {
<a name="l02445"></a>02445                     <span class="keywordtype">int</span> a;
<a name="l02446"></a>02446                     <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l02447"></a>02447                         <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a]) {
<a name="l02448"></a>02448                             <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi= &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance[apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a]];
<a name="l02449"></a>02449                             <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr= obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l02450"></a>02450                             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr= <a class="code" href="../../d0/db6/renderdatabase_8h.html#a12aeb33f7f967002f23ae12a6861914b">RE_findOrAddVlak</a>(obr, (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a]-1) &amp; <a class="code" href="../../d0/db6/renderdatabase_8h.html#ac1ba251e205ec58bf4d88f687b64314f">RE_QUAD_MASK</a>);
<a name="l02451"></a>02451                             <span class="keywordtype">float</span> zco[3];
<a name="l02452"></a>02452                             
<a name="l02453"></a>02453                             <span class="comment">/* here we store shadfac, easier to create the end storage buffer. needs zero&#39;ed, multiple shadowbufs use it */</span>
<a name="l02454"></a>02454                             apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a]= 0;
<a name="l02455"></a>02455                             
<a name="l02456"></a>02456                             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa) {
<a name="l02457"></a>02457                                 <span class="keywordflow">for</span> (sample=0; sample&lt;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa; sample++) {
<a name="l02458"></a>02458                                     <span class="keywordtype">int</span> mask= (1&lt;&lt;sample);
<a name="l02459"></a>02459                                     
<a name="l02460"></a>02460                                     <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[a] &amp; mask) {
<a name="l02461"></a>02461                                         
<a name="l02462"></a>02462                                         <span class="comment">/* convert image plane pixel location to lamp buffer space */</span>
<a name="l02463"></a>02463                                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">viewpixel_to_lampbuf</a>(shb, obi, vlr, xs + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[sample][0], ys + <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.jit[sample][1], zco)) {
<a name="l02464"></a>02464                                             samp= <a class="code" href="../../d0/de2/shadbuf_8c.html#a0a1d8a6e9dc020e3aee2186c86a22fe4">isb_alloc_sample_transp</a>(samplebuf[sample] + sindex, memarena);
<a name="l02465"></a>02465                                             samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#a507efd4dc8c2297f66424a27b4523064">obi</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a];
<a name="l02466"></a>02466                                             samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ad837da9d2ba90a965827a63b595a71ab">facenr</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a] &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l02467"></a>02467                                             samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ad963a111a98fcc571f5f59d16fcc5eaf">shadfac</a>= &amp;apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a];
<a name="l02468"></a>02468                                             
<a name="l02469"></a>02469                                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ae3d25f72d00e919810e453f833be10cd">zco</a>, zco);
<a name="l02470"></a>02470                                             <a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">bound_rectf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ae3d25f72d00e919810e453f833be10cd">zco</a>);
<a name="l02471"></a>02471                                         }
<a name="l02472"></a>02472                                     }
<a name="l02473"></a>02473                                 }
<a name="l02474"></a>02474                             }
<a name="l02475"></a>02475                             <span class="keywordflow">else</span> {
<a name="l02476"></a>02476                                 
<a name="l02477"></a>02477                                 <span class="comment">/* convert image plane pixel location to lamp buffer space */</span>
<a name="l02478"></a>02478                                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/shadbuf_8c.html#a7ec9519eed0b720a37dfd8f5b4d40deb">viewpixel_to_lampbuf</a>(shb, obi, vlr, xs, ys, zco)) {
<a name="l02479"></a>02479                                     
<a name="l02480"></a>02480                                     samp= <a class="code" href="../../d0/de2/shadbuf_8c.html#a0a1d8a6e9dc020e3aee2186c86a22fe4">isb_alloc_sample_transp</a>(samplebuf[0] + sindex, memarena);
<a name="l02481"></a>02481                                     samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#a507efd4dc8c2297f66424a27b4523064">obi</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a];
<a name="l02482"></a>02482                                     samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ad837da9d2ba90a965827a63b595a71ab">facenr</a>= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a] &amp; ~<a class="code" href="../../d0/db6/renderdatabase_8h.html#aeb9b2247cb304c9a1279bc6809c79e3c">RE_QUAD_OFFS</a>;
<a name="l02483"></a>02483                                     samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ad963a111a98fcc571f5f59d16fcc5eaf">shadfac</a>= &amp;apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a];
<a name="l02484"></a>02484                                     
<a name="l02485"></a>02485                                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ae3d25f72d00e919810e453f833be10cd">zco</a>, zco);
<a name="l02486"></a>02486                                     <a class="code" href="../../d0/de2/shadbuf_8c.html#a0f28d8061567f2b4a873051649cc04d0">bound_rectf</a>((<a class="code" href="../../da/d10/structrctf.html">rctf</a> *)&amp;root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>, samp-&gt;<a class="code" href="../../df/d17/structISBSampleA.html#ae3d25f72d00e919810e453f833be10cd">zco</a>);
<a name="l02487"></a>02487                                 }
<a name="l02488"></a>02488                             }
<a name="l02489"></a>02489                         }
<a name="l02490"></a>02490                     }
<a name="l02491"></a>02491                 }
<a name="l02492"></a>02492             }
<a name="l02493"></a>02493         }
<a name="l02494"></a>02494     }
<a name="l02495"></a>02495     
<a name="l02496"></a>02496     <span class="comment">/* simple method to see if we have samples */</span>
<a name="l02497"></a>02497     <span class="keywordflow">if</span> (root.<a class="code" href="../../db/d5b/structISBBranch.html#a861f102e85b1f5ff8c9033a01b129830">box</a>.<a class="code" href="../../d9/d84/structBoxf.html#ac0a4fb95dff93d644519d15ee7da67b2">xmin</a> != (<span class="keywordtype">float</span>)shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#abd83505d59adc9dacb740b74767f2267">size</a>) {
<a name="l02498"></a>02498         <span class="comment">/* now create a regular split, root.box has the initial bounding box of all pixels */</span>
<a name="l02499"></a>02499         <span class="comment">/* split bsp 8 levels deep, in regular grid (16 x 16) */</span>
<a name="l02500"></a>02500         <a class="code" href="../../d0/de2/shadbuf_8c.html#a0ad2f83e9af56172c5cf57ff268b9dfe">isb_bsp_split_init</a>(&amp;root, memarena, 8);
<a name="l02501"></a>02501         
<a name="l02502"></a>02502         <span class="comment">/* insert all samples in BSP now */</span>
<a name="l02503"></a>02503         bsp_err= <a class="code" href="../../d0/de2/shadbuf_8c.html#ac231293782d239d9a0422b09dcaa5315">isb_add_samples_transp</a>(pa, &amp;root, memarena, samplebuf);
<a name="l02504"></a>02504         
<a name="l02505"></a>02505         <span class="keywordflow">if</span> (bsp_err==0) {
<a name="l02506"></a>02506             <a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a> **isbsa;
<a name="l02507"></a>02507             
<a name="l02508"></a>02508             <span class="comment">/* go over all faces and fill in shadow values */</span>
<a name="l02509"></a>02509             <a class="code" href="../../d0/de2/shadbuf_8c.html#afdcf7c01a2d1503c35e5cb6ed43ae3cb">isb_bsp_fillfaces</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar, &amp;root);  <span class="comment">/* shb-&gt;persmat should have been calculated */</span>
<a name="l02510"></a>02510             
<a name="l02511"></a>02511             <span class="comment">/* copy shadow samples to persistent buffer, reduce memory overhead */</span>
<a name="l02512"></a>02512             isbsa= isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>*<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *), <span class="stringliteral">&quot;isb shadfacs&quot;</span>);
<a name="l02513"></a>02513             
<a name="l02514"></a>02514             isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(0x8000 * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d17/structISBSampleA.html">ISBSampleA</a>), <span class="stringliteral">&quot;isb arena&quot;</span>);
<a name="l02515"></a>02515             
<a name="l02516"></a>02516             <span class="keywordflow">for</span> (ap= apixbuf, x=pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a2c0da6ca421fe0fb77d5fc32a5e766b4">rectx</a>*pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#afeb4113a565c9ebefa59d5512b73eb12">recty</a>; x&gt;0; x--, ap++, isbsa++) {
<a name="l02517"></a>02517                     
<a name="l02518"></a>02518                 <span class="keywordflow">if</span> (ap-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[0]) {
<a name="l02519"></a>02519                     <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apn;
<a name="l02520"></a>02520                     <span class="keywordflow">for</span> (apn=ap; apn; apn= apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#afae540adfce77412af0d55b8997850eb">next</a>) {
<a name="l02521"></a>02521                         <span class="keywordtype">int</span> a;
<a name="l02522"></a>02522                         <span class="keywordflow">for</span> (a=0; a&lt;4; a++) {
<a name="l02523"></a>02523                             <span class="keywordflow">if</span> (apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a] &amp;&amp; apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a]) {
<a name="l02524"></a>02524                                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa)
<a name="l02525"></a>02525                                     <a class="code" href="../../d0/de2/shadbuf_8c.html#ad2d61a33eaf1b5ecff4b4a1d1f790894">isb_add_shadfac</a>(isbsa, isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>, apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a], apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a], apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a], <a class="code" href="../../d0/d0e/rendercore_8h.html#a4b7639b6addcc7e447572d581a9fe70c">count_mask</a>(apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04d9f176e56384da2626610c5172309f">mask</a>[a]));
<a name="l02526"></a>02526                                 <span class="keywordflow">else</span>
<a name="l02527"></a>02527                                     <a class="code" href="../../d0/de2/shadbuf_8c.html#ad2d61a33eaf1b5ecff4b4a1d1f790894">isb_add_shadfac</a>(isbsa, isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>, apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a04446825ac8b93be3c2c7d6fd5c6176e">obi</a>[a], apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a508d54f8ba09761987a9fe47836434c1">p</a>[a], apn-&gt;<a class="code" href="../../d3/d49/structAPixstr.html#a9af73a8354507ee0fb1d72ec801a4be4">shadfac</a>[a], 0);
<a name="l02528"></a>02528                             }
<a name="l02529"></a>02529                         }
<a name="l02530"></a>02530                     }
<a name="l02531"></a>02531                 }
<a name="l02532"></a>02532             }
<a name="l02533"></a>02533         }
<a name="l02534"></a>02534     }
<a name="l02535"></a>02535 
<a name="l02536"></a>02536     <span class="comment">/* free BSP */</span>
<a name="l02537"></a>02537     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(memarena);
<a name="l02538"></a>02538 
<a name="l02539"></a>02539     <span class="comment">/* free samples */</span>
<a name="l02540"></a>02540     <span class="keywordflow">for</span> (x=0; x&lt;(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa?<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.osa:1); x++)
<a name="l02541"></a>02541         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(samplebuf[x]);
<a name="l02542"></a>02542 
<a name="l02543"></a>02543     <span class="keywordflow">if</span> (bsp_err) printf(<span class="stringliteral">&quot;error in filling bsp\n&quot;</span>);
<a name="l02544"></a>02544 }
<a name="l02545"></a>02545 
<a name="l02546"></a>02546 
<a name="l02547"></a>02547 
<a name="l02548"></a>02548 <span class="comment">/* exported */</span>
<a name="l02549"></a>02549 
<a name="l02550"></a>02550 <span class="comment">/* returns amount of light (1.0 = no shadow) */</span>
<a name="l02551"></a>02551 <span class="comment">/* note, shadepixel() rounds the coordinate, not the real sample info */</span>
<a name="l02552"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a1fc452525e32ed37705c35597b174f11">02552</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#a1fc452525e32ed37705c35597b174f11">ISB_getshadow</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d1/d08/structShadBuf.html">ShadBuf</a> *shb)
<a name="l02553"></a>02553 {
<a name="l02554"></a>02554     <span class="comment">/* if raytracing, we can&#39;t accept irregular shadow */</span>
<a name="l02555"></a>02555     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>==0) {
<a name="l02556"></a>02556         <a class="code" href="../../dd/df9/structISBData.html">ISBData</a> *isbdata= shb-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>];
<a name="l02557"></a>02557         
<a name="l02558"></a>02558         <span class="keywordflow">if</span> (isbdata) {
<a name="l02559"></a>02559             <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a> || isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a>) {
<a name="l02560"></a>02560                 <span class="keywordtype">int</span> x= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a> - isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#aec7bd65e2cefaf0f2b1d0f49c8be78e8">minx</a>;
<a name="l02561"></a>02561                 
<a name="l02562"></a>02562                 <span class="keywordflow">if</span> (x &gt;= 0 &amp;&amp; x &lt; isbdata-&gt;rectx) {
<a name="l02563"></a>02563                     <span class="keywordtype">int</span> y= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a> - isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#ae40171a59b7ca48f6ead476dc125b538">miny</a>;
<a name="l02564"></a>02564             
<a name="l02565"></a>02565                     <span class="keywordflow">if</span> (y &gt;= 0 &amp;&amp; y &lt; isbdata-&gt;recty) {
<a name="l02566"></a>02566                         <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>) {
<a name="l02567"></a>02567                             <span class="keywordtype">short</span> *sp= isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a> + y*isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a598172f720c295ebd86a7c3aa20cb44a">rectx</a> + x;
<a name="l02568"></a>02568                             <span class="keywordflow">return</span> *sp&gt;=4096?0.0f:1.0f - ((float)*sp)/4096.0f;
<a name="l02569"></a>02569                         }
<a name="l02570"></a>02570                         <span class="keywordflow">else</span> {
<a name="l02571"></a>02571                             <span class="keywordtype">int</span> sindex= y*isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a598172f720c295ebd86a7c3aa20cb44a">rectx</a> + x;
<a name="l02572"></a>02572                             <span class="keywordtype">int</span> obi= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> - <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.objectinstance;
<a name="l02573"></a>02573                             <a class="code" href="../../d7/d49/structISBShadfacA.html">ISBShadfacA</a> *isbsa= *(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a> + sindex);
<a name="l02574"></a>02574                             
<a name="l02575"></a>02575                             <span class="keywordflow">while</span> (isbsa) {
<a name="l02576"></a>02576                                 <span class="keywordflow">if</span> (isbsa-&gt;<a class="code" href="../../d7/d49/structISBShadfacA.html#adea8fae2c7ef7e3ff4c2f245a0fad4b0">facenr</a>==shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a0ec67e9acef04f5a86577ed06afc901f">facenr</a>+1 &amp;&amp; isbsa-&gt;<a class="code" href="../../d7/d49/structISBShadfacA.html#aca123316c04035306f102abca24d352a">obi</a>==obi)
<a name="l02577"></a>02577                                     <span class="keywordflow">return</span> isbsa-&gt;<a class="code" href="../../d7/d49/structISBShadfacA.html#a6a014186c45af84f5ab75b1465fbd23e">shadfac</a>&gt;=1.0f?0.0f:1.0f - isbsa-&gt;<a class="code" href="../../d7/d49/structISBShadfacA.html#a6a014186c45af84f5ab75b1465fbd23e">shadfac</a>;
<a name="l02578"></a>02578                                 isbsa= isbsa-&gt;<a class="code" href="../../d7/d49/structISBShadfacA.html#af9be5f06db05a2041a7159d269790eed">next</a>;
<a name="l02579"></a>02579                             }
<a name="l02580"></a>02580                         }
<a name="l02581"></a>02581                     }
<a name="l02582"></a>02582                 }
<a name="l02583"></a>02583             }
<a name="l02584"></a>02584         }
<a name="l02585"></a>02585     }
<a name="l02586"></a>02586     <span class="keywordflow">return</span> 1.0f;
<a name="l02587"></a>02587 }
<a name="l02588"></a>02588 
<a name="l02589"></a>02589 <span class="comment">/* part is supposed to be solid zbuffered (apixbuf==NULL) or transparent zbuffered */</span>
<a name="l02590"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#a6d37f8377c5bc3bc3572dbb4b933667c">02590</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#a87e76d77f5694b37ac9ec7fc1963affd">ISB_create</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa, <a class="code" href="../../d3/d49/structAPixstr.html">APixstr</a> *apixbuf)
<a name="l02591"></a>02591 {
<a name="l02592"></a>02592     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l02593"></a>02593     
<a name="l02594"></a>02594     <span class="comment">/* go over all lamps, and make the irregular buffers */</span>
<a name="l02595"></a>02595     <span class="keywordflow">for</span> (go=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights.first; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l02596"></a>02596         <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l02597"></a>02597         
<a name="l02598"></a>02598         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a> &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a140e58d774f55360506b8dd8bebeb553">LA_SHADBUF_IRREGULAR</a>) {
<a name="l02599"></a>02599             
<a name="l02600"></a>02600             <span class="comment">/* create storage for shadow, per thread */</span>
<a name="l02601"></a>02601             lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>]= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/df9/structISBData.html">ISBData</a>), <span class="stringliteral">&quot;isb data&quot;</span>);
<a name="l02602"></a>02602             
<a name="l02603"></a>02603             <span class="keywordflow">if</span> (apixbuf)
<a name="l02604"></a>02604                 <a class="code" href="../../d0/de2/shadbuf_8c.html#acbdbc8e10cbed128b618b293df85f643">isb_make_buffer_transp</a>(pa, apixbuf, lar);
<a name="l02605"></a>02605             <span class="keywordflow">else</span>
<a name="l02606"></a>02606                 <a class="code" href="../../d0/de2/shadbuf_8c.html#a25183f93eb253475b99c5129e7af59e3">isb_make_buffer</a>(pa, lar);
<a name="l02607"></a>02607         }
<a name="l02608"></a>02608     }
<a name="l02609"></a>02609 }
<a name="l02610"></a>02610 
<a name="l02611"></a>02611 
<a name="l02612"></a>02612 <span class="comment">/* end of part rendering, free stored shadow data for this thread from all lamps */</span>
<a name="l02613"></a><a class="code" href="../../d0/de2/shadbuf_8c.html#acb1f35c7f3e79ad0390f8e26ea35a495">02613</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/d30/shadbuf_8h.html#acb1f35c7f3e79ad0390f8e26ea35a495">ISB_free</a>(<a class="code" href="../../d2/dd1/structRenderPart.html">RenderPart</a> *pa)
<a name="l02614"></a>02614 {
<a name="l02615"></a>02615     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l02616"></a>02616     
<a name="l02617"></a>02617     <span class="comment">/* go over all lamps, and free the irregular buffers */</span>
<a name="l02618"></a>02618     <span class="keywordflow">for</span> (go=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.lights.first; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l02619"></a>02619         <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l02620"></a>02620         
<a name="l02621"></a>02621         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a55ba7e9dc61979b7097cb11dace90bdb">LA_SPOT</a> &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a> &amp;&amp; lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#afc36f0b635423110c27f15d00dd3de08">buftype</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a140e58d774f55360506b8dd8bebeb553">LA_SHADBUF_IRREGULAR</a>) {
<a name="l02622"></a>02622             <a class="code" href="../../dd/df9/structISBData.html">ISBData</a> *isbdata= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>];
<a name="l02623"></a>02623 
<a name="l02624"></a>02624             <span class="keywordflow">if</span> (isbdata) {
<a name="l02625"></a>02625                 <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>)
<a name="l02626"></a>02626                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a14042ed4c2b588ae85a8caf6d2c33135">shadfacs</a>);
<a name="l02627"></a>02627                 <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a>)
<a name="l02628"></a>02628                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a18505663a8bbebbe4436f107657ff133">shadfaca</a>);
<a name="l02629"></a>02629                 
<a name="l02630"></a>02630                 <span class="keywordflow">if</span> (isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>)
<a name="l02631"></a>02631                     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(isbdata-&gt;<a class="code" href="../../dd/df9/structISBData.html#a282efc741bfae4ec47f7eeec1ce6982f">memarena</a>);
<a name="l02632"></a>02632                 
<a name="l02633"></a>02633                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(isbdata);
<a name="l02634"></a>02634                 lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a684a219ed44c13ef112b96d27e5f731b">isb_result</a>[pa-&gt;<a class="code" href="../../d2/dd1/structRenderPart.html#a9ccb72018eacaa63763b6329494572b3">thread</a>]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02635"></a>02635             }
<a name="l02636"></a>02636         }
<a name="l02637"></a>02637     }
<a name="l02638"></a>02638 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:54 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
