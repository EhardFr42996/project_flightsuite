<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: KX_ObstacleSimulation.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">KX_ObstacleSimulation.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d0/dad/KX__ObstacleSimulation_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Simulation for obstacle avoidance behavior</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00007"></a>00007 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00008"></a>00008 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00009"></a>00009 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00018"></a>00018 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html">KX_ObstacleSimulation.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/dc7/KX__NavMeshObject_8h.html">KX_NavMeshObject.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/de4/KX__PythonInit_8h.html">KX_PythonInit.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">namespace</span>
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033     <span class="keyword">inline</span> <span class="keywordtype">float</span> perp(<span class="keyword">const</span> <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a>&amp; a, <span class="keyword">const</span> <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a>&amp; b) { <span class="keywordflow">return</span> a.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a9eaf883865345bdf8b8030f4b3d73aae">x</a>()*b.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a65ebe38022fd0de66a20a7207c53ac92">y</a>() - a.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a65ebe38022fd0de66a20a7207c53ac92">y</a>()*b.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a9eaf883865345bdf8b8030f4b3d73aae">x</a>(); }
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(<span class="keywordtype">float</span> x) { <span class="keywordflow">return</span> x*x; }
<a name="l00036"></a>00036     <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> b, <span class="keywordtype">float</span> t) { <span class="keywordflow">return</span> a + (b-a)*t; }
<a name="l00037"></a>00037     <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> mn, <span class="keywordtype">float</span> mx) { <span class="keywordflow">return</span> a &lt; mn ? mn : (a &gt; mx ? mx : a); }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="keyword">inline</span> <span class="keywordtype">float</span> vdistsqr(<span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { <span class="keywordflow">return</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(b[0]-a[0]) + <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(b[1]-a[1]); }
<a name="l00040"></a>00040     <span class="keyword">inline</span> <span class="keywordtype">float</span> vdist(<span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(vdistsqr(a,b)); }
<a name="l00041"></a>00041     <span class="keyword">inline</span> <span class="keywordtype">void</span> vcpy(<span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { a[0]=b[0]; a[1]=b[1]; }
<a name="l00042"></a>00042     <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { <span class="keywordflow">return</span> a[0]*b[0] + a[1]*b[1]; }
<a name="l00043"></a>00043     <span class="keyword">inline</span> <span class="keywordtype">float</span> vperp(<span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { <span class="keywordflow">return</span> a[0]*b[1] - a[1]*b[0]; }
<a name="l00044"></a>00044     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(<span class="keywordtype">float</span>* v, <span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { v[0] = a[0]-b[0]; v[1] = a[1]-b[1]; }
<a name="l00045"></a>00045     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d91/mikktspace_8c.html#a474a0fb9a82cec5583879723b22a715d">vadd</a>(<span class="keywordtype">float</span>* v, <span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b) { v[0] = a[0]+b[0]; v[1] = a[1]+b[1]; }
<a name="l00046"></a>00046     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d91/mikktspace_8c.html#a4e650bfec2292ae7c1ca023c18a14faf">vscale</a>(<span class="keywordtype">float</span>* v, <span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span> s) { v[0] = a[0]*s; v[1] = a[1]*s; }
<a name="l00047"></a>00047     <span class="keyword">inline</span> <span class="keywordtype">void</span> vset(<span class="keywordtype">float</span>* v, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y) { v[0]=x; v[1]=y; }
<a name="l00048"></a>00048     <span class="keyword">inline</span> <span class="keywordtype">float</span> vlensqr(<span class="keyword">const</span> <span class="keywordtype">float</span>* v) { <span class="keywordflow">return</span> <a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(v,v); }
<a name="l00049"></a>00049     <span class="keyword">inline</span> <span class="keywordtype">float</span> vlen(<span class="keyword">const</span> <span class="keywordtype">float</span>* v) { <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(vlensqr(v)); }
<a name="l00050"></a>00050     <span class="keyword">inline</span> <span class="keywordtype">void</span> vlerp(<span class="keywordtype">float</span>* v, <span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b, <span class="keywordtype">float</span> t) { v[0] = <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(a[0], b[0], t); v[1] = <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(a[1], b[1], t); }
<a name="l00051"></a>00051     <span class="keyword">inline</span> <span class="keywordtype">void</span> vmad(<span class="keywordtype">float</span>* v, <span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b, <span class="keywordtype">float</span> s) { v[0] = a[0] + b[0]*s; v[1] = a[1] + b[1]*s; }
<a name="l00052"></a>00052     <span class="keyword">inline</span> <span class="keywordtype">void</span> vnorm(<span class="keywordtype">float</span>* v)
<a name="l00053"></a>00053     {
<a name="l00054"></a>00054         <span class="keywordtype">float</span> d = vlen(v);
<a name="l00055"></a>00055         <span class="keywordflow">if</span> (d &gt; 0.0001f)
<a name="l00056"></a>00056         {
<a name="l00057"></a>00057             d = 1.0f/d;
<a name="l00058"></a>00058             v[0] *= d;
<a name="l00059"></a>00059             v[1] *= d;
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062 }
<a name="l00063"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a7554756e04638b1cf677d72d78a5b486">00063</a> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a7554756e04638b1cf677d72d78a5b486">triarea</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* a, <span class="keyword">const</span> <span class="keywordtype">float</span>* b, <span class="keyword">const</span> <span class="keywordtype">float</span>* c)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <span class="keywordflow">return</span> (b[0]*a[1] - a[0]*b[1]) + (c[0]*b[1] - b[0]*c[1]) + (a[0]*c[1] - c[0]*a[1]);
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a56119dadc936f711eecc892ccd6aed42">00068</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a56119dadc936f711eecc892ccd6aed42">closestPtPtSeg</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* pt,
<a name="l00069"></a>00069                     <span class="keyword">const</span> <span class="keywordtype">float</span>* sp, <span class="keyword">const</span> <span class="keywordtype">float</span>* sq,
<a name="l00070"></a>00070                     <span class="keywordtype">float</span>&amp; t)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072     <span class="keywordtype">float</span> dir[2],<a class="code" href="../../d0/dbc/namespaceKDL.html#a0227d72a9cfff5e6065944ebb04f9e77">diff</a>[3];
<a name="l00073"></a>00073     <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(dir,sq,sp);
<a name="l00074"></a>00074     <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(diff,pt,sp);
<a name="l00075"></a>00075     t = <a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(diff,dir);
<a name="l00076"></a>00076     <span class="keywordflow">if</span> (t &lt;= 0.0f) { t = 0; <span class="keywordflow">return</span>; }
<a name="l00077"></a>00077     <span class="keywordtype">float</span> d = <a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(dir,dir);
<a name="l00078"></a>00078     <span class="keywordflow">if</span> (t &gt;= d) { t = 1; <span class="keywordflow">return</span>; }
<a name="l00079"></a>00079     t /= d;
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aba8c7acebeac2fbca99f33e87f712825">00082</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aba8c7acebeac2fbca99f33e87f712825">distPtSegSqr</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* pt, <span class="keyword">const</span> <span class="keywordtype">float</span>* sp, <span class="keyword">const</span> <span class="keywordtype">float</span>* sq)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084     <span class="keywordtype">float</span> t;
<a name="l00085"></a>00085     <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a56119dadc936f711eecc892ccd6aed42">closestPtPtSeg</a>(pt, sp,sq, t);
<a name="l00086"></a>00086     <span class="keywordtype">float</span> np[2];
<a name="l00087"></a>00087     vlerp(np, sp,sq, t);
<a name="l00088"></a>00088     <span class="keywordflow">return</span> vdistsqr(pt,np);
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">00091</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">sweepCircleCircle</a>(<span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; pos0, <span class="keyword">const</span> <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> r0, <span class="keyword">const</span> <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a>&amp; v,
<a name="l00092"></a>00092                       <span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; pos1, <span class="keyword">const</span> <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> r1,
<a name="l00093"></a>00093                       <span class="keywordtype">float</span>&amp; tmin, <span class="keywordtype">float</span>&amp; tmax)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d1d/unit_8c.html#a6ebf6899d6c1c8b7b9d09be872c05aae">EPS</a> = 0.0001f;
<a name="l00096"></a>00096     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> c0(pos0.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), pos0.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00097"></a>00097     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> c1(pos1.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), pos1.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00098"></a>00098     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> s = c1 - c0;
<a name="l00099"></a>00099     <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a>  r = r0+r1;
<a name="l00100"></a>00100     <span class="keywordtype">float</span> c = s.<a class="code" href="../../d6/d81/classMT__Vector2.html#a7eda1866d71f528391ec21564e497962">length2</a>() - r*r;
<a name="l00101"></a>00101     <span class="keywordtype">float</span> a = v.<a class="code" href="../../d6/d81/classMT__Vector2.html#a7eda1866d71f528391ec21564e497962">length2</a>();
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (a &lt; EPS) <span class="keywordflow">return</span> 0;  <span class="comment">// not moving</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">// Overlap, calc time to exit.</span>
<a name="l00105"></a>00105     <span class="keywordtype">float</span> b = <a class="code" href="../../d7/d84/MT__Vector2_8h.html#aa60e99d8db06d9069987d1cc6a1a220a">MT_dot</a>(v,s);
<a name="l00106"></a>00106     <span class="keywordtype">float</span> d = b*b - a*c;
<a name="l00107"></a>00107     <span class="keywordflow">if</span> (d &lt; 0.0f) <span class="keywordflow">return</span> 0; <span class="comment">// no intersection.</span>
<a name="l00108"></a>00108     tmin = (b - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d)) / a;
<a name="l00109"></a>00109     tmax = (b + <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d)) / a;
<a name="l00110"></a>00110     <span class="keywordflow">return</span> 1;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a9893ed532851b605f71129f4a928b790">00113</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a9893ed532851b605f71129f4a928b790">sweepCircleSegment</a>(<span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; pos0, <span class="keyword">const</span> <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> r0, <span class="keyword">const</span> <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a>&amp; v,
<a name="l00114"></a>00114                        <span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; pa, <span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; pb, <span class="keyword">const</span> <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> sr,
<a name="l00115"></a>00115                        <span class="keywordtype">float</span>&amp; tmin, <span class="keywordtype">float</span> &amp;tmax)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117     <span class="comment">// equation parameters</span>
<a name="l00118"></a>00118     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> c0(pos0.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), pos0.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00119"></a>00119     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> sa(pa.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), pa.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00120"></a>00120     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> sb(pb.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), pb.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00121"></a>00121     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> <a class="code" href="../../d2/d6c/mball_8c.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a> = sb-sa;
<a name="l00122"></a>00122     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ae42219072d798876e6b08e6b78614ff6">H</a> = c0-sa;
<a name="l00123"></a>00123     <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> radius = r0+sr;
<a name="l00124"></a>00124     <span class="keywordtype">float</span> l2 = L.length2();
<a name="l00125"></a>00125     <span class="keywordtype">float</span> r2 = radius * radius;
<a name="l00126"></a>00126     <span class="keywordtype">float</span> dl = perp(v, L);
<a name="l00127"></a>00127     <span class="keywordtype">float</span> hl = perp(H, L);
<a name="l00128"></a>00128     <span class="keywordtype">float</span> a = dl * dl;
<a name="l00129"></a>00129     <span class="keywordtype">float</span> b = 2.0f * hl * dl;
<a name="l00130"></a>00130     <span class="keywordtype">float</span> c = hl * hl - (r2 * l2);
<a name="l00131"></a>00131     <span class="keywordtype">float</span> d = (b*b) - (4.0f * a * c);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">// infinite line missed by infinite ray.</span>
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (d &lt; 0.0f)
<a name="l00135"></a>00135         <span class="keywordflow">return</span> 0;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     d = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d);
<a name="l00138"></a>00138     tmin = (-b - d) / (2.0f * a);
<a name="l00139"></a>00139     tmax = (-b + d) / (2.0f * a);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">// line missed by ray range.</span>
<a name="l00142"></a>00142     <span class="comment">/*  if (tmax &lt; 0.0f || tmin &gt; 1.0f)</span>
<a name="l00143"></a>00143 <span class="comment">    return 0;*/</span>
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="comment">// find what part of the ray was collided.</span>
<a name="l00146"></a>00146     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> Pedge;
<a name="l00147"></a>00147     Pedge = c0+v*tmin;
<a name="l00148"></a>00148     H = Pedge - sa;
<a name="l00149"></a>00149     <span class="keywordtype">float</span> e0 = <a class="code" href="../../d7/d84/MT__Vector2_8h.html#aa60e99d8db06d9069987d1cc6a1a220a">MT_dot</a>(H, L) / l2;
<a name="l00150"></a>00150     Pedge = c0 + v*tmax;
<a name="l00151"></a>00151     H = Pedge - sa;
<a name="l00152"></a>00152     <span class="keywordtype">float</span> e1 = <a class="code" href="../../d7/d84/MT__Vector2_8h.html#aa60e99d8db06d9069987d1cc6a1a220a">MT_dot</a>(H, L) / l2;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (e0 &lt; 0.0f || e1 &lt; 0.0f)
<a name="l00155"></a>00155     {
<a name="l00156"></a>00156         <span class="keywordtype">float</span> ctmin, ctmax;
<a name="l00157"></a>00157         <span class="keywordflow">if</span> (<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">sweepCircleCircle</a>(pos0, r0, v, pa, sr, ctmin, ctmax))
<a name="l00158"></a>00158         {
<a name="l00159"></a>00159             <span class="keywordflow">if</span> (e0 &lt; 0.0f &amp;&amp; ctmin &gt; tmin)
<a name="l00160"></a>00160                 tmin = ctmin;
<a name="l00161"></a>00161             <span class="keywordflow">if</span> (e1 &lt; 0.0f &amp;&amp; ctmax &lt; tmax)
<a name="l00162"></a>00162                 tmax = ctmax;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164         <span class="keywordflow">else</span>
<a name="l00165"></a>00165         {
<a name="l00166"></a>00166             <span class="keywordflow">return</span> 0;
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (e0 &gt; 1.0f || e1 &gt; 1.0f)
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172         <span class="keywordtype">float</span> ctmin, ctmax;
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">sweepCircleCircle</a>(pos0, r0, v, pb, sr, ctmin, ctmax))
<a name="l00174"></a>00174         {
<a name="l00175"></a>00175             <span class="keywordflow">if</span> (e0 &gt; 1.0f &amp;&amp; ctmin &gt; tmin)
<a name="l00176"></a>00176                 tmin = ctmin;
<a name="l00177"></a>00177             <span class="keywordflow">if</span> (e1 &gt; 1.0f &amp;&amp; ctmax &lt; tmax)
<a name="l00178"></a>00178                 tmax = ctmax;
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180         <span class="keywordflow">else</span>
<a name="l00181"></a>00181         {
<a name="l00182"></a>00182             <span class="keywordflow">return</span> 0;
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">return</span> 1;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a28240180c47d4b70e397743ee87b3919">00189</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a28240180c47d4b70e397743ee87b3919">inBetweenAngle</a>(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> amin, <span class="keywordtype">float</span> amax, <span class="keywordtype">float</span>&amp; t)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <span class="keywordflow">if</span> (amax &lt; amin) amax += (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (a &lt; amin-(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) a += (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (a &gt; amin+(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) a -= (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00194"></a>00194     <span class="keywordflow">if</span> (a &gt;= amin &amp;&amp; a &lt; amax)
<a name="l00195"></a>00195     {
<a name="l00196"></a>00196         t = (a-amin) / (amax-amin);
<a name="l00197"></a>00197         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ad9ee34fa54fd33678431477f699ff3ae">00202</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ad9ee34fa54fd33678431477f699ff3ae">interpolateToi</a>(<span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* dir, <span class="keyword">const</span> <span class="keywordtype">float</span>* toi, <span class="keyword">const</span> <span class="keywordtype">int</span> ntoi)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; ntoi; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00205"></a>00205     {
<a name="l00206"></a>00206         <span class="keywordtype">int</span> <a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a> = (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+1) % ntoi;
<a name="l00207"></a>00207         <span class="keywordtype">float</span> t;
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a28240180c47d4b70e397743ee87b3919">inBetweenAngle</a>(a, dir[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>], dir[next], t))
<a name="l00209"></a>00209         {
<a name="l00210"></a>00210             <span class="keywordflow">return</span> <a class="code" href="../../dd/d05/noise_8c.html#a9e745f07b0955e11db38c424a9e6e805">lerp</a>(toi[i], toi[next], t);
<a name="l00211"></a>00211         }
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     <span class="keywordflow">return</span> 0;
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a76bacc6c6a7412e35a902ad0baac88d4">00216</a> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a76bacc6c6a7412e35a902ad0baac88d4">KX_ObstacleSimulation::KX_ObstacleSimulation</a>(<a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> levelHeight, <span class="keywordtype">bool</span> enableVisualization)
<a name="l00217"></a>00217 :   m_levelHeight(levelHeight)
<a name="l00218"></a>00218 ,   m_enableVisualization(enableVisualization)
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#aae2cf4320bf46952a4ebe02a951141ad">00223</a> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#aae2cf4320bf46952a4ebe02a951141ad">KX_ObstacleSimulation::~KX_ObstacleSimulation</a>()
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227         <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obs = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00228"></a>00228         <span class="keyword">delete</span> obs;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.clear();
<a name="l00231"></a>00231 }
<a name="l00232"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a3b64bd97ee0c5467d045167a2b865f50">00232</a> <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a3b64bd97ee0c5467d045167a2b865f50">KX_ObstacleSimulation::CreateObstacle</a>(<a class="code" href="../../d1/d73/classKX__GameObject.html">KX_GameObject</a>* gameobj)
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234     <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obstacle = <span class="keyword">new</span> <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>();
<a name="l00235"></a>00235     obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a> = gameobj;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     vset(obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>, 0,0);
<a name="l00238"></a>00238     vset(obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>, 0,0);
<a name="l00239"></a>00239     vset(obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>, 0,0);
<a name="l00240"></a>00240     vset(obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>, 0,0);
<a name="l00241"></a>00241     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#abf7ed28107261cb5bc034baf805633ce">VEL_HIST_SIZE</a>; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00242"></a>00242         vset(&amp;obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad6a123dde81e0b485cdef3cd2ef91c07">hvel</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*2], 0,0);
<a name="l00243"></a>00243     obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#aa19b960cd8e5d2e2a28c1358ce845ac9">hhead</a> = 0;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     gameobj-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#a9a674d4b51b9c634af5d30e91648dc2f">RegisterObstacle</a>(<span class="keyword">this</span>);
<a name="l00246"></a>00246     <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.push_back(obstacle);
<a name="l00247"></a>00247     <span class="keywordflow">return</span> obstacle;
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a9e47ed5ec91bc82b06e1e7bacafb822e">00250</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a9e47ed5ec91bc82b06e1e7bacafb822e">KX_ObstacleSimulation::AddObstacleForObj</a>(<a class="code" href="../../d1/d73/classKX__GameObject.html">KX_GameObject</a>* gameobj)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obstacle = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a3b64bd97ee0c5467d045167a2b865f50">CreateObstacle</a>(gameobj);
<a name="l00253"></a>00253     <span class="keyword">struct </span><a class="code" href="../../de/de7/structObject.html">Object</a>* blenderobject = gameobj-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#a33f8953dd41b83078db209e44d448b7c">GetBlenderObject</a>();
<a name="l00254"></a>00254     obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a1f98f24e7dc907ad856df05cbe1d98d9">m_type</a> = <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a17f8929723b92b81fc5f0e9b369125da">KX_OBSTACLE_OBJ</a>;
<a name="l00255"></a>00255     obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a> = <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbea8622ed20ede0bce7f4243a85db706d6c">KX_OBSTACLE_CIRCLE</a>;
<a name="l00256"></a>00256     obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a> = blenderobject-&gt;<a class="code" href="../../de/de7/structObject.html#ad8f05321c8a0b9ab7f8a5bdd73e1fc78">obstacleRad</a>;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a1d37a2aa87d1ccc3be6f4fe71272cdde">00259</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a1d37a2aa87d1ccc3be6f4fe71272cdde">KX_ObstacleSimulation::AddObstaclesForNavMesh</a>(<a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* navmeshobj)
<a name="l00260"></a>00260 {   
<a name="l00261"></a>00261     dtStatNavMesh* navmesh = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#a92b8e82918f7240df9ffd704fac841c3">GetNavMesh</a>();
<a name="l00262"></a>00262     <span class="keywordflow">if</span> (navmesh)
<a name="l00263"></a>00263     {
<a name="l00264"></a>00264         <span class="keywordtype">int</span> npoly = navmesh-&gt;getPolyCount();
<a name="l00265"></a>00265         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> pi=0; pi&lt;npoly; pi++)
<a name="l00266"></a>00266         {
<a name="l00267"></a>00267             <span class="keyword">const</span> dtStatPoly* poly = navmesh-&gt;getPoly(pi);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, j = (<span class="keywordtype">int</span>)poly-&gt;nv-1; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; (<span class="keywordtype">int</span>)poly-&gt;nv; j = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00270"></a>00270             {   
<a name="l00271"></a>00271                 <span class="keywordflow">if</span> (poly-&gt;n[j]) <span class="keywordflow">continue</span>;
<a name="l00272"></a>00272                 <span class="keyword">const</span> <span class="keywordtype">float</span>* vj = navmesh-&gt;getVertex(poly-&gt;v[j]);
<a name="l00273"></a>00273                 <span class="keyword">const</span> <span class="keywordtype">float</span>* vi = navmesh-&gt;getVertex(poly-&gt;v[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l00274"></a>00274         
<a name="l00275"></a>00275                 <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obstacle = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a3b64bd97ee0c5467d045167a2b865f50">CreateObstacle</a>(navmeshobj);
<a name="l00276"></a>00276                 obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a1f98f24e7dc907ad856df05cbe1d98d9">m_type</a> = <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a>;
<a name="l00277"></a>00277                 obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a> = <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a>;
<a name="l00278"></a>00278                 obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a> = <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a>(vj[0], vj[2], vj[1]);
<a name="l00279"></a>00279                 obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a3b368fe45a27097e283d48ec5694cfba">m_pos2</a> = <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a>(vi[0], vi[2], vi[1]);
<a name="l00280"></a>00280                 obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a> = 0;
<a name="l00281"></a>00281             }
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#af7f8dff2bb9a4bfa4a6f06761ae4e69b">00286</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#af7f8dff2bb9a4bfa4a6f06761ae4e69b">KX_ObstacleSimulation::DestroyObstacleForObj</a>(<a class="code" href="../../d1/d73/classKX__GameObject.html">KX_GameObject</a>* gameobj)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size(); )
<a name="l00289"></a>00289     {
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_gameObj == gameobj)
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292             <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obstacle = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00293"></a>00293             obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#a1f7420bd58e9ae064b0047f5cb2fad72">UnregisterObstacle</a>();
<a name="l00294"></a>00294             <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.back();
<a name="l00295"></a>00295             <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.pop_back();
<a name="l00296"></a>00296             <span class="keyword">delete</span> obstacle;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <span class="keywordflow">else</span>
<a name="l00299"></a>00299             <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 
<a name="l00303"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#af36e511a4e04afe7b2919b410c5d8cd5">00303</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#af36e511a4e04afe7b2919b410c5d8cd5">KX_ObstacleSimulation::UpdateObstacles</a>()
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00306"></a>00306     {
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_type==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a> || <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_shape==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a>)
<a name="l00308"></a>00308             <span class="keywordflow">continue</span>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obs = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00311"></a>00311         obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a> = obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#afa83f00c96f7d08511a385730442019b">NodeGetWorldPosition</a>();
<a name="l00312"></a>00312         obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>[0] = obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#afca1281b03a024a167327c7344ec0812">GetLinearVelocity</a>().<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>();
<a name="l00313"></a>00313         obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>[1] = obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#afca1281b03a024a167327c7344ec0812">GetLinearVelocity</a>().<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>();
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">// Update velocity history and calculate perceived (average) velocity.</span>
<a name="l00316"></a>00316         vcpy(&amp;obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad6a123dde81e0b485cdef3cd2ef91c07">hvel</a>[obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#aa19b960cd8e5d2e2a28c1358ce845ac9">hhead</a>*2], obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>);
<a name="l00317"></a>00317         obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#aa19b960cd8e5d2e2a28c1358ce845ac9">hhead</a> = (obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#aa19b960cd8e5d2e2a28c1358ce845ac9">hhead</a>+1) % <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#abf7ed28107261cb5bc034baf805633ce">VEL_HIST_SIZE</a>;
<a name="l00318"></a>00318         vset(obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>,0,0);
<a name="l00319"></a>00319         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#abf7ed28107261cb5bc034baf805633ce">VEL_HIST_SIZE</a>; ++j)
<a name="l00320"></a>00320             <a class="code" href="../../d8/d91/mikktspace_8c.html#a474a0fb9a82cec5583879723b22a715d">vadd</a>(obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>, obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>, &amp;obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad6a123dde81e0b485cdef3cd2ef91c07">hvel</a>[j*2]);
<a name="l00321"></a>00321         <a class="code" href="../../d8/d91/mikktspace_8c.html#a4e650bfec2292ae7c1ca023c18a14faf">vscale</a>(obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>, obs-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>, 1.0f/VEL_HIST_SIZE);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a5b40d03eecad4ebdb23c5370f8031a36">00325</a> <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a5b40d03eecad4ebdb23c5370f8031a36">KX_ObstacleSimulation::GetObstacle</a>(<a class="code" href="../../d1/d73/classKX__GameObject.html">KX_GameObject</a>* gameobj)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00328"></a>00328     {
<a name="l00329"></a>00329         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_gameObj == gameobj)
<a name="l00330"></a>00330             <span class="keywordflow">return</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a661535e6992956ef7a6d381d31690013">00336</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a661535e6992956ef7a6d381d31690013">KX_ObstacleSimulation::AdjustObstacleVelocity</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, 
<a name="l00337"></a>00337                                         <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; velocity, <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> maxDeltaSpeed,<a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> maxDeltaAngle)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a2a3048a3ecea24ed8f2c6a5bab57484c">00341</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a2a3048a3ecea24ed8f2c6a5bab57484c">KX_ObstacleSimulation::DrawObstacles</a>()
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a94d0039341b55e96fe6a784f8399f69d">m_enableVisualization</a>)
<a name="l00344"></a>00344         <span class="keywordflow">return</span>;
<a name="l00345"></a>00345     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a> bluecolor(0,0,1);
<a name="l00346"></a>00346     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a> normal(0.0, 0.0, 1.0);
<a name="l00347"></a>00347     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> SECTORS_NUM = 32;
<a name="l00348"></a>00348     <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size(); <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00349"></a>00349     {
<a name="l00350"></a>00350         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_shape==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a>)
<a name="l00351"></a>00351         {
<a name="l00352"></a>00352             <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p1 = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_pos;
<a name="l00353"></a>00353             <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p2 = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_pos2;
<a name="l00354"></a>00354             <span class="comment">//apply world transform</span>
<a name="l00355"></a>00355             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_type == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a>)
<a name="l00356"></a>00356             {
<a name="l00357"></a>00357                 <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* navmeshobj = <span class="keyword">static_cast&lt;</span><a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>*<span class="keyword">&gt;</span>(<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_gameObj);
<a name="l00358"></a>00358                 p1 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p1);
<a name="l00359"></a>00359                 p2 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p2);
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362             <a class="code" href="../../d6/dc2/KX__PythonInit_8cpp.html#a10e53bea817147a2671bbdef43805f20">KX_RasterizerDrawDebugLine</a>(p1, p2, bluecolor);
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_shape==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbea8622ed20ede0bce7f4243a85db706d6c">KX_OBSTACLE_CIRCLE</a>)
<a name="l00365"></a>00365         {
<a name="l00366"></a>00366             <a class="code" href="../../d6/dc2/KX__PythonInit_8cpp.html#a9805961510e2a98dc30f9f7b254f809c">KX_RasterizerDrawDebugCircle</a>(<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_pos, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;m_rad, bluecolor,
<a name="l00367"></a>00367                                         normal, SECTORS_NUM);
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369     }   
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a73e77867db7da834e6fc0b4507753d12">00372</a> <span class="keyword">static</span> <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a73e77867db7da834e6fc0b4507753d12">nearestPointToObstacle</a>(<a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a>&amp; pos ,<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* obstacle)
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374     <span class="keywordflow">switch</span> (obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a>)
<a name="l00375"></a>00375     {
<a name="l00376"></a>00376     <span class="keywordflow">case</span> <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a> :
<a name="l00377"></a>00377     {
<a name="l00378"></a>00378         <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a> ab = obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a3b368fe45a27097e283d48ec5694cfba">m_pos2</a> - obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>;
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (!ab.<a class="code" href="../../d6/d9d/classMT__Vector3.html#aac38f1508b7b11bd90127a6e939356fb">fuzzyZero</a>())
<a name="l00380"></a>00380         {
<a name="l00381"></a>00381             <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a> abdir = ab.<a class="code" href="../../d6/d9d/classMT__Vector3.html#a03ee15a375c6cfa6c9a4a1e06409594a">normalized</a>();
<a name="l00382"></a>00382             <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>  v = pos - obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>;
<a name="l00383"></a>00383             <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> proj = abdir.<a class="code" href="../../d6/d9d/classMT__Vector3.html#a46a95b173394ecf471432277a14135df">dot</a>(v);
<a name="l00384"></a>00384             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(proj, 0, ab.<a class="code" href="../../d6/d9d/classMT__Vector3.html#a2a961afdd0baa69b75b8184086b8e922">length</a>());
<a name="l00385"></a>00385             <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> res = obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a> + abdir*proj;
<a name="l00386"></a>00386             <span class="keywordflow">return</span> res;
<a name="l00387"></a>00387         }       
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     <span class="keywordflow">case</span> <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbea8622ed20ede0bce7f4243a85db706d6c">KX_OBSTACLE_CIRCLE</a> :
<a name="l00390"></a>00390     <span class="keywordflow">default</span>:
<a name="l00391"></a>00391         <span class="keywordflow">return</span> obstacle-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>;
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ae37e295bd1d8e0316f34f4f54146de6a">00395</a> <span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ae37e295bd1d8e0316f34f4f54146de6a">filterObstacle</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* otherObst,
<a name="l00396"></a>00396                             <span class="keywordtype">float</span> levelHeight)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <span class="comment">//filter obstacles by type</span>
<a name="l00399"></a>00399     <span class="keywordflow">if</span> ( (otherObst == activeObst) ||
<a name="l00400"></a>00400         (otherObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a1f98f24e7dc907ad856df05cbe1d98d9">m_type</a>==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a> &amp;&amp; otherObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>!=activeNavMeshObj) )
<a name="l00401"></a>00401         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">//filter obstacles by position</span>
<a name="l00404"></a>00404     <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a> = <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a73e77867db7da834e6fc0b4507753d12">nearestPointToObstacle</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, otherObst);
<a name="l00405"></a>00405     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>.<a class="code" href="../../d8/da2/classMT__Tuple3.html#af9fc03727b4886fdc3492c2e4f3c8d79">z</a>() - p.<a class="code" href="../../d8/da2/classMT__Tuple3.html#af9fc03727b4886fdc3492c2e4f3c8d79">z</a>()) &gt; levelHeight)
<a name="l00406"></a>00406         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00412"></a><a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa6a0ebd2cd02fa247f28419e66a01585">00412</a> <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa6a0ebd2cd02fa247f28419e66a01585">KX_ObstacleSimulationTOI::KX_ObstacleSimulationTOI</a>(<a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> levelHeight, <span class="keywordtype">bool</span> enableVisualization)
<a name="l00413"></a>00413 :   <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html">KX_ObstacleSimulation</a>(levelHeight, enableVisualization),
<a name="l00414"></a>00414     m_maxSamples(32),
<a name="l00415"></a>00415     m_minToi(0.0f),
<a name="l00416"></a>00416     m_maxToi(0.0f),
<a name="l00417"></a>00417     m_velWeight(1.0f),
<a name="l00418"></a>00418     m_curVelWeight(1.0f),
<a name="l00419"></a>00419     m_toiWeight(1.0f),
<a name="l00420"></a>00420     m_collisionWeight(1.0f)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 
<a name="l00425"></a><a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a1cdb26f58f778f7fc4313bf4aa3fc2eb">00425</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a1cdb26f58f778f7fc4313bf4aa3fc2eb">KX_ObstacleSimulationTOI::AdjustObstacleVelocity</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, 
<a name="l00426"></a>00426                                                            <a class="code" href="../../d6/d9d/classMT__Vector3.html">MT_Vector3</a>&amp; velocity, <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> maxDeltaSpeed, <a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> maxDeltaAngle)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     <span class="keywordtype">int</span> nobs = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size();
<a name="l00429"></a>00429     <span class="keywordtype">int</span> obstidx = <a class="code" href="../../d0/dea/sp__coletree_8c.html#ae3d5811c1f73da8bff145a1dcd88ef69">std::find</a>(<a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.begin(), <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.end(), activeObst) - <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.begin();
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (obstidx == nobs)
<a name="l00431"></a>00431         <span class="keywordflow">return</span>;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     vset(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>, velocity.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), velocity.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">//apply RVO</span>
<a name="l00436"></a>00436     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a30c0d0ac646d276689c4051c663f70e9">sampleRVO</a>(activeObst, activeNavMeshObj, maxDeltaAngle);
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="comment">// Fake dynamic constraint.</span>
<a name="l00439"></a>00439     <span class="keywordtype">float</span> dv[2];
<a name="l00440"></a>00440     <span class="keywordtype">float</span> vel[2];
<a name="l00441"></a>00441     <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(dv, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>);
<a name="l00442"></a>00442     <span class="keywordtype">float</span> ds = vlen(dv);
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (ds &gt; maxDeltaSpeed || ds&lt;-maxDeltaSpeed)
<a name="l00444"></a>00444         <a class="code" href="../../d8/d91/mikktspace_8c.html#a4e650bfec2292ae7c1ca023c18a14faf">vscale</a>(dv, dv, <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(maxDeltaSpeed/ds));
<a name="l00445"></a>00445     <a class="code" href="../../d8/d91/mikktspace_8c.html#a474a0fb9a82cec5583879723b22a715d">vadd</a>(vel, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>, dv);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     velocity.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>() = vel[0];
<a name="l00448"></a>00448     velocity.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>() = vel[1];  
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00452"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1e1a516270ceeae42909aaca8f36d3e4">00452</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1e1a516270ceeae42909aaca8f36d3e4">AVOID_MAX_STEPS</a> = 128;
<a name="l00453"></a><a class="code" href="../../dd/dac/structTOICircle.html">00453</a> <span class="keyword">struct </span><a class="code" href="../../dd/dac/structTOICircle.html">TOICircle</a>
<a name="l00454"></a>00454 {
<a name="l00455"></a><a class="code" href="../../dd/dac/structTOICircle.html#a47eb84afb4cc43589b5362ea22843500">00455</a>     <a class="code" href="../../dd/dac/structTOICircle.html#a47eb84afb4cc43589b5362ea22843500">TOICircle</a>() : <a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">n</a>(0), <a class="code" href="../../dd/dac/structTOICircle.html#aa0eba629cdf3cd14f67c74f7a0b38e4b">minToi</a>(0), <a class="code" href="../../dd/dac/structTOICircle.html#a2e477e2976787a983fc4fda9e865efbd">maxToi</a>(1) {}
<a name="l00456"></a><a class="code" href="../../dd/dac/structTOICircle.html#a6cab6280cbfa25e1d0c111d2c76456f6">00456</a>     <span class="keywordtype">float</span>   <a class="code" href="../../dd/dac/structTOICircle.html#a6cab6280cbfa25e1d0c111d2c76456f6">toi</a>[<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1e1a516270ceeae42909aaca8f36d3e4">AVOID_MAX_STEPS</a>];   <span class="comment">// Time of impact (seconds)</span>
<a name="l00457"></a><a class="code" href="../../dd/dac/structTOICircle.html#a9e64bf09b103e393678322acd14802ff">00457</a>     <span class="keywordtype">float</span>   <a class="code" href="../../dd/dac/structTOICircle.html#a9e64bf09b103e393678322acd14802ff">toie</a>[<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1e1a516270ceeae42909aaca8f36d3e4">AVOID_MAX_STEPS</a>];  <span class="comment">// Time of exit (seconds)</span>
<a name="l00458"></a><a class="code" href="../../dd/dac/structTOICircle.html#ab208a74732a63326ac5dc2a0d277214e">00458</a>     <span class="keywordtype">float</span>   <a class="code" href="../../dd/dac/structTOICircle.html#ab208a74732a63326ac5dc2a0d277214e">dir</a>[<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1e1a516270ceeae42909aaca8f36d3e4">AVOID_MAX_STEPS</a>];   <span class="comment">// Direction (radians)</span>
<a name="l00459"></a><a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">00459</a>     <span class="keywordtype">int</span>     <a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">n</a>;                      <span class="comment">// Number of samples</span>
<a name="l00460"></a><a class="code" href="../../dd/dac/structTOICircle.html#aa0eba629cdf3cd14f67c74f7a0b38e4b">00460</a>     <span class="keywordtype">float</span>   <a class="code" href="../../dd/dac/structTOICircle.html#aa0eba629cdf3cd14f67c74f7a0b38e4b">minToi</a>, <a class="code" href="../../dd/dac/structTOICircle.html#a2e477e2976787a983fc4fda9e865efbd">maxToi</a>;         <span class="comment">// Min/max TOI (seconds)</span>
<a name="l00461"></a>00461 };
<a name="l00462"></a>00462 
<a name="l00463"></a><a class="code" href="../../d0/d12/classKX__ObstacleSimulationTOI__rays.html#a9e35213ce848eebb9b6e06c3402897c5">00463</a> <a class="code" href="../../d0/d12/classKX__ObstacleSimulationTOI__rays.html#a9e35213ce848eebb9b6e06c3402897c5">KX_ObstacleSimulationTOI_rays::KX_ObstacleSimulationTOI_rays</a>(<a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> levelHeight, <span class="keywordtype">bool</span> enableVisualization):
<a name="l00464"></a>00464     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html">KX_ObstacleSimulationTOI</a>(levelHeight, enableVisualization)
<a name="l00465"></a>00465 {
<a name="l00466"></a>00466     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a> = 32;
<a name="l00467"></a>00467     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a> = 0.5f;
<a name="l00468"></a>00468     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a> = 1.2f;
<a name="l00469"></a>00469     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aca66a665792a0e239e294b8f6273530c">m_velWeight</a> = 4.0f;
<a name="l00470"></a>00470     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a74164bc57960714bfff6f8d77a1e767d">m_toiWeight</a> = 1.0f;
<a name="l00471"></a>00471     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a8d01f01df256c15b82a5cc69509942be">m_collisionWeight</a> = 100.0f;
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 
<a name="l00475"></a><a class="code" href="../../d0/d12/classKX__ObstacleSimulationTOI__rays.html#afd09caf64a57eef51d5ea08307e5a2fc">00475</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d12/classKX__ObstacleSimulationTOI__rays.html#afd09caf64a57eef51d5ea08307e5a2fc">KX_ObstacleSimulationTOI_rays::sampleRVO</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, 
<a name="l00476"></a>00476                                         <span class="keyword">const</span> <span class="keywordtype">float</span> maxDeltaAngle)
<a name="l00477"></a>00477 {
<a name="l00478"></a>00478     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> vel(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[0], activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[1]);
<a name="l00479"></a>00479     <span class="keywordtype">float</span> vmax = (float) vel.<a class="code" href="../../d6/d81/classMT__Vector2.html#ab55421c42efeb6316e928064b662c941">length</a>();
<a name="l00480"></a>00480     <span class="keywordtype">float</span> odir = (float) <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(vel.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a65ebe38022fd0de66a20a7207c53ac92">y</a>(), vel.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a9eaf883865345bdf8b8030f4b3d73aae">x</a>());
<a name="l00481"></a>00481 
<a name="l00482"></a>00482     <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> ddir = vel;
<a name="l00483"></a>00483     ddir.<a class="code" href="../../d6/d81/classMT__Vector2.html#ac962770207f0abc684239599c1e37684">normalize</a>();
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordtype">float</span> bestScore = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00486"></a>00486     <span class="keywordtype">float</span> bestDir = odir;
<a name="l00487"></a>00487     <span class="keywordtype">float</span> bestToi = 0;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <a class="code" href="../../dd/dac/structTOICircle.html">TOICircle</a> tc;
<a name="l00490"></a>00490     tc.<a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">n</a> = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>;
<a name="l00491"></a>00491     tc.<a class="code" href="../../dd/dac/structTOICircle.html#aa0eba629cdf3cd14f67c74f7a0b38e4b">minToi</a> = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a>;
<a name="l00492"></a>00492     tc.<a class="code" href="../../dd/dac/structTOICircle.html#a2e477e2976787a983fc4fda9e865efbd">maxToi</a> = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keyword">const</span> <span class="keywordtype">int</span> iforw = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>/2;
<a name="l00495"></a>00495     <span class="keyword">const</span> <span class="keywordtype">float</span> aoff = (float)iforw / (<span class="keywordtype">float</span>)<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keywordtype">size_t</span> nobs = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>.size();
<a name="l00498"></a>00498     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iter = 0; iter &lt; <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>; ++iter)
<a name="l00499"></a>00499     {
<a name="l00500"></a>00500         <span class="comment">// Calculate sample velocity</span>
<a name="l00501"></a>00501         <span class="keyword">const</span> <span class="keywordtype">float</span> ndir = ((float)iter/(<span class="keywordtype">float</span>)<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>) - aoff;
<a name="l00502"></a>00502         <span class="keyword">const</span> <span class="keywordtype">float</span> dir = odir+ndir*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00503"></a>00503         <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> svel;
<a name="l00504"></a>00504         svel.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a9eaf883865345bdf8b8030f4b3d73aae">x</a>() = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(dir) * vmax;
<a name="l00505"></a>00505         svel.<a class="code" href="../../d7/dba/classMT__Tuple2.html#a65ebe38022fd0de66a20a7207c53ac92">y</a>() = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(dir) * vmax;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">// Find min time of impact and exit amongst all obstacles.</span>
<a name="l00508"></a>00508         <span class="keywordtype">float</span> tmin = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a>;
<a name="l00509"></a>00509         <span class="keywordtype">float</span> tmine = 0;
<a name="l00510"></a>00510         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; nobs; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00511"></a>00511         {
<a name="l00512"></a>00512             <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* ob = <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00513"></a>00513             <span class="keywordtype">bool</span> res = <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ae37e295bd1d8e0316f34f4f54146de6a">filterObstacle</a>(activeObst, activeNavMeshObj, ob, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a2618f9e416b9bf432651736f384886a3">m_levelHeight</a>);
<a name="l00514"></a>00514             <span class="keywordflow">if</span> (!res)
<a name="l00515"></a>00515                 <span class="keywordflow">continue</span>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517             <span class="keywordtype">float</span> htmin,htmax;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a> == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbea8622ed20ede0bce7f4243a85db706d6c">KX_OBSTACLE_CIRCLE</a>)
<a name="l00520"></a>00520             {
<a name="l00521"></a>00521                 <a class="code" href="../../d6/d81/classMT__Vector2.html">MT_Vector2</a> vab;
<a name="l00522"></a>00522                 <span class="keywordflow">if</span> (vlen(ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>) &lt; 0.01f*0.01f)
<a name="l00523"></a>00523                 {
<a name="l00524"></a>00524                     <span class="comment">// Stationary, use VO</span>
<a name="l00525"></a>00525                     vab = svel;
<a name="l00526"></a>00526                 }
<a name="l00527"></a>00527                 <span class="keywordflow">else</span>
<a name="l00528"></a>00528                 {
<a name="l00529"></a>00529                     <span class="comment">// Moving, use RVO</span>
<a name="l00530"></a>00530                     vab = 2*svel - vel - ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>;
<a name="l00531"></a>00531                 }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">sweepCircleCircle</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, 
<a name="l00534"></a>00534                     vab, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, htmin, htmax))
<a name="l00535"></a>00535                     <span class="keywordflow">continue</span>;
<a name="l00536"></a>00536             }
<a name="l00537"></a>00537             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a> == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a>)
<a name="l00538"></a>00538             {
<a name="l00539"></a>00539                 <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p1 = ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>;
<a name="l00540"></a>00540                 <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p2 = ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a3b368fe45a27097e283d48ec5694cfba">m_pos2</a>;
<a name="l00541"></a>00541                 <span class="comment">//apply world transform</span>
<a name="l00542"></a>00542                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a1f98f24e7dc907ad856df05cbe1d98d9">m_type</a> == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a>)
<a name="l00543"></a>00543                 {
<a name="l00544"></a>00544                     <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* navmeshobj = <span class="keyword">static_cast&lt;</span><a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>*<span class="keyword">&gt;</span>(ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>);
<a name="l00545"></a>00545                     p1 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p1);
<a name="l00546"></a>00546                     p2 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p2);
<a name="l00547"></a>00547                 }
<a name="l00548"></a>00548                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a9893ed532851b605f71129f4a928b790">sweepCircleSegment</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, svel, 
<a name="l00549"></a>00549                     p1, p2, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, htmin, htmax))
<a name="l00550"></a>00550                     <span class="keywordflow">continue</span>;
<a name="l00551"></a>00551             }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553             <span class="keywordflow">if</span> (htmin &gt; 0.0f)
<a name="l00554"></a>00554             {
<a name="l00555"></a>00555                 <span class="comment">// The closest obstacle is somewhere ahead of us, keep track of nearest obstacle.</span>
<a name="l00556"></a>00556                 <span class="keywordflow">if</span> (htmin &lt; tmin)
<a name="l00557"></a>00557                     tmin = htmin;
<a name="l00558"></a>00558             }
<a name="l00559"></a>00559             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (htmax &gt; 0.0f)
<a name="l00560"></a>00560             {
<a name="l00561"></a>00561                 <span class="comment">// The agent overlaps the obstacle, keep track of first safe exit.</span>
<a name="l00562"></a>00562                 <span class="keywordflow">if</span> (htmax &gt; tmine)
<a name="l00563"></a>00563                     tmine = htmax;
<a name="l00564"></a>00564             }
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         <span class="comment">// Calculate sample penalties and final score.</span>
<a name="l00568"></a>00568         <span class="keyword">const</span> <span class="keywordtype">float</span> apen = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aca66a665792a0e239e294b8f6273530c">m_velWeight</a> * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(ndir);
<a name="l00569"></a>00569         <span class="keyword">const</span> <span class="keywordtype">float</span> tpen = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a74164bc57960714bfff6f8d77a1e767d">m_toiWeight</a> * (1.0f/(0.0001f+tmin/<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a>));
<a name="l00570"></a>00570         <span class="keyword">const</span> <span class="keywordtype">float</span> cpen = <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a8d01f01df256c15b82a5cc69509942be">m_collisionWeight</a> * (tmine/<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a>)*(tmine/<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a>);
<a name="l00571"></a>00571         <span class="keyword">const</span> <span class="keywordtype">float</span> score = apen + tpen + cpen;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         <span class="comment">// Update best score.</span>
<a name="l00574"></a>00574         <span class="keywordflow">if</span> (score &lt; bestScore)
<a name="l00575"></a>00575         {
<a name="l00576"></a>00576             bestDir = dir;
<a name="l00577"></a>00577             bestToi = tmin;
<a name="l00578"></a>00578             bestScore = score;
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         tc.<a class="code" href="../../dd/dac/structTOICircle.html#ab208a74732a63326ac5dc2a0d277214e">dir</a>[iter] = dir;
<a name="l00582"></a>00582         tc.<a class="code" href="../../dd/dac/structTOICircle.html#a6cab6280cbfa25e1d0c111d2c76456f6">toi</a>[iter] = tmin;
<a name="l00583"></a>00583         tc.<a class="code" href="../../dd/dac/structTOICircle.html#a9e64bf09b103e393678322acd14802ff">toie</a>[iter] = tmine;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586     <span class="keywordflow">if</span> (vlen(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>) &gt; 0.1)
<a name="l00587"></a>00587     {
<a name="l00588"></a>00588         <span class="comment">// Constrain max turn rate.</span>
<a name="l00589"></a>00589         <span class="keywordtype">float</span> cura = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>[1],activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>[0]);
<a name="l00590"></a>00590         <span class="keywordtype">float</span> da = bestDir - cura;
<a name="l00591"></a>00591         <span class="keywordflow">if</span> (da &lt; -<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) da += (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (da &gt; <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) da -= (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*2;
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (da &lt; -maxDeltaAngle)
<a name="l00594"></a>00594         {
<a name="l00595"></a>00595             bestDir = cura - maxDeltaAngle;
<a name="l00596"></a>00596             bestToi = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(bestToi, <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ad9ee34fa54fd33678431477f699ff3ae">interpolateToi</a>(bestDir, tc.<a class="code" href="../../dd/dac/structTOICircle.html#ab208a74732a63326ac5dc2a0d277214e">dir</a>, tc.<a class="code" href="../../dd/dac/structTOICircle.html#a6cab6280cbfa25e1d0c111d2c76456f6">toi</a>, tc.<a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">n</a>));
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (da &gt; maxDeltaAngle)
<a name="l00599"></a>00599         {
<a name="l00600"></a>00600             bestDir = cura + maxDeltaAngle;
<a name="l00601"></a>00601             bestToi = <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(bestToi, <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ad9ee34fa54fd33678431477f699ff3ae">interpolateToi</a>(bestDir, tc.<a class="code" href="../../dd/dac/structTOICircle.html#ab208a74732a63326ac5dc2a0d277214e">dir</a>, tc.<a class="code" href="../../dd/dac/structTOICircle.html#a6cab6280cbfa25e1d0c111d2c76456f6">toi</a>, tc.<a class="code" href="../../dd/dac/structTOICircle.html#ac49daf62d3cec201775f463329c21c9d">n</a>));
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">// Adjust speed when time of impact is less than min TOI.</span>
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (bestToi &lt; <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a>)
<a name="l00607"></a>00607         vmax *= bestToi/<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aefdca38fce3e689fd81791b2b9279662">m_minToi</a>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">// New steering velocity.</span>
<a name="l00610"></a>00610     activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>[0] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(bestDir) * vmax;
<a name="l00611"></a>00611     activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>[1] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a1a55e3226c270625a4bff1befa977638">sinf</a>(bestDir) * vmax;
<a name="l00612"></a>00612 }
<a name="l00613"></a>00613 
<a name="l00615"></a>00615 
<a name="l00616"></a><a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aaa3a3c74a4e81c294252c0a9c3970fbc">00616</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aaa3a3c74a4e81c294252c0a9c3970fbc">processSamples</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, 
<a name="l00617"></a>00617                            <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#acdf3049035391d0c211db4fef0bb62f7">KX_Obstacles</a>&amp; obstacles,  <span class="keywordtype">float</span> levelHeight, <span class="keyword">const</span> <span class="keywordtype">float</span> vmax,
<a name="l00618"></a>00618                            <span class="keyword">const</span> <span class="keywordtype">float</span>* spos, <span class="keyword">const</span> <span class="keywordtype">float</span> cs, <span class="keyword">const</span> <span class="keywordtype">int</span> nspos, <span class="keywordtype">float</span>* res,                         
<a name="l00619"></a>00619                            <span class="keywordtype">float</span> maxToi, <span class="keywordtype">float</span> velWeight, <span class="keywordtype">float</span> curVelWeight, <span class="keywordtype">float</span> sideWeight,
<a name="l00620"></a>00620                            <span class="keywordtype">float</span> toiWeight)
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622     vset(res, 0,0);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keyword">const</span> <span class="keywordtype">float</span> ivmax = 1.0f / vmax;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <span class="keywordtype">float</span> adir[2] <span class="comment">/*, adist */</span>;
<a name="l00627"></a>00627     vcpy(adir, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a07f271f6be18d2166406fc6c2b0c0d0f">pvel</a>);
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (vlen(adir) &gt; 0.01f)
<a name="l00629"></a>00629         vnorm(adir);
<a name="l00630"></a>00630     <span class="keywordflow">else</span>
<a name="l00631"></a>00631         vset(adir,0,0);
<a name="l00632"></a>00632     <span class="keywordtype">float</span> activeObstPos[2];
<a name="l00633"></a>00633     vset(activeObstPos, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>()); 
<a name="l00634"></a>00634     <span class="comment">/* adist = vdot(adir, activeObstPos); */</span>
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="keywordtype">float</span> minPenalty = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = 0; n &lt; nspos; ++n)
<a name="l00639"></a>00639     {
<a name="l00640"></a>00640         <span class="keywordtype">float</span> vcand[2];
<a name="l00641"></a>00641         vcpy(vcand, &amp;spos[n*2]);        
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="comment">// Find min time of impact and exit amongst all obstacles.</span>
<a name="l00644"></a>00644         <span class="keywordtype">float</span> tmin = maxToi;
<a name="l00645"></a>00645         <span class="keywordtype">float</span> side = 0;
<a name="l00646"></a>00646         <span class="keywordtype">int</span> nside = 0;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; obstacles.size(); ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00649"></a>00649         {
<a name="l00650"></a>00650             <a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* ob = obstacles[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00651"></a>00651             <span class="keywordtype">bool</span> res = <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#ae37e295bd1d8e0316f34f4f54146de6a">filterObstacle</a>(activeObst, activeNavMeshObj, ob, levelHeight);
<a name="l00652"></a>00652             <span class="keywordflow">if</span> (!res)
<a name="l00653"></a>00653                 <span class="keywordflow">continue</span>;
<a name="l00654"></a>00654             <span class="keywordtype">float</span> htmin, htmax;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656             <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a>==<a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbea8622ed20ede0bce7f4243a85db706d6c">KX_OBSTACLE_CIRCLE</a>)
<a name="l00657"></a>00657             {
<a name="l00658"></a>00658                 <span class="keywordtype">float</span> vab[2];
<a name="l00659"></a>00659 
<a name="l00660"></a>00660                 <span class="comment">// Moving, use RVO</span>
<a name="l00661"></a>00661                 <a class="code" href="../../d8/d91/mikktspace_8c.html#a4e650bfec2292ae7c1ca023c18a14faf">vscale</a>(vab, vcand, 2);
<a name="l00662"></a>00662                 <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(vab, vab, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>);
<a name="l00663"></a>00663                 <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(vab, vab, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>);
<a name="l00664"></a>00664 
<a name="l00665"></a>00665                 <span class="comment">// Side</span>
<a name="l00666"></a>00666                 <span class="comment">// NOTE: dp, and dv are constant over the whole calculation,</span>
<a name="l00667"></a>00667                 <span class="comment">// they can be precomputed per object. </span>
<a name="l00668"></a>00668                 <span class="keyword">const</span> <span class="keywordtype">float</span>* pa = activeObstPos;
<a name="l00669"></a>00669                 <span class="keywordtype">float</span> pb[2];
<a name="l00670"></a>00670                 vset(pb, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00671"></a>00671 
<a name="l00672"></a>00672                 <span class="keyword">const</span> <span class="keywordtype">float</span> orig[2] = {0,0};
<a name="l00673"></a>00673                 <span class="keywordtype">float</span> dp[2],dv[2],np[2];
<a name="l00674"></a>00674                 <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(dp,pb,pa);
<a name="l00675"></a>00675                 vnorm(dp);
<a name="l00676"></a>00676                 <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(dv,ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                 <span class="keyword">const</span> <span class="keywordtype">float</span> a = <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a7554756e04638b1cf677d72d78a5b486">triarea</a>(orig, dp,dv);
<a name="l00679"></a>00679                 <span class="keywordflow">if</span> (a &lt; 0.01f)
<a name="l00680"></a>00680                 {
<a name="l00681"></a>00681                     np[0] = -dp[1];
<a name="l00682"></a>00682                     np[1] = dp[0];
<a name="l00683"></a>00683                 }
<a name="l00684"></a>00684                 <span class="keywordflow">else</span>
<a name="l00685"></a>00685                 {
<a name="l00686"></a>00686                     np[0] = dp[1];
<a name="l00687"></a>00687                     np[1] = -dp[0];
<a name="l00688"></a>00688                 }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690                 side += <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#a2de4316477cb25448b1cff8970439a46">clamp</a>(<a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>(<a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(dp,vab)*2,<a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(np,vab)*2), 0.0f, 1.0f);
<a name="l00691"></a>00691                 nside++;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a1ccb47b66c38d3e1789665c1d521efdc">sweepCircleCircle</a>(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, vab, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, 
<a name="l00694"></a>00694                     htmin, htmax))
<a name="l00695"></a>00695                     <span class="keywordflow">continue</span>;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697                 <span class="comment">// Handle overlapping obstacles.</span>
<a name="l00698"></a>00698                 <span class="keywordflow">if</span> (htmin &lt; 0.0f &amp;&amp; htmax &gt; 0.0f)
<a name="l00699"></a>00699                 {
<a name="l00700"></a>00700                     <span class="comment">// Avoid more when overlapped.</span>
<a name="l00701"></a>00701                     htmin = -htmin * 0.5f;
<a name="l00702"></a>00702                 }
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a05312b685184fb07019bdf22d3075eb4">m_shape</a> == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#a939291f7fa011d4aa3f31136ba775dbeab1ef49de41e1c99e94c511dc050169f9">KX_OBSTACLE_SEGMENT</a>)
<a name="l00705"></a>00705             {
<a name="l00706"></a>00706                 <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p1 = ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a43a267ef9505af4b597807f49d6759d1">m_pos</a>;
<a name="l00707"></a>00707                 <a class="code" href="../../d0/d9e/classMT__Point3.html">MT_Point3</a> p2 = ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a3b368fe45a27097e283d48ec5694cfba">m_pos2</a>;
<a name="l00708"></a>00708                 <span class="comment">//apply world transform</span>
<a name="l00709"></a>00709                 <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a1f98f24e7dc907ad856df05cbe1d98d9">m_type</a> == <a class="code" href="../../da/dbc/KX__ObstacleSimulation_8h.html#ad6bdf83c7eafd28a4941a227806c7842a9d3707f39c0a3e93870f6facf664e7e2">KX_OBSTACLE_NAV_MESH</a>)
<a name="l00710"></a>00710                 {
<a name="l00711"></a>00711                     <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* navmeshobj = <span class="keyword">static_cast&lt;</span><a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>*<span class="keyword">&gt;</span>(ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a413fad0d5d087ae3369f54da92eef9bf">m_gameObj</a>);
<a name="l00712"></a>00712                     p1 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p1);
<a name="l00713"></a>00713                     p2 = navmeshobj-&gt;<a class="code" href="../../db/d94/classKX__NavMeshObject.html#ac69b410db2cd4d7fd5a9d7b8c24c4cc5">TransformToWorldCoords</a>(p2);
<a name="l00714"></a>00714                 }
<a name="l00715"></a>00715                 <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[2], q[2];
<a name="l00716"></a>00716                 vset(p, p1.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), p1.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00717"></a>00717                 vset(q, p2.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a4fc6295783618921127b9c2fc50f1886">x</a>(), p2.<a class="code" href="../../d8/da2/classMT__Tuple3.html#a1f96a6c8175338f515073fa85b922275">y</a>());
<a name="l00718"></a>00718 
<a name="l00719"></a>00719                 <span class="comment">// NOTE: the segments are assumed to come from a navmesh which is shrunken by</span>
<a name="l00720"></a>00720                 <span class="comment">// the agent radius, hence the use of really small radius.</span>
<a name="l00721"></a>00721                 <span class="comment">// This can be handle more efficiently by using seg-seg test instead.</span>
<a name="l00722"></a>00722                 <span class="comment">// If the whole segment is to be treated as obstacle, use agent-&gt;rad instead of 0.01f!</span>
<a name="l00723"></a>00723                 <span class="keyword">const</span> <span class="keywordtype">float</span> r = 0.01f; <span class="comment">// agent-&gt;rad</span>
<a name="l00724"></a>00724                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aba8c7acebeac2fbca99f33e87f712825">distPtSegSqr</a>(activeObstPos, p, q) &lt; <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(r+ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>))
<a name="l00725"></a>00725                 {
<a name="l00726"></a>00726                     <span class="keywordtype">float</span> sdir[2], snorm[2];
<a name="l00727"></a>00727                     <a class="code" href="../../d8/d91/mikktspace_8c.html#a7f0c0902f5dfac6082b6a7ea94509f96">vsub</a>(sdir, q, p);
<a name="l00728"></a>00728                     snorm[0] = sdir[1];
<a name="l00729"></a>00729                     snorm[1] = -sdir[0];
<a name="l00730"></a>00730                     <span class="comment">// If the velocity is pointing towards the segment, no collision.</span>
<a name="l00731"></a>00731                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d91/mikktspace_8c.html#ae5cda423168d7e762a2f02590e13d230">vdot</a>(snorm, vcand) &lt; 0.0f)
<a name="l00732"></a>00732                         <span class="keywordflow">continue</span>;
<a name="l00733"></a>00733                     <span class="comment">// Else immediate collision.</span>
<a name="l00734"></a>00734                     htmin = 0.0f;
<a name="l00735"></a>00735                     htmax = 10.0f;
<a name="l00736"></a>00736                 }
<a name="l00737"></a>00737                 <span class="keywordflow">else</span>
<a name="l00738"></a>00738                 {
<a name="l00739"></a>00739                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#a9893ed532851b605f71129f4a928b790">sweepCircleSegment</a>(activeObstPos, r, vcand, p, q, ob-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a17905c747c0c50e4261ce4e50b6dc870">m_rad</a>, htmin, htmax))
<a name="l00740"></a>00740                         <span class="keywordflow">continue</span>;
<a name="l00741"></a>00741                 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743                 <span class="comment">// Avoid less when facing walls.</span>
<a name="l00744"></a>00744                 htmin *= 2.0f;
<a name="l00745"></a>00745             }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747             <span class="keywordflow">if</span> (htmin &gt;= 0.0f)
<a name="l00748"></a>00748             {
<a name="l00749"></a>00749                 <span class="comment">// The closest obstacle is somewhere ahead of us, keep track of nearest obstacle.</span>
<a name="l00750"></a>00750                 <span class="keywordflow">if</span> (htmin &lt; tmin)
<a name="l00751"></a>00751                     tmin = htmin;
<a name="l00752"></a>00752             }
<a name="l00753"></a>00753         }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755         <span class="comment">// Normalize side bias, to prevent it dominating too much.</span>
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (nside)
<a name="l00757"></a>00757             side /= nside;
<a name="l00758"></a>00758 
<a name="l00759"></a>00759         <span class="keyword">const</span> <span class="keywordtype">float</span> vpen = velWeight * (vdist(vcand, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>) * ivmax);
<a name="l00760"></a>00760         <span class="keyword">const</span> <span class="keywordtype">float</span> vcpen = curVelWeight * (vdist(vcand, activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#ad024838adef0791499dfad40b1f3e965">vel</a>) * ivmax);
<a name="l00761"></a>00761         <span class="keyword">const</span> <span class="keywordtype">float</span> spen = sideWeight * side;
<a name="l00762"></a>00762         <span class="keyword">const</span> <span class="keywordtype">float</span> tpen = toiWeight * (1.0f/(0.1f+tmin/maxToi));
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="keyword">const</span> <span class="keywordtype">float</span> penalty = vpen + vcpen + spen + tpen;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         <span class="keywordflow">if</span> (penalty &lt; minPenalty)
<a name="l00767"></a>00767         {
<a name="l00768"></a>00768             minPenalty = penalty;
<a name="l00769"></a>00769             vcpy(res, vcand);
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771     }
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a><a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a2f2113c0bc243e3477332562b7d47d24">00774</a> <span class="keywordtype">void</span> <a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a2f2113c0bc243e3477332562b7d47d24">KX_ObstacleSimulationTOI_cells::sampleRVO</a>(<a class="code" href="../../df/dc6/structKX__Obstacle.html">KX_Obstacle</a>* activeObst, <a class="code" href="../../db/d94/classKX__NavMeshObject.html">KX_NavMeshObject</a>* activeNavMeshObj, 
<a name="l00775"></a>00775                        <span class="keyword">const</span> <span class="keywordtype">float</span> maxDeltaAngle)
<a name="l00776"></a>00776 {
<a name="l00777"></a>00777     vset(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>, 0.f, 0.f);
<a name="l00778"></a>00778     <span class="keywordtype">float</span> vmax = vlen(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>);
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="keywordtype">float</span>* spos = <span class="keyword">new</span> <span class="keywordtype">float</span>[2*<a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>];
<a name="l00781"></a>00781     <span class="keywordtype">int</span> nspos = 0;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (!<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ac3baea78bbd4cec1e1a40ca5b810bbea">m_adaptive</a>)
<a name="l00784"></a>00784     {
<a name="l00785"></a>00785         <span class="keyword">const</span> <span class="keywordtype">float</span> cvx = activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[0]*<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>;
<a name="l00786"></a>00786         <span class="keyword">const</span> <span class="keywordtype">float</span> cvy = activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[1]*<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>;
<a name="l00787"></a>00787         <span class="keywordtype">float</span> vmax = vlen(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>);
<a name="l00788"></a>00788         <span class="keyword">const</span> <span class="keywordtype">float</span> vrange = vmax*(1-<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>);
<a name="l00789"></a>00789         <span class="keyword">const</span> <span class="keywordtype">float</span> cs = 1.0f / (float)<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>*vrange;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = -<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>; y &lt;= <a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>; ++y)
<a name="l00792"></a>00792         {
<a name="l00793"></a>00793             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = -<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>; x &lt;= <a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>; ++x)
<a name="l00794"></a>00794             {
<a name="l00795"></a>00795                 <span class="keywordflow">if</span> (nspos &lt; <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a>)
<a name="l00796"></a>00796                 {
<a name="l00797"></a>00797                     <span class="keyword">const</span> <span class="keywordtype">float</span> vx = cvx + (float)(x+0.5f)*cs;
<a name="l00798"></a>00798                     <span class="keyword">const</span> <span class="keywordtype">float</span> vy = cvy + (float)(y+0.5f)*cs;
<a name="l00799"></a>00799                     <span class="keywordflow">if</span> (vx*vx+vy*vy &gt; <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(vmax+cs/2)) <span class="keywordflow">continue</span>;
<a name="l00800"></a>00800                     spos[nspos*2+0] = vx;
<a name="l00801"></a>00801                     spos[nspos*2+1] = vy;
<a name="l00802"></a>00802                     nspos++;
<a name="l00803"></a>00803                 }
<a name="l00804"></a>00804             }
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806         <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aaa3a3c74a4e81c294252c0a9c3970fbc">processSamples</a>(activeObst, activeNavMeshObj, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a2618f9e416b9bf432651736f384886a3">m_levelHeight</a>, vmax, spos, cs/2, 
<a name="l00807"></a>00807             nspos,  activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aca66a665792a0e239e294b8f6273530c">m_velWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#ae8705fd2f4f65e332fd9df7e40866092">m_curVelWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a8d01f01df256c15b82a5cc69509942be">m_collisionWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a74164bc57960714bfff6f8d77a1e767d">m_toiWeight</a>);
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809     <span class="keywordflow">else</span>
<a name="l00810"></a>00810     {
<a name="l00811"></a>00811         <span class="keywordtype">int</span> rad;
<a name="l00812"></a>00812         <span class="keywordtype">float</span> res[2];
<a name="l00813"></a>00813         <span class="keywordtype">float</span> cs;
<a name="l00814"></a>00814         <span class="comment">// First sample location.</span>
<a name="l00815"></a>00815         rad = 4;
<a name="l00816"></a>00816         res[0] = activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[0]*<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>;
<a name="l00817"></a>00817         res[1] = activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a8efcd6a3d5564c5567b04ceaaf4b8106">dvel</a>[1]*<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>;
<a name="l00818"></a>00818         cs = vmax*(2-<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#ade59f0c341e7f9cc7fc47a5196a107ce">m_bias</a>*2) / (<span class="keywordtype">float</span>)(rad-1);
<a name="l00819"></a>00819 
<a name="l00820"></a>00820         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; 5; ++k)
<a name="l00821"></a>00821         {
<a name="l00822"></a>00822             <span class="keyword">const</span> <span class="keywordtype">float</span> half = (rad-1)*cs*0.5f;
<a name="l00823"></a>00823 
<a name="l00824"></a>00824             nspos = 0;
<a name="l00825"></a>00825             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; rad; ++y)
<a name="l00826"></a>00826             {
<a name="l00827"></a>00827                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; rad; ++x)
<a name="l00828"></a>00828                 {
<a name="l00829"></a>00829                     <span class="keyword">const</span> <span class="keywordtype">float</span> vx = res[0] + x*cs - half;
<a name="l00830"></a>00830                     <span class="keyword">const</span> <span class="keywordtype">float</span> vy = res[1] + y*cs - half;
<a name="l00831"></a>00831                     <span class="keywordflow">if</span> (vx*vx+vy*vy &gt; <a class="code" href="../../d0/dbc/namespaceKDL.html#accfa6cc1228db447db8a5b53d80462b5">sqr</a>(vmax+cs/2)) <span class="keywordflow">continue</span>;
<a name="l00832"></a>00832                     spos[nspos*2+0] = vx;
<a name="l00833"></a>00833                     spos[nspos*2+1] = vy;
<a name="l00834"></a>00834                     nspos++;
<a name="l00835"></a>00835                 }
<a name="l00836"></a>00836             }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838             <a class="code" href="../../d0/dad/KX__ObstacleSimulation_8cpp.html#aaa3a3c74a4e81c294252c0a9c3970fbc">processSamples</a>(activeObst, activeNavMeshObj, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#ae045289735ffd2362fc416e4ef36a62b">m_obstacles</a>, <a class="code" href="../../d7/d8d/classKX__ObstacleSimulation.html#a2618f9e416b9bf432651736f384886a3">m_levelHeight</a>, vmax, spos, cs/2, 
<a name="l00839"></a>00839                 nspos,  res, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aca66a665792a0e239e294b8f6273530c">m_velWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#ae8705fd2f4f65e332fd9df7e40866092">m_curVelWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a8d01f01df256c15b82a5cc69509942be">m_collisionWeight</a>, <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a74164bc57960714bfff6f8d77a1e767d">m_toiWeight</a>);
<a name="l00840"></a>00840 
<a name="l00841"></a>00841             cs *= 0.5f;
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843         vcpy(activeObst-&gt;<a class="code" href="../../df/dc6/structKX__Obstacle.html#a97d1bc1f43310125eb5342a4e644cedc">nvel</a>, res);
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a><a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a722d8e46fb27a3004c2b19ec7f7173de">00847</a> <a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a722d8e46fb27a3004c2b19ec7f7173de">KX_ObstacleSimulationTOI_cells::KX_ObstacleSimulationTOI_cells</a>(<a class="code" href="../../d6/dc4/MT__Scalar_8h.html#a71b06cc1a8da1da228878ebfd84cd2a9">MT_Scalar</a> levelHeight, <span class="keywordtype">bool</span> enableVisualization)
<a name="l00848"></a>00848 :   <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html">KX_ObstacleSimulationTOI</a>(levelHeight, enableVisualization)
<a name="l00849"></a>00849 ,   m_bias(0.4f)
<a name="l00850"></a>00850 ,   m_adaptive(true)
<a name="l00851"></a>00851 ,   m_sampleRadius(15)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aa84526bd93b8bad5ae09df32552466cc">m_maxSamples</a> = (<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>*2+1)*(<a class="code" href="../../de/d1c/classKX__ObstacleSimulationTOI__cells.html#a9048c446bc4462bc2280e3ee4ffde517">m_sampleRadius</a>*2+1) + 100;
<a name="l00854"></a>00854     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a0eade8282adbe5f6153e95109300e001">m_maxToi</a> = 1.5f;
<a name="l00855"></a>00855     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#aca66a665792a0e239e294b8f6273530c">m_velWeight</a> = 2.0f;
<a name="l00856"></a>00856     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#ae8705fd2f4f65e332fd9df7e40866092">m_curVelWeight</a> = 0.75f;
<a name="l00857"></a>00857     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a74164bc57960714bfff6f8d77a1e767d">m_toiWeight</a> = 2.5f;
<a name="l00858"></a>00858     <a class="code" href="../../d5/dd2/classKX__ObstacleSimulationTOI.html#a8d01f01df256c15b82a5cc69509942be">m_collisionWeight</a> = 0.75f; <span class="comment">//side_weight</span>
<a name="l00859"></a>00859 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:28 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
