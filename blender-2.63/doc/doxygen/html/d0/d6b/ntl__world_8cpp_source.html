<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: ntl_world.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">ntl_world.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d0/d6b/ntl__world_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * El&#39;Beem - Free Surface Fluid Simulation with the Lattice Boltzmann Method</span>
<a name="l00007"></a>00007 <span class="comment"> * Copyright 2003-2006 Nils Thuerey</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * Main renderer class</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> *****************************************************************************/</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df0/utilities_8h.html">utilities.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d8d/ntl__world_8h.html">ntl_world.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d94/parametrizer_8h.html">parametrizer.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment">// for non-threaded renderViz</span>
<a name="l00021"></a>00021 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#include &quot;../gui/ntl_openglrenderer.h&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;../gui/guifuncs.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;../gui/frame.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/* external parser functions from cfgparser.cxx */</span>
<a name="l00029"></a>00029 <span class="preprocessor">#ifndef ELBEEM_PLUGIN</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="comment">/* parse given file as config file */</span>
<a name="l00031"></a>00031 <span class="keywordtype">void</span> <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#aea19bacb9cf58119dfd802f405a144de">parseFile</a>(<span class="keywordtype">string</span> filename);
<a name="l00032"></a>00032 <span class="comment">/* set pointers for parsing */</span>
<a name="l00033"></a>00033 <span class="keywordtype">void</span> <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5bfba1cd94933666dd6488de4e69bc3b">setPointers</a>( <a class="code" href="../../d0/d95/classntlRenderGlobals.html" title="Class that handles global rendering parameters.">ntlRenderGlobals</a> *setglob);
<a name="l00034"></a>00034 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">/******************************************************************************</span>
<a name="l00038"></a>00038 <span class="comment"> * Constructor</span>
<a name="l00039"></a>00039 <span class="comment"> *****************************************************************************/</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="../../dc/d5b/classntlWorld.html#ad1d3946c58269a990a223d2d1ba47970">00041</a> <a class="code" href="../../dc/d5b/classntlWorld.html#ad1d3946c58269a990a223d2d1ba47970">ntlWorld::ntlWorld</a>() {
<a name="l00042"></a>00042     <a class="code" href="../../dc/d5b/classntlWorld.html#ae62d4d476e249ea83bcf7768c305b1c9">initDefaults</a>();
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="../../dc/d5b/classntlWorld.html#aa97e80991c96a17041a04a84becde3a9">00045</a> <a class="code" href="../../dc/d5b/classntlWorld.html#ad1d3946c58269a990a223d2d1ba47970">ntlWorld::ntlWorld</a>(<span class="keywordtype">string</span> filename, <span class="keywordtype">bool</span> commandlineMode) 
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047 <span class="preprocessor">#ifndef ELBEEM_PLUGIN</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049         <a class="code" href="../../dc/d5b/classntlWorld.html#ae62d4d476e249ea83bcf7768c305b1c9">initDefaults</a>();
<a name="l00050"></a>00050 <span class="preprocessor">#   ifdef NOGUI</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>        commandlineMode = <span class="keyword">true</span>; <span class="comment">// remove warning...</span>
<a name="l00052"></a>00052 <span class="preprocessor">#   endif // NOGUI</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054         <span class="comment">// load config</span>
<a name="l00055"></a>00055         <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5bfba1cd94933666dd6488de4e69bc3b">setPointers</a>( <a class="code" href="../../dc/d5b/classntlWorld.html#abd194bdef4dcb227dc34a45eb5fbd496">getRenderGlobals</a>() );
<a name="l00056"></a>00056         <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#aea19bacb9cf58119dfd802f405a144de">parseFile</a>( filename.c_str() );
<a name="l00057"></a>00057 <span class="preprocessor">#   ifndef NOGUI</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>        <span class="comment">// setup opengl display, save first animation step for start time </span>
<a name="l00059"></a>00059         <span class="comment">// init after parsing file...</span>
<a name="l00060"></a>00060         <span class="keywordflow">if</span>(!commandlineMode) {
<a name="l00061"></a>00061             <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a> = <span class="keyword">new</span> ntlOpenGLRenderer( <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a> );
<a name="l00062"></a>00062         }
<a name="l00063"></a>00063 <span class="preprocessor">#   endif // NOGUI</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>        <a class="code" href="../../dc/d5b/classntlWorld.html#ab335265da5674d26cb3ab039120a02b8">finishWorldInit</a>();
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#else // ELBEEM_PLUGIN</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>    <a class="code" href="../../de/df0/utilities_8h.html#abbf67626aa468b4301520b9f6f292e1c">errFatal</a>(<span class="stringliteral">&quot;ntlWorld::init&quot;</span>,<span class="stringliteral">&quot;Cfg file parsing not supported for API version! &quot;</span>&lt;&lt;filename&lt;&lt;<span class="stringliteral">&quot; &quot;</span>&lt;&lt;commandlineMode, <a class="code" href="../../de/df0/utilities_8h.html#a74894721e682bda2c22d5dacda988cad">SIMWORLD_INITERROR</a>);
<a name="l00068"></a>00068 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>}
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5090e3b2438f3118578b7d83dfb6a1f7">00072</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5090e3b2438f3118578b7d83dfb6a1f7">globalDomainCounter</a> = 1;
<a name="l00073"></a><a class="code" href="../../dc/d5b/classntlWorld.html#a21cf96436b2c72977d1da70868f369fc">00073</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a21cf96436b2c72977d1da70868f369fc">ntlWorld::addDomain</a>(<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html">elbeemSimulationSettings</a> *settings)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075     <span class="comment">// create domain obj</span>
<a name="l00076"></a>00076     <a class="code" href="../../da/df3/classSimulationObject.html">SimulationObject</a> *sim = <span class="keyword">new</span> <a class="code" href="../../da/df3/classSimulationObject.html">SimulationObject</a>();
<a name="l00077"></a>00077     <span class="keywordtype">char</span> simname[100];
<a name="l00078"></a>00078     <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(simname,100,<span class="stringliteral">&quot;domain%04d&quot;</span>,<a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5090e3b2438f3118578b7d83dfb6a1f7">globalDomainCounter</a>);
<a name="l00079"></a>00079     <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5090e3b2438f3118578b7d83dfb6a1f7">globalDomainCounter</a>++;
<a name="l00080"></a>00080     sim-&gt;<a class="code" href="../../dd/dcf/classntlGeometryClass.html#a444f6bbccaccf40d4ebb882ca9ef5889">setName</a>(<span class="keywordtype">string</span>(simname));
<a name="l00081"></a>00081     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ab9df25f8c59ba50ba3498872e2bda572" title="Returns the list of simulations.">getSims</a>()-&gt;push_back( sim );
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="comment">// important - add to both, only render scene objects are free&#39;d </span>
<a name="l00084"></a>00084     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#aadce3ce2667316f35ac67078c1b050e3">addGeoClass</a>( sim );
<a name="l00085"></a>00085     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ab16c773967908534c9861b39951d11f2" title="Returns the simulation scene manager (static scene with sim objects)">getSimScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#aadce3ce2667316f35ac67078c1b050e3">addGeoClass</a>( sim );
<a name="l00086"></a>00086     sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a7b9dd168b71a68d0e198be7afea84ca7">setGeoStart</a>(<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[0],settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[1],settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[2]));
<a name="l00087"></a>00087     sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#ae7bd13ce9556b99a90bfc1e4a7562d2d">setGeoEnd</a>(<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(
<a name="l00088"></a>00088             settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[0]+settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad6ec2432d27565ba8eb9e18c98d50bdd">geoSize</a>[0],
<a name="l00089"></a>00089             settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[1]+settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad6ec2432d27565ba8eb9e18c98d50bdd">geoSize</a>[1],
<a name="l00090"></a>00090             settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aabbe4522a0205e42be0cfe479f8ce6b0">geoStart</a>[2]+settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad6ec2432d27565ba8eb9e18c98d50bdd">geoSize</a>[2] ));
<a name="l00091"></a>00091     <span class="comment">// further init in postGeoConstrInit/initializeLbmSimulation of SimulationObject</span>
<a name="l00092"></a>00092     sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a7bc4ce699220c58d67e004cbf5a0e24c">copyElbeemSettings</a>(settings);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     <a class="code" href="../../d1/d7f/classParametrizer.html" title="output parameter debug message?">Parametrizer</a> *param = sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a65747e16d4b7ae9a19012c17364f6df5">getParametrizer</a>();
<a name="l00095"></a>00095     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a2f19b037c5136360f7e2de473a42489f">setSize</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ad3889f49d9cbb6605d366a4161c8857b">resolutionxyz</a> );
<a name="l00096"></a>00096     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a666a72dd732c70ae8f07795e536a9431">setDomainSize</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#accc770fdefc6079eff4dcae7753b750f">realsize</a> );
<a name="l00097"></a>00097     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#ae80b44b6470bf1778f18f8d427918d30">setAniStart</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#acb5dec91ace098f73eb7110783f2872c">animStart</a> );
<a name="l00098"></a>00098     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a2989fcd1ac610958bd61e66cf6020dcb">setNormalizedGStar</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a78645ab0c49fae66e5a807d307cdc747">gstar</a> );
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// init domain channels</span>
<a name="l00101"></a>00101     vector&lt;ParamFloat&gt; valf; 
<a name="l00102"></a>00102     vector&lt;ParamVec&gt; valv; 
<a name="l00103"></a>00103     vector&lt;double&gt; time;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="preprocessor">#define INIT_CHANNEL_FLOAT(channel,size) \</span>
<a name="l00106"></a>00106 <span class="preprocessor">    valf.clear(); time.clear(); elbeemSimplifyChannelFloat(channel,&amp;size); \</span>
<a name="l00107"></a>00107 <span class="preprocessor">    for(int i=0; i&lt;size; i++) { valf.push_back( channel[2*i+0] ); time.push_back( channel[2*i+1] ); } </span>
<a name="l00108"></a>00108 <span class="preprocessor"></span><span class="preprocessor">#define INIT_CHANNEL_VEC(channel,size) \</span>
<a name="l00109"></a>00109 <span class="preprocessor">    valv.clear(); time.clear(); elbeemSimplifyChannelVec3(channel,&amp;size); \</span>
<a name="l00110"></a>00110 <span class="preprocessor">    for(int i=0; i&lt;size; i++) { valv.push_back( ParamVec(channel[4*i+0],channel[4*i+1],channel[4*i+2]) ); time.push_back( channel[4*i+3] ); } </span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a>00112     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a928ef3a6224899fe6f7d81b2ec3b7985">setViscosity</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ac0ac098a9115598677657ee5471415db">viscosity</a> );
<a name="l00113"></a>00113     <span class="keywordflow">if</span>((settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ab44689840f807d2e2d1fee0c812ceaec">channelViscosity</a>)&amp;&amp;(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aa7047ddd7cbe37b627bc3b664477d349">channelSizeViscosity</a>&gt;0)) {
<a name="l00114"></a>00114         <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5fce1dfdcbd1b4766d82523a5d561540">INIT_CHANNEL_FLOAT</a>(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#ab44689840f807d2e2d1fee0c812ceaec">channelViscosity</a>, settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#aa7047ddd7cbe37b627bc3b664477d349">channelSizeViscosity</a>);
<a name="l00115"></a>00115         param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a94ec4fa354024a2c48d1d8f95a61d453">initViscosityChannel</a>(valf,time); }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#aeadd52b694690b7370e670c072aac5e3">setGravity</a>( <a class="code" href="../../de/d94/parametrizer_8h.html#a5874807786cac3cd2676621c8ae9fc8f">ParamVec</a>(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#afc7508091f207c6b9148c56052ea9685">gravity</a>[0], settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#afc7508091f207c6b9148c56052ea9685">gravity</a>[1], settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#afc7508091f207c6b9148c56052ea9685">gravity</a>[2]) );
<a name="l00118"></a>00118     <span class="keywordflow">if</span>((settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a77596ec9398b619df476d5093f4d8cb7">channelGravity</a>)&amp;&amp;(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a2a1c0ce8453a132c4bfd12dd9718db77">channelSizeGravity</a>&gt;0)) {
<a name="l00119"></a>00119         <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a83d93a02f72130ebde2f04b5fed29001">INIT_CHANNEL_VEC</a>(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a77596ec9398b619df476d5093f4d8cb7">channelGravity</a>, settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a2a1c0ce8453a132c4bfd12dd9718db77">channelSizeGravity</a>);
<a name="l00120"></a>00120         param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a744fc0c42fb349008f86ce43e2e4f419">initGravityChannel</a>(valv,time); }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a6d6cfc48fd648709da3d4f59c6cc6323">setAniFrameTimeChannel</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a7b76335c6fa581d8de07284012bceaec">aniFrameTime</a> );
<a name="l00123"></a>00123     <span class="keywordflow">if</span>((settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a27769d2989d99ae66e9a57c8672db04a">channelFrameTime</a>)&amp;&amp;(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a7828a3700c1203956e05395f125e146b">channelSizeFrameTime</a>&gt;0)) {
<a name="l00124"></a>00124         <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a5fce1dfdcbd1b4766d82523a5d561540">INIT_CHANNEL_FLOAT</a>(settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a27769d2989d99ae66e9a57c8672db04a">channelFrameTime</a>, settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a7828a3700c1203956e05395f125e146b">channelSizeFrameTime</a>);
<a name="l00125"></a>00125         param-&gt;<a class="code" href="../../d1/d7f/classParametrizer.html#a86a3fd61d583482d5716fac02750e5aa">initAniFrameTimeChannel</a>(valf,time); }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="preprocessor">#undef INIT_CHANNEL_FLOAT</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="preprocessor">#undef INIT_CHANNEL_VEC</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>    
<a name="l00130"></a>00130     <span class="comment">// might be set by previous domain</span>
<a name="l00131"></a>00131     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a903699cce9cae1a0431b099fd6f70fcd" title="Return the animation frame number.">getAniFrames</a>() &lt; settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a251f4962a77fa4415ee8eac005bf2604">noOfFrames</a>)   <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a008857c6c2eb8da307297037b1c0a888" title="Set the animation number of frames.">setAniFrames</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a251f4962a77fa4415ee8eac005bf2604">noOfFrames</a> );
<a name="l00132"></a>00132     <span class="comment">// set additionally to SimulationObject-&gt;mOutFilename</span>
<a name="l00133"></a>00133     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a2dd2f43e676aa580d7220752c6dbb00d" title="Set the outfilename.">setOutFilename</a>( settings-&gt;<a class="code" href="../../d3/d14/structelbeemSimulationSettings.html#a80c082ac97031e941539c2abd04c5848">outputPath</a> );
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">return</span> 0;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a><a class="code" href="../../dc/d5b/classntlWorld.html#ae62d4d476e249ea83bcf7768c305b1c9">00138</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d5b/classntlWorld.html#ae62d4d476e249ea83bcf7768c305b1c9">ntlWorld::initDefaults</a>()
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <a class="code" href="../../dc/d5b/classntlWorld.html#a9b8956a628eaf8ace8a260c088ab69ae">mStopRenderVisualization</a> = <span class="keyword">false</span>;
<a name="l00141"></a>00141     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> =  <span class="keyword">false</span>;
<a name="l00142"></a>00142     <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> = 0.0; 
<a name="l00143"></a>00143     <a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a> = 1;
<a name="l00144"></a>00144     <a class="code" href="../../dc/d5b/classntlWorld.html#ae7f1d5a9a344e378a3aa1eb45c2677bb">mSingleStepDebug</a> =  <span class="keyword">false</span>;
<a name="l00145"></a>00145     <a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a> = 0;
<a name="l00146"></a>00146     <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148   <span class="comment">/* create scene storage */</span>
<a name="l00149"></a>00149   <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a> = <span class="keyword">new</span> <a class="code" href="../../d0/d95/classntlRenderGlobals.html" title="Class that handles global rendering parameters.">ntlRenderGlobals</a>();
<a name="l00150"></a>00150   <a class="code" href="../../dc/d5b/classntlWorld.html#a37fea2357979d20541d109b4187e9f76">mpLightList</a> = <span class="keyword">new</span> vector&lt;ntlLightObject*&gt;;
<a name="l00151"></a>00151   <a class="code" href="../../dc/d5b/classntlWorld.html#ad78afb6c389a6de46d24b692ad28943b">mpPropList</a> = <span class="keyword">new</span> vector&lt;ntlMaterial*&gt;;
<a name="l00152"></a>00152   <a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a> = <span class="keyword">new</span> vector&lt;SimulationObject*&gt;;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a3b5ae48d84737f81045cd2d2e20de839" title="Set the light list.">setLightList</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#a37fea2357979d20541d109b4187e9f76">mpLightList</a>);
<a name="l00155"></a>00155   <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a0b154235d0056b1778048c91bc7a2953" title="Set the property list.">setMaterials</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#ad78afb6c389a6de46d24b692ad28943b">mpPropList</a>);
<a name="l00156"></a>00156   <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ad2423ea586522a5ca16eae451824e29d" title="Set the pointer to the list of simulations.">setSims</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="comment">/* init default material */</span>
<a name="l00159"></a>00159   <a class="code" href="../../d5/d60/classntlMaterial.html" title="Properties of an geo object, describing the reflection properties of the surface.">ntlMaterial</a> *def = <a class="code" href="../../de/d50/ntl__lighting_8h.html#ab385b5fbd01650fb2062a3f9fd89325e">GET_GLOBAL_DEFAULT_MATERIAL</a>;
<a name="l00160"></a>00160     <a class="code" href="../../dc/d5b/classntlWorld.html#ad78afb6c389a6de46d24b692ad28943b">mpPropList</a>-&gt;push_back( def );
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="comment">/* init the scene object */</span>
<a name="l00163"></a>00163     <a class="code" href="../../dd/d46/classntlScene.html">ntlScene</a> *renderscene = <span class="keyword">new</span> <a class="code" href="../../dd/d46/classntlScene.html">ntlScene</a>( <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>, <span class="keyword">true</span> );
<a name="l00164"></a>00164     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a13c42850d5c9191b2c1c83e88e713ad2" title="Set the renderscene manager.">setRenderScene</a>( renderscene );
<a name="l00165"></a>00165     <span class="comment">// sim scene shouldnt delete objs, may only contain subset</span>
<a name="l00166"></a>00166     <a class="code" href="../../dd/d46/classntlScene.html">ntlScene</a> *simscene = <span class="keyword">new</span> <a class="code" href="../../dd/d46/classntlScene.html">ntlScene</a>( <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>, <span class="keyword">false</span> );
<a name="l00167"></a>00167     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a2f07d1d755c94ccbe0fb23938d5d15f1" title="Set the simulation scene manager.">setSimScene</a>( simscene );
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="../../dc/d5b/classntlWorld.html#ab335265da5674d26cb3ab039120a02b8">00170</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d5b/classntlWorld.html#ab335265da5674d26cb3ab039120a02b8">ntlWorld::finishWorldInit</a>()
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <span class="keywordflow">if</span>(! <a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>() ) <span class="keywordflow">return</span>;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">// init the scene for the first time</span>
<a name="l00175"></a>00175   <span class="keywordtype">long</span> sstartTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">// first init sim scene for geo setup</span>
<a name="l00178"></a>00178     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ab16c773967908534c9861b39951d11f2" title="Returns the simulation scene manager (static scene with sim objects)">getSimScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#aeae84245423a31b212567b722225340d">buildScene</a>(0.0, <span class="keyword">true</span>);
<a name="l00179"></a>00179     <span class="keywordflow">if</span>(! <a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>() ) <span class="keywordflow">return</span>;
<a name="l00180"></a>00180     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#aeae84245423a31b212567b722225340d">buildScene</a>(0.0, <span class="keyword">true</span>);
<a name="l00181"></a>00181     <span class="keywordflow">if</span>(! <a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>() ) <span class="keywordflow">return</span>;
<a name="l00182"></a>00182     <span class="keywordtype">long</span> sstopTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00183"></a>00183     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Scene build time: &quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(sstopTime-sstartTime) &lt;&lt;<span class="stringliteral">&quot; &quot;</span>, 10);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <span class="comment">// TODO check simulations, run first steps</span>
<a name="l00186"></a>00186     <a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a> = -1;
<a name="l00187"></a>00187     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size() &gt; 0) {
<a name="l00188"></a>00188 
<a name="l00189"></a>00189         <span class="comment">// use values from first simulation as master time scale</span>
<a name="l00190"></a>00190         <span class="keywordtype">long</span> startTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00191"></a>00191         
<a name="l00192"></a>00192         <span class="comment">// remember first active sim</span>
<a name="l00193"></a>00193         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00194"></a>00194             <span class="keywordflow">if</span>(!(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getVisible()) <span class="keywordflow">continue</span>;
<a name="l00195"></a>00195             <span class="keywordflow">if</span>((*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getPanic())    <span class="keywordflow">continue</span>;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197             <span class="comment">// check largest timestep</span>
<a name="l00198"></a>00198             <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>&gt;=0) {
<a name="l00199"></a>00199                 <span class="keywordflow">if</span>( (*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getTimestep() &gt; (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep() ) {
<a name="l00200"></a>00200                     <a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00201"></a>00201                     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;First Sim changed: &quot;</span>&lt;&lt;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> ,10);
<a name="l00202"></a>00202                 }
<a name="l00203"></a>00203             }
<a name="l00204"></a>00204             <span class="comment">// check any valid sim</span>
<a name="l00205"></a>00205             <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>&lt;0) {
<a name="l00206"></a>00206                 <a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00207"></a>00207                 <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;First Sim: &quot;</span>&lt;&lt;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> ,10);
<a name="l00208"></a>00208             }
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>&gt;=0) {
<a name="l00212"></a>00212             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Anistart Time: &quot;</span>&lt;&lt;(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getStartTime() ,10);
<a name="l00213"></a>00213             <span class="keywordflow">while</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> &lt; (*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getStartTime() ) {
<a name="l00214"></a>00214             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Anistart Time: &quot;</span>&lt;&lt;(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getStartTime()&lt;&lt;<span class="stringliteral">&quot; simtime:&quot;</span>&lt;&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> ,10);
<a name="l00215"></a>00215                 <a class="code" href="../../dc/d5b/classntlWorld.html#abc4cad656e837b5bd1568495fb668762">advanceSims</a>(-1);
<a name="l00216"></a>00216             }
<a name="l00217"></a>00217             <span class="keywordtype">long</span> stopTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00218"></a>00218 
<a name="l00219"></a>00219             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Time for start-sims:&quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(stopTime-startTime) , 1);
<a name="l00220"></a>00220 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>            guiResetSimulationTimeRange( <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> );
<a name="l00222"></a>00222 <span class="preprocessor">#endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l00224"></a>00224             <span class="keywordflow">if</span>(!<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aa6dc1628b3a677e4380c5b558808715b" title="set single frame mode flag">getSingleFrameMode</a>()) <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#aac9413fb9eeba06e80c56258d95b15d6">DM_WARNING</a>,<span class="stringliteral">&quot;No active simulations!&quot;</span>, 1);
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="keywordflow">if</span>(! <a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>() ) <span class="keywordflow">return</span>;
<a name="l00229"></a>00229     <a class="code" href="../../de/da5/utilities_8cpp.html#a4cb779c77c9d3b803fa9076c8f38e945">setElbeemState</a>( <a class="code" href="../../de/df0/utilities_8h.html#a34741a16423e44f87a8828ec49bc1ccb">SIMWORLD_INITED</a> );
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">/******************************************************************************</span>
<a name="l00235"></a>00235 <span class="comment"> * Destructor</span>
<a name="l00236"></a>00236 <span class="comment"> *****************************************************************************/</span>
<a name="l00237"></a><a class="code" href="../../dc/d5b/classntlWorld.html#a0f0e9ac961a8ce137aa6fb018335495e">00237</a> <a class="code" href="../../dc/d5b/classntlWorld.html#a0f0e9ac961a8ce137aa6fb018335495e">ntlWorld::~ntlWorld</a>()
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>();
<a name="l00240"></a>00240     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ab16c773967908534c9861b39951d11f2" title="Returns the simulation scene manager (static scene with sim objects)">getSimScene</a>();
<a name="l00241"></a>00241   
<a name="l00242"></a>00242     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>;
<a name="l00243"></a>00243     
<a name="l00244"></a>00244     
<a name="l00245"></a>00245     <span class="comment">// these get assigned to mpGlob but not freed there</span>
<a name="l00246"></a>00246     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a37fea2357979d20541d109b4187e9f76">mpLightList</a>;
<a name="l00247"></a>00247     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#ad78afb6c389a6de46d24b692ad28943b">mpPropList</a>; <span class="comment">// materials</span>
<a name="l00248"></a>00248     <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>;
<a name="l00249"></a>00249   
<a name="l00250"></a>00250 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>) <span class="keyword">delete</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>;
<a name="l00252"></a>00252 <span class="preprocessor">#endif // NOGUI</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>    <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>, <span class="stringliteral">&quot;ntlWorld done&quot;</span>, 10);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">/******************************************************************************/</span>
<a name="l00258"></a><a class="code" href="../../dc/d5b/classntlWorld.html#aee58009a6d46a16dca410fdaa1c1d61a">00258</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d5b/classntlWorld.html#aee58009a6d46a16dca410fdaa1c1d61a">ntlWorld::setSingleFrameOut</a>(<span class="keywordtype">string</span> singleframeFilename) {
<a name="l00259"></a>00259     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a571524eb4deea9496a9550d91749bc54" title="set single frame mode flag">setSingleFrameMode</a>(<span class="keyword">true</span>);
<a name="l00260"></a>00260     <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a07219f7994c3e5dc5123e5bedb6246a3" title="set single frame mode filename">setSingleFrameFilename</a>(singleframeFilename);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/******************************************************************************</span>
<a name="l00264"></a>00264 <span class="comment"> * render a whole animation (command line mode) </span>
<a name="l00265"></a>00265 <span class="comment"> *****************************************************************************/</span>
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="../../dc/d5b/classntlWorld.html#a696aa674def2f25b98ace4efc71a354d">00267</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a696aa674def2f25b98ace4efc71a354d">ntlWorld::renderAnimation</a>( <span class="keywordtype">void</span> )
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <span class="comment">// only single pic currently</span>
<a name="l00270"></a>00270     <span class="comment">//debMsgStd(&quot;ntlWorld::renderAnimation : Warning only simulating...&quot;,1);</span>
<a name="l00271"></a>00271     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a903699cce9cae1a0431b099fd6f70fcd" title="Return the animation frame number.">getAniFrames</a>() &lt; 0) {
<a name="l00272"></a>00272         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderAnimation&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;No frames to render... &quot;</span>,1);
<a name="l00273"></a>00273         <span class="keywordflow">return</span> 1;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>&lt;0) {
<a name="l00277"></a>00277         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderAnimation&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;No reference animation found...&quot;</span>,1);
<a name="l00278"></a>00278         <span class="keywordflow">return</span> 1;
<a name="l00279"></a>00279     } 
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">true</span>; <span class="comment">// not threaded, but still use the same flags</span>
<a name="l00282"></a>00282     <span class="keywordflow">if</span>(<a class="code" href="../../de/da5/utilities_8cpp.html#a5703bf80d6c4205e530eb01983bf0ac3">getElbeemState</a>() == <a class="code" href="../../de/df0/utilities_8h.html#a34741a16423e44f87a8828ec49bc1ccb">SIMWORLD_INITED</a>) {
<a name="l00283"></a>00283         <a class="code" href="../../dc/d5b/classntlWorld.html#aa6184eccd1ae9c68c80e70143be6cb1e">renderScene</a>();
<a name="l00284"></a>00284     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../de/da5/utilities_8cpp.html#a5703bf80d6c4205e530eb01983bf0ac3">getElbeemState</a>() == <a class="code" href="../../de/df0/utilities_8h.html#a7e6c8a9b196c6e8ad8c6009c7650ab40">SIMWORLD_STOP</a>) {
<a name="l00285"></a>00285         <span class="comment">// dont render now, just continue</span>
<a name="l00286"></a>00286         <a class="code" href="../../de/da5/utilities_8cpp.html#a4cb779c77c9d3b803fa9076c8f38e945">setElbeemState</a>( <a class="code" href="../../de/df0/utilities_8h.html#a34741a16423e44f87a8828ec49bc1ccb">SIMWORLD_INITED</a> );
<a name="l00287"></a>00287         <a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>--; <span class="comment">// counted one too many from last abort...</span>
<a name="l00288"></a>00288     } <span class="keywordflow">else</span> {
<a name="l00289"></a>00289         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderAnimation&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;Not properly inited, stopping...&quot;</span>,1);
<a name="l00290"></a>00290         <span class="keywordflow">return</span> 1;
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size() &lt;= 0) {
<a name="l00294"></a>00294         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderAnimation&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;No simulations found, stopping...&quot;</span>,1);
<a name="l00295"></a>00295         <span class="keywordflow">return</span> 1;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordtype">bool</span> simok = <span class="keyword">true</span>;
<a name="l00299"></a>00299     <span class="keywordflow">for</span>( ; ((<a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a903699cce9cae1a0431b099fd6f70fcd" title="Return the animation frame number.">getAniFrames</a>()) &amp;&amp; (!<a class="code" href="../../dc/d5b/classntlWorld.html#a464916e5e191ce4ad1a9657cbd992e8d">getStopRenderVisualization</a>() ) &amp;&amp; (simok)); <a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>++) {
<a name="l00300"></a>00300         <span class="keywordflow">if</span>(!<a class="code" href="../../dc/d5b/classntlWorld.html#abc4cad656e837b5bd1568495fb668762">advanceSims</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>)) {
<a name="l00301"></a>00301             <a class="code" href="../../dc/d5b/classntlWorld.html#aa6184eccd1ae9c68c80e70143be6cb1e">renderScene</a>();
<a name="l00302"></a>00302         } <span class="comment">// else means sim panicked, so dont render...</span>
<a name="l00303"></a>00303         <span class="keywordflow">else</span> { simok=<span class="keyword">false</span>; }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">false</span>;
<a name="l00306"></a>00306     <span class="keywordflow">return</span> 0;
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="comment">/******************************************************************************</span>
<a name="l00310"></a>00310 <span class="comment"> * render a whole animation (visualization mode) </span>
<a name="l00311"></a>00311 <span class="comment"> * this function is run in another thread, and communicates </span>
<a name="l00312"></a>00312 <span class="comment"> * with the parent thread via a mutex </span>
<a name="l00313"></a>00313 <span class="comment"> *****************************************************************************/</span>
<a name="l00314"></a><a class="code" href="../../dc/d5b/classntlWorld.html#ac9ff1f46c682e35a00259bf70aca8a8a">00314</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#ac9ff1f46c682e35a00259bf70aca8a8a">ntlWorld::renderVisualization</a>( <span class="keywordtype">bool</span> multiThreaded ) 
<a name="l00315"></a>00315 {
<a name="l00316"></a>00316 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../de/da5/utilities_8cpp.html#a5703bf80d6c4205e530eb01983bf0ac3">getElbeemState</a>() != <a class="code" href="../../de/df0/utilities_8h.html#a34741a16423e44f87a8828ec49bc1ccb">SIMWORLD_INITED</a>) { <span class="keywordflow">return</span> 0; }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordflow">if</span>(multiThreaded) <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">true</span>;
<a name="l00320"></a>00320     <span class="comment">// TODO, check global state?</span>
<a name="l00321"></a>00321     <span class="keywordflow">while</span>(!<a class="code" href="../../dc/d5b/classntlWorld.html#a464916e5e191ce4ad1a9657cbd992e8d">getStopRenderVisualization</a>()) {
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size() &lt;= 0) {
<a name="l00324"></a>00324             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderVisualization&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>,<span class="stringliteral">&quot;No simulations found, stopping...&quot;</span>,1);
<a name="l00325"></a>00325             stopSimulationThread();
<a name="l00326"></a>00326             <span class="keywordflow">break</span>;
<a name="l00327"></a>00327         }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="comment">// determine stepsize</span>
<a name="l00330"></a>00330         <span class="keywordflow">if</span>(!<a class="code" href="../../dc/d5b/classntlWorld.html#ae7f1d5a9a344e378a3aa1eb45c2677bb">mSingleStepDebug</a>) {
<a name="l00331"></a>00331             <span class="keywordtype">long</span> startTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00332"></a>00332             <a class="code" href="../../dc/d5b/classntlWorld.html#abc4cad656e837b5bd1568495fb668762">advanceSims</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>);
<a name="l00333"></a>00333             <a class="code" href="../../dc/d5b/classntlWorld.html#a412415feb803f03ede724eb1252c2b77">mFrameCnt</a>++;
<a name="l00334"></a>00334             <span class="keywordtype">long</span> stopTime = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00335"></a>00335             <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderVisualization&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Time for t=&quot;</span>&lt;&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a>&lt;&lt;<span class="stringliteral">&quot;: &quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(stopTime-startTime) &lt;&lt;<span class="stringliteral">&quot; &quot;</span>, 10);
<a name="l00336"></a>00336         } <span class="keywordflow">else</span> {
<a name="l00337"></a>00337             <span class="keywordtype">double</span> targetTime = <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> + (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep();
<a name="l00338"></a>00338             <a class="code" href="../../dc/d5b/classntlWorld.html#a270a96eeff691cf6869a80b929785365">singleStepSims</a>(targetTime);
<a name="l00339"></a>00339 
<a name="l00340"></a>00340             <span class="comment">// check paniced sims (normally done by advanceSims</span>
<a name="l00341"></a>00341             <span class="keywordtype">bool</span> allPanic = <span class="keyword">true</span>;
<a name="l00342"></a>00342             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00343"></a>00343                 <span class="keywordflow">if</span>(!(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getPanic()) allPanic = <span class="keyword">false</span>;
<a name="l00344"></a>00344             }
<a name="l00345"></a>00345             <span class="keywordflow">if</span>(allPanic) {
<a name="l00346"></a>00346                 <a class="code" href="../../de/df0/utilities_8h.html#ab01779ee97bb2950ece31f08740bc35f">warnMsg</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<span class="stringliteral">&quot;All sims panicked... stopping thread&quot;</span> );
<a name="l00347"></a>00347                 <a class="code" href="../../dc/d5b/classntlWorld.html#a1b54e3bfad53f335269b3f1bc4700104">setStopRenderVisualization</a>( <span class="keyword">true</span> );
<a name="l00348"></a>00348             }
<a name="l00349"></a>00349             <span class="keywordflow">if</span>(! <a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>() ) {
<a name="l00350"></a>00350                 <a class="code" href="../../de/df0/utilities_8h.html#ab01779ee97bb2950ece31f08740bc35f">warnMsg</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<span class="stringliteral">&quot;World state error... stopping&quot;</span> );
<a name="l00351"></a>00351                 <a class="code" href="../../dc/d5b/classntlWorld.html#a1b54e3bfad53f335269b3f1bc4700104">setStopRenderVisualization</a>( <span class="keyword">true</span> );
<a name="l00352"></a>00352             }
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="comment">// save frame</span>
<a name="l00356"></a>00356         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>) <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>-&gt;saveAnimationFrame( <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> );
<a name="l00357"></a>00357         
<a name="l00358"></a>00358         <span class="comment">// for non-threaded check events</span>
<a name="l00359"></a>00359         <span class="keywordflow">if</span>(!multiThreaded) {
<a name="l00360"></a>00360             Fl::check();
<a name="l00361"></a>00361       gpElbeemFrame-&gt;SceneDisplay-&gt;doOnlyForcedRedraw();
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">false</span>;
<a name="l00366"></a>00366     stopSimulationRestoreGui();
<a name="l00367"></a>00367 <span class="preprocessor">#else </span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>    multiThreaded = <span class="keyword">false</span>; <span class="comment">// remove warning</span>
<a name="l00369"></a>00369 <span class="preprocessor">#endif</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00371"></a>00371 }
<a name="l00373"></a><a class="code" href="../../dc/d5b/classntlWorld.html#a610a512d49d089e078709e1aac2c986a">00373</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a610a512d49d089e078709e1aac2c986a">ntlWorld::singleStepVisualization</a>( <span class="keywordtype">void</span> ) 
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">true</span>;
<a name="l00376"></a>00376     <span class="keywordtype">double</span> targetTime = <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> + (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep();
<a name="l00377"></a>00377     <a class="code" href="../../dc/d5b/classntlWorld.html#a270a96eeff691cf6869a80b929785365">singleStepSims</a>(targetTime);
<a name="l00378"></a>00378     <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> = (*mpSims)[0]-&gt;getCurrentTime();
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>) <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>-&gt;saveAnimationFrame( <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> );
<a name="l00382"></a>00382     Fl::check();
<a name="l00383"></a>00383   gpElbeemFrame-&gt;SceneDisplay-&gt;doOnlyForcedRedraw();
<a name="l00384"></a>00384     <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">false</span>;
<a name="l00385"></a>00385     stopSimulationRestoreGui();
<a name="l00386"></a>00386 <span class="preprocessor">#else</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>    <a class="code" href="../../dc/d5b/classntlWorld.html#a5a199461d91c7f6166fc65ff3381ea58">mThreadRunning</a> = <span class="keyword">false</span>;
<a name="l00388"></a>00388 <span class="preprocessor">#endif // NOGUI</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 <span class="comment">// dont use LBM_EPSILON here, time is always double-precision!</span>
<a name="l00393"></a><a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a8aef512d15beeb3e881bae2f3c2f4664">00393</a> <span class="preprocessor">#define LBM_TIME_EPSILON 1e-10</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>
<a name="l00395"></a>00395 <span class="comment">/******************************************************************************</span>
<a name="l00396"></a>00396 <span class="comment"> * advance simulations by time t </span>
<a name="l00397"></a>00397 <span class="comment"> *****************************************************************************/</span>
<a name="l00398"></a><a class="code" href="../../dc/d5b/classntlWorld.html#abc4cad656e837b5bd1568495fb668762">00398</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#abc4cad656e837b5bd1568495fb668762">ntlWorld::advanceSims</a>(<span class="keywordtype">int</span> framenum)
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <span class="keywordtype">bool</span> done = <span class="keyword">false</span>;
<a name="l00401"></a>00401     <span class="keywordtype">bool</span> allPanic = <span class="keyword">true</span>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">// stop/quit (abort), dont display/render</span>
<a name="l00404"></a>00404     <span class="keywordflow">if</span>(!<a class="code" href="../../de/da5/utilities_8cpp.html#af3e89e0e3df33a7bf12fb4903a18f79b">isSimworldOk</a>()) { 
<a name="l00405"></a>00405         <span class="keywordflow">return</span> 1;
<a name="l00406"></a>00406     }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) { (*mpSims)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;setFrameNum(framenum); }
<a name="l00409"></a>00409     <span class="keywordtype">double</span> targetTime = <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> + (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getFrameTime(framenum);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="comment">// time stopped? nothing else to do...</span>
<a name="l00412"></a>00412     <span class="keywordflow">if</span>( (*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getFrameTime(framenum) &lt;= 0.0 ){ 
<a name="l00413"></a>00413         done=<span class="keyword">true</span>; allPanic=<span class="keyword">false</span>; 
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         <span class="comment">/* DG: Need to check for user cancel here (fix for [#30298]) */</span>
<a name="l00416"></a>00416         (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;checkCallerStatus(<a class="code" href="../../d8/d00/elbeem_8h.html#ab6678d281fc1a20116640b8884c4dd8c">FLUIDSIM_CBSTATUS_STEP</a>, 0);
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="keywordtype">int</span> gstate = 0;
<a name="l00420"></a>00420     <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> advsstart = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     <span class="comment">// step all the sims, and check for panic</span>
<a name="l00423"></a>00423     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <span class="stringliteral">&quot; sims &quot;</span>&lt;&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size()&lt;&lt;<span class="stringliteral">&quot; t&quot;</span>&lt;&lt;targetTime&lt;&lt;<span class="stringliteral">&quot; done:&quot;</span>&lt;&lt;done&lt;&lt;<span class="stringliteral">&quot; panic:&quot;</span>&lt;&lt;allPanic&lt;&lt;<span class="stringliteral">&quot; gstate:&quot;</span>&lt;&lt;gstate, 10); <span class="comment">// debug // timedebug</span>
<a name="l00424"></a>00424     <span class="keywordflow">while</span>(!done) {
<a name="l00425"></a>00425         <span class="keywordtype">double</span> nextTargetTime = (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getCurrentTime() + (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep();
<a name="l00426"></a>00426         <a class="code" href="../../dc/d5b/classntlWorld.html#a270a96eeff691cf6869a80b929785365">singleStepSims</a>(nextTargetTime);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="comment">// check target times</span>
<a name="l00429"></a>00429         done = <span class="keyword">true</span>;
<a name="l00430"></a>00430         allPanic = <span class="keyword">false</span>;
<a name="l00431"></a>00431         
<a name="l00432"></a>00432         <span class="keywordflow">if</span>((*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep() &lt;1e-9 ) { 
<a name="l00433"></a>00433             <span class="comment">// safety check, avoid timesteps that are too small</span>
<a name="l00434"></a>00434             <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<span class="stringliteral">&quot;Invalid time step, causing panic! curr:&quot;</span>&lt;&lt;(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getCurrentTime()&lt;&lt;<span class="stringliteral">&quot; next:&quot;</span>&lt;&lt;nextTargetTime&lt;&lt;<span class="stringliteral">&quot;, stept:&quot;</span>&lt;&lt; (*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getTimestep() );
<a name="l00435"></a>00435             allPanic = <span class="keyword">true</span>; 
<a name="l00436"></a>00436         } <span class="keywordflow">else</span> {
<a name="l00437"></a>00437             <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00438"></a>00438                 <span class="keywordflow">if</span>(!(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getVisible()) <span class="keywordflow">continue</span>;
<a name="l00439"></a>00439                 <span class="keywordflow">if</span>((*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getPanic()) allPanic = <span class="keyword">true</span>; <span class="comment">// do any panic now!?</span>
<a name="l00440"></a>00440                 <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, <span class="stringliteral">&quot;Sim &quot;</span>&lt;&lt;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;&lt;<span class="stringliteral">&quot;, currt:&quot;</span>&lt;&lt;(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getCurrentTime()&lt;&lt;<span class="stringliteral">&quot;, nt:&quot;</span>&lt;&lt;nextTargetTime&lt;&lt;<span class="stringliteral">&quot;, panic:&quot;</span>&lt;&lt;(*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;getPanic()&lt;&lt;<span class="stringliteral">&quot;, targett:&quot;</span>&lt;&lt;targetTime, 10); <span class="comment">// debug // timedebug</span>
<a name="l00441"></a>00441             } 
<a name="l00442"></a>00442         }
<a name="l00443"></a>00443         <span class="keywordflow">if</span>( (targetTime - (*<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getCurrentTime()) &gt; <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a8aef512d15beeb3e881bae2f3c2f4664">LBM_TIME_EPSILON</a>) done=<span class="keyword">false</span>;
<a name="l00444"></a>00444         <span class="keywordflow">if</span>(allPanic) done = <span class="keyword">true</span>;
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordflow">if</span>(allPanic) {
<a name="l00448"></a>00448         <a class="code" href="../../de/df0/utilities_8h.html#ab01779ee97bb2950ece31f08740bc35f">warnMsg</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<span class="stringliteral">&quot;All sims panicked... stopping thread&quot;</span> );
<a name="l00449"></a>00449         <a class="code" href="../../dc/d5b/classntlWorld.html#a1b54e3bfad53f335269b3f1bc4700104">setStopRenderVisualization</a>( <span class="keyword">true</span> );
<a name="l00450"></a>00450         <span class="keywordflow">return</span> 1;
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> advsend = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00454"></a>00454     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::advanceSims&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;Overall steps so far took:&quot;</span>&lt;&lt; <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(advsend-advsstart)&lt;&lt;<span class="stringliteral">&quot; for sim time &quot;</span>&lt;&lt;targetTime, 4);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">// finish step</span>
<a name="l00457"></a>00457     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00458"></a>00458         <a class="code" href="../../da/df3/classSimulationObject.html">SimulationObject</a> *sim = (*mpSims)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00459"></a>00459         <span class="keywordflow">if</span>(!sim-&gt;<a class="code" href="../../dd/dcf/classntlGeometryClass.html#ad0558ea884fc049a12e55dc8643da897">getVisible</a>()) <span class="keywordflow">continue</span>;
<a name="l00460"></a>00460         <span class="keywordflow">if</span>(sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a3d3783a4a3ed830cf8172171611a2506">getPanic</a>()) <span class="keywordflow">continue</span>;
<a name="l00461"></a>00461         sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a37a88a8e2e45a308bcf33d322c262400">prepareVisualization</a>();
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="keywordflow">return</span> 0;
<a name="l00465"></a>00465 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467 <span class="comment">/* advance simulations by a single step */</span>
<a name="l00468"></a>00468 <span class="comment">/* dont check target time, if *targetTime==NULL */</span>
<a name="l00469"></a><a class="code" href="../../dc/d5b/classntlWorld.html#a270a96eeff691cf6869a80b929785365">00469</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d5b/classntlWorld.html#a270a96eeff691cf6869a80b929785365">ntlWorld::singleStepSims</a>(<span class="keywordtype">double</span> targetTime) {
<a name="l00470"></a>00470     <span class="keyword">const</span> <span class="keywordtype">bool</span> debugTime = <span class="keyword">false</span>;
<a name="l00471"></a>00471     <span class="comment">//double targetTime = mSimulationTime + (*mpSims)[mFirstSim]-&gt;getTimestep();</span>
<a name="l00472"></a>00472     <span class="keywordflow">if</span>(debugTime) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlWorld::singleStepSims&quot;</span>,<span class="stringliteral">&quot;Target time: &quot;</span>&lt;&lt;targetTime);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="../../dc/d5b/classntlWorld.html#a6007d526736d255733bcc2436444328a">mpSims</a>-&gt;size();<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00475"></a>00475         <a class="code" href="../../da/df3/classSimulationObject.html">SimulationObject</a> *sim = (*mpSims)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00476"></a>00476         <span class="keywordflow">if</span>(!sim-&gt;<a class="code" href="../../dd/dcf/classntlGeometryClass.html#ad0558ea884fc049a12e55dc8643da897">getVisible</a>()) <span class="keywordflow">continue</span>;
<a name="l00477"></a>00477         <span class="keywordflow">if</span>(sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a3d3783a4a3ed830cf8172171611a2506">getPanic</a>()) <span class="keywordflow">continue</span>;
<a name="l00478"></a>00478         <span class="keywordtype">bool</span> done = <span class="keyword">false</span>;
<a name="l00479"></a>00479         <span class="keywordflow">while</span>(!done) {
<a name="l00480"></a>00480             <span class="comment">// try to prevent round off errs</span>
<a name="l00481"></a>00481             <span class="keywordflow">if</span>(debugTime) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlWorld::singleStepSims&quot;</span>,<span class="stringliteral">&quot;Test sim &quot;</span>&lt;&lt;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;&lt;<span class="stringliteral">&quot; curt:&quot;</span>&lt;&lt; sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#aaa8879e0c77bb53e8a993c7b59c4e1ba">getCurrentTime</a>()&lt;&lt;<span class="stringliteral">&quot; target:&quot;</span>&lt;&lt;targetTime&lt;&lt;<span class="stringliteral">&quot; delta:&quot;</span>&lt;&lt;(targetTime - sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#aaa8879e0c77bb53e8a993c7b59c4e1ba">getCurrentTime</a>())&lt;&lt;<span class="stringliteral">&quot; stept:&quot;</span>&lt;&lt;sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a235d647f4b0382710fa7be1d1d13ede9">getTimestep</a>()&lt;&lt;<span class="stringliteral">&quot; leps:&quot;</span>&lt;&lt;<a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a8aef512d15beeb3e881bae2f3c2f4664">LBM_TIME_EPSILON</a> ); <span class="comment">// timedebug</span>
<a name="l00482"></a>00482             <span class="keywordflow">if</span>( (targetTime - sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#aaa8879e0c77bb53e8a993c7b59c4e1ba">getCurrentTime</a>()) &gt; <a class="code" href="../../d0/d6b/ntl__world_8cpp.html#a8aef512d15beeb3e881bae2f3c2f4664">LBM_TIME_EPSILON</a>) {
<a name="l00483"></a>00483                 <span class="keywordflow">if</span>(debugTime) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlWorld::singleStepSims&quot;</span>,<span class="stringliteral">&quot;Stepping sim &quot;</span>&lt;&lt;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;&lt;<span class="stringliteral">&quot; t:&quot;</span>&lt;&lt; sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#aaa8879e0c77bb53e8a993c7b59c4e1ba">getCurrentTime</a>()); <span class="comment">// timedebug</span>
<a name="l00484"></a>00484                 sim-&gt;<a class="code" href="../../da/df3/classSimulationObject.html#a023911a8bb9617f2929f1d4ecd22295d">step</a>();
<a name="l00485"></a>00485             } <span class="keywordflow">else</span> {
<a name="l00486"></a>00486                 done = <span class="keyword">true</span>;
<a name="l00487"></a>00487             }
<a name="l00488"></a>00488         }
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a> = (*mpSims)[<a class="code" href="../../dc/d5b/classntlWorld.html#a20ad13c95665a7483a99dc6ed346c031">mFirstSim</a>]-&gt;getCurrentTime();
<a name="l00492"></a>00492 <span class="preprocessor">#ifndef NOGUI</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>    <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>) <a class="code" href="../../dc/d5b/classntlWorld.html#a9be7c01137f0dc14b144f430a1532d06">mpOpenGLRenderer</a>-&gt;notifyOfNextStep(<a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a>);
<a name="l00494"></a>00494 <span class="preprocessor">#endif // NOGUI</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span>}
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="keyword">extern</span> <span class="keywordtype">bool</span> <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>;
<a name="l00500"></a>00500 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="comment">/******************************************************************************</span>
<a name="l00503"></a>00503 <span class="comment"> * Render the current scene</span>
<a name="l00504"></a>00504 <span class="comment"> * uses the global variables from the parser</span>
<a name="l00505"></a>00505 <span class="comment"> *****************************************************************************/</span>
<a name="l00506"></a><a class="code" href="../../dc/d5b/classntlWorld.html#aa6184eccd1ae9c68c80e70143be6cb1e">00506</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/d5b/classntlWorld.html#aa6184eccd1ae9c68c80e70143be6cb1e">ntlWorld::renderScene</a>( <span class="keywordtype">void</span> )
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508 <span class="preprocessor">#ifndef ELBEEM_PLUGIN</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>    <span class="keywordtype">char</span> nrStr[5];                                                      <span class="comment">// nr conversion </span>
<a name="l00510"></a>00510     std::ostringstream outfn_conv(<span class="stringliteral">&quot;&quot;</span>);              <span class="comment">// converted ppm with other suffix </span>
<a name="l00511"></a>00511   <a class="code" href="../../d0/d95/classntlRenderGlobals.html" title="Class that handles global rendering parameters.">ntlRenderGlobals</a> *glob;                   <span class="comment">// storage for global rendering parameters </span>
<a name="l00512"></a>00512   <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> timeStart,totalStart,timeEnd;        <span class="comment">// measure user running time </span>
<a name="l00513"></a>00513   <a class="code" href="../../de/df0/utilities_8h.html#a5e598b8f33d56705cb3c457cb3a663b9">myTime_t</a> rendStart,rendEnd;                   <span class="comment">// measure user rendering time </span>
<a name="l00514"></a>00514   glob = <a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <span class="comment">// deactivate for all with index!=0 </span>
<a name="l00517"></a>00517     <span class="keywordflow">if</span>((<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>)&amp;&amp;(<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>&gt;0)) <span class="keywordflow">return</span>(0);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     <span class="comment">/* check if picture already exists... */</span>
<a name="l00520"></a>00520     <span class="keywordflow">if</span>(!glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aa6dc1628b3a677e4380c5b558808715b" title="set single frame mode flag">getSingleFrameMode</a>() ) {
<a name="l00521"></a>00521         <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(nrStr, 5, <span class="stringliteral">&quot;%04d&quot;</span>, glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a3aceaa4afc97aeeda8726a37c34f00" title="Return the animation counter.">getAniCount</a>() );
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a8557d7859f8e6298ad044884ae8212f1">glob_mpactive</a>) {
<a name="l00524"></a>00524             outfn_conv  &lt;&lt; glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a54747b59e5ffb1bd010699458977eed5" title="Return the outfilename.">getOutFilename</a>() &lt;&lt;<span class="stringliteral">&quot;_&quot;</span>&lt;&lt;<a class="code" href="../../d4/d97/ntl__blenderdumper_8cpp.html#a3b6d65f6326c7f625f30ff37ae4e3ead">glob_mpindex</a>&lt;&lt;<span class="stringliteral">&quot;_&quot;</span> &lt;&lt; nrStr &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>; 
<a name="l00525"></a>00525         } <span class="keywordflow">else</span> {
<a name="l00526"></a>00526             <span class="comment">// ORG</span>
<a name="l00527"></a>00527             outfn_conv  &lt;&lt; glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a54747b59e5ffb1bd010699458977eed5" title="Return the outfilename.">getOutFilename</a>() &lt;&lt;<span class="stringliteral">&quot;_&quot;</span> &lt;&lt; nrStr &lt;&lt; <span class="stringliteral">&quot;.png&quot;</span>;
<a name="l00528"></a>00528         }
<a name="l00529"></a>00529         
<a name="l00530"></a>00530         <span class="comment">//if((mpGlob-&gt;getDisplayMode() == DM_RAY)&amp;&amp;(mpGlob-&gt;getFrameSkip())) {</span>
<a name="l00531"></a>00531         <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#ab9737d9549f74b18ef39370546c063d3" title="Check if existing frames should be skipped.">getFrameSkip</a>()) {
<a name="l00532"></a>00532             <span class="keyword">struct </span>stat statBuf;
<a name="l00533"></a>00533             <span class="keywordflow">if</span>(stat(outfn_conv.str().c_str(),&amp;statBuf) == 0) {
<a name="l00534"></a>00534                 <a class="code" href="../../de/df0/utilities_8h.html#afdd54ebb997dabea3c3e7a9851b7e68d">errorOut</a>(<span class="stringliteral">&quot;ntlWorld::renderscene Warning: file &quot;</span>&lt;&lt;outfn_conv.str()&lt;&lt;<span class="stringliteral">&quot; already exists - skipping frame...&quot;</span>); 
<a name="l00535"></a>00535                 glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a0d428808fa8889fc4dc93d487a392771" title="Set the animation.">setAniCount</a>( glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a3aceaa4afc97aeeda8726a37c34f00" title="Return the animation counter.">getAniCount</a>() +1 );
<a name="l00536"></a>00536                 <span class="keywordflow">return</span>(2);
<a name="l00537"></a>00537             }
<a name="l00538"></a>00538         } <span class="comment">// RAY mode</span>
<a name="l00539"></a>00539     } <span class="keywordflow">else</span> {
<a name="l00540"></a>00540         <span class="comment">// single frame rendering, overwrite if necessary...</span>
<a name="l00541"></a>00541         outfn_conv &lt;&lt; glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a13134b62e5b9eb13da7820eb44343816" title="set single frame mode filename">getSingleFrameFilename</a>();
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544   <span class="comment">/* start program */</span>
<a name="l00545"></a>00545     timeStart = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">/* build scene geometry, calls buildScene(t,false) */</span>
<a name="l00548"></a>00548     glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#a1b0b0dc9f277fde547a3637f687c9361" title="Prepare the scene triangles and maps for raytracing.">prepareScene</a>(<a class="code" href="../../dc/d5b/classntlWorld.html#aece112e15809ab6bec4fd029f445bbd8">mSimulationTime</a>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550   <span class="comment">/* start program */</span>
<a name="l00551"></a>00551     totalStart = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">/* view parameters are currently not animated */</span>
<a name="l00555"></a>00555     <span class="comment">/* calculate rays through projection plane */</span>
<a name="l00556"></a>00556     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> direction = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a9bd92653e0ebe35655306388303ab5" title="Return the look at vector.">getLookat</a>() - glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a12a458dec122278135d471f389c028ac" title="Return the eye point.">getEye</a>();
<a name="l00557"></a>00557     <span class="comment">/* calculate width of screen using perpendicular triangle diven by</span>
<a name="l00558"></a>00558 <span class="comment">     * viewing direction and screen plane */</span>
<a name="l00559"></a>00559     <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> screenWidth = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(direction)*<a class="code" href="../../d0/dbc/namespaceKDL.html#a4c38a2bd6500e4df8a3312309a56fa6d">tan</a>( (glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aa7ebf0df9736652c62c2ba0e17e0611c" title="Return the field of view.">getFovy</a>()*0.5/180.0)*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> );
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <span class="comment">/* calculate vector orthogonal to up and viewing direction */</span>
<a name="l00562"></a>00562     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> upVec = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a1349f716fd3a83d779f721db507c5c22" title="Return the up vector.">getUpVec</a>();
<a name="l00563"></a>00563     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> rightVec( <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>(upVec,direction) );
<a name="l00564"></a>00564     <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(rightVec);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment">/* calculate screen plane up vector, perpendicular to viewdir and right vec */</span>
<a name="l00567"></a>00567     upVec = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>( <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>(rightVec,direction) );
<a name="l00568"></a>00568     <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(upVec);
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="comment">/* check if vectors are valid */</span>
<a name="l00571"></a>00571     <span class="keywordflow">if</span>( (<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac3d13e3c585e0ebebbb788e81b459a18">equal</a>(upVec,<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(0.0))) || (<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac3d13e3c585e0ebebbb788e81b459a18">equal</a>(rightVec,<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4006e3727805ede28b6ec98337c84427">ntlVec3Gfx</a>(0.0))) ) {
<a name="l00572"></a>00572         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;ntlWorld::renderScene&quot;</span>,<span class="stringliteral">&quot;Invalid viewpoint vectors! up=&quot;</span>&lt;&lt;upVec&lt;&lt;<span class="stringliteral">&quot; right=&quot;</span>&lt;&lt;rightVec);
<a name="l00573"></a>00573         <span class="keywordflow">return</span>(1);
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="comment">/* length from center to border of screen plane */</span>
<a name="l00577"></a>00577     rightVec *= (screenWidth*glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a659b4558bd615e0c015f2b1d5b6b14d6" title="Return the image aspect.">getAspect</a>() * -1.0);
<a name="l00578"></a>00578     upVec *= (screenWidth * -1.0);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">/* screen traversal variables */</span>
<a name="l00581"></a>00581     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> screenPos;                          <span class="comment">/* current position on virtual screen */</span>
<a name="l00582"></a>00582     <span class="keywordtype">int</span> Xres = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a06513df9ceb9069240f3a977df2ad10e" title="Return the x resolution.">getResX</a>();                  <span class="comment">/* X resolution */</span>
<a name="l00583"></a>00583     <span class="keywordtype">int</span> Yres = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a82b18e58d875cf198373380a657f444e" title="Return the y resolution.">getResY</a>();                  <span class="comment">/* Y resolution */</span>
<a name="l00584"></a>00584     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> rightStep = (rightVec/(Xres/2.0));  <span class="comment">/* one step right for a pixel */</span>
<a name="l00585"></a>00585     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> upStep    = (upVec/(Yres/2.0));     <span class="comment">/* one step up for a pixel */</span>
<a name="l00586"></a>00586     
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="comment">/* anti alias init */</span>
<a name="l00589"></a>00589     <span class="keywordtype">char</span>  showAAPic = 0;
<a name="l00590"></a>00590     <span class="keywordtype">int</span>   aaDepth = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a2210e8e4ed907bad115ae52d6d97da3c" title="Return the anti-aliasing depth.">getAADepth</a>();
<a name="l00591"></a>00591     <span class="keywordtype">int</span>   aaLength;
<a name="l00592"></a>00592     <span class="keywordflow">if</span>(aaDepth&gt;=0) aaLength = (2&lt;&lt;aaDepth);
<a name="l00593"></a>00593     <span class="keywordflow">else</span>           aaLength = 0;
<a name="l00594"></a>00594     <span class="keywordtype">float</span> aaSensRed   = 0.1;
<a name="l00595"></a>00595     <span class="keywordtype">float</span> aaSensGreen = 0.1;
<a name="l00596"></a>00596     <span class="keywordtype">float</span> aaSensBlue  = 0.1;
<a name="l00597"></a>00597     <span class="keywordtype">int</span>   aaArrayX = aaLength*Xres+1;
<a name="l00598"></a>00598     <span class="keywordtype">int</span>   aaArrayY = ( aaLength+1 );
<a name="l00599"></a>00599     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> *aaCol = <span class="keyword">new</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a>[ aaArrayX*aaArrayY ];
<a name="l00600"></a>00600     <span class="keywordtype">char</span>  *aaUse = <span class="keyword">new</span> <span class="keywordtype">char</span>[ aaArrayX*aaArrayY ];
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="comment">/* picture storage */</span>
<a name="l00603"></a>00603     <span class="keywordtype">int</span> picX = Xres;
<a name="l00604"></a>00604     <span class="keywordtype">int</span> picY = Yres;
<a name="l00605"></a>00605     <span class="keywordflow">if</span>(showAAPic) {
<a name="l00606"></a>00606         picX = Xres *aaLength+1;
<a name="l00607"></a>00607         picY = Yres *aaLength+1;
<a name="l00608"></a>00608     }
<a name="l00609"></a>00609     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> *finalPic = <span class="keyword">new</span> <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a>[picX * picY];
<a name="l00610"></a>00610 
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="comment">/* reset picture vars */</span>
<a name="l00613"></a>00613     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;aaArrayY;j++) {
<a name="l00614"></a>00614         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;aaArrayX;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00615"></a>00615             aaCol[j*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.0, 0.0, 0.0);
<a name="l00616"></a>00616             aaUse[j*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0;
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;picY;j++) {
<a name="l00620"></a>00620         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;picX;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00621"></a>00621             finalPic[j*picX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.0, 0.0, 0.0);
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="comment">/* loop over all y lines in screen, from bottom to top because</span>
<a name="l00626"></a>00626 <span class="comment">     * ppm format wants 0,0 top left */</span>
<a name="l00627"></a>00627     rendStart = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00628"></a>00628     glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a233a16d3f2479007eb9b69bacc01ed33" title="Set the ray shades counter.">setCounterShades</a>(0);
<a name="l00629"></a>00629     glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a165a2600c3e9212b7c7c5b58425e6bea" title="Set the scenen intersection counter.">setCounterSceneInter</a>(0);
<a name="l00630"></a>00630     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> scanline=Yres ; scanline &gt; 0 ; --scanline) {
<a name="l00631"></a>00631     
<a name="l00632"></a>00632         <a class="code" href="../../de/df0/utilities_8h.html#a83d7ce946a21bee51f3ea77939a60a32">debugOutInter</a>( <span class="stringliteral">&quot;ntlWorld::renderScene: Line &quot;</span>&lt;&lt;scanline&lt;&lt;
<a name="l00633"></a>00633                                  <span class="stringliteral">&quot; (&quot;</span>&lt;&lt; ((Yres-scanline)*100/Yres) &lt;&lt;<span class="stringliteral">&quot;%) &quot;</span>, 2, 2000 );
<a name="l00634"></a>00634         screenPos = glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a9bd92653e0ebe35655306388303ab5" title="Return the look at vector.">getLookat</a>() + upVec*((2.0*scanline-Yres)/Yres)
<a name="l00635"></a>00635             - rightVec;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="comment">/* loop over all pixels in line */</span>
<a name="l00638"></a>00638         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> sx=0 ; sx &lt; Xres ; ++sx) {
<a name="l00639"></a>00639 
<a name="l00640"></a>00640             <span class="keywordflow">if</span>((sx==glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a746659a557152421f79448789f2fa553" title="get the debug pixel coordinate">getDebugPixelX</a>())&amp;&amp;(scanline==(Yres-glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af1aa4123a49c3cd2b496766599a7438f" title="get the debug pixel coordinate">getDebugPixelY</a>()) )) {
<a name="l00641"></a>00641                 <span class="comment">// DEBUG!!!</span>
<a name="l00642"></a>00642                 glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a70eeb67bced9b68250e32b8abf930b91" title="Set the debug output var.">setDebugOut</a>(10);
<a name="l00643"></a>00643             } <span class="keywordflow">else</span> glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a70eeb67bced9b68250e32b8abf930b91" title="Set the debug output var.">setDebugOut</a>(0);
<a name="l00644"></a>00644             
<a name="l00645"></a>00645             <span class="comment">/* compute ray from eye through current pixel into scene... */</span>
<a name="l00646"></a>00646             <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> col;
<a name="l00647"></a>00647             <span class="keywordflow">if</span>(aaDepth&lt;0) {
<a name="l00648"></a>00648                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> dir(screenPos - glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a12a458dec122278135d471f389c028ac" title="Return the eye point.">getEye</a>());
<a name="l00649"></a>00649                 <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> the_ray(glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a12a458dec122278135d471f389c028ac" title="Return the eye point.">getEye</a>(), <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac43d14a1c6daaaff84ddd054b5c4db7d">getNormalized</a>(dir), 0, 1.0, glob );
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                 <span class="comment">/* ...and trace it */</span>
<a name="l00652"></a>00652                 col = the_ray.shade();
<a name="l00653"></a>00653             } <span class="keywordflow">else</span> {
<a name="l00654"></a>00654                 <span class="comment">/* anti alias */</span>
<a name="l00655"></a>00655                 <span class="keywordtype">int</span> ai,aj;                   <span class="comment">/* position in grid */</span>
<a name="l00656"></a>00656                 <span class="keywordtype">int</span> aOrg = sx*aaLength;      <span class="comment">/* grid offset x */</span>
<a name="l00657"></a>00657                 <span class="keywordtype">int</span> currStep = aaLength;     <span class="comment">/* step size */</span>
<a name="l00658"></a>00658                 <span class="keywordtype">char</span> colDiff = 1;            <span class="comment">/* do colors still differ too much? */</span>
<a name="l00659"></a>00659                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> minCol,maxCol;         <span class="comment">/* minimum and maximum Color Values */</span>
<a name="l00660"></a>00660                 minCol = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(1.0,1.0,1.0);
<a name="l00661"></a>00661                 maxCol = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.0,0.0,0.0);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                 <span class="keywordflow">while</span>((colDiff) &amp;&amp; (currStep&gt;0)) {
<a name="l00664"></a>00664                     colDiff = 0;
<a name="l00665"></a>00665         
<a name="l00666"></a>00666                     <span class="keywordflow">for</span>(aj = 0;aj&lt;=aaLength;aj+= currStep) {
<a name="l00667"></a>00667                         <span class="keywordflow">for</span>(ai = 0;ai&lt;=aaLength;ai+= currStep) {
<a name="l00668"></a>00668 
<a name="l00669"></a>00669                             <span class="comment">/* shade pixel if not done */</span>
<a name="l00670"></a>00670                             <span class="keywordflow">if</span>(aaUse[aj*aaArrayX +ai +aOrg] == 0) {
<a name="l00671"></a>00671                                 aaUse[aj*aaArrayX +ai +aOrg] = 1;
<a name="l00672"></a>00672                                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> aaPos( screenPos +
<a name="l00673"></a>00673                                                                 (rightStep * (ai- aaLength/2)/(<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a>)aaLength ) +
<a name="l00674"></a>00674                                                                 (upStep    * (aj- aaLength/2)/(<a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a>)aaLength ) );
<a name="l00675"></a>00675 
<a name="l00676"></a>00676                                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> dir(aaPos - glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a12a458dec122278135d471f389c028ac" title="Return the eye point.">getEye</a>());
<a name="l00677"></a>00677                                 <a class="code" href="../../d4/d54/classntlRay.html" title="the main ray class">ntlRay</a> the_ray(glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a12a458dec122278135d471f389c028ac" title="Return the eye point.">getEye</a>(), <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#ac43d14a1c6daaaff84ddd054b5c4db7d">getNormalized</a>(dir), 0, 1.0, glob );
<a name="l00678"></a>00678 
<a name="l00679"></a>00679                                 <span class="comment">/* ...and trace it */</span>
<a name="l00680"></a>00680                                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> newCol= the_ray.shade();
<a name="l00681"></a>00681                                 aaCol[aj*aaArrayX +ai +aOrg]= newCol;
<a name="l00682"></a>00682                             } <span class="comment">/* not used? */</span>
<a name="l00683"></a>00683 
<a name="l00684"></a>00684                         }
<a name="l00685"></a>00685                     }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687                     <span class="comment">/* check color differences */</span>
<a name="l00688"></a>00688                     <span class="keywordflow">for</span>(aj = 0;aj&lt;aaLength;aj+= currStep) {
<a name="l00689"></a>00689                         <span class="keywordflow">for</span>(ai = 0;ai&lt;aaLength;ai+= currStep) {
<a name="l00690"></a>00690 
<a name="l00691"></a>00691                             <span class="keywordtype">char</span> thisColDiff = 0;
<a name="l00692"></a>00692                             <span class="keywordflow">if</span>( 
<a name="l00693"></a>00693                                  (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][0] - 
<a name="l00694"></a>00694                                              aaCol[(aj+0)*aaArrayX +(ai+currStep) +aOrg][0])&gt; aaSensRed ) ||
<a name="l00695"></a>00695                                  (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][1] - 
<a name="l00696"></a>00696                                              aaCol[(aj+0)*aaArrayX +(ai+currStep) +aOrg][1])&gt; aaSensGreen ) ||
<a name="l00697"></a>00697                                  (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][2] - 
<a name="l00698"></a>00698                                              aaCol[(aj+0)*aaArrayX +(ai+currStep) +aOrg][2])&gt; aaSensBlue ) ) {
<a name="l00699"></a>00699                                 thisColDiff = 1;
<a name="l00700"></a>00700                             } <span class="keywordflow">else</span>
<a name="l00701"></a>00701                                 <span class="keywordflow">if</span>( 
<a name="l00702"></a>00702                                      (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][0] - 
<a name="l00703"></a>00703                                                  aaCol[(aj+currStep)*aaArrayX +(ai+0) +aOrg][0])&gt; aaSensRed ) ||
<a name="l00704"></a>00704                                      (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][1] - 
<a name="l00705"></a>00705                                                  aaCol[(aj+currStep)*aaArrayX +(ai+0) +aOrg][1])&gt; aaSensGreen ) ||
<a name="l00706"></a>00706                                      (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][2] - 
<a name="l00707"></a>00707                                                  aaCol[(aj+currStep)*aaArrayX +(ai+0) +aOrg][2])&gt; aaSensBlue ) ) {
<a name="l00708"></a>00708                                     thisColDiff = 1;
<a name="l00709"></a>00709                                 } <span class="keywordflow">else</span>
<a name="l00710"></a>00710                                     <span class="keywordflow">if</span>( 
<a name="l00711"></a>00711                                          (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][0] - 
<a name="l00712"></a>00712                                                      aaCol[(aj+currStep)*aaArrayX +(ai+currStep) +aOrg][0])&gt; aaSensRed ) ||
<a name="l00713"></a>00713                                          (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][1] - 
<a name="l00714"></a>00714                                                      aaCol[(aj+currStep)*aaArrayX +(ai+currStep) +aOrg][1])&gt; aaSensGreen ) ||
<a name="l00715"></a>00715                                          (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(aaCol[aj*aaArrayX +ai +aOrg][2] - 
<a name="l00716"></a>00716                                                      aaCol[(aj+currStep)*aaArrayX +(ai+currStep) +aOrg][2])&gt; aaSensBlue ) ) {
<a name="l00717"></a>00717                                         thisColDiff = 1;
<a name="l00718"></a>00718                                     } 
<a name="l00719"></a>00719 
<a name="l00720"></a>00720                             <span class="comment">//colDiff =1;</span>
<a name="l00721"></a>00721                             <span class="keywordflow">if</span>(thisColDiff) {
<a name="l00722"></a>00722                                 <span class="comment">/* set diff flag */</span>
<a name="l00723"></a>00723                                 colDiff = thisColDiff;
<a name="l00724"></a>00724                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> bj=aj;bj&lt;=aj+currStep;bj++) {
<a name="l00725"></a>00725                                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> bi=ai;bi&lt;=ai+currStep;bi++) {
<a name="l00726"></a>00726                                         <span class="keywordflow">if</span>(aaUse[bj*aaArrayX +bi +aOrg]==2) {
<a name="l00727"></a>00727                                             <span class="comment">//if(showAAPic) </span>
<a name="l00728"></a>00728                                             aaUse[bj*aaArrayX +bi +aOrg] = 0;
<a name="l00729"></a>00729                                         }
<a name="l00730"></a>00730                                     }
<a name="l00731"></a>00731                                 }
<a name="l00732"></a>00732                             } <span class="keywordflow">else</span> {
<a name="l00733"></a>00733                                 <span class="comment">/* set all values */</span>
<a name="l00734"></a>00734                                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> avgCol = (
<a name="l00735"></a>00735                                                                      aaCol[(aj+0       )*aaArrayX +(ai+0       ) +aOrg] +
<a name="l00736"></a>00736                                                                      aaCol[(aj+0       )*aaArrayX +(ai+currStep) +aOrg] +
<a name="l00737"></a>00737                                                                      aaCol[(aj+currStep)*aaArrayX +(ai+0       ) +aOrg] +
<a name="l00738"></a>00738                                                                      aaCol[(aj+currStep)*aaArrayX +(ai+currStep) +aOrg] ) *0.25;
<a name="l00739"></a>00739                                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> bj=aj;bj&lt;=aj+currStep;bj++) {
<a name="l00740"></a>00740                                     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> bi=ai;bi&lt;=ai+currStep;bi++) {
<a name="l00741"></a>00741                                         <span class="keywordflow">if</span>(aaUse[bj*aaArrayX +bi +aOrg]==0) {
<a name="l00742"></a>00742                                             aaCol[bj*aaArrayX +bi +aOrg] = avgCol; 
<a name="l00743"></a>00743                                             aaUse[bj*aaArrayX +bi +aOrg] = 2;
<a name="l00744"></a>00744                                         }
<a name="l00745"></a>00745                                     }
<a name="l00746"></a>00746                                 }
<a name="l00747"></a>00747                             } <span class="comment">/* smaller values set */</span>
<a name="l00748"></a>00748 
<a name="l00749"></a>00749                         }
<a name="l00750"></a>00750                     }
<a name="l00751"></a>00751 
<a name="l00752"></a>00752                     <span class="comment">/* half step size */</span>
<a name="l00753"></a>00753                     currStep /= 2;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755                 } <span class="comment">/* repeat until diff not too big */</span>
<a name="l00756"></a>00756 
<a name="l00757"></a>00757                 <span class="comment">/* get average color */</span>
<a name="l00758"></a>00758                 <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> colNum = 0.0;
<a name="l00759"></a>00759                 col = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.0, 0.0, 0.0);
<a name="l00760"></a>00760                 <span class="keywordflow">for</span>(aj = 0;aj&lt;=aaLength;aj++) {
<a name="l00761"></a>00761                     <span class="keywordflow">for</span>(ai = 0;ai&lt;=aaLength;ai++) {
<a name="l00762"></a>00762                         col += aaCol[aj*aaArrayX +ai +aOrg];
<a name="l00763"></a>00763                         colNum += 1.0;
<a name="l00764"></a>00764                     }
<a name="l00765"></a>00765                 }
<a name="l00766"></a>00766                 col /= colNum;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768             }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770           <span class="comment">/* mark pixels with debugging */</span>
<a name="l00771"></a>00771             <span class="keywordflow">if</span>( glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a5ef936a21567e0100f90b58463aecc2d" title="Return the debug mode setting.">getDebugOut</a>() &gt; 0) col = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0,1,0);
<a name="l00772"></a>00772 
<a name="l00773"></a>00773             <span class="comment">/* store pixel */</span>
<a name="l00774"></a>00774             <span class="keywordflow">if</span>(!showAAPic) {
<a name="l00775"></a>00775                 finalPic[(scanline-1)*picX+sx] = col; 
<a name="l00776"></a>00776             }
<a name="l00777"></a>00777             screenPos +=  rightStep;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779         } <span class="comment">/* foreach x */</span>
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="comment">/* init aa array */</span>
<a name="l00782"></a>00782         <span class="keywordflow">if</span>(showAAPic) {
<a name="l00783"></a>00783             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;=aaArrayY-1;j++) {
<a name="l00784"></a>00784                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;=aaArrayX-1;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00785"></a>00785                     <span class="keywordflow">if</span>(aaUse[j*aaArrayX +<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]==1) finalPic[((scanline-1)*aaLength +j)*picX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] = 1.0;
<a name="l00786"></a>00786                 }
<a name="l00787"></a>00787             }
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;aaArrayX;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00791"></a>00791             aaCol[(aaArrayY-1)*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = aaCol[0*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00792"></a>00792             aaUse[(aaArrayY-1)*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = aaUse[0*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00793"></a>00793         }
<a name="l00794"></a>00794         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;aaArrayY-1;j++) {
<a name="l00795"></a>00795             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;aaArrayX;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00796"></a>00796                 aaCol[j*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a325b681b6e65a5542b61d20c71eb52bc">ntlColor</a>(0.0, 0.0, 0.0);
<a name="l00797"></a>00797                 aaUse[j*aaArrayX+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 0;
<a name="l00798"></a>00798             }
<a name="l00799"></a>00799         }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801     } <span class="comment">/* foreach y */</span>
<a name="l00802"></a>00802     rendEnd = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="comment">/* write png file */</span>
<a name="l00806"></a>00806     {
<a name="l00807"></a>00807         <span class="keywordtype">int</span> w = picX;
<a name="l00808"></a>00808         <span class="keywordtype">int</span> h = picY;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         <span class="keywordtype">unsigned</span> rowbytes = w*4;
<a name="l00811"></a>00811         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *screenbuf, **rows;
<a name="l00812"></a>00812         screenbuf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)malloc( h*rowbytes );
<a name="l00813"></a>00813         rows = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>**)malloc( h*<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*) );
<a name="l00814"></a>00814         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *filler = screenbuf;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816         <span class="comment">// cutoff color values 0..1</span>
<a name="l00817"></a>00817         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;h;j++) {
<a name="l00818"></a>00818             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;w;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {
<a name="l00819"></a>00819                 <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlColor</a> col = finalPic[j*w+<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00820"></a>00820                 <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc=0; cc&lt;3; cc++) {
<a name="l00821"></a>00821                     <span class="keywordflow">if</span>(col[cc] &lt;= 0.0) col[cc] = 0.0;
<a name="l00822"></a>00822                     <span class="keywordflow">if</span>(col[cc] &gt;= 1.0) col[cc] = 1.0;
<a name="l00823"></a>00823                 }
<a name="l00824"></a>00824                 *filler = (<span class="keywordtype">unsigned</span> char)( col[0]*255.0 ); 
<a name="l00825"></a>00825                 filler++;
<a name="l00826"></a>00826                 *filler = (<span class="keywordtype">unsigned</span> char)( col[1]*255.0 ); 
<a name="l00827"></a>00827                 filler++;
<a name="l00828"></a>00828                 *filler = (<span class="keywordtype">unsigned</span> char)( col[2]*255.0 ); 
<a name="l00829"></a>00829                 filler++;
<a name="l00830"></a>00830                 *filler = (<span class="keywordtype">unsigned</span> char)( 255.0 ); 
<a name="l00831"></a>00831                 filler++; <span class="comment">// alpha channel</span>
<a name="l00832"></a>00832             }
<a name="l00833"></a>00833         }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; h; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) rows[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = &amp;screenbuf[ (h - <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> - 1)*rowbytes ];
<a name="l00836"></a>00836         <a class="code" href="../../de/da5/utilities_8cpp.html#ab30cdd2fd2ddb715b98d8e5eb61800cb" title="write png image">writePng</a>(outfn_conv.str().c_str(), rows, w, h);
<a name="l00837"></a>00837     }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <span class="comment">// next frame </span>
<a name="l00841"></a>00841     glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a0d428808fa8889fc4dc93d487a392771" title="Set the animation.">setAniCount</a>( glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a3aceaa4afc97aeeda8726a37c34f00" title="Return the animation counter.">getAniCount</a>() +1 );
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="comment">// done </span>
<a name="l00844"></a>00844     timeEnd = <a class="code" href="../../de/da5/utilities_8cpp.html#a464465f0a983105a4fd29ae7c1604927" title="get the current system time">getTime</a>();
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordtype">char</span> resout[1024];
<a name="l00847"></a>00847     <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(resout,1024, <span class="stringliteral">&quot;NTL Done %s, frame %d/%d (took %s scene, %s raytracing, %s total, %d shades, %d i.s.&#39;s)!\n&quot;</span>, 
<a name="l00848"></a>00848                  outfn_conv.str().c_str(), (glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a4a3aceaa4afc97aeeda8726a37c34f00" title="Return the animation counter.">getAniCount</a>()), (glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a903699cce9cae1a0431b099fd6f70fcd" title="Return the animation frame number.">getAniFrames</a>()+1),
<a name="l00849"></a>00849                  <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(totalStart-timeStart).c_str(), <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(rendEnd-rendStart).c_str(), <a class="code" href="../../de/da5/utilities_8cpp.html#a61ff8ca64f5e508c5142f409047f3600" title="convert time to readable string">getTimeString</a>(timeEnd-timeStart).c_str(),
<a name="l00850"></a>00850                  glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a9035d4aaefaf01c63baafdfe8a1131ed" title="Return the ray shades counter.">getCounterShades</a>(),
<a name="l00851"></a>00851                  glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#a0aec52a0271565fc5877af29c30b234c" title="Return the scene intersection counter.">getCounterSceneInter</a>() );
<a name="l00852"></a>00852     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>, resout, 1 );
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     <span class="comment">/* clean stuff up */</span>
<a name="l00855"></a>00855     <span class="keyword">delete</span> [] aaCol;
<a name="l00856"></a>00856     <span class="keyword">delete</span> [] aaUse;
<a name="l00857"></a>00857     <span class="keyword">delete</span> [] finalPic;
<a name="l00858"></a>00858     glob-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#af5ebfadac17d6ca6581c9cc1ea147828" title="Returns the renderscene manager (scene changes for each frame)">getRenderScene</a>()-&gt;<a class="code" href="../../dd/d46/classntlScene.html#a77b604a1ec69f7205b39a143c77d7ee6" title="Do some memory cleaning, when frame is finished.">cleanupScene</a>();
<a name="l00859"></a>00859 
<a name="l00860"></a>00860     <span class="keywordflow">if</span>(<a class="code" href="../../dc/d5b/classntlWorld.html#a6868920054ade72d027dc83242f2c298">mpGlob</a>-&gt;<a class="code" href="../../d0/d95/classntlRenderGlobals.html#aa6dc1628b3a677e4380c5b558808715b" title="set single frame mode flag">getSingleFrameMode</a>() ) {
<a name="l00861"></a>00861         <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;ntlWorld::renderScene&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a49b416ae327829b9acf505a5f627a272">DM_NOTIFY</a>, <span class="stringliteral">&quot;Single frame mode done...&quot;</span>, 1 );
<a name="l00862"></a>00862         <span class="keywordflow">return</span> 1;
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864 <span class="preprocessor">#endif // ELBEEM_PLUGIN</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 
<a name="l00869"></a>00869 <span class="comment">/******************************************************************************</span>
<a name="l00870"></a>00870 <span class="comment"> * renderglobals</span>
<a name="l00871"></a>00871 <span class="comment"> *****************************************************************************/</span>
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="comment">/*****************************************************************************/</span>
<a name="l00875"></a>00875 <span class="comment">/* Constructor with standard value init */</span>
<a name="l00876"></a><a class="code" href="../../d0/d95/classntlRenderGlobals.html#a9eeb95a2f345ff988e7f930624d8ef80">00876</a> <a class="code" href="../../d0/d95/classntlRenderGlobals.html#a9eeb95a2f345ff988e7f930624d8ef80" title="Standard constructor.">ntlRenderGlobals::ntlRenderGlobals</a>() :
<a name="l00877"></a>00877     mpRenderScene(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>), mpSimScene(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),
<a name="l00878"></a>00878   mpLightList( <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ), mpMaterials( <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ), mpSims( <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ),
<a name="l00879"></a>00879   mResX(320), mResY(200), mAADepth(-1), mMaxColVal(255), 
<a name="l00880"></a>00880   mRayMaxDepth( 5 ),
<a name="l00881"></a>00881   mvEye(0.0,0.0,5.0), mvLookat(0.0,0.0,0.0), mvUpvec(0.0,1.0,0.0), 
<a name="l00882"></a>00882   mAspect(320.0/200.0), 
<a name="l00883"></a>00883   mFovy(45), mcBackgr(0.0,0.0,0.0), mcAmbientLight(0.0,0.0,0.0), 
<a name="l00884"></a>00884   mDebugOut( 0 ),
<a name="l00885"></a>00885   mAniStart(0), mAniFrames( -1 ), mAniCount( 0 ),
<a name="l00886"></a>00886     mFrameSkip( 0 ),
<a name="l00887"></a>00887   mCounterRays( 0 ), mCounterShades( 0 ), mCounterSceneInter( 0 ),
<a name="l00888"></a>00888     mOutFilename( <span class="stringliteral">&quot;pic&quot;</span> ),
<a name="l00889"></a>00889     mTreeMaxDepth( 30 ), mTreeMaxTriangles( 30 ),
<a name="l00890"></a>00890     mpOpenGlAttr(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),
<a name="l00891"></a>00891     mpBlenderAttr(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),
<a name="l00892"></a>00892     mTestSphereEnabled( false ),
<a name="l00893"></a>00893     mDebugPixelX( -1 ), mDebugPixelY( -1 ), mTestMode(false),
<a name="l00894"></a>00894     mSingleFrameMode(false), mSingleFrameFilename(<span class="stringliteral">&quot;&quot;</span>)
<a name="l00895"></a>00895     <span class="comment">//,mpRndDirections( NULL ), mpRndRoulette( NULL )</span>
<a name="l00896"></a>00896 { 
<a name="l00897"></a>00897     <span class="comment">// create internal attribute list for opengl renderer</span>
<a name="l00898"></a>00898     mpOpenGlAttr = <span class="keyword">new</span> <a class="code" href="../../d3/d8d/classAttributeList.html" title="The list of configuration attributes.">AttributeList</a>(<span class="stringliteral">&quot;__ntlOpenGLRenderer&quot;</span>);
<a name="l00899"></a>00899     mpBlenderAttr = <span class="keyword">new</span> <a class="code" href="../../d3/d8d/classAttributeList.html" title="The list of configuration attributes.">AttributeList</a>(<span class="stringliteral">&quot;__ntlBlenderAttr&quot;</span>);
<a name="l00900"></a>00900 };
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="comment">/*****************************************************************************/</span>
<a name="l00904"></a>00904 <span class="comment">/* Destructor */</span>
<a name="l00905"></a><a class="code" href="../../d0/d95/classntlRenderGlobals.html#ac3da76a60e52a45a62337cc81c828b8f">00905</a> <a class="code" href="../../d0/d95/classntlRenderGlobals.html#ac3da76a60e52a45a62337cc81c828b8f" title="Destructor.">ntlRenderGlobals::~ntlRenderGlobals</a>() {
<a name="l00906"></a>00906     <span class="keywordflow">if</span>(mpOpenGlAttr) <span class="keyword">delete</span> mpOpenGlAttr;
<a name="l00907"></a>00907     <span class="keywordflow">if</span>(mpBlenderAttr) <span class="keyword">delete</span> mpBlenderAttr;
<a name="l00908"></a>00908     
<a name="l00909"></a>00909     
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 <span class="comment">/*****************************************************************************/</span>
<a name="l00915"></a>00915 <span class="comment">//ntlVec3Gfx ntlRenderGlobals::getRandomDirection( void ) { </span>
<a name="l00916"></a>00916     <span class="comment">//return ntlVec3Gfx( </span>
<a name="l00917"></a>00917             <span class="comment">//(mpRndDirections-&gt;getGfxReal()-0.5), </span>
<a name="l00918"></a>00918             <span class="comment">//(mpRndDirections-&gt;getGfxReal()-0.5),  </span>
<a name="l00919"></a>00919             <span class="comment">//(mpRndDirections-&gt;getGfxReal()-0.5) ); </span>
<a name="l00920"></a>00920 <span class="comment">//} </span>
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:37 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
