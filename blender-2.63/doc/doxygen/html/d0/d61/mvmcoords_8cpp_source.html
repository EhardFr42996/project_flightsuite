<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: mvmcoords.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">mvmcoords.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d0/d61/mvmcoords_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/******************************************************************************</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment">// El&#39;Beem - the visual lattice boltzmann freesurface simulator</span>
<a name="l00007"></a>00007 <span class="comment">// All code distributed as part of El&#39;Beem is covered by the version 2 of the </span>
<a name="l00008"></a>00008 <span class="comment">// GNU General Public License. See the file COPYING for details.  </span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">// Copyright 2008 Nils Thuerey , Richard Keiser, Mark Pauly, Ulrich Ruede</span>
<a name="l00011"></a>00011 <span class="comment">//</span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * Mean Value Mesh Coords class</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> *****************************************************************************/</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/de1/mvmcoords_8h.html">mvmcoords.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00019"></a>00019 <span class="keyword">using</span> std::vector;
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a44e0690ea4dcf18429f863d09e103f33">00021</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a44e0690ea4dcf18429f863d09e103f33">MeanValueMeshCoords::clear</a>() 
<a name="l00022"></a>00022 {
<a name="l00023"></a>00023     <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a390cd1758f689169c14108e1aed7807b">mVertices</a>.resize(0);
<a name="l00024"></a>00024     <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ac50437e020f9881c7d7a92c7cd8dbf6a">mNumVerts</a> = 0;
<a name="l00025"></a>00025 }
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a44678d14f800a23d1ffd95ba4113a666">00027</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a44678d14f800a23d1ffd95ba4113a666">MeanValueMeshCoords::calculateMVMCs</a>(vector&lt;ntlVec3Gfx&gt; &amp;reference_vertices, vector&lt;ntlTriangle&gt; &amp;tris, 
<a name="l00028"></a>00028         vector&lt;ntlVec3Gfx&gt; &amp;points, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> numweights)
<a name="l00029"></a>00029 {
<a name="l00030"></a>00030     <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a44e0690ea4dcf18429f863d09e103f33">clear</a>();
<a name="l00031"></a>00031     <a class="code" href="../../d6/d84/classmvmTransferPoint.html">mvmTransferPoint</a> tds;
<a name="l00032"></a>00032     <span class="keywordtype">int</span> mem = 0;
<a name="l00033"></a>00033     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ac50437e020f9881c7d7a92c7cd8dbf6a">mNumVerts</a> = (int)reference_vertices.size();
<a name="l00036"></a>00036 
<a name="l00037"></a>00037     <span class="keywordflow">for</span> (vector&lt;ntlVec3Gfx&gt;::iterator iter = points.begin(); iter != points.end(); ++iter, ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00038"></a>00038         <span class="comment">/*</span>
<a name="l00039"></a>00039 <span class="comment">        if(i%(points.size()/10)==1) debMsgStd(&quot;MeanValueMeshCoords::calculateMVMCs&quot;,DM_MSG,&quot;Computing weights, points: &quot;&lt;&lt;i&lt;&lt;&quot;/&quot;&lt;&lt;points.size(),5 );</span>
<a name="l00040"></a>00040 <span class="comment">        */</span>
<a name="l00041"></a>00041         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#a1aa74ad4d9f9b8942f3979d35563d95d" title="position of transfer point">lastpos</a> = *iter;
<a name="l00042"></a>00042         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.resize(0);  <span class="comment">// clear</span>
<a name="l00043"></a>00043         <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ad9b3b1b7efe6023a63405423e5718e15">computeWeights</a>(reference_vertices, tris, tds, numweights);
<a name="l00044"></a>00044         mem += (int)tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.size();
<a name="l00045"></a>00045         <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a390cd1758f689169c14108e1aed7807b">mVertices</a>.push_back(tds);
<a name="l00046"></a>00046     }    
<a name="l00047"></a>00047     <span class="keywordtype">int</span> mbmem = mem * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a>) / (1024*1024);
<a name="l00048"></a>00048     <a class="code" href="../../de/df0/utilities_8h.html#a37f52a1d684af6dd5f377d6286f09fbd">debMsgStd</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::calculateMVMCs&quot;</span>,<a class="code" href="../../de/df0/utilities_8h.html#a6114b55148a647b2cb346a8f3f4bb938">DM_MSG</a>,<span class="stringliteral">&quot;vertices:&quot;</span>&lt;&lt;<a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ac50437e020f9881c7d7a92c7cd8dbf6a">mNumVerts</a>&lt;&lt;<span class="stringliteral">&quot; points:&quot;</span>&lt;&lt;points.size()&lt;&lt;<span class="stringliteral">&quot; weights:&quot;</span>&lt;&lt;mem&lt;&lt;<span class="stringliteral">&quot;, wmem:&quot;</span>&lt;&lt;mbmem&lt;&lt;<span class="stringliteral">&quot;MB &quot;</span>,7 );
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">// from: mean value coordinates for closed triangular meshes</span>
<a name="l00052"></a>00052 <span class="comment">// attention: fails if a point is exactly (or very close) to a vertex</span>
<a name="l00053"></a><a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ad9b3b1b7efe6023a63405423e5718e15">00053</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ad9b3b1b7efe6023a63405423e5718e15">MeanValueMeshCoords::computeWeights</a>(vector&lt;ntlVec3Gfx&gt; &amp;reference_vertices, vector&lt;ntlTriangle&gt;&amp; tris,
<a name="l00054"></a>00054         <a class="code" href="../../d6/d84/classmvmTransferPoint.html">mvmTransferPoint</a>&amp; tds, <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a412b2b4fe010143b62a8019a03086110">gfxReal</a> numweights)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <span class="keyword">const</span> <span class="keywordtype">bool</span> mvmFullDebug=<span class="keyword">false</span>;
<a name="l00057"></a>00057     <span class="comment">//const ntlVec3Gfx cEPS = 1.0e-6;</span>
<a name="l00058"></a>00058     <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> cEPS = 1.0e-14;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">//mvmFloat d[3], s[3], phi[3],c[3];</span>
<a name="l00061"></a>00061     <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3d</a> u[3],c,d,s,phi;
<a name="l00062"></a>00062     <span class="keywordtype">int</span> <a class="code" href="../../d2/d6c/mball_8c.html#a47e7cc913f2b356de088363a1d87db4a">indices</a>[3];
<a name="l00063"></a>00063 
<a name="l00064"></a>00064     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; (int)reference_vertices.size(); ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l00065"></a>00065         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.push_back(<a class="code" href="../../db/da3/classmvmIndexWeight.html">mvmIndexWeight</a>(<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, 0.0));
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <span class="comment">// for each triangle</span>
<a name="l00069"></a>00069     <span class="comment">//for (vector&lt;ntlTriangle&gt;::iterator iter = tris.begin(); iter != tris.end();) {</span>
<a name="l00070"></a>00070     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> t=0; t&lt;(int)tris.size(); t++) {
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; 3; ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) { <span class="comment">//, ++iter) {</span>
<a name="l00073"></a>00073             indices[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = tris[t].getPoints()[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00074"></a>00074             u[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a4cf9be02f3d4720947423404f482018f">vec2D</a>(reference_vertices[ indices[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] ]-tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#a1aa74ad4d9f9b8942f3979d35563d95d" title="position of transfer point">lastpos</a>);
<a name="l00075"></a>00075             d[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a>(u[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]); <span class="comment">//.normalize();        </span>
<a name="l00076"></a>00076             <span class="comment">//assert(d[i] != 0.);</span>
<a name="l00077"></a>00077             <span class="keywordflow">if</span>(mvmFullDebug) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;t&quot;</span>&lt;&lt;t&lt;&lt;<span class="stringliteral">&quot; i&quot;</span>&lt;&lt;indices[i] <span class="comment">//&lt;&lt;&quot; lp&quot;&lt;&lt;tds.lastpos</span>
<a name="l00078"></a>00078                     &lt;&lt;<span class="stringliteral">&quot; v&quot;</span>&lt;&lt;reference_vertices[indices[i]]&lt;&lt;<span class="stringliteral">&quot; u&quot;</span>&lt;&lt;u[i]&lt;&lt;<span class="stringliteral">&quot; &quot;</span>);
<a name="l00079"></a>00079             <span class="comment">// on vertex!</span>
<a name="l00080"></a>00080             <span class="comment">//? if(d[i]&lt;=0.) continue;</span>
<a name="l00081"></a>00081         }
<a name="l00082"></a>00082         <span class="comment">//for (int i = 0; i &lt; 3; ++i) { errMsg(&quot;III&quot;,&quot; &quot;&lt;&lt;i     &lt;&lt;&quot; i&quot;&lt;&lt;indices[i]&lt;&lt;reference_vertices[ indices[i] ] ); }</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <span class="comment">// arcsin is not needed, see paper</span>
<a name="l00085"></a>00085         phi[0] = 2.*<a class="code" href="../../d0/dbc/namespaceKDL.html#a121a9c903f0567fd7bc000ac9df9472f">asin</a>( (<a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a>)(0.5* <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(u[1]-u[2]) )  );
<a name="l00086"></a>00086         phi[1] = 2.*<a class="code" href="../../d0/dbc/namespaceKDL.html#a121a9c903f0567fd7bc000ac9df9472f">asin</a>( (<a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a>)(0.5* <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(u[0]-u[2]) )  );
<a name="l00087"></a>00087         phi[2] = 2.*<a class="code" href="../../d0/dbc/namespaceKDL.html#a121a9c903f0567fd7bc000ac9df9472f">asin</a>( (<a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a>)(0.5* <a class="code" href="../../d1/d8e/ntl__vector3dim_8h.html#a828f653994f3f04fe2a539bc1ed64590">norm</a>(u[0]-u[1]) )  );
<a name="l00088"></a>00088         <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> h = (phi[0] + phi[1] + phi[2])*0.5;
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>-h &lt; cEPS) {
<a name="l00090"></a>00090             <span class="keywordflow">if</span>(mvmFullDebug) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;point on triangle&quot;</span>);
<a name="l00091"></a>00091             tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.resize(0);
<a name="l00092"></a>00092             tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.push_back( <a class="code" href="../../db/da3/classmvmIndexWeight.html">mvmIndexWeight</a>(indices[0], <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[0])*d[1]*d[2]));
<a name="l00093"></a>00093             tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.push_back( <a class="code" href="../../db/da3/classmvmIndexWeight.html">mvmIndexWeight</a>(indices[1], <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[1])*d[0]*d[2]));
<a name="l00094"></a>00094             tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.push_back( <a class="code" href="../../db/da3/classmvmIndexWeight.html">mvmIndexWeight</a>(indices[2], <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[2])*d[1]*d[0]));
<a name="l00095"></a>00095             <span class="keywordflow">break</span>;
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097         <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> <a class="code" href="../../d0/dbc/namespaceKDL.html#aa07a1615c5ab61a1039ccd4e51ae4a83">sinh</a> = 2.*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(h);
<a name="l00098"></a>00098         c[0] = (sinh*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(h-phi[0]))/(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[1])*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[2]))-1.;
<a name="l00099"></a>00099         c[1] = (sinh*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(h-phi[1]))/(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[0])*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[2]))-1.;    
<a name="l00100"></a>00100         c[2] = (sinh*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(h-phi[2]))/(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[0])*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[1]))-1.;   
<a name="l00101"></a>00101         <span class="keywordflow">if</span>(mvmFullDebug) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;c=&quot;</span>&lt;&lt;c&lt;&lt;<span class="stringliteral">&quot; phi=&quot;</span>&lt;&lt;phi&lt;&lt;<span class="stringliteral">&quot; d=&quot;</span>&lt;&lt;d);
<a name="l00102"></a>00102         <span class="comment">//if (c[0] &gt; 1. || c[0] &lt; 0. || c[1] &gt; 1. || c[1] &lt; 0. || c[2] &gt; 1. || c[2] &lt; 0.) continue;</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         s[0] = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>((<span class="keywordtype">float</span>)(1.-c[0]*c[0]));
<a name="l00105"></a>00105         s[1] = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>((<span class="keywordtype">float</span>)(1.-c[1]*c[1]));
<a name="l00106"></a>00106         s[2] = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>((<span class="keywordtype">float</span>)(1.-c[2]*c[2]));
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">if</span>(mvmFullDebug) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;s&quot;</span>);
<a name="l00109"></a>00109         <span class="keywordflow">if</span> (s[0] &lt;= cEPS || s[1] &lt;= cEPS || s[2] &lt;= cEPS) {
<a name="l00110"></a>00110             <span class="comment">//MSG(&quot;position lies outside the triangle on the same plane -&gt; ignore it&quot;);</span>
<a name="l00111"></a>00111             <span class="keywordflow">continue</span>;
<a name="l00112"></a>00112         }
<a name="l00113"></a>00113         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u0x = u[0][0];
<a name="l00114"></a>00114         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u0y = u[0][1];
<a name="l00115"></a>00115         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u0z = u[0][2];
<a name="l00116"></a>00116         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u1x = u[1][0];
<a name="l00117"></a>00117         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u1y = u[1][1];
<a name="l00118"></a>00118         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u1z = u[1][2];
<a name="l00119"></a>00119         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u2x = u[2][0];
<a name="l00120"></a>00120         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u2y = u[2][1];
<a name="l00121"></a>00121         <span class="keyword">const</span> <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> u2z = u[2][2];
<a name="l00122"></a>00122         <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> det = u0x*u1y*u2z - u0x*u1z*u2y + u0y*u1z*u2x - u0y*u1x*u2z + u0z*u1x*u2y - u0z*u1y*u2x;
<a name="l00123"></a>00123         <span class="comment">//assert(det != 0.);</span>
<a name="l00124"></a>00124         <span class="keywordflow">if</span> (det &lt; 0.) {
<a name="l00125"></a>00125             s[0] = -s[0];
<a name="l00126"></a>00126             s[1] = -s[1];
<a name="l00127"></a>00127             s[2] = -s[2];
<a name="l00128"></a>00128         }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[0]].weight += (phi[0]-c[1]*phi[2]-c[2]*phi[1])/(d[0]*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[1])*s[2]);
<a name="l00131"></a>00131         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[1]].weight += (phi[1]-c[2]*phi[0]-c[0]*phi[2])/(d[1]*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[2])*s[0]);
<a name="l00132"></a>00132         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[2]].weight += (phi[2]-c[0]*phi[1]-c[1]*phi[0])/(d[2]*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(phi[0])*s[1]);
<a name="l00133"></a>00133         <span class="keywordflow">if</span>(mvmFullDebug) { <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;i&quot;</span>&lt;&lt;indices[0]&lt;&lt;<span class="stringliteral">&quot; o&quot;</span>&lt;&lt;tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[0]].weight);
<a name="l00134"></a>00134         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;i&quot;</span>&lt;&lt;indices[1]&lt;&lt;<span class="stringliteral">&quot; o&quot;</span>&lt;&lt;tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[1]].weight);
<a name="l00135"></a>00135         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;i&quot;</span>&lt;&lt;indices[2]&lt;&lt;<span class="stringliteral">&quot; o&quot;</span>&lt;&lt;tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>[indices[2]].weight);
<a name="l00136"></a>00136         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;\n\n\n&quot;</span>); }
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <span class="comment">//sort weights</span>
<a name="l00140"></a>00140     <span class="keywordflow">if</span>((numweights&gt;0.)&amp;&amp; (numweights&lt;1.) ) {
<a name="l00141"></a>00141     <span class="comment">//if( ((int)tds.weights.size() &gt; maxNumWeights) &amp;&amp; (maxNumWeights &gt; 0) ) {</span>
<a name="l00142"></a>00142       <span class="keywordtype">int</span> maxNumWeights = (int)(tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.size()*numweights);
<a name="l00143"></a>00143         <span class="keywordflow">if</span>(maxNumWeights&lt;=0) maxNumWeights = 1;
<a name="l00144"></a>00144         <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a8ca6e915111ca3310e3298a7ab69b111">std::sort</a>(tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.begin(), tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.end(), std::greater&lt;mvmIndexWeight&gt;());
<a name="l00145"></a>00145         <span class="comment">// only use maxNumWeights-th largest weights</span>
<a name="l00146"></a>00146         tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.resize(maxNumWeights);
<a name="l00147"></a>00147     }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="comment">// normalize weights</span>
<a name="l00150"></a>00150     <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> totalWeight = 0.;
<a name="l00151"></a>00151     <span class="keywordflow">for</span> (vector&lt;mvmIndexWeight&gt;::const_iterator witer = tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.begin();
<a name="l00152"></a>00152             witer != tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.end(); ++witer) {
<a name="l00153"></a>00153         totalWeight += witer-&gt;weight;
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     <a class="code" href="../../d2/de1/mvmcoords_8h.html#a40a305a2061b9eae50488373aeaf34c2">mvmFloat</a> invTotalWeight;
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (totalWeight == 0.) {
<a name="l00157"></a>00157         <span class="keywordflow">if</span>(mvmFullDebug) <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::computeWeights&quot;</span>,<span class="stringliteral">&quot;totalWeight == 0&quot;</span>);
<a name="l00158"></a>00158         invTotalWeight = 0.0;
<a name="l00159"></a>00159     } <span class="keywordflow">else</span> {
<a name="l00160"></a>00160         invTotalWeight = 1.0/totalWeight;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="keywordflow">for</span> (vector&lt;mvmIndexWeight&gt;::iterator viter = tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.begin();
<a name="l00164"></a>00164             viter != tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.end(); ++viter) {
<a name="l00165"></a>00165         viter-&gt;weight *= invTotalWeight;  
<a name="l00166"></a>00166         <span class="comment">//assert(finite(viter-&gt;weight) != 0);</span>
<a name="l00167"></a>00167         <span class="keywordflow">if</span>(!finite(viter-&gt;weight)) viter-&gt;weight=0.;
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a339ea13e7971e475a4a91610d1ce8d2f">00171</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a339ea13e7971e475a4a91610d1ce8d2f">MeanValueMeshCoords::transfer</a>(vector&lt;ntlVec3Gfx&gt; &amp;<a class="code" href="../../d9/d0b/structvertices.html">vertices</a>, vector&lt;ntlVec3Gfx&gt;&amp; displacements) 
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     displacements.resize(0);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">//debMsgStd(&quot;MeanValueMeshCoords::transfer&quot;,DM_MSG,&quot;vertices:&quot;&lt;&lt;mNumVerts&lt;&lt;&quot; curr_verts:&quot;&lt;&lt;vertices.size()&lt;&lt;&quot; &quot;,7 );</span>
<a name="l00176"></a>00176     <span class="keywordflow">if</span>((<span class="keywordtype">int</span>)vertices.size() != <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ac50437e020f9881c7d7a92c7cd8dbf6a">mNumVerts</a>) {
<a name="l00177"></a>00177         <a class="code" href="../../de/df0/utilities_8h.html#aad5a3b2a920c31f4f4a4252c949c6c71">errMsg</a>(<span class="stringliteral">&quot;MeanValueMeshCoords::transfer&quot;</span>,<span class="stringliteral">&quot;Different no of verts: &quot;</span>&lt;&lt;vertices.size()&lt;&lt;<span class="stringliteral">&quot; vs &quot;</span>&lt;&lt;<a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#ac50437e020f9881c7d7a92c7cd8dbf6a">mNumVerts</a>);
<a name="l00178"></a>00178         <span class="keywordflow">return</span>;
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="keywordflow">for</span> (vector&lt;mvmTransferPoint&gt;::iterator titer = <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a390cd1758f689169c14108e1aed7807b">mVertices</a>.begin(); titer != <a class="code" href="../../d1/df6/classMeanValueMeshCoords.html#a390cd1758f689169c14108e1aed7807b">mVertices</a>.end(); ++titer) {
<a name="l00182"></a>00182         <a class="code" href="../../d6/d84/classmvmTransferPoint.html">mvmTransferPoint</a> &amp;tds = *titer;
<a name="l00183"></a>00183         <a class="code" href="../../dc/d7e/classntlVector3Dim.html">ntlVec3Gfx</a> newpos(0.0);
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="keywordflow">for</span> (vector&lt;mvmIndexWeight&gt;::iterator witer = tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.begin();
<a name="l00186"></a>00186                 witer != tds.<a class="code" href="../../d6/d84/classmvmTransferPoint.html#aad38e6e9e46c033c4fcd0a4f66a46bb7" title="triangle weights">weights</a>.end(); ++witer) {
<a name="l00187"></a>00187             newpos += vertices[witer-&gt;index] * witer-&gt;weight;
<a name="l00188"></a>00188             <span class="comment">//errMsg(&quot;transfer&quot;,&quot;np&quot;&lt;&lt;newpos&lt;&lt;&quot; v&quot;&lt;&lt;vertices[witer-&gt;index]&lt;&lt;&quot; w&quot;&lt;&lt; witer-&gt;weight);</span>
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         displacements.push_back(newpos);
<a name="l00192"></a>00192         <span class="comment">//displacements.push_back(newpos - tds.lastpos);</span>
<a name="l00193"></a>00193         <span class="comment">//tds.lastpos = newpos;</span>
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:34 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
