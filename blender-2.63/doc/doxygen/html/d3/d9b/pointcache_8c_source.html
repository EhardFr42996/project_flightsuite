<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: pointcache.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">pointcache.c</div>  </div>
</div>
<div class="contents">
<a href="../../d3/d9b/pointcache_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Campbell Barton &lt;ideasman42@gmail.com&gt;</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dfb/DNA__ID_8h.html" title="ID and Library types, which are fundamental for sdna.">DNA_ID.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d70/DNA__cloth__types_8h.html">DNA_cloth_types.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html">DNA_dynamicpaint_types.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../da/df0/DNA__modifier__types_8h.html">DNA_modifier_types.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d60/DNA__object__force_8h.html">DNA_object_force.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html">DNA_particle_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d8b/DNA__smoke__types_8h.html">DNA_smoke_types.h</a>&quot;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/ddf/BKE__blender_8h.html" title="Blender util stuff.">BKE_blender.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d17/BKE__cloth_8h.html">BKE_cloth.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html">BKE_dynamicpaint.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dca/BKE__particle_8h.html">BKE_particle.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d45/BKE__pointcache_8h.html">BKE_pointcache.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d58/BKE__smoke_8h.html">BKE_smoke.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df9/BKE__softbody_8h.html">BKE_softbody.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dd6/BIK__api_8h.html">BIK_api.h</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/* both in intern */</span>
<a name="l00077"></a>00077 <span class="preprocessor">#ifdef WITH_SMOKE</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dc/d83/smoke__API_8h.html">smoke_API.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">#ifdef WITH_LZO</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#include &quot;minilzo.h&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#else</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="comment">/* used for non-lzo cases */</span>
<a name="l00085"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">00085</a> <span class="preprocessor">#define LZO_OUT_LEN(size)     ((size) + (size) / 16 + 64 + 3)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a>00088 <span class="preprocessor">#ifdef WITH_LZMA</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#include &quot;LzmaLib.h&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#endif</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a>00092 <span class="comment">/* needed for directory lookup */</span>
<a name="l00093"></a>00093 <span class="comment">/* untitled blend&#39;s need getpid for a unique name */</span>
<a name="l00094"></a>00094 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;dirent.h&gt;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#  include &lt;unistd.h&gt;</span>
<a name="l00097"></a>00097 <span class="preprocessor">#else</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;process.h&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#  include &quot;<a class="code" href="../../d9/ded/BLI__winstuff_8h.html" title="Compatibility-like things for windows.">BLI_winstuff.h</a>&quot;</span>
<a name="l00100"></a>00100 <span class="preprocessor">#endif</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">00102</a> <span class="preprocessor">#define PTCACHE_DATA_FROM(data, type, from)     if (data[type]) { memcpy(data[type], from, ptcache_data_size[type]); }</span>
<a name="l00103"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">00103</a> <span class="preprocessor"></span><span class="preprocessor">#define PTCACHE_DATA_TO(data, type, index, to)  if (data[type]) { memcpy(to, (char*)data[type] + (index ? index * ptcache_data_size[type] : 0), ptcache_data_size[type]); }</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a>00105 <span class="comment">/* could be made into a pointcache option */</span>
<a name="l00106"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aae84befa814019778003a56b877e7f19">00106</a> <span class="preprocessor">#define DURIAN_POINTCACHE_LIB_OK 1</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">00108</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[] = {  
<a name="l00109"></a>00109         <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> int), <span class="comment">// BPHYS_DATA_INDEX</span>
<a name="l00110"></a>00110         3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="comment">// BPHYS_DATA_LOCATION</span>
<a name="l00111"></a>00111         3 * <span class="keyword">sizeof</span>(float), <span class="comment">// BPHYS_DATA_VELOCITY</span>
<a name="l00112"></a>00112         4 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="comment">// BPHYS_DATA_ROTATION</span>
<a name="l00113"></a>00113         3 * <span class="keyword">sizeof</span>(float), <span class="comment">// BPHYS_DATA_AVELOCITY / BPHYS_DATA_XCONST</span>
<a name="l00114"></a>00114         <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>), <span class="comment">// BPHYS_DATA_SIZE</span>
<a name="l00115"></a>00115         3 * <span class="keyword">sizeof</span>(float), <span class="comment">// BPHYS_DATA_TIMES</span>
<a name="l00116"></a>00116         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/de4/structBoidData.html">BoidData</a>) <span class="comment">// case BPHYS_DATA_BOIDS</span>
<a name="l00117"></a>00117 };
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">00119</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[] = {
<a name="l00120"></a>00120     0,
<a name="l00121"></a>00121     <span class="keyword">sizeof</span>(<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a30bc680d29d45ab3fcfafcb3dbe4307e">ParticleSpring</a>)
<a name="l00122"></a>00122 };
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="comment">/* forward declerations */</span>
<a name="l00125"></a>00125 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *result, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>);
<a name="l00126"></a>00126 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out, <span class="keywordtype">int</span> mode);
<a name="l00127"></a>00127 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keyword">const</span> <span class="keywordtype">void</span> *f, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>);
<a name="l00128"></a>00128 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *f, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/* Common functions */</span>
<a name="l00131"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">00131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>=0;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">/* Custom functions should read these basic elements too! */</span>
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (!error &amp;&amp; !fread(&amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l00137"></a>00137         error = 1;
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (!error &amp;&amp; !fread(&amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l00140"></a>00140         error = 1;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="keywordflow">return</span> !<a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l00143"></a>00143 }
<a name="l00144"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">00144</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <span class="comment">/* Custom functions should write these basic elements too! */</span>
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (!fwrite(&amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l00148"></a>00148         <span class="keywordflow">return</span> 0;
<a name="l00149"></a>00149     
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (!fwrite(&amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l00151"></a>00151         <span class="keywordflow">return</span> 0;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="keywordflow">return</span> 1;
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 <span class="comment">/* Softbody functions */</span>
<a name="l00156"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a616b6cb81d66dbc71d3db21ecb3e4dcf">00156</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a616b6cb81d66dbc71d3db21ecb3e4dcf">ptcache_softbody_write</a>(<span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>, <span class="keywordtype">void</span> *soft_v, <span class="keywordtype">void</span> **<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *soft= soft_v;
<a name="l00159"></a>00159     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp = soft-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l00162"></a>00162     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordflow">return</span> 1;
<a name="l00165"></a>00165 }
<a name="l00166"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a5eb8b5654d9ed2c476b32787a8ef2872">00166</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a5eb8b5654d9ed2c476b32787a8ef2872">ptcache_softbody_read</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *soft_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra), <span class="keywordtype">float</span> *old_data)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *soft= soft_v;
<a name="l00169"></a>00169     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp = soft-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (old_data) {
<a name="l00172"></a>00172         memcpy(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, data, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00173"></a>00173         memcpy(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, data + 3, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     <span class="keywordflow">else</span> {
<a name="l00176"></a>00176         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, 0, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l00177"></a>00177         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, 0, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179 }
<a name="l00180"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aa2bd5d23f2cdb76a529b5008c8e3efe9">00180</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aa2bd5d23f2cdb76a529b5008c8e3efe9">ptcache_softbody_interpolate</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *soft_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> cfra, <span class="keywordtype">float</span> cfra1, <span class="keywordtype">float</span> cfra2, <span class="keywordtype">float</span> *old_data)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *soft= soft_v;
<a name="l00183"></a>00183     <a class="code" href="../../d4/d8a/structBodyPoint.html">BodyPoint</a> *bp = soft-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#afb9eac0e2c3fe1db404aebfcc65bc81d">bpoint</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00184"></a>00184     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> keys[4];
<a name="l00185"></a>00185     <span class="keywordtype">float</span> dfra;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (cfra1 == cfra2)
<a name="l00188"></a>00188         <span class="keywordflow">return</span>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(keys[1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>);
<a name="l00191"></a>00191     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(keys[1].vel, bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (old_data) {
<a name="l00194"></a>00194         memcpy(keys[2].co, old_data, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00195"></a>00195         memcpy(keys[2].vel, old_data + 3, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     <span class="keywordflow">else</span>
<a name="l00198"></a>00198         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#abf52e2a5b602c1d933a1c6e48258e07a">BKE_ptcache_make_particle_key</a>(keys+2, 0, data, cfra2);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     dfra = cfra2 - cfra1;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[1].vel, dfra);
<a name="l00203"></a>00203     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[2].vel, dfra);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <a class="code" href="../../db/dca/BKE__particle_8h.html#a51e4b5809d577b25da097a393c78d296">psys_interpolate_particle</a>(-1, keys, (cfra - cfra1) / dfra, keys, 1);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, 1.0f / dfra);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a1526eb04c94f3e53802d999ef858f778">pos</a>, keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00210"></a>00210     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(bp-&gt;<a class="code" href="../../d4/d8a/structBodyPoint.html#a28aaade4d09e96bee764cfa4e4882a87">vec</a>, keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l00211"></a>00211 }
<a name="l00212"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aafcf9d7940b2980373b293f684f19c82">00212</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#aafcf9d7940b2980373b293f684f19c82">ptcache_softbody_totpoint</a>(<span class="keywordtype">void</span> *soft_v, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214     <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *soft= soft_v;
<a name="l00215"></a>00215     <span class="keywordflow">return</span> soft-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a7e96b191e53a4d3061415745b1226aaa">totpoint</a>;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 <span class="comment">/* Particle functions */</span>
<a name="l00218"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a3b159c1fbd56299a3ee290f6915f2d7a">00218</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#abf52e2a5b602c1d933a1c6e48258e07a">BKE_ptcache_make_particle_key</a>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> *key, <span class="keywordtype">int</span> index, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> time)
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220     <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, index, key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00221"></a>00221     <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, index, key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     <span class="comment">/* no rotation info, so make something nice up */</span>
<a name="l00224"></a>00224     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>]==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00225"></a>00225         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#afb9156556a1562b1debeb6d586859524">vec_to_quat</a>( key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a2295440d7a006e657cfafb937e52b163">OB_NEGX</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a71f4ff65774e1fb89e9326d6506e1580">OB_POSZ</a>);
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227     <span class="keywordflow">else</span> {
<a name="l00228"></a>00228         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>, index, key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>, index, key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l00232"></a>00232     key-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = time;
<a name="l00233"></a>00233 }
<a name="l00234"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#adeb1e809c41ebe353e590df4d02fabae">00234</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#adeb1e809c41ebe353e590df4d02fabae">ptcache_particle_write</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *psys_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">int</span> cfra)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= psys_v;
<a name="l00237"></a>00237     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00238"></a>00238     <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *boid = (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>) ? pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00239"></a>00239     <span class="keywordtype">float</span> times[3];
<a name="l00240"></a>00240     <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a>;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="comment">/* No need to store unborn or died particles outside cache step bounds */</span>
<a name="l00243"></a>00243     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>] &amp;&amp; (cfra &lt; pa-&gt;time - <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> || cfra &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> + <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>))
<a name="l00244"></a>00244         <span class="keywordflow">return</span> 0;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     times[0]= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>;
<a name="l00247"></a>00247     times[1]= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>;
<a name="l00248"></a>00248     times[2]= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a>;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>, &amp;index);
<a name="l00251"></a>00251     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00252"></a>00252     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l00253"></a>00253     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>);
<a name="l00254"></a>00254     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a1a1abb763544678adb29ac1305ca63b9">ave</a>);
<a name="l00255"></a>00255     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4ba18d7005288eb8c8ffd716b2d74403">BPHYS_DATA_SIZE</a>, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>);
<a name="l00256"></a>00256     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a43c9b1cefacb99d22a41acec469386be">BPHYS_DATA_TIMES</a>, times);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (boid)
<a name="l00259"></a>00259         <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45c8fc7edea3203df76f8118ac9e6b19">BPHYS_DATA_BOIDS</a>, &amp;boid-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="comment">/* return flag 1+1=2 for newly born particles to copy exact birth location to previously cached frame */</span>
<a name="l00262"></a>00262     <span class="keywordflow">return</span> 1 + (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> &gt;= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> &amp;&amp; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> &lt;= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>);
<a name="l00263"></a>00263 }
<a name="l00264"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a8cd00005a48c0f38aca431729253c874">00264</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a8cd00005a48c0f38aca431729253c874">ptcache_particle_read</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *psys_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> cfra, <span class="keywordtype">float</span> *old_data)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= psys_v;
<a name="l00267"></a>00267     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa;
<a name="l00268"></a>00268     <a class="code" href="../../da/df5/structBoidParticle.html">BoidParticle</a> *boid;
<a name="l00269"></a>00269     <span class="keywordtype">float</span> timestep = 0.04f*psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a6df6ee5d66e3d778472b97590dd74ad3">timetweak</a>;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (index &gt;= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>)
<a name="l00272"></a>00272         <span class="keywordflow">return</span>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     pa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00275"></a>00275     boid = (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>) ? pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0605ad1a4ab015c2c627b8dc91e5b93c">boid</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (cfra &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>)
<a name="l00278"></a>00278         memcpy(&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a>));
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (old_data) {
<a name="l00281"></a>00281         <span class="comment">/* old format cache */</span>
<a name="l00282"></a>00282         memcpy(&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, old_data, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a>));
<a name="l00283"></a>00283         <span class="keywordflow">return</span>;
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#abf52e2a5b602c1d933a1c6e48258e07a">BKE_ptcache_make_particle_key</a>(&amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, 0, data, cfra);
<a name="l00287"></a>00287 
<a name="l00288"></a>00288     <span class="comment">/* set frames cached before birth to birth time */</span>
<a name="l00289"></a>00289     <span class="keywordflow">if</span> (cfra &lt; pa-&gt;time)
<a name="l00290"></a>00290         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>;
<a name="l00291"></a>00291     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfra &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>)
<a name="l00292"></a>00292         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4ba18d7005288eb8c8ffd716b2d74403">BPHYS_DATA_SIZE</a>])
<a name="l00295"></a>00295         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, BPHYS_DATA_SIZE, 0, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a4cd9a6f1328a2b83a7a27c8d38f2cbf6">size</a>);
<a name="l00296"></a>00296     
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a43c9b1cefacb99d22a41acec469386be">BPHYS_DATA_TIMES</a>]) {
<a name="l00298"></a>00298         <span class="keywordtype">float</span> times[3];
<a name="l00299"></a>00299         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, BPHYS_DATA_TIMES, 0, &amp;times);
<a name="l00300"></a>00300         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> = times[0];
<a name="l00301"></a>00301         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> = times[1];
<a name="l00302"></a>00302         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a46996559ec8d16d89fff3baeb96b0abf">lifetime</a> = times[2];
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (boid)
<a name="l00306"></a>00306         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45c8fc7edea3203df76f8118ac9e6b19">BPHYS_DATA_BOIDS</a>, 0, &amp;boid-&gt;<a class="code" href="../../da/df5/structBoidParticle.html#a8afb53f7799acc747c40dd3882f8814c">data</a>);
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="comment">/* determine velocity from previous location */</span>
<a name="l00309"></a>00309     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>] &amp;&amp; !data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>]) {
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (cfra &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>) {
<a name="l00311"></a>00311             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00312"></a>00312             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, (cfra - pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a>) * timestep);
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314         <span class="keywordflow">else</span> {
<a name="l00315"></a>00315             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00316"></a>00316             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, (pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a3378d1560fc77d3842f910e38b2c7078">prev_state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> - cfra) * timestep);
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="comment">/* default to no rotation */</span>
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>] &amp;&amp; !data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>]) {
<a name="l00322"></a>00322         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[0]=1.0f;
<a name="l00323"></a>00323         pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[1]=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[2]=pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>[3]=0;
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325 }
<a name="l00326"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a8e213c97ff5a8b486ffb64ac030595c7">00326</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a8e213c97ff5a8b486ffb64ac030595c7">ptcache_particle_interpolate</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *psys_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> cfra, <span class="keywordtype">float</span> cfra1, <span class="keywordtype">float</span> cfra2, <span class="keywordtype">float</span> *old_data)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= psys_v;
<a name="l00329"></a>00329     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa;
<a name="l00330"></a>00330     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> keys[4];
<a name="l00331"></a>00331     <span class="keywordtype">float</span> dfra, timestep = 0.04f*psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a6df6ee5d66e3d778472b97590dd74ad3">timetweak</a>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (index &gt;= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>)
<a name="l00334"></a>00334         <span class="keywordflow">return</span>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     pa = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">/* particle wasn&#39;t read from first cache so can&#39;t interpolate */</span>
<a name="l00339"></a>00339     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)cfra1 &lt; pa-&gt;time - psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a> || (<span class="keywordtype">int</span>)cfra1 &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a> + psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a>)
<a name="l00340"></a>00340         <span class="keywordflow">return</span>;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     cfra = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(cfra, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>);
<a name="l00343"></a>00343     cfra1 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(cfra1, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>);
<a name="l00344"></a>00344     cfra2 = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(cfra2, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#acccb02a763b098fdf5056d256598bfcf">dietime</a>);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (cfra1 == cfra2)
<a name="l00347"></a>00347         <span class="keywordflow">return</span>;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     memcpy(keys+1, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a>));
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (old_data)
<a name="l00351"></a>00351         memcpy(keys+2, old_data, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a>));
<a name="l00352"></a>00352     <span class="keywordflow">else</span>
<a name="l00353"></a>00353         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#abf52e2a5b602c1d933a1c6e48258e07a">BKE_ptcache_make_particle_key</a>(keys+2, 0, data, cfra2);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="comment">/* determine velocity from previous location */</span>
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>] &amp;&amp; !data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>]) {
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (keys[1].time &gt; keys[2].time) {
<a name="l00358"></a>00358             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(keys[2].vel, keys[1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, keys[2].co);
<a name="l00359"></a>00359             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[2].vel, (keys[1].time - keys[2].time) * timestep);
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361         <span class="keywordflow">else</span> {
<a name="l00362"></a>00362             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(keys[2].vel, keys[2].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, keys[1].co);
<a name="l00363"></a>00363             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[2].vel, (keys[2].time - keys[1].time) * timestep);
<a name="l00364"></a>00364         }
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="comment">/* determine rotation from velocity */</span>
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>] &amp;&amp; !data[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>]) {
<a name="l00369"></a>00369         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#afb9156556a1562b1debeb6d586859524">vec_to_quat</a>( keys[2].<a class="code" href="../../df/d5a/svm__noise_8h.html#aae44e21ada356d9d84450d5440fbb0c4">rot</a>,keys[2].vel, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a2295440d7a006e657cfafb937e52b163">OB_NEGX</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a71f4ff65774e1fb89e9326d6506e1580">OB_POSZ</a>);
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (cfra &gt; pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>)
<a name="l00373"></a>00373         cfra1 = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(cfra1, pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a>);
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     dfra = cfra2 - cfra1;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[1].vel, dfra * timestep);
<a name="l00378"></a>00378     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[2].vel, dfra * timestep);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <a class="code" href="../../db/dca/BKE__particle_8h.html#a51e4b5809d577b25da097a393c78d296">psys_interpolate_particle</a>(-1, keys, (cfra - cfra1) / dfra, &amp;pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>, 1);
<a name="l00381"></a>00381     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#aabc8b501c8bcfe8a37ecfc39661b07d9">interp_qt_qtqt</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, keys[1].<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, keys[2].<a class="code" href="../../d3/d31/structParticleKey.html#a33ddd3b5915822847448bee82089feea">rot</a>, (cfra - cfra1) / dfra);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, 1.f / (dfra * timestep));
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#a0e6ed09763e5a4103e1e12a2cf61d970">state</a>.<a class="code" href="../../d3/d31/structParticleKey.html#aa16173a033cec6443d22d89550e7b0b6">time</a> = cfra;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00388"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af8326423f718431d40801aee6aba0a76">00388</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#af8326423f718431d40801aee6aba0a76">ptcache_particle_totpoint</a>(<span class="keywordtype">void</span> *psys_v, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = psys_v;
<a name="l00391"></a>00391     <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l00392"></a>00392 }
<a name="l00393"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a25c8ceaff9db856627d77fe25807b247">00393</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a25c8ceaff9db856627d77fe25807b247">ptcache_particle_totwrite</a>(<span class="keywordtype">void</span> *psys_v, <span class="keywordtype">int</span> cfra)
<a name="l00394"></a>00394 {
<a name="l00395"></a>00395     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = psys_v;
<a name="l00396"></a>00396     <a class="code" href="../../dc/d76/structParticleData.html">ParticleData</a> *pa= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a27f735cb50764ca866693a88b0e9ec5d">particles</a>;
<a name="l00397"></a>00397     <span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a>;
<a name="l00398"></a>00398     <span class="keywordtype">int</span> totwrite = 0;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (cfra == 0)
<a name="l00401"></a>00401         <span class="keywordflow">return</span> psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>;
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="keywordflow">for</span> (p=0; p&lt;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ab52fdf06eac31dc7129f874718284014">totpart</a>; p++,pa++)
<a name="l00404"></a>00404         totwrite += (cfra &gt;= pa-&gt;<a class="code" href="../../dc/d76/structParticleData.html#ae6722db00f35e282a732461109f8565e">time</a> - step &amp;&amp; cfra &lt;= pa-&gt;dietime + step);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keywordflow">return</span> totwrite;
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ae3d1cb6dff0b1e6d2af30e63e52e6020">00409</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#ae3d1cb6dff0b1e6d2af30e63e52e6020">ptcache_particle_extra_write</a>(<span class="keywordtype">void</span> *psys_v, <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = psys_v;
<a name="l00412"></a>00412     <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a> &amp;&amp;
<a name="l00415"></a>00415         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a52543435c6331404504cf2e8ff560dab">SPH_VISCOELASTIC_SPRINGS</a> &amp;&amp;
<a name="l00416"></a>00416         psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>) {
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         extra = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a>), <span class="stringliteral">&quot;Point cache: fluid extra data&quot;</span>);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a> = <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a22d44a97a36790bcd617c0088b1b4a99">BPHYS_EXTRA_FLUID_SPRINGS</a>;
<a name="l00421"></a>00421         extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a>;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> * <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>], <span class="stringliteral">&quot;Point cache: extra data&quot;</span>);
<a name="l00424"></a>00424         memcpy(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>, extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> * <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>]);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>, extra);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aac065da409926abe500a03b69ae24892">00430</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aac065da409926abe500a03b69ae24892">ptcache_particle_extra_read</a>(<span class="keywordtype">void</span> *psys_v, <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = psys_v;
<a name="l00433"></a>00433     <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">for</span> (; extra; extra=extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a652f1bab30cf02b3519b372fc168c5bf">next</a>) {
<a name="l00436"></a>00436         <span class="keywordflow">switch</span>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>) {
<a name="l00437"></a>00437             <span class="keywordflow">case</span> <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a22d44a97a36790bcd617c0088b1b4a99">BPHYS_EXTRA_FLUID_SPRINGS</a>:
<a name="l00438"></a>00438             {
<a name="l00439"></a>00439                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>)
<a name="l00440"></a>00440                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a>);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a0809cf17c48f503b178fbf788c0f0235">fluid_springs</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>);
<a name="l00443"></a>00443                 psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a17e89410420b3b119c941e20834ea58d">tot_fluidsprings</a> = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ace7c2cd575dc07558017b803146997ef">alloc_fluidsprings</a> = extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>;
<a name="l00444"></a>00444                 <span class="keywordflow">break</span>;
<a name="l00445"></a>00445             }
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="comment">/* Cloth functions */</span>
<a name="l00451"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a894360e2c03f09895b371cf91ec9f5d7">00451</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a894360e2c03f09895b371cf91ec9f5d7">ptcache_cloth_write</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *cloth_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453     <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd= cloth_v;
<a name="l00454"></a>00454     <a class="code" href="../../d7/d35/structCloth.html">Cloth</a> *cloth= clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a73cb41a7ce0ccf4ee8d5c6597307702e">clothObject</a>;
<a name="l00455"></a>00455     <a class="code" href="../../d2/dc4/structClothVertex.html">ClothVertex</a> *vert = cloth-&gt;<a class="code" href="../../d7/d35/structCloth.html#abb55dfde9f8197852a25fe2c776686ed">verts</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a9394c1e84c2e8f0e36a9a79bb87265de">x</a>);
<a name="l00458"></a>00458     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a98dfb569724cfc1c0d60989cced30e69">v</a>);
<a name="l00459"></a>00459     <a class="code" href="../../d3/d9b/pointcache_8c.html#a0fc0d0b1ccca320fc897db264b89e8b5">PTCACHE_DATA_FROM</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae9ce0b34d794b0d59340175e6b58ccaa">BPHYS_DATA_XCONST</a>, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#aec9787aff2bd7f41326329f18138a740">xconst</a>);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="keywordflow">return</span> 1;
<a name="l00462"></a>00462 }
<a name="l00463"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a39ebe99e329d4b6dd6e8be838d882af4">00463</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a39ebe99e329d4b6dd6e8be838d882af4">ptcache_cloth_read</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *cloth_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra), <span class="keywordtype">float</span> *old_data)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd= cloth_v;
<a name="l00466"></a>00466     <a class="code" href="../../d7/d35/structCloth.html">Cloth</a> *cloth= clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a73cb41a7ce0ccf4ee8d5c6597307702e">clothObject</a>;
<a name="l00467"></a>00467     <a class="code" href="../../d2/dc4/structClothVertex.html">ClothVertex</a> *vert = cloth-&gt;<a class="code" href="../../d7/d35/structCloth.html#abb55dfde9f8197852a25fe2c776686ed">verts</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00468"></a>00468     
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (old_data) {
<a name="l00470"></a>00470         memcpy(vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a9394c1e84c2e8f0e36a9a79bb87265de">x</a>, data, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00471"></a>00471         memcpy(vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#aec9787aff2bd7f41326329f18138a740">xconst</a>, data + 3, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00472"></a>00472         memcpy(vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a98dfb569724cfc1c0d60989cced30e69">v</a>, data + 6, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474     <span class="keywordflow">else</span> {
<a name="l00475"></a>00475         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>, 0, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a9394c1e84c2e8f0e36a9a79bb87265de">x</a>);
<a name="l00476"></a>00476         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>, 0, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a98dfb569724cfc1c0d60989cced30e69">v</a>);
<a name="l00477"></a>00477         <a class="code" href="../../d3/d9b/pointcache_8c.html#ad6bd231ed0ca3ff5a55877144d9a6347">PTCACHE_DATA_TO</a>(data, <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae9ce0b34d794b0d59340175e6b58ccaa">BPHYS_DATA_XCONST</a>, 0, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#aec9787aff2bd7f41326329f18138a740">xconst</a>);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 }
<a name="l00480"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ac573991ef4867ef601f01fd19d65c4c0">00480</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#ac573991ef4867ef601f01fd19d65c4c0">ptcache_cloth_interpolate</a>(<span class="keywordtype">int</span> index, <span class="keywordtype">void</span> *cloth_v, <span class="keywordtype">void</span> **data, <span class="keywordtype">float</span> cfra, <span class="keywordtype">float</span> cfra1, <span class="keywordtype">float</span> cfra2, <span class="keywordtype">float</span> *old_data)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482     <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd= cloth_v;
<a name="l00483"></a>00483     <a class="code" href="../../d7/d35/structCloth.html">Cloth</a> *cloth= clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a73cb41a7ce0ccf4ee8d5c6597307702e">clothObject</a>;
<a name="l00484"></a>00484     <a class="code" href="../../d2/dc4/structClothVertex.html">ClothVertex</a> *vert = cloth-&gt;<a class="code" href="../../d7/d35/structCloth.html#abb55dfde9f8197852a25fe2c776686ed">verts</a> + <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00485"></a>00485     <a class="code" href="../../d3/d31/structParticleKey.html">ParticleKey</a> keys[4];
<a name="l00486"></a>00486     <span class="keywordtype">float</span> dfra;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (cfra1 == cfra2)
<a name="l00489"></a>00489         <span class="keywordflow">return</span>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(keys[1].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a9394c1e84c2e8f0e36a9a79bb87265de">x</a>);
<a name="l00492"></a>00492     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(keys[1].vel, vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a98dfb569724cfc1c0d60989cced30e69">v</a>);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (old_data) {
<a name="l00495"></a>00495         memcpy(keys[2].co, old_data, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00496"></a>00496         memcpy(keys[2].vel, old_data + 6, 3 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498     <span class="keywordflow">else</span>
<a name="l00499"></a>00499         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#abf52e2a5b602c1d933a1c6e48258e07a">BKE_ptcache_make_particle_key</a>(keys+2, 0, data, cfra2);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     dfra = cfra2 - cfra1;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[1].vel, dfra);
<a name="l00504"></a>00504     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys[2].vel, dfra);
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <a class="code" href="../../db/dca/BKE__particle_8h.html#a51e4b5809d577b25da097a393c78d296">psys_interpolate_particle</a>(-1, keys, (cfra - cfra1) / dfra, keys, 1);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>, 1.0f / dfra);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a9394c1e84c2e8f0e36a9a79bb87265de">x</a>, keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a95888d245d557f8e453844d9aad97019">co</a>);
<a name="l00511"></a>00511     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vert-&gt;<a class="code" href="../../d2/dc4/structClothVertex.html#a98dfb569724cfc1c0d60989cced30e69">v</a>, keys-&gt;<a class="code" href="../../d3/d31/structParticleKey.html#a2784ffc7a428dff13e5f031178706fee">vel</a>);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="comment">/* should vert-&gt;xconst be interpolated somehow too? - jahka */</span>
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aca4c1a5a92e9c520947431475fff4dec">00516</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#aca4c1a5a92e9c520947431475fff4dec">ptcache_cloth_totpoint</a>(<span class="keywordtype">void</span> *cloth_v, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518     <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd= cloth_v;
<a name="l00519"></a>00519     <span class="keywordflow">return</span> clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a73cb41a7ce0ccf4ee8d5c6597307702e">clothObject</a> ? clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a73cb41a7ce0ccf4ee8d5c6597307702e">clothObject</a>-&gt;<a class="code" href="../../d7/d35/structCloth.html#a6def416ae8e5159609bc690dda606036">numverts</a> : 0;
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="preprocessor">#ifdef WITH_SMOKE</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="comment">/* Smoke functions */</span>
<a name="l00524"></a>00524 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a7602d5c469f68e598e59a0c7c8a5bed9">ptcache_smoke_totpoint</a>(<span class="keywordtype">void</span> *smoke_v, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd= (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *)smoke_v;
<a name="l00527"></a>00527     <a class="code" href="../../df/df0/structSmokeDomainSettings.html">SmokeDomainSettings</a> *sds = smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a691a7d81e9cd652cba5a0e756ac4656c">domain</a>;
<a name="l00528"></a>00528     
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>) {
<a name="l00530"></a>00530         <span class="keywordflow">return</span> sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[0]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[1]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[2];
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532     <span class="keywordflow">else</span>
<a name="l00533"></a>00533         <span class="keywordflow">return</span> 0;
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a8fc38822095cc6132bebd0eacbc31732">ptcache_smoke_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *smoke_v)
<a name="l00536"></a>00536 {   
<a name="l00537"></a>00537     <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd= (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *)smoke_v;
<a name="l00538"></a>00538     <a class="code" href="../../df/df0/structSmokeDomainSettings.html">SmokeDomainSettings</a> *sds = smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a691a7d81e9cd652cba5a0e756ac4656c">domain</a>;
<a name="l00539"></a>00539     <span class="keywordtype">int</span> ret = 0;
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>) {
<a name="l00542"></a>00542         <span class="keywordtype">size_t</span> res = sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[0]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[1]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[2];
<a name="l00543"></a>00543         <span class="keywordtype">float</span> dt, dx, *dens, *densold, *heat, *heatold, *vx, *vy, *vz, *vxold, *vyold, *vzold;
<a name="l00544"></a>00544         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *obstacles;
<a name="l00545"></a>00545         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len = <span class="keyword">sizeof</span>(float)*(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res;
<a name="l00546"></a>00546         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len)*4, <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l00547"></a>00547         <span class="comment">//int mode = res &gt;= 1000000 ? 2 : 1;</span>
<a name="l00548"></a>00548         <span class="keywordtype">int</span> mode=1;     <span class="comment">// light</span>
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#ab3944c03a8415c52d428e70485ce3b21">cache_comp</a> == <a class="code" href="../../d8/d8b/DNA__smoke__types_8h.html#ac4ff7b3916350194cea46f37b3cea4c6">SM_CACHE_HEAVY</a>) mode=2;  <span class="comment">// heavy</span>
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <a class="code" href="../../dc/d83/smoke__API_8h.html#a416bce18236d6768bf1c91fae95c2141">smoke_export</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>, &amp;dt, &amp;dx, &amp;dens, &amp;densold, &amp;heat, &amp;heatold, &amp;vx, &amp;vy, &amp;vz, &amp;vxold, &amp;vyold, &amp;vzold, &amp;obstacles);
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#aac9e66a5f2eacde79c5c8ac3419c1836">shadow</a>, in_len, out, mode);
<a name="l00554"></a>00554         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)dens, in_len, out, mode);
<a name="l00555"></a>00555         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)densold, in_len, out, mode); 
<a name="l00556"></a>00556         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)heat, in_len, out, mode);
<a name="l00557"></a>00557         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)heatold, in_len, out, mode);
<a name="l00558"></a>00558         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vx, in_len, out, mode);
<a name="l00559"></a>00559         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vy, in_len, out, mode);
<a name="l00560"></a>00560         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vz, in_len, out, mode);
<a name="l00561"></a>00561         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vxold, in_len, out, mode);
<a name="l00562"></a>00562         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vyold, in_len, out, mode);
<a name="l00563"></a>00563         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)vzold, in_len, out, mode);
<a name="l00564"></a>00564         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)obstacles, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res, out, mode);
<a name="l00565"></a>00565         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;dt, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00566"></a>00566         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;dx, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l00569"></a>00569         
<a name="l00570"></a>00570         ret = 1;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>) {
<a name="l00574"></a>00574         <span class="keywordtype">int</span> res_big_array[3];
<a name="l00575"></a>00575         <span class="keywordtype">int</span> res_big;
<a name="l00576"></a>00576         <span class="keywordtype">int</span> res = sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[0]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[1]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[2];
<a name="l00577"></a>00577         <span class="keywordtype">float</span> *dens, *densold, *tcu, *tcv, *tcw;
<a name="l00578"></a>00578         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len = <span class="keyword">sizeof</span>(float)*(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res;
<a name="l00579"></a>00579         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len_big;
<a name="l00580"></a>00580         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out;
<a name="l00581"></a>00581         <span class="keywordtype">int</span> mode;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <a class="code" href="../../dc/d83/smoke__API_8h.html#a9c89a86da80baea6b1e6f6c0581d5018">smoke_turbulence_get_res</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>, res_big_array);
<a name="l00584"></a>00584         res_big = res_big_array[0]*res_big_array[1]*res_big_array[2];
<a name="l00585"></a>00585         <span class="comment">//mode =  res_big &gt;= 1000000 ? 2 : 1;</span>
<a name="l00586"></a>00586         mode = 1;   <span class="comment">// light</span>
<a name="l00587"></a>00587         <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a9c12a583cc84896fa57404a05dad4b38">cache_high_comp</a> == <a class="code" href="../../d8/d8b/DNA__smoke__types_8h.html#ac4ff7b3916350194cea46f37b3cea4c6">SM_CACHE_HEAVY</a>) mode=2; <span class="comment">// heavy</span>
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         in_len_big = <span class="keyword">sizeof</span>(float) * (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res_big;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         <a class="code" href="../../dc/d83/smoke__API_8h.html#a936811ac8c6d8380bf4d30b6419ac860">smoke_turbulence_export</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>, &amp;dens, &amp;densold, &amp;tcu, &amp;tcv, &amp;tcw);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len_big), <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l00594"></a>00594         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)dens, in_len_big, out, mode);
<a name="l00595"></a>00595         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)densold, in_len_big, out, mode); 
<a name="l00596"></a>00596         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len), <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l00599"></a>00599         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tcu, in_len, out, mode);
<a name="l00600"></a>00600         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tcv, in_len, out, mode);
<a name="l00601"></a>00601         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tcw, in_len, out, mode);
<a name="l00602"></a>00602         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l00603"></a>00603         
<a name="l00604"></a>00604         ret = 1;
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">return</span> ret;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a08a259bbd3c0df24238f702f622112b8">ptcache_smoke_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *smoke_v)
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611     <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd= (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *)smoke_v;
<a name="l00612"></a>00612     <a class="code" href="../../df/df0/structSmokeDomainSettings.html">SmokeDomainSettings</a> *sds = smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a691a7d81e9cd652cba5a0e756ac4656c">domain</a>;
<a name="l00613"></a>00613     
<a name="l00614"></a>00614     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>) {
<a name="l00615"></a>00615         <span class="keywordtype">size_t</span> res = sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[0]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[1]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[2];
<a name="l00616"></a>00616         <span class="keywordtype">float</span> dt, dx, *dens, *densold, *heat, *heatold, *vx, *vy, *vz, *vxold, *vyold, *vzold;
<a name="l00617"></a>00617         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *obstacles;
<a name="l00618"></a>00618         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> out_len = (<span class="keywordtype">unsigned</span> int)res * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>);
<a name="l00619"></a>00619         
<a name="l00620"></a>00620         <a class="code" href="../../dc/d83/smoke__API_8h.html#a416bce18236d6768bf1c91fae95c2141">smoke_export</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>, &amp;dt, &amp;dx, &amp;dens, &amp;densold, &amp;heat, &amp;heatold, &amp;vx, &amp;vy, &amp;vz, &amp;vxold, &amp;vyold, &amp;vzold, &amp;obstacles);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#aac9e66a5f2eacde79c5c8ac3419c1836">shadow</a>, out_len);
<a name="l00623"></a>00623         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)dens, out_len);
<a name="l00624"></a>00624         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)densold, out_len);
<a name="l00625"></a>00625         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)heat, out_len);
<a name="l00626"></a>00626         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)heatold, out_len);
<a name="l00627"></a>00627         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vx, out_len);
<a name="l00628"></a>00628         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vy, out_len);
<a name="l00629"></a>00629         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vz, out_len);
<a name="l00630"></a>00630         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vxold, out_len);
<a name="l00631"></a>00631         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vyold, out_len);
<a name="l00632"></a>00632         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)vzold, out_len);
<a name="l00633"></a>00633         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)obstacles, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res);
<a name="l00634"></a>00634         <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;dt, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00635"></a>00635         <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;dx, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="keywordflow">if</span> (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afce6418ba3077dbb828fbdbba197ae13">BPHYS_DATA_SMOKE_HIGH</a>) &amp;&amp; sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>) {
<a name="l00638"></a>00638             <span class="keywordtype">int</span> res = sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[0]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[1]*sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8b75df097b3493a0b15c32e2e0df6faa">res</a>[2];
<a name="l00639"></a>00639             <span class="keywordtype">int</span> res_big, res_big_array[3];
<a name="l00640"></a>00640             <span class="keywordtype">float</span> *dens, *densold, *tcu, *tcv, *tcw;
<a name="l00641"></a>00641             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> out_len = <span class="keyword">sizeof</span>(float)*(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res;
<a name="l00642"></a>00642             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> out_len_big;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644             <a class="code" href="../../dc/d83/smoke__API_8h.html#a9c89a86da80baea6b1e6f6c0581d5018">smoke_turbulence_get_res</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>, res_big_array);
<a name="l00645"></a>00645             res_big = res_big_array[0]*res_big_array[1]*res_big_array[2];
<a name="l00646"></a>00646             out_len_big = <span class="keyword">sizeof</span>(float) * (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)res_big;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648             <a class="code" href="../../dc/d83/smoke__API_8h.html#a936811ac8c6d8380bf4d30b6419ac860">smoke_turbulence_export</a>(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>, &amp;dens, &amp;densold, &amp;tcu, &amp;tcv, &amp;tcw);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650             <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)dens, out_len_big);
<a name="l00651"></a>00651             <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)densold, out_len_big);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653             <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)tcu, out_len);
<a name="l00654"></a>00654             <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)tcv, out_len);
<a name="l00655"></a>00655             <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)tcw, out_len);
<a name="l00656"></a>00656         }
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="keywordflow">return</span> 1;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 <span class="preprocessor">#else // WITH_SMOKE</span>
<a name="l00662"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a7602d5c469f68e598e59a0c7c8a5bed9">00662</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a7602d5c469f68e598e59a0c7c8a5bed9">ptcache_smoke_totpoint</a>(<span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(smoke_v), <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra)) { <span class="keywordflow">return</span> 0; }
<a name="l00663"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a08a259bbd3c0df24238f702f622112b8">00663</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a08a259bbd3c0df24238f702f622112b8">ptcache_smoke_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(pf), <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(smoke_v)) { <span class="keywordflow">return</span> 0; }
<a name="l00664"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a8fc38822095cc6132bebd0eacbc31732">00664</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a8fc38822095cc6132bebd0eacbc31732">ptcache_smoke_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(pf), <span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(smoke_v)) { <span class="keywordflow">return</span> 0; }
<a name="l00665"></a>00665 <span class="preprocessor">#endif // WITH_SMOKE</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span>
<a name="l00667"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a0869a50dd86c3188cf3fbe0a4419ae21">00667</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a0869a50dd86c3188cf3fbe0a4419ae21">ptcache_dynamicpaint_totpoint</a>(<span class="keywordtype">void</span> *sd, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(cfra))
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669     <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface = (<a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a>*)sd;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     <span class="keywordflow">if</span> (!surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>) <span class="keywordflow">return</span> 0;
<a name="l00672"></a>00672     <span class="keywordflow">else</span> <span class="keywordflow">return</span> surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>-&gt;<a class="code" href="../../d3/d25/structPaintSurfaceData.html#aa47aaf3060dd60e9ec7df43f227330cf">total_points</a>;
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ae3e88f326bec840c3ea511c2cfef3580">00675</a> <span class="preprocessor">#define DPAINT_CACHE_VERSION &quot;1.01&quot;</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>
<a name="l00677"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a435589b3ea0772024f246a32caccefc0">00677</a> <span class="keyword">static</span> <span class="keywordtype">int</span>  <a class="code" href="../../d3/d9b/pointcache_8c.html#a435589b3ea0772024f246a32caccefc0">ptcache_dynamicpaint_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *dp_v)
<a name="l00678"></a>00678 {   
<a name="l00679"></a>00679     <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface = (<a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a>*)dp_v;
<a name="l00680"></a>00680     <span class="keywordtype">int</span> cache_compress = 1;
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">/* version header */</span>
<a name="l00683"></a>00683     <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, <a class="code" href="../../d3/d9b/pointcache_8c.html#ae3e88f326bec840c3ea511c2cfef3580">DPAINT_CACHE_VERSION</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*4);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a4c17d9e4778f82baa22c555ac00b79ae">format</a> != <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#aaf778fa8a1ce6f8de3247adaa6a99958">MOD_DPAINT_SURFACE_F_IMAGESEQ</a> &amp;&amp; surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>) {
<a name="l00686"></a>00686         <span class="keywordtype">int</span> total_points=surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>-&gt;<a class="code" href="../../d3/d25/structPaintSurfaceData.html#aa47aaf3060dd60e9ec7df43f227330cf">total_points</a>;
<a name="l00687"></a>00687         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len;
<a name="l00688"></a>00688         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690         <span class="comment">/* cache type */</span>
<a name="l00691"></a>00691         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#a258cdcaf14045a55f3bdb5da59d4155d">MOD_DPAINT_SURFACE_T_PAINT</a>)
<a name="l00694"></a>00694             in_len = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html#aab2eb7bbd2a26cedbdfbabb337aa9172">PaintPoint</a>)*total_points;
<a name="l00695"></a>00695         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#a966ac7d18ac33f6f5dfd7a33aa9bf373">MOD_DPAINT_SURFACE_T_DISPLACE</a> ||
<a name="l00696"></a>00696                  surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#aba3417a6c1ab28b92dbeae126c58a1ed">MOD_DPAINT_SURFACE_T_WEIGHT</a>)
<a name="l00697"></a>00697             in_len = <span class="keyword">sizeof</span>(float)*total_points;
<a name="l00698"></a>00698         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#ab70b13df7b58e21c11a92e0b1abe75a5">MOD_DPAINT_SURFACE_T_WAVE</a>)
<a name="l00699"></a>00699             in_len = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html#ae46c57c449775fdd6ea75a81f15418f2">PaintWavePoint</a>)*total_points;
<a name="l00700"></a>00700         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len), <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>-&gt;<a class="code" href="../../d3/d25/structPaintSurfaceData.html#a2872a80bc4840dd2dd6c8ccb66437a90">type_data</a>, in_len, out, cache_compress);
<a name="l00705"></a>00705         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     }
<a name="l00708"></a>00708     <span class="keywordflow">return</span> 1;
<a name="l00709"></a>00709 }
<a name="l00710"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a9641fd3163e4e39edf218cfbda7a1706">00710</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a9641fd3163e4e39edf218cfbda7a1706">ptcache_dynamicpaint_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *dp_v)
<a name="l00711"></a>00711 {
<a name="l00712"></a>00712     <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface = (<a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a>*)dp_v;
<a name="l00713"></a>00713     <span class="keywordtype">char</span> version[4];
<a name="l00714"></a>00714     
<a name="l00715"></a>00715     <span class="comment">/* version header */</span>
<a name="l00716"></a>00716     <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, version, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)*4);
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (strncmp(version, <a class="code" href="../../d3/d9b/pointcache_8c.html#ae3e88f326bec840c3ea511c2cfef3580">DPAINT_CACHE_VERSION</a>,4)) {printf(<span class="stringliteral">&quot;Dynamic Paint: Invalid cache version: %s!\n&quot;</span>,version); <span class="keywordflow">return</span> 0;}
<a name="l00718"></a>00718 
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a4c17d9e4778f82baa22c555ac00b79ae">format</a> != <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#aaf778fa8a1ce6f8de3247adaa6a99958">MOD_DPAINT_SURFACE_F_IMAGESEQ</a> &amp;&amp; surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>) {
<a name="l00720"></a>00720         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> data_len;
<a name="l00721"></a>00721         <span class="keywordtype">int</span> surface_type;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723         <span class="comment">/* cache type */</span>
<a name="l00724"></a>00724         <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;surface_type, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <span class="keywordflow">if</span> (surface_type != surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a>)
<a name="l00727"></a>00727             <span class="keywordflow">return</span> 0;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         <span class="comment">/* read surface data */</span>
<a name="l00730"></a>00730         <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#a258cdcaf14045a55f3bdb5da59d4155d">MOD_DPAINT_SURFACE_T_PAINT</a>)
<a name="l00731"></a>00731             data_len = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html#aab2eb7bbd2a26cedbdfbabb337aa9172">PaintPoint</a>);
<a name="l00732"></a>00732         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#a966ac7d18ac33f6f5dfd7a33aa9bf373">MOD_DPAINT_SURFACE_T_DISPLACE</a> ||
<a name="l00733"></a>00733                  surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#aba3417a6c1ab28b92dbeae126c58a1ed">MOD_DPAINT_SURFACE_T_WEIGHT</a>)
<a name="l00734"></a>00734             data_len = <span class="keyword">sizeof</span>(float);
<a name="l00735"></a>00735         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#aa156c31e929f4f1851d88161d0ae03a4">type</a> == <a class="code" href="../../dd/daf/DNA__dynamicpaint__types_8h.html#ab70b13df7b58e21c11a92e0b1abe75a5">MOD_DPAINT_SURFACE_T_WAVE</a>)
<a name="l00736"></a>00736             data_len = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html#ae46c57c449775fdd6ea75a81f15418f2">PaintWavePoint</a>);
<a name="l00737"></a>00737         <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>-&gt;<a class="code" href="../../d3/d25/structPaintSurfaceData.html#a2872a80bc4840dd2dd6c8ccb66437a90">type_data</a>, data_len*surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a5a0a35c043234290d9bd8d5a88840670">data</a>-&gt;<a class="code" href="../../d3/d25/structPaintSurfaceData.html#aa47aaf3060dd60e9ec7df43f227330cf">total_points</a>);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     }
<a name="l00742"></a>00742     <span class="keywordflow">return</span> 1;
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745 <span class="comment">/* Creating ID&#39;s */</span>
<a name="l00746"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#acf6be010d1ad3b820f46d74cd438c996">00746</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a77c23b980ef3e6c4f755966321bbe2e4">BKE_ptcache_id_from_softbody</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../df/d9a/structSoftBody.html">SoftBody</a> *sb)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748     memset(pid, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>));
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>= ob;
<a name="l00751"></a>00751     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>= sb;
<a name="l00752"></a>00752     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a8f896983be158775838cbf7fc1ffa45d">PTCACHE_TYPE_SOFTBODY</a>;
<a name="l00753"></a>00753     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>= sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3cbaa712cbb0289db746f8dbfb34f1bb">pointcache</a>;
<a name="l00754"></a>00754     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a03ae687a5fe73c8806aa4ed7b05512d6">cache_ptr</a>= &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a3cbaa712cbb0289db746f8dbfb34f1bb">pointcache</a>;
<a name="l00755"></a>00755     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a77f0bc2aadc694fab6cd8bdc71d6429c">ptcaches</a>= &amp;sb-&gt;<a class="code" href="../../df/d9a/structSoftBody.html#a2b4fe2801e797119094ffa33d7a92d59">ptcaches</a>;
<a name="l00756"></a>00756     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>= <a class="code" href="../../d3/d9b/pointcache_8c.html#aafcf9d7940b2980373b293f684f19c82">ptcache_softbody_totpoint</a>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a616b6cb81d66dbc71d3db21ecb3e4dcf">ptcache_softbody_write</a>;
<a name="l00759"></a>00759     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>             = <a class="code" href="../../d3/d9b/pointcache_8c.html#a5eb8b5654d9ed2c476b32787a8ef2872">ptcache_softbody_read</a>;
<a name="l00760"></a>00760     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>      = <a class="code" href="../../d3/d9b/pointcache_8c.html#aa2bd5d23f2cdb76a529b5008c8e3efe9">ptcache_softbody_interpolate</a>;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>           = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00763"></a>00763     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>       = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00766"></a>00766     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>        = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00767"></a>00767     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>;
<a name="l00770"></a>00770     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>);
<a name="l00773"></a>00773     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>= 0;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a8de087aa350951a6a95110001f1b0adf">default_step</a> = 10;
<a name="l00778"></a>00778     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae749090ebbca3467559d0c9743bcc278">max_step</a> = 20;
<a name="l00779"></a>00779 }
<a name="l00780"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ae8734aa158f12fddbe4a21828b05f881">00780</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782     memset(pid, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>));
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>= ob;
<a name="l00785"></a>00785     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>= psys;
<a name="l00786"></a>00786     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a>;
<a name="l00787"></a>00787     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>;
<a name="l00788"></a>00788     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>= psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>;
<a name="l00789"></a>00789     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a03ae687a5fe73c8806aa4ed7b05512d6">cache_ptr</a>= &amp;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a747471629aff917d4847a094b5c4c811">pointcache</a>;
<a name="l00790"></a>00790     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a77f0bc2aadc694fab6cd8bdc71d6429c">ptcaches</a>= &amp;psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a18021dc0203ac6bfb44d306d7a008989">ptcaches</a>;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>)
<a name="l00793"></a>00793         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a7dad54c2b8bd539fde0f3fb5f1d47ec1">flag</a> |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2364130180f97526de3e3e374e51df77">PTCACHE_VEL_PER_SEC</a>;
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>               = <a class="code" href="../../d3/d9b/pointcache_8c.html#af8326423f718431d40801aee6aba0a76">ptcache_particle_totpoint</a>;
<a name="l00796"></a>00796     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>               = <a class="code" href="../../d3/d9b/pointcache_8c.html#a25c8ceaff9db856627d77fe25807b247">ptcache_particle_totwrite</a>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>                = <a class="code" href="../../d3/d9b/pointcache_8c.html#adeb1e809c41ebe353e590df4d02fabae">ptcache_particle_write</a>;
<a name="l00799"></a>00799     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>             = <a class="code" href="../../d3/d9b/pointcache_8c.html#a8cd00005a48c0f38aca431729253c874">ptcache_particle_read</a>;
<a name="l00800"></a>00800     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>      = <a class="code" href="../../d3/d9b/pointcache_8c.html#a8e213c97ff5a8b486ffb64ac030595c7">ptcache_particle_interpolate</a>;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>           = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00803"></a>00803     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>       = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00806"></a>00806     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>        = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00807"></a>00807     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>;
<a name="l00810"></a>00810     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> = (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>);
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a632b70a25b43cdad1aad17d2cd9a2c53">PART_PHYS_BOIDS</a>)
<a name="l00815"></a>00815         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>|= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45c8fc7edea3203df76f8118ac9e6b19">BPHYS_DATA_BOIDS</a>);
<a name="l00816"></a>00816     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5fa3865af8588ad97dc9b94b9fcc4e23">PART_PHYS_FLUID</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a> &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ada8ff094092deeef0d812a97ab310a08">fluid</a>-&gt;<a class="code" href="../../dc/dec/structSPHFluidSettings.html#a2acb321642a0e5b62262d6835001dccd">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a52543435c6331404504cf2e8ff560dab">SPH_VISCOELASTIC_SPRINGS</a>) {
<a name="l00817"></a>00817         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a> = <a class="code" href="../../d3/d9b/pointcache_8c.html#ae3d1cb6dff0b1e6d2af30e63e52e6020">ptcache_particle_extra_write</a>;
<a name="l00818"></a>00818         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a> = <a class="code" href="../../d3/d9b/pointcache_8c.html#aac065da409926abe500a03b69ae24892">ptcache_particle_extra_read</a>;
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a395ca2446ef372e1f852d7e4efc2b396">flag</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acb1eead271635dccefc77a7126e214a2">PART_ROTATIONS</a>) {
<a name="l00822"></a>00822         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>|= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad27b4fdd7271a1de7e2fe38051c3ca44">rotmode</a> != <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acf117996b37af9e17bc18dca3e09b6ea">PART_ROT_VEL</a>  ||
<a name="l00825"></a>00825             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#afd3757fb9c4b6e071128a39daa641914">avemode</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#afff2b6bb2e99908069674099186d1cbe">PART_AVE_RAND</a> ||
<a name="l00826"></a>00826             psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#ad26b38930a1c5771dcb93f5b33b67b68">avefac</a>  != 0.0f)
<a name="l00827"></a>00827         {
<a name="l00828"></a>00828             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> |= (1 &lt;&lt; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>);
<a name="l00829"></a>00829         }
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a43c9b1cefacb99d22a41acec469386be">BPHYS_DATA_TIMES</a>);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a8de087aa350951a6a95110001f1b0adf">default_step</a> = 10;
<a name="l00835"></a>00835     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae749090ebbca3467559d0c9743bcc278">max_step</a> = 20;
<a name="l00836"></a>00836 }
<a name="l00837"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a9ce6d4b279e3fb7317e53cc183cd79d9">00837</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac096044fef336c86e9eb09373c7c5dcd">BKE_ptcache_id_from_cloth</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a> *clmd)
<a name="l00838"></a>00838 {
<a name="l00839"></a>00839     memset(pid, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>));
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>= ob;
<a name="l00842"></a>00842     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>= clmd;
<a name="l00843"></a>00843     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a64019fd6972f164398f3b2f022fd9e74">PTCACHE_TYPE_CLOTH</a>;
<a name="l00844"></a>00844     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>= clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a77605f4a26c5077252abce50377e3de9">point_cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>;
<a name="l00845"></a>00845     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>= clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a77605f4a26c5077252abce50377e3de9">point_cache</a>;
<a name="l00846"></a>00846     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a03ae687a5fe73c8806aa4ed7b05512d6">cache_ptr</a>= &amp;clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a77605f4a26c5077252abce50377e3de9">point_cache</a>;
<a name="l00847"></a>00847     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a77f0bc2aadc694fab6cd8bdc71d6429c">ptcaches</a>= &amp;clmd-&gt;<a class="code" href="../../d5/d06/structClothModifierData.html#a2bfdb45d82b0577deb1cdd5f879e931c">ptcaches</a>;
<a name="l00848"></a>00848     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>= <a class="code" href="../../d3/d9b/pointcache_8c.html#aca4c1a5a92e9c520947431475fff4dec">ptcache_cloth_totpoint</a>;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a894360e2c03f09895b371cf91ec9f5d7">ptcache_cloth_write</a>;
<a name="l00851"></a>00851     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>             = <a class="code" href="../../d3/d9b/pointcache_8c.html#a39ebe99e329d4b6dd6e8be838d882af4">ptcache_cloth_read</a>;
<a name="l00852"></a>00852     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>      = <a class="code" href="../../d3/d9b/pointcache_8c.html#ac573991ef4867ef601f01fd19d65c4c0">ptcache_cloth_interpolate</a>;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>           = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00855"></a>00855     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>       = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00858"></a>00858     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>        = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00859"></a>00859     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>;
<a name="l00862"></a>00862     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>) | (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae9ce0b34d794b0d59340175e6b58ccaa">BPHYS_DATA_XCONST</a>);
<a name="l00865"></a>00865     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>= 0;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a8de087aa350951a6a95110001f1b0adf">default_step</a> = 1;
<a name="l00868"></a>00868     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae749090ebbca3467559d0c9743bcc278">max_step</a> = 1;
<a name="l00869"></a>00869 }
<a name="l00870"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a139c5c89f9fbf148ec330a232fb306a6">00870</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a139c5c89f9fbf148ec330a232fb306a6">BKE_ptcache_id_from_smoke</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">struct</span> <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd)
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872     <a class="code" href="../../df/df0/structSmokeDomainSettings.html">SmokeDomainSettings</a> *sds = smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a691a7d81e9cd652cba5a0e756ac4656c">domain</a>;
<a name="l00873"></a>00873 
<a name="l00874"></a>00874     memset(pid, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>));
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>= ob;
<a name="l00877"></a>00877     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>= smd;
<a name="l00878"></a>00878     
<a name="l00879"></a>00879     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a>;
<a name="l00880"></a>00880     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>= sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a51c76a80c09b649712b9bf226235c112">point_cache</a>[0]-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>= sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a51c76a80c09b649712b9bf226235c112">point_cache</a>[0];
<a name="l00883"></a>00883     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a03ae687a5fe73c8806aa4ed7b05512d6">cache_ptr</a>= &amp;(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a51c76a80c09b649712b9bf226235c112">point_cache</a>[0]);
<a name="l00884"></a>00884     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a77f0bc2aadc694fab6cd8bdc71d6429c">ptcaches</a>= &amp;(sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a8bec113790f4bff589a5299be6273801">ptcaches</a>[0]);
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>= <a class="code" href="../../d3/d9b/pointcache_8c.html#a7602d5c469f68e598e59a0c7c8a5bed9">ptcache_smoke_totpoint</a>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00889"></a>00889     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>             = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00890"></a>00890     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>      = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a08a259bbd3c0df24238f702f622112b8">ptcache_smoke_read</a>;
<a name="l00893"></a>00893     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#a8fc38822095cc6132bebd0eacbc31732">ptcache_smoke_write</a>;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>       = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00896"></a>00896     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>        = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00897"></a>00897     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>;
<a name="l00900"></a>00900     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>= 0;
<a name="l00903"></a>00903     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>= 0;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a2243482d9f65b8cb4f1018f8092a73b2">fluid</a>)
<a name="l00906"></a>00906         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> |= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a84d23e7414214c787b0b4cd1566406db">BPHYS_DATA_SMOKE_LOW</a>);
<a name="l00907"></a>00907     <span class="keywordflow">if</span> (sds-&gt;<a class="code" href="../../df/df0/structSmokeDomainSettings.html#a6b4254083936838e368963db2bd1c41d">wt</a>)
<a name="l00908"></a>00908         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> |= (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afce6418ba3077dbb828fbdbba197ae13">BPHYS_DATA_SMOKE_HIGH</a>);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a8de087aa350951a6a95110001f1b0adf">default_step</a> = 1;
<a name="l00911"></a>00911     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae749090ebbca3467559d0c9743bcc278">max_step</a> = 1;
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00914"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a4af4022fbf3ef5af8f6efa847fecb58f">00914</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a65216ebe614f6e108d88b059a1bec408">BKE_ptcache_id_from_dynamicpaint</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface)
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     memset(pid, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>));
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>= ob;
<a name="l00920"></a>00920     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>= surface;
<a name="l00921"></a>00921     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a69d1f6145b8e33c34e843239d567d781">PTCACHE_TYPE_DYNAMICPAINT</a>;
<a name="l00922"></a>00922     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>= surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#ae56d6bbed91169958270d8fb85cf1b15">pointcache</a>;
<a name="l00923"></a>00923     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a03ae687a5fe73c8806aa4ed7b05512d6">cache_ptr</a>= &amp;surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#ae56d6bbed91169958270d8fb85cf1b15">pointcache</a>;
<a name="l00924"></a>00924     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a77f0bc2aadc694fab6cd8bdc71d6429c">ptcaches</a>= &amp;surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#ad5a5d56f2355389075826d9c3c69fd93">ptcaches</a>;
<a name="l00925"></a>00925     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>= <a class="code" href="../../d3/d9b/pointcache_8c.html#a0869a50dd86c3188cf3fbe0a4419ae21">ptcache_dynamicpaint_totpoint</a>;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>            = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00928"></a>00928     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>             = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00929"></a>00929     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>      = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#a435589b3ea0772024f246a32caccefc0">ptcache_dynamicpaint_write</a>;
<a name="l00932"></a>00932     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a9641fd3163e4e39edf218cfbda7a1706">ptcache_dynamicpaint_read</a>;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>       = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00935"></a>00935     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>        = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00936"></a>00936     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>           = <a class="code" href="../../d3/d9b/pointcache_8c.html#afc19cb01b39bd90bf8d33f852c6ab007">ptcache_basic_header_write</a>;
<a name="l00939"></a>00939     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>            = <a class="code" href="../../d3/d9b/pointcache_8c.html#a17d03f6496475558efa7f23b921e8730">ptcache_basic_header_read</a>;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a3fd0943ffa1da402063d499fe4391a95">BPHYS_DATA_DYNAMICPAINT</a>;
<a name="l00942"></a>00942     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>= 0;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a8de087aa350951a6a95110001f1b0adf">default_step</a> = 1;
<a name="l00947"></a>00947     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae749090ebbca3467559d0c9743bcc278">max_step</a> = 1;
<a name="l00948"></a>00948 }
<a name="l00949"></a>00949 
<a name="l00950"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ab1603afba19dab95c13fdb9b6b04be6b">00950</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2308780fc8b6f269567217d7e9e9d3e6">BKE_ptcache_ids_from_object</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">int</span> duplis)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid;
<a name="l00953"></a>00953     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l00954"></a>00954     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>) {
<a name="l00959"></a>00959         pid= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>), <span class="stringliteral">&quot;PTCacheID&quot;</span>);
<a name="l00960"></a>00960         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a77c23b980ef3e6c4f755966321bbe2e4">BKE_ptcache_id_from_softbody</a>(pid, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>);
<a name="l00961"></a>00961         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, pid);
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l00965"></a>00965         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00966"></a>00966             <span class="keywordflow">continue</span>;
<a name="l00967"></a>00967         
<a name="l00968"></a>00968         <span class="comment">/* check to make sure point cache is actually used by the particles */</span>
<a name="l00969"></a>00969         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aaaa65883b0fd34e1f66db33d0e55ef9e">PART_PHYS_NO</a>, <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>))
<a name="l00970"></a>00970             <span class="keywordflow">continue</span>;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="comment">/* hair needs to be included in id-list for cache edit mode to work */</span>
<a name="l00973"></a>00973         <span class="comment">/* if (psys-&gt;part-&gt;type == PART_HAIR &amp;&amp; (psys-&gt;flag &amp; PSYS_HAIR_DYNAMICS)==0) */</span>
<a name="l00974"></a>00974         <span class="comment">/*  continue; */</span>
<a name="l00975"></a>00975             
<a name="l00976"></a>00976         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ad2b156b6908626c14f063e15712fe427">PART_FLUID</a>)
<a name="l00977"></a>00977             <span class="keywordflow">continue</span>;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979         pid= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>), <span class="stringliteral">&quot;PTCacheID&quot;</span>);
<a name="l00980"></a>00980         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(pid, ob, psys);
<a name="l00981"></a>00981         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, pid);
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983 
<a name="l00984"></a>00984     <span class="keywordflow">for</span> (md=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; md; md=md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l00985"></a>00985         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a5fc484f055c7aba4c89beda85b5ba321">eModifierType_Cloth</a>) {
<a name="l00986"></a>00986             pid= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>), <span class="stringliteral">&quot;PTCacheID&quot;</span>);
<a name="l00987"></a>00987             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac096044fef336c86e9eb09373c7c5dcd">BKE_ptcache_id_from_cloth</a>(pid, ob, (<a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a>*)md);
<a name="l00988"></a>00988             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, pid);
<a name="l00989"></a>00989         }
<a name="l00990"></a>00990         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a7a78843e9dd6590fafc9b7682e691ac5">eModifierType_Smoke</a>) {
<a name="l00991"></a>00991             <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd = (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *)md;
<a name="l00992"></a>00992             <span class="keywordflow">if</span> (smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a43b5e848c1b44a089bd6d4461b0d2b1f">type</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a88bed02ad1eb599ef628931fc9ab7973">MOD_SMOKE_TYPE_DOMAIN</a>)
<a name="l00993"></a>00993             {
<a name="l00994"></a>00994                 pid= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>), <span class="stringliteral">&quot;PTCacheID&quot;</span>);
<a name="l00995"></a>00995                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a139c5c89f9fbf148ec330a232fb306a6">BKE_ptcache_id_from_smoke</a>(pid, ob, (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a>*)md);
<a name="l00996"></a>00996                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, pid);
<a name="l00997"></a>00997             }
<a name="l00998"></a>00998         }
<a name="l00999"></a>00999         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435abf6c2369ea1f5b0cab992eb27906823c">eModifierType_DynamicPaint</a>) {
<a name="l01000"></a>01000             <a class="code" href="../../de/d70/structDynamicPaintModifierData.html">DynamicPaintModifierData</a> *pmd = (<a class="code" href="../../de/d70/structDynamicPaintModifierData.html">DynamicPaintModifierData</a> *)md;
<a name="l01001"></a>01001             <span class="keywordflow">if</span> (pmd-&gt;<a class="code" href="../../de/d70/structDynamicPaintModifierData.html#a7f52b6a38d830d37a65adb2485555e6f">canvas</a>)
<a name="l01002"></a>01002             {
<a name="l01003"></a>01003                 <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface = pmd-&gt;<a class="code" href="../../de/d70/structDynamicPaintModifierData.html#a7f52b6a38d830d37a65adb2485555e6f">canvas</a>-&gt;<a class="code" href="../../dd/d1c/structDynamicPaintCanvasSettings.html#ad228b42281d1a30b3a1471918032d6a5">surfaces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005                 <span class="keywordflow">for</span> (; surface; surface=surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a844dd16f25eea3afb63262bf54937b05">next</a>) {
<a name="l01006"></a>01006                     pid= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a>), <span class="stringliteral">&quot;PTCacheID&quot;</span>);
<a name="l01007"></a>01007                     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a65216ebe614f6e108d88b059a1bec408">BKE_ptcache_id_from_dynamicpaint</a>(pid, ob, surface);
<a name="l01008"></a>01008                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, pid);
<a name="l01009"></a>01009                 }
<a name="l01010"></a>01010             }
<a name="l01011"></a>01011         }
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keywordflow">if</span> (scene &amp;&amp; (duplis-- &gt; 0) &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a1091cd84d4d7227ab41b167e84be3065">transflag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a09b56b47e42a59a4266c995ded542ea6">OB_DUPLI</a>)) {
<a name="l01015"></a>01015         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb_dupli_ob;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017         <span class="keywordflow">if</span> ((lb_dupli_ob=<a class="code" href="../../df/dd0/BKE__anim_8h.html#a8e20fdaf71c0bc4466b67ec835807bbf">object_duplilist</a>(scene, ob))) {
<a name="l01018"></a>01018             <a class="code" href="../../d5/d47/structDupliObject.html">DupliObject</a> *dob;
<a name="l01019"></a>01019             <span class="keywordflow">for</span> (dob= lb_dupli_ob-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dob; dob= dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af87591f8d98950df0cb823aaf5775877">next</a>) {
<a name="l01020"></a>01020                 <span class="keywordflow">if</span> (dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a> != ob) { <span class="comment">/* avoids recursive loops with dupliframes: bug 22988 */</span>
<a name="l01021"></a>01021                     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> lb_dupli_pid;
<a name="l01022"></a>01022                     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2308780fc8b6f269567217d7e9e9d3e6">BKE_ptcache_ids_from_object</a>(&amp;lb_dupli_pid, dob-&gt;<a class="code" href="../../d5/d47/structDupliObject.html#af01d1a6578e81fc3b06c31d41aecbc28">ob</a>, scene, duplis);
<a name="l01023"></a>01023                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aea47205fbf4fc9965bc2b06e7e3ca75a">BLI_movelisttolist</a>(lb, &amp;lb_dupli_pid);
<a name="l01024"></a>01024                     <span class="keywordflow">if</span> (lb_dupli_pid.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l01025"></a>01025                         printf(<span class="stringliteral">&quot;Adding Dupli\n&quot;</span>);
<a name="l01026"></a>01026                 }
<a name="l01027"></a>01027             }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029             <a class="code" href="../../df/dd0/BKE__anim_8h.html#a6e75b271f0e0049858eadb8122d87626">free_object_duplilist</a>(lb_dupli_ob); <span class="comment">/* does restore */</span>
<a name="l01030"></a>01030         }
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="comment">/* File handling */</span>
<a name="l01035"></a>01035 
<a name="l01036"></a>01036 <span class="comment">/* Takes an Object ID and returns a unique name</span>
<a name="l01037"></a>01037 <span class="comment"> * - id: object id</span>
<a name="l01038"></a>01038 <span class="comment"> * - cfra: frame for the cache, can be negative</span>
<a name="l01039"></a>01039 <span class="comment"> * - stack_index: index in the modifier stack. we can have cache for more then one stack_index</span>
<a name="l01040"></a>01040 <span class="comment"> */</span>
<a name="l01041"></a>01041 
<a name="l01042"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">01042</a> <span class="preprocessor">#define MAX_PTCACHE_PATH FILE_MAX</span>
<a name="l01043"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">01043</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_PTCACHE_FILE ((FILE_MAX)*2)</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>
<a name="l01045"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">01045</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">char</span> *filename)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047     <a class="code" href="../../da/d4d/structLibrary.html">Library</a> *lib= (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>)? pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>: <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01048"></a>01048     <span class="keyword">const</span> <span class="keywordtype">char</span> *blendfilename= (lib &amp;&amp; (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad6bbeadbb287a858b58061fa873c8cd3">PTCACHE_IGNORE_LIBPATH</a>)==0) ? lib-&gt;<a class="code" href="../../da/d4d/structLibrary.html#a1785b34cf2dc18faeab4c39853593d17">filepath</a>: <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name;
<a name="l01049"></a>01049     <span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>) {
<a name="l01052"></a>01052         strcpy(filename, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af28dd012b5b03ccefc88689266a8ae59">path</a>);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054         <span class="keywordflow">if</span> (strncmp(filename, <span class="stringliteral">&quot;//&quot;</span>, 2)==0)
<a name="l01055"></a>01055             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(filename, blendfilename);
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         <span class="keywordflow">return</span> <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ab80bd3eb1d5a53807b777f4912b34cd9">BLI_add_slash</a>(filename); <span class="comment">/* new strlen() */</span>
<a name="l01058"></a>01058     }
<a name="l01059"></a>01059     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.relbase_valid || lib) {
<a name="l01060"></a>01060         <span class="keywordtype">char</span> file[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>]; <span class="comment">/* we don&#39;t want the dir, only the file */</span>
<a name="l01061"></a>01061 
<a name="l01062"></a>01062         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#aeb23a21e0676b508c4cd49afbb445c55">BLI_split_file_part</a>(blendfilename, file, <span class="keyword">sizeof</span>(file));
<a name="l01063"></a>01063         <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(file);
<a name="l01064"></a>01064         
<a name="l01065"></a>01065         <span class="comment">/* remove .blend */</span>
<a name="l01066"></a>01066         <span class="keywordflow">if</span> (<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> &gt; 6)
<a name="l01067"></a>01067             file[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>-6] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01068"></a>01068         
<a name="l01069"></a>01069         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(filename, <a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>, <span class="stringliteral">&quot;//&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#aeb7a3c5f7f1684d83395b4636fd1a755">PTCACHE_PATH</a><span class="stringliteral">&quot;%s&quot;</span>, file); <span class="comment">/* add blend file name to pointcache dir */</span>
<a name="l01070"></a>01070         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(filename, blendfilename);
<a name="l01071"></a>01071         <span class="keywordflow">return</span> <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ab80bd3eb1d5a53807b777f4912b34cd9">BLI_add_slash</a>(filename); <span class="comment">/* new strlen() */</span>
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073     
<a name="l01074"></a>01074     <span class="comment">/* use the temp path. this is weak but better then not using point cache at all */</span>
<a name="l01075"></a>01075     <span class="comment">/* temporary directory is assumed to exist and ALWAYS has a trailing slash */</span>
<a name="l01076"></a>01076     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(filename, <a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>, <span class="stringliteral">&quot;%s&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#aeb7a3c5f7f1684d83395b4636fd1a755">PTCACHE_PATH</a><span class="stringliteral">&quot;%d&quot;</span>, <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a86a333bbabf398f4d08f0a845f8d358e">BLI_temporary_dir</a>(), <a class="code" href="../../d1/d22/stdosl_8h.html#a1200284b0188ff3732b55b964e5e3a25">abs</a>(getpid()));
<a name="l01077"></a>01077     
<a name="l01078"></a>01078     <span class="keywordflow">return</span> <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ab80bd3eb1d5a53807b777f4912b34cd9">BLI_add_slash</a>(filename); <span class="comment">/* new strlen() */</span>
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 
<a name="l01081"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">01081</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> cfra, <span class="keywordtype">short</span> do_path, <span class="keywordtype">short</span> do_ext)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083     <span class="keywordtype">int</span> len=0;
<a name="l01084"></a>01084     <span class="keywordtype">char</span> *idname;
<a name="l01085"></a>01085     <span class="keywordtype">char</span> *newname;
<a name="l01086"></a>01086     filename[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01087"></a>01087     newname = filename;
<a name="l01088"></a>01088     
<a name="l01089"></a>01089     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.relbase_valid &amp;&amp; (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>)==0) <span class="keywordflow">return</span> 0; <span class="comment">/* save blend file before using disk pointcache */</span>
<a name="l01090"></a>01090     
<a name="l01091"></a>01091     <span class="comment">/* start with temp dir */</span>
<a name="l01092"></a>01092     <span class="keywordflow">if</span> (do_path) {
<a name="l01093"></a>01093         len = <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(pid, filename);
<a name="l01094"></a>01094         newname += <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01095"></a>01095     }
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>[0] == <span class="charliteral">&#39;\0&#39;</span> &amp;&amp; (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>)==0) {
<a name="l01097"></a>01097         idname = (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2);
<a name="l01098"></a>01098         <span class="comment">/* convert chars to hex so they are always a valid filename */</span>
<a name="l01099"></a>01099         <span class="keywordflow">while</span> (<span class="charliteral">&#39;\0&#39;</span> != *idname) {
<a name="l01100"></a>01100             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(newname, <a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>, <span class="stringliteral">&quot;%02X&quot;</span>, (<span class="keywordtype">char</span>)(*idname++));
<a name="l01101"></a>01101             newname+=2;
<a name="l01102"></a>01102             len += 2;
<a name="l01103"></a>01103         }
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105     <span class="keywordflow">else</span> {
<a name="l01106"></a>01106         <span class="keywordtype">int</span> temp = (int)<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>); 
<a name="l01107"></a>01107         strcpy(newname, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>); 
<a name="l01108"></a>01108         newname+=temp;
<a name="l01109"></a>01109         len += temp;
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="keywordflow">if</span> (do_ext) {
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a> &lt; 0)
<a name="l01115"></a>01115             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a> =  pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a> = <a class="code" href="../../df/dac/BKE__object_8h.html#ad4c904ccbc31c82ef8aacf0dce930981">object_insert_ptcache</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>) {
<a name="l01118"></a>01118             <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a> &gt;= 0)
<a name="l01119"></a>01119                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(newname, <a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>, <span class="stringliteral">&quot;_%06d_%02u&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, cfra, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>); <span class="comment">/* always 6 chars */</span>
<a name="l01120"></a>01120             <span class="keywordflow">else</span>
<a name="l01121"></a>01121                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(newname, <a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>, <span class="stringliteral">&quot;_%06d&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, cfra); <span class="comment">/* always 6 chars */</span>
<a name="l01122"></a>01122         }
<a name="l01123"></a>01123         <span class="keywordflow">else</span> {
<a name="l01124"></a>01124             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(newname, <a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>, <span class="stringliteral">&quot;_%06d_%02u&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, cfra, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>); <span class="comment">/* always 6 chars */</span>
<a name="l01125"></a>01125         }
<a name="l01126"></a>01126         len += 16;
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128     
<a name="l01129"></a>01129     <span class="keywordflow">return</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; <span class="comment">/* make sure the above string is always 16 chars */</span>
<a name="l01130"></a>01130 }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 <span class="comment">/* youll need to close yourself after! */</span>
<a name="l01133"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">01133</a> <span class="keyword">static</span> <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> cfra)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l01136"></a>01136     FILE *fp = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01137"></a>01137     <span class="keywordtype">char</span> filename[(<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>)*2];
<a name="l01138"></a>01138 
<a name="l01139"></a>01139 <span class="preprocessor">#ifndef DURIAN_POINTCACHE_LIB_OK</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>    <span class="comment">/* don&#39;t allow writing for linked objects */</span>
<a name="l01141"></a>01141     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a> &amp;&amp; mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a37cd01ec7baf117b10662b6a36f3f92d">PTCACHE_FILE_WRITE</a>)
<a name="l01142"></a>01142         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01143"></a>01143 <span class="preprocessor">#endif</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.relbase_valid &amp;&amp; (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>)==0) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* save blend file before using disk pointcache */</span>
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, cfra, 1, 1);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a08f62037a9e520e3374ee79d422ef308">PTCACHE_FILE_READ</a>) {
<a name="l01149"></a>01149         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(filename)) {
<a name="l01150"></a>01150             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152         fp = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a270e4b01aaea72fa0d091cf3b32015af">BLI_fopen</a>(filename, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l01153"></a>01153     }
<a name="l01154"></a>01154     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a37cd01ec7baf117b10662b6a36f3f92d">PTCACHE_FILE_WRITE</a>) {
<a name="l01155"></a>01155         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(filename); <span class="comment">/* will create the dir if needs be, same as //textures is created */</span>
<a name="l01156"></a>01156         fp = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a270e4b01aaea72fa0d091cf3b32015af">BLI_fopen</a>(filename, <span class="stringliteral">&quot;wb&quot;</span>);
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#ab3416f4b74442edede581b369df04c7a">PTCACHE_FILE_UPDATE</a>) {
<a name="l01159"></a>01159         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(filename);
<a name="l01160"></a>01160         fp = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a270e4b01aaea72fa0d091cf3b32015af">BLI_fopen</a>(filename, <span class="stringliteral">&quot;rb+&quot;</span>);
<a name="l01161"></a>01161     }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="keywordflow">if</span> (!fp)
<a name="l01164"></a>01164         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     pf= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a>), <span class="stringliteral">&quot;PTCacheFile&quot;</span>);
<a name="l01167"></a>01167     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>= fp;
<a name="l01168"></a>01168     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#acfa37ebcd648399b64c50654678eb202">old_format</a> = 0;
<a name="l01169"></a>01169     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#ad686df2374e2c3944f9d836eacf88f25">frame</a> = cfra;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l01172"></a>01172 }
<a name="l01173"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">01173</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01174"></a>01174 {
<a name="l01175"></a>01175     <span class="keywordflow">if</span> (pf) {
<a name="l01176"></a>01176         fclose(pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>);
<a name="l01177"></a>01177         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pf);
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 }
<a name="l01180"></a>01180 
<a name="l01181"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">01181</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *result, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len)
<a name="l01182"></a>01182 {
<a name="l01183"></a>01183     <span class="keywordtype">int</span> r = 0;
<a name="l01184"></a>01184     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> compressed = 0;
<a name="l01185"></a>01185     <span class="keywordtype">size_t</span> in_len;
<a name="l01186"></a>01186 <span class="preprocessor">#ifdef WITH_LZO</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>    <span class="keywordtype">size_t</span> out_len = <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01188"></a>01188 <span class="preprocessor">#endif</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in;
<a name="l01190"></a>01190     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *props = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(16*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <span class="stringliteral">&quot;tmp&quot;</span>);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;compressed, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01193"></a>01193     <span class="keywordflow">if</span> (compressed) {
<a name="l01194"></a>01194         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l01195"></a>01195         <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;size, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01196"></a>01196         in_len = (size_t)size;
<a name="l01197"></a>01197         <span class="keywordflow">if</span> (in_len==0) {
<a name="l01198"></a>01198             <span class="comment">/* do nothing */</span>
<a name="l01199"></a>01199         }
<a name="l01200"></a>01200         <span class="keywordflow">else</span> {
<a name="l01201"></a>01201             in = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*in_len, <span class="stringliteral">&quot;pointcache_compressed_buffer&quot;</span>);
<a name="l01202"></a>01202             <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, in, in_len, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01203"></a>01203 <span class="preprocessor">#ifdef WITH_LZO</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (compressed == 1)
<a name="l01205"></a>01205                 r = lzo1x_decompress_safe(in, (lzo_uint)in_len, result, (lzo_uint *)&amp;out_len, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01206"></a>01206 <span class="preprocessor">#endif</span>
<a name="l01207"></a>01207 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_LZMA</span>
<a name="l01208"></a>01208 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (compressed == 2)
<a name="l01209"></a>01209             {
<a name="l01210"></a>01210                 <span class="keywordtype">size_t</span> sizeOfIt;
<a name="l01211"></a>01211                 <span class="keywordtype">size_t</span> leni = in_len, leno = <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01212"></a>01212                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;size, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01213"></a>01213                 sizeOfIt = (size_t)size;
<a name="l01214"></a>01214                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, props, sizeOfIt, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01215"></a>01215                 r = LzmaUncompress(result, &amp;leno, in, &amp;leni, props, sizeOfIt);
<a name="l01216"></a>01216             }
<a name="l01217"></a>01217 <span class="preprocessor">#endif</span>
<a name="l01218"></a>01218 <span class="preprocessor"></span>            <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(in);
<a name="l01219"></a>01219         }
<a name="l01220"></a>01220     }
<a name="l01221"></a>01221     <span class="keywordflow">else</span> {
<a name="l01222"></a>01222         <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, result, len, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01223"></a>01223     }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(props);
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     <span class="keywordflow">return</span> r;
<a name="l01228"></a>01228 }
<a name="l01229"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">01229</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out, <span class="keywordtype">int</span> mode)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231     <span class="keywordtype">int</span> r = 0;
<a name="l01232"></a>01232     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> compressed = 0;
<a name="l01233"></a>01233     <span class="keywordtype">size_t</span> out_len= 0;
<a name="l01234"></a>01234     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *props = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(16*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <span class="stringliteral">&quot;tmp&quot;</span>);
<a name="l01235"></a>01235     <span class="keywordtype">size_t</span> sizeOfIt = 5;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     (void)mode; <span class="comment">/* unused when building w/o compression */</span>
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 <span class="preprocessor">#ifdef WITH_LZO</span>
<a name="l01240"></a>01240 <span class="preprocessor"></span>    out_len= <a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len);
<a name="l01241"></a>01241     <span class="keywordflow">if</span> (mode == 1) {
<a name="l01242"></a>01242         LZO_HEAP_ALLOC(wrkmem, LZO1X_MEM_COMPRESS);
<a name="l01243"></a>01243         
<a name="l01244"></a>01244         r = lzo1x_1_compress(in, (lzo_uint)in_len, out, (lzo_uint *)&amp;out_len, wrkmem);  
<a name="l01245"></a>01245         <span class="keywordflow">if</span> (!(r == LZO_E_OK) || (out_len &gt;= in_len))
<a name="l01246"></a>01246             compressed = 0;
<a name="l01247"></a>01247         <span class="keywordflow">else</span>
<a name="l01248"></a>01248             compressed = 1;
<a name="l01249"></a>01249     }
<a name="l01250"></a>01250 <span class="preprocessor">#endif</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_LZMA</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mode == 2) {
<a name="l01253"></a>01253         
<a name="l01254"></a>01254         r = LzmaCompress(out, &amp;out_len, in, in_len,<span class="comment">//assume sizeof(char)==1....</span>
<a name="l01255"></a>01255                         props, &amp;sizeOfIt, 5, 1 &lt;&lt; 24, 3, 0, 2, 32, 2);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257         <span class="keywordflow">if</span> (!(r == SZ_OK) || (out_len &gt;= in_len))
<a name="l01258"></a>01258             compressed = 0;
<a name="l01259"></a>01259         <span class="keywordflow">else</span>
<a name="l01260"></a>01260             compressed = 2;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262 <span class="preprocessor">#endif</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span>    
<a name="l01264"></a>01264     <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;compressed, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01265"></a>01265     <span class="keywordflow">if</span> (compressed) {
<a name="l01266"></a>01266         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = out_len;
<a name="l01267"></a>01267         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;size, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01268"></a>01268         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, out, out_len, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270     <span class="keywordflow">else</span>
<a name="l01271"></a>01271         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, in, in_len, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     <span class="keywordflow">if</span> (compressed == 2)
<a name="l01274"></a>01274     {
<a name="l01275"></a>01275         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = sizeOfIt;
<a name="l01276"></a>01276         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;sizeOfIt, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01277"></a>01277         <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, props, size, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(props);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282     <span class="keywordflow">return</span> r;
<a name="l01283"></a>01283 }
<a name="l01284"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">01284</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keywordtype">void</span> *f, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286     <span class="keywordflow">return</span> (fread(f, size, tot, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>) == tot);
<a name="l01287"></a>01287 }
<a name="l01288"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">01288</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf, <span class="keyword">const</span> <span class="keywordtype">void</span> *f, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size)
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290     <span class="keywordflow">return</span> (fwrite(f, size, tot, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>) == tot);
<a name="l01291"></a>01291 }
<a name="l01292"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#affef16068c581622bbea82194e40ff37">01292</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#affef16068c581622bbea82194e40ff37">ptcache_file_data_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01297"></a>01297         <span class="keywordflow">if</span> ((pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> &amp; (1&lt;&lt;i)) &amp;&amp; !ptcache_file_read(pf, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[i], 1, <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i]))
<a name="l01298"></a>01298             <span class="keywordflow">return</span> 0;
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300     
<a name="l01301"></a>01301     <span class="keywordflow">return</span> 1;
<a name="l01302"></a>01302 }
<a name="l01303"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a799d3e3de696020024d60a98fc360cde">01303</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a799d3e3de696020024d60a98fc360cde">ptcache_file_data_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01304"></a>01304 {       
<a name="l01305"></a>01305     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01308"></a>01308         <span class="keywordflow">if</span> ((pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> &amp; (1&lt;&lt;i)) &amp;&amp; !ptcache_file_write(pf, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[i], 1, <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i]))
<a name="l01309"></a>01309             <span class="keywordflow">return</span> 0;
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311     
<a name="l01312"></a>01312     <span class="keywordflow">return</span> 1;
<a name="l01313"></a>01313 }
<a name="l01314"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af3d476ef312c4e1d20f7cf57d9b220f9">01314</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#af3d476ef312c4e1d20f7cf57d9b220f9">ptcache_file_header_begin_read</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01315"></a>01315 {
<a name="l01316"></a>01316     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> typeflag=0;
<a name="l01317"></a>01317     <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>=0;
<a name="l01318"></a>01318     <span class="keywordtype">char</span> bphysics[8];
<a name="l01319"></a>01319     
<a name="l01320"></a>01320     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> = 0;
<a name="l01321"></a>01321     
<a name="l01322"></a>01322     <span class="keywordflow">if</span> (fread(bphysics, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 8, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>) != 8)
<a name="l01323"></a>01323         error = 1;
<a name="l01324"></a>01324     
<a name="l01325"></a>01325     <span class="keywordflow">if</span> (!error &amp;&amp; strncmp(bphysics, <span class="stringliteral">&quot;BPHYSICS&quot;</span>, 8))
<a name="l01326"></a>01326         error = 1;
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     <span class="keywordflow">if</span> (!error &amp;&amp; !fread(&amp;typeflag, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l01329"></a>01329         error = 1;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> = (typeflag &amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a06976694417be27d91a6b1835b5cb759">PTCACHE_TYPEFLAG_TYPEMASK</a>);
<a name="l01332"></a>01332     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> = (typeflag &amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a8eef85ec13d3f5a8c7eb50cf80391c30">PTCACHE_TYPEFLAG_FLAGMASK</a>);
<a name="l01333"></a>01333     
<a name="l01334"></a>01334     <span class="comment">/* if there was an error set file as it was */</span>
<a name="l01335"></a>01335     <span class="keywordflow">if</span> (error)
<a name="l01336"></a>01336         <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#aa083b8d40680af41008094ea2ffd5c59">fseek</a>(pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>, 0, SEEK_SET);
<a name="l01337"></a>01337 
<a name="l01338"></a>01338     <span class="keywordflow">return</span> !<a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l01339"></a>01339 }
<a name="l01340"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ae62f7d628e8c3c7a1c634ab683fce9ff">01340</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#ae62f7d628e8c3c7a1c634ab683fce9ff">ptcache_file_header_begin_write</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342     <span class="keyword">const</span> <span class="keywordtype">char</span> *bphysics = <span class="stringliteral">&quot;BPHYSICS&quot;</span>;
<a name="l01343"></a>01343     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> typeflag = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> + pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a>;
<a name="l01344"></a>01344     
<a name="l01345"></a>01345     <span class="keywordflow">if</span> (fwrite(bphysics, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 8, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>) != 8)
<a name="l01346"></a>01346         <span class="keywordflow">return</span> 0;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keywordflow">if</span> (!fwrite(&amp;typeflag, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>), 1, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a87a769095719bf672fcf19fe164b1ce3">fp</a>))
<a name="l01349"></a>01349         <span class="keywordflow">return</span> 0;
<a name="l01350"></a>01350     
<a name="l01351"></a>01351     <span class="keywordflow">return</span> 1;
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 <span class="comment">/* Data pointer handling */</span>
<a name="l01355"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a03341cb500421a27b0452309677c0610">01355</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a03341cb500421a27b0452309677c0610">BKE_ptcache_data_size</a>(<span class="keywordtype">int</span> data_type)
<a name="l01356"></a>01356 {
<a name="l01357"></a>01357     <span class="keywordflow">return</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[data_type];
<a name="l01358"></a>01358 }
<a name="l01359"></a>01359 
<a name="l01360"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a79d80da2f778e2fb640baca118168188">01360</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a79d80da2f778e2fb640baca118168188">ptcache_file_pointers_init</a>(<a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf)
<a name="l01361"></a>01361 {
<a name="l01362"></a>01362     <span class="keywordtype">int</span> data_types = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a>;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>] =     (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>))    ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#af9f74c80774db4cf7e875fec0834af92">index</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01365"></a>01365     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>] =  (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a153ded7696da27f84bbd5261c11d6348">BPHYS_DATA_LOCATION</a>)) ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#ad820a0687a47bf1e6244aa9914f868f4">loc</a>   : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01366"></a>01366     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>] =  (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a569f0fd5a2821b79c830f34d3729be67">BPHYS_DATA_VELOCITY</a>)) ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#a54149bfdf73209e121f0a02dea1ada2a">vel</a>   : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01367"></a>01367     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>] =  (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abb9071cff4d61c4ce5b4e1e9995615de">BPHYS_DATA_ROTATION</a>)) ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#ae8ca9e25cf43184968a147eaad0a1894">rot</a>   : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01368"></a>01368     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>] = (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#abdb53631400086e64320f614a016d918">BPHYS_DATA_AVELOCITY</a>))?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#a4e326cebcf049a4efb90ef57bf94124b">ave</a>   : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01369"></a>01369     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4ba18d7005288eb8c8ffd716b2d74403">BPHYS_DATA_SIZE</a>] =      (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4ba18d7005288eb8c8ffd716b2d74403">BPHYS_DATA_SIZE</a>))     ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#af5a68740f132ca3fc5430665da0328e9">size</a>  : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01370"></a>01370     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a43c9b1cefacb99d22a41acec469386be">BPHYS_DATA_TIMES</a>] =     (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a43c9b1cefacb99d22a41acec469386be">BPHYS_DATA_TIMES</a>))    ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#abedb206bf21316645f94391892319ea9">times</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01371"></a>01371     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45c8fc7edea3203df76f8118ac9e6b19">BPHYS_DATA_BOIDS</a>] =     (data_types &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45c8fc7edea3203df76f8118ac9e6b19">BPHYS_DATA_BOIDS</a>))    ?       &amp;pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2f245b32308ea4d2d09bacf3384d93c6">data</a>.<a class="code" href="../../d3/d7e/structPTCacheData.html#a38fd3cf8697840bf653ed554f3510c81">boids</a> : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01372"></a>01372 }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 <span class="comment">/* Check to see if point number &quot;index&quot; is in pm, uses binary search for index data. */</span>
<a name="l01375"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a25fa46c93b57fffe0b3ee6da0badab50">01375</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaf6e0fd70b75e7ac1253c13084817387">BKE_ptcache_mem_index_find</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index)
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377     <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>]) {
<a name="l01378"></a>01378         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *data = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>];
<a name="l01379"></a>01379         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> mid, low = 0, high = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a> - 1;
<a name="l01380"></a>01380 
<a name="l01381"></a>01381         <span class="keywordflow">if</span> (index &lt; *data || index &gt; *(data+high))
<a name="l01382"></a>01382             <span class="keywordflow">return</span> -1;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="comment">/* check simple case for continuous indexes first */</span>
<a name="l01385"></a>01385         <span class="keywordflow">if</span> (index-*data &lt; high &amp;&amp; data[index-*data] == index)
<a name="l01386"></a>01386             <span class="keywordflow">return</span> index-*<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>;
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <span class="keywordflow">while</span> (low &lt;= high) {
<a name="l01389"></a>01389             mid= (low + high)/2;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391             <span class="keywordflow">if</span> (data[mid] &gt; index)
<a name="l01392"></a>01392                 high = mid - 1;
<a name="l01393"></a>01393             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (data[mid] &lt; index)
<a name="l01394"></a>01394                 low = mid + 1;
<a name="l01395"></a>01395             <span class="keywordflow">else</span>
<a name="l01396"></a>01396                 <span class="keywordflow">return</span> mid;
<a name="l01397"></a>01397         }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399         <span class="keywordflow">return</span> -1;
<a name="l01400"></a>01400     }
<a name="l01401"></a>01401     <span class="keywordflow">else</span> {
<a name="l01402"></a>01402         <span class="keywordflow">return</span> (index &lt; pm-&gt;totpoint ? index : -1);
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404 }
<a name="l01405"></a>01405 
<a name="l01406"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a9cc2e3a4355f328fe60589cfef3d2e7c">01406</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01407"></a>01407 {
<a name="l01408"></a>01408     <span class="keywordtype">int</span> data_types = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a>;
<a name="l01409"></a>01409     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++)
<a name="l01412"></a>01412         pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[i] = ((data_types &amp; (1&lt;&lt;i)) ? pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i] : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01413"></a>01413 }
<a name="l01414"></a>01414 
<a name="l01415"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a46fc23a73147d5d987ba8f32d26eee49">01415</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01416"></a>01416 {
<a name="l01417"></a>01417     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01418"></a>01418 
<a name="l01419"></a>01419     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01420"></a>01420         <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[i])
<a name="l01421"></a>01421             pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (<span class="keywordtype">char</span>*)pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[i] + <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i];
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423 }
<a name="l01424"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a68faeb435d418822ab05f522b0c4fb3e">01424</a> <span class="keywordtype">int</span>  <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5320bb7846b9065b9b65fba21df2748f">BKE_ptcache_mem_pointers_seek</a>(<span class="keywordtype">int</span> point_index, <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426     <span class="keywordtype">int</span> data_types = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a>;
<a name="l01427"></a>01427     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, index = <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaf6e0fd70b75e7ac1253c13084817387">BKE_ptcache_mem_index_find</a>(pm, point_index);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429     <span class="keywordflow">if</span> (index &lt; 0) {
<a name="l01430"></a>01430         <span class="comment">/* Can&#39;t give proper location without reallocation, so don&#39;t give any location.</span>
<a name="l01431"></a>01431 <span class="comment">         * Some points will be cached improperly, but this only happens with simulation</span>
<a name="l01432"></a>01432 <span class="comment">         * steps bigger than cache-&gt;step, so the cache has to be recalculated anyways</span>
<a name="l01433"></a>01433 <span class="comment">         * at some point.</span>
<a name="l01434"></a>01434 <span class="comment">         */</span>
<a name="l01435"></a>01435         <span class="keywordflow">return</span> 0;
<a name="l01436"></a>01436     }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++)
<a name="l01439"></a>01439         pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[i] = data_types &amp; (1&lt;&lt;i) ? (<span class="keywordtype">char</span>*)pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i] + index * <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i] : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441     <span class="keywordflow">return</span> 1;
<a name="l01442"></a>01442 }
<a name="l01443"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a4ce7d280bad06f58e1f481d2400a2803">01443</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ce7d280bad06f58e1f481d2400a2803">ptcache_data_alloc</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01444"></a>01444 {
<a name="l01445"></a>01445     <span class="keywordtype">int</span> data_types = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a>;
<a name="l01446"></a>01446     <span class="keywordtype">int</span> totpoint = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>;
<a name="l01447"></a>01447     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01450"></a>01450         <span class="keywordflow">if</span> (data_types &amp; (1&lt;&lt;i))
<a name="l01451"></a>01451             pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(totpoint * <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i], <span class="stringliteral">&quot;PTCache Data&quot;</span>);
<a name="l01452"></a>01452     }
<a name="l01453"></a>01453 }
<a name="l01454"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">01454</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01455"></a>01455 {
<a name="l01456"></a>01456     <span class="keywordtype">void</span> **data = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>;
<a name="l01457"></a>01457     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01460"></a>01460         <span class="keywordflow">if</span> (data[i])
<a name="l01461"></a>01461             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(data[i]);
<a name="l01462"></a>01462     }
<a name="l01463"></a>01463 }
<a name="l01464"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a19c6b382dc8375222e85044f39372d42">01464</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a19c6b382dc8375222e85044f39372d42">ptcache_data_copy</a>(<span class="keywordtype">void</span> *from[], <span class="keywordtype">void</span> *to[])
<a name="l01465"></a>01465 {
<a name="l01466"></a>01466     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01467"></a>01467     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01468"></a>01468     <span class="comment">/* note, durian file 03.4b_comp crashes if to[i] is not tested</span>
<a name="l01469"></a>01469 <span class="comment">     * its NULL, not sure if this should be fixed elsewhere but for now its needed */</span>
<a name="l01470"></a>01470         <span class="keywordflow">if</span> (from[i] &amp;&amp; to[i])
<a name="l01471"></a>01471             memcpy(to[i], from[i], <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[i]);
<a name="l01472"></a>01472     }
<a name="l01473"></a>01473 }
<a name="l01474"></a>01474 
<a name="l01475"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">01475</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01476"></a>01476 {
<a name="l01477"></a>01477     <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     <span class="keywordflow">if</span> (extra) {
<a name="l01480"></a>01480         <span class="keywordflow">for</span> (; extra; extra=extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a652f1bab30cf02b3519b372fc168c5bf">next</a>) {
<a name="l01481"></a>01481             <span class="keywordflow">if</span> (extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>)
<a name="l01482"></a>01482                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>);
<a name="l01483"></a>01483         }
<a name="l01484"></a>01484 
<a name="l01485"></a>01485         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>);
<a name="l01486"></a>01486     }
<a name="l01487"></a>01487 }
<a name="l01488"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#abf4bd0f2faaa4ba562667b36028ba351">01488</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#abf4bd0f2faaa4ba562667b36028ba351">ptcache_old_elemsize</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l01489"></a>01489 {
<a name="l01490"></a>01490     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a8f896983be158775838cbf7fc1ffa45d">PTCACHE_TYPE_SOFTBODY</a>)
<a name="l01491"></a>01491         <span class="keywordflow">return</span> 6 * <span class="keyword">sizeof</span>(float);
<a name="l01492"></a>01492     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a>)
<a name="l01493"></a>01493         <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code" href="../../de/d5a/DNA__particle__types_8h.html#acd2e3bc003a7d197a14bf38e5d0fcbda">ParticleKey</a>);
<a name="l01494"></a>01494     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a64019fd6972f164398f3b2f022fd9e74">PTCACHE_TYPE_CLOTH</a>)
<a name="l01495"></a>01495         <span class="keywordflow">return</span> 9 * <span class="keyword">sizeof</span>(float);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     <span class="keywordflow">return</span> 0;
<a name="l01498"></a>01498 }
<a name="l01499"></a>01499 
<a name="l01500"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aa8ffe5139059cffcab2867104c2b3800">01500</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aa8ffe5139059cffcab2867104c2b3800">ptcache_find_frames_around</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frame, <span class="keywordtype">int</span> *fra1, <span class="keywordtype">int</span> *fra2)
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01503"></a>01503         <span class="keywordtype">int</span> cfra1=frame, cfra2=frame+1;
<a name="l01504"></a>01504 
<a name="l01505"></a>01505         <span class="keywordflow">while</span> (cfra1 &gt;= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfra1))
<a name="l01506"></a>01506             cfra1--;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508         <span class="keywordflow">if</span> (cfra1 &lt; pid-&gt;cache-&gt;startframe)
<a name="l01509"></a>01509             cfra1 = 0;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511         <span class="keywordflow">while</span> (cfra2 &lt;= pid-&gt;cache-&gt;endframe &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfra2))
<a name="l01512"></a>01512             cfra2++;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514         <span class="keywordflow">if</span> (cfra2 &gt; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>)
<a name="l01515"></a>01515             cfra2 = 0;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517         <span class="keywordflow">if</span> (cfra1 &amp;&amp; !cfra2) {
<a name="l01518"></a>01518             *fra1 = 0;
<a name="l01519"></a>01519             *fra2 = cfra1;
<a name="l01520"></a>01520         }
<a name="l01521"></a>01521         <span class="keywordflow">else</span> {
<a name="l01522"></a>01522             *fra1 = cfra1;
<a name="l01523"></a>01523             *fra2 = cfra2;
<a name="l01524"></a>01524         }
<a name="l01525"></a>01525     }
<a name="l01526"></a>01526     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01527"></a>01527         <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01528"></a>01528         <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm2 = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530         <span class="keywordflow">while</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &lt;= frame)
<a name="l01531"></a>01531             pm= pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         <span class="keywordflow">if</span> (pm2-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &lt; frame) {
<a name="l01534"></a>01534             pm2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01535"></a>01535         }
<a name="l01536"></a>01536         <span class="keywordflow">else</span> {
<a name="l01537"></a>01537             <span class="keywordflow">while</span> (pm2-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#ab2413363a7178af9f9e681de442f75f5">prev</a> &amp;&amp; pm2-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#ab2413363a7178af9f9e681de442f75f5">prev</a>-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &gt; frame) {
<a name="l01538"></a>01538                 pm2= pm2-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#ab2413363a7178af9f9e681de442f75f5">prev</a>;
<a name="l01539"></a>01539             }
<a name="l01540"></a>01540         }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542         <span class="keywordflow">if</span> (!pm2) {
<a name="l01543"></a>01543             *fra1 = 0;
<a name="l01544"></a>01544             *fra2 = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>;
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546         <span class="keywordflow">else</span> {
<a name="l01547"></a>01547             *fra1 = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>;
<a name="l01548"></a>01548             *fra2 = pm2-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>;
<a name="l01549"></a>01549         }
<a name="l01550"></a>01550     }
<a name="l01551"></a>01551 }
<a name="l01552"></a>01552 
<a name="l01553"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">01553</a> <span class="keyword">static</span> <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *<a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">ptcache_disk_frame_to_mem</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra)
<a name="l01554"></a>01554 {
<a name="l01555"></a>01555     <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf = <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a08f62037a9e520e3374ee79d422ef308">PTCACHE_FILE_READ</a>, cfra);
<a name="l01556"></a>01556     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01557"></a>01557     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559     <span class="keywordflow">if</span> (pf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01560"></a>01560         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#af3d476ef312c4e1d20f7cf57d9b220f9">ptcache_file_header_begin_read</a>(pf))
<a name="l01563"></a>01563         error = 1;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565     <span class="keywordflow">if</span> (!error &amp;&amp; (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> != pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> || !pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>(pf)))
<a name="l01566"></a>01566         error = 1;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568     <span class="keywordflow">if</span> (!error) {
<a name="l01569"></a>01569         pm = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a>), <span class="stringliteral">&quot;Pointcache mem&quot;</span>);
<a name="l01570"></a>01570 
<a name="l01571"></a>01571         pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a> = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a>;
<a name="l01572"></a>01572         pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a> = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a>;
<a name="l01573"></a>01573         pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#ad686df2374e2c3944f9d836eacf88f25">frame</a>;
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ce7d280bad06f58e1f481d2400a2803">ptcache_data_alloc</a>(pm);
<a name="l01576"></a>01576 
<a name="l01577"></a>01577         <span class="keywordflow">if</span> (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> &amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaba39c7cfad958f2312fd4b2ab5931df">PTCACHE_TYPEFLAG_COMPRESS</a>) {
<a name="l01578"></a>01578             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01579"></a>01579                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> out_len = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>*<a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01580"></a>01580                 <span class="keywordflow">if</span> (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> &amp; (1&lt;&lt;i))
<a name="l01581"></a>01581                     <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i]), out_len);
<a name="l01582"></a>01582             }
<a name="l01583"></a>01583         }
<a name="l01584"></a>01584         <span class="keywordflow">else</span> {
<a name="l01585"></a>01585             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(pm);
<a name="l01586"></a>01586             <a class="code" href="../../d3/d9b/pointcache_8c.html#a79d80da2f778e2fb640baca118168188">ptcache_file_pointers_init</a>(pf);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588             <span class="keywordflow">for</span> (i=0; i&lt;pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>; i++) {
<a name="l01589"></a>01589                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#affef16068c581622bbea82194e40ff37">ptcache_file_data_read</a>(pf)) {
<a name="l01590"></a>01590                     error = 1;
<a name="l01591"></a>01591                     <span class="keywordflow">break</span>;
<a name="l01592"></a>01592                 }
<a name="l01593"></a>01593                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a19c6b382dc8375222e85044f39372d42">ptcache_data_copy</a>(pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>);
<a name="l01594"></a>01594                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(pm);
<a name="l01595"></a>01595             }
<a name="l01596"></a>01596         }
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599     <span class="keywordflow">if</span> (!error &amp;&amp; pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> &amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af763b42543fa2f78515eb1048dc71563">PTCACHE_TYPEFLAG_EXTRADATA</a>) {
<a name="l01600"></a>01600         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extratype = 0;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602         <span class="keywordflow">while</span> (<a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;extratype, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>))) {
<a name="l01603"></a>01603             <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a>), <span class="stringliteral">&quot;Pointcache extradata&quot;</span>);
<a name="l01604"></a>01604 
<a name="l01605"></a>01605             extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a> = extratype;
<a name="l01606"></a>01606 
<a name="l01607"></a>01607             <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, &amp;extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01608"></a>01608 
<a name="l01609"></a>01609             extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> * <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>], <span class="stringliteral">&quot;Pointcache extradata-&gt;data&quot;</span>);
<a name="l01610"></a>01610 
<a name="l01611"></a>01611             <span class="keywordflow">if</span> (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> &amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaba39c7cfad958f2312fd4b2ab5931df">PTCACHE_TYPEFLAG_COMPRESS</a>)
<a name="l01612"></a>01612                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a8669c105e9ecfffa7302445df1cd0e55">ptcache_file_compressed_read</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>), extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>*<a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>]);
<a name="l01613"></a>01613             <span class="keywordflow">else</span>
<a name="l01614"></a>01614                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>, extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>, <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>]);
<a name="l01615"></a>01615 
<a name="l01616"></a>01616             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>, extra);
<a name="l01617"></a>01617         }
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="keywordflow">if</span> (error &amp;&amp; pm) {
<a name="l01621"></a>01621         <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l01622"></a>01622         <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l01623"></a>01623         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pm);
<a name="l01624"></a>01624         pm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01625"></a>01625     }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     <span class="keywordflow">if</span> (error &amp;&amp; <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01630"></a>01630         printf(<span class="stringliteral">&quot;Error reading from disk cache\n&quot;</span>);
<a name="l01631"></a>01631     
<a name="l01632"></a>01632     <span class="keywordflow">return</span> pm;
<a name="l01633"></a>01633 }
<a name="l01634"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a549b16b47c422de163fd9e516aca28f0">01634</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a549b16b47c422de163fd9e516aca28f0">ptcache_mem_frame_to_disk</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm)
<a name="l01635"></a>01635 {
<a name="l01636"></a>01636     <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01637"></a>01637     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01638"></a>01638     
<a name="l01639"></a>01639     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac0b363b56171cca3dc616abe8dc862cf">PTCACHE_CLEAR_FRAME</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>);
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     pf = <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a37cd01ec7baf117b10662b6a36f3f92d">PTCACHE_FILE_WRITE</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>);
<a name="l01642"></a>01642 
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (pf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01644"></a>01644         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01645"></a>01645             printf(<span class="stringliteral">&quot;Error opening disk cache file for writing\n&quot;</span>);
<a name="l01646"></a>01646         <span class="keywordflow">return</span> 0;
<a name="l01647"></a>01647     }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a>;
<a name="l01650"></a>01650     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a> = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>;
<a name="l01651"></a>01651     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>;
<a name="l01652"></a>01652     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> = 0;
<a name="l01653"></a>01653     
<a name="l01654"></a>01654     <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l01655"></a>01655         pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af763b42543fa2f78515eb1048dc71563">PTCACHE_TYPEFLAG_EXTRADATA</a>;
<a name="l01656"></a>01656     
<a name="l01657"></a>01657     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a35762bd5af161d81db4685c9b6f17868">compression</a>)
<a name="l01658"></a>01658         pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaba39c7cfad958f2312fd4b2ab5931df">PTCACHE_TYPEFLAG_COMPRESS</a>;
<a name="l01659"></a>01659 
<a name="l01660"></a>01660     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#ae62f7d628e8c3c7a1c634ab683fce9ff">ptcache_file_header_begin_write</a>(pf) || !pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>(pf))
<a name="l01661"></a>01661         error = 1;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="keywordflow">if</span> (!error) {
<a name="l01664"></a>01664         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a35762bd5af161d81db4685c9b6f17868">compression</a>) {
<a name="l01665"></a>01665             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++) {
<a name="l01666"></a>01666                 <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i]) {
<a name="l01667"></a>01667                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>*<a class="code" href="../../d3/d9b/pointcache_8c.html#a4ac972440f8bd507de6aa425510add2b">ptcache_data_size</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01668"></a>01668                     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len)*4, <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l01669"></a>01669                     <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i]), in_len, out, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a35762bd5af161d81db4685c9b6f17868">compression</a>);
<a name="l01670"></a>01670                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l01671"></a>01671                 }
<a name="l01672"></a>01672             }
<a name="l01673"></a>01673         }
<a name="l01674"></a>01674         <span class="keywordflow">else</span> {
<a name="l01675"></a>01675             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(pm);
<a name="l01676"></a>01676             <a class="code" href="../../d3/d9b/pointcache_8c.html#a79d80da2f778e2fb640baca118168188">ptcache_file_pointers_init</a>(pf);
<a name="l01677"></a>01677 
<a name="l01678"></a>01678             <span class="keywordflow">for</span> (i=0; i&lt;pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>; i++) {
<a name="l01679"></a>01679                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a19c6b382dc8375222e85044f39372d42">ptcache_data_copy</a>(pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>, pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a2e6e8f46fbe98e554a088e243b8e1da1">cur</a>);
<a name="l01680"></a>01680                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#a799d3e3de696020024d60a98fc360cde">ptcache_file_data_write</a>(pf)) {
<a name="l01681"></a>01681                     error = 1;
<a name="l01682"></a>01682                     <span class="keywordflow">break</span>;
<a name="l01683"></a>01683                 }
<a name="l01684"></a>01684                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(pm);
<a name="l01685"></a>01685             }
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687     }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689     <span class="keywordflow">if</span> (!error &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l01690"></a>01690         <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01691"></a>01691 
<a name="l01692"></a>01692         <span class="keywordflow">for</span> (; extra; extra=extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a652f1bab30cf02b3519b372fc168c5bf">next</a>) {
<a name="l01693"></a>01693             <span class="keywordflow">if</span> (extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> == 0)
<a name="l01694"></a>01694                 <span class="keywordflow">continue</span>;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696             <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01697"></a>01697             <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, &amp;extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>, 1, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));
<a name="l01698"></a>01698 
<a name="l01699"></a>01699             <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a35762bd5af161d81db4685c9b6f17868">compression</a>) {
<a name="l01700"></a>01700                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_len = extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a> * <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>];
<a name="l01701"></a>01701                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d3/d9b/pointcache_8c.html#ada50fd4ea8d28a550a8ebc32626d852b">LZO_OUT_LEN</a>(in_len)*4, <span class="stringliteral">&quot;pointcache_lzo_buffer&quot;</span>);
<a name="l01702"></a>01702                 <a class="code" href="../../d3/d9b/pointcache_8c.html#aad4ff78aad87e31caf4ae546e170b6d7">ptcache_file_compressed_write</a>(pf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>), in_len, out, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a35762bd5af161d81db4685c9b6f17868">compression</a>);
<a name="l01703"></a>01703                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(out);
<a name="l01704"></a>01704             }
<a name="l01705"></a>01705             <span class="keywordflow">else</span> {
<a name="l01706"></a>01706                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a7ec3a6ca408a0a0a70b65a4d49088fd8">ptcache_file_write</a>(pf, extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>, extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a5721f1f62572a0c917b242e9d90c3471">totdata</a>, <a class="code" href="../../d3/d9b/pointcache_8c.html#a9ee22492847d9e1d82a8e7df818e6202">ptcache_extra_datasize</a>[extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a004990f648d1650da45b84e9d8449e49">type</a>]);
<a name="l01707"></a>01707             }
<a name="l01708"></a>01708         }
<a name="l01709"></a>01709     }
<a name="l01710"></a>01710 
<a name="l01711"></a>01711     <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l01712"></a>01712     
<a name="l01713"></a>01713     <span class="keywordflow">if</span> (error &amp;&amp; <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01714"></a>01714         printf(<span class="stringliteral">&quot;Error writing to disk cache\n&quot;</span>);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">return</span> error==0;
<a name="l01717"></a>01717 }
<a name="l01718"></a>01718 
<a name="l01719"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a882705446fadd6c98e7eb9158382dccb">01719</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a882705446fadd6c98e7eb9158382dccb">ptcache_read_stream</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra)
<a name="l01720"></a>01720 {
<a name="l01721"></a>01721     <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf = <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a08f62037a9e520e3374ee79d422ef308">PTCACHE_FILE_READ</a>, cfra);
<a name="l01722"></a>01722     <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01725"></a>01725         <span class="keywordflow">return</span> 0;
<a name="l01726"></a>01726 
<a name="l01727"></a>01727     <span class="keywordflow">if</span> (pf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01728"></a>01728         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01729"></a>01729             printf(<span class="stringliteral">&quot;Error opening disk cache file for reading\n&quot;</span>);
<a name="l01730"></a>01730         <span class="keywordflow">return</span> 0;
<a name="l01731"></a>01731     }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#af3d476ef312c4e1d20f7cf57d9b220f9">ptcache_file_header_begin_read</a>(pf))
<a name="l01734"></a>01734         error = 1;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736     <span class="keywordflow">if</span> (!error &amp;&amp; (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> != pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> || !pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>(pf)))
<a name="l01737"></a>01737         error = 1;
<a name="l01738"></a>01738 
<a name="l01739"></a>01739     <span class="keywordflow">if</span> (!error &amp;&amp; pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a> != pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfra))
<a name="l01740"></a>01740         error = 1;
<a name="l01741"></a>01741 
<a name="l01742"></a>01742     <span class="keywordflow">if</span> (!error) {
<a name="l01743"></a>01743         <a class="code" href="../../d3/d9b/pointcache_8c.html#a79d80da2f778e2fb640baca118168188">ptcache_file_pointers_init</a>(pf);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745         <span class="comment">// we have stream reading here</span>
<a name="l01746"></a>01746         <span class="keywordflow">if</span> (!pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>(pf, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>))
<a name="l01747"></a>01747             error = 1;
<a name="l01748"></a>01748     }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750     <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l01751"></a>01751     
<a name="l01752"></a>01752     <span class="keywordflow">return</span> error == 0;
<a name="l01753"></a>01753 }
<a name="l01754"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a310d2cd72407ac1615f71f9ae3e9432f">01754</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a310d2cd72407ac1615f71f9ae3e9432f">ptcache_read</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra)
<a name="l01755"></a>01755 {
<a name="l01756"></a>01756     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01757"></a>01757     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01758"></a>01758     <span class="keywordtype">int</span> *index = &amp;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01759"></a>01759 
<a name="l01760"></a>01760     <span class="comment">/* get a memory cache to read from */</span>
<a name="l01761"></a>01761     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01762"></a>01762         pm = <a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">ptcache_disk_frame_to_mem</a>(pid, cfra);
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764     <span class="keywordflow">else</span> {
<a name="l01765"></a>01765         pm = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01766"></a>01766         
<a name="l01767"></a>01767         <span class="keywordflow">while</span> (pm &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> != cfra)
<a name="l01768"></a>01768             pm = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l01769"></a>01769     }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     <span class="comment">/* read the cache */</span>
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (pm) {
<a name="l01773"></a>01773         <span class="keywordtype">int</span> totpoint = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775         <span class="keywordflow">if</span> ((pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>)) == 0)
<a name="l01776"></a>01776             totpoint = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totpoint, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfra));
<a name="l01777"></a>01777 
<a name="l01778"></a>01778         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(pm);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">for</span> (i=0; i&lt;totpoint; i++) {
<a name="l01781"></a>01781             <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a> &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>))
<a name="l01782"></a>01782                 index = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>];
<a name="l01783"></a>01783 
<a name="l01784"></a>01784             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>(*index, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>, (<span class="keywordtype">float</span>)pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01785"></a>01785         
<a name="l01786"></a>01786             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(pm);
<a name="l01787"></a>01787         }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l01790"></a>01790             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aa6fd6f049e2db0dc83f2ea2cdd1d8cd3">read_extra_data</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm, (<span class="keywordtype">float</span>)pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>);
<a name="l01791"></a>01791 
<a name="l01792"></a>01792         <span class="comment">/* clean up temporary memory cache */</span>
<a name="l01793"></a>01793         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01794"></a>01794             <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l01795"></a>01795             <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l01796"></a>01796             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pm);
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798     }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800     <span class="keywordflow">return</span> 1;
<a name="l01801"></a>01801 }
<a name="l01802"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ace5b4b9773bd2f3495522833a4c5a112">01802</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#ace5b4b9773bd2f3495522833a4c5a112">ptcache_interpolate</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">float</span> cfra, <span class="keywordtype">int</span> cfra1, <span class="keywordtype">int</span> cfra2)
<a name="l01803"></a>01803 {
<a name="l01804"></a>01804     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01805"></a>01805     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01806"></a>01806     <span class="keywordtype">int</span> *index = &amp;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01807"></a>01807 
<a name="l01808"></a>01808     <span class="comment">/* get a memory cache to read from */</span>
<a name="l01809"></a>01809     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01810"></a>01810         pm = <a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">ptcache_disk_frame_to_mem</a>(pid, cfra2);
<a name="l01811"></a>01811     }
<a name="l01812"></a>01812     <span class="keywordflow">else</span> {
<a name="l01813"></a>01813         pm = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01814"></a>01814         
<a name="l01815"></a>01815         <span class="keywordflow">while</span> (pm &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> != cfra2)
<a name="l01816"></a>01816             pm = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l01817"></a>01817     }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819     <span class="comment">/* read the cache */</span>
<a name="l01820"></a>01820     <span class="keywordflow">if</span> (pm) {
<a name="l01821"></a>01821         <span class="keywordtype">int</span> totpoint = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a>;
<a name="l01822"></a>01822 
<a name="l01823"></a>01823         <span class="keywordflow">if</span> ((pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>)) == 0)
<a name="l01824"></a>01824             totpoint = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(totpoint, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, (<span class="keywordtype">int</span>)cfra));
<a name="l01825"></a>01825 
<a name="l01826"></a>01826         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(pm);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828         <span class="keywordflow">for</span> (i=0; i&lt;totpoint; i++) {
<a name="l01829"></a>01829             <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a> &amp; (1&lt;&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>))
<a name="l01830"></a>01830                 index = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>[<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a233d493d95e81af75938a09a34a91d21">BPHYS_DATA_INDEX</a>];
<a name="l01831"></a>01831 
<a name="l01832"></a>01832             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>(*index, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>, cfra, (<span class="keywordtype">float</span>)cfra1, (<span class="keywordtype">float</span>)cfra2, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01833"></a>01833             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(pm);
<a name="l01834"></a>01834         }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l01837"></a>01837             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ae779ef425f1524b7787a61bd8819d3da">interpolate_extra_data</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm, cfra, (<span class="keywordtype">float</span>)cfra1, (<span class="keywordtype">float</span>)cfra2);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839         <span class="comment">/* clean up temporary memory cache */</span>
<a name="l01840"></a>01840         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01841"></a>01841             <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l01842"></a>01842             <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l01843"></a>01843             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pm);
<a name="l01844"></a>01844         }
<a name="l01845"></a>01845     }
<a name="l01846"></a>01846 
<a name="l01847"></a>01847     <span class="keywordflow">return</span> 1;
<a name="l01848"></a>01848 }
<a name="l01849"></a>01849 <span class="comment">/* reads cache from disk or memory */</span>
<a name="l01850"></a>01850 <span class="comment">/* possible to get old or interpolated result */</span>
<a name="l01851"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a707b45e87667b28ce4c28d7af981d015">01851</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a707b45e87667b28ce4c28d7af981d015">BKE_ptcache_read</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">float</span> cfra)
<a name="l01852"></a>01852 {
<a name="l01853"></a>01853     <span class="keywordtype">int</span> cfrai = (int)floor(cfra), cfra1=0, cfra2=0;
<a name="l01854"></a>01854     <span class="keywordtype">int</span> ret = 0;
<a name="l01855"></a>01855 
<a name="l01856"></a>01856     <span class="comment">/* nothing to read to */</span>
<a name="l01857"></a>01857     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfrai) == 0)
<a name="l01858"></a>01858         <span class="keywordflow">return</span> 0;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae07fd09c62174d7b7de0b9af6ce82567">PTCACHE_READ_INFO</a>) {
<a name="l01861"></a>01861         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae07fd09c62174d7b7de0b9af6ce82567">PTCACHE_READ_INFO</a>;
<a name="l01862"></a>01862         <a class="code" href="../../d3/d9b/pointcache_8c.html#a310d2cd72407ac1615f71f9ae3e9432f">ptcache_read</a>(pid, 0);
<a name="l01863"></a>01863     }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <span class="comment">/* first check if we have the actual frame cached */</span>
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (cfra == (<span class="keywordtype">float</span>)cfrai &amp;&amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfrai))
<a name="l01867"></a>01867         cfra1 = cfrai;
<a name="l01868"></a>01868 
<a name="l01869"></a>01869     <span class="comment">/* no exact cache frame found so try to find cached frames around cfra */</span>
<a name="l01870"></a>01870     <span class="keywordflow">if</span> (cfra1 == 0)
<a name="l01871"></a>01871         <a class="code" href="../../d3/d9b/pointcache_8c.html#aa8ffe5139059cffcab2867104c2b3800">ptcache_find_frames_around</a>(pid, cfrai, &amp;cfra1, &amp;cfra2);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="keywordflow">if</span> (cfra1 == 0 &amp;&amp; cfra2 == 0)
<a name="l01874"></a>01874         <span class="keywordflow">return</span> 0;
<a name="l01875"></a>01875 
<a name="l01876"></a>01876     <span class="comment">/* don&#39;t read old cache if already simulated past cached frame */</span>
<a name="l01877"></a>01877     <span class="keywordflow">if</span> (cfra1 == 0 &amp;&amp; cfra2 &amp;&amp; cfra2 &lt;= pid-&gt;cache-&gt;simframe)
<a name="l01878"></a>01878         <span class="keywordflow">return</span> 0;
<a name="l01879"></a>01879     <span class="keywordflow">if</span> (cfra1 &amp;&amp; cfra1 == cfra2)
<a name="l01880"></a>01880         <span class="keywordflow">return</span> 0;
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (cfra1) {
<a name="l01883"></a>01883         
<a name="l01884"></a>01884         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>) {
<a name="l01885"></a>01885             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#a882705446fadd6c98e7eb9158382dccb">ptcache_read_stream</a>(pid, cfra1))
<a name="l01886"></a>01886                 <span class="keywordflow">return</span> 0;
<a name="l01887"></a>01887         }
<a name="l01888"></a>01888         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>)
<a name="l01889"></a>01889             <a class="code" href="../../d3/d9b/pointcache_8c.html#a310d2cd72407ac1615f71f9ae3e9432f">ptcache_read</a>(pid, cfra1);
<a name="l01890"></a>01890     }
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <span class="keywordflow">if</span> (cfra2) {
<a name="l01893"></a>01893         
<a name="l01894"></a>01894         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a83aacfdaf4236decb2162643ba19de08">read_stream</a>) {
<a name="l01895"></a>01895             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9b/pointcache_8c.html#a882705446fadd6c98e7eb9158382dccb">ptcache_read_stream</a>(pid, cfra2))
<a name="l01896"></a>01896                 <span class="keywordflow">return</span> 0;
<a name="l01897"></a>01897         }
<a name="l01898"></a>01898         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a845006f3f84eb4c06926815e73865377">read_point</a>) {
<a name="l01899"></a>01899             <span class="keywordflow">if</span> (cfra1 &amp;&amp; cfra2 &amp;&amp; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a1b54ad5565c00e9d08f2355255557470">interpolate_point</a>)
<a name="l01900"></a>01900                 <a class="code" href="../../d3/d9b/pointcache_8c.html#ace5b4b9773bd2f3495522833a4c5a112">ptcache_interpolate</a>(pid, cfra, cfra1, cfra2);
<a name="l01901"></a>01901             <span class="keywordflow">else</span>
<a name="l01902"></a>01902                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a310d2cd72407ac1615f71f9ae3e9432f">ptcache_read</a>(pid, cfra2);
<a name="l01903"></a>01903         }
<a name="l01904"></a>01904     }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906     <span class="keywordflow">if</span> (cfra1)
<a name="l01907"></a>01907         ret = (cfra2 ? <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a87c0cf2703ad8da6444507a50f1f31b3">PTCACHE_READ_INTERPOLATED</a> : <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af66510109c41fe8841cfef13e1548950">PTCACHE_READ_EXACT</a>);
<a name="l01908"></a>01908     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfra2) {
<a name="l01909"></a>01909         ret = <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aa462ff2d6af45758c0d40956a93c1e37">PTCACHE_READ_OLD</a>;
<a name="l01910"></a>01910         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a> = cfra2;
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     <span class="keywordflow">if</span> ((pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1cf6c69d9867025ed8f85da17c0886a3">PTCACHE_QUICK_CACHE</a>)==0) {
<a name="l01914"></a>01914         cfrai = (int)cfra;
<a name="l01915"></a>01915         <span class="comment">/* clear invalid cache frames so that better stuff can be simulated */</span>
<a name="l01916"></a>01916         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>) {
<a name="l01917"></a>01917             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a>, cfrai);
<a name="l01918"></a>01918         }
<a name="l01919"></a>01919         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>) {
<a name="l01920"></a>01920             <span class="keywordflow">if</span> (cfra &lt;= pid-&gt;cache-&gt;last_exact)
<a name="l01921"></a>01921                 pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a>, <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(cfrai, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>));
<a name="l01924"></a>01924         }
<a name="l01925"></a>01925     }
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     <span class="keywordflow">return</span> ret;
<a name="l01928"></a>01928 }
<a name="l01929"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a605c4dda27e330c25360c5d8bb8ab794">01929</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a605c4dda27e330c25360c5d8bb8ab794">ptcache_write_stream</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra, <span class="keywordtype">int</span> totpoint)
<a name="l01930"></a>01930 {
<a name="l01931"></a>01931     <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *pf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01932"></a>01932     <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01933"></a>01933     
<a name="l01934"></a>01934     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac0b363b56171cca3dc616abe8dc862cf">PTCACHE_CLEAR_FRAME</a>, cfra);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936     pf = <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a37cd01ec7baf117b10662b6a36f3f92d">PTCACHE_FILE_WRITE</a>, cfra);
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="keywordflow">if</span> (pf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01939"></a>01939         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01940"></a>01940             printf(<span class="stringliteral">&quot;Error opening disk cache file for writing\n&quot;</span>);
<a name="l01941"></a>01941         <span class="keywordflow">return</span> 0;
<a name="l01942"></a>01942     }
<a name="l01943"></a>01943 
<a name="l01944"></a>01944     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aea57dd2798e7e989a5076898eb103cc5">data_types</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a>;
<a name="l01945"></a>01945     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a> = totpoint;
<a name="l01946"></a>01946     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>;
<a name="l01947"></a>01947     pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#aab287e7495073e74adcfe7d469682b82">flag</a> = 0;
<a name="l01948"></a>01948 
<a name="l01949"></a>01949     <span class="keywordflow">if</span> (!error &amp;&amp; (!<a class="code" href="../../d3/d9b/pointcache_8c.html#ae62f7d628e8c3c7a1c634ab683fce9ff">ptcache_file_header_begin_write</a>(pf) || !pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a14e45431987b59a60ad537641b0a005e">write_header</a>(pf)))
<a name="l01950"></a>01950         error = 1;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952     <span class="keywordflow">if</span> (!error &amp;&amp; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>)
<a name="l01953"></a>01953         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>(pf, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l01956"></a>01956 
<a name="l01957"></a>01957     <span class="keywordflow">if</span> (error &amp;&amp; <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l01958"></a>01958         printf(<span class="stringliteral">&quot;Error writing to disk cache\n&quot;</span>);
<a name="l01959"></a>01959 
<a name="l01960"></a>01960     <span class="keywordflow">return</span> error == 0;
<a name="l01961"></a>01961 }
<a name="l01962"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a52288220d9386e773df2abc8c0d77ea3">01962</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#a52288220d9386e773df2abc8c0d77ea3">ptcache_write</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra, <span class="keywordtype">int</span> overwrite)
<a name="l01963"></a>01963 {
<a name="l01964"></a>01964     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l01965"></a>01965     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *pm2=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01966"></a>01966     <span class="keywordtype">int</span> totpoint = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfra);
<a name="l01967"></a>01967     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l01968"></a>01968 
<a name="l01969"></a>01969     pm = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a>), <span class="stringliteral">&quot;Pointcache mem&quot;</span>);
<a name="l01970"></a>01970 
<a name="l01971"></a>01971     pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aeddf4801bb286f61979cfc4a757a42fc">totpoint</a> = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a864c3cd08e5fcdc72f50083ef558f506">totwrite</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfra);
<a name="l01972"></a>01972     pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a40aded037f759b90f45e0454c99745d3">data_types</a> = cfra ? pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> : pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a>;
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <a class="code" href="../../d3/d9b/pointcache_8c.html#a4ce7d280bad06f58e1f481d2400a2803">ptcache_data_alloc</a>(pm);
<a name="l01975"></a>01975     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2c3a586f7da8f368acc3dbc4448fdf3d">BKE_ptcache_mem_pointers_init</a>(pm);
<a name="l01976"></a>01976 
<a name="l01977"></a>01977     <span class="keywordflow">if</span> (overwrite) {
<a name="l01978"></a>01978         <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l01979"></a>01979             <span class="keywordtype">int</span> fra = cfra-1;
<a name="l01980"></a>01980 
<a name="l01981"></a>01981             <span class="keywordflow">while</span> (fra &gt;= cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, fra))
<a name="l01982"></a>01982                 fra--;
<a name="l01983"></a>01983             
<a name="l01984"></a>01984             pm2 = <a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">ptcache_disk_frame_to_mem</a>(pid, fra);
<a name="l01985"></a>01985         }
<a name="l01986"></a>01986         <span class="keywordflow">else</span>
<a name="l01987"></a>01987             pm2 = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l01988"></a>01988     }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>) {
<a name="l01991"></a>01991         <span class="keywordflow">for</span> (i=0; i&lt;totpoint; i++) {
<a name="l01992"></a>01992             <span class="keywordtype">int</span> write = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>(i, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a71266096e54b55397104388cedcaad47">cur</a>, cfra);
<a name="l01993"></a>01993             <span class="keywordflow">if</span> (write) {
<a name="l01994"></a>01994                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae0283e69ab731a849376b1dd876ef7ae">BKE_ptcache_mem_pointers_incr</a>(pm);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996                 <span class="comment">/* newly born particles have to be copied to previous cached frame */</span>
<a name="l01997"></a>01997                 <span class="keywordflow">if</span> (overwrite &amp;&amp; write == 2 &amp;&amp; pm2 &amp;&amp; <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5320bb7846b9065b9b65fba21df2748f">BKE_ptcache_mem_pointers_seek</a>(i, pm2))
<a name="l01998"></a>01998                     pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>(i, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm2-&gt;cur, cfra);
<a name="l01999"></a>01999             }
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>)
<a name="l02004"></a>02004         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a28f6f811e043fa9f3e04928d3b297306">write_extra_data</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, pm, cfra);
<a name="l02005"></a>02005 
<a name="l02006"></a>02006     pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> = cfra;
<a name="l02007"></a>02007 
<a name="l02008"></a>02008     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02009"></a>02009         error += !<a class="code" href="../../d3/d9b/pointcache_8c.html#a549b16b47c422de163fd9e516aca28f0">ptcache_mem_frame_to_disk</a>(pid, pm);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011         <span class="comment">// if (pm) /* pm is always set */</span>
<a name="l02012"></a>02012         {
<a name="l02013"></a>02013             <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l02014"></a>02014             <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l02015"></a>02015             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pm);
<a name="l02016"></a>02016         }
<a name="l02017"></a>02017 
<a name="l02018"></a>02018         <span class="keywordflow">if</span> (pm2) {
<a name="l02019"></a>02019             error += !<a class="code" href="../../d3/d9b/pointcache_8c.html#a549b16b47c422de163fd9e516aca28f0">ptcache_mem_frame_to_disk</a>(pid, pm2);
<a name="l02020"></a>02020             <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm2);
<a name="l02021"></a>02021             <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm2);
<a name="l02022"></a>02022             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(pm2);
<a name="l02023"></a>02023         }
<a name="l02024"></a>02024     }
<a name="l02025"></a>02025     <span class="keywordflow">else</span> {
<a name="l02026"></a>02026         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>, pm);
<a name="l02027"></a>02027     }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     <span class="keywordflow">return</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l02030"></a>02030 }
<a name="l02031"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aef916c0e3939f349eadbb1ca34e0ca7a">02031</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#aef916c0e3939f349eadbb1ca34e0ca7a">ptcache_write_needed</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra, <span class="keywordtype">int</span> *overwrite)
<a name="l02032"></a>02032 {
<a name="l02033"></a>02033     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02034"></a>02034     <span class="keywordtype">int</span> ofra = 0, efra = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02035"></a>02035 
<a name="l02036"></a>02036     <span class="comment">/* allways start from scratch on the first frame */</span>
<a name="l02037"></a>02037     <span class="keywordflow">if</span> (cfra &amp;&amp; cfra == cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>) {
<a name="l02038"></a>02038         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, cfra);
<a name="l02039"></a>02039         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>;
<a name="l02040"></a>02040         <span class="keywordflow">return</span> 1;
<a name="l02041"></a>02041     }
<a name="l02042"></a>02042 
<a name="l02043"></a>02043     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02044"></a>02044         <span class="keywordflow">if</span> (cfra==0 &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &gt; 0)
<a name="l02045"></a>02045             <span class="keywordflow">return</span> 1;
<a name="l02046"></a>02046 
<a name="l02047"></a>02047                 <span class="comment">/* find last cached frame */</span>
<a name="l02048"></a>02048         <span class="keywordflow">while</span> (efra &gt; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, efra))
<a name="l02049"></a>02049             efra--;
<a name="l02050"></a>02050 
<a name="l02051"></a>02051         <span class="comment">/* find second last cached frame */</span>
<a name="l02052"></a>02052         ofra = efra-1;
<a name="l02053"></a>02053         <span class="keywordflow">while</span> (ofra &gt; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, ofra))
<a name="l02054"></a>02054             ofra--;
<a name="l02055"></a>02055     }
<a name="l02056"></a>02056     <span class="keywordflow">else</span> {
<a name="l02057"></a>02057         <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l02058"></a>02058         <span class="comment">/* don&#39;t write info file in memory */</span>
<a name="l02059"></a>02059         <span class="keywordflow">if</span> (cfra == 0)
<a name="l02060"></a>02060             <span class="keywordflow">return</span> 0;
<a name="l02061"></a>02061 
<a name="l02062"></a>02062         <span class="keywordflow">if</span> (pm == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02063"></a>02063             <span class="keywordflow">return</span> 1;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065         efra = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>;
<a name="l02066"></a>02066         ofra = (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#ab2413363a7178af9f9e681de442f75f5">prev</a> ? pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#ab2413363a7178af9f9e681de442f75f5">prev</a>-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> : efra - cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a>);
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069     <span class="keywordflow">if</span> (efra &gt;= cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; cfra &gt; efra) {
<a name="l02070"></a>02070         <span class="keywordflow">if</span> (ofra &gt;= cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> &amp;&amp; efra - ofra &lt; cache-&gt;<a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>) {
<a name="l02071"></a>02071             <span class="comment">/* overwrite previous frame */</span>
<a name="l02072"></a>02072             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac0b363b56171cca3dc616abe8dc862cf">PTCACHE_CLEAR_FRAME</a>, efra);
<a name="l02073"></a>02073             *overwrite = 1;
<a name="l02074"></a>02074         }
<a name="l02075"></a>02075         <span class="keywordflow">return</span> 1;
<a name="l02076"></a>02076     }
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     <span class="keywordflow">return</span> 0;
<a name="l02079"></a>02079 }
<a name="l02080"></a>02080 <span class="comment">/* writes cache to disk or memory */</span>
<a name="l02081"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#acc8a26ff863578ec09d0846659b03763">02081</a> <span class="keywordtype">int</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cfra)
<a name="l02082"></a>02082 {
<a name="l02083"></a>02083     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02084"></a>02084     <span class="keywordtype">int</span> totpoint = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, cfra);
<a name="l02085"></a>02085     <span class="keywordtype">int</span> overwrite = 0, <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = 0;
<a name="l02086"></a>02086 
<a name="l02087"></a>02087     <span class="keywordflow">if</span> (totpoint == 0 || (cfra ? pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a26956256c405520c3d7c13f5260a9ca0">data_types</a> == 0 : pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a29ab81cdef352f67d2a686166f5318a8">info_types</a> == 0))
<a name="l02088"></a>02088         <span class="keywordflow">return</span> 0;
<a name="l02089"></a>02089 
<a name="l02090"></a>02090     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9b/pointcache_8c.html#aef916c0e3939f349eadbb1ca34e0ca7a">ptcache_write_needed</a>(pid, cfra, &amp;overwrite)==0)
<a name="l02091"></a>02091         <span class="keywordflow">return</span> 0;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a4132ef9c9a22d7a666496f5de4adf59d">write_stream</a>) {
<a name="l02094"></a>02094         <a class="code" href="../../d3/d9b/pointcache_8c.html#a605c4dda27e330c25360c5d8bb8ab794">ptcache_write_stream</a>(pid, cfra, totpoint);
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#ac0013565eb549d4ff1c77da7fbd60c6d">write_point</a>) {
<a name="l02097"></a>02097         <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> += <a class="code" href="../../d3/d9b/pointcache_8c.html#a52288220d9386e773df2abc8c0d77ea3">ptcache_write</a>(pid, cfra, overwrite);
<a name="l02098"></a>02098     }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100     <span class="comment">/* Mark frames skipped if more than 1 frame forwards since last non-skipped frame. */</span>
<a name="l02101"></a>02101     <span class="keywordflow">if</span> (cfra - cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> == 1 || cfra == cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>) {
<a name="l02102"></a>02102         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> = cfra;
<a name="l02103"></a>02103         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>;
<a name="l02104"></a>02104     }
<a name="l02105"></a>02105     <span class="comment">/* Don&#39;t mark skipped when writing info file (frame 0) */</span>
<a name="l02106"></a>02106     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfra)
<a name="l02107"></a>02107         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>;
<a name="l02108"></a>02108 
<a name="l02109"></a>02109     <span class="comment">/* Update timeline cache display */</span>
<a name="l02110"></a>02110     <span class="keywordflow">if</span> (cfra &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>)
<a name="l02111"></a>02111         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[cfra-cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>] = 1;
<a name="l02112"></a>02112 
<a name="l02113"></a>02113     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a52ac7372c493399b1a564d79d34f50f8">BKE_ptcache_update_info</a>(pid);
<a name="l02114"></a>02114 
<a name="l02115"></a>02115     <span class="keywordflow">return</span> !<a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a>;
<a name="l02116"></a>02116 }
<a name="l02117"></a>02117 <span class="comment">/* youll need to close yourself after!</span>
<a name="l02118"></a>02118 <span class="comment"> * mode - PTCACHE_CLEAR_ALL, </span>
<a name="l02119"></a>02119 <span class="comment"> */</span>
<a name="l02120"></a>02120 
<a name="l02121"></a>02121 <span class="comment">/* Clears &amp; resets */</span>
<a name="l02122"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#abf1a77c761374b3cb8351071c7da68ab">02122</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> mode, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cfra)
<a name="l02123"></a>02123 {
<a name="l02124"></a>02124     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; <span class="comment">/* store the length of the string */</span>
<a name="l02125"></a>02125     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sta, end;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     <span class="comment">/* mode is same as fopen&#39;s modes */</span>
<a name="l02128"></a>02128     <a class="code" href="../../d2/d00/struct__DIR.html">DIR</a> *dir; 
<a name="l02129"></a>02129     <span class="keyword">struct </span><a class="code" href="../../d5/de2/structdirent.html">dirent</a> *de;
<a name="l02130"></a>02130     <span class="keywordtype">char</span> path[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02131"></a>02131     <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l02132"></a>02132     <span class="keywordtype">char</span> path_full[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l02133"></a>02133     <span class="keywordtype">char</span> ext[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <span class="keywordflow">if</span> (!pid || !pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a> || pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)
<a name="l02136"></a>02136         <span class="keywordflow">return</span>;
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#af32abeb205a6835563bdff0761b6d2e1">PTCACHE_IGNORE_CLEAR</a>)
<a name="l02139"></a>02139         <span class="keywordflow">return</span>;
<a name="l02140"></a>02140 
<a name="l02141"></a>02141     sta = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>;
<a name="l02142"></a>02142     end = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 <span class="preprocessor">#ifndef DURIAN_POINTCACHE_LIB_OK</span>
<a name="l02145"></a>02145 <span class="preprocessor"></span>    <span class="comment">/* don&#39;t allow clearing for linked objects */</span>
<a name="l02146"></a>02146     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>)
<a name="l02147"></a>02147         <span class="keywordflow">return</span>;
<a name="l02148"></a>02148 <span class="preprocessor">#endif</span>
<a name="l02149"></a>02149 <span class="preprocessor"></span>
<a name="l02150"></a>02150     <span class="comment">/*if (!G.relbase_valid) return; */</span><span class="comment">/* save blend file before using pointcache */</span>
<a name="l02151"></a>02151     
<a name="l02152"></a>02152     <span class="comment">/* clear all files in the temp dir with the prefix of the ID and the &quot;.bphys&quot; suffix */</span>
<a name="l02153"></a>02153     <span class="keywordflow">switch</span> (mode) {
<a name="l02154"></a>02154     <span class="keywordflow">case</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>:
<a name="l02155"></a>02155     <span class="keywordflow">case</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4983eb030d2659135436b3977f4c695a">PTCACHE_CLEAR_BEFORE</a>:  
<a name="l02156"></a>02156     <span class="keywordflow">case</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a>:
<a name="l02157"></a>02157         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02158"></a>02158             <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(pid, path);
<a name="l02159"></a>02159             
<a name="l02160"></a>02160             len = <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, cfra, 0, 0); <span class="comment">/* no path */</span>
<a name="l02161"></a>02161             
<a name="l02162"></a>02162             dir = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#afa648ff43ec9eba592716a334f243111">opendir</a>(path);
<a name="l02163"></a>02163             <span class="keywordflow">if</span> (dir==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02164"></a>02164                 <span class="keywordflow">return</span>;
<a name="l02165"></a>02165 
<a name="l02166"></a>02166             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(ext, <span class="keyword">sizeof</span>(ext), <span class="stringliteral">&quot;_%02u&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>);
<a name="l02167"></a>02167             
<a name="l02168"></a>02168             <span class="keywordflow">while</span> ((de = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#ae8014c416b1b4c4a966b2deea8f50a9a">readdir</a>(dir)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02169"></a>02169                 <span class="keywordflow">if</span> (strstr(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, ext)) { <span class="comment">/* do we have the right extension?*/</span>
<a name="l02170"></a>02170                     <span class="keywordflow">if</span> (strncmp(filename, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, len ) == 0) { <span class="comment">/* do we have the right prefix */</span>
<a name="l02171"></a>02171                         <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>) {
<a name="l02172"></a>02172                             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, 0);
<a name="l02173"></a>02173                             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(path_full, <span class="keyword">sizeof</span>(path_full), path, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l02174"></a>02174                             <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(path_full, 0, 0);
<a name="l02175"></a>02175                         }
<a name="l02176"></a>02176                         <span class="keywordflow">else</span> {
<a name="l02177"></a>02177                             <span class="comment">/* read the number of the file */</span>
<a name="l02178"></a>02178                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frame, len2 = (int)<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l02179"></a>02179                             <span class="keywordtype">char</span> num[7];
<a name="l02180"></a>02180 
<a name="l02181"></a>02181                             <span class="keywordflow">if</span> (len2 &gt; 15) { <span class="comment">/* could crash if trying to copy a string out of this range*/</span>
<a name="l02182"></a>02182                                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(num, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a> + (<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>) - 15), <span class="keyword">sizeof</span>(num));
<a name="l02183"></a>02183                                 frame = atoi(num);
<a name="l02184"></a>02184                                 
<a name="l02185"></a>02185                                 <span class="keywordflow">if</span> ((mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4983eb030d2659135436b3977f4c695a">PTCACHE_CLEAR_BEFORE</a> &amp;&amp; frame &lt; cfra)    || 
<a name="l02186"></a>02186                                 (mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a> &amp;&amp; frame &gt; cfra) ) {
<a name="l02187"></a>02187                                     
<a name="l02188"></a>02188                                     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(path_full, <span class="keyword">sizeof</span>(path_full), path, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l02189"></a>02189                                     <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(path_full, 0, 0);
<a name="l02190"></a>02190                                     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> &amp;&amp; frame &gt;=sta &amp;&amp; frame &lt;= end)
<a name="l02191"></a>02191                                         pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[frame-sta] = 0;
<a name="l02192"></a>02192                                 }
<a name="l02193"></a>02193                             }
<a name="l02194"></a>02194                         }
<a name="l02195"></a>02195                     }
<a name="l02196"></a>02196                 }
<a name="l02197"></a>02197             }
<a name="l02198"></a>02198             <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f0074f29445f186fbab246d10ddf331">closedir</a>(dir);
<a name="l02199"></a>02199 
<a name="l02200"></a>02200             <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a> &amp;&amp; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>)
<a name="l02201"></a>02201                 memset(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>, 0, <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>));
<a name="l02202"></a>02202         }
<a name="l02203"></a>02203         <span class="keywordflow">else</span> {
<a name="l02204"></a>02204             <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02205"></a>02205             <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#aaa63f127f8b967960d824c4cf6e93ca0">link</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02206"></a>02206 
<a name="l02207"></a>02207             <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>) {
<a name="l02208"></a>02208                 <span class="comment">/*we want startframe if the cache starts before zero*/</span>
<a name="l02209"></a>02209                 pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, 0);
<a name="l02210"></a>02210                 <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l02211"></a>02211                     <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l02212"></a>02212                     <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l02213"></a>02213                 }
<a name="l02214"></a>02214                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>);
<a name="l02215"></a>02215 
<a name="l02216"></a>02216                 <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>) 
<a name="l02217"></a>02217                     memset(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>, 0, <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>));
<a name="l02218"></a>02218             }
<a name="l02219"></a>02219             <span class="keywordflow">else</span> {
<a name="l02220"></a>02220                 <span class="keywordflow">while</span> (pm) {
<a name="l02221"></a>02221                     <span class="keywordflow">if</span> ((mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4983eb030d2659135436b3977f4c695a">PTCACHE_CLEAR_BEFORE</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &lt; cfra)    || 
<a name="l02222"></a>02222                     (mode==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &gt; cfra) ) {
<a name="l02223"></a>02223                         link = pm;
<a name="l02224"></a>02224                         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &gt;=sta &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &lt;= end)
<a name="l02225"></a>02225                             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>-sta] = 0;
<a name="l02226"></a>02226                         <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l02227"></a>02227                         <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l02228"></a>02228                         pm = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l02229"></a>02229                         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>, link);
<a name="l02230"></a>02230                     }
<a name="l02231"></a>02231                     <span class="keywordflow">else</span>
<a name="l02232"></a>02232                         pm = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l02233"></a>02233                 }
<a name="l02234"></a>02234             }
<a name="l02235"></a>02235         }
<a name="l02236"></a>02236         <span class="keywordflow">break</span>;
<a name="l02237"></a>02237         
<a name="l02238"></a>02238     <span class="keywordflow">case</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac0b363b56171cca3dc616abe8dc862cf">PTCACHE_CLEAR_FRAME</a>:
<a name="l02239"></a>02239         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02240"></a>02240             <span class="keywordflow">if</span> (<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfra)) {
<a name="l02241"></a>02241                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, cfra, 1, 1); <span class="comment">/* no path */</span>
<a name="l02242"></a>02242                 <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(filename, 0, 0);
<a name="l02243"></a>02243             }
<a name="l02244"></a>02244         }
<a name="l02245"></a>02245         <span class="keywordflow">else</span> {
<a name="l02246"></a>02246             <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02247"></a>02247 
<a name="l02248"></a>02248             <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l02249"></a>02249                 <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> == cfra) {
<a name="l02250"></a>02250                     <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l02251"></a>02251                     <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l02252"></a>02252                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>, pm);
<a name="l02253"></a>02253                     <span class="keywordflow">break</span>;
<a name="l02254"></a>02254                 }
<a name="l02255"></a>02255             }
<a name="l02256"></a>02256         }
<a name="l02257"></a>02257         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> &amp;&amp; cfra&gt;=sta &amp;&amp; cfra&lt;=end)
<a name="l02258"></a>02258             pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[cfra-sta] = 0;
<a name="l02259"></a>02259         <span class="keywordflow">break</span>;
<a name="l02260"></a>02260     }
<a name="l02261"></a>02261 
<a name="l02262"></a>02262     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a52ac7372c493399b1a564d79d34f50f8">BKE_ptcache_update_info</a>(pid);
<a name="l02263"></a>02263 }
<a name="l02264"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a36fa922e57054a4d171a458e3c6015c7">02264</a> <span class="keywordtype">int</span>  <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> cfra)
<a name="l02265"></a>02265 {
<a name="l02266"></a>02266     <span class="keywordflow">if</span> (!pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>)
<a name="l02267"></a>02267         <span class="keywordflow">return</span> 0;
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     <span class="keywordflow">if</span> (cfra&lt;pid-&gt;cache-&gt;startframe || cfra &gt; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>)
<a name="l02270"></a>02270         <span class="keywordflow">return</span> 0;
<a name="l02271"></a>02271 
<a name="l02272"></a>02272     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> &amp;&amp;    pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[cfra-pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>]==0)
<a name="l02273"></a>02273         <span class="keywordflow">return</span> 0;
<a name="l02274"></a>02274     
<a name="l02275"></a>02275     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02276"></a>02276         <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l02277"></a>02277         
<a name="l02278"></a>02278         <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, cfra, 1, 1);
<a name="l02279"></a>02279 
<a name="l02280"></a>02280         <span class="keywordflow">return</span> <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(filename);
<a name="l02281"></a>02281     }
<a name="l02282"></a>02282     <span class="keywordflow">else</span> {
<a name="l02283"></a>02283         <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02284"></a>02284 
<a name="l02285"></a>02285         <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l02286"></a>02286             <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>==cfra)
<a name="l02287"></a>02287                 <span class="keywordflow">return</span> 1;
<a name="l02288"></a>02288         }
<a name="l02289"></a>02289         <span class="keywordflow">return</span> 0;
<a name="l02290"></a>02290     }
<a name="l02291"></a>02291 }
<a name="l02292"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a6fd2f56dfe1e9c98357a64d004de3ff3">02292</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a3b3321b3ad61b23a9c227a438281ad14">BKE_ptcache_id_time</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">float</span> cfra, <span class="keywordtype">int</span> *startframe, <span class="keywordtype">int</span> *endframe, <span class="keywordtype">float</span> *timescale)
<a name="l02293"></a>02293 {
<a name="l02294"></a>02294     <span class="comment">/* Object *ob; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02295"></a>02295     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache;
<a name="l02296"></a>02296     <span class="comment">/* float offset; unused for now */</span>
<a name="l02297"></a>02297     <span class="keywordtype">float</span> time, nexttime;
<a name="l02298"></a>02298 
<a name="l02299"></a>02299     <span class="comment">/* TODO: this has to be sorted out once bsystem_time gets redone, */</span>
<a name="l02300"></a>02300     <span class="comment">/*       now caches can handle interpolating etc. too - jahka */</span>
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <span class="comment">/* time handling for point cache:</span>
<a name="l02303"></a>02303 <span class="comment">     * - simulation time is scaled by result of bsystem_time</span>
<a name="l02304"></a>02304 <span class="comment">     * - for offsetting time only time offset is taken into account, since</span>
<a name="l02305"></a>02305 <span class="comment">     *   that&#39;s always the same and can&#39;t be animated. a timeoffset which</span>
<a name="l02306"></a>02306 <span class="comment">     *   varies over time is not simpe to support.</span>
<a name="l02307"></a>02307 <span class="comment">     * - field and motion blur offsets are currently ignored, proper solution</span>
<a name="l02308"></a>02308 <span class="comment">     *   is probably to interpolate results from two frames for that ..</span>
<a name="l02309"></a>02309 <span class="comment">     */</span>
<a name="l02310"></a>02310 
<a name="l02311"></a>02311     <span class="comment">/* ob= pid-&gt;ob; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02312"></a>02312     cache= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02313"></a>02313 
<a name="l02314"></a>02314     <span class="keywordflow">if</span> (timescale) {
<a name="l02315"></a>02315         time= <a class="code" href="../../d8/d53/BKE__scene_8h.html#aa1d515c11776decf154b4b1684408586">BKE_curframe</a>(scene);
<a name="l02316"></a>02316         nexttime= <a class="code" href="../../d8/d53/BKE__scene_8h.html#a1e54633ecd61cd6275ecbe94ab341c2f">BKE_frame_to_ctime</a>(scene, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>+1);
<a name="l02317"></a>02317         
<a name="l02318"></a>02318         *timescale= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(nexttime - time, 0.0f);
<a name="l02319"></a>02319     }
<a name="l02320"></a>02320 
<a name="l02321"></a>02321     <span class="keywordflow">if</span> (startframe &amp;&amp; endframe) {
<a name="l02322"></a>02322         *startframe= cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>;
<a name="l02323"></a>02323         *endframe= cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02324"></a>02324 
<a name="l02325"></a>02325         <span class="comment">/* TODO: time handling with object offsets and simulated vs. cached</span>
<a name="l02326"></a>02326 <span class="comment">         * particles isn&#39;t particularly easy, so for now what you see is what</span>
<a name="l02327"></a>02327 <span class="comment">         * you get. In the future point cache could handle the whole particle</span>
<a name="l02328"></a>02328 <span class="comment">         * system timing. */</span>
<a name="l02329"></a>02329 <span class="preprocessor">#if 0</span>
<a name="l02330"></a>02330 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((ob-&gt;partype &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a470d967e3dbbe659e0e9c52f630fe7de">PARSLOW</a>)==0) {
<a name="l02331"></a>02331             offset= ob-&gt;sf;
<a name="l02332"></a>02332 
<a name="l02333"></a>02333             *startframe += (int)(offset+0.5f);
<a name="l02334"></a>02334             *endframe += (int)(offset+0.5f);
<a name="l02335"></a>02335         }
<a name="l02336"></a>02336 <span class="preprocessor">#endif</span>
<a name="l02337"></a>02337 <span class="preprocessor"></span>    }
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     <span class="comment">/* verify cached_frames array is up to date */</span>
<a name="l02340"></a>02340     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>) {
<a name="l02341"></a>02341         <span class="keywordflow">if</span> (<a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>) != <span class="keyword">sizeof</span>(char) * (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>-cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>+1)) {
<a name="l02342"></a>02342             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>);
<a name="l02343"></a>02343             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02344"></a>02344         }   
<a name="l02345"></a>02345     }
<a name="l02346"></a>02346 
<a name="l02347"></a>02347     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a> &gt; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>) {
<a name="l02348"></a>02348         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sta=cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>;
<a name="l02349"></a>02349         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> end=cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02350"></a>02350 
<a name="l02351"></a>02351         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>-cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>+1), <span class="stringliteral">&quot;cached frames array&quot;</span>);
<a name="l02352"></a>02352 
<a name="l02353"></a>02353         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l02354"></a>02354             <span class="comment">/* mode is same as fopen&#39;s modes */</span>
<a name="l02355"></a>02355             <a class="code" href="../../d2/d00/struct__DIR.html">DIR</a> *dir; 
<a name="l02356"></a>02356             <span class="keyword">struct </span><a class="code" href="../../d5/de2/structdirent.html">dirent</a> *de;
<a name="l02357"></a>02357             <span class="keywordtype">char</span> path[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02358"></a>02358             <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l02359"></a>02359             <span class="keywordtype">char</span> ext[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02360"></a>02360             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; <span class="comment">/* store the length of the string */</span>
<a name="l02361"></a>02361 
<a name="l02362"></a>02362             <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(pid, path);
<a name="l02363"></a>02363             
<a name="l02364"></a>02364             len = <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, (<span class="keywordtype">int</span>)cfra, 0, 0); <span class="comment">/* no path */</span>
<a name="l02365"></a>02365             
<a name="l02366"></a>02366             dir = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#afa648ff43ec9eba592716a334f243111">opendir</a>(path);
<a name="l02367"></a>02367             <span class="keywordflow">if</span> (dir==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02368"></a>02368                 <span class="keywordflow">return</span>;
<a name="l02369"></a>02369 
<a name="l02370"></a>02370             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(ext, <span class="keyword">sizeof</span>(ext), <span class="stringliteral">&quot;_%02u&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>);
<a name="l02371"></a>02371             
<a name="l02372"></a>02372             <span class="keywordflow">while</span> ((de = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#ae8014c416b1b4c4a966b2deea8f50a9a">readdir</a>(dir)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02373"></a>02373                 <span class="keywordflow">if</span> (strstr(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, ext)) { <span class="comment">/* do we have the right extension?*/</span>
<a name="l02374"></a>02374                     <span class="keywordflow">if</span> (strncmp(filename, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, len ) == 0) { <span class="comment">/* do we have the right prefix */</span>
<a name="l02375"></a>02375                         <span class="comment">/* read the number of the file */</span>
<a name="l02376"></a>02376                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frame, len2 = (int)<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l02377"></a>02377                         <span class="keywordtype">char</span> num[7];
<a name="l02378"></a>02378 
<a name="l02379"></a>02379                         <span class="keywordflow">if</span> (len2 &gt; 15) { <span class="comment">/* could crash if trying to copy a string out of this range*/</span>
<a name="l02380"></a>02380                             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(num, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a> + (<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>) - 15), <span class="keyword">sizeof</span>(num));
<a name="l02381"></a>02381                             frame = atoi(num);
<a name="l02382"></a>02382                             
<a name="l02383"></a>02383                             <span class="keywordflow">if</span> (frame &gt;= sta &amp;&amp; frame &lt;= end)
<a name="l02384"></a>02384                                 cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[frame-sta] = 1;
<a name="l02385"></a>02385                         }
<a name="l02386"></a>02386                     }
<a name="l02387"></a>02387                 }
<a name="l02388"></a>02388             }
<a name="l02389"></a>02389             <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f0074f29445f186fbab246d10ddf331">closedir</a>(dir);
<a name="l02390"></a>02390         }
<a name="l02391"></a>02391         <span class="keywordflow">else</span> {
<a name="l02392"></a>02392             <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02393"></a>02393 
<a name="l02394"></a>02394             <span class="keywordflow">while</span> (pm) {
<a name="l02395"></a>02395                 <span class="keywordflow">if</span> (pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &gt;= sta &amp;&amp; pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a> &lt;= end)
<a name="l02396"></a>02396                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>[pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a455582a98c0d975788300b80386dc47c">frame</a>-sta] = 1;
<a name="l02397"></a>02397                 pm = pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>;
<a name="l02398"></a>02398             }
<a name="l02399"></a>02399         }
<a name="l02400"></a>02400     }
<a name="l02401"></a>02401 }
<a name="l02402"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ad1fd6e2a9dbc7a1b6e685f8d5d85ac18">02402</a> <span class="keywordtype">int</span>  <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keywordtype">int</span> mode)
<a name="l02403"></a>02403 {
<a name="l02404"></a>02404     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache;
<a name="l02405"></a>02405     <span class="keywordtype">int</span> reset, <a class="code" href="../../d1/d79/btDbvtBroadphase_8cpp.html#a19b1dda96df6332570b535a0683d8076">clear</a>, after;
<a name="l02406"></a>02406 
<a name="l02407"></a>02407     <span class="keywordflow">if</span> (!pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>)
<a name="l02408"></a>02408         <span class="keywordflow">return</span> 0;
<a name="l02409"></a>02409 
<a name="l02410"></a>02410     cache= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02411"></a>02411     reset= 0;
<a name="l02412"></a>02412     clear= 0;
<a name="l02413"></a>02413     after= 0;
<a name="l02414"></a>02414 
<a name="l02415"></a>02415     <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aef800351abca5f08a0d90a742a46bce8">PTCACHE_RESET_DEPSGRAPH</a>) {
<a name="l02416"></a>02416         <span class="keywordflow">if</span> (!(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>) &amp;&amp; !<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a34764119fdcd6197dceb78b4181e6e3b">BKE_ptcache_get_continue_physics</a>()) {
<a name="l02417"></a>02417             <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1cf6c69d9867025ed8f85da17c0886a3">PTCACHE_QUICK_CACHE</a>)
<a name="l02418"></a>02418                 clear= 1;
<a name="l02419"></a>02419 
<a name="l02420"></a>02420             after= 1;
<a name="l02421"></a>02421         }
<a name="l02422"></a>02422 
<a name="l02423"></a>02423         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>;
<a name="l02424"></a>02424     }
<a name="l02425"></a>02425     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af6103892f190161492cd76c84ab88452">PTCACHE_RESET_BAKED</a>) {
<a name="l02426"></a>02426         <span class="keywordflow">if</span> (!<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a34764119fdcd6197dceb78b4181e6e3b">BKE_ptcache_get_continue_physics</a>()) {
<a name="l02427"></a>02427             reset= 1;
<a name="l02428"></a>02428             clear= 1;
<a name="l02429"></a>02429         }
<a name="l02430"></a>02430         <span class="keywordflow">else</span>
<a name="l02431"></a>02431             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>;
<a name="l02432"></a>02432     }
<a name="l02433"></a>02433     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0da786e671a578f5467e04bcfdb99e4">PTCACHE_RESET_OUTDATED</a>) {
<a name="l02434"></a>02434         reset = 1;
<a name="l02435"></a>02435 
<a name="l02436"></a>02436         <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a> &amp;&amp; !(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)) {
<a name="l02437"></a>02437             clear= 1;
<a name="l02438"></a>02438             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>;
<a name="l02439"></a>02439         }
<a name="l02440"></a>02440     }
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     <span class="keywordflow">if</span> (reset) {
<a name="l02443"></a>02443         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(cache);
<a name="l02444"></a>02444         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>;
<a name="l02445"></a>02445 
<a name="l02446"></a>02446         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a64019fd6972f164398f3b2f022fd9e74">PTCACHE_TYPE_CLOTH</a>)
<a name="l02447"></a>02447             <a class="code" href="../../d4/d17/BKE__cloth_8h.html#a252b1bd957943fc2193f26d6893971f4">cloth_free_modifier</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l02448"></a>02448         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a8f896983be158775838cbf7fc1ffa45d">PTCACHE_TYPE_SOFTBODY</a>)
<a name="l02449"></a>02449             <a class="code" href="../../d6/df9/BKE__softbody_8h.html#aa5b390987e39edfd5bd9269e9a1e5dd1">sbFreeSimulation</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l02450"></a>02450         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a>)
<a name="l02451"></a>02451             <a class="code" href="../../db/dca/BKE__particle_8h.html#a686244657da3b6f9c17f52070e5cd4b4">psys_reset</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, <a class="code" href="../../db/dca/BKE__particle_8h.html#ad7b0cdc78a3e750210512f0bd4837845">PSYS_RESET_DEPSGRAPH</a>);
<a name="l02452"></a>02452         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a>)
<a name="l02453"></a>02453             <a class="code" href="../../da/d58/BKE__smoke_8h.html#a071c6213082d00251be436f737625413">smokeModifier_reset</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l02454"></a>02454         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a0c912d9f57d48eefd6a3677cacef9d85">PTCACHE_TYPE_SMOKE_HIGHRES</a>)
<a name="l02455"></a>02455             <a class="code" href="../../da/d58/BKE__smoke_8h.html#a6df94a0a5e4e7ff7a9b1cf1c35e2a6c1">smokeModifier_reset_turbulence</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l02456"></a>02456         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a69d1f6145b8e33c34e843239d567d781">PTCACHE_TYPE_DYNAMICPAINT</a>)
<a name="l02457"></a>02457             <a class="code" href="../../d0/db4/BKE__dynamicpaint_8h.html#a902ce84caf056a4d140be06a4cf3f6cd">dynamicPaint_clearSurface</a>((<a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a>*)pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>);
<a name="l02458"></a>02458     }
<a name="l02459"></a>02459     <span class="keywordflow">if</span> (clear)
<a name="l02460"></a>02460         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l02461"></a>02461     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (after)
<a name="l02462"></a>02462         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a4d645ff4e13576c2c6681b2902c0fb5e">PTCACHE_CLEAR_AFTER</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l02463"></a>02463 
<a name="l02464"></a>02464     <span class="keywordflow">return</span> (reset || clear || after);
<a name="l02465"></a>02465 }
<a name="l02466"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af69cd352f2f904ab73e48bcbb38357c8">02466</a> <span class="keywordtype">int</span>  <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad1036d5ae255fe62240ecef0e2a24a85">BKE_ptcache_object_reset</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> mode)
<a name="l02467"></a>02467 {
<a name="l02468"></a>02468     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> pid;
<a name="l02469"></a>02469     <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l02470"></a>02470     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l02471"></a>02471     <span class="keywordtype">int</span> reset, skip;
<a name="l02472"></a>02472 
<a name="l02473"></a>02473     reset= 0;
<a name="l02474"></a>02474     skip= 0;
<a name="l02475"></a>02475 
<a name="l02476"></a>02476     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>) {
<a name="l02477"></a>02477         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a77c23b980ef3e6c4f755966321bbe2e4">BKE_ptcache_id_from_softbody</a>(&amp;pid, ob, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a65de819e902d20e3001de9ef8cad19df">soft</a>);
<a name="l02478"></a>02478         reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02479"></a>02479     }
<a name="l02480"></a>02480 
<a name="l02481"></a>02481     <span class="keywordflow">for</span> (psys=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys=psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l02482"></a>02482         <span class="comment">/* children or just redo can be calculated without reseting anything */</span>
<a name="l02483"></a>02483         <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a5547f2bd9a8035cc2e57bb0ede233551">PSYS_RECALC_REDO</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> &amp; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a682502f586515a24a8148c421db2877b">PSYS_RECALC_CHILD</a>)
<a name="l02484"></a>02484             skip = 1;
<a name="l02485"></a>02485         <span class="comment">/* Baked cloth hair has to be checked too, because we don&#39;t want to reset */</span>
<a name="l02486"></a>02486         <span class="comment">/* particles or cloth in that case -jahka */</span>
<a name="l02487"></a>02487         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>) {
<a name="l02488"></a>02488             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac096044fef336c86e9eb09373c7c5dcd">BKE_ptcache_id_from_cloth</a>(&amp;pid, ob, psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a85b96c63e4672af0fa100b6d8fda9269">clmd</a>);
<a name="l02489"></a>02489             <span class="keywordflow">if</span> (mode == <a class="code" href="../../db/dca/BKE__particle_8h.html#aac0cee343bc36395e4bec4851c8f0ab3">PSYS_RESET_ALL</a> || !(psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> &amp;&amp; (pid.<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>))) 
<a name="l02490"></a>02490                 reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02491"></a>02491             <span class="keywordflow">else</span>
<a name="l02492"></a>02492                 skip = 1;
<a name="l02493"></a>02493         }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495         <span class="keywordflow">if</span> (skip == 0 &amp;&amp; psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>) {
<a name="l02496"></a>02496             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a50a8b29292a42f97f908d8de8b3acc67">BKE_ptcache_id_from_particles</a>(&amp;pid, ob, psys);
<a name="l02497"></a>02497             reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02498"></a>02498         }
<a name="l02499"></a>02499     }
<a name="l02500"></a>02500 
<a name="l02501"></a>02501     <span class="keywordflow">for</span> (md=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; md; md=md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l02502"></a>02502         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a5fc484f055c7aba4c89beda85b5ba321">eModifierType_Cloth</a>) {
<a name="l02503"></a>02503             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ac096044fef336c86e9eb09373c7c5dcd">BKE_ptcache_id_from_cloth</a>(&amp;pid, ob, (<a class="code" href="../../d5/d06/structClothModifierData.html">ClothModifierData</a>*)md);
<a name="l02504"></a>02504             reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02505"></a>02505         }
<a name="l02506"></a>02506         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435a7a78843e9dd6590fafc9b7682e691ac5">eModifierType_Smoke</a>) {
<a name="l02507"></a>02507             <a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *smd = (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a> *)md;
<a name="l02508"></a>02508             <span class="keywordflow">if</span> (smd-&gt;<a class="code" href="../../d5/d03/structSmokeModifierData.html#a43b5e848c1b44a089bd6d4461b0d2b1f">type</a> &amp; <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a88bed02ad1eb599ef628931fc9ab7973">MOD_SMOKE_TYPE_DOMAIN</a>)
<a name="l02509"></a>02509             {
<a name="l02510"></a>02510                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a139c5c89f9fbf148ec330a232fb306a6">BKE_ptcache_id_from_smoke</a>(&amp;pid, ob, (<a class="code" href="../../d5/d03/structSmokeModifierData.html">SmokeModifierData</a>*)md);
<a name="l02511"></a>02511                 reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02512"></a>02512             }
<a name="l02513"></a>02513         }
<a name="l02514"></a>02514         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435abf6c2369ea1f5b0cab992eb27906823c">eModifierType_DynamicPaint</a>) {
<a name="l02515"></a>02515             <a class="code" href="../../de/d70/structDynamicPaintModifierData.html">DynamicPaintModifierData</a> *pmd = (<a class="code" href="../../de/d70/structDynamicPaintModifierData.html">DynamicPaintModifierData</a> *)md;
<a name="l02516"></a>02516             <span class="keywordflow">if</span> (pmd-&gt;<a class="code" href="../../de/d70/structDynamicPaintModifierData.html#a7f52b6a38d830d37a65adb2485555e6f">canvas</a>)
<a name="l02517"></a>02517             {
<a name="l02518"></a>02518                 <a class="code" href="../../dc/d46/structDynamicPaintSurface.html">DynamicPaintSurface</a> *surface = pmd-&gt;<a class="code" href="../../de/d70/structDynamicPaintModifierData.html#a7f52b6a38d830d37a65adb2485555e6f">canvas</a>-&gt;<a class="code" href="../../dd/d1c/structDynamicPaintCanvasSettings.html#ad228b42281d1a30b3a1471918032d6a5">surfaces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02519"></a>02519 
<a name="l02520"></a>02520                 <span class="keywordflow">for</span> (; surface; surface=surface-&gt;<a class="code" href="../../dc/d46/structDynamicPaintSurface.html#a844dd16f25eea3afb63262bf54937b05">next</a>) {
<a name="l02521"></a>02521                     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a65216ebe614f6e108d88b059a1bec408">BKE_ptcache_id_from_dynamicpaint</a>(&amp;pid, ob, surface);
<a name="l02522"></a>02522                     reset |= <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a936238355aa375c37d9e8fc633ea5f39">BKE_ptcache_id_reset</a>(scene, &amp;pid, mode);
<a name="l02523"></a>02523                 }
<a name="l02524"></a>02524             }
<a name="l02525"></a>02525         }
<a name="l02526"></a>02526     }
<a name="l02527"></a>02527 
<a name="l02528"></a>02528     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a17c162dffb7fd4f0acb11d051374609b">OB_ARMATURE</a>)
<a name="l02529"></a>02529         <a class="code" href="../../d8/dd6/BIK__api_8h.html#a13b73ec44c855cf0d6ead1bf0d9bd413">BIK_clear_cache</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531     <span class="keywordflow">return</span> reset;
<a name="l02532"></a>02532 }
<a name="l02533"></a>02533 
<a name="l02534"></a>02534 <span class="comment">/* Use this when quitting blender, with unsaved files */</span>
<a name="l02535"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a8d59a0eae0930aa505d4b48085d7c9d6">02535</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a8d59a0eae0930aa505d4b48085d7c9d6">BKE_ptcache_remove</a>(<span class="keywordtype">void</span>)
<a name="l02536"></a>02536 {
<a name="l02537"></a>02537     <span class="keywordtype">char</span> path[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02538"></a>02538     <span class="keywordtype">char</span> path_full[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l02539"></a>02539     <span class="keywordtype">int</span> rmdir = 1;
<a name="l02540"></a>02540     
<a name="l02541"></a>02541     <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, path);
<a name="l02542"></a>02542 
<a name="l02543"></a>02543     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(path)) {
<a name="l02544"></a>02544         <span class="comment">/* The pointcache dir exists? - remove all pointcache */</span>
<a name="l02545"></a>02545 
<a name="l02546"></a>02546         <a class="code" href="../../d2/d00/struct__DIR.html">DIR</a> *dir; 
<a name="l02547"></a>02547         <span class="keyword">struct </span><a class="code" href="../../d5/de2/structdirent.html">dirent</a> *de;
<a name="l02548"></a>02548 
<a name="l02549"></a>02549         dir = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#afa648ff43ec9eba592716a334f243111">opendir</a>(path);
<a name="l02550"></a>02550         <span class="keywordflow">if</span> (dir==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02551"></a>02551             <span class="keywordflow">return</span>;
<a name="l02552"></a>02552         
<a name="l02553"></a>02553         <span class="keywordflow">while</span> ((de = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#ae8014c416b1b4c4a966b2deea8f50a9a">readdir</a>(dir)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02554"></a>02554             <span class="keywordflow">if</span> ( strcmp(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, <span class="stringliteral">&quot;.&quot;</span>)==0 || strcmp(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, <span class="stringliteral">&quot;..&quot;</span>)==0) {
<a name="l02555"></a>02555                 <span class="comment">/* do nothing */</span>
<a name="l02556"></a>02556             }
<a name="l02557"></a>02557             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>)) { <span class="comment">/* do we have the right extension?*/</span>
<a name="l02558"></a>02558                 <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(path_full, <span class="keyword">sizeof</span>(path_full), path, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l02559"></a>02559                 <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(path_full, 0, 0);
<a name="l02560"></a>02560             }
<a name="l02561"></a>02561             <span class="keywordflow">else</span> {
<a name="l02562"></a>02562                 rmdir = 0; <span class="comment">/* unknown file, don&#39;t remove the dir */</span>
<a name="l02563"></a>02563             }
<a name="l02564"></a>02564         }
<a name="l02565"></a>02565 
<a name="l02566"></a>02566         <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f0074f29445f186fbab246d10ddf331">closedir</a>(dir);
<a name="l02567"></a>02567     }
<a name="l02568"></a>02568     <span class="keywordflow">else</span> {
<a name="l02569"></a>02569         rmdir = 0; <span class="comment">/* path dosnt exist  */</span>
<a name="l02570"></a>02570     }
<a name="l02571"></a>02571     
<a name="l02572"></a>02572     <span class="keywordflow">if</span> (rmdir) {
<a name="l02573"></a>02573         <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a732fc591374d736271bdaad0ff555432">BLI_delete</a>(path, 1, 0);
<a name="l02574"></a>02574     }
<a name="l02575"></a>02575 }
<a name="l02576"></a>02576 
<a name="l02577"></a>02577 <span class="comment">/* Continuous Interaction */</span>
<a name="l02578"></a>02578 
<a name="l02579"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#abc7d7b017c8ff80750f62c81cd896dbf">02579</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#abc7d7b017c8ff80750f62c81cd896dbf">CONTINUE_PHYSICS</a> = 0;
<a name="l02580"></a>02580 
<a name="l02581"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a4b0cb64e3af6ed1d1a4b22eeedec418a">02581</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a72817e21bd005c7cd3a70e43342a096c">BKE_ptcache_set_continue_physics</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <span class="keywordtype">int</span> enable)
<a name="l02582"></a>02582 {
<a name="l02583"></a>02583     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l02584"></a>02584 
<a name="l02585"></a>02585     <span class="keywordflow">if</span> (CONTINUE_PHYSICS != enable) {
<a name="l02586"></a>02586         CONTINUE_PHYSICS = enable;
<a name="l02587"></a>02587 
<a name="l02588"></a>02588         <span class="keywordflow">if</span> (CONTINUE_PHYSICS == 0) {
<a name="l02589"></a>02589             <span class="keywordflow">for</span> (ob=bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#ac9c12335b530e1b3f1717bb9cbc269a4">object</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ob; ob=ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l02590"></a>02590                 <span class="keywordflow">if</span> (<a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad1036d5ae255fe62240ecef0e2a24a85">BKE_ptcache_object_reset</a>(scene, ob, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0da786e671a578f5467e04bcfdb99e4">PTCACHE_RESET_OUTDATED</a>))
<a name="l02591"></a>02591                     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l02592"></a>02592         }
<a name="l02593"></a>02593     }
<a name="l02594"></a>02594 }
<a name="l02595"></a>02595 
<a name="l02596"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a34764119fdcd6197dceb78b4181e6e3b">02596</a> <span class="keywordtype">int</span>  <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a34764119fdcd6197dceb78b4181e6e3b">BKE_ptcache_get_continue_physics</a>(<span class="keywordtype">void</span>)
<a name="l02597"></a>02597 {
<a name="l02598"></a>02598     <span class="keywordflow">return</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#abc7d7b017c8ff80750f62c81cd896dbf">CONTINUE_PHYSICS</a>;
<a name="l02599"></a>02599 }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 <span class="comment">/* Point Cache handling */</span>
<a name="l02602"></a>02602 
<a name="l02603"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a4be5eb76e3856b2ee1bb2fc3817c5451">02603</a> <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *<a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaa30cc8980cfa020b23b61066cda11e1">BKE_ptcache_add</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ptcaches)
<a name="l02604"></a>02604 {
<a name="l02605"></a>02605     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache;
<a name="l02606"></a>02606 
<a name="l02607"></a>02607     cache= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d83/structPointCache.html">PointCache</a>), <span class="stringliteral">&quot;PointCache&quot;</span>);
<a name="l02608"></a>02608     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>= 1;
<a name="l02609"></a>02609     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>= 250;
<a name="l02610"></a>02610     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a45c02298ee93df755a2f14ce5c8e5173">step</a>= 10;
<a name="l02611"></a>02611     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a> = -1;
<a name="l02612"></a>02612 
<a name="l02613"></a>02613     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(ptcaches, cache);
<a name="l02614"></a>02614 
<a name="l02615"></a>02615     <span class="keywordflow">return</span> cache;
<a name="l02616"></a>02616 }
<a name="l02617"></a>02617 
<a name="l02618"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a7efd72309a351bd8a938e376b40e031d">02618</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a21cc23638085a6c85ca20cf220b50754">BKE_ptcache_free_mem</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *mem_cache)
<a name="l02619"></a>02619 {
<a name="l02620"></a>02620     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = mem_cache-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02621"></a>02621 
<a name="l02622"></a>02622     <span class="keywordflow">if</span> (pm) {
<a name="l02623"></a>02623         <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l02624"></a>02624             <a class="code" href="../../d3/d9b/pointcache_8c.html#af34dd3c835b175e67ab82691d9f7886a">ptcache_data_free</a>(pm);
<a name="l02625"></a>02625             <a class="code" href="../../d3/d9b/pointcache_8c.html#af4db2c40068792e84926a1c95fbfd34e">ptcache_extra_free</a>(pm);
<a name="l02626"></a>02626         }
<a name="l02627"></a>02627 
<a name="l02628"></a>02628         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(mem_cache);
<a name="l02629"></a>02629     }
<a name="l02630"></a>02630 }
<a name="l02631"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#abcb024369116bd74b1e53f5902fdf25b">02631</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae3d00074bc7b55061792e424ef6240fe">BKE_ptcache_free</a>(<a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache)
<a name="l02632"></a>02632 {
<a name="l02633"></a>02633     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a21cc23638085a6c85ca20cf220b50754">BKE_ptcache_free_mem</a>(&amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>);
<a name="l02634"></a>02634     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad08fe08bc70d9877272ff6cdd8437e32">edit</a> &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a44149b9445cd4008c57a7573c852b24b">free_edit</a>)
<a name="l02635"></a>02635         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a44149b9445cd4008c57a7573c852b24b">free_edit</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad08fe08bc70d9877272ff6cdd8437e32">edit</a>);
<a name="l02636"></a>02636     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>)
<a name="l02637"></a>02637         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>);
<a name="l02638"></a>02638     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache);
<a name="l02639"></a>02639 }
<a name="l02640"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a871076a0cab29a2ca2d86744a0cd70ad">02640</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acd668a903f7dc38eabb18e0c44677c0d">BKE_ptcache_free_list</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ptcaches)
<a name="l02641"></a>02641 {
<a name="l02642"></a>02642     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = ptcaches-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02643"></a>02643 
<a name="l02644"></a>02644     <span class="keywordflow">while</span> (cache) {
<a name="l02645"></a>02645         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(ptcaches, cache);
<a name="l02646"></a>02646         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ae3d00074bc7b55061792e424ef6240fe">BKE_ptcache_free</a>(cache);
<a name="l02647"></a>02647         cache = ptcaches-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02648"></a>02648     }
<a name="l02649"></a>02649 }
<a name="l02650"></a>02650 
<a name="l02651"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aa3bc7fe5dc5baf7c438461b6c4663f7d">02651</a> <span class="keyword">static</span> <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *<a class="code" href="../../d3/d9b/pointcache_8c.html#aa3bc7fe5dc5baf7c438461b6c4663f7d">ptcache_copy</a>(<a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache)
<a name="l02652"></a>02652 {
<a name="l02653"></a>02653     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *ncache;
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     ncache= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(cache);
<a name="l02656"></a>02656 
<a name="l02657"></a>02657     <span class="comment">/* hmm, should these be copied over instead? */</span>
<a name="l02658"></a>02658     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02659"></a>02659     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02660"></a>02660     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02661"></a>02661     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad08fe08bc70d9877272ff6cdd8437e32">edit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02662"></a>02662 
<a name="l02663"></a>02663     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a>= 0;
<a name="l02664"></a>02664     ncache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a>= 0;
<a name="l02665"></a>02665 
<a name="l02666"></a>02666     <span class="keywordflow">return</span> ncache;
<a name="l02667"></a>02667 }
<a name="l02668"></a>02668 <span class="comment">/* returns first point cache */</span>
<a name="l02669"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ae6500c45f087fec0a8310674013b8deb">02669</a> <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a96054e98212303d017403e0d8edefcc7">BKE_ptcache_copy_list</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ptcaches_new, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ptcaches_old)
<a name="l02670"></a>02670 {
<a name="l02671"></a>02671     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = ptcaches_old-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02672"></a>02672 
<a name="l02673"></a>02673     ptcaches_new-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = ptcaches_new-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02674"></a>02674 
<a name="l02675"></a>02675     <span class="keywordflow">for</span> (; cache; cache=cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a3689f725d54309e1b00a3b06ac0561a5">next</a>)
<a name="l02676"></a>02676         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(ptcaches_new, <a class="code" href="../../d3/d9b/pointcache_8c.html#aa3bc7fe5dc5baf7c438461b6c4663f7d">ptcache_copy</a>(cache));
<a name="l02677"></a>02677 
<a name="l02678"></a>02678     <span class="keywordflow">return</span> ptcaches_new-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l02679"></a>02679 }
<a name="l02680"></a>02680 
<a name="l02681"></a>02681 
<a name="l02682"></a>02682 <span class="comment">/* Baking */</span>
<a name="l02683"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#adf5d8822ff8f0d73f1f846c021efd058">02683</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a1e3e742d9a6cead7514f01fab86f5a84">BKE_ptcache_quick_cache_all</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l02684"></a>02684 {
<a name="l02685"></a>02685     <a class="code" href="../../d9/d6b/structPTCacheBaker.html">PTCacheBaker</a> baker;
<a name="l02686"></a>02686 
<a name="l02687"></a>02687     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a58489ca94bbb295a57f0ca53ce031e5c">bake</a>=0;
<a name="l02688"></a>02688     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a9cf24fabd3bda859b62d26b98d6ee8e2">break_data</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02689"></a>02689     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a9db9f3b0bbc19158af96cd29df27a764">break_test</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02690"></a>02690     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a3aa890b37235e0ddb7e018cb8ff566c0">pid</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02691"></a>02691     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a3b023e4c0d2daa876dcafbb2ffd7eb12">progressbar</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02692"></a>02692     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a2e10687e95878225411ce4f8e0f6a421">progressend</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02693"></a>02693     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a157abde889c4b9fb3cfbbb1d8353aaf9">progresscontext</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02694"></a>02694     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a622e19eac9524a988d93e3203a1a2fad">render</a>=0;
<a name="l02695"></a>02695     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ade056e7fe55446bad74c723242ff3722">anim_init</a> = 0;
<a name="l02696"></a>02696     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ab0e3fabfa956f3574373790136c0807f">main</a>=bmain;
<a name="l02697"></a>02697     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a7204330a7a032569b9bcfaa41e4db16e">scene</a>=scene;
<a name="l02698"></a>02698     baker.<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ae9f29b4adce403c413c7bfa97d3bf680">quick_step</a>=scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a2af54e63511dbe75e7b3c736288ed4d4">physics_settings</a>.<a class="code" href="../../d6/d40/structPhysicsSettings.html#a616231d82a7300eb96690c86d6141bb3">quick_cache_step</a>;
<a name="l02699"></a>02699 
<a name="l02700"></a>02700     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5dd02bd1a766237a56e6331a24cd4964">BKE_ptcache_bake</a>(&amp;baker);
<a name="l02701"></a>02701 }
<a name="l02702"></a>02702 
<a name="l02703"></a>02703 <span class="comment">/* Simulation thread, no need for interlocks as data written in both threads</span>
<a name="l02704"></a>02704 <span class="comment"> * are only unitary integers (I/O assumed to be atomic for them) */</span>
<a name="l02705"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html">02705</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l02706"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">02706</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">break_operation</a>;
<a name="l02707"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#a60451dcd92e27ad207fcd3f4e4374abc">02707</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/dd6/structptcache__bake__data.html#a60451dcd92e27ad207fcd3f4e4374abc">thread_ended</a>;
<a name="l02708"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">02708</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>;
<a name="l02709"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">02709</a>     <span class="keywordtype">int</span> <a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">step</a>;
<a name="l02710"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">02710</a>     <span class="keywordtype">int</span> *<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>;
<a name="l02711"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac64879911c2334fc750201d265d59500">02711</a>     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac64879911c2334fc750201d265d59500">main</a>;
<a name="l02712"></a><a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4fbbb9247752194af45a6adf91b048e2">02712</a>     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4fbbb9247752194af45a6adf91b048e2">scene</a>;
<a name="l02713"></a>02713 } <a class="code" href="../../dc/dd6/structptcache__bake__data.html">ptcache_bake_data</a>;
<a name="l02714"></a>02714 
<a name="l02715"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">02715</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">ptcache_dt_to_str</a>(<span class="keywordtype">char</span> *<a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>, <span class="keywordtype">double</span> dtime)
<a name="l02716"></a>02716 {
<a name="l02717"></a>02717     <span class="keywordflow">if</span> (dtime &gt; 60.0) {
<a name="l02718"></a>02718         <span class="keywordflow">if</span> (dtime &gt; 3600.0)
<a name="l02719"></a>02719             sprintf(str, <span class="stringliteral">&quot;%ih %im %is&quot;</span>, (<span class="keywordtype">int</span>)(dtime/3600), ((<span class="keywordtype">int</span>)(dtime/60))%60, ((<span class="keywordtype">int</span>)dtime) % 60);
<a name="l02720"></a>02720         <span class="keywordflow">else</span>
<a name="l02721"></a>02721             sprintf(str, <span class="stringliteral">&quot;%im %is&quot;</span>, ((<span class="keywordtype">int</span>)(dtime/60))%60, ((<span class="keywordtype">int</span>)dtime) % 60);
<a name="l02722"></a>02722     }
<a name="l02723"></a>02723     <span class="keywordflow">else</span>
<a name="l02724"></a>02724         sprintf(str, <span class="stringliteral">&quot;%is&quot;</span>, ((<span class="keywordtype">int</span>)dtime) % 60);
<a name="l02725"></a>02725 }
<a name="l02726"></a>02726 
<a name="l02727"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#abae7653399fe5a47a9b97f941cb41b6e">02727</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../d3/d9b/pointcache_8c.html#abae7653399fe5a47a9b97f941cb41b6e">ptcache_bake_thread</a>(<span class="keywordtype">void</span> *ptr)
<a name="l02728"></a>02728 {
<a name="l02729"></a>02729     <span class="keywordtype">int</span> usetimer = 0, sfra, efra;
<a name="l02730"></a>02730     <span class="keywordtype">double</span> stime, ptime, ctime, fetd;
<a name="l02731"></a>02731     <span class="keywordtype">char</span> run[32], cur[32], etd[32];
<a name="l02732"></a>02732 
<a name="l02733"></a>02733     <a class="code" href="../../dc/dd6/structptcache__bake__data.html">ptcache_bake_data</a> *data = (<a class="code" href="../../dc/dd6/structptcache__bake__data.html">ptcache_bake_data</a>*)ptr;
<a name="l02734"></a>02734 
<a name="l02735"></a>02735     stime = ptime = <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l02736"></a>02736     sfra = *data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>;
<a name="l02737"></a>02737     efra = data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>;
<a name="l02738"></a>02738 
<a name="l02739"></a>02739     <span class="keywordflow">for</span> (; (*data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a> &lt;= data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>) &amp;&amp; !data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">break_operation</a>; *data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>+=data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">step</a>) {
<a name="l02740"></a>02740         <a class="code" href="../../d8/d53/BKE__scene_8h.html#af6ab7bd3a6bb91b84e1b6cffc995640f">scene_update_for_newframe</a>(data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac64879911c2334fc750201d265d59500">main</a>, data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4fbbb9247752194af45a6adf91b048e2">scene</a>, data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4fbbb9247752194af45a6adf91b048e2">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a506dd867fc58506c37c1e56f6b134056">lay</a>);
<a name="l02741"></a>02741         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background) {
<a name="l02742"></a>02742             printf(<span class="stringliteral">&quot;bake: frame %d :: %d\n&quot;</span>, (<span class="keywordtype">int</span>)*data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>, data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>);
<a name="l02743"></a>02743         }
<a name="l02744"></a>02744         <span class="keywordflow">else</span> {
<a name="l02745"></a>02745             ctime = <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l02746"></a>02746 
<a name="l02747"></a>02747             fetd = (ctime-ptime)*(efra-*data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>)/data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">step</a>;
<a name="l02748"></a>02748 
<a name="l02749"></a>02749             <span class="keywordflow">if</span> (usetimer || fetd &gt; 60.0) {
<a name="l02750"></a>02750                 usetimer = 1;
<a name="l02751"></a>02751 
<a name="l02752"></a>02752                 <a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">ptcache_dt_to_str</a>(cur, ctime-ptime);
<a name="l02753"></a>02753                 <a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">ptcache_dt_to_str</a>(run, ctime-stime);
<a name="l02754"></a>02754                 <a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">ptcache_dt_to_str</a>(etd, fetd);
<a name="l02755"></a>02755 
<a name="l02756"></a>02756                 printf(<span class="stringliteral">&quot;Baked for %s, current frame: %i/%i (%.3fs), ETC: %s\r&quot;</span>, run, *data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>-sfra+1, efra-sfra+1, ctime-ptime, etd);
<a name="l02757"></a>02757             }
<a name="l02758"></a>02758             ptime = ctime;
<a name="l02759"></a>02759         }
<a name="l02760"></a>02760     }
<a name="l02761"></a>02761 
<a name="l02762"></a>02762     <span class="keywordflow">if</span> (usetimer) {
<a name="l02763"></a>02763         <a class="code" href="../../d3/d9b/pointcache_8c.html#af0c723b94f37d964e385b16f713f97b5">ptcache_dt_to_str</a>(run, <a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>()-stime);
<a name="l02764"></a>02764         printf(<span class="stringliteral">&quot;Bake %s %s (%i frames simulated).\n&quot;</span>, (data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">break_operation</a> ? <span class="stringliteral">&quot;canceled after&quot;</span> : <span class="stringliteral">&quot;finished in&quot;</span>), run, *data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a>-sfra);
<a name="l02765"></a>02765     }
<a name="l02766"></a>02766 
<a name="l02767"></a>02767     data-&gt;<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a60451dcd92e27ad207fcd3f4e4374abc">thread_ended</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02768"></a>02768     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02769"></a>02769 }
<a name="l02770"></a>02770 
<a name="l02771"></a>02771 <span class="comment">/* if bake is not given run simulations to current frame */</span>
<a name="l02772"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#aac5f3d54c466559d86f6340228b411da">02772</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5dd02bd1a766237a56e6331a24cd4964">BKE_ptcache_bake</a>(<a class="code" href="../../d9/d6b/structPTCacheBaker.html">PTCacheBaker</a>* baker)
<a name="l02773"></a>02773 {
<a name="l02774"></a>02774     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ab0e3fabfa956f3574373790136c0807f">main</a>;
<a name="l02775"></a>02775     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a7204330a7a032569b9bcfaa41e4db16e">scene</a>;
<a name="l02776"></a>02776     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *sce_iter; <span class="comment">/* SETLOOPER macro only */</span>
<a name="l02777"></a>02777     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l02778"></a>02778     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> pidlist;
<a name="l02779"></a>02779     <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a3aa890b37235e0ddb7e018cb8ff566c0">pid</a>;
<a name="l02780"></a>02780     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02781"></a>02781     <span class="keywordtype">float</span> frameleno = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4399e01a91c6ca3e1259887c82ea0972">framelen</a>;
<a name="l02782"></a>02782     <span class="keywordtype">int</span> cfrao = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>;
<a name="l02783"></a>02783     <span class="keywordtype">int</span> startframe = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#afedd4d2cbfe9c6cdbc7496c9a2a01c9e">MAXFRAME</a>;
<a name="l02784"></a>02784     <span class="keywordtype">int</span> bake = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a58489ca94bbb295a57f0ca53ce031e5c">bake</a>;
<a name="l02785"></a>02785     <span class="keywordtype">int</span> render = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a622e19eac9524a988d93e3203a1a2fad">render</a>;
<a name="l02786"></a>02786     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d2/dcd/pipeline_8c.html#a4f987a98d3e1221916748962e45399fe">threads</a>;
<a name="l02787"></a>02787     <a class="code" href="../../dc/dd6/structptcache__bake__data.html">ptcache_bake_data</a> thread_data;
<a name="l02788"></a>02788     <span class="keywordtype">int</span> progress, old_progress;
<a name="l02789"></a>02789     
<a name="l02790"></a>02790     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a> = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ade056e7fe55446bad74c723242ff3722">anim_init</a> ? scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a97f52582406befb3dba13b121d886526">sfra</a> : <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>;
<a name="l02791"></a>02791     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">step</a> = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ae9f29b4adce403c413c7bfa97d3bf680">quick_step</a>;
<a name="l02792"></a>02792     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4da1f066949fea1a1eb4de7fba57d4bf">cfra_ptr</a> = &amp;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>;
<a name="l02793"></a>02793     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a4fbbb9247752194af45a6adf91b048e2">scene</a> = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a7204330a7a032569b9bcfaa41e4db16e">scene</a>;
<a name="l02794"></a>02794     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac64879911c2334fc750201d265d59500">main</a> = baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#ab0e3fabfa956f3574373790136c0807f">main</a>;
<a name="l02795"></a>02795 
<a name="l02796"></a>02796     <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.afbreek = 0;
<a name="l02797"></a>02797 
<a name="l02798"></a>02798     <span class="comment">/* set caches to baking mode and figure out start frame */</span>
<a name="l02799"></a>02799     <span class="keywordflow">if</span> (pid) {
<a name="l02800"></a>02800         <span class="comment">/* cache/bake a single object */</span>
<a name="l02801"></a>02801         cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02802"></a>02802         <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)==0) {
<a name="l02803"></a>02803             <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a>) {
<a name="l02804"></a>02804                 <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys= pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>;
<a name="l02805"></a>02805 
<a name="l02806"></a>02806                 <span class="comment">/* a bit confusing, could make this work better in the UI */</span>
<a name="l02807"></a>02807                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a1854b06595cf1fa6c4e805405142f195">PART_EMITTER</a>)
<a name="l02808"></a>02808                     <a class="code" href="../../db/dca/BKE__particle_8h.html#a4eb47a384d089ddb5b3c91ae3e8ae07a">psys_get_pointcache_start_end</a>(scene, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>);
<a name="l02809"></a>02809             }
<a name="l02810"></a>02810             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a0c912d9f57d48eefd6a3677cacef9d85">PTCACHE_TYPE_SMOKE_HIGHRES</a>) {
<a name="l02811"></a>02811                 <span class="comment">/* get all pids from the object and search for smoke low res */</span>
<a name="l02812"></a>02812                 <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> pidlist2;
<a name="l02813"></a>02813                 <a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid2;
<a name="l02814"></a>02814                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2308780fc8b6f269567217d7e9e9d3e6">BKE_ptcache_ids_from_object</a>(&amp;pidlist2, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb1d5dafabe8b4c5a1a69278ad7bda3c">ob</a>, scene, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36a22093e79e04fd2df49aaf650c10ce">MAX_DUPLI_RECUR</a>);
<a name="l02815"></a>02815                 <span class="keywordflow">for</span> (pid2=pidlist2.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pid2; pid2=pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb3b4392dbaf6ab7166b4f44d18cf93a">next</a>) {
<a name="l02816"></a>02816                     <span class="keywordflow">if</span> (pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a>) 
<a name="l02817"></a>02817                     {
<a name="l02818"></a>02818                         <span class="keywordflow">if</span> (pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a> &amp;&amp; !(pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)) {
<a name="l02819"></a>02819                             <span class="keywordflow">if</span> (bake || pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>)
<a name="l02820"></a>02820                                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid2, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l02821"></a>02821                             <span class="keywordflow">if</span> (bake) {
<a name="l02822"></a>02822                                 pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>;
<a name="l02823"></a>02823                                 pid2-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02824"></a>02824                             }
<a name="l02825"></a>02825                         }
<a name="l02826"></a>02826                     }
<a name="l02827"></a>02827                 }
<a name="l02828"></a>02828                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pidlist2);
<a name="l02829"></a>02829             }
<a name="l02830"></a>02830 
<a name="l02831"></a>02831             <span class="keywordflow">if</span> (bake || cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>)
<a name="l02832"></a>02832                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l02833"></a>02833 
<a name="l02834"></a>02834             startframe = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>);
<a name="l02835"></a>02835 
<a name="l02836"></a>02836             <span class="keywordflow">if</span> (bake) {
<a name="l02837"></a>02837                 thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a> = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02838"></a>02838                 cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>;
<a name="l02839"></a>02839             }
<a name="l02840"></a>02840             <span class="keywordflow">else</span> {
<a name="l02841"></a>02841                 thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>);
<a name="l02842"></a>02842             }
<a name="l02843"></a>02843 
<a name="l02844"></a>02844             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02845"></a>02845         }
<a name="l02846"></a>02846     }
<a name="l02847"></a>02847     <span class="keywordflow">else</span> {
<a name="l02848"></a>02848         <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene, sce_iter, base)) {
<a name="l02849"></a>02849             <span class="comment">/* cache/bake everything in the scene */</span>
<a name="l02850"></a>02850             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2308780fc8b6f269567217d7e9e9d3e6">BKE_ptcache_ids_from_object</a>(&amp;pidlist, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>, scene, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36a22093e79e04fd2df49aaf650c10ce">MAX_DUPLI_RECUR</a>);
<a name="l02851"></a>02851 
<a name="l02852"></a>02852             <span class="keywordflow">for</span> (pid=pidlist.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pid; pid=pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb3b4392dbaf6ab7166b4f44d18cf93a">next</a>) {
<a name="l02853"></a>02853                 cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02854"></a>02854                 <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)==0) {
<a name="l02855"></a>02855                     <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a>) {
<a name="l02856"></a>02856                         <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys = (<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a>*)pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>;
<a name="l02857"></a>02857                         <span class="comment">/* skip hair &amp; keyed particles */</span>
<a name="l02858"></a>02858                         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a3489e9807bb2c3edb363c7159234ae80">type</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a> || psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a3b53997470f35e5d3a5e99ba52fb1c3a">part</a>-&gt;<a class="code" href="../../df/da6/structParticleSettings.html#a4868871c1c1ba91bd42b97081be0f76a">phystype</a> == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a04539ab17dab33b4e345164c2831a4f8">PART_PHYS_KEYED</a>)
<a name="l02859"></a>02859                             <span class="keywordflow">continue</span>;
<a name="l02860"></a>02860 
<a name="l02861"></a>02861                         <a class="code" href="../../db/dca/BKE__particle_8h.html#a4eb47a384d089ddb5b3c91ae3e8ae07a">psys_get_pointcache_start_end</a>(scene, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, &amp;cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>);
<a name="l02862"></a>02862                     }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864                     <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a> || (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>)==0) &amp;&amp;
<a name="l02865"></a>02865                         ((cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a1cf6c69d9867025ed8f85da17c0886a3">PTCACHE_QUICK_CACHE</a>)==0 || render || bake))
<a name="l02866"></a>02866                     {
<a name="l02867"></a>02867                         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l02868"></a>02868                     }
<a name="l02869"></a>02869 
<a name="l02870"></a>02870                     startframe = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(startframe, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>);
<a name="l02871"></a>02871 
<a name="l02872"></a>02872                     <span class="keywordflow">if</span> (bake || render) {
<a name="l02873"></a>02873                         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>;
<a name="l02874"></a>02874 
<a name="l02875"></a>02875                         <span class="keywordflow">if</span> (bake)
<a name="l02876"></a>02876                             thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a> = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ab7a16a1abfdd55a40891b77520e7849b">endframe</a>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>);
<a name="l02877"></a>02877                     }
<a name="l02878"></a>02878 
<a name="l02879"></a>02879                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02880"></a>02880 
<a name="l02881"></a>02881                 }
<a name="l02882"></a>02882             }
<a name="l02883"></a>02883             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pidlist);
<a name="l02884"></a>02884         }
<a name="l02885"></a>02885     }
<a name="l02886"></a>02886 
<a name="l02887"></a>02887     <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a> = startframe;
<a name="l02888"></a>02888     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4399e01a91c6ca3e1259887c82ea0972">framelen</a> = 1.0;
<a name="l02889"></a>02889     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">break_operation</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02890"></a>02890     thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a60451dcd92e27ad207fcd3f4e4374abc">thread_ended</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02891"></a>02891     old_progress = -1;
<a name="l02892"></a>02892 
<a name="l02893"></a>02893     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(1);
<a name="l02894"></a>02894     
<a name="l02895"></a>02895     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background) {
<a name="l02896"></a>02896         <a class="code" href="../../d3/d9b/pointcache_8c.html#abae7653399fe5a47a9b97f941cb41b6e">ptcache_bake_thread</a>((<span class="keywordtype">void</span>*)&amp;thread_data);
<a name="l02897"></a>02897     }
<a name="l02898"></a>02898     <span class="keywordflow">else</span> {
<a name="l02899"></a>02899         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a71fe304cbc8934d7dce95d5ad1eefa46">BLI_init_threads</a>(&amp;threads, <a class="code" href="../../d3/d9b/pointcache_8c.html#abae7653399fe5a47a9b97f941cb41b6e">ptcache_bake_thread</a>, 1);
<a name="l02900"></a>02900         <a class="code" href="../../df/dbb/BLI__threads_8h.html#a19e3908192f418ed7d20f9060b92e39a">BLI_insert_thread</a>(&amp;threads, (<span class="keywordtype">void</span>*)&amp;thread_data);
<a name="l02901"></a>02901 
<a name="l02902"></a>02902         <span class="keywordflow">while</span> (thread_data.thread_ended == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l02903"></a>02903 
<a name="l02904"></a>02904             <span class="keywordflow">if</span> (bake)
<a name="l02905"></a>02905                 progress = (int)(100.0f * (<span class="keywordtype">float</span>)(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a> - startframe)/(<span class="keywordtype">float</span>)(thread_data.endframe-startframe));
<a name="l02906"></a>02906             <span class="keywordflow">else</span>
<a name="l02907"></a>02907                 progress = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>;
<a name="l02908"></a>02908 
<a name="l02909"></a>02909             <span class="comment">/* NOTE: baking should not redraw whole ui as this slows things down */</span>
<a name="l02910"></a>02910             <span class="keywordflow">if</span> ((baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a3b023e4c0d2daa876dcafbb2ffd7eb12">progressbar</a>) &amp;&amp; (progress != old_progress)) {
<a name="l02911"></a>02911                 baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a3b023e4c0d2daa876dcafbb2ffd7eb12">progressbar</a>(baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a157abde889c4b9fb3cfbbb1d8353aaf9">progresscontext</a>, progress);
<a name="l02912"></a>02912                 old_progress = progress;
<a name="l02913"></a>02913             }
<a name="l02914"></a>02914 
<a name="l02915"></a>02915             <span class="comment">/* Delay to lessen CPU load from UI thread */</span>
<a name="l02916"></a>02916             <a class="code" href="../../df/d73/time_8c.html#a43667128024aa660ab9adfbd5df9e88a">PIL_sleep_ms</a>(200);
<a name="l02917"></a>02917 
<a name="l02918"></a>02918             <span class="comment">/* NOTE: breaking baking should leave calculated frames in cache, not clear it */</span>
<a name="l02919"></a>02919             <span class="keywordflow">if</span> (<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1ad141f46f0fb24cf83ba80060bacdf7">blender_test_break</a>() &amp;&amp; !thread_data.break_operation) {
<a name="l02920"></a>02920                 thread_data.break_operation = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02921"></a>02921                 <span class="keywordflow">if</span> (baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a2e10687e95878225411ce4f8e0f6a421">progressend</a>)
<a name="l02922"></a>02922                     baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a2e10687e95878225411ce4f8e0f6a421">progressend</a>(baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a157abde889c4b9fb3cfbbb1d8353aaf9">progresscontext</a>);
<a name="l02923"></a>02923                 <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(1);
<a name="l02924"></a>02924             }
<a name="l02925"></a>02925         }
<a name="l02926"></a>02926 
<a name="l02927"></a>02927     <a class="code" href="../../df/dbb/BLI__threads_8h.html#a74091ba5aec8c4deaaed5aa32d0545b2">BLI_end_threads</a>(&amp;threads);
<a name="l02928"></a>02928     }
<a name="l02929"></a>02929     <span class="comment">/* clear baking flag */</span>
<a name="l02930"></a>02930     <span class="keywordflow">if</span> (pid) {
<a name="l02931"></a>02931         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>);
<a name="l02932"></a>02932         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>;
<a name="l02933"></a>02933         <span class="keywordflow">if</span> (bake) {
<a name="l02934"></a>02934             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02935"></a>02935             <span class="comment">/* write info file */</span>
<a name="l02936"></a>02936             <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>)
<a name="l02937"></a>02937                 <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, 0);
<a name="l02938"></a>02938         }
<a name="l02939"></a>02939     }
<a name="l02940"></a>02940     <span class="keywordflow">else</span> {
<a name="l02941"></a>02941         <span class="keywordflow">for</span> (<a class="code" href="../../d8/d53/BKE__scene_8h.html#a2ea2c0ff1c9b5bb29c3add65bbaadf2d">SETLOOPER</a>(scene, sce_iter, base)) {
<a name="l02942"></a>02942             <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a2308780fc8b6f269567217d7e9e9d3e6">BKE_ptcache_ids_from_object</a>(&amp;pidlist, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>, scene, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36a22093e79e04fd2df49aaf650c10ce">MAX_DUPLI_RECUR</a>);
<a name="l02943"></a>02943 
<a name="l02944"></a>02944             <span class="keywordflow">for</span> (pid=pidlist.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; pid; pid=pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#aeb3b4392dbaf6ab7166b4f44d18cf93a">next</a>) {
<a name="l02945"></a>02945                 <span class="comment">/* skip hair particles */</span>
<a name="l02946"></a>02946                 <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a>==<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a89ac9cccf7f8ab9a797952fa679bba4a">PTCACHE_TYPE_PARTICLES</a> &amp;&amp; ((<a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a>*)pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>)-&gt;part-&gt;type == <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#aa38c7f44b9dcf5e9889f23cfae104145">PART_HAIR</a>)
<a name="l02947"></a>02947                     <span class="keywordflow">continue</span>;
<a name="l02948"></a>02948 
<a name="l02949"></a>02949                 cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02950"></a>02950 
<a name="l02951"></a>02951                 <span class="keywordflow">if</span> (thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#a8a3d7caba8874ddd2698eec57b314799">step</a> &gt; 1)
<a name="l02952"></a>02952                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>);
<a name="l02953"></a>02953                 <span class="keywordflow">else</span>
<a name="l02954"></a>02954                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#afbb4141a9c0c93eb6a35b94f11a7f725">PTCACHE_BAKING</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0dc69ed5f35aff43c095c339dd5da0ce">PTCACHE_REDO_NEEDED</a>);
<a name="l02955"></a>02955 
<a name="l02956"></a>02956                 cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>;
<a name="l02957"></a>02957 
<a name="l02958"></a>02958                 <span class="keywordflow">if</span> (bake) {
<a name="l02959"></a>02959                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02960"></a>02960                     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>)
<a name="l02961"></a>02961                         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, 0);
<a name="l02962"></a>02962                 }
<a name="l02963"></a>02963             }
<a name="l02964"></a>02964             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;pidlist);
<a name="l02965"></a>02965         }
<a name="l02966"></a>02966     }
<a name="l02967"></a>02967 
<a name="l02968"></a>02968     scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4399e01a91c6ca3e1259887c82ea0972">framelen</a> = frameleno;
<a name="l02969"></a>02969     <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a> = cfrao;
<a name="l02970"></a>02970     
<a name="l02971"></a>02971     <span class="keywordflow">if</span> (bake) <span class="comment">/* already on cfra unless baking */</span>
<a name="l02972"></a>02972         <a class="code" href="../../d8/d53/BKE__scene_8h.html#af6ab7bd3a6bb91b84e1b6cffc995640f">scene_update_for_newframe</a>(bmain, scene, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a506dd867fc58506c37c1e56f6b134056">lay</a>);
<a name="l02973"></a>02973 
<a name="l02974"></a>02974     <span class="keywordflow">if</span> (thread_data.<a class="code" href="../../dc/dd6/structptcache__bake__data.html#ac426453cb7b6bcb635461f892dcfca83">break_operation</a>)
<a name="l02975"></a>02975         <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l02976"></a>02976     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a2e10687e95878225411ce4f8e0f6a421">progressend</a>)
<a name="l02977"></a>02977         baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a2e10687e95878225411ce4f8e0f6a421">progressend</a>(baker-&gt;<a class="code" href="../../d9/d6b/structPTCacheBaker.html#a157abde889c4b9fb3cfbbb1d8353aaf9">progresscontext</a>);
<a name="l02978"></a>02978 
<a name="l02979"></a>02979     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ae5b57427153f1f60f6638a537465c805">WM_cursor_wait</a>(0);
<a name="l02980"></a>02980 
<a name="l02981"></a>02981     <span class="comment">/* TODO: call redraw all windows somehow */</span>
<a name="l02982"></a>02982 }
<a name="l02983"></a>02983 <span class="comment">/* Helpers */</span>
<a name="l02984"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a1b2229068f9918ac00c645755bc8cbe7">02984</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a7b90fef9414cf9e322a23f6011c16440">BKE_ptcache_disk_to_mem</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l02985"></a>02985 {
<a name="l02986"></a>02986     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l02987"></a>02987     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02988"></a>02988     <span class="keywordtype">int</span> baked = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02989"></a>02989     <span class="keywordtype">int</span> cfra, sfra = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, efra = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>;
<a name="l02990"></a>02990 
<a name="l02991"></a>02991     <span class="comment">/* Remove possible bake flag to allow clear */</span>
<a name="l02992"></a>02992     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l02993"></a>02993 
<a name="l02994"></a>02994     <span class="comment">/* PTCACHE_DISK_CACHE flag was cleared already */</span>
<a name="l02995"></a>02995     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l02996"></a>02996 
<a name="l02997"></a>02997     <span class="comment">/* restore possible bake flag */</span>
<a name="l02998"></a>02998     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= baked;
<a name="l02999"></a>02999 
<a name="l03000"></a>03000     <span class="keywordflow">for</span> (cfra=sfra; cfra &lt;= efra; cfra++) {
<a name="l03001"></a>03001         pm = <a class="code" href="../../d3/d9b/pointcache_8c.html#a3eda35bf8818382abc32f86fa03b6d8d">ptcache_disk_frame_to_mem</a>(pid, cfra);
<a name="l03002"></a>03002 
<a name="l03003"></a>03003         <span class="keywordflow">if</span> (pm)
<a name="l03004"></a>03004             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>, pm);
<a name="l03005"></a>03005     }
<a name="l03006"></a>03006 }
<a name="l03007"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a380d52bb1456e7ddacd1473d4c1ebeaa">03007</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc9531af9bbadca6512213b4ec179225">BKE_ptcache_mem_to_disk</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l03008"></a>03008 {
<a name="l03009"></a>03009     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l03010"></a>03010     <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l03011"></a>03011     <span class="keywordtype">int</span> baked = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013     <span class="comment">/* Remove possible bake flag to allow clear */</span>
<a name="l03014"></a>03014     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>;
<a name="l03015"></a>03015 
<a name="l03016"></a>03016     <span class="comment">/* PTCACHE_DISK_CACHE flag was set already */</span>
<a name="l03017"></a>03017     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l03018"></a>03018 
<a name="l03019"></a>03019     <span class="comment">/* restore possible bake flag */</span>
<a name="l03020"></a>03020     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= baked;
<a name="l03021"></a>03021 
<a name="l03022"></a>03022     <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l03023"></a>03023         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9b/pointcache_8c.html#a549b16b47c422de163fd9e516aca28f0">ptcache_mem_frame_to_disk</a>(pid, pm)==0) {
<a name="l03024"></a>03024             cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l03025"></a>03025             <span class="keywordflow">break</span>;
<a name="l03026"></a>03026         }
<a name="l03027"></a>03027     }
<a name="l03028"></a>03028 
<a name="l03029"></a>03029     <span class="comment">/* write info file */</span>
<a name="l03030"></a>03030     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>)
<a name="l03031"></a>03031         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc8a26ff863578ec09d0846659b03763">BKE_ptcache_write</a>(pid, 0);
<a name="l03032"></a>03032 }
<a name="l03033"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ad16d5b521d4c63886259c5513af468cd">03033</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5ddd0ed5a876dfc731915356d839c977">BKE_ptcache_toggle_disk_cache</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l03034"></a>03034 {
<a name="l03035"></a>03035     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l03036"></a>03036     <span class="keywordtype">int</span> last_exact = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>;
<a name="l03037"></a>03037 
<a name="l03038"></a>03038     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.relbase_valid) {
<a name="l03039"></a>03039         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l03040"></a>03040         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.debug &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>)
<a name="l03041"></a>03041             printf(<span class="stringliteral">&quot;File must be saved before using disk cache!\n&quot;</span>);
<a name="l03042"></a>03042         <span class="keywordflow">return</span>;
<a name="l03043"></a>03043     }
<a name="l03044"></a>03044 
<a name="l03045"></a>03045     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>) {
<a name="l03046"></a>03046         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>);
<a name="l03047"></a>03047         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#af0a0e4f7958b9ea1e67ef79b65b0df51">cached_frames</a>=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03048"></a>03048     }
<a name="l03049"></a>03049 
<a name="l03050"></a>03050     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>)
<a name="l03051"></a>03051         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#acc9531af9bbadca6512213b4ec179225">BKE_ptcache_mem_to_disk</a>(pid);
<a name="l03052"></a>03052     <span class="keywordflow">else</span>
<a name="l03053"></a>03053         <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a7b90fef9414cf9e322a23f6011c16440">BKE_ptcache_disk_to_mem</a>(pid);
<a name="l03054"></a>03054 
<a name="l03055"></a>03055     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> ^= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l03056"></a>03056     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a76698b67a8a21bf0b169fb4dd532c85b">BKE_ptcache_id_clear</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a81d392773c3565a7869139e518f4cc28">PTCACHE_CLEAR_ALL</a>, 0);
<a name="l03057"></a>03057     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> ^= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>;
<a name="l03058"></a>03058     
<a name="l03059"></a>03059     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> = last_exact;
<a name="l03060"></a>03060 
<a name="l03061"></a>03061     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a3b3321b3ad61b23a9c227a438281ad14">BKE_ptcache_id_time</a>(pid, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0.0f, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03062"></a>03062 
<a name="l03063"></a>03063     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a52ac7372c493399b1a564d79d34f50f8">BKE_ptcache_update_info</a>(pid);
<a name="l03064"></a>03064 }
<a name="l03065"></a>03065 
<a name="l03066"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#ac51f2796909ec5977bd52ce416db5395">03066</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#afdb73bbed8f9bd5891ec0a0cc1998cb2">BKE_ptcache_disk_cache_rename</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid, <span class="keyword">const</span> <span class="keywordtype">char</span> *name_src, <span class="keyword">const</span> <span class="keywordtype">char</span> *name_dst)
<a name="l03067"></a>03067 {
<a name="l03068"></a>03068     <span class="keywordtype">char</span> old_name[80];
<a name="l03069"></a>03069     <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; <span class="comment">/* store the length of the string */</span>
<a name="l03070"></a>03070     <span class="comment">/* mode is same as fopen&#39;s modes */</span>
<a name="l03071"></a>03071     <a class="code" href="../../d2/d00/struct__DIR.html">DIR</a> *dir; 
<a name="l03072"></a>03072     <span class="keyword">struct </span><a class="code" href="../../d5/de2/structdirent.html">dirent</a> *de;
<a name="l03073"></a>03073     <span class="keywordtype">char</span> path[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l03074"></a>03074     <span class="keywordtype">char</span> old_filename[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l03075"></a>03075     <span class="keywordtype">char</span> new_path_full[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l03076"></a>03076     <span class="keywordtype">char</span> old_path_full[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l03077"></a>03077     <span class="keywordtype">char</span> ext[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l03078"></a>03078 
<a name="l03079"></a>03079     <span class="comment">/* save old name */</span>
<a name="l03080"></a>03080     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(old_name, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>, <span class="keyword">sizeof</span>(old_name));
<a name="l03081"></a>03081 
<a name="l03082"></a>03082     <span class="comment">/* get &quot;from&quot; filename */</span>
<a name="l03083"></a>03083     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>, name_src, <span class="keyword">sizeof</span>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>));
<a name="l03084"></a>03084 
<a name="l03085"></a>03085     len = <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, old_filename, 0, 0, 0); <span class="comment">/* no path */</span>
<a name="l03086"></a>03086 
<a name="l03087"></a>03087     <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(pid, path);
<a name="l03088"></a>03088     dir = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#afa648ff43ec9eba592716a334f243111">opendir</a>(path);
<a name="l03089"></a>03089     <span class="keywordflow">if</span> (dir==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03090"></a>03090         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>, old_name, <span class="keyword">sizeof</span>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>));
<a name="l03091"></a>03091         <span class="keywordflow">return</span>;
<a name="l03092"></a>03092     }
<a name="l03093"></a>03093 
<a name="l03094"></a>03094     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(ext, <span class="keyword">sizeof</span>(ext), <span class="stringliteral">&quot;_%02u&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a70ff366b3724b931d3762512b7f7717a">stack_index</a>);
<a name="l03095"></a>03095 
<a name="l03096"></a>03096     <span class="comment">/* put new name into cache */</span>
<a name="l03097"></a>03097     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>, name_dst, <span class="keyword">sizeof</span>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>));
<a name="l03098"></a>03098 
<a name="l03099"></a>03099     <span class="keywordflow">while</span> ((de = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#ae8014c416b1b4c4a966b2deea8f50a9a">readdir</a>(dir)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03100"></a>03100         <span class="keywordflow">if</span> (strstr(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, ext)) { <span class="comment">/* do we have the right extension?*/</span>
<a name="l03101"></a>03101             <span class="keywordflow">if</span> (strncmp(old_filename, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, len ) == 0) { <span class="comment">/* do we have the right prefix */</span>
<a name="l03102"></a>03102                 <span class="comment">/* read the number of the file */</span>
<a name="l03103"></a>03103                 <span class="keywordtype">int</span> frame, len2 = (int)<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l03104"></a>03104                 <span class="keywordtype">char</span> num[7];
<a name="l03105"></a>03105 
<a name="l03106"></a>03106                 <span class="keywordflow">if</span> (len2 &gt; 15) { <span class="comment">/* could crash if trying to copy a string out of this range*/</span>
<a name="l03107"></a>03107                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(num, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a> + (<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>) - 15), <span class="keyword">sizeof</span>(num));
<a name="l03108"></a>03108                     frame = atoi(num);
<a name="l03109"></a>03109 
<a name="l03110"></a>03110                     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af06511817c824c772ec102e6b23a3207">BLI_join_dirfile</a>(old_path_full, <span class="keyword">sizeof</span>(old_path_full), path, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l03111"></a>03111                     <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, new_path_full, frame, 1, 1);
<a name="l03112"></a>03112                     <a class="code" href="../../d2/d63/BLI__fileops_8h.html#af698b70803b612aec5a87a0a41babed3">BLI_rename</a>(old_path_full, new_path_full);
<a name="l03113"></a>03113                 }
<a name="l03114"></a>03114             }
<a name="l03115"></a>03115         }
<a name="l03116"></a>03116     }
<a name="l03117"></a>03117     <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f0074f29445f186fbab246d10ddf331">closedir</a>(dir);
<a name="l03118"></a>03118 
<a name="l03119"></a>03119     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>, old_name, <span class="keyword">sizeof</span>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a599ed6a99704748d5fba66a3fac7fe55">name</a>));
<a name="l03120"></a>03120 }
<a name="l03121"></a>03121 
<a name="l03122"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a2ca3b1973ba7759ff47efb4824e9b916">03122</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#aaa746385544362486048f9f8e8855d22">BKE_ptcache_load_external</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l03123"></a>03123 {
<a name="l03124"></a>03124     <span class="comment">/*todo*/</span>
<a name="l03125"></a>03125     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l03126"></a>03126     <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>; <span class="comment">/* store the length of the string */</span>
<a name="l03127"></a>03127     <span class="keywordtype">int</span> info = 0;
<a name="l03128"></a>03128     <span class="keywordtype">int</span> start = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#afedd4d2cbfe9c6cdbc7496c9a2a01c9e">MAXFRAME</a>;
<a name="l03129"></a>03129     <span class="keywordtype">int</span> end = -1;
<a name="l03130"></a>03130 
<a name="l03131"></a>03131     <span class="comment">/* mode is same as fopen&#39;s modes */</span>
<a name="l03132"></a>03132     <a class="code" href="../../d2/d00/struct__DIR.html">DIR</a> *dir; 
<a name="l03133"></a>03133     <span class="keyword">struct </span><a class="code" href="../../d5/de2/structdirent.html">dirent</a> *de;
<a name="l03134"></a>03134     <span class="keywordtype">char</span> path[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l03135"></a>03135     <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/d9b/pointcache_8c.html#a68e6a7ab6ae5299a7c3b290c4a794e7e">MAX_PTCACHE_FILE</a>];
<a name="l03136"></a>03136     <span class="keywordtype">char</span> ext[<a class="code" href="../../d3/d9b/pointcache_8c.html#a35995b6c85255be8cc0c148330c4eb06">MAX_PTCACHE_PATH</a>];
<a name="l03137"></a>03137 
<a name="l03138"></a>03138     <span class="keywordflow">if</span> (!cache)
<a name="l03139"></a>03139         <span class="keywordflow">return</span>;
<a name="l03140"></a>03140 
<a name="l03141"></a>03141     <a class="code" href="../../d3/d9b/pointcache_8c.html#a3d0345300ef2dd76830f27ba76805ac7">ptcache_path</a>(pid, path);
<a name="l03142"></a>03142     
<a name="l03143"></a>03143     len = <a class="code" href="../../d3/d9b/pointcache_8c.html#a6209717fd0267770297c8e637281bf20">ptcache_filename</a>(pid, filename, 1, 0, 0); <span class="comment">/* no path */</span>
<a name="l03144"></a>03144     
<a name="l03145"></a>03145     dir = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#afa648ff43ec9eba592716a334f243111">opendir</a>(path);
<a name="l03146"></a>03146     <span class="keywordflow">if</span> (dir==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03147"></a>03147         <span class="keywordflow">return</span>;
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a> &gt;= 0)
<a name="l03150"></a>03150         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(ext, <span class="keyword">sizeof</span>(ext), <span class="stringliteral">&quot;_%02d&quot;</span><a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ab1fe8cb28e00dd6e1365473c04094404">index</a>);
<a name="l03151"></a>03151     <span class="keywordflow">else</span>
<a name="l03152"></a>03152         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ext, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5abe2cf701d58e59777d8114acb1f024">PTCACHE_EXT</a>, <span class="keyword">sizeof</span>(ext));
<a name="l03153"></a>03153     
<a name="l03154"></a>03154     <span class="keywordflow">while</span> ((de = <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#ae8014c416b1b4c4a966b2deea8f50a9a">readdir</a>(dir)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l03155"></a>03155         <span class="keywordflow">if</span> (strstr(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, ext)) { <span class="comment">/* do we have the right extension?*/</span>
<a name="l03156"></a>03156             <span class="keywordflow">if</span> (strncmp(filename, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>, len ) == 0) { <span class="comment">/* do we have the right prefix */</span>
<a name="l03157"></a>03157                 <span class="comment">/* read the number of the file */</span>
<a name="l03158"></a>03158                 <span class="keywordtype">int</span> frame, len2 = (int)<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>);
<a name="l03159"></a>03159                 <span class="keywordtype">char</span> num[7];
<a name="l03160"></a>03160 
<a name="l03161"></a>03161                 <span class="keywordflow">if</span> (len2 &gt; 15) { <span class="comment">/* could crash if trying to copy a string out of this range*/</span>
<a name="l03162"></a>03162                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(num, de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a> + (<a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(de-&gt;<a class="code" href="../../d5/de2/structdirent.html#ab703007dd91aa1f311cf0fc85268b2e1">d_name</a>) - 15), <span class="keyword">sizeof</span>(num));
<a name="l03163"></a>03163                     frame = atoi(num);
<a name="l03164"></a>03164 
<a name="l03165"></a>03165                     <span class="keywordflow">if</span> (frame) {
<a name="l03166"></a>03166                         start = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(start, frame);
<a name="l03167"></a>03167                         end = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(end, frame);
<a name="l03168"></a>03168                     }
<a name="l03169"></a>03169                     <span class="keywordflow">else</span>
<a name="l03170"></a>03170                         info = 1;
<a name="l03171"></a>03171                 }
<a name="l03172"></a>03172             }
<a name="l03173"></a>03173         }
<a name="l03174"></a>03174     }
<a name="l03175"></a>03175     <a class="code" href="../../d9/ded/BLI__winstuff_8h.html#a5f0074f29445f186fbab246d10ddf331">closedir</a>(dir);
<a name="l03176"></a>03176 
<a name="l03177"></a>03177     <span class="keywordflow">if</span> (start != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#afedd4d2cbfe9c6cdbc7496c9a2a01c9e">MAXFRAME</a>) {
<a name="l03178"></a>03178         <a class="code" href="../../da/d38/structPTCacheFile.html">PTCacheFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l03179"></a>03179 
<a name="l03180"></a>03180         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a> = start;
<a name="l03181"></a>03181         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a> = end;
<a name="l03182"></a>03182         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a> = 0;
<a name="l03183"></a>03183 
<a name="l03184"></a>03184         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a>)
<a name="l03185"></a>03185             ; <span class="comment">/*necessary info in every file*/</span>
<a name="l03186"></a>03186         <span class="comment">/* read totpoint from info file (frame 0) */</span>
<a name="l03187"></a>03187         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info) {
<a name="l03188"></a>03188             pf= <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a08f62037a9e520e3374ee79d422ef308">PTCACHE_FILE_READ</a>, 0);
<a name="l03189"></a>03189 
<a name="l03190"></a>03190             <span class="keywordflow">if</span> (pf) {
<a name="l03191"></a>03191                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9b/pointcache_8c.html#af3d476ef312c4e1d20f7cf57d9b220f9">ptcache_file_header_begin_read</a>(pf)) {
<a name="l03192"></a>03192                     <span class="keywordflow">if</span> (pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#abcc369922362be9dac1b7e1da2117cc9">type</a> == pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> &amp;&amp; pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#abd01c2f2e17b804160e0c90c9848c3e1">read_header</a>(pf)) {
<a name="l03193"></a>03193                         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a> = pf-&gt;<a class="code" href="../../da/d38/structPTCacheFile.html#a438cbddc4d17701b67cdc1255d9b1033">totpoint</a>;
<a name="l03194"></a>03194                         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ae07fd09c62174d7b7de0b9af6ce82567">PTCACHE_READ_INFO</a>;
<a name="l03195"></a>03195                     }
<a name="l03196"></a>03196                     <span class="keywordflow">else</span> {
<a name="l03197"></a>03197                         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a> = 0;
<a name="l03198"></a>03198                     }
<a name="l03199"></a>03199                 }
<a name="l03200"></a>03200                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l03201"></a>03201             }
<a name="l03202"></a>03202         }
<a name="l03203"></a>03203         <span class="comment">/* or from any old format cache file */</span>
<a name="l03204"></a>03204         <span class="keywordflow">else</span> {
<a name="l03205"></a>03205             <span class="keywordtype">float</span> old_data[14];
<a name="l03206"></a>03206             <span class="keywordtype">int</span> elemsize = <a class="code" href="../../d3/d9b/pointcache_8c.html#abf4bd0f2faaa4ba562667b36028ba351">ptcache_old_elemsize</a>(pid);
<a name="l03207"></a>03207             pf= <a class="code" href="../../d3/d9b/pointcache_8c.html#aa82773060b4d3cbcc0a10030f4d287ea">ptcache_file_open</a>(pid, <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a08f62037a9e520e3374ee79d422ef308">PTCACHE_FILE_READ</a>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>);
<a name="l03208"></a>03208 
<a name="l03209"></a>03209             <span class="keywordflow">if</span> (pf) {
<a name="l03210"></a>03210                 <span class="keywordflow">while</span> (<a class="code" href="../../d3/d9b/pointcache_8c.html#a01bb6a0c7ad81efca6eb4f738b31c8ea">ptcache_file_read</a>(pf, old_data, 1, elemsize))
<a name="l03211"></a>03211                     cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a>++;
<a name="l03212"></a>03212                 
<a name="l03213"></a>03213                 <a class="code" href="../../d3/d9b/pointcache_8c.html#a2db8143dbcb6a5476ee9b8ea2e05a8b8">ptcache_file_close</a>(pf);
<a name="l03214"></a>03214             }
<a name="l03215"></a>03215         }
<a name="l03216"></a>03216         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= (<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a895fb976494aba70aaac10d09e880368">PTCACHE_BAKED</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>);
<a name="l03217"></a>03217         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>|<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>);
<a name="l03218"></a>03218     }
<a name="l03219"></a>03219 
<a name="l03220"></a>03220     <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a52ac7372c493399b1a564d79d34f50f8">BKE_ptcache_update_info</a>(pid);
<a name="l03221"></a>03221 }
<a name="l03222"></a>03222 
<a name="l03223"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a52ac7372c493399b1a564d79d34f50f8">03223</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a52ac7372c493399b1a564d79d34f50f8">BKE_ptcache_update_info</a>(<a class="code" href="../../db/d21/structPTCacheID.html">PTCacheID</a> *pid)
<a name="l03224"></a>03224 {
<a name="l03225"></a>03225     <a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#af14383358561e231d506da97252ea345">cache</a>;
<a name="l03226"></a>03226     <a class="code" href="../../d2/d97/structPTCacheExtra.html">PTCacheExtra</a> *extra = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03227"></a>03227     <span class="keywordtype">int</span> totframes = 0;
<a name="l03228"></a>03228     <span class="keywordtype">char</span> mem_info[64];
<a name="l03229"></a>03229 
<a name="l03230"></a>03230     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a0f7bcfd660863fd82c48da9ad0e948d4">PTCACHE_EXTERNAL</a>) {
<a name="l03231"></a>03231         <span class="keywordtype">int</span> cfra = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>;
<a name="l03232"></a>03232 
<a name="l03233"></a>03233         <span class="keywordflow">for</span> (; cfra&lt;=cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>; cfra++) {
<a name="l03234"></a>03234             <span class="keywordflow">if</span> (<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfra))
<a name="l03235"></a>03235                 totframes++;
<a name="l03236"></a>03236         }
<a name="l03237"></a>03237 
<a name="l03238"></a>03238         <span class="comment">/* smoke doesn&#39;t use frame 0 as info frame so can&#39;t check based on totpoint */</span>
<a name="l03239"></a>03239         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a> &amp;&amp; totframes)
<a name="l03240"></a>03240             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;%i frames found!&quot;</span>, totframes);
<a name="l03241"></a>03241         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (totframes &amp;&amp; cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a>)
<a name="l03242"></a>03242             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;%i points found!&quot;</span>, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a>);
<a name="l03243"></a>03243         <span class="keywordflow">else</span>
<a name="l03244"></a>03244             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;No valid data to read!&quot;</span>);
<a name="l03245"></a>03245         <span class="keywordflow">return</span>;
<a name="l03246"></a>03246     }
<a name="l03247"></a>03247 
<a name="l03248"></a>03248     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a4dfd845afe48aca448b8bbcef971cc5d">PTCACHE_DISK_CACHE</a>) {
<a name="l03249"></a>03249         <span class="keywordflow">if</span> (pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a643be6b5bf54ba0e7686d8e9cdd426dc">type</a> == <a class="code" href="../../db/d45/BKE__pointcache_8h.html#ad0807dd50518d68763b2dd637f89bbb7">PTCACHE_TYPE_SMOKE_DOMAIN</a>)
<a name="l03250"></a>03250         {
<a name="l03251"></a>03251             <span class="keywordtype">int</span> totpoint = pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a934a1075e594e2c7fcb64fe71801990c">totpoint</a>(pid-&gt;<a class="code" href="../../db/d21/structPTCacheID.html#a49341aaf52c0942110480795d04ce5ae">calldata</a>, 0);
<a name="l03252"></a>03252 
<a name="l03253"></a>03253             <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a8adcb0fc43f4761ad867881b8fa1e332">totpoint</a> &gt; totpoint)
<a name="l03254"></a>03254                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(mem_info, <span class="keyword">sizeof</span>(mem_info), <span class="stringliteral">&quot;%i cells + High Resolution cached&quot;</span>, totpoint);
<a name="l03255"></a>03255             <span class="keywordflow">else</span>
<a name="l03256"></a>03256                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(mem_info, <span class="keyword">sizeof</span>(mem_info), <span class="stringliteral">&quot;%i cells cached&quot;</span>, totpoint);
<a name="l03257"></a>03257         }
<a name="l03258"></a>03258         <span class="keywordflow">else</span> {
<a name="l03259"></a>03259             <span class="keywordtype">int</span> cfra = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>;
<a name="l03260"></a>03260 
<a name="l03261"></a>03261             <span class="keywordflow">for</span> (; cfra&lt;=cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ad32c1c63d21f477d72e61e87f34aff78">endframe</a>; cfra++) {
<a name="l03262"></a>03262                 <span class="keywordflow">if</span> (<a class="code" href="../../db/d45/BKE__pointcache_8h.html#a24ea66b305452e1b07b07438b3454836">BKE_ptcache_id_exist</a>(pid, cfra))
<a name="l03263"></a>03263                     totframes++;
<a name="l03264"></a>03264             }
<a name="l03265"></a>03265 
<a name="l03266"></a>03266             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(mem_info, <span class="keyword">sizeof</span>(mem_info), <span class="stringliteral">&quot;%i frames on disk&quot;</span>, totframes);
<a name="l03267"></a>03267         }
<a name="l03268"></a>03268     }
<a name="l03269"></a>03269     <span class="keywordflow">else</span> {
<a name="l03270"></a>03270         <a class="code" href="../../d0/d5b/structPTCacheMem.html">PTCacheMem</a> *pm = cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a52981831e4870022ca700f626e4aae02">mem_cache</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;        
<a name="l03271"></a>03271         <span class="keywordtype">float</span> bytes = 0.0f;
<a name="l03272"></a>03272         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, mb;
<a name="l03273"></a>03273         
<a name="l03274"></a>03274         <span class="keywordflow">for</span> (; pm; pm=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#aae9b8467a9815e66d4568c26d7569196">next</a>) {
<a name="l03275"></a>03275             <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d2/d60/DNA__object__force_8h.html#ad17b7c27ab6c314200ba5b6fe5d59e41">BPHYS_TOT_DATA</a>; i++)
<a name="l03276"></a>03276                 bytes += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a3e23164e2c5e315cbe28e185d046b616">data</a>[i]);
<a name="l03277"></a>03277 
<a name="l03278"></a>03278             <span class="keywordflow">for</span> (extra=pm-&gt;<a class="code" href="../../d0/d5b/structPTCacheMem.html#a85b85c1fd14f7a8d9c467857ae274907">extradata</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; extra; extra=extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a652f1bab30cf02b3519b372fc168c5bf">next</a>) {
<a name="l03279"></a>03279                 bytes += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(extra-&gt;<a class="code" href="../../d2/d97/structPTCacheExtra.html#a1cd2313d6b40822712c6d68e0ca2161e">data</a>);
<a name="l03280"></a>03280                 bytes += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#adfb3a719467876e6fa15a79be53fa510">PTCacheExtra</a>);
<a name="l03281"></a>03281             }
<a name="l03282"></a>03282 
<a name="l03283"></a>03283             bytes += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d60/DNA__object__force_8h.html#add680965027c2c68a9063db1bd99fc22">PTCacheMem</a>);
<a name="l03284"></a>03284             
<a name="l03285"></a>03285             totframes++;
<a name="l03286"></a>03286         }
<a name="l03287"></a>03287 
<a name="l03288"></a>03288         mb = (bytes &gt; 1024.0f * 1024.0f);
<a name="l03289"></a>03289 
<a name="l03290"></a>03290         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(mem_info, <span class="keyword">sizeof</span>(mem_info), <span class="stringliteral">&quot;%i frames in memory (%.1f %s)&quot;</span>,
<a name="l03291"></a>03291             totframes,
<a name="l03292"></a>03292             bytes / (mb ? 1024.0f * 1024.0f : 1024.0f),
<a name="l03293"></a>03293             mb ? <span class="stringliteral">&quot;Mb&quot;</span> : <span class="stringliteral">&quot;kb&quot;</span>);
<a name="l03294"></a>03294     }
<a name="l03295"></a>03295 
<a name="l03296"></a>03296     <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#ac268c1b0c0fa511a67c11bab2c8a0f77">PTCACHE_OUTDATED</a>) {
<a name="l03297"></a>03297         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;%s, cache is outdated!&quot;</span>, mem_info);
<a name="l03298"></a>03298     }
<a name="l03299"></a>03299     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp; <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a5dc55af889ae5c32ba1139f6ade21e6f">PTCACHE_FRAMES_SKIPPED</a>) {
<a name="l03300"></a>03300         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;%s, not exact since frame %i.&quot;</span>, mem_info, cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a>);
<a name="l03301"></a>03301     }
<a name="l03302"></a>03302     <span class="keywordflow">else</span> {
<a name="l03303"></a>03303         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>, <span class="keyword">sizeof</span>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a947f86d5377d9bf48cd1a7f52db4bfda">info</a>), <span class="stringliteral">&quot;%s.&quot;</span>, mem_info);
<a name="l03304"></a>03304     }
<a name="l03305"></a>03305 }
<a name="l03306"></a>03306 
<a name="l03307"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#af2ca67ba80342deb8ecfe8a1ce80dcba">03307</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#a5523459accb11b7c0900009bfed82717">BKE_ptcache_validate</a>(<a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache, <span class="keywordtype">int</span> framenr)
<a name="l03308"></a>03308 {
<a name="l03309"></a>03309     <span class="keywordflow">if</span> (cache) {
<a name="l03310"></a>03310         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> |= <a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>;
<a name="l03311"></a>03311         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a> = framenr;
<a name="l03312"></a>03312     }
<a name="l03313"></a>03313 }
<a name="l03314"></a><a class="code" href="../../d3/d9b/pointcache_8c.html#a2c9b2d428f7e15e6cb989f5f197d5d22">03314</a> <span class="keywordtype">void</span> <a class="code" href="../../db/d45/BKE__pointcache_8h.html#af2b22a63e401fc45edc2a7e53f98792f">BKE_ptcache_invalidate</a>(<a class="code" href="../../d6/d83/structPointCache.html">PointCache</a> *cache)
<a name="l03315"></a>03315 {
<a name="l03316"></a>03316     <span class="keywordflow">if</span> (cache) {
<a name="l03317"></a>03317         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#ae601ac8693d0881eb5da61700e84cf2d">flag</a> &amp;= ~<a class="code" href="../../d2/d60/DNA__object__force_8h.html#a45a84cafc6ce610ca944f1883fe2453a">PTCACHE_SIMULATION_VALID</a>;
<a name="l03318"></a>03318         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abdbf5f6b87b7cecaa23a0dce74c7ba8e">simframe</a> = 0;
<a name="l03319"></a>03319         cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#a824b743a9a0a323677702fe72b5fdb94">last_exact</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(cache-&gt;<a class="code" href="../../d6/d83/structPointCache.html#abb743923aa1e957b51cdaa4dc8edb329">startframe</a>, 0);
<a name="l03320"></a>03320     }
<a name="l03321"></a>03321 }
<a name="l03322"></a>03322 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:44 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
