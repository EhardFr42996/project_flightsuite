<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: math_geom.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">math_geom.c</div>  </div>
</div>
<div class="contents">
<a href="../../d3/d61/math__geom_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: some of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> * */</span>
<a name="l00025"></a>00025 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/********************************** Polygons *********************************/</span>
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8c4edc51f214e91cfb5bbeb5b581d1e6">00040</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a324f7ddc4d04ef772a00ef7b80cfdef3">cent_tri_v3</a>(<span class="keywordtype">float</span> cent[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042     cent[0] = 0.33333f * (v1[0] + v2[0] + v3[0]);
<a name="l00043"></a>00043     cent[1] = 0.33333f * (v1[1] + v2[1] + v3[1]);
<a name="l00044"></a>00044     cent[2] = 0.33333f * (v1[2] + v2[2] + v3[2]);
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="../../d3/d61/math__geom_8c.html#af1aa176339b02b0c2f80863b4bdf8343">00047</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a70e6123099c80ec0493c6a8412488f85">cent_quad_v3</a>(<span class="keywordtype">float</span> cent[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3])
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049     cent[0] = 0.25f * (v1[0] + v2[0] + v3[0] + v4[0]);
<a name="l00050"></a>00050     cent[1] = 0.25f * (v1[1] + v2[1] + v3[1] + v4[1]);
<a name="l00051"></a>00051     cent[2] = 0.25f * (v1[2] + v2[2] + v3[2] + v4[2]);
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ae622e943355e985e7dc261af3ccc53d7">00054</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(<span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056     <span class="keywordtype">float</span> n1[3], n2[3];
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     n1[0] = v1[0] - v2[0];
<a name="l00059"></a>00059     n2[0] = v2[0] - v3[0];
<a name="l00060"></a>00060     n1[1] = v1[1] - v2[1];
<a name="l00061"></a>00061     n2[1] = v2[1] - v3[1];
<a name="l00062"></a>00062     n1[2] = v1[2] - v2[2];
<a name="l00063"></a>00063     n2[2] = v2[2] - v3[2];
<a name="l00064"></a>00064     n[0] = n1[1] * n2[2] - n1[2] * n2[1];
<a name="l00065"></a>00065     n[1] = n1[2] * n2[0] - n1[0] * n2[2];
<a name="l00066"></a>00066     n[2] = n1[0] * n2[1] - n1[1] * n2[0];
<a name="l00067"></a>00067 
<a name="l00068"></a>00068     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a1b74c0120b88c5e42ca8caada84fe0f3">00071</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a79b270ef64d46a87c7739ff2042fb7db">normal_quad_v3</a>(<span class="keywordtype">float</span> n[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3])
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <span class="comment">/* real cross! */</span>
<a name="l00074"></a>00074     <span class="keywordtype">float</span> n1[3], n2[3];
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     n1[0] = v1[0] - v3[0];
<a name="l00077"></a>00077     n1[1] = v1[1] - v3[1];
<a name="l00078"></a>00078     n1[2] = v1[2] - v3[2];
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     n2[0] = v2[0] - v4[0];
<a name="l00081"></a>00081     n2[1] = v2[1] - v4[1];
<a name="l00082"></a>00082     n2[2] = v2[2] - v4[2];
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     n[0] = n1[1] * n2[2] - n1[2] * n2[1];
<a name="l00085"></a>00085     n[1] = n1[2] * n2[0] - n1[0] * n2[2];
<a name="l00086"></a>00086     n[2] = n1[0] * n2[1] - n1[1] * n2[0];
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="../../d3/d61/math__geom_8c.html#af2a7f796c90be7cc72a62b93a37fcda9">00091</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2])
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <span class="keywordflow">return</span> 0.5f * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>((v1[0] - v2[0]) * (v2[1] - v3[1]) + (v1[1] - v2[1]) * (v3[0] - v2[0]));
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">00096</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2])
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <span class="keywordflow">return</span> 0.5f * ((v1[0] - v2[0]) * (v2[1] - v3[1]) + (v1[1] - v2[1]) * (v3[0] - v2[0]));
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/* only convex Quadrilaterals */</span>
<a name="l00102"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aea7dc695a83b40bf98aab3df24bf8ad6">00102</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7051e542338c420d180a6c728a3952a8">area_quad_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3])
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, vec1[3], vec2[3], n[3];
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec1, v2, v1);
<a name="l00107"></a>00107     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec2, v4, v1);
<a name="l00108"></a>00108     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(n, vec1, vec2);
<a name="l00109"></a>00109     len = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec1, v4, v3);
<a name="l00112"></a>00112     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec2, v2, v3);
<a name="l00113"></a>00113     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(n, vec1, vec2);
<a name="l00114"></a>00114     len += <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="keywordflow">return</span> (len / 2.0f);
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="comment">/* Triangles */</span>
<a name="l00120"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a9dcebdd665a01993e36f9fd9dd5e94ef">00120</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, vec1[3], vec2[3], n[3];
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec1, v3, v2);
<a name="l00125"></a>00125     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vec2, v1, v2);
<a name="l00126"></a>00126     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(n, vec1, vec2);
<a name="l00127"></a>00127     len = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(n);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">return</span> (len / 2.0f);
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a401ed5a525de1661f5377c2af8a3aded">00132</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a401ed5a525de1661f5377c2af8a3aded">area_poly_v3</a>(<span class="keywordtype">int</span> nr, <span class="keywordtype">float</span> verts[][3], <span class="keyword">const</span> <span class="keywordtype">float</span> normal[3])
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keywordtype">float</span> x, y, z, area, <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>;
<a name="l00135"></a>00135     <span class="keywordtype">float</span> *cur, *prev;
<a name="l00136"></a>00136     <span class="keywordtype">int</span> a, px = 0, py = 1;
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">/* first: find dominant axis: 0==X, 1==Y, 2==Z</span>
<a name="l00139"></a>00139 <span class="comment">     * don&#39;t use &#39;axis_dominant_v3()&#39; because we need max axis too */</span>
<a name="l00140"></a>00140     x = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(normal[0]);
<a name="l00141"></a>00141     y = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(normal[1]);
<a name="l00142"></a>00142     z = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(normal[2]);
<a name="l00143"></a>00143     max = <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(x, y, z);
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (max == y) py = 2;
<a name="l00145"></a>00145     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (max == x) {
<a name="l00146"></a>00146         px = 1;
<a name="l00147"></a>00147         py = 2;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">/* The Trapezium Area Rule */</span>
<a name="l00151"></a>00151     prev = verts[nr - 1];
<a name="l00152"></a>00152     cur = verts[0];
<a name="l00153"></a>00153     area = 0;
<a name="l00154"></a>00154     <span class="keywordflow">for</span> (a = 0; a &lt; nr; a++) {
<a name="l00155"></a>00155         area += (cur[px] - prev[px]) * (cur[py] + prev[py]);
<a name="l00156"></a>00156         prev = verts[a];
<a name="l00157"></a>00157         cur = verts[a + 1];
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(0.5f * area / max);
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">/********************************* Distance **********************************/</span>
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">/* distance v1 to line v2-v3</span>
<a name="l00166"></a>00166 <span class="comment"> * using Hesse formula, NO LINE PIECE! */</span>
<a name="l00167"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a49905950d183e833c9c2907eabad6b16">00167</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aee9e9d32be8def7288500f2eda1512c5">dist_to_line_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2])
<a name="l00168"></a>00168 {
<a name="l00169"></a>00169     <span class="keywordtype">float</span> a[2], deler;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     a[0] = v2[1] - v3[1];
<a name="l00172"></a>00172     a[1] = v3[0] - v2[0];
<a name="l00173"></a>00173     deler = (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(a[0] * a[0] + a[1] * a[1]);
<a name="l00174"></a>00174     <span class="keywordflow">if</span> (deler == 0.0f) <span class="keywordflow">return</span> 0;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>((v1[0] - v2[0]) * a[0] + (v1[1] - v2[1]) * a[1]) / deler;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="comment">/* distance v1 to line-piece v2-v3 */</span>
<a name="l00181"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ad4cae70e02fca1e2e1a31a8428ed2ea8">00181</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acb707a79a8f4aaebf941caec9f14725a">dist_to_line_segment_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2])
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keywordtype">float</span> labda, rc[2], pt[2], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     rc[0] = v3[0] - v2[0];
<a name="l00186"></a>00186     rc[1] = v3[1] - v2[1];
<a name="l00187"></a>00187     len = rc[0] * rc[0] + rc[1] * rc[1];
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (len == 0.0f) {
<a name="l00189"></a>00189         rc[0] = v1[0] - v2[0];
<a name="l00190"></a>00190         rc[1] = v1[1] - v2[1];
<a name="l00191"></a>00191         <span class="keywordflow">return</span> (<span class="keywordtype">float</span>)(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(rc[0] * rc[0] + rc[1] * rc[1]));
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     labda = (rc[0] * (v1[0] - v2[0]) + rc[1] * (v1[1] - v2[1])) / len;
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (labda &lt;= 0.0f) {
<a name="l00196"></a>00196         pt[0] = v2[0];
<a name="l00197"></a>00197         pt[1] = v2[1];
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (labda &gt;= 1.0f) {
<a name="l00200"></a>00200         pt[0] = v3[0];
<a name="l00201"></a>00201         pt[1] = v3[1];
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203     <span class="keywordflow">else</span> {
<a name="l00204"></a>00204         pt[0] = labda * rc[0] + v2[0];
<a name="l00205"></a>00205         pt[1] = labda * rc[1] + v2[1];
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     rc[0] = pt[0] - v1[0];
<a name="l00209"></a>00209     rc[1] = pt[1] - v1[1];
<a name="l00210"></a>00210     <span class="keywordflow">return</span> <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(rc[0] * rc[0] + rc[1] * rc[1]);
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/* point closest to v1 on line v2-v3 in 2D */</span>
<a name="l00214"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ab247fbc68d60576d97762ddb13cb9a32">00214</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#adf0f114ba72423d7d4a85fee2afd8433">closest_to_line_segment_v2</a>(<span class="keywordtype">float</span> close_r[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[2])
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <span class="keywordtype">float</span> lambda, cp[2];
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     lambda = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00d439c1ac1a9593b794ebe8734358f5">closest_to_line_v2</a>(cp, p, l1, l2);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="keywordflow">if</span> (lambda &lt;= 0.0f)
<a name="l00221"></a>00221         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(close_r, l1);
<a name="l00222"></a>00222     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lambda &gt;= 1.0f)
<a name="l00223"></a>00223         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(close_r, l2);
<a name="l00224"></a>00224     <span class="keywordflow">else</span>
<a name="l00225"></a>00225         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(close_r, cp);
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">/* point closest to v1 on line v2-v3 in 3D */</span>
<a name="l00229"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a341de9d38c80180281a59cc178c03096">00229</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(<span class="keywordtype">float</span> close_r[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <span class="keywordtype">float</span> lambda, cp[3];
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     lambda = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(cp, v1, v2, v3);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (lambda &lt;= 0.0f)
<a name="l00236"></a>00236         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(close_r, v2);
<a name="l00237"></a>00237     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lambda &gt;= 1.0f)
<a name="l00238"></a>00238         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(close_r, v3);
<a name="l00239"></a>00239     <span class="keywordflow">else</span>
<a name="l00240"></a>00240         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(close_r, cp);
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* find the closest point on a plane to another point and store it in close_r</span>
<a name="l00244"></a>00244 <span class="comment"> * close_r:       return coordinate</span>
<a name="l00245"></a>00245 <span class="comment"> * plane_co:      a point on the plane</span>
<a name="l00246"></a>00246 <span class="comment"> * plane_no_unit: the plane&#39;s normal, and d is the last number in the plane equation 0 = ax + by + cz + d</span>
<a name="l00247"></a>00247 <span class="comment"> * pt:            the point that you want the nearest of</span>
<a name="l00248"></a>00248 <span class="comment"> */</span>
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a5207705be557fd29a0be16ef8f3c8102">00250</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5734c5c231da6faf98a8aae579a24df7">closest_to_plane_v3</a>(<span class="keywordtype">float</span> close_r[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_no_unit[3], <span class="keyword">const</span> <span class="keywordtype">float</span> pt[3])
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <span class="keywordtype">float</span> temp[3];
<a name="l00253"></a>00253     <span class="keywordtype">float</span> dotprod;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, pt, plane_co);
<a name="l00256"></a>00256     dotprod = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, plane_no_unit);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     close_r[0] = pt[0] - (plane_no_unit[0] * dotprod);
<a name="l00259"></a>00259     close_r[1] = pt[1] - (plane_no_unit[1] * dotprod);
<a name="l00260"></a>00260     close_r[2] = pt[2] - (plane_no_unit[2] * dotprod);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/* signed distance from the point to the plane in 3D */</span>
<a name="l00264"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a0c4922962aa573aa4ee99ddcef118043">00264</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a0c4922962aa573aa4ee99ddcef118043">dist_to_plane_normalized_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_no_unit[3])
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <span class="keywordtype">float</span> plane_co_other[3];
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(plane_co_other, plane_co, plane_no_unit);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#abe6676736ae17748b51b40cdb4e89171">line_point_factor_v3</a>(p, plane_co, plane_co_other);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ab780ebdccbb6130d50da6d1ecc2244c3">00273</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ab780ebdccbb6130d50da6d1ecc2244c3">dist_to_plane_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_no[3])
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <span class="keywordtype">float</span> plane_no_unit[3];
<a name="l00276"></a>00276     <span class="keywordtype">float</span> plane_co_other[3];
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(plane_no_unit, plane_no);
<a name="l00279"></a>00279     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(plane_co_other, plane_co, plane_no_unit);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#abe6676736ae17748b51b40cdb4e89171">line_point_factor_v3</a>(p, plane_co, plane_co_other);
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment">/* distance v1 to line-piece v2-v3 in 3D */</span>
<a name="l00285"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ad08663ca52916a7efff8561c24c6e7c9">00285</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a642580e9046645377dc5520817657eb5">dist_to_line_segment_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     <span class="keywordtype">float</span> closest[3];
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(closest, v1, v2, v3);
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(closest, v1);
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="comment">/******************************* Intersection ********************************/</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="comment">/* intersect Line-Line, shorts */</span>
<a name="l00297"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ac0359f7d6db669bc8b4e69a654e93608">00297</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ad72843e53f61ff9cb6bad080c957d156">isect_line_line_v2_int</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">int</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">int</span> v3[2], <span class="keyword">const</span> <span class="keywordtype">int</span> v4[2])
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, labda, mu;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     div = (float)((v2[0] - v1[0]) * (v4[1] - v3[1]) - (v2[1] - v1[1]) * (v4[0] - v3[0]));
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (div == 0.0f) <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6e081704c7a62cc4ee245a736d28e79d">ISECT_LINE_LINE_COLINEAR</a>;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     labda = ((float)(v1[1] - v3[1]) * (v4[0] - v3[0]) - (v1[0] - v3[0]) * (v4[1] - v3[1])) / <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     mu = ((float)(v1[1] - v3[1]) * (v2[0] - v1[0]) - (v1[0] - v3[0]) * (v2[1] - v1[1])) / <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="keywordflow">if</span> (labda &gt;= 0.0f &amp;&amp; labda &lt;= 1.0f &amp;&amp; mu &gt;= 0.0f &amp;&amp; mu &lt;= 1.0f) {
<a name="l00309"></a>00309         <span class="keywordflow">if</span> (labda == 0.0f || labda == 1.0f || mu == 0.0f || mu == 1.0f) <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ad6128bee35a1ec1866e880211376a252">ISECT_LINE_LINE_EXACT</a>;
<a name="l00310"></a>00310         <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#afbaec0e177628194c3b7a13b9cbdbe10">ISECT_LINE_LINE_CROSS</a>;
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a42cb33808669d8555ac629dc13d2ce37">ISECT_LINE_LINE_NONE</a>;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="comment">/* intersect Line-Line, floats */</span>
<a name="l00316"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aa4c22644ba01e30885ebf2477ebf7076">00316</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[2])
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <span class="keywordtype">float</span> <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, labda, mu;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     div = (v2[0] - v1[0]) * (v4[1] - v3[1]) - (v2[1] - v1[1]) * (v4[0] - v3[0]);
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (div == 0.0f) <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6e081704c7a62cc4ee245a736d28e79d">ISECT_LINE_LINE_COLINEAR</a>;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     labda = ((float)(v1[1] - v3[1]) * (v4[0] - v3[0]) - (v1[0] - v3[0]) * (v4[1] - v3[1])) / <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     mu = ((float)(v1[1] - v3[1]) * (v2[0] - v1[0]) - (v1[0] - v3[0]) * (v2[1] - v1[1])) / <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (labda &gt;= 0.0f &amp;&amp; labda &lt;= 1.0f &amp;&amp; mu &gt;= 0.0f &amp;&amp; mu &lt;= 1.0f) {
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (labda == 0.0f || labda == 1.0f || mu == 0.0f || mu == 1.0f) <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ad6128bee35a1ec1866e880211376a252">ISECT_LINE_LINE_EXACT</a>;
<a name="l00329"></a>00329         <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#afbaec0e177628194c3b7a13b9cbdbe10">ISECT_LINE_LINE_CROSS</a>;
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a42cb33808669d8555ac629dc13d2ce37">ISECT_LINE_LINE_NONE</a>;
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment">/* get intersection point of two 2D segments and return intersection type:</span>
<a name="l00335"></a>00335 <span class="comment"> *  -1: colliniar</span>
<a name="l00336"></a>00336 <span class="comment"> *   1: intersection</span>
<a name="l00337"></a>00337 <span class="comment"> */</span>
<a name="l00338"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a30d976b5dd56a7b4862ec98a25809e22">00338</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a30d976b5dd56a7b4862ec98a25809e22">isect_seg_seg_v2_point</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[2], <span class="keywordtype">float</span> vi[2])
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <span class="keywordtype">float</span> a1, a2, b1, b2, c1, c2, d;
<a name="l00341"></a>00341     <span class="keywordtype">float</span> u, v;
<a name="l00342"></a>00342     <span class="keyword">const</span> <span class="keywordtype">float</span> eps = 0.000001f;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     a1 = v2[0] - v1[0];
<a name="l00345"></a>00345     b1 = v4[0] - v3[0];
<a name="l00346"></a>00346     c1 = v1[0] - v4[0];
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     a2 = v2[1] - v1[1];
<a name="l00349"></a>00349     b2 = v4[1] - v3[1];
<a name="l00350"></a>00350     c2 = v1[1] - v4[1];
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     d = a1 * b2 - a2 * b1;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (d == 0) {
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (a1 * c2 - a2 * c1 == 0.0f &amp;&amp; b1 * c2 - b2 * c1 == 0.0f) { <span class="comment">/* equal lines */</span>
<a name="l00356"></a>00356             <span class="keywordtype">float</span> a[2], b[2], c[2];
<a name="l00357"></a>00357             <span class="keywordtype">float</span> u2;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(v1, v2) == 0.0f) {
<a name="l00360"></a>00360                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(v3, v4) &gt; eps) {
<a name="l00361"></a>00361                     <span class="comment">/* use non-point segment as basis */</span>
<a name="l00362"></a>00362                     <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> *, v1, v3);
<a name="l00363"></a>00363                     <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> *, v2, v4);
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365                 <span class="keywordflow">else</span> { <span class="comment">/* both of segments are points */</span>
<a name="l00366"></a>00366                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9b1c3fb8b00d40f6dffea903069fd94a">equals_v2v2</a>(v1, v3)) { <span class="comment">/* points are equal */</span>
<a name="l00367"></a>00367                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(vi, v1);
<a name="l00368"></a>00368                         <span class="keywordflow">return</span> 1;
<a name="l00369"></a>00369                     }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371                     <span class="comment">/* two different points */</span>
<a name="l00372"></a>00372                     <span class="keywordflow">return</span> -1;
<a name="l00373"></a>00373                 }
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(a, v3, v1);
<a name="l00377"></a>00377             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(b, v2, v1);
<a name="l00378"></a>00378             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(c, v2, v1);
<a name="l00379"></a>00379             u = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(a, b) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(c, c);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(a, v4, v1);
<a name="l00382"></a>00382             u2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(a, b) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(c, c);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384             <span class="keywordflow">if</span> (u &gt; u2) <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, u, u2);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (u &gt; 1.0f + eps || u2 &lt; -eps) <span class="keywordflow">return</span> -1;  <span class="comment">/* non-ovlerlapping segments */</span>
<a name="l00387"></a>00387             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(0.0f, u) == <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a6662c4add3c6f2e4b3a5ab8526d0fb67">minf</a>(1.0f, u2)) { <span class="comment">/* one common point: can return result */</span>
<a name="l00388"></a>00388                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(vi, v1, v2, <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a46e8c3b77f29f3db28088953cebcb43f">maxf</a>(0, u));
<a name="l00389"></a>00389                 <span class="keywordflow">return</span> 1;
<a name="l00390"></a>00390             }
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393         <span class="comment">/* lines are colliniar */</span>
<a name="l00394"></a>00394         <span class="keywordflow">return</span> -1;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     u = (c2 * b1 - b2 * c1) / d;
<a name="l00398"></a>00398     v = (c1 * a2 - a1 * c2) / d;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (u &gt;= -eps &amp;&amp; u &lt;= 1.0f + eps &amp;&amp; v &gt;= -eps &amp;&amp; v &lt;= 1.0f + eps) { <span class="comment">/* intersection */</span>
<a name="l00401"></a>00401         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0fc9c9886095f92d83a29d65fef64ae3">interp_v2_v2v2</a>(vi, v1, v2, u);
<a name="l00402"></a>00402         <span class="keywordflow">return</span> 1;
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="comment">/* out of segment intersection */</span>
<a name="l00406"></a>00406     <span class="keywordflow">return</span> -1;
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aa2a88d0d1c20da43d3a072b8b5d493a9">00409</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aa2a88d0d1c20da43d3a072b8b5d493a9">isect_line_sphere_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> l1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[3],
<a name="l00410"></a>00410                          <span class="keyword">const</span> <span class="keywordtype">float</span> sp[3], <span class="keyword">const</span> <span class="keywordtype">float</span> r,
<a name="l00411"></a>00411                          <span class="keywordtype">float</span> r_p1[3], <span class="keywordtype">float</span> r_p2[3])
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <span class="comment">/* l1:         coordinates (point of line)</span>
<a name="l00414"></a>00414 <span class="comment">     * l2:         coordinates (point of line)</span>
<a name="l00415"></a>00415 <span class="comment">     * sp, r:      coordinates and radius (sphere)</span>
<a name="l00416"></a>00416 <span class="comment">     * r_p1, r_p2: return intersection coordinates</span>
<a name="l00417"></a>00417 <span class="comment">     */</span>
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="comment">/* adapted for use in blender by Campbell Barton - 2011</span>
<a name="l00421"></a>00421 <span class="comment">     *</span>
<a name="l00422"></a>00422 <span class="comment">     * atelier iebele abel - 2001</span>
<a name="l00423"></a>00423 <span class="comment">     * atelier@iebele.nl</span>
<a name="l00424"></a>00424 <span class="comment">     * http://www.iebele.nl</span>
<a name="l00425"></a>00425 <span class="comment">     *</span>
<a name="l00426"></a>00426 <span class="comment">     * sphere_line_intersection function adapted from:</span>
<a name="l00427"></a>00427 <span class="comment">     * http://astronomy.swin.edu.au/pbourke/geometry/sphereline</span>
<a name="l00428"></a>00428 <span class="comment">     * Paul Bourke pbourke@swin.edu.au</span>
<a name="l00429"></a>00429 <span class="comment">     */</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431     <span class="keyword">const</span> <span class="keywordtype">float</span> ldir[3] = {
<a name="l00432"></a>00432         l2[0] - l1[0],
<a name="l00433"></a>00433         l2[1] - l1[1],
<a name="l00434"></a>00434         l2[2] - l1[2]
<a name="l00435"></a>00435     };
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keyword">const</span> <span class="keywordtype">float</span> a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ldir, ldir);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keyword">const</span> <span class="keywordtype">float</span> b = 2.0f *
<a name="l00440"></a>00440             (ldir[0] * (l1[0] - sp[0]) +
<a name="l00441"></a>00441              ldir[1] * (l1[1] - sp[1]) +
<a name="l00442"></a>00442              ldir[2] * (l1[2] - sp[2]));
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keyword">const</span> <span class="keywordtype">float</span> c =
<a name="l00445"></a>00445             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(sp, sp) +
<a name="l00446"></a>00446             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(l1, l1) -
<a name="l00447"></a>00447             (2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(sp, l1)) -
<a name="l00448"></a>00448             (r * r);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = b * b - 4.0f * a * c;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordtype">float</span> mu;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (i &lt; 0.0f) {
<a name="l00455"></a>00455         <span class="comment">/* no intersections */</span>
<a name="l00456"></a>00456         <span class="keywordflow">return</span> 0;
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0.0f) {
<a name="l00459"></a>00459         <span class="comment">/* one intersection */</span>
<a name="l00460"></a>00460         mu = -b / (2.0f * a);
<a name="l00461"></a>00461         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(r_p1, l1, ldir, mu);
<a name="l00462"></a>00462         <span class="keywordflow">return</span> 1;
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &gt; 0.0f) {
<a name="l00465"></a>00465         <span class="keyword">const</span> <span class="keywordtype">float</span> i_sqrt = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(i); <span class="comment">/* avoid calc twice */</span>
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         <span class="comment">/* first intersection */</span>
<a name="l00468"></a>00468         mu = (-b + i_sqrt) / (2.0f * a);
<a name="l00469"></a>00469         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(r_p1, l1, ldir, mu);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         <span class="comment">/* second intersection */</span>
<a name="l00472"></a>00472         mu = (-b - i_sqrt) / (2.0f * a);
<a name="l00473"></a>00473         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(r_p2, l1, ldir, mu);
<a name="l00474"></a>00474         <span class="keywordflow">return</span> 2;
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476     <span class="keywordflow">else</span> {
<a name="l00477"></a>00477         <span class="comment">/* math domain error - nan */</span>
<a name="l00478"></a>00478         <span class="keywordflow">return</span> -1;
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment">/* keep in sync with isect_line_sphere_v3 */</span>
<a name="l00483"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ab7f845557f36e53ad0582d92154179b6">00483</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ab7f845557f36e53ad0582d92154179b6">isect_line_sphere_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> l1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[2],
<a name="l00484"></a>00484                          <span class="keyword">const</span> <span class="keywordtype">float</span> sp[2], <span class="keyword">const</span> <span class="keywordtype">float</span> r,
<a name="l00485"></a>00485                          <span class="keywordtype">float</span> r_p1[2], <span class="keywordtype">float</span> r_p2[2])
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <span class="keyword">const</span> <span class="keywordtype">float</span> ldir[2] = {l2[0] - l1[0],
<a name="l00488"></a>00488                            l2[1] - l1[1]};
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="keyword">const</span> <span class="keywordtype">float</span> a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(ldir, ldir);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keyword">const</span> <span class="keywordtype">float</span> b = 2.0f *
<a name="l00493"></a>00493             (ldir[0] * (l1[0] - sp[0]) +
<a name="l00494"></a>00494              ldir[1] * (l1[1] - sp[1]));
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keyword">const</span> <span class="keywordtype">float</span> c =
<a name="l00497"></a>00497             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(sp, sp) +
<a name="l00498"></a>00498             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(l1, l1) -
<a name="l00499"></a>00499             (2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(sp, l1)) -
<a name="l00500"></a>00500             (r * r);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = b * b - 4.0f * a * c;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="keywordtype">float</span> mu;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     <span class="keywordflow">if</span> (i &lt; 0.0f) {
<a name="l00507"></a>00507         <span class="comment">/* no intersections */</span>
<a name="l00508"></a>00508         <span class="keywordflow">return</span> 0;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0.0f) {
<a name="l00511"></a>00511         <span class="comment">/* one intersection */</span>
<a name="l00512"></a>00512         mu = -b / (2.0f * a);
<a name="l00513"></a>00513         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a218a17997f38270105521035d564589d">madd_v2_v2v2fl</a>(r_p1, l1, ldir, mu);
<a name="l00514"></a>00514         <span class="keywordflow">return</span> 1;
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &gt; 0.0f) {
<a name="l00517"></a>00517         <span class="keyword">const</span> <span class="keywordtype">float</span> i_sqrt = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(i); <span class="comment">/* avoid calc twice */</span>
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="comment">/* first intersection */</span>
<a name="l00520"></a>00520         mu = (-b + i_sqrt) / (2.0f * a);
<a name="l00521"></a>00521         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a218a17997f38270105521035d564589d">madd_v2_v2v2fl</a>(r_p1, l1, ldir, mu);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="comment">/* second intersection */</span>
<a name="l00524"></a>00524         mu = (-b - i_sqrt) / (2.0f * a);
<a name="l00525"></a>00525         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a218a17997f38270105521035d564589d">madd_v2_v2v2fl</a>(r_p2, l1, ldir, mu);
<a name="l00526"></a>00526         <span class="keywordflow">return</span> 2;
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528     <span class="keywordflow">else</span> {
<a name="l00529"></a>00529         <span class="comment">/* math domain error - nan */</span>
<a name="l00530"></a>00530         <span class="keywordflow">return</span> -1;
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="comment">/*</span>
<a name="l00535"></a>00535 <span class="comment"> * -1: colliniar</span>
<a name="l00536"></a>00536 <span class="comment"> *  1: intersection</span>
<a name="l00537"></a>00537 <span class="comment"> */</span>
<a name="l00538"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">00538</a> <span class="keyword">static</span> <span class="keywordtype">short</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">IsectLLPt2Df</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> x0, <span class="keyword">const</span> <span class="keywordtype">float</span> y0, <span class="keyword">const</span> <span class="keywordtype">float</span> x1, <span class="keyword">const</span> <span class="keywordtype">float</span> y1,
<a name="l00539"></a>00539                           <span class="keyword">const</span> <span class="keywordtype">float</span> x2, <span class="keyword">const</span> <span class="keywordtype">float</span> y2, <span class="keyword">const</span> <span class="keywordtype">float</span> x3, <span class="keyword">const</span> <span class="keywordtype">float</span> y3, <span class="keywordtype">float</span> *xi, <span class="keywordtype">float</span> *yi)
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="comment">/*</span>
<a name="l00543"></a>00543 <span class="comment">     * this function computes the intersection of the sent lines</span>
<a name="l00544"></a>00544 <span class="comment">     * and returns the intersection point, note that the function assumes</span>
<a name="l00545"></a>00545 <span class="comment">     * the lines intersect. the function can handle vertical as well</span>
<a name="l00546"></a>00546 <span class="comment">     * as horizontal lines. note the function isn&#39;t very clever, it simply</span>
<a name="l00547"></a>00547 <span class="comment">     * applies the math, but we don&#39;t need speed since this is a</span>
<a name="l00548"></a>00548 <span class="comment">     * pre-processing step</span>
<a name="l00549"></a>00549 <span class="comment">     */</span>
<a name="l00550"></a>00550     <span class="keywordtype">float</span> c1, c2; <span class="comment">/* constants of linear equations */</span>
<a name="l00551"></a>00551     <span class="keywordtype">float</span> det_inv; <span class="comment">/* the inverse of the determinant of the coefficient */</span>
<a name="l00552"></a>00552     <span class="keywordtype">float</span> m1, m2; <span class="comment">/* the slopes of each line */</span>
<a name="l00553"></a>00553     <span class="comment">/*</span>
<a name="l00554"></a>00554 <span class="comment">     * compute slopes, note the cludge for infinity, however, this will</span>
<a name="l00555"></a>00555 <span class="comment">     * be close enough</span>
<a name="l00556"></a>00556 <span class="comment">     */</span>
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(x1 - x0) &gt; 0.000001)
<a name="l00558"></a>00558         m1 = (y1 - y0) / (x1 - x0);
<a name="l00559"></a>00559     <span class="keywordflow">else</span>
<a name="l00560"></a>00560         <span class="keywordflow">return</span> -1; <span class="comment">/*m1 = (float)1e+10;*/</span> <span class="comment">// close enough to infinity</span>
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(x3 - x2) &gt; 0.000001)
<a name="l00563"></a>00563         m2 = (y3 - y2) / (x3 - x2);
<a name="l00564"></a>00564     <span class="keywordflow">else</span>
<a name="l00565"></a>00565         <span class="keywordflow">return</span> -1; <span class="comment">/*m2 = (float)1e+10;*/</span> <span class="comment">// close enough to infinity</span>
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(m1 - m2) &lt; 0.000001)
<a name="l00568"></a>00568         <span class="keywordflow">return</span> -1;  <span class="comment">/* parallel lines */</span>
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="comment">// compute constants</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     c1 = (y0 - m1 * x0);
<a name="l00573"></a>00573     c2 = (y2 - m2 * x2);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="comment">// compute the inverse of the determinate</span>
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     det_inv = 1.0f / (-m1 + m2);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="comment">// use Kramers rule to compute xi and yi</span>
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     *xi = ((-c2 + c1) * det_inv);
<a name="l00582"></a>00582     *yi = ((m2 * c1 - m1 * c2) * det_inv);
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">return</span> 1;
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="comment">/* point in tri */</span>
<a name="l00588"></a>00588 
<a name="l00589"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ae5dad18260c602d825381ed5037f25dd">00589</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2])
<a name="l00590"></a>00590 {
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v1, v2, pt) &gt;= 0.0f) {
<a name="l00592"></a>00592         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v2, v3, pt) &gt;= 0.0f) {
<a name="l00593"></a>00593             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v3, v1, pt) &gt;= 0.0f) {
<a name="l00594"></a>00594                 <span class="keywordflow">return</span> 1;
<a name="l00595"></a>00595             }
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598     <span class="keywordflow">else</span> {
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v2, v3, pt) &gt;= 0.0f)) {
<a name="l00600"></a>00600             <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v3, v1, pt) &gt;= 0.0f)) {
<a name="l00601"></a>00601                 <span class="keywordflow">return</span> -1;
<a name="l00602"></a>00602             }
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="keywordflow">return</span> 0;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="comment">/* point in quad - only convex quads */</span>
<a name="l00610"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7cd5b834a7d223a512eda854956fd39e">00610</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaac3d8b89d9d1eb75b994db45675e82b">isect_point_quad_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[2])
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v1, v2, pt) &gt;= 0.0f) {
<a name="l00613"></a>00613         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v2, v3, pt) &gt;= 0.0f) {
<a name="l00614"></a>00614             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v3, v4, pt) &gt;= 0.0f) {
<a name="l00615"></a>00615                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v4, v1, pt) &gt;= 0.0f) {
<a name="l00616"></a>00616                     <span class="keywordflow">return</span> 1;
<a name="l00617"></a>00617                 }
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621     <span class="keywordflow">else</span> {
<a name="l00622"></a>00622         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v2, v3, pt) &gt;= 0.0f)) {
<a name="l00623"></a>00623             <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v3, v4, pt) &gt;= 0.0f)) {
<a name="l00624"></a>00624                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#add9c817e9a33440a66811533cccb45cc">line_point_side_v2</a>(v4, v1, pt) &gt;= 0.0f)) {
<a name="l00625"></a>00625                     <span class="keywordflow">return</span> -1;
<a name="l00626"></a>00626                 }
<a name="l00627"></a>00627             }
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="keywordflow">return</span> 0;
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="comment">/* moved from effect.c</span>
<a name="l00635"></a>00635 <span class="comment"> * test if the line starting at p1 ending at p2 intersects the triangle v0..v2</span>
<a name="l00636"></a>00636 <span class="comment"> * return non zero if it does</span>
<a name="l00637"></a>00637 <span class="comment"> */</span>
<a name="l00638"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a69853822f1e463f7142dcc6f987043b9">00638</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[3],
<a name="l00639"></a>00639                       <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00640"></a>00640                       <span class="keywordtype">float</span> *r_lambda, <span class="keywordtype">float</span> r_uv[2])
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], s[3], d[3], e1[3], e2[3], q[3];
<a name="l00644"></a>00644     <span class="keywordtype">float</span> a, f, u, v;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00647"></a>00647     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00648"></a>00648     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d, p2, p1);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(p, d, e2);
<a name="l00651"></a>00651     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p);
<a name="l00652"></a>00652     <span class="keywordflow">if</span> ((a &gt; -0.000001f) &amp;&amp; (a &lt; 0.000001f)) <span class="keywordflow">return</span> 0;
<a name="l00653"></a>00653     f = 1.0f / a;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, p1, v0);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     u = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(s, p);
<a name="l00658"></a>00658     <span class="keywordflow">if</span> ((u &lt; 0.0f) || (u &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(q, s, e1);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     v = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, q);
<a name="l00663"></a>00663     <span class="keywordflow">if</span> ((v &lt; 0.0f) || ((u + v) &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     *r_lambda = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, q);
<a name="l00666"></a>00666     <span class="keywordflow">if</span> ((*r_lambda &lt; 0.0f) || (*r_lambda &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (r_uv) {
<a name="l00669"></a>00669         r_uv[0] = u;
<a name="l00670"></a>00670         r_uv[1] = v;
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="keywordflow">return</span> 1;
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="comment">/* moved from effect.c</span>
<a name="l00677"></a>00677 <span class="comment"> * test if the ray starting at p1 going in d direction intersects the triangle v0..v2</span>
<a name="l00678"></a>00678 <span class="comment"> * return non zero if it does</span>
<a name="l00679"></a>00679 <span class="comment"> */</span>
<a name="l00680"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aad526aed8e2821b758ed612e91ce2e0b">00680</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aad526aed8e2821b758ed612e91ce2e0b">isect_ray_tri_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> d[3],
<a name="l00681"></a>00681                      <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00682"></a>00682                      <span class="keywordtype">float</span> *r_lambda, <span class="keywordtype">float</span> r_uv[2])
<a name="l00683"></a>00683 {
<a name="l00684"></a>00684     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], s[3], e1[3], e2[3], q[3];
<a name="l00685"></a>00685     <span class="keywordtype">float</span> a, f, u, v;
<a name="l00686"></a>00686 
<a name="l00687"></a>00687     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00688"></a>00688     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(p, d, e2);
<a name="l00691"></a>00691     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p);
<a name="l00692"></a>00692     <span class="comment">/* note: these values were 0.000001 in 2.4x but for projection snapping on</span>
<a name="l00693"></a>00693 <span class="comment">     * a human head (1BU==1m), subsurf level 2, this gave many errors - campbell */</span>
<a name="l00694"></a>00694     <span class="keywordflow">if</span> ((a &gt; -0.00000001f) &amp;&amp; (a &lt; 0.00000001f)) <span class="keywordflow">return</span> 0;
<a name="l00695"></a>00695     f = 1.0f / a;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, p1, v0);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     u = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(s, p);
<a name="l00700"></a>00700     <span class="keywordflow">if</span> ((u &lt; 0.0f) || (u &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(q, s, e1);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     v = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, q);
<a name="l00705"></a>00705     <span class="keywordflow">if</span> ((v &lt; 0.0f) || ((u + v) &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     *r_lambda = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, q);
<a name="l00708"></a>00708     <span class="keywordflow">if</span> ((*r_lambda &lt; 0.0f)) <span class="keywordflow">return</span> 0;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (r_uv) {
<a name="l00711"></a>00711         r_uv[0] = u;
<a name="l00712"></a>00712         r_uv[1] = v;
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     <span class="keywordflow">return</span> 1;
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a1322e10c122ba046b1c7c2f1b7e606a5">00718</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1322e10c122ba046b1c7c2f1b7e606a5">isect_ray_plane_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> d[3],
<a name="l00719"></a>00719                        <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00720"></a>00720                        <span class="keywordtype">float</span> *r_lambda, <span class="keyword">const</span> <span class="keywordtype">int</span> clip)
<a name="l00721"></a>00721 {
<a name="l00722"></a>00722     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], s[3], e1[3], e2[3], q[3];
<a name="l00723"></a>00723     <span class="keywordtype">float</span> a, f;
<a name="l00724"></a>00724     <span class="comment">/* float  u, v; */</span> <span class="comment">/*UNUSED*/</span>
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00727"></a>00727     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(p, d, e2);
<a name="l00730"></a>00730     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p);
<a name="l00731"></a>00731     <span class="comment">/* note: these values were 0.000001 in 2.4x but for projection snapping on</span>
<a name="l00732"></a>00732 <span class="comment">     * a human head (1BU==1m), subsurf level 2, this gave many errors - campbell */</span>
<a name="l00733"></a>00733     <span class="keywordflow">if</span> ((a &gt; -0.00000001f) &amp;&amp; (a &lt; 0.00000001f)) <span class="keywordflow">return</span> 0;
<a name="l00734"></a>00734     f = 1.0f / a;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, p1, v0);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">/* u = f * dot_v3v3(s, p); */</span> <span class="comment">/*UNUSED*/</span>
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(q, s, e1);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="comment">/* v = f * dot_v3v3(d, q); */</span> <span class="comment">/*UNUSED*/</span>
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     *r_lambda = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, q);
<a name="l00745"></a>00745     <span class="keywordflow">if</span> (clip &amp;&amp; (*r_lambda &lt; 0.0f)) <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="keywordflow">return</span> 1;
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a28987ec9ffef04b714963b866842c3b7">00750</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ab4fddf2266650b5bde24ef1570e61cab">isect_ray_tri_epsilon_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> d[3],
<a name="l00751"></a>00751                              <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00752"></a>00752                              <span class="keywordtype">float</span> *r_lambda, <span class="keywordtype">float</span> uv[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a>)
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], s[3], e1[3], e2[3], q[3];
<a name="l00755"></a>00755     <span class="keywordtype">float</span> a, f, u, v;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00758"></a>00758     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00759"></a>00759 
<a name="l00760"></a>00760     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(p, d, e2);
<a name="l00761"></a>00761     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p);
<a name="l00762"></a>00762     <span class="keywordflow">if</span> (a == 0.0f) <span class="keywordflow">return</span> 0;
<a name="l00763"></a>00763     f = 1.0f / a;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, p1, v0);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767     u = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(s, p);
<a name="l00768"></a>00768     <span class="keywordflow">if</span> ((u &lt; -epsilon) || (u &gt; 1.0f + epsilon)) <span class="keywordflow">return</span> 0;
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(q, s, e1);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     v = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, q);
<a name="l00773"></a>00773     <span class="keywordflow">if</span> ((v &lt; -epsilon) || ((u + v) &gt; 1.0f + epsilon)) <span class="keywordflow">return</span> 0;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     *r_lambda = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, q);
<a name="l00776"></a>00776     <span class="keywordflow">if</span> ((*r_lambda &lt; 0.0f)) <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (uv) {
<a name="l00779"></a>00779         uv[0] = u;
<a name="l00780"></a>00780         uv[1] = v;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="keywordflow">return</span> 1;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00786"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8c89d506d78d26912d4f29deb9d11588">00786</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8c89d506d78d26912d4f29deb9d11588">isect_ray_tri_threshold_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> d[3],
<a name="l00787"></a>00787                                <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00788"></a>00788                                <span class="keywordtype">float</span> *r_lambda, <span class="keywordtype">float</span> r_uv[2], <span class="keyword">const</span> <span class="keywordtype">float</span> threshold)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], s[3], e1[3], e2[3], q[3];
<a name="l00791"></a>00791     <span class="keywordtype">float</span> a, f, u, v;
<a name="l00792"></a>00792     <span class="keywordtype">float</span> du = 0, dv = 0;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00795"></a>00795     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(p, d, e2);
<a name="l00798"></a>00798     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, p);
<a name="l00799"></a>00799     <span class="keywordflow">if</span> ((a &gt; -0.000001f) &amp;&amp; (a &lt; 0.000001f)) <span class="keywordflow">return</span> 0;
<a name="l00800"></a>00800     f = 1.0f / a;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(s, p1, v0);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(q, s, e1);
<a name="l00805"></a>00805     *r_lambda = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, q);
<a name="l00806"></a>00806     <span class="keywordflow">if</span> ((*r_lambda &lt; 0.0f)) <span class="keywordflow">return</span> 0;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     u = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(s, p);
<a name="l00809"></a>00809     v = f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d, q);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="keywordflow">if</span> (u &lt; 0) du = u;
<a name="l00812"></a>00812     <span class="keywordflow">if</span> (u &gt; 1) du = u - 1;
<a name="l00813"></a>00813     <span class="keywordflow">if</span> (v &lt; 0) dv = v;
<a name="l00814"></a>00814     <span class="keywordflow">if</span> (v &gt; 1) dv = v - 1;
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (u &gt; 0 &amp;&amp; v &gt; 0 &amp;&amp; u + v &gt; 1) {
<a name="l00816"></a>00816         <span class="keywordtype">float</span> t = u + v - 1;
<a name="l00817"></a>00817         du = u - t / 2;
<a name="l00818"></a>00818         dv = v - t / 2;
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(e1, du);
<a name="l00822"></a>00822     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(e2, dv);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e1) + <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, e2) &gt; threshold * threshold) {
<a name="l00825"></a>00825         <span class="keywordflow">return</span> 0;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (r_uv) {
<a name="l00829"></a>00829         r_uv[0] = u;
<a name="l00830"></a>00830         r_uv[1] = v;
<a name="l00831"></a>00831     }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="keywordflow">return</span> 1;
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 
<a name="l00836"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a3fe81d8eae080a54d26703ce98b5575e">00836</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3fe81d8eae080a54d26703ce98b5575e">isect_line_plane_v3</a>(<span class="keywordtype">float</span> out[3],
<a name="l00837"></a>00837                         <span class="keyword">const</span> <span class="keywordtype">float</span> l1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[3],
<a name="l00838"></a>00838                         <span class="keyword">const</span> <span class="keywordtype">float</span> plane_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_no[3], <span class="keyword">const</span> <span class="keywordtype">short</span> no_flip)
<a name="l00839"></a>00839 {
<a name="l00840"></a>00840     <span class="keywordtype">float</span> l_vec[3]; <span class="comment">/* l1 -&gt; l2 normalized vector */</span>
<a name="l00841"></a>00841     <span class="keywordtype">float</span> p_no[3]; <span class="comment">/* &#39;plane_no&#39; normalized */</span>
<a name="l00842"></a>00842     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(l_vec, l2, l1);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(l_vec);
<a name="l00847"></a>00847     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(p_no, plane_no);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(l_vec, p_no);
<a name="l00850"></a>00850     <span class="keywordflow">if</span> (dot == 0.0f) {
<a name="l00851"></a>00851         <span class="keywordflow">return</span> 0;
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853     <span class="keywordflow">else</span> {
<a name="l00854"></a>00854         <span class="keywordtype">float</span> l1_plane[3]; <span class="comment">/* line point aligned with the plane */</span>
<a name="l00855"></a>00855         <span class="keywordtype">float</span> dist; <span class="comment">/* &#39;plane_no&#39; aligned distance to the &#39;plane_co&#39; */</span>
<a name="l00856"></a>00856 
<a name="l00857"></a>00857         <span class="comment">/* for predictable flipping since the plane is only used to</span>
<a name="l00858"></a>00858 <span class="comment">         * define a direction, ignore its flipping and aligned with &#39;l_vec&#39; */</span>
<a name="l00859"></a>00859         <span class="keywordflow">if</span> (dot &lt; 0.0f) {
<a name="l00860"></a>00860             dot = -<a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>;
<a name="l00861"></a>00861             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(p_no);
<a name="l00862"></a>00862         }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(l1_plane, l1, p_no);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         dist = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#abe6676736ae17748b51b40cdb4e89171">line_point_factor_v3</a>(plane_co, l1, l1_plane);
<a name="l00867"></a>00867 
<a name="l00868"></a>00868         <span class="comment">/* treat line like a ray, when &#39;no_flip&#39; is set */</span>
<a name="l00869"></a>00869         <span class="keywordflow">if</span> (no_flip &amp;&amp; dist &lt; 0.0f) {
<a name="l00870"></a>00870             dist = -dist;
<a name="l00871"></a>00871         }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(l_vec, dist / dot);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(out, l1, l_vec);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877         <span class="keywordflow">return</span> 1;
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 <span class="comment">/* note: return normal isn&#39;t unit length */</span>
<a name="l00882"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ac97125caaba32c7301db50cd76e80bc8">00882</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ac97125caaba32c7301db50cd76e80bc8">isect_plane_plane_v3</a>(<span class="keywordtype">float</span> r_isect_co[3], <span class="keywordtype">float</span> r_isect_no[3],
<a name="l00883"></a>00883                           <span class="keyword">const</span> <span class="keywordtype">float</span> plane_a_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_a_no[3],
<a name="l00884"></a>00884                           <span class="keyword">const</span> <span class="keywordtype">float</span> plane_b_co[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane_b_no[3])
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886     <span class="keywordtype">float</span> plane_a_co_other[3];
<a name="l00887"></a>00887     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(r_isect_no, plane_a_no, plane_b_no); <span class="comment">/* direction is simply the cross product */</span>
<a name="l00888"></a>00888     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(plane_a_co_other, plane_a_no, r_isect_no);
<a name="l00889"></a>00889     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(plane_a_co_other, plane_a_co);
<a name="l00890"></a>00890     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3fe81d8eae080a54d26703ce98b5575e">isect_line_plane_v3</a>(r_isect_co, plane_a_co, plane_a_co_other, plane_b_co, plane_b_no, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="comment">/* Adapted from the paper by Kasper Fauerby */</span>
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/* &quot;Improved Collision detection and Response&quot; */</span>
<a name="l00897"></a><a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">00897</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span> b, <span class="keyword">const</span> <span class="keywordtype">float</span> c, <span class="keyword">const</span> <span class="keywordtype">float</span> maxR, <span class="keywordtype">float</span> *root)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <span class="comment">// Check if a solution exists</span>
<a name="l00900"></a>00900     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a64a96a2f7282caebb48a5c8304285dd8">determinant</a> = b * b - 4.0f * a * c;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     <span class="comment">// If determinant is negative it means no solutions.</span>
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (determinant &gt;= 0.0f) {
<a name="l00904"></a>00904         <span class="comment">// calculate the two roots: (if determinant == 0 then</span>
<a name="l00905"></a>00905         <span class="comment">// x1==x2 but lets disregard that slight optimization)</span>
<a name="l00906"></a>00906         <span class="keywordtype">float</span> sqrtD = (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(determinant);
<a name="l00907"></a>00907         <span class="keywordtype">float</span> r1 = (-b - sqrtD) / (2.0f * a);
<a name="l00908"></a>00908         <span class="keywordtype">float</span> r2 = (-b + sqrtD) / (2.0f * a);
<a name="l00909"></a>00909 
<a name="l00910"></a>00910         <span class="comment">// Sort so x1 &lt;= x2</span>
<a name="l00911"></a>00911         <span class="keywordflow">if</span> (r1 &gt; r2)
<a name="l00912"></a>00912             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, r1, r2);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         <span class="comment">// Get lowest root:</span>
<a name="l00915"></a>00915         <span class="keywordflow">if</span> (r1 &gt; 0.0f &amp;&amp; r1 &lt; maxR) {
<a name="l00916"></a>00916             *root = r1;
<a name="l00917"></a>00917             <span class="keywordflow">return</span> 1;
<a name="l00918"></a>00918         }
<a name="l00919"></a>00919 
<a name="l00920"></a>00920         <span class="comment">// It is possible that we want x2 - this can happen</span>
<a name="l00921"></a>00921         <span class="comment">// if x1 &lt; 0</span>
<a name="l00922"></a>00922         <span class="keywordflow">if</span> (r2 &gt; 0.0f &amp;&amp; r2 &lt; maxR) {
<a name="l00923"></a>00923             *root = r2;
<a name="l00924"></a>00924             <span class="keywordflow">return</span> 1;
<a name="l00925"></a>00925         }
<a name="l00926"></a>00926     }
<a name="l00927"></a>00927     <span class="comment">// No (valid) solutions</span>
<a name="l00928"></a>00928     <span class="keywordflow">return</span> 0;
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a108badb717c4a78647e6e992c2a77a46">00931</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a108badb717c4a78647e6e992c2a77a46">isect_sweeping_sphere_tri_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> radius,
<a name="l00932"></a>00932                                  <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l00933"></a>00933                                  <span class="keywordtype">float</span> *r_lambda, <span class="keywordtype">float</span> ipoint[3])
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935     <span class="keywordtype">float</span> e1[3], e2[3], e3[3], <a class="code" href="../../d8/dae/structpoint.html">point</a>[3], vel[3], <span class="comment">/*dist[3],*/</span> nor[3], temp[3], bv[3];
<a name="l00936"></a>00936     <span class="keywordtype">float</span> a, b, c, d, e, x, y, z, radius2 = radius * radius;
<a name="l00937"></a>00937     <span class="keywordtype">float</span> elen2, edotv, edotbv, nordotv;
<a name="l00938"></a>00938     <span class="keywordtype">float</span> newLambda;
<a name="l00939"></a>00939     <span class="keywordtype">int</span> found_by_sweep = 0;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l00942"></a>00942     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l00943"></a>00943     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vel, p2, p1);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="comment">/*---test plane of tri---*/</span>
<a name="l00946"></a>00946     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(nor, e1, e2);
<a name="l00947"></a>00947     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(nor);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="comment">/* flip normal */</span>
<a name="l00950"></a>00950     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, vel) &gt; 0.0f) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(nor);
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(p1, nor) - <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(v0, nor);
<a name="l00953"></a>00953     nordotv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor, vel);
<a name="l00954"></a>00954 
<a name="l00955"></a>00955     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(nordotv) &lt; 0.000001f) {
<a name="l00956"></a>00956         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(a) &gt;= radius) {
<a name="l00957"></a>00957             <span class="keywordflow">return</span> 0;
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960     <span class="keywordflow">else</span> {
<a name="l00961"></a>00961         <span class="keywordtype">float</span> t0 = (-a + radius) / nordotv;
<a name="l00962"></a>00962         <span class="keywordtype">float</span> t1 = (-a - radius) / nordotv;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964         <span class="keywordflow">if</span> (t0 &gt; t1)
<a name="l00965"></a>00965             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, t0, t1);
<a name="l00966"></a>00966 
<a name="l00967"></a>00967         <span class="keywordflow">if</span> (t0 &gt; 1.0f || t1 &lt; 0.0f) <span class="keywordflow">return</span> 0;
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         <span class="comment">/* clamp to [0,1] */</span>
<a name="l00970"></a>00970         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(t0, 0.0f, 1.0f);
<a name="l00971"></a>00971         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(t1, 0.0f, 1.0f);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973         <span class="comment">/*---test inside of tri---*/</span>
<a name="l00974"></a>00974         <span class="comment">/* plane intersection point */</span>
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         point[0] = p1[0] + vel[0] * t0 - nor[0] * radius;
<a name="l00977"></a>00977         point[1] = p1[1] + vel[1] * t0 - nor[1] * radius;
<a name="l00978"></a>00978         point[2] = p1[2] + vel[2] * t0 - nor[2] * radius;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980 
<a name="l00981"></a>00981         <span class="comment">/* is the point in the tri? */</span>
<a name="l00982"></a>00982         a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e1);
<a name="l00983"></a>00983         b = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e2);
<a name="l00984"></a>00984         c = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, e2);
<a name="l00985"></a>00985 
<a name="l00986"></a>00986         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, point, v0);
<a name="l00987"></a>00987         d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, e1);
<a name="l00988"></a>00988         e = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, e2);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990         x = d * c - e * b;
<a name="l00991"></a>00991         y = e * a - d * b;
<a name="l00992"></a>00992         z = x + y - (a * c - b * b);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994 
<a name="l00995"></a>00995         <span class="keywordflow">if</span> (z &lt;= 0.0f &amp;&amp; (x &gt;= 0.0f &amp;&amp; y &gt;= 0.0f)) {
<a name="l00996"></a>00996             <span class="comment">//(((unsigned int)z)&amp; ~(((unsigned int)x)|((unsigned int)y))) &amp; 0x80000000) {</span>
<a name="l00997"></a>00997             *r_lambda = t0;
<a name="l00998"></a>00998             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, point);
<a name="l00999"></a>00999             <span class="keywordflow">return</span> 1;
<a name="l01000"></a>01000         }
<a name="l01001"></a>01001     }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     *r_lambda = 1.0f;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <span class="comment">/*---test points---*/</span>
<a name="l01007"></a>01007     a = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, vel);
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     <span class="comment">/*v0*/</span>
<a name="l01010"></a>01010     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, p1, v0);
<a name="l01011"></a>01011     b = 2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, temp);
<a name="l01012"></a>01012     c = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, temp) - radius2;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, r_lambda)) {
<a name="l01015"></a>01015         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, v0);
<a name="l01016"></a>01016         found_by_sweep = 1;
<a name="l01017"></a>01017     }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <span class="comment">/*v1*/</span>
<a name="l01020"></a>01020     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, p1, v1);
<a name="l01021"></a>01021     b = 2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, temp);
<a name="l01022"></a>01022     c = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, temp) - radius2;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, r_lambda)) {
<a name="l01025"></a>01025         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, v1);
<a name="l01026"></a>01026         found_by_sweep = 1;
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="comment">/*v2*/</span>
<a name="l01030"></a>01030     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(temp, p1, v2);
<a name="l01031"></a>01031     b = 2.0f * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, temp);
<a name="l01032"></a>01032     c = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(temp, temp) - radius2;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, r_lambda)) {
<a name="l01035"></a>01035         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, v2);
<a name="l01036"></a>01036         found_by_sweep = 1;
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="comment">/*---test edges---*/</span>
<a name="l01040"></a>01040     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e3, v2, v1); <span class="comment">//wasnt yet calculated</span>
<a name="l01041"></a>01041 
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="comment">/*e1*/</span>
<a name="l01044"></a>01044     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(bv, v0, p1);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     elen2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, e1);
<a name="l01047"></a>01047     edotv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, vel);
<a name="l01048"></a>01048     edotbv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e1, bv);
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     a = elen2 * (-<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, vel)) + edotv * edotv;
<a name="l01051"></a>01051     b = 2.0f * (elen2 * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, bv) - edotv * edotbv);
<a name="l01052"></a>01052     c = elen2 * (radius2 - <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(bv, bv)) + edotbv * edotbv;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, &amp;newLambda)) {
<a name="l01055"></a>01055         e = (edotv * newLambda - edotbv) / elen2;
<a name="l01056"></a>01056 
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (e &gt;= 0.0f &amp;&amp; e &lt;= 1.0f) {
<a name="l01058"></a>01058             *r_lambda = newLambda;
<a name="l01059"></a>01059             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, e1);
<a name="l01060"></a>01060             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ipoint, e);
<a name="l01061"></a>01061             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ipoint, v0);
<a name="l01062"></a>01062             found_by_sweep = 1;
<a name="l01063"></a>01063         }
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="comment">/*e2*/</span>
<a name="l01067"></a>01067     <span class="comment">/*bv is same*/</span>
<a name="l01068"></a>01068     elen2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, e2);
<a name="l01069"></a>01069     edotv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, vel);
<a name="l01070"></a>01070     edotbv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e2, bv);
<a name="l01071"></a>01071 
<a name="l01072"></a>01072     a = elen2 * (-<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, vel)) + edotv * edotv;
<a name="l01073"></a>01073     b = 2.0f * (elen2 * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, bv) - edotv * edotbv);
<a name="l01074"></a>01074     c = elen2 * (radius2 - <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(bv, bv)) + edotbv * edotbv;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, &amp;newLambda)) {
<a name="l01077"></a>01077         e = (edotv * newLambda - edotbv) / elen2;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (e &gt;= 0.0f &amp;&amp; e &lt;= 1.0f) {
<a name="l01080"></a>01080             *r_lambda = newLambda;
<a name="l01081"></a>01081             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, e2);
<a name="l01082"></a>01082             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ipoint, e);
<a name="l01083"></a>01083             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ipoint, v0);
<a name="l01084"></a>01084             found_by_sweep = 1;
<a name="l01085"></a>01085         }
<a name="l01086"></a>01086     }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="comment">/*e3*/</span>
<a name="l01089"></a>01089     <span class="comment">/* sub_v3_v3v3(bv,v0,p1); */</span> <span class="comment">/* UNUSED */</span>
<a name="l01090"></a>01090     <span class="comment">/* elen2 = dot_v3v3(e1,e1); */</span> <span class="comment">/* UNUSED */</span>
<a name="l01091"></a>01091     <span class="comment">/* edotv = dot_v3v3(e1,vel); */</span> <span class="comment">/* UNUSED */</span>
<a name="l01092"></a>01092     <span class="comment">/* edotbv = dot_v3v3(e1,bv); */</span> <span class="comment">/* UNUSED */</span>
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(bv, v1, p1);
<a name="l01095"></a>01095     elen2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e3, e3);
<a name="l01096"></a>01096     edotv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e3, vel);
<a name="l01097"></a>01097     edotbv = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(e3, bv);
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     a = elen2 * (-<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, vel)) + edotv * edotv;
<a name="l01100"></a>01100     b = 2.0f * (elen2 * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vel, bv) - edotv * edotbv);
<a name="l01101"></a>01101     c = elen2 * (radius2 - <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(bv, bv)) + edotbv * edotbv;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#afe6f3ce41d6844c862d06aea9f16264c">getLowestRoot</a>(a, b, c, *r_lambda, &amp;newLambda)) {
<a name="l01104"></a>01104         e = (edotv * newLambda - edotbv) / elen2;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="keywordflow">if</span> (e &gt;= 0.0f &amp;&amp; e &lt;= 1.0f) {
<a name="l01107"></a>01107             *r_lambda = newLambda;
<a name="l01108"></a>01108             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ipoint, e3);
<a name="l01109"></a>01109             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(ipoint, e);
<a name="l01110"></a>01110             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(ipoint, v1);
<a name="l01111"></a>01111             found_by_sweep = 1;
<a name="l01112"></a>01112         }
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 
<a name="l01116"></a>01116     <span class="keywordflow">return</span> found_by_sweep;
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01119"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a844013ebce58c7217f8436d599e89c24">01119</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a02070e89ddf56dc3d463aa88ce4b767d">isect_axial_line_tri_v3</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> axis, <span class="keyword">const</span> <span class="keywordtype">float</span> p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> p2[3],
<a name="l01120"></a>01120                             <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keywordtype">float</span> *r_lambda)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], e1[3], e2[3];
<a name="l01123"></a>01123     <span class="keywordtype">float</span> u, v, f;
<a name="l01124"></a>01124     <span class="keywordtype">int</span> a0 = axis, a1 = (axis + 1) % 3, a2 = (axis + 2) % 3;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     <span class="comment">//return isect_line_tri_v3(p1,p2,v0,v1,v2,lambda);</span>
<a name="l01127"></a>01127 
<a name="l01129"></a>01129     <span class="comment">//if (MIN3(v0[a1],v1[a1],v2[a1]) &gt; p1[a1]) return 0;</span>
<a name="l01130"></a>01130     <span class="comment">//if (MIN3(v0[a2],v1[a2],v2[a2]) &gt; p1[a2]) return 0;</span>
<a name="l01131"></a>01131     <span class="comment">//if (MAX3(v0[a1],v1[a1],v2[a1]) &lt; p1[a1]) return 0;</span>
<a name="l01132"></a>01132     <span class="comment">//if (MAX3(v0[a2],v1[a2],v2[a2]) &lt; p1[a2]) return 0;</span>
<a name="l01133"></a>01133 
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, v1, v0);
<a name="l01137"></a>01137     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, v2, v0);
<a name="l01138"></a>01138     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(p, v0, p1);
<a name="l01139"></a>01139 
<a name="l01140"></a>01140     f = (e2[a1] * e1[a2] - e2[a2] * e1[a1]);
<a name="l01141"></a>01141     <span class="keywordflow">if</span> ((f &gt; -0.000001f) &amp;&amp; (f &lt; 0.000001f)) <span class="keywordflow">return</span> 0;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143     v = (p[a2] * e1[a1] - p[a1] * e1[a2]) / f;
<a name="l01144"></a>01144     <span class="keywordflow">if</span> ((v &lt; 0.0f) || (v &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     f = e1[a1];
<a name="l01147"></a>01147     <span class="keywordflow">if</span> ((f &gt; -0.000001f) &amp;&amp; (f &lt; 0.000001f)) {
<a name="l01148"></a>01148         f = e1[a2];
<a name="l01149"></a>01149         <span class="keywordflow">if</span> ((f &gt; -0.000001f) &amp;&amp; (f &lt; 0.000001f)) <span class="keywordflow">return</span> 0;
<a name="l01150"></a>01150         u = (-p[a2] - v * e2[a2]) / f;
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152     <span class="keywordflow">else</span>
<a name="l01153"></a>01153         u = (-p[a1] - v * e2[a1]) / f;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155     <span class="keywordflow">if</span> ((u &lt; 0.0f) || ((u + v) &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     *r_lambda = (p[a0] + u * e1[a0] + v * e2[a0]) / (p2[a0] - p1[a0]);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159     <span class="keywordflow">if</span> ((*r_lambda &lt; 0.0f) || (*r_lambda &gt; 1.0f)) <span class="keywordflow">return</span> 0;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     <span class="keywordflow">return</span> 1;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 <span class="comment">/* Returns the number of point of interests</span>
<a name="l01165"></a>01165 <span class="comment"> * 0 - lines are colinear</span>
<a name="l01166"></a>01166 <span class="comment"> * 1 - lines are coplanar, i1 is set to intersection</span>
<a name="l01167"></a>01167 <span class="comment"> * 2 - i1 and i2 are the nearest points on line 1 (v1, v2) and line 2 (v3, v4) respectively</span>
<a name="l01168"></a>01168 <span class="comment"> * */</span>
<a name="l01169"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a60ead4f3b5813794f90d67f9d2ee1bfa">01169</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a60ead4f3b5813794f90d67f9d2ee1bfa">isect_line_line_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3], <span class="keywordtype">float</span> i1[3], <span class="keywordtype">float</span> i2[3])
<a name="l01170"></a>01170 {
<a name="l01171"></a>01171     <span class="keywordtype">float</span> a[3], b[3], c[3], ab[3], cb[3], dir1[3], dir2[3];
<a name="l01172"></a>01172     <span class="keywordtype">float</span> d;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(c, v3, v1);
<a name="l01175"></a>01175     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(a, v2, v1);
<a name="l01176"></a>01176     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(b, v4, v3);
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(dir1, a);
<a name="l01179"></a>01179     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(dir2, b);
<a name="l01180"></a>01180     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir1, dir2);
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (d == 1.0f || d == -1.0f) {
<a name="l01182"></a>01182         <span class="comment">/* colinear */</span>
<a name="l01183"></a>01183         <span class="keywordflow">return</span> 0;
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ab, a, b);
<a name="l01187"></a>01187     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(c, ab);
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="comment">/* test if the two lines are coplanar */</span>
<a name="l01190"></a>01190     <span class="keywordflow">if</span> (d &gt; -0.000001f &amp;&amp; d &lt; 0.000001f) {
<a name="l01191"></a>01191         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cb, c, b);
<a name="l01192"></a>01192 
<a name="l01193"></a>01193         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(a, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(cb, ab) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ab, ab));
<a name="l01194"></a>01194         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(i1, v1, a);
<a name="l01195"></a>01195         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(i2, i1);
<a name="l01196"></a>01196 
<a name="l01197"></a>01197         <span class="keywordflow">return</span> 1; <span class="comment">/* one intersection only */</span>
<a name="l01198"></a>01198     }
<a name="l01199"></a>01199     <span class="comment">/* if not */</span>
<a name="l01200"></a>01200     <span class="keywordflow">else</span> {
<a name="l01201"></a>01201         <span class="keywordtype">float</span> n[3], t[3];
<a name="l01202"></a>01202         <span class="keywordtype">float</span> v3t[3], v4t[3];
<a name="l01203"></a>01203         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(t, v1, v3);
<a name="l01204"></a>01204 
<a name="l01205"></a>01205         <span class="comment">/* offset between both plane where the lines lies */</span>
<a name="l01206"></a>01206         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(n, a, b);
<a name="l01207"></a>01207         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a0a8ff93b28d3d1f8e81650662fbb496d">project_v3_v3v3</a>(t, t, n);
<a name="l01208"></a>01208 
<a name="l01209"></a>01209         <span class="comment">/* for the first line, offset the second line until it is coplanar */</span>
<a name="l01210"></a>01210         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(v3t, v3, t);
<a name="l01211"></a>01211         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(v4t, v4, t);
<a name="l01212"></a>01212 
<a name="l01213"></a>01213         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(c, v3t, v1);
<a name="l01214"></a>01214         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(a, v2, v1);
<a name="l01215"></a>01215         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(b, v4t, v3t);
<a name="l01216"></a>01216 
<a name="l01217"></a>01217         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ab, a, b);
<a name="l01218"></a>01218         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cb, c, b);
<a name="l01219"></a>01219 
<a name="l01220"></a>01220         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(a, <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(cb, ab) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ab, ab));
<a name="l01221"></a>01221         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(i1, v1, a);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         <span class="comment">/* for the second line, just substract the offset from the first intersection point */</span>
<a name="l01224"></a>01224         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(i2, i1, t);
<a name="l01225"></a>01225 
<a name="l01226"></a>01226         <span class="keywordflow">return</span> 2; <span class="comment">/* two nearest points */</span>
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228 }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230 <span class="comment">/* Intersection point strictly between the two lines</span>
<a name="l01231"></a>01231 <span class="comment"> * 0 when no intersection is found</span>
<a name="l01232"></a>01232 <span class="comment"> * */</span>
<a name="l01233"></a><a class="code" href="../../d3/d61/math__geom_8c.html#af76f0adb324c0b296b6e1ad5f69e5b73">01233</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af76f0adb324c0b296b6e1ad5f69e5b73">isect_line_line_strict_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3], <span class="keywordtype">float</span> vi[3], <span class="keywordtype">float</span> *r_lambda)
<a name="l01234"></a>01234 {
<a name="l01235"></a>01235     <span class="keywordtype">float</span> a[3], b[3], c[3], ab[3], cb[3], ca[3], dir1[3], dir2[3];
<a name="l01236"></a>01236     <span class="keywordtype">float</span> d;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(c, v3, v1);
<a name="l01239"></a>01239     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(a, v2, v1);
<a name="l01240"></a>01240     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(b, v4, v3);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(dir1, a);
<a name="l01243"></a>01243     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aaa8b4ca59d77eb2612341c608507e087">normalize_v3_v3</a>(dir2, b);
<a name="l01244"></a>01244     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dir1, dir2);
<a name="l01245"></a>01245     <span class="keywordflow">if</span> (d == 1.0f || d == -1.0f || d == 0) {
<a name="l01246"></a>01246         <span class="comment">/* colinear or one vector is zero-length*/</span>
<a name="l01247"></a>01247         <span class="keywordflow">return</span> 0;
<a name="l01248"></a>01248     }
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ab, a, b);
<a name="l01251"></a>01251     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(c, ab);
<a name="l01252"></a>01252 
<a name="l01253"></a>01253     <span class="comment">/* test if the two lines are coplanar */</span>
<a name="l01254"></a>01254     <span class="keywordflow">if</span> (d &gt; -0.000001f &amp;&amp; d &lt; 0.000001f) {
<a name="l01255"></a>01255         <span class="keywordtype">float</span> f1, f2;
<a name="l01256"></a>01256         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cb, c, b);
<a name="l01257"></a>01257         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ca, c, a);
<a name="l01258"></a>01258 
<a name="l01259"></a>01259         f1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(cb, ab) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ab, ab);
<a name="l01260"></a>01260         f2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ca, ab) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ab, ab);
<a name="l01261"></a>01261 
<a name="l01262"></a>01262         <span class="keywordflow">if</span> (f1 &gt;= 0 &amp;&amp; f1 &lt;= 1 &amp;&amp;
<a name="l01263"></a>01263             f2 &gt;= 0 &amp;&amp; f2 &lt;= 1)
<a name="l01264"></a>01264         {
<a name="l01265"></a>01265             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(a, f1);
<a name="l01266"></a>01266             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(vi, v1, a);
<a name="l01267"></a>01267 
<a name="l01268"></a>01268             <span class="keywordflow">if</span> (r_lambda) *r_lambda = f1;
<a name="l01269"></a>01269 
<a name="l01270"></a>01270             <span class="keywordflow">return</span> 1; <span class="comment">/* intersection found */</span>
<a name="l01271"></a>01271         }
<a name="l01272"></a>01272         <span class="keywordflow">else</span> {
<a name="l01273"></a>01273             <span class="keywordflow">return</span> 0;
<a name="l01274"></a>01274         }
<a name="l01275"></a>01275     }
<a name="l01276"></a>01276     <span class="keywordflow">else</span> {
<a name="l01277"></a>01277         <span class="keywordflow">return</span> 0;
<a name="l01278"></a>01278     }
<a name="l01279"></a>01279 }
<a name="l01280"></a>01280 
<a name="l01281"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a06a67a33e958256669ed4440cddbd137">01281</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a06a67a33e958256669ed4440cddbd137">isect_aabb_aabb_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> min1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> max1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> min2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> max2[3])
<a name="l01282"></a>01282 {
<a name="l01283"></a>01283     <span class="keywordflow">return</span> (min1[0] &lt; max2[0] &amp;&amp; min1[1] &lt; max2[1] &amp;&amp; min1[2] &lt; max2[2] &amp;&amp;
<a name="l01284"></a>01284             min2[0] &lt; max1[0] &amp;&amp; min2[1] &lt; max1[1] &amp;&amp; min2[2] &lt; max1[2]);
<a name="l01285"></a>01285 }
<a name="l01286"></a>01286 
<a name="l01287"></a>01287 <span class="comment">/* find closest point to p on line through l1,l2 and return lambda,</span>
<a name="l01288"></a>01288 <span class="comment"> * where (0 &lt;= lambda &lt;= 1) when cp is in the line segement l1,l2</span>
<a name="l01289"></a>01289 <span class="comment"> */</span>
<a name="l01290"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a70fb3938a21254305f0e5f484ce2ac07">01290</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(<span class="keywordtype">float</span> cp[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[3])
<a name="l01291"></a>01291 {
<a name="l01292"></a>01292     <span class="keywordtype">float</span> h[3], u[3], lambda;
<a name="l01293"></a>01293     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(u, l2, l1);
<a name="l01294"></a>01294     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(h, p, l1);
<a name="l01295"></a>01295     lambda = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(u, h) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(u, u);
<a name="l01296"></a>01296     cp[0] = l1[0] + u[0] * lambda;
<a name="l01297"></a>01297     cp[1] = l1[1] + u[1] * lambda;
<a name="l01298"></a>01298     cp[2] = l1[2] + u[2] * lambda;
<a name="l01299"></a>01299     <span class="keywordflow">return</span> lambda;
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01302"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aeccc32790e6872298be76acc5b5d83cb">01302</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00d439c1ac1a9593b794ebe8734358f5">closest_to_line_v2</a>(<span class="keywordtype">float</span> cp[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[2])
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304     <span class="keywordtype">float</span> h[2], u[2], lambda;
<a name="l01305"></a>01305     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(u, l2, l1);
<a name="l01306"></a>01306     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(h, p, l1);
<a name="l01307"></a>01307     lambda = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(u, h) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(u, u);
<a name="l01308"></a>01308     cp[0] = l1[0] + u[0] * lambda;
<a name="l01309"></a>01309     cp[1] = l1[1] + u[1] * lambda;
<a name="l01310"></a>01310     <span class="keywordflow">return</span> lambda;
<a name="l01311"></a>01311 }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="comment">/* little sister we only need to know lambda */</span>
<a name="l01314"></a><a class="code" href="../../d3/d61/math__geom_8c.html#abe6676736ae17748b51b40cdb4e89171">01314</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#abe6676736ae17748b51b40cdb4e89171">line_point_factor_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[3])
<a name="l01315"></a>01315 {
<a name="l01316"></a>01316     <span class="keywordtype">float</span> h[3], u[3];
<a name="l01317"></a>01317     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(u, l2, l1);
<a name="l01318"></a>01318     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(h, p, l1);
<a name="l01319"></a>01319     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(u, h) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(u, u));
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a87d4f10694f41505747272f5a4490057">01322</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a87d4f10694f41505747272f5a4490057">line_point_factor_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[2])
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324     <span class="keywordtype">float</span> h[2], u[2];
<a name="l01325"></a>01325     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(u, l2, l1);
<a name="l01326"></a>01326     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(h, p, l1);
<a name="l01327"></a>01327     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(u, h) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(u, u));
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330 <span class="comment">/* ensyre the distance between these points is no greater then &#39;dist&#39;</span>
<a name="l01331"></a>01331 <span class="comment"> * if it is, scale then both into the center */</span>
<a name="l01332"></a><a class="code" href="../../d3/d61/math__geom_8c.html#ac21a6d5b83b222828870133f4310f89d">01332</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ac21a6d5b83b222828870133f4310f89d">limit_dist_v3</a>(<span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> dist)
<a name="l01333"></a>01333 {
<a name="l01334"></a>01334     <span class="keyword">const</span> <span class="keywordtype">float</span> dist_old = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1, v2);
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     <span class="keywordflow">if</span> (dist_old &gt; dist) {
<a name="l01337"></a>01337         <span class="keywordtype">float</span> v1_old[3];
<a name="l01338"></a>01338         <span class="keywordtype">float</span> v2_old[3];
<a name="l01339"></a>01339         <span class="keywordtype">float</span> fac = (dist / dist_old) * 0.5f;
<a name="l01340"></a>01340 
<a name="l01341"></a>01341         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1_old, v1);
<a name="l01342"></a>01342         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2_old, v2);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(v1, v1_old, v2_old, 0.5f - fac);
<a name="l01345"></a>01345         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(v2, v1_old, v2_old, 0.5f + fac);
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347 }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349 <span class="comment">/* Similar to LineIntersectsTriangleUV, except it operates on a quad and in 2d, assumes point is in quad */</span>
<a name="l01350"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a89040c1adb6469e951f804896ffcfefb">01350</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a89040c1adb6469e951f804896ffcfefb">isect_point_quad_uv_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v0[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2],
<a name="l01351"></a>01351                             <span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> r_uv[2])
<a name="l01352"></a>01352 {
<a name="l01353"></a>01353     <span class="keywordtype">float</span> x0, y0, x1, y1, wtot, v2d[2], w1, w2;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355     <span class="comment">/* used for parallel lines */</span>
<a name="l01356"></a>01356     <span class="keywordtype">float</span> pt3d[3], l1[3], l2[3], pt_on_line[3];
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     <span class="comment">/* compute 2 edges  of the quad  intersection point */</span>
<a name="l01359"></a>01359     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">IsectLLPt2Df</a>(v0[0], v0[1], v1[0], v1[1], v2[0], v2[1], v3[0], v3[1], &amp;x0, &amp;y0) == 1) {
<a name="l01360"></a>01360         <span class="comment">/* the intersection point between the quad-edge intersection and the point in the quad we want the uv&#39;s for */</span>
<a name="l01361"></a>01361         <span class="comment">/* should never be paralle !! */</span>
<a name="l01362"></a>01362         <span class="comment">/*printf(&quot;\tnot parallel 1\n&quot;);*/</span>
<a name="l01363"></a>01363         <a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">IsectLLPt2Df</a>(pt[0], pt[1], x0, y0, v0[0], v0[1], v3[0], v3[1], &amp;x1, &amp;y1);
<a name="l01364"></a>01364 
<a name="l01365"></a>01365         <span class="comment">/* Get the weights from the new intersection point, to each edge */</span>
<a name="l01366"></a>01366         v2d[0] = x1 - v0[0];
<a name="l01367"></a>01367         v2d[1] = y1 - v0[1];
<a name="l01368"></a>01368         w1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370         v2d[0] = x1 - v3[0]; <span class="comment">/* some but for the other vert */</span>
<a name="l01371"></a>01371         v2d[1] = y1 - v3[1];
<a name="l01372"></a>01372         w2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01373"></a>01373         wtot = w1 + w2;
<a name="l01374"></a>01374         <span class="comment">/*w1 = w1/wtot;*/</span>
<a name="l01375"></a>01375         <span class="comment">/*w2 = w2/wtot;*/</span>
<a name="l01376"></a>01376         r_uv[0] = w1 / wtot;
<a name="l01377"></a>01377     }
<a name="l01378"></a>01378     <span class="keywordflow">else</span> {
<a name="l01379"></a>01379         <span class="comment">/* lines are parallel, lambda_cp_line_ex is 3d grrr */</span>
<a name="l01380"></a>01380         <span class="comment">/*printf(&quot;\tparallel1\n&quot;);*/</span>
<a name="l01381"></a>01381         pt3d[0] = pt[0];
<a name="l01382"></a>01382         pt3d[1] = pt[1];
<a name="l01383"></a>01383         pt3d[2] = l1[2] = l2[2] = 0.0f;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         l1[0] = v0[0];
<a name="l01386"></a>01386         l1[1] = v0[1];
<a name="l01387"></a>01387         l2[0] = v1[0];
<a name="l01388"></a>01388         l2[1] = v1[1];
<a name="l01389"></a>01389         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(pt_on_line, pt3d, l1, l2);
<a name="l01390"></a>01390         v2d[0] = pt[0] - pt_on_line[0]; <span class="comment">/* same, for the other vert */</span>
<a name="l01391"></a>01391         v2d[1] = pt[1] - pt_on_line[1];
<a name="l01392"></a>01392         w1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394         l1[0] = v2[0];
<a name="l01395"></a>01395         l1[1] = v2[1];
<a name="l01396"></a>01396         l2[0] = v3[0];
<a name="l01397"></a>01397         l2[1] = v3[1];
<a name="l01398"></a>01398         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(pt_on_line, pt3d, l1, l2);
<a name="l01399"></a>01399         v2d[0] = pt[0] - pt_on_line[0]; <span class="comment">/* same, for the other vert */</span>
<a name="l01400"></a>01400         v2d[1] = pt[1] - pt_on_line[1];
<a name="l01401"></a>01401         w2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01402"></a>01402         wtot = w1 + w2;
<a name="l01403"></a>01403         r_uv[0] = w1 / wtot;
<a name="l01404"></a>01404     }
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <span class="comment">/* Same as above to calc the uv[1] value, alternate calculation */</span>
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">IsectLLPt2Df</a>(v0[0], v0[1], v3[0], v3[1], v1[0], v1[1], v2[0], v2[1], &amp;x0, &amp;y0) == 1) { <span class="comment">/* was v0,v1  v2,v3  now v0,v3  v1,v2*/</span>
<a name="l01409"></a>01409         <span class="comment">/* never paralle if above was not */</span>
<a name="l01410"></a>01410         <span class="comment">/*printf(&quot;\tnot parallel2\n&quot;);*/</span>
<a name="l01411"></a>01411         <a class="code" href="../../d3/d61/math__geom_8c.html#a0b2cb99b648b9f63e77ed4c18241a97e">IsectLLPt2Df</a>(pt[0], pt[1], x0, y0, v0[0], v0[1], v1[0], v1[1], &amp;x1, &amp;y1); <span class="comment">/* was v0,v3  now v0,v1*/</span>
<a name="l01412"></a>01412 
<a name="l01413"></a>01413         v2d[0] = x1 - v0[0];
<a name="l01414"></a>01414         v2d[1] = y1 - v0[1];
<a name="l01415"></a>01415         w1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417         v2d[0] = x1 - v1[0];
<a name="l01418"></a>01418         v2d[1] = y1 - v1[1];
<a name="l01419"></a>01419         w2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01420"></a>01420         wtot = w1 + w2;
<a name="l01421"></a>01421         r_uv[1] = w1 / wtot;
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423     <span class="keywordflow">else</span> {
<a name="l01424"></a>01424         <span class="comment">/* lines are parallel, lambda_cp_line_ex is 3d grrr */</span>
<a name="l01425"></a>01425         <span class="comment">/*printf(&quot;\tparallel2\n&quot;);*/</span>
<a name="l01426"></a>01426         pt3d[0] = pt[0];
<a name="l01427"></a>01427         pt3d[1] = pt[1];
<a name="l01428"></a>01428         pt3d[2] = l1[2] = l2[2] = 0.0f;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 
<a name="l01431"></a>01431         l1[0] = v0[0];
<a name="l01432"></a>01432         l1[1] = v0[1];
<a name="l01433"></a>01433         l2[0] = v3[0];
<a name="l01434"></a>01434         l2[1] = v3[1];
<a name="l01435"></a>01435         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(pt_on_line, pt3d, l1, l2);
<a name="l01436"></a>01436         v2d[0] = pt[0] - pt_on_line[0]; <span class="comment">/* some but for the other vert */</span>
<a name="l01437"></a>01437         v2d[1] = pt[1] - pt_on_line[1];
<a name="l01438"></a>01438         w1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01439"></a>01439 
<a name="l01440"></a>01440         l1[0] = v1[0];
<a name="l01441"></a>01441         l1[1] = v1[1];
<a name="l01442"></a>01442         l2[0] = v2[0];
<a name="l01443"></a>01443         l2[1] = v2[1];
<a name="l01444"></a>01444         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(pt_on_line, pt3d, l1, l2);
<a name="l01445"></a>01445         v2d[0] = pt[0] - pt_on_line[0]; <span class="comment">/* some but for the other vert */</span>
<a name="l01446"></a>01446         v2d[1] = pt[1] - pt_on_line[1];
<a name="l01447"></a>01447         w2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a524206121dfa19c9c14423f3a96fcb2b">len_v2</a>(v2d);
<a name="l01448"></a>01448         wtot = w1 + w2;
<a name="l01449"></a>01449         r_uv[1] = w1 / wtot;
<a name="l01450"></a>01450     }
<a name="l01451"></a>01451     <span class="comment">/* may need to flip UV&#39;s here */</span>
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454 <span class="comment">/* same as above but does tri&#39;s and quads, tri&#39;s are a bit of a hack */</span>
<a name="l01455"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a17c3c4e74f975391add145e523db68a3">01455</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a17c3c4e74f975391add145e523db68a3">isect_point_face_uv_v2</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> isquad,
<a name="l01456"></a>01456                             <span class="keyword">const</span> <span class="keywordtype">float</span> v0[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2],
<a name="l01457"></a>01457                             <span class="keyword">const</span> <span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> r_uv[2])
<a name="l01458"></a>01458 {
<a name="l01459"></a>01459     <span class="keywordflow">if</span> (isquad) {
<a name="l01460"></a>01460         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a89040c1adb6469e951f804896ffcfefb">isect_point_quad_uv_v2</a>(v0, v1, v2, v3, pt, r_uv);
<a name="l01461"></a>01461     }
<a name="l01462"></a>01462     <span class="keywordflow">else</span> {
<a name="l01463"></a>01463         <span class="comment">/* not for quads, use for our abuse of LineIntersectsTriangleUV */</span>
<a name="l01464"></a>01464         <span class="keywordtype">float</span> p1_3d[3], p2_3d[3], v0_3d[3], v1_3d[3], v2_3d[3], lambda;
<a name="l01465"></a>01465 
<a name="l01466"></a>01466         p1_3d[0] = p2_3d[0] = r_uv[0];
<a name="l01467"></a>01467         p1_3d[1] = p2_3d[1] = r_uv[1];
<a name="l01468"></a>01468         p1_3d[2] = 1.0f;
<a name="l01469"></a>01469         p2_3d[2] = -1.0f;
<a name="l01470"></a>01470         v0_3d[2] = v1_3d[2] = v2_3d[2] = 0.0;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         <span class="comment">/* generate a new fuv, (this is possibly a non optimal solution,</span>
<a name="l01473"></a>01473 <span class="comment">         * since we only need 2d calculation but use 3d func&#39;s)</span>
<a name="l01474"></a>01474 <span class="comment">         *</span>
<a name="l01475"></a>01475 <span class="comment">         * this method makes an imaginary triangle in 2d space using the UV&#39;s from the derived mesh face</span>
<a name="l01476"></a>01476 <span class="comment">         * Then find new uv coords using the fuv and this face with LineIntersectsTriangleUV.</span>
<a name="l01477"></a>01477 <span class="comment">         * This means the new values will be correct in relation to the derived meshes face.</span>
<a name="l01478"></a>01478 <span class="comment">         */</span>
<a name="l01479"></a>01479         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v0_3d, v0);
<a name="l01480"></a>01480         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v1_3d, v1);
<a name="l01481"></a>01481         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v2_3d, v2);
<a name="l01482"></a>01482 
<a name="l01483"></a>01483         <span class="comment">/* Doing this in 3D is not nice */</span>
<a name="l01484"></a>01484         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(p1_3d, p2_3d, v0_3d, v1_3d, v2_3d, &amp;lambda, r_uv);
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486 }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488 <span class="preprocessor">#if 0 // XXX this version used to be used in isect_point_tri_v2_int() and was called IsPointInTri2D</span>
<a name="l01489"></a>01489 <span class="preprocessor"></span>
<a name="l01490"></a>01490 <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(<span class="keywordtype">float</span> pt[2], <span class="keywordtype">float</span> v1[2], <span class="keywordtype">float</span> v2[2], <span class="keywordtype">float</span> v3[2])
<a name="l01491"></a>01491 {
<a name="l01492"></a>01492     <span class="keywordtype">float</span> inp1, inp2, inp3;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494     inp1 = (v2[0] - v1[0]) * (v1[1] - pt[1]) + (v1[1] - v2[1]) * (v1[0] - pt[0]);
<a name="l01495"></a>01495     inp2 = (v3[0] - v2[0]) * (v2[1] - pt[1]) + (v2[1] - v3[1]) * (v2[0] - pt[0]);
<a name="l01496"></a>01496     inp3 = (v1[0] - v3[0]) * (v3[1] - pt[1]) + (v3[1] - v1[1]) * (v3[0] - pt[0]);
<a name="l01497"></a>01497 
<a name="l01498"></a>01498     <span class="keywordflow">if</span> (inp1 &lt;= 0.0f &amp;&amp; inp2 &lt;= 0.0f &amp;&amp; inp3 &lt;= 0.0f) <span class="keywordflow">return</span> 1;
<a name="l01499"></a>01499     <span class="keywordflow">if</span> (inp1 &gt;= 0.0f &amp;&amp; inp2 &gt;= 0.0f &amp;&amp; inp3 &gt;= 0.0f) <span class="keywordflow">return</span> 1;
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     <span class="keywordflow">return</span> 0;
<a name="l01502"></a>01502 }
<a name="l01503"></a>01503 <span class="preprocessor">#endif</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span>
<a name="l01505"></a>01505 <span class="preprocessor">#if 0</span>
<a name="l01506"></a>01506 <span class="preprocessor"></span>
<a name="l01507"></a>01507 <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(<span class="keywordtype">float</span> v0[2], <span class="keywordtype">float</span> v1[2], <span class="keywordtype">float</span> v2[2], <span class="keywordtype">float</span> pt[2])
<a name="l01508"></a>01508 {
<a name="l01509"></a>01509     <span class="comment">/* not for quads, use for our abuse of LineIntersectsTriangleUV */</span>
<a name="l01510"></a>01510     <span class="keywordtype">float</span> p1_3d[3], p2_3d[3], v0_3d[3], v1_3d[3], v2_3d[3];
<a name="l01511"></a>01511     <span class="comment">/* not used */</span>
<a name="l01512"></a>01512     <span class="keywordtype">float</span> lambda, uv[3];
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     p1_3d[0] = p2_3d[0] = uv[0] = pt[0];
<a name="l01515"></a>01515     p1_3d[1] = p2_3d[1] = uv[1] = uv[2] = pt[1];
<a name="l01516"></a>01516     p1_3d[2] = 1.0f;
<a name="l01517"></a>01517     p2_3d[2] = -1.0f;
<a name="l01518"></a>01518     v0_3d[2] = v1_3d[2] = v2_3d[2] = 0.0;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     <span class="comment">/* generate a new fuv, (this is possibly a non optimal solution,</span>
<a name="l01521"></a>01521 <span class="comment">     * since we only need 2d calculation but use 3d func&#39;s)</span>
<a name="l01522"></a>01522 <span class="comment">     *</span>
<a name="l01523"></a>01523 <span class="comment">     * this method makes an imaginary triangle in 2d space using the UV&#39;s from the derived mesh face</span>
<a name="l01524"></a>01524 <span class="comment">     * Then find new uv coords using the fuv and this face with LineIntersectsTriangleUV.</span>
<a name="l01525"></a>01525 <span class="comment">     * This means the new values will be correct in relation to the derived meshes face.</span>
<a name="l01526"></a>01526 <span class="comment">     */</span>
<a name="l01527"></a>01527     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v0_3d, v0);
<a name="l01528"></a>01528     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v1_3d, v1);
<a name="l01529"></a>01529     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5e7a11335014e249bd70cea058cc22ed">copy_v2_v2</a>(v2_3d, v2);
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     <span class="comment">/* Doing this in 3D is not nice */</span>
<a name="l01532"></a>01532     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(p1_3d, p2_3d, v0_3d, v1_3d, v2_3d, &amp;lambda, uv);
<a name="l01533"></a>01533 }
<a name="l01534"></a>01534 <span class="preprocessor">#endif</span>
<a name="l01535"></a>01535 <span class="preprocessor"></span>
<a name="l01536"></a>01536 <span class="comment">/*</span>
<a name="l01537"></a>01537 <span class="comment"> *     x1,y2</span>
<a name="l01538"></a>01538 <span class="comment"> *     |  \</span>
<a name="l01539"></a>01539 <span class="comment"> *     |   \     .(a,b)</span>
<a name="l01540"></a>01540 <span class="comment"> *     |    \</span>
<a name="l01541"></a>01541 <span class="comment"> *     x1,y1-- x2,y1</span>
<a name="l01542"></a>01542 <span class="comment"> */</span>
<a name="l01543"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a5825de41f8325d123a7c9cfd9ef8901d">01543</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5825de41f8325d123a7c9cfd9ef8901d">isect_point_tri_v2_int</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> x1, <span class="keyword">const</span> <span class="keywordtype">int</span> y1, <span class="keyword">const</span> <span class="keywordtype">int</span> x2, <span class="keyword">const</span> <span class="keywordtype">int</span> y2, <span class="keyword">const</span> <span class="keywordtype">int</span> a, <span class="keyword">const</span> <span class="keywordtype">int</span> b)
<a name="l01544"></a>01544 {
<a name="l01545"></a>01545     <span class="keywordtype">float</span> v1[2], v2[2], v3[2], <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[2];
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     v1[0] = (float)x1;
<a name="l01548"></a>01548     v1[1] = (float)y1;
<a name="l01549"></a>01549 
<a name="l01550"></a>01550     v2[0] = (float)x1;
<a name="l01551"></a>01551     v2[1] = (float)y2;
<a name="l01552"></a>01552 
<a name="l01553"></a>01553     v3[0] = (float)x2;
<a name="l01554"></a>01554     v3[1] = (float)y1;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     p[0] = (float)a;
<a name="l01557"></a>01557     p[1] = (float)b;
<a name="l01558"></a>01558 
<a name="l01559"></a>01559     <span class="keywordflow">return</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9b9ad82d53315636d1e97cc4355e93c4">isect_point_tri_v2</a>(p, v1, v2, v3);
<a name="l01560"></a>01560 }
<a name="l01561"></a>01561 
<a name="l01562"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a53a2d0238fbb44b09e78b2e37e927954">01562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a53a2d0238fbb44b09e78b2e37e927954">point_in_slice</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> l2[3])
<a name="l01563"></a>01563 {
<a name="l01564"></a>01564     <span class="comment">/*</span>
<a name="l01565"></a>01565 <span class="comment">     * what is a slice ?</span>
<a name="l01566"></a>01566 <span class="comment">     * some maths:</span>
<a name="l01567"></a>01567 <span class="comment">     * a line including l1,l2 and a point not on the line</span>
<a name="l01568"></a>01568 <span class="comment">     * define a subset of R3 delimited by planes parallel to the line and orthogonal</span>
<a name="l01569"></a>01569 <span class="comment">     * to the (point --&gt; line) distance vector,one plane on the line one on the point,</span>
<a name="l01570"></a>01570 <span class="comment">     * the room inside usually is rather small compared to R3 though still infinte</span>
<a name="l01571"></a>01571 <span class="comment">     * useful for restricting (speeding up) searches</span>
<a name="l01572"></a>01572 <span class="comment">     * e.g. all points of triangular prism are within the intersection of 3 &#39;slices&#39;</span>
<a name="l01573"></a>01573 <span class="comment">     * onother trivial case : cube</span>
<a name="l01574"></a>01574 <span class="comment">     * but see a &#39;spat&#39; which is a deformed cube with paired parallel planes needs only 3 slices too</span>
<a name="l01575"></a>01575 <span class="comment">     */</span>
<a name="l01576"></a>01576     <span class="keywordtype">float</span> h, rp[3], cp[3], q[3];
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(cp, v1, l1, l2);
<a name="l01579"></a>01579     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(q, cp, v1);
<a name="l01580"></a>01580 
<a name="l01581"></a>01581     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(rp, p, v1);
<a name="l01582"></a>01582     h = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(q, rp) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(q, q);
<a name="l01583"></a>01583     <span class="keywordflow">if</span> (h &lt; 0.0f || h &gt; 1.0f) <span class="keywordflow">return</span> 0;
<a name="l01584"></a>01584     <span class="keywordflow">return</span> 1;
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="preprocessor">#if 0</span>
<a name="l01588"></a>01588 <span class="preprocessor"></span>
<a name="l01589"></a>01589 <span class="comment">/* adult sister defining the slice planes by the origin and the normal</span>
<a name="l01590"></a>01590 <span class="comment"> * NOTE |normal| may not be 1 but defining the thickness of the slice */</span>
<a name="l01591"></a>01591 <span class="keyword">static</span> <span class="keywordtype">int</span> point_in_slice_as(<span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keywordtype">float</span> origin[3], <span class="keywordtype">float</span> normal[3])
<a name="l01592"></a>01592 {
<a name="l01593"></a>01593     <span class="keywordtype">float</span> h, rp[3];
<a name="l01594"></a>01594     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(rp, p, origin);
<a name="l01595"></a>01595     h = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(normal, rp) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(normal, normal);
<a name="l01596"></a>01596     <span class="keywordflow">if</span> (h &lt; 0.0f || h &gt; 1.0f) <span class="keywordflow">return</span> 0;
<a name="l01597"></a>01597     <span class="keywordflow">return</span> 1;
<a name="l01598"></a>01598 }
<a name="l01599"></a>01599 
<a name="l01600"></a>01600 <span class="comment">/*mama (knowing the squared length of the normal)*/</span>
<a name="l01601"></a>01601 <span class="keyword">static</span> <span class="keywordtype">int</span> point_in_slice_m(<span class="keywordtype">float</span> p[3], <span class="keywordtype">float</span> origin[3], <span class="keywordtype">float</span> normal[3], <span class="keywordtype">float</span> lns)
<a name="l01602"></a>01602 {
<a name="l01603"></a>01603     <span class="keywordtype">float</span> h, rp[3];
<a name="l01604"></a>01604     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(rp, p, origin);
<a name="l01605"></a>01605     h = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(normal, rp) / lns;
<a name="l01606"></a>01606     <span class="keywordflow">if</span> (h &lt; 0.0f || h &gt; 1.0f) <span class="keywordflow">return</span> 0;
<a name="l01607"></a>01607     <span class="keywordflow">return</span> 1;
<a name="l01608"></a>01608 }
<a name="l01609"></a>01609 <span class="preprocessor">#endif</span>
<a name="l01610"></a>01610 <span class="preprocessor"></span>
<a name="l01611"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7a6709a387dc493d4446feab3e554930">01611</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7a6709a387dc493d4446feab3e554930">isect_point_tri_prism_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01612"></a>01612 {
<a name="l01613"></a>01613     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d61/math__geom_8c.html#a53a2d0238fbb44b09e78b2e37e927954">point_in_slice</a>(p, v1, v2, v3)) <span class="keywordflow">return</span> 0;
<a name="l01614"></a>01614     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d61/math__geom_8c.html#a53a2d0238fbb44b09e78b2e37e927954">point_in_slice</a>(p, v2, v3, v1)) <span class="keywordflow">return</span> 0;
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d61/math__geom_8c.html#a53a2d0238fbb44b09e78b2e37e927954">point_in_slice</a>(p, v3, v1, v2)) <span class="keywordflow">return</span> 0;
<a name="l01616"></a>01616     <span class="keywordflow">return</span> 1;
<a name="l01617"></a>01617 }
<a name="l01618"></a>01618 
<a name="l01619"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8e3cb77db089360e173e2688317deb16">01619</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8e3cb77db089360e173e2688317deb16">clip_line_plane</a>(<span class="keywordtype">float</span> p1[3], <span class="keywordtype">float</span> p2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> plane[4])
<a name="l01620"></a>01620 {
<a name="l01621"></a>01621     <span class="keywordtype">float</span> dp[3], n[3], <a class="code" href="../../d7/d35/meshtools_8c.html#aaa0035357cda6d6d6d0e6831ce7c869a">div</a>, t, pc[3];
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(n, plane);
<a name="l01624"></a>01624     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dp, p2, p1);
<a name="l01625"></a>01625     div = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(dp, n);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     <span class="keywordflow">if</span> (div == 0.0f) <span class="comment">/* parallel */</span>
<a name="l01628"></a>01628         <span class="keywordflow">return</span> 1;
<a name="l01629"></a>01629 
<a name="l01630"></a>01630     t = -(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(p1, n) + plane[3]) / div;
<a name="l01631"></a>01631 
<a name="l01632"></a>01632     <span class="keywordflow">if</span> (div &gt; 0.0f) {
<a name="l01633"></a>01633         <span class="comment">/* behind plane, completely clipped */</span>
<a name="l01634"></a>01634         <span class="keywordflow">if</span> (t &gt;= 1.0f) {
<a name="l01635"></a>01635             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(p1);
<a name="l01636"></a>01636             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(p2);
<a name="l01637"></a>01637             <span class="keywordflow">return</span> 0;
<a name="l01638"></a>01638         }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640         <span class="comment">/* intersect plane */</span>
<a name="l01641"></a>01641         <span class="keywordflow">if</span> (t &gt; 0.0f) {
<a name="l01642"></a>01642             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pc, p1, dp, t);
<a name="l01643"></a>01643             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p1, pc);
<a name="l01644"></a>01644             <span class="keywordflow">return</span> 1;
<a name="l01645"></a>01645         }
<a name="l01646"></a>01646 
<a name="l01647"></a>01647         <span class="keywordflow">return</span> 1;
<a name="l01648"></a>01648     }
<a name="l01649"></a>01649     <span class="keywordflow">else</span> {
<a name="l01650"></a>01650         <span class="comment">/* behind plane, completely clipped */</span>
<a name="l01651"></a>01651         <span class="keywordflow">if</span> (t &lt;= 0.0f) {
<a name="l01652"></a>01652             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(p1);
<a name="l01653"></a>01653             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(p2);
<a name="l01654"></a>01654             <span class="keywordflow">return</span> 0;
<a name="l01655"></a>01655         }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657         <span class="comment">/* intersect plane */</span>
<a name="l01658"></a>01658         <span class="keywordflow">if</span> (t &lt; 1.0f) {
<a name="l01659"></a>01659             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pc, p1, dp, t);
<a name="l01660"></a>01660             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p2, pc);
<a name="l01661"></a>01661             <span class="keywordflow">return</span> 1;
<a name="l01662"></a>01662         }
<a name="l01663"></a>01663 
<a name="l01664"></a>01664         <span class="keywordflow">return</span> 1;
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666 }
<a name="l01667"></a>01667 
<a name="l01668"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7e44707b9d5058e0b577902aaefe86c2">01668</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7e44707b9d5058e0b577902aaefe86c2">plot_line_v2v2i</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> p1[2], <span class="keyword">const</span> <span class="keywordtype">int</span> p2[2], <span class="keywordtype">int</span> (*callback)(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">void</span> *), <span class="keywordtype">void</span> *userData)
<a name="l01669"></a>01669 {
<a name="l01670"></a>01670     <span class="keywordtype">int</span> x1 = p1[0];
<a name="l01671"></a>01671     <span class="keywordtype">int</span> y1 = p1[1];
<a name="l01672"></a>01672     <span class="keywordtype">int</span> x2 = p2[0];
<a name="l01673"></a>01673     <span class="keywordtype">int</span> y2 = p2[1];
<a name="l01674"></a>01674 
<a name="l01675"></a>01675     <span class="keywordtype">signed</span> <span class="keywordtype">char</span> ix;
<a name="l01676"></a>01676     <span class="keywordtype">signed</span> <span class="keywordtype">char</span> iy;
<a name="l01677"></a>01677 
<a name="l01678"></a>01678     <span class="comment">// if x1 == x2 or y1 == y2, then it does not matter what we set here</span>
<a name="l01679"></a>01679     <span class="keywordtype">int</span> delta_x = (x2 &gt; x1 ? (ix = 1, x2 - x1) : (ix = -1, x1 - x2)) &lt;&lt; 1;
<a name="l01680"></a>01680     <span class="keywordtype">int</span> delta_y = (y2 &gt; y1 ? (iy = 1, y2 - y1) : (iy = -1, y1 - y2)) &lt;&lt; 1;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <span class="keywordflow">if</span> (callback(x1, y1, userData) == 0) {
<a name="l01683"></a>01683         <span class="keywordflow">return</span>;
<a name="l01684"></a>01684     }
<a name="l01685"></a>01685 
<a name="l01686"></a>01686     <span class="keywordflow">if</span> (delta_x &gt;= delta_y) {
<a name="l01687"></a>01687         <span class="comment">// error may go below zero</span>
<a name="l01688"></a>01688         <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = delta_y - (delta_x &gt;&gt; 1);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690         <span class="keywordflow">while</span> (x1 != x2) {
<a name="l01691"></a>01691             <span class="keywordflow">if</span> (error &gt;= 0) {
<a name="l01692"></a>01692                 <span class="keywordflow">if</span> (error || (ix &gt; 0)) {
<a name="l01693"></a>01693                     y1 += iy;
<a name="l01694"></a>01694                     error -= delta_x;
<a name="l01695"></a>01695                 }
<a name="l01696"></a>01696                 <span class="comment">// else do nothing</span>
<a name="l01697"></a>01697             }
<a name="l01698"></a>01698             <span class="comment">// else do nothing</span>
<a name="l01699"></a>01699 
<a name="l01700"></a>01700             x1 += ix;
<a name="l01701"></a>01701             error += delta_y;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703             <span class="keywordflow">if</span> (callback(x1, y1, userData) == 0) {
<a name="l01704"></a>01704                 <span class="keywordflow">return</span>;
<a name="l01705"></a>01705             }
<a name="l01706"></a>01706         }
<a name="l01707"></a>01707     }
<a name="l01708"></a>01708     <span class="keywordflow">else</span> {
<a name="l01709"></a>01709         <span class="comment">// error may go below zero</span>
<a name="l01710"></a>01710         <span class="keywordtype">int</span> <a class="code" href="../../d3/d22/seqeffects_8c.html#a7b34dac1400e04787532993b40ad9814">error</a> = delta_x - (delta_y &gt;&gt; 1);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         <span class="keywordflow">while</span> (y1 != y2) {
<a name="l01713"></a>01713             <span class="keywordflow">if</span> (error &gt;= 0) {
<a name="l01714"></a>01714                 <span class="keywordflow">if</span> (error || (iy &gt; 0)) {
<a name="l01715"></a>01715                     x1 += ix;
<a name="l01716"></a>01716                     error -= delta_y;
<a name="l01717"></a>01717                 }
<a name="l01718"></a>01718                 <span class="comment">// else do nothing</span>
<a name="l01719"></a>01719             }
<a name="l01720"></a>01720             <span class="comment">// else do nothing</span>
<a name="l01721"></a>01721 
<a name="l01722"></a>01722             y1 += iy;
<a name="l01723"></a>01723             error += delta_x;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725             <span class="keywordflow">if</span> (callback(x1, y1, userData) == 0) {
<a name="l01726"></a>01726                 <span class="keywordflow">return</span>;
<a name="l01727"></a>01727             }
<a name="l01728"></a>01728         }
<a name="l01729"></a>01729     }
<a name="l01730"></a>01730 }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 <span class="comment">/****************************** Interpolation ********************************/</span>
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 <span class="comment">/* get the 2 dominant axis values, 0==X, 1==Y, 2==Z */</span>
<a name="l01735"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a1d7ee186236c67b1591049c92c382e0d">01735</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(<span class="keywordtype">int</span> *axis_a, <span class="keywordtype">int</span> *axis_b, <span class="keyword">const</span> <span class="keywordtype">float</span> axis[3])
<a name="l01736"></a>01736 {
<a name="l01737"></a>01737     <span class="keyword">const</span> <span class="keywordtype">float</span> xn = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(axis[0]);
<a name="l01738"></a>01738     <span class="keyword">const</span> <span class="keywordtype">float</span> yn = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(axis[1]);
<a name="l01739"></a>01739     <span class="keyword">const</span> <span class="keywordtype">float</span> zn = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(axis[2]);
<a name="l01740"></a>01740 
<a name="l01741"></a>01741     <span class="keywordflow">if</span>      (zn &gt;= xn &amp;&amp; zn &gt;= yn) { *axis_a= 0; *axis_b = 1; }
<a name="l01742"></a>01742     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (yn &gt;= xn &amp;&amp; yn &gt;= zn) { *axis_a= 0; *axis_b = 2; }
<a name="l01743"></a>01743     <span class="keywordflow">else</span>                           { *axis_a= 1; *axis_b = 2; }
<a name="l01744"></a>01744 }
<a name="l01745"></a>01745 
<a name="l01746"></a><a class="code" href="../../d3/d61/math__geom_8c.html#add8b0119e4245c2bae00ec3aa0c240e7">01746</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#add8b0119e4245c2bae00ec3aa0c240e7">tri_signed_area</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> j)
<a name="l01747"></a>01747 {
<a name="l01748"></a>01748     <span class="keywordflow">return</span> 0.5f * ((v1[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - v2[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) * (v2[j] - v3[j]) + (v1[j] - v2[j]) * (v3[i] - v2[i]));
<a name="l01749"></a>01749 }
<a name="l01750"></a>01750 
<a name="l01751"></a>01751 <span class="comment">/* return 1 when degenerate */</span>
<a name="l01752"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a3d334ad772762bf58b61de0d73655d34">01752</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a3d334ad772762bf58b61de0d73655d34">barycentric_weights</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> n[3], <span class="keywordtype">float</span> w[3])
<a name="l01753"></a>01753 {
<a name="l01754"></a>01754     <span class="keywordtype">float</span> wtot;
<a name="l01755"></a>01755     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01756"></a>01756 
<a name="l01757"></a>01757     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(&amp;i, &amp;j, n);
<a name="l01758"></a>01758 
<a name="l01759"></a>01759     w[0] = <a class="code" href="../../d3/d61/math__geom_8c.html#add8b0119e4245c2bae00ec3aa0c240e7">tri_signed_area</a>(v2, v3, co, i, j);
<a name="l01760"></a>01760     w[1] = <a class="code" href="../../d3/d61/math__geom_8c.html#add8b0119e4245c2bae00ec3aa0c240e7">tri_signed_area</a>(v3, v1, co, i, j);
<a name="l01761"></a>01761     w[2] = <a class="code" href="../../d3/d61/math__geom_8c.html#add8b0119e4245c2bae00ec3aa0c240e7">tri_signed_area</a>(v1, v2, co, i, j);
<a name="l01762"></a>01762 
<a name="l01763"></a>01763     wtot = w[0] + w[1] + w[2];
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(wtot) &gt; FLT_EPSILON) {
<a name="l01766"></a>01766         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(w, 1.0f / wtot);
<a name="l01767"></a>01767         <span class="keywordflow">return</span> 0;
<a name="l01768"></a>01768     }
<a name="l01769"></a>01769     <span class="keywordflow">else</span> {
<a name="l01770"></a>01770         <span class="comment">/* zero area triangle */</span>
<a name="l01771"></a>01771         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac91c4e2c09412366f3cb04db8a2e5798">copy_v3_fl</a>(w, 1.0f / 3.0f);
<a name="l01772"></a>01772         <span class="keywordflow">return</span> 1;
<a name="l01773"></a>01773     }
<a name="l01774"></a>01774 }
<a name="l01775"></a>01775 
<a name="l01776"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a23f38a5cb4a980d9a0ec93cf78d3cf20">01776</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6c56a0f699c1c3585b26b6e8e9d16fd0">interp_weights_face_v3</a>(<span class="keywordtype">float</span> w[4], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l01777"></a>01777 {
<a name="l01778"></a>01778     <span class="keywordtype">float</span> w2[3];
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     w[0] = w[1] = w[2] = w[3] = 0.0f;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782     <span class="comment">/* first check for exact match */</span>
<a name="l01783"></a>01783     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(co, v1))
<a name="l01784"></a>01784         w[0] = 1.0f;
<a name="l01785"></a>01785     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(co, v2))
<a name="l01786"></a>01786         w[1] = 1.0f;
<a name="l01787"></a>01787     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(co, v3))
<a name="l01788"></a>01788         w[2] = 1.0f;
<a name="l01789"></a>01789     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v4 &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(co, v4))
<a name="l01790"></a>01790         w[3] = 1.0f;
<a name="l01791"></a>01791     <span class="keywordflow">else</span> {
<a name="l01792"></a>01792         <span class="comment">/* otherwise compute barycentric interpolation weights */</span>
<a name="l01793"></a>01793         <span class="keywordtype">float</span> n1[3], n2[3], n[3];
<a name="l01794"></a>01794         <span class="keywordtype">int</span> degenerate;
<a name="l01795"></a>01795 
<a name="l01796"></a>01796         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(n1, v1, v3);
<a name="l01797"></a>01797         <span class="keywordflow">if</span> (v4) {
<a name="l01798"></a>01798             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(n2, v2, v4);
<a name="l01799"></a>01799         }
<a name="l01800"></a>01800         <span class="keywordflow">else</span> {
<a name="l01801"></a>01801             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(n2, v2, v3);
<a name="l01802"></a>01802         }
<a name="l01803"></a>01803         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(n, n1, n2);
<a name="l01804"></a>01804 
<a name="l01805"></a>01805         <span class="comment">/* OpenGL seems to split this way, so we do too */</span>
<a name="l01806"></a>01806         <span class="keywordflow">if</span> (v4) {
<a name="l01807"></a>01807             degenerate = <a class="code" href="../../d3/d61/math__geom_8c.html#a3d334ad772762bf58b61de0d73655d34">barycentric_weights</a>(v1, v2, v4, co, n, w);
<a name="l01808"></a>01808             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<span class="keywordtype">float</span>, w[2], w[3]);
<a name="l01809"></a>01809 
<a name="l01810"></a>01810             <span class="keywordflow">if</span> (degenerate || (w[0] &lt; 0.0f)) {
<a name="l01811"></a>01811                 <span class="comment">/* if w[1] is negative, co is on the other side of the v1-v3 edge,</span>
<a name="l01812"></a>01812 <span class="comment">                 * so we interpolate using the other triangle */</span>
<a name="l01813"></a>01813                 degenerate = <a class="code" href="../../d3/d61/math__geom_8c.html#a3d334ad772762bf58b61de0d73655d34">barycentric_weights</a>(v2, v3, v4, co, n, w2);
<a name="l01814"></a>01814 
<a name="l01815"></a>01815                 <span class="keywordflow">if</span> (!degenerate) {
<a name="l01816"></a>01816                     w[0] = 0.0f;
<a name="l01817"></a>01817                     w[1] = w2[0];
<a name="l01818"></a>01818                     w[2] = w2[1];
<a name="l01819"></a>01819                     w[3] = w2[2];
<a name="l01820"></a>01820                 }
<a name="l01821"></a>01821             }
<a name="l01822"></a>01822         }
<a name="l01823"></a>01823         <span class="keywordflow">else</span>
<a name="l01824"></a>01824             <a class="code" href="../../d3/d61/math__geom_8c.html#a3d334ad772762bf58b61de0d73655d34">barycentric_weights</a>(v1, v2, v3, co, n, w);
<a name="l01825"></a>01825     }
<a name="l01826"></a>01826 }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828 <span class="comment">/* used by projection painting</span>
<a name="l01829"></a>01829 <span class="comment"> * note: using area_tri_signed_v2 means locations outside the triangle are correctly weighted */</span>
<a name="l01830"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a377546ea50356062df670816ec2e857f">01830</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[2], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[2], <span class="keywordtype">float</span> w[3])
<a name="l01831"></a>01831 {
<a name="l01832"></a>01832     <span class="keywordtype">float</span> wtot;
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     w[0] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v2, v3, co);
<a name="l01835"></a>01835     w[1] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v3, v1, co);
<a name="l01836"></a>01836     w[2] = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5d6fbabbcf0c1d6d349e4f0f704e9da8">area_tri_signed_v2</a>(v1, v2, co);
<a name="l01837"></a>01837     wtot = w[0] + w[1] + w[2];
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     <span class="keywordflow">if</span> (wtot != 0.0f) {
<a name="l01840"></a>01840         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(w, 1.0f / wtot);
<a name="l01841"></a>01841     }
<a name="l01842"></a>01842     <span class="keywordflow">else</span> { <span class="comment">/* dummy values for zero area face */</span>
<a name="l01843"></a>01843         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac91c4e2c09412366f3cb04db8a2e5798">copy_v3_fl</a>(w, 1.0f / 3.0f);
<a name="l01844"></a>01844     }
<a name="l01845"></a>01845 }
<a name="l01846"></a>01846 
<a name="l01847"></a>01847 <span class="comment">/* given 2 triangles in 3D space, and a point in relation to the first triangle.</span>
<a name="l01848"></a>01848 <span class="comment"> * calculate the location of a point in relation to the second triangle.</span>
<a name="l01849"></a>01849 <span class="comment"> * Useful for finding relative positions with geometry */</span>
<a name="l01850"></a><a class="code" href="../../d3/d61/math__geom_8c.html#afe1f56977f87b3329b4fe9022793cad2">01850</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#afe1f56977f87b3329b4fe9022793cad2">barycentric_transform</a>(<span class="keywordtype">float</span> pt_tar[3], <span class="keywordtype">float</span> <span class="keyword">const</span> pt_src[3],
<a name="l01851"></a>01851                            <span class="keyword">const</span> <span class="keywordtype">float</span> tri_tar_p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> tri_tar_p2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> tri_tar_p3[3],
<a name="l01852"></a>01852                            <span class="keyword">const</span> <span class="keywordtype">float</span> tri_src_p1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> tri_src_p2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> tri_src_p3[3])
<a name="l01853"></a>01853 {
<a name="l01854"></a>01854     <span class="comment">/* this works by moving the source triangle so its normal is pointing on the Z</span>
<a name="l01855"></a>01855 <span class="comment">     * axis where its barycentric wights can be calculated in 2D and its Z offset can</span>
<a name="l01856"></a>01856 <span class="comment">     *  be re-applied. The weights are applied directly to the targets 3D points and the</span>
<a name="l01857"></a>01857 <span class="comment">     *  z-depth is used to scale the targets normal as an offset.</span>
<a name="l01858"></a>01858 <span class="comment">     * This saves transforming the target into its Z-Up orientation and back (which could also work) */</span>
<a name="l01859"></a>01859     <span class="keyword">const</span> <span class="keywordtype">float</span> z_up[3] = {0, 0, 1};
<a name="l01860"></a>01860     <span class="keywordtype">float</span> no_tar[3], no_src[3];
<a name="l01861"></a>01861     <span class="keywordtype">float</span> quat_src[4];
<a name="l01862"></a>01862     <span class="keywordtype">float</span> pt_src_xy[3];
<a name="l01863"></a>01863     <span class="keywordtype">float</span> tri_xy_src[3][3];
<a name="l01864"></a>01864     <span class="keywordtype">float</span> w_src[3];
<a name="l01865"></a>01865     <span class="keywordtype">float</span> area_tar, area_src;
<a name="l01866"></a>01866     <span class="keywordtype">float</span> z_ofs_src;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(no_tar, tri_tar_p1, tri_tar_p2, tri_tar_p3);
<a name="l01869"></a>01869     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(no_src, tri_src_p1, tri_src_p2, tri_src_p3);
<a name="l01870"></a>01870 
<a name="l01871"></a>01871     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a1c43d6841215a62105c340b1418afb13">rotation_between_vecs_to_quat</a>(quat_src, no_src, z_up);
<a name="l01872"></a>01872     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a58e1ba0822577e22846bd4352f111e81">normalize_qt</a>(quat_src);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(pt_src_xy, pt_src);
<a name="l01875"></a>01875     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tri_xy_src[0], tri_src_p1);
<a name="l01876"></a>01876     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tri_xy_src[1], tri_src_p2);
<a name="l01877"></a>01877     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(tri_xy_src[2], tri_src_p3);
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <span class="comment">/* make the source tri xy space */</span>
<a name="l01880"></a>01880     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(quat_src, pt_src_xy);
<a name="l01881"></a>01881     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(quat_src, tri_xy_src[0]);
<a name="l01882"></a>01882     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(quat_src, tri_xy_src[1]);
<a name="l01883"></a>01883     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#a654dd0df4df6f960e592032f276f2c68">mul_qt_v3</a>(quat_src, tri_xy_src[2]);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a377546ea50356062df670816ec2e857f">barycentric_weights_v2</a>(tri_xy_src[0], tri_xy_src[1], tri_xy_src[2], pt_src_xy, w_src);
<a name="l01886"></a>01886     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a426276a41746c07bed2a5cda1115112a">interp_v3_v3v3v3</a>(pt_tar, tri_tar_p1, tri_tar_p2, tri_tar_p3, w_src);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888     area_tar = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7f7cdc9495876ea234a775a93dc7d4c5">area_tri_v3</a>(tri_tar_p1, tri_tar_p2, tri_tar_p3));
<a name="l01889"></a>01889     area_src = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3f091986e48e70838ae9d8a6ca929337">area_tri_v2</a>(tri_xy_src[0], tri_xy_src[1], tri_xy_src[2]));
<a name="l01890"></a>01890 
<a name="l01891"></a>01891     z_ofs_src = pt_src_xy[2] - tri_xy_src[0][2];
<a name="l01892"></a>01892     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac993b3c38bb2d5e7de48e57aab03db7f">madd_v3_v3v3fl</a>(pt_tar, pt_tar, no_tar, (z_ofs_src / area_src) * area_tar);
<a name="l01893"></a>01893 }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895 <span class="comment">/* given an array with some invalid values this function interpolates valid values</span>
<a name="l01896"></a>01896 <span class="comment"> * replacing the invalid ones */</span>
<a name="l01897"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a24bc8f934478d75828f4a688bc77ead0">01897</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3d69a68d0af9dbd05ccf8af4a86bef2d">interp_sparse_array</a>(<span class="keywordtype">float</span> *<a class="code" href="../../d2/d41/classarray.html">array</a>, <span class="keywordtype">int</span> <span class="keyword">const</span> list_size, <span class="keyword">const</span> <span class="keywordtype">float</span> skipval)
<a name="l01898"></a>01898 {
<a name="l01899"></a>01899     <span class="keywordtype">int</span> found_invalid = 0;
<a name="l01900"></a>01900     <span class="keywordtype">int</span> found_valid = 0;
<a name="l01901"></a>01901     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01902"></a>01902 
<a name="l01903"></a>01903     <span class="keywordflow">for</span> (i = 0; i &lt; list_size; i++) {
<a name="l01904"></a>01904         <span class="keywordflow">if</span> (array[i] == skipval)
<a name="l01905"></a>01905             found_invalid = 1;
<a name="l01906"></a>01906         <span class="keywordflow">else</span>
<a name="l01907"></a>01907             found_valid = 1;
<a name="l01908"></a>01908     }
<a name="l01909"></a>01909 
<a name="l01910"></a>01910     <span class="keywordflow">if</span> (found_valid == 0) {
<a name="l01911"></a>01911         <span class="keywordflow">return</span> -1;
<a name="l01912"></a>01912     }
<a name="l01913"></a>01913     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (found_invalid == 0) {
<a name="l01914"></a>01914         <span class="keywordflow">return</span> 0;
<a name="l01915"></a>01915     }
<a name="l01916"></a>01916     <span class="keywordflow">else</span> {
<a name="l01917"></a>01917         <span class="comment">/* found invalid depths, interpolate */</span>
<a name="l01918"></a>01918         <span class="keywordtype">float</span> valid_last = skipval;
<a name="l01919"></a>01919         <span class="keywordtype">int</span> valid_ofs = 0;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <span class="keywordtype">float</span> *array_up = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * list_size, <span class="stringliteral">&quot;interp_sparse_array up&quot;</span>);
<a name="l01922"></a>01922         <span class="keywordtype">float</span> *array_down = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * list_size, <span class="stringliteral">&quot;interp_sparse_array up&quot;</span>);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924         <span class="keywordtype">int</span> *ofs_tot_up = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * list_size, <span class="stringliteral">&quot;interp_sparse_array tup&quot;</span>);
<a name="l01925"></a>01925         <span class="keywordtype">int</span> *ofs_tot_down = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * list_size, <span class="stringliteral">&quot;interp_sparse_array tdown&quot;</span>);
<a name="l01926"></a>01926 
<a name="l01927"></a>01927         <span class="keywordflow">for</span> (i = 0; i &lt; list_size; i++) {
<a name="l01928"></a>01928             <span class="keywordflow">if</span> (array[i] == skipval) {
<a name="l01929"></a>01929                 array_up[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = valid_last;
<a name="l01930"></a>01930                 ofs_tot_up[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ++valid_ofs;
<a name="l01931"></a>01931             }
<a name="l01932"></a>01932             <span class="keywordflow">else</span> {
<a name="l01933"></a>01933                 valid_last = array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01934"></a>01934                 valid_ofs = 0;
<a name="l01935"></a>01935             }
<a name="l01936"></a>01936         }
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         valid_last = skipval;
<a name="l01939"></a>01939         valid_ofs = 0;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941         <span class="keywordflow">for</span> (i = list_size - 1; i &gt;= 0; i--) {
<a name="l01942"></a>01942             <span class="keywordflow">if</span> (array[i] == skipval) {
<a name="l01943"></a>01943                 array_down[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = valid_last;
<a name="l01944"></a>01944                 ofs_tot_down[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ++valid_ofs;
<a name="l01945"></a>01945             }
<a name="l01946"></a>01946             <span class="keywordflow">else</span> {
<a name="l01947"></a>01947                 valid_last = array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01948"></a>01948                 valid_ofs = 0;
<a name="l01949"></a>01949             }
<a name="l01950"></a>01950         }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952         <span class="comment">/* now blend */</span>
<a name="l01953"></a>01953         <span class="keywordflow">for</span> (i = 0; i &lt; list_size; i++) {
<a name="l01954"></a>01954             <span class="keywordflow">if</span> (array[i] == skipval) {
<a name="l01955"></a>01955                 <span class="keywordflow">if</span> (array_up[i] != skipval &amp;&amp; array_down[i] != skipval) {
<a name="l01956"></a>01956                     array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ((array_up[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] * ofs_tot_down[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]) + (array_down[i] * ofs_tot_up[i])) / (<span class="keywordtype">float</span>)(ofs_tot_down[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] + ofs_tot_up[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l01957"></a>01957                 }
<a name="l01958"></a>01958                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (array_up[i] != skipval) {
<a name="l01959"></a>01959                     array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = array_up[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01960"></a>01960                 }
<a name="l01961"></a>01961                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (array_down[i] != skipval) {
<a name="l01962"></a>01962                     array[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = array_down[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01963"></a>01963                 }
<a name="l01964"></a>01964             }
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966 
<a name="l01967"></a>01967         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array_up);
<a name="l01968"></a>01968         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(array_down);
<a name="l01969"></a>01969 
<a name="l01970"></a>01970         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ofs_tot_up);
<a name="l01971"></a>01971         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ofs_tot_down);
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <span class="keywordflow">return</span> 1;
<a name="l01975"></a>01975 }
<a name="l01976"></a>01976 
<a name="l01977"></a>01977 <span class="comment">/* Mean value weights - smooth interpolation weights for polygons with</span>
<a name="l01978"></a>01978 <span class="comment"> * more than 3 vertices */</span>
<a name="l01979"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a1394056ef114378fe34302c6587ed334">01979</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a1394056ef114378fe34302c6587ed334">mean_value_half_tan</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01980"></a>01980 {
<a name="l01981"></a>01981     <span class="keywordtype">float</span> d2[3], d3[3], <a class="code" href="../../d1/d22/stdosl_8h.html#af89a44efb4de11d737647ee46ef3d304">cross</a>[3], area, <a class="code" href="../../d1/d22/stdosl_8h.html#aedba6e917e11b0571459516317985220">dot</a>, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d2, v2, v1);
<a name="l01984"></a>01984     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(d3, v3, v1);
<a name="l01985"></a>01985     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(cross, d2, d3);
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     area = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(cross);
<a name="l01988"></a>01988     dot = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(d2, d3);
<a name="l01989"></a>01989     len = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(d2) * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(d3);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991     <span class="keywordflow">if</span> (area == 0.0f)
<a name="l01992"></a>01992         <span class="keywordflow">return</span> 0.0f;
<a name="l01993"></a>01993     <span class="keywordflow">else</span>
<a name="l01994"></a>01994         <span class="keywordflow">return</span> (len - dot) / area;
<a name="l01995"></a>01995 }
<a name="l01996"></a>01996 
<a name="l01997"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aedfa447ecda48cb177a8fbe2454ea6c8">01997</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a9ad37845c890fd4002636cd5a5145b8d">interp_weights_poly_v3</a>(<span class="keywordtype">float</span> *w, <span class="keywordtype">float</span> v[][3], <span class="keyword">const</span> <span class="keywordtype">int</span> n, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l01998"></a>01998 {
<a name="l01999"></a>01999     <span class="keywordtype">float</span> totweight, t1, t2, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>, *vmid, *vprev, *vnext;
<a name="l02000"></a>02000     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02001"></a>02001 
<a name="l02002"></a>02002     totweight = 0.0f;
<a name="l02003"></a>02003 
<a name="l02004"></a>02004     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l02005"></a>02005         vmid = v[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02006"></a>02006         vprev = (i == 0) ? v[n - 1] : v[i - 1];
<a name="l02007"></a>02007         vnext = (i == n - 1) ? v[0] : v[i + 1];
<a name="l02008"></a>02008 
<a name="l02009"></a>02009         t1 = <a class="code" href="../../d3/d61/math__geom_8c.html#a1394056ef114378fe34302c6587ed334">mean_value_half_tan</a>(co, vprev, vmid);
<a name="l02010"></a>02010         t2 = <a class="code" href="../../d3/d61/math__geom_8c.html#a1394056ef114378fe34302c6587ed334">mean_value_half_tan</a>(co, vmid, vnext);
<a name="l02011"></a>02011 
<a name="l02012"></a>02012         len = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(co, vmid);
<a name="l02013"></a>02013         w[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (t1 + t2) / len;
<a name="l02014"></a>02014         totweight += w[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02015"></a>02015     }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017     <span class="keywordflow">if</span> (totweight != 0.0f)
<a name="l02018"></a>02018         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l02019"></a>02019             w[i] /= totweight;
<a name="l02020"></a>02020 }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022 <span class="comment">/* (x1,v1)(t1=0)------(x2,v2)(t2=1), 0&lt;t&lt;1 --&gt; (x,v)(t) */</span>
<a name="l02023"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aae83a4b52e918e36a98cdca3e9e6f2f1">02023</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aae83a4b52e918e36a98cdca3e9e6f2f1">interp_cubic_v3</a>(<span class="keywordtype">float</span> x[3], <span class="keywordtype">float</span> v[3], <span class="keyword">const</span> <span class="keywordtype">float</span> x1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> x2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> t)
<a name="l02024"></a>02024 {
<a name="l02025"></a>02025     <span class="keywordtype">float</span> a[3], b[3];
<a name="l02026"></a>02026     <span class="keywordtype">float</span> t2 = t * t;
<a name="l02027"></a>02027     <span class="keywordtype">float</span> t3 = t2 * t;
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     <span class="comment">/* cubic interpolation */</span>
<a name="l02030"></a>02030     a[0] = v1[0] + v2[0] + 2 * (x1[0] - x2[0]);
<a name="l02031"></a>02031     a[1] = v1[1] + v2[1] + 2 * (x1[1] - x2[1]);
<a name="l02032"></a>02032     a[2] = v1[2] + v2[2] + 2 * (x1[2] - x2[2]);
<a name="l02033"></a>02033 
<a name="l02034"></a>02034     b[0] = -2 * v1[0] - v2[0] - 3 * (x1[0] - x2[0]);
<a name="l02035"></a>02035     b[1] = -2 * v1[1] - v2[1] - 3 * (x1[1] - x2[1]);
<a name="l02036"></a>02036     b[2] = -2 * v1[2] - v2[2] - 3 * (x1[2] - x2[2]);
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     x[0] = a[0] * t3 + b[0] * t2 + v1[0] * t + x1[0];
<a name="l02039"></a>02039     x[1] = a[1] * t3 + b[1] * t2 + v1[1] * t + x1[1];
<a name="l02040"></a>02040     x[2] = a[2] * t3 + b[2] * t2 + v1[2] * t + x1[2];
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     v[0] = 3 * a[0] * t2 + 2 * b[0] * t + v1[0];
<a name="l02043"></a>02043     v[1] = 3 * a[1] * t2 + 2 * b[1] * t + v1[1];
<a name="l02044"></a>02044     v[2] = 3 * a[2] * t2 + 2 * b[2] * t + v1[2];
<a name="l02045"></a>02045 }
<a name="l02046"></a>02046 
<a name="l02047"></a>02047 <span class="comment">/* unfortunately internal calculations have to be done at double precision to achieve correct/stable results. */</span>
<a name="l02048"></a>02048 
<a name="l02049"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a0a69594b2ea1ac8262ab37a48fe774ff">02049</a> <span class="preprocessor">#define IS_ZERO(x) ((x &gt; (-DBL_EPSILON) &amp;&amp; x &lt; DBL_EPSILON) ? 1 : 0)</span>
<a name="l02050"></a>02050 <span class="preprocessor"></span>
<a name="l02051"></a>02051 <span class="comment">/* Barycentric reverse  */</span>
<a name="l02052"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a3b21d6ce6bebb39febe24bb62ba150f5">02052</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a3b21d6ce6bebb39febe24bb62ba150f5">resolve_tri_uv</a>(<span class="keywordtype">float</span> r_uv[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st0[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st2[2])
<a name="l02053"></a>02053 {
<a name="l02054"></a>02054     <span class="comment">/* find UV such that</span>
<a name="l02055"></a>02055 <span class="comment">     * t = u * t0 + v * t1 + (1 - u - v) * t2</span>
<a name="l02056"></a>02056 <span class="comment">     * u * (t0 - t2) + v * (t1 - t2) = t - t2 */</span>
<a name="l02057"></a>02057     <span class="keyword">const</span> <span class="keywordtype">double</span> a = st0[0] - st2[0], b = st1[0] - st2[0];
<a name="l02058"></a>02058     <span class="keyword">const</span> <span class="keywordtype">double</span> c = st0[1] - st2[1], d = st1[1] - st2[1];
<a name="l02059"></a>02059     <span class="keyword">const</span> <span class="keywordtype">double</span> det = a * d - c * b;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0a69594b2ea1ac8262ab37a48fe774ff">IS_ZERO</a>(det) == 0) { <span class="comment">/* det should never be zero since the determinant is the signed ST area of the triangle. */</span>
<a name="l02062"></a>02062         <span class="keyword">const</span> <span class="keywordtype">double</span> x[] = {st[0] - st2[0], st[1] - st2[1]};
<a name="l02063"></a>02063 
<a name="l02064"></a>02064         r_uv[0] = (float)((d * x[0] - b * x[1]) / det);
<a name="l02065"></a>02065         r_uv[1] = (float)(((-c) * x[0] + a * x[1]) / det);
<a name="l02066"></a>02066     }
<a name="l02067"></a>02067     <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(r_uv);
<a name="l02068"></a>02068 }
<a name="l02069"></a>02069 
<a name="l02070"></a>02070 <span class="comment">/* bilinear reverse */</span>
<a name="l02071"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a25ccb8a6823efd69f4bf041238b81601">02071</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aa3a0b3c83afe874d2639015f794fb01c">resolve_quad_uv</a>(<span class="keywordtype">float</span> r_uv[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st0[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st1[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st2[2], <span class="keyword">const</span> <span class="keywordtype">float</span> st3[2])
<a name="l02072"></a>02072 {
<a name="l02073"></a>02073     <span class="keyword">const</span> <span class="keywordtype">double</span> signed_area = (st0[0] * st1[1] - st0[1] * st1[0]) + (st1[0] * st2[1] - st1[1] * st2[0]) +
<a name="l02074"></a>02074                                (st2[0] * st3[1] - st2[1] * st3[0]) + (st3[0] * st0[1] - st3[1] * st0[0]);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076     <span class="comment">/* X is 2D cross product (determinant)</span>
<a name="l02077"></a>02077 <span class="comment">     * A= (p0-p) X (p0-p3)*/</span>
<a name="l02078"></a>02078     <span class="keyword">const</span> <span class="keywordtype">double</span> a = (st0[0] - st[0]) * (st0[1] - st3[1]) - (st0[1] - st[1]) * (st0[0] - st3[0]);
<a name="l02079"></a>02079 
<a name="l02080"></a>02080     <span class="comment">/* B= ( (p0-p) X (p1-p2) + (p1-p) X (p0-p3) ) / 2 */</span>
<a name="l02081"></a>02081     <span class="keyword">const</span> <span class="keywordtype">double</span> b = 0.5 * (((st0[0] - st[0]) * (st1[1] - st2[1]) - (st0[1] - st[1]) * (st1[0] - st2[0])) +
<a name="l02082"></a>02082                             ((st1[0] - st[0]) * (st0[1] - st3[1]) - (st1[1] - st[1]) * (st0[0] - st3[0])));
<a name="l02083"></a>02083 
<a name="l02084"></a>02084     <span class="comment">/* C = (p1-p) X (p1-p2) */</span>
<a name="l02085"></a>02085     <span class="keyword">const</span> <span class="keywordtype">double</span> fC = (st1[0] - st[0]) * (st1[1] - st2[1]) - (st1[1] - st[1]) * (st1[0] - st2[0]);
<a name="l02086"></a>02086     <span class="keyword">const</span> <span class="keywordtype">double</span> denom = a - 2 * b + fC;
<a name="l02087"></a>02087 
<a name="l02088"></a>02088     <span class="comment">// clear outputs</span>
<a name="l02089"></a>02089     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab56b423771c4d41aa565151535978954">zero_v2</a>(r_uv);
<a name="l02090"></a>02090 
<a name="l02091"></a>02091     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0a69594b2ea1ac8262ab37a48fe774ff">IS_ZERO</a>(denom) != 0) {
<a name="l02092"></a>02092         <span class="keyword">const</span> <span class="keywordtype">double</span> fDen = a - fC;
<a name="l02093"></a>02093         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0a69594b2ea1ac8262ab37a48fe774ff">IS_ZERO</a>(fDen) == 0)
<a name="l02094"></a>02094             r_uv[0] = (float)(a / fDen);
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096     <span class="keywordflow">else</span> {
<a name="l02097"></a>02097         <span class="keyword">const</span> <span class="keywordtype">double</span> desc_sq = b * b - a * fC;
<a name="l02098"></a>02098         <span class="keyword">const</span> <span class="keywordtype">double</span> desc = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(desc_sq &lt; 0.0 ? 0.0 : desc_sq);
<a name="l02099"></a>02099         <span class="keyword">const</span> <span class="keywordtype">double</span> s = signed_area &gt; 0 ? (-1.0) : 1.0;
<a name="l02100"></a>02100 
<a name="l02101"></a>02101         r_uv[0] = (float)(((a - b) + s * desc) / denom);
<a name="l02102"></a>02102     }
<a name="l02103"></a>02103 
<a name="l02104"></a>02104     <span class="comment">/* find UV such that</span>
<a name="l02105"></a>02105 <span class="comment">     * fST = (1-u)(1-v) * ST0 + u * (1-v) * ST1 + u * v * ST2 + (1-u) * v * ST3 */</span>
<a name="l02106"></a>02106     {
<a name="l02107"></a>02107         <span class="keyword">const</span> <span class="keywordtype">double</span> denom_s = (1 - r_uv[0]) * (st0[0] - st3[0]) + r_uv[0] * (st1[0] - st2[0]);
<a name="l02108"></a>02108         <span class="keyword">const</span> <span class="keywordtype">double</span> denom_t = (1 - r_uv[0]) * (st0[1] - st3[1]) + r_uv[0] * (st1[1] - st2[1]);
<a name="l02109"></a>02109         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l02110"></a>02110         <span class="keywordtype">double</span> denom = denom_s;
<a name="l02111"></a>02111 
<a name="l02112"></a>02112         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(denom_s) &lt; <a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(denom_t)) {
<a name="l02113"></a>02113             i = 1;
<a name="l02114"></a>02114             denom = denom_t;
<a name="l02115"></a>02115         }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a0a69594b2ea1ac8262ab37a48fe774ff">IS_ZERO</a>(denom) == 0)
<a name="l02118"></a>02118             r_uv[1] = (<span class="keywordtype">float</span>)(((1.0f - r_uv[0]) * (st0[i] - st[i]) + r_uv[0] * (st1[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] - st[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>])) / denom);
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120 }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122 <span class="preprocessor">#undef IS_ZERO</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span>
<a name="l02124"></a>02124 <span class="comment">/***************************** View &amp; Projection *****************************/</span>
<a name="l02125"></a>02125 
<a name="l02126"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a97c8c8bc1178173b226eb0a7758821b9">02126</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae0264cbbfe3f229f9ec380190e1ed8a8">orthographic_m4</a>(<span class="keywordtype">float</span> matrix[][4], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> right, <span class="keyword">const</span> <span class="keywordtype">float</span> bottom, <span class="keyword">const</span> <span class="keywordtype">float</span> top, <span class="keyword">const</span> <span class="keywordtype">float</span> nearClip, <span class="keyword">const</span> <span class="keywordtype">float</span> farClip)
<a name="l02127"></a>02127 {
<a name="l02128"></a>02128     <span class="keywordtype">float</span> Xdelta, Ydelta, Zdelta;
<a name="l02129"></a>02129 
<a name="l02130"></a>02130     Xdelta = right - <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l02131"></a>02131     Ydelta = top - bottom;
<a name="l02132"></a>02132     Zdelta = farClip - nearClip;
<a name="l02133"></a>02133     <span class="keywordflow">if</span> (Xdelta == 0.0f || Ydelta == 0.0f || Zdelta == 0.0f) {
<a name="l02134"></a>02134         <span class="keywordflow">return</span>;
<a name="l02135"></a>02135     }
<a name="l02136"></a>02136     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(matrix);
<a name="l02137"></a>02137     matrix[0][0] = 2.0f / Xdelta;
<a name="l02138"></a>02138     matrix[3][0] = -(right + <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>) / Xdelta;
<a name="l02139"></a>02139     matrix[1][1] = 2.0f / Ydelta;
<a name="l02140"></a>02140     matrix[3][1] = -(top + bottom) / Ydelta;
<a name="l02141"></a>02141     matrix[2][2] = -2.0f / Zdelta; <span class="comment">/* note: negate Z    */</span>
<a name="l02142"></a>02142     matrix[3][2] = -(farClip + nearClip) / Zdelta;
<a name="l02143"></a>02143 }
<a name="l02144"></a>02144 
<a name="l02145"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8e39ae9dcc346cc95db26002260d0ee7">02145</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8e39ae9dcc346cc95db26002260d0ee7">perspective_m4</a>(<span class="keywordtype">float</span> mat[4][4], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> right, <span class="keyword">const</span> <span class="keywordtype">float</span> bottom, <span class="keyword">const</span> <span class="keywordtype">float</span> top, <span class="keyword">const</span> <span class="keywordtype">float</span> nearClip, <span class="keyword">const</span> <span class="keywordtype">float</span> farClip)
<a name="l02146"></a>02146 {
<a name="l02147"></a>02147     <span class="keywordtype">float</span> Xdelta, Ydelta, Zdelta;
<a name="l02148"></a>02148 
<a name="l02149"></a>02149     Xdelta = right - <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>;
<a name="l02150"></a>02150     Ydelta = top - bottom;
<a name="l02151"></a>02151     Zdelta = farClip - nearClip;
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     <span class="keywordflow">if</span> (Xdelta == 0.0f || Ydelta == 0.0f || Zdelta == 0.0f) {
<a name="l02154"></a>02154         <span class="keywordflow">return</span>;
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156     mat[0][0] = nearClip * 2.0f / Xdelta;
<a name="l02157"></a>02157     mat[1][1] = nearClip * 2.0f / Ydelta;
<a name="l02158"></a>02158     mat[2][0] = (right + <a class="code" href="../../db/d0f/navmesh__conversion_8c.html#a4d78fdbccaa4d42dc8599d58cdf0de96">left</a>) / Xdelta; <span class="comment">/* note: negate Z  */</span>
<a name="l02159"></a>02159     mat[2][1] = (top + bottom) / Ydelta;
<a name="l02160"></a>02160     mat[2][2] = -(farClip + nearClip) / Zdelta;
<a name="l02161"></a>02161     mat[2][3] = -1.0f;
<a name="l02162"></a>02162     mat[3][2] = (-2.0f * nearClip * farClip) / Zdelta;
<a name="l02163"></a>02163     mat[0][1] = mat[0][2] = mat[0][3] =
<a name="l02164"></a>02164             mat[1][0] = mat[1][2] = mat[1][3] =
<a name="l02165"></a>02165             mat[3][0] = mat[3][1] = mat[3][3] = 0.0;
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169 <span class="comment">/* translate a matrix created by orthographic_m4 or perspective_m4 in XY coords (used to jitter the view) */</span>
<a name="l02170"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7c4bd960a71691e61aa71afb2a016928">02170</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a7c4bd960a71691e61aa71afb2a016928">window_translate_m4</a>(<span class="keywordtype">float</span> winmat[][4], <span class="keywordtype">float</span> perspmat[][4], <span class="keyword">const</span> <span class="keywordtype">float</span> x, <span class="keyword">const</span> <span class="keywordtype">float</span> y)
<a name="l02171"></a>02171 {
<a name="l02172"></a>02172     <span class="keywordflow">if</span> (winmat[2][3] == -1.0f) {
<a name="l02173"></a>02173         <span class="comment">/* in the case of a win-matrix, this means perspective always */</span>
<a name="l02174"></a>02174         <span class="keywordtype">float</span> v1[3];
<a name="l02175"></a>02175         <span class="keywordtype">float</span> v2[3];
<a name="l02176"></a>02176         <span class="keywordtype">float</span> len1, len2;
<a name="l02177"></a>02177 
<a name="l02178"></a>02178         v1[0] = perspmat[0][0];
<a name="l02179"></a>02179         v1[1] = perspmat[1][0];
<a name="l02180"></a>02180         v1[2] = perspmat[2][0];
<a name="l02181"></a>02181 
<a name="l02182"></a>02182         v2[0] = perspmat[0][1];
<a name="l02183"></a>02183         v2[1] = perspmat[1][1];
<a name="l02184"></a>02184         v2[2] = perspmat[2][1];
<a name="l02185"></a>02185 
<a name="l02186"></a>02186         len1 = (1.0f / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(v1));
<a name="l02187"></a>02187         len2 = (1.0f / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(v2));
<a name="l02188"></a>02188 
<a name="l02189"></a>02189         winmat[2][0] += len1 * winmat[0][0] * x;
<a name="l02190"></a>02190         winmat[2][1] += len2 * winmat[1][1] * y;
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192     <span class="keywordflow">else</span> {
<a name="l02193"></a>02193         winmat[3][0] += x;
<a name="l02194"></a>02194         winmat[3][1] += y;
<a name="l02195"></a>02195     }
<a name="l02196"></a>02196 }
<a name="l02197"></a>02197 
<a name="l02198"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a92d0999f34765fadb5006f8c8d36ac38">02198</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a92d0999f34765fadb5006f8c8d36ac38">i_multmatrix</a>(<span class="keywordtype">float</span> icand[][4], <span class="keywordtype">float</span> Vm[][4])
<a name="l02199"></a>02199 {
<a name="l02200"></a>02200     <span class="keywordtype">int</span> row, col;
<a name="l02201"></a>02201     <span class="keywordtype">float</span> temp[4][4];
<a name="l02202"></a>02202 
<a name="l02203"></a>02203     <span class="keywordflow">for</span> (row = 0; row &lt; 4; row++)
<a name="l02204"></a>02204         <span class="keywordflow">for</span> (col = 0; col &lt; 4; col++)
<a name="l02205"></a>02205             temp[row][col] = (icand[row][0] * Vm[0][col] +
<a name="l02206"></a>02206                               icand[row][1] * Vm[1][col] +
<a name="l02207"></a>02207                               icand[row][2] * Vm[2][col] +
<a name="l02208"></a>02208                               icand[row][3] * Vm[3][col]);
<a name="l02209"></a>02209     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(Vm, temp);
<a name="l02210"></a>02210 }
<a name="l02211"></a>02211 
<a name="l02212"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a4a6e67b47c31fb8248d29d331c24c5fc">02212</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a4f4711de835ab674dbd58478da2fb0b2">polarview_m4</a>(<span class="keywordtype">float</span> Vm[][4], <span class="keywordtype">float</span> dist, <span class="keywordtype">float</span> azimuth, <span class="keywordtype">float</span> incidence, <span class="keywordtype">float</span> twist)
<a name="l02213"></a>02213 {
<a name="l02214"></a>02214 
<a name="l02215"></a>02215     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(Vm);
<a name="l02216"></a>02216 
<a name="l02217"></a>02217     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a684efb1794a8bf6610559e5df23484f1">translate_m4</a>(Vm, 0.0, 0.0, -dist);
<a name="l02218"></a>02218     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#afcc068c37902397b59b109c4ce769925">rotate_m4</a>(Vm, <span class="charliteral">&#39;Z&#39;</span>, -twist);
<a name="l02219"></a>02219     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#afcc068c37902397b59b109c4ce769925">rotate_m4</a>(Vm, <span class="charliteral">&#39;X&#39;</span>, -incidence);
<a name="l02220"></a>02220     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#afcc068c37902397b59b109c4ce769925">rotate_m4</a>(Vm, <span class="charliteral">&#39;Z&#39;</span>, -azimuth);
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02223"></a><a class="code" href="../../d3/d61/math__geom_8c.html#af7928309bbdcb18a69fa794c71e344cb">02223</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8ea4e9fc1c38f07e5479d37b86d2ef05">lookat_m4</a>(<span class="keywordtype">float</span> mat[][4], <span class="keywordtype">float</span> vx, <span class="keywordtype">float</span> vy, <span class="keywordtype">float</span> vz, <span class="keywordtype">float</span> px, <span class="keywordtype">float</span> py, <span class="keywordtype">float</span> pz, <span class="keywordtype">float</span> twist)
<a name="l02224"></a>02224 {
<a name="l02225"></a>02225     <span class="keywordtype">float</span> sine, cosine, hyp, hyp1, dx, dy, dz;
<a name="l02226"></a>02226     <span class="keywordtype">float</span> mat1[4][4] = <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0e2ef61ffa876947da5d7dfb15d79230">MAT4_UNITY</a>;
<a name="l02227"></a>02227 
<a name="l02228"></a>02228     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(mat);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#afcc068c37902397b59b109c4ce769925">rotate_m4</a>(mat, <span class="charliteral">&#39;Z&#39;</span>, -twist);
<a name="l02231"></a>02231 
<a name="l02232"></a>02232     dx = px - vx;
<a name="l02233"></a>02233     dy = py - vy;
<a name="l02234"></a>02234     dz = pz - vz;
<a name="l02235"></a>02235     hyp = dx * dx + dz * dz; <span class="comment">/* hyp squared */</span>
<a name="l02236"></a>02236     hyp1 = (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(dy * dy + hyp);
<a name="l02237"></a>02237     hyp = (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#aa3fc8738e36a262f694814c04e8ef744">sqrt</a>(hyp); <span class="comment">/* the real hyp */</span>
<a name="l02238"></a>02238 
<a name="l02239"></a>02239     <span class="keywordflow">if</span> (hyp1 != 0.0f) { <span class="comment">/* rotate X */</span>
<a name="l02240"></a>02240         sine = -dy / hyp1;
<a name="l02241"></a>02241         cosine = hyp / hyp1;
<a name="l02242"></a>02242     }
<a name="l02243"></a>02243     <span class="keywordflow">else</span> {
<a name="l02244"></a>02244         sine = 0;
<a name="l02245"></a>02245         cosine = 1.0f;
<a name="l02246"></a>02246     }
<a name="l02247"></a>02247     mat1[1][1] = cosine;
<a name="l02248"></a>02248     mat1[1][2] = sine;
<a name="l02249"></a>02249     mat1[2][1] = -sine;
<a name="l02250"></a>02250     mat1[2][2] = cosine;
<a name="l02251"></a>02251 
<a name="l02252"></a>02252     <a class="code" href="../../d3/d61/math__geom_8c.html#a92d0999f34765fadb5006f8c8d36ac38">i_multmatrix</a>(mat1, mat);
<a name="l02253"></a>02253 
<a name="l02254"></a>02254     mat1[1][1] = mat1[2][2] = 1.0f; <span class="comment">/* be careful here to reinit    */</span>
<a name="l02255"></a>02255     mat1[1][2] = mat1[2][1] = 0.0; <span class="comment">/* those modified by the last    */</span>
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     <span class="comment">/* paragraph    */</span>
<a name="l02258"></a>02258     <span class="keywordflow">if</span> (hyp != 0.0f) { <span class="comment">/* rotate Y  */</span>
<a name="l02259"></a>02259         sine = dx / hyp;
<a name="l02260"></a>02260         cosine = -dz / hyp;
<a name="l02261"></a>02261     }
<a name="l02262"></a>02262     <span class="keywordflow">else</span> {
<a name="l02263"></a>02263         sine = 0;
<a name="l02264"></a>02264         cosine = 1.0f;
<a name="l02265"></a>02265     }
<a name="l02266"></a>02266     mat1[0][0] = cosine;
<a name="l02267"></a>02267     mat1[0][2] = -sine;
<a name="l02268"></a>02268     mat1[2][0] = sine;
<a name="l02269"></a>02269     mat1[2][2] = cosine;
<a name="l02270"></a>02270 
<a name="l02271"></a>02271     <a class="code" href="../../d3/d61/math__geom_8c.html#a92d0999f34765fadb5006f8c8d36ac38">i_multmatrix</a>(mat1, mat);
<a name="l02272"></a>02272     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a684efb1794a8bf6610559e5df23484f1">translate_m4</a>(mat, -vx, -vy, -vz); <span class="comment">/* translate viewpoint to origin */</span>
<a name="l02273"></a>02273 }
<a name="l02274"></a>02274 
<a name="l02275"></a><a class="code" href="../../d3/d61/math__geom_8c.html#abab563788f70909b48f0384e410dc00a">02275</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#abab563788f70909b48f0384e410dc00a">box_clip_bounds_m4</a>(<span class="keywordtype">float</span> boundbox[2][3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a42f734331cf10fc65cd1c80c5d764ebc">bounds</a>[4], <span class="keywordtype">float</span> winmat[4][4])
<a name="l02276"></a>02276 {
<a name="l02277"></a>02277     <span class="keywordtype">float</span> mat[4][4], vec[4];
<a name="l02278"></a>02278     <span class="keywordtype">int</span> a, fl, flag = -1;
<a name="l02279"></a>02279 
<a name="l02280"></a>02280     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(mat, winmat);
<a name="l02281"></a>02281 
<a name="l02282"></a>02282     <span class="keywordflow">for</span> (a = 0; a &lt; 8; a++) {
<a name="l02283"></a>02283         vec[0] = (a &amp; 1) ? boundbox[0][0] : boundbox[1][0];
<a name="l02284"></a>02284         vec[1] = (a &amp; 2) ? boundbox[0][1] : boundbox[1][1];
<a name="l02285"></a>02285         vec[2] = (a &amp; 4) ? boundbox[0][2] : boundbox[1][2];
<a name="l02286"></a>02286         vec[3] = 1.0;
<a name="l02287"></a>02287         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a0317104b02abeeb617a3d53af7070820">mul_m4_v4</a>(mat, vec);
<a name="l02288"></a>02288 
<a name="l02289"></a>02289         fl = 0;
<a name="l02290"></a>02290         <span class="keywordflow">if</span> (bounds) {
<a name="l02291"></a>02291             <span class="keywordflow">if</span> (vec[0] &gt; bounds[1] * vec[3]) fl |= 1;
<a name="l02292"></a>02292             <span class="keywordflow">if</span> (vec[0] &lt; bounds[0] * vec[3]) fl |= 2;
<a name="l02293"></a>02293             <span class="keywordflow">if</span> (vec[1] &gt; bounds[3] * vec[3]) fl |= 4;
<a name="l02294"></a>02294             <span class="keywordflow">if</span> (vec[1] &lt; bounds[2] * vec[3]) fl |= 8;
<a name="l02295"></a>02295         }
<a name="l02296"></a>02296         <span class="keywordflow">else</span> {
<a name="l02297"></a>02297             <span class="keywordflow">if</span> (vec[0] &lt; -vec[3]) fl |= 1;
<a name="l02298"></a>02298             <span class="keywordflow">if</span> (vec[0] &gt; vec[3]) fl |= 2;
<a name="l02299"></a>02299             <span class="keywordflow">if</span> (vec[1] &lt; -vec[3]) fl |= 4;
<a name="l02300"></a>02300             <span class="keywordflow">if</span> (vec[1] &gt; vec[3]) fl |= 8;
<a name="l02301"></a>02301         }
<a name="l02302"></a>02302         <span class="keywordflow">if</span> (vec[2] &lt; -vec[3]) fl |= 16;
<a name="l02303"></a>02303         <span class="keywordflow">if</span> (vec[2] &gt; vec[3]) fl |= 32;
<a name="l02304"></a>02304 
<a name="l02305"></a>02305         flag &amp;= fl;
<a name="l02306"></a>02306         <span class="keywordflow">if</span> (flag == 0) <span class="keywordflow">return</span> 0;
<a name="l02307"></a>02307     }
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     <span class="keywordflow">return</span> flag;
<a name="l02310"></a>02310 }
<a name="l02311"></a>02311 
<a name="l02312"></a><a class="code" href="../../d3/d61/math__geom_8c.html#afac87edac077c35345967a7f57df8ad9">02312</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#afac87edac077c35345967a7f57df8ad9">box_minmax_bounds_m4</a>(<span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>[3], <span class="keywordtype">float</span> <a class="code" href="../../d0/d4b/blender_2imbuf_2intern_2dds_2Common_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>[3], <span class="keywordtype">float</span> boundbox[2][3], <span class="keywordtype">float</span> mat[4][4])
<a name="l02313"></a>02313 {
<a name="l02314"></a>02314     <span class="keywordtype">float</span> mn[3], mx[3], vec[3];
<a name="l02315"></a>02315     <span class="keywordtype">int</span> a;
<a name="l02316"></a>02316 
<a name="l02317"></a>02317     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mn, min);
<a name="l02318"></a>02318     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(mx, max);
<a name="l02319"></a>02319 
<a name="l02320"></a>02320     <span class="keywordflow">for</span> (a = 0; a &lt; 8; a++) {
<a name="l02321"></a>02321         vec[0] = (a &amp; 1) ? boundbox[0][0] : boundbox[1][0];
<a name="l02322"></a>02322         vec[1] = (a &amp; 2) ? boundbox[0][1] : boundbox[1][1];
<a name="l02323"></a>02323         vec[2] = (a &amp; 4) ? boundbox[0][2] : boundbox[1][2];
<a name="l02324"></a>02324 
<a name="l02325"></a>02325         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(mat, vec);
<a name="l02326"></a>02326         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a56471388e0045022014f3a365af6b34a">DO_MINMAX</a>(vec, mn, mx);
<a name="l02327"></a>02327     }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(min, mn);
<a name="l02330"></a>02330     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(max, mx);
<a name="l02331"></a>02331 }
<a name="l02332"></a>02332 
<a name="l02333"></a>02333 <span class="comment">/********************************** Mapping **********************************/</span>
<a name="l02334"></a>02334 
<a name="l02335"></a><a class="code" href="../../d3/d61/math__geom_8c.html#acc7abfd5b890347fa45e5f710448a6b5">02335</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acc7abfd5b890347fa45e5f710448a6b5">map_to_tube</a>(<span class="keywordtype">float</span> *r_u, <span class="keywordtype">float</span> *r_v, <span class="keyword">const</span> <span class="keywordtype">float</span> x, <span class="keyword">const</span> <span class="keywordtype">float</span> y, <span class="keyword">const</span> <span class="keywordtype">float</span> z)
<a name="l02336"></a>02336 {
<a name="l02337"></a>02337     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     *r_v = (z + 1.0f) / 2.0f;
<a name="l02340"></a>02340 
<a name="l02341"></a>02341     len = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(x * x + y * y);
<a name="l02342"></a>02342     <span class="keywordflow">if</span> (len &gt; 0.0f) {
<a name="l02343"></a>02343         *r_u = (float)((1.0 - (<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(x / len, y / len) / <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>)) / 2.0);
<a name="l02344"></a>02344     }
<a name="l02345"></a>02345     <span class="keywordflow">else</span> {
<a name="l02346"></a>02346         *r_v = *r_u = 0.0f; <span class="comment">/* to avoid un-initialized variables */</span>
<a name="l02347"></a>02347     }
<a name="l02348"></a>02348 }
<a name="l02349"></a>02349 
<a name="l02350"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a00008dde1f5ee691cb22fc21757c920e">02350</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a00008dde1f5ee691cb22fc21757c920e">map_to_sphere</a>(<span class="keywordtype">float</span> *r_u, <span class="keywordtype">float</span> *r_v, <span class="keyword">const</span> <span class="keywordtype">float</span> x, <span class="keyword">const</span> <span class="keywordtype">float</span> y, <span class="keyword">const</span> <span class="keywordtype">float</span> z)
<a name="l02351"></a>02351 {
<a name="l02352"></a>02352     <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02353"></a>02353 
<a name="l02354"></a>02354     len = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(x * x + y * y + z * z);
<a name="l02355"></a>02355     <span class="keywordflow">if</span> (len &gt; 0.0f) {
<a name="l02356"></a>02356         <span class="keywordflow">if</span> (x == 0.0f &amp;&amp; y == 0.0f) *r_u = 0.0f;  <span class="comment">/* othwise domain error */</span>
<a name="l02357"></a>02357         <span class="keywordflow">else</span> *r_u = (1.0f - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#ab616618cf09fc0ef5c0ec0d9e5825f58">atan2f</a>(x, y) / (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) / 2.0f;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359         *r_v = 1.0f - (float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(z / len) / (float)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l02360"></a>02360     }
<a name="l02361"></a>02361     <span class="keywordflow">else</span> {
<a name="l02362"></a>02362         *r_v = *r_u = 0.0f; <span class="comment">/* to avoid un-initialized variables */</span>
<a name="l02363"></a>02363     }
<a name="l02364"></a>02364 }
<a name="l02365"></a>02365 
<a name="l02366"></a>02366 <span class="comment">/********************************* Normals **********************************/</span>
<a name="l02367"></a>02367 
<a name="l02368"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8073e47ed0bac54057de95147ec575db">02368</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a8073e47ed0bac54057de95147ec575db">accumulate_vertex_normals</a>(<span class="keywordtype">float</span> n1[3], <span class="keywordtype">float</span> n2[3], <span class="keywordtype">float</span> n3[3],
<a name="l02369"></a>02369                                <span class="keywordtype">float</span> n4[3], <span class="keyword">const</span> <span class="keywordtype">float</span> f_no[3], <span class="keyword">const</span> <span class="keywordtype">float</span> co1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> co2[3],
<a name="l02370"></a>02370                                <span class="keyword">const</span> <span class="keywordtype">float</span> co3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> co4[3])
<a name="l02371"></a>02371 {
<a name="l02372"></a>02372     <span class="keywordtype">float</span> vdiffs[4][3];
<a name="l02373"></a>02373     <span class="keyword">const</span> <span class="keywordtype">int</span> nverts = (n4 != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; co4 != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ? 4 : 3;
<a name="l02374"></a>02374 
<a name="l02375"></a>02375     <span class="comment">/* compute normalized edge vectors */</span>
<a name="l02376"></a>02376     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[0], co2, co1);
<a name="l02377"></a>02377     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[1], co3, co2);
<a name="l02378"></a>02378 
<a name="l02379"></a>02379     <span class="keywordflow">if</span> (nverts == 3) {
<a name="l02380"></a>02380         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[2], co1, co3);
<a name="l02381"></a>02381     }
<a name="l02382"></a>02382     <span class="keywordflow">else</span> {
<a name="l02383"></a>02383         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[2], co4, co3);
<a name="l02384"></a>02384         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[3], co1, co4);
<a name="l02385"></a>02385         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vdiffs[3]);
<a name="l02386"></a>02386     }
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vdiffs[0]);
<a name="l02389"></a>02389     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vdiffs[1]);
<a name="l02390"></a>02390     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vdiffs[2]);
<a name="l02391"></a>02391 
<a name="l02392"></a>02392     <span class="comment">/* accumulate angle weighted face normal */</span>
<a name="l02393"></a>02393     {
<a name="l02394"></a>02394         <span class="keywordtype">float</span> *vn[] = {n1, n2, n3, n4};
<a name="l02395"></a>02395         <span class="keyword">const</span> <span class="keywordtype">float</span> *prev_edge = vdiffs[nverts - 1];
<a name="l02396"></a>02396         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02397"></a>02397 
<a name="l02398"></a>02398         <span class="keywordflow">for</span> (i = 0; i &lt; nverts; i++) {
<a name="l02399"></a>02399             <span class="keyword">const</span> <span class="keywordtype">float</span> *cur_edge = vdiffs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02400"></a>02400             <span class="keyword">const</span> <span class="keywordtype">float</span> fac = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(-<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(cur_edge, prev_edge));
<a name="l02401"></a>02401 
<a name="l02402"></a>02402             <span class="comment">// accumulate</span>
<a name="l02403"></a>02403             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vn[i], f_no, fac);
<a name="l02404"></a>02404             prev_edge = cur_edge;
<a name="l02405"></a>02405         }
<a name="l02406"></a>02406     }
<a name="l02407"></a>02407 }
<a name="l02408"></a>02408 
<a name="l02409"></a>02409 <span class="comment">/* Add weighted face normal component into normals of the face vertices.</span>
<a name="l02410"></a>02410 <span class="comment"> * Caller must pass pre-allocated vdiffs of nverts length. */</span>
<a name="l02411"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a5f1e8988d60bd6f2e2b18b6265b90812">02411</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a5f1e8988d60bd6f2e2b18b6265b90812">accumulate_vertex_normals_poly</a>(<span class="keywordtype">float</span> **vertnos, <span class="keywordtype">float</span> polyno[3],
<a name="l02412"></a>02412                                     <span class="keywordtype">float</span> **vertcos, <span class="keywordtype">float</span> vdiffs[][3], <span class="keywordtype">int</span> nverts)
<a name="l02413"></a>02413 {
<a name="l02414"></a>02414     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02415"></a>02415 
<a name="l02416"></a>02416     <span class="comment">/* calculate normalized edge directions for each edge in the poly */</span>
<a name="l02417"></a>02417     <span class="keywordflow">for</span> (i = 0; i &lt; nverts; i++) {
<a name="l02418"></a>02418         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vdiffs[i], vertcos[(i + 1) % nverts], vertcos[i]);
<a name="l02419"></a>02419         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(vdiffs[i]);
<a name="l02420"></a>02420     }
<a name="l02421"></a>02421 
<a name="l02422"></a>02422     <span class="comment">/* accumulate angle weighted face normal */</span>
<a name="l02423"></a>02423     {
<a name="l02424"></a>02424         <span class="keyword">const</span> <span class="keywordtype">float</span> *prev_edge = vdiffs[nverts - 1];
<a name="l02425"></a>02425         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02426"></a>02426 
<a name="l02427"></a>02427         <span class="keywordflow">for</span> (i = 0; i &lt; nverts; i++) {
<a name="l02428"></a>02428             <span class="keyword">const</span> <span class="keywordtype">float</span> *cur_edge = vdiffs[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l02429"></a>02429 
<a name="l02430"></a>02430             <span class="comment">/* calculate angle between the two poly edges incident on</span>
<a name="l02431"></a>02431 <span class="comment">             * this vertex */</span>
<a name="l02432"></a>02432             <span class="keyword">const</span> <span class="keywordtype">float</span> fac = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a0b0ac0cef781c9d0eb9e57e3702f76db">saacos</a>(-<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(cur_edge, prev_edge));
<a name="l02433"></a>02433 
<a name="l02434"></a>02434             <span class="comment">/* accumulate */</span>
<a name="l02435"></a>02435             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1b4079b4f57c1eaf908d521b5a0f867e">madd_v3_v3fl</a>(vertnos[i], polyno, fac);
<a name="l02436"></a>02436             prev_edge = cur_edge;
<a name="l02437"></a>02437         }
<a name="l02438"></a>02438     }
<a name="l02439"></a>02439 }
<a name="l02440"></a>02440 
<a name="l02441"></a>02441 <span class="comment">/********************************* Tangents **********************************/</span>
<a name="l02442"></a>02442 
<a name="l02443"></a>02443 <span class="comment">/* For normal map tangents we need to detect uv boundaries, and only average</span>
<a name="l02444"></a>02444 <span class="comment"> * tangents in case the uvs are connected. Alternative would be to store 1</span>
<a name="l02445"></a>02445 <span class="comment"> * tangent per face rather than 4 per face vertex, but that&#39;s not compatible</span>
<a name="l02446"></a>02446 <span class="comment"> * with games */</span>
<a name="l02447"></a>02447 
<a name="l02448"></a>02448 
<a name="l02449"></a>02449 <span class="comment">/* from BKE_mesh.h */</span>
<a name="l02450"></a><a class="code" href="../../d3/d61/math__geom_8c.html#adc08e719e3f967380f727b3fbce1c952">02450</a> <span class="preprocessor">#define STD_UV_CONNECT_LIMIT  0.0001f</span>
<a name="l02451"></a>02451 <span class="preprocessor"></span>
<a name="l02452"></a><a class="code" href="../../d3/d61/math__geom_8c.html#af79ffd60e222b25fb4ba20492c418958">02452</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#af79ffd60e222b25fb4ba20492c418958">sum_or_add_vertex_tangent</a>(<span class="keywordtype">void</span> *arena, <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> **vtang, <span class="keyword">const</span> <span class="keywordtype">float</span> tang[3], <span class="keyword">const</span> <span class="keywordtype">float</span> uv[2])
<a name="l02453"></a>02453 {
<a name="l02454"></a>02454     <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> *vt;
<a name="l02455"></a>02455 
<a name="l02456"></a>02456     <span class="comment">/* find a tangent with connected uvs */</span>
<a name="l02457"></a>02457     <span class="keywordflow">for</span> (vt = *vtang; vt; vt = vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#a86561c0e007d47786ae4784c22d8ae4b">next</a>) {
<a name="l02458"></a>02458         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(uv[0] - vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[0]) &lt; <a class="code" href="../../d3/d61/math__geom_8c.html#adc08e719e3f967380f727b3fbce1c952">STD_UV_CONNECT_LIMIT</a> &amp;&amp; <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(uv[1] - vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[1]) &lt; <a class="code" href="../../d3/d61/math__geom_8c.html#adc08e719e3f967380f727b3fbce1c952">STD_UV_CONNECT_LIMIT</a>) {
<a name="l02459"></a>02459             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#ab739fd213e0e1b4a440b65bd1925f0d6">tang</a>, tang);
<a name="l02460"></a>02460             <span class="keywordflow">return</span>;
<a name="l02461"></a>02461         }
<a name="l02462"></a>02462     }
<a name="l02463"></a>02463 
<a name="l02464"></a>02464     <span class="comment">/* if not found, append a new one */</span>
<a name="l02465"></a>02465     vt = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>((<a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *) arena, <span class="keyword">sizeof</span>(<a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a>));
<a name="l02466"></a>02466     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#ab739fd213e0e1b4a440b65bd1925f0d6">tang</a>, tang);
<a name="l02467"></a>02467     vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[0] = uv[0];
<a name="l02468"></a>02468     vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[1] = uv[1];
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <span class="keywordflow">if</span> (*vtang)
<a name="l02471"></a>02471         vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#a86561c0e007d47786ae4784c22d8ae4b">next</a> = *vtang;
<a name="l02472"></a>02472     *vtang = vt;
<a name="l02473"></a>02473 }
<a name="l02474"></a>02474 
<a name="l02475"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aea368b0338bf24737cbed01f509a65ce">02475</a> <span class="keywordtype">float</span> *<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aea368b0338bf24737cbed01f509a65ce">find_vertex_tangent</a>(<a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> *vtang, <span class="keyword">const</span> <span class="keywordtype">float</span> uv[2])
<a name="l02476"></a>02476 {
<a name="l02477"></a>02477     <a class="code" href="../../da/d99/structVertexTangent.html">VertexTangent</a> *vt;
<a name="l02478"></a>02478     <span class="keyword">static</span> <span class="keywordtype">float</span> nulltang[3] = {0.0f, 0.0f, 0.0f};
<a name="l02479"></a>02479 
<a name="l02480"></a>02480     <span class="keywordflow">for</span> (vt = vtang; vt; vt = vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#a86561c0e007d47786ae4784c22d8ae4b">next</a>)
<a name="l02481"></a>02481         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(uv[0] - vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[0]) &lt; <a class="code" href="../../d3/d61/math__geom_8c.html#adc08e719e3f967380f727b3fbce1c952">STD_UV_CONNECT_LIMIT</a> &amp;&amp; <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(uv[1] - vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#adeb18b5c52ec834d4fa415a2be283a13">uv</a>[1]) &lt; <a class="code" href="../../d3/d61/math__geom_8c.html#adc08e719e3f967380f727b3fbce1c952">STD_UV_CONNECT_LIMIT</a>)
<a name="l02482"></a>02482             <span class="keywordflow">return</span> vt-&gt;<a class="code" href="../../da/d99/structVertexTangent.html#ab739fd213e0e1b4a440b65bd1925f0d6">tang</a>;
<a name="l02483"></a>02483 
<a name="l02484"></a>02484     <span class="keywordflow">return</span> nulltang; <span class="comment">/* shouldn&#39;t happen, except for nan or so */</span>
<a name="l02485"></a>02485 }
<a name="l02486"></a>02486 
<a name="l02487"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7629d2b35fdb61160d8312b39c3f34a2">02487</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aaba45324d81462685b3b3b650ea84e3f">tangent_from_uv</a>(<span class="keywordtype">float</span> uv1[2], <span class="keywordtype">float</span> uv2[2], <span class="keywordtype">float</span> uv3[3], <span class="keywordtype">float</span> co1[3], <span class="keywordtype">float</span> co2[3], <span class="keywordtype">float</span> co3[3], <span class="keywordtype">float</span> n[3], <span class="keywordtype">float</span> tang[3])
<a name="l02488"></a>02488 {
<a name="l02489"></a>02489     <span class="keywordtype">float</span> s1 = uv2[0] - uv1[0];
<a name="l02490"></a>02490     <span class="keywordtype">float</span> s2 = uv3[0] - uv1[0];
<a name="l02491"></a>02491     <span class="keywordtype">float</span> t1 = uv2[1] - uv1[1];
<a name="l02492"></a>02492     <span class="keywordtype">float</span> t2 = uv3[1] - uv1[1];
<a name="l02493"></a>02493     <span class="keywordtype">float</span> det = (s1 * t2 - s2 * t1);
<a name="l02494"></a>02494 
<a name="l02495"></a>02495     <span class="keywordflow">if</span> (det != 0.0f) { <span class="comment">/* otherwise &#39;tang&#39; becomes nan */</span>
<a name="l02496"></a>02496         <span class="keywordtype">float</span> tangv[3], ct[3], e1[3], e2[3];
<a name="l02497"></a>02497 
<a name="l02498"></a>02498         det = 1.0f / det;
<a name="l02499"></a>02499 
<a name="l02500"></a>02500         <span class="comment">/* normals in render are inversed... */</span>
<a name="l02501"></a>02501         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e1, co1, co2);
<a name="l02502"></a>02502         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(e2, co1, co3);
<a name="l02503"></a>02503         tang[0] = (t2 * e1[0] - t1 * e2[0]) * det;
<a name="l02504"></a>02504         tang[1] = (t2 * e1[1] - t1 * e2[1]) * det;
<a name="l02505"></a>02505         tang[2] = (t2 * e1[2] - t1 * e2[2]) * det;
<a name="l02506"></a>02506         tangv[0] = (s1 * e2[0] - s2 * e1[0]) * det;
<a name="l02507"></a>02507         tangv[1] = (s1 * e2[1] - s2 * e1[1]) * det;
<a name="l02508"></a>02508         tangv[2] = (s1 * e2[2] - s2 * e1[2]) * det;
<a name="l02509"></a>02509         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(ct, tang, tangv);
<a name="l02510"></a>02510 
<a name="l02511"></a>02511         <span class="comment">/* check flip */</span>
<a name="l02512"></a>02512         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(ct, n) &lt; 0.0f) {
<a name="l02513"></a>02513             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(tang);
<a name="l02514"></a>02514         }
<a name="l02515"></a>02515     }
<a name="l02516"></a>02516     <span class="keywordflow">else</span> {
<a name="l02517"></a>02517         tang[0] = tang[1] = tang[2] = 0.0;
<a name="l02518"></a>02518     }
<a name="l02519"></a>02519 }
<a name="l02520"></a>02520 
<a name="l02521"></a>02521 <span class="comment">/****************************** Vector Clouds ********************************/</span>
<a name="l02522"></a>02522 
<a name="l02523"></a>02523 <span class="comment">/* vector clouds */</span>
<a name="l02524"></a>02524 <span class="comment">/* void vcloud_estimate_transform(int list_size, float (*pos)[3], float *weight,float (*rpos)[3], float *rweight,</span>
<a name="l02525"></a>02525 <span class="comment"> *                                float lloc[3],float rloc[3],float lrot[3][3],float lscale[3][3])</span>
<a name="l02526"></a>02526 <span class="comment"> *</span>
<a name="l02527"></a>02527 <span class="comment"> * input</span>
<a name="l02528"></a>02528 <span class="comment"> * (</span>
<a name="l02529"></a>02529 <span class="comment"> * int list_size</span>
<a name="l02530"></a>02530 <span class="comment"> * 4 lists as pointer to array[list_size]</span>
<a name="l02531"></a>02531 <span class="comment"> * 1. current pos array of &#39;new&#39; positions</span>
<a name="l02532"></a>02532 <span class="comment"> * 2. current weight array of &#39;new&#39;weights (may be NULL pointer if you have no weights )</span>
<a name="l02533"></a>02533 <span class="comment"> * 3. reference rpos array of &#39;old&#39; positions</span>
<a name="l02534"></a>02534 <span class="comment"> * 4. reference rweight array of &#39;old&#39;weights (may be NULL pointer if you have no weights )</span>
<a name="l02535"></a>02535 <span class="comment"> * )</span>
<a name="l02536"></a>02536 <span class="comment"> * output</span>
<a name="l02537"></a>02537 <span class="comment"> * (</span>
<a name="l02538"></a>02538 <span class="comment"> * float lloc[3] center of mass pos</span>
<a name="l02539"></a>02539 <span class="comment"> * float rloc[3] center of mass rpos</span>
<a name="l02540"></a>02540 <span class="comment"> * float lrot[3][3] rotation matrix</span>
<a name="l02541"></a>02541 <span class="comment"> * float lscale[3][3] scale matrix</span>
<a name="l02542"></a>02542 <span class="comment"> * pointers may be NULL if not needed</span>
<a name="l02543"></a>02543 <span class="comment"> * )</span>
<a name="l02544"></a>02544 <span class="comment"> */</span>
<a name="l02545"></a>02545 
<a name="l02546"></a>02546 <span class="comment">/* can&#39;t believe there is none in math utils */</span>
<a name="l02547"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a7bed562ce1f999037651d1a648380f0f">02547</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a7bed562ce1f999037651d1a648380f0f">_det_m3</a>(<span class="keywordtype">float</span> m2[3][3])
<a name="l02548"></a>02548 {
<a name="l02549"></a>02549     <span class="keywordtype">float</span> det = 0.f;
<a name="l02550"></a>02550     <span class="keywordflow">if</span> (m2) {
<a name="l02551"></a>02551         det = (m2[0][0] * (m2[1][1] * m2[2][2] - m2[1][2] * m2[2][1]) -
<a name="l02552"></a>02552                m2[1][0] * (m2[0][1] * m2[2][2] - m2[0][2] * m2[2][1]) +
<a name="l02553"></a>02553                m2[2][0] * (m2[0][1] * m2[1][2] - m2[0][2] * m2[1][1]));
<a name="l02554"></a>02554     }
<a name="l02555"></a>02555     <span class="keywordflow">return</span> det;
<a name="l02556"></a>02556 }
<a name="l02557"></a>02557 
<a name="l02558"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a6410c46c949466388fe2e7e87fbbe000">02558</a> <span class="keywordtype">void</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a6410c46c949466388fe2e7e87fbbe000">vcloud_estimate_transform</a>(<span class="keywordtype">int</span> list_size, <span class="keywordtype">float</span> (*pos)[3], <span class="keywordtype">float</span> *weight, <span class="keywordtype">float</span> (*rpos)[3], <span class="keywordtype">float</span> *rweight,
<a name="l02559"></a>02559                                <span class="keywordtype">float</span> lloc[3], <span class="keywordtype">float</span> rloc[3], <span class="keywordtype">float</span> lrot[3][3], <span class="keywordtype">float</span> lscale[3][3])
<a name="l02560"></a>02560 {
<a name="l02561"></a>02561     <span class="keywordtype">float</span> accu_com[3] = {0.0f, 0.0f, 0.0f}, accu_rcom[3] = {0.0f, 0.0f, 0.0f};
<a name="l02562"></a>02562     <span class="keywordtype">float</span> accu_weight = 0.0f, accu_rweight = 0.0f, eps = 0.000001f;
<a name="l02563"></a>02563 
<a name="l02564"></a>02564     <span class="keywordtype">int</span> a;
<a name="l02565"></a>02565     <span class="comment">/* first set up a nice default response */</span>
<a name="l02566"></a>02566     <span class="keywordflow">if</span> (lloc) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(lloc);
<a name="l02567"></a>02567     <span class="keywordflow">if</span> (rloc) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(rloc);
<a name="l02568"></a>02568     <span class="keywordflow">if</span> (lrot) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(lrot);
<a name="l02569"></a>02569     <span class="keywordflow">if</span> (lscale) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac2ec10af660a2f1d912816c842f37bfb">unit_m3</a>(lscale);
<a name="l02570"></a>02570     <span class="comment">/* do com for both clouds */</span>
<a name="l02571"></a>02571     <span class="keywordflow">if</span> (pos &amp;&amp; rpos &amp;&amp; (list_size &gt; 0)) { <span class="comment">/* paranoya check */</span>
<a name="l02572"></a>02572         <span class="comment">/* do com for both clouds */</span>
<a name="l02573"></a>02573         <span class="keywordflow">for</span> (a = 0; a &lt; list_size; a++) {
<a name="l02574"></a>02574             <span class="keywordflow">if</span> (weight) {
<a name="l02575"></a>02575                 <span class="keywordtype">float</span> v[3];
<a name="l02576"></a>02576                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v, pos[a]);
<a name="l02577"></a>02577                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(v, weight[a]);
<a name="l02578"></a>02578                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(accu_com, v);
<a name="l02579"></a>02579                 accu_weight += weight[a];
<a name="l02580"></a>02580             }
<a name="l02581"></a>02581             <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(accu_com, pos[a]);
<a name="l02582"></a>02582 
<a name="l02583"></a>02583             <span class="keywordflow">if</span> (rweight) {
<a name="l02584"></a>02584                 <span class="keywordtype">float</span> v[3];
<a name="l02585"></a>02585                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v, rpos[a]);
<a name="l02586"></a>02586                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(v, rweight[a]);
<a name="l02587"></a>02587                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(accu_rcom, v);
<a name="l02588"></a>02588                 accu_rweight += rweight[a];
<a name="l02589"></a>02589             }
<a name="l02590"></a>02590             <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(accu_rcom, rpos[a]);
<a name="l02591"></a>02591 
<a name="l02592"></a>02592         }
<a name="l02593"></a>02593         <span class="keywordflow">if</span> (!weight || !rweight) {
<a name="l02594"></a>02594             accu_weight = accu_rweight = list_size;
<a name="l02595"></a>02595         }
<a name="l02596"></a>02596 
<a name="l02597"></a>02597         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(accu_com, 1.0f / accu_weight);
<a name="l02598"></a>02598         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(accu_rcom, 1.0f / accu_rweight);
<a name="l02599"></a>02599         <span class="keywordflow">if</span> (lloc) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lloc, accu_com);
<a name="l02600"></a>02600         <span class="keywordflow">if</span> (rloc) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(rloc, accu_rcom);
<a name="l02601"></a>02601         <span class="keywordflow">if</span> (lrot || lscale) { <span class="comment">/* caller does not want rot nor scale, strange but legal */</span>
<a name="l02602"></a>02602             <span class="comment">/*so now do some reverse engeneering and see if we can split rotation from scale -&gt;Polardecompose*/</span>
<a name="l02603"></a>02603             <span class="comment">/* build &#39;projection&#39; matrix */</span>
<a name="l02604"></a>02604             <span class="keywordtype">float</span> m[3][3], mr[3][3], q[3][3], qi[3][3];
<a name="l02605"></a>02605             <span class="keywordtype">float</span> va[3], vb[3], stunt[3];
<a name="l02606"></a>02606             <span class="keywordtype">float</span> odet, ndet;
<a name="l02607"></a>02607             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0, imax = 15;
<a name="l02608"></a>02608             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ab9e4d613e276ebae7b75c67ef34e35a4">zero_m3</a>(m);
<a name="l02609"></a>02609             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ab9e4d613e276ebae7b75c67ef34e35a4">zero_m3</a>(mr);
<a name="l02610"></a>02610 
<a name="l02611"></a>02611             <span class="comment">/* build &#39;projection&#39; matrix */</span>
<a name="l02612"></a>02612             <span class="keywordflow">for</span> (a = 0; a &lt; list_size; a++) {
<a name="l02613"></a>02613                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(va, rpos[a], accu_rcom);
<a name="l02614"></a>02614                 <span class="comment">/* mul_v3_fl(va,bp-&gt;mass);  mass needs renormalzation here ?? */</span>
<a name="l02615"></a>02615                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(vb, pos[a], accu_com);
<a name="l02616"></a>02616                 <span class="comment">/* mul_v3_fl(va,rp-&gt;mass); */</span>
<a name="l02617"></a>02617                 m[0][0] += va[0] * vb[0];
<a name="l02618"></a>02618                 m[0][1] += va[0] * vb[1];
<a name="l02619"></a>02619                 m[0][2] += va[0] * vb[2];
<a name="l02620"></a>02620 
<a name="l02621"></a>02621                 m[1][0] += va[1] * vb[0];
<a name="l02622"></a>02622                 m[1][1] += va[1] * vb[1];
<a name="l02623"></a>02623                 m[1][2] += va[1] * vb[2];
<a name="l02624"></a>02624 
<a name="l02625"></a>02625                 m[2][0] += va[2] * vb[0];
<a name="l02626"></a>02626                 m[2][1] += va[2] * vb[1];
<a name="l02627"></a>02627                 m[2][2] += va[2] * vb[2];
<a name="l02628"></a>02628 
<a name="l02629"></a>02629                 <span class="comment">/* building the reference matrix on the fly</span>
<a name="l02630"></a>02630 <span class="comment">                 * needed to scale properly later */</span>
<a name="l02631"></a>02631 
<a name="l02632"></a>02632                 mr[0][0] += va[0] * va[0];
<a name="l02633"></a>02633                 mr[0][1] += va[0] * va[1];
<a name="l02634"></a>02634                 mr[0][2] += va[0] * va[2];
<a name="l02635"></a>02635 
<a name="l02636"></a>02636                 mr[1][0] += va[1] * va[0];
<a name="l02637"></a>02637                 mr[1][1] += va[1] * va[1];
<a name="l02638"></a>02638                 mr[1][2] += va[1] * va[2];
<a name="l02639"></a>02639 
<a name="l02640"></a>02640                 mr[2][0] += va[2] * va[0];
<a name="l02641"></a>02641                 mr[2][1] += va[2] * va[1];
<a name="l02642"></a>02642                 mr[2][2] += va[2] * va[2];
<a name="l02643"></a>02643             }
<a name="l02644"></a>02644             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(q, m);
<a name="l02645"></a>02645             stunt[0] = q[0][0];
<a name="l02646"></a>02646             stunt[1] = q[1][1];
<a name="l02647"></a>02647             stunt[2] = q[2][2];
<a name="l02648"></a>02648             <span class="comment">/* renormalizing for numeric stability */</span>
<a name="l02649"></a>02649             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a55eec16c2fac66336344b9e7f346fe83">mul_m3_fl</a>(q, 1.f / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(stunt));
<a name="l02650"></a>02650 
<a name="l02651"></a>02651             <span class="comment">/* this is pretty much Polardecompose &#39;inline&#39; the algo based on Higham&#39;s thesis */</span>
<a name="l02652"></a>02652             <span class="comment">/* without the far case ... but seems to work here pretty neat                   */</span>
<a name="l02653"></a>02653             odet = 0.f;
<a name="l02654"></a>02654             ndet = <a class="code" href="../../d3/d61/math__geom_8c.html#a7bed562ce1f999037651d1a648380f0f">_det_m3</a>(q);
<a name="l02655"></a>02655             <span class="keywordflow">while</span> ((odet - ndet) * (odet - ndet) &gt; eps &amp;&amp; i &lt; imax) {
<a name="l02656"></a>02656                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(qi, q);
<a name="l02657"></a>02657                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(qi);
<a name="l02658"></a>02658                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ac90ef87bc55924ddc815b4b604fd645b">add_m3_m3m3</a>(q, q, qi);
<a name="l02659"></a>02659                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a55eec16c2fac66336344b9e7f346fe83">mul_m3_fl</a>(q, 0.5f);
<a name="l02660"></a>02660                 odet = ndet;
<a name="l02661"></a>02661                 ndet = <a class="code" href="../../d3/d61/math__geom_8c.html#a7bed562ce1f999037651d1a648380f0f">_det_m3</a>(q);
<a name="l02662"></a>02662                 i++;
<a name="l02663"></a>02663             }
<a name="l02664"></a>02664 
<a name="l02665"></a>02665             <span class="keywordflow">if</span> (i) {
<a name="l02666"></a>02666                 <span class="keywordtype">float</span> scale[3][3];
<a name="l02667"></a>02667                 <span class="keywordtype">float</span> irot[3][3];
<a name="l02668"></a>02668                 <span class="keywordflow">if</span> (lrot) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(lrot, q);
<a name="l02669"></a>02669                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(irot, q);
<a name="l02670"></a>02670                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(qi, mr);
<a name="l02671"></a>02671                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(q, m, qi);
<a name="l02672"></a>02672                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(scale, irot, q);
<a name="l02673"></a>02673                 <span class="keywordflow">if</span> (lscale) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(lscale, scale);
<a name="l02674"></a>02674 
<a name="l02675"></a>02675             }
<a name="l02676"></a>02676         }
<a name="l02677"></a>02677     }
<a name="l02678"></a>02678 }
<a name="l02679"></a>02679 
<a name="l02680"></a>02680 <span class="comment">/******************************* Form Factor *********************************/</span>
<a name="l02681"></a>02681 
<a name="l02682"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">02682</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(<span class="keywordtype">float</span> r[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> fac)
<a name="l02683"></a>02683 {
<a name="l02684"></a>02684     r[0] = v1[0] + fac * (v2[0] - v1[0]);
<a name="l02685"></a>02685     r[1] = v1[1] + fac * (v2[1] - v1[1]);
<a name="l02686"></a>02686     r[2] = v1[2] + fac * (v2[2] - v1[2]);
<a name="l02687"></a>02687 }
<a name="l02688"></a>02688 
<a name="l02689"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a8dadd6f0ce1937663ff55e9288ded87d">02689</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a8dadd6f0ce1937663ff55e9288ded87d">ff_visible_quad</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p[3], <span class="keyword">const</span> <span class="keywordtype">float</span> n[3],
<a name="l02690"></a>02690                            <span class="keyword">const</span> <span class="keywordtype">float</span> v0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3],
<a name="l02691"></a>02691                            <span class="keywordtype">float</span> q0[3], <span class="keywordtype">float</span> q1[3], <span class="keywordtype">float</span> q2[3], <span class="keywordtype">float</span> q3[3])
<a name="l02692"></a>02692 {
<a name="l02693"></a>02693     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d0/dbc/namespaceKDL.html#ad69840ad33dc4985798237acfd5fd048" title="default precision while comparing with Equal(..,..) functions. Initialized at 0.0000001.">epsilon</a> = 1e-6f;
<a name="l02694"></a>02694     <span class="keywordtype">float</span> c, sd[3];
<a name="l02695"></a>02695 
<a name="l02696"></a>02696     c = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, p);
<a name="l02697"></a>02697 
<a name="l02698"></a>02698     <span class="comment">/* signed distances from the vertices to the plane. */</span>
<a name="l02699"></a>02699     sd[0] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v0) - c;
<a name="l02700"></a>02700     sd[1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v1) - c;
<a name="l02701"></a>02701     sd[2] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, v2) - c;
<a name="l02702"></a>02702 
<a name="l02703"></a>02703     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[0]) &lt; epsilon) sd[0] = 0.0f;
<a name="l02704"></a>02704     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[1]) &lt; epsilon) sd[1] = 0.0f;
<a name="l02705"></a>02705     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(sd[2]) &lt; epsilon) sd[2] = 0.0f;
<a name="l02706"></a>02706 
<a name="l02707"></a>02707     <span class="keywordflow">if</span> (sd[0] &gt; 0) {
<a name="l02708"></a>02708         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l02709"></a>02709             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02710"></a>02710                 <span class="comment">// +++</span>
<a name="l02711"></a>02711                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02712"></a>02712                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02713"></a>02713                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02714"></a>02714                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02715"></a>02715             }
<a name="l02716"></a>02716             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02717"></a>02717                 <span class="comment">// ++-</span>
<a name="l02718"></a>02718                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02719"></a>02719                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02720"></a>02720                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02721"></a>02721                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q3, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02722"></a>02722             }
<a name="l02723"></a>02723             <span class="keywordflow">else</span> {
<a name="l02724"></a>02724                 <span class="comment">// ++0</span>
<a name="l02725"></a>02725                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02726"></a>02726                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02727"></a>02727                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02728"></a>02728                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02729"></a>02729             }
<a name="l02730"></a>02730         }
<a name="l02731"></a>02731         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l02732"></a>02732             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02733"></a>02733                 <span class="comment">// +-+</span>
<a name="l02734"></a>02734                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02735"></a>02735                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q1, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02736"></a>02736                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02737"></a>02737                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, v2);
<a name="l02738"></a>02738             }
<a name="l02739"></a>02739             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02740"></a>02740                 <span class="comment">// +--</span>
<a name="l02741"></a>02741                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02742"></a>02742                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q1, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02743"></a>02743                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02744"></a>02744                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02745"></a>02745             }
<a name="l02746"></a>02746             <span class="keywordflow">else</span> {
<a name="l02747"></a>02747                 <span class="comment">// +-0</span>
<a name="l02748"></a>02748                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02749"></a>02749                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q1, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02750"></a>02750                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02751"></a>02751                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02752"></a>02752             }
<a name="l02753"></a>02753         }
<a name="l02754"></a>02754         <span class="keywordflow">else</span> {
<a name="l02755"></a>02755             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02756"></a>02756                 <span class="comment">// +0+</span>
<a name="l02757"></a>02757                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02758"></a>02758                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02759"></a>02759                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02760"></a>02760                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02761"></a>02761             }
<a name="l02762"></a>02762             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02763"></a>02763                 <span class="comment">// +0-</span>
<a name="l02764"></a>02764                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02765"></a>02765                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02766"></a>02766                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02767"></a>02767                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02768"></a>02768             }
<a name="l02769"></a>02769             <span class="keywordflow">else</span> {
<a name="l02770"></a>02770                 <span class="comment">// +00</span>
<a name="l02771"></a>02771                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02772"></a>02772                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02773"></a>02773                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02774"></a>02774                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02775"></a>02775             }
<a name="l02776"></a>02776         }
<a name="l02777"></a>02777     }
<a name="l02778"></a>02778     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[0] &lt; 0) {
<a name="l02779"></a>02779         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l02780"></a>02780             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02781"></a>02781                 <span class="comment">// -++</span>
<a name="l02782"></a>02782                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q0, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02783"></a>02783                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02784"></a>02784                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02785"></a>02785                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q3, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02786"></a>02786             }
<a name="l02787"></a>02787             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02788"></a>02788                 <span class="comment">// -+-</span>
<a name="l02789"></a>02789                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q0, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02790"></a>02790                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02791"></a>02791                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02792"></a>02792                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02793"></a>02793             }
<a name="l02794"></a>02794             <span class="keywordflow">else</span> {
<a name="l02795"></a>02795                 <span class="comment">// -+0</span>
<a name="l02796"></a>02796                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q0, v0, v1, (sd[0] / (sd[0] - sd[1])));
<a name="l02797"></a>02797                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02798"></a>02798                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02799"></a>02799                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02800"></a>02800             }
<a name="l02801"></a>02801         }
<a name="l02802"></a>02802         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l02803"></a>02803             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02804"></a>02804                 <span class="comment">// --+</span>
<a name="l02805"></a>02805                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q0, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02806"></a>02806                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q1, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02807"></a>02807                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02808"></a>02808                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02809"></a>02809             }
<a name="l02810"></a>02810             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02811"></a>02811                 <span class="comment">// ---</span>
<a name="l02812"></a>02812                 <span class="keywordflow">return</span> 0;
<a name="l02813"></a>02813             }
<a name="l02814"></a>02814             <span class="keywordflow">else</span> {
<a name="l02815"></a>02815                 <span class="comment">// --0</span>
<a name="l02816"></a>02816                 <span class="keywordflow">return</span> 0;
<a name="l02817"></a>02817             }
<a name="l02818"></a>02818         }
<a name="l02819"></a>02819         <span class="keywordflow">else</span> {
<a name="l02820"></a>02820             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02821"></a>02821                 <span class="comment">// -0+</span>
<a name="l02822"></a>02822                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q0, v0, v2, (sd[0] / (sd[0] - sd[2])));
<a name="l02823"></a>02823                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02824"></a>02824                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02825"></a>02825                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02826"></a>02826             }
<a name="l02827"></a>02827             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02828"></a>02828                 <span class="comment">// -0-</span>
<a name="l02829"></a>02829                 <span class="keywordflow">return</span> 0;
<a name="l02830"></a>02830             }
<a name="l02831"></a>02831             <span class="keywordflow">else</span> {
<a name="l02832"></a>02832                 <span class="comment">// -00</span>
<a name="l02833"></a>02833                 <span class="keywordflow">return</span> 0;
<a name="l02834"></a>02834             }
<a name="l02835"></a>02835         }
<a name="l02836"></a>02836     }
<a name="l02837"></a>02837     <span class="keywordflow">else</span> {
<a name="l02838"></a>02838         <span class="keywordflow">if</span> (sd[1] &gt; 0) {
<a name="l02839"></a>02839             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02840"></a>02840                 <span class="comment">// 0++</span>
<a name="l02841"></a>02841                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02842"></a>02842                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02843"></a>02843                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02844"></a>02844                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02845"></a>02845             }
<a name="l02846"></a>02846             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02847"></a>02847                 <span class="comment">// 0+-</span>
<a name="l02848"></a>02848                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02849"></a>02849                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02850"></a>02850                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q2, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02851"></a>02851                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02852"></a>02852             }
<a name="l02853"></a>02853             <span class="keywordflow">else</span> {
<a name="l02854"></a>02854                 <span class="comment">// 0+0</span>
<a name="l02855"></a>02855                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02856"></a>02856                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02857"></a>02857                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02858"></a>02858                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02859"></a>02859             }
<a name="l02860"></a>02860         }
<a name="l02861"></a>02861         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[1] &lt; 0) {
<a name="l02862"></a>02862             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02863"></a>02863                 <span class="comment">// 0-+</span>
<a name="l02864"></a>02864                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02865"></a>02865                 <a class="code" href="../../d3/d61/math__geom_8c.html#a8d87758ec356950a7f6524b2f6d0b652">vec_add_dir</a>(q1, v1, v2, (sd[1] / (sd[1] - sd[2])));
<a name="l02866"></a>02866                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02867"></a>02867                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02868"></a>02868             }
<a name="l02869"></a>02869             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02870"></a>02870                 <span class="comment">// 0--</span>
<a name="l02871"></a>02871                 <span class="keywordflow">return</span> 0;
<a name="l02872"></a>02872             }
<a name="l02873"></a>02873             <span class="keywordflow">else</span> {
<a name="l02874"></a>02874                 <span class="comment">// 0-0</span>
<a name="l02875"></a>02875                 <span class="keywordflow">return</span> 0;
<a name="l02876"></a>02876             }
<a name="l02877"></a>02877         }
<a name="l02878"></a>02878         <span class="keywordflow">else</span> {
<a name="l02879"></a>02879             <span class="keywordflow">if</span> (sd[2] &gt; 0) {
<a name="l02880"></a>02880                 <span class="comment">// 00+</span>
<a name="l02881"></a>02881                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q0, v0);
<a name="l02882"></a>02882                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q1, v1);
<a name="l02883"></a>02883                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q2, v2);
<a name="l02884"></a>02884                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(q3, q2);
<a name="l02885"></a>02885             }
<a name="l02886"></a>02886             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sd[2] &lt; 0) {
<a name="l02887"></a>02887                 <span class="comment">// 00-</span>
<a name="l02888"></a>02888                 <span class="keywordflow">return</span> 0;
<a name="l02889"></a>02889             }
<a name="l02890"></a>02890             <span class="keywordflow">else</span> {
<a name="l02891"></a>02891                 <span class="comment">// 000</span>
<a name="l02892"></a>02892                 <span class="keywordflow">return</span> 0;
<a name="l02893"></a>02893             }
<a name="l02894"></a>02894         }
<a name="l02895"></a>02895     }
<a name="l02896"></a>02896 
<a name="l02897"></a>02897     <span class="keywordflow">return</span> 1;
<a name="l02898"></a>02898 }
<a name="l02899"></a>02899 
<a name="l02900"></a>02900 <span class="comment">/* altivec optimization, this works, but is unused */</span>
<a name="l02901"></a>02901 
<a name="l02902"></a>02902 <span class="preprocessor">#if 0</span>
<a name="l02903"></a>02903 <span class="preprocessor"></span><span class="preprocessor">#include &lt;Accelerate/Accelerate.h&gt;</span>
<a name="l02904"></a>02904 
<a name="l02905"></a>02905 <span class="keyword">typedef</span> <span class="keyword">union </span>{
<a name="l02906"></a>02906     vFloat v;
<a name="l02907"></a>02907     <span class="keywordtype">float</span> f[4];
<a name="l02908"></a>02908 } vFloatResult;
<a name="l02909"></a>02909 
<a name="l02910"></a>02910 <span class="keyword">static</span> vFloat vec_splat_float(<span class="keywordtype">float</span> val)
<a name="l02911"></a>02911 {
<a name="l02912"></a>02912     <span class="keywordflow">return</span> (vFloat) {val, val, val, val};
<a name="l02913"></a>02913 }
<a name="l02914"></a>02914 
<a name="l02915"></a>02915 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">ff_quad_form_factor</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *q0, <span class="keywordtype">float</span> *q1, <span class="keywordtype">float</span> *q2, <span class="keywordtype">float</span> *q3)
<a name="l02916"></a>02916 {
<a name="l02917"></a>02917     vFloat vcos, rlen, vrx, vry, vrz, vsrx, vsry, vsrz, gx, gy, gz, vangle;
<a name="l02918"></a>02918     vUInt8 <a class="code" href="../../d1/d22/stdosl_8h.html#a223c99c5a2abf0efde88e9da56bae327">rotate</a> = (vUInt8) {4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 0, 1, 2, 3};
<a name="l02919"></a>02919     vFloatResult vresult;
<a name="l02920"></a>02920     <span class="keywordtype">float</span> result;
<a name="l02921"></a>02921 
<a name="l02922"></a>02922     <span class="comment">/* compute r* */</span>
<a name="l02923"></a>02923     vrx = (vFloat) {q0[0], q1[0], q2[0], q3[0]} -vec_splat_float(p[0]);
<a name="l02924"></a>02924     vry = (vFloat) {q0[1], q1[1], q2[1], q3[1]} -vec_splat_float(p[1]);
<a name="l02925"></a>02925     vrz = (vFloat) {q0[2], q1[2], q2[2], q3[2]} -vec_splat_float(p[2]);
<a name="l02926"></a>02926 
<a name="l02927"></a>02927     <span class="comment">/* normalize r* */</span>
<a name="l02928"></a>02928     rlen = vec_rsqrte(vrx * vrx + vry * vry + vrz * vrz + vec_splat_float(1e-16f));
<a name="l02929"></a>02929     vrx = vrx * rlen;
<a name="l02930"></a>02930     vry = vry * rlen;
<a name="l02931"></a>02931     vrz = vrz * rlen;
<a name="l02932"></a>02932 
<a name="l02933"></a>02933     <span class="comment">/* rotate r* for cross and dot */</span>
<a name="l02934"></a>02934     vsrx = vec_perm(vrx, vrx, rotate);
<a name="l02935"></a>02935     vsry = vec_perm(vry, vry, rotate);
<a name="l02936"></a>02936     vsrz = vec_perm(vrz, vrz, rotate);
<a name="l02937"></a>02937 
<a name="l02938"></a>02938     <span class="comment">/* cross product */</span>
<a name="l02939"></a>02939     gx = vsry * vrz - vsrz * vry;
<a name="l02940"></a>02940     gy = vsrz * vrx - vsrx * vrz;
<a name="l02941"></a>02941     gz = vsrx * vry - vsry * vrx;
<a name="l02942"></a>02942 
<a name="l02943"></a>02943     <span class="comment">/* normalize */</span>
<a name="l02944"></a>02944     rlen = vec_rsqrte(gx * gx + gy * gy + gz * gz + vec_splat_float(1e-16f));
<a name="l02945"></a>02945     gx = gx * rlen;
<a name="l02946"></a>02946     gy = gy * rlen;
<a name="l02947"></a>02947     gz = gz * rlen;
<a name="l02948"></a>02948 
<a name="l02949"></a>02949     <span class="comment">/* angle */</span>
<a name="l02950"></a>02950     vcos = vrx * vsrx + vry * vsry + vrz * vsrz;
<a name="l02951"></a>02951     vcos = vec_max(vec_min(vcos, vec_splat_float(1.0f)), vec_splat_float(-1.0f));
<a name="l02952"></a>02952     vangle = vacosf(vcos);
<a name="l02953"></a>02953 
<a name="l02954"></a>02954     <span class="comment">/* dot */</span>
<a name="l02955"></a>02955     vresult.v = (vec_splat_float(n[0]) * gx +
<a name="l02956"></a>02956                  vec_splat_float(n[1]) * gy +
<a name="l02957"></a>02957                  vec_splat_float(n[2]) * gz) * vangle;
<a name="l02958"></a>02958 
<a name="l02959"></a>02959     result = (vresult.f[0] + vresult.f[1] + vresult.f[2] + vresult.f[3]) * (0.5f / (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l02960"></a>02960     result = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l02961"></a>02961 
<a name="l02962"></a>02962     <span class="keywordflow">return</span> result;
<a name="l02963"></a>02963 }
<a name="l02964"></a>02964 
<a name="l02965"></a>02965 <span class="preprocessor">#endif</span>
<a name="l02966"></a>02966 <span class="preprocessor"></span>
<a name="l02967"></a>02967 <span class="comment">/* SSE optimization, acos code doesn&#39;t work */</span>
<a name="l02968"></a>02968 
<a name="l02969"></a>02969 <span class="preprocessor">#if 0</span>
<a name="l02970"></a>02970 <span class="preprocessor"></span>
<a name="l02971"></a>02971 <span class="preprocessor">#include &lt;xmmintrin.h&gt;</span>
<a name="l02972"></a>02972 
<a name="l02973"></a>02973 <span class="keyword">static</span> __m128 sse_approx_acos(__m128 x)
<a name="l02974"></a>02974 {
<a name="l02975"></a>02975     <span class="comment">/* needs a better approximation than taylor expansion of acos, since that</span>
<a name="l02976"></a>02976 <span class="comment">     * gives big erros for near 1.0 values, sqrt(2 * x) * acos(1 - x) should work</span>
<a name="l02977"></a>02977 <span class="comment">     * better, see http://www.tom.womack.net/projects/sse-fast-arctrig.html */</span>
<a name="l02978"></a>02978 
<a name="l02979"></a>02979     <span class="keywordflow">return</span> _mm_set_ps1(1.0f);
<a name="l02980"></a>02980 }
<a name="l02981"></a>02981 
<a name="l02982"></a>02982 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">ff_quad_form_factor</a>(<span class="keywordtype">float</span> *p, <span class="keywordtype">float</span> *n, <span class="keywordtype">float</span> *q0, <span class="keywordtype">float</span> *q1, <span class="keywordtype">float</span> *q2, <span class="keywordtype">float</span> *q3)
<a name="l02983"></a>02983 {
<a name="l02984"></a>02984     <span class="keywordtype">float</span> r0[3], r1[3], r2[3], r3[3], g0[3], g1[3], g2[3], g3[3];
<a name="l02985"></a>02985     <span class="keywordtype">float</span> a1, a2, a3, a4, dot1, dot2, dot3, dot4, result;
<a name="l02986"></a>02986     <span class="keywordtype">float</span> fresult[4] <a class="code" href="../../d7/d38/util__opencl_8h.html#abd062009d355453e86013d3c02318e6b">__attribute__</a>((aligned(16)));
<a name="l02987"></a>02987     __m128 qx, qy, qz, rx, ry, rz, rlen, srx, sry, srz, gx, gy, gz, glen, rcos, <a class="code" href="../../d9/d42/btQuaternion_8h.html#a0dbf74d697e478378c0c48ef948cac37" title="Return the angle between two quaternions.">angle</a>, aresult;
<a name="l02988"></a>02988 
<a name="l02989"></a>02989     <span class="comment">/* compute r */</span>
<a name="l02990"></a>02990     qx = _mm_set_ps(q3[0], q2[0], q1[0], q0[0]);
<a name="l02991"></a>02991     qy = _mm_set_ps(q3[1], q2[1], q1[1], q0[1]);
<a name="l02992"></a>02992     qz = _mm_set_ps(q3[2], q2[2], q1[2], q0[2]);
<a name="l02993"></a>02993 
<a name="l02994"></a>02994     rx = qx - _mm_set_ps1(p[0]);
<a name="l02995"></a>02995     ry = qy - _mm_set_ps1(p[1]);
<a name="l02996"></a>02996     rz = qz - _mm_set_ps1(p[2]);
<a name="l02997"></a>02997 
<a name="l02998"></a>02998     <span class="comment">/* normalize r */</span>
<a name="l02999"></a>02999     rlen = _mm_rsqrt_ps(rx * rx + ry * ry + rz * rz + _mm_set_ps1(1e-16f));
<a name="l03000"></a>03000     rx = rx * rlen;
<a name="l03001"></a>03001     ry = ry * rlen;
<a name="l03002"></a>03002     rz = rz * rlen;
<a name="l03003"></a>03003 
<a name="l03004"></a>03004     <span class="comment">/* cross product */</span>
<a name="l03005"></a>03005     srx = _mm_shuffle_ps(rx, rx, _MM_SHUFFLE(0, 3, 2, 1));
<a name="l03006"></a>03006     sry = _mm_shuffle_ps(ry, ry, _MM_SHUFFLE(0, 3, 2, 1));
<a name="l03007"></a>03007     srz = _mm_shuffle_ps(rz, rz, _MM_SHUFFLE(0, 3, 2, 1));
<a name="l03008"></a>03008 
<a name="l03009"></a>03009     gx = sry * rz - srz * ry;
<a name="l03010"></a>03010     gy = srz * rx - srx * rz;
<a name="l03011"></a>03011     gz = srx * ry - sry * rx;
<a name="l03012"></a>03012 
<a name="l03013"></a>03013     <span class="comment">/* normalize g */</span>
<a name="l03014"></a>03014     glen = _mm_rsqrt_ps(gx * gx + gy * gy + gz * gz + _mm_set_ps1(1e-16f));
<a name="l03015"></a>03015     gx = gx * glen;
<a name="l03016"></a>03016     gy = gy * glen;
<a name="l03017"></a>03017     gz = gz * glen;
<a name="l03018"></a>03018 
<a name="l03019"></a>03019     <span class="comment">/* compute angle */</span>
<a name="l03020"></a>03020     rcos = rx * srx + ry * sry + rz * srz;
<a name="l03021"></a>03021     rcos = _mm_max_ps(_mm_min_ps(rcos, _mm_set_ps1(1.0f)), _mm_set_ps1(-1.0f));
<a name="l03022"></a>03022 
<a name="l03023"></a>03023     angle = sse_approx_cos(rcos);
<a name="l03024"></a>03024     aresult = (_mm_set_ps1(n[0]) * gx + _mm_set_ps1(n[1]) * gy + _mm_set_ps1(n[2]) * gz) * angle;
<a name="l03025"></a>03025 
<a name="l03026"></a>03026     <span class="comment">/* sum together */</span>
<a name="l03027"></a>03027     result = (fresult[0] + fresult[1] + fresult[2] + fresult[3]) * (0.5f / (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l03028"></a>03028     result = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l03029"></a>03029 
<a name="l03030"></a>03030     <span class="keywordflow">return</span> result;
<a name="l03031"></a>03031 }
<a name="l03032"></a>03032 
<a name="l03033"></a>03033 <span class="preprocessor">#endif</span>
<a name="l03034"></a>03034 <span class="preprocessor"></span>
<a name="l03035"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">03035</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(<span class="keywordtype">float</span> n[3])
<a name="l03036"></a>03036 {
<a name="l03037"></a>03037     <span class="keywordtype">float</span> d;
<a name="l03038"></a>03038 
<a name="l03039"></a>03039     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, n);
<a name="l03040"></a>03040 
<a name="l03041"></a>03041     <span class="keywordflow">if</span> (d &gt; 1.0e-35<a class="code" href="../../d2/d6c/mball_8c.html#a42257a545daf5b7933d6e8f96adc74f2">F</a>) {
<a name="l03042"></a>03042         d = 1.0f / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(d);
<a name="l03043"></a>03043 
<a name="l03044"></a>03044         n[0] *= d;
<a name="l03045"></a>03045         n[1] *= d;
<a name="l03046"></a>03046         n[2] *= d;
<a name="l03047"></a>03047     }
<a name="l03048"></a>03048 }
<a name="l03049"></a>03049 
<a name="l03050"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">03050</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">ff_quad_form_factor</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> p[3], <span class="keyword">const</span> <span class="keywordtype">float</span> n[3],
<a name="l03051"></a>03051                                  <span class="keyword">const</span> <span class="keywordtype">float</span> q0[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> q3[3])
<a name="l03052"></a>03052 {
<a name="l03053"></a>03053     <span class="keywordtype">float</span> r0[3], r1[3], r2[3], r3[3], g0[3], g1[3], g2[3], g3[3];
<a name="l03054"></a>03054     <span class="keywordtype">float</span> a1, a2, a3, a4, dot1, dot2, dot3, dot4, result;
<a name="l03055"></a>03055 
<a name="l03056"></a>03056     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r0, q0, p);
<a name="l03057"></a>03057     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r1, q1, p);
<a name="l03058"></a>03058     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r2, q2, p);
<a name="l03059"></a>03059     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r3, q3, p);
<a name="l03060"></a>03060 
<a name="l03061"></a>03061     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(r0);
<a name="l03062"></a>03062     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(r1);
<a name="l03063"></a>03063     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(r2);
<a name="l03064"></a>03064     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(r3);
<a name="l03065"></a>03065 
<a name="l03066"></a>03066     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g0, r1, r0);
<a name="l03067"></a>03067     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(g0);
<a name="l03068"></a>03068     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g1, r2, r1);
<a name="l03069"></a>03069     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(g1);
<a name="l03070"></a>03070     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g2, r3, r2);
<a name="l03071"></a>03071     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(g2);
<a name="l03072"></a>03072     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a8828e92cd5d3d481c95a1745c94c1c6f">cross_v3_v3v3</a>(g3, r0, r3);
<a name="l03073"></a>03073     <a class="code" href="../../d3/d61/math__geom_8c.html#a017d903d26721136011a87b85fcfef36">ff_normalize</a>(g3);
<a name="l03074"></a>03074 
<a name="l03075"></a>03075     a1 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r0, r1));
<a name="l03076"></a>03076     a2 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r1, r2));
<a name="l03077"></a>03077     a3 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r2, r3));
<a name="l03078"></a>03078     a4 = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a910916fe9686fbb31f77445fb5add2f7">saacosf</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(r3, r0));
<a name="l03079"></a>03079 
<a name="l03080"></a>03080     dot1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g0);
<a name="l03081"></a>03081     dot2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g1);
<a name="l03082"></a>03082     dot3 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g2);
<a name="l03083"></a>03083     dot4 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(n, g3);
<a name="l03084"></a>03084 
<a name="l03085"></a>03085     result = (a1 * dot1 + a2 * dot2 + a3 * dot3 + a4 * dot4) * 0.5f / (<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l03086"></a>03086     result = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(result, 0.0f);
<a name="l03087"></a>03087 
<a name="l03088"></a>03088     <span class="keywordflow">return</span> result;
<a name="l03089"></a>03089 }
<a name="l03090"></a>03090 
<a name="l03091"></a><a class="code" href="../../d3/d61/math__geom_8c.html#a836b2802183fab2bfbe159ed555fabc3">03091</a> <span class="keywordtype">float</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a836b2802183fab2bfbe159ed555fabc3">form_factor_hemi_poly</a>(<span class="keywordtype">float</span> p[3], <span class="keywordtype">float</span> n[3], <span class="keywordtype">float</span> v1[3], <span class="keywordtype">float</span> v2[3], <span class="keywordtype">float</span> v3[3], <span class="keywordtype">float</span> v4[3])
<a name="l03092"></a>03092 {
<a name="l03093"></a>03093     <span class="comment">/* computes how much hemisphere defined by point and normal is</span>
<a name="l03094"></a>03094 <span class="comment">     * covered by a quad or triangle, cosine weighted */</span>
<a name="l03095"></a>03095     <span class="keywordtype">float</span> q0[3], q1[3], q2[3], q3[3], contrib = 0.0f;
<a name="l03096"></a>03096 
<a name="l03097"></a>03097     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d61/math__geom_8c.html#a8dadd6f0ce1937663ff55e9288ded87d">ff_visible_quad</a>(p, n, v1, v2, v3, q0, q1, q2, q3))
<a name="l03098"></a>03098         contrib += <a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">ff_quad_form_factor</a>(p, n, q0, q1, q2, q3);
<a name="l03099"></a>03099 
<a name="l03100"></a>03100     <span class="keywordflow">if</span> (v4 &amp;&amp; <a class="code" href="../../d3/d61/math__geom_8c.html#a8dadd6f0ce1937663ff55e9288ded87d">ff_visible_quad</a>(p, n, v1, v3, v4, q0, q1, q2, q3))
<a name="l03101"></a>03101         contrib += <a class="code" href="../../d3/d61/math__geom_8c.html#a89667fb028b9704416af0cc2b3068246">ff_quad_form_factor</a>(p, n, q0, q1, q2, q3);
<a name="l03102"></a>03102 
<a name="l03103"></a>03103     <span class="keywordflow">return</span> contrib;
<a name="l03104"></a>03104 }
<a name="l03105"></a>03105 
<a name="l03106"></a>03106 <span class="comment">/* evaluate if entire quad is a proper convex quad */</span>
<a name="l03107"></a><a class="code" href="../../d3/d61/math__geom_8c.html#aa8935b6a43c151d0997692c4e746a69b">03107</a> <span class="keywordtype">int</span> <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#aa8935b6a43c151d0997692c4e746a69b">is_quad_convex_v3</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v4[3])
<a name="l03108"></a>03108 {
<a name="l03109"></a>03109     <span class="keywordtype">float</span> nor[3], nor1[3], nor2[3], vec[4][2];
<a name="l03110"></a>03110     <span class="keywordtype">int</span> axis_a, axis_b;
<a name="l03111"></a>03111 
<a name="l03112"></a>03112     <span class="comment">/* define projection, do both trias apart, quad is undefined! */</span>
<a name="l03113"></a>03113 
<a name="l03114"></a>03114     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(nor1, v1, v2, v3);
<a name="l03115"></a>03115     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ada7050cefa95b7a630489eddee0c3834">normal_tri_v3</a>(nor2, v1, v3, v4);
<a name="l03116"></a>03116 
<a name="l03117"></a>03117     <span class="comment">/* when the face is folded over as 2 tris we probably don&#39;t want to create</span>
<a name="l03118"></a>03118 <span class="comment">     * a quad from it, but go ahead with the intersection test since this</span>
<a name="l03119"></a>03119 <span class="comment">     * isn&#39;t a function for degenerate faces */</span>
<a name="l03120"></a>03120     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ab10d0a221f4d7a706701b806c8135fd7">UNLIKELY</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(nor1, nor2) &lt; 0.0f)) {
<a name="l03121"></a>03121         <span class="comment">/* flip so adding normals in the opposite direction</span>
<a name="l03122"></a>03122 <span class="comment">         * doesnt give a zero length vector */</span>
<a name="l03123"></a>03123         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(nor2);
<a name="l03124"></a>03124     }
<a name="l03125"></a>03125 
<a name="l03126"></a>03126     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(nor, nor1, nor2);
<a name="l03127"></a>03127 
<a name="l03128"></a>03128     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(&amp;axis_a, &amp;axis_b, nor);
<a name="l03129"></a>03129 
<a name="l03130"></a>03130     vec[0][0] = v1[axis_a];
<a name="l03131"></a>03131     vec[0][1] = v1[axis_b];
<a name="l03132"></a>03132     vec[1][0] = v2[axis_a];
<a name="l03133"></a>03133     vec[1][1] = v2[axis_b];
<a name="l03134"></a>03134 
<a name="l03135"></a>03135     vec[2][0] = v3[axis_a];
<a name="l03136"></a>03136     vec[2][1] = v3[axis_b];
<a name="l03137"></a>03137     vec[3][0] = v4[axis_a];
<a name="l03138"></a>03138     vec[3][1] = v4[axis_b];
<a name="l03139"></a>03139 
<a name="l03140"></a>03140     <span class="comment">/* linetests, the 2 diagonals have to instersect to be convex */</span>
<a name="l03141"></a>03141     <span class="keywordflow">return</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(vec[0], vec[2], vec[1], vec[3]) &gt; 0) ? <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> : <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l03142"></a>03142 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:30 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
