<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: sculpt_undo.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">sculpt_undo.c</div>  </div>
</div>
<div class="contents">
<a href="../../d3/d55/sculpt__undo_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software  Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2006 by Nicholas Bishop</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * Implements the Sculpt Mode tools</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> */</span>
<a name="l00030"></a>00030 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/db3/BLI__string_8h.html">BLI_string.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d3e/BLI__listbase_8h.html">BLI_listbase.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d37/BKE__multires_8h.html">BKE_multires.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d17/BKE__key_8h.html">BKE_key.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d35/BKE__subsurf_8h.html">BKE_subsurf.h</a>&quot;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dca/GPU__buffers_8h.html">GPU_buffers.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../db/de3/ED__sculpt_8h.html">ED_sculpt.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d6c/paint__intern_8h.html">paint_intern.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d69/sculpt__intern_8h.html">sculpt_intern.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">/************************** Undo *************************/</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab82d2c27e4ee5cc83929785e5ce814b0">00071</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab82d2c27e4ee5cc83929785e5ce814b0">update_cb</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>, <span class="keywordtype">void</span> *rebuild)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a695a0e333f03d1ba08b869a2302a977f">BLI_pbvh_node_mark_update</a>(node);
<a name="l00074"></a>00074     <span class="keywordflow">if</span> (*((<span class="keywordtype">int</span> *)rebuild))
<a name="l00075"></a>00075         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1acd780e00f79e15cdd1ad10a39f92d4">BLI_pbvh_node_mark_rebuild_draw</a>(node);
<a name="l00076"></a>00076     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af9ca94c397460761dc568a1b43ad2ef6">BLI_pbvh_node_fully_hidden_set</a>(node, 0);
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a72fddc524588056ddbb5c929292867c4">00079</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a72fddc524588056ddbb5c929292867c4">sculpt_undo_restore_deformed</a>(<a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss, <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode, <span class="keywordtype">int</span> uindex, <span class="keywordtype">int</span> oindex, <span class="keywordtype">float</span> coord[3])
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>) {
<a name="l00082"></a>00082         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(coord, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>[uindex]);
<a name="l00083"></a>00083         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>[uindex], ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#ae7715f8b8ce2a653bae34194c261e52f">deform_cos</a>[oindex]);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085     <span class="keywordflow">else</span> {
<a name="l00086"></a>00086         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(coord, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>[uindex]);
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#af1ef3f2e79d3a84840364f8d2863b3cb">00090</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#af1ef3f2e79d3a84840364f8d2863b3cb">sculpt_undo_restore_coords</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm, <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode)
<a name="l00091"></a>00091 {
<a name="l00092"></a>00092     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00093"></a>00093     <a class="code" href="../../d2/df6/structSculpt.html">Sculpt</a> *sd = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C)-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a3d7b2bfc12195d43d8dac148e95d0281">sculpt</a>;
<a name="l00094"></a>00094     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00095"></a>00095     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00096"></a>00096     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00097"></a>00097     <span class="keywordtype">int</span> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;   
<a name="l00098"></a>00098     
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a7d24b740925fa8bec9d71154cf7a1dc7">maxvert</a>) {
<a name="l00100"></a>00100         <span class="comment">/* regular mesh restore */</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a> &amp;&amp; strcmp(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a15905fc55ccadef77e398b69af085354">shapeName</a>)) {
<a name="l00103"></a>00103             <span class="comment">/* shape key has been changed before calling undo operator */</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105             <a class="code" href="../../d1/d9e/structKey.html">Key</a> *key = <a class="code" href="../../d5/d17/BKE__key_8h.html#a8f07b4f039eb391df3c5b429d2f79e62">ob_get_key</a>(ob);
<a name="l00106"></a>00106             <a class="code" href="../../d2/dc3/structKeyBlock.html">KeyBlock</a> *kb = <a class="code" href="../../d5/d17/BKE__key_8h.html#a0b9d3a0e7ee3c7208fac589ebed998a8">key_get_named_keyblock</a>(key, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a15905fc55ccadef77e398b69af085354">shapeName</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108             <span class="keywordflow">if</span> (kb) {
<a name="l00109"></a>00109                 ob-&gt;<a class="code" href="../../de/de7/structObject.html#a749993da86326a6394781cf252d8e903">shapenr</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(&amp;key-&gt;<a class="code" href="../../d1/d9e/structKey.html#ab82a3a504826387b0811d68570496e2a">block</a>, kb) + 1;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111                 <a class="code" href="../../d2/df6/sculpt_8c.html#a98a1a5d13c8defee794364b07a8390c4">sculpt_update_mesh_elements</a>(scene, sd, ob, 0);
<a name="l00112"></a>00112                 <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a25383f13197df9bda823d34736df4d82">ND_DATA</a>, ob);
<a name="l00113"></a>00113             }
<a name="l00114"></a>00114             <span class="keywordflow">else</span> {
<a name="l00115"></a>00115                 <span class="comment">/* key has been removed -- skip this undo node */</span>
<a name="l00116"></a>00116                 <span class="keywordflow">return</span> 0;
<a name="l00117"></a>00117             }
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         index = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>;
<a name="l00121"></a>00121         mvert = ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a54f432172d96f68e833460409a041590">mvert</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>) {
<a name="l00124"></a>00124             float (*vertCos)[3];
<a name="l00125"></a>00125             vertCos = <a class="code" href="../../d5/d17/BKE__key_8h.html#a2eb2d4e471ef54f5c5e20ed84cd1fde4">key_to_vertcos</a>(ob, ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127             <span class="keywordflow">for</span> (i = 0; i &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>; i++) {
<a name="l00128"></a>00128                 <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a22bad3c719eacf5edee474be0e66c4f1">modifiers_active</a>) <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a72fddc524588056ddbb5c929292867c4">sculpt_undo_restore_deformed</a>(ss, unode, i, index[i], vertCos[index[i]]);
<a name="l00129"></a>00129                 <span class="keywordflow">else</span> {
<a name="l00130"></a>00130                     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(vertCos[index[i]], unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>[i]);
<a name="l00131"></a>00131                     <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(vertCos[index[i]], unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>[i]);
<a name="l00132"></a>00132                 }
<a name="l00133"></a>00133             }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135             <span class="comment">/* propagate new coords to keyblock */</span>
<a name="l00136"></a>00136             <a class="code" href="../../d2/df6/sculpt_8c.html#a0a1502dd1860c5ba59cd6306c6b9c2d3">sculpt_vertcos_to_key</a>(ob, ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>, vertCos);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138             <span class="comment">/* pbvh uses it&#39;s own mvert array, so coords should be */</span>
<a name="l00139"></a>00139             <span class="comment">/* propagated to pbvh here */</span>
<a name="l00140"></a>00140             <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a5f006f0be006dd9c9e462f8caf40e37d">BLI_pbvh_apply_vertCos</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, vertCos);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vertCos);
<a name="l00143"></a>00143         }
<a name="l00144"></a>00144         <span class="keywordflow">else</span> {
<a name="l00145"></a>00145             <span class="keywordflow">for</span> (i = 0; i &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>; i++) {
<a name="l00146"></a>00146                 <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a22bad3c719eacf5edee474be0e66c4f1">modifiers_active</a>) <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a72fddc524588056ddbb5c929292867c4">sculpt_undo_restore_deformed</a>(ss, unode, i, index[i], mvert[index[i]].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>);
<a name="l00147"></a>00147                 <span class="keywordflow">else</span> {
<a name="l00148"></a>00148                     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(mvert[index[i]].co, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>[i]);
<a name="l00149"></a>00149                     <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(mvert[index[i]].co, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>[i]);
<a name="l00150"></a>00150                 }
<a name="l00151"></a>00151                 mvert[index[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>;
<a name="l00152"></a>00152             }
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a> &amp;&amp; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>) {
<a name="l00156"></a>00156         <span class="comment">/* multires restore */</span>
<a name="l00157"></a>00157         <a class="code" href="../../de/d85/structDMGridData.html">DMGridData</a> **<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>, *grid;
<a name="l00158"></a>00158         float (*<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>)[3];
<a name="l00159"></a>00159         <span class="keywordtype">int</span> <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         grids = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>(dm);
<a name="l00162"></a>00162         gridsize = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(dm);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a> = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>;
<a name="l00165"></a>00165         <span class="keywordflow">for</span> (j = 0; j &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>; j++) {
<a name="l00166"></a>00166             grid = grids[unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>[j]];
<a name="l00167"></a>00167 
<a name="l00168"></a>00168             <span class="keywordflow">for</span> (i = 0; i &lt; gridsize * <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a>; i++, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>++)
<a name="l00169"></a>00169                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac69c047f62ea208bb9f550757b21a9cb">swap_v3_v3</a>(grid[i].<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, co[0]);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="keywordflow">return</span> 1;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#af3d6963da055d96a74c8f2895a57642b">00176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#af3d6963da055d96a74c8f2895a57642b">sculpt_undo_restore_hidden</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm,
<a name="l00177"></a>00177                                       <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00180"></a>00180     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00181"></a>00181     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a7d24b740925fa8bec9d71154cf7a1dc7">maxvert</a>) {
<a name="l00184"></a>00184         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a54f432172d96f68e833460409a041590">mvert</a>;
<a name="l00185"></a>00185         
<a name="l00186"></a>00186         <span class="keywordflow">for</span> (i = 0; i &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>; i++) {
<a name="l00187"></a>00187             <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v = &amp;mvert[unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]];
<a name="l00188"></a>00188             <span class="keywordtype">int</span> uval = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a74951d7a6b7401568d603bf3a55d5d8d">BLI_BITMAP_GET</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a>, i);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a>, i,
<a name="l00191"></a>00191                               v-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a9336832abc5e4645418d182f520d058f">ME_HIDE</a>);
<a name="l00192"></a>00192             <span class="keywordflow">if</span> (uval)
<a name="l00193"></a>00193                 v-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a9336832abc5e4645418d182f520d058f">ME_HIDE</a>;
<a name="l00194"></a>00194             <span class="keywordflow">else</span>
<a name="l00195"></a>00195                 v-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp;= ~<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a9336832abc5e4645418d182f520d058f">ME_HIDE</a>;
<a name="l00196"></a>00196             
<a name="l00197"></a>00197             v-&gt;<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> |= <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a20918e518fdc538742e67f197aa76c21">ME_VERT_PBVH_UPDATE</a>;
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a> &amp;&amp; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>) {
<a name="l00201"></a>00201         <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a> = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a648cdaa0d9424e7d4c4e29b6a7e15da1">getGridHidden</a>(dm);
<a name="l00202"></a>00202         
<a name="l00203"></a>00203         <span class="keywordflow">for</span> (i = 0; i &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>; i++) {
<a name="l00204"></a>00204             <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a>,
<a name="l00205"></a>00205                  unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>[i],
<a name="l00206"></a>00206                  grid_hidden[unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>[i]]);
<a name="l00207"></a>00207             
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">return</span> 1;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a73953ad4a1ee484a45c9eeef270417d6">00214</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a73953ad4a1ee484a45c9eeef270417d6">sculpt_undo_restore</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00217"></a>00217     <a class="code" href="../../d2/df6/structSculpt.html">Sculpt</a> *sd = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C)-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a3d7b2bfc12195d43d8dac148e95d0281">sculpt</a>;
<a name="l00218"></a>00218     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00219"></a>00219     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(scene, ob, 0);
<a name="l00220"></a>00220     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00221"></a>00221     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00222"></a>00222     <a class="code" href="../../dd/dd2/structMultiresModifierData.html">MultiresModifierData</a> *mmd;
<a name="l00223"></a>00223     <span class="keywordtype">int</span> <a class="code" href="../../d7/d49/node__composite__tree_8c.html#a8568effaf95c1efd2e0482ed79dfac4f">update</a> = 0, rebuild = 1;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225     <a class="code" href="../../d2/df6/sculpt_8c.html#a98a1a5d13c8defee794364b07a8390c4">sculpt_update_mesh_elements</a>(scene, sd, ob, 0);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordflow">for</span> (unode = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; unode; unode = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#abed93f7d8ebea2d57caaa47d98281280">next</a>) {
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (!(strcmp(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a383c00c0b3d03b2536e2f818068c8abf">idname</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>) == 0))
<a name="l00229"></a>00229             <span class="keywordflow">continue</span>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="comment">/* check if undo data matches current data well enough to</span>
<a name="l00232"></a>00232 <span class="comment">         * continue */</span>
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a7d24b740925fa8bec9d71154cf7a1dc7">maxvert</a>) {
<a name="l00234"></a>00234             <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a0b1d3ba260d0e7c443ac906a31423ae6">totvert</a> != unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a7d24b740925fa8bec9d71154cf7a1dc7">maxvert</a>)
<a name="l00235"></a>00235                 <span class="keywordflow">continue</span>;
<a name="l00236"></a>00236         }
<a name="l00237"></a>00237         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a> &amp;&amp; dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#acc2a79b6e477b7a91f06c01c48d9f51f">getGridData</a>) {
<a name="l00238"></a>00238             <span class="keywordflow">if</span> ((dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a81ce6b1eab0f2d5646851b609e9cc842">getNumGrids</a>(dm) != unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a>) ||
<a name="l00239"></a>00239                 (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a463b02823901d34c1026a6eea3529ed8">getGridSize</a>(dm) != unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a>))
<a name="l00240"></a>00240                 <span class="keywordflow">continue</span>;
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242         <span class="keywordflow">else</span> {
<a name="l00243"></a>00243             <span class="keywordflow">continue</span>;
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="keywordflow">switch</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab700d0c3a6dee4d39e76d0ee50a4b43d">type</a>) {
<a name="l00247"></a>00247             <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da5b777b3abf1d09369b010c2e71475243">SCULPT_UNDO_COORDS</a>:
<a name="l00248"></a>00248                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d55/sculpt__undo_8c.html#af1ef3f2e79d3a84840364f8d2863b3cb">sculpt_undo_restore_coords</a>(C, dm, unode))
<a name="l00249"></a>00249                     update = 1;
<a name="l00250"></a>00250                 <span class="keywordflow">break</span>;
<a name="l00251"></a>00251             <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da784e7da7411d2c3e43f8c928705c671a">SCULPT_UNDO_HIDDEN</a>:
<a name="l00252"></a>00252                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d55/sculpt__undo_8c.html#af3d6963da055d96a74c8f2895a57642b">sculpt_undo_restore_hidden</a>(C, dm, unode))
<a name="l00253"></a>00253                     rebuild = 1;
<a name="l00254"></a>00254                 <span class="keywordflow">break</span>;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (update || rebuild) {
<a name="l00259"></a>00259         <span class="keywordtype">int</span> tag_update = 0;
<a name="l00260"></a>00260         <span class="comment">/* we update all nodes still, should be more clever, but also</span>
<a name="l00261"></a>00261 <span class="comment">         * needs to work correct when exiting/entering sculpt mode and</span>
<a name="l00262"></a>00262 <span class="comment">         * the nodes get recreated, though in that case it could do all */</span>
<a name="l00263"></a>00263         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a8494aff65bc27eed5646ccea4f161be8">BLI_pbvh_search_callback</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab82d2c27e4ee5cc83929785e5ce814b0">update_cb</a>, &amp;rebuild);
<a name="l00264"></a>00264         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a97135c648369b00b64bc04e7468a86f9">BLI_pbvh_update</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebab859da08cac4dc153994768e154ac00c">PBVH_UpdateBB</a> | <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebad4775a8ba2425613f1be5988d66c3318">PBVH_UpdateOriginalBB</a> | <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#af641526d5f4e3cd0eafbf8dcdf3f10ebae3d2dbbffa294296117a36c9f323a874">PBVH_UpdateRedraw</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00265"></a>00265 
<a name="l00266"></a>00266         <span class="keywordflow">if</span> ((mmd = <a class="code" href="../../d2/df6/sculpt_8c.html#aeb48226923b9781c0f3963da6ca3dc9a">sculpt_multires_active</a>(scene, ob))) {
<a name="l00267"></a>00267             <span class="keywordflow">if</span> (rebuild)
<a name="l00268"></a>00268                 <a class="code" href="../../d1/d37/BKE__multires_8h.html#afd2c5ce15542c8f8d27b940f9cbf7a35">multires_mark_as_modified</a>(ob, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4aa4d16d9e63e5737dfa382759e22a3020">MULTIRES_HIDDEN_MODIFIED</a>);
<a name="l00269"></a>00269             <span class="keywordflow">else</span>
<a name="l00270"></a>00270                 <a class="code" href="../../d1/d37/BKE__multires_8h.html#afd2c5ce15542c8f8d27b940f9cbf7a35">multires_mark_as_modified</a>(ob, <a class="code" href="../../d9/d35/BKE__subsurf_8h.html#a3312b2489e402d325c903a84b0b9a9d4ad2bf78fc26652a42e8e000bb7a190d09">MULTIRES_COORDS_MODIFIED</a>);
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         tag_update = ((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;id.us &gt; 1;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a22bad3c719eacf5edee474be0e66c4f1">modifiers_active</a>) {
<a name="l00276"></a>00276             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *mesh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00277"></a>00277             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a19b001a7d763c08b54cc47eaa8234f27">mesh_calc_normals_tessface</a>(mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>,
<a name="l00278"></a>00278                                        mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>, mesh-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280             <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc2a1ba5f0abe771e6f3cba297efdaff">free_sculptsession_deformMats</a>(ss);
<a name="l00281"></a>00281             tag_update |= 1;
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (tag_update)
<a name="l00285"></a>00285             <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="comment">/* for non-PBVH drawing, need to recreate VBOs */</span>
<a name="l00288"></a>00288         <a class="code" href="../../d8/dca/GPU__buffers_8h.html#a024ed6ecea42504ed2685e2d0298cc30">GPU_drawobject_free</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>);
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#ac11c506198d9eb6e9fa548d486b3ece0">00292</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ac11c506198d9eb6e9fa548d486b3ece0">sculpt_undo_free</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00295"></a>00295     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="keywordflow">for</span> (unode = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; unode; unode = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#abed93f7d8ebea2d57caaa47d98281280">next</a>) {
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>)
<a name="l00299"></a>00299             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>);
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>)
<a name="l00301"></a>00301             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>);
<a name="l00302"></a>00302         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>)
<a name="l00303"></a>00303             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>);
<a name="l00304"></a>00304         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>)
<a name="l00305"></a>00305             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>);
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a0f159ea606cec888f1e10e4c885e992a">layer_disp</a>)
<a name="l00307"></a>00307             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a0f159ea606cec888f1e10e4c885e992a">layer_disp</a>);
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>)
<a name="l00309"></a>00309             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>);
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a>)
<a name="l00311"></a>00311             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a>);
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>) {
<a name="l00313"></a>00313             <span class="keywordflow">for</span> (i = 0; i &lt; unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>; i++) {
<a name="l00314"></a>00314                 <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>[i])
<a name="l00315"></a>00315                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>[i]);
<a name="l00316"></a>00316             }
<a name="l00317"></a>00317             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a079d76f0caaa74bfe9442b9b38cbcc97">00322</a> <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *<a class="code" href="../../d5/d69/sculpt__intern_8h.html#a079d76f0caaa74bfe9442b9b38cbcc97">sculpt_undo_get_node</a>(<a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../d3/d6c/paint__intern_8h.html#adf3ad319a227bf21f482daae4acceb33">undo_paint_push_get_list</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>);
<a name="l00325"></a>00325     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (!lb)
<a name="l00328"></a>00328         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordflow">for</span> (unode = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; unode; unode = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#abed93f7d8ebea2d57caaa47d98281280">next</a>)
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a> == node)
<a name="l00332"></a>00332             <span class="keywordflow">return</span> unode;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a123079acb6a0f6d99de3b9efe69755e0">00337</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a123079acb6a0f6d99de3b9efe69755e0">sculpt_undo_alloc_and_store_hidden</a>(<a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *pbvh,
<a name="l00338"></a>00338                                                <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode)
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a> = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>;
<a name="l00341"></a>00341     <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>;
<a name="l00342"></a>00342     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, *grid_indices, <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     grid_hidden = <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4c413767d18c4c373bb5c17b068a473f">BLI_pbvh_grid_hidden</a>(pbvh);
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae2bfd81c94c6139d50c125f417801956">BLI_pbvh_node_get_grids</a>(pbvh, node, &amp;grid_indices, &amp;totgrid,
<a name="l00347"></a>00347                             <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00348"></a>00348             
<a name="l00349"></a>00349     unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ac915c135ba8d5868247ad47439582736">BLI_bitmap</a>) * totgrid,
<a name="l00350"></a>00350                                        <span class="stringliteral">&quot;unode-&gt;grid_hidden&quot;</span>);
<a name="l00351"></a>00351         
<a name="l00352"></a>00352     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>; i++) {
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (grid_hidden[grid_indices[i]])
<a name="l00354"></a>00354             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(grid_hidden[grid_indices[i]]);
<a name="l00355"></a>00355         <span class="keywordflow">else</span>
<a name="l00356"></a>00356             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af86692ae85e1eb9883bcfb049aaae7f9">grid_hidden</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a5e4c3f20c6b386b9d58c93ecc8b3c309">00360</a> <span class="keyword">static</span> <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *<a class="code" href="../../d3/d55/sculpt__undo_8c.html#a5e4c3f20c6b386b9d58c93ecc8b3c309">sculpt_undo_alloc_node</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>,
<a name="l00361"></a>00361                                               <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130d">SculptUndoType</a> <a class="code" href="../../de/dd2/structSculptUndoNode.html#ab700d0c3a6dee4d39e76d0ee50a4b43d">type</a>)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../d3/d6c/paint__intern_8h.html#adf3ad319a227bf21f482daae4acceb33">undo_paint_push_get_list</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>);
<a name="l00364"></a>00364     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00365"></a>00365     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00366"></a>00366     <span class="keywordtype">int</span> <a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>, allvert, <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>, <a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a>, <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a>, *<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>;
<a name="l00367"></a>00367     
<a name="l00368"></a>00368     unode = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a>), <span class="stringliteral">&quot;SculptUndoNode&quot;</span>);
<a name="l00369"></a>00369     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a383c00c0b3d03b2536e2f818068c8abf">idname</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>, <span class="keyword">sizeof</span>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a383c00c0b3d03b2536e2f818068c8abf">idname</a>));
<a name="l00370"></a>00370     unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab700d0c3a6dee4d39e76d0ee50a4b43d">type</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#ab700d0c3a6dee4d39e76d0ee50a4b43d">type</a>;
<a name="l00371"></a>00371     unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4bfd1ef41ea772bd811beeaa7e649dfe">BLI_pbvh_node_num_verts</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, node, &amp;totvert, &amp;allvert);
<a name="l00374"></a>00374     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae2bfd81c94c6139d50c125f417801956">BLI_pbvh_node_get_grids</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, node, &amp;grids, &amp;totgrid,
<a name="l00375"></a>00375                             &amp;maxgrid, &amp;gridsize, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>;
<a name="l00378"></a>00378     
<a name="l00379"></a>00379     <span class="comment">/* we will use this while sculpting, is mapalloc slow to access then? */</span>
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="comment">/* general TODO, fix count_alloc */</span>
<a name="l00382"></a>00382     <span class="keywordflow">switch</span> (type) {
<a name="l00383"></a>00383         <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da5b777b3abf1d09369b010c2e71475243">SCULPT_UNDO_COORDS</a>:
<a name="l00384"></a>00384             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * allvert, <span class="stringliteral">&quot;SculptUndoNode.co&quot;</span>);
<a name="l00385"></a>00385             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) * 3 * allvert, <span class="stringliteral">&quot;SculptUndoNode.no&quot;</span>);
<a name="l00386"></a>00386             <a class="code" href="../../d3/d6c/paint__intern_8h.html#a153efe1cce4a72fa81032c023218580d">undo_paint_push_count_alloc</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>, (<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 + <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) * 3 + <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)) * allvert);
<a name="l00387"></a>00387             <span class="keywordflow">break</span>;
<a name="l00388"></a>00388         <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da784e7da7411d2c3e43f8c928705c671a">SCULPT_UNDO_HIDDEN</a>:
<a name="l00389"></a>00389             <span class="keywordflow">if</span> (maxgrid)
<a name="l00390"></a>00390                 <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a123079acb6a0f6d99de3b9efe69755e0">sculpt_undo_alloc_and_store_hidden</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, unode);
<a name="l00391"></a>00391             <span class="keywordflow">else</span>
<a name="l00392"></a>00392                 unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a> = <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#ab5a4c9770bba8ca87005a5c84fa33dfa">BLI_BITMAP_NEW</a>(allvert, <span class="stringliteral">&quot;SculptUndoNode.vert_hidden&quot;</span>);
<a name="l00393"></a>00393         
<a name="l00394"></a>00394             <span class="keywordflow">break</span>;
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396     
<a name="l00397"></a>00397     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lb, unode);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (maxgrid) {
<a name="l00400"></a>00400         <span class="comment">/* multires */</span>
<a name="l00401"></a>00401         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#ab5587db72d5ab911f65c0d833e4a992a">maxgrid</a>;
<a name="l00402"></a>00402         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>;
<a name="l00403"></a>00403         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a> = <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ee82a9606f90587f460af066777b8de">gridsize</a>;
<a name="l00404"></a>00404         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * totgrid, <span class="stringliteral">&quot;SculptUndoNode.grids&quot;</span>);
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     <span class="keywordflow">else</span> {
<a name="l00407"></a>00407         <span class="comment">/* regular mesh */</span>
<a name="l00408"></a>00408         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a7d24b740925fa8bec9d71154cf7a1dc7">maxvert</a> = ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a0b1d3ba260d0e7c443ac906a31423ae6">totvert</a>;
<a name="l00409"></a>00409         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a0d81cef21b91a8e2db40b4b3d0ba8fb1">MEM_mapallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * allvert, <span class="stringliteral">&quot;SculptUndoNode.index&quot;</span>);
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a22bad3c719eacf5edee474be0e66c4f1">modifiers_active</a>)
<a name="l00413"></a>00413         unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(allvert * <span class="keyword">sizeof</span>(*unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>), <span class="stringliteral">&quot;undoSculpt orig_cos&quot;</span>);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordflow">return</span> unode;
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00418"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#af0f04eca13c443da6d8816227e06c4c2">00418</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#af0f04eca13c443da6d8816227e06c4c2">sculpt_undo_store_coords</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00421"></a>00421     <a class="code" href="../../d4/d18/structPBVHVertexIter.html">PBVHVertexIter</a> vd;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ab00130472d6dbcf07fa2f4529dd3da77">BLI_pbvh_vertex_iter_begin</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>, vd, <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a1e5915687b643feaddfd747aab14b5f9">PBVH_ITER_ALL</a>) {
<a name="l00424"></a>00424         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a2a2b131617c6b72bf8ba986e0a4da9d9">co</a>[vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a7c0bb6c4a46f5d2878bebf60d60c1f37">i</a>], vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a450bced6bb74ccd088a0540fdb53fcd6">co</a>);
<a name="l00425"></a>00425         <span class="keywordflow">if</span> (vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a0f32d8cac83260de20e6742e0ad84393">no</a>) <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a94a7060c86b0f3ad31e95c2b7fa7234b">copy_v3_v3_short</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>[vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a7c0bb6c4a46f5d2878bebf60d60c1f37">i</a>], vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a0f32d8cac83260de20e6742e0ad84393">no</a>);
<a name="l00426"></a>00426         <span class="keywordflow">else</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1f45ccf25ddca023da20b3b7e967151a">normal_float_to_short_v3</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>[vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a7c0bb6c4a46f5d2878bebf60d60c1f37">i</a>], vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a69f251f26b918fdd9211384ed33d6530">fno</a>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a22bad3c719eacf5edee474be0e66c4f1">modifiers_active</a>)
<a name="l00429"></a>00429             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aacb3a39ba37c544e0a12fb96222a302e">orig_co</a>[vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a7c0bb6c4a46f5d2878bebf60d60c1f37">i</a>], ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a46dc3df9937219599de59be4aedb825c">orig_cos</a>[unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>[vd.<a class="code" href="../../d4/d18/structPBVHVertexIter.html#a7c0bb6c4a46f5d2878bebf60d60c1f37">i</a>]]);
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a5b3a073eb77860b640a960d786ab2755">BLI_pbvh_vertex_iter_end</a>;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab0c2aaf8b6b6a74d0261ef5b289a8eda">00434</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab0c2aaf8b6b6a74d0261ef5b289a8eda">sculpt_undo_store_hidden</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode)
<a name="l00435"></a>00435 {
<a name="l00436"></a>00436     <a class="code" href="../../d3/dd0/structPBVH.html">PBVH</a> *pbvh = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>;
<a name="l00437"></a>00437     <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a> = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>) {
<a name="l00440"></a>00440         <span class="comment">/* already stored during allocation */</span>
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442     <span class="keywordflow">else</span> {
<a name="l00443"></a>00443         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert;
<a name="l00444"></a>00444         <span class="keywordtype">int</span> *vert_indices, allvert;
<a name="l00445"></a>00445         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00446"></a>00446         
<a name="l00447"></a>00447         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4bfd1ef41ea772bd811beeaa7e649dfe">BLI_pbvh_node_num_verts</a>(pbvh, node, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;allvert);
<a name="l00448"></a>00448         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ad78889c6986e72570348cc7463c574af">BLI_pbvh_node_get_verts</a>(pbvh, node, &amp;vert_indices, &amp;mvert);
<a name="l00449"></a>00449         <span class="keywordflow">for</span> (i = 0; i &lt; allvert; i++) {
<a name="l00450"></a>00450             <a class="code" href="../../df/dd3/BLI__bitmap_8h.html#a45c1a920dad1099cb9246e0807097d00">BLI_BITMAP_MODIFY</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ad600ce2f9d1791356600b6324b207af5">vert_hidden</a>, i,
<a name="l00451"></a>00451                               mvert[vert_indices[i]].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a9336832abc5e4645418d182f520d058f">ME_HIDE</a>);
<a name="l00452"></a>00452         }
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#af516b5907107c5431f5093d20c81f7ff">00456</a> <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *<a class="code" href="../../d5/d69/sculpt__intern_8h.html#af516b5907107c5431f5093d20c81f7ff">sculpt_undo_push_node</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <a class="code" href="../../d2/dae/structPBVHNode.html">PBVHNode</a> *<a class="code" href="../../de/dd2/structSculptUndoNode.html#aba201558f647972b469e851b6279be80">node</a>,
<a name="l00457"></a>00457                                       <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130d">SculptUndoType</a> <a class="code" href="../../de/dd2/structSculptUndoNode.html#ab700d0c3a6dee4d39e76d0ee50a4b43d">type</a>)
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459     <a class="code" href="../../dc/de3/structSculptSession.html">SculptSession</a> *ss = ob-&gt;<a class="code" href="../../de/de7/structObject.html#add5d1bf7bdd64ae917bed87d4d933277">sculpt</a>;
<a name="l00460"></a>00460     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">/* list is manipulated by multiple threads, so we lock */</span>
<a name="l00463"></a>00463     <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="keywordflow">if</span> ((unode = <a class="code" href="../../d5/d69/sculpt__intern_8h.html#a079d76f0caaa74bfe9442b9b38cbcc97">sculpt_undo_get_node</a>(node))) {
<a name="l00466"></a>00466         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00467"></a>00467         <span class="keywordflow">return</span> unode;
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     unode = <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a5e4c3f20c6b386b9d58c93ecc8b3c309">sculpt_undo_alloc_node</a>(ob, node, type);
<a name="l00471"></a>00471     
<a name="l00472"></a>00472     <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a164421692614f6bbd4c33b51f116cefa">LOCK_CUSTOM1</a>);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="comment">/* copy threaded, hopefully this is the performance critical part */</span>
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>) {
<a name="l00477"></a>00477         <span class="keywordtype">int</span> <a class="code" href="../../de/dd2/structSculptUndoNode.html#a6ca39fd4bb61033883a7e1f7533b1770">totgrid</a>, *<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>;
<a name="l00478"></a>00478         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ae2bfd81c94c6139d50c125f417801956">BLI_pbvh_node_get_grids</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, node, &amp;grids, &amp;totgrid,
<a name="l00479"></a>00479                                 <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00480"></a>00480         memcpy(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a6026c35852c72332a20bede9821cc79c">grids</a>, grids, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * totgrid);
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482     <span class="keywordflow">else</span> {
<a name="l00483"></a>00483         <span class="keywordtype">int</span> *vert_indices, allvert;
<a name="l00484"></a>00484         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#a4bfd1ef41ea772bd811beeaa7e649dfe">BLI_pbvh_node_num_verts</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, node, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;allvert);
<a name="l00485"></a>00485         <a class="code" href="../../d1/d13/BLI__pbvh_8h.html#ad78889c6986e72570348cc7463c574af">BLI_pbvh_node_get_verts</a>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#afdbbb6c115ebe8041fbea48dd714bc96">pbvh</a>, node, &amp;vert_indices, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00486"></a>00486         memcpy(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#af4f696d37da795fd1697e83fda7b2737">index</a>, vert_indices, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#ae8e1df2e79078f97271b5cf149e94270">totvert</a>);
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <span class="keywordflow">switch</span> (type) {
<a name="l00490"></a>00490         <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da5b777b3abf1d09369b010c2e71475243">SCULPT_UNDO_COORDS</a>:
<a name="l00491"></a>00491             <a class="code" href="../../d3/d55/sculpt__undo_8c.html#af0f04eca13c443da6d8816227e06c4c2">sculpt_undo_store_coords</a>(ob, unode);
<a name="l00492"></a>00492             <span class="keywordflow">break</span>;
<a name="l00493"></a>00493         <span class="keywordflow">case</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#af85dd7bf5fd2dd44b9a41c718ba2130da784e7da7411d2c3e43f8c928705c671a">SCULPT_UNDO_HIDDEN</a>:
<a name="l00494"></a>00494             <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ab0c2aaf8b6b6a74d0261ef5b289a8eda">sculpt_undo_store_hidden</a>(ob, unode);
<a name="l00495"></a>00495             <span class="keywordflow">break</span>;
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">/* store active shape key */</span>
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>) <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a15905fc55ccadef77e398b69af085354">shapeName</a>, ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>, <span class="keyword">sizeof</span>(ss-&gt;<a class="code" href="../../dc/de3/structSculptSession.html#a7793a2c78a83491916c579ad094c2fa5">kb</a>-&gt;<a class="code" href="../../d2/dc3/structKeyBlock.html#a4602d856d6b6e5d9fa6f88dce66b5bb6">name</a>));
<a name="l00500"></a>00500     <span class="keywordflow">else</span> unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a15905fc55ccadef77e398b69af085354">shapeName</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="keywordflow">return</span> unode;
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a88619235959afc5fb75db09f6a79efa6">00505</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#a88619235959afc5fb75db09f6a79efa6">sculpt_undo_push_begin</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507     <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab8bed50dd373fb5e5192dfb78c561cda">undo_paint_push_begin</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>, name,
<a name="l00508"></a>00508                           <a class="code" href="../../d3/d55/sculpt__undo_8c.html#a73953ad4a1ee484a45c9eeef270417d6">sculpt_undo_restore</a>, <a class="code" href="../../d3/d55/sculpt__undo_8c.html#ac11c506198d9eb6e9fa548d486b3ece0">sculpt_undo_free</a>);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="../../d3/d55/sculpt__undo_8c.html#a2ab190063084bfc4fce24991dc57f2ea">00511</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/d69/sculpt__intern_8h.html#a2ab190063084bfc4fce24991dc57f2ea">sculpt_undo_push_end</a>(<span class="keywordtype">void</span>)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb = <a class="code" href="../../d3/d6c/paint__intern_8h.html#adf3ad319a227bf21f482daae4acceb33">undo_paint_push_get_list</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>);
<a name="l00514"></a>00514     <a class="code" href="../../de/dd2/structSculptUndoNode.html">SculptUndoNode</a> *unode;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <span class="comment">/* we don&#39;t need normals in the undo stack */</span>
<a name="l00517"></a>00517     <span class="keywordflow">for</span> (unode = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; unode; unode = unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#abed93f7d8ebea2d57caaa47d98281280">next</a>) {
<a name="l00518"></a>00518         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>) {
<a name="l00519"></a>00519             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a>);
<a name="l00520"></a>00520             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#aab2b5147a9c6ada0e013c19b40ddacd7">no</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a0f159ea606cec888f1e10e4c885e992a">layer_disp</a>) {
<a name="l00524"></a>00524             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a0f159ea606cec888f1e10e4c885e992a">layer_disp</a>);
<a name="l00525"></a>00525             unode-&gt;<a class="code" href="../../de/dd2/structSculptUndoNode.html#a0f159ea606cec888f1e10e4c885e992a">layer_disp</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00526"></a>00526         }
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a6e1a555b71a4ce0281af8b3a7648b662">undo_paint_push_end</a>(<a class="code" href="../../db/de3/ED__sculpt_8h.html#a7c6015751e8ae45764905bb8d94551dc">UNDO_PAINT_MESH</a>);
<a name="l00530"></a>00530 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:53 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
