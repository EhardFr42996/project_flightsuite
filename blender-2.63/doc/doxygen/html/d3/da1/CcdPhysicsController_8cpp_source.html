<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: CcdPhysicsController.cpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">CcdPhysicsController.cpp</div>  </div>
</div>
<div class="contents">
<a href="../../d3/da1/CcdPhysicsController_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00004"></a>00004 <span class="comment">/*</span>
<a name="l00005"></a>00005 <span class="comment">Bullet Continuous Collision Detection and Physics Library</span>
<a name="l00006"></a>00006 <span class="comment">Copyright (c) 2003-2006 Erwin Coumans  http://continuousphysics.com/Bullet/</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">This software is provided &#39;as-is&#39;, without any express or implied warranty.</span>
<a name="l00009"></a>00009 <span class="comment">In no event will the authors be held liable for any damages arising from the use of this software.</span>
<a name="l00010"></a>00010 <span class="comment">Permission is granted to anyone to use this software for any purpose, </span>
<a name="l00011"></a>00011 <span class="comment">including commercial applications, and to alter it and redistribute it freely, </span>
<a name="l00012"></a>00012 <span class="comment">subject to the following restrictions:</span>
<a name="l00013"></a>00013 <span class="comment"></span>
<a name="l00014"></a>00014 <span class="comment">1. The origin of this software must not be misrepresented; you must not claim that you wrote the original software. If you use this software in a product, an acknowledgment in the product documentation would be appreciated but is not required.</span>
<a name="l00015"></a>00015 <span class="comment">2. Altered source versions must be plainly marked as such, and must not be misrepresented as being the original software.</span>
<a name="l00016"></a>00016 <span class="comment">3. This notice may not be removed or altered from any source distribution.</span>
<a name="l00017"></a>00017 <span class="comment">*/</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#ifndef WIN32</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#endif</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d14/CcdPhysicsController_8h.html">CcdPhysicsController.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d1d/btBulletDynamicsCommon_8h.html">btBulletDynamicsCommon.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d12/btScaledBvhTriangleMeshShape_8h.html">BulletCollision/CollisionShapes/btScaledBvhTriangleMeshShape.h</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d2b/btTriangleIndexVertexArray_8h.html">BulletCollision/CollisionShapes/btTriangleIndexVertexArray.h</a>&quot;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dc4/PHY__IMotionState_8h.html">PHY_IMotionState.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d4a/CcdPhysicsEnvironment_8h.html">CcdPhysicsEnvironment.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d62/RAS__MeshObject_8h.html">RAS_MeshObject.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dc5/KX__GameObject_8h.html" title="General KX game object.">KX_GameObject.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d40/btSoftBody_8h.html">BulletSoftBody/btSoftBody.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d59/btSoftBodyInternals_8h.html">BulletSoftBody//btSoftBodyInternals.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d3e/btSoftBodyHelpers_8h.html">BulletSoftBody/btSoftBodyHelpers.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dd6/btConvexHull_8h.html">LinearMath/btConvexHull.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d01/btGImpactShape_8h.html">BulletCollision/Gimpact/btGImpactShape.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d01/btGImpactShape_8h.html">BulletCollision/Gimpact/btGImpactShape.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/db1/btSoftRigidDynamicsWorld_8h.html">BulletSoftBody/btSoftRigidDynamicsWorld.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span>{
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html">BKE_cdderivedmesh.h</a>&quot;</span>
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">class </span>BP_Proxy;
<a name="l00052"></a>00052 
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">//&#39;temporarily&#39; global variables</span>
<a name="l00056"></a>00056 <span class="comment">//float gDeactivationTime = 2.f;</span>
<a name="l00057"></a>00057 <span class="comment">//bool  gDisableDeactivation = false;</span>
<a name="l00058"></a>00058 <span class="keyword">extern</span> <span class="keywordtype">float</span> <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#aef69831b4cd06a69b56375bc57a8ac08" title="todo: fill all the empty CcdPhysicsController methods, hook them up to the btRigidBody class...">gDeactivationTime</a>;
<a name="l00059"></a>00059 <span class="keyword">extern</span> <span class="keywordtype">bool</span> <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a22d90acd5246ac9f7e5b5a54c8f5cc76">gDisableDeactivation</a>;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#aace71078f01f39f648edadc7a75cf12c">00062</a> <span class="keywordtype">float</span> <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#aace71078f01f39f648edadc7a75cf12c">gLinearSleepingTreshold</a> = 0.8f;
<a name="l00063"></a><a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#ada571baa4ed0fe47f6e7f1fc81055d38">00063</a> <span class="keywordtype">float</span> <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#ada571baa4ed0fe47f6e7f1fc81055d38">gAngularSleepingTreshold</a> = 1.0f;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 btVector3 <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#aba4c94e64b0512e38a24365788e34fe8">startVel</a>(0,0,0);<span class="comment">//-10000);</span>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a49c218e55fac6eefb4fb7e724d532c9f">00068</a> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a49c218e55fac6eefb4fb7e724d532c9f">CcdPhysicsController::CcdPhysicsController</a> (<span class="keyword">const</span> <a class="code" href="../../da/d62/structCcdConstructionInfo.html">CcdConstructionInfo</a>&amp; ci)
<a name="l00069"></a>00069 :m_cci(ci)
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a81020246baa62437827fc902d9fd3972">m_prototypeTransformInitialized</a> = <span class="keyword">false</span>;
<a name="l00072"></a>00072     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa2ab95557da27be16b687293e5b1e9b">m_softbodyMappingDone</a> = <span class="keyword">false</span>;
<a name="l00073"></a>00073     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a541cf17846921705653c282448cfb936">m_collisionDelay</a> = 0;
<a name="l00074"></a>00074     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a4a472042eb3bb9d453ec76c89714657a">m_newClientInfo</a> = 0;
<a name="l00075"></a>00075     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6ea2ae98e28c242f2b722cf8cf7548f6">m_registerCount</a> = 0;
<a name="l00076"></a>00076     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a> = <span class="keyword">false</span>;
<a name="l00077"></a>00077     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5e2ec23918a4c3fa9e13af147e12ac8">m_parentCtrl</a> = 0;
<a name="l00078"></a>00078     <span class="comment">// copy pointers locally to allow smart release</span>
<a name="l00079"></a>00079     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a> = ci.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ae781f7f6c86bc82e40c8dabbf453648e">m_MotionState</a>;
<a name="l00080"></a>00080     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a> = ci.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a>;
<a name="l00081"></a>00081     <span class="comment">// apply scaling before creating rigid body</span>
<a name="l00082"></a>00082     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#ab0e7232cb21511258227afafb952a0a5">setLocalScaling</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>);
<a name="l00083"></a>00083     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>)
<a name="l00084"></a>00084         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a6328b7b20ebbe143742a58d9ab9d5939">calculateLocalInertia</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a>);
<a name="l00085"></a>00085     <span class="comment">// shape info is shared, increment ref count</span>
<a name="l00086"></a>00086     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a> = ci.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a39566e54911c4db6515a25216795e00d">m_shapeInfo</a>;
<a name="l00087"></a>00087     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>)
<a name="l00088"></a>00088         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a82628ab59948d70446675dd8bf389fa6">AddRef</a>();
<a name="l00089"></a>00089     
<a name="l00090"></a>00090     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a> = 0;
<a name="l00091"></a>00091     
<a name="l00092"></a>00092     
<a name="l00093"></a>00093     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa85fefad2238449045d295d2ce440a35">CreateRigidbody</a>();
<a name="l00094"></a>00094     
<a name="l00095"></a>00095 
<a name="l00097"></a>00097 <span class="comment">/*#ifdef WIN32</span>
<a name="l00098"></a>00098 <span class="comment">    if (GetRigidBody() &amp;&amp; !GetRigidBody()-&gt;isStaticObject())</span>
<a name="l00099"></a>00099 <span class="comment">        GetRigidBody()-&gt;setLinearVelocity(startVel);</span>
<a name="l00100"></a>00100 <span class="comment">#endif*/</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af390fc40ee7beed24406f7c784bc9d14">00104</a> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp;    <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af390fc40ee7beed24406f7c784bc9d14">CcdPhysicsController::GetTransformFromMotionState</a>(<a class="code" href="../../d2/d52/classPHY__IMotionState.html">PHY_IMotionState</a>* motionState)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <span class="keyword">static</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> trans;
<a name="l00107"></a>00107     btVector3 tmp;
<a name="l00108"></a>00108     motionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a14b0a6dda08db39cf527949223066efa">getWorldPosition</a>(tmp.m_floats[0], tmp.m_floats[1], tmp.m_floats[2]);
<a name="l00109"></a>00109     trans.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(tmp);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="keywordtype">float</span> ori[12];
<a name="l00112"></a>00112     motionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a859e62d1a0cf0d251aa57923583afe44">getWorldOrientation</a>(ori);
<a name="l00113"></a>00113     trans.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a2135b57e51831fd0112299c6e1348beb" title="Set from the rotational part of a 4x4 OpenGL matrix.">setFromOpenGLSubMatrix</a>(ori);
<a name="l00114"></a>00114     <span class="comment">//btQuaternion orn;</span>
<a name="l00115"></a>00115     <span class="comment">//motionState-&gt;getWorldOrientation(orn[0],orn[1],orn[2],orn[3]);</span>
<a name="l00116"></a>00116     <span class="comment">//trans.setRotation(orn);</span>
<a name="l00117"></a>00117     <span class="keywordflow">return</span> trans;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="../../dc/d81/classBlenderBulletMotionState.html">00121</a> <span class="keyword">class   </span><a class="code" href="../../dc/d81/classBlenderBulletMotionState.html">BlenderBulletMotionState</a> : <span class="keyword">public</span> <a class="code" href="../../dc/ded/classbtMotionState.html">btMotionState</a>
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     <a class="code" href="../../d2/d52/classPHY__IMotionState.html">PHY_IMotionState</a>*   m_blenderMotionState;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">public</span>:
<a name="l00126"></a>00126 
<a name="l00127"></a><a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#a88e21357bf66175dcbaaaff1ed191981">00127</a>     <a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#a88e21357bf66175dcbaaaff1ed191981">BlenderBulletMotionState</a>(<a class="code" href="../../d2/d52/classPHY__IMotionState.html">PHY_IMotionState</a>* bms)
<a name="l00128"></a>00128         :m_blenderMotionState(bms)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#ad0e2cafdd0abaf91cf6c873ab62af21f">00133</a>     <span class="keywordtype">void</span>    <a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#ad0e2cafdd0abaf91cf6c873ab62af21f">getWorldTransform</a>(<a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; worldTrans )<span class="keyword"> const</span>
<a name="l00134"></a>00134 <span class="keyword">    </span>{
<a name="l00135"></a>00135         btVector3 pos;
<a name="l00136"></a>00136         <span class="keywordtype">float</span> ori[12];
<a name="l00137"></a>00137 
<a name="l00138"></a>00138         m_blenderMotionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a14b0a6dda08db39cf527949223066efa">getWorldPosition</a>(pos.m_floats[0],pos.m_floats[1],pos.m_floats[2]);
<a name="l00139"></a>00139         m_blenderMotionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a859e62d1a0cf0d251aa57923583afe44">getWorldOrientation</a>(ori);
<a name="l00140"></a>00140         worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(pos);
<a name="l00141"></a>00141         worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a2135b57e51831fd0112299c6e1348beb" title="Set from the rotational part of a 4x4 OpenGL matrix.">setFromOpenGLSubMatrix</a>(ori);
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#aa747481366d51882ae4adf895f3997ac">00144</a>     <span class="keywordtype">void</span>    <a class="code" href="../../dc/d81/classBlenderBulletMotionState.html#aa747481366d51882ae4adf895f3997ac">setWorldTransform</a>(<span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; worldTrans)
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         m_blenderMotionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#af89f5ea8a9e809c724248e5966633331">setWorldPosition</a>(worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getX(),worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getY(),worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getZ());
<a name="l00147"></a>00147         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> rotQuat = worldTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l00148"></a>00148         m_blenderMotionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#aa237b521073dcdc45632a5c493ce2f8d">setWorldOrientation</a>(rotQuat[0],rotQuat[1],rotQuat[2],rotQuat[3]);
<a name="l00149"></a>00149         m_blenderMotionState-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a78034d31d2d4f37e8b13f2c49d3f37fa">calculateWorldTransformations</a>();
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 };
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">00155</a> <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">CcdPhysicsController::GetRigidBody</a>()
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157     <span class="keywordflow">return</span> <a class="code" href="../../d9/dea/classbtRigidBody.html#a59077fce3d2efd193a3fd7d7de2c97e8">btRigidBody::upcast</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>);
<a name="l00158"></a>00158 }
<a name="l00159"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a248772684189b631eea6fde2aa0709bf">00159</a> btCollisionObject*  <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a248772684189b631eea6fde2aa0709bf">CcdPhysicsController::GetCollisionObject</a>()
<a name="l00160"></a>00160 {
<a name="l00161"></a>00161     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>;
<a name="l00162"></a>00162 }
<a name="l00163"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">00163</a> <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>* <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">CcdPhysicsController::GetSoftBody</a>()
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165     <span class="keywordflow">return</span> <a class="code" href="../../da/d60/classbtSoftBody.html#ac6209b1843fd2511b477547c648adb67">btSoftBody::upcast</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d3e/btSoftBodyHelpers_8h.html">BulletSoftBody/btSoftBodyHelpers.h</a>&quot;</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9881a8ae18c28da431269c7de2f86a73">00171</a> <span class="keywordtype">bool</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9881a8ae18c28da431269c7de2f86a73">CcdPhysicsController::CreateSoftbody</a>()
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     <span class="keywordtype">int</span> shapeType = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a> ? <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a10edfe88febe43b3282f05c24bfa026e">getShapeType</a>() : 0;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">//disable soft body until first sneak preview is ready</span>
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a36e3a83bcf2c43873e18e7cf37ad0cfb">m_bSoft</a> || !<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a> ||
<a name="l00177"></a>00177         ((shapeType != <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5eafcbe51b30926873598f099db3b26cd86">CONVEX_HULL_SHAPE_PROXYTYPE</a>)&amp;&amp;
<a name="l00178"></a>00178         (shapeType != <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5ea420afe83391f77e499f88a6e34efb3f3">TRIANGLE_MESH_SHAPE_PROXYTYPE</a>) &amp;&amp;
<a name="l00179"></a>00179         (shapeType != <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5ea3a16ecb265221a7a860bcff7ce553326">SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE</a>)))
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html">btRigidBody::btRigidBodyConstructionInfo</a> rbci(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a> * <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a030b2dd440b5ff88a13a3f2356cc9458">m_inertiaFactor</a>);
<a name="l00185"></a>00185     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#ab74df15a7cd29a48628e416dc0cf166e">m_linearDamping</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a3ac285e9deac28c5e952b220309141c9">m_linearDamping</a>;
<a name="l00186"></a>00186     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a9bec3e4c1e96b99165969a5777bf6199">m_angularDamping</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a390d2d1a52258ff4652ddb87a2e59617">m_angularDamping</a>;
<a name="l00187"></a>00187     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a096d36f8308c4ca9b225d7c7ad43a0bf" title="best simulation results when friction is non-zero">m_friction</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac434a908df2e47b6e511a4c20b7d822a">m_friction</a>;
<a name="l00188"></a>00188     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a4cee9df6cc734b50e0ef7c7a4eeb43d8" title="best simulation results using zero restitution.">m_restitution</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad06c56b4cc3bdf7593302084e2e882e7">m_restitution</a>;
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     btVector3 <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>(0,0,0);<span class="comment">// = getOrigin();</span>
<a name="l00191"></a>00191     <span class="comment">//btSoftBody*   psb=btSoftBodyHelpers::CreateRope(worldInfo,    btVector3(-10,0,i*0.25),btVector3(10,0,i*0.25), 16,1+2);</span>
<a name="l00192"></a>00192     <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>* psb  = 0;
<a name="l00193"></a>00193     <a class="code" href="../../d8/dc6/structbtSoftBodyWorldInfo.html">btSoftBodyWorldInfo</a>&amp; worldInfo = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#ac052d558bddbd6109860c2210f6eebc2">getDynamicsWorld</a>()-&gt;<a class="code" href="../../d9/d94/classbtSoftRigidDynamicsWorld.html#adf7ee702dee979e4120ce536eb95e695">getWorldInfo</a>();
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a10edfe88febe43b3282f05c24bfa026e">getShapeType</a>() == <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5eafcbe51b30926873598f099db3b26cd86">CONVEX_HULL_SHAPE_PROXYTYPE</a>)
<a name="l00196"></a>00196     {
<a name="l00197"></a>00197         btConvexHullShape* convexHull = (btConvexHullShape* )<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a>;
<a name="l00198"></a>00198         {
<a name="l00199"></a>00199             <span class="keywordtype">int</span> nvertices = convexHull-&gt;getNumPoints();
<a name="l00200"></a>00200             <span class="keyword">const</span> btVector3* <a class="code" href="../../d9/d0b/structvertices.html">vertices</a> = convexHull-&gt;getPoints();
<a name="l00201"></a>00201 
<a name="l00202"></a>00202             <a class="code" href="../../de/d38/classHullDesc.html">HullDesc</a>        hdsc(<a class="code" href="../../d7/dd6/btConvexHull_8h.html#ae93d5bb3739b08ce4de1756210bae63da349d9e244aff82e1cf19ba0cdef1ddaa">QF_TRIANGLES</a>,nvertices,vertices);
<a name="l00203"></a>00203             <a class="code" href="../../df/de3/classHullResult.html">HullResult</a>      hres;
<a name="l00204"></a>00204             <a class="code" href="../../d3/dba/classHullLibrary.html">HullLibrary</a>     hlib;<span class="comment">/*??*/</span> 
<a name="l00205"></a>00205             hdsc.<a class="code" href="../../de/d38/classHullDesc.html#ad9c7a335bb50c3025dc9e40c3924dd53">mMaxVertices</a>=nvertices;
<a name="l00206"></a>00206             hlib.<a class="code" href="../../d3/dba/classHullLibrary.html#a28e5dc544a9d0f326f5b9e02dac656f0">CreateConvexHull</a>(hdsc,hres);
<a name="l00207"></a>00207             
<a name="l00208"></a>00208             psb=<span class="keyword">new</span> <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>(&amp;worldInfo,(<span class="keywordtype">int</span>)hres.<a class="code" href="../../df/de3/classHullResult.html#aa31d0601990e10f7a9c0d991dffac859">mNumOutputVertices</a>,
<a name="l00209"></a>00209                 &amp;hres.<a class="code" href="../../df/de3/classHullResult.html#a2a0f200c20f765e2f1b54ca5e06f6eec">m_OutputVertices</a>[0],0);
<a name="l00210"></a>00210             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0;<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;(int)hres.<a class="code" href="../../df/de3/classHullResult.html#ab20683ae46c0a29c0a0b34fe78474f9a">mNumFaces</a>;++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>)
<a name="l00211"></a>00211             {
<a name="l00212"></a>00212                 <span class="keyword">const</span> <span class="keywordtype">int</span> idx[]={   hres.<a class="code" href="../../df/de3/classHullResult.html#a88737bb44864daed86f058f338ba0a8e">m_Indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*3+0],
<a name="l00213"></a>00213                     hres.<a class="code" href="../../df/de3/classHullResult.html#a88737bb44864daed86f058f338ba0a8e">m_Indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*3+1],
<a name="l00214"></a>00214                     hres.<a class="code" href="../../df/de3/classHullResult.html#a88737bb44864daed86f058f338ba0a8e">m_Indices</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*3+2]};
<a name="l00215"></a>00215                 <span class="keywordflow">if</span> (idx[0]&lt;idx[1]) psb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#ad632d23c33118bc061ac171a0a99ad20">appendLink</a>( idx[0],idx[1]);
<a name="l00216"></a>00216                 <span class="keywordflow">if</span> (idx[1]&lt;idx[2]) psb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#ad632d23c33118bc061ac171a0a99ad20">appendLink</a>( idx[1],idx[2]);
<a name="l00217"></a>00217                 <span class="keywordflow">if</span> (idx[2]&lt;idx[0]) psb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#ad632d23c33118bc061ac171a0a99ad20">appendLink</a>( idx[2],idx[0]);
<a name="l00218"></a>00218                 psb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a1a89dadf0b4a8d9553d5e2263c034b07">appendFace</a>(idx[0],idx[1],idx[2]);
<a name="l00219"></a>00219             }
<a name="l00220"></a>00220             hlib.<a class="code" href="../../d3/dba/classHullLibrary.html#a1694479ac11e270c9f8f13164c0f6dcf">ReleaseResult</a>(hres);
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222     } <span class="keywordflow">else</span>
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224         <span class="keywordtype">int</span> numtris = 0;
<a name="l00225"></a>00225         <span class="keywordflow">if</span> (m_cci.m_collisionShape-&gt;getShapeType() ==<a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5ea3a16ecb265221a7a860bcff7ce553326">SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE</a>)
<a name="l00226"></a>00226         {
<a name="l00227"></a>00227             btScaledBvhTriangleMeshShape* scaledtrimeshshape = (btScaledBvhTriangleMeshShape*) m_cci.m_collisionShape;
<a name="l00228"></a>00228             btBvhTriangleMeshShape* trimeshshape = scaledtrimeshshape-&gt;getChildShape();
<a name="l00229"></a>00229 
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (trimeshshape-&gt;getMeshInterface()-&gt;getNumSubParts()==1)
<a name="l00232"></a>00232             {
<a name="l00233"></a>00233                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* vertexBase;
<a name="l00234"></a>00234                 <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>* scaledVertexBase;
<a name="l00235"></a>00235                 btVector3 localScaling;
<a name="l00236"></a>00236                 <a class="code" href="../../d1/d74/btConcaveShape_8h.html#af7786741f2d89a33a47c8693b3f847b5">PHY_ScalarType</a> vertexType;
<a name="l00237"></a>00237                 <span class="keywordtype">int</span> numverts;
<a name="l00238"></a>00238                 <span class="keywordtype">int</span> vertexstride;
<a name="l00239"></a>00239                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* indexbase;
<a name="l00240"></a>00240                 <span class="keywordtype">int</span> indexstride;
<a name="l00241"></a>00241                 <a class="code" href="../../d1/d74/btConcaveShape_8h.html#af7786741f2d89a33a47c8693b3f847b5">PHY_ScalarType</a> indexType;
<a name="l00242"></a>00242                 trimeshshape-&gt;getMeshInterface()-&gt;getLockedVertexIndexBase(&amp;vertexBase,numverts,vertexType,vertexstride,&amp;indexbase,indexstride,numtris,indexType);
<a name="l00243"></a>00243                 localScaling = scaledtrimeshshape-&gt;getLocalScaling();
<a name="l00244"></a>00244                 scaledVertexBase = <span class="keyword">new</span> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>[numverts*3];
<a name="l00245"></a>00245                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;numverts*3; <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+=3)
<a name="l00246"></a>00246                 {
<a name="l00247"></a>00247                     scaledVertexBase[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ((<span class="keyword">const</span> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>*)vertexBase)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] * localScaling.getX();
<a name="l00248"></a>00248                     scaledVertexBase[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+1] = ((<span class="keyword">const</span> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>*)vertexBase)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+1] * localScaling.getY();
<a name="l00249"></a>00249                     scaledVertexBase[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+2] = ((<span class="keyword">const</span> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>*)vertexBase)[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+2] * localScaling.getZ();
<a name="l00250"></a>00250                 }
<a name="l00251"></a>00251                 psb = <a class="code" href="../../df/de6/structbtSoftBodyHelpers.html#a272cdc7d6d2ad911550d823419bdd3e7">btSoftBodyHelpers::CreateFromTriMesh</a>(worldInfo,scaledVertexBase,(<span class="keyword">const</span> <span class="keywordtype">int</span>*)indexbase,numtris,<span class="keyword">false</span>);
<a name="l00252"></a>00252                 <span class="keyword">delete</span> [] scaledVertexBase;
<a name="l00253"></a>00253             }
<a name="l00254"></a>00254         } <span class="keywordflow">else</span>
<a name="l00255"></a>00255         {
<a name="l00256"></a>00256             <a class="code" href="../../db/d47/classbtTriangleMeshShape.html" title="The btTriangleMeshShape is an internal concave triangle mesh interface. Don&#39;t use this class directly...">btTriangleMeshShape</a>* trimeshshape = (<a class="code" href="../../db/d47/classbtTriangleMeshShape.html" title="The btTriangleMeshShape is an internal concave triangle mesh interface. Don&#39;t use this class directly...">btTriangleMeshShape</a>*) m_cci.m_collisionShape;
<a name="l00258"></a>00258             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (trimeshshape-&gt;<a class="code" href="../../db/d47/classbtTriangleMeshShape.html#a59bbd25d3eb70b23c94c838fb67a03ac">getMeshInterface</a>()-&gt;<a class="code" href="../../d6/de0/classbtStridingMeshInterface.html#a99a9836355d79f79a6f6d35c90de3636">getNumSubParts</a>()==1)
<a name="l00259"></a>00259             {
<a name="l00260"></a>00260                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* vertexBase;
<a name="l00261"></a>00261                 <a class="code" href="../../d1/d74/btConcaveShape_8h.html#af7786741f2d89a33a47c8693b3f847b5">PHY_ScalarType</a> vertexType;
<a name="l00262"></a>00262                 <span class="keywordtype">int</span> numverts;
<a name="l00263"></a>00263                 <span class="keywordtype">int</span> vertexstride;
<a name="l00264"></a>00264                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* indexbase;
<a name="l00265"></a>00265                 <span class="keywordtype">int</span> indexstride;
<a name="l00266"></a>00266                 <a class="code" href="../../d1/d74/btConcaveShape_8h.html#af7786741f2d89a33a47c8693b3f847b5">PHY_ScalarType</a> indexType;
<a name="l00267"></a>00267                 trimeshshape-&gt;<a class="code" href="../../db/d47/classbtTriangleMeshShape.html#a59bbd25d3eb70b23c94c838fb67a03ac">getMeshInterface</a>()-&gt;<a class="code" href="../../d6/de0/classbtStridingMeshInterface.html#a051dfde4d850cb24eb0b7839199ad8c6">getLockedVertexIndexBase</a>(&amp;vertexBase,numverts,vertexType,vertexstride,&amp;indexbase,indexstride,numtris,indexType);
<a name="l00268"></a>00268                 
<a name="l00269"></a>00269                 psb = <a class="code" href="../../df/de6/structbtSoftBodyHelpers.html#a272cdc7d6d2ad911550d823419bdd3e7">btSoftBodyHelpers::CreateFromTriMesh</a>(worldInfo,(<span class="keyword">const</span> <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>*)vertexBase,(<span class="keyword">const</span> <span class="keywordtype">int</span>*)indexbase,numtris,<span class="keyword">false</span>);
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272         <span class="comment">// store face tag so that we can find our original face when doing ray casting</span>
<a name="l00273"></a>00273         <a class="code" href="../../d1/d7b/structbtSoftBody_1_1Face.html">btSoftBody::Face</a>* ft;
<a name="l00274"></a>00274         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00275"></a>00275         <span class="keywordflow">for</span> (i=0, ft=&amp;psb-&gt;m_faces[0]; i&lt;numtris; ++i, ++ft)
<a name="l00276"></a>00276         {
<a name="l00277"></a>00277             <span class="comment">// Hack!! use m_tag to store the face number, normally it is a pointer</span>
<a name="l00278"></a>00278             <span class="comment">// add 1 to make sure it is never 0</span>
<a name="l00279"></a>00279             ft-&gt;<a class="code" href="../../d5/dc1/structbtSoftBody_1_1Element.html#a1291adac8206f851b096f6bd913cae13">m_tag</a> = (<span class="keywordtype">void</span>*)((uintptr_t)(i+1));
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (m_cci.m_margin &gt; 0.f)
<a name="l00283"></a>00283     {
<a name="l00284"></a>00284         psb-&gt;getCollisionShape()-&gt;setMargin(m_cci.m_margin);
<a name="l00285"></a>00285         psb-&gt;updateBounds();
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287     m_object = psb;
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     <span class="comment">//btSoftBody::Material* pm=psb-&gt;appendMaterial();</span>
<a name="l00290"></a>00290     <a class="code" href="../../d2/dea/structbtSoftBody_1_1Material.html">btSoftBody::Material</a>*   pm=psb-&gt;m_materials[0];
<a name="l00291"></a>00291     pm-&gt;<a class="code" href="../../d2/dea/structbtSoftBody_1_1Material.html#adf4cb9a81ab3ce7fdb7297fb482fd9a8">m_kLST</a>              =   m_cci.m_soft_linStiff;
<a name="l00292"></a>00292     pm-&gt;<a class="code" href="../../d2/dea/structbtSoftBody_1_1Material.html#a1875797b002c5248c90f42fbee349a43">m_kAST</a>              =   m_cci.m_soft_angStiff;
<a name="l00293"></a>00293     pm-&gt;<a class="code" href="../../d2/dea/structbtSoftBody_1_1Material.html#ab86b682fc529ec4f315dbea2f87a7b29">m_kVST</a>              =   m_cci.m_soft_volume;
<a name="l00294"></a>00294     psb-&gt;m_cfg.collisions = 0;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (m_cci.m_soft_collisionflags &amp; <a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#aa8f9a04b4be54bc882b619696e217367">CCD_BSB_COL_CL_RS</a>)
<a name="l00297"></a>00297     {
<a name="l00298"></a>00298         psb-&gt;m_cfg.collisions   +=  <a class="code" href="../../d0/dcf/structbtSoftBody_1_1fCollision.html#afeb40bef0380b8db7e9e5628cc5f08d5af9bbf62b0d36af93b1198eb19d800813" title="SDF based rigid vs soft.">btSoftBody::fCollision::CL_RS</a>;
<a name="l00299"></a>00299     } <span class="keywordflow">else</span>
<a name="l00300"></a>00300     {
<a name="l00301"></a>00301         psb-&gt;m_cfg.collisions   +=  <a class="code" href="../../d0/dcf/structbtSoftBody_1_1fCollision.html#afeb40bef0380b8db7e9e5628cc5f08d5a7c057a9cdfcd280d9ec3bf69e09edc62" title="Rigid versus soft mask.">btSoftBody::fCollision::SDF_RS</a>;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (m_cci.m_soft_collisionflags &amp; <a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#a5186ba94af8d1650260837ee36450ad2">CCD_BSB_COL_CL_SS</a>)
<a name="l00304"></a>00304     {
<a name="l00305"></a>00305         psb-&gt;m_cfg.collisions += <a class="code" href="../../d0/dcf/structbtSoftBody_1_1fCollision.html#afeb40bef0380b8db7e9e5628cc5f08d5a602caf1ca49fea4d9215dbea6ad17f04" title="Vertex vs face soft vs soft handling.">btSoftBody::fCollision::CL_SS</a>;
<a name="l00306"></a>00306     } <span class="keywordflow">else</span>
<a name="l00307"></a>00307     {
<a name="l00308"></a>00308         psb-&gt;m_cfg.collisions += <a class="code" href="../../d0/dcf/structbtSoftBody_1_1fCollision.html#afeb40bef0380b8db7e9e5628cc5f08d5a1ad696f1fa631c1256c18a3c8eb18ebc" title="Rigid versus soft mask.">btSoftBody::fCollision::VF_SS</a>;
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     psb-&gt;m_cfg.kSRHR_CL = m_cci.m_soft_kSRHR_CL;        <span class="comment">/* Soft vs rigid hardness [0,1] (cluster only) */</span>
<a name="l00313"></a>00313     psb-&gt;m_cfg.kSKHR_CL = m_cci.m_soft_kSKHR_CL;        <span class="comment">/* Soft vs kinetic hardness [0,1] (cluster only) */</span>
<a name="l00314"></a>00314     psb-&gt;m_cfg.kSSHR_CL = m_cci.m_soft_kSSHR_CL;        <span class="comment">/* Soft vs soft hardness [0,1] (cluster only) */</span>
<a name="l00315"></a>00315     psb-&gt;m_cfg.kSR_SPLT_CL = m_cci.m_soft_kSR_SPLT_CL;  <span class="comment">/* Soft vs rigid impulse split [0,1] (cluster only) */</span>
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     psb-&gt;m_cfg.kSK_SPLT_CL = m_cci.m_soft_kSK_SPLT_CL;  <span class="comment">/* Soft vs rigid impulse split [0,1] (cluster only) */</span>
<a name="l00318"></a>00318     psb-&gt;m_cfg.kSS_SPLT_CL = m_cci.m_soft_kSS_SPLT_CL;  <span class="comment">/* Soft vs rigid impulse split [0,1] (cluster only) */</span>
<a name="l00319"></a>00319     psb-&gt;m_cfg.kVCF = m_cci.m_soft_kVCF;            <span class="comment">/* Velocities correction factor (Baumgarte) */</span>
<a name="l00320"></a>00320     psb-&gt;m_cfg.kDP = m_cci.m_soft_kDP;          <span class="comment">/* Damping coefficient [0,1] */</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     psb-&gt;m_cfg.kDG = m_cci.m_soft_kDG;          <span class="comment">/* Drag coefficient [0,+inf] */</span>
<a name="l00323"></a>00323     psb-&gt;m_cfg.kLF = m_cci.m_soft_kLF;          <span class="comment">/* Lift coefficient [0,+inf] */</span>
<a name="l00324"></a>00324     psb-&gt;m_cfg.kPR = m_cci.m_soft_kPR;          <span class="comment">/* Pressure coefficient [-inf,+inf] */</span>
<a name="l00325"></a>00325     psb-&gt;m_cfg.kVC = m_cci.m_soft_kVC;          <span class="comment">/* Volume conversation coefficient [0,+inf] */</span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     psb-&gt;m_cfg.kDF = m_cci.m_soft_kDF;          <span class="comment">/* Dynamic friction coefficient [0,1] */</span>
<a name="l00328"></a>00328     psb-&gt;m_cfg.kMT = m_cci.m_soft_kMT;          <span class="comment">/* Pose matching coefficient [0,1] */</span>
<a name="l00329"></a>00329     psb-&gt;m_cfg.kCHR = m_cci.m_soft_kCHR;            <span class="comment">/* Rigid contacts hardness [0,1] */</span>
<a name="l00330"></a>00330     psb-&gt;m_cfg.kKHR = m_cci.m_soft_kKHR;            <span class="comment">/* Kinetic contacts hardness [0,1] */</span>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     psb-&gt;m_cfg.kSHR = m_cci.m_soft_kSHR;            <span class="comment">/* Soft contacts hardness [0,1] */</span>
<a name="l00333"></a>00333     psb-&gt;m_cfg.kAHR = m_cci.m_soft_kAHR;            <span class="comment">/* Anchors hardness [0,1] */</span>
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (m_cci.m_gamesoftFlag &amp; <a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#a2f37c0c05fcb6168816025ec71e95e91">CCD_BSB_BENDING_CONSTRAINTS</a>)<span class="comment">//OB_SB_GOAL)</span>
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337         psb-&gt;generateBendingConstraints(2,pm);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     psb-&gt;m_cfg.piterations = m_cci.m_soft_piterations;
<a name="l00341"></a>00341     psb-&gt;m_cfg.viterations = m_cci.m_soft_viterations;
<a name="l00342"></a>00342     psb-&gt;m_cfg.diterations = m_cci.m_soft_diterations;
<a name="l00343"></a>00343     psb-&gt;m_cfg.citerations = m_cci.m_soft_citerations;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="keywordflow">if</span> (m_cci.m_gamesoftFlag &amp; <a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#ab68c2764af4067dd931f652be4aed996">CCD_BSB_SHAPE_MATCHING</a>)<span class="comment">//OB_SB_GOAL)</span>
<a name="l00346"></a>00346     {
<a name="l00347"></a>00347         psb-&gt;setPose(<span class="keyword">false</span>,<span class="keyword">true</span>);<span class="comment">//</span>
<a name="l00348"></a>00348     } <span class="keywordflow">else</span>
<a name="l00349"></a>00349     {
<a name="l00350"></a>00350         psb-&gt;setPose(<span class="keyword">true</span>,<span class="keyword">false</span>);
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     psb-&gt;randomizeConstraints();
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (m_cci.m_soft_collisionflags &amp; (<a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#aa8f9a04b4be54bc882b619696e217367">CCD_BSB_COL_CL_RS</a>+<a class="code" href="../../d1/d14/CcdPhysicsController_8h.html#a5186ba94af8d1650260837ee36450ad2">CCD_BSB_COL_CL_SS</a>))
<a name="l00356"></a>00356     {
<a name="l00357"></a>00357         psb-&gt;generateClusters(m_cci.m_soft_numclusteriterations);
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     psb-&gt;setTotalMass(m_cci.m_mass);
<a name="l00361"></a>00361     
<a name="l00362"></a>00362     psb-&gt;setCollisionFlags(0);
<a name="l00363"></a>00363 
<a name="l00365"></a>00365     {
<a name="l00366"></a>00366         <a class="code" href="../../d5/d85/classRAS__MeshObject.html">RAS_MeshObject</a>* rasMesh= GetShapeInfo()-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a3f873a70dc7521e2e67ef719ca3f22dc">GetMesh</a>();
<a name="l00367"></a>00367 
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (rasMesh &amp;&amp; !m_softbodyMappingDone)
<a name="l00369"></a>00369         {
<a name="l00370"></a>00370             <span class="comment">//printf(&quot;apply\n&quot;);</span>
<a name="l00371"></a>00371             <a class="code" href="../../d7/de0/structRAS__MeshSlot_1_1iterator.html">RAS_MeshSlot::iterator</a> it;
<a name="l00372"></a>00372             <a class="code" href="../../d6/d02/classRAS__MeshMaterial.html">RAS_MeshMaterial</a> *mmat;
<a name="l00373"></a>00373             <a class="code" href="../../d2/d4a/classRAS__MeshSlot.html">RAS_MeshSlot</a> *slot;
<a name="l00374"></a>00374             <span class="keywordtype">size_t</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376             <span class="comment">//for each material</span>
<a name="l00377"></a>00377             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> m=0;m&lt;rasMesh-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a2038150d587e833e5847ac73b4240e46">NumMaterials</a>();m++)
<a name="l00378"></a>00378             {
<a name="l00379"></a>00379                 mmat = rasMesh-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#ae2c210599485a3ff5af6dd96b19d99b9">GetMeshMaterial</a>(m);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381                 slot = mmat-&gt;<a class="code" href="../../d6/d02/classRAS__MeshMaterial.html#aa2c1657166cd6adb1370edea7104efc6">m_baseslot</a>;
<a name="l00382"></a>00382                 <span class="keywordflow">for</span> (slot-&gt;<a class="code" href="../../d2/d4a/classRAS__MeshSlot.html#ac1b5b5f347cb378d38747a008533d25b">begin</a>(it); !slot-&gt;<a class="code" href="../../d2/d4a/classRAS__MeshSlot.html#a63cb0687bc2ee5ca0636742b611c22c3">end</a>(it); slot-&gt;<a class="code" href="../../d2/d4a/classRAS__MeshSlot.html#a4c3528cb61c2eec7e4fc66859bddd3a5">next</a>(it))
<a name="l00383"></a>00383                 {
<a name="l00384"></a>00384                     <span class="keywordtype">int</span> index = 0;
<a name="l00385"></a>00385                     <span class="keywordflow">for</span> (i=it.<a class="code" href="../../d7/de0/structRAS__MeshSlot_1_1iterator.html#a8e11a1672783601318788a461da43f41">startvertex</a>; i&lt;it.<a class="code" href="../../d7/de0/structRAS__MeshSlot_1_1iterator.html#ae31acd0dcf2cb2e159ab8d7c7a9f5b14">endvertex</a>; i++,index++) 
<a name="l00386"></a>00386                     {
<a name="l00387"></a>00387                         <a class="code" href="../../dc/dd2/classRAS__TexVert.html">RAS_TexVert</a>* <a class="code" href="../../db/d7c/structvertex.html">vertex</a> = &amp;it.<a class="code" href="../../d7/de0/structRAS__MeshSlot_1_1iterator.html#aeb87a7190ab1476047999fabb85f5459">vertex</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00388"></a>00388                         <span class="comment">//search closest index, and store it in vertex</span>
<a name="l00389"></a>00389                         vertex-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#abbbdd9951fb99f13c8ab5e1796270efc">setSoftBodyIndex</a>(0);
<a name="l00390"></a>00390                         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> maxDistSqr = 1e30;
<a name="l00391"></a>00391                         <a class="code" href="../../dc/df2/classbtAlignedObjectArray.html">btSoftBody::tNodeArray</a>&amp;   <a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>(psb-&gt;m_nodes);
<a name="l00392"></a>00392                         btVector3 xyz = btVector3(vertex-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#ad90716d0e59579a64f0c5d4ce4527400">getXYZ</a>()[0],vertex-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#ad90716d0e59579a64f0c5d4ce4527400">getXYZ</a>()[1],vertex-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#ad90716d0e59579a64f0c5d4ce4527400">getXYZ</a>()[2]);
<a name="l00393"></a>00393                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n=0;n&lt;<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>.size();n++)
<a name="l00394"></a>00394                         {
<a name="l00395"></a>00395                             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> distSqr = (<a class="code" href="../../d5/dff/rna__nodetree_8c.html#a9510ffcfa37bb664f5f3e70f0d9011f9">nodes</a>[n].m_x - xyz).length2();
<a name="l00396"></a>00396                             <span class="keywordflow">if</span> (distSqr&lt;maxDistSqr)
<a name="l00397"></a>00397                             {
<a name="l00398"></a>00398                                 maxDistSqr = distSqr;
<a name="l00399"></a>00399                                 
<a name="l00400"></a>00400                                 vertex-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#abbbdd9951fb99f13c8ab5e1796270efc">setSoftBodyIndex</a>(n);
<a name="l00401"></a>00401                             }
<a name="l00402"></a>00402                         }
<a name="l00403"></a>00403                     }
<a name="l00404"></a>00404                 }
<a name="l00405"></a>00405             }
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     m_softbodyMappingDone = <span class="keyword">true</span>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> startTrans;
<a name="l00411"></a>00411     rbci.m_motionState-&gt;getWorldTransform(startTrans);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     m_MotionState-&gt;setWorldPosition(startTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getX(),startTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getY(),startTrans.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().getZ());
<a name="l00414"></a>00414     m_MotionState-&gt;setWorldOrientation(0,0,0,1);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (!m_prototypeTransformInitialized)
<a name="l00417"></a>00417     {
<a name="l00418"></a>00418         m_prototypeTransformInitialized = <span class="keyword">true</span>;
<a name="l00419"></a>00419         m_softBodyTransformInitialized = <span class="keyword">true</span>;
<a name="l00420"></a>00420         psb-&gt;transform(startTrans);
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422     m_object-&gt;setCollisionFlags(m_object-&gt;getCollisionFlags() | m_cci.m_collisionFlags);
<a name="l00423"></a>00423     <span class="keywordflow">if</span> (m_cci.m_do_anisotropic)
<a name="l00424"></a>00424         m_object-&gt;setAnisotropicFriction(m_cci.m_anisotropicFriction);
<a name="l00425"></a>00425     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 
<a name="l00429"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa85fefad2238449045d295d2ce440a35">00429</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa85fefad2238449045d295d2ce440a35">CcdPhysicsController::CreateRigidbody</a>()
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="comment">//btTransform trans = GetTransformFromMotionState(m_MotionState);</span>
<a name="l00433"></a>00433     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a> = <span class="keyword">new</span> <a class="code" href="../../dc/d81/classBlenderBulletMotionState.html">BlenderBulletMotionState</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>);
<a name="l00434"></a>00434 
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9881a8ae18c28da431269c7de2f86a73">CreateSoftbody</a>())
<a name="l00437"></a>00437         <span class="comment">// soft body created, done</span>
<a name="l00438"></a>00438         <span class="keywordflow">return</span>;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="comment">//create a rgid collision object</span>
<a name="l00441"></a>00441     <a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html">btRigidBody::btRigidBodyConstructionInfo</a> rbci(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>,<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a> * <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a030b2dd440b5ff88a13a3f2356cc9458">m_inertiaFactor</a>);
<a name="l00442"></a>00442     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#ab74df15a7cd29a48628e416dc0cf166e">m_linearDamping</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a3ac285e9deac28c5e952b220309141c9">m_linearDamping</a>;
<a name="l00443"></a>00443     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a9bec3e4c1e96b99165969a5777bf6199">m_angularDamping</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a390d2d1a52258ff4652ddb87a2e59617">m_angularDamping</a>;
<a name="l00444"></a>00444     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a096d36f8308c4ca9b225d7c7ad43a0bf" title="best simulation results when friction is non-zero">m_friction</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac434a908df2e47b6e511a4c20b7d822a">m_friction</a>;
<a name="l00445"></a>00445     rbci.<a class="code" href="../../db/d1a/structbtRigidBody_1_1btRigidBodyConstructionInfo.html#a4cee9df6cc734b50e0ef7c7a4eeb43d8" title="best simulation results using zero restitution.">m_restitution</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad06c56b4cc3bdf7593302084e2e882e7">m_restitution</a>;
<a name="l00446"></a>00446     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> = <span class="keyword">new</span> <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>(rbci);
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     <span class="comment">//</span>
<a name="l00449"></a>00449     <span class="comment">// init the rigidbody properly</span>
<a name="l00450"></a>00450     <span class="comment">//</span>
<a name="l00451"></a>00451     
<a name="l00452"></a>00452     <span class="comment">//setMassProps this also sets collisionFlags</span>
<a name="l00453"></a>00453     <span class="comment">//convert collision flags!</span>
<a name="l00454"></a>00454     <span class="comment">//special case: a near/radar sensor controller should not be defined static or it will</span>
<a name="l00455"></a>00455     <span class="comment">//generate loads of static-static collision messages on the console</span>
<a name="l00456"></a>00456     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458         <span class="comment">// reset the flags that have been set so far</span>
<a name="l00459"></a>00459         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a248772684189b631eea6fde2aa0709bf">GetCollisionObject</a>()-&gt;setCollisionFlags(0);
<a name="l00460"></a>00460         <span class="comment">// sensor must never go to sleep: they need to detect continously</span>
<a name="l00461"></a>00461         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a248772684189b631eea6fde2aa0709bf">GetCollisionObject</a>()-&gt;setActivationState(<a class="code" href="../../da/df2/btCollisionObject_8h.html#a3974157ba49bb9a32bcfcd3d01a5447b">DISABLE_DEACTIVATION</a>);
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a248772684189b631eea6fde2aa0709bf">GetCollisionObject</a>()-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a42d72c367ca67806e51801f67948d0f3">m_collisionFlags</a>);
<a name="l00464"></a>00464     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (body)
<a name="l00467"></a>00467     {
<a name="l00468"></a>00468         body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a5aedec73517fb7b9cddcbd72663e0ddc">setGravity</a>( <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a40a5bfd35e14ed71df4f73fba859017e">m_gravity</a>);
<a name="l00469"></a>00469         body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ace302f6d75db7e4cd64305dd4d20114b">setDamping</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a3ac285e9deac28c5e952b220309141c9">m_linearDamping</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a390d2d1a52258ff4652ddb87a2e59617">m_angularDamping</a>);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a95a413467b4fd2d2842eaf22e9e17319">m_bRigid</a>)
<a name="l00472"></a>00472         {
<a name="l00473"></a>00473             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa2061f3fd87043f2a3b8c68ee74847cb">setAngularFactor</a>(0.f);
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475         body-&gt;setContactProcessingThreshold(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a662a71feeda1d11825edfd966b047a7c" title="Process contacts with positive distance in range [0..INF].">m_contactProcessingThreshold</a>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a367f57043c4855b5b10f5f9948286a4f">m_do_anisotropic</a>)
<a name="l00479"></a>00479     {
<a name="l00480"></a>00480         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setAnisotropicFriction(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ab146ba10047198628a7fbe69bcc63a52">m_anisotropicFriction</a>);
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482         
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a><a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">00485</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">DeleteBulletShape</a>(<a class="code" href="../../d7/dd7/classbtCollisionShape.html" title="The btCollisionShape class provides an interface for collision shapes that can be shared among btColl...">btCollisionShape</a>* shape, <span class="keywordtype">bool</span> free)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (shape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a10edfe88febe43b3282f05c24bfa026e">getShapeType</a>() == <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5ea420afe83391f77e499f88a6e34efb3f3">TRIANGLE_MESH_SHAPE_PROXYTYPE</a>)
<a name="l00488"></a>00488     {
<a name="l00489"></a>00489         <span class="comment">// shapes based on meshes use an interface that contains the vertices.</span>
<a name="l00490"></a>00490         <a class="code" href="../../db/d47/classbtTriangleMeshShape.html" title="The btTriangleMeshShape is an internal concave triangle mesh interface. Don&#39;t use this class directly...">btTriangleMeshShape</a>* meshShape = <span class="keyword">static_cast&lt;</span><a class="code" href="../../db/d47/classbtTriangleMeshShape.html" title="The btTriangleMeshShape is an internal concave triangle mesh interface. Don&#39;t use this class directly...">btTriangleMeshShape</a>*<span class="keyword">&gt;</span>(shape);
<a name="l00491"></a>00491         <a class="code" href="../../d6/de0/classbtStridingMeshInterface.html">btStridingMeshInterface</a>* meshInterface = meshShape-&gt;<a class="code" href="../../db/d47/classbtTriangleMeshShape.html#a59bbd25d3eb70b23c94c838fb67a03ac">getMeshInterface</a>();
<a name="l00492"></a>00492         <span class="keywordflow">if</span> (meshInterface)
<a name="l00493"></a>00493             <span class="keyword">delete</span> meshInterface;
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (free) {
<a name="l00496"></a>00496         <span class="keyword">delete</span> shape;
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00500"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6757d85bb3011c1f7d48895b1043dcbe">00500</a> <span class="keywordtype">bool</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6757d85bb3011c1f7d48895b1043dcbe">CcdPhysicsController::DeleteControllerShape</a>( )
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>)
<a name="l00503"></a>00503     {
<a name="l00504"></a>00504         <span class="comment">// collision shape is always unique to the controller, can delete it here</span>
<a name="l00505"></a>00505         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a2ae27ee79f2b96b73a5edb887a28e050">isCompound</a>())
<a name="l00506"></a>00506         {
<a name="l00507"></a>00507             <span class="comment">// bullet does not delete the child shape, must do it here</span>
<a name="l00508"></a>00508             btCompoundShape* compoundShape = (btCompoundShape*)<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>;
<a name="l00509"></a>00509             <span class="keywordtype">int</span> numChild = compoundShape-&gt;getNumChildShapes();
<a name="l00510"></a>00510             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=numChild-1 ; i &gt;= 0; i--)
<a name="l00511"></a>00511             {
<a name="l00512"></a>00512                 <a class="code" href="../../d7/dd7/classbtCollisionShape.html" title="The btCollisionShape class provides an interface for collision shapes that can be shared among btColl...">btCollisionShape</a>* childShape = compoundShape-&gt;getChildShape(i);
<a name="l00513"></a>00513                 <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">DeleteBulletShape</a>(childShape, <span class="keyword">true</span>);
<a name="l00514"></a>00514             }
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516         <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">DeleteBulletShape</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>, <span class="keyword">true</span>);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9fbfca2a45799fd05d55196739921ff6">00524</a> <span class="keywordtype">bool</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9fbfca2a45799fd05d55196739921ff6">CcdPhysicsController::ReplaceControllerShape</a>(<a class="code" href="../../d7/dd7/classbtCollisionShape.html" title="The btCollisionShape class provides an interface for collision shapes that can be shared among btColl...">btCollisionShape</a> *newShape)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526     
<a name="l00527"></a>00527     <span class="comment">/* Note, deleting the previous collision shape must be done already */</span>
<a name="l00528"></a>00528     <span class="comment">/* if (m_collisionShape) DeleteControllerShape(); */</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionShape(newShape);
<a name="l00531"></a>00531     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>= newShape;
<a name="l00532"></a>00532     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a>= newShape;
<a name="l00533"></a>00533     
<a name="l00534"></a>00534     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>()) {
<a name="l00535"></a>00535         <span class="comment">// soft body must be recreated</span>
<a name="l00536"></a>00536         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#af47906cfc88fd5697168dec6efdd97c1">removeCcdPhysicsController</a>(<span class="keyword">this</span>);
<a name="l00537"></a>00537         <span class="keyword">delete</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>;
<a name="l00538"></a>00538         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00539"></a>00539         <span class="comment">// force complete reinitialization</span>
<a name="l00540"></a>00540         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa2ab95557da27be16b687293e5b1e9b">m_softbodyMappingDone</a> = <span class="keyword">false</span>;
<a name="l00541"></a>00541         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a81020246baa62437827fc902d9fd3972">m_prototypeTransformInitialized</a> = <span class="keyword">false</span>;
<a name="l00542"></a>00542         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a> = <span class="keyword">false</span>;
<a name="l00543"></a>00543         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9881a8ae18c28da431269c7de2f86a73">CreateSoftbody</a>();
<a name="l00544"></a>00544         <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>);
<a name="l00545"></a>00545         <span class="comment">// reinsert the new body</span>
<a name="l00546"></a>00546         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#a499ce415dc0d29c5b3ec83c73eb59192">addCcdPhysicsController</a>(<span class="keyword">this</span>);
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     
<a name="l00549"></a>00549     <span class="comment">/* Copied from CcdPhysicsEnvironment::addCcdPhysicsController() */</span>
<a name="l00550"></a>00550     
<a name="l00551"></a>00551     <span class="comment">/* without this, an object can rest on the old physics mesh</span>
<a name="l00552"></a>00552 <span class="comment">     * and not move to account for the physics mesh, even with &#39;nosleep&#39; */</span> 
<a name="l00553"></a>00553     <a class="code" href="../../d9/d94/classbtSoftRigidDynamicsWorld.html">btSoftRigidDynamicsWorld</a>* dw= <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a420cf4cc86c7004cbba01154c1504895">GetPhysicsEnvironment</a>()-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#ac052d558bddbd6109860c2210f6eebc2">getDynamicsWorld</a>();
<a name="l00554"></a>00554     <a class="code" href="../../dc/df2/classbtAlignedObjectArray.html">btCollisionObjectArray</a> &amp;obarr= dw-&gt;<a class="code" href="../../d6/def/classbtCollisionWorld.html#a43e878669b2e755992acc41fad1cda30">getCollisionObjectArray</a>();
<a name="l00555"></a>00555     btCollisionObject *ob;
<a name="l00556"></a>00556     btBroadphaseProxy* proxy;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i= 0; i &lt; obarr.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>(); i++) {
<a name="l00559"></a>00559         ob= obarr[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00560"></a>00560         <span class="keywordflow">if</span> (ob-&gt;getCollisionShape() == newShape) {
<a name="l00561"></a>00561             proxy = ob-&gt;getBroadphaseHandle();
<a name="l00562"></a>00562             
<a name="l00563"></a>00563             <span class="keywordflow">if</span> (proxy)
<a name="l00564"></a>00564                 dw-&gt;<a class="code" href="../../d6/def/classbtCollisionWorld.html#a7327cc034ead04b732bd242f21b690cf">getPairCache</a>()-&gt;<a class="code" href="../../df/dc4/classbtOverlappingPairCache.html#a31a0b857f0eb4e2484be6dcc468a6d36">cleanProxyFromPairs</a>(proxy,dw-&gt;<a class="code" href="../../d6/def/classbtCollisionWorld.html#a65b5cb3b0070b3aca14cb4c2aff25ed5">getDispatcher</a>());
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567     
<a name="l00568"></a>00568     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00571"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a071866900c7a1c43d739e42766b6cd2f">00571</a> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a071866900c7a1c43d739e42766b6cd2f">CcdPhysicsController::~CcdPhysicsController</a>()
<a name="l00572"></a>00572 {
<a name="l00573"></a>00573     <span class="comment">//will be reference counted, due to sharing</span>
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>)
<a name="l00575"></a>00575         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#af47906cfc88fd5697168dec6efdd97c1">removeCcdPhysicsController</a>(<span class="keyword">this</span>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>)
<a name="l00578"></a>00578         <span class="keyword">delete</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>;
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a>)
<a name="l00580"></a>00580         <span class="keyword">delete</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a3978a9bd37710c9e047591ba6a3f18e2">m_bulletMotionState</a>;
<a name="l00581"></a>00581     <span class="keyword">delete</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6757d85bb3011c1f7d48895b1043dcbe">DeleteControllerShape</a>();
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>)
<a name="l00586"></a>00586     {
<a name="l00587"></a>00587         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a70f35abafde365e311441d8052697069">Release</a>();
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 
<a name="l00595"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afcf8262d46937996474f6e471a6c00fc">00595</a> <span class="keywordtype">bool</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afcf8262d46937996474f6e471a6c00fc">CcdPhysicsController::SynchronizeMotionStates</a>(<span class="keywordtype">float</span> time)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     <span class="comment">//sync non-static to motionstate, and static from motionstate (todo: add kinematic etc.)</span>
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>* sb = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>();
<a name="l00600"></a>00600     <span class="keywordflow">if</span> (sb)
<a name="l00601"></a>00601     {
<a name="l00602"></a>00602         <span class="keywordflow">if</span> (sb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_bframe) 
<a name="l00603"></a>00603         {
<a name="l00604"></a>00604             btVector3 worldPos = sb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_com;
<a name="l00605"></a>00605             <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> worldquat;
<a name="l00606"></a>00606             <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a> trs = sb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_rot*sb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a3c1d3c3e9f60e3d97f08245a82fa0ed3">m_pose</a>.m_scl;
<a name="l00607"></a>00607             trs.<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a7521bf796271fcb8f0270d24fb13fb30" title="Get the matrix represented as a quaternion.">getRotation</a>(worldquat);
<a name="l00608"></a>00608             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#af89f5ea8a9e809c724248e5966633331">setWorldPosition</a>(worldPos[0],worldPos[1],worldPos[2]);
<a name="l00609"></a>00609             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#aa237b521073dcdc45632a5c493ce2f8d">setWorldOrientation</a>(worldquat[0],worldquat[1],worldquat[2],worldquat[3]);
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611         <span class="keywordflow">else</span> 
<a name="l00612"></a>00612         {
<a name="l00613"></a>00613             btVector3 aabbMin,aabbMax;
<a name="l00614"></a>00614             sb-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a2bfb86d186a1ed0235fed0e1d33c2295">getAabb</a>(aabbMin,aabbMax);
<a name="l00615"></a>00615             btVector3 worldPos  = (aabbMax+aabbMin)*0.5f;
<a name="l00616"></a>00616             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#af89f5ea8a9e809c724248e5966633331">setWorldPosition</a>(worldPos[0],worldPos[1],worldPos[2]);
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a78034d31d2d4f37e8b13f2c49d3f37fa">calculateWorldTransformations</a>();
<a name="l00619"></a>00619         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (body &amp;&amp; !body-&gt;isStaticObject())
<a name="l00625"></a>00625     {
<a name="l00626"></a>00626         
<a name="l00627"></a>00627         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac3afa10130ca2daf5be73f3032072777">m_clamp_vel_max</a>&gt;0.0) || (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abd096791b041500499f2518db612f5c6">m_clamp_vel_min</a>&gt;0.0))
<a name="l00628"></a>00628         {
<a name="l00629"></a>00629             <span class="keyword">const</span> btVector3&amp; linvel = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad04b979396367f3f1945cebff4933252">getLinearVelocity</a>();
<a name="l00630"></a>00630             <span class="keywordtype">float</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= linvel.length();
<a name="l00631"></a>00631             
<a name="l00632"></a>00632             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac3afa10130ca2daf5be73f3032072777">m_clamp_vel_max</a>&gt;0.0) &amp;&amp; (len &gt; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac3afa10130ca2daf5be73f3032072777">m_clamp_vel_max</a>))
<a name="l00633"></a>00633                     body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad692042edc901425189cf1d067eebac6">setLinearVelocity</a>(linvel * (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac3afa10130ca2daf5be73f3032072777">m_clamp_vel_max</a> / len));
<a name="l00634"></a>00634             
<a name="l00635"></a>00635             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abd096791b041500499f2518db612f5c6">m_clamp_vel_min</a>&gt;0.0) &amp;&amp; <a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(len)==0 &amp;&amp; (len &lt; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abd096791b041500499f2518db612f5c6">m_clamp_vel_min</a>))
<a name="l00636"></a>00636                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad692042edc901425189cf1d067eebac6">setLinearVelocity</a>(linvel * (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abd096791b041500499f2518db612f5c6">m_clamp_vel_min</a> / len));
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638         
<a name="l00639"></a>00639         <span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; xform = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a5eaee89e89e7498cfb39709e58fdc477">getCenterOfMassTransform</a>();
<a name="l00640"></a>00640         <span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; worldOri = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>();
<a name="l00641"></a>00641         <span class="keyword">const</span> btVector3&amp; worldPos = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>();
<a name="l00642"></a>00642         <span class="keywordtype">float</span> ori[12];
<a name="l00643"></a>00643         worldOri.<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a632444211b224e2bc0cc6aeef8101084" title="Fill the rotational part of an OpenGL matrix and clear the shear/perspective.">getOpenGLSubMatrix</a>(ori);
<a name="l00644"></a>00644         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#aa237b521073dcdc45632a5c493ce2f8d">setWorldOrientation</a>(ori);
<a name="l00645"></a>00645         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#af89f5ea8a9e809c724248e5966633331">setWorldPosition</a>(worldPos[0],worldPos[1],worldPos[2]);
<a name="l00646"></a>00646         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a78034d31d2d4f37e8b13f2c49d3f37fa">calculateWorldTransformations</a>();
<a name="l00647"></a>00647 
<a name="l00648"></a>00648         <span class="keywordtype">float</span> scale[3];
<a name="l00649"></a>00649         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#aea409d47acdcaef97e1c95da7e7b45b2">getWorldScaling</a>(scale[0],scale[1],scale[2]);
<a name="l00650"></a>00650         btVector3 scaling(scale[0],scale[1],scale[2]);
<a name="l00651"></a>00651         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9122aa5a90bbf97c4364770235d1b2f6">GetCollisionShape</a>()-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#ab0e7232cb21511258227afafb952a0a5">setLocalScaling</a>(scaling);
<a name="l00652"></a>00652     } <span class="keywordflow">else</span>
<a name="l00653"></a>00653     {
<a name="l00654"></a>00654         btVector3 worldPos;
<a name="l00655"></a>00655         <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> worldquat;
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 <span class="comment">/*      m_MotionState-&gt;getWorldPosition(worldPos[0],worldPos[1],worldPos[2]);</span>
<a name="l00658"></a>00658 <span class="comment">        m_MotionState-&gt;getWorldOrientation(worldquat[0],worldquat[1],worldquat[2],worldquat[3]);</span>
<a name="l00659"></a>00659 <span class="comment">        btTransform oldTrans = m_body-&gt;getCenterOfMassTransform();</span>
<a name="l00660"></a>00660 <span class="comment">        btTransform newTrans(worldquat,worldPos);</span>
<a name="l00661"></a>00661 <span class="comment">                </span>
<a name="l00662"></a>00662 <span class="comment">        SetCenterOfMassTransform(newTrans);</span>
<a name="l00663"></a>00663 <span class="comment">        //need to keep track of previous position for friction effects...</span>
<a name="l00664"></a>00664 <span class="comment">        </span>
<a name="l00665"></a>00665 <span class="comment">        m_MotionState-&gt;calculateWorldTransformations();</span>
<a name="l00666"></a>00666 <span class="comment">*/</span>
<a name="l00667"></a>00667         <span class="keywordtype">float</span> scale[3];
<a name="l00668"></a>00668         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#aea409d47acdcaef97e1c95da7e7b45b2">getWorldScaling</a>(scale[0],scale[1],scale[2]);
<a name="l00669"></a>00669         btVector3 scaling(scale[0],scale[1],scale[2]);
<a name="l00670"></a>00670         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a9122aa5a90bbf97c4364770235d1b2f6">GetCollisionShape</a>()-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#ab0e7232cb21511258227afafb952a0a5">setLocalScaling</a>(scaling);
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00680"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a8ba3941caa60e4074a116450ef2d4808">00680</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a8ba3941caa60e4074a116450ef2d4808">CcdPhysicsController::WriteMotionStateToDynamics</a>(<span class="keywordtype">bool</span> nondynaonly)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af390fc40ee7beed24406f7c784bc9d14">CcdPhysicsController::GetTransformFromMotionState</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>);
<a name="l00683"></a>00683     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a62b0a2314aab71f621747710b6cc0b6c">00686</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a62b0a2314aab71f621747710b6cc0b6c">CcdPhysicsController::WriteDynamicsToMotionState</a>()
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689         <span class="comment">// controller replication</span>
<a name="l00690"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab73606937ef7ce8aa7a12dd0a43a4193">00690</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab73606937ef7ce8aa7a12dd0a43a4193">CcdPhysicsController::PostProcessReplica</a>(<span class="keyword">class</span> <a class="code" href="../../d2/d52/classPHY__IMotionState.html">PHY_IMotionState</a>* motionstate,<span class="keyword">class</span> <a class="code" href="../../d7/ddb/classPHY__IPhysicsController.html">PHY_IPhysicsController</a>* parentctrl)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     
<a name="l00693"></a>00693     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a>=<span class="keyword">false</span>;
<a name="l00694"></a>00694     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a> = motionstate;
<a name="l00695"></a>00695     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6ea2ae98e28c242f2b722cf8cf7548f6">m_registerCount</a> = 0;
<a name="l00696"></a>00696     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="comment">// always create a new shape to avoid scaling bug</span>
<a name="l00699"></a>00699     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>)
<a name="l00700"></a>00700     {
<a name="l00701"></a>00701         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a82628ab59948d70446675dd8bf389fa6">AddRef</a>();
<a name="l00702"></a>00702         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9d1ba0bb87f77e9ef4529c494faacada">CreateBulletShape</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a1ea6b1df1de1bbcf8204ccd64bc2c397">m_margin</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abf4c4109803d3e4a825678aa88f594b9">m_bGimpact</a>, !<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a36e3a83bcf2c43873e18e7cf37ad0cfb">m_bSoft</a>);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>)
<a name="l00705"></a>00705         {
<a name="l00706"></a>00706             <span class="comment">// new shape has no scaling, apply initial scaling</span>
<a name="l00707"></a>00707             <span class="comment">//m_collisionShape-&gt;setMargin(m_cci.m_margin);</span>
<a name="l00708"></a>00708             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#ab0e7232cb21511258227afafb952a0a5">setLocalScaling</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>);
<a name="l00709"></a>00709             
<a name="l00710"></a>00710             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>)
<a name="l00711"></a>00711                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a6328b7b20ebbe143742a58d9ab9d5939">calculateLocalInertia</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a>);
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     <span class="comment">// load some characterists that are not </span>
<a name="l00716"></a>00716     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* oldbody = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l00717"></a>00717     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> = 0;
<a name="l00718"></a>00718     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa85fefad2238449045d295d2ce440a35">CreateRigidbody</a>();
<a name="l00719"></a>00719     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (body)
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>)
<a name="l00723"></a>00723         {
<a name="l00724"></a>00724             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a912b4a273bcd6fe9af25c47106db900c">setMassProps</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a> * <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a030b2dd440b5ff88a13a3f2356cc9458">m_inertiaFactor</a>);
<a name="l00725"></a>00725         }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         <span class="keywordflow">if</span> (oldbody)
<a name="l00728"></a>00728         {
<a name="l00729"></a>00729             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a00cf3fa28987ffb77764e5bd3605e3ef">setLinearFactor</a>(oldbody-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ae7b3f0f0df8a9e24f75f632ca08540cb">getLinearFactor</a>());
<a name="l00730"></a>00730             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa2061f3fd87043f2a3b8c68ee74847cb">setAngularFactor</a>(oldbody-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#acf7cb3d3ad86818eb0f33e3226bc5105">getAngularFactor</a>());
<a name="l00731"></a>00731             <span class="keywordflow">if</span> (oldbody-&gt;getActivationState() == <a class="code" href="../../da/df2/btCollisionObject_8h.html#a3974157ba49bb9a32bcfcd3d01a5447b">DISABLE_DEACTIVATION</a>)
<a name="l00732"></a>00732                 body-&gt;setActivationState(<a class="code" href="../../da/df2/btCollisionObject_8h.html#a3974157ba49bb9a32bcfcd3d01a5447b">DISABLE_DEACTIVATION</a>);
<a name="l00733"></a>00733         }
<a name="l00734"></a>00734     }   
<a name="l00735"></a>00735     <span class="comment">// sensor object are added when needed</span>
<a name="l00736"></a>00736     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00737"></a>00737         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#a499ce415dc0d29c5b3ec83c73eb59192">addCcdPhysicsController</a>(<span class="keyword">this</span>);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 
<a name="l00740"></a>00740 <span class="comment">/*  SM_Object* dynaparent=0;</span>
<a name="l00741"></a>00741 <span class="comment">    SumoPhysicsController* sumoparentctrl = (SumoPhysicsController* )parentctrl;</span>
<a name="l00742"></a>00742 <span class="comment">    </span>
<a name="l00743"></a>00743 <span class="comment">    if (sumoparentctrl)</span>
<a name="l00744"></a>00744 <span class="comment">    {</span>
<a name="l00745"></a>00745 <span class="comment">        dynaparent = sumoparentctrl-&gt;GetSumoObject();</span>
<a name="l00746"></a>00746 <span class="comment">    }</span>
<a name="l00747"></a>00747 <span class="comment">    </span>
<a name="l00748"></a>00748 <span class="comment">    SM_Object* orgsumoobject = m_sumoObj;</span>
<a name="l00749"></a>00749 <span class="comment">    </span>
<a name="l00750"></a>00750 <span class="comment">    </span>
<a name="l00751"></a>00751 <span class="comment">    m_sumoObj   =   new SM_Object(</span>
<a name="l00752"></a>00752 <span class="comment">        orgsumoobject-&gt;getShapeHandle(), </span>
<a name="l00753"></a>00753 <span class="comment">        orgsumoobject-&gt;getMaterialProps(),          </span>
<a name="l00754"></a>00754 <span class="comment">        orgsumoobject-&gt;getShapeProps(),</span>
<a name="l00755"></a>00755 <span class="comment">        dynaparent);</span>
<a name="l00756"></a>00756 <span class="comment">    </span>
<a name="l00757"></a>00757 <span class="comment">    m_sumoObj-&gt;setRigidBody(orgsumoobject-&gt;isRigidBody());</span>
<a name="l00758"></a>00758 <span class="comment">    </span>
<a name="l00759"></a>00759 <span class="comment">    m_sumoObj-&gt;setMargin(orgsumoobject-&gt;getMargin());</span>
<a name="l00760"></a>00760 <span class="comment">    m_sumoObj-&gt;setPosition(orgsumoobject-&gt;getPosition());</span>
<a name="l00761"></a>00761 <span class="comment">    m_sumoObj-&gt;setOrientation(orgsumoobject-&gt;getOrientation());</span>
<a name="l00762"></a>00762 <span class="comment">    //if it is a dyna, register for a callback</span>
<a name="l00763"></a>00763 <span class="comment">    m_sumoObj-&gt;registerCallback(*this);</span>
<a name="l00764"></a>00764 <span class="comment">    </span>
<a name="l00765"></a>00765 <span class="comment">    m_sumoScene-&gt;add(* (m_sumoObj));</span>
<a name="l00766"></a>00766 <span class="comment">    */</span>
<a name="l00767"></a>00767 
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa819a5064e87c9b50282f8ddba469c2d">00772</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa819a5064e87c9b50282f8ddba469c2d">CcdPhysicsController::SetPhysicsEnvironment</a>(<span class="keyword">class</span> <a class="code" href="../../d4/db0/classPHY__IPhysicsEnvironment.html">PHY_IPhysicsEnvironment</a> *env)
<a name="l00773"></a>00773 {
<a name="l00774"></a>00774     <span class="comment">// can safely assume CCD environment</span>
<a name="l00775"></a>00775     <a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html">CcdPhysicsEnvironment</a> *physicsEnv = <span class="keyword">static_cast&lt;</span><a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html">CcdPhysicsEnvironment</a>*<span class="keyword">&gt;</span>(env);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a> != physicsEnv) 
<a name="l00778"></a>00778     {
<a name="l00779"></a>00779         <span class="comment">// since the environment is changing, we must also move the controler to the</span>
<a name="l00780"></a>00780         <span class="comment">// new environment. Note that we don&#39;t handle sensor explicitly: this</span>
<a name="l00781"></a>00781         <span class="comment">// function can be called on sensor but only when they are not registered</span>
<a name="l00782"></a>00782         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a>-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#af47906cfc88fd5697168dec6efdd97c1">removeCcdPhysicsController</a>(<span class="keyword">this</span>))
<a name="l00783"></a>00783         {
<a name="l00784"></a>00784             physicsEnv-&gt;<a class="code" href="../../d5/d39/classCcdPhysicsEnvironment.html#a499ce415dc0d29c5b3ec83c73eb59192">addCcdPhysicsController</a>(<span class="keyword">this</span>);
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ad1466866214087738d21867bd8c5f64e">m_physicsEnv</a> = physicsEnv;
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">00790</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">CcdPhysicsController::SetCenterOfMassTransform</a>(<a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; xform)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (body)
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#adeaff2386513eeaaa138e0e3b3acca66">setCenterOfMassTransform</a>(xform);
<a name="l00796"></a>00796     } <span class="keywordflow">else</span>
<a name="l00797"></a>00797     {
<a name="l00798"></a>00798         <span class="comment">//either collision object or soft body?</span>
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>())
<a name="l00800"></a>00800         {
<a name="l00801"></a>00801 
<a name="l00802"></a>00802         } <span class="keywordflow">else</span>
<a name="l00803"></a>00803         {
<a name="l00804"></a>00804 
<a name="l00805"></a>00805             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticOrKinematicObject())
<a name="l00806"></a>00806             {
<a name="l00807"></a>00807                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setInterpolationWorldTransform(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform());
<a name="l00808"></a>00808             } <span class="keywordflow">else</span>
<a name="l00809"></a>00809             {
<a name="l00810"></a>00810                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setInterpolationWorldTransform(xform);
<a name="l00811"></a>00811             }
<a name="l00812"></a>00812             <span class="keywordflow">if</span> (body)
<a name="l00813"></a>00813             {
<a name="l00814"></a>00814                 body-&gt;setInterpolationLinearVelocity(body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad04b979396367f3f1945cebff4933252">getLinearVelocity</a>());
<a name="l00815"></a>00815                 body-&gt;setInterpolationAngularVelocity(body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#adc19d8e39a18aeabfb04be61de2c984e">getAngularVelocity</a>());
<a name="l00816"></a>00816                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aeb2880f17187c3f28b4a253423aa71d1">updateInertiaTensor</a>();
<a name="l00817"></a>00817             }
<a name="l00818"></a>00818             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setWorldTransform(xform);
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <span class="comment">// kinematic methods</span>
<a name="l00824"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a2f55a925904bbb102317c7d0dcdafa5f">00824</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a2f55a925904bbb102317c7d0dcdafa5f">CcdPhysicsController::RelativeTranslate</a>(<span class="keywordtype">float</span> dlocX,<span class="keywordtype">float</span> dlocY,<span class="keywordtype">float</span> dlocZ,<span class="keywordtype">bool</span> local)
<a name="l00825"></a>00825 {
<a name="l00826"></a>00826     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00827"></a>00827     {
<a name="l00828"></a>00828         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l00829"></a>00829         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l00830"></a>00830         {
<a name="l00831"></a>00831             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00832"></a>00832                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l00833"></a>00833             <span class="comment">// kinematic object should not set the transform, it disturbs the velocity interpolation</span>
<a name="l00834"></a>00834             <span class="keywordflow">return</span>;
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837         <span class="comment">// btRigidBody* body = GetRigidBody(); // not used anymore</span>
<a name="l00838"></a>00838 
<a name="l00839"></a>00839         btVector3 dloc(dlocX,dlocY,dlocZ);
<a name="l00840"></a>00840         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00841"></a>00841     
<a name="l00842"></a>00842         <span class="keywordflow">if</span> (local)
<a name="l00843"></a>00843         {
<a name="l00844"></a>00844             dloc = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*dloc;
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         xform.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>() + dloc);
<a name="l00848"></a>00848         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851 }
<a name="l00852"></a>00852 
<a name="l00853"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a278f8d19f72188e71a3915e9766d9ebd">00853</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a278f8d19f72188e71a3915e9766d9ebd">CcdPhysicsController::RelativeRotate</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> rotval[9],<span class="keywordtype">bool</span> local)
<a name="l00854"></a>00854 {
<a name="l00855"></a>00855     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00856"></a>00856     {
<a name="l00857"></a>00857         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l00859"></a>00859         {
<a name="l00860"></a>00860             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00861"></a>00861                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l00862"></a>00862             <span class="comment">// kinematic object should not set the transform, it disturbs the velocity interpolation</span>
<a name="l00863"></a>00863             <span class="keywordflow">return</span>;
<a name="l00864"></a>00864         }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a> drotmat(rotval[0], rotval[3], rotval[6],
<a name="l00867"></a>00867                             rotval[1], rotval[4], rotval[7],
<a name="l00868"></a>00868                             rotval[2], rotval[5], rotval[8]);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a> currentOrn;
<a name="l00872"></a>00872         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a642ae52c635bbe8747202e05e1561a86">GetWorldOrientation</a>(currentOrn);
<a name="l00873"></a>00873 
<a name="l00874"></a>00874         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00875"></a>00875         
<a name="l00876"></a>00876         xform.<a class="code" href="../../d4/d79/classbtTransform.html#acf90a00b9996c47cb4b4a74aadb28c09" title="Set the rotational element by btMatrix3x3.">setBasis</a>(xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*(local ? 
<a name="l00877"></a>00877         drotmat : (currentOrn.<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a051aba0fed800ed3453f04a5b8e7f465" title="Return the inverse of the matrix.">inverse</a>() * drotmat * currentOrn)));
<a name="l00878"></a>00878 
<a name="l00879"></a>00879         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 
<a name="l00884"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a642ae52c635bbe8747202e05e1561a86">00884</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a642ae52c635bbe8747202e05e1561a86">CcdPhysicsController::GetWorldOrientation</a>(<a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; mat)
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886     <span class="keywordtype">float</span> ori[12];
<a name="l00887"></a>00887     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a54e05634a81870c33df327b23bfda4b7">m_MotionState</a>-&gt;<a class="code" href="../../d2/d52/classPHY__IMotionState.html#a859e62d1a0cf0d251aa57923583afe44">getWorldOrientation</a>(ori);
<a name="l00888"></a>00888     mat.<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a2135b57e51831fd0112299c6e1348beb" title="Set from the rotational part of a 4x4 OpenGL matrix.">setFromOpenGLSubMatrix</a>(ori);
<a name="l00889"></a>00889 }
<a name="l00890"></a>00890 
<a name="l00891"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aceed9439d8d2febac372c2c38173c194">00891</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aceed9439d8d2febac372c2c38173c194">CcdPhysicsController::getOrientation</a>(<span class="keywordtype">float</span> &amp;quatImag0,<span class="keywordtype">float</span> &amp;quatImag1,<span class="keywordtype">float</span> &amp;quatImag2,<span class="keywordtype">float</span> &amp;quatReal)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> q = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform().getRotation();
<a name="l00894"></a>00894     quatImag0 = q[0];
<a name="l00895"></a>00895     quatImag1 = q[1];
<a name="l00896"></a>00896     quatImag2 = q[2];
<a name="l00897"></a>00897     quatReal = q[3];
<a name="l00898"></a>00898 }
<a name="l00899"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab0b6eb6c8616f1abfbae9330a01a11c1">00899</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab0b6eb6c8616f1abfbae9330a01a11c1">CcdPhysicsController::setOrientation</a>(<span class="keywordtype">float</span> quatImag0,<span class="keywordtype">float</span> quatImag1,<span class="keywordtype">float</span> quatImag2,<span class="keywordtype">float</span> quatReal)
<a name="l00900"></a>00900 {
<a name="l00901"></a>00901     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00902"></a>00902     {
<a name="l00903"></a>00903         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l00904"></a>00904         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l00905"></a>00905         {
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00907"></a>00907                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l00908"></a>00908             <span class="comment">// kinematic object should not set the transform, it disturbs the velocity interpolation</span>
<a name="l00909"></a>00909             <span class="keywordflow">return</span>;
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911         <span class="comment">// not required</span>
<a name="l00912"></a>00912         <span class="comment">//m_MotionState-&gt;setWorldOrientation(quatImag0,quatImag1,quatImag2,quatReal);</span>
<a name="l00913"></a>00913         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform  = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00914"></a>00914         xform.<a class="code" href="../../d4/d79/classbtTransform.html#a5d012bc1b697ba1ff775f0b3b7ab6e3b" title="Set the rotational element by btQuaternion.">setRotation</a>(<a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a>(quatImag0,quatImag1,quatImag2,quatReal));
<a name="l00915"></a>00915         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00916"></a>00916         <span class="comment">// not required</span>
<a name="l00917"></a>00917         <span class="comment">//m_bulletMotionState-&gt;setWorldTransform(xform);</span>
<a name="l00918"></a>00918         
<a name="l00919"></a>00919         
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00925"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#acd41fe58756e94cc575f0bdeffff868f">00925</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#acd41fe58756e94cc575f0bdeffff868f">CcdPhysicsController::setWorldOrientation</a>(<span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; orn)
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00928"></a>00928     {
<a name="l00929"></a>00929         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l00930"></a>00930         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject() &amp;&amp; !<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00931"></a>00931         {
<a name="l00932"></a>00932             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934         <span class="comment">// not required</span>
<a name="l00935"></a>00935         <span class="comment">//m_MotionState-&gt;setWorldOrientation(quatImag0,quatImag1,quatImag2,quatReal);</span>
<a name="l00936"></a>00936         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform  = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00937"></a>00937         xform.<a class="code" href="../../d4/d79/classbtTransform.html#acf90a00b9996c47cb4b4a74aadb28c09" title="Set the rotational element by btMatrix3x3.">setBasis</a>(orn);
<a name="l00938"></a>00938         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00939"></a>00939         <span class="comment">// not required</span>
<a name="l00940"></a>00940         <span class="comment">//m_bulletMotionState-&gt;setWorldTransform(xform);</span>
<a name="l00941"></a>00941         <span class="comment">//only once!</span>
<a name="l00942"></a>00942         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a> &amp;&amp; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>())
<a name="l00943"></a>00943         {
<a name="l00944"></a>00944             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab841a4211ae7b6c609f047f5e2ca6be7">m_softbodyStartTrans</a>.<a class="code" href="../../d4/d79/classbtTransform.html#acf90a00b9996c47cb4b4a74aadb28c09" title="Set the rotational element by btMatrix3x3.">setBasis</a>(orn);
<a name="l00945"></a>00945             xform.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab841a4211ae7b6c609f047f5e2ca6be7">m_softbodyStartTrans</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>());
<a name="l00946"></a>00946             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>()-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a7ab01480d2dcebf21db52e65d0d8b891">transform</a>(xform);
<a name="l00947"></a>00947             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a> = <span class="keyword">true</span>;
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 }
<a name="l00953"></a>00953 
<a name="l00954"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a2be46b85035a06fce1ad693062de56d8">00954</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a2be46b85035a06fce1ad693062de56d8">CcdPhysicsController::setPosition</a>(<span class="keywordtype">float</span> posX,<span class="keywordtype">float</span> posY,<span class="keywordtype">float</span> posZ)
<a name="l00955"></a>00955 {
<a name="l00956"></a>00956     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00957"></a>00957     {
<a name="l00958"></a>00958         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l00960"></a>00960         {
<a name="l00961"></a>00961             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l00962"></a>00962                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l00963"></a>00963             <span class="comment">// kinematic object should not set the transform, it disturbs the velocity interpolation</span>
<a name="l00964"></a>00964             <span class="keywordflow">return</span>;
<a name="l00965"></a>00965         }
<a name="l00966"></a>00966         <span class="comment">// not required, this function is only used to update the physic controller</span>
<a name="l00967"></a>00967         <span class="comment">//m_MotionState-&gt;setWorldPosition(posX,posY,posZ);</span>
<a name="l00968"></a>00968         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform  = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00969"></a>00969         xform.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(btVector3(posX,posY,posZ));
<a name="l00970"></a>00970         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af80ac270cc85e2f3e628a0148fc28c74">SetCenterOfMassTransform</a>(xform);
<a name="l00971"></a>00971         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afacfc9bc21959397a5466bdac18484f8">m_softBodyTransformInitialized</a>)
<a name="l00972"></a>00972             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab841a4211ae7b6c609f047f5e2ca6be7">m_softbodyStartTrans</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>());
<a name="l00973"></a>00973         <span class="comment">// not required</span>
<a name="l00974"></a>00974         <span class="comment">//m_bulletMotionState-&gt;setWorldTransform(xform);</span>
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 }
<a name="l00977"></a>00977 
<a name="l00978"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ac5be89a623a182dc94cf47601e62a947">00978</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ac5be89a623a182dc94cf47601e62a947">CcdPhysicsController::forceWorldTransform</a>(<span class="keyword">const</span> <a class="code" href="../../d1/d7d/classbtMatrix3x3.html" title="The btMatrix3x3 class implements a 3x3 rotation matrix, to perform linear algebra in combination with...">btMatrix3x3</a>&amp; mat, <span class="keyword">const</span> btVector3&amp; pos)
<a name="l00979"></a>00979 {
<a name="l00980"></a>00980     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>)
<a name="l00981"></a>00981     {
<a name="l00982"></a>00982         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00983"></a>00983         xform.<a class="code" href="../../d4/d79/classbtTransform.html#acf90a00b9996c47cb4b4a74aadb28c09" title="Set the rotational element by btMatrix3x3.">setBasis</a>(mat);
<a name="l00984"></a>00984         xform.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>(pos);
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986 }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 
<a name="l00989"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a1facd5754b89ab9e8e343832c346518b">00989</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a1facd5754b89ab9e8e343832c346518b">CcdPhysicsController::resolveCombinedVelocities</a>(<span class="keywordtype">float</span> linvelX,<span class="keywordtype">float</span> linvelY,<span class="keywordtype">float</span> linvelZ,<span class="keywordtype">float</span> angVelX,<span class="keywordtype">float</span> angVelY,<span class="keywordtype">float</span> angVelZ)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a95cd17ccc304c42efa544e17b4b6e124">00993</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a95cd17ccc304c42efa544e17b4b6e124">CcdPhysicsController::getPosition</a>(<a class="code" href="../../d8/d6c/structPHY____Vector3.html">PHY__Vector3</a>&amp; pos)<span class="keyword"> const</span>
<a name="l00994"></a>00994 <span class="keyword"></span>{
<a name="l00995"></a>00995     <span class="keyword">const</span> <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a>&amp; xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l00996"></a>00996     pos[0] = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().x();
<a name="l00997"></a>00997     pos[1] = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().y();
<a name="l00998"></a>00998     pos[2] = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().z();
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a743bbc1c4519dceac9b8b1ad3ac70a5c">01001</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a743bbc1c4519dceac9b8b1ad3ac70a5c">CcdPhysicsController::setScaling</a>(<span class="keywordtype">float</span> scaleX,<span class="keywordtype">float</span> scaleY,<span class="keywordtype">float</span> scaleZ)
<a name="l01002"></a>01002 {
<a name="l01003"></a>01003     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>.x()-scaleX) ||
<a name="l01004"></a>01004         !<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>.y()-scaleY) ||
<a name="l01005"></a>01005         !<a class="code" href="../../d0/d6b/btScalar_8h.html#a64883187cf63c81ef5fb15f6f0c7ae05">btFuzzyZero</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>.z()-scaleZ))
<a name="l01006"></a>01006     {
<a name="l01007"></a>01007         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a> = btVector3(scaleX,scaleY,scaleZ);
<a name="l01008"></a>01008 
<a name="l01009"></a>01009         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionShape())
<a name="l01010"></a>01010         {
<a name="l01011"></a>01011             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>); <span class="comment">// without this, sleeping objects scale wont be applied in bullet if python changes the scale - Campbell.</span>
<a name="l01012"></a>01012             <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionShape()-&gt;setLocalScaling(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aabfdc66b42772c0dbf93ea6123bf3d2b">m_scaling</a>);
<a name="l01013"></a>01013             
<a name="l01014"></a>01014             <span class="comment">//printf(&quot;no inertia recalc for fixed objects with mass=0\n&quot;);</span>
<a name="l01015"></a>01015             <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01016"></a>01016             <span class="keywordflow">if</span> (body &amp;&amp; <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>)
<a name="l01017"></a>01017             {
<a name="l01018"></a>01018                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a5f821aa731290a47b6dfcd2e981e69bb">getCollisionShape</a>()-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a6328b7b20ebbe143742a58d9ab9d5939">calculateLocalInertia</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a>);
<a name="l01019"></a>01019                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a912b4a273bcd6fe9af25c47106db900c">setMassProps</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ac76146c64292e77f0cc1d3b218b074ec">m_mass</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a8546c38f9444cd3b53b99e39b03ad33b">m_localInertiaTensor</a> * <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a030b2dd440b5ff88a13a3f2356cc9458">m_inertiaFactor</a>);
<a name="l01020"></a>01020             } 
<a name="l01021"></a>01021             
<a name="l01022"></a>01022         }
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024 }
<a name="l01025"></a>01025         
<a name="l01026"></a>01026         <span class="comment">// physics methods</span>
<a name="l01027"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a8fb6e1657c20c388a5a64c7be57dd694">01027</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a8fb6e1657c20c388a5a64c7be57dd694">CcdPhysicsController::ApplyTorque</a>(<span class="keywordtype">float</span> torqueX,<span class="keywordtype">float</span> torqueY,<span class="keywordtype">float</span> torqueZ,<span class="keywordtype">bool</span> local)
<a name="l01028"></a>01028 {
<a name="l01029"></a>01029     btVector3 torque(torqueX,torqueY,torqueZ);
<a name="l01030"></a>01030     <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l01031"></a>01031     
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; torque.length2() &gt; (<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>*<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>))
<a name="l01034"></a>01034     {
<a name="l01035"></a>01035         <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01036"></a>01036         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate();
<a name="l01037"></a>01037         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l01038"></a>01038         {
<a name="l01039"></a>01039             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l01040"></a>01040                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l01041"></a>01041             <span class="keywordflow">return</span>;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043         <span class="keywordflow">if</span> (local)
<a name="l01044"></a>01044         {
<a name="l01045"></a>01045             torque  = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*torque;
<a name="l01046"></a>01046         }
<a name="l01047"></a>01047         <span class="keywordflow">if</span> (body)
<a name="l01048"></a>01048         {
<a name="l01049"></a>01049             <span class="keywordflow">if</span>  (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a95a413467b4fd2d2842eaf22e9e17319">m_bRigid</a>)
<a name="l01050"></a>01050             {
<a name="l01051"></a>01051                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aede3cf53474f4b367693b19871692b99">applyTorque</a>(torque);
<a name="l01052"></a>01052             }
<a name="l01053"></a>01053             <span class="keywordflow">else</span>
<a name="l01054"></a>01054             {
<a name="l01055"></a>01055                 <span class="comment">//workaround for incompatibility between &#39;DYNAMIC&#39; game object, and angular factor</span>
<a name="l01056"></a>01056                 <span class="comment">//a DYNAMIC object has some inconsistency: it has no angular effect due to collisions, but still has torque</span>
<a name="l01057"></a>01057                 <span class="keyword">const</span> btVector3&amp; angFac = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#acf7cb3d3ad86818eb0f33e3226bc5105">getAngularFactor</a>();
<a name="l01058"></a>01058                 btVector3 tmpFac(1,1,1);
<a name="l01059"></a>01059                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa2061f3fd87043f2a3b8c68ee74847cb">setAngularFactor</a>(tmpFac);
<a name="l01060"></a>01060                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aede3cf53474f4b367693b19871692b99">applyTorque</a>(torque);
<a name="l01061"></a>01061                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa2061f3fd87043f2a3b8c68ee74847cb">setAngularFactor</a>(angFac);
<a name="l01062"></a>01062             } 
<a name="l01063"></a>01063         } 
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065 }
<a name="l01066"></a>01066 
<a name="l01067"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afe66eef8a5ade414f52e38eefd5d112c">01067</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#afe66eef8a5ade414f52e38eefd5d112c">CcdPhysicsController::ApplyForce</a>(<span class="keywordtype">float</span> forceX,<span class="keywordtype">float</span> forceY,<span class="keywordtype">float</span> forceZ,<span class="keywordtype">bool</span> local)
<a name="l01068"></a>01068 {
<a name="l01069"></a>01069     btVector3 force(forceX,forceY,forceZ);
<a name="l01070"></a>01070     
<a name="l01071"></a>01071 
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; force.length2() &gt; (<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>*<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>))
<a name="l01073"></a>01073     {
<a name="l01074"></a>01074         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate();
<a name="l01075"></a>01075         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l01076"></a>01076         {
<a name="l01077"></a>01077             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l01078"></a>01078                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l01079"></a>01079             <span class="keywordflow">return</span>;
<a name="l01080"></a>01080         }
<a name="l01081"></a>01081         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l01082"></a>01082         
<a name="l01083"></a>01083         <span class="keywordflow">if</span> (local)
<a name="l01084"></a>01084         {   
<a name="l01085"></a>01085             force   = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*force;
<a name="l01086"></a>01086         }
<a name="l01087"></a>01087         <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01088"></a>01088         <span class="keywordflow">if</span> (body)
<a name="l01089"></a>01089             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a48478896407083f4ff64299e0c3c4a32">applyCentralForce</a>(force);
<a name="l01090"></a>01090         <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>* soft = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>();
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (soft)
<a name="l01092"></a>01092         {
<a name="l01093"></a>01093             <span class="comment">// the force is applied on each node, must reduce it in the same extend</span>
<a name="l01094"></a>01094             <span class="keywordflow">if</span> (soft-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#ad53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>() &gt; 0)
<a name="l01095"></a>01095                 force /= soft-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#ad53c95f39d517c1b72db24f175e92fb5">m_nodes</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>();
<a name="l01096"></a>01096             soft-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a4d4cb25a0b61eee260bda46bca373960">addForce</a>(force);
<a name="l01097"></a>01097         }
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099 }
<a name="l01100"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a94e352358ee9bbef2c8ae842bba5190b">01100</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a94e352358ee9bbef2c8ae842bba5190b">CcdPhysicsController::SetAngularVelocity</a>(<span class="keywordtype">float</span> ang_velX,<span class="keywordtype">float</span> ang_velY,<span class="keywordtype">float</span> ang_velZ,<span class="keywordtype">bool</span> local)
<a name="l01101"></a>01101 {
<a name="l01102"></a>01102     btVector3 angvel(ang_velX,ang_velY,ang_velZ);
<a name="l01103"></a>01103     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; angvel.length2() &gt; (<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>*<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>))
<a name="l01104"></a>01104     {
<a name="l01105"></a>01105         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l01106"></a>01106         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l01107"></a>01107         {
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l01109"></a>01109                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l01110"></a>01110             <span class="keywordflow">return</span>;
<a name="l01111"></a>01111         }
<a name="l01112"></a>01112         <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (local)
<a name="l01114"></a>01114         {
<a name="l01115"></a>01115             angvel  = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*angvel;
<a name="l01116"></a>01116         }
<a name="l01117"></a>01117         <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01118"></a>01118         <span class="keywordflow">if</span> (body)
<a name="l01119"></a>01119             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ac6e5f94e998150e37ca8962c851d10a8">setAngularVelocity</a>(angvel);
<a name="l01120"></a>01120     }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 }
<a name="l01123"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab0ffe10c87ed189e550f3c8434bba480">01123</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab0ffe10c87ed189e550f3c8434bba480">CcdPhysicsController::SetLinearVelocity</a>(<span class="keywordtype">float</span> lin_velX,<span class="keywordtype">float</span> lin_velY,<span class="keywordtype">float</span> lin_velZ,<span class="keywordtype">bool</span> local)
<a name="l01124"></a>01124 {
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     btVector3 linVel(lin_velX,lin_velY,lin_velZ);
<a name="l01127"></a>01127     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a><span class="comment">/* &amp;&amp; linVel.length2() &gt; (SIMD_EPSILON*SIMD_EPSILON)*/</span>)
<a name="l01128"></a>01128     {
<a name="l01129"></a>01129         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate(<span class="keyword">true</span>);
<a name="l01130"></a>01130         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l01131"></a>01131         {
<a name="l01132"></a>01132             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l01133"></a>01133                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l01134"></a>01134             <span class="keywordflow">return</span>;
<a name="l01135"></a>01135         }
<a name="l01136"></a>01136         
<a name="l01137"></a>01137         <a class="code" href="../../da/d60/classbtSoftBody.html">btSoftBody</a>* soft = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aaa0a4d84c88ada42031b70fc997ad335">GetSoftBody</a>();
<a name="l01138"></a>01138         <span class="keywordflow">if</span> (soft)
<a name="l01139"></a>01139         {
<a name="l01140"></a>01140             <span class="keywordflow">if</span> (local)
<a name="l01141"></a>01141             {
<a name="l01142"></a>01142                 linVel  = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ab841a4211ae7b6c609f047f5e2ca6be7">m_softbodyStartTrans</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*linVel;
<a name="l01143"></a>01143             }
<a name="l01144"></a>01144             soft-&gt;<a class="code" href="../../da/d60/classbtSoftBody.html#a94daa5306dfad2e4c5b29715600aed8e">setVelocity</a>(linVel);
<a name="l01145"></a>01145         } <span class="keywordflow">else</span>
<a name="l01146"></a>01146         {
<a name="l01147"></a>01147             <a class="code" href="../../d4/d79/classbtTransform.html" title="The btTransform class supports rigid transforms with only translation and rotation and no scaling/she...">btTransform</a> xform = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getWorldTransform();
<a name="l01148"></a>01148             <span class="keywordflow">if</span> (local)
<a name="l01149"></a>01149             {
<a name="l01150"></a>01150                 linVel  = xform.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>()*linVel;
<a name="l01151"></a>01151             }
<a name="l01152"></a>01152             <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01153"></a>01153             <span class="keywordflow">if</span> (body)
<a name="l01154"></a>01154                 body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad692042edc901425189cf1d067eebac6">setLinearVelocity</a>(linVel);
<a name="l01155"></a>01155         }
<a name="l01156"></a>01156     }
<a name="l01157"></a>01157 }
<a name="l01158"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ac208f234333e837bc555a70731ce2487">01158</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#ac208f234333e837bc555a70731ce2487">CcdPhysicsController::applyImpulse</a>(<span class="keywordtype">float</span> attachX,<span class="keywordtype">float</span> attachY,<span class="keywordtype">float</span> attachZ, <span class="keywordtype">float</span> impulseX,<span class="keywordtype">float</span> impulseY,<span class="keywordtype">float</span> impulseZ)
<a name="l01159"></a>01159 {
<a name="l01160"></a>01160     btVector3 impulse(impulseX,impulseY,impulseZ);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a> &amp;&amp; impulse.length2() &gt; (<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>*<a class="code" href="../../d0/d6b/btScalar_8h.html#ae51eef6845bd59f964c1b2dbfe7054b7">SIMD_EPSILON</a>))
<a name="l01163"></a>01163     {
<a name="l01164"></a>01164         <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;activate();
<a name="l01165"></a>01165         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;isStaticObject())
<a name="l01166"></a>01166         {
<a name="l01167"></a>01167             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a5b4930045b8eef5ec0763ae3ea844f02">m_bSensor</a>)
<a name="l01168"></a>01168                 <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;setCollisionFlags(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af5d1f6ee621e8204c67446403ee2bca0">m_object</a>-&gt;getCollisionFlags() | btCollisionObject::CF_KINEMATIC_OBJECT);
<a name="l01169"></a>01169             <span class="keywordflow">return</span>;
<a name="l01170"></a>01170         }
<a name="l01171"></a>01171         
<a name="l01172"></a>01172         btVector3 pos(attachX,attachY,attachZ);
<a name="l01173"></a>01173         <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01174"></a>01174         <span class="keywordflow">if</span> (body)
<a name="l01175"></a>01175             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a8274f89d9e6b8fe945282797bd25f377">applyImpulse</a>(impulse,pos);
<a name="l01176"></a>01176             
<a name="l01177"></a>01177     }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179 }
<a name="l01180"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a958821f90564a1920730403d32d5dd80">01180</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a958821f90564a1920730403d32d5dd80">CcdPhysicsController::SetActive</a>(<span class="keywordtype">bool</span> active)
<a name="l01181"></a>01181 {
<a name="l01182"></a>01182 }
<a name="l01183"></a>01183         <span class="comment">// reading out information from physics</span>
<a name="l01184"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a26f11726194c97979cbb10504c3df406">01184</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a26f11726194c97979cbb10504c3df406">CcdPhysicsController::GetLinearVelocity</a>(<span class="keywordtype">float</span>&amp; linvX,<span class="keywordtype">float</span>&amp; linvY,<span class="keywordtype">float</span>&amp; linvZ)
<a name="l01185"></a>01185 {
<a name="l01186"></a>01186     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (body)
<a name="l01188"></a>01188     {
<a name="l01189"></a>01189         <span class="keyword">const</span> btVector3&amp; linvel = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ad04b979396367f3f1945cebff4933252">getLinearVelocity</a>();
<a name="l01190"></a>01190         linvX = linvel.x();
<a name="l01191"></a>01191         linvY = linvel.y();
<a name="l01192"></a>01192         linvZ = linvel.z();
<a name="l01193"></a>01193     } <span class="keywordflow">else</span>
<a name="l01194"></a>01194     {
<a name="l01195"></a>01195         linvX = 0.f;
<a name="l01196"></a>01196         linvY = 0.f;
<a name="l01197"></a>01197         linvZ = 0.f;
<a name="l01198"></a>01198     }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01202"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa689c3494238360eceef6a64a4f00be4">01202</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#aa689c3494238360eceef6a64a4f00be4">CcdPhysicsController::GetAngularVelocity</a>(<span class="keywordtype">float</span>&amp; angVelX,<span class="keywordtype">float</span>&amp; angVelY,<span class="keywordtype">float</span>&amp; angVelZ)
<a name="l01203"></a>01203 {
<a name="l01204"></a>01204     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01205"></a>01205     <span class="keywordflow">if</span> (body)
<a name="l01206"></a>01206     {
<a name="l01207"></a>01207         <span class="keyword">const</span> btVector3&amp; angvel= body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#adc19d8e39a18aeabfb04be61de2c984e">getAngularVelocity</a>();
<a name="l01208"></a>01208         angVelX = angvel.x();
<a name="l01209"></a>01209         angVelY = angvel.y();
<a name="l01210"></a>01210         angVelZ = angvel.z();
<a name="l01211"></a>01211     } <span class="keywordflow">else</span>
<a name="l01212"></a>01212     {
<a name="l01213"></a>01213         angVelX = 0.f;
<a name="l01214"></a>01214         angVelY = 0.f;
<a name="l01215"></a>01215         angVelZ = 0.f;
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 }
<a name="l01218"></a>01218 
<a name="l01219"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a326a32ff3b59efbcef3ee0ca0dace943">01219</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a326a32ff3b59efbcef3ee0ca0dace943">CcdPhysicsController::GetVelocity</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> posX,<span class="keyword">const</span> <span class="keywordtype">float</span> posY,<span class="keyword">const</span> <span class="keywordtype">float</span> posZ,<span class="keywordtype">float</span>&amp; linvX,<span class="keywordtype">float</span>&amp; linvY,<span class="keywordtype">float</span>&amp; linvZ)
<a name="l01220"></a>01220 {
<a name="l01221"></a>01221     btVector3 pos(posX,posY,posZ);
<a name="l01222"></a>01222     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01223"></a>01223     <span class="keywordflow">if</span> (body)
<a name="l01224"></a>01224     {
<a name="l01225"></a>01225         btVector3 linvel = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#a78f7293894bf0652a1e740ee63bf1eed">getVelocityInLocalPoint</a>(pos);
<a name="l01226"></a>01226         linvX = linvel.x();
<a name="l01227"></a>01227         linvY = linvel.y();
<a name="l01228"></a>01228         linvZ = linvel.z();
<a name="l01229"></a>01229     } <span class="keywordflow">else</span>
<a name="l01230"></a>01230     {
<a name="l01231"></a>01231         linvX = 0.f;
<a name="l01232"></a>01232         linvY = 0.f;
<a name="l01233"></a>01233         linvZ = 0.f;
<a name="l01234"></a>01234     }
<a name="l01235"></a>01235 }
<a name="l01236"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6348f225e3ee37910bef565d2b610599">01236</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a6348f225e3ee37910bef565d2b610599">CcdPhysicsController::getReactionForce</a>(<span class="keywordtype">float</span>&amp; forceX,<span class="keywordtype">float</span>&amp; forceY,<span class="keywordtype">float</span>&amp; forceZ)
<a name="l01237"></a>01237 {
<a name="l01238"></a>01238 }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240         <span class="comment">// dyna&#39;s that are rigidbody are free in orientation, dyna&#39;s with non-rigidbody are restricted </span>
<a name="l01241"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a595cdf1e7e7411f3c4b6c72bf8017d64">01241</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a595cdf1e7e7411f3c4b6c72bf8017d64">CcdPhysicsController::setRigidBody</a>(<span class="keywordtype">bool</span> rigid)
<a name="l01242"></a>01242 {
<a name="l01243"></a>01243     <span class="keywordflow">if</span> (!rigid)
<a name="l01244"></a>01244     {
<a name="l01245"></a>01245         <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01246"></a>01246         <span class="keywordflow">if</span> (body)
<a name="l01247"></a>01247         {
<a name="l01248"></a>01248             <span class="comment">//fake it for now</span>
<a name="l01249"></a>01249             btVector3 inertia = body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#acaf08c40e69ccacaf50a64e03519e3a2">getInvInertiaDiagLocal</a>();
<a name="l01250"></a>01250             inertia[1] = 0.f;
<a name="l01251"></a>01251             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#ac47e4f27b351e24ed180bb0fcfa5a51d">setInvInertiaDiagLocal</a>(inertia);
<a name="l01252"></a>01252             body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aeb2880f17187c3f28b4a253423aa71d1">updateInertiaTensor</a>();
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257         <span class="comment">// clientinfo for raycasts for example</span>
<a name="l01258"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a18e1adf6ff37532faba3ef53b933663b">01258</a> <span class="keywordtype">void</span>*       <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a18e1adf6ff37532faba3ef53b933663b">CcdPhysicsController::getNewClientInfo</a>()
<a name="l01259"></a>01259 {
<a name="l01260"></a>01260     <span class="keywordflow">return</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a4a472042eb3bb9d453ec76c89714657a">m_newClientInfo</a>;
<a name="l01261"></a>01261 }
<a name="l01262"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#abfa4d13e5c2850a1c77e972fecc1c88d">01262</a> <span class="keywordtype">void</span>        <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#abfa4d13e5c2850a1c77e972fecc1c88d">CcdPhysicsController::setNewClientInfo</a>(<span class="keywordtype">void</span>* clientinfo)
<a name="l01263"></a>01263 {
<a name="l01264"></a>01264     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a4a472042eb3bb9d453ec76c89714657a">m_newClientInfo</a> = clientinfo;
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267 
<a name="l01268"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#abb75b48d06ee24d76d6f834ac7093113">01268</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#abb75b48d06ee24d76d6f834ac7093113">CcdPhysicsController::UpdateDeactivation</a>(<span class="keywordtype">float</span> timeStep)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01271"></a>01271     <span class="keywordflow">if</span> (body)
<a name="l01272"></a>01272     {
<a name="l01273"></a>01273         body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa48bf2e5bf090c613ad8e9aa605bc7df">updateDeactivation</a>( timeStep);
<a name="l01274"></a>01274     }
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a609d3955a05874e421320f1423135fc7">01277</a> <span class="keywordtype">bool</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a609d3955a05874e421320f1423135fc7">CcdPhysicsController::wantsSleeping</a>()
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279     <a class="code" href="../../d9/dea/classbtRigidBody.html">btRigidBody</a>* body = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a23213dc1febb96503449d50afb9a8da6">GetRigidBody</a>();
<a name="l01280"></a>01280     <span class="keywordflow">if</span> (body)
<a name="l01281"></a>01281     {
<a name="l01282"></a>01282         <span class="keywordflow">return</span> body-&gt;<a class="code" href="../../d9/dea/classbtRigidBody.html#aa2ccbd4474fe0edef483533943b5d666">wantsSleeping</a>();
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284     <span class="comment">//check it out</span>
<a name="l01285"></a>01285     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01288"></a><a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a193cbce5fc2f9bd84871050a6b00dad3">01288</a> <a class="code" href="../../d7/ddb/classPHY__IPhysicsController.html">PHY_IPhysicsController</a>* <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a193cbce5fc2f9bd84871050a6b00dad3">CcdPhysicsController::GetReplica</a>()
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290     <span class="comment">// This is used only to replicate Near and Radar sensor controllers</span>
<a name="l01291"></a>01291     <span class="comment">// The replication of object physics controller is done in KX_BulletPhysicsController::GetReplica()</span>
<a name="l01292"></a>01292     <a class="code" href="../../da/d62/structCcdConstructionInfo.html">CcdConstructionInfo</a> cinfo = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>;
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>)
<a name="l01294"></a>01294     {
<a name="l01295"></a>01295         <span class="comment">// This situation does not normally happen</span>
<a name="l01296"></a>01296         cinfo.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9d1ba0bb87f77e9ef4529c494faacada">CreateBulletShape</a>(<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a1ea6b1df1de1bbcf8204ccd64bc2c397">m_margin</a>, <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#abf4c4109803d3e4a825678aa88f594b9">m_bGimpact</a>, !<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a148b92ad6edef17fd11afdd9c1bba8df">m_cci</a>.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a36e3a83bcf2c43873e18e7cf37ad0cfb">m_bSoft</a>);
<a name="l01297"></a>01297     } 
<a name="l01298"></a>01298     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>)
<a name="l01299"></a>01299     {
<a name="l01300"></a>01300         <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a10edfe88febe43b3282f05c24bfa026e">getShapeType</a>())
<a name="l01301"></a>01301         {
<a name="l01302"></a>01302         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5eaa16f67e315a603f3a3e4ad7a70a570d9">SPHERE_SHAPE_PROXYTYPE</a>:
<a name="l01303"></a>01303             {
<a name="l01304"></a>01304                 btSphereShape* orgShape = (btSphereShape*)<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>;
<a name="l01305"></a>01305                 cinfo.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a> = <span class="keyword">new</span> btSphereShape(*orgShape);
<a name="l01306"></a>01306                 <span class="keywordflow">break</span>;
<a name="l01307"></a>01307             }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         <span class="keywordflow">case</span> <a class="code" href="../../d2/d3d/btBroadphaseProxy_8h.html#a629e290d766e52966199b687a537ba5eac237f7e1140ce7cc7a5fa3c81aeac361">CONE_SHAPE_PROXYTYPE</a>:
<a name="l01310"></a>01310             {
<a name="l01311"></a>01311                 <a class="code" href="../../d1/d5e/classbtConeShape.html" title="The btConeShape implements a cone shape primitive, centered around the origin and aligned with the Y ...">btConeShape</a>* orgShape = (<a class="code" href="../../d1/d5e/classbtConeShape.html" title="The btConeShape implements a cone shape primitive, centered around the origin and aligned with the Y ...">btConeShape</a>*)<a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a546973d84d41c3267881e792c9be7277">m_collisionShape</a>;
<a name="l01312"></a>01312                 cinfo.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#aaf65bb11c7165027cafe233dd66d414c">m_collisionShape</a> = <span class="keyword">new</span> <a class="code" href="../../d1/d5e/classbtConeShape.html" title="The btConeShape implements a cone shape primitive, centered around the origin and aligned with the Y ...">btConeShape</a>(*orgShape);
<a name="l01313"></a>01313                 <span class="keywordflow">break</span>;
<a name="l01314"></a>01314             }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316         <span class="keywordflow">default</span>:
<a name="l01317"></a>01317             {
<a name="l01318"></a>01318                 <span class="keywordflow">return</span> 0;
<a name="l01319"></a>01319             }
<a name="l01320"></a>01320         }
<a name="l01321"></a>01321     }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     cinfo.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#ae781f7f6c86bc82e40c8dabbf453648e">m_MotionState</a> = <span class="keyword">new</span> <a class="code" href="../../d2/d35/classDefaultMotionState.html" title="DefaultMotionState implements standard motionstate, using btTransform.">DefaultMotionState</a>();
<a name="l01324"></a>01324     cinfo.<a class="code" href="../../da/d62/structCcdConstructionInfo.html#a39566e54911c4db6515a25216795e00d">m_shapeInfo</a> = <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#af8979a1387e5c6e5566cd5fbf6109987">m_shapeInfo</a>;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <a class="code" href="../../d2/d9d/classCcdPhysicsController.html" title="CcdPhysicsController is a physics object that supports continuous collision detection and time of imp...">CcdPhysicsController</a>* replica = <span class="keyword">new</span> <a class="code" href="../../d2/d9d/classCcdPhysicsController.html#a49c218e55fac6eefb4fb7e724d532c9f">CcdPhysicsController</a>(cinfo);
<a name="l01327"></a>01327     <span class="keywordflow">return</span> replica;
<a name="l01328"></a>01328 }
<a name="l01329"></a>01329 
<a name="l01334"></a>01334 
<a name="l01335"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#ace48ebb23b99ae9687fa469c15e4f41c">01335</a> <a class="code" href="../../d2/d35/classDefaultMotionState.html#ace48ebb23b99ae9687fa469c15e4f41c">DefaultMotionState::DefaultMotionState</a>()
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#ac95a4f502585b3c896001eb236293ce5" title="Set this transformation to the identity.">setIdentity</a>();
<a name="l01338"></a>01338     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ac66267e6f54812329350ce822a4606d2">m_localScaling</a>.setValue(1.f,1.f,1.f);
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 
<a name="l01342"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a32d5252e39f5cd6692ffa206ecc0cba5">01342</a> <a class="code" href="../../d2/d35/classDefaultMotionState.html#a32d5252e39f5cd6692ffa206ecc0cba5">DefaultMotionState::~DefaultMotionState</a>()
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 }
<a name="l01346"></a>01346 
<a name="l01347"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#aa15059cf175d788954c7a1f653019474">01347</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#aa15059cf175d788954c7a1f653019474">DefaultMotionState::getWorldPosition</a>(<span class="keywordtype">float</span>&amp; posX,<span class="keywordtype">float</span>&amp; posY,<span class="keywordtype">float</span>&amp; posZ)
<a name="l01348"></a>01348 {
<a name="l01349"></a>01349     posX = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().x();
<a name="l01350"></a>01350     posY = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().y();
<a name="l01351"></a>01351     posZ = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a1fbf71080d75e64ef8cb5130e2bef196" title="Return the origin vector translation.">getOrigin</a>().z();
<a name="l01352"></a>01352 }
<a name="l01353"></a>01353 
<a name="l01354"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a7458a0ad41eed8263f04b7490575e26a">01354</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a7458a0ad41eed8263f04b7490575e26a">DefaultMotionState::getWorldScaling</a>(<span class="keywordtype">float</span>&amp; scaleX,<span class="keywordtype">float</span>&amp; scaleY,<span class="keywordtype">float</span>&amp; scaleZ)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356     scaleX = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ac66267e6f54812329350ce822a4606d2">m_localScaling</a>.getX();
<a name="l01357"></a>01357     scaleY = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ac66267e6f54812329350ce822a4606d2">m_localScaling</a>.getY();
<a name="l01358"></a>01358     scaleZ = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ac66267e6f54812329350ce822a4606d2">m_localScaling</a>.getZ();
<a name="l01359"></a>01359 }
<a name="l01360"></a>01360 
<a name="l01361"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a45ef28d6827034c2267ebacfbcf623f4">01361</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a45ef28d6827034c2267ebacfbcf623f4">DefaultMotionState::getWorldOrientation</a>(<span class="keywordtype">float</span>&amp; quatIma0,<span class="keywordtype">float</span>&amp; quatIma1,<span class="keywordtype">float</span>&amp; quatIma2,<span class="keywordtype">float</span>&amp; quatReal)
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> quat = <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a0000b60c68876844b43fc298507b7520" title="Return a quaternion representing the rotation.">getRotation</a>();
<a name="l01364"></a>01364     quatIma0 = quat.x();
<a name="l01365"></a>01365     quatIma1 = quat.y();
<a name="l01366"></a>01366     quatIma2 = quat.z();
<a name="l01367"></a>01367     quatReal = quat[3];
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369         
<a name="l01370"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a15814b0fcb58eeaf8a39aa9b9662ac28">01370</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a45ef28d6827034c2267ebacfbcf623f4">DefaultMotionState::getWorldOrientation</a>(<span class="keywordtype">float</span>* ori)
<a name="l01371"></a>01371 {
<a name="l01372"></a>01372     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a632444211b224e2bc0cc6aeef8101084" title="Fill the rotational part of an OpenGL matrix and clear the shear/perspective.">getOpenGLSubMatrix</a>(ori);
<a name="l01373"></a>01373 }
<a name="l01374"></a>01374 
<a name="l01375"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a338ed0963f023dea1dc8f6f4cd2f7f00">01375</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a7567dc851929c28702cafa930c1b6d13">DefaultMotionState::setWorldOrientation</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* ori)
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a7fc96ecb7fe7794b6bcd56136bc51053" title="Return the basis matrix for the rotation.">getBasis</a>().<a class="code" href="../../d1/d7d/classbtMatrix3x3.html#a2135b57e51831fd0112299c6e1348beb" title="Set from the rotational part of a 4x4 OpenGL matrix.">setFromOpenGLSubMatrix</a>(ori);
<a name="l01378"></a>01378 }
<a name="l01379"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a8aa056cb590ff60bc92a74c44c304441">01379</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a8aa056cb590ff60bc92a74c44c304441">DefaultMotionState::setWorldPosition</a>(<span class="keywordtype">float</span> posX,<span class="keywordtype">float</span> posY,<span class="keywordtype">float</span> posZ)
<a name="l01380"></a>01380 {
<a name="l01381"></a>01381     btVector3 pos(posX,posY,posZ);
<a name="l01382"></a>01382     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a10d173bd239e576c57d0ad5568303c03" title="Set the translational element.">setOrigin</a>( pos );
<a name="l01383"></a>01383 }
<a name="l01384"></a>01384 
<a name="l01385"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a7567dc851929c28702cafa930c1b6d13">01385</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a7567dc851929c28702cafa930c1b6d13">DefaultMotionState::setWorldOrientation</a>(<span class="keywordtype">float</span> quatIma0,<span class="keywordtype">float</span> quatIma1,<span class="keywordtype">float</span> quatIma2,<span class="keywordtype">float</span> quatReal)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387     <a class="code" href="../../d2/d33/classbtQuaternion.html" title="The btQuaternion implements quaternion to perform linear algebra rotations in combination with btMatr...">btQuaternion</a> orn(quatIma0,quatIma1,quatIma2,quatReal);
<a name="l01388"></a>01388     <a class="code" href="../../d2/d35/classDefaultMotionState.html#ae6318b5fa9b33e34777a69e099fa6aea">m_worldTransform</a>.<a class="code" href="../../d4/d79/classbtTransform.html#a5d012bc1b697ba1ff775f0b3b7ab6e3b" title="Set the rotational element by btQuaternion.">setRotation</a>( orn );
<a name="l01389"></a>01389 }
<a name="l01390"></a>01390         
<a name="l01391"></a><a class="code" href="../../d2/d35/classDefaultMotionState.html#a28cd1c58b38b6af94a75a2ce2d3de479">01391</a> <span class="keywordtype">void</span>    <a class="code" href="../../d2/d35/classDefaultMotionState.html#a28cd1c58b38b6af94a75a2ce2d3de479">DefaultMotionState::calculateWorldTransformations</a>()
<a name="l01392"></a>01392 {
<a name="l01393"></a>01393 
<a name="l01394"></a>01394 }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396 <span class="comment">// Shape constructor</span>
<a name="l01397"></a>01397 std::map&lt;RAS_MeshObject*, CcdShapeConstructionInfo*&gt; <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">CcdShapeConstructionInfo::m_meshShapeMap</a>;
<a name="l01398"></a>01398 
<a name="l01399"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a0d6ce0acf0b0ecee7c8b3a8ff8ba78ad">01399</a> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html">CcdShapeConstructionInfo</a>* <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a0d6ce0acf0b0ecee7c8b3a8ff8ba78ad">CcdShapeConstructionInfo::FindMesh</a>(<a class="code" href="../../d5/d85/classRAS__MeshObject.html">RAS_MeshObject</a>* mesh, <span class="keyword">struct</span> <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>* dm, <span class="keywordtype">bool</span> polytope)
<a name="l01400"></a>01400 {
<a name="l01401"></a>01401     <span class="keywordflow">if</span> (polytope || dm)
<a name="l01402"></a>01402         <span class="comment">// not yet supported</span>
<a name="l01403"></a>01403         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     std::map&lt;RAS_MeshObject*,CcdShapeConstructionInfo*&gt;::const_iterator mit = <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.find(mesh);
<a name="l01406"></a>01406     <span class="keywordflow">if</span> (mit != <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.end())
<a name="l01407"></a>01407         <span class="keywordflow">return</span> mit-&gt;second;
<a name="l01408"></a>01408     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01409"></a>01409 }
<a name="l01410"></a>01410 
<a name="l01411"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab991d8adf0b5e91af719869623ae2bea">01411</a> <span class="keywordtype">bool</span> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab991d8adf0b5e91af719869623ae2bea">CcdShapeConstructionInfo::SetMesh</a>(<a class="code" href="../../d5/d85/classRAS__MeshObject.html">RAS_MeshObject</a>* meshobj, <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>* dm, <span class="keywordtype">bool</span> polytope)
<a name="l01412"></a>01412 {
<a name="l01413"></a>01413     <span class="keywordtype">int</span> numpolys, numverts;
<a name="l01414"></a>01414 
<a name="l01415"></a>01415     <span class="comment">// assume no shape information</span>
<a name="l01416"></a>01416     <span class="comment">// no support for dynamic change of shape yet</span>
<a name="l01417"></a>01417     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a61820426adb3d99aef1da28575e9b371">IsUnused</a>());
<a name="l01418"></a>01418     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> = <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaafb22c75fa89becb165e9d89de3620975">PHY_SHAPE_NONE</a>;
<a name="l01419"></a>01419     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a44af26cca43eceacef9a8ce94a6e58d7">m_meshObject</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01420"></a>01420     <span class="keywordtype">bool</span> free_dm = <span class="keyword">false</span>;
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="comment">// No mesh object or mesh has no polys</span>
<a name="l01423"></a>01423     <span class="keywordflow">if</span> (!meshobj || meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a670343516156cfac1cdb1c9458ec7b09">HasColliderPolygon</a>()==<span class="keyword">false</span>) {
<a name="l01424"></a>01424         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a12123db01dda7758f0df5e3bba10cc0a" title="clear the array, deallocated memory. Generally it is better to use array.resize(0), to reduce performance overhead of run-time memory (de)allocations.">clear</a>();
<a name="l01425"></a>01425         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.clear();
<a name="l01426"></a>01426         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.clear();
<a name="l01427"></a>01427         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>.clear();
<a name="l01428"></a>01428         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01429"></a>01429     }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431     <span class="keywordflow">if</span> (!dm) {
<a name="l01432"></a>01432         free_dm = <span class="keyword">true</span>;
<a name="l01433"></a>01433         dm = <a class="code" href="../../dd/d15/BKE__cdderivedmesh_8h.html#acf07490dbc6e250966bbfb63d34e7ada">CDDM_from_mesh</a>(meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a3f873a70dc7521e2e67ef719ca3f22dc">GetMesh</a>(), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01434"></a>01434         <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#afed7604eb89f555bfcad4c3ccd1e5a35">DM_ensure_tessface</a>(dm);
<a name="l01435"></a>01435     }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01438"></a>01438     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01439"></a>01439     numpolys = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01440"></a>01440     numverts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01441"></a>01441     <span class="keywordtype">int</span>* index = (<span class="keywordtype">int</span>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01442"></a>01442     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface = (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01443"></a>01443 
<a name="l01444"></a>01444     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> = (polytope) ? <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa3437b38c19c57f67a79dd4f7282b36fb">PHY_SHAPE_POLYTOPE</a> : <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaab87e2dce120244386e70501968c1329b">PHY_SHAPE_MESH</a>;
<a name="l01445"></a>01445 
<a name="l01446"></a>01446     <span class="comment">/* Convert blender geometry into bullet mesh, need these vars for mapping */</span>
<a name="l01447"></a>01447     vector&lt;bool&gt; vert_tag_array(numverts, <span class="keyword">false</span>);
<a name="l01448"></a>01448     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot_bt_verts= 0;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     <span class="keywordflow">if</span> (polytope)
<a name="l01451"></a>01451     {
<a name="l01452"></a>01452         <span class="comment">// Tag verts we&#39;re using</span>
<a name="l01453"></a>01453         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2=0; p2&lt;numpolys; p2++)
<a name="l01454"></a>01454         {
<a name="l01455"></a>01455             <a class="code" href="../../d6/da0/structMFace.html">MFace</a>* mf = &amp;mface[p2];
<a name="l01456"></a>01456             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly = meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>((index)? index[p2]: p2);
<a name="l01457"></a>01457 
<a name="l01458"></a>01458             <span class="comment">// only add polygons that have the collision flag set</span>
<a name="l01459"></a>01459             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01460"></a>01460             {
<a name="l01461"></a>01461                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]==<span class="keyword">false</span>) {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= <span class="keyword">true</span>;tot_bt_verts++;}
<a name="l01462"></a>01462                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]==<span class="keyword">false</span>) {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= <span class="keyword">true</span>;tot_bt_verts++;}
<a name="l01463"></a>01463                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]==<span class="keyword">false</span>) {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= <span class="keyword">true</span>;tot_bt_verts++;}
<a name="l01464"></a>01464                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]==<span class="keyword">false</span>) {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= <span class="keyword">true</span>;tot_bt_verts++;}
<a name="l01465"></a>01465             }
<a name="l01466"></a>01466         }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(tot_bt_verts*3);
<a name="l01469"></a>01469 
<a name="l01470"></a>01470         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0];
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2=0; p2&lt;numpolys; p2++)
<a name="l01473"></a>01473         {
<a name="l01474"></a>01474             <a class="code" href="../../d6/da0/structMFace.html">MFace</a>* mf = &amp;mface[p2];
<a name="l01475"></a>01475             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>((index)? index[p2]: p2);
<a name="l01476"></a>01476 
<a name="l01477"></a>01477             <span class="comment">// only add polygons that have the collisionflag set</span>
<a name="l01478"></a>01478             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01479"></a>01479             {
<a name="l01480"></a>01480                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]==<span class="keyword">true</span>)
<a name="l01481"></a>01481                 {
<a name="l01482"></a>01482                     <span class="keyword">const</span> <span class="keywordtype">float</span>* vtx = mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01483"></a>01483                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= <span class="keyword">false</span>;
<a name="l01484"></a>01484                     *bt++ = vtx[0];
<a name="l01485"></a>01485                     *bt++ = vtx[1];
<a name="l01486"></a>01486                     *bt++ = vtx[2];
<a name="l01487"></a>01487                 }
<a name="l01488"></a>01488                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]==<span class="keyword">true</span>)
<a name="l01489"></a>01489                 {
<a name="l01490"></a>01490                     <span class="keyword">const</span> <span class="keywordtype">float</span>* vtx = mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01491"></a>01491                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= <span class="keyword">false</span>;
<a name="l01492"></a>01492                     *bt++ = vtx[0];
<a name="l01493"></a>01493                     *bt++ = vtx[1];
<a name="l01494"></a>01494                     *bt++ = vtx[2];
<a name="l01495"></a>01495                 }
<a name="l01496"></a>01496                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]==<span class="keyword">true</span>)
<a name="l01497"></a>01497                 {
<a name="l01498"></a>01498                     <span class="keyword">const</span> <span class="keywordtype">float</span>* vtx = mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01499"></a>01499                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= <span class="keyword">false</span>;
<a name="l01500"></a>01500                     *bt++ = vtx[0];
<a name="l01501"></a>01501                     *bt++ = vtx[1];
<a name="l01502"></a>01502                     *bt++ = vtx[2];
<a name="l01503"></a>01503                 }
<a name="l01504"></a>01504                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]==<span class="keyword">true</span>)
<a name="l01505"></a>01505                 {
<a name="l01506"></a>01506                     <span class="keyword">const</span> <span class="keywordtype">float</span>* vtx = mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>].<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>;
<a name="l01507"></a>01507                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= <span class="keyword">false</span>;
<a name="l01508"></a>01508                     *bt++ = vtx[0];
<a name="l01509"></a>01509                     *bt++ = vtx[1];
<a name="l01510"></a>01510                     *bt++ = vtx[2];
<a name="l01511"></a>01511                 }
<a name="l01512"></a>01512             }
<a name="l01513"></a>01513         }
<a name="l01514"></a>01514     }
<a name="l01515"></a>01515     <span class="keywordflow">else</span> {
<a name="l01516"></a>01516         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot_bt_tris= 0;
<a name="l01517"></a>01517         vector&lt;int&gt; vert_remap_array(numverts, 0);
<a name="l01518"></a>01518         
<a name="l01519"></a>01519         <span class="comment">// Tag verts we&#39;re using</span>
<a name="l01520"></a>01520         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2=0; p2&lt;numpolys; p2++)
<a name="l01521"></a>01521         {
<a name="l01522"></a>01522             <a class="code" href="../../d6/da0/structMFace.html">MFace</a>* mf = &amp;mface[p2];
<a name="l01523"></a>01523             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>((index)? index[p2]: p2);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525             <span class="comment">// only add polygons that have the collision flag set</span>
<a name="l01526"></a>01526             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01527"></a>01527             {
<a name="l01528"></a>01528                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]==<span class="keyword">false</span>)
<a name="l01529"></a>01529                     {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= <span class="keyword">true</span>;vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= tot_bt_verts;tot_bt_verts++;}
<a name="l01530"></a>01530                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]==<span class="keyword">false</span>)
<a name="l01531"></a>01531                     {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= <span class="keyword">true</span>;vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= tot_bt_verts;tot_bt_verts++;}
<a name="l01532"></a>01532                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]==<span class="keyword">false</span>)
<a name="l01533"></a>01533                     {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= <span class="keyword">true</span>;vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= tot_bt_verts;tot_bt_verts++;}
<a name="l01534"></a>01534                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]==<span class="keyword">false</span>)
<a name="l01535"></a>01535                     {vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= <span class="keyword">true</span>;vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= tot_bt_verts;tot_bt_verts++;}
<a name="l01536"></a>01536                 tot_bt_tris += (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 2:1); <span class="comment">/* a quad or a tri */</span>
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538         }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(tot_bt_verts*3);
<a name="l01541"></a>01541         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.resize(tot_bt_tris);
<a name="l01542"></a>01542         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.resize(tot_bt_tris*3);
<a name="l01543"></a>01543         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0];
<a name="l01544"></a>01544         <span class="keywordtype">int</span> *poly_index_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>[0];
<a name="l01545"></a>01545         <span class="keywordtype">int</span> *tri_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0];
<a name="l01546"></a>01546 
<a name="l01547"></a>01547         <a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html">UVco</a> *uv_pt = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01548"></a>01548         <span class="keywordflow">if</span> (tface)
<a name="l01549"></a>01549         {
<a name="l01550"></a>01550             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>.resize(tot_bt_tris*3);
<a name="l01551"></a>01551             uv_pt = &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>[0];
<a name="l01552"></a>01552         } 
<a name="l01553"></a>01553         <span class="keywordflow">else</span> 
<a name="l01554"></a>01554             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>.clear();
<a name="l01555"></a>01555 
<a name="l01556"></a>01556         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2=0; p2&lt;numpolys; p2++)
<a name="l01557"></a>01557         {
<a name="l01558"></a>01558             <a class="code" href="../../d6/da0/structMFace.html">MFace</a>* mf = &amp;mface[p2];
<a name="l01559"></a>01559             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>* tf = (tface) ? &amp;tface[p2] : <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01560"></a>01560             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>((index)? index[p2]: p2);
<a name="l01561"></a>01561 
<a name="l01562"></a>01562             <span class="comment">// only add polygons that have the collisionflag set</span>
<a name="l01563"></a>01563             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01564"></a>01564             {
<a name="l01565"></a>01565                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v1= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l01566"></a>01566                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v2= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l01567"></a>01567                 <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v3= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l01568"></a>01568 
<a name="l01569"></a>01569                 <span class="comment">// the face indices</span>
<a name="l01570"></a>01570                 tri_pt[0]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l01571"></a>01571                 tri_pt[1]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>];
<a name="l01572"></a>01572                 tri_pt[2]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l01573"></a>01573                 tri_pt= tri_pt+3;
<a name="l01574"></a>01574                 <span class="keywordflow">if</span> (tf)
<a name="l01575"></a>01575                 {
<a name="l01576"></a>01576                     uv_pt[0].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0];
<a name="l01577"></a>01577                     uv_pt[0].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1];
<a name="l01578"></a>01578                     uv_pt[1].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][0];
<a name="l01579"></a>01579                     uv_pt[1].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[1][1];
<a name="l01580"></a>01580                     uv_pt[2].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0];
<a name="l01581"></a>01581                     uv_pt[2].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1];
<a name="l01582"></a>01582                     uv_pt += 3;
<a name="l01583"></a>01583                 }
<a name="l01584"></a>01584 
<a name="l01585"></a>01585                 <span class="comment">// m_polygonIndexArray</span>
<a name="l01586"></a>01586                 *poly_index_pt= (index)? index[p2]: p2;
<a name="l01587"></a>01587                 poly_index_pt++;
<a name="l01588"></a>01588 
<a name="l01589"></a>01589                 <span class="comment">// the vertex location</span>
<a name="l01590"></a>01590                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]==<span class="keyword">true</span>) { <span class="comment">/* *** v1 *** */</span>
<a name="l01591"></a>01591                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>]= <span class="keyword">false</span>;
<a name="l01592"></a>01592                     *bt++ = v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l01593"></a>01593                     *bt++ = v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l01594"></a>01594                     *bt++ = v1-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01595"></a>01595                 }
<a name="l01596"></a>01596                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]==<span class="keyword">true</span>) { <span class="comment">/* *** v2 *** */</span>
<a name="l01597"></a>01597                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>]= <span class="keyword">false</span>;
<a name="l01598"></a>01598                     *bt++ = v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l01599"></a>01599                     *bt++ = v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l01600"></a>01600                     *bt++ = v2-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01601"></a>01601                 }
<a name="l01602"></a>01602                 <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]==<span class="keyword">true</span>) { <span class="comment">/* *** v3 *** */</span>
<a name="l01603"></a>01603                     vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>]= <span class="keyword">false</span>;
<a name="l01604"></a>01604                     *bt++ = v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];  
<a name="l01605"></a>01605                     *bt++ = v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l01606"></a>01606                     *bt++ = v3-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01607"></a>01607                 }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l01610"></a>01610                 {
<a name="l01611"></a>01611                     <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *v4= &amp;mvert[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l01612"></a>01612 
<a name="l01613"></a>01613                     tri_pt[0]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>];
<a name="l01614"></a>01614                     tri_pt[1]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>];
<a name="l01615"></a>01615                     tri_pt[2]= vert_remap_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>];
<a name="l01616"></a>01616                     tri_pt= tri_pt+3;
<a name="l01617"></a>01617                     <span class="keywordflow">if</span> (tf)
<a name="l01618"></a>01618                     {
<a name="l01619"></a>01619                         uv_pt[0].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][0];
<a name="l01620"></a>01620                         uv_pt[0].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[0][1];
<a name="l01621"></a>01621                         uv_pt[1].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][0];
<a name="l01622"></a>01622                         uv_pt[1].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[2][1];
<a name="l01623"></a>01623                         uv_pt[2].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][0];
<a name="l01624"></a>01624                         uv_pt[2].<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a8008df692b4527be183b85665cdde582">uv</a>[3][1];
<a name="l01625"></a>01625                         uv_pt += 3;
<a name="l01626"></a>01626                     }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628                     <span class="comment">// m_polygonIndexArray</span>
<a name="l01629"></a>01629                     *poly_index_pt= (index)? index[p2]: p2;
<a name="l01630"></a>01630                     poly_index_pt++;
<a name="l01631"></a>01631 
<a name="l01632"></a>01632                     <span class="comment">// the vertex location</span>
<a name="l01633"></a>01633                     <span class="keywordflow">if</span> (vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]==<span class="keyword">true</span>) { <span class="comment">/* *** v4 *** */</span>
<a name="l01634"></a>01634                         vert_tag_array[mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>]= <span class="keyword">false</span>;
<a name="l01635"></a>01635                         *bt++ = v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l01636"></a>01636                         *bt++ = v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];  
<a name="l01637"></a>01637                         *bt++ = v4-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01638"></a>01638                     }
<a name="l01639"></a>01639                 }
<a name="l01640"></a>01640             }
<a name="l01641"></a>01641         }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643 
<a name="l01644"></a>01644         <span class="comment">/* If this ever gets confusing, print out an OBJ file for debugging */</span>
<a name="l01645"></a>01645 <span class="preprocessor">#if 0</span>
<a name="l01646"></a>01646 <span class="preprocessor"></span>        printf(<span class="stringliteral">&quot;# vert count %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>());
<a name="l01647"></a>01647         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>(); i+=1) {
<a name="l01648"></a>01648             printf(<span class="stringliteral">&quot;v %.6f %.6f %.6f\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i].x(), <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i].y(), <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i].z());
<a name="l01649"></a>01649         }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651         printf(<span class="stringliteral">&quot;# face count %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.size());
<a name="l01652"></a>01652         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.size(); i+=3) {
<a name="l01653"></a>01653             printf(<span class="stringliteral">&quot;f %d %d %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i]+1, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i+1]+1, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i+2]+1);
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655 <span class="preprocessor">#endif</span>
<a name="l01656"></a>01656 <span class="preprocessor"></span>
<a name="l01657"></a>01657     }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659 <span class="preprocessor">#if 0</span>
<a name="l01660"></a>01660 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (validpolys==<span class="keyword">false</span>)
<a name="l01661"></a>01661     {
<a name="l01662"></a>01662         <span class="comment">// should not happen</span>
<a name="l01663"></a>01663         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> = <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaafb22c75fa89becb165e9d89de3620975">PHY_SHAPE_NONE</a>;
<a name="l01664"></a>01664         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01665"></a>01665     }
<a name="l01666"></a>01666 <span class="preprocessor">#endif</span>
<a name="l01667"></a>01667 <span class="preprocessor"></span>    
<a name="l01668"></a>01668     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a44af26cca43eceacef9a8ce94a6e58d7">m_meshObject</a> = meshobj;
<a name="l01669"></a>01669     <span class="keywordflow">if</span> (free_dm) {
<a name="l01670"></a>01670         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01671"></a>01671         dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <span class="comment">// sharing only on static mesh at present, if you change that, you must also change in FindMesh</span>
<a name="l01675"></a>01675     <span class="keywordflow">if</span> (!polytope &amp;&amp; !dm)
<a name="l01676"></a>01676     {
<a name="l01677"></a>01677         <span class="comment">// triangle shape can be shared, store the mesh object in the map</span>
<a name="l01678"></a>01678         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.insert(std::pair&lt;RAS_MeshObject*,CcdShapeConstructionInfo*&gt;(meshobj,<span class="keyword">this</span>));
<a name="l01679"></a>01679     }
<a name="l01680"></a>01680     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01681"></a>01681 }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l01684"></a>01684 
<a name="l01685"></a>01685 <span class="comment">/* Updates the arrays used by CreateBulletShape(),</span>
<a name="l01686"></a>01686 <span class="comment"> * take care that recalcLocalAabb() runs after CreateBulletShape is called.</span>
<a name="l01687"></a>01687 <span class="comment"> * */</span>
<a name="l01688"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a1c5716e3a94929a75b95868fd12aec0e">01688</a> <span class="keywordtype">bool</span> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a1c5716e3a94929a75b95868fd12aec0e">CcdShapeConstructionInfo::UpdateMesh</a>(<span class="keyword">class</span> <a class="code" href="../../d1/d73/classKX__GameObject.html">KX_GameObject</a>* gameobj, <span class="keyword">class</span> <a class="code" href="../../d5/d85/classRAS__MeshObject.html">RAS_MeshObject</a>* meshobj)
<a name="l01689"></a>01689 {
<a name="l01690"></a>01690     <span class="keywordtype">int</span> numpolys;
<a name="l01691"></a>01691     <span class="keywordtype">int</span> numverts;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot_bt_tris= 0;
<a name="l01694"></a>01694     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot_bt_verts= 0;
<a name="l01695"></a>01695 
<a name="l01696"></a>01696     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01697"></a>01697     <span class="keywordtype">int</span> v_orig;
<a name="l01698"></a>01698 
<a name="l01699"></a>01699     <span class="comment">/* Use for looping over verts in a face as a try or 2 tris */</span>
<a name="l01700"></a>01700     <span class="keyword">const</span> <span class="keywordtype">int</span> quad_verts[7]=    {0,1,2,      0,2,3,     -1};
<a name="l01701"></a>01701     <span class="keyword">const</span> <span class="keywordtype">int</span> tri_verts[4]= {0,1,2,     -1};
<a name="l01702"></a>01702     <span class="keyword">const</span> <span class="keywordtype">int</span> *fv_pt;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704     <span class="keywordflow">if</span> (gameobj==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; meshobj==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01705"></a>01705         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01706"></a>01706     
<a name="l01707"></a>01707     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> != <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaab87e2dce120244386e70501968c1329b">PHY_SHAPE_MESH</a>)
<a name="l01708"></a>01708         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01709"></a>01709 
<a name="l01710"></a>01710     <a class="code" href="../../d7/dc3/classRAS__Deformer.html">RAS_Deformer</a> *deformer= gameobj ? gameobj-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#abb4098bf9868e54fc875379eb10009f7">GetDeformer</a>():<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01711"></a>01711     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a>* dm = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <span class="keywordflow">if</span> (deformer)
<a name="l01714"></a>01714         dm = deformer-&gt;<a class="code" href="../../d7/dc3/classRAS__Deformer.html#a0f9c443343b214bd2812b7e37470c78c">GetPhysicsMesh</a>();
<a name="l01715"></a>01715     
<a name="l01716"></a>01716     <span class="comment">/* get the mesh from the object if not defined */</span>
<a name="l01717"></a>01717     <span class="keywordflow">if</span> (meshobj==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01718"></a>01718         
<a name="l01719"></a>01719         <span class="comment">/* modifier mesh */</span>
<a name="l01720"></a>01720         <span class="keywordflow">if</span> (dm)
<a name="l01721"></a>01721             meshobj= deformer-&gt;<a class="code" href="../../d7/dc3/classRAS__Deformer.html#a3b5e3cb3bd2e546bb03af26bd27ed693">GetRasMesh</a>();
<a name="l01722"></a>01722         
<a name="l01723"></a>01723         <span class="comment">/* game object first mesh */</span>
<a name="l01724"></a>01724         <span class="keywordflow">if</span> (meshobj==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01725"></a>01725             <span class="keywordflow">if</span> (gameobj-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#a0380469d233ad08592b6a49819db066d">GetMeshCount</a>() &gt; 0) {
<a name="l01726"></a>01726                 meshobj= gameobj-&gt;<a class="code" href="../../d1/d73/classKX__GameObject.html#a0a71e1e10264a686d4bce3ec2733fe86">GetMesh</a>(0);
<a name="l01727"></a>01727             }
<a name="l01728"></a>01728         }
<a name="l01729"></a>01729     }
<a name="l01730"></a>01730     
<a name="l01731"></a>01731     <span class="keywordflow">if</span> (dm &amp;&amp; deformer-&gt;<a class="code" href="../../d7/dc3/classRAS__Deformer.html#a3b5e3cb3bd2e546bb03af26bd27ed693">GetRasMesh</a>() == meshobj)
<a name="l01732"></a>01732     {   <span class="comment">/*</span>
<a name="l01733"></a>01733 <span class="comment">         * Derived Mesh Update</span>
<a name="l01734"></a>01734 <span class="comment">         *</span>
<a name="l01735"></a>01735 <span class="comment">         * */</span>
<a name="l01736"></a>01736 
<a name="l01737"></a>01737         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mvert = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#adf25b9f9aee2bb3846fe2d0c4a2ab1d4">getVertArray</a>(dm);
<a name="l01738"></a>01738         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#aebdc3d5680e822d40c479530c23a56a1">getTessFaceArray</a>(dm);
<a name="l01739"></a>01739         numpolys = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3481fefe300b7d6b456071320be70c56">getNumTessFaces</a>(dm);
<a name="l01740"></a>01740         numverts = dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a3d5c5a506b0705a9071680807da2e7ee">getNumVerts</a>(dm);
<a name="l01741"></a>01741         <span class="keywordtype">int</span>* index = (<span class="keywordtype">int</span>*)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a5e2cdbe47f447a68d43a9410d8c42100">CD_ORIGINDEX</a>);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743         <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l01744"></a>01744         <a class="code" href="../../d8/de5/structMVert.html">MVert</a> *mv;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746         <span class="keywordtype">int</span> flen;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6474531880fa81739ccdb10fdffd1866">CustomData_has_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>))
<a name="l01749"></a>01749         {
<a name="l01750"></a>01750             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface = (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *)dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#ab62c496219df5c1429b6cb0ec051bfac">getTessFaceDataArray</a>(dm, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>);
<a name="l01751"></a>01751             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tf;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753             vector&lt;bool&gt; vert_tag_array(numverts, <span class="keyword">false</span>);
<a name="l01754"></a>01754             vector&lt;int&gt; vert_remap_array(numverts, 0);
<a name="l01755"></a>01755 
<a name="l01756"></a>01756             <span class="keywordflow">for</span> (mf= mface, tf= tface, i=0; i &lt; numpolys; mf++, tf++, i++) {
<a name="l01757"></a>01757                 <span class="keywordflow">if</span> (tf-&gt;mode &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6cfc000f74b41bf1072b95775a44c172">TF_DYNAMIC</a>)
<a name="l01758"></a>01758                 {
<a name="l01759"></a>01759                     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01760"></a>01760                         tot_bt_tris+= 2;
<a name="l01761"></a>01761                         flen= 4;
<a name="l01762"></a>01762                     } <span class="keywordflow">else</span> {
<a name="l01763"></a>01763                         tot_bt_tris++;
<a name="l01764"></a>01764                         flen= 3;
<a name="l01765"></a>01765                     }
<a name="l01766"></a>01766 
<a name="l01767"></a>01767                     <span class="keywordflow">for</span> (j=0; j&lt;flen; j++)
<a name="l01768"></a>01768                     {
<a name="l01769"></a>01769                         v_orig = (*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + j));
<a name="l01770"></a>01770 
<a name="l01771"></a>01771                         <span class="keywordflow">if</span> (vert_tag_array[v_orig]==<span class="keyword">false</span>)
<a name="l01772"></a>01772                         {
<a name="l01773"></a>01773                             vert_tag_array[v_orig]= <span class="keyword">true</span>;
<a name="l01774"></a>01774                             vert_remap_array[v_orig]= tot_bt_verts;
<a name="l01775"></a>01775                             tot_bt_verts++;
<a name="l01776"></a>01776                         }
<a name="l01777"></a>01777                     }
<a name="l01778"></a>01778                 }
<a name="l01779"></a>01779             }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(tot_bt_verts*3);
<a name="l01782"></a>01782             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0];
<a name="l01783"></a>01783 
<a name="l01784"></a>01784             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.resize(tot_bt_tris*3);
<a name="l01785"></a>01785             <span class="keywordtype">int</span> *tri_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0];
<a name="l01786"></a>01786 
<a name="l01787"></a>01787             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>.resize(tot_bt_tris*3);
<a name="l01788"></a>01788             <a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html">UVco</a> *uv_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>[0];
<a name="l01789"></a>01789 
<a name="l01790"></a>01790             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.resize(tot_bt_tris);
<a name="l01791"></a>01791             <span class="keywordtype">int</span> *poly_index_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>[0];
<a name="l01792"></a>01792 
<a name="l01793"></a>01793             <span class="keywordflow">for</span> (mf= mface, tf= tface, i=0; i &lt; numpolys; mf++, tf++, i++)
<a name="l01794"></a>01794             {
<a name="l01795"></a>01795                 <span class="keywordflow">if</span> (tf-&gt;mode &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a6cfc000f74b41bf1072b95775a44c172">TF_DYNAMIC</a>)
<a name="l01796"></a>01796                 {
<a name="l01797"></a>01797                     <span class="keywordtype">int</span> origi = (index)? index[i]: i;
<a name="l01798"></a>01798 
<a name="l01799"></a>01799                     <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01800"></a>01800                         fv_pt= quad_verts;
<a name="l01801"></a>01801                         *poly_index_pt++ = origi;
<a name="l01802"></a>01802                         *poly_index_pt++ = origi;
<a name="l01803"></a>01803                         flen= 4;
<a name="l01804"></a>01804                     } <span class="keywordflow">else</span> {
<a name="l01805"></a>01805                         fv_pt= tri_verts;
<a name="l01806"></a>01806                         *poly_index_pt++ = origi;
<a name="l01807"></a>01807                         flen= 3;
<a name="l01808"></a>01808                     }
<a name="l01809"></a>01809 
<a name="l01810"></a>01810                     <span class="keywordflow">for</span> (; *fv_pt &gt; -1; fv_pt++)
<a name="l01811"></a>01811                     {
<a name="l01812"></a>01812                         v_orig = (*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + (*fv_pt)));
<a name="l01813"></a>01813 
<a name="l01814"></a>01814                         <span class="keywordflow">if</span> (vert_tag_array[v_orig])
<a name="l01815"></a>01815                         {
<a name="l01816"></a>01816                             mv= mvert + v_orig;
<a name="l01817"></a>01817                             *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0];
<a name="l01818"></a>01818                             *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1];
<a name="l01819"></a>01819                             *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01820"></a>01820 
<a name="l01821"></a>01821                             vert_tag_array[v_orig]= <span class="keyword">false</span>;
<a name="l01822"></a>01822                         }
<a name="l01823"></a>01823                         *tri_pt++ = vert_remap_array[v_orig];
<a name="l01824"></a>01824                         uv_pt-&gt;<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[0] = tf-&gt;uv[*fv_pt][0];
<a name="l01825"></a>01825                         uv_pt-&gt;<a class="code" href="../../d6/d70/structCcdShapeConstructionInfo_1_1UVco.html#a85b4bd0cc5c6503ac3ca2e821fc8e8eb">uv</a>[1] = tf-&gt;uv[*fv_pt][1];
<a name="l01826"></a>01826                         uv_pt++;
<a name="l01827"></a>01827                     }
<a name="l01828"></a>01828                 }
<a name="l01829"></a>01829             }
<a name="l01830"></a>01830         }
<a name="l01831"></a>01831         <span class="keywordflow">else</span> {
<a name="l01832"></a>01832             <span class="comment">/* no need for a vertex mapping. simple/fast */</span>
<a name="l01833"></a>01833 
<a name="l01834"></a>01834             tot_bt_verts= numverts;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836             <span class="keywordflow">for</span> (mf= mface, i=0; i &lt; numpolys; mf++, i++) {
<a name="l01837"></a>01837                 tot_bt_tris += (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 2:1);
<a name="l01838"></a>01838             }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(tot_bt_verts*3);
<a name="l01841"></a>01841             <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0];
<a name="l01842"></a>01842 
<a name="l01843"></a>01843             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.resize(tot_bt_tris*3);
<a name="l01844"></a>01844             <span class="keywordtype">int</span> *tri_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0];
<a name="l01845"></a>01845 
<a name="l01846"></a>01846             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.resize(tot_bt_tris);
<a name="l01847"></a>01847             <span class="keywordtype">int</span> *poly_index_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>[0];
<a name="l01848"></a>01848 
<a name="l01849"></a>01849             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abb547dca07833351583b88f0fcf8462f">m_triFaceUVcoArray</a>.clear();
<a name="l01850"></a>01850 
<a name="l01851"></a>01851             <span class="keywordflow">for</span> (mv= mvert, i=0; i &lt; numverts; mv++, i++) {
<a name="l01852"></a>01852                 *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[0]; *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[1]; *bt++ = mv-&gt;<a class="code" href="../../d8/de5/structMVert.html#a7682e4afa4b2ff47a3e17a4a3f670f1f">co</a>[2];
<a name="l01853"></a>01853             }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855             <span class="keywordflow">for</span> (mf= mface, i=0; i &lt; numpolys; mf++, i++) {
<a name="l01856"></a>01856                 <span class="keywordtype">int</span> origi = (index)? index[i]: i;
<a name="l01857"></a>01857 
<a name="l01858"></a>01858                 <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l01859"></a>01859                     fv_pt= quad_verts;
<a name="l01860"></a>01860                     *poly_index_pt++ = origi;
<a name="l01861"></a>01861                     *poly_index_pt++ = origi;
<a name="l01862"></a>01862                 }
<a name="l01863"></a>01863                 <span class="keywordflow">else</span> {
<a name="l01864"></a>01864                     fv_pt= tri_verts;
<a name="l01865"></a>01865                     *poly_index_pt++ = origi;
<a name="l01866"></a>01866                 }
<a name="l01867"></a>01867 
<a name="l01868"></a>01868                 <span class="keywordflow">for</span> (; *fv_pt &gt; -1; fv_pt++)
<a name="l01869"></a>01869                     *tri_pt++ = (*(&amp;mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a> + (*fv_pt)));
<a name="l01870"></a>01870             }
<a name="l01871"></a>01871         }
<a name="l01872"></a>01872     }
<a name="l01873"></a>01873     <span class="keywordflow">else</span> {  <span class="comment">/*</span>
<a name="l01874"></a>01874 <span class="comment">             * RAS Mesh Update</span>
<a name="l01875"></a>01875 <span class="comment">             *</span>
<a name="l01876"></a>01876 <span class="comment">             * */</span>
<a name="l01877"></a>01877         
<a name="l01878"></a>01878         <span class="comment">/* Note!, gameobj can be NULL here */</span>
<a name="l01879"></a>01879 
<a name="l01880"></a>01880         <span class="comment">/* transverts are only used for deformed RAS_Meshes, the RAS_TexVert data</span>
<a name="l01881"></a>01881 <span class="comment">         * is too hard to get at, see below for details */</span>
<a name="l01882"></a>01882         float (*transverts)[3]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01883"></a>01883         <span class="keywordtype">int</span> transverts_tot= 0; <span class="comment">/* with deformed meshes - should always be greater then the max orginal index, or we get crashes */</span>
<a name="l01884"></a>01884 
<a name="l01885"></a>01885         <span class="keywordflow">if</span> (deformer) {
<a name="l01886"></a>01886             <span class="comment">/* map locations from the deformed array</span>
<a name="l01887"></a>01887 <span class="comment">             *</span>
<a name="l01888"></a>01888 <span class="comment">             * Could call deformer-&gt;Update(); but rely on redraw updating.</span>
<a name="l01889"></a>01889 <span class="comment">             * */</span>
<a name="l01890"></a>01890             transverts= deformer-&gt;<a class="code" href="../../d7/dc3/classRAS__Deformer.html#aa429fb30e44294bff82f378d46e76aa0">GetTransVerts</a>(&amp;transverts_tot);
<a name="l01891"></a>01891         }
<a name="l01892"></a>01892 
<a name="l01893"></a>01893         <span class="comment">// Tag verts we&#39;re using</span>
<a name="l01894"></a>01894         numpolys= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#afaeb47385d766ebce971b11476d97009">NumPolygons</a>();
<a name="l01895"></a>01895         numverts= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#aa67d74520a6ff0536efed2c360656312">m_sharedvertex_map</a>.size();
<a name="l01896"></a>01896         <span class="keyword">const</span> <span class="keywordtype">float</span> *xyz;
<a name="l01897"></a>01897 
<a name="l01898"></a>01898 
<a name="l01899"></a>01899         vector&lt;bool&gt; vert_tag_array(numverts, <span class="keyword">false</span>);
<a name="l01900"></a>01900         vector&lt;int&gt; vert_remap_array(numverts, 0);
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=0; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>&lt;numpolys; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>++)
<a name="l01903"></a>01903         {
<a name="l01904"></a>01904             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>);
<a name="l01905"></a>01905             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01906"></a>01906             {
<a name="l01907"></a>01907                 <span class="keywordflow">for</span> (i=0; i &lt; poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a4ac9781df1430304b634f76236a5cfd1">VertexCount</a>(); i++)
<a name="l01908"></a>01908                 {
<a name="l01909"></a>01909                     v_orig= poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a183769a341bffba880c774f683c01d49">GetVertex</a>(i)-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#a7abcd6d4497533c24bb57d406c733c02">getOrigIndex</a>();
<a name="l01910"></a>01910                     <span class="keywordflow">if</span> (vert_tag_array[v_orig]==<span class="keyword">false</span>)
<a name="l01911"></a>01911                     {
<a name="l01912"></a>01912                         vert_tag_array[v_orig]= <span class="keyword">true</span>;
<a name="l01913"></a>01913                         vert_remap_array[v_orig]= tot_bt_verts;
<a name="l01914"></a>01914                         tot_bt_verts++;
<a name="l01915"></a>01915                     }
<a name="l01916"></a>01916                 }
<a name="l01917"></a>01917                 tot_bt_tris += (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a4ac9781df1430304b634f76236a5cfd1">VertexCount</a>()==4 ? 2:1);
<a name="l01918"></a>01918             }
<a name="l01919"></a>01919         }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <span class="comment">// This case happens when none of the polys are colliders</span>
<a name="l01922"></a>01922         <span class="keywordflow">if</span> (tot_bt_tris == 0 || tot_bt_verts == 0)
<a name="l01923"></a>01923             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01924"></a>01924 
<a name="l01925"></a>01925         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6a48cd9cb91d0cfa50ee1c70ef485190">resize</a>(tot_bt_verts*3);
<a name="l01926"></a>01926         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0];
<a name="l01927"></a>01927 
<a name="l01928"></a>01928         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.resize(tot_bt_tris*3);
<a name="l01929"></a>01929         <span class="keywordtype">int</span> *tri_pt= &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0];
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="comment">/* cant be used for anything useful in this case, since we don&#39;t rely on the original mesh</span>
<a name="l01932"></a>01932 <span class="comment">         * will just be an array like pythons range(tot_bt_tris) */</span>
<a name="l01933"></a>01933         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.resize(tot_bt_tris);
<a name="l01934"></a>01934 
<a name="l01935"></a>01935 
<a name="l01936"></a>01936         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>=0; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>&lt;numpolys; <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>++)
<a name="l01937"></a>01937         {
<a name="l01938"></a>01938             <a class="code" href="../../dc/dd9/classRAS__Polygon.html">RAS_Polygon</a>* poly= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#a599277a8e5d4f4460b4ebe8eb32652ce">GetPolygon</a>(<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>);
<a name="l01939"></a>01939 
<a name="l01940"></a>01940             <span class="keywordflow">if</span> (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a14f4414ce4ce8c6759831c0e39dbe2ef">IsCollider</a>())
<a name="l01941"></a>01941             {
<a name="l01942"></a>01942                 <span class="comment">/* quad or tri loop */</span>
<a name="l01943"></a>01943                 fv_pt= (poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a4ac9781df1430304b634f76236a5cfd1">VertexCount</a>()==3 ? tri_verts:quad_verts);
<a name="l01944"></a>01944 
<a name="l01945"></a>01945                 <span class="keywordflow">for</span> (; *fv_pt &gt; -1; fv_pt++)
<a name="l01946"></a>01946                 {
<a name="l01947"></a>01947                     v_orig= poly-&gt;<a class="code" href="../../dc/dd9/classRAS__Polygon.html#a183769a341bffba880c774f683c01d49">GetVertex</a>(*fv_pt)-&gt;<a class="code" href="../../dc/dd2/classRAS__TexVert.html#a7abcd6d4497533c24bb57d406c733c02">getOrigIndex</a>();
<a name="l01948"></a>01948 
<a name="l01949"></a>01949                     <span class="keywordflow">if</span> (vert_tag_array[v_orig])
<a name="l01950"></a>01950                     {
<a name="l01951"></a>01951                         <span class="keywordflow">if</span> (transverts) {
<a name="l01952"></a>01952                             <span class="comment">/* deformed mesh, using RAS_TexVert locations would be too troublesome</span>
<a name="l01953"></a>01953 <span class="comment">                             * because they are use the gameob as a hash in the material slot */</span>
<a name="l01954"></a>01954                             *bt++ = transverts[v_orig][0];
<a name="l01955"></a>01955                             *bt++ = transverts[v_orig][1];
<a name="l01956"></a>01956                             *bt++ = transverts[v_orig][2];
<a name="l01957"></a>01957                         }
<a name="l01958"></a>01958                         <span class="keywordflow">else</span> {
<a name="l01959"></a>01959                             <span class="comment">/* static mesh python may have modified */</span>
<a name="l01960"></a>01960                             xyz= meshobj-&gt;<a class="code" href="../../d5/d85/classRAS__MeshObject.html#ac388764a286779f0be3b098aa807a4a1">GetVertexLocation</a>( v_orig );
<a name="l01961"></a>01961                             *bt++ = xyz[0];
<a name="l01962"></a>01962                             *bt++ = xyz[1];
<a name="l01963"></a>01963                             *bt++ = xyz[2];
<a name="l01964"></a>01964                         }
<a name="l01965"></a>01965 
<a name="l01966"></a>01966                         vert_tag_array[v_orig]= <span class="keyword">false</span>;
<a name="l01967"></a>01967                     }
<a name="l01968"></a>01968 
<a name="l01969"></a>01969                     *tri_pt++ = vert_remap_array[v_orig];
<a name="l01970"></a>01970                 }
<a name="l01971"></a>01971             }
<a name="l01972"></a>01972 
<a name="l01973"></a>01973             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>[<a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>]= <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>; <span class="comment">/* dumb counting */</span>
<a name="l01974"></a>01974         }
<a name="l01975"></a>01975     }
<a name="l01976"></a>01976     
<a name="l01977"></a>01977 <span class="preprocessor">#if 0</span>
<a name="l01978"></a>01978 <span class="preprocessor"></span>    <span class="comment">/* needs #include &lt;cstdio&gt; */</span>
<a name="l01979"></a>01979     printf(<span class="stringliteral">&quot;# vert count %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>());
<a name="l01980"></a>01980     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>(); i+=3) {
<a name="l01981"></a>01981         printf(<span class="stringliteral">&quot;v %.6f %.6f %.6f\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i], <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i+1], <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[i+2]);
<a name="l01982"></a>01982     }
<a name="l01983"></a>01983 
<a name="l01984"></a>01984     printf(<span class="stringliteral">&quot;# face count %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.size());
<a name="l01985"></a>01985     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.size(); i+=3) {
<a name="l01986"></a>01986         printf(<span class="stringliteral">&quot;f %d %d %d\n&quot;</span>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i]+1, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i+1]+1, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[i+2]+1);
<a name="l01987"></a>01987     }
<a name="l01988"></a>01988 <span class="preprocessor">#endif</span>
<a name="l01989"></a>01989 <span class="preprocessor"></span>
<a name="l01990"></a>01990     <span class="comment">/* force recreation of the m_unscaledShape.</span>
<a name="l01991"></a>01991 <span class="comment">     * If this has multiple users we cant delete */</span>
<a name="l01992"></a>01992     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>) {
<a name="l01993"></a>01993         <span class="comment">// don&#39;t free now so it can re-allocate under the same location and not break pointers.</span>
<a name="l01994"></a>01994         <span class="comment">// DeleteBulletShape(m_unscaledShape); </span>
<a name="l01995"></a>01995         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a7ee6bc59a7a5266ebe2bbcdbe9f63440">m_forceReInstance</a>= <span class="keyword">true</span>;
<a name="l01996"></a>01996     }
<a name="l01997"></a>01997 
<a name="l01998"></a>01998     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a44af26cca43eceacef9a8ce94a6e58d7">m_meshObject</a>= meshobj;
<a name="l01999"></a>01999     
<a name="l02000"></a>02000     <span class="keywordflow">if</span> (dm) {
<a name="l02001"></a>02001         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a18e4784d6ea7e5877394c53cdfd65691">needsFree</a> = 1;
<a name="l02002"></a>02002         dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l02003"></a>02003     }
<a name="l02004"></a>02004     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02005"></a>02005 }
<a name="l02006"></a>02006 
<a name="l02007"></a>02007 
<a name="l02008"></a>02008 
<a name="l02009"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a07e672e22c460b7bd4bc3d97458c550e">02009</a> <span class="keywordtype">bool</span> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a07e672e22c460b7bd4bc3d97458c550e">CcdShapeConstructionInfo::SetProxy</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html">CcdShapeConstructionInfo</a>* shapeInfo)
<a name="l02010"></a>02010 {
<a name="l02011"></a>02011     <span class="keywordflow">if</span> (shapeInfo == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02012"></a>02012         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02013"></a>02013     <span class="comment">// no support for dynamic change</span>
<a name="l02014"></a>02014     <a class="code" href="../../d5/d8e/Value_8h.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a61820426adb3d99aef1da28575e9b371">IsUnused</a>());
<a name="l02015"></a>02015     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> = <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaafbdae59738439ef5a444f5d922c1459b">PHY_SHAPE_PROXY</a>;
<a name="l02016"></a>02016     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a02bf2e13502c2038fb7642f6d7ecd946">m_shapeProxy</a> = shapeInfo;
<a name="l02017"></a>02017     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02018"></a>02018 }
<a name="l02019"></a>02019 
<a name="l02020"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9d1ba0bb87f77e9ef4529c494faacada">02020</a> <a class="code" href="../../d7/dd7/classbtCollisionShape.html" title="The btCollisionShape class provides an interface for collision shapes that can be shared among btColl...">btCollisionShape</a>* <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9d1ba0bb87f77e9ef4529c494faacada">CcdShapeConstructionInfo::CreateBulletShape</a>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> margin, <span class="keywordtype">bool</span> useGimpact, <span class="keywordtype">bool</span> useBvh)
<a name="l02021"></a>02021 {
<a name="l02022"></a>02022     <a class="code" href="../../d7/dd7/classbtCollisionShape.html" title="The btCollisionShape class provides an interface for collision shapes that can be shared among btColl...">btCollisionShape</a>* collisionShape = 0;
<a name="l02023"></a>02023     btCompoundShape* compoundShape = 0; 
<a name="l02024"></a>02024 
<a name="l02025"></a>02025     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> == <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaafbdae59738439ef5a444f5d922c1459b">PHY_SHAPE_PROXY</a> &amp;&amp; <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a02bf2e13502c2038fb7642f6d7ecd946">m_shapeProxy</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02026"></a>02026         <span class="keywordflow">return</span> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a02bf2e13502c2038fb7642f6d7ecd946">m_shapeProxy</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9d1ba0bb87f77e9ef4529c494faacada">CreateBulletShape</a>(margin, useGimpact, useBvh);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028     <span class="keywordflow">switch</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a>) 
<a name="l02029"></a>02029     {
<a name="l02030"></a>02030     <span class="keywordflow">default</span>:
<a name="l02031"></a>02031         <span class="keywordflow">break</span>;
<a name="l02032"></a>02032 
<a name="l02033"></a>02033     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa4d70e8b66f3d61c6340027608ec01601">PHY_SHAPE_BOX</a>:
<a name="l02034"></a>02034         collisionShape = <span class="keyword">new</span> <a class="code" href="../../da/df8/classbtBoxShape.html" title="The btBoxShape is a box primitive around the origin, its sides axis aligned with length specified by ...">btBoxShape</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a08df07eabfc1aa1821e9c5461e6f1ab6">m_halfExtend</a>);
<a name="l02035"></a>02035         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02036"></a>02036         <span class="keywordflow">break</span>;
<a name="l02037"></a>02037 
<a name="l02038"></a>02038     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa1cbd35b2b5125b05682ae9c63822d0f4">PHY_SHAPE_SPHERE</a>:
<a name="l02039"></a>02039         collisionShape = <span class="keyword">new</span> btSphereShape(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#adae2d19530c86139753b99340c9f435a">m_radius</a>);
<a name="l02040"></a>02040         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02041"></a>02041         <span class="keywordflow">break</span>;
<a name="l02042"></a>02042 
<a name="l02043"></a>02043     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa77cc0d4a3571df3241893de8494c7c3c">PHY_SHAPE_CYLINDER</a>:
<a name="l02044"></a>02044         collisionShape = <span class="keyword">new</span> <a class="code" href="../../dd/d37/classbtCylinderShapeZ.html">btCylinderShapeZ</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a08df07eabfc1aa1821e9c5461e6f1ab6">m_halfExtend</a>);
<a name="l02045"></a>02045         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02046"></a>02046         <span class="keywordflow">break</span>;
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa02b16d466b7723ab08987d636bb3c893">PHY_SHAPE_CONE</a>:
<a name="l02049"></a>02049         collisionShape = <span class="keyword">new</span> <a class="code" href="../../d8/df2/classbtConeShapeZ.html" title="btConeShapeZ implements a Cone shape, around the Z axis">btConeShapeZ</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#adae2d19530c86139753b99340c9f435a">m_radius</a>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9e64f37bddcead2c45e18a90952ecc6a">m_height</a>);
<a name="l02050"></a>02050         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02051"></a>02051         <span class="keywordflow">break</span>;
<a name="l02052"></a>02052 
<a name="l02053"></a>02053     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa3437b38c19c57f67a79dd4f7282b36fb">PHY_SHAPE_POLYTOPE</a>:
<a name="l02054"></a>02054         collisionShape = <span class="keyword">new</span> btConvexHullShape(&amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0], <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>()/3, 3*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>));
<a name="l02055"></a>02055         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02056"></a>02056         <span class="keywordflow">break</span>;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaaac44ec4fdfcc1d5aa10aacf48db0b9d7">PHY_SHAPE_CAPSULE</a>:
<a name="l02059"></a>02059         collisionShape = <span class="keyword">new</span> <a class="code" href="../../d2/d0e/classbtCapsuleShapeZ.html">btCapsuleShapeZ</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#adae2d19530c86139753b99340c9f435a">m_radius</a>, <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a9e64f37bddcead2c45e18a90952ecc6a">m_height</a>);
<a name="l02060"></a>02060         collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02061"></a>02061         <span class="keywordflow">break</span>;
<a name="l02062"></a>02062 
<a name="l02063"></a>02063     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaab87e2dce120244386e70501968c1329b">PHY_SHAPE_MESH</a>:
<a name="l02064"></a>02064         <span class="comment">// Let&#39;s use the latest btScaledBvhTriangleMeshShape: it allows true sharing of </span>
<a name="l02065"></a>02065         <span class="comment">// triangle mesh information between duplicates =&gt; drastic performance increase when </span>
<a name="l02066"></a>02066         <span class="comment">// duplicating complex mesh objects. </span>
<a name="l02067"></a>02067         <span class="comment">// BUT it causes a small performance decrease when sharing is not required: </span>
<a name="l02068"></a>02068         <span class="comment">// 9 multiplications/additions and one function call for each triangle that passes the mid phase filtering</span>
<a name="l02069"></a>02069         <span class="comment">// One possible optimization is to use directly the btBvhTriangleMeshShape when the scale is 1,1,1</span>
<a name="l02070"></a>02070         <span class="comment">// and btScaledBvhTriangleMeshShape otherwise.</span>
<a name="l02071"></a>02071         <span class="keywordflow">if</span> (useGimpact)
<a name="l02072"></a>02072         {               
<a name="l02073"></a>02073                 btTriangleIndexVertexArray* indexVertexArrays = <span class="keyword">new</span> btTriangleIndexVertexArray(
<a name="l02074"></a>02074                         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.size(),
<a name="l02075"></a>02075                         &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0],
<a name="l02076"></a>02076                         3*<span class="keyword">sizeof</span>(int),
<a name="l02077"></a>02077                         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>()/3,
<a name="l02078"></a>02078                         &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0],
<a name="l02079"></a>02079                         3*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>)
<a name="l02080"></a>02080                 );
<a name="l02081"></a>02081                 
<a name="l02082"></a>02082                 <a class="code" href="../../df/d39/classbtGImpactMeshShape.html" title="This class manages a mesh supplied by the btStridingMeshInterface interface.">btGImpactMeshShape</a>* gimpactShape =  <span class="keyword">new</span> <a class="code" href="../../df/d39/classbtGImpactMeshShape.html" title="This class manages a mesh supplied by the btStridingMeshInterface interface.">btGImpactMeshShape</a>(indexVertexArrays);
<a name="l02083"></a>02083                 gimpactShape-&gt;<a class="code" href="../../df/d39/classbtGImpactMeshShape.html#aab65bdcfd34867e88a505a6377e4f79b">setMargin</a>(margin);
<a name="l02084"></a>02084                 collisionShape = gimpactShape;
<a name="l02085"></a>02085                 gimpactShape-&gt;<a class="code" href="../../d6/d18/classbtGImpactShapeInterface.html#acb26c2d7a2aecabd06b996b72b848492" title="performs refit operation">updateBound</a>();
<a name="l02086"></a>02086 
<a name="l02087"></a>02087         } <span class="keywordflow">else</span>
<a name="l02088"></a>02088         {
<a name="l02089"></a>02089             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a> || <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a7ee6bc59a7a5266ebe2bbcdbe9f63440">m_forceReInstance</a>)
<a name="l02090"></a>02090             {
<a name="l02091"></a>02091             
<a name="l02092"></a>02092                 btTriangleIndexVertexArray* indexVertexArrays = 0;
<a name="l02093"></a>02093 
<a name="l02095"></a>02095                 <span class="keywordflow">if</span> (0.f != <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a13e89548a417ed2ab39f1f9a3ea08d51">m_weldingThreshold1</a>)
<a name="l02096"></a>02096                 {
<a name="l02097"></a>02097                     <a class="code" href="../../df/d27/classbtTriangleMesh.html">btTriangleMesh</a>* collisionMeshData = <span class="keyword">new</span> <a class="code" href="../../df/d27/classbtTriangleMesh.html">btTriangleMesh</a>(<span class="keyword">true</span>,<span class="keyword">false</span>);
<a name="l02098"></a>02098                     collisionMeshData-&gt;<a class="code" href="../../df/d27/classbtTriangleMesh.html#a0b4be6aee36c84cb4d5679cde0ce91f8">m_weldingThreshold</a> = <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a13e89548a417ed2ab39f1f9a3ea08d51">m_weldingThreshold1</a>;
<a name="l02099"></a>02099                     <span class="keywordtype">bool</span> removeDuplicateVertices=<span class="keyword">true</span>;
<a name="l02100"></a>02100                     <span class="comment">// m_vertexArray not in multiple of 3 anymore, use m_triFaceArray</span>
<a name="l02101"></a>02101                     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>.size(); i+=3) {
<a name="l02102"></a>02102                         <a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a> *bt = &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[3*<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]];
<a name="l02103"></a>02103                         btVector3 v1(bt[0], bt[1], bt[2]);
<a name="l02104"></a>02104                         bt = &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[3*m_triFaceArray[i+1]];
<a name="l02105"></a>02105                         btVector3 v2(bt[0], bt[1], bt[2]);
<a name="l02106"></a>02106                         bt = &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[3*m_triFaceArray[i+2]];
<a name="l02107"></a>02107                         btVector3 v3(bt[0], bt[1], bt[2]);
<a name="l02108"></a>02108                         collisionMeshData-&gt;<a class="code" href="../../df/d27/classbtTriangleMesh.html#a28551d57ae59248a210163a504558583">addTriangle</a>(v1, v2, v3, removeDuplicateVertices);
<a name="l02109"></a>02109                     }
<a name="l02110"></a>02110                     indexVertexArrays = collisionMeshData;
<a name="l02111"></a>02111 
<a name="l02112"></a>02112                 } <span class="keywordflow">else</span>
<a name="l02113"></a>02113                 {
<a name="l02114"></a>02114                     indexVertexArrays = <span class="keyword">new</span> btTriangleIndexVertexArray(
<a name="l02115"></a>02115                             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a304f3fda5f2d3d3dadde20152edcc065">m_polygonIndexArray</a>.size(),
<a name="l02116"></a>02116                             &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#abe0f20426efb4f0cd75405e0a17f4149">m_triFaceArray</a>[0],
<a name="l02117"></a>02117                             3*<span class="keyword">sizeof</span>(int),
<a name="l02118"></a>02118                             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a6bdd14c7599ecb95e8d83dd5a715f9b7" title="return the number of elements in the array">size</a>()/3,
<a name="l02119"></a>02119                             &amp;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>[0],
<a name="l02120"></a>02120                             3*<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6b/btScalar_8h.html#a1e5824cfc8adbf5a77f2622132d16018" title="The btScalar type abstracts floating point numbers, to easily switch between double and single floati...">btScalar</a>));
<a name="l02121"></a>02121                 }
<a name="l02122"></a>02122                 
<a name="l02123"></a>02123                 <span class="comment">// this shape will be shared and not deleted until shapeInfo is deleted</span>
<a name="l02124"></a>02124                 
<a name="l02125"></a>02125                 <span class="comment">// for UpdateMesh, reuse the last memory location so instancing wont crash.</span>
<a name="l02126"></a>02126                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>) {
<a name="l02127"></a>02127                     <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">DeleteBulletShape</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>, <span class="keyword">false</span>);
<a name="l02128"></a>02128                     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>-&gt;~btBvhTriangleMeshShape();
<a name="l02129"></a>02129                     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a> = <span class="keyword">new</span>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>) btBvhTriangleMeshShape( indexVertexArrays, <span class="keyword">true</span>, useBvh );
<a name="l02130"></a>02130                 } <span class="keywordflow">else</span> {
<a name="l02131"></a>02131                     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a> = <span class="keyword">new</span> btBvhTriangleMeshShape( indexVertexArrays, <span class="keyword">true</span>, useBvh );
<a name="l02132"></a>02132                 }
<a name="l02133"></a>02133                 <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a7ee6bc59a7a5266ebe2bbcdbe9f63440">m_forceReInstance</a>= <span class="keyword">false</span>;
<a name="l02134"></a>02134             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (useBvh &amp;&amp; <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>-&gt;getOptimizedBvh() == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02135"></a>02135                 <span class="comment">// the existing unscaledShape was not build with Bvh, do it now</span>
<a name="l02136"></a>02136                 <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>-&gt;buildOptimizedBvh();
<a name="l02137"></a>02137             }
<a name="l02138"></a>02138             collisionShape = <span class="keyword">new</span> btScaledBvhTriangleMeshShape(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>, btVector3(1.0f,1.0f,1.0f));
<a name="l02139"></a>02139             collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#a012dd689cd3a8fd0a469d35335a13ca9">setMargin</a>(margin);
<a name="l02140"></a>02140         }
<a name="l02141"></a>02141         <span class="keywordflow">break</span>;
<a name="l02142"></a>02142 
<a name="l02143"></a>02143     <span class="keywordflow">case</span> <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaa8b272a35838563913e4e2f274d17c98d">PHY_SHAPE_COMPOUND</a>:
<a name="l02144"></a>02144         <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.size() &gt; 0)
<a name="l02145"></a>02145         {
<a name="l02146"></a>02146             compoundShape = <span class="keyword">new</span> btCompoundShape();
<a name="l02147"></a>02147             <span class="keywordflow">for</span> (std::vector&lt;CcdShapeConstructionInfo*&gt;::iterator sit = <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.begin();
<a name="l02148"></a>02148                  sit != <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.end();
<a name="l02149"></a>02149                  sit++)
<a name="l02150"></a>02150             {
<a name="l02151"></a>02151                 collisionShape = (*sit)-&gt;CreateBulletShape(margin, useGimpact, useBvh);
<a name="l02152"></a>02152                 <span class="keywordflow">if</span> (collisionShape)
<a name="l02153"></a>02153                 {
<a name="l02154"></a>02154                     collisionShape-&gt;<a class="code" href="../../d7/dd7/classbtCollisionShape.html#ab0e7232cb21511258227afafb952a0a5">setLocalScaling</a>((*sit)-&gt;m_childScale);
<a name="l02155"></a>02155                     compoundShape-&gt;addChildShape((*sit)-&gt;m_childTrans, collisionShape);
<a name="l02156"></a>02156                 }
<a name="l02157"></a>02157             }
<a name="l02158"></a>02158             collisionShape = compoundShape;
<a name="l02159"></a>02159         }
<a name="l02160"></a>02160         <span class="keywordflow">break</span>;
<a name="l02161"></a>02161     }
<a name="l02162"></a>02162     <span class="keywordflow">return</span> collisionShape;
<a name="l02163"></a>02163 }
<a name="l02164"></a>02164 
<a name="l02165"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a90deb6051a630673574ad407498a5e7a">02165</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a90deb6051a630673574ad407498a5e7a">CcdShapeConstructionInfo::AddShape</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html">CcdShapeConstructionInfo</a>* shapeInfo)
<a name="l02166"></a>02166 {
<a name="l02167"></a>02167     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.push_back(shapeInfo);
<a name="l02168"></a>02168     shapeInfo-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a82628ab59948d70446675dd8bf389fa6">AddRef</a>();
<a name="l02169"></a>02169 }
<a name="l02170"></a>02170 
<a name="l02171"></a><a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a1f278648f3ca14fee3f6739a16b479e4">02171</a> <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a1f278648f3ca14fee3f6739a16b479e4">CcdShapeConstructionInfo::~CcdShapeConstructionInfo</a>()
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173     <span class="keywordflow">for</span> (std::vector&lt;CcdShapeConstructionInfo*&gt;::iterator sit = <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.begin();
<a name="l02174"></a>02174          sit != <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.end();
<a name="l02175"></a>02175          sit++)
<a name="l02176"></a>02176     {
<a name="l02177"></a>02177         (*sit)-&gt;Release();
<a name="l02178"></a>02178     }
<a name="l02179"></a>02179     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ad54bb230e4517b03d723fb10a427c219">m_shapeArray</a>.clear();
<a name="l02180"></a>02180     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>)
<a name="l02181"></a>02181     {
<a name="l02182"></a>02182         <a class="code" href="../../d3/da1/CcdPhysicsController_8cpp.html#a9fd200f5600bd64a24de947c8736e02c">DeleteBulletShape</a>(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a993f65a2399784c1ccf4c9e5ef09eab0">m_unscaledShape</a>, <span class="keyword">true</span>);
<a name="l02183"></a>02183     }
<a name="l02184"></a>02184     <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ab1eedf2969d13a756b61829968d37ee8">m_vertexArray</a>.<a class="code" href="../../dc/df2/classbtAlignedObjectArray.html#a12123db01dda7758f0df5e3bba10cc0a" title="clear the array, deallocated memory. Generally it is better to use array.resize(0), to reduce performance overhead of run-time memory (de)allocations.">clear</a>();
<a name="l02185"></a>02185     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> == <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaab87e2dce120244386e70501968c1329b">PHY_SHAPE_MESH</a> &amp;&amp; <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a44af26cca43eceacef9a8ce94a6e58d7">m_meshObject</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l02186"></a>02186     {
<a name="l02187"></a>02187         std::map&lt;RAS_MeshObject*,CcdShapeConstructionInfo*&gt;::iterator mit = <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.find(<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a44af26cca43eceacef9a8ce94a6e58d7">m_meshObject</a>);
<a name="l02188"></a>02188         <span class="keywordflow">if</span> (mit != <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.end() &amp;&amp; mit-&gt;second == <span class="keyword">this</span>)
<a name="l02189"></a>02189         {
<a name="l02190"></a>02190             <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ac2b6fd0cfa33cdc18a512e3d1f27d4d7">m_meshShapeMap</a>.erase(mit);
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192     }
<a name="l02193"></a>02193     <span class="keywordflow">if</span> (<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#ae267af5ffec5201be111f3bb531c5993">m_shapeType</a> == <a class="code" href="../../d4/d03/PHY__DynamicTypes_8h.html#a1e1c821deea56c0291bad534b29d1bfaafbdae59738439ef5a444f5d922c1459b">PHY_SHAPE_PROXY</a> &amp;&amp; <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a02bf2e13502c2038fb7642f6d7ecd946">m_shapeProxy</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02194"></a>02194     {
<a name="l02195"></a>02195         <a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a02bf2e13502c2038fb7642f6d7ecd946">m_shapeProxy</a>-&gt;<a class="code" href="../../d5/ddd/classCcdShapeConstructionInfo.html#a70f35abafde365e311441d8052697069">Release</a>();
<a name="l02196"></a>02196     }
<a name="l02197"></a>02197 }
<a name="l02198"></a>02198 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:10 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
