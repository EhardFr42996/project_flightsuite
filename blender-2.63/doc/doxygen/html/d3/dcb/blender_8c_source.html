<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: blender.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">blender.c</div>  </div>
</div>
<div class="contents">
<a href="../../d3/dcb/blender_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef _WIN32 </span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;unistd.h&gt;</span> <span class="comment">// for read close</span>
<a name="l00035"></a>00035 <span class="preprocessor">#else</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;io.h&gt;</span> <span class="comment">// for open close read</span>
<a name="l00037"></a>00037 <span class="preprocessor">#  define open _open</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#  define read _read</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#  define close _close</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#  define write _write</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;fcntl.h&gt;</span> <span class="comment">// for open</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/de4/DNA__userdef__types_8h.html">DNA_userdef_types.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/da4/DNA__screen__types_8h.html">DNA_screen_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da9/DNA__sequence__types_8h.html">DNA_sequence_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d66/DNA__sound__types_8h.html">DNA_sound_types.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd1/BLI__bpath_8h.html">BLI_bpath.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/BLI__dynstr_8h.html" title="A dynamically sized string ADT.">BLI_dynstr.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d46/BLI__callbacks_8h.html">BLI_callbacks.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/dc9/IMB__moviecache_8h.html">IMB_moviecache.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/ddf/BKE__blender_8h.html" title="Blender util stuff.">BKE_blender.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d95/BKE__idprop_8h.html">BKE_idprop.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d48/BKE__ipo_8h.html">BKE_ipo.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da3/BKE__screen_8h.html">BKE_screen.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d5f/BKE__sequencer_8h.html">BKE_sequencer.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/db1/BKE__sound_8h.html">BKE_sound.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dfd/RE__pipeline_8h.html">RE_pipeline.h</a>&quot;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d5f/BLO__undofile_8h.html">BLO_undofile.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d01/BLO__readfile_8h.html" title="external readfile function prototypes.">BLO_readfile.h</a>&quot;</span> 
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d5b/BLO__writefile_8h.html" title="external writefile function prototypes.">BLO_writefile.h</a>&quot;</span> 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span> <span class="comment">// XXXXX BAD, very BAD dependency (bad level call) - remove asap, elubie</span>
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="../../d3/dcb/blender_8c.html#abe2782014105bed3c1832da467f720bd">00094</a> <a class="code" href="../../d9/d4c/structGlobal.html">Global</a> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>;
<a name="l00095"></a><a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a50681c06da0a928665b29fdd1cbcaf4f">00095</a> <a class="code" href="../../d6/de3/structUserDef.html">UserDef</a> <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>;
<a name="l00096"></a>00096 <span class="comment">/* ListBase = {NULL, NULL}; */</span>
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="../../d3/dcb/blender_8c.html#a1832aff54e08e3f64967b950096bf034">00098</a> <span class="keywordtype">char</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1853a0f3fca110191987632863077cbb">versionstr</a>[48]= <span class="stringliteral">&quot;&quot;</span>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="comment">/* ********** free ********** */</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="comment">/* only to be called on exit blender */</span>
<a name="l00103"></a><a class="code" href="../../d3/dcb/blender_8c.html#a8d086b3d916f20747384616c1bc48ca6">00103</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a8d086b3d916f20747384616c1bc48ca6">free_blender</a>(<span class="keywordtype">void</span>)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105     <span class="comment">/* samples are in a global list..., also sets G.main-&gt;sound-&gt;sample NULL */</span>
<a name="l00106"></a>00106     <a class="code" href="../../d8/db1/BKE__library_8h.html#a7dacadb71dbdc69a89bbf5e61818e085">free_main</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>);
<a name="l00107"></a>00107     G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <a class="code" href="../../d7/da3/BKE__screen_8h.html#a45425b137dbbb400e3a6ed45ee11b77e">BKE_spacetypes_free</a>();      <span class="comment">/* after free main, it uses space callbacks */</span>
<a name="l00110"></a>00110     
<a name="l00111"></a>00111     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a9a9979305e833af54a720a3a3321e487">IMB_exit</a>();
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <a class="code" href="../../d7/d46/BLI__callbacks_8h.html#aa4734dec54b2e44e598182a16bcb4a2a">BLI_cb_finalize</a>();
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <a class="code" href="../../d8/d5f/BKE__sequencer_8h.html#abe751156a68c59863d7e636f29c11589">seq_stripelem_cache_destruct</a>();
<a name="l00116"></a>00116     <a class="code" href="../../d0/dc9/IMB__moviecache_8h.html#a62535e39e1a78e394594a72bdb2121b4">IMB_moviecache_destruct</a>();
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <a class="code" href="../../d4/d91/BKE__node_8h.html#a99f937f95c0ff67816e0accd45931ad3">free_nodesystem</a>();  
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="../../d3/dcb/blender_8c.html#ae075e1d655a036c8dbba4bca62498ac2">00121</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#ae075e1d655a036c8dbba4bca62498ac2">initglobals</a>(<span class="keywordtype">void</span>)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     memset(&amp;G, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4c/structGlobal.html">Global</a>));
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     U.<a class="code" href="../../d6/de3/structUserDef.html#a92ecf81e8e06bbcac37a2d276a84ed8d">savetime</a>= 1;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/dc0/structMain.html">Main</a>), <span class="stringliteral">&quot;initglobals&quot;</span>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     strcpy(G.<a class="code" href="../../d9/d4c/structGlobal.html#ab898b7135cbe504eae7c5bfe411fd637">ima</a>, <span class="stringliteral">&quot;//&quot;</span>);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131     <span class="keywordflow">if</span> (<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a01cbc3715abf12b99ea7892d911c3803">BLENDER_SUBVERSION</a>)
<a name="l00132"></a>00132         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1853a0f3fca110191987632863077cbb">versionstr</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1853a0f3fca110191987632863077cbb">versionstr</a>), <span class="stringliteral">&quot;blender.org %d.%d&quot;</span>, <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5dffb3de6e078b72298ed826456c2272">BLENDER_VERSION</a>, <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a01cbc3715abf12b99ea7892d911c3803">BLENDER_SUBVERSION</a>);
<a name="l00133"></a>00133     <span class="keywordflow">else</span>
<a name="l00134"></a>00134         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1853a0f3fca110191987632863077cbb">versionstr</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1853a0f3fca110191987632863077cbb">versionstr</a>), <span class="stringliteral">&quot;blender.org %d&quot;</span>, <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5dffb3de6e078b72298ed826456c2272">BLENDER_VERSION</a>);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="preprocessor">#ifdef _WIN32   // FULLSCREEN</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    G.<a class="code" href="../../d9/d4c/structGlobal.html#a41eb8e96f6acd0471c45cb50ebce78ec">windowstate</a> = <a class="code" href="../../d1/d8c/BKE__global_8h.html#ae197270fa6af58e143d67f7942c354f6">G_WINDOWSTATE_USERDEF</a>;
<a name="l00138"></a>00138 <span class="preprocessor">#endif</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>
<a name="l00140"></a>00140     G.<a class="code" href="../../d9/d4c/structGlobal.html#a922778578b6561eff5eac7880c3f437a">charstart</a> = 0x0000;
<a name="l00141"></a>00141     G.<a class="code" href="../../d9/d4c/structGlobal.html#ac50deae9ac1725cfdb9129d34c47be51">charmin</a> = 0x0000;
<a name="l00142"></a>00142     G.<a class="code" href="../../d9/d4c/structGlobal.html#a4a4712b9f1cda0c4c289aed3fd5ed8f9">charmax</a> = 0xffff;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="preprocessor">#ifndef WITH_PYTHON_SECURITY </span><span class="comment">/* default */</span>
<a name="l00145"></a>00145     G.<a class="code" href="../../d9/d4c/structGlobal.html#a0da0e1cf194f175f27e5af99964d2232">f</a> |= <a class="code" href="../../d1/d8c/BKE__global_8h.html#a070f00cacf7dce298099127b5a4d634b">G_SCRIPT_AUTOEXEC</a>;
<a name="l00146"></a>00146 <span class="preprocessor">#else</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>    G.<a class="code" href="../../d9/d4c/structGlobal.html#a0da0e1cf194f175f27e5af99964d2232">f</a> &amp;= ~<a class="code" href="../../d1/d8c/BKE__global_8h.html#a070f00cacf7dce298099127b5a4d634b">G_SCRIPT_AUTOEXEC</a>;
<a name="l00148"></a>00148 <span class="preprocessor">#endif</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>}
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">/***/</span>
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="../../d3/dcb/blender_8c.html#afef06bf8762b3cc95b3e48f8278f94b8">00153</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dcb/blender_8c.html#afef06bf8762b3cc95b3e48f8278f94b8">clear_global</a>(<span class="keywordtype">void</span>) 
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155 <span class="comment">//  extern short winqueue_break;    /* screen.c */</span>
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <a class="code" href="../../d8/db1/BKE__library_8h.html#a7dacadb71dbdc69a89bbf5e61818e085">free_main</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>);          <span class="comment">/* free all lib data */</span>
<a name="l00158"></a>00158     
<a name="l00159"></a>00159 <span class="comment">//  free_vertexpaint();</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="../../d3/dcb/blender_8c.html#af5fcb03d88528898c275cffcc3fdb8d1">00164</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/dcb/blender_8c.html#af5fcb03d88528898c275cffcc3fdb8d1">clean_paths_visit_cb</a>(<span class="keywordtype">void</span> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(userdata), <span class="keywordtype">char</span> *path_dst, <span class="keyword">const</span> <span class="keywordtype">char</span> *path_src)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     strcpy(path_dst, path_src);
<a name="l00167"></a>00167     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ac5cc14a14ce0088944f22aae8baf8083">BLI_clean</a>(path_dst);
<a name="l00168"></a>00168     <span class="keywordflow">return</span> (strcmp(path_dst, path_src) == 0) ? <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> : <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">/* make sure path names are correct for OS */</span>
<a name="l00172"></a><a class="code" href="../../d3/dcb/blender_8c.html#a4b02866a28f918901c34ee38602db1a8">00172</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dcb/blender_8c.html#a4b02866a28f918901c34ee38602db1a8">clean_paths</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *<a class="code" href="../../d5/d95/makesdna_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>)
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <a class="code" href="../../d5/dd1/BLI__bpath_8h.html#a4e91dd48dfd961c24f2f78b2eaac4cb9">bpath_traverse_main</a>(main, <a class="code" href="../../d3/dcb/blender_8c.html#af5fcb03d88528898c275cffcc3fdb8d1">clean_paths_visit_cb</a>, <a class="code" href="../../d5/dd1/BLI__bpath_8h.html#aa06a498820e1e1cd3cb2c5b757fa0561">BPATH_TRAVERSE_SKIP_MULTIFILE</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordflow">for</span> (scene= main-&gt;<a class="code" href="../../d0/dc0/structMain.html#a976062774f867fa0f917c23f2ec331bb">scene</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; scene; scene= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00179"></a>00179         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ac5cc14a14ce0088944f22aae8baf8083">BLI_clean</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a67d0217c5d024ae2ee50bcbe547c4772">pic</a>);
<a name="l00180"></a>00180     }
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="comment">/* context matching */</span>
<a name="l00184"></a>00184 <span class="comment">/* handle no-ui case */</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* note, this is called on Undo so any slow conversion functions here</span>
<a name="l00187"></a>00187 <span class="comment"> * should be avoided or check (mode!=&#39;u&#39;) */</span>
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="../../d3/dcb/blender_8c.html#a691581a77a4b1323d851f13789eac0d9">00189</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dcb/blender_8c.html#a691581a77a4b1323d851f13789eac0d9">setup_app_data</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../db/d57/structBlendFileData.html">BlendFileData</a> *bfd, <span class="keyword">const</span> <span class="keywordtype">char</span> *filepath)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *curscreen= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00192"></a>00192     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *curscene= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00193"></a>00193     <span class="keywordtype">int</span> recover;
<a name="l00194"></a>00194     <span class="keywordtype">char</span> mode;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="comment">/* &#39;u&#39; = undo save, &#39;n&#39; = no UI load */</span>
<a name="l00197"></a>00197     <span class="keywordflow">if</span> (bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a3ab31640766afea3c151a816eb70e691">screen</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) mode= <span class="charliteral">&#39;u&#39;</span>;
<a name="l00198"></a>00198     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a> &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a30ceab40e66804ac4b10d00ab95eb917">G_FILE_NO_UI</a>) mode= <span class="charliteral">&#39;n&#39;</span>;
<a name="l00199"></a>00199     <span class="keywordflow">else</span> mode= 0;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     recover= (G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a> &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a28c521d55001f8082934eab889676e76">G_FILE_RECOVER</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="comment">/* Free all render results, without this stale data gets displayed after loading files */</span>
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (mode != <span class="charliteral">&#39;u&#39;</span>) {
<a name="l00205"></a>00205         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ae42babce553eec1e76076ae149e8c602">RE_FreeAllRenderResults</a>();
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="comment">/* Only make filepaths compatible when loading for real (not undo) */</span>
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (mode != <span class="charliteral">&#39;u&#39;</span>) {
<a name="l00210"></a>00210         <a class="code" href="../../d3/dcb/blender_8c.html#a4b02866a28f918901c34ee38602db1a8">clean_paths</a>(bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>);
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="comment">/* XXX here the complex windowmanager matching */</span>
<a name="l00214"></a>00214     
<a name="l00215"></a>00215     <span class="comment">/* no load screens? */</span>
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (mode) {
<a name="l00217"></a>00217         <span class="comment">/* comes from readfile.c */</span>
<a name="l00218"></a>00218         <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="../../d0/d12/readfile_8c.html#ab98d83b845f48c9394d3c2598dc7b83d">lib_link_screen_restore</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *, <a class="code" href="../../de/de7/structbScreen.html">bScreen</a> *, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *);
<a name="l00219"></a>00219         
<a name="l00220"></a>00220         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a1c415972a9fb2c7ce05e14d83affa0d8">wm</a>, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a1c415972a9fb2c7ce05e14d83affa0d8">wm</a>);
<a name="l00221"></a>00221         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a3ab31640766afea3c151a816eb70e691">screen</a>, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a3ab31640766afea3c151a816eb70e691">screen</a>);
<a name="l00222"></a>00222         <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a5fe0952e66cbb7dbad512a6fcc91b1b3">SWAP</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a3e9b648f3c97050a53bdfc1a2a015916">script</a>, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a3e9b648f3c97050a53bdfc1a2a015916">script</a>);
<a name="l00223"></a>00223         
<a name="l00224"></a>00224         <span class="comment">/* we re-use current screen */</span>
<a name="l00225"></a>00225         curscreen= <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C);
<a name="l00226"></a>00226         <span class="comment">/* but use new Scene pointer */</span>
<a name="l00227"></a>00227         curscene= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ab73859890567227939cc23bafc1431a2">curscene</a>;
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (curscene==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) curscene= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a976062774f867fa0f917c23f2ec331bb">scene</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00229"></a>00229         <span class="comment">/* and we enforce curscene to be in current screen */</span>
<a name="l00230"></a>00230         <span class="keywordflow">if</span> (curscreen) curscreen-&gt;<a class="code" href="../../de/de7/structbScreen.html#a98cbd326f3b4179f769d007556e14999">scene</a>= curscene; <span class="comment">/* can run in bgmode */</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="comment">/* clear_global will free G.main, here we can still restore pointers */</span>
<a name="l00233"></a>00233         <a class="code" href="../../d0/d12/readfile_8c.html#ab98d83b845f48c9394d3c2598dc7b83d">lib_link_screen_restore</a>(bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>, curscreen, curscene);
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     
<a name="l00236"></a>00236     <span class="comment">/* free G.main Main database */</span>
<a name="l00237"></a>00237 <span class="comment">//  CTX_wm_manager_set(C, NULL);</span>
<a name="l00238"></a>00238     <a class="code" href="../../d3/dcb/blender_8c.html#afef06bf8762b3cc95b3e48f8278f94b8">clear_global</a>(); 
<a name="l00239"></a>00239     
<a name="l00240"></a>00240     <span class="comment">/* clear old property update cache, in case some old references are left dangling */</span>
<a name="l00241"></a>00241     <a class="code" href="../../d3/d10/rna__access_8c.html#af548ac64a1f2356bed4e2988ac02cb82">RNA_property_update_cache_free</a>();
<a name="l00242"></a>00242     
<a name="l00243"></a>00243     G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <a class="code" href="../../df/d01/BKE__context_8h.html#ab1d0bcbd1a0e5e6ae65d29b2364e8c9f">CTX_data_main_set</a>(C, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <a class="code" href="../../d2/db1/BKE__sound_8h.html#ae2c71dd7730120757be5df4616a3efbe">sound_init_main</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>);
<a name="l00248"></a>00248     
<a name="l00249"></a>00249     <span class="keywordflow">if</span> (bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af11d7e43345220a1e16989cab7dc55ef">user</a>) {
<a name="l00250"></a>00250         
<a name="l00251"></a>00251         <span class="comment">/* only here free userdef themes... */</span>
<a name="l00252"></a>00252         <a class="code" href="../../d7/ddf/BKE__blender_8h.html#ad2d023073d9161f63cf16c9b9d67100c">BKE_userdef_free</a>();
<a name="l00253"></a>00253         
<a name="l00254"></a>00254         U= *bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af11d7e43345220a1e16989cab7dc55ef">user</a>;
<a name="l00255"></a>00255         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af11d7e43345220a1e16989cab7dc55ef">user</a>);
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     
<a name="l00258"></a>00258     <span class="comment">/* case G_FILE_NO_UI or no screens in file */</span>
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (mode) {
<a name="l00260"></a>00260         <span class="comment">/* leave entire context further unaltered? */</span>
<a name="l00261"></a>00261         <a class="code" href="../../df/d01/BKE__context_8h.html#a197223f1af3429bb18e22f71ef4d4b60">CTX_data_scene_set</a>(C, curscene);
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263     <span class="keywordflow">else</span> {
<a name="l00264"></a>00264         G.<a class="code" href="../../d9/d4c/structGlobal.html#a074e372c03b39d40797c616fce445731">winpos</a>= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#a22f82a21a5ea33b23956a688e9ed5595">winpos</a>;
<a name="l00265"></a>00265         G.<a class="code" href="../../d9/d4c/structGlobal.html#ac1752b6520e8666409b15469e3b4ddd6">displaymode</a>= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ac6f05d28dd3dc3a4869fc4d16c0adcd8">displaymode</a>;
<a name="l00266"></a>00266         G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a>= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#a18858ade465176be45afbe2a4f50563b">fileflags</a>;
<a name="l00267"></a>00267         <a class="code" href="../../df/d01/BKE__context_8h.html#ae385160ffa37348a53852ee474a8c7cb">CTX_wm_manager_set</a>(C, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a1c415972a9fb2c7ce05e14d83affa0d8">wm</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l00268"></a>00268         <a class="code" href="../../df/d01/BKE__context_8h.html#aa738b861d07dd99111174d4aa273cb5c">CTX_wm_screen_set</a>(C, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#a878e239a8517075578f047442d1aa3d1">curscreen</a>);
<a name="l00269"></a>00269         <a class="code" href="../../df/d01/BKE__context_8h.html#a197223f1af3429bb18e22f71ef4d4b60">CTX_data_scene_set</a>(C, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#a878e239a8517075578f047442d1aa3d1">curscreen</a>-&gt;<a class="code" href="../../de/de7/structbScreen.html#a98cbd326f3b4179f769d007556e14999">scene</a>);
<a name="l00270"></a>00270         <a class="code" href="../../df/d01/BKE__context_8h.html#af38e3db529bba2578831bbe57940570b">CTX_wm_area_set</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00271"></a>00271         <a class="code" href="../../df/d01/BKE__context_8h.html#a2406677d500d1744af5e9e56c210590b">CTX_wm_region_set</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00272"></a>00272         <a class="code" href="../../df/d01/BKE__context_8h.html#a472d961c6c917b76140a73038341676e">CTX_wm_menu_set</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274     
<a name="l00275"></a>00275     <span class="comment">/* this can happen when active scene was lib-linked, and doesn&#39;t exist anymore */</span>
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C)==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00277"></a>00277         <a class="code" href="../../df/d01/BKE__context_8h.html#a197223f1af3429bb18e22f71ef4d4b60">CTX_data_scene_set</a>(C, bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a976062774f867fa0f917c23f2ec331bb">scene</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>);
<a name="l00278"></a>00278         <a class="code" href="../../df/d01/BKE__context_8h.html#aa054e49f38f3c9becfebc4013ecf457f">CTX_wm_screen</a>(C)-&gt;<a class="code" href="../../de/de7/structbScreen.html#a98cbd326f3b4179f769d007556e14999">scene</a>= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00279"></a>00279         curscene= <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="comment">/* special cases, override loaded flags: */</span>
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a0da0e1cf194f175f27e5af99964d2232">f</a> != bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af96ecf74af63b83903105e4ffc837fe2">globalf</a>) {
<a name="l00284"></a>00284         <span class="keyword">const</span> <span class="keywordtype">int</span> flags_keep = (<a class="code" href="../../d1/d8c/BKE__global_8h.html#aa49547b14c0a0c10e85c8562d1148ffb">G_SWAP_EXCHANGE</a> | <a class="code" href="../../d1/d8c/BKE__global_8h.html#a070f00cacf7dce298099127b5a4d634b">G_SCRIPT_AUTOEXEC</a> | <a class="code" href="../../d1/d8c/BKE__global_8h.html#ae077a005b44b385bd226d551b3abf3b1">G_SCRIPT_OVERRIDE_PREF</a>);
<a name="l00285"></a>00285         bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af96ecf74af63b83903105e4ffc837fe2">globalf</a>= (bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af96ecf74af63b83903105e4ffc837fe2">globalf</a> &amp; ~flags_keep) | (G.<a class="code" href="../../d9/d4c/structGlobal.html#a0da0e1cf194f175f27e5af99964d2232">f</a> &amp; flags_keep);
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     G.<a class="code" href="../../d9/d4c/structGlobal.html#a0da0e1cf194f175f27e5af99964d2232">f</a>= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af96ecf74af63b83903105e4ffc837fe2">globalf</a>;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (!G.<a class="code" href="../../d9/d4c/structGlobal.html#a883a65a1552d0cf3d06fe9ca7c30a6ab">background</a>) {
<a name="l00292"></a>00292         <span class="comment">//setscreen(G.curscreen);</span>
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     
<a name="l00295"></a>00295     <span class="comment">// FIXME: this version patching should really be part of the file-reading code, </span>
<a name="l00296"></a>00296     <span class="comment">// but we still get too many unrelated data-corruption crashes otherwise...</span>
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#abb6d63262cd2a22e6d18f962e052eefa">versionfile</a> &lt; 250)
<a name="l00298"></a>00298         <a class="code" href="../../db/d48/BKE__ipo_8h.html#aa3fcf10503e305a71e9df87ff61e8bab">do_versions_ipos_to_animato</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>);
<a name="l00299"></a>00299     
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (recover &amp;&amp; bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#aff5b3d60cfdb6c24dfdb18159928d857">filename</a>[0] &amp;&amp; G.<a class="code" href="../../d9/d4c/structGlobal.html#a105c6f806293b5e83136c08fd4e21f6e">relbase_valid</a>) {
<a name="l00301"></a>00301         <span class="comment">/* in case of autosave or quit.blend, use original filename instead</span>
<a name="l00302"></a>00302 <span class="comment">         * use relbase_valid to make sure the file is saved, else we get &lt;memory2&gt; in the filename */</span>
<a name="l00303"></a>00303         filepath= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#aff5b3d60cfdb6c24dfdb18159928d857">filename</a>;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 <span class="preprocessor">#if 0</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!G.<a class="code" href="../../d9/d4c/structGlobal.html#a105c6f806293b5e83136c08fd4e21f6e">relbase_valid</a>) {
<a name="l00307"></a>00307         <span class="comment">/* otherwise, use an empty string as filename, rather than &lt;memory2&gt; */</span>
<a name="l00308"></a>00308         filepath=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 <span class="preprocessor">#endif</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span>    
<a name="l00312"></a>00312     <span class="comment">/* these are the same at times, should never copy to the same location */</span>
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a> != filepath)
<a name="l00314"></a>00314         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, filepath, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">/* baseflags, groups, make depsgraph, etc */</span>
<a name="l00317"></a>00317     <a class="code" href="../../d8/d53/BKE__scene_8h.html#a2786d63921fc3176178dfaa36b5c814e">set_scene_bg</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>, <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C));
<a name="l00318"></a>00318     
<a name="l00319"></a>00319     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bfd);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     (void)curscene; <span class="comment">/* quiet warning */</span>
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad1f9cae9a87f04d084ce1779443031ee">00324</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/dcb/blender_8c.html#ad1f9cae9a87f04d084ce1779443031ee">handle_subversion_warning</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *<a class="code" href="../../d5/d95/makesdna_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (main-&gt;<a class="code" href="../../d0/dc0/structMain.html#a78def530ab43c43630d2d468e083cb83">minversionfile</a> &gt; <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5dffb3de6e078b72298ed826456c2272">BLENDER_VERSION</a> ||
<a name="l00327"></a>00327        (main-&gt;<a class="code" href="../../d0/dc0/structMain.html#a78def530ab43c43630d2d468e083cb83">minversionfile</a> == <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5dffb3de6e078b72298ed826456c2272">BLENDER_VERSION</a> &amp;&amp; 
<a name="l00328"></a>00328          main-&gt;<a class="code" href="../../d0/dc0/structMain.html#ab56fa441a433f58e9b0541d8f4f5c210">minsubversionfile</a> &gt; <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a01cbc3715abf12b99ea7892d911c3803">BLENDER_SUBVERSION</a>)) {
<a name="l00329"></a>00329         <a class="code" href="../../d2/d40/BKE__report_8h.html#af25c247b3b620d13cef87ec2bed1698e">BKE_reportf</a>(reports, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68a77427e7d5e1c0e3f2fbe37425794e319">RPT_ERROR</a>, <span class="stringliteral">&quot;File written by newer Blender binary: %d.%d , expect loss of data!&quot;</span>, main-&gt;<a class="code" href="../../d0/dc0/structMain.html#a78def530ab43c43630d2d468e083cb83">minversionfile</a>, main-&gt;<a class="code" href="../../d0/dc0/structMain.html#ab56fa441a433f58e9b0541d8f4f5c210">minsubversionfile</a>);
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="keywordflow">return</span> 1;
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad363219d1eafda17ff21f90fba2f56a8">00335</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/dcb/blender_8c.html#ad363219d1eafda17ff21f90fba2f56a8">keymap_item_free</a>(<a class="code" href="../../d1/d5e/structwmKeyMapItem.html">wmKeyMapItem</a> *kmi)
<a name="l00336"></a>00336 {
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#af438f7c1ba87d767332b810e2711ac14">properties</a>) {
<a name="l00338"></a>00338         <a class="code" href="../../d5/d95/BKE__idprop_8h.html#ac700fa8a94927f66ebc0c0e12378bbd1">IDP_FreeProperty</a>(kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#af438f7c1ba87d767332b810e2711ac14">properties</a>);
<a name="l00339"></a>00339         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#af438f7c1ba87d767332b810e2711ac14">properties</a>);
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#a17c86417e0dedf1a101de028ec6a2bd6">ptr</a>)
<a name="l00342"></a>00342         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#a17c86417e0dedf1a101de028ec6a2bd6">ptr</a>);
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad2d023073d9161f63cf16c9b9d67100c">00345</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#ad2d023073d9161f63cf16c9b9d67100c">BKE_userdef_free</a>(<span class="keywordtype">void</span>)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     <a class="code" href="../../d3/d90/structwmKeyMap.html">wmKeyMap</a> *km;
<a name="l00348"></a>00348     <a class="code" href="../../d1/d5e/structwmKeyMapItem.html">wmKeyMapItem</a> *kmi;
<a name="l00349"></a>00349     <a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html">wmKeyMapDiffItem</a> *kmdi;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="keywordflow">for</span> (km=U.<a class="code" href="../../d6/de3/structUserDef.html#a5e274bc131da7b1ce436e2ec513f27e8">user_keymaps</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; km; km=km-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#ac3bb52f35350d40470edbeadb43f2bba">next</a>) {
<a name="l00352"></a>00352         <span class="keywordflow">for</span> (kmdi=km-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#a7177a12403442c4ced5970fbc30eba7b">diff_items</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kmdi; kmdi=kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a8c54a042e7cc06a68be027eca355398e">next</a>) {
<a name="l00353"></a>00353             <span class="keywordflow">if</span> (kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a7ffaea212b8e4e053246bacb0c04c902">add_item</a>) {
<a name="l00354"></a>00354                 <a class="code" href="../../d3/dcb/blender_8c.html#ad363219d1eafda17ff21f90fba2f56a8">keymap_item_free</a>(kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a7ffaea212b8e4e053246bacb0c04c902">add_item</a>);
<a name="l00355"></a>00355                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a7ffaea212b8e4e053246bacb0c04c902">add_item</a>);
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a036ecd7f91293d701d03985bab2094e2">remove_item</a>) {
<a name="l00358"></a>00358                 <a class="code" href="../../d3/dcb/blender_8c.html#ad363219d1eafda17ff21f90fba2f56a8">keymap_item_free</a>(kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a036ecd7f91293d701d03985bab2094e2">remove_item</a>);
<a name="l00359"></a>00359                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kmdi-&gt;<a class="code" href="../../d8/d86/structwmKeyMapDiffItem.html#a036ecd7f91293d701d03985bab2094e2">remove_item</a>);
<a name="l00360"></a>00360             }
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">for</span> (kmi=km-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#a0ae48f8a4481c3faf008d60d6d61b4ad">items</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; kmi; kmi=kmi-&gt;<a class="code" href="../../d1/d5e/structwmKeyMapItem.html#a5cb105349fd3c21f73142d637602a75e">next</a>)
<a name="l00364"></a>00364             <a class="code" href="../../d3/dcb/blender_8c.html#ad363219d1eafda17ff21f90fba2f56a8">keymap_item_free</a>(kmi);
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;km-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#a7177a12403442c4ced5970fbc30eba7b">diff_items</a>);
<a name="l00367"></a>00367         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;km-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#a0ae48f8a4481c3faf008d60d6d61b4ad">items</a>);
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369     
<a name="l00370"></a>00370     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;U.<a class="code" href="../../d6/de3/structUserDef.html#a2c9ec4144be7ba5269bc78c80a743557">uistyles</a>);
<a name="l00371"></a>00371     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;U.<a class="code" href="../../d6/de3/structUserDef.html#aa371e14fd743804fbb452307e56dc0da">uifonts</a>);
<a name="l00372"></a>00372     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;U.<a class="code" href="../../d6/de3/structUserDef.html#a76335c6f572030d4bd8ebfaf5f0e85e0">themes</a>);
<a name="l00373"></a>00373     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;U.<a class="code" href="../../d6/de3/structUserDef.html#a5e274bc131da7b1ce436e2ec513f27e8">user_keymaps</a>);
<a name="l00374"></a>00374     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;U.<a class="code" href="../../d6/de3/structUserDef.html#a1194fdc9fddb18a7b31e676e76f1c4e6">addons</a>);
<a name="l00375"></a>00375 }
<a name="l00376"></a>00376 
<a name="l00377"></a><a class="code" href="../../d3/dcb/blender_8c.html#ab31b042e97fd263629a001975a00abd1">00377</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5fda32908981d0295ad537673d4982d9">BKE_read_file</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *filepath, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379     <a class="code" href="../../db/d57/structBlendFileData.html">BlendFileData</a> *bfd;
<a name="l00380"></a>00380     <span class="keywordtype">int</span> retval= <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a11b0341fbd37a75c1a1f293efcc83743">BKE_READ_FILE_OK</a>;
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">if</span> (strstr(filepath, <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a9fe0f66ff9f71c5fa3abe02a15ba3c48">BLENDER_STARTUP_FILE</a>)==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="comment">/* don&#39;t print user-pref loading */</span>
<a name="l00383"></a>00383         printf(<span class="stringliteral">&quot;read blend: %s\n&quot;</span>, filepath);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     bfd= <a class="code" href="../../da/d01/BLO__readfile_8h.html#ae5744dac8d441e0dcc0986765184f721">BLO_read_from_file</a>(filepath, reports);
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (bfd) {
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#af11d7e43345220a1e16989cab7dc55ef">user</a>) retval= <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a66f6ce3a3ba11979ea40cec130be3667">BKE_READ_FILE_OK_USERPREFS</a>;
<a name="l00388"></a>00388         
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (0==<a class="code" href="../../d3/dcb/blender_8c.html#ad1f9cae9a87f04d084ce1779443031ee">handle_subversion_warning</a>(bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>, reports)) {
<a name="l00390"></a>00390             <a class="code" href="../../d8/db1/BKE__library_8h.html#a7dacadb71dbdc69a89bbf5e61818e085">free_main</a>(bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>);
<a name="l00391"></a>00391             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bfd);
<a name="l00392"></a>00392             bfd= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00393"></a>00393             retval= <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a6bdfd68148d57ed17d5e4a80d9870f7c">BKE_READ_FILE_FAIL</a>;
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">else</span>
<a name="l00396"></a>00396             <a class="code" href="../../d3/dcb/blender_8c.html#a691581a77a4b1323d851f13789eac0d9">setup_app_data</a>(C, bfd, filepath); <span class="comment">// frees BFD</span>
<a name="l00397"></a>00397     } 
<a name="l00398"></a>00398     <span class="keywordflow">else</span>
<a name="l00399"></a>00399         <a class="code" href="../../d2/d40/BKE__report_8h.html#a98976a75827285688775c59a5d069662">BKE_reports_prependf</a>(reports, <span class="stringliteral">&quot;Loading %s failed: &quot;</span>, filepath);
<a name="l00400"></a>00400         
<a name="l00401"></a>00401     <span class="keywordflow">return</span> (bfd?retval:<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a6bdfd68148d57ed17d5e4a80d9870f7c">BKE_READ_FILE_FAIL</a>);
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 
<a name="l00404"></a><a class="code" href="../../d3/dcb/blender_8c.html#ab1848d51e41a614704cf78b1afc43b0c">00404</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#ad06387d2cfe255616d8b7208992773d1">BKE_read_file_from_memory</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">char</span>* filebuf, <span class="keywordtype">int</span> filelength, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406     <a class="code" href="../../db/d57/structBlendFileData.html">BlendFileData</a> *bfd;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     bfd= <a class="code" href="../../da/d01/BLO__readfile_8h.html#a3267d291a50fc2c79894a6106d475cbf">BLO_read_from_memory</a>(filebuf, filelength, reports);
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (bfd)
<a name="l00410"></a>00410         <a class="code" href="../../d3/dcb/blender_8c.html#a691581a77a4b1323d851f13789eac0d9">setup_app_data</a>(C, bfd, <span class="stringliteral">&quot;&lt;memory2&gt;&quot;</span>);
<a name="l00411"></a>00411     <span class="keywordflow">else</span>
<a name="l00412"></a>00412         <a class="code" href="../../d2/d40/BKE__report_8h.html#a77a7d159115958abb453160a869a17f1">BKE_reports_prepend</a>(reports, <span class="stringliteral">&quot;Loading failed: &quot;</span>);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414     <span class="keywordflow">return</span> (bfd?1:0);
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 <span class="comment">/* memfile is the undo buffer */</span>
<a name="l00418"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad6d5f1cbf6ac0d3fdba90a0a6db51db2">00418</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#abddc058a28228bb1dee88d88926a3823">BKE_read_file_from_memfile</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d7/d4d/structMemFile.html">MemFile</a> *memfile, <a class="code" href="../../df/df0/structReportList.html">ReportList</a> *reports)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420     <a class="code" href="../../db/d57/structBlendFileData.html">BlendFileData</a> *bfd;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     bfd= <a class="code" href="../../da/d01/BLO__readfile_8h.html#acf84d3c7c1bc87abcb9202a5aa9e41d0">BLO_read_from_memfile</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, memfile, reports);
<a name="l00423"></a>00423     <span class="keywordflow">if</span> (bfd)
<a name="l00424"></a>00424         <a class="code" href="../../d3/dcb/blender_8c.html#a691581a77a4b1323d851f13789eac0d9">setup_app_data</a>(C, bfd, <span class="stringliteral">&quot;&lt;memory1&gt;&quot;</span>);
<a name="l00425"></a>00425     <span class="keywordflow">else</span>
<a name="l00426"></a>00426         <a class="code" href="../../d2/d40/BKE__report_8h.html#a77a7d159115958abb453160a869a17f1">BKE_reports_prepend</a>(reports, <span class="stringliteral">&quot;Loading failed: &quot;</span>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">return</span> (bfd?1:0);
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">/* *****************  testing for break ************* */</span>
<a name="l00433"></a>00433 
<a name="l00434"></a><a class="code" href="../../d3/dcb/blender_8c.html#aab3046d22195086cdf8fb2243b55a5c9">00434</a> <span class="keyword">static</span> void (*<a class="code" href="../../d3/dcb/blender_8c.html#aab3046d22195086cdf8fb2243b55a5c9">blender_test_break_cb</a>)(void)= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00435"></a>00435 
<a name="l00436"></a><a class="code" href="../../d3/dcb/blender_8c.html#ac5e95513b693fa21fffc9f0585ab0579">00436</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#ac5e95513b693fa21fffc9f0585ab0579">set_blender_test_break_cb</a>(<span class="keywordtype">void</span> (*func)(<span class="keywordtype">void</span>) )
<a name="l00437"></a>00437 {
<a name="l00438"></a>00438     <a class="code" href="../../d3/dcb/blender_8c.html#aab3046d22195086cdf8fb2243b55a5c9">blender_test_break_cb</a>= func;
<a name="l00439"></a>00439 }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 
<a name="l00442"></a><a class="code" href="../../d3/dcb/blender_8c.html#a1ad141f46f0fb24cf83ba80060bacdf7">00442</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a1ad141f46f0fb24cf83ba80060bacdf7">blender_test_break</a>(<span class="keywordtype">void</span>)
<a name="l00443"></a>00443 {
<a name="l00444"></a>00444     <span class="keywordflow">if</span> (!G.<a class="code" href="../../d9/d4c/structGlobal.html#a883a65a1552d0cf3d06fe9ca7c30a6ab">background</a>) {
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (<a class="code" href="../../d3/dcb/blender_8c.html#aab3046d22195086cdf8fb2243b55a5c9">blender_test_break_cb</a>)
<a name="l00446"></a>00446             <a class="code" href="../../d3/dcb/blender_8c.html#aab3046d22195086cdf8fb2243b55a5c9">blender_test_break_cb</a>();
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     
<a name="l00449"></a>00449     <span class="keywordflow">return</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a9ec1d89d88059fce7e75b88ff170f3c9">afbreek</a>==1);
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="comment">/* ***************** GLOBAL UNDO *************** */</span>
<a name="l00454"></a>00454 
<a name="l00455"></a><a class="code" href="../../d3/dcb/blender_8c.html#a0920bd5bb5c2d92ca691d434289fdb2f">00455</a> <span class="preprocessor">#define UNDO_DISK   0</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span>
<a name="l00457"></a><a class="code" href="../../d3/dcb/blender_8c.html#a6c0f213e671c422b7d2cf41ac3650de4">00457</a> <span class="preprocessor">#define MAXUNDONAME 64</span>
<a name="l00458"></a><a class="code" href="../../d0/dbe/structUndoElem.html">00458</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> {
<a name="l00459"></a><a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">00459</a>     <span class="keyword">struct </span><a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>, *<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00460"></a><a class="code" href="../../d0/dbe/structUndoElem.html#a56f0003565914aebaaceffe5b952c724">00460</a>     <span class="keywordtype">char</span> <a class="code" href="../../d0/dbe/structUndoElem.html#a56f0003565914aebaaceffe5b952c724">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00461"></a><a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">00461</a>     <span class="keywordtype">char</span> <a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>[<a class="code" href="../../d3/dcb/blender_8c.html#a6c0f213e671c422b7d2cf41ac3650de4">MAXUNDONAME</a>];
<a name="l00462"></a><a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">00462</a>     <a class="code" href="../../d7/d4d/structMemFile.html">MemFile</a> <a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>;
<a name="l00463"></a><a class="code" href="../../d0/dbe/structUndoElem.html#afb20ed955425f6b657747c6d9b241a90">00463</a>     uintptr_t <a class="code" href="../../d0/dbe/structUndoElem.html#afb20ed955425f6b657747c6d9b241a90">undosize</a>;
<a name="l00464"></a>00464 } <a class="code" href="../../d3/dcb/blender_8c.html#add752c42bdc93d4e8cdcf5c60ec8632a">UndoElem</a>;
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad0ecd4b4b07265c1137cbb98833e4763">00466</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../d3/dcb/blender_8c.html#ad0ecd4b4b07265c1137cbb98833e4763">undobase</a>={<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00467"></a><a class="code" href="../../d3/dcb/blender_8c.html#abca337441a6a5f268b4294d8e75d2093">00467</a> <span class="keyword">static</span> <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *<a class="code" href="../../d3/dcb/blender_8c.html#abca337441a6a5f268b4294d8e75d2093">curundo</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="../../d3/dcb/blender_8c.html#aaec763b11483bb9c580747d004613a30">00470</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/dcb/blender_8c.html#aaec763b11483bb9c580747d004613a30">read_undosave</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     <span class="keywordtype">char</span> mainstr[<span class="keyword">sizeof</span>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>)];
<a name="l00473"></a>00473     <span class="keywordtype">int</span> success=0, fileflags;
<a name="l00474"></a>00474     
<a name="l00475"></a>00475     <span class="comment">/* This is needed so undoing/redoing doesn&#39;t crash with threaded previews going */</span>
<a name="l00476"></a>00476     <a class="code" href="../../d6/ddf/wm__jobs_8c.html#abaea8c8c7487ed85e8defacc9e81e205">WM_jobs_stop_all</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a5dcb9150a17a8907a3da33993063637e">CTX_wm_manager</a>(C));
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(mainstr, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, <span class="keyword">sizeof</span>(mainstr));    <span class="comment">/* temporal store */</span>
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     fileflags= G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a>;
<a name="l00481"></a>00481     G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a> |= <a class="code" href="../../d1/d8c/BKE__global_8h.html#a30ceab40e66804ac4b10d00ab95eb917">G_FILE_NO_UI</a>;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordflow">if</span> (<a class="code" href="../../d3/dcb/blender_8c.html#a0920bd5bb5c2d92ca691d434289fdb2f">UNDO_DISK</a>) 
<a name="l00484"></a>00484         success= (<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a5fda32908981d0295ad537673d4982d9">BKE_read_file</a>(C, uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a56f0003565914aebaaceffe5b952c724">str</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) != <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a6bdfd68148d57ed17d5e4a80d9870f7c">BKE_READ_FILE_FAIL</a>);
<a name="l00485"></a>00485     <span class="keywordflow">else</span>
<a name="l00486"></a>00486         success= <a class="code" href="../../d7/ddf/BKE__blender_8h.html#abddc058a28228bb1dee88d88926a3823">BKE_read_file_from_memfile</a>(C, &amp;uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">/* restore */</span>
<a name="l00489"></a>00489     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, mainstr, <span class="keyword">sizeof</span>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>)); <span class="comment">/* restore */</span>
<a name="l00490"></a>00490     G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a>= fileflags;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (success) {
<a name="l00493"></a>00493         <span class="comment">/* important not to update time here, else non keyed tranforms are lost */</span>
<a name="l00494"></a>00494         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a0dc07bc7e606045d217961fce6565efb">DAG_on_visible_update</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keywordflow">return</span> success;
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500 <span class="comment">/* name can be a dynamic string */</span>
<a name="l00501"></a><a class="code" href="../../d3/dcb/blender_8c.html#a351fa0e8f0a8a8b61946cc32ca4d94a0">00501</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#acc21da3c33beff7081fe407819b369fa">BKE_write_undo</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>)
<a name="l00502"></a>00502 {
<a name="l00503"></a>00503     uintptr_t maxmem, totmem, memused;
<a name="l00504"></a>00504     <span class="keywordtype">int</span> nr <span class="comment">/*, success */</span> <span class="comment">/* UNUSED */</span>;
<a name="l00505"></a>00505     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel;
<a name="l00506"></a>00506     
<a name="l00507"></a>00507     <span class="keywordflow">if</span> ( (U.<a class="code" href="../../d6/de3/structUserDef.html#aa879a6d2d58953c223cfecfbce03623b">uiflag</a> &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a32bbcf7e58a7e710fb5357bcc9da4f20">USER_GLOBALUNDO</a>)==0) <span class="keywordflow">return</span>;
<a name="l00508"></a>00508     <span class="keywordflow">if</span> ( U.<a class="code" href="../../d6/de3/structUserDef.html#a51f27fb812f4c5c0833a3e66ba469bfe">undosteps</a>==0) <span class="keywordflow">return</span>;
<a name="l00509"></a>00509     
<a name="l00510"></a>00510     <span class="comment">/* remove all undos after (also when curundo==NULL) */</span>
<a name="l00511"></a>00511     <span class="keywordflow">while</span> (undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> != curundo) {
<a name="l00512"></a>00512         uel= undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00513"></a>00513         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;undobase, uel);
<a name="l00514"></a>00514         <a class="code" href="../../dc/d5f/BLO__undofile_8h.html#a01252e61e89c0fc1fd97320dda67b0d2">BLO_free_memfile</a>(&amp;uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>);
<a name="l00515"></a>00515         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(uel);
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     
<a name="l00518"></a>00518     <span class="comment">/* make new */</span>
<a name="l00519"></a>00519     curundo= uel= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a>), <span class="stringliteral">&quot;undo file&quot;</span>);
<a name="l00520"></a>00520     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>, name, <span class="keyword">sizeof</span>(uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>));
<a name="l00521"></a>00521     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;undobase, uel);
<a name="l00522"></a>00522     
<a name="l00523"></a>00523     <span class="comment">/* and limit amount to the maximum */</span>
<a name="l00524"></a>00524     nr= 0;
<a name="l00525"></a>00525     uel= undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00526"></a>00526     <span class="keywordflow">while</span> (uel) {
<a name="l00527"></a>00527         nr++;
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (nr==U.<a class="code" href="../../d6/de3/structUserDef.html#a51f27fb812f4c5c0833a3e66ba469bfe">undosteps</a>) <span class="keywordflow">break</span>;
<a name="l00529"></a>00529         uel= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00530"></a>00530     }
<a name="l00531"></a>00531     <span class="keywordflow">if</span> (uel) {
<a name="l00532"></a>00532         <span class="keywordflow">while</span> (undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>!=uel) {
<a name="l00533"></a>00533             <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *first= undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00534"></a>00534             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;undobase, first);
<a name="l00535"></a>00535             <span class="comment">/* the merge is because of compression */</span>
<a name="l00536"></a>00536             <a class="code" href="../../dc/d5f/BLO__undofile_8h.html#a9872ecd575cc356c6d1e583c54db80c6">BLO_merge_memfile</a>(&amp;first-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>, &amp;first-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>);
<a name="l00537"></a>00537             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(first);
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="comment">/* disk save version */</span>
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (<a class="code" href="../../d3/dcb/blender_8c.html#a0920bd5bb5c2d92ca691d434289fdb2f">UNDO_DISK</a>) {
<a name="l00544"></a>00544         <span class="keyword">static</span> <span class="keywordtype">int</span> counter= 0;
<a name="l00545"></a>00545         <span class="keywordtype">char</span> filepath[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00546"></a>00546         <span class="keywordtype">char</span> numstr[32];
<a name="l00547"></a>00547         <span class="keywordtype">int</span> fileflags = G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a> &amp; ~(<a class="code" href="../../d1/d8c/BKE__global_8h.html#aa4dd2446eaf20c90d33a0e0dda77523b">G_FILE_HISTORY</a>); <span class="comment">/* don&#39;t do file history on undo */</span>
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         <span class="comment">/* calculate current filepath */</span>
<a name="l00550"></a>00550         counter++;
<a name="l00551"></a>00551         counter= counter % U.<a class="code" href="../../d6/de3/structUserDef.html#a51f27fb812f4c5c0833a3e66ba469bfe">undosteps</a>; 
<a name="l00552"></a>00552     
<a name="l00553"></a>00553         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(numstr, <span class="keyword">sizeof</span>(numstr), <span class="stringliteral">&quot;%d.blend&quot;</span>, counter);
<a name="l00554"></a>00554         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a6f32ac1a463a6322c25cb5c1615c4b1c">BLI_make_file_string</a>(<span class="stringliteral">&quot;/&quot;</span>, filepath, <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a86a333bbabf398f4d08f0a845f8d358e">BLI_temporary_dir</a>(), numstr);
<a name="l00555"></a>00555     
<a name="l00556"></a>00556         <span class="comment">/* success= */</span> <span class="comment">/* UNUSED */</span> <a class="code" href="../../d3/d5b/BLO__writefile_8h.html#ad9d0bbf0c43f00461ee808c6fe53dbf8">BLO_write_file</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), filepath, fileflags, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00557"></a>00557         
<a name="l00558"></a>00558         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a56f0003565914aebaaceffe5b952c724">str</a>, filepath, <span class="keyword">sizeof</span>(curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a56f0003565914aebaaceffe5b952c724">str</a>));
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span> {
<a name="l00561"></a>00561         <a class="code" href="../../d7/d4d/structMemFile.html">MemFile</a> *prevfile=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00562"></a>00562         
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>) prevfile= &amp;(curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>);
<a name="l00564"></a>00564         
<a name="l00565"></a>00565         memused= <a class="code" href="../../da/d2b/mallocn_8c.html#a49e4c87f566840081f93aa5c0db3cc20">MEM_get_memory_in_use</a>();
<a name="l00566"></a>00566         <span class="comment">/* success= */</span> <span class="comment">/* UNUSED */</span> <a class="code" href="../../d3/d5b/BLO__writefile_8h.html#afb6f5d4e08023408ccbdd3f22b7d2232">BLO_write_file_mem</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#ae849d2f7c2427ac6b75ee0c5ffcead6c">CTX_data_main</a>(C), prevfile, &amp;curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>, G.<a class="code" href="../../d9/d4c/structGlobal.html#acefe2f415097c0aa814071fb7017ac65">fileflags</a>);
<a name="l00567"></a>00567         curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#afb20ed955425f6b657747c6d9b241a90">undosize</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a49e4c87f566840081f93aa5c0db3cc20">MEM_get_memory_in_use</a>() - memused;
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     <span class="keywordflow">if</span> (U.<a class="code" href="../../d6/de3/structUserDef.html#a277feb62be02dd20a54b7870b1742ed0">undomemory</a> != 0) {
<a name="l00571"></a>00571         <span class="comment">/* limit to maximum memory (afterwards, we can&#39;t know in advance) */</span>
<a name="l00572"></a>00572         totmem= 0;
<a name="l00573"></a>00573         maxmem= ((uintptr_t)U.<a class="code" href="../../d6/de3/structUserDef.html#a277feb62be02dd20a54b7870b1742ed0">undomemory</a>)*1024*1024;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         <span class="comment">/* keep at least two (original + other) */</span>
<a name="l00576"></a>00576         uel= undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>;
<a name="l00577"></a>00577         <span class="keywordflow">while</span> (uel &amp;&amp; uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>) {
<a name="l00578"></a>00578             totmem+= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#afb20ed955425f6b657747c6d9b241a90">undosize</a>;
<a name="l00579"></a>00579             <span class="keywordflow">if</span> (totmem&gt;maxmem) <span class="keywordflow">break</span>;
<a name="l00580"></a>00580             uel= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="keywordflow">if</span> (uel) {
<a name="l00584"></a>00584             <span class="keywordflow">if</span> (uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a> &amp;&amp; uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>)
<a name="l00585"></a>00585                 uel= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587             <span class="keywordflow">while</span> (undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>!=uel) {
<a name="l00588"></a>00588                 <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *first= undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00589"></a>00589                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;undobase, first);
<a name="l00590"></a>00590                 <span class="comment">/* the merge is because of compression */</span>
<a name="l00591"></a>00591                 <a class="code" href="../../dc/d5f/BLO__undofile_8h.html#a9872ecd575cc356c6d1e583c54db80c6">BLO_merge_memfile</a>(&amp;first-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>, &amp;first-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>);
<a name="l00592"></a>00592                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(first);
<a name="l00593"></a>00593             }
<a name="l00594"></a>00594         }
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 <span class="comment">/* 1= an undo, -1 is a redo. we have to make sure &#39;curundo&#39; remains at current situation */</span>
<a name="l00599"></a><a class="code" href="../../d3/dcb/blender_8c.html#a59ede3e55d20fde9c2c04c180473fc83">00599</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#aa8f97638b96920e08ebcbbb888b8bf4a">BKE_undo_step</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">int</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a8bd9f841cf6ee6c256028a8a544fec3b">step</a>)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601     
<a name="l00602"></a>00602     <span class="keywordflow">if</span> (step==0) {
<a name="l00603"></a>00603         <a class="code" href="../../d3/dcb/blender_8c.html#aaec763b11483bb9c580747d004613a30">read_undosave</a>(C, curundo);
<a name="l00604"></a>00604     }
<a name="l00605"></a>00605     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (step==1) {
<a name="l00606"></a>00606         <span class="comment">/* curundo should never be NULL, after restart or load file it should call undo_save */</span>
<a name="l00607"></a>00607         <span class="keywordflow">if</span> (curundo==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ; <span class="comment">// XXX error(&quot;No undo available&quot;);</span>
<a name="l00608"></a>00608         <span class="keywordflow">else</span> {
<a name="l00609"></a>00609             <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a433234fb7331f1bba6516461ca164a94">debug</a> &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) printf(<span class="stringliteral">&quot;undo %s\n&quot;</span>, curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>);
<a name="l00610"></a>00610             curundo= curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00611"></a>00611             <a class="code" href="../../d3/dcb/blender_8c.html#aaec763b11483bb9c580747d004613a30">read_undosave</a>(C, curundo);
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614     <span class="keywordflow">else</span> {
<a name="l00615"></a>00615         <span class="comment">/* curundo has to remain current situation! */</span>
<a name="l00616"></a>00616         
<a name="l00617"></a>00617         <span class="keywordflow">if</span> (curundo==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ; <span class="comment">// XXX error(&quot;No redo available&quot;);</span>
<a name="l00618"></a>00618         <span class="keywordflow">else</span> {
<a name="l00619"></a>00619             <a class="code" href="../../d3/dcb/blender_8c.html#aaec763b11483bb9c580747d004613a30">read_undosave</a>(C, curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>);
<a name="l00620"></a>00620             curundo= curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>;
<a name="l00621"></a>00621             <span class="keywordflow">if</span> (G.<a class="code" href="../../d9/d4c/structGlobal.html#a433234fb7331f1bba6516461ca164a94">debug</a> &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a726ca809ffd3d67ab4b8476646f26635a1207ca157c84a6be5a8a36c691c4aa72">G_DEBUG</a>) printf(<span class="stringliteral">&quot;redo %s\n&quot;</span>, curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>);
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 }
<a name="l00625"></a>00625 
<a name="l00626"></a><a class="code" href="../../d3/dcb/blender_8c.html#abda95fd90c807785f81b5d2d0a77a042">00626</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#abda95fd90c807785f81b5d2d0a77a042">BKE_reset_undo</a>(<span class="keywordtype">void</span>)
<a name="l00627"></a>00627 {
<a name="l00628"></a>00628     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel;
<a name="l00629"></a>00629     
<a name="l00630"></a>00630     uel= undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00631"></a>00631     <span class="keywordflow">while</span> (uel) {
<a name="l00632"></a>00632         <a class="code" href="../../dc/d5f/BLO__undofile_8h.html#a01252e61e89c0fc1fd97320dda67b0d2">BLO_free_memfile</a>(&amp;uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>);
<a name="l00633"></a>00633         uel= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>;
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635     
<a name="l00636"></a>00636     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;undobase);
<a name="l00637"></a>00637     curundo= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00638"></a>00638 }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="comment">/* based on index nr it does a restore */</span>
<a name="l00641"></a><a class="code" href="../../d3/dcb/blender_8c.html#a4b2702f3c6ca5b88bf06380981b72a8f">00641</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a068130a8ce6bfbb4813116b970219911">BKE_undo_number</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keywordtype">int</span> nr)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643     curundo= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;undobase, nr);
<a name="l00644"></a>00644     <a class="code" href="../../d7/ddf/BKE__blender_8h.html#aa8f97638b96920e08ebcbbb888b8bf4a">BKE_undo_step</a>(C, 0);
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="comment">/* go back to the last occurance of name in stack */</span>
<a name="l00648"></a><a class="code" href="../../d3/dcb/blender_8c.html#a29f4f3538409676f3154ddb82d1de0cf">00648</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a07a1e3111d2e0f474d25f9eb2585b1fd">BKE_undo_name</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a00961439baf4a37452234779ece76842">BLI_rfindstring</a>(&amp;undobase, name, offsetof(<a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a>, name));
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (uel &amp;&amp; uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>) {
<a name="l00653"></a>00653         curundo= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00654"></a>00654         <a class="code" href="../../d7/ddf/BKE__blender_8h.html#aa8f97638b96920e08ebcbbb888b8bf4a">BKE_undo_step</a>(C, 0);
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">/* name optional */</span>
<a name="l00659"></a><a class="code" href="../../d3/dcb/blender_8c.html#aa50d584448974cf67c7d27cc44a93ceb">00659</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#aa50d584448974cf67c7d27cc44a93ceb">BKE_undo_valid</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (name) {
<a name="l00662"></a>00662         <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a00961439baf4a37452234779ece76842">BLI_rfindstring</a>(&amp;undobase, name, offsetof(<a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a>, name));
<a name="l00663"></a>00663         <span class="keywordflow">return</span> uel &amp;&amp; uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a64a8826f96795adbe11cd23b69ef50a9">prev</a>;
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665     
<a name="l00666"></a>00666     <span class="keywordflow">return</span> undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> != undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 <span class="comment">/* get name of undo item, return null if no item with this index */</span>
<a name="l00670"></a>00670 <span class="comment">/* if active pointer, set it to 1 if true */</span>
<a name="l00671"></a><a class="code" href="../../d3/dcb/blender_8c.html#a15adfe322df75502d6a691fd182814a1">00671</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a15adfe322df75502d6a691fd182814a1">BKE_undo_get_name</a>(<span class="keywordtype">int</span> nr, <span class="keywordtype">int</span> *active)
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;undobase, nr);
<a name="l00674"></a>00674     
<a name="l00675"></a>00675     <span class="keywordflow">if</span> (active) *active= 0;
<a name="l00676"></a>00676     
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (uel) {
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (active &amp;&amp; uel==curundo)
<a name="l00679"></a>00679             *active= 1;
<a name="l00680"></a>00680         <span class="keywordflow">return</span> uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>;
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="../../d3/dcb/blender_8c.html#a22165aa7c56d7c71a3a360b1a712840f">00685</a> <span class="keywordtype">char</span> *<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a22165aa7c56d7c71a3a360b1a712840f">BKE_undo_menu_string</a>(<span class="keywordtype">void</span>)
<a name="l00686"></a>00686 {
<a name="l00687"></a>00687     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel;
<a name="l00688"></a>00688     <a class="code" href="../../d4/de5/structDynStr.html">DynStr</a> *ds= <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#ae83ee20abb290558ce2e8f151ed54227">BLI_dynstr_new</a>();
<a name="l00689"></a>00689     <span class="keywordtype">char</span> *menu;
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a55db0fd7c4f2fd5714777dbbd56238b4">BLI_dynstr_append</a>(ds, <span class="stringliteral">&quot;Global Undo History %t&quot;</span>);
<a name="l00692"></a>00692     
<a name="l00693"></a>00693     <span class="keywordflow">for</span> (uel= undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; uel; uel= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#aabd817dcbdec597fc7a227e7bc6414d2">next</a>) {
<a name="l00694"></a>00694         <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a55db0fd7c4f2fd5714777dbbd56238b4">BLI_dynstr_append</a>(ds, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l00695"></a>00695         <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a55db0fd7c4f2fd5714777dbbd56238b4">BLI_dynstr_append</a>(ds, uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#a51144c842162a43061f1aaab07e968f3">name</a>);
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     menu= <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a4ec5498b239c83c6657f206d2f2f4968">BLI_dynstr_get_cstring</a>(ds);
<a name="l00699"></a>00699     <a class="code" href="../../d7/dc9/BLI__dynstr_8h.html#a3687f0d324bc2026a013872ce32d157a">BLI_dynstr_free</a>(ds);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="keywordflow">return</span> menu;
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="comment">/* saves quit.blend */</span>
<a name="l00705"></a><a class="code" href="../../d3/dcb/blender_8c.html#a639e1ed6541551779721f7a35057b3bc">00705</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/ddf/BKE__blender_8h.html#a639e1ed6541551779721f7a35057b3bc">BKE_undo_save_quit</a>(<span class="keywordtype">void</span>)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <a class="code" href="../../d0/dbe/structUndoElem.html">UndoElem</a> *uel;
<a name="l00708"></a>00708     <a class="code" href="../../de/dcc/structMemFileChunk.html">MemFileChunk</a> *chunk;
<a name="l00709"></a>00709     <span class="keywordtype">int</span> file;
<a name="l00710"></a>00710     <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     <span class="keywordflow">if</span> ( (U.<a class="code" href="../../d6/de3/structUserDef.html#aa879a6d2d58953c223cfecfbce03623b">uiflag</a> &amp; <a class="code" href="../../d7/de4/DNA__userdef__types_8h.html#a32bbcf7e58a7e710fb5357bcc9da4f20">USER_GLOBALUNDO</a>)==0) <span class="keywordflow">return</span>;
<a name="l00713"></a>00713     
<a name="l00714"></a>00714     uel= <a class="code" href="../../d3/dcb/blender_8c.html#abca337441a6a5f268b4294d8e75d2093">curundo</a>;
<a name="l00715"></a>00715     <span class="keywordflow">if</span> (uel==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00716"></a>00716         printf(<span class="stringliteral">&quot;No undo buffer to save recovery file\n&quot;</span>);
<a name="l00717"></a>00717         <span class="keywordflow">return</span>;
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719     
<a name="l00720"></a>00720     <span class="comment">/* no undo state to save */</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (undobase.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>==undobase.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>) <span class="keywordflow">return</span>;
<a name="l00722"></a>00722         
<a name="l00723"></a>00723     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a6f32ac1a463a6322c25cb5c1615c4b1c">BLI_make_file_string</a>(<span class="stringliteral">&quot;/&quot;</span>, str, <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a86a333bbabf398f4d08f0a845f8d358e">BLI_temporary_dir</a>(), <span class="stringliteral">&quot;quit.blend&quot;</span>);
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     file = <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a33346823641e2323fcf408264ceacaf2">BLI_open</a>(str,<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>+O_WRONLY+O_CREAT+O_TRUNC, 0666);
<a name="l00726"></a>00726     <span class="keywordflow">if</span> (file == -1) {
<a name="l00727"></a>00727         <span class="comment">//XXX error(&quot;Unable to save %s, check you have permissions&quot;, str);</span>
<a name="l00728"></a>00728         <span class="keywordflow">return</span>;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     chunk= uel-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>.<a class="code" href="../../d7/d4d/structMemFile.html#a4bb9689bf50409e227f1895ee436f590">chunks</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00732"></a>00732     <span class="keywordflow">while</span> (chunk) {
<a name="l00733"></a>00733         <span class="keywordflow">if</span> ( write(file, chunk-&gt;<a class="code" href="../../de/dcc/structMemFileChunk.html#accd9d2b757da5926b21d9b674fc9fe91">buf</a>, chunk-&gt;<a class="code" href="../../de/dcc/structMemFileChunk.html#aac0c6f97d1907349d29ec2b9ff5668d7">size</a>) != chunk-&gt;<a class="code" href="../../de/dcc/structMemFileChunk.html#aac0c6f97d1907349d29ec2b9ff5668d7">size</a>) <span class="keywordflow">break</span>;
<a name="l00734"></a>00734         chunk= chunk-&gt;<a class="code" href="../../de/dcc/structMemFileChunk.html#acfbcadd26265f9b24a576784d3edb6f5">next</a>;
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736     
<a name="l00737"></a>00737     close(file);
<a name="l00738"></a>00738     
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (chunk) ; <span class="comment">//XXX error(&quot;Unable to save %s, internal error&quot;, str);</span>
<a name="l00740"></a>00740     <span class="keywordflow">else</span> printf(<span class="stringliteral">&quot;Saved session recovery to %s\n&quot;</span>, str);
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="comment">/* sets curscene */</span>
<a name="l00744"></a><a class="code" href="../../d3/dcb/blender_8c.html#ad7956d2084d5a054bfcb873a690a7555">00744</a> <a class="code" href="../../d0/dc0/structMain.html">Main</a> *<a class="code" href="../../d7/ddf/BKE__blender_8h.html#a8a8bcef664c410bd82075d0a540c4b52">BKE_undo_get_main</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> **scene)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *mainp= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00747"></a>00747     <a class="code" href="../../db/d57/structBlendFileData.html">BlendFileData</a> *bfd= <a class="code" href="../../da/d01/BLO__readfile_8h.html#acf84d3c7c1bc87abcb9202a5aa9e41d0">BLO_read_from_memfile</a>(G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>, G.<a class="code" href="../../d9/d4c/structGlobal.html#a58e65953cbfdd35418d1bcad2c47879e">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>, &amp;curundo-&gt;<a class="code" href="../../d0/dbe/structUndoElem.html#ad0b2f797c6c0e75519ac05c0c9ce29f5">memfile</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00748"></a>00748     
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (bfd) {
<a name="l00750"></a>00750         mainp= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ae7127e54861595c3050bb298140997cf">main</a>;
<a name="l00751"></a>00751         <span class="keywordflow">if</span> (scene)
<a name="l00752"></a>00752             *scene= bfd-&gt;<a class="code" href="../../db/d57/structBlendFileData.html#ab73859890567227939cc23bafc1431a2">curscene</a>;
<a name="l00753"></a>00753         
<a name="l00754"></a>00754         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(bfd);
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756     
<a name="l00757"></a>00757     <span class="keywordflow">return</span> mainp;
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:03 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
