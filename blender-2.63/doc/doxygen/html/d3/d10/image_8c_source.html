<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: image.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">image.c</div>  </div>
</div>
<div class="contents">
<a href="../../d3/d10/image_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * Contributor(s): Blender Foundation, 2006, full recode</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#ifndef WIN32 </span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#else</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;io.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#define open _open</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define close _close</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d7/d13/openexr__multi_8h.html">intern/openexr/openexr_multi.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#endif</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d4d/DNA__packedFile__types_8h.html">DNA_packedFile_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d3b/DNA__camera__types_8h.html">DNA_camera_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/da9/DNA__sequence__types_8h.html">DNA_sequence_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/de4/DNA__userdef__types_8h.html">DNA_userdef_types.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d37/DNA__brush__types_8h.html">DNA_brush_types.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd1/BLI__bpath_8h.html">BLI_bpath.h</a>&quot;</span>
<a name="l00071"></a>00071 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d20/BKE__bmfont_8h.html">BKE_bmfont.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d32/BKE__icons_8h.html">BKE_icons.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4a/BKE__packedFile_8h.html">BKE_packedFile.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d53/BKE__scene_8h.html">BKE_scene.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d91/BKE__node_8h.html">BKE_node.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d5f/BKE__sequencer_8h.html">BKE_sequencer.h</a>&quot;</span> <span class="comment">/* seq_foreground_frame_get() */</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d5d/BLF__api_8h.html">BLF_api.h</a>&quot;</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d2e/PIL__time_8h.html">PIL_time.h</a>&quot;</span>
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/dfd/RE__pipeline_8h.html">RE_pipeline.h</a>&quot;</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/df0/GPU__draw_8h.html">GPU_draw.h</a>&quot;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d59/BLO__sys__types_8h.html">BLO_sys_types.h</a>&quot;</span> <span class="comment">// for intptr_t support</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="comment">/* max int, to indicate we don&#39;t store sequences in ibuf */</span>
<a name="l00095"></a><a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">00095</a> <span class="preprocessor">#define IMA_NO_INDEX    0x7FEFEFEF</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a>00097 <span class="comment">/* quick lookup: supports 1 million frames, thousand passes */</span>
<a name="l00098"></a><a class="code" href="../../d3/d10/image_8c.html#a098c0cac9fcc81855179316e445e1c0e">00098</a> <span class="preprocessor">#define IMA_MAKE_INDEX(frame, index)    ((frame)&lt;&lt;10)+index</span>
<a name="l00099"></a><a class="code" href="../../d3/d10/image_8c.html#a171aeff9b3519a39d2321a61ba1eee32">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define IMA_INDEX_FRAME(index)          (index&gt;&gt;10)</span>
<a name="l00100"></a><a class="code" href="../../d3/d10/image_8c.html#ac660b4cb2d174abd716c85c6be4044c1">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define IMA_INDEX_PASS(index)           (index &amp; ~1023)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a>00102 <span class="comment">/* ******** IMAGE PROCESSING ************* */</span>
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="../../d3/d10/image_8c.html#a7f0f36d355c6738f800663d16f518753">00104</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#a7f0f36d355c6738f800663d16f518753">de_interlace_ng</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf) <span class="comment">/* neogeo fields */</span>
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> * tbuf1, * tbuf2;
<a name="l00107"></a>00107     
<a name="l00108"></a>00108     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) <span class="keywordflow">return</span>;
<a name="l00110"></a>00110     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>;
<a name="l00111"></a>00111     
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l00113"></a>00113         <span class="comment">/* make copies */</span>
<a name="l00114"></a>00114         tbuf1 = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (<span class="keywordtype">short</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> &gt;&gt; 1), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)32, (<span class="keywordtype">int</span>)<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00115"></a>00115         tbuf2 = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (<span class="keywordtype">short</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> &gt;&gt; 1), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)32, (<span class="keywordtype">int</span>)IB_rect);
<a name="l00116"></a>00116         
<a name="l00117"></a>00117         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> *= 2;
<a name="l00118"></a>00118         
<a name="l00119"></a>00119         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tbuf1, ibuf, 0, 0, 0, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00120"></a>00120         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tbuf2, ibuf, 0, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00121"></a>00121         
<a name="l00122"></a>00122         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> /= 2;
<a name="l00123"></a>00123         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(ibuf, tbuf1, 0, 0, 0, 0, tbuf1-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, tbuf1-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00124"></a>00124         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(ibuf, tbuf2, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 0, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00125"></a>00125         
<a name="l00126"></a>00126         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tbuf1);
<a name="l00127"></a>00127         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tbuf2);
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> /= 2;
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="../../d3/d10/image_8c.html#a383b7d8fe6893205d5892d38b5d0519c">00132</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#a383b7d8fe6893205d5892d38b5d0519c">de_interlace_st</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf) <span class="comment">/* standard fields */</span>
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> * tbuf1, * tbuf2;
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>) <span class="keywordflow">return</span>;
<a name="l00138"></a>00138     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a8daeb3bec2dd03922b4125f809cd58d4" title="Flag defining the components of the ImBuf struct.">IB_fields</a>;
<a name="l00139"></a>00139     
<a name="l00140"></a>00140     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l00141"></a>00141         <span class="comment">/* make copies */</span>
<a name="l00142"></a>00142         tbuf1 = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (<span class="keywordtype">short</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> &gt;&gt; 1), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00143"></a>00143         tbuf2 = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, (<span class="keywordtype">short</span>)(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> &gt;&gt; 1), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00144"></a>00144         
<a name="l00145"></a>00145         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> *= 2;
<a name="l00146"></a>00146         
<a name="l00147"></a>00147         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tbuf1, ibuf, 0, 0, 0, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00148"></a>00148         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(tbuf2, ibuf, 0, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, 0, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00149"></a>00149         
<a name="l00150"></a>00150         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> /= 2;
<a name="l00151"></a>00151         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(ibuf, tbuf2, 0, 0, 0, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00152"></a>00152         <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(ibuf, tbuf1, 0, tbuf2-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>, 0, 0, tbuf1-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, tbuf1-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l00153"></a>00153         
<a name="l00154"></a>00154         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tbuf1);
<a name="l00155"></a>00155         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(tbuf2);
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> /= 2;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="../../d3/d10/image_8c.html#a5988cda832062dd7a2de62357dcfc1e8">00160</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#aa4b9c5704e8f369a08d34239b68536e4">image_de_interlace</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <span class="keywordtype">int</span> odd)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(ima, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (ibuf) {
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (odd)
<a name="l00165"></a>00165             <a class="code" href="../../d3/d10/image_8c.html#a383b7d8fe6893205d5892d38b5d0519c">de_interlace_st</a>(ibuf);
<a name="l00166"></a>00166         <span class="keywordflow">else</span>
<a name="l00167"></a>00167             <a class="code" href="../../d3/d10/image_8c.html#a7f0f36d355c6738f800663d16f518753">de_interlace_ng</a>(ibuf);
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="comment">/* ***************** ALLOC &amp; FREE, DATA MANAGING *************** */</span>
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">00173</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="keywordflow">while</span> ((ibuf = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l00178"></a>00178         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, ibuf);
<a name="l00179"></a>00179         
<a name="l00180"></a>00180         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>) {
<a name="l00181"></a>00181             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>);
<a name="l00182"></a>00182             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a26badb7e7f07e5f747cfceca2ebbb3c7">IMB_free_anim</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>);
<a name="l00188"></a>00188     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l00191"></a>00191         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a9db5615079ab1315b62597db8f75db54">RE_FreeRenderResult</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>);
<a name="l00192"></a>00192         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00193"></a>00193     }   
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(ima);
<a name="l00196"></a>00196     
<a name="l00197"></a>00197     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a6331a69cd5393c1db32cfb154e6ce0ae">IMA_OK</a>;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="comment">/* called by library too, do not free ima itself */</span>
<a name="l00201"></a><a class="code" href="../../d3/d10/image_8c.html#a78de5f4d3cf8343933413c61db84c6c8">00201</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ad5ea71b77da065d75c7c87103b61e674">free_image</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203     <span class="keywordtype">int</span> a;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>) {
<a name="l00207"></a>00207         <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>);
<a name="l00208"></a>00208         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <a class="code" href="../../d4/d32/BKE__icons_8h.html#acb05ae9e066a07044482f5b7c6312264">BKE_icon_delete</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00211"></a>00211     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#a96ccc1fe1ead32713548f274b39eb4e2">icon_id</a> = 0;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <a class="code" href="../../d4/d32/BKE__icons_8h.html#a4b6858e5df40aefe6c016aef8aef2082">BKE_previewimg_free</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a1c97663701a45c784752d88b3e9b1749">preview</a>);
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="keywordflow">for</span> (a=0; a&lt;<a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad925558a1ce78f2ac54939303d72f771">IMA_MAX_RENDER_SLOT</a>; a++) {
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[a]) {
<a name="l00217"></a>00217             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a9db5615079ab1315b62597db8f75db54">RE_FreeRenderResult</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[a]);
<a name="l00218"></a>00218             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[a]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="comment">/* only image block itself */</span>
<a name="l00224"></a><a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">00224</a> <span class="keyword">static</span> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keywordtype">short</span> source, <span class="keywordtype">short</span> type)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00227"></a>00227     
<a name="l00228"></a>00228     ima= <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a564eac75543b047cf8b2b759818529c3">ID_IM</a>, name);
<a name="l00229"></a>00229     <span class="keywordflow">if</span> (ima) {
<a name="l00230"></a>00230         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a6331a69cd5393c1db32cfb154e6ce0ae">IMA_OK</a>;
<a name="l00231"></a>00231         
<a name="l00232"></a>00232         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a4a8434eea71145fbb4de56f4b65e201d">xrep</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2e13fd1505d81eadcb27ba03f90797cc">yrep</a>= 1;
<a name="l00233"></a>00233         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aa316a0e981811d7eaa7b413e812fc4d8">aspx</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5cdb91d931b057cb5bb7ac683e5598a2">aspy</a>= 1.0;
<a name="l00234"></a>00234         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>= 1024; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>= 1024;
<a name="l00235"></a>00235         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>= 1;   <span class="comment">/* no defines yet? */</span>
<a name="l00236"></a>00236         
<a name="l00237"></a>00237         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>= source;
<a name="l00238"></a>00238         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= type;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     <span class="keywordflow">return</span> ima;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="comment">/* get the ibuf from an image cache, local use here only */</span>
<a name="l00244"></a><a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">00244</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>, <span class="keywordtype">int</span> frame)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <span class="comment">/* this function is intended to be thread safe. with IMA_NO_INDEX this</span>
<a name="l00247"></a>00247 <span class="comment">     * should be OK, but when iterating over the list this is more tricky</span>
<a name="l00248"></a>00248 <span class="comment">     * */</span>
<a name="l00249"></a>00249     <span class="keywordflow">if</span> (index==<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>)
<a name="l00250"></a>00250         <span class="keywordflow">return</span> ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00251"></a>00251     <span class="keywordflow">else</span> {
<a name="l00252"></a>00252         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         index= <a class="code" href="../../d3/d10/image_8c.html#a098c0cac9fcc81855179316e445e1c0e">IMA_MAKE_INDEX</a>(frame, index);
<a name="l00255"></a>00255         <span class="keywordflow">for</span> (ibuf= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>)
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>==index)
<a name="l00257"></a>00257                 <span class="keywordflow">return</span> ibuf;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/* no ima-&gt;ibuf anymore, but listbase */</span>
<a name="l00264"></a><a class="code" href="../../d3/d10/image_8c.html#aadc6ac0d518bc6b131b9abb668be673c">00264</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#aadc6ac0d518bc6b131b9abb668be673c">image_remove_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (ibuf) {
<a name="l00267"></a>00267         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, ibuf);
<a name="l00268"></a>00268         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l00269"></a>00269     }
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="comment">/* no ima-&gt;ibuf anymore, but listbase */</span>
<a name="l00274"></a><a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">00274</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>, <span class="keywordtype">int</span> frame)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (ibuf) {
<a name="l00277"></a>00277         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d0/dea/sp__coletree_8c.html#aaa63f127f8b967960d824c4cf6e93ca0">link</a>;
<a name="l00278"></a>00278         
<a name="l00279"></a>00279         <span class="keywordflow">if</span> (index!=<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>)
<a name="l00280"></a>00280             index= <a class="code" href="../../d3/d10/image_8c.html#a098c0cac9fcc81855179316e445e1c0e">IMA_MAKE_INDEX</a>(frame, index);
<a name="l00281"></a>00281         
<a name="l00282"></a>00282         <span class="comment">/* insert based on index */</span>
<a name="l00283"></a>00283         <span class="keywordflow">for</span> (link= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; link; link= link-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>)
<a name="l00284"></a>00284             <span class="keywordflow">if</span> (link-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>&gt;=index)
<a name="l00285"></a>00285                 <span class="keywordflow">break</span>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>= <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a18aa1bbdda58d1c670134dba750b935d">IMA_CM_PREDIVIDE</a>)
<a name="l00289"></a>00289             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aaee35f2986414382c12d2a75cefbddd1" title="Flag defining the components of the ImBuf struct.">IB_cm_predivide</a>;
<a name="l00290"></a>00290         <span class="keywordflow">else</span>
<a name="l00291"></a>00291             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aaee35f2986414382c12d2a75cefbddd1" title="Flag defining the components of the ImBuf struct.">IB_cm_predivide</a>;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="comment">/* this function accepts link==NULL */</span>
<a name="l00294"></a>00294         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a168dc4cffe5e3a86086f3cfc4f7b95e6">BLI_insertlinkbefore</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, link, ibuf);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         <span class="comment">/* now we don&#39;t want copies? */</span>
<a name="l00297"></a>00297         <span class="keywordflow">if</span> (link &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>==link-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>)
<a name="l00298"></a>00298             <a class="code" href="../../d3/d10/image_8c.html#aadc6ac0d518bc6b131b9abb668be673c">image_remove_ibuf</a>(ima, link);
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="comment">/* empty image block, of similar type and filename */</span>
<a name="l00303"></a><a class="code" href="../../d3/d10/image_8c.html#ade23f83bea688148ee634f5184248443">00303</a> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a8b98395ade63f058d251d705c6fc6395">copy_image</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *nima= <a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(nima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="keyword">sizeof</span>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a>;
<a name="l00310"></a>00310     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a>;
<a name="l00311"></a>00311     
<a name="l00312"></a>00312     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>;
<a name="l00313"></a>00313     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>;
<a name="l00314"></a>00314     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#a4d2f39810177923c60e6e96ef06924f7">animspeed</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a4d2f39810177923c60e6e96ef06924f7">animspeed</a>;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#aa316a0e981811d7eaa7b413e812fc4d8">aspx</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aa316a0e981811d7eaa7b413e812fc4d8">aspx</a>;
<a name="l00319"></a>00319     nima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5cdb91d931b057cb5bb7ac683e5598a2">aspy</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5cdb91d931b057cb5bb7ac683e5598a2">aspy</a>;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <span class="keywordflow">return</span> nima;
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="../../d3/d10/image_8c.html#ac7a755b4f92e332e2bc86fafa50c774d">00324</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#ac7a755b4f92e332e2bc86fafa50c774d">extern_local_image</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ima))
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326     <span class="comment">/* Nothing to do: images don&#39;t link to other IDs. This function exists to</span>
<a name="l00327"></a>00327 <span class="comment">     * match id_make_local pattern. */</span>
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a><a class="code" href="../../d3/d10/image_8c.html#a5acd02fa244e35567f6c5fa97beda099">00330</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a5acd02fa244e35567f6c5fa97beda099">make_local_image</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     <a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main;
<a name="l00333"></a>00333     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00334"></a>00334     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush;
<a name="l00335"></a>00335     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00336"></a>00336     <span class="keywordtype">int</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">/* - only lib users: do nothing</span>
<a name="l00339"></a>00339 <span class="comment">     * - only local users: set flag</span>
<a name="l00340"></a>00340 <span class="comment">     * - mixed: make copy</span>
<a name="l00341"></a>00341 <span class="comment">     */</span>
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="comment">/* Can&#39;t take short cut here: must check meshes at least because of bogus</span>
<a name="l00346"></a>00346 <span class="comment">     * texface ID refs. - z0r */</span>
<a name="l00347"></a>00347 <span class="preprocessor">#if 0</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>==1) {
<a name="l00349"></a>00349         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00350"></a>00350         <a class="code" href="../../d3/d10/image_8c.html#ac7a755b4f92e332e2bc86fafa50c774d">extern_local_image</a>(ima);
<a name="l00351"></a>00351         <span class="keywordflow">return</span>;
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353 <span class="preprocessor">#endif</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>
<a name="l00355"></a>00355     <span class="keywordflow">for</span> (tex= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tex; tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a> == ima) {
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00358"></a>00358             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361     <span class="keywordflow">for</span> (brush= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a6f40decaf705d18b809d98637fee11f4">brush</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; brush; brush= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00362"></a>00362         <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a> == ima) {
<a name="l00363"></a>00363             <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00364"></a>00364             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367     <span class="keywordflow">for</span> (me= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a4d23e4db096dd08321b0081f9f7ac4a0">mesh</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; me; me= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>) {
<a name="l00369"></a>00369             <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface;
<a name="l00370"></a>00370             <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372             <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#ae5b4833527392742d84e8f7b46f5f264">totlayer</a>; i++) {
<a name="l00373"></a>00373                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>) {
<a name="l00374"></a>00374                     tface= (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376                     for (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a++, tface++) {
<a name="l00377"></a>00377                         <span class="keywordflow">if</span> (tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a> == ima) {
<a name="l00378"></a>00378                             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00379"></a>00379                             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00380"></a>00380                         }
<a name="l00381"></a>00381                     }
<a name="l00382"></a>00382                 }
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a33e1a6e421ec6271ac147aea17092ec1">mtpoly</a>) {
<a name="l00387"></a>00387             <a class="code" href="../../de/d88/structMTexPoly.html">MTexPoly</a> *mtpoly;
<a name="l00388"></a>00388             <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00389"></a>00389 
<a name="l00390"></a>00390             <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;pdata.totlayer; i++) {
<a name="l00391"></a>00391                 <span class="keywordflow">if</span> (me-&gt;pdata.layers[i].type == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05731a08cef6d81e74c221963ae25712">CD_MTEXPOLY</a>) {
<a name="l00392"></a>00392                     mtpoly= (<a class="code" href="../../de/d88/structMTexPoly.html">MTexPoly</a>*)me-&gt;pdata.layers[i].data;
<a name="l00393"></a>00393 
<a name="l00394"></a>00394                     for (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; a++, mtpoly++) {
<a name="l00395"></a>00395                         <span class="keywordflow">if</span> (mtpoly-&gt;<a class="code" href="../../de/d88/structMTexPoly.html#acd90db38c741566c1f6adcdf59799b46">tpage</a> == ima) {
<a name="l00396"></a>00396                             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) is_lib= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00397"></a>00397                             <span class="keywordflow">else</span> is_local= <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00398"></a>00398                         }
<a name="l00399"></a>00399                     }
<a name="l00400"></a>00400                 }
<a name="l00401"></a>00401             }
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00407"></a>00407         <a class="code" href="../../d8/db1/BKE__library_8h.html#a668f0934d813d85c7920735e681fb2b1">id_clear_lib_data</a>(bmain, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00408"></a>00408         <a class="code" href="../../d3/d10/image_8c.html#ac7a755b4f92e332e2bc86fafa50c774d">extern_local_image</a>(ima);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_local &amp;&amp; is_lib) {
<a name="l00411"></a>00411         <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima_new= <a class="code" href="../../d2/d77/BKE__image_8h.html#a8b98395ade63f058d251d705c6fc6395">copy_image</a>(ima);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>= 0;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         <span class="comment">/* Remap paths of new ID using old library as base. */</span>
<a name="l00416"></a>00416         <a class="code" href="../../d8/db1/BKE__library_8h.html#a28231f1e4d5edb6c8498db449bda4528">BKE_id_lib_local_paths</a>(bmain, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>, &amp;ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         tex= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00419"></a>00419         <span class="keywordflow">while</span> (tex) {
<a name="l00420"></a>00420             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00421"></a>00421                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>==ima) {
<a name="l00422"></a>00422                     tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a> = ima_new;
<a name="l00423"></a>00423                     ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00424"></a>00424                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00425"></a>00425                 }
<a name="l00426"></a>00426             }
<a name="l00427"></a>00427             tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00428"></a>00428         }
<a name="l00429"></a>00429         brush= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a6f40decaf705d18b809d98637fee11f4">brush</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00430"></a>00430         <span class="keywordflow">while</span> (brush) {
<a name="l00431"></a>00431             <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00432"></a>00432                 <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a>==ima) {
<a name="l00433"></a>00433                     brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a15f49f4f869d830a7790726017395b31">clone</a>.<a class="code" href="../../db/d3d/structBrushClone.html#a5786aeede42c79da77f44c8a7ed27650">image</a> = ima_new;
<a name="l00434"></a>00434                     ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;
<a name="l00435"></a>00435                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>--;
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438             brush= brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a853736fc6943d266e72d96080bccf6f0">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440         <span class="comment">/* Transfer references in texfaces. Texfaces don&#39;t add to image ID</span>
<a name="l00441"></a>00441 <span class="comment">         * user count *unless* there are no other users. See</span>
<a name="l00442"></a>00442 <span class="comment">         * readfile.c:lib_link_mtface. */</span>
<a name="l00443"></a>00443         me= bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a4d23e4db096dd08321b0081f9f7ac4a0">mesh</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00444"></a>00444         <span class="keywordflow">while</span> (me) {
<a name="l00445"></a>00445             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>) {
<a name="l00446"></a>00446                 <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface;
<a name="l00447"></a>00447                 <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449                 <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#ae5b4833527392742d84e8f7b46f5f264">totlayer</a>; i++) {
<a name="l00450"></a>00450                     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a1ba604969c785bba31ef501e7a06cc9c">type</a> == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#af23f4c9ba200ae24e0a1ac80464e7b21">CD_MTFACE</a>) {
<a name="l00451"></a>00451                         tface= (<a class="code" href="../../da/d7f/structMTFace.html">MTFace</a>*)me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>.<a class="code" href="../../df/d04/structCustomData.html#a91813d4d92a1349830c9b1e554cf7af6">layers</a>[i].<a class="code" href="../../d5/d97/structCustomDataLayer.html#a96b03d545e94aacd77c467efb04b1153">data</a>;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                         for (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a++, tface++) {    
<a name="l00454"></a>00454                             <span class="keywordflow">if</span> (tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a> == ima) {
<a name="l00455"></a>00455                                 tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a> = ima_new;
<a name="l00456"></a>00456                                 <span class="keywordflow">if</span> (ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> == 0) {
<a name="l00457"></a>00457                                     tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a94b886f25499ad61afed79c6362451ef">tpage</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>= 1;
<a name="l00458"></a>00458                                 }
<a name="l00459"></a>00459                                 <a class="code" href="../../d8/db1/BKE__library_8h.html#a43e37bd819b3a44520ff6fbfd9e8962d">id_lib_extern</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a>*)ima_new);
<a name="l00460"></a>00460                             }
<a name="l00461"></a>00461                         }
<a name="l00462"></a>00462                     }
<a name="l00463"></a>00463                 }
<a name="l00464"></a>00464             }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a33e1a6e421ec6271ac147aea17092ec1">mtpoly</a>) {
<a name="l00467"></a>00467                 <a class="code" href="../../de/d88/structMTexPoly.html">MTexPoly</a> *mtpoly;
<a name="l00468"></a>00468                 <span class="keywordtype">int</span> a, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470                 <span class="keywordflow">for</span> (i=0; i&lt;me-&gt;pdata.totlayer; i++) {
<a name="l00471"></a>00471                     <span class="keywordflow">if</span> (me-&gt;pdata.layers[i].type == <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a05731a08cef6d81e74c221963ae25712">CD_MTEXPOLY</a>) {
<a name="l00472"></a>00472                         mtpoly= (<a class="code" href="../../de/d88/structMTexPoly.html">MTexPoly</a>*)me-&gt;pdata.layers[i].data;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474                         for (a=0; a&lt;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; a++, mtpoly++) {
<a name="l00475"></a>00475                             <span class="keywordflow">if</span> (mtpoly-&gt;<a class="code" href="../../de/d88/structMTexPoly.html#acd90db38c741566c1f6adcdf59799b46">tpage</a> == ima) {
<a name="l00476"></a>00476                                 mtpoly-&gt;<a class="code" href="../../de/d88/structMTexPoly.html#acd90db38c741566c1f6adcdf59799b46">tpage</a> = ima_new;
<a name="l00477"></a>00477                                 <span class="keywordflow">if</span> (ima_new-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> == 0) {
<a name="l00478"></a>00478                                     mtpoly-&gt;<a class="code" href="../../de/d88/structMTexPoly.html#acd90db38c741566c1f6adcdf59799b46">tpage</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>= 1;
<a name="l00479"></a>00479                                 }
<a name="l00480"></a>00480                                 <a class="code" href="../../d8/db1/BKE__library_8h.html#a43e37bd819b3a44520ff6fbfd9e8962d">id_lib_extern</a>((<a class="code" href="../../d8/d7e/structID.html">ID</a>*)ima_new);
<a name="l00481"></a>00481                             }
<a name="l00482"></a>00482                         }
<a name="l00483"></a>00483                     }
<a name="l00484"></a>00484                 }
<a name="l00485"></a>00485             }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487             me= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00488"></a>00488         }
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a><a class="code" href="../../d3/d10/image_8c.html#af5c2619b395fdd52973a4b3fce3ae4a4">00492</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#addaa5acc743631fba6cf4ec2eda4efb7">BKE_image_merge</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *dest, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *source)
<a name="l00493"></a>00493 {
<a name="l00494"></a>00494     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00495"></a>00495     
<a name="l00496"></a>00496     <span class="comment">/* sanity check */</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (dest &amp;&amp; source &amp;&amp; dest!=source) {
<a name="l00498"></a>00498     
<a name="l00499"></a>00499         <span class="keywordflow">while</span> ((ibuf= source-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)) {
<a name="l00500"></a>00500             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;source-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, ibuf);
<a name="l00501"></a>00501             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(dest, ibuf, <a class="code" href="../../d3/d10/image_8c.html#ac660b4cb2d174abd716c85c6be4044c1">IMA_INDEX_PASS</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>), <a class="code" href="../../d3/d10/image_8c.html#a171aeff9b3519a39d2321a61ba1eee32">IMA_INDEX_FRAME</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>));
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503         
<a name="l00504"></a>00504         <a class="code" href="../../d8/db1/BKE__library_8h.html#abdc66d0c4d8e9f6594809313b34d2843">free_libblock</a>(&amp;<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image, source);
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506 }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="comment">/* checks if image was already loaded, then returns same image */</span>
<a name="l00510"></a>00510 <span class="comment">/* otherwise creates new. */</span>
<a name="l00511"></a>00511 <span class="comment">/* does not load ibuf itself */</span>
<a name="l00512"></a>00512 <span class="comment">/* pass on optional frame for #name images */</span>
<a name="l00513"></a><a class="code" href="../../d3/d10/image_8c.html#aaeabdda87165ed00660f78fa7b1ff10f">00513</a> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#ada7c3f7a7be3638972a7635a304420a4">BKE_add_image_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>)
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00516"></a>00516     <span class="keywordtype">int</span> file, <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00517"></a>00517     <span class="keyword">const</span> <span class="keywordtype">char</span> *libname;
<a name="l00518"></a>00518     <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], strtest[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l00519"></a>00519     
<a name="l00520"></a>00520     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(str, name, <span class="keyword">sizeof</span>(str));
<a name="l00521"></a>00521     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(str, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name);
<a name="l00522"></a>00522     
<a name="l00523"></a>00523     <span class="comment">/* exists? */</span>
<a name="l00524"></a>00524     file= <a class="code" href="../../d2/d63/BLI__fileops_8h.html#a33346823641e2323fcf408264ceacaf2">BLI_open</a>(str, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>|O_RDONLY, 0);
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (file== -1) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00526"></a>00526     close(file);
<a name="l00527"></a>00527     
<a name="l00528"></a>00528     <span class="comment">/* first search an identical image */</span>
<a name="l00529"></a>00529     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>!=<a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a> &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>!=<a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l00531"></a>00531             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(strtest, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="keyword">sizeof</span>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));
<a name="l00532"></a>00532             <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(strtest, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name);
<a name="l00533"></a>00533             
<a name="l00534"></a>00534             <span class="keywordflow">if</span> (<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#af94a3a93cdb6b15b6f283ccf3d467f8e">BLI_path_cmp</a>(strtest, str)==0) {
<a name="l00535"></a>00535                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>==0) {
<a name="l00536"></a>00536                     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, name, <span class="keyword">sizeof</span>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));    <span class="comment">/* for stringcode */</span>
<a name="l00537"></a>00537                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>++;                                       <span class="comment">/* officially should not, it doesn&#39;t link here! */</span>
<a name="l00538"></a>00538                     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>==0)
<a name="l00539"></a>00539                         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a6331a69cd5393c1db32cfb154e6ce0ae">IMA_OK</a>;
<a name="l00540"></a>00540                     <span class="comment">/* RETURN! */</span>
<a name="l00541"></a>00541                     <span class="keywordflow">return</span> ima;
<a name="l00542"></a>00542                 }
<a name="l00543"></a>00543             }
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     <span class="comment">/* add new image */</span>
<a name="l00547"></a>00547     
<a name="l00548"></a>00548     <span class="comment">/* create a short library name */</span>
<a name="l00549"></a>00549     len= <a class="code" href="../../d1/d22/stdosl_8h.html#af902ac638d8127503ad64a0eacb3a7e8">strlen</a>(name);
<a name="l00550"></a>00550     
<a name="l00551"></a>00551     <span class="keywordflow">while</span> (len &gt; 0 &amp;&amp; name[len - 1] != <span class="charliteral">&#39;/&#39;</span> &amp;&amp; name[len - 1] != <span class="charliteral">&#39;\\&#39;</span>) len--;
<a name="l00552"></a>00552     libname= name+<a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l00553"></a>00553     
<a name="l00554"></a>00554     ima= <a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(libname, <a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>);
<a name="l00555"></a>00555     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, name, <span class="keyword">sizeof</span>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>));
<a name="l00556"></a>00556     
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#aeeedac7b0ad04a708eb449dc6b7373c0">BLI_testextensie_array</a>(name, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a7c222800805dd4afcbc1691f38c66918">imb_ext_movie</a>))
<a name="l00558"></a>00558         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>;
<a name="l00559"></a>00559     
<a name="l00560"></a>00560     <span class="keywordflow">return</span> ima;
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a><a class="code" href="../../d3/d10/image_8c.html#a63d657c47909ca66bdedaadadc89b121">00563</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a63d657c47909ca66bdedaadadc89b121">add_ibuf_size</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#a6778e0b22d4e50a0685e637a4b527276">depth</a>, <span class="keywordtype">int</span> floatbuf, <span class="keywordtype">short</span> uvtestgrid, <span class="keywordtype">float</span> color[4])
<a name="l00564"></a>00564 {
<a name="l00565"></a>00565     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00566"></a>00566     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00567"></a>00567     <span class="keywordtype">float</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00568"></a>00568     
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (floatbuf) {
<a name="l00570"></a>00570         ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(width, height, depth, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>);
<a name="l00571"></a>00571         rect_float= (<span class="keywordtype">float</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>;
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573     <span class="keywordflow">else</span> {
<a name="l00574"></a>00574         ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(width, height, depth, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l00575"></a>00575         rect= (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577     
<a name="l00578"></a>00578     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, name, <span class="keyword">sizeof</span>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>));
<a name="l00579"></a>00579     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l00580"></a>00580     
<a name="l00581"></a>00581     <span class="keywordflow">switch</span>(uvtestgrid) {
<a name="l00582"></a>00582     <span class="keywordflow">case</span> 1:
<a name="l00583"></a>00583         <a class="code" href="../../d2/d77/BKE__image_8h.html#a8d29e28b7f7f48f3d95306beb4bfe781">BKE_image_buf_fill_checker</a>(rect, rect_float, width, height);
<a name="l00584"></a>00584         <span class="keywordflow">break</span>;
<a name="l00585"></a>00585     <span class="keywordflow">case</span> 2:
<a name="l00586"></a>00586         <a class="code" href="../../d2/d77/BKE__image_8h.html#a8486c7ae1d47e2286c2e261f61138ea6">BKE_image_buf_fill_checker_color</a>(rect, rect_float, width, height);
<a name="l00587"></a>00587         <span class="keywordflow">break</span>;
<a name="l00588"></a>00588     <span class="keywordflow">default</span>:
<a name="l00589"></a>00589         <a class="code" href="../../d2/d77/BKE__image_8h.html#ae602f3dcddbb30d3b0c457dddc66d52f">BKE_image_buf_fill_color</a>(rect, rect_float, width, height, color);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">return</span> ibuf;
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <span class="comment">/* adds new image block, creates ImBuf and initializes color */</span>
<a name="l00596"></a><a class="code" href="../../d3/d10/image_8c.html#abac238263c50bbb5844716871ab61cfd">00596</a> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#ac9183d7df20f4236ce149fcfaebe535e">BKE_add_image_size</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> width, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> height, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#a6778e0b22d4e50a0685e637a4b527276">depth</a>, <span class="keywordtype">int</span> floatbuf, <span class="keywordtype">short</span> uvtestgrid, <span class="keywordtype">float</span> color[4])
<a name="l00597"></a>00597 {
<a name="l00598"></a>00598     <span class="comment">/* on save, type is changed to FILE in editsima.c */</span>
<a name="l00599"></a>00599     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima= <a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(name, <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d0a69a6ac57ac330e6f263cef3d4d22">IMA_TYPE_UV_TEST</a>);
<a name="l00600"></a>00600     
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (ima) {
<a name="l00602"></a>00602         <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00603"></a>00603         
<a name="l00604"></a>00604         <span class="comment">/* BLI_strncpy(ima-&gt;name, name, FILE_MAX); */</span> <span class="comment">/* don&#39;t do this, this writes in ain invalid filepath! */</span>
<a name="l00605"></a>00605         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>= width;
<a name="l00606"></a>00606         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>= height;
<a name="l00607"></a>00607         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>= uvtestgrid;
<a name="l00608"></a>00608         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ac04b590e078aadefd2fb73b3e7dfd46b">gen_flag</a> |= (floatbuf ? <a class="code" href="../../d2/d94/DNA__image__types_8h.html#aef1a3fb1f9bc7ffd8963f987c750ff44">IMA_GEN_FLOAT</a> : 0);
<a name="l00609"></a>00609         
<a name="l00610"></a>00610         ibuf= <a class="code" href="../../d3/d10/image_8c.html#a63d657c47909ca66bdedaadadc89b121">add_ibuf_size</a>(width, height, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, depth, floatbuf, uvtestgrid, color);
<a name="l00611"></a>00611         <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l00612"></a>00612         
<a name="l00613"></a>00613         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>;
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">return</span> ima;
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 <span class="comment">/* creates an image image owns the imbuf passed */</span>
<a name="l00620"></a><a class="code" href="../../d3/d10/image_8c.html#a364b3c2051012e8803eb73121a448c0f">00620</a> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a5d9ec8380d772a8039a783523231a0f1">BKE_add_image_imbuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622     <span class="comment">/* on save, type is changed to FILE in editsima.c */</span>
<a name="l00623"></a>00623     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     ima= <a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ab7fd82fa983b947c076e585e30e7c262">BLI_path_basename</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>), <a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (ima) {
<a name="l00628"></a>00628         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l00629"></a>00629         <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l00630"></a>00630         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>;
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633     <span class="keywordflow">return</span> ima;
<a name="l00634"></a>00634 }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636 <span class="comment">/* packs rect from memory as PNG */</span>
<a name="l00637"></a><a class="code" href="../../d3/d10/image_8c.html#a0b162047d3dcb3ce78c77f2034ae65bd">00637</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#adb62e041f06321d417df6a6dd21adde2">BKE_image_memorypack</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l00640"></a>00640     
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00642"></a>00642         <span class="keywordflow">return</span>;
<a name="l00643"></a>00643     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>) {
<a name="l00644"></a>00644         <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>);
<a name="l00645"></a>00645         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad6bec103484565aa82456b4bb4e60814" title="Flag defining the components of the ImBuf struct.">PNG</a>;
<a name="l00649"></a>00649     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18677560d9dc1695f2fa4e1cc26bd9">R_IMF_PLANES_RGBA</a>;
<a name="l00650"></a>00650     
<a name="l00651"></a>00651     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a59c3289b30d140a0032c85110496dbbc">IMB_saveiff</a>(ibuf, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#af46cf83535481630a343ac6632d71ca6" title="Flag defining the components of the ImBuf struct.">IB_mem</a>);
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a72997fda2b07a14f1765d28079e67f16">encodedbuffer</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00653"></a>00653         printf(<span class="stringliteral">&quot;memory save for pack error\n&quot;</span>);
<a name="l00654"></a>00654     }
<a name="l00655"></a>00655     <span class="keywordflow">else</span> {
<a name="l00656"></a>00656         <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*pf), <span class="stringliteral">&quot;PackedFile&quot;</span>);
<a name="l00657"></a>00657         
<a name="l00658"></a>00658         pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab26282078abf88909ab32213a4290f8e">data</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a72997fda2b07a14f1765d28079e67f16">encodedbuffer</a>;
<a name="l00659"></a>00659         pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a> = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a97f4d8489d699eab9b5791227ddd4c36">encodedsize</a>;
<a name="l00660"></a>00660         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>= <a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l00661"></a>00661         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a72997fda2b07a14f1765d28079e67f16">encodedbuffer</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00662"></a>00662         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a97f4d8489d699eab9b5791227ddd4c36">encodedsize</a>= 0;
<a name="l00663"></a>00663         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>;
<a name="l00664"></a>00664         
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l00666"></a>00666             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>;
<a name="l00667"></a>00667             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l00668"></a>00668         }
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="../../d3/d10/image_8c.html#a9fc104f6990898dc9b4ea76f6117341c">00672</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ad5b660dd2b40bffa484187872f271009">tag_image_time</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674     <span class="keywordflow">if</span> (ima)
<a name="l00675"></a>00675         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5c406458238f8dd71153fc561216677b">lastused</a> = (int)<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="preprocessor">#if 0</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> tag_all_images_time() 
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00682"></a>00682     <span class="keywordtype">int</span> ctime = (int)<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first;
<a name="l00685"></a>00685     <span class="keywordflow">while</span> (ima) {
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a6191ed717ab5202957a8845a97fd6e39">bindcode</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af60081c0bf52834e01991bb87b123fa5">repbind</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00687"></a>00687             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5c406458238f8dd71153fc561216677b">lastused</a> = ctime;
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 <span class="preprocessor">#endif</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span>
<a name="l00693"></a><a class="code" href="../../d3/d10/image_8c.html#ab5dc7a4d3aedf6f24c52e4a033f708bf">00693</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ab5dc7a4d3aedf6f24c52e4a033f708bf">free_old_images</a>(<span class="keywordtype">void</span>)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00696"></a>00696     <span class="keyword">static</span> <span class="keywordtype">int</span> lasttime = 0;
<a name="l00697"></a>00697     <span class="keywordtype">int</span> ctime = (int)<a class="code" href="../../df/d73/time_8c.html#a4e990821a5feb6784e02c3f34642cc17">PIL_check_seconds_timer</a>();
<a name="l00698"></a>00698     
<a name="l00699"></a>00699     <span class="comment">/* </span>
<a name="l00700"></a>00700 <span class="comment">     * Run garbage collector once for every collecting period of time </span>
<a name="l00701"></a>00701 <span class="comment">     * if textimeout is 0, that&#39;s the option to NOT run the collector</span>
<a name="l00702"></a>00702 <span class="comment">     */</span>
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (<a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.textimeout == 0 || ctime % <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.texcollectrate || ctime == lasttime)
<a name="l00704"></a>00704         <span class="keywordflow">return</span>;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <span class="comment">/* of course not! */</span>
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.rendering)
<a name="l00708"></a>00708         <span class="keywordflow">return</span>;
<a name="l00709"></a>00709     
<a name="l00710"></a>00710     lasttime = ctime;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first;
<a name="l00713"></a>00713     <span class="keywordflow">while</span> (ima) {
<a name="l00714"></a>00714         <span class="keywordflow">if</span> ((ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a45ae9b5c77f8a7ee025a50132e2417ba">IMA_NOCOLLECT</a>)==0 &amp;&amp; ctime - ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5c406458238f8dd71153fc561216677b">lastused</a> &gt; <a class="code" href="../../d0/de2/namespacegjkepa2__impl.html#a6d41857f051fae50b68076f99f439398">U</a>.textimeout) {
<a name="l00715"></a>00715             <span class="comment">/* If it&#39;s in GL memory, deallocate and set time tag to current time</span>
<a name="l00716"></a>00716 <span class="comment">             * This gives textures a &quot;second chance&quot; to be used before dying. */</span>
<a name="l00717"></a>00717             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a6191ed717ab5202957a8845a97fd6e39">bindcode</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af60081c0bf52834e01991bb87b123fa5">repbind</a>) {
<a name="l00718"></a>00718                 <a class="code" href="../../d3/df0/GPU__draw_8h.html#aced965f57c52dc61ab76fa1c32317c08">GPU_free_image</a>(ima);
<a name="l00719"></a>00719                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5c406458238f8dd71153fc561216677b">lastused</a> = ctime;
<a name="l00720"></a>00720             }
<a name="l00721"></a>00721             <span class="comment">/* Otherwise, just kill the buffers */</span>
<a name="l00722"></a>00722             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00723"></a>00723                 <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l00724"></a>00724             }
<a name="l00725"></a>00725         }
<a name="l00726"></a>00726         ima = ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="../../d3/d10/image_8c.html#a50df29089265e8f6519cd0f1c06d2991">00730</a> <span class="keyword">static</span> uintptr_t <a class="code" href="../../d3/d10/image_8c.html#a50df29089265e8f6519cd0f1c06d2991">image_mem_size</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, *ibufm;
<a name="l00733"></a>00733     <span class="keywordtype">int</span> level;
<a name="l00734"></a>00734     uintptr_t <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a> = 0;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     size= 0;
<a name="l00737"></a>00737     
<a name="l00738"></a>00738     <span class="comment">/* viewers have memory depending on other rules, has no valid rect pointer */</span>
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>)
<a name="l00740"></a>00740         <span class="keywordflow">return</span> 0;
<a name="l00741"></a>00741     
<a name="l00742"></a>00742     <span class="keywordflow">for</span> (ibuf= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>) {
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) size += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>);
<a name="l00744"></a>00744         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) size += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>);
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         <span class="keywordflow">for</span> (level=0; level&lt;<a class="code" href="../../dd/d38/iff_8h.html#a059e2f48c2c825fb5eb88f60ef23a723">IB_MIPMAP_LEVELS</a>; level++) {
<a name="l00747"></a>00747             ibufm= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[level];
<a name="l00748"></a>00748             <span class="keywordflow">if</span> (ibufm) {
<a name="l00749"></a>00749                 <span class="keywordflow">if</span> (ibufm-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) size += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(ibufm-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>);
<a name="l00750"></a>00750                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibufm-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) size += <a class="code" href="../../da/d2b/mallocn_8c.html#a7d1e6a2f5f9d271452a168d3a637d91f">MEM_allocN_len</a>(ibufm-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>);
<a name="l00751"></a>00751             }
<a name="l00752"></a>00752         }
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="keywordflow">return</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a><a class="code" href="../../d3/d10/image_8c.html#abe47c60e8fc373818be4e1472dd6633a">00758</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#abe47c60e8fc373818be4e1472dd6633a">BKE_image_print_memlist</a>(<span class="keywordtype">void</span>)
<a name="l00759"></a>00759 {
<a name="l00760"></a>00760     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00761"></a>00761     uintptr_t <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>, totsize= 0;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00764"></a>00764         totsize += <a class="code" href="../../d3/d10/image_8c.html#a50df29089265e8f6519cd0f1c06d2991">image_mem_size</a>(ima);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     printf(<span class="stringliteral">&quot;\ntotal image memory len: %.3f MB\n&quot;</span>, (<span class="keywordtype">double</span>)totsize/(<span class="keywordtype">double</span>)(1024*1024));
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00769"></a>00769         size= <a class="code" href="../../d3/d10/image_8c.html#a50df29089265e8f6519cd0f1c06d2991">image_mem_size</a>(ima);
<a name="l00770"></a>00770 
<a name="l00771"></a>00771         <span class="keywordflow">if</span> (size)
<a name="l00772"></a>00772             printf(<span class="stringliteral">&quot;%s len: %.3f MB\n&quot;</span>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, (<span class="keywordtype">double</span>)size/(<span class="keywordtype">double</span>)(1024*1024));
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="../../d3/d10/image_8c.html#a72aac25ba73ae00c116e01b8c4efab8e">00776</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a72aac25ba73ae00c116e01b8c4efab8e">BKE_image_free_all_textures</a>(<span class="keywordtype">void</span>)
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00779"></a>00779     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00780"></a>00780     <span class="comment">/* unsigned int totsize= 0; */</span>
<a name="l00781"></a>00781     
<a name="l00782"></a>00782     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00783"></a>00783         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp;= ~<a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00784"></a>00784     
<a name="l00785"></a>00785     <span class="keywordflow">for</span> (tex= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;tex.first; tex; tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00786"></a>00786         <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>)
<a name="l00787"></a>00787             tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> |= <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>;
<a name="l00788"></a>00788     
<a name="l00789"></a>00789     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l00790"></a>00790         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> &amp;&amp; (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#aaa0124bd1f312b0d778e1e0de8b8be9f">flag</a> &amp; <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a41fa8f648966e669ab4da5b359bd7d57">LIB_DOIT</a>)) {
<a name="l00791"></a>00791             <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00792"></a>00792             
<a name="l00793"></a>00793             <span class="keywordflow">for</span> (ibuf= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>) {
<a name="l00794"></a>00794                 <span class="comment">/* escape when image is painted on */</span>
<a name="l00795"></a>00795                 <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>)
<a name="l00796"></a>00796                     <span class="keywordflow">break</span>;
<a name="l00797"></a>00797                 
<a name="l00798"></a>00798 <span class="preprocessor">#if 0</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1554310a753cdd3ead0de09a90a36553">mipmap</a>[0]) 
<a name="l00800"></a>00800                     totsize+= 1.33*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*4;
<a name="l00801"></a>00801                 <span class="keywordflow">else</span>
<a name="l00802"></a>00802                     totsize+= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>*4;
<a name="l00803"></a>00803 <span class="preprocessor">#endif</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>            }
<a name="l00805"></a>00805             <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00806"></a>00806                 <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809     <span class="comment">/* printf(&quot;freed total %d MB\n&quot;, totsize/(1024*1024)); */</span>
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 <span class="comment">/* except_frame is weak, only works for seqs without offset... */</span>
<a name="l00813"></a><a class="code" href="../../d3/d10/image_8c.html#a4939d3ad855423b611f6ec8e0976b06e">00813</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a2f70d179677a648b57de11d411f19a88">BKE_image_free_anim_ibufs</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <span class="keywordtype">int</span> except_frame)
<a name="l00814"></a>00814 {
<a name="l00815"></a>00815     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, *nbuf;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="keywordflow">for</span> (ibuf= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ibuf; ibuf= nbuf) {
<a name="l00818"></a>00818         nbuf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a1336c12ceab56f77f1af50ac83f17205">next</a>;
<a name="l00819"></a>00819         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6d4eb5ccd281567cfe05d561fbb6a833">userflags</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a30f6d4e88f758f8f9b02bc862d845957">IB_BITMAPDIRTY</a>)
<a name="l00820"></a>00820             <span class="keywordflow">continue</span>;
<a name="l00821"></a>00821         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>==<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>)
<a name="l00822"></a>00822             <span class="keywordflow">continue</span>;
<a name="l00823"></a>00823         <span class="keywordflow">if</span> (except_frame!=<a class="code" href="../../d3/d10/image_8c.html#a171aeff9b3519a39d2321a61ba1eee32">IMA_INDEX_FRAME</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>)) {
<a name="l00824"></a>00824             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a73febaffccd786657631095065b9e25b">ibufs</a>, ibuf);
<a name="l00825"></a>00825             
<a name="l00826"></a>00826             <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>) {
<a name="l00827"></a>00827                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>);
<a name="l00828"></a>00828                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00829"></a>00829             }
<a name="l00830"></a>00830             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l00831"></a>00831         }                   
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a><a class="code" href="../../d3/d10/image_8c.html#a08ac69ba1534f59b83527fc0630d5341">00835</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a3d29cee878a4de9eaca8e10ed37473a3">BKE_image_all_free_anim_ibufs</a>(<span class="keywordtype">int</span> cfra)
<a name="l00836"></a>00836 {
<a name="l00837"></a>00837     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l00838"></a>00838     
<a name="l00839"></a>00839     <span class="keywordflow">for</span> (ima= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00840"></a>00840         <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>, <a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>))
<a name="l00841"></a>00841             <a class="code" href="../../d2/d77/BKE__image_8h.html#a2f70d179677a648b57de11d411f19a88">BKE_image_free_anim_ibufs</a>(ima, cfra);
<a name="l00842"></a>00842 }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="comment">/* *********** READ AND WRITE ************** */</span>
<a name="l00846"></a>00846 
<a name="l00847"></a><a class="code" href="../../d3/d10/image_8c.html#ab8d1841f581d63520cada8624601f16a">00847</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ab8d1841f581d63520cada8624601f16a">BKE_imtype_to_ftype</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849     <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>)
<a name="l00850"></a>00850         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a786bc8a358fdcec22501b3668f18b00a" title="Flag defining the components of the ImBuf struct.">TGA</a>;
<a name="l00851"></a>00851     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>)
<a name="l00852"></a>00852         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a3aaeb3db3191e2e9b7ee544d64871f2e" title="Flag defining the components of the ImBuf struct.">RAWTGA</a>;
<a name="l00853"></a>00853     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype== <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>) 
<a name="l00854"></a>00854         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ae85edbe538f26e9d7c01ce9575e5a869" title="Flag defining the components of the ImBuf struct.">IMAGIC</a>;
<a name="l00855"></a>00855 <span class="preprocessor">#ifdef WITH_HDR</span>
<a name="l00856"></a>00856 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>)
<a name="l00857"></a>00857         <span class="keywordflow">return</span> RADHDR;
<a name="l00858"></a>00858 <span class="preprocessor">#endif</span>
<a name="l00859"></a>00859 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>)
<a name="l00860"></a>00860         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad6bec103484565aa82456b4bb4e60814" title="Flag defining the components of the ImBuf struct.">PNG</a>;
<a name="l00861"></a>00861 <span class="preprocessor">#ifdef WITH_DDS</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>)
<a name="l00863"></a>00863         <span class="keywordflow">return</span> DDS;
<a name="l00864"></a>00864 <span class="preprocessor">#endif</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a828427466ac5c0514afb0b4d7f3f2d3c">R_IMF_IMTYPE_BMP</a>)
<a name="l00866"></a>00866         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a185d03d5cf2972932cb724502a847d7d" title="Flag defining the components of the ImBuf struct.">BMP</a>;
<a name="l00867"></a>00867 <span class="preprocessor">#ifdef WITH_TIFF</span>
<a name="l00868"></a>00868 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>)
<a name="l00869"></a>00869         <span class="keywordflow">return</span> TIF;
<a name="l00870"></a>00870 <span class="preprocessor">#endif</span>
<a name="l00871"></a>00871 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a> || imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>)
<a name="l00872"></a>00872         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac23ddaa6ad1b9434bb6ad46c660eeec2" title="Flag defining the components of the ImBuf struct.">OPENEXR</a>;
<a name="l00873"></a>00873 <span class="preprocessor">#ifdef WITH_CINEON</span>
<a name="l00874"></a>00874 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>)
<a name="l00875"></a>00875         <span class="keywordflow">return</span> CINEON;
<a name="l00876"></a>00876     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>)
<a name="l00877"></a>00877         <span class="keywordflow">return</span> DPX;
<a name="l00878"></a>00878 <span class="preprocessor">#endif</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_OPENJPEG</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>)
<a name="l00881"></a>00881         <span class="keywordflow">return</span> JP2;
<a name="l00882"></a>00882 <span class="preprocessor">#endif</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
<a name="l00884"></a>00884         <span class="keywordflow">return</span> <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a43488598a405ffcd2a6d435eb9638257" title="Flag defining the components of the ImBuf struct.">JPG</a>|90;
<a name="l00885"></a>00885 }
<a name="l00886"></a>00886 
<a name="l00887"></a><a class="code" href="../../d3/d10/image_8c.html#a38444fcc115605ba30b80b730adc6f93">00887</a> <span class="keywordtype">char</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a38444fcc115605ba30b80b730adc6f93">BKE_ftype_to_imtype</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>)
<a name="l00888"></a>00888 {
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (ftype==0)
<a name="l00890"></a>00890         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>;
<a name="l00891"></a>00891     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype == <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ae85edbe538f26e9d7c01ce9575e5a869" title="Flag defining the components of the ImBuf struct.">IMAGIC</a>) 
<a name="l00892"></a>00892         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>;
<a name="l00893"></a>00893 <span class="preprocessor">#ifdef WITH_HDR</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; RADHDR)
<a name="l00895"></a>00895         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>;
<a name="l00896"></a>00896 <span class="preprocessor">#endif</span>
<a name="l00897"></a>00897 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad6bec103484565aa82456b4bb4e60814" title="Flag defining the components of the ImBuf struct.">PNG</a>)
<a name="l00898"></a>00898         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>;
<a name="l00899"></a>00899 <span class="preprocessor">#ifdef WITH_DDS</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; DDS)
<a name="l00901"></a>00901         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>;
<a name="l00902"></a>00902 <span class="preprocessor">#endif</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a185d03d5cf2972932cb724502a847d7d" title="Flag defining the components of the ImBuf struct.">BMP</a>)
<a name="l00904"></a>00904         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a828427466ac5c0514afb0b4d7f3f2d3c">R_IMF_IMTYPE_BMP</a>;
<a name="l00905"></a>00905 <span class="preprocessor">#ifdef WITH_TIFF</span>
<a name="l00906"></a>00906 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; TIF)
<a name="l00907"></a>00907         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>;
<a name="l00908"></a>00908 <span class="preprocessor">#endif</span>
<a name="l00909"></a>00909 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac23ddaa6ad1b9434bb6ad46c660eeec2" title="Flag defining the components of the ImBuf struct.">OPENEXR</a>)
<a name="l00910"></a>00910         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>;
<a name="l00911"></a>00911 <span class="preprocessor">#ifdef WITH_CINEON</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; CINEON)
<a name="l00913"></a>00913         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>;
<a name="l00914"></a>00914     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; DPX)
<a name="l00915"></a>00915         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>;
<a name="l00916"></a>00916 <span class="preprocessor">#endif</span>
<a name="l00917"></a>00917 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a786bc8a358fdcec22501b3668f18b00a" title="Flag defining the components of the ImBuf struct.">TGA</a>)
<a name="l00918"></a>00918         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>;
<a name="l00919"></a>00919     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a3aaeb3db3191e2e9b7ee544d64871f2e" title="Flag defining the components of the ImBuf struct.">RAWTGA</a>)
<a name="l00920"></a>00920         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>;
<a name="l00921"></a>00921 <span class="preprocessor">#ifdef WITH_OPENJPEG</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ftype &amp; JP2)
<a name="l00923"></a>00923         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>;
<a name="l00924"></a>00924 <span class="preprocessor">#endif</span>
<a name="l00925"></a>00925 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
<a name="l00926"></a>00926         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af7717dc6492920a06df125df1dc1b375">R_IMF_IMTYPE_JPEG90</a>;
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a><a class="code" href="../../d3/d10/image_8c.html#ad71ebb55de689c8115e846c8cac9d731">00930</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ad71ebb55de689c8115e846c8cac9d731">BKE_imtype_is_movie</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00931"></a>00931 {
<a name="l00932"></a>00932     <span class="keywordflow">switch</span>(imtype) {
<a name="l00933"></a>00933     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad2e04a8456fc62e17138639dfd46c47">R_IMF_IMTYPE_AVIRAW</a>:
<a name="l00934"></a>00934     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a39945178cf5c0257d49cfd17b5310c10">R_IMF_IMTYPE_AVIJPEG</a>:
<a name="l00935"></a>00935     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4706b815f6322fa877bea029ddfceca7">R_IMF_IMTYPE_AVICODEC</a>:
<a name="l00936"></a>00936     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a98bb464d2ad2ab3e7494cbb240407260">R_IMF_IMTYPE_QUICKTIME</a>:
<a name="l00937"></a>00937     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0aa432f8cedf714280de0c36b5b09e86">R_IMF_IMTYPE_FFMPEG</a>:
<a name="l00938"></a>00938     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0ba8a90795f599d097d6d6e4c93a0a54">R_IMF_IMTYPE_H264</a>:
<a name="l00939"></a>00939     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2650c8ed97f9854439572ce385a54798">R_IMF_IMTYPE_THEORA</a>:
<a name="l00940"></a>00940     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8e584b59b3caa0328d03ec0843f43ea7">R_IMF_IMTYPE_XVID</a>:
<a name="l00941"></a>00941     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0b8c7b2e75cb78cf878f7ced19e5f6fa">R_IMF_IMTYPE_FRAMESERVER</a>:
<a name="l00942"></a>00942             <span class="keywordflow">return</span> 1;
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944     <span class="keywordflow">return</span> 0;
<a name="l00945"></a>00945 }
<a name="l00946"></a>00946 
<a name="l00947"></a><a class="code" href="../../d3/d10/image_8c.html#a1bea8b0d4d23f00f8456dd0f21d49018">00947</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a1bea8b0d4d23f00f8456dd0f21d49018">BKE_imtype_supports_zbuf</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00948"></a>00948 {
<a name="l00949"></a>00949     <span class="keywordflow">switch</span>(imtype) {
<a name="l00950"></a>00950     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a785413379bb7c00888ccdc4610e7ef08">R_IMF_IMTYPE_IRIZ</a>:
<a name="l00951"></a>00951     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>: <span class="comment">/* but not R_IMF_IMTYPE_MULTILAYER */</span>
<a name="l00952"></a>00952             <span class="keywordflow">return</span> 1;
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954     <span class="keywordflow">return</span> 0;
<a name="l00955"></a>00955 }
<a name="l00956"></a>00956 
<a name="l00957"></a><a class="code" href="../../d3/d10/image_8c.html#a1b225957cf48728d81ea3a8379aa47b9">00957</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a1b225957cf48728d81ea3a8379aa47b9">BKE_imtype_supports_compress</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00958"></a>00958 {
<a name="l00959"></a>00959     <span class="keywordflow">switch</span>(imtype) {
<a name="l00960"></a>00960     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>:
<a name="l00961"></a>00961             <span class="keywordflow">return</span> 1;
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963     <span class="keywordflow">return</span> 0;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00966"></a><a class="code" href="../../d3/d10/image_8c.html#ab7e4bd2a09688653bc6e23c53d924697">00966</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ab7e4bd2a09688653bc6e23c53d924697">BKE_imtype_supports_quality</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00967"></a>00967 {
<a name="l00968"></a>00968     <span class="keywordflow">switch</span>(imtype) {
<a name="l00969"></a>00969     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af7717dc6492920a06df125df1dc1b375">R_IMF_IMTYPE_JPEG90</a>:
<a name="l00970"></a>00970     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>:
<a name="l00971"></a>00971     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a39945178cf5c0257d49cfd17b5310c10">R_IMF_IMTYPE_AVIJPEG</a>:
<a name="l00972"></a>00972             <span class="keywordflow">return</span> 1;
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974     <span class="keywordflow">return</span> 0;
<a name="l00975"></a>00975 }
<a name="l00976"></a>00976 
<a name="l00977"></a><a class="code" href="../../d3/d10/image_8c.html#a81b7a99e5d4dd3cae742eaa7ad8e7e53">00977</a> <span class="keywordtype">char</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a81b7a99e5d4dd3cae742eaa7ad8e7e53">BKE_imtype_valid_channels</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l00978"></a>00978 {
<a name="l00979"></a>00979     <span class="keywordtype">char</span> chan_flag= <a class="code" href="../../d2/d77/BKE__image_8h.html#a279ca4658b79aa2d0c2bb92a33b9a336">IMA_CHAN_FLAG_RGB</a>; <span class="comment">/* assume all support rgb */</span>
<a name="l00980"></a>00980 
<a name="l00981"></a>00981     <span class="comment">/* alpha */</span>
<a name="l00982"></a>00982     <span class="keywordflow">switch</span>(imtype) {
<a name="l00983"></a>00983     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>:
<a name="l00984"></a>00984     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>:
<a name="l00985"></a>00985     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>:
<a name="l00986"></a>00986     <span class="comment">/* case R_IMF_IMTYPE_BMP: */</span> <span class="comment">/* read but not write */</span>
<a name="l00987"></a>00987     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>:
<a name="l00988"></a>00988     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>:
<a name="l00989"></a>00989     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>:
<a name="l00990"></a>00990     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>:
<a name="l00991"></a>00991     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>:
<a name="l00992"></a>00992     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>:
<a name="l00993"></a>00993     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a98bb464d2ad2ab3e7494cbb240407260">R_IMF_IMTYPE_QUICKTIME</a>:
<a name="l00994"></a>00994             chan_flag |= <a class="code" href="../../d2/d77/BKE__image_8h.html#a7afa62f20d0fd5a951a586707468278a">IMA_CHAN_FLAG_ALPHA</a>;
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <span class="comment">/* bw */</span>
<a name="l00998"></a>00998     <span class="keywordflow">switch</span>(imtype) {
<a name="l00999"></a>00999     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>:
<a name="l01000"></a>01000     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af7717dc6492920a06df125df1dc1b375">R_IMF_IMTYPE_JPEG90</a>:
<a name="l01001"></a>01001     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>:
<a name="l01002"></a>01002     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>:
<a name="l01003"></a>01003     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>:
<a name="l01004"></a>01004     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>:
<a name="l01005"></a>01005             chan_flag |= <a class="code" href="../../d2/d77/BKE__image_8h.html#a833e5d65da5d350df7a4698d68e72a6c">IMA_CHAN_FLAG_BW</a>;
<a name="l01006"></a>01006     }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="keywordflow">return</span> chan_flag;
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a><a class="code" href="../../d3/d10/image_8c.html#a3ed096edc853c137d4afb7e3b5cc80a0">01011</a> <span class="keywordtype">char</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a3ed096edc853c137d4afb7e3b5cc80a0">BKE_imtype_valid_depths</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l01012"></a>01012 {
<a name="l01013"></a>01013     <span class="keywordflow">switch</span> (imtype) {
<a name="l01014"></a>01014     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>:
<a name="l01015"></a>01015         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>;
<a name="l01016"></a>01016     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>:
<a name="l01017"></a>01017         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>;
<a name="l01018"></a>01018     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>:
<a name="l01019"></a>01019         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>;
<a name="l01020"></a>01020     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>:
<a name="l01021"></a>01021         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a204d434d0d919428f638818080df09c8">R_IMF_CHAN_DEPTH_32</a>;
<a name="l01022"></a>01022     <span class="comment">/* eeh, cineone does some strange 10bits per channel */</span>
<a name="l01023"></a>01023     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>:
<a name="l01024"></a>01024     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>:
<a name="l01025"></a>01025         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>;
<a name="l01026"></a>01026     <span class="keywordflow">case</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>:
<a name="l01027"></a>01027         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>;
<a name="l01028"></a>01028     <span class="comment">/* most formats are 8bit only */</span>
<a name="l01029"></a>01029     <span class="keywordflow">default</span>:
<a name="l01030"></a>01030         <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af02e6e0fb1e7bcfc7a2995dee0e7afc2">R_IMF_CHAN_DEPTH_8</a>;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 <span class="comment">/* string is from command line --render-format arg, keep in sync with</span>
<a name="l01036"></a>01036 <span class="comment"> * creator.c help info */</span>
<a name="l01037"></a><a class="code" href="../../d3/d10/image_8c.html#a6eb10bf0091204d4248fce1d9181b544">01037</a> <span class="keywordtype">char</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a874bca63f90e4da78941d23dc0cbcac9">BKE_imtype_from_arg</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *imtype_arg)
<a name="l01038"></a>01038 {
<a name="l01039"></a>01039     <span class="keywordflow">if</span>      (!strcmp(imtype_arg,<span class="stringliteral">&quot;TGA&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>;
<a name="l01040"></a>01040     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;IRIS&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>;
<a name="l01041"></a>01041 <span class="preprocessor">#ifdef WITH_DDS</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;DDS&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>;
<a name="l01043"></a>01043 <span class="preprocessor">#endif</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;JPEG&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af7717dc6492920a06df125df1dc1b375">R_IMF_IMTYPE_JPEG90</a>;
<a name="l01045"></a>01045     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;IRIZ&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a785413379bb7c00888ccdc4610e7ef08">R_IMF_IMTYPE_IRIZ</a>;
<a name="l01046"></a>01046     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;RAWTGA&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>;
<a name="l01047"></a>01047     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;AVIRAW&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aad2e04a8456fc62e17138639dfd46c47">R_IMF_IMTYPE_AVIRAW</a>;
<a name="l01048"></a>01048     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;AVIJPEG&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a39945178cf5c0257d49cfd17b5310c10">R_IMF_IMTYPE_AVIJPEG</a>;
<a name="l01049"></a>01049     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;PNG&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>;
<a name="l01050"></a>01050     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;AVICODEC&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4706b815f6322fa877bea029ddfceca7">R_IMF_IMTYPE_AVICODEC</a>;
<a name="l01051"></a>01051     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;QUICKTIME&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a98bb464d2ad2ab3e7494cbb240407260">R_IMF_IMTYPE_QUICKTIME</a>;
<a name="l01052"></a>01052     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;BMP&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a828427466ac5c0514afb0b4d7f3f2d3c">R_IMF_IMTYPE_BMP</a>;
<a name="l01053"></a>01053 <span class="preprocessor">#ifdef WITH_HDR</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;HDR&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>;
<a name="l01055"></a>01055 <span class="preprocessor">#endif</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_TIFF</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;TIFF&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>;
<a name="l01058"></a>01058 <span class="preprocessor">#endif</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l01060"></a>01060 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;EXR&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>;
<a name="l01061"></a>01061     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;MULTILAYER&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>;
<a name="l01062"></a>01062 <span class="preprocessor">#endif</span>
<a name="l01063"></a>01063 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;MPEG&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0aa432f8cedf714280de0c36b5b09e86">R_IMF_IMTYPE_FFMPEG</a>;
<a name="l01064"></a>01064     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;FRAMESERVER&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0b8c7b2e75cb78cf878f7ced19e5f6fa">R_IMF_IMTYPE_FRAMESERVER</a>;
<a name="l01065"></a>01065 <span class="preprocessor">#ifdef WITH_CINEON</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;CINEON&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>;
<a name="l01067"></a>01067     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;DPX&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>;
<a name="l01068"></a>01068 <span class="preprocessor">#endif</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_OPENJPEG</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(imtype_arg,<span class="stringliteral">&quot;JP2&quot;</span>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>;
<a name="l01071"></a>01071 <span class="preprocessor">#endif</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae2cd201140c24c4fed0d7b45f860ba65">R_IMF_IMTYPE_INVALID</a>;
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a><a class="code" href="../../d3/d10/image_8c.html#a2718a30a9eda11c50db8429549a7d8d6">01075</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a2718a30a9eda11c50db8429549a7d8d6">BKE_add_image_extension</a>(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> imtype)
<a name="l01076"></a>01076 {
<a name="l01077"></a>01077     <span class="keyword">const</span> <span class="keywordtype">char</span> *extension= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01078"></a>01078     
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (imtype== <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>) {
<a name="l01080"></a>01080         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.rgb&quot;</span>))
<a name="l01081"></a>01081             extension= <span class="stringliteral">&quot;.rgb&quot;</span>;
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a785413379bb7c00888ccdc4610e7ef08">R_IMF_IMTYPE_IRIZ</a>) {
<a name="l01084"></a>01084         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.rgb&quot;</span>))
<a name="l01085"></a>01085             extension= <span class="stringliteral">&quot;.rgb&quot;</span>;
<a name="l01086"></a>01086     }
<a name="l01087"></a>01087 <span class="preprocessor">#ifdef WITH_HDR</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>) {
<a name="l01089"></a>01089         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.hdr&quot;</span>))
<a name="l01090"></a>01090             extension= <span class="stringliteral">&quot;.hdr&quot;</span>;
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092 <span class="preprocessor">#endif</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a94fe4335845faafd0b969e89a13d8c76">ELEM5</a>(imtype, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0aa432f8cedf714280de0c36b5b09e86">R_IMF_IMTYPE_FFMPEG</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0ba8a90795f599d097d6d6e4c93a0a54">R_IMF_IMTYPE_H264</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2650c8ed97f9854439572ce385a54798">R_IMF_IMTYPE_THEORA</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8e584b59b3caa0328d03ec0843f43ea7">R_IMF_IMTYPE_XVID</a>)) {
<a name="l01094"></a>01094         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.png&quot;</span>))
<a name="l01095"></a>01095             extension= <span class="stringliteral">&quot;.png&quot;</span>;
<a name="l01096"></a>01096     }
<a name="l01097"></a>01097 <span class="preprocessor">#ifdef WITH_DDS</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>) {
<a name="l01099"></a>01099         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.dds&quot;</span>))
<a name="l01100"></a>01100             extension= <span class="stringliteral">&quot;.dds&quot;</span>;
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102 <span class="preprocessor">#endif</span>
<a name="l01103"></a>01103 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>) {
<a name="l01104"></a>01104         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.tga&quot;</span>))
<a name="l01105"></a>01105             extension= <span class="stringliteral">&quot;.tga&quot;</span>;
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a828427466ac5c0514afb0b4d7f3f2d3c">R_IMF_IMTYPE_BMP</a>) {
<a name="l01108"></a>01108         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.bmp&quot;</span>))
<a name="l01109"></a>01109             extension= <span class="stringliteral">&quot;.bmp&quot;</span>;
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111 <span class="preprocessor">#ifdef WITH_TIFF</span>
<a name="l01112"></a>01112 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>) {
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.tif&quot;</span>) &amp;&amp; 
<a name="l01114"></a>01114             !<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.tiff&quot;</span>)) extension= <span class="stringliteral">&quot;.tif&quot;</span>;
<a name="l01115"></a>01115     }
<a name="l01116"></a>01116 <span class="preprocessor">#endif</span>
<a name="l01117"></a>01117 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(imtype, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>)) {
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.exr&quot;</span>))
<a name="l01120"></a>01120             extension= <span class="stringliteral">&quot;.exr&quot;</span>;
<a name="l01121"></a>01121     }
<a name="l01122"></a>01122 <span class="preprocessor">#endif</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_CINEON</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>) {
<a name="l01125"></a>01125         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.cin&quot;</span>))
<a name="l01126"></a>01126             extension= <span class="stringliteral">&quot;.cin&quot;</span>;
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>) {
<a name="l01129"></a>01129         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.dpx&quot;</span>))
<a name="l01130"></a>01130             extension= <span class="stringliteral">&quot;.dpx&quot;</span>;
<a name="l01131"></a>01131     }
<a name="l01132"></a>01132 <span class="preprocessor">#endif</span>
<a name="l01133"></a>01133 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>) {
<a name="l01134"></a>01134         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.tga&quot;</span>))
<a name="l01135"></a>01135             extension= <span class="stringliteral">&quot;.tga&quot;</span>;
<a name="l01136"></a>01136     }
<a name="l01137"></a>01137 <span class="preprocessor">#ifdef WITH_OPENJPEG</span>
<a name="l01138"></a>01138 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>) {
<a name="l01139"></a>01139         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.jp2&quot;</span>))
<a name="l01140"></a>01140             extension= <span class="stringliteral">&quot;.jp2&quot;</span>;
<a name="l01141"></a>01141     }
<a name="l01142"></a>01142 <span class="preprocessor">#endif</span>
<a name="l01143"></a>01143 <span class="preprocessor"></span>    <span class="keywordflow">else</span> { <span class="comment">//   R_IMF_IMTYPE_AVICODEC, R_IMF_IMTYPE_AVIRAW, R_IMF_IMTYPE_AVIJPEG, R_IMF_IMTYPE_JPEG90, R_IMF_IMTYPE_QUICKTIME etc</span>
<a name="l01144"></a>01144         <span class="keywordflow">if</span> (!( <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.jpg&quot;</span>) || <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a91f9e9d5868a3b3e5756809d6cae1a75">BLI_testextensie</a>(<span class="keywordtype">string</span>, <span class="stringliteral">&quot;.jpeg&quot;</span>)))
<a name="l01145"></a>01145             extension= <span class="stringliteral">&quot;.jpg&quot;</span>;
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (extension) {
<a name="l01149"></a>01149         <span class="comment">/* prefer this in many cases to avoid .png.tga, but in certain cases it breaks */</span>
<a name="l01150"></a>01150         <span class="comment">/* remove any other known image extension */</span>
<a name="l01151"></a>01151         <span class="keywordflow">if</span> (<a class="code" href="../../d2/dd9/BLI__path__util_8h.html#aeeedac7b0ad04a708eb449dc6b7373c0">BLI_testextensie_array</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ade67ff2d226c2dfa9007064fbcdc3e0a">imb_ext_image</a>) ||
<a name="l01152"></a>01152             (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.have_quicktime &amp;&amp; <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#aeeedac7b0ad04a708eb449dc6b7373c0">BLI_testextensie_array</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a0c1bd2e227e72fc414a10d57886b6768">imb_ext_image_qt</a>)))
<a name="l01153"></a>01153         {
<a name="l01154"></a>01154             <span class="keywordflow">return</span> <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#afa3da8cc53a62041acbb98eb6a9805c4">BLI_replace_extension</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, extension);
<a name="l01155"></a>01155         }
<a name="l01156"></a>01156         <span class="keywordflow">else</span> {
<a name="l01157"></a>01157             <span class="keywordflow">return</span> <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ae5e609274296921b40b35a59959ec5a7">BLI_ensure_extension</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>, extension);
<a name="l01158"></a>01158         }
<a name="l01159"></a>01159         
<a name="l01160"></a>01160     }
<a name="l01161"></a>01161     <span class="keywordflow">else</span> {
<a name="l01162"></a>01162         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164 }
<a name="l01165"></a>01165 
<a name="l01166"></a><a class="code" href="../../d3/d10/image_8c.html#aa4cda222c859363f79372627586104da">01166</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a19bc7535e834b368d09303b2f0896c2d">BKE_imformat_defaults</a>(<a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *im_format)
<a name="l01167"></a>01167 {
<a name="l01168"></a>01168     memset(im_format, 0, <span class="keyword">sizeof</span>(*im_format));
<a name="l01169"></a>01169     im_format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aee79a5344ad31850de44a367f28356bc">R_IMF_PLANES_RGB</a>;
<a name="l01170"></a>01170     im_format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>;
<a name="l01171"></a>01171     im_format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a> = 90;
<a name="l01172"></a>01172     im_format-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a23f6a76d7819cb51371e9959e7ac995a">compress</a> = 90;
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 <span class="comment">/* could allow access externally - 512 is for long names, 64 is for id names */</span>
<a name="l01176"></a><a class="code" href="../../d0/d00/structStampData.html">01176</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d00/structStampData.html">StampData</a> {
<a name="l01177"></a><a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">01177</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>[512];
<a name="l01178"></a><a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">01178</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>[512];
<a name="l01179"></a><a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">01179</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>[512];
<a name="l01180"></a><a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">01180</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>[512];
<a name="l01181"></a><a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">01181</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>[512];
<a name="l01182"></a><a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">01182</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>[512];
<a name="l01183"></a><a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">01183</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>[64];
<a name="l01184"></a><a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">01184</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>[64];
<a name="l01185"></a><a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">01185</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>[64];
<a name="l01186"></a><a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">01186</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>[64];
<a name="l01187"></a><a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">01187</a>     <span class="keywordtype">char</span>    <a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>[64];
<a name="l01188"></a>01188 } <a class="code" href="../../d3/d10/image_8c.html#a7c14c2e06e0533f9a5defd0b375e1f04">StampData</a>;
<a name="l01189"></a>01189 
<a name="l01190"></a><a class="code" href="../../d3/d10/image_8c.html#a7ed5d7e2e8c73fe72b7554d3e6f8eb82">01190</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#a7ed5d7e2e8c73fe72b7554d3e6f8eb82">stampdata</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *camera, <a class="code" href="../../d0/d00/structStampData.html">StampData</a> *stamp_data, <span class="keywordtype">int</span> do_prefix)
<a name="l01191"></a>01191 {
<a name="l01192"></a>01192     <span class="keywordtype">char</span> text[256];
<a name="l01193"></a>01193     <span class="keyword">struct </span>tm *tl;
<a name="l01194"></a>01194     time_t t;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aab2a1af29484b3cdc628408b9527f7b0">R_STAMP_FILENAME</a>) {
<a name="l01197"></a>01197         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>), do_prefix ? <span class="stringliteral">&quot;File %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.relbase_valid ? <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;name:<span class="stringliteral">&quot;&lt;untitled&gt;&quot;</span>);
<a name="l01198"></a>01198     }
<a name="l01199"></a>01199     <span class="keywordflow">else</span> {
<a name="l01200"></a>01200         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01201"></a>01201     }
<a name="l01202"></a>01202     
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8c249167b2476204f3434299aaf234af">R_STAMP_NOTE</a>) {
<a name="l01204"></a>01204         <span class="comment">/* Never do prefix for Note */</span>
<a name="l01205"></a>01205         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>), <span class="stringliteral">&quot;%s&quot;</span>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a29d0fa590c37c391fd9d023f122360e6">stamp_udata</a>);
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207     <span class="keywordflow">else</span> {
<a name="l01208"></a>01208         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01209"></a>01209     }
<a name="l01210"></a>01210     
<a name="l01211"></a>01211     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa95a1b81310725285fc5e7d52aad52b1">R_STAMP_DATE</a>) {
<a name="l01212"></a>01212         t = time(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01213"></a>01213         tl = localtime(&amp;t);
<a name="l01214"></a>01214         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(text, <span class="keyword">sizeof</span>(text), <span class="stringliteral">&quot;%04d/%02d/%02d %02d:%02d:%02d&quot;</span>, tl-&gt;tm_year+1900, tl-&gt;tm_mon+1, tl-&gt;tm_mday, tl-&gt;tm_hour, tl-&gt;tm_min, tl-&gt;tm_sec);
<a name="l01215"></a>01215         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>), do_prefix ? <span class="stringliteral">&quot;Date %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217     <span class="keywordflow">else</span> {
<a name="l01218"></a>01218         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01219"></a>01219     }
<a name="l01220"></a>01220     
<a name="l01221"></a>01221     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3d2fb70c21e236e18c37eca0afa36090">R_STAMP_MARKER</a>) {
<a name="l01222"></a>01222         <span class="keywordtype">char</span> *name = <a class="code" href="../../d8/d53/BKE__scene_8h.html#a4fc132ae34930cbf120129d0ce0f425c">scene_find_last_marker_name</a>(scene, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a3619c6f2d3bfb9dbb64eeb250fd5fdcb">CFRA</a>);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224         <span class="keywordflow">if</span> (name)   <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(text, name, <span class="keyword">sizeof</span>(text));
<a name="l01225"></a>01225         <span class="keywordflow">else</span>        <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(text, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, <span class="keyword">sizeof</span>(text));
<a name="l01226"></a>01226 
<a name="l01227"></a>01227         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>), do_prefix ? <span class="stringliteral">&quot;Marker %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229     <span class="keywordflow">else</span> {
<a name="l01230"></a>01230         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01231"></a>01231     }
<a name="l01232"></a>01232     
<a name="l01233"></a>01233     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aec5030f666744fe172ea24beead1de5e">R_STAMP_TIME</a>) {
<a name="l01234"></a>01234         <span class="keywordtype">int</span> f = (int)(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> % scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a071df993e13c05fc37e6f9a82c0679f5">frs_sec</a>);
<a name="l01235"></a>01235         <span class="keywordtype">int</span> s = (int)(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a> / scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a071df993e13c05fc37e6f9a82c0679f5">frs_sec</a>);
<a name="l01236"></a>01236         <span class="keywordtype">int</span> h= 0;
<a name="l01237"></a>01237         <span class="keywordtype">int</span> m= 0;
<a name="l01238"></a>01238 
<a name="l01239"></a>01239         <span class="keywordflow">if</span> (s) {
<a name="l01240"></a>01240             m = (int)(s / 60);
<a name="l01241"></a>01241             s %= 60;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243             <span class="keywordflow">if</span> (m) {
<a name="l01244"></a>01244                 h = (int)(m / 60);
<a name="l01245"></a>01245                 m %= 60;
<a name="l01246"></a>01246             }
<a name="l01247"></a>01247         }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a071df993e13c05fc37e6f9a82c0679f5">frs_sec</a> &lt; 100)
<a name="l01250"></a>01250             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(text, <span class="keyword">sizeof</span>(text), <span class="stringliteral">&quot;%02d:%02d:%02d.%02d&quot;</span>, h, m, s, f);
<a name="l01251"></a>01251         <span class="keywordflow">else</span>
<a name="l01252"></a>01252             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(text, <span class="keyword">sizeof</span>(text), <span class="stringliteral">&quot;%02d:%02d:%02d.%03d&quot;</span>, h, m, s, f);
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>), do_prefix ? <span class="stringliteral">&quot;Time %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01255"></a>01255     }
<a name="l01256"></a>01256     <span class="keywordflow">else</span> {
<a name="l01257"></a>01257         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01258"></a>01258     }
<a name="l01259"></a>01259     
<a name="l01260"></a>01260     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9c2a347ca029693edbde71eed50250c7">R_STAMP_FRAME</a>) {
<a name="l01261"></a>01261         <span class="keywordtype">char</span> fmtstr[32];
<a name="l01262"></a>01262         <span class="keywordtype">int</span> digits= 1;
<a name="l01263"></a>01263         
<a name="l01264"></a>01264         <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>&gt;9)
<a name="l01265"></a>01265             digits= 1 + (int) log10(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#af94766d58b62a533f851ce3f42ce026c">efra</a>);
<a name="l01266"></a>01266 
<a name="l01267"></a>01267         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(fmtstr, <span class="keyword">sizeof</span>(fmtstr), do_prefix ? <span class="stringliteral">&quot;Frame %%0%di&quot;</span>:<span class="stringliteral">&quot;%%0%di&quot;</span>, digits);
<a name="l01268"></a>01268         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a> (stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>), fmtstr, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>);
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270     <span class="keywordflow">else</span> {
<a name="l01271"></a>01271         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aa36591728fead70dbc09d7ec51746f27">R_STAMP_CAMERA</a>) {
<a name="l01275"></a>01275         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>), do_prefix ? <span class="stringliteral">&quot;Camera %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, camera ? camera-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2 : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>);
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277     <span class="keywordflow">else</span> {
<a name="l01278"></a>01278         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad7eb850b434892a74a54b7ba47230cc8">R_STAMP_CAMERALENS</a>) {
<a name="l01282"></a>01282         <span class="keywordflow">if</span> (camera &amp;&amp; camera-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#afd7fa4376c670f245aeed7a7116c7005">OB_CAMERA</a>) {
<a name="l01283"></a>01283             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(text, <span class="keyword">sizeof</span>(text), <span class="stringliteral">&quot;%.2f&quot;</span>, ((<a class="code" href="../../d7/d7e/structCamera.html">Camera</a> *)camera-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;lens);
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285         <span class="keywordflow">else</span>        <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(text, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, <span class="keyword">sizeof</span>(text));
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>), do_prefix ? <span class="stringliteral">&quot;Lens %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289     <span class="keywordflow">else</span> {
<a name="l01290"></a>01290         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01291"></a>01291     }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac8b51e69ec5e97a8f0f04da0860053d0">R_STAMP_SCENE</a>) {
<a name="l01294"></a>01294         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>), do_prefix ? <span class="stringliteral">&quot;Scene %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2);
<a name="l01295"></a>01295     }
<a name="l01296"></a>01296     <span class="keywordflow">else</span> {
<a name="l01297"></a>01297         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01298"></a>01298     }
<a name="l01299"></a>01299     
<a name="l01300"></a>01300     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#acd1b8b2750249d453a5ccc49acaa98f0">R_STAMP_SEQSTRIP</a>) {
<a name="l01301"></a>01301         <a class="code" href="../../dd/d1a/structSequence.html">Sequence</a> *seq= <a class="code" href="../../d8/d5f/BKE__sequencer_8h.html#a94a69e9844ea7bbe0f5b9cd1d217ebb8">seq_foreground_frame_get</a>(scene, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>);
<a name="l01302"></a>01302     
<a name="l01303"></a>01303         <span class="keywordflow">if</span> (seq)    <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(text, seq-&gt;<a class="code" href="../../dd/d1a/structSequence.html#a2225f4aab19fa7afa3965a2502db8b81">name</a>+2, <span class="keyword">sizeof</span>(text));
<a name="l01304"></a>01304         <span class="keywordflow">else</span>        <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(text, <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, <span class="keyword">sizeof</span>(text));
<a name="l01305"></a>01305 
<a name="l01306"></a>01306         <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>), do_prefix ? <span class="stringliteral">&quot;Strip %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308     <span class="keywordflow">else</span> {
<a name="l01309"></a>01309         stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312     {
<a name="l01313"></a>01313         <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5f782432eba7e3e858fde4dfe1c61703">RE_GetRender</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l01314"></a>01314         <a class="code" href="../../d3/d01/structRenderStats.html">RenderStats</a> *stats= re ? <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ace7057580567490f3a1ecf8b19a8ccb5">RE_GetStats</a>(re):<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316         <span class="keywordflow">if</span> (stats &amp;&amp; (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a13e09864bcf66a395b5e376df0e449f0">R_STAMP_RENDERTIME</a>)) {
<a name="l01317"></a>01317             <a class="code" href="../../d3/db3/BLI__string_8h.html#adace39c768e9a88f53ae083d69d50c1b">BLI_timestr</a>(stats-&gt;<a class="code" href="../../d3/d01/structRenderStats.html#a6bacddcc33ef7cef5f536fe021c02de2">lastframetime</a>, text);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319             <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>, <span class="keyword">sizeof</span>(stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>), do_prefix ? <span class="stringliteral">&quot;RenderTime %s&quot;</span>:<span class="stringliteral">&quot;%s&quot;</span>, text);
<a name="l01320"></a>01320         }
<a name="l01321"></a>01321         <span class="keywordflow">else</span> {
<a name="l01322"></a>01322             stamp_data-&gt;<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>[0] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01323"></a>01323         }
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01327"></a><a class="code" href="../../d3/d10/image_8c.html#aaf00091dab4f64b6596365445d8b4e9b">01327</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a4e8167cb267b3763bdd0a5d9165b39cd">BKE_stamp_buf</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *camera, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rect, <span class="keywordtype">float</span> *rectf, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keywordtype">int</span> channels)
<a name="l01328"></a>01328 {
<a name="l01329"></a>01329     <span class="keyword">struct </span><a class="code" href="../../d0/d00/structStampData.html">StampData</a> stamp_data;
<a name="l01330"></a>01330     <span class="keywordtype">float</span> w, h, pad;
<a name="l01331"></a>01331     <span class="keywordtype">int</span> x, y, y_ofs;
<a name="l01332"></a>01332     <span class="keywordtype">float</span> h_fixed;
<a name="l01333"></a>01333     <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d4/dbf/text__draw_8c.html#a244ab1e1fd66d28cc40f4f17b3e43a38">mono</a>= <a class="code" href="../../df/d5d/BLF__api_8h.html#a71f6110d35c317ef24a232146937a625">blf_mono_font_render</a>; <span class="comment">// XXX</span>
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="preprocessor">#define BUFF_MARGIN_X 2</span>
<a name="l01336"></a>01336 <span class="preprocessor"></span><span class="preprocessor">#define BUFF_MARGIN_Y 1</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span>
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (!rect &amp;&amp; !rectf)
<a name="l01339"></a>01339         <span class="keywordflow">return</span>;
<a name="l01340"></a>01340     
<a name="l01341"></a>01341     <a class="code" href="../../d3/d10/image_8c.html#a7ed5d7e2e8c73fe72b7554d3e6f8eb82">stampdata</a>(scene, camera, &amp;stamp_data, 1);
<a name="l01342"></a>01342 
<a name="l01343"></a>01343     <span class="comment">/* TODO, do_versions */</span>
<a name="l01344"></a>01344     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a551a53888d16cefa2ab21a4b92002eef">stamp_font_id</a> &lt; 8)
<a name="l01345"></a>01345         scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a551a53888d16cefa2ab21a4b92002eef">stamp_font_id</a>= 12;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <span class="comment">/* set before return */</span>
<a name="l01348"></a>01348     <a class="code" href="../../df/d5d/BLF__api_8h.html#abf538c5e51c162f24cc3488b788db181">BLF_size</a>(mono, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a551a53888d16cefa2ab21a4b92002eef">stamp_font_id</a>, 72);
<a name="l01349"></a>01349     
<a name="l01350"></a>01350     <a class="code" href="../../df/d5d/BLF__api_8h.html#a1016453edfa64abbeba602f535eb9233">BLF_buffer</a>(mono, rectf, rect, width, height, channels);
<a name="l01351"></a>01351     <a class="code" href="../../df/d5d/BLF__api_8h.html#a5963a779608c29ed7f4a215fa4feb5a8">BLF_buffer_col</a>(mono, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4093cd9ba9690451433964b247d19cc1">fg_stamp</a>[0], scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4093cd9ba9690451433964b247d19cc1">fg_stamp</a>[1], scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4093cd9ba9690451433964b247d19cc1">fg_stamp</a>[2], 1.0);
<a name="l01352"></a>01352     pad= <a class="code" href="../../df/d5d/BLF__api_8h.html#a4efd8e5adc1d1583789116393e49a080">BLF_width_max</a>(mono);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     <span class="comment">/* use &#39;h_fixed&#39; rather than &#39;h&#39;, aligns better */</span>
<a name="l01355"></a>01355     h_fixed= <a class="code" href="../../df/d5d/BLF__api_8h.html#a6ad49dccd0312992269a01926096a97f">BLF_height_max</a>(mono);
<a name="l01356"></a>01356     y_ofs = -<a class="code" href="../../df/d5d/BLF__api_8h.html#a008ee9b44627f9b5ac47fd66d03383d8">BLF_descender</a>(mono);
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     x= 0;
<a name="l01359"></a>01359     y= height;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>[0]) {
<a name="l01362"></a>01362         <span class="comment">/* Top left corner */</span>
<a name="l01363"></a>01363         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01364"></a>01364         y -= h;
<a name="l01365"></a>01365 
<a name="l01366"></a>01366         <span class="comment">/* also a little of space to the background. */</span>
<a name="l01367"></a>01367         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01368"></a>01368 
<a name="l01369"></a>01369         <span class="comment">/* and draw the text. */</span>
<a name="l01370"></a>01370         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01371"></a>01371         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>);
<a name="l01372"></a>01372 
<a name="l01373"></a>01373         <span class="comment">/* the extra pixel for background. */</span>
<a name="l01374"></a>01374         y -= <a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a> * 2;
<a name="l01375"></a>01375     }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="comment">/* Top left corner, below File */</span>
<a name="l01378"></a>01378     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>[0]) {
<a name="l01379"></a>01379         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01380"></a>01380         y -= h;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382         <span class="comment">/* and space for background. */</span>
<a name="l01383"></a>01383         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, 0, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01386"></a>01386         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <span class="comment">/* the extra pixel for background. */</span>
<a name="l01389"></a>01389         y -= <a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a> * 2;
<a name="l01390"></a>01390     }
<a name="l01391"></a>01391     
<a name="l01392"></a>01392     <span class="comment">/* Top left corner, below File (or Note) */</span>
<a name="l01393"></a>01393     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>[0]) {
<a name="l01394"></a>01394         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01395"></a>01395         y -= h;
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         <span class="comment">/* and space for background. */</span>
<a name="l01398"></a>01398         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, 0, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01401"></a>01401         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>);
<a name="l01402"></a>01402 
<a name="l01403"></a>01403         <span class="comment">/* the extra pixel for background. */</span>
<a name="l01404"></a>01404         y -= <a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a> * 2;
<a name="l01405"></a>01405     }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <span class="comment">/* Top left corner, below File, Date or Note */</span>
<a name="l01408"></a>01408     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>[0]) {
<a name="l01409"></a>01409         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01410"></a>01410         y -= h;
<a name="l01411"></a>01411 
<a name="l01412"></a>01412         <span class="comment">/* and space for background. */</span>
<a name="l01413"></a>01413         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, 0, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01414"></a>01414 
<a name="l01415"></a>01415         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01416"></a>01416         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>);
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419     x= 0;
<a name="l01420"></a>01420     y= 0;
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="comment">/* Bottom left corner, leaving space for timing */</span>
<a name="l01423"></a>01423     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>[0]) {
<a name="l01424"></a>01424         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426         <span class="comment">/* extra space for background. */</span>
<a name="l01427"></a>01427         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01428"></a>01428 
<a name="l01429"></a>01429         <span class="comment">/* and pad the text. */</span>
<a name="l01430"></a>01430         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01431"></a>01431         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>);
<a name="l01432"></a>01432 
<a name="l01433"></a>01433         <span class="comment">/* space width. */</span>
<a name="l01434"></a>01434         x += w + pad;
<a name="l01435"></a>01435     }
<a name="l01436"></a>01436     
<a name="l01437"></a>01437     <span class="comment">/* Left bottom corner */</span>
<a name="l01438"></a>01438     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>[0]) {
<a name="l01439"></a>01439         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01440"></a>01440 
<a name="l01441"></a>01441         <span class="comment">/* extra space for background */</span>
<a name="l01442"></a>01442         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01443"></a>01443 
<a name="l01444"></a>01444         <span class="comment">/* and pad the text. */</span>
<a name="l01445"></a>01445         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01446"></a>01446         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>);
<a name="l01447"></a>01447 
<a name="l01448"></a>01448         <span class="comment">/* space width. */</span>
<a name="l01449"></a>01449         x += w + pad;
<a name="l01450"></a>01450     }
<a name="l01451"></a>01451     
<a name="l01452"></a>01452     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>[0]) {
<a name="l01453"></a>01453         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01454"></a>01454 
<a name="l01455"></a>01455         <span class="comment">/* extra space for background. */</span>
<a name="l01456"></a>01456         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01457"></a>01457 
<a name="l01458"></a>01458         <span class="comment">/* and pad the text. */</span>
<a name="l01459"></a>01459         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01460"></a>01460         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462         <span class="comment">/* space width. */</span>
<a name="l01463"></a>01463         x += w + pad;
<a name="l01464"></a>01464     }
<a name="l01465"></a>01465 
<a name="l01466"></a>01466     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>[0]) {
<a name="l01467"></a>01467         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         <span class="comment">/* extra space for background. */</span>
<a name="l01470"></a>01470         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01471"></a>01471         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01472"></a>01472         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>);
<a name="l01473"></a>01473 
<a name="l01474"></a>01474         <span class="comment">/* space width. */</span>
<a name="l01475"></a>01475         x += w + pad;
<a name="l01476"></a>01476     }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>[0]) {
<a name="l01479"></a>01479         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481         <span class="comment">/* extra space for background. */</span>
<a name="l01482"></a>01482         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01483"></a>01483         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01484"></a>01484         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>);
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486     
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>[0]) {
<a name="l01488"></a>01488         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490         <span class="comment">/* Bottom right corner, with an extra space because blenfont is too strict! */</span>
<a name="l01491"></a>01491         x= width - w - 2;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493         <span class="comment">/* extra space for background. */</span>
<a name="l01494"></a>01494         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01495"></a>01495 
<a name="l01496"></a>01496         <span class="comment">/* and pad the text. */</span>
<a name="l01497"></a>01497         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y+y_ofs, 0.0);
<a name="l01498"></a>01498         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>);
<a name="l01499"></a>01499     }
<a name="l01500"></a>01500     
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>[0]) {
<a name="l01502"></a>01502         <a class="code" href="../../df/d5d/BLF__api_8h.html#ae2086317ccfed7c8939757bd2b4fe09c">BLF_width_and_height</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>, &amp;w, &amp;h); h= h_fixed;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504         <span class="comment">/* Top right corner, with an extra space because blenfont is too strict! */</span>
<a name="l01505"></a>01505         x= width - w - pad;
<a name="l01506"></a>01506         y= height - h;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508         <span class="comment">/* extra space for background. */</span>
<a name="l01509"></a>01509         <a class="code" href="../../dd/d38/iff_8h.html#afe4d72872f309313e31f3f7766c7d886">buf_rectfill_area</a>(rect, rectf, width, height, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a78fed2b1e448c4d1bc03eaeba9111739">bg_stamp</a>, x-<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y-<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>, x+w+<a class="code" href="../../d3/d10/image_8c.html#a2546cdafb3f1aa9786ec5e13afccd2af">BUFF_MARGIN_X</a>, y+h+<a class="code" href="../../d3/d10/image_8c.html#a68d194730e67d51250958a944cb8b7c8">BUFF_MARGIN_Y</a>);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511         <a class="code" href="../../df/d5d/BLF__api_8h.html#af214132278e6274d6dfe0587adaa4c9f">BLF_position</a>(mono, x, y + y_ofs, 0.0);
<a name="l01512"></a>01512         <a class="code" href="../../df/d5d/BLF__api_8h.html#a02ee54914f60ac191219715a2dc7a7b3">BLF_draw_buffer</a>(mono, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>);
<a name="l01513"></a>01513     }
<a name="l01514"></a>01514 
<a name="l01515"></a>01515     <span class="comment">/* cleanup the buffer. */</span>
<a name="l01516"></a>01516     <a class="code" href="../../df/d5d/BLF__api_8h.html#a1016453edfa64abbeba602f535eb9233">BLF_buffer</a>(mono, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0, 0);
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 <span class="preprocessor">#undef BUFF_MARGIN_X</span>
<a name="l01519"></a>01519 <span class="preprocessor"></span><span class="preprocessor">#undef BUFF_MARGIN_Y</span>
<a name="l01520"></a>01520 <span class="preprocessor"></span>}
<a name="l01521"></a>01521 
<a name="l01522"></a><a class="code" href="../../d3/d10/image_8c.html#aa0191219645db7108b4e941ddb1f79a6">01522</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#aadb7c0220f78ecb257595e9fe93e8a2a">BKE_stamp_info</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>, <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>, <span class="keyword">struct</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01523"></a>01523 {
<a name="l01524"></a>01524     <span class="keyword">struct </span><a class="code" href="../../d0/d00/structStampData.html">StampData</a> stamp_data;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     <span class="keywordflow">if</span> (!ibuf)  <span class="keywordflow">return</span>;
<a name="l01527"></a>01527     
<a name="l01528"></a>01528     <span class="comment">/* fill all the data values, no prefix */</span>
<a name="l01529"></a>01529     <a class="code" href="../../d3/d10/image_8c.html#a7ed5d7e2e8c73fe72b7554d3e6f8eb82">stampdata</a>(scene, camera, &amp;stamp_data, 0);
<a name="l01530"></a>01530     
<a name="l01531"></a>01531     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>[0])     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;File&quot;</span>,        stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a2e1b1262201c1944926fd4f27ca4d665">file</a>);
<a name="l01532"></a>01532     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>[0])     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Note&quot;</span>,        stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a367dfb2576f0444077a11d2ebe5f4ba1">note</a>);
<a name="l01533"></a>01533     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>[0])     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Date&quot;</span>,        stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a181fac4331375385c5b62941e0af97f2">date</a>);
<a name="l01534"></a>01534     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>[0])   <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Marker&quot;</span>,  stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a1da53f18455bb75e2a0c4009b4ed4e87">marker</a>);
<a name="l01535"></a>01535     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>[0])     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Time&quot;</span>,        stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a6c4d3dcb5bc22795dfac7eab30efd465">time</a>);
<a name="l01536"></a>01536     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>[0])    <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Frame&quot;</span>,   stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>);
<a name="l01537"></a>01537     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>[0])   <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Camera&quot;</span>,  stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>);
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>[0]) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Lens&quot;</span>,  stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a9b177b7dea70cfc3e44b8bd0374114b1">cameralens</a>);
<a name="l01539"></a>01539     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>[0])    <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Scene&quot;</span>,   stamp_data.<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>);
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>[0])    <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;Strip&quot;</span>,   stamp_data.<a class="code" href="../../d0/d00/structStampData.html#af04722c708c1d54b37ddb07e5440c390">strip</a>);
<a name="l01541"></a>01541     <span class="keywordflow">if</span> (stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>[0]) <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4f20726fa4672b29e4fa9f6dab590efb">IMB_metadata_change_field</a> (ibuf, <span class="stringliteral">&quot;RenderTime&quot;</span>, stamp_data.<a class="code" href="../../d0/d00/structStampData.html#a04e1be8800ed044871a96f904b3dd273">rendertime</a>);
<a name="l01542"></a>01542 }
<a name="l01543"></a>01543 
<a name="l01544"></a><a class="code" href="../../d3/d10/image_8c.html#ad88a3ebcd607f3609a14ac9ce6467b00">01544</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a4642b2ecfc68056c7e6085b9c24c5ae9">BKE_alphatest_ibuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01545"></a>01545 {
<a name="l01546"></a>01546     <span class="keywordtype">int</span> tot;
<a name="l01547"></a>01547     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>) {
<a name="l01548"></a>01548         <span class="keywordtype">float</span> *buf= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>;
<a name="l01549"></a>01549         <span class="keywordflow">for</span> (tot= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; tot--; buf+=4) {
<a name="l01550"></a>01550             <span class="keywordflow">if</span> (buf[3] &lt; 1.0f) {
<a name="l01551"></a>01551                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01552"></a>01552             }
<a name="l01553"></a>01553         }
<a name="l01554"></a>01554     }
<a name="l01555"></a>01555     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>) {
<a name="l01556"></a>01556         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf= (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l01557"></a>01557         for (tot= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>; tot--; buf+=4) {
<a name="l01558"></a>01558             <span class="keywordflow">if</span> (buf[3] != 255) {
<a name="l01559"></a>01559                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01560"></a>01560             }
<a name="l01561"></a>01561         }
<a name="l01562"></a>01562     }
<a name="l01563"></a>01563 
<a name="l01564"></a>01564     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01565"></a>01565 }
<a name="l01566"></a>01566 
<a name="l01567"></a>01567 <span class="comment">/* note: imf-&gt;planes is ignored here, its assumed the image channels</span>
<a name="l01568"></a>01568 <span class="comment"> * are already set */</span>
<a name="l01569"></a><a class="code" href="../../d3/d10/image_8c.html#a13feb823ff6708b4425ef82b4219904b">01569</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d51fd72d99219f6a0dcce17d7f572ff">BKE_write_ibuf</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *imf)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571     <span class="keywordtype">char</span> imtype= imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a30929385debbd1ff586c9f9936895198">imtype</a>;
<a name="l01572"></a>01572     <span class="keywordtype">char</span> compress= imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a23f6a76d7819cb51371e9959e7ac995a">compress</a>;
<a name="l01573"></a>01573     <span class="keywordtype">char</span> quality= imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a74d5dd69af52338475a267ab8493b2f7">quality</a>;
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     <span class="keywordtype">int</span> ok;
<a name="l01576"></a>01576 
<a name="l01577"></a>01577     <span class="keywordflow">if</span> (imtype== <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a838a198a88398ec83d77d889f9ca52b5">R_IMF_IMTYPE_IRIS</a>) {
<a name="l01578"></a>01578         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ae85edbe538f26e9d7c01ce9575e5a869" title="Flag defining the components of the ImBuf struct.">IMAGIC</a>;
<a name="l01579"></a>01579     }
<a name="l01580"></a>01580 <span class="preprocessor">#ifdef WITH_HDR</span>
<a name="l01581"></a>01581 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ac1e475fdcb6a7eb0b770857d12140d4c">R_IMF_IMTYPE_RADHDR</a>) {
<a name="l01582"></a>01582         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= RADHDR;
<a name="l01583"></a>01583     }
<a name="l01584"></a>01584 <span class="preprocessor">#endif</span>
<a name="l01585"></a>01585 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a94fe4335845faafd0b969e89a13d8c76">ELEM5</a>(imtype, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0aa432f8cedf714280de0c36b5b09e86">R_IMF_IMTYPE_FFMPEG</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0ba8a90795f599d097d6d6e4c93a0a54">R_IMF_IMTYPE_H264</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2650c8ed97f9854439572ce385a54798">R_IMF_IMTYPE_THEORA</a>, <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8e584b59b3caa0328d03ec0843f43ea7">R_IMF_IMTYPE_XVID</a>)) {
<a name="l01586"></a>01586         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad6bec103484565aa82456b4bb4e60814" title="Flag defining the components of the ImBuf struct.">PNG</a>;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6a1d65e05ddade83407a62db2df2db0a">R_IMF_IMTYPE_PNG</a>)
<a name="l01589"></a>01589             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= compress;
<a name="l01590"></a>01590 
<a name="l01591"></a>01591     }
<a name="l01592"></a>01592 <span class="preprocessor">#ifdef WITH_DDS</span>
<a name="l01593"></a>01593 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab8f9809a7c94e40bb7cd8a122dab222e">R_IMF_IMTYPE_DDS</a>) {
<a name="l01594"></a>01594         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= DDS;
<a name="l01595"></a>01595     }
<a name="l01596"></a>01596 <span class="preprocessor">#endif</span>
<a name="l01597"></a>01597 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a828427466ac5c0514afb0b4d7f3f2d3c">R_IMF_IMTYPE_BMP</a>) {
<a name="l01598"></a>01598         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a185d03d5cf2972932cb724502a847d7d" title="Flag defining the components of the ImBuf struct.">BMP</a>;
<a name="l01599"></a>01599     }
<a name="l01600"></a>01600 <span class="preprocessor">#ifdef WITH_TIFF</span>
<a name="l01601"></a>01601 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4ae0c9079524f481d318b397fd060bb5">R_IMF_IMTYPE_TIFF</a>) {
<a name="l01602"></a>01602         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= TIF;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604         <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#ada08bec60e3ea645cefb195d125e978b">depth</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>)
<a name="l01605"></a>01605             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= TIF_16BIT;
<a name="l01606"></a>01606     }
<a name="l01607"></a>01607 <span class="preprocessor">#endif</span>
<a name="l01608"></a>01608 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l01609"></a>01609 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae55ca7dec6a00559503bd82951e35b72">R_IMF_IMTYPE_OPENEXR</a> || imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7afb95d1e6ad462626ad5d21190ba54e">R_IMF_IMTYPE_MULTILAYER</a>) {
<a name="l01610"></a>01610         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac23ddaa6ad1b9434bb6ad46c660eeec2" title="Flag defining the components of the ImBuf struct.">OPENEXR</a>;
<a name="l01611"></a>01611         <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#ada08bec60e3ea645cefb195d125e978b">depth</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>)
<a name="l01612"></a>01612             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a1035af88adea1ff2ef48dfae4d79b28a" title="Flag defining the components of the ImBuf struct.">OPENEXR_HALF</a>;
<a name="l01613"></a>01613         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#ad5f4a2d09c8c7b6f0cd5072daba6f186">exr_codec</a> &amp; <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#afcec788c8ce217c0cb76b0a0ad82f275" title="Flag defining the components of the ImBuf struct.">OPENEXR_COMPRESS</a>);
<a name="l01614"></a>01614         
<a name="l01615"></a>01615         <span class="keywordflow">if</span> (!(imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#adb094a1f090338e9eb9fa3b341373577">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae32b2586b603ebd4cd8c6ce5b4844f9b">R_IMF_FLAG_ZBUF</a>))
<a name="l01616"></a>01616             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;    <span class="comment">/* signal for exr saving */</span>
<a name="l01617"></a>01617         
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619 <span class="preprocessor">#endif</span>
<a name="l01620"></a>01620 <span class="preprocessor"></span><span class="preprocessor">#ifdef WITH_CINEON</span>
<a name="l01621"></a>01621 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2e6d0c304976306261c3fb5874faacc0">R_IMF_IMTYPE_CINEON</a>) {
<a name="l01622"></a>01622         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> = CINEON;
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab1dfd1d830353da25a5be41ba7d89d24">R_IMF_IMTYPE_DPX</a>) {
<a name="l01625"></a>01625         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> = DPX;
<a name="l01626"></a>01626     }
<a name="l01627"></a>01627 <span class="preprocessor">#endif</span>
<a name="l01628"></a>01628 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a09761775d9430e54e98c4b49901bb528">R_IMF_IMTYPE_TARGA</a>) {
<a name="l01629"></a>01629         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a786bc8a358fdcec22501b3668f18b00a" title="Flag defining the components of the ImBuf struct.">TGA</a>;
<a name="l01630"></a>01630     }
<a name="l01631"></a>01631     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6223067ff2dcd187c245153a7bf89261">R_IMF_IMTYPE_RAWTGA</a>) {
<a name="l01632"></a>01632         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a3aaeb3db3191e2e9b7ee544d64871f2e" title="Flag defining the components of the ImBuf struct.">RAWTGA</a>;
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634 <span class="preprocessor">#ifdef WITH_OPENJPEG</span>
<a name="l01635"></a>01635 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imtype==<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4fa48469f45908f0a89d41bcf4a4f486">R_IMF_IMTYPE_JP2</a>) {
<a name="l01636"></a>01636         <span class="keywordflow">if</span> (quality &lt; 10) quality= 90;
<a name="l01637"></a>01637         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= JP2|quality;
<a name="l01638"></a>01638         
<a name="l01639"></a>01639         <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#ada08bec60e3ea645cefb195d125e978b">depth</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7a5fd1dc06392cd33f368a397b2010f1">R_IMF_CHAN_DEPTH_16</a>) {
<a name="l01640"></a>01640             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= JP2_16BIT;
<a name="l01641"></a>01641         }
<a name="l01642"></a>01642         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#ada08bec60e3ea645cefb195d125e978b">depth</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#abe26906dae13c2271cd16a71a2d7db85">R_IMF_CHAN_DEPTH_12</a>) {
<a name="l01643"></a>01643             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= JP2_12BIT;
<a name="l01644"></a>01644         }
<a name="l01645"></a>01645         
<a name="l01646"></a>01646         <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a62c33bb8399f0d009ccbfe9762b19bf6">jp2_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#accb21ff83c17732b11a9737ad154a1a7">R_IMF_JP2_FLAG_YCC</a>) {
<a name="l01647"></a>01647             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= JP2_YCC;
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649 
<a name="l01650"></a>01650         <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a62c33bb8399f0d009ccbfe9762b19bf6">jp2_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a7fabf0b33c9bd083d7791072f7ff2b3c">R_IMF_JP2_FLAG_CINE_PRESET</a>) {
<a name="l01651"></a>01651             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= JP2_CINE;
<a name="l01652"></a>01652             <span class="keywordflow">if</span> (imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#a62c33bb8399f0d009ccbfe9762b19bf6">jp2_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aceb66a8f728aa53097b1564a12d2c146">R_IMF_JP2_FLAG_CINE_48</a>)
<a name="l01653"></a>01653                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a> |= JP2_CINE_48FPS;
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656 <span class="preprocessor">#endif</span>
<a name="l01657"></a>01657 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
<a name="l01658"></a>01658         <span class="comment">/* R_IMF_IMTYPE_JPEG90, etc. default we save jpegs */</span>
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (quality &lt; 10) quality= 90;
<a name="l01660"></a>01660         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a43488598a405ffcd2a6d435eb9638257" title="Flag defining the components of the ImBuf struct.">JPG</a>|quality;
<a name="l01661"></a>01661     }
<a name="l01662"></a>01662     
<a name="l01663"></a>01663     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a050025994d6d5f2183dad14b383d0854">BLI_make_existing_file</a>(name);
<a name="l01664"></a>01664     
<a name="l01665"></a>01665     ok = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a59c3289b30d140a0032c85110496dbbc">IMB_saveiff</a>(ibuf, name, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a608c787ed430e12abfb59fda71486191" title="Flag defining the components of the ImBuf struct.">IB_zbuf</a> | <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad0b0d2d177773cca2507492d0a2bc5a4" title="Flag defining the components of the ImBuf struct.">IB_zbuffloat</a>);
<a name="l01666"></a>01666     <span class="keywordflow">if</span> (ok == 0) {
<a name="l01667"></a>01667         perror(name);
<a name="l01668"></a>01668     }
<a name="l01669"></a>01669     
<a name="l01670"></a>01670     <span class="keywordflow">return</span>(ok);
<a name="l01671"></a>01671 }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 <span class="comment">/* same as BKE_write_ibuf() but crappy workaround not to perminantly modify</span>
<a name="l01674"></a>01674 <span class="comment"> * _some_, values in the imbuf */</span>
<a name="l01675"></a><a class="code" href="../../d3/d10/image_8c.html#a4b442221310381f724f478b6adbc219d">01675</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a0f46d70ffa7da929470128807934b974">BKE_write_ibuf_as</a>(<a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *imf,
<a name="l01676"></a>01676                       <span class="keyword">const</span> <span class="keywordtype">short</span> save_copy)
<a name="l01677"></a>01677 {
<a name="l01678"></a>01678     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> ibuf_back= *ibuf;
<a name="l01679"></a>01679     <span class="keywordtype">int</span> ok;
<a name="l01680"></a>01680 
<a name="l01681"></a>01681     <span class="comment">/* all data is rgba anyway,</span>
<a name="l01682"></a>01682 <span class="comment">     * this just controls how to save for some formats */</span>
<a name="l01683"></a>01683     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>= imf-&gt;<a class="code" href="../../da/d23/structImageFormatData.html#aedc2ed8969621f3903a6fee8eeb098c9">planes</a>;
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     ok= <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d51fd72d99219f6a0dcce17d7f572ff">BKE_write_ibuf</a>(ibuf, name, imf);
<a name="l01686"></a>01686 
<a name="l01687"></a>01687     <span class="keywordflow">if</span> (save_copy) {
<a name="l01688"></a>01688         <span class="comment">/* note that we are not restoring _all_ settings */</span>
<a name="l01689"></a>01689         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>= ibuf_back.<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>;
<a name="l01690"></a>01690         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>=  ibuf_back.<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>;
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="keywordflow">return</span> ok;
<a name="l01694"></a>01694 }
<a name="l01695"></a>01695 
<a name="l01696"></a><a class="code" href="../../d3/d10/image_8c.html#a45f3a72a0c14387069b8f61c78e57dd9">01696</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a74d25ccc0a9d3278749ac8eb78570b2d">BKE_write_ibuf_stamp</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *<a class="code" href="../../d0/d00/structStampData.html#aecb5972706337bc0e8ba569256cda8e3">scene</a>, <span class="keyword">struct</span> <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../d0/d00/structStampData.html#a075fe66d301defdb76131feb76e9d5a3">camera</a>, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">struct</span> <a class="code" href="../../da/d23/structImageFormatData.html">ImageFormatData</a> *imf)
<a name="l01697"></a>01697 {
<a name="l01698"></a>01698     <span class="keywordflow">if</span> (scene &amp;&amp; scene-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1a66c7d9654a5c68107ca7bef99d9cb3">stamp</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a0a02515437573c3cd21fc13360be05bf">R_STAMP_ALL</a>)
<a name="l01699"></a>01699         <a class="code" href="../../d2/d77/BKE__image_8h.html#aadb7c0220f78ecb257595e9fe93e8a2a">BKE_stamp_info</a>(scene, camera, ibuf);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <span class="keywordflow">return</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d51fd72d99219f6a0dcce17d7f572ff">BKE_write_ibuf</a>(ibuf, name, imf);
<a name="l01702"></a>01702 }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704 
<a name="l01705"></a><a class="code" href="../../d3/d10/image_8c.html#a0f3fdbde463db462bc2d403426c6fda7">01705</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a0f3fdbde463db462bc2d403426c6fda7">BKE_makepicstring</a>(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *base, <span class="keyword">const</span> <span class="keywordtype">char</span> *relbase, <span class="keywordtype">int</span> <a class="code" href="../../d0/d00/structStampData.html#a5736ccacc95f30da39efae7c85e7c272">frame</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> imtype, <span class="keyword">const</span> <span class="keywordtype">short</span> use_ext, <span class="keyword">const</span> <span class="keywordtype">short</span> use_frames)
<a name="l01706"></a>01706 {
<a name="l01707"></a>01707     <span class="keywordflow">if</span> (<span class="keywordtype">string</span>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l01708"></a>01708     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(<span class="keywordtype">string</span>, base, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a> - 10);   <span class="comment">/* weak assumption */</span>
<a name="l01709"></a>01709     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(<span class="keywordtype">string</span>, relbase);
<a name="l01710"></a>01710 
<a name="l01711"></a>01711     <span class="keywordflow">if</span> (use_frames)
<a name="l01712"></a>01712         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a57e90c5ab9a8c42672bb881833b4bde0">BLI_path_frame</a>(<span class="keywordtype">string</span>, frame, 4);
<a name="l01713"></a>01713 
<a name="l01714"></a>01714     <span class="keywordflow">if</span> (use_ext)
<a name="l01715"></a>01715         <a class="code" href="../../d2/d77/BKE__image_8h.html#a2718a30a9eda11c50db8429549a7d8d6">BKE_add_image_extension</a>(<span class="keywordtype">string</span>, imtype);
<a name="l01716"></a>01716         
<a name="l01717"></a>01717 }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719 <span class="comment">/* used by sequencer too */</span>
<a name="l01720"></a><a class="code" href="../../d3/d10/image_8c.html#a5bcb7aaaa54ec946022e07510eddbcaa">01720</a> <span class="keyword">struct </span><a class="code" href="../../d6/d4a/structanim.html">anim</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a5bcb7aaaa54ec946022e07510eddbcaa">openanim</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/d4a/structanim.html#ac23d5b1c7d3af9af87671ba4d7a4eb25">name</a>, <span class="keywordtype">int</span> flags, <span class="keywordtype">int</span> <a class="code" href="../../d6/d4a/structanim.html#abe269ad16f82b79201b6abe7793d8538">streamindex</a>)
<a name="l01721"></a>01721 {
<a name="l01722"></a>01722     <span class="keyword">struct </span><a class="code" href="../../d6/d4a/structanim.html">anim</a> *<a class="code" href="../../d6/d4a/structanim.html">anim</a>;
<a name="l01723"></a>01723     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l01724"></a>01724     
<a name="l01725"></a>01725     anim = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a35b89c9dfb5afe12fe9fd596c0c395c9">IMB_open_anim</a>(name, flags, streamindex);
<a name="l01726"></a>01726     <span class="keywordflow">if</span> (anim == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728     ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aea47315b3c671962f07d937509eeb38e">IMB_anim_absolute</a>(anim, 0, <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aff5caa59b0951e087034606a3c6e9f1ca5b974c2275e784c1f24a3fe025379343">IMB_TC_NONE</a>, <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40bf8eb133a4eebf0b19a25cf1cd68b9aed5cd6acdce80ab41093059cede0c494">IMB_PROXY_NONE</a>);
<a name="l01729"></a>01729     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d63/BLI__fileops_8h.html#a0bf59749f87b0f283c37e27e72029591">BLI_exists</a>(name))
<a name="l01731"></a>01731             printf(<span class="stringliteral">&quot;not an anim: %s\n&quot;</span>, name);
<a name="l01732"></a>01732         <span class="keywordflow">else</span>
<a name="l01733"></a>01733             printf(<span class="stringliteral">&quot;anim file doesn&#39;t exist: %s\n&quot;</span>, name);
<a name="l01734"></a>01734         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a26badb7e7f07e5f747cfceca2ebbb3c7">IMB_free_anim</a>(anim);
<a name="l01735"></a>01735         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01736"></a>01736     }
<a name="l01737"></a>01737     <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l01738"></a>01738     
<a name="l01739"></a>01739     <span class="keywordflow">return</span>(anim);
<a name="l01740"></a>01740 }
<a name="l01741"></a>01741 
<a name="l01742"></a>01742 <span class="comment">/* ************************* New Image API *************** */</span>
<a name="l01743"></a>01743 
<a name="l01744"></a>01744 
<a name="l01745"></a>01745 <span class="comment">/* Notes about Image storage </span>
<a name="l01746"></a>01746 <span class="comment"> * - packedfile</span>
<a name="l01747"></a>01747 <span class="comment"> *   -&gt; written in .blend</span>
<a name="l01748"></a>01748 <span class="comment"> * - filename</span>
<a name="l01749"></a>01749 <span class="comment"> *   -&gt; written in .blend</span>
<a name="l01750"></a>01750 <span class="comment"> * - movie</span>
<a name="l01751"></a>01751 <span class="comment"> *   -&gt; comes from packedfile or filename</span>
<a name="l01752"></a>01752 <span class="comment"> * - renderresult</span>
<a name="l01753"></a>01753 <span class="comment"> *   -&gt; comes from packedfile or filename</span>
<a name="l01754"></a>01754 <span class="comment"> * - listbase</span>
<a name="l01755"></a>01755 <span class="comment"> *   -&gt; ibufs from exrhandle</span>
<a name="l01756"></a>01756 <span class="comment"> * - flipbook array</span>
<a name="l01757"></a>01757 <span class="comment"> *   -&gt; ibufs come from movie, temporary renderresult or sequence</span>
<a name="l01758"></a>01758 <span class="comment"> * - ibuf</span>
<a name="l01759"></a>01759 <span class="comment"> *   -&gt; comes from packedfile or filename or generated</span>
<a name="l01760"></a>01760 <span class="comment"> */</span>
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 
<a name="l01763"></a>01763 <span class="comment">/* forces existence of 1 Image for renderout or nodes, returns Image */</span>
<a name="l01764"></a>01764 <span class="comment">/* name is only for default, when making new one */</span>
<a name="l01765"></a><a class="code" href="../../d3/d10/image_8c.html#af8c9a5de754c22b63b81c3bf5adebcff">01765</a> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#acadfd029703b4c5129e5e763506421a5">BKE_image_verify_viewer</a>(<span class="keywordtype">int</span> type, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>)
<a name="l01766"></a>01766 {
<a name="l01767"></a>01767     <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima;
<a name="l01768"></a>01768     
<a name="l01769"></a>01769     <span class="keywordflow">for</span> (ima=<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;image.first; ima; ima= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l01770"></a>01770         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>)
<a name="l01771"></a>01771             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==type)
<a name="l01772"></a>01772                 <span class="keywordflow">break</span>;
<a name="l01773"></a>01773     
<a name="l01774"></a>01774     <span class="keywordflow">if</span> (ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01775"></a>01775         ima= <a class="code" href="../../d3/d10/image_8c.html#a64891ee46e099020688a96a050bae8de">image_alloc</a>(name, <a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>, type);
<a name="l01776"></a>01776     
<a name="l01777"></a>01777     <span class="comment">/* happens on reload, imagewindow cannot be image user when hidden*/</span>
<a name="l01778"></a>01778     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a>==0)
<a name="l01779"></a>01779         <a class="code" href="../../d8/db1/BKE__library_8h.html#a967d1ceef29b2612ef6e03194c512ad6">id_us_plus</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     <span class="keywordflow">return</span> ima;
<a name="l01782"></a>01782 }
<a name="l01783"></a>01783 
<a name="l01784"></a><a class="code" href="../../d3/d10/image_8c.html#a280d1d44b0752fb44daacda75be705ea">01784</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#aa1b596f8ebd2aff5ec7c5870bcd3c733">BKE_image_assign_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01785"></a>01785 {
<a name="l01786"></a>01786     <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l01787"></a>01787 }
<a name="l01788"></a>01788 
<a name="l01789"></a><a class="code" href="../../d3/d10/image_8c.html#a46794ad0740418aa1777cb00c5347bfc">01789</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a620aff00ed883501ed144c0c7752b40f">BKE_image_signal</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> signal)
<a name="l01790"></a>01790 {
<a name="l01791"></a>01791     <span class="keywordflow">if</span> (ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01792"></a>01792         <span class="keywordflow">return</span>;
<a name="l01793"></a>01793     
<a name="l01794"></a>01794     <span class="keywordflow">switch</span>(signal) {
<a name="l01795"></a>01795     <span class="keywordflow">case</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a7fd26b4828a6aedc7781fb5c2dffa258">IMA_SIGNAL_FREE</a>:
<a name="l01796"></a>01796         <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l01797"></a>01797         <span class="keywordflow">if</span> (iuser)
<a name="l01798"></a>01798             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= 1;
<a name="l01799"></a>01799         <span class="keywordflow">break</span>;
<a name="l01800"></a>01800     <span class="keywordflow">case</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a8f7d18d440609828cf0775115e645b6c">IMA_SIGNAL_SRC_CHANGE</a>:
<a name="l01801"></a>01801         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#a0d0a69a6ac57ac330e6f263cef3d4d22">IMA_TYPE_UV_TEST</a>)
<a name="l01802"></a>01802             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> != <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>)
<a name="l01803"></a>01803                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l01804"></a>01804 
<a name="l01805"></a>01805         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l01806"></a>01806             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>==0 || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>==0) {
<a name="l01807"></a>01807                 <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l01808"></a>01808                 <span class="keywordflow">if</span> (ibuf) {
<a name="l01809"></a>01809                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>;
<a name="l01810"></a>01810                     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l01811"></a>01811                 }
<a name="l01812"></a>01812             }
<a name="l01813"></a>01813         }
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="comment">/* force reload on first use, but not for multilayer, that makes nodes and buttons in ui drawing fail */</span>
<a name="l01816"></a>01816         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>!=<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>)
<a name="l01817"></a>01817             <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 1;
<a name="l01820"></a>01820         <span class="keywordflow">if</span> (iuser)
<a name="l01821"></a>01821             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= 1;
<a name="l01822"></a>01822         <span class="keywordflow">break</span>;
<a name="l01823"></a>01823             
<a name="l01824"></a>01824     <span class="keywordflow">case</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#aa619ce3aeb222fab77d1566c1798b1c1">IMA_SIGNAL_RELOAD</a>:
<a name="l01825"></a>01825         <span class="comment">/* try to repack file */</span>
<a name="l01826"></a>01826         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>) {
<a name="l01827"></a>01827             <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l01828"></a>01828             pf = <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l01829"></a>01829             <span class="keywordflow">if</span> (pf) {
<a name="l01830"></a>01830                 <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>);
<a name="l01831"></a>01831                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> = <a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l01832"></a>01832                 <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l01833"></a>01833             }
<a name="l01834"></a>01834             <span class="keywordflow">else</span> {
<a name="l01835"></a>01835                 printf(<span class="stringliteral">&quot;ERROR: Image not available. Keeping packed image\n&quot;</span>);
<a name="l01836"></a>01836             }
<a name="l01837"></a>01837         }
<a name="l01838"></a>01838         <span class="keywordflow">else</span>
<a name="l01839"></a>01839             <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l01840"></a>01840         
<a name="l01841"></a>01841         <span class="keywordflow">if</span> (iuser)
<a name="l01842"></a>01842             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= 1;
<a name="l01843"></a>01843         
<a name="l01844"></a>01844         <span class="keywordflow">break</span>;
<a name="l01845"></a>01845     <span class="keywordflow">case</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a9d7a62afa600e926af85c2afce656475">IMA_SIGNAL_USER_NEW_IMAGE</a>:
<a name="l01846"></a>01846         <span class="keywordflow">if</span> (iuser) {
<a name="l01847"></a>01847             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= 1;
<a name="l01848"></a>01848             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a> || ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>) {
<a name="l01849"></a>01849                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>) {
<a name="l01850"></a>01850                     iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>= 0;
<a name="l01851"></a>01851                     iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a78c9cbc71d3fe8ba5ca74ec74b1b0045">layer</a>= iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ad0d893d9033142501ee8c3a715855200">pass</a>= 0;
<a name="l01852"></a>01852                 }
<a name="l01853"></a>01853             }
<a name="l01854"></a>01854         }
<a name="l01855"></a>01855         <span class="keywordflow">break</span>;
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857     
<a name="l01858"></a>01858     <span class="comment">/* don&#39;t use notifiers because they are not 100% sure to succeeded</span>
<a name="l01859"></a>01859 <span class="comment">     * this also makes sure all scenes are accounted for. */</span>
<a name="l01860"></a>01860     {
<a name="l01861"></a>01861         <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene;
<a name="l01862"></a>01862         <span class="keywordflow">for</span> (scene= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;scene.first; scene; scene= scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>) {
<a name="l01863"></a>01863             <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a09a194ec2fd08925c48b3d0a692bd14d">nodetree</a>) {
<a name="l01864"></a>01864                 <a class="code" href="../../d4/d91/BKE__node_8h.html#a7f3de8e85e038cac2d3843fd77a8f05e">nodeUpdateID</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a09a194ec2fd08925c48b3d0a692bd14d">nodetree</a>, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>);
<a name="l01865"></a>01865             }
<a name="l01866"></a>01866         }
<a name="l01867"></a>01867     }
<a name="l01868"></a>01868 }
<a name="l01869"></a>01869 
<a name="l01870"></a>01870 <span class="comment">/* if layer or pass changes, we need an index for the imbufs list */</span>
<a name="l01871"></a>01871 <span class="comment">/* note it is called for rendered results, but it doesnt use the index! */</span>
<a name="l01872"></a>01872 <span class="comment">/* and because rendered results use fake layer/passes, don&#39;t correct for wrong indices here */</span>
<a name="l01873"></a><a class="code" href="../../d3/d10/image_8c.html#ac3b5b9e78eac207b6244a2106e8595e2">01873</a> <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a688c220fe933298aa0c2b70c5539cd29">BKE_image_multilayer_index</a>(<a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> *rr, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser)
<a name="l01874"></a>01874 {
<a name="l01875"></a>01875     <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl;
<a name="l01876"></a>01876     <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01877"></a>01877     
<a name="l01878"></a>01878     <span class="keywordflow">if</span> (rr==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l01879"></a>01879         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01880"></a>01880     
<a name="l01881"></a>01881     <span class="keywordflow">if</span> (iuser) {
<a name="l01882"></a>01882         <span class="keywordtype">short</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>= 0, rl_index= 0, rp_index;
<a name="l01883"></a>01883         
<a name="l01884"></a>01884         <span class="keywordflow">for</span> (rl= rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a56f453254756e82da4cec4ddc516b167">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rl; rl= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#abfeeaf162137025af0a017c377a24a12">next</a>, rl_index++) {
<a name="l01885"></a>01885             rp_index= 0;
<a name="l01886"></a>01886             <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>, index++, rp_index++)
<a name="l01887"></a>01887                 <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a78c9cbc71d3fe8ba5ca74ec74b1b0045">layer</a>==rl_index &amp;&amp; iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ad0d893d9033142501ee8c3a715855200">pass</a>==rp_index)
<a name="l01888"></a>01888                     <span class="keywordflow">break</span>;
<a name="l01889"></a>01889             <span class="keywordflow">if</span> (rpass)
<a name="l01890"></a>01890                 <span class="keywordflow">break</span>;
<a name="l01891"></a>01891         }
<a name="l01892"></a>01892         
<a name="l01893"></a>01893         <span class="keywordflow">if</span> (rpass)
<a name="l01894"></a>01894             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>= <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l01895"></a>01895         <span class="keywordflow">else</span> 
<a name="l01896"></a>01896             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>= 0;
<a name="l01897"></a>01897     }
<a name="l01898"></a>01898     <span class="keywordflow">if</span> (rpass==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01899"></a>01899         rl= rr-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a56f453254756e82da4cec4ddc516b167">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01900"></a>01900         <span class="keywordflow">if</span> (rl)
<a name="l01901"></a>01901             rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l01902"></a>01902     }
<a name="l01903"></a>01903     
<a name="l01904"></a>01904     <span class="keywordflow">return</span> rpass;
<a name="l01905"></a>01905 }
<a name="l01906"></a>01906 
<a name="l01907"></a><a class="code" href="../../d3/d10/image_8c.html#aaffff4f64f035a3c94dd3613e9577522">01907</a> <a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a171026b95d3a957947f5d797727e91d9">BKE_image_acquire_renderresult</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l01908"></a>01908 {
<a name="l01909"></a>01909     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l01910"></a>01910         <span class="keywordflow">return</span> ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>;
<a name="l01911"></a>01911     }
<a name="l01912"></a>01912     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>) {
<a name="l01913"></a>01913         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> == ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>)
<a name="l01914"></a>01914             <span class="keywordflow">return</span> <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#af6d28aef624e60c6648ce463b73d0205">RE_AcquireResultRead</a>(<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5f782432eba7e3e858fde4dfe1c61703">RE_GetRender</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>));
<a name="l01915"></a>01915         <span class="keywordflow">else</span>
<a name="l01916"></a>01916             <span class="keywordflow">return</span> ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>];
<a name="l01917"></a>01917     }
<a name="l01918"></a>01918     <span class="keywordflow">else</span>
<a name="l01919"></a>01919         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01920"></a>01920 }
<a name="l01921"></a>01921 
<a name="l01922"></a><a class="code" href="../../d3/d10/image_8c.html#a289ea1c975869f77cdaacdaf0b7186bd">01922</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ab8d0892c3d178db229ae5a10938906dd">BKE_image_release_renderresult</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l01923"></a>01923 {
<a name="l01924"></a>01924     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>);
<a name="l01925"></a>01925     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>) {
<a name="l01926"></a>01926         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> == ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>)
<a name="l01927"></a>01927             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a40aac4c20c30072863c8fd25f35343c5">RE_ReleaseResult</a>(<a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5f782432eba7e3e858fde4dfe1c61703">RE_GetRender</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>));
<a name="l01928"></a>01928     }
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01931"></a><a class="code" href="../../d3/d10/image_8c.html#aaee30f8a7646c003032717244034bb4b">01931</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#ab604d955fe5955294ab3428cda98a9a5">BKE_image_backup_render</a>(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima)
<a name="l01932"></a>01932 {
<a name="l01933"></a>01933     <span class="comment">/* called right before rendering, ima-&gt;renders contains render</span>
<a name="l01934"></a>01934 <span class="comment">     * result pointers for everything but the current render */</span>
<a name="l01935"></a>01935     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5f782432eba7e3e858fde4dfe1c61703">RE_GetRender</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l01936"></a>01936     <span class="keywordtype">int</span> slot= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>, last= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938     <span class="keywordflow">if</span> (slot != last) {
<a name="l01939"></a>01939         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[slot]) {
<a name="l01940"></a>01940             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a9db5615079ab1315b62597db8f75db54">RE_FreeRenderResult</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[slot]);
<a name="l01941"></a>01941             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[slot]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01942"></a>01942         }
<a name="l01943"></a>01943 
<a name="l01944"></a>01944         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[last]= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01945"></a>01945         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a88329a3ce531b7982be5d811c3d09a72">RE_SwapResult</a>(re, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[last]);
<a name="l01946"></a>01946     }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>= slot;
<a name="l01949"></a>01949 }
<a name="l01950"></a>01950 
<a name="l01951"></a>01951 <span class="comment">/* after imbuf load, openexr type can return with a exrhandle open */</span>
<a name="l01952"></a>01952 <span class="comment">/* in that case we have to build a render-result */</span>
<a name="l01953"></a><a class="code" href="../../d3/d10/image_8c.html#acaa11aee43b91f5df95a3ca0b90e9a60">01953</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#acaa11aee43b91f5df95a3ca0b90e9a60">image_create_multilayer</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf, <span class="keywordtype">int</span> framenr)
<a name="l01954"></a>01954 {
<a name="l01955"></a>01955     
<a name="l01956"></a>01956     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a8e6292423c61ec5e5297c2da97972032">RE_MultilayerConvert</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>);
<a name="l01957"></a>01957 
<a name="l01958"></a>01958 <span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l01959"></a>01959 <span class="preprocessor"></span>    <a class="code" href="../../d2/d16/openexr__api_8cpp.html#a42e5c3cfa8fd0b40713429c8187dc9c0">IMB_exr_close</a>(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>);
<a name="l01960"></a>01960 <span class="preprocessor">#endif</span>
<a name="l01961"></a>01961 <span class="preprocessor"></span>
<a name="l01962"></a>01962     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01963"></a>01963     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>)
<a name="l01964"></a>01964         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a97bbd3253a22e400113173e218bd624c">framenr</a>= framenr;
<a name="l01965"></a>01965 }
<a name="l01966"></a>01966 
<a name="l01967"></a>01967 <span class="comment">/* common stuff to do with images after loading */</span>
<a name="l01968"></a><a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">01968</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l01969"></a>01969 {
<a name="l01970"></a>01970     <span class="comment">/* preview is NULL when it has never been used as an icon before */</span>
<a name="l01971"></a>01971     <span class="keywordflow">if</span> (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.background==0 &amp;&amp; ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a1c97663701a45c784752d88b3e9b1749">preview</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01972"></a>01972         <a class="code" href="../../d4/d32/BKE__icons_8h.html#a75fc479411d6336b043f38b19885ad90">BKE_icon_changed</a>(<a class="code" href="../../d4/d32/BKE__icons_8h.html#a7c1c9f16a87653cd5287caf99299f348">BKE_icon_getid</a>(&amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <span class="comment">/* fields */</span>
<a name="l01975"></a>01975     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a024d51a9f926340fb55740ad53b6d6ec">IMA_FIELDS</a>) {
<a name="l01976"></a>01976         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a3a52fcd61acebc5d734fcb820e62fabc">IMA_STD_FIELD</a>) <a class="code" href="../../d3/d10/image_8c.html#a383b7d8fe6893205d5892d38b5d0519c">de_interlace_st</a>(ibuf);
<a name="l01977"></a>01977         <span class="keywordflow">else</span> <a class="code" href="../../d3/d10/image_8c.html#a7f0f36d355c6738f800663d16f518753">de_interlace_ng</a>(ibuf);
<a name="l01978"></a>01978     }
<a name="l01979"></a>01979     <span class="comment">/* timer */</span>
<a name="l01980"></a>01980     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a5c406458238f8dd71153fc561216677b">lastused</a> = clock() / CLOCKS_PER_SEC;
<a name="l01981"></a>01981     
<a name="l01982"></a>01982     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>;
<a name="l01983"></a>01983     
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a><a class="code" href="../../d3/d10/image_8c.html#a682e2232b1935fd8116a6eb0d81a1d4a">01986</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a682e2232b1935fd8116a6eb0d81a1d4a">image_load_sequence_file</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> frame)
<a name="l01987"></a>01987 {
<a name="l01988"></a>01988     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l01989"></a>01989     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> numlen;
<a name="l01990"></a>01990     <span class="keywordtype">char</span> <a class="code" href="../../d3/dd9/structImBuf.html#a19aecd6c1f8855b0bb40f877fa01633f">name</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], head[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>], tail[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l01991"></a>01991     <span class="keywordtype">int</span> flag;
<a name="l01992"></a>01992     
<a name="l01993"></a>01993     <span class="comment">/* XXX temp stuff? */</span>
<a name="l01994"></a>01994     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a> != frame)
<a name="l01995"></a>01995         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> |= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad8a2bf777fd3d318388ae52b3080df68">IMA_TPAGE_REFRESH</a>;
<a name="l01996"></a>01996 
<a name="l01997"></a>01997     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a>= frame;
<a name="l01998"></a>01998     <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(name, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="keyword">sizeof</span>(name));
<a name="l01999"></a>01999     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#ad1455f1d2df23ea66d7b1bf46adff870">BLI_stringdec</a>(name, head, tail, &amp;numlen);
<a name="l02000"></a>02000     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a9cb5dd722995bcaf96c1fabef98be6bc">BLI_stringenc</a>(name, head, tail, numlen, frame);
<a name="l02001"></a>02001 
<a name="l02002"></a>02002     <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(name, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l02003"></a>02003     
<a name="l02004"></a>02004     flag= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ab86521a39a5155a4f87545b41d35a18b" title="Flag defining the components of the ImBuf struct.">IB_multilayer</a>;
<a name="l02005"></a>02005     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a1312f80c28583b65a650fc20f0a815d0">IMA_DO_PREMUL</a>)
<a name="l02006"></a>02006         flag |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a4fb3cfdbd9ef49f944ea774636bdbbca" title="Flag defining the components of the ImBuf struct.">IB_premul</a>;
<a name="l02007"></a>02007 
<a name="l02008"></a>02008     <span class="comment">/* read ibuf */</span>
<a name="l02009"></a>02009     ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ad9841de487be5fa3a88602b144ad9c2d">IMB_loadiffname</a>(name, flag);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011 <span class="preprocessor">#if 0</span>
<a name="l02012"></a>02012 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ibuf) {
<a name="l02013"></a>02013         printf(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad37a804df2a1060b453ce07fe0ee3cbc">AT</a><span class="stringliteral">&quot; loaded %s\n&quot;</span>, name);
<a name="l02014"></a>02014     }
<a name="l02015"></a>02015     <span class="keywordflow">else</span> {
<a name="l02016"></a>02016         printf(<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad37a804df2a1060b453ce07fe0ee3cbc">AT</a><span class="stringliteral">&quot; missed %s\n&quot;</span>, name);
<a name="l02017"></a>02017     }
<a name="l02018"></a>02018 <span class="preprocessor">#endif</span>
<a name="l02019"></a>02019 <span class="preprocessor"></span>
<a name="l02020"></a>02020     <span class="keywordflow">if</span> (ibuf) {
<a name="l02021"></a>02021 <span class="preprocessor">#ifdef WITH_OPENEXR</span>
<a name="l02022"></a>02022 <span class="preprocessor"></span>        <span class="comment">/* handle multilayer case, don&#39;t assign ibuf. will be handled in BKE_image_get_ibuf */</span>
<a name="l02023"></a>02023         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>==<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac23ddaa6ad1b9434bb6ad46c660eeec2" title="Flag defining the components of the ImBuf struct.">OPENEXR</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>) {
<a name="l02024"></a>02024             <a class="code" href="../../d3/d10/image_8c.html#acaa11aee43b91f5df95a3ca0b90e9a60">image_create_multilayer</a>(ima, ibuf, frame);  
<a name="l02025"></a>02025             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>;
<a name="l02026"></a>02026             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l02027"></a>02027             ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02028"></a>02028         }
<a name="l02029"></a>02029         <span class="keywordflow">else</span> {
<a name="l02030"></a>02030             <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02031"></a>02031             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, 0, frame);
<a name="l02032"></a>02032         }
<a name="l02033"></a>02033 <span class="preprocessor">#else</span>
<a name="l02034"></a>02034 <span class="preprocessor"></span>        <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02035"></a>02035         <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, 0, frame);
<a name="l02036"></a>02036 <span class="preprocessor">#endif</span>
<a name="l02037"></a>02037 <span class="preprocessor"></span>    }
<a name="l02038"></a>02038     <span class="keywordflow">else</span>
<a name="l02039"></a>02039         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02040"></a>02040     
<a name="l02041"></a>02041     <span class="keywordflow">if</span> (iuser)
<a name="l02042"></a>02042         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l02043"></a>02043     
<a name="l02044"></a>02044     <span class="keywordflow">return</span> ibuf;
<a name="l02045"></a>02045 }
<a name="l02046"></a>02046 
<a name="l02047"></a><a class="code" href="../../d3/d10/image_8c.html#afdc9a453f04849b6d810aed05b7a0b98">02047</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#afdc9a453f04849b6d810aed05b7a0b98">image_load_sequence_multilayer</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> frame)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02050"></a>02050     
<a name="l02051"></a>02051     <span class="comment">/* either we load from RenderResult, or we have to load a new one */</span>
<a name="l02052"></a>02052     
<a name="l02053"></a>02053     <span class="comment">/* check for new RenderResult */</span>
<a name="l02054"></a>02054     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || frame!=ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a97bbd3253a22e400113173e218bd624c">framenr</a>) {
<a name="l02055"></a>02055         <span class="comment">/* copy to survive not found multilayer image */</span>
<a name="l02056"></a>02056         <a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> *oldrr= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>;
<a name="l02057"></a>02057     
<a name="l02058"></a>02058         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02059"></a>02059         ibuf = <a class="code" href="../../d3/d10/image_8c.html#a682e2232b1935fd8116a6eb0d81a1d4a">image_load_sequence_file</a>(ima, iuser, frame);
<a name="l02060"></a>02060         
<a name="l02061"></a>02061         <span class="keywordflow">if</span> (ibuf) { <span class="comment">/* actually an error */</span>
<a name="l02062"></a>02062             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l02063"></a>02063             printf(<span class="stringliteral">&quot;error, multi is normal image\n&quot;</span>);
<a name="l02064"></a>02064         }
<a name="l02065"></a>02065         <span class="comment">// printf(&quot;loaded new result %p\n&quot;, ima-&gt;rr);</span>
<a name="l02066"></a>02066         <span class="comment">/* free result if new one found */</span>
<a name="l02067"></a>02067         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l02068"></a>02068             <span class="comment">// if (oldrr) printf(&quot;freed previous result %p\n&quot;, oldrr);</span>
<a name="l02069"></a>02069             <span class="keywordflow">if</span> (oldrr) <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a9db5615079ab1315b62597db8f75db54">RE_FreeRenderResult</a>(oldrr);
<a name="l02070"></a>02070         }
<a name="l02071"></a>02071         <span class="keywordflow">else</span> {
<a name="l02072"></a>02072             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>= oldrr;
<a name="l02073"></a>02073         }
<a name="l02074"></a>02074 
<a name="l02075"></a>02075     }
<a name="l02076"></a>02076     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l02077"></a>02077         <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass= <a class="code" href="../../d2/d77/BKE__image_8h.html#a688c220fe933298aa0c2b70c5539cd29">BKE_image_multilayer_index</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>, iuser);
<a name="l02078"></a>02078         
<a name="l02079"></a>02079         <span class="keywordflow">if</span> (rpass) {
<a name="l02080"></a>02080             <span class="comment">// printf(&quot;load from pass %s\n&quot;, rpass-&gt;name);</span>
<a name="l02081"></a>02081             <span class="comment">/* since we free  render results, we copy the rect */</span>
<a name="l02082"></a>02082             ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#abe71f7f7cce1643d0407fe3844cbe21d">recty</a>, 32, 0);
<a name="l02083"></a>02083             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a>);
<a name="l02084"></a>02084             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02085"></a>02085             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ad147239b291e76fa3a1b21b9b773e942">mall</a>= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02086"></a>02086             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac6272a7a882306012c4187122d8016a3">channels</a>;
<a name="l02087"></a>02087             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>;
<a name="l02088"></a>02088             
<a name="l02089"></a>02089             <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02090"></a>02090             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>:0, frame);
<a name="l02091"></a>02091             
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093         <span class="comment">// else printf(&quot;pass not found\n&quot;);</span>
<a name="l02094"></a>02094     }
<a name="l02095"></a>02095     <span class="keywordflow">else</span>
<a name="l02096"></a>02096         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02097"></a>02097     
<a name="l02098"></a>02098     <span class="keywordflow">if</span> (iuser)
<a name="l02099"></a>02099         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l02100"></a>02100     
<a name="l02101"></a>02101     <span class="keywordflow">return</span> ibuf;
<a name="l02102"></a>02102 }
<a name="l02103"></a>02103 
<a name="l02104"></a>02104 
<a name="l02105"></a><a class="code" href="../../d3/d10/image_8c.html#ac509031a94d2b825c31ee18e5469f7c6">02105</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#ac509031a94d2b825c31ee18e5469f7c6">image_load_movie_file</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> frame)
<a name="l02106"></a>02106 {
<a name="l02107"></a>02107     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02108"></a>02108     
<a name="l02109"></a>02109     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a>= frame;
<a name="l02110"></a>02110     
<a name="l02111"></a>02111     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02112"></a>02112         <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l02113"></a>02113         
<a name="l02114"></a>02114         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(str, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>);
<a name="l02115"></a>02115         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(str, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l02116"></a>02116 
<a name="l02117"></a>02117         <span class="comment">/* FIXME: make several stream accessible in image editor, too*/</span>
<a name="l02118"></a>02118         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a> = <a class="code" href="../../d2/d77/BKE__image_8h.html#a5bcb7aaaa54ec946022e07510eddbcaa">openanim</a>(str, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>, 0);
<a name="l02119"></a>02119         
<a name="l02120"></a>02120         <span class="comment">/* let&#39;s initialize this user */</span>
<a name="l02121"></a>02121         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a> &amp;&amp; iuser &amp;&amp; iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a>==0)
<a name="l02122"></a>02122             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a>= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#af8d8929cb1ab6eaff45f50de696752b6">IMB_anim_get_duration</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>,
<a name="l02123"></a>02123                                  <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aff5caa59b0951e087034606a3c6e9f1cafd4bc8417b7f6bce9b94c63008b268bd">IMB_TC_RECORD_RUN</a>);
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125     
<a name="l02126"></a>02126     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>) {
<a name="l02127"></a>02127         <span class="keywordtype">int</span> dur = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#af8d8929cb1ab6eaff45f50de696752b6">IMB_anim_get_duration</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>,
<a name="l02128"></a>02128                         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aff5caa59b0951e087034606a3c6e9f1cafd4bc8417b7f6bce9b94c63008b268bd">IMB_TC_RECORD_RUN</a>);
<a name="l02129"></a>02129         <span class="keywordtype">int</span> fra= frame-1;
<a name="l02130"></a>02130         
<a name="l02131"></a>02131         <span class="keywordflow">if</span> (fra&lt;0) fra = 0;
<a name="l02132"></a>02132         <span class="keywordflow">if</span> (fra&gt;(dur-1)) fra= dur-1;
<a name="l02133"></a>02133         ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a16e23f3a37cf2272cb87f270bf8e4d98">IMB_makeSingleUser</a>(
<a name="l02134"></a>02134             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aea47315b3c671962f07d937509eeb38e">IMB_anim_absolute</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a8871757578c9905c12a57b17ebafc35a">anim</a>, fra,
<a name="l02135"></a>02135                       <a class="code" href="../../db/d49/IMB__imbuf_8h.html#aff5caa59b0951e087034606a3c6e9f1cafd4bc8417b7f6bce9b94c63008b268bd">IMB_TC_RECORD_RUN</a>,
<a name="l02136"></a>02136                       <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40bf8eb133a4eebf0b19a25cf1cd68b9aed5cd6acdce80ab41093059cede0c494">IMB_PROXY_NONE</a>));
<a name="l02137"></a>02137         
<a name="l02138"></a>02138         <span class="keywordflow">if</span> (ibuf) {
<a name="l02139"></a>02139             <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02140"></a>02140             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, 0, frame);
<a name="l02141"></a>02141         }
<a name="l02142"></a>02142         <span class="keywordflow">else</span>
<a name="l02143"></a>02143             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02144"></a>02144     }
<a name="l02145"></a>02145     <span class="keywordflow">else</span>
<a name="l02146"></a>02146         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02147"></a>02147     
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (iuser)
<a name="l02149"></a>02149         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l02150"></a>02150     
<a name="l02151"></a>02151     <span class="keywordflow">return</span> ibuf;
<a name="l02152"></a>02152 }
<a name="l02153"></a>02153 
<a name="l02154"></a>02154 <span class="comment">/* warning, &#39;iuser&#39; can be NULL */</span>
<a name="l02155"></a><a class="code" href="../../d3/d10/image_8c.html#a982b6e022a3048de515eb60b294d19ea">02155</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a982b6e022a3048de515eb60b294d19ea">image_load_image_file</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> cfra)
<a name="l02156"></a>02156 {
<a name="l02157"></a>02157     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l02158"></a>02158     <span class="keywordtype">char</span> <a class="code" href="../../d2/d36/interface__layout_8c.html#ab50d783982593ef993ea0b68f7ad8b80">str</a>[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a4d71bd743114c866e342b82481760d80">FILE_MAX</a>];
<a name="l02159"></a>02159     <span class="keywordtype">int</span> assign = 0, flag;
<a name="l02160"></a>02160     
<a name="l02161"></a>02161     <span class="comment">/* always ensure clean ima */</span>
<a name="l02162"></a>02162     <a class="code" href="../../d3/d10/image_8c.html#aebe2886a6ce4ed0f1caf5e26482df387">image_free_buffers</a>(ima);
<a name="l02163"></a>02163     
<a name="l02164"></a>02164     <span class="comment">/* is there a PackedFile with this image ? */</span>
<a name="l02165"></a>02165     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>) {
<a name="l02166"></a>02166         flag = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ab86521a39a5155a4f87545b41d35a18b" title="Flag defining the components of the ImBuf struct.">IB_multilayer</a>;
<a name="l02167"></a>02167         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a1312f80c28583b65a650fc20f0a815d0">IMA_DO_PREMUL</a>) flag |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a4fb3cfdbd9ef49f944ea774636bdbbca" title="Flag defining the components of the ImBuf struct.">IB_premul</a>;
<a name="l02168"></a>02168         
<a name="l02169"></a>02169         ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a23cf4ed9826b357cd43b9047fd98946e">IMB_ibImageFromMemory</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab26282078abf88909ab32213a4290f8e">data</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a>-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a>, flag, <span class="stringliteral">&quot;&lt;packed data&gt;&quot;</span>);
<a name="l02170"></a>02170     } 
<a name="l02171"></a>02171     <span class="keywordflow">else</span> {
<a name="l02172"></a>02172         flag= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ab86521a39a5155a4f87545b41d35a18b" title="Flag defining the components of the ImBuf struct.">IB_multilayer</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a919c63671d79df2232ab7a6e2ca82270" title="Flag defining the components of the ImBuf struct.">IB_metadata</a>;
<a name="l02173"></a>02173         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a1312f80c28583b65a650fc20f0a815d0">IMA_DO_PREMUL</a>)
<a name="l02174"></a>02174             flag |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a4fb3cfdbd9ef49f944ea774636bdbbca" title="Flag defining the components of the ImBuf struct.">IB_premul</a>;
<a name="l02175"></a>02175             
<a name="l02176"></a>02176         <span class="comment">/* get the right string */</span>
<a name="l02177"></a>02177         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(str, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, <span class="keyword">sizeof</span>(str));
<a name="l02178"></a>02178         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a779fd31715eb05e3322500e3426b03a2">BLI_path_abs</a>(str, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l02179"></a>02179         
<a name="l02180"></a>02180         <span class="comment">/* read ibuf */</span>
<a name="l02181"></a>02181         ibuf = <a class="code" href="../../db/d49/IMB__imbuf_8h.html#ad9841de487be5fa3a88602b144ad9c2d">IMB_loadiffname</a>(str, flag);
<a name="l02182"></a>02182     }
<a name="l02183"></a>02183     
<a name="l02184"></a>02184     <span class="keywordflow">if</span> (ibuf) {
<a name="l02185"></a>02185         <span class="comment">/* handle multilayer case, don&#39;t assign ibuf. will be handled in BKE_image_get_ibuf */</span>
<a name="l02186"></a>02186         <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#afe0c82b3cdc7314bdfc229aeba70f067">ftype</a>==<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac23ddaa6ad1b9434bb6ad46c660eeec2" title="Flag defining the components of the ImBuf struct.">OPENEXR</a> &amp;&amp; ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a01f7772c156104dec90f532ef0b1a783">userdata</a>) {
<a name="l02187"></a>02187             <a class="code" href="../../d3/d10/image_8c.html#acaa11aee43b91f5df95a3ca0b90e9a60">image_create_multilayer</a>(ima, ibuf, cfra);   
<a name="l02188"></a>02188             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>;
<a name="l02189"></a>02189             <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l02190"></a>02190             ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192         <span class="keywordflow">else</span> {
<a name="l02193"></a>02193             <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02194"></a>02194             assign= 1;
<a name="l02195"></a>02195 
<a name="l02196"></a>02196             <span class="comment">/* check if the image is a font image... */</span>
<a name="l02197"></a>02197             <a class="code" href="../../d5/d20/BKE__bmfont_8h.html#ae3e880cc642068f50cb10207b1f6b678">detectBitmapFont</a>(ibuf);
<a name="l02198"></a>02198             
<a name="l02199"></a>02199             <span class="comment">/* make packed file for autopack */</span>
<a name="l02200"></a>02200             <span class="keywordflow">if</span> ((ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.fileflags &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a7238d448ec1e56e3b370fc5345a30ab8">G_AUTOPACK</a>))
<a name="l02201"></a>02201                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a0e0851c62c73413ddefacfa48e199c8e">packedfile</a> = <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, str, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, &amp;ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aaf5fcd281cf4337d6686322f82187896">id</a>));
<a name="l02202"></a>02202         }
<a name="l02203"></a>02203     }
<a name="l02204"></a>02204     <span class="keywordflow">else</span>
<a name="l02205"></a>02205         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02206"></a>02206     
<a name="l02207"></a>02207     <span class="keywordflow">if</span> (assign)
<a name="l02208"></a>02208         <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02209"></a>02209 
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (iuser)
<a name="l02211"></a>02211         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l02212"></a>02212     
<a name="l02213"></a>02213     <span class="keywordflow">return</span> ibuf;
<a name="l02214"></a>02214 }
<a name="l02215"></a>02215 
<a name="l02216"></a><a class="code" href="../../d3/d10/image_8c.html#a73a737450398c782a06fb029a8eb0829">02216</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a73a737450398c782a06fb029a8eb0829">image_get_ibuf_multilayer</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser)
<a name="l02217"></a>02217 {
<a name="l02218"></a>02218     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02219"></a>02219     
<a name="l02220"></a>02220     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02221"></a>02221         ibuf = <a class="code" href="../../d3/d10/image_8c.html#a982b6e022a3048de515eb60b294d19ea">image_load_image_file</a>(ima, iuser, 0);
<a name="l02222"></a>02222         <span class="keywordflow">if</span> (ibuf) { <span class="comment">/* actually an error */</span>
<a name="l02223"></a>02223             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>;
<a name="l02224"></a>02224             <span class="keywordflow">return</span> ibuf;
<a name="l02225"></a>02225         }
<a name="l02226"></a>02226     }
<a name="l02227"></a>02227     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>) {
<a name="l02228"></a>02228         <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass= <a class="code" href="../../d2/d77/BKE__image_8h.html#a688c220fe933298aa0c2b70c5539cd29">BKE_image_multilayer_index</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>, iuser);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230         <span class="keywordflow">if</span> (rpass) {
<a name="l02231"></a>02231             ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab4eb9e80e14920245c69cb9604a28c3a">rr</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#abe71f7f7cce1643d0407fe3844cbe21d">recty</a>, 32, 0);
<a name="l02232"></a>02232             
<a name="l02233"></a>02233             <a class="code" href="../../d3/d10/image_8c.html#a164aac128aa1c571b65305c73c5a84f3">image_initialize_after_load</a>(ima, ibuf);
<a name="l02234"></a>02234             
<a name="l02235"></a>02235             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a>;
<a name="l02236"></a>02236             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02237"></a>02237             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac6272a7a882306012c4187122d8016a3">channels</a>;
<a name="l02238"></a>02238             ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>;
<a name="l02239"></a>02239 
<a name="l02240"></a>02240             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>:<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02241"></a>02241         }
<a name="l02242"></a>02242     }
<a name="l02243"></a>02243     
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l02245"></a>02245         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l02246"></a>02246     <span class="keywordflow">if</span> (iuser)
<a name="l02247"></a>02247         iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>;
<a name="l02248"></a>02248     
<a name="l02249"></a>02249     <span class="keywordflow">return</span> ibuf;
<a name="l02250"></a>02250 }
<a name="l02251"></a>02251 
<a name="l02252"></a>02252 
<a name="l02253"></a>02253 <span class="comment">/* showing RGBA result itself (from compo/sequence) or</span>
<a name="l02254"></a>02254 <span class="comment"> * like exr, using layers etc */</span>
<a name="l02255"></a>02255 <span class="comment">/* always returns a single ibuf, also during render progress */</span>
<a name="l02256"></a><a class="code" href="../../d3/d10/image_8c.html#a1a804608f8a075c525ad1f88c6cf4bd2">02256</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a1a804608f8a075c525ad1f88c6cf4bd2">image_get_render_result</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">void</span> **lock_r)
<a name="l02257"></a>02257 {
<a name="l02258"></a>02258     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *re;
<a name="l02259"></a>02259     <a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a> rres;
<a name="l02260"></a>02260     <span class="keywordtype">float</span> *rectf, *rectz;
<a name="l02261"></a>02261     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l02262"></a>02262     <span class="keywordtype">float</span> <a class="code" href="../../d3/dd9/structImBuf.html#a79237e9965b157b0e3ebd899ce7f09b5">dither</a>;
<a name="l02263"></a>02263     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>, layer, pass;
<a name="l02264"></a>02264     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l02265"></a>02265     <span class="keywordtype">int</span> from_render= (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a> == ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2a87093a1b926cfb183d0611b22f3f3f">last_render_slot</a>);
<a name="l02266"></a>02266 
<a name="l02267"></a>02267     <span class="keywordflow">if</span> (!(iuser &amp;&amp; iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aee6884f3d5d6dc026064a0ae7831c349">scene</a>))
<a name="l02268"></a>02268         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02269"></a>02269 
<a name="l02270"></a>02270     <span class="comment">/* if we the caller is not going to release the lock, don&#39;t give the image */</span>
<a name="l02271"></a>02271     <span class="keywordflow">if</span> (!lock_r)
<a name="l02272"></a>02272         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02273"></a>02273 
<a name="l02274"></a>02274     re= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a5f782432eba7e3e858fde4dfe1c61703">RE_GetRender</a>(iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aee6884f3d5d6dc026064a0ae7831c349">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a68db741bd7a79e16f765bba66cf276b1">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>);
<a name="l02275"></a>02275 
<a name="l02276"></a>02276     channels= 4;
<a name="l02277"></a>02277     layer= (iuser)? iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a78c9cbc71d3fe8ba5ca74ec74b1b0045">layer</a>: 0;
<a name="l02278"></a>02278     pass= (iuser)? iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ad0d893d9033142501ee8c3a715855200">pass</a>: 0;
<a name="l02279"></a>02279 
<a name="l02280"></a>02280     <span class="keywordflow">if</span> (from_render) {
<a name="l02281"></a>02281         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a045f95a0a1777b13bc0f878861ee3982">RE_AcquireResultImage</a>(re, &amp;rres);
<a name="l02282"></a>02282     }
<a name="l02283"></a>02283     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>]) {
<a name="l02284"></a>02284         rres= *(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a600f01d198f4a37cac944c87e0552d36">renders</a>[ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a9e7bbcc90a4784deaffcbd550bc509bc">render_slot</a>]);
<a name="l02285"></a>02285         rres.<a class="code" href="../../d5/d29/structRenderResult.html#a995db0df707eacf1983443d2b50cc2b5">have_combined</a>= rres.<a class="code" href="../../d5/d29/structRenderResult.html#ac02fcb9d53c81afa71fab7f78c5b1774">rectf</a> != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02286"></a>02286     }
<a name="l02287"></a>02287     <span class="keywordflow">else</span>
<a name="l02288"></a>02288         memset(&amp;rres, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d29/structRenderResult.html">RenderResult</a>));
<a name="l02289"></a>02289     
<a name="l02290"></a>02290     <span class="keywordflow">if</span> (!(rres.<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a> &gt; 0 &amp;&amp; rres.<a class="code" href="../../d5/d29/structRenderResult.html#abe71f7f7cce1643d0407fe3844cbe21d">recty</a> &gt; 0)) {
<a name="l02291"></a>02291         <span class="keywordflow">if</span> (from_render)
<a name="l02292"></a>02292             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a775f4f363a65ec48123d2c180249edb4">RE_ReleaseResultImage</a>(re);
<a name="l02293"></a>02293         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02294"></a>02294     }
<a name="l02295"></a>02295 
<a name="l02296"></a>02296     <span class="comment">/* release is done in BKE_image_release_ibuf using lock_r */</span>
<a name="l02297"></a>02297     <span class="keywordflow">if</span> (from_render) {
<a name="l02298"></a>02298         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a0612aad752558a84c930348ca3bb41bb">LOCK_VIEWER</a>);
<a name="l02299"></a>02299         *lock_r= re;
<a name="l02300"></a>02300     }
<a name="l02301"></a>02301 
<a name="l02302"></a>02302     <span class="comment">/* this gives active layer, composite or seqence result */</span>
<a name="l02303"></a>02303     rect= (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rres.<a class="code" href="../../d5/d29/structRenderResult.html#a84b99e133309e9e7a6f459ddfed954f9">rect32</a>;
<a name="l02304"></a>02304     rectf= rres.<a class="code" href="../../d5/d29/structRenderResult.html#ac02fcb9d53c81afa71fab7f78c5b1774">rectf</a>;
<a name="l02305"></a>02305     rectz= rres.<a class="code" href="../../d5/d29/structRenderResult.html#a716ea8220c2dca0d252ae3fe48e226a9">rectz</a>;
<a name="l02306"></a>02306     dither= iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aee6884f3d5d6dc026064a0ae7831c349">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a89a7fef2712484fede8eb8887f55a72b">dither_intensity</a>;
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="comment">/* combined layer gets added as first layer */</span>
<a name="l02309"></a>02309     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (rres.<a class="code" href="../../d5/d29/structRenderResult.html#a995db0df707eacf1983443d2b50cc2b5">have_combined</a> &amp;&amp; layer==0);
<a name="l02310"></a>02310     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rres.<a class="code" href="../../d5/d29/structRenderResult.html#a56f453254756e82da4cec4ddc516b167">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l02311"></a>02311         <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;rres.<a class="code" href="../../d5/d29/structRenderResult.html#a56f453254756e82da4cec4ddc516b167">layers</a>, layer-(rres.<a class="code" href="../../d5/d29/structRenderResult.html#a995db0df707eacf1983443d2b50cc2b5">have_combined</a>?1:0));
<a name="l02312"></a>02312         <span class="keywordflow">if</span> (rl) {
<a name="l02313"></a>02313             <a class="code" href="../../de/dfc/structRenderPass.html">RenderPass</a> *rpass;
<a name="l02314"></a>02314 
<a name="l02315"></a>02315             <span class="comment">/* there&#39;s no combined pass, is in renderlayer itself */</span>
<a name="l02316"></a>02316             <span class="keywordflow">if</span> (pass==0) {
<a name="l02317"></a>02317                 rectf= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ae9845cbf757bcf086f09c543d535bdda">rectf</a>;
<a name="l02318"></a>02318             }
<a name="l02319"></a>02319             <span class="keywordflow">else</span> {
<a name="l02320"></a>02320                 rpass= <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>, pass-1);
<a name="l02321"></a>02321                 <span class="keywordflow">if</span> (rpass) {
<a name="l02322"></a>02322                     channels= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac6272a7a882306012c4187122d8016a3">channels</a>;
<a name="l02323"></a>02323                     rectf= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a>;
<a name="l02324"></a>02324                     dither= 0.0f; <span class="comment">/* don&#39;t dither passes */</span>
<a name="l02325"></a>02325                 }
<a name="l02326"></a>02326             }
<a name="l02327"></a>02327 
<a name="l02328"></a>02328             <span class="keywordflow">for</span> (rpass= rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#a6c243fd3ac7e6b7ec94d74ecf68a0133">passes</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; rpass; rpass= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#aed9513097ccc7c82e0deae0b086e4e0e">next</a>)
<a name="l02329"></a>02329                 <span class="keywordflow">if</span> (rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#a4ddaded7461ae46c6cc4dcc2eaf479ca">passtype</a> == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1ae908c61cd1d871b33f30bc2b16c13c">SCE_PASS_Z</a>)
<a name="l02330"></a>02330                     rectz= rpass-&gt;<a class="code" href="../../de/dfc/structRenderPass.html#ac9f6a50d7c70461a48af1781b66fa3fd">rect</a>;
<a name="l02331"></a>02331         }
<a name="l02332"></a>02332     }
<a name="l02333"></a>02333 
<a name="l02334"></a>02334     ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02335"></a>02335 
<a name="l02336"></a>02336     <span class="comment">/* make ibuf if needed, and initialize it */</span>
<a name="l02337"></a>02337     <span class="keywordflow">if</span> (ibuf==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02338"></a>02338         ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(rres.<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a>, rres.<a class="code" href="../../d5/d29/structRenderResult.html#abe71f7f7cce1643d0407fe3844cbe21d">recty</a>, 32, 0);
<a name="l02339"></a>02339         <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341 
<a name="l02342"></a>02342     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>= rres.<a class="code" href="../../d5/d29/structRenderResult.html#a2ef58e272e5cbc5445f34ff8bed87f2d">rectx</a>;
<a name="l02343"></a>02343     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>= rres.<a class="code" href="../../d5/d29/structRenderResult.html#abe71f7f7cce1643d0407fe3844cbe21d">recty</a>;
<a name="l02344"></a>02344     
<a name="l02345"></a>02345     <span class="comment">/* free rect buffer if float buffer changes, so it can be recreated with</span>
<a name="l02346"></a>02346 <span class="comment">     * the updated result, and also in case we got byte buffer from sequencer,</span>
<a name="l02347"></a>02347 <span class="comment">     * so we don&#39;t keep reference to freed buffer */</span>
<a name="l02348"></a>02348     <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>!=rectf || rect || !rectf)
<a name="l02349"></a>02349         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a4660d436da5d4c67faacaf2fa2b9989e">imb_freerectImBuf</a>(ibuf);
<a name="l02350"></a>02350 
<a name="l02351"></a>02351     <span class="keywordflow">if</span> (rect)
<a name="l02352"></a>02352         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>= <a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l02353"></a>02353     
<a name="l02354"></a>02354     <span class="keywordflow">if</span> (rectf) {
<a name="l02355"></a>02355         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>= rectf;
<a name="l02356"></a>02356         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02357"></a>02357         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>= <a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a>;
<a name="l02358"></a>02358     }
<a name="l02359"></a>02359     <span class="keywordflow">else</span> {
<a name="l02360"></a>02360         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02361"></a>02361         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>;
<a name="l02362"></a>02362     }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364     <span class="keywordflow">if</span> (rectz) {
<a name="l02365"></a>02365         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a>= rectz;
<a name="l02366"></a>02366         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad0b0d2d177773cca2507492d0a2bc5a4" title="Flag defining the components of the ImBuf struct.">IB_zbuffloat</a>;
<a name="l02367"></a>02367     }
<a name="l02368"></a>02368     <span class="keywordflow">else</span> {
<a name="l02369"></a>02369         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a8f4e90b2ba7c9fa834edb5cd8bc9b765">zbuf_float</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02370"></a>02370         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ad0b0d2d177773cca2507492d0a2bc5a4" title="Flag defining the components of the ImBuf struct.">IB_zbuffloat</a>;
<a name="l02371"></a>02371     }
<a name="l02372"></a>02372 
<a name="l02373"></a>02373     <span class="comment">/* since its possible to access the buffer from the image directly, set the profile [#25073] */</span>
<a name="l02374"></a>02374     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a>= (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aee6884f3d5d6dc026064a0ae7831c349">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>) ? <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a> : <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#a5a4ca931467afcec1f255cd469ec5433">IB_PROFILE_NONE</a>;
<a name="l02375"></a>02375     ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a79237e9965b157b0e3ebd899ce7f09b5">dither</a>= <a class="code" href="../../d3/dd9/structImBuf.html#a79237e9965b157b0e3ebd899ce7f09b5">dither</a>;
<a name="l02376"></a>02376 
<a name="l02377"></a>02377     <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aee6884f3d5d6dc026064a0ae7831c349">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a6bbbf5cdc7643229a71630aece03e5fe">R_COLOR_MANAGEMENT_PREDIVIDE</a>) {
<a name="l02378"></a>02378         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> |= <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aaee35f2986414382c12d2a75cefbddd1" title="Flag defining the components of the ImBuf struct.">IB_cm_predivide</a>;
<a name="l02379"></a>02379         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> |= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a18aa1bbdda58d1c670134dba750b935d">IMA_CM_PREDIVIDE</a>;
<a name="l02380"></a>02380     }
<a name="l02381"></a>02381     <span class="keywordflow">else</span> {
<a name="l02382"></a>02382         ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#aface8662f09c3426342a256122974872">flags</a> &amp;= ~<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aaee35f2986414382c12d2a75cefbddd1" title="Flag defining the components of the ImBuf struct.">IB_cm_predivide</a>;
<a name="l02383"></a>02383         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ab84c3d099caf0d6ec44c266899839f63">flag</a> &amp;= ~<a class="code" href="../../d2/d94/DNA__image__types_8h.html#a18aa1bbdda58d1c670134dba750b935d">IMA_CM_PREDIVIDE</a>;
<a name="l02384"></a>02384     }
<a name="l02385"></a>02385 
<a name="l02386"></a>02386     ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>;
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="keywordflow">return</span> ibuf;
<a name="l02389"></a>02389 }
<a name="l02390"></a>02390 
<a name="l02391"></a><a class="code" href="../../d3/d10/image_8c.html#a8fae18c6360f3047159a98a0be4e67f0">02391</a> <span class="keyword">static</span> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d3/d10/image_8c.html#a8fae18c6360f3047159a98a0be4e67f0">image_get_ibuf_threadsafe</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> *frame_r, <span class="keywordtype">int</span> *index_r)
<a name="l02392"></a>02392 {
<a name="l02393"></a>02393     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02394"></a>02394     <span class="keywordtype">int</span> frame = 0, <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a> = 0;
<a name="l02395"></a>02395 
<a name="l02396"></a>02396     <span class="comment">/* see if we already have an appropriate ibuf, with image source and type */</span>
<a name="l02397"></a>02397     <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>) {
<a name="l02398"></a>02398         frame= iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa6cc3321daee3993cdd38447f24e4a3c">framenr</a>:ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a>;
<a name="l02399"></a>02399         ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, 0, frame);
<a name="l02400"></a>02400         <span class="comment">/* XXX temp stuff? */</span>
<a name="l02401"></a>02401         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a> != frame)
<a name="l02402"></a>02402             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> |= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad8a2bf777fd3d318388ae52b3080df68">IMA_TPAGE_REFRESH</a>;
<a name="l02403"></a>02403         ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a> = frame;
<a name="l02404"></a>02404     }
<a name="l02405"></a>02405     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>) {
<a name="l02406"></a>02406         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>) {
<a name="l02407"></a>02407             frame= iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa6cc3321daee3993cdd38447f24e4a3c">framenr</a>:ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a>;
<a name="l02408"></a>02408             ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, 0, frame);
<a name="l02409"></a>02409             
<a name="l02410"></a>02410             <span class="comment">/* XXX temp stuff? */</span>
<a name="l02411"></a>02411             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a> != frame) {
<a name="l02412"></a>02412                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#aca02a67942f2090b7d9d19de4286af90">tpageflag</a> |= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ad8a2bf777fd3d318388ae52b3080df68">IMA_TPAGE_REFRESH</a>;
<a name="l02413"></a>02413             }
<a name="l02414"></a>02414             ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a> = frame;
<a name="l02415"></a>02415         }   
<a name="l02416"></a>02416         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>) {
<a name="l02417"></a>02417             frame= iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa6cc3321daee3993cdd38447f24e4a3c">framenr</a>:ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ad280b774d74fee58d15c0deec0da36af">lastframe</a>;
<a name="l02418"></a>02418             <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>= iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>:<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>;
<a name="l02419"></a>02419             ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>, frame);
<a name="l02420"></a>02420         }
<a name="l02421"></a>02421     }
<a name="l02422"></a>02422     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>) {
<a name="l02423"></a>02423         <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>)
<a name="l02424"></a>02424             ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02425"></a>02425         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>)
<a name="l02426"></a>02426             ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, iuser?iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa0eccb39aa6fd7c6d3d9603984ded71f">multi_index</a>:<a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02427"></a>02427     }
<a name="l02428"></a>02428     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l02429"></a>02429         ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02430"></a>02430     }
<a name="l02431"></a>02431     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>) {
<a name="l02432"></a>02432         <span class="comment">/* always verify entirely, not that this shouldn&#39;t happen</span>
<a name="l02433"></a>02433 <span class="comment">         * as part of texture sampling in rendering anyway, so not</span>
<a name="l02434"></a>02434 <span class="comment">         * a big bottleneck */</span>
<a name="l02435"></a>02435     }
<a name="l02436"></a>02436 
<a name="l02437"></a>02437     *frame_r = frame;
<a name="l02438"></a>02438     *index_r = <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l02439"></a>02439 
<a name="l02440"></a>02440     <span class="keywordflow">return</span> ibuf;
<a name="l02441"></a>02441 }
<a name="l02442"></a>02442 
<a name="l02443"></a>02443 <span class="comment">/* Checks optional ImageUser and verifies/creates ImBuf. */</span>
<a name="l02444"></a>02444 <span class="comment">/* use this one if you want to get a render result in progress,</span>
<a name="l02445"></a>02445 <span class="comment"> * if not, use BKE_image_get_ibuf which doesn&#39;t require a release */</span>
<a name="l02446"></a><a class="code" href="../../d3/d10/image_8c.html#a486e97a7fb4e61848a1eb70051324953">02446</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a2b04dffde4310589df05cf29db9d2ea4">BKE_image_acquire_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">void</span> **lock_r)
<a name="l02447"></a>02447 {
<a name="l02448"></a>02448     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02449"></a>02449     <span class="keywordtype">float</span> color[] = {0, 0, 0, 1};
<a name="l02450"></a>02450     <span class="keywordtype">int</span> frame= 0, <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>= 0;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     <span class="comment">/* This function is intended to be thread-safe. It postpones the mutex lock</span>
<a name="l02453"></a>02453 <span class="comment">     * until it needs to load the image, if the image is already there it</span>
<a name="l02454"></a>02454 <span class="comment">     * should just get the pointer and return. The reason is that a lot of mutex</span>
<a name="l02455"></a>02455 <span class="comment">     * locks appears to be very slow on certain multicore macs, causing a render</span>
<a name="l02456"></a>02456 <span class="comment">     * with image textures to actually slow down as more threads are used.</span>
<a name="l02457"></a>02457 <span class="comment">     *</span>
<a name="l02458"></a>02458 <span class="comment">     * Note that all the image loading functions should also make sure they do</span>
<a name="l02459"></a>02459 <span class="comment">     * things in a threadsafe way for image_get_ibuf_threadsafe to work correct.</span>
<a name="l02460"></a>02460 <span class="comment">     * That means, the last two steps must be, 1) add the ibuf to the list and</span>
<a name="l02461"></a>02461 <span class="comment">     * 2) set ima/iuser-&gt;ok to 0 to IMA_OK_LOADED */</span>
<a name="l02462"></a>02462     
<a name="l02463"></a>02463     <span class="keywordflow">if</span> (lock_r)
<a name="l02464"></a>02464         *lock_r= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <span class="comment">/* quick reject tests */</span>
<a name="l02467"></a>02467     <span class="keywordflow">if</span> (ima==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) 
<a name="l02468"></a>02468         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02469"></a>02469     <span class="keywordflow">if</span> (iuser) {
<a name="l02470"></a>02470         <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>==0)
<a name="l02471"></a>02471             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02472"></a>02472     }
<a name="l02473"></a>02473     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>==0)
<a name="l02474"></a>02474         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02475"></a>02475     
<a name="l02476"></a>02476     <span class="comment">/* try to get the ibuf without locking */</span>
<a name="l02477"></a>02477     ibuf= <a class="code" href="../../d3/d10/image_8c.html#a8fae18c6360f3047159a98a0be4e67f0">image_get_ibuf_threadsafe</a>(ima, iuser, &amp;frame, &amp;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>);
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02480"></a>02480         <span class="comment">/* couldn&#39;t get ibuf and image is not ok, so let&#39;s lock and try to</span>
<a name="l02481"></a>02481 <span class="comment">         * load the image */</span>
<a name="l02482"></a>02482         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l02483"></a>02483 
<a name="l02484"></a>02484         <span class="comment">/* need to check ok flag and loading ibuf again, because the situation</span>
<a name="l02485"></a>02485 <span class="comment">         * might have changed in the meantime */</span>
<a name="l02486"></a>02486         <span class="keywordflow">if</span> (iuser) {
<a name="l02487"></a>02487             <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>==0) {
<a name="l02488"></a>02488                 <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l02489"></a>02489                 <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02490"></a>02490             }
<a name="l02491"></a>02491         }
<a name="l02492"></a>02492         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>==0) {
<a name="l02493"></a>02493             <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l02494"></a>02494             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02495"></a>02495         }
<a name="l02496"></a>02496 
<a name="l02497"></a>02497         ibuf= <a class="code" href="../../d3/d10/image_8c.html#a8fae18c6360f3047159a98a0be4e67f0">image_get_ibuf_threadsafe</a>(ima, iuser, &amp;frame, &amp;<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>);
<a name="l02498"></a>02498 
<a name="l02499"></a>02499         <span class="keywordflow">if</span> (ibuf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02500"></a>02500             <span class="comment">/* we are sure we have to load the ibuf, using source and type */</span>
<a name="l02501"></a>02501             <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ad15772d6b95027902c77c6374ceac47b">IMA_SRC_MOVIE</a>) {
<a name="l02502"></a>02502                 <span class="comment">/* source is from single file, use flipbook to store ibuf */</span>
<a name="l02503"></a>02503                 ibuf= <a class="code" href="../../d3/d10/image_8c.html#ac509031a94d2b825c31ee18e5469f7c6">image_load_movie_file</a>(ima, iuser, frame);
<a name="l02504"></a>02504             }
<a name="l02505"></a>02505             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#aeff8879cd961f2dff8c4f31ed55409c4">IMA_SRC_SEQUENCE</a>) {
<a name="l02506"></a>02506                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>) {
<a name="l02507"></a>02507                     <span class="comment">/* regular files, ibufs in flipbook, allows saving */</span>
<a name="l02508"></a>02508                     ibuf= <a class="code" href="../../d3/d10/image_8c.html#a682e2232b1935fd8116a6eb0d81a1d4a">image_load_sequence_file</a>(ima, iuser, frame);
<a name="l02509"></a>02509                 }
<a name="l02510"></a>02510                 <span class="comment">/* no else; on load the ima type can change */</span>
<a name="l02511"></a>02511                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>) {
<a name="l02512"></a>02512                     <span class="comment">/* only 1 layer/pass stored in imbufs, no exrhandle anim storage, no saving */</span>
<a name="l02513"></a>02513                     ibuf= <a class="code" href="../../d3/d10/image_8c.html#afdc9a453f04849b6d810aed05b7a0b98">image_load_sequence_multilayer</a>(ima, iuser, frame);
<a name="l02514"></a>02514                 }
<a name="l02515"></a>02515             }
<a name="l02516"></a>02516             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#ae1aaf40355c07c5707842c54ae386d96">IMA_SRC_FILE</a>) {
<a name="l02517"></a>02517                 
<a name="l02518"></a>02518                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a848b9ca26aa15a6debaf59ae235767b1">IMA_TYPE_IMAGE</a>)
<a name="l02519"></a>02519                     ibuf= <a class="code" href="../../d3/d10/image_8c.html#a982b6e022a3048de515eb60b294d19ea">image_load_image_file</a>(ima, iuser, frame); <span class="comment">/* cfra only for &#39;#&#39;, this global is OK */</span>
<a name="l02520"></a>02520                 <span class="comment">/* no else; on load the ima type can change */</span>
<a name="l02521"></a>02521                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a29f2c97fada2137d1c2fb5ff23c47622">IMA_TYPE_MULTILAYER</a>)
<a name="l02522"></a>02522                     <span class="comment">/* keeps render result, stores ibufs in listbase, allows saving */</span>
<a name="l02523"></a>02523                     ibuf= <a class="code" href="../../d3/d10/image_8c.html#a73a737450398c782a06fb029a8eb0829">image_get_ibuf_multilayer</a>(ima, iuser);
<a name="l02524"></a>02524                     
<a name="l02525"></a>02525             }
<a name="l02526"></a>02526             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#a2a76aa3b67d75266d87118f420e3941c">IMA_SRC_GENERATED</a>) {
<a name="l02527"></a>02527                 <span class="comment">/* generated is: ibuf is allocated dynamically */</span>
<a name="l02528"></a>02528                 <span class="comment">/* UV testgrid or black or solid etc */</span>
<a name="l02529"></a>02529                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>==0) ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>= 1024;
<a name="l02530"></a>02530                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>==0) ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>= 1024;
<a name="l02531"></a>02531                 ibuf= <a class="code" href="../../d3/d10/image_8c.html#a63d657c47909ca66bdedaadadc89b121">add_ibuf_size</a>(ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ae2743f2730dbec2bfaf13aea66b99313">gen_x</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a28c166f9b8c16b57b1777a60fd220f86">gen_y</a>, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#acfc924ea17aa360720ea5f9779620b84">name</a>, 24, (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#ac04b590e078aadefd2fb73b3e7dfd46b">gen_flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#aef1a3fb1f9bc7ffd8963f987c750ff44">IMA_GEN_FLOAT</a>) != 0, ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a2700acc0fc1f66bbd958a93dac99ca85">gen_type</a>, color);
<a name="l02532"></a>02532                 <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, <a class="code" href="../../d3/d10/image_8c.html#a720ce27df029c5bbfa973fa72b64aead">IMA_NO_INDEX</a>, 0);
<a name="l02533"></a>02533                 ima-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= <a class="code" href="../../d2/d77/BKE__image_8h.html#a218fab6add549248838257fcddcac954">IMA_OK_LOADED</a>;
<a name="l02534"></a>02534             }
<a name="l02535"></a>02535             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a868d306431889e6c2998ca2184fbe18e">source</a> == <a class="code" href="../../d2/d77/BKE__image_8h.html#ae7af40da3fa37e071c6ce12ac6f987da">IMA_SRC_VIEWER</a>) {
<a name="l02536"></a>02536                 <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#af8eec9b55a49c67ca1effbc2ccf43501">IMA_TYPE_R_RESULT</a>) {
<a name="l02537"></a>02537                     <span class="comment">/* always verify entirely, and potentially</span>
<a name="l02538"></a>02538 <span class="comment">                     * returns pointer to release later */</span>
<a name="l02539"></a>02539                     ibuf= <a class="code" href="../../d3/d10/image_8c.html#a1a804608f8a075c525ad1f88c6cf4bd2">image_get_render_result</a>(ima, iuser, lock_r);
<a name="l02540"></a>02540                 }
<a name="l02541"></a>02541                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ima-&gt;<a class="code" href="../../d8/d00/classImage.html#a80acd1ed9bc66fb3a9d45e146f6039f0">type</a>==<a class="code" href="../../d2/d77/BKE__image_8h.html#a922dc453e6b157a2da1dc7ffb5fb19f6">IMA_TYPE_COMPOSITE</a>) {
<a name="l02542"></a>02542                     <span class="comment">/* requires lock/unlock, otherwise don&#39;t return image */</span>
<a name="l02543"></a>02543                     <span class="keywordflow">if</span> (lock_r) {
<a name="l02544"></a>02544                         <span class="comment">/* unlock in BKE_image_release_ibuf */</span>
<a name="l02545"></a>02545                         <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a0612aad752558a84c930348ca3bb41bb">LOCK_VIEWER</a>);
<a name="l02546"></a>02546                         *lock_r= ima;
<a name="l02547"></a>02547 
<a name="l02548"></a>02548                         <span class="comment">/* XXX anim play for viewer nodes not yet supported */</span>
<a name="l02549"></a>02549                         frame= 0; <span class="comment">// XXX iuser?iuser-&gt;framenr:0;</span>
<a name="l02550"></a>02550                         ibuf= <a class="code" href="../../d3/d10/image_8c.html#ab1bb117e4ed7b992118348e2a30719da">image_get_ibuf</a>(ima, 0, frame);
<a name="l02551"></a>02551 
<a name="l02552"></a>02552                         <span class="keywordflow">if</span> (!ibuf) {
<a name="l02553"></a>02553                             <span class="comment">/* Composite Viewer, all handled in compositor */</span>
<a name="l02554"></a>02554                             <span class="comment">/* fake ibuf, will be filled in compositor */</span>
<a name="l02555"></a>02555                             ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(256, 256, 32, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>);
<a name="l02556"></a>02556                             <a class="code" href="../../d3/d10/image_8c.html#a1085b9d751195d829c27ff94a69f3486">image_assign_ibuf</a>(ima, ibuf, 0, frame);
<a name="l02557"></a>02557                         }
<a name="l02558"></a>02558                     }
<a name="l02559"></a>02559                 }
<a name="l02560"></a>02560             }
<a name="l02561"></a>02561         }
<a name="l02562"></a>02562 
<a name="l02563"></a>02563         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l02564"></a>02564     }
<a name="l02565"></a>02565 
<a name="l02566"></a>02566     <a class="code" href="../../d2/d77/BKE__image_8h.html#ad5b660dd2b40bffa484187872f271009">tag_image_time</a>(ima);
<a name="l02567"></a>02567 
<a name="l02568"></a>02568     <span class="keywordflow">return</span> ibuf;
<a name="l02569"></a>02569 }
<a name="l02570"></a>02570 
<a name="l02571"></a><a class="code" href="../../d3/d10/image_8c.html#aa805dcbe363b15a25599b39caf84760c">02571</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a9aa97df76020d8128b568780db6a0568">BKE_image_release_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <span class="keywordtype">void</span> *lock)
<a name="l02572"></a>02572 {
<a name="l02573"></a>02573     <span class="comment">/* for getting image during threaded render / compositing, need to release */</span>
<a name="l02574"></a>02574     <span class="keywordflow">if</span> (lock == ima) {
<a name="l02575"></a>02575         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a0612aad752558a84c930348ca3bb41bb">LOCK_VIEWER</a>); <span class="comment">/* viewer image */</span>
<a name="l02576"></a>02576     }
<a name="l02577"></a>02577     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lock) {
<a name="l02578"></a>02578         <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a775f4f363a65ec48123d2c180249edb4">RE_ReleaseResultImage</a>(lock); <span class="comment">/* render result */</span>
<a name="l02579"></a>02579         <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a0612aad752558a84c930348ca3bb41bb">LOCK_VIEWER</a>); <span class="comment">/* view image imbuf */</span>
<a name="l02580"></a>02580     }
<a name="l02581"></a>02581 }
<a name="l02582"></a>02582 
<a name="l02583"></a>02583 <span class="comment">/* warning, this can allocate generated images */</span>
<a name="l02584"></a><a class="code" href="../../d3/d10/image_8c.html#abab9067708f03e2b6dbf11a2cbf0319b">02584</a> <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *<a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(<a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *ima, <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser)
<a name="l02585"></a>02585 {
<a name="l02586"></a>02586     <span class="comment">/* here (+fie_ima/2-1) makes sure that division happens correctly */</span>
<a name="l02587"></a>02587     <span class="keywordflow">return</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a2b04dffde4310589df05cf29db9d2ea4">BKE_image_acquire_ibuf</a>(ima, iuser, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02588"></a>02588 }
<a name="l02589"></a>02589 
<a name="l02590"></a><a class="code" href="../../d3/d10/image_8c.html#a45b14ce90b29d79cc50ae75c91a1bb1b">02590</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a45d4cebabd103acb3e8019885c34f159">BKE_image_user_get_frame</a>(<span class="keyword">const</span> <a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> cfra, <span class="keywordtype">int</span> fieldnr)
<a name="l02591"></a>02591 {
<a name="l02592"></a>02592     <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>= (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ac4e828b08400ad8bc231081b1ba7969e">fie_ima</a>*iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a>)/2;
<a name="l02593"></a>02593 
<a name="l02594"></a>02594     <span class="keywordflow">if</span> (len==0) {
<a name="l02595"></a>02595         <span class="keywordflow">return</span> 0;
<a name="l02596"></a>02596     }
<a name="l02597"></a>02597     <span class="keywordflow">else</span> {
<a name="l02598"></a>02598         <span class="keywordtype">int</span> framenr;
<a name="l02599"></a>02599         cfra= cfra - iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a69e7d2b76006d695daeaae9832df2c83">sfra</a>+1;
<a name="l02600"></a>02600 
<a name="l02601"></a>02601         <span class="comment">/* cyclic */</span>
<a name="l02602"></a>02602         <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a22a1db60afef9af31dae54165dce922e">cycl</a>) {
<a name="l02603"></a>02603             cfra= ( (cfra) % len );
<a name="l02604"></a>02604             <span class="keywordflow">if</span> (cfra &lt; 0) cfra+= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02605"></a>02605             <span class="keywordflow">if</span> (cfra==0) cfra= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02606"></a>02606         }
<a name="l02607"></a>02607 
<a name="l02608"></a>02608         <span class="keywordflow">if</span> (cfra&lt;0) cfra= 0;
<a name="l02609"></a>02609         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfra&gt;len) cfra= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02610"></a>02610 
<a name="l02611"></a>02611         <span class="comment">/* convert current frame to current field */</span>
<a name="l02612"></a>02612         cfra= 2*(cfra);
<a name="l02613"></a>02613         <span class="keywordflow">if</span> (fieldnr) cfra++;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615         <span class="comment">/* transform to images space */</span>
<a name="l02616"></a>02616         framenr= (cfra+iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ac4e828b08400ad8bc231081b1ba7969e">fie_ima</a>-2)/iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ac4e828b08400ad8bc231081b1ba7969e">fie_ima</a>;
<a name="l02617"></a>02617         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (framenr&gt;iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a>) framenr= iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a86cb3e5ecb23a95da68893e43af1c52d">frames</a>;
<a name="l02618"></a>02618         framenr+= iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a576cb0077af7401c73e8634dee46a7f6">offset</a>;
<a name="l02619"></a>02619 
<a name="l02620"></a>02620         <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a22a1db60afef9af31dae54165dce922e">cycl</a>) {
<a name="l02621"></a>02621             framenr= ( (framenr) % len );
<a name="l02622"></a>02622             <span class="keywordflow">while</span> (framenr &lt; 0) framenr+= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02623"></a>02623             <span class="keywordflow">if</span> (framenr==0) framenr= <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l02624"></a>02624         }
<a name="l02625"></a>02625 
<a name="l02626"></a>02626         <span class="keywordflow">return</span> framenr;
<a name="l02627"></a>02627     }
<a name="l02628"></a>02628 }
<a name="l02629"></a>02629 
<a name="l02630"></a><a class="code" href="../../d3/d10/image_8c.html#ae5d96e1bf72875f050db9e0da2995fc6">02630</a> <span class="keywordtype">void</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a10903f281a2ed1213eb50d6ae09f50da">BKE_image_user_calc_frame</a>(<a class="code" href="../../de/d31/structImageUser.html">ImageUser</a> *iuser, <span class="keywordtype">int</span> cfra, <span class="keywordtype">int</span> fieldnr)
<a name="l02631"></a>02631 {
<a name="l02632"></a>02632     <span class="keyword">const</span> <span class="keywordtype">int</span> framenr= <a class="code" href="../../d2/d77/BKE__image_8h.html#a45d4cebabd103acb3e8019885c34f159">BKE_image_user_get_frame</a>(iuser, cfra, fieldnr);
<a name="l02633"></a>02633 
<a name="l02634"></a>02634     <span class="comment">/* allows image users to handle redraws */</span>
<a name="l02635"></a>02635     <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> &amp; <a class="code" href="../../d2/d94/DNA__image__types_8h.html#a5150271fce142589ad2986832d34e85d">IMA_ANIM_ALWAYS</a>)
<a name="l02636"></a>02636         <span class="keywordflow">if</span> (framenr!=iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa6cc3321daee3993cdd38447f24e4a3c">framenr</a>)
<a name="l02637"></a>02637             iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#ad75a0d83edbd58ca9c4cfda7da7d77c8">flag</a> |= <a class="code" href="../../d2/d94/DNA__image__types_8h.html#ac854a536aea46e803b18265aaf9cbcdf">IMA_ANIM_REFRESHED</a>;
<a name="l02638"></a>02638 
<a name="l02639"></a>02639     iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#aa6cc3321daee3993cdd38447f24e4a3c">framenr</a>= framenr;
<a name="l02640"></a>02640     <span class="keywordflow">if</span> (iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>==0) iuser-&gt;<a class="code" href="../../de/d31/structImageUser.html#a4c3780a98eb40a0465264303f197ecab">ok</a>= 1;
<a name="l02641"></a>02641 }
<a name="l02642"></a>02642 
<a name="l02643"></a><a class="code" href="../../d3/d10/image_8c.html#a0414fa198129a6dbec124c02a42c0e5c">02643</a> <span class="keywordtype">int</span> <a class="code" href="../../d2/d77/BKE__image_8h.html#a0414fa198129a6dbec124c02a42c0e5c">BKE_image_has_alpha</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d00/classImage.html" title="32 bit RGBA image.">Image</a> *image)
<a name="l02644"></a>02644 {
<a name="l02645"></a>02645     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l02646"></a>02646     <span class="keywordtype">void</span> *lock;
<a name="l02647"></a>02647     <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>;
<a name="l02648"></a>02648     
<a name="l02649"></a>02649     ibuf= <a class="code" href="../../d2/d77/BKE__image_8h.html#a2b04dffde4310589df05cf29db9d2ea4">BKE_image_acquire_ibuf</a>(image, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;lock);
<a name="l02650"></a>02650     planes = (ibuf?ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a82ce0df1634072ad7ff972bf9d7bacd7">planes</a>:0);
<a name="l02651"></a>02651     <a class="code" href="../../d2/d77/BKE__image_8h.html#a9aa97df76020d8128b568780db6a0568">BKE_image_release_ibuf</a>(image, lock);
<a name="l02652"></a>02652 
<a name="l02653"></a>02653     <span class="keywordflow">if</span> (planes == 32)
<a name="l02654"></a>02654         <span class="keywordflow">return</span> 1;
<a name="l02655"></a>02655     <span class="keywordflow">else</span>
<a name="l02656"></a>02656         <span class="keywordflow">return</span> 0;
<a name="l02657"></a>02657 }
<a name="l02658"></a>02658 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:24 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
