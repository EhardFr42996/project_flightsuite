<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: sunsky.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">sunsky.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/d31/sunsky_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001  <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d88/sunsky_8h.html">sunsky.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00032"></a>00032 
<a name="l00041"></a><a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">00041</a> <span class="preprocessor">#define VEC3OPV(v1, v2, op, v3)                                               \</span>
<a name="l00042"></a>00042 <span class="preprocessor">    {                                                                         \</span>
<a name="l00043"></a>00043 <span class="preprocessor">        v1[0] = (v2[0] op v3[0]);                                             \</span>
<a name="l00044"></a>00044 <span class="preprocessor">        v1[1] = (v2[1] op v3[1]);                                             \</span>
<a name="l00045"></a>00045 <span class="preprocessor">        v1[2] = (v2[2] op v3[2]);                                             \</span>
<a name="l00046"></a>00046 <span class="preprocessor">    } (void)0</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">00053</a> <span class="preprocessor">#define VEC3OPF(v1, v2, op, f1)                                               \</span>
<a name="l00054"></a>00054 <span class="preprocessor">    {                                                                         \</span>
<a name="l00055"></a>00055 <span class="preprocessor">        v1[0] = (v2[0] op (f1));                                              \</span>
<a name="l00056"></a>00056 <span class="preprocessor">        v1[1] = (v2[1] op (f1));                                              \</span>
<a name="l00057"></a>00057 <span class="preprocessor">        v1[2] = (v2[2] op (f1));                                              \</span>
<a name="l00058"></a>00058 <span class="preprocessor">    } (void)0</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00065"></a><a class="code" href="../../da/d31/sunsky_8c.html#a63093198685289b6c778b1faa1246dca">00065</a> <span class="preprocessor">#define FOPVEC3(v1, f1, op, v2)                                               \</span>
<a name="l00066"></a>00066 <span class="preprocessor">    {                                                                         \</span>
<a name="l00067"></a>00067 <span class="preprocessor">        v1[0] = ((f1) op v2[0]);                                              \</span>
<a name="l00068"></a>00068 <span class="preprocessor">        v1[1] = ((f1) op v2[1]);                                              \</span>
<a name="l00069"></a>00069 <span class="preprocessor">        v1[2] = ((f1) op v2[2]);                                              \</span>
<a name="l00070"></a>00070 <span class="preprocessor">    } (void)0</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../da/d31/sunsky_8c.html#add265b69bf1fe55e454d36bc0a0bf089">00076</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#add265b69bf1fe55e454d36bc0a0bf089">ClipColor</a>(<span class="keywordtype">float</span> c[3])
<a name="l00077"></a>00077 {
<a name="l00078"></a>00078     <span class="keywordflow">if</span> (c[0] &gt; 1.0f) c[0] = 1.0f;
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (c[0] &lt; 0.0f) c[0] = 0.0f;
<a name="l00080"></a>00080     <span class="keywordflow">if</span> (c[1] &gt; 1.0f) c[1] = 1.0f;
<a name="l00081"></a>00081     <span class="keywordflow">if</span> (c[1] &lt; 0.0f) c[1] = 0.0f;
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (c[2] &gt; 1.0f) c[2] = 1.0f;
<a name="l00083"></a>00083     <span class="keywordflow">if</span> (c[2] &lt; 0.0f) c[2] = 0.0f;
<a name="l00084"></a>00084 }
<a name="l00085"></a>00085 
<a name="l00091"></a><a class="code" href="../../da/d31/sunsky_8c.html#a30015501191094f651ee583483335ebf">00091</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/sunsky_8c.html#a30015501191094f651ee583483335ebf">AngleBetween</a>(<span class="keywordtype">float</span> thetav, <span class="keywordtype">float</span> phiv, <span class="keywordtype">float</span> theta, <span class="keywordtype">float</span> phi)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <span class="keywordtype">float</span> cospsi = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(thetav) * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(theta) * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(phi - phiv) + <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(thetav) * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(theta);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (cospsi &gt; 1.0f)
<a name="l00096"></a>00096         <span class="keywordflow">return</span> 0;
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (cospsi &lt; -1.0f)
<a name="l00098"></a>00098         <span class="keywordflow">return</span> <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordflow">return</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(cospsi);
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00110"></a><a class="code" href="../../da/d31/sunsky_8c.html#a3c994305db134e31e1b3d8ae857b6018">00110</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/sunsky_8c.html#a3c994305db134e31e1b3d8ae857b6018">DirectionToThetaPhi</a>(<span class="keywordtype">float</span> *toSun, <span class="keywordtype">float</span> *theta, <span class="keywordtype">float</span> *phi)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112     *theta = <a class="code" href="../../d7/d47/NM__Scalar_8h.html#afc5ba75c46d1596598d6bc5fafdbda12">acos</a>(toSun[2]);
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d22/stdosl_8h.html#a706cbf0492993ed1d280ccf8e9b56682">fabs</a>(*theta) &lt; 1e-5)
<a name="l00114"></a>00114         *phi = 0;
<a name="l00115"></a>00115     <span class="keywordflow">else</span>
<a name="l00116"></a>00116         *phi = <a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(toSun[1], toSun[0]);
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00123"></a><a class="code" href="../../da/d31/sunsky_8c.html#ab9c706679642ee6be150f6c7a98a46fc">00123</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/sunsky_8c.html#ab9c706679642ee6be150f6c7a98a46fc">PerezFunction</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a> *sunsky, <span class="keyword">const</span> <span class="keywordtype">float</span> *lam, <span class="keywordtype">float</span> theta, <span class="keywordtype">float</span> gamma, <span class="keywordtype">float</span> lvz)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     <span class="keywordtype">float</span> den, num;
<a name="l00126"></a>00126     
<a name="l00127"></a>00127     den = ((1 + lam[0] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(lam[1])) *
<a name="l00128"></a>00128            (1 + lam[2] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(lam[3] * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>) + lam[4] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>)));
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     num = ((1 + lam[0] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(lam[1] / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(theta))) *
<a name="l00131"></a>00131            (1 + lam[2] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(lam[3] * gamma) + lam[4] * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(gamma) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(gamma)));
<a name="l00132"></a>00132     
<a name="l00133"></a>00133     <span class="keywordflow">return</span>(lvz * num / den);}
<a name="l00134"></a>00134 
<a name="l00148"></a><a class="code" href="../../da/d31/sunsky_8c.html#a320aaf01c0443f4b14a0d6302dc0e4fd">00148</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#a320aaf01c0443f4b14a0d6302dc0e4fd">InitSunSky</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a> *sunsky, <span class="keywordtype">float</span> <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>, <span class="keywordtype">float</span> *toSun, <span class="keywordtype">float</span> horizon_brightness, 
<a name="l00149"></a>00149                 <span class="keywordtype">float</span> spread,<span class="keywordtype">float</span> sun_brightness, <span class="keywordtype">float</span> sun_size, <span class="keywordtype">float</span> back_scatter,
<a name="l00150"></a>00150                 <span class="keywordtype">float</span> skyblendfac, <span class="keywordtype">short</span> skyblendtype, <span class="keywordtype">float</span> sky_exposure, <span class="keywordtype">float</span> sky_colorspace)
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <span class="keywordtype">float</span> theta2;
<a name="l00153"></a>00153     <span class="keywordtype">float</span> theta3;
<a name="l00154"></a>00154     <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a0acb682b8260ab1c60b918599864e2e5">T</a>;
<a name="l00155"></a>00155     <span class="keywordtype">float</span> <a class="code" href="../../dc/dc8/util__md5_8cpp.html#a259c2993ee45e06a4ea8150451a7a70e">T2</a>;
<a name="l00156"></a>00156     <span class="keywordtype">float</span> chi;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a09bc143e672108a154e6373b387ab887">turbidity</a> = <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a07ee6aae8c0e37a70fef49fe0e1e6f4a">horizon_brightness</a> = horizon_brightness;
<a name="l00161"></a>00161     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a702d308f3b5140069c13720a895fce5b">spread</a> = spread;
<a name="l00162"></a>00162     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a0ddef2fe1f0d6517a344d33e5e896083">sun_brightness</a> = sun_brightness;
<a name="l00163"></a>00163     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac05ac01ed140b69a13e02ada3ca80a81">sun_size</a> = sun_size;
<a name="l00164"></a>00164     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ade2c5bab03bab00c45fbebf6b6a294b6">backscattered_light</a> = back_scatter;
<a name="l00165"></a>00165     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a8fcd983c4bed0caf9ff9f7d2f733a741">skyblendfac</a>= skyblendfac;
<a name="l00166"></a>00166     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a749f61e3d414352b282ab681986ebfc8">skyblendtype</a>= skyblendtype;
<a name="l00167"></a>00167     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a8210c0ad69ca25987e9269aecfc4b703">sky_exposure</a>= -sky_exposure;
<a name="l00168"></a>00168     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7299aacc8f3babf7a16758bd0968256c">sky_colorspace</a>= sky_colorspace;
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[0] = toSun[0];
<a name="l00171"></a>00171     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[1] = toSun[1];
<a name="l00172"></a>00172     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[2] = toSun[2];
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <a class="code" href="../../da/d31/sunsky_8c.html#a3c994305db134e31e1b3d8ae857b6018">DirectionToThetaPhi</a>(sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>, &amp;sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>, &amp;sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1cd41b168bc3e06b0c3f1ce3087ffce0">phi</a>);
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ad37cd6370abf87d4742e19f9a660c277">sunSolidAngle</a> = 0.25 * <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> * 1.39 * 1.39 / (150 * 150);   <span class="comment">// = 6.7443e-05</span>
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     theta2 = sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>*sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>;
<a name="l00179"></a>00179     theta3 = theta2 * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>;
<a name="l00180"></a>00180     T = <a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00181"></a>00181     T2 = turb*<a class="code" href="../../d3/d41/mathutils__noise_8c.html#aa3fbc7371bf04afa8f7d292b32861eda">turb</a>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     chi = (4.0f / 9.0f - T / 120.0f) * ((<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> - 2.0f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>);
<a name="l00184"></a>00184     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a4b77868d21149176bf4414cc608e4b79">zenith_Y</a> = (4.0453f * T - 4.9710f) * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a8399002c5cbbff754c83f8b9ac3d77e8">tanf</a>(chi) - 0.2155f * T + 2.4192f;
<a name="l00185"></a>00185     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a4b77868d21149176bf4414cc608e4b79">zenith_Y</a> *= 1000;   <span class="comment">// conversion from kcd/m^2 to cd/m^2</span>
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a4b77868d21149176bf4414cc608e4b79">zenith_Y</a>&lt;=0)
<a name="l00188"></a>00188         sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a4b77868d21149176bf4414cc608e4b79">zenith_Y</a> = 1e-6;
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1fdf6e5f3dbf8e4e380cca9c27092f58">zenith_x</a> =
<a name="l00191"></a>00191         ( + 0.00165f * theta3 - 0.00374f * theta2 + 0.00208f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.0f) * T2 +
<a name="l00192"></a>00192         ( -0.02902f * theta3 + 0.06377f * theta2 - 0.03202f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.00394f) * T +
<a name="l00193"></a>00193         ( + 0.11693f * theta3 - 0.21196f * theta2 + 0.06052f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.25885f);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a87a1cc724a941c1db4ff5d37e3fedf3b">zenith_y</a> =
<a name="l00196"></a>00196         ( + 0.00275f * theta3 - 0.00610f * theta2 + 0.00316f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.0f) * T2 +
<a name="l00197"></a>00197         ( -0.04214f * theta3 + 0.08970f * theta2 - 0.04153f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.00515f) * T +
<a name="l00198"></a>00198         ( + 0.15346f * theta3 - 0.26756f * theta2 + 0.06669f * sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a> + 0.26688f);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     
<a name="l00201"></a>00201     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[0] = 0.17872f * T - 1.46303f;
<a name="l00202"></a>00202     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[1] = -0.35540f * T + 0.42749f;
<a name="l00203"></a>00203     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[2] = -0.02266f * T + 5.32505f;
<a name="l00204"></a>00204     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[3] = 0.12064f * T - 2.57705f;
<a name="l00205"></a>00205     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[4] = -0.06696f * T + 0.37027f;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[0] = -0.01925f * T - 0.25922f;
<a name="l00208"></a>00208     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[1] = -0.06651f * T + 0.00081f;
<a name="l00209"></a>00209     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[2] = -0.00041f * T + 0.21247f;
<a name="l00210"></a>00210     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[3] = -0.06409f * T - 0.89887f;
<a name="l00211"></a>00211     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[4] = -0.00325f * T + 0.04517f;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[0] = -0.01669f * T - 0.26078f;
<a name="l00214"></a>00214     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[1] = -0.09495f * T + 0.00921f;
<a name="l00215"></a>00215     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[2] = -0.00792f * T + 0.21023f;
<a name="l00216"></a>00216     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[3] = -0.04405f * T - 1.65369f;
<a name="l00217"></a>00217     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[4] = -0.01092f * T + 0.05291f;
<a name="l00218"></a>00218     
<a name="l00219"></a>00219     <span class="comment">/* suggested by glome in </span>
<a name="l00220"></a>00220 <span class="comment">     * http://projects.blender.org/tracker/?func=detail&amp;atid=127&amp;aid=8063&amp;group_id=9*/</span>
<a name="l00221"></a>00221     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[0] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a07ee6aae8c0e37a70fef49fe0e1e6f4a">horizon_brightness</a>;
<a name="l00222"></a>00222     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[0] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a07ee6aae8c0e37a70fef49fe0e1e6f4a">horizon_brightness</a>;
<a name="l00223"></a>00223     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[0] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a07ee6aae8c0e37a70fef49fe0e1e6f4a">horizon_brightness</a>;
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[1] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a702d308f3b5140069c13720a895fce5b">spread</a>;
<a name="l00226"></a>00226     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[1] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a702d308f3b5140069c13720a895fce5b">spread</a>;
<a name="l00227"></a>00227     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[1] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a702d308f3b5140069c13720a895fce5b">spread</a>;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[2] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a0ddef2fe1f0d6517a344d33e5e896083">sun_brightness</a>;
<a name="l00230"></a>00230     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[2] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a0ddef2fe1f0d6517a344d33e5e896083">sun_brightness</a>;
<a name="l00231"></a>00231     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[2] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a0ddef2fe1f0d6517a344d33e5e896083">sun_brightness</a>;
<a name="l00232"></a>00232     
<a name="l00233"></a>00233     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[3] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac05ac01ed140b69a13e02ada3ca80a81">sun_size</a>;
<a name="l00234"></a>00234     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[3] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac05ac01ed140b69a13e02ada3ca80a81">sun_size</a>;
<a name="l00235"></a>00235     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[3] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ac05ac01ed140b69a13e02ada3ca80a81">sun_size</a>;
<a name="l00236"></a>00236     
<a name="l00237"></a>00237     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>[4] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ade2c5bab03bab00c45fbebf6b6a294b6">backscattered_light</a>;
<a name="l00238"></a>00238     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>[4] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ade2c5bab03bab00c45fbebf6b6a294b6">backscattered_light</a>;
<a name="l00239"></a>00239     sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>[4] *= sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ade2c5bab03bab00c45fbebf6b6a294b6">backscattered_light</a>;
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00251"></a><a class="code" href="../../da/d31/sunsky_8c.html#ac19f768471779fdd3e394e54d4ba9e05">00251</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#ac19f768471779fdd3e394e54d4ba9e05">GetSkyXYZRadiance</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a>* sunsky, <span class="keywordtype">float</span> theta, <span class="keywordtype">float</span> phi, <span class="keywordtype">float</span> color_out[3])
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <span class="keywordtype">float</span> gamma;
<a name="l00254"></a>00254     <span class="keywordtype">float</span> x,y,Y,<a class="code" href="../../de/da0/strsv_8c.html#a5ae25df4ee72f83efb4a3683c970678f">X</a>,Z;
<a name="l00255"></a>00255     <span class="keywordtype">float</span> hfade=1, nfade=1;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (theta&gt;(0.5f*(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>)) {
<a name="l00259"></a>00259         hfade = 1.0f-(theta*(float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a08dfac3cca9601a02fc88356cc078e1d">M_1_PI</a>-0.5f)*2.0f;
<a name="l00260"></a>00260         hfade = hfade*hfade*(3.0f-2.0f*hfade);
<a name="l00261"></a>00261         theta = 0.5*<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>&gt;(0.5f*(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>)) {
<a name="l00265"></a>00265         <span class="keywordflow">if</span> (theta&lt;=0.5f*(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>) {
<a name="l00266"></a>00266             nfade = 1.0f-(0.5f-theta*(float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a08dfac3cca9601a02fc88356cc078e1d">M_1_PI</a>)*2.0f;
<a name="l00267"></a>00267             nfade *= 1.0f-(sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>*(float)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a08dfac3cca9601a02fc88356cc078e1d">M_1_PI</a>-0.5f)*2.0f;
<a name="l00268"></a>00268             nfade = nfade*nfade*(3.0f-2.0f*nfade);
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     gamma = <a class="code" href="../../da/d31/sunsky_8c.html#a30015501191094f651ee583483335ebf">AngleBetween</a>(theta, phi, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1cd41b168bc3e06b0c3f1ce3087ffce0">phi</a>);
<a name="l00273"></a>00273     
<a name="l00274"></a>00274     <span class="comment">// Compute xyY values</span>
<a name="l00275"></a>00275     x = <a class="code" href="../../da/d31/sunsky_8c.html#ab9c706679642ee6be150f6c7a98a46fc">PerezFunction</a>(sunsky, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acfac5c1b77fe43128cf17e6c64937165">perez_x</a>, theta, gamma, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1fdf6e5f3dbf8e4e380cca9c27092f58">zenith_x</a>);
<a name="l00276"></a>00276     y = <a class="code" href="../../da/d31/sunsky_8c.html#ab9c706679642ee6be150f6c7a98a46fc">PerezFunction</a>(sunsky, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adc45266b0f4b6a5cbe68fc15eacc66f1">perez_y</a>, theta, gamma, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a87a1cc724a941c1db4ff5d37e3fedf3b">zenith_y</a>);
<a name="l00277"></a>00277     Y = 6.666666667e-5f * nfade * hfade * <a class="code" href="../../da/d31/sunsky_8c.html#ab9c706679642ee6be150f6c7a98a46fc">PerezFunction</a>(sunsky, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a6dbbe895bd7fee7b8b56798792813c9d">perez_Y</a>, theta, gamma, sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a4b77868d21149176bf4414cc608e4b79">zenith_Y</a>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a8210c0ad69ca25987e9269aecfc4b703">sky_exposure</a>!=0.0f)
<a name="l00280"></a>00280         Y = 1.0 - <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(Y*sunsky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a8210c0ad69ca25987e9269aecfc4b703">sky_exposure</a>);
<a name="l00281"></a>00281     
<a name="l00282"></a>00282     X = (x / y) * Y;
<a name="l00283"></a>00283     Z = ((1 - x - y) / y) * Y;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     color_out[0] = X;
<a name="l00286"></a>00286     color_out[1] = Y;
<a name="l00287"></a>00287     color_out[2] = Z;
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00298"></a><a class="code" href="../../da/d31/sunsky_8c.html#a635b203f1cec132c76cd888249df299b">00298</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#a635b203f1cec132c76cd888249df299b">GetSkyXYZRadiancef</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a>* sunsky, <span class="keyword">const</span> <span class="keywordtype">float</span> varg[3], <span class="keywordtype">float</span> color_out[3])
<a name="l00299"></a>00299 {
<a name="l00300"></a>00300     <span class="keywordtype">float</span>   theta, phi;
<a name="l00301"></a>00301     <span class="keywordtype">float</span>   v[3];
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v, (<span class="keywordtype">float</span>*)varg);
<a name="l00304"></a>00304     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v);
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (v[2] &lt; 0.001f) {
<a name="l00307"></a>00307         v[2] = 0.001f;
<a name="l00308"></a>00308         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(v);
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <a class="code" href="../../da/d31/sunsky_8c.html#a3c994305db134e31e1b3d8ae857b6018">DirectionToThetaPhi</a>(v, &amp;theta, &amp;phi);
<a name="l00312"></a>00312     <a class="code" href="../../dc/d88/sunsky_8h.html#ac19f768471779fdd3e394e54d4ba9e05">GetSkyXYZRadiance</a>(sunsky, theta, phi, color_out);
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00323"></a><a class="code" href="../../da/d31/sunsky_8c.html#a0241266c76d7334f279102a1de8f79c8">00323</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/sunsky_8c.html#a0241266c76d7334f279102a1de8f79c8">ComputeAttenuatedSunlight</a>(<span class="keywordtype">float</span> theta, <span class="keywordtype">int</span> turbidity, <span class="keywordtype">float</span> fTau[3])
<a name="l00324"></a>00324 {
<a name="l00325"></a>00325     <span class="keywordtype">float</span> fBeta;
<a name="l00326"></a>00326     <span class="keywordtype">float</span> fTauR, fTauA;
<a name="l00327"></a>00327     <span class="keywordtype">float</span> m;
<a name="l00328"></a>00328     <span class="keywordtype">float</span> fAlpha;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00331"></a>00331     <span class="keywordtype">float</span> fLambda[3]; 
<a name="l00332"></a>00332     fLambda[0] = 0.65f; 
<a name="l00333"></a>00333     fLambda[1] = 0.57f; 
<a name="l00334"></a>00334     fLambda[2] = 0.475f;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     fAlpha = 1.3f;
<a name="l00337"></a>00337     fBeta = 0.04608365822050f * turbidity - 0.04586025928522f;
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     m =  1.0f/(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a2503b77b52ff481a3507a596ae1f3938">cosf</a>(theta) + 0.15f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(93.885f-theta/(<span class="keywordtype">float</span>)<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>*180.0f,-1.253f));
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
<a name="l00342"></a>00342     {
<a name="l00343"></a>00343         <span class="comment">// Rayleigh Scattering</span>
<a name="l00344"></a>00344         fTauR = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>( -m * 0.008735f * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(fLambda[i], (<span class="keywordtype">float</span>)(-4.08f)));
<a name="l00345"></a>00345 
<a name="l00346"></a>00346         <span class="comment">// Aerosal (water + dust) attenuation</span>
<a name="l00347"></a>00347         fTauA = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(-m * fBeta * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(fLambda[i], -fAlpha));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         fTau[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = fTauR * fTauA; 
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00365"></a><a class="code" href="../../da/d31/sunsky_8c.html#af3a60aad8494a03ce09ee469cf29dd57">00365</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#af3a60aad8494a03ce09ee469cf29dd57">InitAtmosphere</a>(<span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a> *sunSky, <span class="keywordtype">float</span> sun_intens, <span class="keywordtype">float</span> mief, <span class="keywordtype">float</span> rayf,
<a name="l00366"></a>00366                             <span class="keywordtype">float</span> inscattf, <span class="keywordtype">float</span> extincf, <span class="keywordtype">float</span> disf)
<a name="l00367"></a>00367 {
<a name="l00368"></a>00368     <span class="keyword">const</span> <span class="keywordtype">float</span> pi = 3.14159265358f;
<a name="l00369"></a>00369     <span class="keyword">const</span> <span class="keywordtype">float</span> n = 1.003f; <span class="comment">// refractive index</span>
<a name="l00370"></a>00370     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a0240ac851181b84ac374872dc5434ee4">N</a> = 2.545e25;
<a name="l00371"></a>00371     <span class="keyword">const</span> <span class="keywordtype">float</span> pn = 0.035f;
<a name="l00372"></a>00372     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d2/d6c/mball_8c.html#a0acb682b8260ab1c60b918599864e2e5">T</a> = 2.0f;
<a name="l00373"></a>00373     <span class="keywordtype">float</span> fTemp, fTemp2, fTemp3, fBeta, fBetaDash;
<a name="l00374"></a>00374     <span class="keywordtype">float</span> c = (6.544f*T - 6.51f)*1e-17f;
<a name="l00375"></a>00375     <span class="keywordtype">float</span> <a class="code" href="../../d8/d9e/EventToBuf_8c.html#a44274d284f44463aaf509177c78913ed">K</a>[3] = {0.685f, 0.679f, 0.670f};
<a name="l00376"></a>00376     <span class="keywordtype">float</span> vBetaMieTemp[3];
<a name="l00377"></a>00377     
<a name="l00378"></a>00378     <span class="keywordtype">float</span> fLambda[3],fLambda2[3], fLambda4[3];
<a name="l00379"></a>00379     <span class="keywordtype">float</span> vLambda2[3];
<a name="l00380"></a>00380     <span class="keywordtype">float</span> vLambda4[3];
<a name="l00381"></a>00381     
<a name="l00382"></a>00382     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a94dde2cd86551118eba5668441d37d11">atm_SunIntensity</a> = sun_intens;
<a name="l00385"></a>00385     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1acc14bad0f67b3601ce615d11aed3a3">atm_BetaMieMultiplier</a>  = mief;
<a name="l00386"></a>00386     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ab47fd768bbe5eb46c239a80b6d3f7a8c">atm_BetaRayMultiplier</a> = rayf;
<a name="l00387"></a>00387     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adef9f3709b602eb6dd3bad3adb6f6a2e">atm_InscatteringMultiplier</a> = inscattf;
<a name="l00388"></a>00388     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adeb30448f6b6404508e7f342e6e6ec57">atm_ExtinctionMultiplier</a> = extincf;
<a name="l00389"></a>00389     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a333eb08e7dd640cabdc3d9d656ee174b">atm_DistanceMultiplier</a> = disf;
<a name="l00390"></a>00390         
<a name="l00391"></a>00391     sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7b64dfae806de527ad696644e2c19a1f">atm_HGg</a>=0.8;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     fLambda[0]  = 1/650e-9f; 
<a name="l00394"></a>00394     fLambda[1]  = 1/570e-9f;
<a name="l00395"></a>00395     fLambda[2]  = 1/475e-9f;
<a name="l00396"></a>00396     <span class="keywordflow">for</span> (i=0; i &lt; 3; i++)
<a name="l00397"></a>00397     {
<a name="l00398"></a>00398         fLambda2[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = fLambda[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*fLambda[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00399"></a>00399         fLambda4[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = fLambda2[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]*fLambda2[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     vLambda2[0] = fLambda2[0];
<a name="l00403"></a>00403     vLambda2[1] = fLambda2[1];
<a name="l00404"></a>00404     vLambda2[2] = fLambda2[2];
<a name="l00405"></a>00405  
<a name="l00406"></a>00406     vLambda4[0] = fLambda4[0];
<a name="l00407"></a>00407     vLambda4[1] = fLambda4[1];
<a name="l00408"></a>00408     vLambda4[2] = fLambda4[2];
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="comment">// Rayleigh scattering constants.</span>
<a name="l00411"></a>00411     fTemp = pi*pi*(n*n-1)*(n*n-1)*(6+3*pn)/(6-7*pn)/<a class="code" href="../../d2/d6c/mball_8c.html#a0240ac851181b84ac374872dc5434ee4">N</a>;
<a name="l00412"></a>00412     fBeta = 8*fTemp*pi/3;
<a name="l00413"></a>00413         
<a name="l00414"></a>00414     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aaba56c54f61aa30d266481fdfc610067">atm_BetaRay</a>, vLambda4, *, fBeta);
<a name="l00415"></a>00415     fBetaDash = fTemp/2;
<a name="l00416"></a>00416     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a195ed1517a2a3e99e6e48aa95a26803e">atm_BetaDashRay</a>, vLambda4,*, fBetaDash);
<a name="l00417"></a>00417     
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <span class="comment">// Mie scattering constants.</span>
<a name="l00420"></a>00420     fTemp2 = 0.434f*c*(2*pi)*(2*pi)*0.5f;
<a name="l00421"></a>00421     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a942ec0531f8f1ea63102ae04e5cc51e6">atm_BetaDashMie</a>, vLambda2, *, fTemp2);
<a name="l00422"></a>00422     
<a name="l00423"></a>00423     fTemp3 = 0.434f*c*pi*(2*pi)*(2*pi);
<a name="l00424"></a>00424     
<a name="l00425"></a>00425     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(vBetaMieTemp, K, *, fLambda);
<a name="l00426"></a>00426     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acaed2c5d693f3473890bd3c60326ee3b">atm_BetaMie</a>, vBetaMieTemp,*, fTemp3);
<a name="l00427"></a>00427     
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00439"></a><a class="code" href="../../da/d31/sunsky_8c.html#a1d5ef4ae25285a3f691a14a8c02570b7">00439</a> <span class="keywordtype">void</span> <a class="code" href="../../dc/d88/sunsky_8h.html#a1d5ef4ae25285a3f691a14a8c02570b7">AtmospherePixleShader</a>( <span class="keyword">struct</span> <a class="code" href="../../d7/dc2/structSunSky.html">SunSky</a>* sunSky, <span class="keywordtype">float</span> view[3], <span class="keywordtype">float</span> s, <span class="keywordtype">float</span> rgb[3])
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441     <span class="keywordtype">float</span> costheta;
<a name="l00442"></a>00442     <span class="keywordtype">float</span> Phase_1;
<a name="l00443"></a>00443     <span class="keywordtype">float</span> Phase_2;
<a name="l00444"></a>00444     <span class="keywordtype">float</span> sunColor[3];
<a name="l00445"></a>00445     
<a name="l00446"></a>00446     <span class="keywordtype">float</span> E[3];
<a name="l00447"></a>00447     <span class="keywordtype">float</span> E1[3];
<a name="l00448"></a>00448     
<a name="l00449"></a>00449     
<a name="l00450"></a>00450     <span class="keywordtype">float</span> <a class="code" href="../../d7/d0d/node__texture__proc_8c.html#a60ef6e1bcfabb95cfeb300e1d03ce470">I</a>[3];
<a name="l00451"></a>00451     <span class="keywordtype">float</span> fTemp;
<a name="l00452"></a>00452     <span class="keywordtype">float</span> vTemp1[3], vTemp2[3];
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="keywordtype">float</span> sunDirection[3];
<a name="l00455"></a>00455     
<a name="l00456"></a>00456     s *= sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a333eb08e7dd640cabdc3d9d656ee174b">atm_DistanceMultiplier</a>;
<a name="l00457"></a>00457     
<a name="l00458"></a>00458     sunDirection[0] = sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[0];
<a name="l00459"></a>00459     sunDirection[1] = sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[1];
<a name="l00460"></a>00460     sunDirection[2] = sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ae3a0023eaf4b00c15a22157c7ff2b7bc">toSun</a>[2];
<a name="l00461"></a>00461     
<a name="l00462"></a>00462     costheta = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(view, sunDirection); <span class="comment">// cos(theta)</span>
<a name="l00463"></a>00463     Phase_1 = 1 + (costheta * costheta); <span class="comment">// Phase_1</span>
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aaba56c54f61aa30d266481fdfc610067">atm_BetaRay</a>, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aaba56c54f61aa30d266481fdfc610067">atm_BetaRay</a>, *, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#ab47fd768bbe5eb46c239a80b6d3f7a8c">atm_BetaRayMultiplier</a>);
<a name="l00466"></a>00466     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acaed2c5d693f3473890bd3c60326ee3b">atm_BetaMie</a>, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acaed2c5d693f3473890bd3c60326ee3b">atm_BetaMie</a>, *, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a1acc14bad0f67b3601ce615d11aed3a3">atm_BetaMieMultiplier</a>);
<a name="l00467"></a>00467     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a257b7f4362c923dc554d686c8427486c">atm_BetaRM</a>, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aaba56c54f61aa30d266481fdfc610067">atm_BetaRay</a>, +, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#acaed2c5d693f3473890bd3c60326ee3b">atm_BetaMie</a>);
<a name="l00468"></a>00468     
<a name="l00469"></a>00469     <span class="comment">//e^(-(beta_1 + beta_2) * s) = E1</span>
<a name="l00470"></a>00470     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(E1, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a257b7f4362c923dc554d686c8427486c">atm_BetaRM</a>, *, -s/(<span class="keywordtype">float</span>)<a class="code" href="../../dd/d06/BLI__math__base_8h.html#a92428112a5d24721208748774a4f23e6">M_LN2</a>);
<a name="l00471"></a>00471     E1[0] = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(E1[0]);
<a name="l00472"></a>00472     E1[1] = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(E1[1]);
<a name="l00473"></a>00473     E1[2] = <a class="code" href="../../d0/dbc/namespaceKDL.html#a82c1904677c13464d30566d25edc9034">exp</a>(E1[2]);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(E, E1);
<a name="l00476"></a>00476         
<a name="l00477"></a>00477     <span class="comment">//Phase2(theta) = (1-g^2)/(1+g-2g*cos(theta))^(3/2)</span>
<a name="l00478"></a>00478     fTemp = 1 + sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7b64dfae806de527ad696644e2c19a1f">atm_HGg</a> - 2 * sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7b64dfae806de527ad696644e2c19a1f">atm_HGg</a> * costheta;
<a name="l00479"></a>00479     fTemp = fTemp * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(fTemp);
<a name="l00480"></a>00480     Phase_2 = (1 - sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7b64dfae806de527ad696644e2c19a1f">atm_HGg</a> * sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a7b64dfae806de527ad696644e2c19a1f">atm_HGg</a>)/fTemp;
<a name="l00481"></a>00481     
<a name="l00482"></a>00482     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(vTemp1, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a195ed1517a2a3e99e6e48aa95a26803e">atm_BetaDashRay</a>, *, Phase_1);
<a name="l00483"></a>00483     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(vTemp2, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a942ec0531f8f1ea63102ae04e5cc51e6">atm_BetaDashMie</a>, *, Phase_2);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(vTemp1, vTemp1, +, vTemp2);
<a name="l00486"></a>00486     <a class="code" href="../../da/d31/sunsky_8c.html#a63093198685289b6c778b1faa1246dca">FOPVEC3</a>(vTemp2, 1.0f, -, E1);
<a name="l00487"></a>00487     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(vTemp1, vTemp1, *, vTemp2);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     <a class="code" href="../../da/d31/sunsky_8c.html#a63093198685289b6c778b1faa1246dca">FOPVEC3</a>(vTemp2, 1.0f, / , sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a257b7f4362c923dc554d686c8427486c">atm_BetaRM</a>);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(I, vTemp1, *, vTemp2);
<a name="l00492"></a>00492         
<a name="l00493"></a>00493     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(I, I, *, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adef9f3709b602eb6dd3bad3adb6f6a2e">atm_InscatteringMultiplier</a>);
<a name="l00494"></a>00494     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(E, E, *, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#adeb30448f6b6404508e7f342e6e6ec57">atm_ExtinctionMultiplier</a>);
<a name="l00495"></a>00495         
<a name="l00496"></a>00496     <span class="comment">//scale to color sun</span>
<a name="l00497"></a>00497     <a class="code" href="../../da/d31/sunsky_8c.html#a0241266c76d7334f279102a1de8f79c8">ComputeAttenuatedSunlight</a>(sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#aa95ccc34ef9c3b36e7d3dd2ad62b2ece">theta</a>, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a09bc143e672108a154e6373b387ab887">turbidity</a>, sunColor);
<a name="l00498"></a>00498     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(E, E, *, sunColor);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <a class="code" href="../../da/d31/sunsky_8c.html#ae564c901b6330fff8745d6841988b4ad">VEC3OPF</a>(I, I, *, sunSky-&gt;<a class="code" href="../../d7/dc2/structSunSky.html#a94dde2cd86551118eba5668441d37d11">atm_SunIntensity</a>);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(rgb, rgb, *, E);
<a name="l00503"></a>00503     <a class="code" href="../../da/d31/sunsky_8c.html#a63793c4180f58ba263f35ffb93c5941b">VEC3OPV</a>(rgb, rgb, +, I);
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <span class="preprocessor">#undef VEC3OPV</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span><span class="preprocessor">#undef VEC3OPF</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span><span class="preprocessor">#undef FOPVEC3</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>
<a name="l00510"></a>00510 <span class="comment">/* EOF */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:58 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
