<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: paint_vertex.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">paint_vertex.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/d31/paint__vertex_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;io.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#else</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#endif   </span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc5/BLI__ghash_8h.html" title="A general (pointer -&gt; pointer) hash table ADT.">BLI_ghash.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d93/DNA__armature__types_8h.html">DNA_armature_types.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d5a/DNA__particle__types_8h.html">DNA_particle_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d37/DNA__brush__types_8h.html">DNA_brush_types.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html">DNA_meshdata_types.h</a>&quot;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d68/RNA__enum__types_8h.html">RNA_enum_types.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d17/BKE__armature_8h.html">BKE_armature.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/df5/BKE__action_8h.html" title="Blender kernel action and pose functionality.">BKE_action.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../da/dc9/BKE__brush_8h.html">BKE_brush.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dbd/BKE__deform_8h.html" title="support for deformation groups and hooks.">BKE_deform.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d7f/BKE__mesh_8h.html">BKE_mesh.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d0f/BKE__modifier_8h.html">BKE_modifier.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dac/BKE__object_8h.html" title="General operations, lookup, etc. for blender objects.">BKE_object.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d86/BKE__paint_8h.html">BKE_paint.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d40/BKE__report_8h.html">BKE_report.h</a>&quot;</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d98/ED__armature_8h.html">ED_armature.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d6c/paint__intern_8h.html">paint_intern.h</a>&quot;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="comment">/* check if we can do partial updates and have them draw realtime</span>
<a name="l00090"></a>00090 <span class="comment"> * (without rebuilding the &#39;derivedFinal&#39;) */</span>
<a name="l00091"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3eedb778404e270b2349b7c70e418f9b">00091</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3eedb778404e270b2349b7c70e418f9b">vertex_paint_use_fast_update_check</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="keywordflow">if</span> (dm) {
<a name="l00096"></a>00096         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00097"></a>00097         <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>) {
<a name="l00098"></a>00098             <span class="keywordflow">return</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a> == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>));
<a name="l00099"></a>00099         }
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">/* if the polygons from the mesh and the &#39;derivedFinal&#39; match</span>
<a name="l00106"></a>00106 <span class="comment"> * we can assume that no modifiers are applied and that its worth adding tessellated faces</span>
<a name="l00107"></a>00107 <span class="comment"> * so &#39;vertex_paint_use_fast_update_check()&#39; returns TRUE */</span>
<a name="l00108"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a0b9d7a2df1f0a87a768bac214655685a">00108</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a0b9d7a2df1f0a87a768bac214655685a">vertex_paint_use_tessface_check</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a90f2cb67625caff2124e0675ea32510d">derivedFinal</a>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (dm) {
<a name="l00113"></a>00113         <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00114"></a>00114         <span class="keywordflow">return</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a> == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a12722e14b04d5f053d93d2a3bb81203e">faceData</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a9b16cdec502754c725828330159ea1cf">CD_MPOLY</a>));
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">/* polling - retrieve whether cursor should be set or operator should be done */</span>
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="comment">/* Returns true if vertex paint mode is active */</span>
<a name="l00123"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a852e0ec737b294b9efb216d3086d768e">00123</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#aa7f7a22ea83d387314a6082e4c6671ce">vertex_paint_mode_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="keywordflow">return</span> ob &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a> &amp;&amp; ((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;totpoly;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a48b30139004ac61b0316516a8a501440">00130</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab4a93bb6c2400695e459c87883735b24">vertex_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6c/paint__intern_8h.html#aa7f7a22ea83d387314a6082e4c6671ce">vertex_paint_mode_poll</a>(C) &amp;&amp; 
<a name="l00133"></a>00133         <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;<a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C)-&gt;vpaint-&gt;paint))
<a name="l00134"></a>00134     {
<a name="l00135"></a>00135         <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa = <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C);
<a name="l00136"></a>00136         <span class="keywordflow">if</span> (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>) {
<a name="l00137"></a>00137             <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00138"></a>00138             <span class="keywordflow">if</span> (ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> == <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>)
<a name="l00139"></a>00139                 <span class="keywordflow">return</span> 1;
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142     <span class="keywordflow">return</span> 0;
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a803079ef5d83c48ec9eb15634919cb21">00145</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a509408c9bafa9b798c8ee17db63f2f3a">weight_paint_mode_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">return</span> ob &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a> &amp;&amp; ((<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;totpoly;
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a130e9251156701763442e56dc46d7666">00152</a> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab771c0d67420decddf7ba7336b4e9126">weight_paint_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>)
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l00155"></a>00155     <a class="code" href="../../d4/d95/structScrArea.html">ScrArea</a> *sa;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keywordflow">if</span> ((ob != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp;
<a name="l00158"></a>00158         (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) &amp;&amp;
<a name="l00159"></a>00159         (<a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;<a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C)-&gt;wpaint-&gt;paint) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp;
<a name="l00160"></a>00160         (sa = <a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C)) &amp;&amp;
<a name="l00161"></a>00161         (sa-&gt;<a class="code" href="../../d4/d95/structScrArea.html#a124203529b9ea4c84ca8f8ae4efff3e3">spacetype</a> == <a class="code" href="../../d8/d5d/DNA__space__types_8h.html#a5efefa44b296976f2147b8acbed1752caf4af925b582bb7d7590235f90a38c8a9">SPACE_VIEW3D</a>))
<a name="l00162"></a>00162     {
<a name="l00163"></a>00163         <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *ar = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l00164"></a>00164         <span class="keywordflow">if</span> (ar-&gt;<a class="code" href="../../da/d23/structARegion.html#ad430a35493ef271e772179ccb7abb767">regiontype</a> == <a class="code" href="../../d4/da4/DNA__screen__types_8h.html#a425be5f49e9c31d8d13d53190a3e7bc2a3d4303928de6d095b8db2a0637930a63">RGN_TYPE_WINDOW</a>) {
<a name="l00165"></a>00165             <span class="keywordflow">return</span> 1;
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordflow">return</span> 0;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00171"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ae74f441ef2ed3ac1f3c7a5a9cc37a950">00171</a> <span class="keyword">static</span> <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *<a class="code" href="../../da/d31/paint__vertex_8c.html#ae74f441ef2ed3ac1f3c7a5a9cc37a950">new_vpaint</a>(<span class="keywordtype">int</span> wpaint)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a>), <span class="stringliteral">&quot;VPaint&quot;</span>);
<a name="l00174"></a>00174     
<a name="l00175"></a>00175     vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad38f734cc540a73ad8e07a2271511299">VP_AREA</a> + <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae1b08ef491270c86c0068ac293102fad">VP_SPRAY</a>;
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (wpaint)
<a name="l00178"></a>00178         vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad38f734cc540a73ad8e07a2271511299">VP_AREA</a>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keywordflow">return</span> vp;
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a9c733e19c07defdb2f40833d7c43caf3">00183</a> <span class="keyword">static</span> <span class="keywordtype">int</span> *<a class="code" href="../../da/d31/paint__vertex_8c.html#a9c733e19c07defdb2f40833d7c43caf3">get_indexarray</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l00184"></a>00184 {
<a name="l00185"></a>00185     <span class="keywordflow">return</span> <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> + 1), <span class="stringliteral">&quot;vertexpaint&quot;</span>);
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a4f84849497978a26f8bb6aae26e928e9">00188</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#aa2cdd1762e74a4d397575cc78809c936">vpaint_get_current_col</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp)
<a name="l00189"></a>00189 {
<a name="l00190"></a>00190     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l00191"></a>00191     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> col[4];
<a name="l00192"></a>00192     <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a9b3bb8bb3331550782244e732cd1d349">rgb_float_to_uchar</a>(col, brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a85d21a075a302395b9930f523c0b0487">rgb</a>);
<a name="l00193"></a>00193     col[3] = 255; <span class="comment">/* alpha isn&#39;t used, could even be removed to speedup paint a little */</span>
<a name="l00194"></a>00194     <span class="keywordflow">return</span> *(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)col;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a4ed550971b8ea63213cc3fac1d262e7d">00197</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a4ed550971b8ea63213cc3fac1d262e7d">do_shared_vertex_tesscol</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     <span class="comment">/* if no mcol: do not do */</span>
<a name="l00200"></a>00200     <span class="comment">/* if tface: only the involved faces, otherwise all */</span>
<a name="l00201"></a>00201     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface;
<a name="l00202"></a>00202     <a class="code" href="../../da/d7f/structMTFace.html">MTFace</a> *tface;
<a name="l00203"></a>00203     <span class="keywordtype">int</span> a;
<a name="l00204"></a>00204     <span class="keywordtype">short</span> *scolmain, *scol;
<a name="l00205"></a>00205     <span class="keywordtype">char</span> *mcol;
<a name="l00206"></a>00206     
<a name="l00207"></a>00207     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a> == 0) <span class="keywordflow">return</span>;
<a name="l00208"></a>00208     
<a name="l00209"></a>00209     scolmain = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(4 * <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>, <span class="stringliteral">&quot;colmain&quot;</span>);
<a name="l00210"></a>00210     
<a name="l00211"></a>00211     tface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>;
<a name="l00212"></a>00212     mface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l00213"></a>00213     mcol = (<span class="keywordtype">char</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>;
<a name="l00214"></a>00214     for (a = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a &gt; 0; a--, mface++, mcol += 16) {
<a name="l00215"></a>00215         <span class="keywordflow">if</span> ((tface &amp;&amp; tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a11d7f70a4874a3d2ff3a8a2bb3a8cd38">mode</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a4c59b2b097193394359d8bbedca783fd">TF_SHAREDCOL</a>) || (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) == 0) {
<a name="l00216"></a>00216             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l00217"></a>00217             scol[0]++; scol[1] += mcol[1]; scol[2] += mcol[2]; scol[3] += mcol[3];
<a name="l00218"></a>00218             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l00219"></a>00219             scol[0]++; scol[1] += mcol[5]; scol[2] += mcol[6]; scol[3] += mcol[7];
<a name="l00220"></a>00220             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l00221"></a>00221             scol[0]++; scol[1] += mcol[9]; scol[2] += mcol[10]; scol[3] += mcol[11];
<a name="l00222"></a>00222             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00223"></a>00223                 scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l00224"></a>00224                 scol[0]++; scol[1] += mcol[13]; scol[2] += mcol[14]; scol[3] += mcol[15];
<a name="l00225"></a>00225             }
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (tface) tface++;
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     
<a name="l00230"></a>00230     a = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>;
<a name="l00231"></a>00231     scol = scolmain;
<a name="l00232"></a>00232     <span class="keywordflow">while</span> (a--) {
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (scol[0] &gt; 1) {
<a name="l00234"></a>00234             scol[1] /= scol[0];
<a name="l00235"></a>00235             scol[2] /= scol[0];
<a name="l00236"></a>00236             scol[3] /= scol[0];
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         scol += 4;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     
<a name="l00241"></a>00241     tface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a24605886e11f077cf98ad713b1387483">mtface</a>;
<a name="l00242"></a>00242     mface = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l00243"></a>00243     mcol = (<span class="keywordtype">char</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>;
<a name="l00244"></a>00244     for (a = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; a &gt; 0; a--, mface++, mcol += 16) {
<a name="l00245"></a>00245         <span class="keywordflow">if</span> ((tface &amp;&amp; tface-&gt;<a class="code" href="../../da/d7f/structMTFace.html#a11d7f70a4874a3d2ff3a8a2bb3a8cd38">mode</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a4c59b2b097193394359d8bbedca783fd">TF_SHAREDCOL</a>) || (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) == 0) {
<a name="l00246"></a>00246             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>;
<a name="l00247"></a>00247             mcol[1] = scol[1]; mcol[2] = scol[2]; mcol[3] = scol[3];
<a name="l00248"></a>00248             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>;
<a name="l00249"></a>00249             mcol[5] = scol[1]; mcol[6] = scol[2]; mcol[7] = scol[3];
<a name="l00250"></a>00250             scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>;
<a name="l00251"></a>00251             mcol[9] = scol[1]; mcol[10] = scol[2]; mcol[11] = scol[3];
<a name="l00252"></a>00252             <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l00253"></a>00253                 scol = scolmain + 4 * mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>;
<a name="l00254"></a>00254                 mcol[13] = scol[1]; mcol[14] = scol[2]; mcol[15] = scol[3];
<a name="l00255"></a>00255             }
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257         <span class="keywordflow">if</span> (tface) tface++;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(scolmain);
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a887cb11d1077c709a1127223191dd8cb">00263</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a887cb11d1077c709a1127223191dd8cb">do_shared_vertexcol</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keywordtype">int</span> do_tessface)
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>;
<a name="l00266"></a>00266     <a class="code" href="../../d5/df4/structMLoopCol.html">MLoopCol</a> *lcol = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>;
<a name="l00267"></a>00267     <a class="code" href="../../de/d88/structMTexPoly.html">MTexPoly</a> *mtp = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a33e1a6e421ec6271ac147aea17092ec1">mtpoly</a>;
<a name="l00268"></a>00268     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>;
<a name="l00269"></a>00269     float (*scol)[5];
<a name="l00270"></a>00270     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, has_shared = 0;
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* if no mloopcol: do not do */</span>
<a name="l00273"></a>00273     <span class="comment">/* if mtexpoly: only the involved faces, otherwise all */</span>
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> == 0) <span class="keywordflow">return</span>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     scol = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a> * 5, <span class="stringliteral">&quot;scol&quot;</span>);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++, ml++, lcol++) {
<a name="l00280"></a>00280         <span class="keywordflow">if</span> (i &gt;= mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>) {
<a name="l00281"></a>00281             mp++;
<a name="l00282"></a>00282             <span class="keywordflow">if</span> (mtp) mtp++;
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (!(mtp &amp;&amp; (mtp-&gt;<a class="code" href="../../de/d88/structMTexPoly.html#a61e08fb00df1a664fad06b160545a2b3">mode</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a4c59b2b097193394359d8bbedca783fd">TF_SHAREDCOL</a>)) &amp;&amp; (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) != 0)
<a name="l00286"></a>00286             <span class="keywordflow">continue</span>;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         scol[ml-&gt;v][0] += lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a761df0c1a71a5aafd7e5c6183732e182">r</a>;
<a name="l00289"></a>00289         scol[ml-&gt;v][1] += lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a3891d53855f19a889b5e25f7edc332ed">g</a>;
<a name="l00290"></a>00290         scol[ml-&gt;v][2] += lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a313b1b64bedbf4b1d3426940076567c8">b</a>;
<a name="l00291"></a>00291         scol[ml-&gt;v][3] += lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#abc0ea799e13087083f5761cd29d6c896">a</a>;
<a name="l00292"></a>00292         scol[ml-&gt;v][4] += 1.0;
<a name="l00293"></a>00293         has_shared = 1;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295     
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (has_shared) {
<a name="l00297"></a>00297         <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; i++) {
<a name="l00298"></a>00298             <span class="keywordflow">if</span> (!scol[i][4]) <span class="keywordflow">continue</span>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300             scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] /= scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][4];
<a name="l00301"></a>00301             scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] /= scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][4];
<a name="l00302"></a>00302             scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][2] /= scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][4];
<a name="l00303"></a>00303             scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][3] /= scol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][4];
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305     
<a name="l00306"></a>00306         ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>;
<a name="l00307"></a>00307         lcol = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>;
<a name="l00308"></a>00308         <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>; i++, ml++, lcol++) {
<a name="l00309"></a>00309             <span class="keywordflow">if</span> (!scol[ml-&gt;v][4]) <span class="keywordflow">continue</span>;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311             lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a761df0c1a71a5aafd7e5c6183732e182">r</a> = scol[ml-&gt;v][0];
<a name="l00312"></a>00312             lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a3891d53855f19a889b5e25f7edc332ed">g</a> = scol[ml-&gt;v][1];
<a name="l00313"></a>00313             lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#a313b1b64bedbf4b1d3426940076567c8">b</a> = scol[ml-&gt;v][2];
<a name="l00314"></a>00314             lcol-&gt;<a class="code" href="../../d5/df4/structMLoopCol.html#abc0ea799e13087083f5761cd29d6c896">a</a> = scol[ml-&gt;v][3];
<a name="l00315"></a>00315         }
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(scol);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keywordflow">if</span> (has_shared &amp;&amp; do_tessface) {
<a name="l00321"></a>00321         <a class="code" href="../../da/d31/paint__vertex_8c.html#a4ed550971b8ea63213cc3fac1d262e7d">do_shared_vertex_tesscol</a>(me);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aa37e791dbb398ba16114327aab84af45">00325</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aa37e791dbb398ba16114327aab84af45">make_vertexcol</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)  <span class="comment">/* single ob */</span>
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00328"></a>00328     <span class="keywordflow">if</span> (!ob || ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a>) <span class="keywordflow">return</span>;
<a name="l00329"></a>00329     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00331"></a>00331     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a1b0a1797d0b3927b83f36b2d8d579ddb">edit_btmesh</a>) <span class="keywordflow">return</span>;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="comment">/* copies from shadedisplist to mcol */</span>
<a name="l00334"></a>00334     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>) {
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>) {
<a name="l00336"></a>00336             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#a24cf4db4f470b454282bf931f4aa58ac">CD_MCOL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>) {
<a name="l00339"></a>00339             <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a14573f9bdcf9448020a73d96d6e7a51e">CustomData_add_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a255aca90ca2e5b36547795f3d79407f9">ldata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#adfdc3d9683ce132f088e8fee80fe6f71">CD_MLOOPCOL</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#af7877d5baf4e2e56e33e8131ea4baf6b">CD_DEFAULT</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);   
<a name="l00340"></a>00340         }
<a name="l00341"></a>00341         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#adc8217e8a6385eec61318e5f7489b462">mesh_update_customdata_pointers</a>(me, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (<a class="code" href="../../da/d31/paint__vertex_8c.html#a0b9d7a2df1f0a87a768bac214655685a">vertex_paint_use_tessface_check</a>(ob)) {
<a name="l00345"></a>00345         <span class="comment">/* assume if these exist, that they are up to date &amp; valid */</span>
<a name="l00346"></a>00346         <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a> || !me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>) {
<a name="l00347"></a>00347             <span class="comment">/* should always be true */</span>
<a name="l00348"></a>00348             <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>) {
<a name="l00349"></a>00349                 memset(me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>, 255, 4 * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d33/structMCol.html">MCol</a>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>);
<a name="l00350"></a>00350             }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352             <span class="comment">/* create tessfaces because they will be used for drawing &amp; fast updates */</span>
<a name="l00353"></a>00353             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a935b5b7d16979aed31099dc7024bdbab">BKE_mesh_tessface_calc</a>(me); <span class="comment">/* does own call to update pointers */</span>
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     <span class="keywordflow">else</span> {
<a name="l00357"></a>00357         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>) {
<a name="l00358"></a>00358             <span class="comment">/* this wont be used, theres no need to keep it */</span>
<a name="l00359"></a>00359             <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a1973aa37f3dab5010ed30dfc70a0d9dc">BKE_mesh_tessface_clear</a>(me);
<a name="l00360"></a>00360         }
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="comment">//if (shade)</span>
<a name="l00364"></a>00364     <span class="comment">//  shadeMeshMCol(scene, ob, me);</span>
<a name="l00365"></a>00365     <span class="comment">//else</span>
<a name="l00366"></a>00366     
<a name="l00367"></a>00367     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l00368"></a>00368     
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 <span class="comment">/* mirror_vgroup is set to -1 when invalid */</span>
<a name="l00372"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ae32c70d05ce64ee6c26d03057bd09f90">00372</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ae32c70d05ce64ee6c26d03057bd09f90">wpaint_mirror_vgroup_ensure</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">const</span> <span class="keywordtype">int</span> vgroup_active)
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *defgroup = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>, vgroup_active);
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (defgroup) {
<a name="l00377"></a>00377         <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *curdef;
<a name="l00378"></a>00378         <span class="keywordtype">int</span> mirrdef;
<a name="l00379"></a>00379         <span class="keywordtype">char</span> name[<a class="code" href="../../d2/d93/DNA__armature__types_8h.html#a73ee51878d99f5d1256478b2d3cb6883">MAXBONENAME</a>];
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a13c8067511267c6d95644db2450a367a">flip_side_name</a>(name, defgroup-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <span class="keywordflow">if</span> (strcmp(name, defgroup-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>) != 0) {
<a name="l00384"></a>00384             <span class="keywordflow">for</span> (curdef = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, mirrdef = 0; curdef; curdef = curdef-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>, mirrdef++) {
<a name="l00385"></a>00385                 <span class="keywordflow">if</span> (!strcmp(curdef-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, name)) {
<a name="l00386"></a>00386                     <span class="keywordflow">break</span>;
<a name="l00387"></a>00387                 }
<a name="l00388"></a>00388             }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390             <span class="keywordflow">if</span> (curdef == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00391"></a>00391                 <span class="keywordtype">int</span> olddef = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a>;  <span class="comment">/* tsk, ED_vgroup_add sets the active defgroup */</span>
<a name="l00392"></a>00392                 curdef = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#af563a0e7930017802f6403c33de6a5f6">ED_vgroup_add_name</a>(ob, name);
<a name="l00393"></a>00393                 ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> = olddef;
<a name="l00394"></a>00394             }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396             <span class="comment">/* curdef should never be NULL unless this is</span>
<a name="l00397"></a>00397 <span class="comment">             * a  lamp and ED_vgroup_add_name fails */</span>
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (curdef) {
<a name="l00399"></a>00399                 <span class="keywordflow">return</span> mirrdef;
<a name="l00400"></a>00400             }
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">return</span> -1;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ab1c54077920cada220331475a8e9b14b">00407</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ab1c54077920cada220331475a8e9b14b">copy_vpaint_prev</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *lcol, <span class="keywordtype">int</span> tot)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a>) {
<a name="l00410"></a>00410         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a>);
<a name="l00411"></a>00411         vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413     vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a5815f2f40c2ce32dab3aea92c8218aaa">tot</a> = tot;
<a name="l00414"></a>00414     
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (lcol == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || tot == 0) <span class="keywordflow">return</span>;
<a name="l00416"></a>00416     
<a name="l00417"></a>00417     vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * tot, <span class="stringliteral">&quot;vpaint_prev&quot;</span>);
<a name="l00418"></a>00418     memcpy(vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a>, lcol, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * tot);
<a name="l00419"></a>00419     
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">00422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">copy_wpaint_prev</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp, <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dverts, <span class="keywordtype">int</span> dcount)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a>) {
<a name="l00425"></a>00425         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#aa7b3531228000f544fdad9d531a64ed9">free_dverts</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a>, wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a5815f2f40c2ce32dab3aea92c8218aaa">tot</a>);
<a name="l00426"></a>00426         wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (dverts &amp;&amp; dcount) {
<a name="l00430"></a>00430         
<a name="l00431"></a>00431         wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a>) * dcount, <span class="stringliteral">&quot;wpaint prev&quot;</span>);
<a name="l00432"></a>00432         wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a5815f2f40c2ce32dab3aea92c8218aaa">tot</a> = dcount;
<a name="l00433"></a>00433         <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a672c5c9b1b2357a8c937c5ed97640fb4">copy_dverts</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a>, dverts, dcount);
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 
<a name="l00438"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#acd173e8b97a18dfe00fda21a11b4637e">00438</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a204937ad375c9f608ccc79f2a9e22b28">vpaint_fill</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> paintcol)
<a name="l00439"></a>00439 {
<a name="l00440"></a>00440     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00441"></a>00441     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp;
<a name="l00442"></a>00442     <a class="code" href="../../d5/df4/structMLoopCol.html">MLoopCol</a> *lcol;
<a name="l00443"></a>00443     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, selected;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> == 0) <span class="keywordflow">return</span>;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>) <a class="code" href="../../da/d31/paint__vertex_8c.html#aa37e791dbb398ba16114327aab84af45">make_vertexcol</a>(ob);
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>) <span class="keywordflow">return</span>;  <span class="comment">/* possible we can&#39;t make mcol&#39;s */</span>
<a name="l00450"></a>00450 
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     selected = (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     mp = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>;
<a name="l00455"></a>00455     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>; i++, mp++) {
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (!(!selected || mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a208492a1db60c4d108f51334e5e80d53">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>))
<a name="l00457"></a>00457             <span class="keywordflow">continue</span>;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         lcol = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> + mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l00460"></a>00460         <span class="keywordflow">for</span> (j = 0; j &lt; mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, lcol++) {
<a name="l00461"></a>00461             *(<span class="keywordtype">int</span> *)lcol = paintcol;
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="comment">/* remove stale me-&gt;mcol, will be added later */</span>
<a name="l00466"></a>00466     <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a1973aa37f3dab5010ed30dfc70a0d9dc">BKE_mesh_tessface_clear</a>(me);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="comment">/* fills in the selected faces with the current weight and vertex group */</span>
<a name="l00473"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a8266c8f0ce55f314077ef285a906ddcf">00473</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a893872ce448a0692a004cb1f738abc77">wpaint_fill</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">float</span> paintweight)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00476"></a>00476     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp;
<a name="l00477"></a>00477     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw, *dw_prev;
<a name="l00478"></a>00478     <span class="keywordtype">int</span> vgroup_active, vgroup_mirror = -1;
<a name="l00479"></a>00479     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="comment">/* mutually exclusive, could be made into a */</span>
<a name="l00482"></a>00482     <span class="keyword">const</span> <span class="keywordtype">short</span> paint_selmode = <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#afa15c6e8024fa7543a3fc74a3b98d092">ME_EDIT_PAINT_SEL_MODE</a>(me);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || !me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) <span class="keywordflow">return</span>;
<a name="l00485"></a>00485     
<a name="l00486"></a>00486     vgroup_active = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> - 1;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">/* if mirror painting, find the other group */</span>
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a5932a31a907f7856e4b33c8617982df4">ME_EDIT_MIRROR_X</a>) {
<a name="l00490"></a>00490         vgroup_mirror = <a class="code" href="../../da/d31/paint__vertex_8c.html#ae32c70d05ce64ee6c26d03057bd09f90">wpaint_mirror_vgroup_ensure</a>(ob, vgroup_active);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492     
<a name="l00493"></a>00493     <a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">copy_wpaint_prev</a>(wp, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l00494"></a>00494     
<a name="l00495"></a>00495     <span class="keywordflow">for</span> (index = 0, mp = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>; index &lt; me-&gt;totpoly; index++, mp++) {
<a name="l00496"></a>00496         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fidx = mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> - 1;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498         <span class="keywordflow">if</span> ((paint_selmode == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a616adf2bfd4117c15663a28e464a5100">SCE_SELECT_FACE</a>) &amp;&amp; !(mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a208492a1db60c4d108f51334e5e80d53">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>)) {
<a name="l00499"></a>00499             <span class="keywordflow">continue</span>;
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="keywordflow">do</span> {
<a name="l00503"></a>00503             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vidx = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + fidx].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505             <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a>) {
<a name="l00506"></a>00506                 <span class="keywordflow">if</span> ((paint_selmode == <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a8de5fe0f8dbf523c4699a7b54c429e2f">SCE_SELECT_VERTEX</a>) &amp;&amp; !(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[vidx].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>)) {
<a name="l00507"></a>00507                     <span class="keywordflow">continue</span>;
<a name="l00508"></a>00508                 }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510                 dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx], vgroup_active);
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (dw) {
<a name="l00512"></a>00512                     dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + vidx, vgroup_active);
<a name="l00513"></a>00513                     dw_prev-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>; <span class="comment">/* set the undo weight */</span>
<a name="l00514"></a>00514                     dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = paintweight;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516                     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a5932a31a907f7856e4b33c8617982df4">ME_EDIT_MIRROR_X</a>) {  <span class="comment">/* x mirror painting */</span>
<a name="l00517"></a>00517                         <span class="keywordtype">int</span> j = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(ob, vidx);
<a name="l00518"></a>00518                         <span class="keywordflow">if</span> (j &gt;= 0) {
<a name="l00519"></a>00519                             <span class="comment">/* copy, not paint again */</span>
<a name="l00520"></a>00520                             <span class="keywordflow">if</span> (vgroup_mirror != -1) {
<a name="l00521"></a>00521                                 dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> + j, vgroup_mirror);
<a name="l00522"></a>00522                                 dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + j, vgroup_mirror);
<a name="l00523"></a>00523                             }
<a name="l00524"></a>00524                             <span class="keywordflow">else</span> {
<a name="l00525"></a>00525                                 dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> + j, vgroup_active);
<a name="l00526"></a>00526                                 dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + j, vgroup_active);
<a name="l00527"></a>00527                             }
<a name="l00528"></a>00528                             dw_prev-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>; <span class="comment">/* set the undo weight */</span>
<a name="l00529"></a>00529                             dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = paintweight;
<a name="l00530"></a>00530                         }
<a name="l00531"></a>00531                     }
<a name="l00532"></a>00532                 }
<a name="l00533"></a>00533                 me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = 1;
<a name="l00534"></a>00534             }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         } <span class="keywordflow">while</span> (fidx--);
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539     {
<a name="l00540"></a>00540         <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>;
<a name="l00541"></a>00541         <span class="keywordflow">for</span> (index = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>; index != 0; index--, dv++) {
<a name="l00542"></a>00542             dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = 0;
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544     }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">copy_wpaint_prev</a>(wp, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551 <span class="comment">/* XXX: should be re-implemented as a vertex/weight paint &#39;color correct&#39; operator */</span>
<a name="l00552"></a>00552 <span class="preprocessor">#if 0</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="keywordtype">void</span> vpaint_dogamma(<a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene)
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a>;
<a name="l00556"></a>00556     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l00557"></a>00557     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l00558"></a>00558     <span class="keywordtype">float</span> igam, fac;
<a name="l00559"></a>00559     <span class="keywordtype">int</span> a, temp;
<a name="l00560"></a>00560     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp, <a class="code" href="../../d3/d22/seqeffects_8c.html#abafd54146fdc44e2e74a72eea3677544">gamtab</a>[256];
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     ob = <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a119935c54737bd111df8fd516c390000">OBACT</a>;
<a name="l00563"></a>00563     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (!(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>)) <span class="keywordflow">return</span>;
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (me == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a> == 0 || me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a> == 0) <span class="keywordflow">return</span>;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     igam = 1.0 / vp-&gt;gamma;
<a name="l00569"></a>00569     <span class="keywordflow">for</span> (a = 0; a &lt; 256; a++) {
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         fac = ((float)a) / 255.0;
<a name="l00572"></a>00572         fac = vp-&gt;mul * <a class="code" href="../../d7/d47/NM__Scalar_8h.html#af46040b4ed6734ce0bcafe3e53d46dd3">pow</a>(fac, igam);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         temp = 255.9 * fac;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         <span class="keywordflow">if</span> (temp &lt;= 0) gamtab[a] = 0;
<a name="l00577"></a>00577         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (temp &gt;= 255) gamtab[a] = 255;
<a name="l00578"></a>00578         <span class="keywordflow">else</span> gamtab[a] = temp;
<a name="l00579"></a>00579     }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     a = 4 * me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>;
<a name="l00582"></a>00582     cp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>;
<a name="l00583"></a>00583     while (a--) {
<a name="l00584"></a>00584 
<a name="l00585"></a>00585         cp[1] = gamtab[cp[1]];
<a name="l00586"></a>00586         cp[2] = gamtab[cp[2]];
<a name="l00587"></a>00587         cp[3] = gamtab[cp[3]];
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         cp += 4;
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 <span class="preprocessor">#endif</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span>
<a name="l00594"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">00594</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00597"></a>00597     <span class="keywordtype">int</span> mfac;
<a name="l00598"></a>00598     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00601"></a>00601         <span class="keywordflow">return</span> col1;
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">if</span> (fac &gt;= 255) {
<a name="l00605"></a>00605         <span class="keywordflow">return</span> col2;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     mfac = 255 - fac;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00611"></a>00611     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00612"></a>00612     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     cp[0] = (mfac * cp1[0] + fac * cp2[0]) / 255;
<a name="l00615"></a>00615     cp[1] = (mfac * cp1[1] + fac * cp2[1]) / 255;
<a name="l00616"></a>00616     cp[2] = (mfac * cp1[2] + fac * cp2[2]) / 255;
<a name="l00617"></a>00617     cp[3] = 255;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="keywordflow">return</span> col;
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a8c22468fdd455cc228d7d41e8f648b01">00622</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a8c22468fdd455cc228d7d41e8f648b01">mcol_add</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00625"></a>00625     <span class="keywordtype">int</span> temp;
<a name="l00626"></a>00626     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00629"></a>00629         <span class="keywordflow">return</span> col1;
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00633"></a>00633     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00634"></a>00634     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     temp = cp1[0] + ((fac * cp2[0]) / 255);
<a name="l00637"></a>00637     cp[0] = (temp &gt; 254) ? 255 : temp;
<a name="l00638"></a>00638     temp = cp1[1] + ((fac * cp2[1]) / 255);
<a name="l00639"></a>00639     cp[1] = (temp &gt; 254) ? 255 : temp;
<a name="l00640"></a>00640     temp = cp1[2] + ((fac * cp2[2]) / 255);
<a name="l00641"></a>00641     cp[2] = (temp &gt; 254) ? 255 : temp;
<a name="l00642"></a>00642     cp[3] = 255;
<a name="l00643"></a>00643     
<a name="l00644"></a>00644     <span class="keywordflow">return</span> col;
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a56dd0f4bcc50c6997693e42a337d63c8">00647</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a56dd0f4bcc50c6997693e42a337d63c8">mcol_sub</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00650"></a>00650     <span class="keywordtype">int</span> temp;
<a name="l00651"></a>00651     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00654"></a>00654         <span class="keywordflow">return</span> col1;
<a name="l00655"></a>00655     }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00658"></a>00658     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00659"></a>00659     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00660"></a>00660 
<a name="l00661"></a>00661     temp = cp1[0] - ((fac * cp2[0]) / 255);
<a name="l00662"></a>00662     cp1[0] = (temp &lt; 0) ? 0 : temp;
<a name="l00663"></a>00663     temp = cp1[1] - ((fac * cp2[1]) / 255);
<a name="l00664"></a>00664     cp1[1] = (temp &lt; 0) ? 0 : temp;
<a name="l00665"></a>00665     temp = cp1[2] - ((fac * cp2[2]) / 255);
<a name="l00666"></a>00666     cp1[2] = (temp &lt; 0) ? 0 : temp;
<a name="l00667"></a>00667     cp[3] = 255;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="keywordflow">return</span> col;
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a2991b50dbdf533c08fadc677b536b5a2">00672</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a2991b50dbdf533c08fadc677b536b5a2">mcol_mul</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00675"></a>00675     <span class="keywordtype">int</span> mfac;
<a name="l00676"></a>00676     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00679"></a>00679         <span class="keywordflow">return</span> col1;
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     mfac = 255 - fac;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00685"></a>00685     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00686"></a>00686     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     <span class="comment">/* first mul, then blend the fac */</span>
<a name="l00689"></a>00689     cp[0] = (mfac * cp1[0] + fac * ((cp2[0] * cp1[0]) / 255)) / 255;
<a name="l00690"></a>00690     cp[1] = (mfac * cp1[1] + fac * ((cp2[1] * cp1[1]) / 255)) / 255;
<a name="l00691"></a>00691     cp[2] = (mfac * cp1[2] + fac * ((cp2[2] * cp1[2]) / 255)) / 255;
<a name="l00692"></a>00692     cp[3] = 255;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordflow">return</span> col;
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00697"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#af67991c8ee8a270f7013b92f63b827e7">00697</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#af67991c8ee8a270f7013b92f63b827e7">mcol_lighten</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00700"></a>00700     <span class="keywordtype">int</span> mfac;
<a name="l00701"></a>00701     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00704"></a>00704         <span class="keywordflow">return</span> col1;
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt;= 255) {
<a name="l00707"></a>00707         <span class="keywordflow">return</span> col2;
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     mfac = 255 - fac;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00713"></a>00713     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00714"></a>00714     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="comment">/* See if are lighter, if so mix, else don&#39;t do anything.</span>
<a name="l00717"></a>00717 <span class="comment">     * if the paint col is darker then the original, then ignore */</span>
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a98c50112a0ca92836f82f8fcafa11117">rgb_to_grayscale_byte</a>(cp1) &gt; <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a98c50112a0ca92836f82f8fcafa11117">rgb_to_grayscale_byte</a>(cp2)) {
<a name="l00719"></a>00719         <span class="keywordflow">return</span> col1;
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     cp[0] = (mfac * cp1[0] + fac * cp2[0]) / 255;
<a name="l00723"></a>00723     cp[1] = (mfac * cp1[1] + fac * cp2[1]) / 255;
<a name="l00724"></a>00724     cp[2] = (mfac * cp1[2] + fac * cp2[2]) / 255;
<a name="l00725"></a>00725     cp[3] = 255;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordflow">return</span> col;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aaa182c953280ae3118b4496d59772281">00730</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aaa182c953280ae3118b4496d59772281">mcol_darken</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col1, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col2, <span class="keywordtype">int</span> fac)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cp1, *cp2, *cp;
<a name="l00733"></a>00733     <span class="keywordtype">int</span> mfac;
<a name="l00734"></a>00734     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col = 0;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">if</span> (fac == 0) {
<a name="l00737"></a>00737         <span class="keywordflow">return</span> col1;
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fac &gt;= 255) {
<a name="l00740"></a>00740         <span class="keywordflow">return</span> col2;
<a name="l00741"></a>00741     }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     mfac = 255 - fac;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     cp1 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col1;
<a name="l00746"></a>00746     cp2 = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col2;
<a name="l00747"></a>00747     cp  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)&amp;col;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="comment">/* See if were darker, if so mix, else don&#39;t do anything.</span>
<a name="l00750"></a>00750 <span class="comment">     * if the paint col is brighter then the original, then ignore */</span>
<a name="l00751"></a>00751     <span class="keywordflow">if</span> (<a class="code" href="../../d8/de1/BLI__math__color_8h.html#a98c50112a0ca92836f82f8fcafa11117">rgb_to_grayscale_byte</a>(cp1) &lt; <a class="code" href="../../d8/de1/BLI__math__color_8h.html#a98c50112a0ca92836f82f8fcafa11117">rgb_to_grayscale_byte</a>(cp2)) {
<a name="l00752"></a>00752         <span class="keywordflow">return</span> col1;
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     cp[0] = (mfac * cp1[0] + fac * cp2[0]) / 255;
<a name="l00756"></a>00756     cp[1] = (mfac * cp1[1] + fac * cp2[1]) / 255;
<a name="l00757"></a>00757     cp[2] = (mfac * cp1[2] + fac * cp2[2]) / 255;
<a name="l00758"></a>00758     cp[3] = 255;
<a name="l00759"></a>00759     <span class="keywordflow">return</span> col;
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a>00762 <span class="comment">/* wpaint has &#39;wpaint_blend_tool&#39; */</span>
<a name="l00763"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#adb74e75295e09a9fdfe6bbf69a8553fe">00763</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#adb74e75295e09a9fdfe6bbf69a8553fe">vpaint_blend_tool</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> tool, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col,
<a name="l00764"></a>00764                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> paintcol, <span class="keyword">const</span> <span class="keywordtype">int</span> alpha_i)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     <span class="keywordflow">switch</span> (tool) {
<a name="l00767"></a>00767         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba497fd1526e4517b9ea90d7f77ba4d1f9">PAINT_BLEND_MIX</a>:
<a name="l00768"></a>00768         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>:     <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(col, paintcol, alpha_i);
<a name="l00769"></a>00769         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba9571507852be550f08228f5eaa2834b4">PAINT_BLEND_ADD</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a8c22468fdd455cc228d7d41e8f648b01">mcol_add</a>(col, paintcol, alpha_i);
<a name="l00770"></a>00770         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66bab1911db43aa6a23ba47e4da54d2cce79">PAINT_BLEND_SUB</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a56dd0f4bcc50c6997693e42a337d63c8">mcol_sub</a>(col, paintcol, alpha_i);
<a name="l00771"></a>00771         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba321f89f959507c54a7123648346080c6">PAINT_BLEND_MUL</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a2991b50dbdf533c08fadc677b536b5a2">mcol_mul</a>(col, paintcol, alpha_i);
<a name="l00772"></a>00772         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba075a01b6e40058abcb09faa48e1e7356">PAINT_BLEND_LIGHTEN</a>:  <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#af67991c8ee8a270f7013b92f63b827e7">mcol_lighten</a>(col, paintcol, alpha_i);
<a name="l00773"></a>00773         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66babe596d16d668ecbe7aa7c3d42b30e1ae">PAINT_BLEND_DARKEN</a>:   <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aaa182c953280ae3118b4496d59772281">mcol_darken</a>(col, paintcol, alpha_i);
<a name="l00774"></a>00774         <span class="keywordflow">default</span>:
<a name="l00775"></a>00775             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(0);
<a name="l00776"></a>00776             <span class="keywordflow">return</span> 0;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="comment">/* wpaint has &#39;wpaint_blend&#39; */</span>
<a name="l00781"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a21cfbb3aa1996c41a4cea82cb3df8da1">00781</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a21cfbb3aa1996c41a4cea82cb3df8da1">vpaint_blend</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> col, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> colorig, <span class="keyword">const</span>
<a name="l00782"></a>00782                                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> paintcol, <span class="keyword">const</span> <span class="keywordtype">int</span> alpha_i,
<a name="l00783"></a>00783                                  <span class="comment">/* pre scaled from [0-1] --&gt; [0-255] */</span>
<a name="l00784"></a>00784                                  <span class="keyword">const</span> <span class="keywordtype">int</span> brush_alpha_value_i)
<a name="l00785"></a>00785 {
<a name="l00786"></a>00786     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l00787"></a>00787     <span class="keyword">const</span> <span class="keywordtype">int</span> tool = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a>;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     col = <a class="code" href="../../da/d31/paint__vertex_8c.html#adb74e75295e09a9fdfe6bbf69a8553fe">vpaint_blend_tool</a>(tool, col, paintcol, alpha_i);
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="comment">/* if no spray, clip color adding with colorig &amp; orig alpha */</span>
<a name="l00792"></a>00792     <span class="keywordflow">if</span> ((vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae1b08ef491270c86c0068ac293102fad">VP_SPRAY</a>) == 0) {
<a name="l00793"></a>00793         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> testcol, a;
<a name="l00794"></a>00794         <span class="keywordtype">char</span> *cp, *ct, *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00795"></a>00795         
<a name="l00796"></a>00796         testcol = <a class="code" href="../../da/d31/paint__vertex_8c.html#adb74e75295e09a9fdfe6bbf69a8553fe">vpaint_blend_tool</a>(tool, colorig, paintcol, brush_alpha_value_i);
<a name="l00797"></a>00797         
<a name="l00798"></a>00798         cp = (<span class="keywordtype">char</span> *)&amp;col;
<a name="l00799"></a>00799         ct = (<span class="keywordtype">char</span> *)&amp;testcol;
<a name="l00800"></a>00800         co = (<span class="keywordtype">char</span> *)&amp;colorig;
<a name="l00801"></a>00801         
<a name="l00802"></a>00802         <span class="keywordflow">for</span> (a = 0; a &lt; 4; a++) {
<a name="l00803"></a>00803             <span class="keywordflow">if</span> (ct[a] &lt; co[a]) {
<a name="l00804"></a>00804                 <span class="keywordflow">if</span> (cp[a] &lt; ct[a]) cp[a] = ct[a];
<a name="l00805"></a>00805                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cp[a] &gt; co[a]) cp[a] = co[a];
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807             <span class="keywordflow">else</span> {
<a name="l00808"></a>00808                 <span class="keywordflow">if</span> (cp[a] &lt; co[a]) cp[a] = co[a];
<a name="l00809"></a>00809                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cp[a] &gt; ct[a]) cp[a] = ct[a];
<a name="l00810"></a>00810             }
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812     }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <span class="keywordflow">return</span> col;
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 
<a name="l00818"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a17f80a1f9e46cc648cd4e20cd1115ce1">00818</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a17f80a1f9e46cc648cd4e20cd1115ce1">sample_backbuf_area</a>(<a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keywordtype">int</span> *indexar, <span class="keywordtype">int</span> totface, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">float</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820     <span class="keyword">struct </span><a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00821"></a>00821     <span class="keywordtype">int</span> a, tot = 0, <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l00822"></a>00822     
<a name="l00823"></a>00823     <span class="comment">/* brecht: disabled this because it obviously fails for</span>
<a name="l00824"></a>00824 <span class="comment">     * brushes with size &gt; 64, why is this here? */</span>
<a name="l00825"></a>00825     <span class="comment">/*if (size &gt; 64.0) size = 64.0;*/</span>
<a name="l00826"></a>00826     
<a name="l00827"></a>00827     ibuf = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a67a338f046919216d96ba482e7cd1e06">view3d_read_backbuf</a>(vc, x - size, y - size, x + size, y + size);
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (ibuf) {
<a name="l00829"></a>00829         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rt = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ade8b2f05559e57840af8d3657817f8c8">rect</a>;
<a name="l00830"></a>00830 
<a name="l00831"></a>00831         memset(indexar, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * (totface + 1));
<a name="l00832"></a>00832         
<a name="l00833"></a>00833         size = ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00834"></a>00834         <span class="keywordflow">while</span> (size--) {
<a name="l00835"></a>00835                 
<a name="l00836"></a>00836             <span class="keywordflow">if</span> (*rt) {
<a name="l00837"></a>00837                 <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a> = <a class="code" href="../../df/d4d/wm__subwindow_8c.html#a9ee3b53c087965dadbc7b770ffc56100">WM_framebuffer_to_index</a>(*rt);
<a name="l00838"></a>00838                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a> &gt; 0 &amp;&amp; <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a> &lt;= totface)
<a name="l00839"></a>00839                     indexar[<a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>] = 1;
<a name="l00840"></a>00840             }
<a name="l00841"></a>00841         
<a name="l00842"></a>00842             rt++;
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844         
<a name="l00845"></a>00845         <span class="keywordflow">for</span> (a = 1; a &lt;= totface; a++) {
<a name="l00846"></a>00846             <span class="keywordflow">if</span> (indexar[a]) indexar[tot++] = a;
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a40eceec0075863e55997a3fb210a18ae">IMB_freeImBuf</a>(ibuf);
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851     
<a name="l00852"></a>00852     <span class="keywordflow">return</span> tot;
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 <span class="comment">/* whats _dl mean? */</span>
<a name="l00856"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3fc95e4c1feb79de975bd66e423ab054">00856</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3fc95e4c1feb79de975bd66e423ab054">calc_vp_strength_dl</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc, <span class="keyword">const</span> <span class="keywordtype">float</span> *vert_nor,
<a name="l00857"></a>00857                                  <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2], <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure)
<a name="l00858"></a>00858 {
<a name="l00859"></a>00859     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l00860"></a>00860     <span class="keywordtype">float</span> dist_squared;
<a name="l00861"></a>00861     <span class="keywordtype">float</span> vertco[2], delta[2];
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a4551d98f490ec042932367ef422a8ba1">project_float_noclip</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>, vert_nor, vertco);
<a name="l00864"></a>00864     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ab33aab525bc92b68e86d3fafda240f38">sub_v2_v2v2</a>(delta, mval, vertco);
<a name="l00865"></a>00865     dist_squared = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a03e71ae06120f598c068aad6970015c2">dot_v2v2</a>(delta, delta); <span class="comment">/* len squared */</span>
<a name="l00866"></a>00866     <span class="keywordflow">if</span> (dist_squared &gt; brush_size_pressure * brush_size_pressure) {
<a name="l00867"></a>00867         <span class="keywordflow">return</span> 0.0f;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869     <span class="keywordflow">else</span> {
<a name="l00870"></a>00870         <span class="keyword">const</span> <span class="keywordtype">float</span> dist = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a33f9e82220f9ff9453a6557bd04bd8c5">sqrtf</a>(dist_squared);
<a name="l00871"></a>00871         <span class="keywordflow">return</span> <a class="code" href="../../da/dc9/BKE__brush_8h.html#a036d9163e36e7a1ac6ade0518704a985">brush_curve_strength_clamp</a>(brush, dist, brush_size_pressure);
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873 }
<a name="l00874"></a>00874 
<a name="l00875"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3b97fabbe199b8b0142034158eb5d9bf">00875</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b97fabbe199b8b0142034158eb5d9bf">calc_vp_alpha_dl</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc,
<a name="l00876"></a>00876                               <span class="keywordtype">float</span> vpimat[][3], <span class="keyword">const</span> <span class="keywordtype">float</span> *vert_nor,
<a name="l00877"></a>00877                               <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l00878"></a>00878                               <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure, <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_pressure)
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880     <span class="keywordtype">float</span> strength = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3fc95e4c1feb79de975bd66e423ab054">calc_vp_strength_dl</a>(vp, vc, vert_nor, mval, brush_size_pressure);
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (strength &gt; 0.0f) {
<a name="l00883"></a>00883         <span class="keywordtype">float</span> alpha = brush_alpha_pressure * strength;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885         <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a42d40e1d693f8c17318e0cc14156512f">VP_NORMALS</a>) {
<a name="l00886"></a>00886             <span class="keywordtype">float</span> dvec[3];
<a name="l00887"></a>00887             <span class="keyword">const</span> <span class="keywordtype">float</span> *no = vert_nor + 3;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889             <span class="comment">/* transpose ! */</span>
<a name="l00890"></a>00890             dvec[2] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vpimat[2], no);
<a name="l00891"></a>00891             <span class="keywordflow">if</span> (dvec[2] &gt; 0.0f) {
<a name="l00892"></a>00892                 dvec[0] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vpimat[0], no);
<a name="l00893"></a>00893                 dvec[1] = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(vpimat[1], no);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895                 alpha *= dvec[2] / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a5dedd24d16c008a3d9e5fc0c4db3fa81">len_v3</a>(dvec);
<a name="l00896"></a>00896             }
<a name="l00897"></a>00897             <span class="keywordflow">else</span> {
<a name="l00898"></a>00898                 <span class="keywordflow">return</span> 0.0f;
<a name="l00899"></a>00899             }
<a name="l00900"></a>00900         }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <span class="keywordflow">return</span> alpha;
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="keywordflow">return</span> 0.0f;
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 
<a name="l00909"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a78ca3a9cf331d5eb8b360466bcd1ac46">00909</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a78ca3a9cf331d5eb8b360466bcd1ac46">wval_blend</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911     <span class="keywordflow">return</span> (paintval * alpha) + (weight * (1.0f - alpha));
<a name="l00912"></a>00912 }
<a name="l00913"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ab29816726ce5358b8f4faaddf0843408">00913</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ab29816726ce5358b8f4faaddf0843408">wval_add</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00914"></a>00914 {
<a name="l00915"></a>00915     <span class="keywordflow">return</span> weight + (paintval * alpha);
<a name="l00916"></a>00916 }
<a name="l00917"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ad97a0d364c12a368bff04b4a6ac11cb4">00917</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ad97a0d364c12a368bff04b4a6ac11cb4">wval_sub</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919     <span class="keywordflow">return</span> weight - (paintval * alpha);
<a name="l00920"></a>00920 }
<a name="l00921"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aa623639773a162ebb253c2a23c778e6c">00921</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aa623639773a162ebb253c2a23c778e6c">wval_mul</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00922"></a>00922 {   <span class="comment">/* first mul, then blend the fac */</span>
<a name="l00923"></a>00923     <span class="keywordflow">return</span> ((1.0f - alpha) + (alpha * paintval)) * weight;
<a name="l00924"></a>00924 }
<a name="l00925"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a7c4bf577d71e5ba4ec9d7768aaf9ca82">00925</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a7c4bf577d71e5ba4ec9d7768aaf9ca82">wval_lighten</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00926"></a>00926 {
<a name="l00927"></a>00927     <span class="keywordflow">return</span> (weight &lt; paintval) ? <a class="code" href="../../da/d31/paint__vertex_8c.html#a78ca3a9cf331d5eb8b360466bcd1ac46">wval_blend</a>(weight, paintval, alpha) : weight;
<a name="l00928"></a>00928 }
<a name="l00929"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aab1405606b763eae87d7963c7ab6b9a5">00929</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aab1405606b763eae87d7963c7ab6b9a5">wval_darken</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> weight, <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00930"></a>00930 {
<a name="l00931"></a>00931     <span class="keywordflow">return</span> (weight &gt; paintval) ? <a class="code" href="../../da/d31/paint__vertex_8c.html#a78ca3a9cf331d5eb8b360466bcd1ac46">wval_blend</a>(weight, paintval, alpha) : weight;
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="comment">/* vpaint has &#39;vpaint_blend_tool&#39; */</span>
<a name="l00936"></a>00936 <span class="comment">/* result is not clamped from [0-1] */</span>
<a name="l00937"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a29c1a3e16ed86d83c8d2889c2d1b1d15">00937</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a29c1a3e16ed86d83c8d2889c2d1b1d15">wpaint_blend_tool</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> tool,
<a name="l00938"></a>00938                                <span class="comment">/* dw-&gt;weight */</span>
<a name="l00939"></a>00939                                <span class="keyword">const</span> <span class="keywordtype">float</span> weight,
<a name="l00940"></a>00940                                <span class="keyword">const</span> <span class="keywordtype">float</span> paintval, <span class="keyword">const</span> <span class="keywordtype">float</span> alpha)
<a name="l00941"></a>00941 {
<a name="l00942"></a>00942     <span class="keywordflow">switch</span> (tool) {
<a name="l00943"></a>00943         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba497fd1526e4517b9ea90d7f77ba4d1f9">PAINT_BLEND_MIX</a>:
<a name="l00944"></a>00944         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>:     <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a78ca3a9cf331d5eb8b360466bcd1ac46">wval_blend</a>(weight, paintval, alpha);
<a name="l00945"></a>00945         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba9571507852be550f08228f5eaa2834b4">PAINT_BLEND_ADD</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ab29816726ce5358b8f4faaddf0843408">wval_add</a>(weight, paintval, alpha);
<a name="l00946"></a>00946         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66bab1911db43aa6a23ba47e4da54d2cce79">PAINT_BLEND_SUB</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ad97a0d364c12a368bff04b4a6ac11cb4">wval_sub</a>(weight, paintval, alpha);
<a name="l00947"></a>00947         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba321f89f959507c54a7123648346080c6">PAINT_BLEND_MUL</a>:      <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aa623639773a162ebb253c2a23c778e6c">wval_mul</a>(weight, paintval, alpha);
<a name="l00948"></a>00948         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba075a01b6e40058abcb09faa48e1e7356">PAINT_BLEND_LIGHTEN</a>:  <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a7c4bf577d71e5ba4ec9d7768aaf9ca82">wval_lighten</a>(weight, paintval, alpha);
<a name="l00949"></a>00949         <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66babe596d16d668ecbe7aa7c3d42b30e1ae">PAINT_BLEND_DARKEN</a>:   <span class="keywordflow">return</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aab1405606b763eae87d7963c7ab6b9a5">wval_darken</a>(weight, paintval, alpha);
<a name="l00950"></a>00950         <span class="keywordflow">default</span>:
<a name="l00951"></a>00951             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(0);
<a name="l00952"></a>00952             <span class="keywordflow">return</span> 0.0f;
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954 }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment">/* vpaint has &#39;vpaint_blend&#39; */</span>
<a name="l00957"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a43c8002c48bd024a1a00814564650026">00957</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a43c8002c48bd024a1a00814564650026">wpaint_blend</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp, <span class="keywordtype">float</span> weight, <span class="keywordtype">float</span> weight_prev,
<a name="l00958"></a>00958                           <span class="keyword">const</span> <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> paintval,
<a name="l00959"></a>00959                           <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_value,
<a name="l00960"></a>00960                           <span class="keyword">const</span> <span class="keywordtype">short</span> do_flip, <span class="keyword">const</span> <span class="keywordtype">short</span> do_multipaint_totsel)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l00963"></a>00963     <span class="keywordtype">int</span> tool = brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a>;
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <span class="keywordflow">if</span> (do_flip) {
<a name="l00966"></a>00966         <span class="keywordflow">switch</span> (tool) {
<a name="l00967"></a>00967             <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba497fd1526e4517b9ea90d7f77ba4d1f9">PAINT_BLEND_MIX</a>:
<a name="l00968"></a>00968                 paintval = 1.f - paintval; <span class="keywordflow">break</span>;
<a name="l00969"></a>00969             <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba9571507852be550f08228f5eaa2834b4">PAINT_BLEND_ADD</a>:
<a name="l00970"></a>00970                 tool = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66bab1911db43aa6a23ba47e4da54d2cce79">PAINT_BLEND_SUB</a>; <span class="keywordflow">break</span>;
<a name="l00971"></a>00971             <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66bab1911db43aa6a23ba47e4da54d2cce79">PAINT_BLEND_SUB</a>:
<a name="l00972"></a>00972                 tool = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba9571507852be550f08228f5eaa2834b4">PAINT_BLEND_ADD</a>; <span class="keywordflow">break</span>;
<a name="l00973"></a>00973             <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba075a01b6e40058abcb09faa48e1e7356">PAINT_BLEND_LIGHTEN</a>:
<a name="l00974"></a>00974                 tool = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66babe596d16d668ecbe7aa7c3d42b30e1ae">PAINT_BLEND_DARKEN</a>; <span class="keywordflow">break</span>;
<a name="l00975"></a>00975             <span class="keywordflow">case</span> <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66babe596d16d668ecbe7aa7c3d42b30e1ae">PAINT_BLEND_DARKEN</a>:
<a name="l00976"></a>00976                 tool = <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba075a01b6e40058abcb09faa48e1e7356">PAINT_BLEND_LIGHTEN</a>; <span class="keywordflow">break</span>;
<a name="l00977"></a>00977         }
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979     
<a name="l00980"></a>00980     weight = <a class="code" href="../../da/d31/paint__vertex_8c.html#a29c1a3e16ed86d83c8d2889c2d1b1d15">wpaint_blend_tool</a>(tool, weight, paintval, alpha);
<a name="l00981"></a>00981 
<a name="l00982"></a>00982     <span class="comment">/* delay clamping until the end so multi-paint can function when the active group is at the limits */</span>
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (do_multipaint_totsel == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00984"></a>00984         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(weight, 0.0f, 1.0f);
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986     
<a name="l00987"></a>00987     <span class="comment">/* if no spray, clip result with orig weight &amp; orig alpha */</span>
<a name="l00988"></a>00988     <span class="keywordflow">if</span> ((wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ae1b08ef491270c86c0068ac293102fad">VP_SPRAY</a>) == 0) {
<a name="l00989"></a>00989         <span class="keywordflow">if</span> (do_multipaint_totsel == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l00990"></a>00990             <span class="keywordtype">float</span> testw = <a class="code" href="../../da/d31/paint__vertex_8c.html#a29c1a3e16ed86d83c8d2889c2d1b1d15">wpaint_blend_tool</a>(tool, weight_prev, paintval, brush_alpha_value);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992             <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(testw, 0.0f, 1.0f);
<a name="l00993"></a>00993             <span class="keywordflow">if</span> (testw &lt; weight_prev) {
<a name="l00994"></a>00994                 <span class="keywordflow">if</span> (weight &lt; testw) weight = testw;
<a name="l00995"></a>00995                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight &gt; weight_prev) weight = weight_prev;
<a name="l00996"></a>00996             }
<a name="l00997"></a>00997             <span class="keywordflow">else</span> {
<a name="l00998"></a>00998                 <span class="keywordflow">if</span> (weight &gt; testw) weight = testw;
<a name="l00999"></a>00999                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (weight &lt; weight_prev) weight = weight_prev;
<a name="l01000"></a>01000             }
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="keywordflow">return</span> weight;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 <span class="comment">/* ----------------------------------------------------- */</span>
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 
<a name="l01010"></a>01010 <span class="comment">/* sets wp-&gt;weight to the closest weight value to vertex */</span>
<a name="l01011"></a>01011 <span class="comment">/* note: we cant sample frontbuf, weight colors are interpolated too unpredictable */</span>
<a name="l01012"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ac196a27353a6fa639bea6ecec6c36ff9">01012</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ac196a27353a6fa639bea6ecec6c36ff9">weight_sample_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> vc;
<a name="l01015"></a>01015     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l01016"></a>01016     <span class="keywordtype">short</span> change = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vc);
<a name="l01019"></a>01019     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> &amp;&amp; vc.<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a> &amp;&amp; vc.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>) {
<a name="l01022"></a>01022         <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026         index = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aba40efd013e32afa64b4059112bcaede">view3d_sample_backbuf</a>(&amp;vc, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0], event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[1]);
<a name="l01027"></a>01027 
<a name="l01028"></a>01028         <span class="keywordflow">if</span> (index &amp;&amp; index &lt;= me-&gt;totpoly) {
<a name="l01029"></a>01029             <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *dm = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a97d53912627cd01e30cab0c5a125485e">mesh_get_derived_final</a>(vc.<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>, vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ac302305683fc6e7bba64ef68c74a1404">CD_MASK_BAREMESH</a>);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031             <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01032"></a>01032                 <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;The modifier used does not support deformed locations&quot;</span>);
<a name="l01033"></a>01033             }
<a name="l01034"></a>01034             <span class="keywordflow">else</span> {
<a name="l01035"></a>01035                 <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (index - 1);
<a name="l01036"></a>01036                 <span class="keyword">const</span> <span class="keywordtype">int</span> vgroup_active = vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> - 1;
<a name="l01037"></a>01037                 <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = vc.<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l01038"></a>01038                 <span class="keywordtype">float</span> mval_f[2];
<a name="l01039"></a>01039                 <span class="keywordtype">int</span> v_idx_best = -1;
<a name="l01040"></a>01040                 <span class="keywordtype">int</span> fidx;
<a name="l01041"></a>01041                 <span class="keywordtype">float</span> len_best = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l01042"></a>01042 
<a name="l01043"></a>01043                 mval_f[0] = (float)event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>[0];
<a name="l01044"></a>01044                 mval_f[1] = (<span class="keywordtype">float</span>)<span class="keyword">event</span>-&gt;mval[1];
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                 fidx = mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> - 1;
<a name="l01047"></a>01047                 <span class="keywordflow">do</span> {
<a name="l01048"></a>01048                     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], sco[3], <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01049"></a>01049                     <span class="keyword">const</span> <span class="keywordtype">int</span> v_idx = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + fidx].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l01050"></a>01050                     dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a4eb80dfbf127ea39db823865610b127e">getVertCo</a>(dm, v_idx, co);
<a name="l01051"></a>01051                     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a4551d98f490ec042932367ef422a8ba1">project_float_noclip</a>(vc.<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>, co, sco);
<a name="l01052"></a>01052                     len = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aad974afda68ca9dc12b3ebc0ce297a0c">len_squared_v2v2</a>(mval_f, sco);
<a name="l01053"></a>01053                     <span class="keywordflow">if</span> (len &lt; len_best) {
<a name="l01054"></a>01054                         len_best = <a class="code" href="../../d9/d90/util__math_8h.html#aa4232e576aca913870e7753393b82894">len</a>;
<a name="l01055"></a>01055                         v_idx_best = v_idx;
<a name="l01056"></a>01056                     }
<a name="l01057"></a>01057                 } <span class="keywordflow">while</span> (fidx--);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059                 <span class="keywordflow">if</span> (v_idx_best != -1) { <span class="comment">/* should always be valid */</span>
<a name="l01060"></a>01060                     ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a6af6c729861d662aef1aac6913832c74">vgroup_weight</a> = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#af197ce14dcf863f808dfc4023b76004f">defvert_find_weight</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[v_idx_best], vgroup_active);
<a name="l01061"></a>01061                     change = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01062"></a>01062                 }
<a name="l01063"></a>01063             }
<a name="l01064"></a>01064             dm-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a36c159344a023f5fbe64f12006c8647f">release</a>(dm);
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (change) {
<a name="l01069"></a>01069         <span class="comment">/* not really correct since the brush didnt change, but redraws the toolbar */</span>
<a name="l01070"></a>01070         <a class="code" href="../../df/db0/wm__event__system_8c.html#a2d4bab7477e1a026061d578f19247457">WM_main_add_notifier</a>(<a class="code" href="../../d4/ddc/WM__types_8h.html#a1f92a8bb850509b5eaec48a130689729">NC_BRUSH</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a73680e84dba31202967ab486f0b306ea">NA_EDITED</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>); <span class="comment">/* ts-&gt;wpaint-&gt;paint.brush */</span>
<a name="l01071"></a>01071 
<a name="l01072"></a>01072         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01073"></a>01073     }
<a name="l01074"></a>01074     <span class="keywordflow">else</span> {
<a name="l01075"></a>01075         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01079"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a7c8ba24e14243b7958bac89c059d9a5a">01079</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab5e675893b3b709dfdde686abae5fc09">PAINT_OT_weight_sample</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01080"></a>01080 {
<a name="l01081"></a>01081     <span class="comment">/* identifiers */</span>
<a name="l01082"></a>01082     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Weight Paint Sample Weight&quot;</span>;
<a name="l01083"></a>01083     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_sample&quot;</span>;
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     <span class="comment">/* api callbacks */</span>
<a name="l01086"></a>01086     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ac196a27353a6fa639bea6ecec6c36ff9">weight_sample_invoke</a>;
<a name="l01087"></a>01087     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a509408c9bafa9b798c8ee17db63f2f3a">weight_paint_mode_poll</a>;
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="comment">/* flags */</span>
<a name="l01090"></a>01090     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01091"></a>01091 }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093 <span class="comment">/* samples cursor location, and gives menu with vertex groups to activate */</span>
<a name="l01094"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a0826e2b503ad74e59ad13f2ee416d105">01094</a> <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> *<a class="code" href="../../da/d31/paint__vertex_8c.html#a0826e2b503ad74e59ad13f2ee416d105">weight_paint_sample_enum_itemf</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ptr), <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(prop), <span class="keywordtype">int</span> *free)
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (C) {
<a name="l01097"></a>01097         <a class="code" href="../../dc/da4/structwmWindow.html">wmWindow</a> *win = <a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C);
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (win &amp;&amp; win-&gt;<a class="code" href="../../dc/da4/structwmWindow.html#a1c950f3f8bc3e99973abac8e510d0835">eventstate</a>) {
<a name="l01099"></a>01099             <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> vc;
<a name="l01100"></a>01100             <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102             <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vc);
<a name="l01103"></a>01103             me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105             <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> &amp;&amp; vc.<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a> &amp;&amp; vc.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>) {
<a name="l01106"></a>01106                 <span class="keywordtype">int</span> <a class="code" href="../../d3/dd9/structImBuf.html#ab8d52a453c4886f4fe00230c6387f964">index</a>;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108                 <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 index = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aba40efd013e32afa64b4059112bcaede">view3d_sample_backbuf</a>(&amp;vc, win-&gt;<a class="code" href="../../dc/da4/structwmWindow.html#a1c950f3f8bc3e99973abac8e510d0835">eventstate</a>-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aa6d806b03b666c8e88f6178303145cb1">x</a> - vc.<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>, win-&gt;<a class="code" href="../../dc/da4/structwmWindow.html#a1c950f3f8bc3e99973abac8e510d0835">eventstate</a>-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a1f9bfd9ad3dda5768a94bad7a3c3fc1e">y</a> - vc.<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112                 <span class="keywordflow">if</span> (index &amp;&amp; index &lt;= me-&gt;totpoly) {
<a name="l01113"></a>01113                     <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>);
<a name="l01114"></a>01114                     <span class="keywordflow">if</span> (defbase_tot) {
<a name="l01115"></a>01115                         <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mp = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (index - 1);
<a name="l01116"></a>01116                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fidx = mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a> - 1;
<a name="l01117"></a>01117                         <span class="keywordtype">int</span> *groups = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(defbase_tot * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>), <span class="stringliteral">&quot;groups&quot;</span>);
<a name="l01118"></a>01118                         <span class="keywordtype">int</span> found = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                         <span class="keywordflow">do</span> {
<a name="l01121"></a>01121                             <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a> + me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a>[mp-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a> + fidx].<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l01122"></a>01122                             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>;
<a name="l01123"></a>01123                             <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw;
<a name="l01124"></a>01124                             <span class="keywordflow">for</span> (dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i &gt; 0; dw++, i--) {
<a name="l01125"></a>01125                                 <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01126"></a>01126                                     groups[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01127"></a>01127                                     found = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01128"></a>01128                                 }
<a name="l01129"></a>01129                             }
<a name="l01130"></a>01130                         } <span class="keywordflow">while</span> (fidx--);
<a name="l01131"></a>01131 
<a name="l01132"></a>01132                         <span class="keywordflow">if</span> (found == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l01133"></a>01133                             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(groups);
<a name="l01134"></a>01134                         }
<a name="l01135"></a>01135                         <span class="keywordflow">else</span> {
<a name="l01136"></a>01136                             <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> *item = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, item_tmp = {0};
<a name="l01137"></a>01137                             <span class="keywordtype">int</span> totitem = 0;
<a name="l01138"></a>01138                             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0;
<a name="l01139"></a>01139                             <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg;
<a name="l01140"></a>01140                             <span class="keywordflow">for</span> (dg = vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dg &amp;&amp; i &lt; defbase_tot; i++, dg = dg-&gt;<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>) {
<a name="l01141"></a>01141                                 <span class="keywordflow">if</span> (groups[i]) {
<a name="l01142"></a>01142                                     item_tmp.identifier = item_tmp.<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a> = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>;
<a name="l01143"></a>01143                                     item_tmp.value = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01144"></a>01144                                     <a class="code" href="../../dc/d7e/rna__define_8c.html#aac347b3d7d22bc34be1afcea3a155550">RNA_enum_item_add</a>(&amp;item, &amp;totitem, &amp;item_tmp);
<a name="l01145"></a>01145                                 }
<a name="l01146"></a>01146                             }
<a name="l01147"></a>01147 
<a name="l01148"></a>01148                             <a class="code" href="../../dc/d7e/rna__define_8c.html#a9c356736035ce93183d416c437a40d1c">RNA_enum_item_end</a>(&amp;item, &amp;totitem);
<a name="l01149"></a>01149                             *free = 1;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151                             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(groups);
<a name="l01152"></a>01152                             <span class="keywordflow">return</span> item;
<a name="l01153"></a>01153                         }
<a name="l01154"></a>01154                     }
<a name="l01155"></a>01155                 }
<a name="l01156"></a>01156             }
<a name="l01157"></a>01157         }
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="keywordflow">return</span> <a class="code" href="../../d3/d10/rna__access_8c.html#abf24cbff0dda06cfad896088d53288fe">DummyRNA_NULL_items</a>;
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#af3ac40382c0d4e1260bb65b96ac458ee">01163</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#af3ac40382c0d4e1260bb65b96ac458ee">weight_sample_group_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l01164"></a>01164 {
<a name="l01165"></a>01165     <span class="keywordtype">int</span> type = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;group&quot;</span>);
<a name="l01166"></a>01166     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> vc;
<a name="l01167"></a>01167     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vc);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(type + 1 &gt;= 0);
<a name="l01170"></a>01170     vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> = type + 1;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>, <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a5753f311c53d8a8f72b1937f33ebb527">OB_RECALC_DATA</a>);
<a name="l01173"></a>01173     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#ad7623342a2e6e2b7e66123bbdf2975da">NC_OBJECT</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a1f2c5ee380a0a55abaf43b7bceeb7688">ND_DRAW</a>, vc.<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>);
<a name="l01174"></a>01174     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 <span class="comment">/* TODO, we could make this a menu into OBJECT_OT_vertex_group_set_active rather than its own operator */</span>
<a name="l01178"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ad8c074e08b973fc7bca3eb0261e0bbdd">01178</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a58d0819dd68e9c690842103d0dcd2a9e">PAINT_OT_weight_sample_group</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l01179"></a>01179 {
<a name="l01180"></a>01180     <a class="code" href="../../d0/de5/structPropertyRNA.html">PropertyRNA</a> *prop = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="comment">/* identifiers */</span>
<a name="l01183"></a>01183     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Weight Paint Sample Group&quot;</span>;
<a name="l01184"></a>01184     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_sample_group&quot;</span>;
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     <span class="comment">/* api callbacks */</span>
<a name="l01187"></a>01187     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#af3ac40382c0d4e1260bb65b96ac458ee">weight_sample_group_exec</a>;
<a name="l01188"></a>01188     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l01189"></a>01189     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a509408c9bafa9b798c8ee17db63f2f3a">weight_paint_mode_poll</a>;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     <span class="comment">/* flags */</span>
<a name="l01192"></a>01192     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="comment">/* keyingset to use (dynamic enum) */</span>
<a name="l01195"></a>01195     prop = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;group&quot;</span>, <a class="code" href="../../d3/d10/rna__access_8c.html#afebbe326102296030e3d563cc47b07c8">DummyRNA_DEFAULT_items</a>, 0, <span class="stringliteral">&quot;Keying Set&quot;</span>, <span class="stringliteral">&quot;The Keying Set to use&quot;</span>);
<a name="l01196"></a>01196     <a class="code" href="../../dc/d7e/rna__define_8c.html#adb30c6a3157cbd3193ff1a8de159389f">RNA_def_enum_funcs</a>(prop, <a class="code" href="../../da/d31/paint__vertex_8c.html#a0826e2b503ad74e59ad13f2ee416d105">weight_paint_sample_enum_itemf</a>);
<a name="l01197"></a>01197     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = prop;
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a1c98a13cf2e1a994903eca2b59e8ad98">01200</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a1c98a13cf2e1a994903eca2b59e8ad98">do_weight_paint_normalize_all</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *vgroup_validmap)
<a name="l01201"></a>01201 {
<a name="l01202"></a>01202     <span class="keywordtype">float</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a> = 0.0f, fac;
<a name="l01203"></a>01203     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, tot = 0;
<a name="l01204"></a>01204     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw;
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01207"></a>01207         <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01208"></a>01208             tot++;
<a name="l01209"></a>01209             sum += dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01210"></a>01210         }
<a name="l01211"></a>01211     }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="keywordflow">if</span> ((tot == 0) || (sum == 1.0f)) {
<a name="l01214"></a>01214         <span class="keywordflow">return</span>;
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217     <span class="keywordflow">if</span> (sum != 0.0f) {
<a name="l01218"></a>01218         fac = 1.0f / <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220         <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01221"></a>01221             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01222"></a>01222                 dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> *= fac;
<a name="l01223"></a>01223             }
<a name="l01224"></a>01224         }
<a name="l01225"></a>01225     }
<a name="l01226"></a>01226     <span class="keywordflow">else</span> {
<a name="l01227"></a>01227         <span class="comment">/* hrmf, not a factor in this case */</span>
<a name="l01228"></a>01228         fac = 1.0f / tot;
<a name="l01229"></a>01229 
<a name="l01230"></a>01230         <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01231"></a>01231             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01232"></a>01232                 dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = fac;
<a name="l01233"></a>01233             }
<a name="l01234"></a>01234         }
<a name="l01235"></a>01235     }
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="comment">/* same as function above except it normalizes against the active vgroup which remains unchanged</span>
<a name="l01239"></a>01239 <span class="comment"> *</span>
<a name="l01240"></a>01240 <span class="comment"> * note that the active is just the group which is unchanged, it can be any,</span>
<a name="l01241"></a>01241 <span class="comment"> * can also be -1 to normalize all but in that case call &#39;do_weight_paint_normalize_all&#39; */</span>
<a name="l01242"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a46a655cded91661e03a713d6ac226419">01242</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a46a655cded91661e03a713d6ac226419">do_weight_paint_normalize_all_active</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *vgroup_validmap,
<a name="l01243"></a>01243                                                  <span class="keyword">const</span> <span class="keywordtype">int</span> vgroup_active)
<a name="l01244"></a>01244 {
<a name="l01245"></a>01245     <span class="keywordtype">float</span> <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a> = 0.0f, fac;
<a name="l01246"></a>01246     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, tot = 0;
<a name="l01247"></a>01247     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw;
<a name="l01248"></a>01248     <span class="keywordtype">float</span> act_weight = 0.0f;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01251"></a>01251         <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01252"></a>01252             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> != vgroup_active) {
<a name="l01253"></a>01253                 sum += dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01254"></a>01254                 tot++;
<a name="l01255"></a>01255             }
<a name="l01256"></a>01256             <span class="keywordflow">else</span> {
<a name="l01257"></a>01257                 act_weight = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01258"></a>01258             }
<a name="l01259"></a>01259         }
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261 
<a name="l01262"></a>01262     <span class="keywordflow">if</span> ((tot == 0) || (sum + act_weight == 1.0f)) {
<a name="l01263"></a>01263         <span class="keywordflow">return</span>;
<a name="l01264"></a>01264     }
<a name="l01265"></a>01265 
<a name="l01266"></a>01266     <span class="keywordflow">if</span> (sum != 0.0f) {
<a name="l01267"></a>01267         fac = (1.0f / <a class="code" href="../../de/da0/btSoftBodyHelpers_8cpp.html#a746bfa686f2dce5b1cff46bba26ac803">sum</a>) * (1.0f - act_weight);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01270"></a>01270             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01271"></a>01271                 <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> != vgroup_active) {
<a name="l01272"></a>01272                     dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> *= fac;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274                     <span class="comment">/* paranoid but possibly with float error */</span>
<a name="l01275"></a>01275                     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, 0.0f, 1.0f);
<a name="l01276"></a>01276                 }
<a name="l01277"></a>01277             }
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280     <span class="keywordflow">else</span> {
<a name="l01281"></a>01281         <span class="comment">/* corner case where we need to scale all weights evenly because they&#39;re all zero */</span>
<a name="l01282"></a>01282 
<a name="l01283"></a>01283         <span class="comment">/* hrmf, not a factor in this case */</span>
<a name="l01284"></a>01284         fac = (1.0f - act_weight) / tot;
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         <span class="comment">/* paranoid but possibly with float error */</span>
<a name="l01287"></a>01287         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(fac, 0.0f, 1.0f);
<a name="l01288"></a>01288 
<a name="l01289"></a>01289         <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01290"></a>01290             <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot &amp;&amp; vgroup_validmap[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01291"></a>01291                 <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> != vgroup_active) {
<a name="l01292"></a>01292                     dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = fac;
<a name="l01293"></a>01293                 }
<a name="l01294"></a>01294             }
<a name="l01295"></a>01295         }
<a name="l01296"></a>01296     }
<a name="l01297"></a>01297 }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299 <span class="comment">/*</span>
<a name="l01300"></a>01300 <span class="comment"> * See if the current deform vertex has a locked group</span>
<a name="l01301"></a>01301 <span class="comment"> */</span>
<a name="l01302"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ac8d0b7bcefb16b175c3679408554691a">01302</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ac8d0b7bcefb16b175c3679408554691a">has_locked_group</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot,
<a name="l01303"></a>01303                              <span class="keyword">const</span> <span class="keywordtype">char</span> *bone_groups, <span class="keyword">const</span> <span class="keywordtype">char</span> *lock_flags)
<a name="l01304"></a>01304 {
<a name="l01305"></a>01305     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01306"></a>01306     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw;
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>, dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>; i != 0; i--, dw++) {
<a name="l01309"></a>01309         <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01310"></a>01310             <span class="keywordflow">if</span> (bone_groups[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] &amp;&amp; lock_flags[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] &amp;&amp; dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> &gt; 0.0f) {
<a name="l01311"></a>01311                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01312"></a>01312             }
<a name="l01313"></a>01313         }
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01316"></a>01316 }
<a name="l01317"></a>01317 <span class="comment">/* </span>
<a name="l01318"></a>01318 <span class="comment"> * gen_lck_flags gets the status of &quot;flag&quot; for each bDeformGroup</span>
<a name="l01319"></a>01319 <span class="comment"> * in ob-&gt;defbase and returns an array containing them</span>
<a name="l01320"></a>01320 <span class="comment"> */</span>
<a name="l01321"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ac15abf166a7ce4580dd676d26be3de03">01321</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d31/paint__vertex_8c.html#ac15abf166a7ce4580dd676d26be3de03">gen_lock_flags</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> defbase_tot)
<a name="l01322"></a>01322 {
<a name="l01323"></a>01323     <span class="keywordtype">char</span> is_locked = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01324"></a>01324     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01325"></a>01325     <span class="comment">//int defbase_tot = BLI_countlist(&amp;ob-&gt;defbase);</span>
<a name="l01326"></a>01326     <span class="keywordtype">char</span> *lock_flags = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(defbase_tot * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <span class="stringliteral">&quot;defflags&quot;</span>);
<a name="l01327"></a>01327     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *defgroup;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="keywordflow">for</span> (i = 0, defgroup = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; i &lt; defbase_tot &amp;&amp; defgroup; defgroup = defgroup-&gt;<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, i++) {
<a name="l01330"></a>01330         lock_flags[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = ((defgroup-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a66186b058bf902bc4a545deaf023c6a3">flag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#add0642d9c162451e006491e534066144">DG_LOCK_WEIGHT</a>) != 0);
<a name="l01331"></a>01331         is_locked |= lock_flags[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333     <span class="keywordflow">if</span> (is_locked) {
<a name="l01334"></a>01334         <span class="keywordflow">return</span> lock_flags;
<a name="l01335"></a>01335     }
<a name="l01336"></a>01336 
<a name="l01337"></a>01337     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(lock_flags);
<a name="l01338"></a>01338     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a4c9ee45f69b818c15320114dc32b85b9">01341</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a4c9ee45f69b818c15320114dc32b85b9">has_locked_group_selected</a>(<span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel, <span class="keyword">const</span> <span class="keywordtype">char</span> *lock_flags)
<a name="l01342"></a>01342 {
<a name="l01343"></a>01343     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01344"></a>01344     <span class="keywordflow">for</span> (i = 0; i &lt; defbase_tot; i++) {
<a name="l01345"></a>01345         <span class="keywordflow">if</span> (defbase_sel[i] &amp;&amp; lock_flags[i]) {
<a name="l01346"></a>01346             <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01347"></a>01347         }
<a name="l01348"></a>01348     }
<a name="l01349"></a>01349     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 <span class="preprocessor">#if 0 </span><span class="comment">/* UNUSED */</span>
<a name="l01354"></a>01354 <span class="keyword">static</span> <span class="keywordtype">int</span> has_unselected_unlocked_bone_group(<span class="keywordtype">int</span> defbase_tot, <span class="keywordtype">char</span> *defbase_sel, <span class="keywordtype">int</span> selected, <span class="keywordtype">char</span> *lock_flags, <span class="keywordtype">char</span> *vgroup_validmap)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (defbase_tot == selected) {
<a name="l01358"></a>01358         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01359"></a>01359     }
<a name="l01360"></a>01360     <span class="keywordflow">for</span> (i = 0; i &lt; defbase_tot; i++) {
<a name="l01361"></a>01361         <span class="keywordflow">if</span> (vgroup_validmap[i] &amp;&amp; !defbase_sel[i] &amp;&amp; !lock_flags[i]) {
<a name="l01362"></a>01362             <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01363"></a>01363         }
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01366"></a>01366 }
<a name="l01367"></a>01367 <span class="preprocessor">#endif</span>
<a name="l01368"></a>01368 <span class="preprocessor"></span>
<a name="l01369"></a>01369 
<a name="l01370"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ae97589ac4f853dcf728bbda3a8772e1b">01370</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ae97589ac4f853dcf728bbda3a8772e1b">multipaint_selection</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keywordtype">float</span> change, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel)
<a name="l01371"></a>01371 {
<a name="l01372"></a>01372     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01373"></a>01373     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw;
<a name="l01374"></a>01374     <span class="keywordtype">float</span> val;
<a name="l01375"></a>01375     <span class="comment">/* make sure they are all at most 1 after the change */</span>
<a name="l01376"></a>01376     <span class="keywordflow">for</span> (i = 0; i &lt; defbase_tot; i++) {
<a name="l01377"></a>01377         <span class="keywordflow">if</span> (defbase_sel[i]) {
<a name="l01378"></a>01378             dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dvert, i);
<a name="l01379"></a>01379             <span class="keywordflow">if</span> (dw &amp;&amp; dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) {
<a name="l01380"></a>01380                 val = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> * change;
<a name="l01381"></a>01381                 <span class="keywordflow">if</span> (val &gt; 1) {
<a name="l01382"></a>01382                     <span class="comment">/* TODO: when the change is reduced, you need to recheck</span>
<a name="l01383"></a>01383 <span class="comment">                     * the earlier values to make sure they are not 0</span>
<a name="l01384"></a>01384 <span class="comment">                     * (precision error) */</span>
<a name="l01385"></a>01385                     change = 1.0f / dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01386"></a>01386                 }
<a name="l01387"></a>01387                 <span class="comment">/* the value should never reach zero while multi-painting if it</span>
<a name="l01388"></a>01388 <span class="comment">                 * was nonzero beforehand */</span>
<a name="l01389"></a>01389                 <span class="keywordflow">if</span> (val &lt;= 0) {
<a name="l01390"></a>01390                     <span class="keywordflow">return</span>;
<a name="l01391"></a>01391                 }
<a name="l01392"></a>01392             }
<a name="l01393"></a>01393         }
<a name="l01394"></a>01394     }
<a name="l01395"></a>01395     <span class="comment">/* apply the valid change */</span>
<a name="l01396"></a>01396     <span class="keywordflow">for</span> (i = 0; i &lt; defbase_tot; i++) {
<a name="l01397"></a>01397         <span class="keywordflow">if</span> (defbase_sel[i]) {
<a name="l01398"></a>01398             dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dvert, i);
<a name="l01399"></a>01399             <span class="keywordflow">if</span> (dw &amp;&amp; dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) {
<a name="l01400"></a>01400                 dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> * change;
<a name="l01401"></a>01401             }
<a name="l01402"></a>01402         }
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404 }
<a name="l01405"></a>01405 
<a name="l01406"></a>01406 <span class="comment">/* move all change onto valid, unchanged groups.  If there is change left over,</span>
<a name="l01407"></a>01407 <span class="comment"> * then return it.</span>
<a name="l01408"></a>01408 <span class="comment"> * assumes there are valid groups to shift weight onto */</span>
<a name="l01409"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#acfbe12a6dee9059282c95510db5d9e2f">01409</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#acfbe12a6dee9059282c95510db5d9e2f">redistribute_change</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *ndv, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot,
<a name="l01410"></a>01410                                  <span class="keywordtype">char</span> *change_status, <span class="keyword">const</span> <span class="keywordtype">char</span> change_me, <span class="keywordtype">int</span> changeto,
<a name="l01411"></a>01411                                  <span class="keywordtype">float</span> totchange, <span class="keywordtype">float</span> total_valid,
<a name="l01412"></a>01412                                  <span class="keywordtype">char</span> do_auto_normalize)
<a name="l01413"></a>01413 {
<a name="l01414"></a>01414     <span class="keywordtype">float</span> was_change;
<a name="l01415"></a>01415     <span class="keywordtype">float</span> change;
<a name="l01416"></a>01416     <span class="keywordtype">float</span> oldval;
<a name="l01417"></a>01417     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *ndw;
<a name="l01418"></a>01418     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01419"></a>01419     <span class="keywordflow">do</span> {
<a name="l01420"></a>01420         <span class="comment">/* assume there is no change until you see one */</span>
<a name="l01421"></a>01421         was_change = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01422"></a>01422         <span class="comment">/* change each group by the same amount each time */</span>
<a name="l01423"></a>01423         change = totchange / total_valid;
<a name="l01424"></a>01424         <span class="keywordflow">for</span> (i = 0; i &lt; ndv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a> &amp;&amp; total_valid &amp;&amp; totchange; i++) {
<a name="l01425"></a>01425             ndw = (ndv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a> + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427             <span class="comment">/* ignore anything outside the value range */</span>
<a name="l01428"></a>01428             <span class="keywordflow">if</span> (ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01429"></a>01429 
<a name="l01430"></a>01430                 <span class="comment">/* change only the groups with a valid status */</span>
<a name="l01431"></a>01431                 <span class="keywordflow">if</span> (change_status[ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] == change_me) {
<a name="l01432"></a>01432                     oldval = ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01433"></a>01433                     <span class="comment">/* if auto normalize is active, don&#39;t worry about upper bounds */</span>
<a name="l01434"></a>01434                     <span class="keywordflow">if</span> (do_auto_normalize == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a> &amp;&amp; ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> + change &gt; 1) {
<a name="l01435"></a>01435                         totchange -= 1.0f - ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01436"></a>01436                         ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = 1.0f;
<a name="l01437"></a>01437                         <span class="comment">/* stop the changes to this group */</span>
<a name="l01438"></a>01438                         change_status[ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] = changeto;
<a name="l01439"></a>01439                         total_valid--;
<a name="l01440"></a>01440                     }
<a name="l01441"></a>01441                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> + change &lt; 0) { <span class="comment">/* check the lower bound */</span>
<a name="l01442"></a>01442                         totchange -= ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01443"></a>01443                         ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = 0;
<a name="l01444"></a>01444                         change_status[ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] = changeto;
<a name="l01445"></a>01445                         total_valid--;
<a name="l01446"></a>01446                     }
<a name="l01447"></a>01447                     <span class="keywordflow">else</span> { <span class="comment">/* a perfectly valid change occurred to ndw-&gt;weight */</span>
<a name="l01448"></a>01448                         totchange -= change;
<a name="l01449"></a>01449                         ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> += change;
<a name="l01450"></a>01450                     }
<a name="l01451"></a>01451                     <span class="comment">/* see if there was a change */</span>
<a name="l01452"></a>01452                     <span class="keywordflow">if</span> (oldval != ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) {
<a name="l01453"></a>01453                         was_change = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01454"></a>01454                     }
<a name="l01455"></a>01455                 }
<a name="l01456"></a>01456             }
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458         <span class="comment">/* don&#39;t go again if there was no change, if there is no valid group,</span>
<a name="l01459"></a>01459 <span class="comment">         * or there is no change left */</span>
<a name="l01460"></a>01460     } <span class="keywordflow">while</span> (was_change &amp;&amp; total_valid &amp;&amp; totchange);
<a name="l01461"></a>01461     <span class="comment">/* left overs */</span>
<a name="l01462"></a>01462     <span class="keywordflow">return</span> totchange;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aba05f4227bc2d79b530b4d30bd213782">get_mp_change</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *odv, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel, <span class="keywordtype">float</span> brush_change);
<a name="l01465"></a>01465 <span class="comment">/* observe the changes made to the weights of groups.</span>
<a name="l01466"></a>01466 <span class="comment"> * make sure all locked groups on the vertex have the same deformation</span>
<a name="l01467"></a>01467 <span class="comment"> * by moving the changes made to groups onto other unlocked groups */</span>
<a name="l01468"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#adddc3a51c16a5428a63d638c0badabb9">01468</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#adddc3a51c16a5428a63d638c0badabb9">enforce_locks</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *odv, <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *ndv,
<a name="l01469"></a>01469                           <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel,
<a name="l01470"></a>01470                           <span class="keyword">const</span> <span class="keywordtype">char</span> *lock_flags, <span class="keyword">const</span> <span class="keywordtype">char</span> *vgroup_validmap,
<a name="l01471"></a>01471                           <span class="keywordtype">char</span> do_auto_normalize, <span class="keywordtype">char</span> do_multipaint)
<a name="l01472"></a>01472 {
<a name="l01473"></a>01473     <span class="keywordtype">float</span> totchange = 0.0f;
<a name="l01474"></a>01474     <span class="keywordtype">float</span> totchange_allowed = 0.0f;
<a name="l01475"></a>01475     <span class="keywordtype">float</span> left_over;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477     <span class="keywordtype">int</span> total_valid = 0;
<a name="l01478"></a>01478     <span class="keywordtype">int</span> total_changed = 0;
<a name="l01479"></a>01479     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01480"></a>01480     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *ndw;
<a name="l01481"></a>01481     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *odw;
<a name="l01482"></a>01482 
<a name="l01483"></a>01483     <span class="keywordtype">float</span> changed_sum = 0.0f;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485     <span class="keywordtype">char</span> *change_status;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (!lock_flags || !<a class="code" href="../../da/d31/paint__vertex_8c.html#ac8d0b7bcefb16b175c3679408554691a">has_locked_group</a>(ndv, defbase_tot, vgroup_validmap, lock_flags)) {
<a name="l01488"></a>01488         <span class="keywordflow">return</span>;
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490     <span class="comment">/* record if a group was changed, unlocked and not changed, or locked */</span>
<a name="l01491"></a>01491     change_status = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * defbase_tot, <span class="stringliteral">&quot;unlocked_unchanged&quot;</span>);
<a name="l01492"></a>01492 
<a name="l01493"></a>01493     <span class="keywordflow">for</span> (i = 0; i &lt; defbase_tot; i++) {
<a name="l01494"></a>01494         ndw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(ndv, i);
<a name="l01495"></a>01495         odw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(odv, i);
<a name="l01496"></a>01496         <span class="comment">/* the weights are zero, so we can assume a lot */</span>
<a name="l01497"></a>01497         <span class="keywordflow">if</span> (!ndw || !odw) {
<a name="l01498"></a>01498             <span class="keywordflow">if</span> (!lock_flags[i] &amp;&amp; vgroup_validmap[i]) {
<a name="l01499"></a>01499                 <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(odv, i);
<a name="l01500"></a>01500                 <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(ndv, i);
<a name="l01501"></a>01501                 total_valid++;
<a name="l01502"></a>01502                 change_status[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 1; <span class="comment">/* can be altered while redistributing */</span>
<a name="l01503"></a>01503             }
<a name="l01504"></a>01504             <span class="keywordflow">continue</span>;
<a name="l01505"></a>01505         }
<a name="l01506"></a>01506         <span class="comment">/* locked groups should not be changed */</span>
<a name="l01507"></a>01507         <span class="keywordflow">if</span> (lock_flags[i]) {
<a name="l01508"></a>01508             ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = odw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01509"></a>01509         }
<a name="l01510"></a>01510         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> != odw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) { <span class="comment">/* changed groups are handled here */</span>
<a name="l01511"></a>01511             totchange += ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> - odw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01512"></a>01512             changed_sum += ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01513"></a>01513             change_status[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 2; <span class="comment">/* was altered already */</span>
<a name="l01514"></a>01514             total_changed++;
<a name="l01515"></a>01515         } <span class="comment">/* unchanged, unlocked bone groups are handled here */</span>
<a name="l01516"></a>01516         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vgroup_validmap[i]) {
<a name="l01517"></a>01517             totchange_allowed += ndw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01518"></a>01518             total_valid++;
<a name="l01519"></a>01519             change_status[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = 1; <span class="comment">/* can be altered while redistributing */</span>
<a name="l01520"></a>01520         }
<a name="l01521"></a>01521     }
<a name="l01522"></a>01522     <span class="comment">/* if there was any change, redistribute it */</span>
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (total_changed) {
<a name="l01524"></a>01524         <span class="comment">/* auto normalize will allow weights to temporarily go above 1 in redistribution */</span>
<a name="l01525"></a>01525         <span class="keywordflow">if</span> (vgroup_validmap &amp;&amp; total_changed &lt; 0 &amp;&amp; total_valid) {
<a name="l01526"></a>01526             totchange_allowed = total_valid;
<a name="l01527"></a>01527         }
<a name="l01528"></a>01528         <span class="comment">/* the way you modify the unlocked + unchanged groups is different depending</span>
<a name="l01529"></a>01529 <span class="comment">         * on whether or not you are painting the weight(s) up or down */</span>
<a name="l01530"></a>01530         <span class="keywordflow">if</span> (totchange &lt; 0) {
<a name="l01531"></a>01531             totchange_allowed = total_valid - totchange_allowed;
<a name="l01532"></a>01532         }
<a name="l01533"></a>01533         <span class="keywordflow">else</span> {
<a name="l01534"></a>01534             totchange_allowed *= -1;
<a name="l01535"></a>01535         }
<a name="l01536"></a>01536         <span class="comment">/* there needs to be change allowed, or you should not bother */</span>
<a name="l01537"></a>01537         <span class="keywordflow">if</span> (totchange_allowed) {
<a name="l01538"></a>01538             left_over = 0;
<a name="l01539"></a>01539             <span class="keywordflow">if</span> (<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(totchange_allowed) &lt; <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(totchange)) {
<a name="l01540"></a>01540                 <span class="comment">/* this amount goes back onto the changed, unlocked weights */</span>
<a name="l01541"></a>01541                 left_over = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(totchange) - <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(totchange_allowed));
<a name="l01542"></a>01542                 <span class="keywordflow">if</span> (totchange &gt; 0) {
<a name="l01543"></a>01543                     left_over *= -1;
<a name="l01544"></a>01544                 }
<a name="l01545"></a>01545             }
<a name="l01546"></a>01546             <span class="keywordflow">else</span> {
<a name="l01547"></a>01547                 <span class="comment">/* all of the change will be permitted */</span>
<a name="l01548"></a>01548                 totchange_allowed = -totchange;
<a name="l01549"></a>01549             }
<a name="l01550"></a>01550             <span class="comment">/* move the weight evenly between the allowed groups, move excess back onto the used groups based on the change */</span>
<a name="l01551"></a>01551             totchange_allowed = <a class="code" href="../../da/d31/paint__vertex_8c.html#acfbe12a6dee9059282c95510db5d9e2f">redistribute_change</a>(ndv, defbase_tot, change_status, 1, -1, totchange_allowed, total_valid, do_auto_normalize);
<a name="l01552"></a>01552             left_over += totchange_allowed;
<a name="l01553"></a>01553             <span class="keywordflow">if</span> (left_over) {
<a name="l01554"></a>01554                 <span class="comment">/* more than one nonzero weights were changed with the same ratio with multipaint, so keep them changed that way! */</span>
<a name="l01555"></a>01555                 <span class="keywordflow">if</span> (total_changed &gt; 1 &amp;&amp; do_multipaint) {
<a name="l01556"></a>01556                     <span class="keywordtype">float</span> undo_change = <a class="code" href="../../da/d31/paint__vertex_8c.html#aba05f4227bc2d79b530b4d30bd213782">get_mp_change</a>(ndv, defbase_tot, defbase_sel, left_over);
<a name="l01557"></a>01557                     <a class="code" href="../../da/d31/paint__vertex_8c.html#ae97589ac4f853dcf728bbda3a8772e1b">multipaint_selection</a>(ndv, defbase_tot, undo_change, defbase_sel);
<a name="l01558"></a>01558                 }   
<a name="l01559"></a>01559                 <span class="comment">/* or designatedw is still -1 put weight back as evenly as possible */</span>
<a name="l01560"></a>01560                 <span class="keywordflow">else</span> {
<a name="l01561"></a>01561                     <a class="code" href="../../da/d31/paint__vertex_8c.html#acfbe12a6dee9059282c95510db5d9e2f">redistribute_change</a>(ndv, defbase_tot, change_status, 2, -2, left_over, total_changed, do_auto_normalize);
<a name="l01562"></a>01562                 }
<a name="l01563"></a>01563             }
<a name="l01564"></a>01564         }
<a name="l01565"></a>01565         <span class="keywordflow">else</span> {
<a name="l01566"></a>01566             <span class="comment">/* reset the weights */</span>
<a name="l01567"></a>01567             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01568"></a>01568             <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw_old = odv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01569"></a>01569             <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw_new = ndv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571             <span class="keywordflow">for</span> (i = odv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i != 0; i--, dw_old++, dw_new++) {
<a name="l01572"></a>01572                 dw_new-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw_old-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01573"></a>01573             }
<a name="l01574"></a>01574         }
<a name="l01575"></a>01575     }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(change_status);
<a name="l01578"></a>01578 }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 <span class="comment">/* multi-paint&#39;s initial, potential change is computed here based on the user&#39;s stroke */</span>
<a name="l01581"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aba05f4227bc2d79b530b4d30bd213782">01581</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aba05f4227bc2d79b530b4d30bd213782">get_mp_change</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *odv, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel, <span class="keywordtype">float</span> brush_change)
<a name="l01582"></a>01582 {
<a name="l01583"></a>01583     <span class="keywordtype">float</span> selwsum = 0.0f;
<a name="l01584"></a>01584     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01585"></a>01585     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = odv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01586"></a>01586 
<a name="l01587"></a>01587     <span class="keywordflow">for</span> (i = odv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i != 0; i--, dw++) {
<a name="l01588"></a>01588         <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01589"></a>01589             <span class="keywordflow">if</span> (defbase_sel[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>]) {
<a name="l01590"></a>01590                 selwsum += dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01591"></a>01591             }
<a name="l01592"></a>01592         }
<a name="l01593"></a>01593     }
<a name="l01594"></a>01594     <span class="keywordflow">if</span> (selwsum &amp;&amp; selwsum + brush_change &gt; 0) {
<a name="l01595"></a>01595         <span class="keywordflow">return</span> (selwsum + brush_change) / selwsum;
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597     <span class="keywordflow">return</span> 0.0f;
<a name="l01598"></a>01598 }
<a name="l01599"></a>01599 
<a name="l01600"></a>01600 <span class="comment">/* change the weights back to the wv&#39;s weights</span>
<a name="l01601"></a>01601 <span class="comment"> * it assumes you already have the correct pointer index */</span>
<a name="l01602"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a15af7c7191d4dfe0a265d94d114ddf74">01602</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a15af7c7191d4dfe0a265d94d114ddf74">defvert_reset_to_prev</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv_prev, <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv)
<a name="l01603"></a>01603 {
<a name="l01604"></a>01604     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01605"></a>01605     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw_prev;
<a name="l01606"></a>01606     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01607"></a>01607     <span class="keywordflow">for</span> (i = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i != 0; i--, dw++) {
<a name="l01608"></a>01608         dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dv_prev, dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>);
<a name="l01609"></a>01609         <span class="comment">/* if there was no w when there is a d, then the old weight was 0 */</span>
<a name="l01610"></a>01610         dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw_prev ? dw_prev-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> : 0.0f;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01614"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3ba34d0ab71ddfe8bb94aafbdebfd84d">01614</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3ba34d0ab71ddfe8bb94aafbdebfd84d">clamp_weights</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert)
<a name="l01615"></a>01615 {
<a name="l01616"></a>01616     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01617"></a>01617     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01618"></a>01618     <span class="keywordflow">for</span> (i = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i != 0; i--, dw++) {
<a name="l01619"></a>01619         <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, 0.0f, 1.0f);
<a name="l01620"></a>01620     }
<a name="l01621"></a>01621 }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623 <span class="comment">/* struct to avoid passing many args each call to do_weight_paint_vertex()</span>
<a name="l01624"></a>01624 <span class="comment"> * this _could_ be made a part of the operators &#39;WPaintData&#39; struct, or at</span>
<a name="l01625"></a>01625 <span class="comment"> * least a member, but for now keep its own struct, initialized on every</span>
<a name="l01626"></a>01626 <span class="comment"> * paint stroke update - campbell */</span>
<a name="l01627"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html">01627</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d82/structWeightPaintInfo.html">WeightPaintInfo</a> {
<a name="l01628"></a>01628 
<a name="l01629"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">01629</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="comment">/* both must add up to &#39;defbase_tot&#39; */</span>
<a name="l01632"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a06a72626f5d1c5cecf920dd45f629b92">01632</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#a06a72626f5d1c5cecf920dd45f629b92">defbase_tot_sel</a>;
<a name="l01633"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a1e35dcb980add02bb960a09c397c1654">01633</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#a1e35dcb980add02bb960a09c397c1654">defbase_tot_unsel</a>;
<a name="l01634"></a>01634 
<a name="l01635"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">01635</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>; <span class="comment">/* (ob-&gt;actdef - 1) */</span>
<a name="l01636"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#afe61fbd032ee1c78d8e2d4b0f9763c2e">01636</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#afe61fbd032ee1c78d8e2d4b0f9763c2e">vgroup_mirror</a>; <span class="comment">/* mirror group or -1 */</span>
<a name="l01637"></a>01637 
<a name="l01638"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">01638</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a>;  <span class="comment">/* boolean array for locked bones,</span>
<a name="l01639"></a>01639 <span class="comment">                              * length of defbase_tot */</span>
<a name="l01640"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">01640</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>; <span class="comment">/* boolean array for selected bones,</span>
<a name="l01641"></a>01641 <span class="comment">                              * length of defbase_tot, cant be const because of how its passed */</span>
<a name="l01642"></a>01642 
<a name="l01643"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">01643</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>; <span class="comment">/* same as WeightPaintData.vgroup_validmap,</span>
<a name="l01644"></a>01644 <span class="comment">                                  * only added here for convenience */</span>
<a name="l01645"></a>01645 
<a name="l01646"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#ab0d62dc666d5de01804245f8e182e5fd">01646</a>     <span class="keywordtype">char</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#ab0d62dc666d5de01804245f8e182e5fd">do_flip</a>;
<a name="l01647"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">01647</a>     <span class="keywordtype">char</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">do_multipaint</a>;
<a name="l01648"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#aed459033c76c47a49d3e53d8dbe565be">01648</a>     <span class="keywordtype">char</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#aed459033c76c47a49d3e53d8dbe565be">do_auto_normalize</a>;
<a name="l01649"></a>01649 
<a name="l01650"></a><a class="code" href="../../d1/d82/structWeightPaintInfo.html#a6dc6eb82bd41ff63c904968becfd7ee2">01650</a>     <span class="keywordtype">float</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html#a6dc6eb82bd41ff63c904968becfd7ee2">brush_alpha_value</a>;  <span class="comment">/* result of brush_alpha() */</span>
<a name="l01651"></a>01651 } <a class="code" href="../../da/d31/paint__vertex_8c.html#a18c85931fbbe382635df28349fdc7303">WeightPaintInfo</a>;
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 <span class="comment">/* fresh start to make multi-paint and locking modular */</span>
<a name="l01654"></a>01654 <span class="comment">/* returns TRUE if it thinks you need to reset the weights due to</span>
<a name="l01655"></a>01655 <span class="comment"> * normalizing while multi-painting</span>
<a name="l01656"></a>01656 <span class="comment"> *</span>
<a name="l01657"></a>01657 <span class="comment"> * note: this assumes dw-&gt;def_nr range has been checked by the caller</span>
<a name="l01658"></a>01658 <span class="comment"> */</span>
<a name="l01659"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a1b042a86f45ed41093004b2d66d960ef">01659</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a1b042a86f45ed41093004b2d66d960ef">apply_mp_locks_normalize</a>(<a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me, <span class="keyword">const</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html">WeightPaintInfo</a> *wpi,
<a name="l01660"></a>01660                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index,
<a name="l01661"></a>01661                                     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw, <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *tdw,
<a name="l01662"></a>01662                                     <span class="keywordtype">float</span> change, <span class="keywordtype">float</span> oldChange,
<a name="l01663"></a>01663                                     <span class="keywordtype">float</span> oldw, <span class="keywordtype">float</span> neww)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[index];
<a name="l01666"></a>01666     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> dv_test = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01669"></a>01669     dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a>;
<a name="l01670"></a>01670     dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a> = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>;
<a name="l01671"></a>01671     <span class="comment">/* do not multi-paint if a locked group is selected or the active group is locked</span>
<a name="l01672"></a>01672 <span class="comment">     * !lock_flags[dw-&gt;def_nr] helps if nothing is selected, but active group is locked */</span>
<a name="l01673"></a>01673     <span class="keywordflow">if</span> ( (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) ||
<a name="l01674"></a>01674          ((wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a>[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp;&amp; <span class="comment">/* def_nr range has to be checked for by caller */</span>
<a name="l01675"></a>01675           <a class="code" href="../../da/d31/paint__vertex_8c.html#a4c9ee45f69b818c15320114dc32b85b9">has_locked_group_selected</a>(wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a>) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))
<a name="l01676"></a>01676     {
<a name="l01677"></a>01677         <span class="keywordflow">if</span> (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">do_multipaint</a> &amp;&amp; wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a06a72626f5d1c5cecf920dd45f629b92">defbase_tot_sel</a> &gt; 1) {
<a name="l01678"></a>01678             <span class="keywordflow">if</span> (change &amp;&amp; change != 1) {
<a name="l01679"></a>01679                 <a class="code" href="../../da/d31/paint__vertex_8c.html#ae97589ac4f853dcf728bbda3a8772e1b">multipaint_selection</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, change, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>);
<a name="l01680"></a>01680             }
<a name="l01681"></a>01681         }
<a name="l01682"></a>01682         <span class="keywordflow">else</span> { <span class="comment">/* this lets users paint normally, but don&#39;t let them paint locked groups */</span>
<a name="l01683"></a>01683             dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = neww;
<a name="l01684"></a>01684         }
<a name="l01685"></a>01685     }
<a name="l01686"></a>01686     <a class="code" href="../../da/d31/paint__vertex_8c.html#a3ba34d0ab71ddfe8bb94aafbdebfd84d">clamp_weights</a>(dv);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688     <a class="code" href="../../da/d31/paint__vertex_8c.html#adddc3a51c16a5428a63d638c0badabb9">enforce_locks</a>(&amp;dv_test, dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aed459033c76c47a49d3e53d8dbe565be">do_auto_normalize</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">do_multipaint</a>);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     <span class="keywordflow">if</span> (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aed459033c76c47a49d3e53d8dbe565be">do_auto_normalize</a>) {
<a name="l01691"></a>01691         <span class="comment">/* XXX - should we pass the active group? - currently &#39;-1&#39; */</span>
<a name="l01692"></a>01692         <a class="code" href="../../da/d31/paint__vertex_8c.html#a1c98a13cf2e1a994903eca2b59e8ad98">do_weight_paint_normalize_all</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>);
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695     <span class="keywordflow">if</span> (oldChange &amp;&amp; wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">do_multipaint</a> &amp;&amp; wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a06a72626f5d1c5cecf920dd45f629b92">defbase_tot_sel</a> &gt; 1) {
<a name="l01696"></a>01696         <span class="keywordflow">if</span> (tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> != oldw) {
<a name="l01697"></a>01697             <span class="keywordflow">if</span> (neww &gt; oldw) {
<a name="l01698"></a>01698                 <span class="keywordflow">if</span> (tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> &lt;= oldw) {
<a name="l01699"></a>01699                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01700"></a>01700                     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01701"></a>01701                 }
<a name="l01702"></a>01702             }
<a name="l01703"></a>01703             <span class="keywordflow">else</span> {
<a name="l01704"></a>01704                 <span class="keywordflow">if</span> (tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> &gt;= oldw) {
<a name="l01705"></a>01705                     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01706"></a>01706                     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01707"></a>01707                 }
<a name="l01708"></a>01708             }
<a name="l01709"></a>01709         }
<a name="l01710"></a>01710     }
<a name="l01711"></a>01711     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dv_test.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01712"></a>01712     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01713"></a>01713 }
<a name="l01714"></a>01714 
<a name="l01715"></a>01715 <span class="comment">/* within the current dvert index, get the dw that is selected and has a weight</span>
<a name="l01716"></a>01716 <span class="comment"> * above 0, this helps multi-paint */</span>
<a name="l01717"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a59e4b8a1d248130382addab5593a115a">01717</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a59e4b8a1d248130382addab5593a115a">get_first_selected_nonzero_weight</a>(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dvert, <span class="keyword">const</span> <span class="keywordtype">int</span> defbase_tot, <span class="keyword">const</span> <span class="keywordtype">char</span> *defbase_sel)
<a name="l01718"></a>01718 {
<a name="l01719"></a>01719     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01720"></a>01720     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw = dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>;
<a name="l01721"></a>01721     <span class="keywordflow">for</span> (i = 0; i &lt; dvert-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>; i++, dw++) {
<a name="l01722"></a>01722         <span class="keywordflow">if</span> (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a> &lt; defbase_tot) {
<a name="l01723"></a>01723             <span class="keywordflow">if</span> (defbase_sel[dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>] &amp;&amp; dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> &gt; 0.0f) {
<a name="l01724"></a>01724                 <span class="keywordflow">return</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01725"></a>01725             }
<a name="l01726"></a>01726         }
<a name="l01727"></a>01727     }
<a name="l01728"></a>01728     <span class="keywordflow">return</span> -1;
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d31/paint__vertex_8c.html#a63821ca1f0d7a7c4d0153aff253b66a4">wpaint_make_validmap</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob);
<a name="l01733"></a>01733 
<a name="l01734"></a>01734 
<a name="l01735"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ab0cc48c9ee0790d7116c04601a9697c8">01735</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ab0cc48c9ee0790d7116c04601a9697c8">do_weight_paint_vertex</a>(
<a name="l01736"></a>01736         <span class="comment">/* vars which remain the same for every vert */</span>
<a name="l01737"></a>01737         <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keyword">const</span> <a class="code" href="../../d1/d82/structWeightPaintInfo.html">WeightPaintInfo</a> *wpi,
<a name="l01738"></a>01738         <span class="comment">/* vars which change on each stroke */</span>
<a name="l01739"></a>01739         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <span class="keywordtype">float</span> alpha, <span class="keywordtype">float</span> paintweight
<a name="l01740"></a>01740         )
<a name="l01741"></a>01741 {
<a name="l01742"></a>01742     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l01743"></a>01743     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[index];
<a name="l01744"></a>01744     
<a name="l01745"></a>01745     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw, *dw_prev;
<a name="l01746"></a>01746 
<a name="l01747"></a>01747     <span class="comment">/* mirror vars */</span>
<a name="l01748"></a>01748     <span class="keywordtype">int</span> index_mirr;
<a name="l01749"></a>01749     <span class="keywordtype">int</span> vgroup_mirr;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *dv_mirr;
<a name="l01752"></a>01752     <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw_mirr;
<a name="l01753"></a>01753 
<a name="l01754"></a>01754     <span class="keyword">const</span> <span class="keywordtype">short</span> do_multipaint_totsel = (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a67b8b00509ca752c28fab843a829bbf5">do_multipaint</a> &amp;&amp; wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a06a72626f5d1c5cecf920dd45f629b92">defbase_tot_sel</a> &gt; 1);
<a name="l01755"></a>01755 
<a name="l01756"></a>01756     <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a78bac4e1e880117a5ef702c7c150d7e4">VP_ONLYVGROUP</a>) {
<a name="l01757"></a>01757         dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>);
<a name="l01758"></a>01758         dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + index, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>);
<a name="l01759"></a>01759     }
<a name="l01760"></a>01760     <span class="keywordflow">else</span> {
<a name="l01761"></a>01761         dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>);
<a name="l01762"></a>01762         dw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + index, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>);
<a name="l01763"></a>01763     }
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     <span class="keywordflow">if</span> (dw == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || dw_prev == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01766"></a>01766         <span class="keywordflow">return</span>;
<a name="l01767"></a>01767     }
<a name="l01768"></a>01768 
<a name="l01769"></a>01769 
<a name="l01770"></a>01770     <span class="comment">/* from now on we can check if mirrors enabled if this var is -1 and not bother with the flag */</span>
<a name="l01771"></a>01771     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a5932a31a907f7856e4b33c8617982df4">ME_EDIT_MIRROR_X</a>) {
<a name="l01772"></a>01772         index_mirr = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a386f24ba06653011e3e1753953d36c0e">mesh_get_x_mirror_vert</a>(ob, index);
<a name="l01773"></a>01773         vgroup_mirr = (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#afe61fbd032ee1c78d8e2d4b0f9763c2e">vgroup_mirror</a> != -1) ? wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#afe61fbd032ee1c78d8e2d4b0f9763c2e">vgroup_mirror</a> : wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>;
<a name="l01774"></a>01774 
<a name="l01775"></a>01775         <span class="comment">/* another possible error - mirror group _and_ active group are the same (which is fine),</span>
<a name="l01776"></a>01776 <span class="comment">         * but we also are painting onto a center vertex - this would paint the same weight twice */</span>
<a name="l01777"></a>01777         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (index_mirr == index &amp;&amp; vgroup_mirr == wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>) {
<a name="l01778"></a>01778             index_mirr = vgroup_mirr = -1;
<a name="l01779"></a>01779         }
<a name="l01780"></a>01780     }
<a name="l01781"></a>01781     <span class="keywordflow">else</span> {
<a name="l01782"></a>01782         index_mirr = vgroup_mirr = -1;
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     <span class="comment">/* get the mirror def vars */</span>
<a name="l01787"></a>01787     <span class="keywordflow">if</span> (index_mirr != -1) {
<a name="l01788"></a>01788         dv_mirr = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[index_mirr];
<a name="l01789"></a>01789         <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a78bac4e1e880117a5ef702c7c150d7e4">VP_ONLYVGROUP</a>) {
<a name="l01790"></a>01790             dw_mirr = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dv_mirr, vgroup_mirr);
<a name="l01791"></a>01791 
<a name="l01792"></a>01792             <span class="keywordflow">if</span> (dw_mirr == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01793"></a>01793                 index_mirr = vgroup_mirr = -1;
<a name="l01794"></a>01794                 dv_mirr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01795"></a>01795             }
<a name="l01796"></a>01796         }
<a name="l01797"></a>01797         <span class="keywordflow">else</span> {
<a name="l01798"></a>01798             <span class="keywordflow">if</span> (index != index_mirr) {
<a name="l01799"></a>01799                 dw_mirr = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(dv_mirr, vgroup_mirr);
<a name="l01800"></a>01800             }
<a name="l01801"></a>01801             <span class="keywordflow">else</span> {
<a name="l01802"></a>01802                 <span class="comment">/* dv and dv_mirr are the same */</span>
<a name="l01803"></a>01803                 <span class="keywordtype">int</span> totweight_prev = dv_mirr-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>;
<a name="l01804"></a>01804                 <span class="keywordtype">int</span> dw_offset = (int)(dw - dv_mirr-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01805"></a>01805                 dw_mirr = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(dv_mirr, vgroup_mirr);
<a name="l01806"></a>01806 
<a name="l01807"></a>01807                 <span class="comment">/* if we added another, get our old one back */</span>
<a name="l01808"></a>01808                 <span class="keywordflow">if</span> (totweight_prev != dv_mirr-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>) {
<a name="l01809"></a>01809                     dw = &amp;dv_mirr-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[dw_offset];
<a name="l01810"></a>01810                 }
<a name="l01811"></a>01811             }
<a name="l01812"></a>01812         }
<a name="l01813"></a>01813     }
<a name="l01814"></a>01814     <span class="keywordflow">else</span> {
<a name="l01815"></a>01815         dv_mirr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01816"></a>01816         dw_mirr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01817"></a>01817     }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 
<a name="l01820"></a>01820     <span class="comment">/* TODO: De-duplicate the simple weight paint - jason */</span>
<a name="l01821"></a>01821     <span class="comment">/* ... or not, since its &lt;10 SLOC - campbell */</span>
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     <span class="comment">/* If there are no locks or multipaint,</span>
<a name="l01824"></a>01824 <span class="comment">     * then there is no need to run the more complicated checks */</span>
<a name="l01825"></a>01825     <span class="keywordflow">if</span> ( (do_multipaint_totsel == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) &amp;&amp;
<a name="l01826"></a>01826          (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../da/d31/paint__vertex_8c.html#ac8d0b7bcefb16b175c3679408554691a">has_locked_group</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a223f9782a2bd43925cc0390c45bf9f12">lock_flags</a>) == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>))
<a name="l01827"></a>01827     {
<a name="l01828"></a>01828         dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a43c8002c48bd024a1a00814564650026">wpaint_blend</a>(wp, dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, dw_prev-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, alpha, paintweight,
<a name="l01829"></a>01829                                   wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a6dc6eb82bd41ff63c904968becfd7ee2">brush_alpha_value</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#ab0d62dc666d5de01804245f8e182e5fd">do_flip</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01830"></a>01830 
<a name="l01831"></a>01831         <span class="comment">/* WATCH IT: take care of the ordering of applying mirror -&gt; normalize,</span>
<a name="l01832"></a>01832 <span class="comment">         * can give wrong results [#26193], least confusing if normalize is done last */</span>
<a name="l01833"></a>01833 
<a name="l01834"></a>01834         <span class="comment">/* apply mirror */</span>
<a name="l01835"></a>01835         <span class="keywordflow">if</span> (index_mirr != -1) {
<a name="l01836"></a>01836             <span class="comment">/* copy, not paint again */</span>
<a name="l01837"></a>01837             dw_mirr-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01838"></a>01838         }
<a name="l01839"></a>01839 
<a name="l01840"></a>01840         <span class="comment">/* apply normalize */</span>
<a name="l01841"></a>01841         <span class="keywordflow">if</span> (wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aed459033c76c47a49d3e53d8dbe565be">do_auto_normalize</a>) {
<a name="l01842"></a>01842             <span class="comment">/* note on normalize - this used to be applied after painting and normalize all weights,</span>
<a name="l01843"></a>01843 <span class="comment">             * in some ways this is good because there is feedback where the more weights involved would</span>
<a name="l01844"></a>01844 <span class="comment">             * &#39;resist&#39; so you couldn&#39;t instantly zero out other weights by painting 1.0 on the active.</span>
<a name="l01845"></a>01845 <span class="comment">             *</span>
<a name="l01846"></a>01846 <span class="comment">             * However this gave a problem since applying mirror, then normalize both verts</span>
<a name="l01847"></a>01847 <span class="comment">             * the resulting weight wont match on both sides.</span>
<a name="l01848"></a>01848 <span class="comment">             *</span>
<a name="l01849"></a>01849 <span class="comment">             * If this &#39;resisting&#39;, slower normalize is nicer, we could call</span>
<a name="l01850"></a>01850 <span class="comment">             * do_weight_paint_normalize_all() and only use...</span>
<a name="l01851"></a>01851 <span class="comment">             * do_weight_paint_normalize_all_active() when normalizing the mirror vertex.</span>
<a name="l01852"></a>01852 <span class="comment">             * - campbell</span>
<a name="l01853"></a>01853 <span class="comment">             */</span>
<a name="l01854"></a>01854             <a class="code" href="../../da/d31/paint__vertex_8c.html#a46a655cded91661e03a713d6ac226419">do_weight_paint_normalize_all_active</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adca0d67ed9c684637650d05f4b22d1b4">vgroup_active</a>);
<a name="l01855"></a>01855 
<a name="l01856"></a>01856             <span class="keywordflow">if</span> (index_mirr != -1) {
<a name="l01857"></a>01857                 <span class="comment">/* only normalize if this is not a center vertex, else we get a conflict, normalizing twice */</span>
<a name="l01858"></a>01858                 <span class="keywordflow">if</span> (index != index_mirr) {
<a name="l01859"></a>01859                     <a class="code" href="../../da/d31/paint__vertex_8c.html#a46a655cded91661e03a713d6ac226419">do_weight_paint_normalize_all_active</a>(dv_mirr, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#adda6cbe8148d80486547076a23a5da8a">vgroup_validmap</a>, vgroup_mirr);
<a name="l01860"></a>01860                 }
<a name="l01861"></a>01861                 <span class="keywordflow">else</span> {
<a name="l01862"></a>01862                     <span class="comment">/* this case accounts for...</span>
<a name="l01863"></a>01863 <span class="comment">                     * - painting onto a center vertex of a mesh</span>
<a name="l01864"></a>01864 <span class="comment">                     * - x mirror is enabled</span>
<a name="l01865"></a>01865 <span class="comment">                     * - auto normalize is enabled</span>
<a name="l01866"></a>01866 <span class="comment">                     * - the group you are painting onto has a L / R version</span>
<a name="l01867"></a>01867 <span class="comment">                     *</span>
<a name="l01868"></a>01868 <span class="comment">                     * We want L/R vgroups to have the same weight but this cant be if both are over 0.5,</span>
<a name="l01869"></a>01869 <span class="comment">                     * We _could_ have special check for that, but this would need its own normalize function which</span>
<a name="l01870"></a>01870 <span class="comment">                     * holds 2 groups from changing at once.</span>
<a name="l01871"></a>01871 <span class="comment">                     *</span>
<a name="l01872"></a>01872 <span class="comment">                     * So! just balance out the 2 weights, it keeps them equal and everything normalized.</span>
<a name="l01873"></a>01873 <span class="comment">                     *</span>
<a name="l01874"></a>01874 <span class="comment">                     * While it wont hit the desired weight immediatelty as the user waggles their mouse,</span>
<a name="l01875"></a>01875 <span class="comment">                     * constant painting and re-normalizing will get there. this is also just simpler logic.</span>
<a name="l01876"></a>01876 <span class="comment">                     * - campbell */</span>
<a name="l01877"></a>01877                     dw_mirr-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> = (dw_mirr-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> + dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) * 0.5f;
<a name="l01878"></a>01878                 }
<a name="l01879"></a>01879             }
<a name="l01880"></a>01880         }
<a name="l01881"></a>01881     }
<a name="l01882"></a>01882     <span class="keywordflow">else</span> {
<a name="l01883"></a>01883         <span class="comment">/* use locks and/or multipaint */</span>
<a name="l01884"></a>01884         <span class="keywordtype">float</span> oldw;
<a name="l01885"></a>01885         <span class="keywordtype">float</span> neww;
<a name="l01886"></a>01886         <span class="keywordtype">float</span> testw = 0;
<a name="l01887"></a>01887         <span class="keywordtype">float</span> change = 0;
<a name="l01888"></a>01888         <span class="keywordtype">float</span> oldChange = 0;
<a name="l01889"></a>01889         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01890"></a>01890         <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *tdw = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *tdw_prev;
<a name="l01891"></a>01891         <a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> dv_copy = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l01892"></a>01892 
<a name="l01893"></a>01893         oldw = dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>;
<a name="l01894"></a>01894         neww = <a class="code" href="../../da/d31/paint__vertex_8c.html#a43c8002c48bd024a1a00814564650026">wpaint_blend</a>(wp, dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, dw_prev-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>, alpha, paintweight,
<a name="l01895"></a>01895                             wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a6dc6eb82bd41ff63c904968becfd7ee2">brush_alpha_value</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#ab0d62dc666d5de01804245f8e182e5fd">do_flip</a>, do_multipaint_totsel);
<a name="l01896"></a>01896         
<a name="l01897"></a>01897         <span class="comment">/* setup multi-paint */</span>
<a name="l01898"></a>01898         <span class="keywordflow">if</span> (do_multipaint_totsel) {
<a name="l01899"></a>01899             dv_copy.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#a949901146866de87c434b2a6e225d2ec">MEM_dupallocN</a>(dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01900"></a>01900             dv_copy.<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a>;
<a name="l01901"></a>01901             dv_copy.<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a> = dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ae476e4275af2828e273dad024e40a4c3">totweight</a>;
<a name="l01902"></a>01902             tdw = dw;
<a name="l01903"></a>01903             tdw_prev = dw_prev;
<a name="l01904"></a>01904             change = <a class="code" href="../../da/d31/paint__vertex_8c.html#aba05f4227bc2d79b530b4d30bd213782">get_mp_change</a>(&amp;wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a>[index], wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>, neww - oldw);
<a name="l01905"></a>01905             <span class="keywordflow">if</span> (change) {
<a name="l01906"></a>01906                 <span class="keywordflow">if</span> (!tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a>) {
<a name="l01907"></a>01907                     i = <a class="code" href="../../da/d31/paint__vertex_8c.html#a59e4b8a1d248130382addab5593a115a">get_first_selected_nonzero_weight</a>(dv, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#a28f5b904359930ec8da9c70ab6a750d2">defbase_tot</a>, wpi-&gt;<a class="code" href="../../d1/d82/structWeightPaintInfo.html#aa68e3a6672f0fcc2d922005375a08a96">defbase_sel</a>);
<a name="l01908"></a>01908                     <span class="keywordflow">if</span> (i &gt;= 0) {
<a name="l01909"></a>01909                         tdw = &amp;(dv-&gt;<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l01910"></a>01910                         tdw_prev = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>(&amp;wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a>[index], tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#a444897eb37478bdccf661b054083941c">def_nr</a>);
<a name="l01911"></a>01911                     }
<a name="l01912"></a>01912                     <span class="keywordflow">else</span> {
<a name="l01913"></a>01913                         change = 0;
<a name="l01914"></a>01914                     }
<a name="l01915"></a>01915                 }
<a name="l01916"></a>01916                 <span class="keywordflow">if</span> (change &amp;&amp; tdw_prev-&gt;weight &amp;&amp; tdw_prev-&gt;weight * change) {
<a name="l01917"></a>01917                     <span class="keywordflow">if</span> (tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> != tdw_prev-&gt;weight) {
<a name="l01918"></a>01918                         oldChange = tdw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> / tdw_prev-&gt;weight;
<a name="l01919"></a>01919                         testw = tdw_prev-&gt;weight * change;
<a name="l01920"></a>01920                         <span class="keywordflow">if</span> (testw &gt; tdw_prev-&gt;weight) {
<a name="l01921"></a>01921                             <span class="keywordflow">if</span> (change &gt; oldChange) {
<a name="l01922"></a>01922                                 <span class="comment">/* reset the weights and use the new change */</span>
<a name="l01923"></a>01923                                 <a class="code" href="../../da/d31/paint__vertex_8c.html#a15af7c7191d4dfe0a265d94d114ddf74">defvert_reset_to_prev</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + index, dv);
<a name="l01924"></a>01924                             }
<a name="l01925"></a>01925                             <span class="keywordflow">else</span> {
<a name="l01926"></a>01926                                 <span class="comment">/* the old change was more significant, so set</span>
<a name="l01927"></a>01927 <span class="comment">                                 * the change to 0 so that it will not do another multi-paint */</span>
<a name="l01928"></a>01928                                 change = 0;
<a name="l01929"></a>01929                             }
<a name="l01930"></a>01930                         }
<a name="l01931"></a>01931                         <span class="keywordflow">else</span> {
<a name="l01932"></a>01932                             <span class="keywordflow">if</span> (change &lt; oldChange) {
<a name="l01933"></a>01933                                 <a class="code" href="../../da/d31/paint__vertex_8c.html#a15af7c7191d4dfe0a265d94d114ddf74">defvert_reset_to_prev</a>(wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a9bdd2f3cd5e7f50745693c0155492456">wpaint_prev</a> + index, dv);
<a name="l01934"></a>01934                             }
<a name="l01935"></a>01935                             <span class="keywordflow">else</span> {
<a name="l01936"></a>01936                                 change = 0;
<a name="l01937"></a>01937                             }
<a name="l01938"></a>01938                         }
<a name="l01939"></a>01939                     }
<a name="l01940"></a>01940                 }
<a name="l01941"></a>01941                 <span class="keywordflow">else</span> {
<a name="l01942"></a>01942                     change = 0;
<a name="l01943"></a>01943                 }
<a name="l01944"></a>01944             }
<a name="l01945"></a>01945         }
<a name="l01946"></a>01946         
<a name="l01947"></a>01947         <span class="keywordflow">if</span> (<a class="code" href="../../da/d31/paint__vertex_8c.html#a1b042a86f45ed41093004b2d66d960ef">apply_mp_locks_normalize</a>(me, wpi, index, dw, tdw, change, oldChange, oldw, neww)) {
<a name="l01948"></a>01948             <a class="code" href="../../da/d31/paint__vertex_8c.html#a15af7c7191d4dfe0a265d94d114ddf74">defvert_reset_to_prev</a>(&amp;dv_copy, dv);
<a name="l01949"></a>01949             change = 0;
<a name="l01950"></a>01950             oldChange = 0;
<a name="l01951"></a>01951         }
<a name="l01952"></a>01952         <span class="keywordflow">if</span> (dv_copy.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>) {
<a name="l01953"></a>01953             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(dv_copy.<a class="code" href="../../dc/d0d/structMDeformVert.html#ab98ee24da5fda5ac02eb30e5d1c928ed">dw</a>);
<a name="l01954"></a>01954         }
<a name="l01955"></a>01955 <span class="preprocessor">#if 0</span>
<a name="l01956"></a>01956 <span class="preprocessor"></span>        <span class="comment">/* dv may have been altered greatly */</span>
<a name="l01957"></a>01957         dw = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>(dv, vgroup);
<a name="l01958"></a>01958 <span class="preprocessor">#else</span>
<a name="l01959"></a>01959 <span class="preprocessor"></span>        dw = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; <span class="comment">/* UNUSED after assignment, set to NULL to ensuyre we don&#39;t</span>
<a name="l01960"></a>01960 <span class="comment">                    * use again, we thats needed un-ifdef the line above */</span>
<a name="l01961"></a>01961         (void)dw;  <span class="comment">/* quiet warnigns */</span>
<a name="l01962"></a>01962 <span class="preprocessor">#endif</span>
<a name="l01963"></a>01963 <span class="preprocessor"></span>
<a name="l01964"></a>01964         <span class="comment">/* x mirror painting */</span>
<a name="l01965"></a>01965         <span class="keywordflow">if</span> (index_mirr != -1) {
<a name="l01966"></a>01966             <span class="comment">/* copy, not paint again */</span>
<a name="l01967"></a>01967 
<a name="l01968"></a>01968             <span class="comment">/* dw_mirr-&gt;weight = dw-&gt;weight; */</span>  <span class="comment">/* TODO, explain the logic in not assigning weight! - campbell */</span>
<a name="l01969"></a>01969             <a class="code" href="../../da/d31/paint__vertex_8c.html#a1b042a86f45ed41093004b2d66d960ef">apply_mp_locks_normalize</a>(me, wpi, index_mirr, dw_mirr, tdw, change, oldChange, oldw, neww);
<a name="l01970"></a>01970         }
<a name="l01971"></a>01971     }
<a name="l01972"></a>01972 }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 
<a name="l01975"></a>01975 <span class="comment">/* *************** set wpaint operator ****************** */</span>
<a name="l01976"></a>01976 
<a name="l01977"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a0143bda577eb326447ee107801827ee9">01977</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a0143bda577eb326447ee107801827ee9">set_wpaint</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))  <span class="comment">/* toggle */</span>
<a name="l01978"></a>01978 {       
<a name="l01979"></a>01979     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l01980"></a>01980     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l01981"></a>01981     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a>;
<a name="l01982"></a>01982     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l01983"></a>01983     
<a name="l01984"></a>01984     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l01985"></a>01985     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a879e9a4b2068335bf9b33dab896e439b">id</a>.<a class="code" href="../../d8/d7e/structID.html#a56d730e86e0fc566622c5f5ea2a7de9f">lib</a> || me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l01986"></a>01986     
<a name="l01987"></a>01987     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>;
<a name="l01988"></a>01988     <span class="keywordflow">else</span> ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>;
<a name="l01989"></a>01989     
<a name="l01990"></a>01990     
<a name="l01991"></a>01991     <span class="comment">/* Weightpaint works by overriding colors in mesh,</span>
<a name="l01992"></a>01992 <span class="comment">     * so need to make sure we recalc on enter and</span>
<a name="l01993"></a>01993 <span class="comment">     * exit (exit needs doing regardless because we</span>
<a name="l01994"></a>01994 <span class="comment">     * should redeform).</span>
<a name="l01995"></a>01995 <span class="comment">     */</span>
<a name="l01996"></a>01996     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l01997"></a>01997     
<a name="l01998"></a>01998     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) {
<a name="l01999"></a>01999         <a class="code" href="../../de/de7/structObject.html">Object</a> *par;
<a name="l02000"></a>02000         
<a name="l02001"></a>02001         <span class="keywordflow">if</span> (wp == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02002"></a>02002             wp = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ae74f441ef2ed3ac1f3c7a5a9cc37a950">new_vpaint</a>(1);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004         <a class="code" href="../../d8/d86/BKE__paint_8h.html#a01e639cae3a45f6e88662083ba8bdd08">paint_init</a>(&amp;wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>, <a class="code" href="../../d8/d86/BKE__paint_8h.html#a98f81fce6a43781e02ccf9f859b7df61">PAINT_CURSOR_WEIGHT_PAINT</a>);
<a name="l02005"></a>02005         <a class="code" href="../../d1/d4d/paint__cursor_8c.html#acc1341bd38131aace67b2e5e8c26aace">paint_cursor_start</a>(C, <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab771c0d67420decddf7ba7336b4e9126">weight_paint_poll</a>);
<a name="l02006"></a>02006         
<a name="l02007"></a>02007         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(ob, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;s&#39;</span>);
<a name="l02008"></a>02008         
<a name="l02009"></a>02009         <span class="comment">/* verify if active weight group is also active bone */</span>
<a name="l02010"></a>02010         par = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a3da508ee2e78275014fa2a143c3e6045">modifiers_isDeformedByArmature</a>(ob);
<a name="l02011"></a>02011         <span class="keywordflow">if</span> (par &amp;&amp; (par-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550acfed9b4bf4a7e2d3c5ae0b3571e38950">OB_MODE_POSE</a>)) {
<a name="l02012"></a>02012             <a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *arm = par-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02013"></a>02013 
<a name="l02014"></a>02014             <span class="keywordflow">if</span> (arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>)
<a name="l02015"></a>02015                 <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ab0fb64913370413c4e4be54a23171dca">ED_vgroup_select_by_name</a>(ob, arm-&gt;<a class="code" href="../../d9/d9f/structbArmature.html#a7d1c3812f46a8787c49bc84c68c1e118">act_bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l02016"></a>02016         }
<a name="l02017"></a>02017     }
<a name="l02018"></a>02018     <span class="keywordflow">else</span> {
<a name="l02019"></a>02019         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a67add616c5fd97f17bf7870d9b05f3f6">mesh_octree_table</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;e&#39;</span>);
<a name="l02020"></a>02020         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a3c8665b18a239636c5f8051e7dc547be">mesh_mirrtopo_table</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="charliteral">&#39;e&#39;</span>);
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022     
<a name="l02023"></a>02023     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a53c798c29ec45386460a892c62769440">ND_MODE</a>, scene);
<a name="l02024"></a>02024     
<a name="l02025"></a>02025     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02026"></a>02026 }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028 <span class="comment">/* for switching to/from mode */</span>
<a name="l02029"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ac8fa7e9f5092e3b97692cbf9f0358881">02029</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ac8fa7e9f5092e3b97692cbf9f0358881">paint_poll_test</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l02030"></a>02030 {
<a name="l02031"></a>02031     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02032"></a>02032     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C))
<a name="l02033"></a>02033         <span class="keywordflow">return</span> 0;
<a name="l02034"></a>02034     <span class="keywordflow">if</span> (<a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C) == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02035"></a>02035         <span class="keywordflow">return</span> 0;
<a name="l02036"></a>02036     <span class="keywordflow">if</span> (!ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a> || ((<a class="code" href="../../d8/d7e/structID.html">ID</a> *)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;lib)
<a name="l02037"></a>02037         <span class="keywordflow">return</span> 0;
<a name="l02038"></a>02038     <span class="keywordflow">return</span> 1;
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 
<a name="l02041"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ab749236444a9055e3ba6d90c0188c230">02041</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a23e603a954081a3c4a27cbb84b5e71b9">PAINT_OT_weight_paint_toggle</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02042"></a>02042 {
<a name="l02043"></a>02043     
<a name="l02044"></a>02044     <span class="comment">/* identifiers */</span>
<a name="l02045"></a>02045     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Weight Paint Mode&quot;</span>;
<a name="l02046"></a>02046     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_paint_toggle&quot;</span>;
<a name="l02047"></a>02047     
<a name="l02048"></a>02048     <span class="comment">/* api callbacks */</span>
<a name="l02049"></a>02049     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a0143bda577eb326447ee107801827ee9">set_wpaint</a>;
<a name="l02050"></a>02050     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ac8fa7e9f5092e3b97692cbf9f0358881">paint_poll_test</a>;
<a name="l02051"></a>02051     
<a name="l02052"></a>02052     <span class="comment">/* flags */</span>
<a name="l02053"></a>02053     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02054"></a>02054     
<a name="l02055"></a>02055 }
<a name="l02056"></a>02056 
<a name="l02057"></a>02057 <span class="comment">/* ************ weight paint operator ********** */</span>
<a name="l02058"></a>02058 
<a name="l02059"></a><a class="code" href="../../df/dc3/structWPaintData.html">02059</a> <span class="keyword">struct </span><a class="code" href="../../df/dc3/structWPaintData.html">WPaintData</a> {
<a name="l02060"></a><a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">02060</a>     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> <a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>;
<a name="l02061"></a><a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">02061</a>     <span class="keywordtype">int</span> *<a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">indexar</a>;
<a name="l02062"></a><a class="code" href="../../df/dc3/structWPaintData.html#a89060238b0fa3ca9d9622ce1857c7ce2">02062</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dc3/structWPaintData.html#a89060238b0fa3ca9d9622ce1857c7ce2">vgroup_active</a>;
<a name="l02063"></a><a class="code" href="../../df/dc3/structWPaintData.html#abee257a9b1d51a6ed6b916f42b9aa252">02063</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dc3/structWPaintData.html#abee257a9b1d51a6ed6b916f42b9aa252">vgroup_mirror</a>;
<a name="l02064"></a><a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">02064</a>     <span class="keywordtype">float</span> *<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a>;
<a name="l02065"></a><a class="code" href="../../df/dc3/structWPaintData.html#a2b0aab5423dec6f1b1c64feaea2d2d84">02065</a>     <span class="keywordtype">float</span> <a class="code" href="../../df/dc3/structWPaintData.html#a2b0aab5423dec6f1b1c64feaea2d2d84">wpimat</a>[3][3];
<a name="l02066"></a>02066     
<a name="l02067"></a>02067     <span class="comment">/* variables for auto normalize */</span>
<a name="l02068"></a><a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">02068</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">vgroup_validmap</a>; <span class="comment">/* stores if vgroups tie to deforming bones or not */</span>
<a name="l02069"></a><a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">02069</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a>;
<a name="l02070"></a><a class="code" href="../../df/dc3/structWPaintData.html#ac1501866f5f55fcd366dd41e7dd622d5">02070</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/dc3/structWPaintData.html#ac1501866f5f55fcd366dd41e7dd622d5">defbase_tot</a>;
<a name="l02071"></a>02071 };
<a name="l02072"></a>02072 
<a name="l02073"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a63821ca1f0d7a7c4d0153aff253b66a4">02073</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../da/d31/paint__vertex_8c.html#a63821ca1f0d7a7c4d0153aff253b66a4">wpaint_make_validmap</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l02074"></a>02074 {
<a name="l02075"></a>02075     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg;
<a name="l02076"></a>02076     <a class="code" href="../../db/ddd/structModifierData.html">ModifierData</a> *md;
<a name="l02077"></a>02077     <span class="keywordtype">char</span> *vgroup_validmap;
<a name="l02078"></a>02078     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *gh;
<a name="l02079"></a>02079     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, step1 = 1;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02082"></a>02082         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02083"></a>02083     }
<a name="l02084"></a>02084 
<a name="l02085"></a>02085     gh = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a5ef36990cf63a693451c76a8faf6b6f5">BLI_ghashutil_strhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a040511a3bdc5ab15ee0d7bf266f3773c">BLI_ghashutil_strcmp</a>, <span class="stringliteral">&quot;wpaint_make_validmap gh&quot;</span>);
<a name="l02086"></a>02086 
<a name="l02087"></a>02087     <span class="comment">/* add all names to a hash table */</span>
<a name="l02088"></a>02088     <span class="keywordflow">for</span> (dg = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; dg; dg = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>) {
<a name="l02089"></a>02089         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(gh, dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02090"></a>02090     }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092     <span class="comment">/* now loop through the armature modifiers and identify deform bones */</span>
<a name="l02093"></a>02093     <span class="keywordflow">for</span> (md = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a31fdd585d66951dfd084a8e8ee624a8d">modifiers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; md; md = !md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a> &amp;&amp; step1 ? (step1 = 0), <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a136f15cde944e4b0c5d938d946d975c9">modifiers_getVirtualModifierList</a>(ob) : md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a3021bdd74b5a4d99e4ea5ee3a19f8560">next</a>) {
<a name="l02094"></a>02094         <span class="keywordflow">if</span> (!(md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a905ab5cd625053441b2e82efe47e95d1">mode</a> &amp; (<a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601ac434becb714d73f6821cafeeb5b22995">eModifierMode_Realtime</a> | <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a1cab93646b1d30a0ad79c4448bb06601a0742486098df403f1362234039fe2473">eModifierMode_Virtual</a>)))
<a name="l02095"></a>02095             <span class="keywordflow">continue</span>;
<a name="l02096"></a>02096 
<a name="l02097"></a>02097         <span class="keywordflow">if</span> (md-&gt;<a class="code" href="../../db/ddd/structModifierData.html#a06b3bfe88f9205bc474fa4a267732b8e">type</a> == <a class="code" href="../../da/df0/DNA__modifier__types_8h.html#a96ba018ea46fb28e626c3b573aca5435aa45deecb66e254a60207702a40efa416">eModifierType_Armature</a>) {
<a name="l02098"></a>02098             <a class="code" href="../../de/d02/structArmatureModifierData.html">ArmatureModifierData</a> *amd = (<a class="code" href="../../de/d02/structArmatureModifierData.html">ArmatureModifierData</a> *) md;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100             <span class="keywordflow">if</span> (amd-&gt;<a class="code" href="../../de/d02/structArmatureModifierData.html#a590e2df001575f79a07d66a7205ebe75">object</a> &amp;&amp; amd-&gt;<a class="code" href="../../de/d02/structArmatureModifierData.html#a590e2df001575f79a07d66a7205ebe75">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>) {
<a name="l02101"></a>02101                 <a class="code" href="../../d3/de4/structbPose.html">bPose</a> *pose = amd-&gt;<a class="code" href="../../de/d02/structArmatureModifierData.html#a590e2df001575f79a07d66a7205ebe75">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>;
<a name="l02102"></a>02102                 <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *chan;
<a name="l02103"></a>02103                 
<a name="l02104"></a>02104                 <span class="keywordflow">for</span> (chan = pose-&gt;<a class="code" href="../../d3/de4/structbPose.html#a0bcc485e14443c3542a761284fa36b81">chanbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; chan; chan = chan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a73c14c1cca1a2d1e91778f44578eeca0">next</a>) {
<a name="l02105"></a>02105                     <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a31291bac57d8e3b0edaac489c94ed8b4">bone</a>-&gt;<a class="code" href="../../de/de0/structBone.html#a5b5e463a4ba414686cfe2954ada482fb">flag</a> &amp; <a class="code" href="../../d2/d93/DNA__armature__types_8h.html#ad26c2b448f0e416cffc8cd84065c3b50ac1ba81acf3025b8a601d4736ba18a394">BONE_NO_DEFORM</a>)
<a name="l02106"></a>02106                         <span class="keywordflow">continue</span>;
<a name="l02107"></a>02107 
<a name="l02108"></a>02108                     <span class="keywordflow">if</span> (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#aaf17fe206dcb6b7b222b670b2a9570c1">BLI_ghash_haskey</a>(gh, chan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>)) {
<a name="l02109"></a>02109                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a8cc41d37f19a6005218c9c061e819d42">BLI_ghash_remove</a>(gh, chan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02110"></a>02110                         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(gh, chan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa6f58f8bcd4649b89458079eae9b1a1f">SET_INT_IN_POINTER</a>(1));
<a name="l02111"></a>02111                     }
<a name="l02112"></a>02112                 }
<a name="l02113"></a>02113             }
<a name="l02114"></a>02114         }
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117     vgroup_validmap = <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2f636817c33fecf8de5e18f30fba0879">BLI_ghash_size</a>(gh), <span class="stringliteral">&quot;wpaint valid map&quot;</span>);
<a name="l02118"></a>02118 
<a name="l02119"></a>02119     <span class="comment">/* add all names to a hash table */</span>
<a name="l02120"></a>02120     <span class="keywordflow">for</span> (dg = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i = 0; dg; dg = dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a8a7d7781bc9d928bff891de4188de7ad">next</a>, i++) {
<a name="l02121"></a>02121         vgroup_validmap[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = (<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(gh, dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#ac38b3004d93922163768710dc9b7cf83">name</a>) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02122"></a>02122     }
<a name="l02123"></a>02123 
<a name="l02124"></a>02124     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(i == <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a2f636817c33fecf8de5e18f30fba0879">BLI_ghash_size</a>(gh));
<a name="l02125"></a>02125 
<a name="l02126"></a>02126     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(gh, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02127"></a>02127 
<a name="l02128"></a>02128     <span class="keywordflow">return</span> vgroup_validmap;
<a name="l02129"></a>02129 }
<a name="l02130"></a>02130 
<a name="l02131"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a5ebbb3282d49f9ad0539c58244331573">02131</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a5ebbb3282d49f9ad0539c58244331573">wpaint_stroke_test_start</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02134"></a>02134     <span class="keyword">struct </span><a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02135"></a>02135     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>;
<a name="l02136"></a>02136     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a>;
<a name="l02137"></a>02137     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02138"></a>02138     <span class="keyword">struct </span><a class="code" href="../../df/dc3/structWPaintData.html">WPaintData</a> *wpd;
<a name="l02139"></a>02139     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l02140"></a>02140     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142     <span class="keywordtype">float</span> mat[4][4], imat[4][4];
<a name="l02143"></a>02143     
<a name="l02144"></a>02144     <span class="keywordflow">if</span> (scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a1aa1978dba5dab99d35b6ba89e88b5bb">obedit</a>) {
<a name="l02145"></a>02145         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02146"></a>02146     }
<a name="l02147"></a>02147     
<a name="l02148"></a>02148     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l02149"></a>02149     <span class="keywordflow">if</span> (me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l02150"></a>02150     
<a name="l02151"></a>02151     <span class="comment">/* if nothing was added yet, we make dverts and a vertex deform group */</span>
<a name="l02152"></a>02152     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>) {
<a name="l02153"></a>02153         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a4338d4c52b452b1ca2fd8868f94e6b26">ED_vgroup_data_create</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>);
<a name="l02154"></a>02154         <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a185e97978ae45ed1d3b3ff4d442c567c">NC_GEOM</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a25383f13197df9bda823d34736df4d82">ND_DATA</a>, me);
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156 
<a name="l02157"></a>02157     <span class="comment">/* this happens on a Bone select, when no vgroup existed yet */</span>
<a name="l02158"></a>02158     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> &lt;= 0) {
<a name="l02159"></a>02159         <a class="code" href="../../de/de7/structObject.html">Object</a> *modob;
<a name="l02160"></a>02160         <span class="keywordflow">if</span> ((modob = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a3da508ee2e78275014fa2a143c3e6045">modifiers_isDeformedByArmature</a>(ob))) {
<a name="l02161"></a>02161             <a class="code" href="../../de/de0/structBone.html">Bone</a> *actbone = ((<a class="code" href="../../d9/d9f/structbArmature.html">bArmature</a> *)modob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>)-&gt;act_bone;
<a name="l02162"></a>02162             <span class="keywordflow">if</span> (actbone) {
<a name="l02163"></a>02163                 <a class="code" href="../../dd/d41/structbPoseChannel.html">bPoseChannel</a> *pchan = <a class="code" href="../../d8/df5/BKE__action_8h.html#a18bfaf2fd4139dd5efbf0c5ea657a1aa">get_pose_channel</a>(modob-&gt;<a class="code" href="../../de/de7/structObject.html#a23522fc15312fc5d99e1e1f68c579c25">pose</a>, actbone-&gt;<a class="code" href="../../de/de0/structBone.html#a64174a3246045ec9f985e604d30c6159">name</a>);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165                 <span class="keywordflow">if</span> (pchan) {
<a name="l02166"></a>02166                     <a class="code" href="../../de/dad/structbDeformGroup.html">bDeformGroup</a> *dg = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#abf203d5606ffc482e88b1d9c6ccffdce">defgroup_find_name</a>(ob, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);
<a name="l02167"></a>02167                     <span class="keywordflow">if</span> (dg == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02168"></a>02168                         dg = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#af563a0e7930017802f6403c33de6a5f6">ED_vgroup_add_name</a>(ob, pchan-&gt;<a class="code" href="../../dd/d41/structbPoseChannel.html#a8e947cbe29071a1c347abe644fe9c0c1">name</a>);  <span class="comment">/* sets actdef */</span>
<a name="l02169"></a>02169                     }
<a name="l02170"></a>02170                     <span class="keywordflow">else</span> {
<a name="l02171"></a>02171                         <span class="keywordtype">int</span> actdef = 1 + <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a0a004822554284f0bb32fdc70cfeee1f">BLI_findindex</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>, dg);
<a name="l02172"></a>02172                         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(actdef &gt;= 0);
<a name="l02173"></a>02173                         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> = actdef;
<a name="l02174"></a>02174                     }
<a name="l02175"></a>02175                 }
<a name="l02176"></a>02176             }
<a name="l02177"></a>02177         }
<a name="l02178"></a>02178     }
<a name="l02179"></a>02179     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02180"></a>02180         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#aeb34cd69cf19ba71530f7ae7862b604b">ED_vgroup_add</a>(ob);
<a name="l02181"></a>02181     }
<a name="l02182"></a>02182 
<a name="l02183"></a>02183     <span class="comment">/* ensure we don&#39;t try paint onto an invalid group */</span>
<a name="l02184"></a>02184     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> &lt;= 0) {
<a name="l02185"></a>02185         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;No active vertex group for painting, aborting&quot;</span>);
<a name="l02186"></a>02186         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02187"></a>02187     }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189     <span class="comment">/* check if we are attempting to paint onto a locked vertex group,</span>
<a name="l02190"></a>02190 <span class="comment">     * and other options disallow it from doing anything useful */</span>
<a name="l02191"></a>02191     dg = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a09f13df59d10774f0bcf69a054f9d865">BLI_findlink</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>, (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> - 1));
<a name="l02192"></a>02192     <span class="keywordflow">if</span> (dg-&gt;<a class="code" href="../../de/dad/structbDeformGroup.html#a66186b058bf902bc4a545deaf023c6a3">flag</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#add0642d9c162451e006491e534066144">DG_LOCK_WEIGHT</a>) {
<a name="l02193"></a>02193         <a class="code" href="../../d2/d40/BKE__report_8h.html#a704625c22b5bb0148eea14635968537a">BKE_report</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ae4f179a72db5cca021a37ec4c6fe4c68aa7428e90bb3916896145e5eb14a7dd7b">RPT_WARNING</a>, <span class="stringliteral">&quot;Active group is locked, aborting&quot;</span>);
<a name="l02194"></a>02194         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02195"></a>02195     }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197     <span class="comment">/* ALLOCATIONS! no return after this line */</span>
<a name="l02198"></a>02198     <span class="comment">/* make mode data storage */</span>
<a name="l02199"></a>02199     wpd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dc3/structWPaintData.html">WPaintData</a>), <span class="stringliteral">&quot;WPaintData&quot;</span>);
<a name="l02200"></a>02200     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a5b7561aaa7fd6364d3591f0ad5933c93">paint_stroke_set_mode_data</a>(stroke, wpd);
<a name="l02201"></a>02201     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>);
<a name="l02202"></a>02202 
<a name="l02203"></a>02203     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a89060238b0fa3ca9d9622ce1857c7ce2">vgroup_active</a> = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> - 1;
<a name="l02204"></a>02204     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#abee257a9b1d51a6ed6b916f42b9aa252">vgroup_mirror</a> = -1;
<a name="l02205"></a>02205 
<a name="l02206"></a>02206     <span class="comment">/* set up auto-normalize, and generate map for detecting which</span>
<a name="l02207"></a>02207 <span class="comment">     * vgroups affect deform bones */</span>
<a name="l02208"></a>02208     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac1501866f5f55fcd366dd41e7dd622d5">defbase_tot</a> = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(&amp;ob-&gt;<a class="code" href="../../de/de7/structObject.html#a11c2e3299c854eb361471ea041397cb7">defbase</a>);
<a name="l02209"></a>02209     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ac15abf166a7ce4580dd676d26be3de03">gen_lock_flags</a>(ob, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac1501866f5f55fcd366dd41e7dd622d5">defbase_tot</a>);
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a854bcd28f2ceed508851e4c830c4c037">auto_normalize</a> || ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a87a556ea02e1c4d8373e54eb45610b74">multipaint</a> || wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a>) {
<a name="l02211"></a>02211         wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">vgroup_validmap</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a63821ca1f0d7a7c4d0153aff253b66a4">wpaint_make_validmap</a>(ob);
<a name="l02212"></a>02212     }
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="comment">/* painting on subsurfs should give correct points too, this returns me-&gt;totvert amount */</span>
<a name="l02215"></a>02215     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1793a322a76b3b50ddd2c09742c5366f">mesh_get_mapped_verts_nors</a>(scene, ob);
<a name="l02216"></a>02216     wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">indexar</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a9c733e19c07defdb2f40833d7c43caf3">get_indexarray</a>(me);
<a name="l02217"></a>02217     <a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">copy_wpaint_prev</a>(wp, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8eb428498e3a39055f51a7de431655ed">totvert</a>);
<a name="l02218"></a>02218 
<a name="l02219"></a>02219     <span class="comment">/* imat for normals */</span>
<a name="l02220"></a>02220     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02221"></a>02221     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, mat);
<a name="l02222"></a>02222     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a2b0aab5423dec6f1b1c64feaea2d2d84">wpimat</a>, imat);
<a name="l02223"></a>02223 
<a name="l02224"></a>02224     <span class="comment">/* if mirror painting, find the other group */</span>
<a name="l02225"></a>02225     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a5932a31a907f7856e4b33c8617982df4">ME_EDIT_MIRROR_X</a>) {
<a name="l02226"></a>02226         wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#abee257a9b1d51a6ed6b916f42b9aa252">vgroup_mirror</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ae32c70d05ce64ee6c26d03057bd09f90">wpaint_mirror_vgroup_ensure</a>(ob, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a89060238b0fa3ca9d9622ce1857c7ce2">vgroup_active</a>);
<a name="l02227"></a>02227     }
<a name="l02228"></a>02228     
<a name="l02229"></a>02229     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02230"></a>02230 }
<a name="l02231"></a>02231 
<a name="l02232"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#af13d2af1e8e13cd009f92f981a4e23a6">02232</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#af13d2af1e8e13cd009f92f981a4e23a6">wpaint_stroke_update_step</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">struct</span> <a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke, <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *itemptr)
<a name="l02233"></a>02233 {
<a name="l02234"></a>02234     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02235"></a>02235     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C);
<a name="l02236"></a>02236     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *wp = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a>;
<a name="l02237"></a>02237     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l02238"></a>02238     <span class="keyword">struct </span><a class="code" href="../../df/dc3/structWPaintData.html">WPaintData</a> *wpd = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a9ba72ca33d4e779560e62236d11ca03a">paint_stroke_mode_data</a>(stroke);
<a name="l02239"></a>02239     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *<a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>;
<a name="l02240"></a>02240     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob;
<a name="l02241"></a>02241     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l02242"></a>02242     <span class="keywordtype">float</span> mat[4][4];
<a name="l02243"></a>02243     <span class="keywordtype">float</span> paintweight;
<a name="l02244"></a>02244     <span class="keywordtype">int</span> *<a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">indexar</a>;
<a name="l02245"></a>02245     <span class="keywordtype">float</span> totw;
<a name="l02246"></a>02246     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>;
<a name="l02247"></a>02247     <span class="keywordtype">float</span> alpha;
<a name="l02248"></a>02248     <span class="keywordtype">float</span> mval[2];
<a name="l02249"></a>02249     <span class="keywordtype">int</span> use_vert_sel;
<a name="l02250"></a>02250     <span class="keywordtype">char</span> *defbase_sel;
<a name="l02251"></a>02251 
<a name="l02252"></a>02252     <span class="keyword">const</span> <span class="keywordtype">float</span> pressure = <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(itemptr, <span class="stringliteral">&quot;pressure&quot;</span>);
<a name="l02253"></a>02253     <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush) * (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(scene, brush) ? pressure : 1.0f);
<a name="l02254"></a>02254     <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_value = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(scene, brush);
<a name="l02255"></a>02255     <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_pressure = brush_alpha_value * (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(scene, brush) ? pressure : 1.0f);
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     <span class="comment">/* intentionally don&#39;t initialize as NULL, make sure we initialize all members below */</span>
<a name="l02258"></a>02258     <a class="code" href="../../d1/d82/structWeightPaintInfo.html">WeightPaintInfo</a> wpi;
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     <span class="comment">/* cannot paint if there is no stroke data */</span>
<a name="l02261"></a>02261     <span class="keywordflow">if</span> (wpd == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02262"></a>02262         <span class="comment">/* XXX: force a redraw here, since even though we can&#39;t paint,</span>
<a name="l02263"></a>02263 <span class="comment">         * at least view won&#39;t freeze until stroke ends */</span>
<a name="l02264"></a>02264         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C));
<a name="l02265"></a>02265         <span class="keywordflow">return</span>;
<a name="l02266"></a>02266     }
<a name="l02267"></a>02267         
<a name="l02268"></a>02268     vc = &amp;wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>;
<a name="l02269"></a>02269     ob = vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>;
<a name="l02270"></a>02270     me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02271"></a>02271     indexar = wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">indexar</a>;
<a name="l02272"></a>02272     
<a name="l02273"></a>02273     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l02274"></a>02274         
<a name="l02275"></a>02275     <span class="comment">/* load projection matrix */</span>
<a name="l02276"></a>02276     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02277"></a>02277 
<a name="l02278"></a>02278     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mval);
<a name="l02279"></a>02279     mval[0] -= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l02280"></a>02280     mval[1] -= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l02281"></a>02281 
<a name="l02282"></a>02282 
<a name="l02283"></a>02283 
<a name="l02284"></a>02284     <span class="comment">/* *** setup WeightPaintInfo - pass onto do_weight_paint_vertex *** */</span>
<a name="l02285"></a>02285     wpi.defbase_tot =        wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac1501866f5f55fcd366dd41e7dd622d5">defbase_tot</a>;
<a name="l02286"></a>02286     defbase_sel =            <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(wpi.defbase_tot * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <span class="stringliteral">&quot;wpi.defbase_sel&quot;</span>);
<a name="l02287"></a>02287     wpi.defbase_tot_sel =    <a class="code" href="../../da/d17/BKE__armature_8h.html#a5a61334aef7488589135bfb9f2f8d447">get_selected_defgroups</a>(ob, defbase_sel, wpi.defbase_tot);
<a name="l02288"></a>02288     wpi.defbase_sel =        defbase_sel; <span class="comment">/* so we can stay const */</span>
<a name="l02289"></a>02289     <span class="keywordflow">if</span> (wpi.defbase_tot_sel == 0 &amp;&amp; ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a> &gt; 0) wpi.defbase_tot_sel = 1;
<a name="l02290"></a>02290 
<a name="l02291"></a>02291     wpi.defbase_tot_unsel =  wpi.defbase_tot - wpi.defbase_tot_sel;
<a name="l02292"></a>02292     wpi.vgroup_active =      wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a89060238b0fa3ca9d9622ce1857c7ce2">vgroup_active</a>;
<a name="l02293"></a>02293     wpi.vgroup_mirror =      wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#abee257a9b1d51a6ed6b916f42b9aa252">vgroup_mirror</a>;
<a name="l02294"></a>02294     wpi.lock_flags =         wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a>;
<a name="l02295"></a>02295     wpi.vgroup_validmap =    wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">vgroup_validmap</a>;
<a name="l02296"></a>02296     wpi.do_flip =            <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(itemptr, <span class="stringliteral">&quot;pen_flip&quot;</span>);
<a name="l02297"></a>02297     wpi.do_multipaint =      (ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a87a556ea02e1c4d8373e54eb45610b74">multipaint</a> != 0);
<a name="l02298"></a>02298     wpi.do_auto_normalize =  ((ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a854bcd28f2ceed508851e4c830c4c037">auto_normalize</a> != 0) &amp;&amp; (wpi.vgroup_validmap != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>));
<a name="l02299"></a>02299     wpi.brush_alpha_value =  brush_alpha_value;
<a name="l02300"></a>02300     <span class="comment">/* *** done setting up WeightPaintInfo *** */</span>
<a name="l02301"></a>02301 
<a name="l02302"></a>02302 
<a name="l02303"></a>02303 
<a name="l02304"></a>02304     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a487370fb68e22a1a67cd8b6be935ecbd">swap_m4m4</a>(wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a7d1daf20c35e60113f4b08cce7139dce">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, mat);
<a name="l02305"></a>02305 
<a name="l02306"></a>02306     use_vert_sel = (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#af66396a073d4e81b048ffe20d23fc612">ME_EDIT_VERT_SEL</a>) != 0;
<a name="l02307"></a>02307 
<a name="l02308"></a>02308     <span class="comment">/* which faces are involved */</span>
<a name="l02309"></a>02309     <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad38f734cc540a73ad8e07a2271511299">VP_AREA</a>) {
<a name="l02310"></a>02310         <span class="comment">/* Ugly hack, to avoid drawing vertex index when getting the face index buffer - campbell */</span>
<a name="l02311"></a>02311         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp;= ~<a class="code" href="../../df/d96/DNA__mesh__types_8h.html#af66396a073d4e81b048ffe20d23fc612">ME_EDIT_VERT_SEL</a>;
<a name="l02312"></a>02312         totindex = <a class="code" href="../../da/d31/paint__vertex_8c.html#a17f80a1f9e46cc648cd4e20cd1115ce1">sample_backbuf_area</a>(vc, indexar, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>, mval[0], mval[1], brush_size_pressure);
<a name="l02313"></a>02313         me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> |= use_vert_sel ? <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#af66396a073d4e81b048ffe20d23fc612">ME_EDIT_VERT_SEL</a> : 0;
<a name="l02314"></a>02314     }
<a name="l02315"></a>02315     <span class="keywordflow">else</span> {
<a name="l02316"></a>02316         indexar[0] = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aba40efd013e32afa64b4059112bcaede">view3d_sample_backbuf</a>(vc, mval[0], mval[1]);
<a name="l02317"></a>02317         <span class="keywordflow">if</span> (indexar[0]) totindex = 1;
<a name="l02318"></a>02318         <span class="keywordflow">else</span> totindex = 0;
<a name="l02319"></a>02319     }
<a name="l02320"></a>02320             
<a name="l02321"></a>02321     <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18b0b61dcda19369a057a82a723317">VP_COLINDEX</a>) {
<a name="l02322"></a>02322         <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02323"></a>02323             <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02324"></a>02324                 <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (indexar[index] - 1);
<a name="l02325"></a>02325                         
<a name="l02326"></a>02326                 <span class="keywordflow">if</span> (mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#afaa3e20eadbc3dfe52d47c0a10dd0c7f">mat_nr</a> != ob-&gt;<a class="code" href="../../de/de7/structObject.html#a7f7913949235b61d1cd0b8f343d0cbfc">actcol</a> - 1) {
<a name="l02327"></a>02327                     indexar[index] = 0;
<a name="l02328"></a>02328                 }
<a name="l02329"></a>02329             }
<a name="l02330"></a>02330         }
<a name="l02331"></a>02331     }
<a name="l02332"></a>02332             
<a name="l02333"></a>02333     <span class="keywordflow">if</span> ((me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) {
<a name="l02334"></a>02334         <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02335"></a>02335             <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02336"></a>02336                 <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (indexar[index] - 1);
<a name="l02337"></a>02337                         
<a name="l02338"></a>02338                 <span class="keywordflow">if</span> ((mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a208492a1db60c4d108f51334e5e80d53">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>) == 0) {
<a name="l02339"></a>02339                     indexar[index] = 0;
<a name="l02340"></a>02340                 }
<a name="l02341"></a>02341             }
<a name="l02342"></a>02342         }
<a name="l02343"></a>02343     }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345     <span class="comment">/* make sure each vertex gets treated only once */</span>
<a name="l02346"></a>02346     <span class="comment">/* and calculate filter weight */</span>
<a name="l02347"></a>02347     totw = 0.0f;
<a name="l02348"></a>02348     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>)
<a name="l02349"></a>02349         paintweight = 0.0f;
<a name="l02350"></a>02350     <span class="keywordflow">else</span>
<a name="l02351"></a>02351         paintweight = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a6af6c729861d662aef1aac6913832c74">vgroup_weight</a>;
<a name="l02352"></a>02352             
<a name="l02353"></a>02353     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02354"></a>02354         <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02355"></a>02355             <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a> + (indexar[index] - 1);
<a name="l02356"></a>02356             <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02357"></a>02357             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359             <span class="keywordflow">if</span> (use_vert_sel) {
<a name="l02360"></a>02360                 <span class="keywordflow">for</span> (i = 0; i &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; i++, ml++) {
<a name="l02361"></a>02361                     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a422181e95f8eeb611b58ca26b5f62bdf">mvert</a>[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>].<a class="code" href="../../d8/de5/structMVert.html#ad635bc3f86fdb7266167069b0cd4cde9">flag</a> &amp; <a class="code" href="../../db/d17/fcurve_8c.html#a53dc4af00adc7b3b4d12eafb71596dfc">SELECT</a>);
<a name="l02362"></a>02362                 }
<a name="l02363"></a>02363             }
<a name="l02364"></a>02364             <span class="keywordflow">else</span> {
<a name="l02365"></a>02365                 <span class="keywordflow">for</span> (i = 0; i &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; i++, ml++) {
<a name="l02366"></a>02366                     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = 1;
<a name="l02367"></a>02367                 }
<a name="l02368"></a>02368             }
<a name="l02369"></a>02369                     
<a name="l02370"></a>02370             <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>) {
<a name="l02371"></a>02371                 <a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *dw, *(*dw_func)(<a class="code" href="../../dc/d0d/structMDeformVert.html">MDeformVert</a> *, <span class="keyword">const</span> int);
<a name="l02372"></a>02372                         
<a name="l02373"></a>02373                 <span class="keywordflow">if</span> (wp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a78bac4e1e880117a5ef702c7c150d7e4">VP_ONLYVGROUP</a>)
<a name="l02374"></a>02374                     dw_func = (<a class="code" href="../../da/d40/structMDeformWeight.html">MDeformWeight</a> *(*)(MDeformVert *, <span class="keyword">const</span> int))<a class="code" href="../../d7/dbd/BKE__deform_8h.html#a5a72056408d78af746633e64f2223ea8">defvert_find_index</a>;
<a name="l02375"></a>02375                 <span class="keywordflow">else</span>
<a name="l02376"></a>02376                     dw_func = <a class="code" href="../../d7/dbd/BKE__deform_8h.html#ac6a1e0a64018bab2913907fadd552a5f">defvert_verify_index</a>;
<a name="l02377"></a>02377                         
<a name="l02378"></a>02378                 ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02379"></a>02379                 <span class="keywordflow">for</span> (i = 0; i &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; i++, ml++) {
<a name="l02380"></a>02380                     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vidx = ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l02381"></a>02381                     <span class="keyword">const</span> <span class="keywordtype">float</span> fac = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3fc95e4c1feb79de975bd66e423ab054">calc_vp_strength_dl</a>(wp, vc, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a> + 6 * vidx, mval, brush_size_pressure);
<a name="l02382"></a>02382                     <span class="keywordflow">if</span> (fac &gt; 0.0f) {
<a name="l02383"></a>02383                         dw = dw_func(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx], wpi.vgroup_active);
<a name="l02384"></a>02384                         paintweight += dw ? (dw-&gt;<a class="code" href="../../da/d40/structMDeformWeight.html#ab18b5a9762544ef80b24f5c5507bd7b7">weight</a> * fac) : 0.0f;
<a name="l02385"></a>02385                         totw += fac;
<a name="l02386"></a>02386                     }
<a name="l02387"></a>02387                 }
<a name="l02388"></a>02388             }
<a name="l02389"></a>02389         }
<a name="l02390"></a>02390     }
<a name="l02391"></a>02391             
<a name="l02392"></a>02392     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>) {
<a name="l02393"></a>02393         paintweight /= totw;
<a name="l02394"></a>02394     }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02397"></a>02397 
<a name="l02398"></a>02398         <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02399"></a>02399             <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a> + (indexar[index] - 1);
<a name="l02400"></a>02400             <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02401"></a>02401             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02402"></a>02402 
<a name="l02403"></a>02403             <span class="keywordflow">for</span> (i = 0; i &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; i++, ml++) {
<a name="l02404"></a>02404                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vidx = ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>;
<a name="l02405"></a>02405 
<a name="l02406"></a>02406                 <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a>) {
<a name="l02407"></a>02407                     alpha = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b97fabbe199b8b0142034158eb5d9bf">calc_vp_alpha_dl</a>(wp, vc, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a2b0aab5423dec6f1b1c64feaea2d2d84">wpimat</a>, wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a> + 6 * vidx,
<a name="l02408"></a>02408                                              mval, brush_size_pressure, brush_alpha_pressure);
<a name="l02409"></a>02409                     <span class="keywordflow">if</span> (alpha) {
<a name="l02410"></a>02410                         <a class="code" href="../../da/d31/paint__vertex_8c.html#ab0cc48c9ee0790d7116c04601a9697c8">do_weight_paint_vertex</a>(wp, ob, &amp;wpi, vidx, alpha, paintweight);
<a name="l02411"></a>02411                     }
<a name="l02412"></a>02412                     me-&gt;<a class="code" href="../../da/d29/structMesh.html#a5d3c41c9b430b3ed6e0454a85fea68de">dvert</a>[vidx].<a class="code" href="../../dc/d0d/structMDeformVert.html#a779734377ac68c83f8fdd38279ba6c4e">flag</a> = 0;
<a name="l02413"></a>02413                 }
<a name="l02414"></a>02414             }
<a name="l02415"></a>02415         }
<a name="l02416"></a>02416     }
<a name="l02417"></a>02417 
<a name="l02418"></a>02418 
<a name="l02419"></a>02419     <span class="comment">/* *** free wpi members */</span>
<a name="l02420"></a>02420     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>((<span class="keywordtype">void</span> *)wpi.defbase_sel);
<a name="l02421"></a>02421     <span class="comment">/* *** don&#39;t freeing wpi members */</span>
<a name="l02422"></a>02422 
<a name="l02423"></a>02423 
<a name="l02424"></a>02424     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a487370fb68e22a1a67cd8b6be935ecbd">swap_m4m4</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, mat);
<a name="l02425"></a>02425             
<a name="l02426"></a>02426     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, 0);
<a name="l02427"></a>02427     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>);
<a name="l02428"></a>02428 }
<a name="l02429"></a>02429 
<a name="l02430"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aed81cb8ff08f85519ec8e1d3f84a7243">02430</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aed81cb8ff08f85519ec8e1d3f84a7243">wpaint_stroke_done</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">struct</span> <a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke)
<a name="l02431"></a>02431 {
<a name="l02432"></a>02432     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C);
<a name="l02433"></a>02433     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02434"></a>02434     <span class="keyword">struct </span><a class="code" href="../../df/dc3/structWPaintData.html">WPaintData</a> *wpd = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a9ba72ca33d4e779560e62236d11ca03a">paint_stroke_mode_data</a>(stroke);
<a name="l02435"></a>02435     
<a name="l02436"></a>02436     <span class="keywordflow">if</span> (wpd) {
<a name="l02437"></a>02437         <span class="keywordflow">if</span> (wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a>)
<a name="l02438"></a>02438             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ac21478c55743b460db61b75f6afdf712">vertexcosnos</a>);
<a name="l02439"></a>02439         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#aa955cd483b1d403bf287cf4f5a4cfb61">indexar</a>);
<a name="l02440"></a>02440         
<a name="l02441"></a>02441         <span class="keywordflow">if</span> (wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">vgroup_validmap</a>)
<a name="l02442"></a>02442             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>((<span class="keywordtype">void</span> *)wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#ab5308b83780f2d8becbbdb653163e08a">vgroup_validmap</a>);
<a name="l02443"></a>02443         <span class="keywordflow">if</span> (wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a>)
<a name="l02444"></a>02444             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>((<span class="keywordtype">void</span> *)wpd-&gt;<a class="code" href="../../df/dc3/structWPaintData.html#a9af8deef2330ae74636abb2802564128">lock_flags</a>);
<a name="l02445"></a>02445 
<a name="l02446"></a>02446         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(wpd);
<a name="l02447"></a>02447     }
<a name="l02448"></a>02448     
<a name="l02449"></a>02449     <span class="comment">/* frees prev buffer */</span>
<a name="l02450"></a>02450     <a class="code" href="../../da/d31/paint__vertex_8c.html#a51a82aafafbb2fc7a52ca6a51b2b06bc">copy_wpaint_prev</a>(ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l02451"></a>02451     
<a name="l02452"></a>02452     <span class="comment">/* and particles too */</span>
<a name="l02453"></a>02453     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l02454"></a>02454         <a class="code" href="../../d4/d14/structParticleSystem.html">ParticleSystem</a> *psys;
<a name="l02455"></a>02455         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02456"></a>02456         
<a name="l02457"></a>02457         <span class="keywordflow">for</span> (psys = ob-&gt;<a class="code" href="../../de/de7/structObject.html#a0eef8205764ed3927f48766acf36ea68">particlesystem</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; psys; psys = psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#a734228c70c56227c6f7a29145a5f5b57">next</a>) {
<a name="l02458"></a>02458             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#a532294a3de8bdb6ac90e7e973de9fa23">PSYS_TOT_VG</a>; i++) {
<a name="l02459"></a>02459                 <span class="keywordflow">if</span> (psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#ad65cbfe5598e2785a4cbc8e32041adc8">vgroup</a>[i] == ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8460eeaead60eced482f83f2bf636417">actdef</a>) {
<a name="l02460"></a>02460                     psys-&gt;<a class="code" href="../../d4/d14/structParticleSystem.html#af8bbacb64e6295f8799570f41e00868d">recalc</a> |= <a class="code" href="../../de/d5a/DNA__particle__types_8h.html#ada872fb06234b9dd53d430a894ce02f0">PSYS_RECALC_RESET</a>;
<a name="l02461"></a>02461                     <span class="keywordflow">break</span>;
<a name="l02462"></a>02462                 }
<a name="l02463"></a>02463             }
<a name="l02464"></a>02464         }
<a name="l02465"></a>02465     }
<a name="l02466"></a>02466     
<a name="l02467"></a>02467     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, 0);
<a name="l02468"></a>02468 }
<a name="l02469"></a>02469 
<a name="l02470"></a>02470 
<a name="l02471"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a1f28b63f97ad92fcd2b587204a1bbd1b">02471</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a1f28b63f97ad92fcd2b587204a1bbd1b">wpaint_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02472"></a>02472 {
<a name="l02473"></a>02473     
<a name="l02474"></a>02474     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#ae31a7a92d1389c10082e2ce234a06b35">paint_stroke_new</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../da/d31/paint__vertex_8c.html#a5ebbb3282d49f9ad0539c58244331573">wpaint_stroke_test_start</a>,
<a name="l02475"></a>02475                                       <a class="code" href="../../da/d31/paint__vertex_8c.html#af13d2af1e8e13cd009f92f981a4e23a6">wpaint_stroke_update_step</a>,
<a name="l02476"></a>02476                                       <a class="code" href="../../da/d31/paint__vertex_8c.html#aed81cb8ff08f85519ec8e1d3f84a7243">wpaint_stroke_done</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>);
<a name="l02477"></a>02477     
<a name="l02478"></a>02478     <span class="comment">/* add modal handler */</span>
<a name="l02479"></a>02479     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l02480"></a>02480 
<a name="l02481"></a>02481     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a>(C, op, event);
<a name="l02482"></a>02482     
<a name="l02483"></a>02483     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02484"></a>02484 }
<a name="l02485"></a>02485 
<a name="l02486"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#aeeaf1431d64574c7f36c63a55911f841">02486</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#aeeaf1431d64574c7f36c63a55911f841">wpaint_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02487"></a>02487 {
<a name="l02488"></a>02488     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a6380e1d9d16a0914b1bda4f71e152f92">paint_stroke_cancel</a>(C, op);
<a name="l02489"></a>02489 
<a name="l02490"></a>02490     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02491"></a>02491 }
<a name="l02492"></a>02492 
<a name="l02493"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a24d7e68bd8feeb594f8569d65f4f85ab">02493</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a66672a128102600911dedbb4a07c5f67">PAINT_OT_weight_paint</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02494"></a>02494 {
<a name="l02495"></a>02495     
<a name="l02496"></a>02496     <span class="comment">/* identifiers */</span>
<a name="l02497"></a>02497     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Weight Paint&quot;</span>;
<a name="l02498"></a>02498     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_paint&quot;</span>;
<a name="l02499"></a>02499     
<a name="l02500"></a>02500     <span class="comment">/* api callbacks */</span>
<a name="l02501"></a>02501     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a1f28b63f97ad92fcd2b587204a1bbd1b">wpaint_invoke</a>;
<a name="l02502"></a>02502     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#abbdd9002992ed83f68ea1c37eca16f28">paint_stroke_modal</a>;
<a name="l02503"></a>02503     <span class="comment">/* ot-&gt;exec = vpaint_exec; &lt;-- needs stroke property */</span>
<a name="l02504"></a>02504     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab771c0d67420decddf7ba7336b4e9126">weight_paint_poll</a>;
<a name="l02505"></a>02505     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#aeeaf1431d64574c7f36c63a55911f841">wpaint_cancel</a>;
<a name="l02506"></a>02506     
<a name="l02507"></a>02507     <span class="comment">/* flags */</span>
<a name="l02508"></a>02508     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l02509"></a>02509 
<a name="l02510"></a>02510     <a class="code" href="../../dc/d7e/rna__define_8c.html#a5861cf8175d4ffb61082e2bbeff84fd0">RNA_def_collection_runtime</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a0c09154eb5eafa1601572b2cd89cf35a">RNA_OperatorStrokeElement</a>, <span class="stringliteral">&quot;Stroke&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02511"></a>02511 }
<a name="l02512"></a>02512 
<a name="l02513"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ac11e491aa07a8ee7a2494b39ad787f5e">02513</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#ac11e491aa07a8ee7a2494b39ad787f5e">weight_paint_set_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(op))
<a name="l02514"></a>02514 {
<a name="l02515"></a>02515     <span class="keyword">struct </span><a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02516"></a>02516     <a class="code" href="../../de/de7/structObject.html">Object</a> *obact = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02517"></a>02517 
<a name="l02518"></a>02518     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a893872ce448a0692a004cb1f738abc77">wpaint_fill</a>(scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#affa3e524b9068ff98a5f00bb56d8b4e2">wpaint</a>, obact, scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a6af6c729861d662aef1aac6913832c74">vgroup_weight</a>);
<a name="l02519"></a>02519     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C)); <span class="comment">/* XXX - should redraw all 3D views */</span>
<a name="l02520"></a>02520     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02521"></a>02521 }
<a name="l02522"></a>02522 
<a name="l02523"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a0d2646a7d4380a4a315ab106054193cf">02523</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a1537af572928328ff030acc6e76d21bc">PAINT_OT_weight_set</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02524"></a>02524 {
<a name="l02525"></a>02525     <span class="comment">/* identifiers */</span>
<a name="l02526"></a>02526     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Set Weight&quot;</span>;
<a name="l02527"></a>02527     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_set&quot;</span>;
<a name="l02528"></a>02528 
<a name="l02529"></a>02529     <span class="comment">/* api callbacks */</span>
<a name="l02530"></a>02530     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ac11e491aa07a8ee7a2494b39ad787f5e">weight_paint_set_exec</a>;
<a name="l02531"></a>02531     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../df/d60/paint__image_8c.html#aacca3ba6063ac3f2f58ba90f51463a2a">mask_paint_poll</a>; <span class="comment">/* it was facemask_paint_poll */</span>
<a name="l02532"></a>02532 
<a name="l02533"></a>02533     <span class="comment">/* flags */</span>
<a name="l02534"></a>02534     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02535"></a>02535 }
<a name="l02536"></a>02536 
<a name="l02537"></a>02537 <span class="comment">/* ************ set / clear vertex paint mode ********** */</span>
<a name="l02538"></a>02538 
<a name="l02539"></a>02539 
<a name="l02540"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a2d172ea7acf2c03d6237966673df7b08">02540</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a2d172ea7acf2c03d6237966673df7b08">set_vpaint</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)  <span class="comment">/* toggle */</span>
<a name="l02541"></a>02541 {   
<a name="l02542"></a>02542     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02543"></a>02543     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02544"></a>02544     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a>;
<a name="l02545"></a>02545     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l02546"></a>02546     
<a name="l02547"></a>02547     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l02548"></a>02548     
<a name="l02549"></a>02549     <span class="keywordflow">if</span> (me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || <a class="code" href="../../df/dac/BKE__object_8h.html#a7e66121d861c5070a2b6f9ed04ca87cb">object_data_is_libdata</a>(ob)) {
<a name="l02550"></a>02550         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>;
<a name="l02551"></a>02551         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l02552"></a>02552     }
<a name="l02553"></a>02553     
<a name="l02554"></a>02554     <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02555"></a>02555         <a class="code" href="../../da/d31/paint__vertex_8c.html#aa37e791dbb398ba16114327aab84af45">make_vertexcol</a>(ob);
<a name="l02556"></a>02556     }
<a name="l02557"></a>02557     
<a name="l02558"></a>02558     <span class="comment">/* toggle: end vpaint */</span>
<a name="l02559"></a>02559     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>) {
<a name="l02560"></a>02560         
<a name="l02561"></a>02561         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp;= ~<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>;
<a name="l02562"></a>02562     }
<a name="l02563"></a>02563     <span class="keywordflow">else</span> {
<a name="l02564"></a>02564         ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> |= <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550afa4f66c680fdf8f9cd7ef1ca969b1901">OB_MODE_VERTEX_PAINT</a>;
<a name="l02565"></a>02565         <span class="comment">/* Turn off weight painting */</span>
<a name="l02566"></a>02566         <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>)
<a name="l02567"></a>02567             <a class="code" href="../../da/d31/paint__vertex_8c.html#a0143bda577eb326447ee107801827ee9">set_wpaint</a>(C, op);
<a name="l02568"></a>02568         
<a name="l02569"></a>02569         <span class="keywordflow">if</span> (vp == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02570"></a>02570             vp = scene-&gt;<a class="code" href="../../d9/d27/structScene.html#a6723b2b9cc9129060c7b2b5c3de1cc77">toolsettings</a>-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ae74f441ef2ed3ac1f3c7a5a9cc37a950">new_vpaint</a>(0);
<a name="l02571"></a>02571         
<a name="l02572"></a>02572         <a class="code" href="../../d1/d4d/paint__cursor_8c.html#acc1341bd38131aace67b2e5e8c26aace">paint_cursor_start</a>(C, <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab4a93bb6c2400695e459c87883735b24">vertex_paint_poll</a>);
<a name="l02573"></a>02573 
<a name="l02574"></a>02574         <a class="code" href="../../d8/d86/BKE__paint_8h.html#a01e639cae3a45f6e88662083ba8bdd08">paint_init</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>, <a class="code" href="../../d8/d86/BKE__paint_8h.html#a4d0ff2161572bf2b44936858afce787d">PAINT_CURSOR_VERTEX_PAINT</a>);
<a name="l02575"></a>02575     }
<a name="l02576"></a>02576     
<a name="l02577"></a>02577     <span class="keywordflow">if</span> (me)
<a name="l02578"></a>02578         <span class="comment">/* update modifier stack for mapping requirements */</span>
<a name="l02579"></a>02579         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l02580"></a>02580     
<a name="l02581"></a>02581     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a61261a6b5ea948eee6d42c7e7ee18166">NC_SCENE</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a53c798c29ec45386460a892c62769440">ND_MODE</a>, scene);
<a name="l02582"></a>02582     
<a name="l02583"></a>02583     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02584"></a>02584 }
<a name="l02585"></a>02585 
<a name="l02586"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#acfb90af20d5a4039faf2d00ca9b8bcec">02586</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#aaf3c1516f2835e799c2656d85586412c">PAINT_OT_vertex_paint_toggle</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02587"></a>02587 {
<a name="l02588"></a>02588     
<a name="l02589"></a>02589     <span class="comment">/* identifiers */</span>
<a name="l02590"></a>02590     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Vertex Paint Mode&quot;</span>;
<a name="l02591"></a>02591     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_vertex_paint_toggle&quot;</span>;
<a name="l02592"></a>02592     
<a name="l02593"></a>02593     <span class="comment">/* api callbacks */</span>
<a name="l02594"></a>02594     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a2d172ea7acf2c03d6237966673df7b08">set_vpaint</a>;
<a name="l02595"></a>02595     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#ac8fa7e9f5092e3b97692cbf9f0358881">paint_poll_test</a>;
<a name="l02596"></a>02596     
<a name="l02597"></a>02597     <span class="comment">/* flags */</span>
<a name="l02598"></a>02598     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l02599"></a>02599 }
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 
<a name="l02602"></a>02602 
<a name="l02603"></a>02603 <span class="comment">/* ********************** vertex paint operator ******************* */</span>
<a name="l02604"></a>02604 
<a name="l02605"></a>02605 <span class="comment">/* Implementation notes:</span>
<a name="l02606"></a>02606 <span class="comment"> *</span>
<a name="l02607"></a>02607 <span class="comment"> * Operator-&gt;invoke()</span>
<a name="l02608"></a>02608 <span class="comment"> * - validate context (add mcol)</span>
<a name="l02609"></a>02609 <span class="comment"> * - create customdata storage</span>
<a name="l02610"></a>02610 <span class="comment"> * - call paint once (mouse click)</span>
<a name="l02611"></a>02611 <span class="comment"> * - add modal handler </span>
<a name="l02612"></a>02612 <span class="comment"> *</span>
<a name="l02613"></a>02613 <span class="comment"> * Operator-&gt;modal()</span>
<a name="l02614"></a>02614 <span class="comment"> * - for every mousemove, apply vertex paint</span>
<a name="l02615"></a>02615 <span class="comment"> * - exit on mouse release, free customdata</span>
<a name="l02616"></a>02616 <span class="comment"> *   (return OPERATOR_FINISHED also removes handler and operator)</span>
<a name="l02617"></a>02617 <span class="comment"> *</span>
<a name="l02618"></a>02618 <span class="comment"> * For future:</span>
<a name="l02619"></a>02619 <span class="comment"> * - implement a stroke event (or mousemove with past positons)</span>
<a name="l02620"></a>02620 <span class="comment"> * - revise whether op-&gt;customdata should be added in object, in set_vpaint</span>
<a name="l02621"></a>02621 <span class="comment"> */</span>
<a name="l02622"></a>02622 
<a name="l02623"></a><a class="code" href="../../d8/d8b/structpolyfacemap__e.html">02623</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d8b/structpolyfacemap__e.html">polyfacemap_e</a> {
<a name="l02624"></a><a class="code" href="../../d8/d8b/structpolyfacemap__e.html#a4d3e12ea0169e43d84daeea206420d2c">02624</a>     <span class="keyword">struct </span><a class="code" href="../../d8/d8b/structpolyfacemap__e.html">polyfacemap_e</a> *<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#a0b2236b9b8bd1e0a2bd1d43c1ebdca04">next</a>, *<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#a4d3e12ea0169e43d84daeea206420d2c">prev</a>;
<a name="l02625"></a><a class="code" href="../../d8/d8b/structpolyfacemap__e.html#abe6ee35b44e8d28ce0ef1f9d0434f78d">02625</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/d8b/structpolyfacemap__e.html#abe6ee35b44e8d28ce0ef1f9d0434f78d">facenr</a>;
<a name="l02626"></a>02626 } <a class="code" href="../../da/d31/paint__vertex_8c.html#aa82130c419795aab66e2539e76dbad3d">polyfacemap_e</a>;
<a name="l02627"></a>02627 
<a name="l02628"></a><a class="code" href="../../d6/df6/structVPaintData.html">02628</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> {
<a name="l02629"></a><a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">02629</a>     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> <a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>;
<a name="l02630"></a><a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">02630</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a>;
<a name="l02631"></a><a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">02631</a>     <span class="keywordtype">int</span> *<a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">indexar</a>;
<a name="l02632"></a><a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">02632</a>     <span class="keywordtype">float</span> *<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a>;
<a name="l02633"></a><a class="code" href="../../d6/df6/structVPaintData.html#a46b24d8fe528de8529225d2e6dd4e875">02633</a>     <span class="keywordtype">float</span> <a class="code" href="../../d6/df6/structVPaintData.html#a46b24d8fe528de8529225d2e6dd4e875">vpimat</a>[3][3];
<a name="l02634"></a>02634 
<a name="l02635"></a>02635     <span class="comment">/* modify &#39;me-&gt;mcol&#39; directly, since the derived mesh is drawing from this array,</span>
<a name="l02636"></a>02636 <span class="comment">     * otherwise we need to refresh the modifier stack */</span>
<a name="l02637"></a><a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">02637</a>     <span class="keywordtype">int</span> <a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a>;
<a name="l02638"></a>02638 
<a name="l02639"></a>02639     <span class="comment">/* mpoly -&gt; mface mapping */</span>
<a name="l02640"></a><a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">02640</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>;
<a name="l02641"></a><a class="code" href="../../d6/df6/structVPaintData.html#ad0a5cc7b5bbe031dd349266cbb9f7f07">02641</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d6/df6/structVPaintData.html#ad0a5cc7b5bbe031dd349266cbb9f7f07">polyfacemap</a>;
<a name="l02642"></a>02642 } <a class="code" href="../../da/d31/paint__vertex_8c.html#af07c823daa907753748de3e6e7e3c928">VPaintData</a>;
<a name="l02643"></a>02643 
<a name="l02644"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a301c8486e027ed907c9f391ba25e0a61">02644</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a301c8486e027ed907c9f391ba25e0a61">vpaint_build_poly_facemap</a>(<span class="keyword">struct</span> <a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vd, <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me)
<a name="l02645"></a>02645 {
<a name="l02646"></a>02646     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l02647"></a>02647     <a class="code" href="../../d8/d8b/structpolyfacemap__e.html">polyfacemap_e</a> *e;
<a name="l02648"></a>02648     <span class="keywordtype">int</span> *origIndex;
<a name="l02649"></a>02649     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02650"></a>02650 
<a name="l02651"></a>02651     vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(1 &lt;&lt; 13, <span class="stringliteral">&quot;vpaint tmp&quot;</span>);
<a name="l02652"></a>02652     <a class="code" href="../../da/db3/BLI__memarena_8h.html#ab7428e198c87b3b5947de14d32b5f705">BLI_memarena_use_calloc</a>(vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>);
<a name="l02653"></a>02653 
<a name="l02654"></a>02654     vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ad0a5cc7b5bbe031dd349266cbb9f7f07">polyfacemap</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>) * me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>);
<a name="l02655"></a>02655 
<a name="l02656"></a>02656     origIndex = <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#ab05e3a5a972a7132cc6e254914fb5743">CustomData_get_layer</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9e7b23c7ac7bc3e81c3e3076f475bda4">fdata</a>, <a class="code" href="../../d8/d9f/DNA__customdata__types_8h.html#aa372d7e079afb57b1c244af8b8906509">CD_POLYINDEX</a>);
<a name="l02657"></a>02657     mf = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>;
<a name="l02658"></a>02658 
<a name="l02659"></a>02659     <span class="keywordflow">if</span> (!origIndex)
<a name="l02660"></a>02660         <span class="keywordflow">return</span>;
<a name="l02661"></a>02661 
<a name="l02662"></a>02662     <span class="keywordflow">for</span> (i = 0; i &lt; me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9dcac207036b39eff56533e7204cbb95">totface</a>; i++, mf++, origIndex++) {
<a name="l02663"></a>02663         <span class="keywordflow">if</span> (*origIndex == <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a9c45061d42a9d82ed1a425e2b997c200">ORIGINDEX_NONE</a>)
<a name="l02664"></a>02664             <span class="keywordflow">continue</span>;
<a name="l02665"></a>02665 
<a name="l02666"></a>02666         e = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8b/structpolyfacemap__e.html">polyfacemap_e</a>));
<a name="l02667"></a>02667         e-&gt;<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#abe6ee35b44e8d28ce0ef1f9d0434f78d">facenr</a> = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02668"></a>02668         
<a name="l02669"></a>02669         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;vd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ad0a5cc7b5bbe031dd349266cbb9f7f07">polyfacemap</a>[*origIndex], e);
<a name="l02670"></a>02670     }
<a name="l02671"></a>02671 }
<a name="l02672"></a>02672 
<a name="l02673"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a7869bfe75adf1d0f64a7f813d0bf39b3">02673</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a7869bfe75adf1d0f64a7f813d0bf39b3">vpaint_stroke_test_start</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">struct</span> <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(event))
<a name="l02674"></a>02674 {
<a name="l02675"></a>02675     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C);
<a name="l02676"></a>02676     <span class="keyword">struct </span><a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02677"></a>02677     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a>;
<a name="l02678"></a>02678     <span class="keyword">struct </span><a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vpd;
<a name="l02679"></a>02679     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l02680"></a>02680     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me;
<a name="l02681"></a>02681     <span class="keywordtype">float</span> mat[4][4], imat[4][4];
<a name="l02682"></a>02682 
<a name="l02683"></a>02683     <span class="comment">/* context checks could be a poll() */</span>
<a name="l02684"></a>02684     me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l02685"></a>02685     <span class="keywordflow">if</span> (me == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a> == 0)
<a name="l02686"></a>02686         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l02687"></a>02687     
<a name="l02688"></a>02688     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02689"></a>02689         <a class="code" href="../../da/d31/paint__vertex_8c.html#aa37e791dbb398ba16114327aab84af45">make_vertexcol</a>(ob);
<a name="l02690"></a>02690     <span class="keywordflow">if</span> (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02691"></a>02691         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02692"></a>02692     
<a name="l02693"></a>02693     <span class="comment">/* make mode data storage */</span>
<a name="l02694"></a>02694     vpd = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a>), <span class="stringliteral">&quot;VPaintData&quot;</span>);
<a name="l02695"></a>02695     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a5b7561aaa7fd6364d3591f0ad5933c93">paint_stroke_set_mode_data</a>(stroke, vpd);
<a name="l02696"></a>02696     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aa18efc327ab12e74064a2c1129237431">view3d_set_viewcontext</a>(C, &amp;vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>);
<a name="l02697"></a>02697     
<a name="l02698"></a>02698     vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a> = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a1793a322a76b3b50ddd2c09742c5366f">mesh_get_mapped_verts_nors</a>(vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a318ac2fefa5f4e6ad6faa0a7249d7e73">scene</a>, ob);
<a name="l02699"></a>02699     vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">indexar</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a9c733e19c07defdb2f40833d7c43caf3">get_indexarray</a>(me);
<a name="l02700"></a>02700     vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#aa2cdd1762e74a4d397575cc78809c936">vpaint_get_current_col</a>(vp);
<a name="l02701"></a>02701 
<a name="l02702"></a>02702 
<a name="l02703"></a>02703     <span class="comment">/* are we painting onto a modified mesh?,</span>
<a name="l02704"></a>02704 <span class="comment">     * if not we can skip face map trickyness */</span>
<a name="l02705"></a>02705     <span class="keywordflow">if</span> (<a class="code" href="../../da/d31/paint__vertex_8c.html#a3eedb778404e270b2349b7c70e418f9b">vertex_paint_use_fast_update_check</a>(ob)) {
<a name="l02706"></a>02706         <a class="code" href="../../da/d31/paint__vertex_8c.html#a301c8486e027ed907c9f391ba25e0a61">vpaint_build_poly_facemap</a>(vpd, me);
<a name="l02707"></a>02707         vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02708"></a>02708     }
<a name="l02709"></a>02709     <span class="keywordflow">else</span> {
<a name="l02710"></a>02710         vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a> = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02711"></a>02711     }
<a name="l02712"></a>02712 
<a name="l02713"></a>02713     <span class="comment">/* for filtering */</span>
<a name="l02714"></a>02714     <a class="code" href="../../da/d31/paint__vertex_8c.html#ab1c54077920cada220331475a8e9b14b">copy_vpaint_prev</a>(vp, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ad564f355ced9ae66d5e9b2d7681cc510">totloop</a>);
<a name="l02715"></a>02715     
<a name="l02716"></a>02716     <span class="comment">/* some old cruft to sort out later */</span>
<a name="l02717"></a>02717     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#ad04178a1375cc4ef5c59a76b723f822f">viewmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02718"></a>02718     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, mat);
<a name="l02719"></a>02719     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a46b24d8fe528de8529225d2e6dd4e875">vpimat</a>, imat);
<a name="l02720"></a>02720 
<a name="l02721"></a>02721     <span class="keywordflow">return</span> 1;
<a name="l02722"></a>02722 }
<a name="l02723"></a>02723 
<a name="l02724"></a>02724 <span class="preprocessor">#if 0</span>
<a name="l02725"></a>02725 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> vpaint_paint_face(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vpd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,
<a name="l02726"></a>02726                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l02727"></a>02727                               <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure, <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_pressure,
<a name="l02728"></a>02728                               <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(flip))
<a name="l02729"></a>02729 {
<a name="l02730"></a>02730     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a> = &amp;vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>;
<a name="l02731"></a>02731     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l02732"></a>02732     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l02733"></a>02733     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mface = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a>[index];
<a name="l02734"></a>02734     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *mcol = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a>) + 4 * index;
<a name="l02735"></a>02735     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *mcolorig = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a>) + 4 * index;
<a name="l02736"></a>02736     <span class="keywordtype">float</span> alpha;
<a name="l02737"></a>02737     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02738"></a>02738 
<a name="l02739"></a>02739     <span class="keywordtype">int</span> brush_alpha_pressure_i;
<a name="l02740"></a>02740     
<a name="l02741"></a>02741     <span class="keywordflow">if</span> ((vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18b0b61dcda19369a057a82a723317">VP_COLINDEX</a> &amp;&amp; mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a9263f86fc8c22b7f355bcade20574047">mat_nr</a> != ob-&gt;<a class="code" href="../../de/de7/structObject.html#a7f7913949235b61d1cd0b8f343d0cbfc">actcol</a> - 1) ||
<a name="l02742"></a>02742         ((me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) &amp;&amp; !(mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a729da859ed02b2946331e7f82f3ff20c">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>)))
<a name="l02743"></a>02743         <span class="keywordflow">return</span>;
<a name="l02744"></a>02744 
<a name="l02745"></a>02745     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>) {
<a name="l02746"></a>02746         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fcol1 = <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(mcol[0], mcol[1], 128);
<a name="l02747"></a>02747         <span class="keywordflow">if</span> (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>) {
<a name="l02748"></a>02748             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fcol2 = <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(mcol[2], mcol[3], 128);
<a name="l02749"></a>02749             vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(fcol1, fcol2, 128);
<a name="l02750"></a>02750         }
<a name="l02751"></a>02751         <span class="keywordflow">else</span> {
<a name="l02752"></a>02752             vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#aa6b954a9c702cc165c9b5c35e3ddd017">mcol_blend</a>(mcol[2], fcol1, 170);
<a name="l02753"></a>02753         }
<a name="l02754"></a>02754     }
<a name="l02755"></a>02755 
<a name="l02756"></a>02756     brush_alpha_pressure_i = (int)(brush_alpha_pressure * 255.0f);
<a name="l02757"></a>02757 
<a name="l02758"></a>02758     <span class="keywordflow">for</span> (i = 0; i &lt; (mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> ? 4 : 3); ++<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>) {
<a name="l02759"></a>02759         alpha = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b97fabbe199b8b0142034158eb5d9bf">calc_vp_alpha_dl</a>(vp, vc, vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a46b24d8fe528de8529225d2e6dd4e875">vpimat</a>, vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a> + 6 * (&amp;mface-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)[i],
<a name="l02760"></a>02760                                  mval, brush_size_pressure, brush_alpha_pressure);
<a name="l02761"></a>02761         <span class="keywordflow">if</span> (alpha) {
<a name="l02762"></a>02762             <span class="keyword">const</span> <span class="keywordtype">int</span> alpha_i = (int)(alpha * 255.0f);
<a name="l02763"></a>02763             mcol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d31/paint__vertex_8c.html#a21cfbb3aa1996c41a4cea82cb3df8da1">vpaint_blend</a>(vp, mcol[i], mcolorig[i], vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a>, alpha_i, brush_alpha_pressure_i);
<a name="l02764"></a>02764         }
<a name="l02765"></a>02765     }
<a name="l02766"></a>02766 }
<a name="l02767"></a>02767 <span class="preprocessor">#endif</span>
<a name="l02768"></a>02768 <span class="preprocessor"></span>
<a name="l02769"></a>02769 <span class="comment">/* BMESH version of vpaint_paint_face (commented above) */</span>
<a name="l02770"></a>02770 
<a name="l02771"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a6b702f5f09d0e5f2213cb6f6e3a03168">02771</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a6b702f5f09d0e5f2213cb6f6e3a03168">vpaint_paint_poly</a>(<a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp, <a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vpd, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob,
<a name="l02772"></a>02772                               <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">float</span> mval[2],
<a name="l02773"></a>02773                               <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure, <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_pressure)
<a name="l02774"></a>02774 {
<a name="l02775"></a>02775     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc = &amp;vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>;
<a name="l02776"></a>02776     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l02777"></a>02777     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = <a class="code" href="../../df/d7f/BKE__mesh_8h.html#a80d6c41e95a49af12ddf2f2b48dc659d">get_mesh</a>(ob);
<a name="l02778"></a>02778     <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = &amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>[index];
<a name="l02779"></a>02779     <a class="code" href="../../d6/da0/structMFace.html">MFace</a> *mf;
<a name="l02780"></a>02780     <a class="code" href="../../db/d33/structMCol.html">MCol</a> *mc;
<a name="l02781"></a>02781     <a class="code" href="../../d7/d72/structMLoop.html">MLoop</a> *ml;
<a name="l02782"></a>02782     <a class="code" href="../../d5/df4/structMLoopCol.html">MLoopCol</a> *mlc;
<a name="l02783"></a>02783     <a class="code" href="../../d8/d8b/structpolyfacemap__e.html">polyfacemap_e</a> *e;
<a name="l02784"></a>02784     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *lcol = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a>) + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02785"></a>02785     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *lcolorig = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a2d4ad031ecb5a46c0e9622939f4c31d5">vpaint_prev</a>) + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02786"></a>02786     <span class="keywordtype">float</span> alpha;
<a name="l02787"></a>02787     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l02788"></a>02788 
<a name="l02789"></a>02789     <span class="keywordtype">int</span> brush_alpha_pressure_i = (int)(brush_alpha_pressure * 255.0f);
<a name="l02790"></a>02790 
<a name="l02791"></a>02791     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>) {
<a name="l02792"></a>02792         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../db/d0d/render__texture_8c.html#a85b57d4b9680af22ac05b4a6fb623d7c">blend</a>[4] = {0};
<a name="l02793"></a>02793         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tcol;
<a name="l02794"></a>02794         <span class="keywordtype">char</span> *col;
<a name="l02795"></a>02795 
<a name="l02796"></a>02796         <span class="keywordflow">for</span> (j = 0; j &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++) {
<a name="l02797"></a>02797             col = (<span class="keywordtype">char</span> *)(lcol + j);
<a name="l02798"></a>02798             blend[0] += col[0];
<a name="l02799"></a>02799             blend[1] += col[1];
<a name="l02800"></a>02800             blend[2] += col[2];
<a name="l02801"></a>02801             blend[3] += col[3];
<a name="l02802"></a>02802         }
<a name="l02803"></a>02803 
<a name="l02804"></a>02804         blend[0] /= mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l02805"></a>02805         blend[1] /= mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l02806"></a>02806         blend[2] /= mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l02807"></a>02807         blend[3] /= mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>;
<a name="l02808"></a>02808         col = (<span class="keywordtype">char</span> *)&amp;tcol;
<a name="l02809"></a>02809         col[0] = blend[0];
<a name="l02810"></a>02810         col[1] = blend[1];
<a name="l02811"></a>02811         col[2] = blend[2];
<a name="l02812"></a>02812         col[3] = blend[3];
<a name="l02813"></a>02813 
<a name="l02814"></a>02814         vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a> = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)col);
<a name="l02815"></a>02815     }
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02818"></a>02818     <span class="keywordflow">for</span> (i = 0; i &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; i++, ml++) {
<a name="l02819"></a>02819         alpha = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b97fabbe199b8b0142034158eb5d9bf">calc_vp_alpha_dl</a>(vp, vc, vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a46b24d8fe528de8529225d2e6dd4e875">vpimat</a>,
<a name="l02820"></a>02820                                  vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a> + 6 * ml-&gt;<a class="code" href="../../d7/d72/structMLoop.html#ae5aa5a4861aba2bd5145f0b2c4ab4412">v</a>, mval,
<a name="l02821"></a>02821                                  brush_size_pressure, brush_alpha_pressure);
<a name="l02822"></a>02822         <span class="keywordflow">if</span> (alpha &gt; 0.0f) {
<a name="l02823"></a>02823             <span class="keyword">const</span> <span class="keywordtype">int</span> alpha_i = (int)(alpha * 255.0f);
<a name="l02824"></a>02824             lcol[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/d31/paint__vertex_8c.html#a21cfbb3aa1996c41a4cea82cb3df8da1">vpaint_blend</a>(vp, lcol[i], lcolorig[i], vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a24aea9f293e2ad3a4dfd1099c4f7e9a3">paintcol</a>, alpha_i, brush_alpha_pressure_i);
<a name="l02825"></a>02825         }
<a name="l02826"></a>02826     }
<a name="l02827"></a>02827 
<a name="l02828"></a>02828     <span class="keywordflow">if</span> (vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a>) {
<a name="l02829"></a>02829 
<a name="l02830"></a>02830 <span class="preprocessor">#ifdef CPYCOL</span>
<a name="l02831"></a>02831 <span class="preprocessor"></span><span class="preprocessor">#  undef CPYCOL</span>
<a name="l02832"></a>02832 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02833"></a>02833 <span class="preprocessor"></span><span class="preprocessor">#define CPYCOL(c, l) (c)-&gt;a = (l)-&gt;a, (c)-&gt;r = (l)-&gt;r, (c)-&gt;g = (l)-&gt;g, (c)-&gt;b = (l)-&gt;b</span>
<a name="l02834"></a>02834 <span class="preprocessor"></span>
<a name="l02835"></a>02835         <span class="comment">/* update vertex colors for tessellations incrementally,</span>
<a name="l02836"></a>02836 <span class="comment">         * rather then regenerating the tessellation altogether */</span>
<a name="l02837"></a>02837         <span class="keywordflow">for</span> (e = vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ad0a5cc7b5bbe031dd349266cbb9f7f07">polyfacemap</a>[index].<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; e; e = e-&gt;<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#a0b2236b9b8bd1e0a2bd1d43c1ebdca04">next</a>) {
<a name="l02838"></a>02838             mf = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ae2f9f6ccbbc64ba6aff375ae95510217">mface</a> + e-&gt;<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#abe6ee35b44e8d28ce0ef1f9d0434f78d">facenr</a>;
<a name="l02839"></a>02839             mc = me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac9ed0f3506c7eeffb9d7aad8d6c254a7">mcol</a> + e-&gt;<a class="code" href="../../d8/d8b/structpolyfacemap__e.html#abe6ee35b44e8d28ce0ef1f9d0434f78d">facenr</a> * 4;
<a name="l02840"></a>02840 
<a name="l02841"></a>02841             ml = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a9ae8024c777dd16443d6fc13a8b30880">mloop</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02842"></a>02842             mlc = me-&gt;<a class="code" href="../../da/d29/structMesh.html#a42f7770f13a2a1ff5042036eed27edef">mloopcol</a> + mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#af553fa511f9a5475e5ff8cca8fa0b115">loopstart</a>;
<a name="l02843"></a>02843             <span class="keywordflow">for</span> (j = 0; j &lt; mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a056a6dcc2dd557fc8b14db5aa6dfa8b0">totloop</a>; j++, ml++, mlc++) {
<a name="l02844"></a>02844                 <span class="keywordflow">if</span> (ml-&gt;v == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a7bbd2d1ca59c1ed8edd859c0a869081d">v1</a>)
<a name="l02845"></a>02845                     <a class="code" href="../../da/d31/paint__vertex_8c.html#abbcd32ea22c4ffce108777adf33600c7">CPYCOL</a>(mc, mlc);
<a name="l02846"></a>02846                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ml-&gt;v == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#a3e56f10b57b97167b3db97024920f693">v2</a>)
<a name="l02847"></a>02847                     <a class="code" href="../../da/d31/paint__vertex_8c.html#abbcd32ea22c4ffce108777adf33600c7">CPYCOL</a>(mc + 1, mlc);
<a name="l02848"></a>02848                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ml-&gt;v == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ac3bd1c8c8cb82e73685b9bfead2b30da">v3</a>)
<a name="l02849"></a>02849                     <a class="code" href="../../da/d31/paint__vertex_8c.html#abbcd32ea22c4ffce108777adf33600c7">CPYCOL</a>(mc + 2, mlc);
<a name="l02850"></a>02850                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a> &amp;&amp; ml-&gt;v == mf-&gt;<a class="code" href="../../d6/da0/structMFace.html#ab3fb5a76f4c838226244c710af79e3fc">v4</a>)
<a name="l02851"></a>02851                     <a class="code" href="../../da/d31/paint__vertex_8c.html#abbcd32ea22c4ffce108777adf33600c7">CPYCOL</a>(mc + 3, mlc);
<a name="l02852"></a>02852 
<a name="l02853"></a>02853             }
<a name="l02854"></a>02854         }
<a name="l02855"></a>02855 <span class="preprocessor">#undef CPYCOL</span>
<a name="l02856"></a>02856 <span class="preprocessor"></span>    }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858 }
<a name="l02859"></a>02859 
<a name="l02860"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3b96c19ec8a8f474ec30566783611719">02860</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b96c19ec8a8f474ec30566783611719">vpaint_stroke_update_step</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">struct</span> <a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke, <a class="code" href="../../dd/d80/structPointerRNA.html">PointerRNA</a> *itemptr)
<a name="l02861"></a>02861 {
<a name="l02862"></a>02862     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02863"></a>02863     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C);
<a name="l02864"></a>02864     <span class="keyword">struct </span><a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vpd = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a9ba72ca33d4e779560e62236d11ca03a">paint_stroke_mode_data</a>(stroke);
<a name="l02865"></a>02865     <a class="code" href="../../de/d1e/structVPaint.html">VPaint</a> *vp = ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a>;
<a name="l02866"></a>02866     <a class="code" href="../../d1/d9f/structBrush.html">Brush</a> *brush = <a class="code" href="../../d8/d86/BKE__paint_8h.html#abc920423e2205663f7131ab5d7eb9eaa">paint_brush</a>(&amp;vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a91639c084be23729115954704b03c518">paint</a>);
<a name="l02867"></a>02867     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> *vc = &amp;vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#adf41f2162f21ab25c41b16445e786b56">vc</a>;
<a name="l02868"></a>02868     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a8c8d7f1222ef72f73849512aa5ee0372">obact</a>;
<a name="l02869"></a>02869     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l02870"></a>02870     <span class="keywordtype">float</span> mat[4][4];
<a name="l02871"></a>02871     <span class="keywordtype">int</span> *<a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">indexar</a> = vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">indexar</a>;
<a name="l02872"></a>02872     <span class="keywordtype">int</span> <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>, index;
<a name="l02873"></a>02873     <span class="keywordtype">float</span> mval[2];
<a name="l02874"></a>02874 
<a name="l02875"></a>02875     <span class="keyword">const</span> <span class="keywordtype">float</span> pressure = <a class="code" href="../../d3/d10/rna__access_8c.html#a99bfb3295a4df6fef29f16924fd24c79">RNA_float_get</a>(itemptr, <span class="stringliteral">&quot;pressure&quot;</span>);
<a name="l02876"></a>02876     <span class="keyword">const</span> <span class="keywordtype">float</span> brush_size_pressure = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a41e7464811e837c486e4e2d48bf74190">brush_size</a>(scene, brush) * (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a9246972f773b7523f024e5a58488f328">brush_use_size_pressure</a>(scene, brush) ? pressure : 1.0f);
<a name="l02877"></a>02877     <span class="keyword">const</span> <span class="keywordtype">float</span> brush_alpha_pressure = <a class="code" href="../../da/dc9/BKE__brush_8h.html#a9259092b9744db0b14e8a59954356d20">brush_alpha</a>(scene, brush) * (<a class="code" href="../../da/dc9/BKE__brush_8h.html#a95861f4c554f9f75699c42eff6b4cff1">brush_use_alpha_pressure</a>(scene, brush) ? pressure : 1.0f);
<a name="l02878"></a>02878 
<a name="l02879"></a>02879     <a class="code" href="../../d3/d10/rna__access_8c.html#a5d95f86ccce314676ae750034fb56709">RNA_float_get_array</a>(itemptr, <span class="stringliteral">&quot;mouse&quot;</span>, mval);
<a name="l02880"></a>02880 
<a name="l02881"></a>02881     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l02882"></a>02882             
<a name="l02883"></a>02883     <span class="comment">/* load projection matrix */</span>
<a name="l02884"></a>02884     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02885"></a>02885 
<a name="l02886"></a>02886     mval[0] -= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l02887"></a>02887     mval[1] -= vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l02888"></a>02888 
<a name="l02889"></a>02889             
<a name="l02890"></a>02890     <span class="comment">/* which faces are involved */</span>
<a name="l02891"></a>02891     <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad38f734cc540a73ad8e07a2271511299">VP_AREA</a>) {
<a name="l02892"></a>02892         totindex = <a class="code" href="../../da/d31/paint__vertex_8c.html#a17f80a1f9e46cc648cd4e20cd1115ce1">sample_backbuf_area</a>(vc, indexar, me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>, mval[0], mval[1], brush_size_pressure);
<a name="l02893"></a>02893     }
<a name="l02894"></a>02894     <span class="keywordflow">else</span> {
<a name="l02895"></a>02895         indexar[0] = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#aba40efd013e32afa64b4059112bcaede">view3d_sample_backbuf</a>(vc, mval[0], mval[1]);
<a name="l02896"></a>02896         <span class="keywordflow">if</span> (indexar[0]) totindex = 1;
<a name="l02897"></a>02897         <span class="keywordflow">else</span> totindex = 0;
<a name="l02898"></a>02898     }
<a name="l02899"></a>02899             
<a name="l02900"></a>02900             
<a name="l02901"></a>02901     <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="../../de/d1e/structVPaint.html#a0420d302f468d8c183d98806e7cadf38">flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9d18b0b61dcda19369a057a82a723317">VP_COLINDEX</a>) {
<a name="l02902"></a>02902         <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02903"></a>02903             <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02904"></a>02904                 <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (indexar[index] - 1);
<a name="l02905"></a>02905                         
<a name="l02906"></a>02906                 <span class="keywordflow">if</span> (mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#afaa3e20eadbc3dfe52d47c0a10dd0c7f">mat_nr</a> != ob-&gt;<a class="code" href="../../de/de7/structObject.html#a7f7913949235b61d1cd0b8f343d0cbfc">actcol</a> - 1) {
<a name="l02907"></a>02907                     indexar[index] = 0;
<a name="l02908"></a>02908                 }
<a name="l02909"></a>02909             }
<a name="l02910"></a>02910         }
<a name="l02911"></a>02911     }
<a name="l02912"></a>02912 
<a name="l02913"></a>02913     <span class="keywordflow">if</span> ((me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#ae2c6ba156c41b5bc56a253cd8bf33b13">ME_EDIT_PAINT_MASK</a>) &amp;&amp; me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) {
<a name="l02914"></a>02914         <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02915"></a>02915             <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02916"></a>02916                 <a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *mpoly = ((<a class="code" href="../../d2/dca/structMPoly.html">MPoly</a> *)me-&gt;<a class="code" href="../../da/d29/structMesh.html#aed0e442be859c2a4f8067eda4f81c064">mpoly</a>) + (indexar[index] - 1);
<a name="l02917"></a>02917                         
<a name="l02918"></a>02918                 <span class="keywordflow">if</span> ((mpoly-&gt;<a class="code" href="../../d2/dca/structMPoly.html#a208492a1db60c4d108f51334e5e80d53">flag</a> &amp; <a class="code" href="../../d4/d36/DNA__meshdata__types_8h.html#a893637457f3055c76b2bddc12f1b5d52">ME_FACE_SEL</a>) == 0)
<a name="l02919"></a>02919                     indexar[index] = 0;
<a name="l02920"></a>02920             }                   
<a name="l02921"></a>02921         }
<a name="l02922"></a>02922     }
<a name="l02923"></a>02923     
<a name="l02924"></a>02924     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a487370fb68e22a1a67cd8b6be935ecbd">swap_m4m4</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, mat);
<a name="l02925"></a>02925 
<a name="l02926"></a>02926             
<a name="l02927"></a>02927     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d2/d6c/mball_8c.html#a16996c17496386a947d510a19ad1facc">totindex</a>; index++) {
<a name="l02928"></a>02928                 
<a name="l02929"></a>02929         <span class="keywordflow">if</span> (indexar[index] &amp;&amp; indexar[index] &lt;= me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac26ffb56473851155dc77789a012c5d9">totpoly</a>) {
<a name="l02930"></a>02930             <a class="code" href="../../da/d31/paint__vertex_8c.html#a6b702f5f09d0e5f2213cb6f6e3a03168">vpaint_paint_poly</a>(vp, vpd, ob, indexar[index] - 1, mval, brush_size_pressure, brush_alpha_pressure);
<a name="l02931"></a>02931         }
<a name="l02932"></a>02932     }
<a name="l02933"></a>02933         
<a name="l02934"></a>02934     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a487370fb68e22a1a67cd8b6be935ecbd">swap_m4m4</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a8ab36b8b8caeec087fd9595c33e90775">persmat</a>, mat);
<a name="l02935"></a>02935 
<a name="l02936"></a>02936     <span class="comment">/* was disabled because it is slow, but necessary for blur */</span>
<a name="l02937"></a>02937     <span class="keywordflow">if</span> (brush-&gt;<a class="code" href="../../d1/d9f/structBrush.html#a39f49ca455ad1777234edc966baea800">vertexpaint_tool</a> == <a class="code" href="../../da/d37/DNA__brush__types_8h.html#aaa1faf9307efabe7471b4443de4ba66ba0e4deaf18a5ba197d6063e84bf122bbc">PAINT_BLEND_BLUR</a>) {
<a name="l02938"></a>02938         <span class="keywordtype">int</span> do_tessface = vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a>;
<a name="l02939"></a>02939         <a class="code" href="../../da/d31/paint__vertex_8c.html#a887cb11d1077c709a1127223191dd8cb">do_shared_vertexcol</a>(me, do_tessface);
<a name="l02940"></a>02940     }
<a name="l02941"></a>02941 
<a name="l02942"></a>02942     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(vc-&gt;<a class="code" href="../../d8/d30/structViewContext.html#a6f44641101d37b3ad843fabd70e185c8">ar</a>);
<a name="l02943"></a>02943 
<a name="l02944"></a>02944     <span class="keywordflow">if</span> (vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#aa3876d91ffe344b4d654e5b811031af6">use_fast_update</a> == <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l02945"></a>02945         <span class="comment">/* recalculate modifier stack to get new colors, slow,</span>
<a name="l02946"></a>02946 <span class="comment">         * avoid this if we can! */</span>
<a name="l02947"></a>02947         <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>, 0);
<a name="l02948"></a>02948     }
<a name="l02949"></a>02949 }
<a name="l02950"></a>02950 
<a name="l02951"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a4b87842f2a620f6b680317768283af52">02951</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a4b87842f2a620f6b680317768283af52">vpaint_stroke_done</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <span class="keyword">struct</span> <a class="code" href="../../d1/d68/structPaintStroke.html">PaintStroke</a> *stroke)
<a name="l02952"></a>02952 {
<a name="l02953"></a>02953     <a class="code" href="../../d0/d65/structToolSettings.html">ToolSettings</a> *ts = <a class="code" href="../../df/d01/BKE__context_8h.html#ae91ddb50e1e5a0888a5636ce717a8ef3">CTX_data_tool_settings</a>(C);
<a name="l02954"></a>02954     <span class="keyword">struct </span><a class="code" href="../../d6/df6/structVPaintData.html">VPaintData</a> *vpd = <a class="code" href="../../d3/d6c/paint__intern_8h.html#a9ba72ca33d4e779560e62236d11ca03a">paint_stroke_mode_data</a>(stroke);
<a name="l02955"></a>02955     
<a name="l02956"></a>02956     <span class="keywordflow">if</span> (vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a>)
<a name="l02957"></a>02957         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#ae3d54b34921e694a4918b5aa5eac4895">vertexcosnos</a>);
<a name="l02958"></a>02958     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a41407ee85eb924c21e947ea7405e8031">indexar</a>);
<a name="l02959"></a>02959     
<a name="l02960"></a>02960     <span class="comment">/* frees prev buffer */</span>
<a name="l02961"></a>02961     <a class="code" href="../../da/d31/paint__vertex_8c.html#ab1c54077920cada220331475a8e9b14b">copy_vpaint_prev</a>(ts-&gt;<a class="code" href="../../d0/d65/structToolSettings.html#a71507c50ae356599dfb4bafef460474c">vpaint</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l02962"></a>02962 
<a name="l02963"></a>02963     <span class="keywordflow">if</span> (vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>) {
<a name="l02964"></a>02964         <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(vpd-&gt;<a class="code" href="../../d6/df6/structVPaintData.html#a101d67d414d803c13f004fdace71b07e">polyfacemap_arena</a>);
<a name="l02965"></a>02965     }
<a name="l02966"></a>02966 
<a name="l02967"></a>02967     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vpd);
<a name="l02968"></a>02968 }
<a name="l02969"></a>02969 
<a name="l02970"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3f261463221e65113a7ae8e4b91fb211">02970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a3f261463221e65113a7ae8e4b91fb211">vpaint_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02971"></a>02971 {
<a name="l02972"></a>02972     
<a name="l02973"></a>02973     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#ae31a7a92d1389c10082e2ce234a06b35">paint_stroke_new</a>(C, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../da/d31/paint__vertex_8c.html#a7869bfe75adf1d0f64a7f813d0bf39b3">vpaint_stroke_test_start</a>,
<a name="l02974"></a>02974                                       <a class="code" href="../../da/d31/paint__vertex_8c.html#a3b96c19ec8a8f474ec30566783611719">vpaint_stroke_update_step</a>,
<a name="l02975"></a>02975                                       <a class="code" href="../../da/d31/paint__vertex_8c.html#a4b87842f2a620f6b680317768283af52">vpaint_stroke_done</a>, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>);
<a name="l02976"></a>02976     
<a name="l02977"></a>02977     <span class="comment">/* add modal handler */</span>
<a name="l02978"></a>02978     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l02979"></a>02979 
<a name="l02980"></a>02980     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a75c88e62b43b663e9a0cf6cfbede007c">type</a>-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a>(C, op, event);
<a name="l02981"></a>02981     
<a name="l02982"></a>02982     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02983"></a>02983 }
<a name="l02984"></a>02984 
<a name="l02985"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a756d8170391fa2b086e6f8f25b78aaf6">02985</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a756d8170391fa2b086e6f8f25b78aaf6">vpaint_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02986"></a>02986 {
<a name="l02987"></a>02987     <a class="code" href="../../d3/d6c/paint__intern_8h.html#a6380e1d9d16a0914b1bda4f71e152f92">paint_stroke_cancel</a>(C, op);
<a name="l02988"></a>02988 
<a name="l02989"></a>02989     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02990"></a>02990 }
<a name="l02991"></a>02991 
<a name="l02992"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a3274a289962d803dccdaa0da0c247b12">02992</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a6ca92b3fb6687989889d7c7562e3a71b">PAINT_OT_vertex_paint</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l02993"></a>02993 {
<a name="l02994"></a>02994     <span class="comment">/* identifiers */</span>
<a name="l02995"></a>02995     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Vertex Paint&quot;</span>;
<a name="l02996"></a>02996     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_vertex_paint&quot;</span>;
<a name="l02997"></a>02997     
<a name="l02998"></a>02998     <span class="comment">/* api callbacks */</span>
<a name="l02999"></a>02999     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a3f261463221e65113a7ae8e4b91fb211">vpaint_invoke</a>;
<a name="l03000"></a>03000     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#abbdd9002992ed83f68ea1c37eca16f28">paint_stroke_modal</a>;
<a name="l03001"></a>03001     <span class="comment">/* ot-&gt;exec = vpaint_exec; &lt;-- needs stroke property */</span>
<a name="l03002"></a>03002     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d3/d6c/paint__intern_8h.html#ab4a93bb6c2400695e459c87883735b24">vertex_paint_poll</a>;
<a name="l03003"></a>03003     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a756d8170391fa2b086e6f8f25b78aaf6">vpaint_cancel</a>;
<a name="l03004"></a>03004     
<a name="l03005"></a>03005     <span class="comment">/* flags */</span>
<a name="l03006"></a>03006     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l03007"></a>03007 
<a name="l03008"></a>03008     <a class="code" href="../../dc/d7e/rna__define_8c.html#a5861cf8175d4ffb61082e2bbeff84fd0">RNA_def_collection_runtime</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;stroke&quot;</span>, &amp;<a class="code" href="../../de/ddf/RNA__access_8h.html#a0c09154eb5eafa1601572b2cd89cf35a">RNA_OperatorStrokeElement</a>, <span class="stringliteral">&quot;Stroke&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03009"></a>03009 }
<a name="l03010"></a>03010 
<a name="l03011"></a>03011 <span class="comment">/* ********************** weight from bones operator ******************* */</span>
<a name="l03012"></a>03012 
<a name="l03013"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#afc567b87d92a59ea219511327ab8db40">03013</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#afc567b87d92a59ea219511327ab8db40">weight_from_bones_poll</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C)
<a name="l03014"></a>03014 {
<a name="l03015"></a>03015     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l03016"></a>03016 
<a name="l03017"></a>03017     <span class="keywordflow">return</span> (ob &amp;&amp; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a4f90725f5876b309d325c84ae4f5c51b">mode</a> &amp; <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a36fb08f71e0c90da2a0f21518ef0d550a6ab1cede4f6911c8042ca67d0c53b780">OB_MODE_WEIGHT_PAINT</a>) &amp;&amp; <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a3da508ee2e78275014fa2a143c3e6045">modifiers_isDeformedByArmature</a>(ob));
<a name="l03018"></a>03018 }
<a name="l03019"></a>03019 
<a name="l03020"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#a715b27d3eec05b9a6b7572dd178e4e06">03020</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d31/paint__vertex_8c.html#a715b27d3eec05b9a6b7572dd178e4e06">weight_from_bones_exec</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l03021"></a>03021 {
<a name="l03022"></a>03022     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l03023"></a>03023     <a class="code" href="../../de/de7/structObject.html">Object</a> *ob = <a class="code" href="../../df/d01/BKE__context_8h.html#a86fd97bb1e59c64106c001ab29db25c7">CTX_data_active_object</a>(C);
<a name="l03024"></a>03024     <a class="code" href="../../de/de7/structObject.html">Object</a> *armob = <a class="code" href="../../d3/d0f/BKE__modifier_8h.html#a3da508ee2e78275014fa2a143c3e6045">modifiers_isDeformedByArmature</a>(ob);
<a name="l03025"></a>03025     <a class="code" href="../../da/d29/structMesh.html">Mesh</a> *me = ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l03026"></a>03026     <span class="keywordtype">int</span> type = <a class="code" href="../../d3/d10/rna__access_8c.html#adf28976d740b269f80b747eb62fea6ce">RNA_enum_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l03027"></a>03027 
<a name="l03028"></a>03028     <a class="code" href="../../de/dbc/editarmature_8c.html#a5b4d844c910c018e82212d0496e5a925">create_vgroups_from_armature</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a07dcf0c512e769205201c34c254f4049">reports</a>, scene, ob, armob, type, (me-&gt;<a class="code" href="../../da/d29/structMesh.html#a8e2607f7fddc692e3082aac5b180c35e">editflag</a> &amp; <a class="code" href="../../df/d96/DNA__mesh__types_8h.html#a5932a31a907f7856e4b33c8617982df4">ME_EDIT_MIRROR_X</a>));
<a name="l03029"></a>03029 
<a name="l03030"></a>03030     <a class="code" href="../../d2/da0/BKE__depsgraph_8h.html#a70d8c170e1f4bbcc010d94405d6a9817">DAG_id_tag_update</a>(&amp;me-&gt;<a class="code" href="../../da/d29/structMesh.html#ac10779fc3e00d6d5b8f7ea32adaedd43">id</a>, 0);
<a name="l03031"></a>03031     <a class="code" href="../../df/db0/wm__event__system_8c.html#a6a6bfb771c3639a4f1038d56a3fa0217">WM_event_add_notifier</a>(C, <a class="code" href="../../d4/ddc/WM__types_8h.html#a185e97978ae45ed1d3b3ff4d442c567c">NC_GEOM</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a25383f13197df9bda823d34736df4d82">ND_DATA</a>, me);
<a name="l03032"></a>03032 
<a name="l03033"></a>03033     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l03034"></a>03034 }
<a name="l03035"></a>03035 
<a name="l03036"></a><a class="code" href="../../da/d31/paint__vertex_8c.html#ab067db85b4a6ababad45838aae96afc4">03036</a> <span class="keywordtype">void</span> <a class="code" href="../../d3/d6c/paint__intern_8h.html#a0b5c2dfdbc9882333b3c921ffb98acbf">PAINT_OT_weight_from_bones</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03037"></a>03037 {
<a name="l03038"></a>03038     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> type_items[] = {
<a name="l03039"></a>03039         {<a class="code" href="../../d1/d98/ED__armature_8h.html#aee05c190ea005c6c7fb413a09b9c1afb">ARM_GROUPS_AUTO</a>, <span class="stringliteral">&quot;AUTOMATIC&quot;</span>, 0, <span class="stringliteral">&quot;Automatic&quot;</span>, <span class="stringliteral">&quot;Automatic weights froms bones&quot;</span>},
<a name="l03040"></a>03040         {<a class="code" href="../../d1/d98/ED__armature_8h.html#aa8288c163d5238171f2f390a42531796">ARM_GROUPS_ENVELOPE</a>, <span class="stringliteral">&quot;ENVELOPES&quot;</span>, 0, <span class="stringliteral">&quot;From Envelopes&quot;</span>, <span class="stringliteral">&quot;Weights from envelopes with user defined radius&quot;</span>},
<a name="l03041"></a>03041         {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}};
<a name="l03042"></a>03042 
<a name="l03043"></a>03043     <span class="comment">/* identifiers */</span>
<a name="l03044"></a>03044     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Weight from Bones&quot;</span>;
<a name="l03045"></a>03045     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;PAINT_OT_weight_from_bones&quot;</span>;
<a name="l03046"></a>03046     
<a name="l03047"></a>03047     <span class="comment">/* api callbacks */</span>
<a name="l03048"></a>03048     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#acf19aee20badd3857d211524b081a939">exec</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#a715b27d3eec05b9a6b7572dd178e4e06">weight_from_bones_exec</a>;
<a name="l03049"></a>03049     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../d6/dae/wm__operators_8c.html#a926375c583166540cfa96299e433e071">WM_menu_invoke</a>;
<a name="l03050"></a>03050     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../da/d31/paint__vertex_8c.html#afc567b87d92a59ea219511327ab8db40">weight_from_bones_poll</a>;
<a name="l03051"></a>03051     
<a name="l03052"></a>03052     <span class="comment">/* flags */</span>
<a name="l03053"></a>03053     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a>;
<a name="l03054"></a>03054 
<a name="l03055"></a>03055     <span class="comment">/* properties */</span>
<a name="l03056"></a>03056     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ad2ecde05b67ff7682699554ee5a0bfc9">prop</a> = <a class="code" href="../../dc/d7e/rna__define_8c.html#af2ad58c3924113813903fe1b6a2bd5ac">RNA_def_enum</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;type&quot;</span>, type_items, 0, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;Method to use for assigning weights&quot;</span>);
<a name="l03057"></a>03057 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:43 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
