<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: envmap.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">envmap.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/dd4/envmap_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* </span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00006"></a>00006 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00007"></a>00007 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00008"></a>00008 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment"> *</span>
<a name="l00015"></a>00015 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00016"></a>00016 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00017"></a>00017 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00020"></a>00020 <span class="comment"> * All rights reserved.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * Contributors: 2004/2005/2006 Blender Foundation, full recode</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00025"></a>00025 <span class="comment"> */</span>
<a name="l00026"></a>00026 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="comment">/* external modules: */</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dbb/BLI__threads_8h.html">BLI_threads.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html" title="Contains defines and structs used throughout the imbuf module.">IMB_imbuf_types.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d49/IMB__imbuf_8h.html">IMB_imbuf.h</a>&quot;</span>        <span class="comment">/* for rectcpy */</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d94/DNA__image__types_8h.html">DNA_image_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../da/ddf/DNA__texture__types_8h.html">DNA_texture_types.h</a>&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d77/BKE__image_8h.html">BKE_image.h</a>&quot;</span>   <span class="comment">// BKE_write_ibuf </span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d66/BKE__texture_8h.html">BKE_texture.h</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">/* this module */</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/df5/renderpipeline_8h.html">renderpipeline.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/d3f/envmap_8h.html">envmap.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d0e/rendercore_8h.html">rendercore.h</a>&quot;</span> 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db6/renderdatabase_8h.html">renderdatabase.h</a>&quot;</span> 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9d/zbuf_8h.html">zbuf.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/def/initrender_8h.html">initrender.h</a>&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="../../da/dd4/envmap_8c.html#a03376d68f1811f46e34f42b1b51784d1">00073</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a03376d68f1811f46e34f42b1b51784d1">envmap_split_ima</a>(<a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env, <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075     <span class="keywordtype">int</span> dx, part;
<a name="l00076"></a>00076     
<a name="l00077"></a>00077     <span class="comment">/* after lock we test cube[1], if set the other thread has done it fine */</span>
<a name="l00078"></a>00078     <a class="code" href="../../df/dbb/BLI__threads_8h.html#aeb7fa826429971a6eb6074249ad39a0b">BLI_lock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[1]==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(env);   
<a name="l00082"></a>00082     
<a name="l00083"></a>00083         dx= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>;
<a name="l00084"></a>00084         dx/= 2;
<a name="l00085"></a>00085         <span class="keywordflow">if</span> (3*dx == ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>) {
<a name="l00086"></a>00086             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a> = <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac9fcd115b55fc03e03cdb3792f21a63a">ENV_CUBE</a>;
<a name="l00087"></a>00087             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a91c1a681090be4a118bf3461bc8125dd">ENV_OSA</a>;
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> == ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a>) {
<a name="l00090"></a>00090             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a> = <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af7153b716c4378b1fa073540f7d6350d">ENV_PLANE</a>;
<a name="l00091"></a>00091             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a91c1a681090be4a118bf3461bc8125dd">ENV_OSA</a>;
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093         <span class="keywordflow">else</span> {
<a name="l00094"></a>00094             printf(<span class="stringliteral">&quot;Incorrect envmap size\n&quot;</span>);
<a name="l00095"></a>00095             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= 0;
<a name="l00096"></a>00096             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8aa958f7d9894d2941bf32c82625a50a">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>= 0;
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098         
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>) {
<a name="l00100"></a>00100             <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac9fcd115b55fc03e03cdb3792f21a63a">ENV_CUBE</a>) {
<a name="l00101"></a>00101                 <span class="keywordflow">for</span> (part=0; part&lt;6; part++) {
<a name="l00102"></a>00102                     env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[part]= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(dx, dx, 24, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>);
<a name="l00103"></a>00103                 }
<a name="l00104"></a>00104                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0484659502ef804f57a4dd6c9d3b6d6c">IMB_float_from_rect</a>(ibuf);
<a name="l00105"></a>00105                 
<a name="l00106"></a>00106                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[0], ibuf, 
<a name="l00107"></a>00107                     0, 0, 0, 0, dx, dx);
<a name="l00108"></a>00108                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[1], ibuf, 
<a name="l00109"></a>00109                     0, 0, dx, 0, dx, dx);
<a name="l00110"></a>00110                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[2], ibuf, 
<a name="l00111"></a>00111                     0, 0, 2*dx, 0, dx, dx);
<a name="l00112"></a>00112                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[3], ibuf, 
<a name="l00113"></a>00113                     0, 0, 0, dx, dx, dx);
<a name="l00114"></a>00114                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[4], ibuf, 
<a name="l00115"></a>00115                     0, 0, dx, dx, dx, dx);
<a name="l00116"></a>00116                 <a class="code" href="../../dd/d38/iff_8h.html#a8449fd51516d813f09f2d26d07aac6e2">IMB_rectcpy</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[5], ibuf, 
<a name="l00117"></a>00117                     0, 0, 2*dx, dx, dx, dx);
<a name="l00118"></a>00118                 
<a name="l00119"></a>00119             }
<a name="l00120"></a>00120             <span class="keywordflow">else</span> { <span class="comment">/* ENV_PLANE */</span>
<a name="l00121"></a>00121                 env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[1]= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a094bab2aa339f34922893e1d6d617c28">IMB_dupImBuf</a>(ibuf);
<a name="l00122"></a>00122                 <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a0484659502ef804f57a4dd6c9d3b6d6c">IMB_float_from_rect</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[1]);
<a name="l00123"></a>00123             }
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125     }   
<a name="l00126"></a>00126     <a class="code" href="../../df/dbb/BLI__threads_8h.html#add77b383686cdf9514286b56e3c7939c">BLI_unlock_thread</a>(<a class="code" href="../../df/dbb/BLI__threads_8h.html#a1125aa0a8e5847f859fc07cbfba46099">LOCK_IMAGE</a>);
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00130"></a>00130 <span class="comment">/* ****************** RENDER ********************** */</span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="comment">/* copy current render */</span>
<a name="l00133"></a><a class="code" href="../../da/dd4/envmap_8c.html#a4925a894e3fc645bca4903ca97144aea">00133</a> <span class="keyword">static</span> <a class="code" href="../../d6/d7a/structRender.html">Render</a> *<a class="code" href="../../da/dd4/envmap_8c.html#a4925a894e3fc645bca4903ca97144aea">envmap_render_copy</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *envre;
<a name="l00136"></a>00136     <span class="keywordtype">float</span> viewscale;
<a name="l00137"></a>00137     <span class="keywordtype">int</span> cuberes;
<a name="l00138"></a>00138     
<a name="l00139"></a>00139     envre= <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#aa539d2c227f40725b93fe2df94a76bd1">RE_NewRender</a>(<span class="stringliteral">&quot;Envmap&quot;</span>);
<a name="l00140"></a>00140     
<a name="l00141"></a>00141     env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac498a020e3facf763c53e7adb6fc83e6">lastsize</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a>;
<a name="l00142"></a>00142     cuberes = (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a0add4e8ee1847b8daf63ed8982bfce73">cuberes</a> * re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a>) / 100;
<a name="l00143"></a>00143     cuberes &amp;= 0xFFFC;
<a name="l00144"></a>00144     
<a name="l00145"></a>00145     <span class="comment">/* this flag has R_ZTRA in it for example */</span>
<a name="l00146"></a>00146     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aaf0aa291e1d2f87a5218ea0cc24e2845">flag</a>;
<a name="l00147"></a>00147     
<a name="l00148"></a>00148     <span class="comment">/* set up renderdata */</span>
<a name="l00149"></a>00149     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>;
<a name="l00150"></a>00150     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp;= ~(<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a1766e76e06a3443cee3f58368e490b17">R_BORDER</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a734c49fbcb5788988d667052995f4fa0">R_PANORAMA</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ad1461325b45cf05ec52533e0b5fc9c5b">R_ORTHO</a> | <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#ab02952cbeca884d224a5b0f51ac99d6a">R_MBLUR</a>);
<a name="l00151"></a>00151     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a235b7b4bed2d2d73189d3e12c219672a">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a235b7b4bed2d2d73189d3e12c219672a">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00152"></a>00152     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a4795ac457722fc5af529181f2c1259ab">filtertype</a>= 0;
<a name="l00153"></a>00153     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ade972d7802ccc8bd375faec2bac270a1">xparts</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a663640f6f699dd2991f6866804d3bfa7">yparts</a>= 2;
<a name="l00154"></a>00154     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a>= 100;
<a name="l00155"></a>00155     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a1f4c395a81051abd055a1014e02c9f00">yasp</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a7c97c9fb3ae2b02bd4ccb8c76d68811a">xasp</a>= 1;
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a153b5eeffd3b7a00c6ad23c8dbd92f93">RE_InitState</a>(envre, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, cuberes, cuberes, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00158"></a>00158     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>;    <span class="comment">/* unsure about this... */</span>
<a name="l00159"></a>00159     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="comment">/* view stuff in env render */</span>
<a name="l00162"></a>00162     viewscale= (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a> == <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af7153b716c4378b1fa073540f7d6350d">ENV_PLANE</a>)? env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ad779e991bd439bb9c4b571371e774a11">viewscale</a>: 1.0f;
<a name="l00163"></a>00163     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#af741f94c5a56819de2dfebd6c697862a">RE_SetEnvmapCamera</a>(envre, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>, viewscale, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a460f6ed1e05075c82b6d1288f7d9940b">clipsta</a>, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a91e31b5f62ced826dae5deafb366beef">clipend</a>);
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     <span class="comment">/* callbacks */</span>
<a name="l00166"></a>00166     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a72179716df11df6b77a974a1156f57dd">display_draw</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a72179716df11df6b77a974a1156f57dd">display_draw</a>;
<a name="l00167"></a>00167     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#afaba064a7d8ffb0da7099c0636ece2b6">ddh</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#afaba064a7d8ffb0da7099c0636ece2b6">ddh</a>;
<a name="l00168"></a>00168     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>;
<a name="l00169"></a>00169     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>;
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     <span class="comment">/* and for the evil stuff; copy the database... */</span>
<a name="l00172"></a>00172     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>;
<a name="l00173"></a>00173     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>;
<a name="l00174"></a>00174     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>;
<a name="l00175"></a>00175     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>;
<a name="l00176"></a>00176     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>;
<a name="l00177"></a>00177     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>;
<a name="l00178"></a>00178     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>;
<a name="l00179"></a>00179     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>;
<a name="l00180"></a>00180     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a04f2cd3c65ec3afe3adfc36bdb95a36e">customdata_names</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a04f2cd3c65ec3afe3adfc36bdb95a36e">customdata_names</a>;
<a name="l00181"></a>00181     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>;
<a name="l00182"></a>00182     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#af99d72b7ba1b97e0203e041b7029ec5a">totinstance</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#af99d72b7ba1b97e0203e041b7029ec5a">totinstance</a>;
<a name="l00183"></a>00183     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>;
<a name="l00184"></a>00184     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>;
<a name="l00185"></a>00185     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>;
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     <span class="keywordflow">return</span> envre;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="../../da/dd4/envmap_8c.html#a6fc2fe2fa5354a458084daa3971a8b3a">00190</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a6fc2fe2fa5354a458084daa3971a8b3a">envmap_free_render_copy</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *envre)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a9cf11658281c405c1fe0a98d865ea192">totvlak</a>= 0;
<a name="l00194"></a>00194     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa9e49d576e3994e5119be9b610debfb2">totvert</a>= 0;
<a name="l00195"></a>00195     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a5ee34e6e648056348d483448775002e4">tothalo</a>= 0;
<a name="l00196"></a>00196     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a8f4cf9403d6098728c81ed66d1aa46f9">totstrand</a>= 0;
<a name="l00197"></a>00197     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a642efed101b49d25a9119f31c2058cf4">totlamp</a>= 0;
<a name="l00198"></a>00198     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#af99d72b7ba1b97e0203e041b7029ec5a">totinstance</a>= 0;
<a name="l00199"></a>00199     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a63e2fc51bd4a6e407798ef45d9a9ae7b">sortedhalos</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00200"></a>00200     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00201"></a>00201     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00202"></a>00202     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a04f2cd3c65ec3afe3adfc36bdb95a36e">customdata_names</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a04f2cd3c65ec3afe3adfc36bdb95a36e">customdata_names</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00203"></a>00203     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4bc2ddf7821f88b9015d0b74e05a3fdb">raytree</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00204"></a>00204     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00205"></a>00205     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a55b0e234a4006d20dc83fb8e04525e4a">objectinstance</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00206"></a>00206     envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a97c07b72c0c373325d1ecd462e756650">qmcsamplers</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00207"></a>00207     
<a name="l00208"></a>00208     <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#a0db6620f4b0a23e27593a2d50278946e">RE_FreeRender</a>(envre);
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="../../da/dd4/envmap_8c.html#a64c6990d1a0d1d9dd2a61d414f04499a">00213</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a64c6990d1a0d1d9dd2a61d414f04499a">envmap_transmatrix</a>(<span class="keywordtype">float</span> mat[][4], <span class="keywordtype">int</span> part)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215     <span class="keywordtype">float</span> tmat[4][4], eul[3], rotmat[4][4];
<a name="l00216"></a>00216     
<a name="l00217"></a>00217     eul[0]= eul[1]= eul[2]= 0.0;
<a name="l00218"></a>00218     
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (part==0) {          <span class="comment">/* neg z */</span>
<a name="l00220"></a>00220         ;
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part==1) { <span class="comment">/* pos z */</span>
<a name="l00223"></a>00223         eul[0]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part==2) { <span class="comment">/* pos y */</span>
<a name="l00226"></a>00226         eul[0]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part==3) { <span class="comment">/* neg x */</span>
<a name="l00229"></a>00229         eul[0]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00230"></a>00230         eul[2]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part==4) { <span class="comment">/* neg y */</span>
<a name="l00233"></a>00233         eul[0]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00234"></a>00234         eul[2]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>;
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236     <span class="keywordflow">else</span> {              <span class="comment">/* pos x */</span>
<a name="l00237"></a>00237         eul[0]= <a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00238"></a>00238         eul[2]= -<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>/2.0;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     
<a name="l00241"></a>00241     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmat, mat);
<a name="l00242"></a>00242     <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#afc3de3a2327040557f8b94047b2a8a96">eul_to_mat4</a>( rotmat,eul);
<a name="l00243"></a>00243     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a9d41e7b216b06f815fb05ed4cb8474e6">mul_serie_m4</a>(mat, tmat, rotmat,
<a name="l00244"></a>00244                      <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00245"></a>00245                      <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../da/dd4/envmap_8c.html#a82e4fdbffd63dc5eb807a1d3053efafc">00250</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a82e4fdbffd63dc5eb807a1d3053efafc">env_rotate_scene</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">float</span> mat[][4], <span class="keywordtype">int</span> mode)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l00253"></a>00253     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00254"></a>00254     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi;
<a name="l00255"></a>00255     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00256"></a>00256     <a class="code" href="../../d3/dad/structHaloRen.html">HaloRen</a> *har = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00257"></a>00257     <span class="keywordtype">float</span> imat[3][3], pmat[4][4], smat[4][4], tmat[4][4], cmat[3][3], tmpmat[4][4];
<a name="l00258"></a>00258     <span class="keywordtype">int</span> a;
<a name="l00259"></a>00259     
<a name="l00260"></a>00260     <span class="keywordflow">if</span> (mode==0) {
<a name="l00261"></a>00261         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(tmat, mat);
<a name="l00262"></a>00262         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, tmat);
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     <span class="keywordflow">else</span> {
<a name="l00265"></a>00265         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmat, mat);
<a name="l00266"></a>00266         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, mat);
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">for</span> (obi=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae9493f5945ca8dc6441205e2229fba65">instancetable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obi; obi=obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#af0e2404b42ecb635aef77475aed0e56a">next</a>) {
<a name="l00270"></a>00270         <span class="comment">/* append or set matrix depending on dupli */</span>
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp; <a class="code" href="../../db/d00/render__types_8h.html#a7efb8e434f4d2e625f834a87826f887e">R_DUPLI_TRANSFORMED</a>) {
<a name="l00272"></a>00272             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmpmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l00273"></a>00273             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, tmat, tmpmat);
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode==1)
<a name="l00276"></a>00276             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>, tmat);
<a name="l00277"></a>00277         <span class="keywordflow">else</span>
<a name="l00278"></a>00278             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a573114dda84526c82734926c26953eb0">unit_m4</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(cmat, obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#aab8aa131c007124b23bffc90c2ad10eb">mat</a>);
<a name="l00281"></a>00281         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#acc9f8cab0ea2c5993f2c9bdeaca6b788">invert_m3_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>, cmat);
<a name="l00282"></a>00282         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a080d97cdcce75d11383f70663b6fb05b">nmat</a>);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <span class="comment">/* indicate the renderer has to use transform matrices */</span>
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (mode==0)
<a name="l00286"></a>00286             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#a558034f1518145a4b75493e6a9c14bd8">R_ENV_TRANSFORMED</a>;
<a name="l00287"></a>00287         <span class="keywordflow">else</span>
<a name="l00288"></a>00288             obi-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a656ad504f1a3cb006338214f386a71a0">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#a558034f1518145a4b75493e6a9c14bd8">R_ENV_TRANSFORMED</a>;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290     
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>) {
<a name="l00293"></a>00293         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a4d832648c2a938fdd1a25f64b0c64b49">tothalo</a>; a++) {
<a name="l00294"></a>00294             <span class="keywordflow">if</span> ((a &amp; 255)==0) har= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a757e0854631bc43f0888cca915688d10">bloha</a>[a&gt;&gt;8];
<a name="l00295"></a>00295             <span class="keywordflow">else</span> har++;
<a name="l00296"></a>00296         
<a name="l00297"></a>00297             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(tmat, har-&gt;<a class="code" href="../../d3/dad/structHaloRen.html#ae6c5e70c8bccbccfa3e5eef8bc8b2529">co</a>);
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300     
<a name="l00301"></a>00301     <span class="keywordflow">for</span> (go=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>) {
<a name="l00302"></a>00302         lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l00303"></a>00303         
<a name="l00304"></a>00304         <span class="comment">/* removed here some horrible code of someone in NaN who tried to fix</span>
<a name="l00305"></a>00305 <span class="comment">         * prototypes... just solved by introducing a correct cmat[3][3] instead</span>
<a name="l00306"></a>00306 <span class="comment">         * of using smat. this works, check square spots in reflections  (ton) */</span>
<a name="l00307"></a>00307         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aceb90dff38c8c92e00335f2da648d61e">copy_m3_m3</a>(cmat, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>); 
<a name="l00308"></a>00308         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, cmat, imat); 
<a name="l00309"></a>00309 
<a name="l00310"></a>00310         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>);
<a name="l00311"></a>00311         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(tmat, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>);
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[0]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[0];
<a name="l00314"></a>00314         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[1]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[1];
<a name="l00315"></a>00315         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[2]= -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>[2];
<a name="l00316"></a>00316         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a5b7ffd7bfa1e5bb0b96be6074a35ab83">imat</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>);
<a name="l00317"></a>00317         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a6028461b52f7a38c6adbb261f16b42fe">sh_invcampos</a>[2]*= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a71b1be3f29d81d0c33b9dbbf3f91c1cc">sh_zfac</a>;
<a name="l00318"></a>00318         
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (mode==1) {
<a name="l00321"></a>00321                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(pmat, mat);
<a name="l00322"></a>00322                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(smat, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac60eb776f17863e2e49eb745c2de382c">viewmat</a>, pmat);
<a name="l00323"></a>00323                 <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, smat);
<a name="l00324"></a>00324             }
<a name="l00325"></a>00325             <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ad210540cd3f93895eb7a65d7bd815cfd">persmat</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#a974f8dfc47b5c3ce10abd6114a468364">winmat</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>-&gt;<a class="code" href="../../d1/d08/structShadBuf.html#ac60eb776f17863e2e49eb745c2de382c">viewmat</a>);
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328     
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00332"></a>00332 
<a name="l00333"></a><a class="code" href="../../da/dd4/envmap_8c.html#a6f940d03cc2985459a93d356c04f4bd8">00333</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a6f940d03cc2985459a93d356c04f4bd8">env_layerflags</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> notlay)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00336"></a>00336     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00337"></a>00337     <span class="keywordtype">int</span> a;
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     <span class="comment">/* invert notlay, so if face is in multiple layers it will still be visible,</span>
<a name="l00340"></a>00340 <span class="comment">     * unless all &#39;notlay&#39; bits match the face bits.</span>
<a name="l00341"></a>00341 <span class="comment">     * face: 0110</span>
<a name="l00342"></a>00342 <span class="comment">     * not:  0100</span>
<a name="l00343"></a>00343 <span class="comment">     * ~not: 1011</span>
<a name="l00344"></a>00344 <span class="comment">     * now (face &amp; ~not) is true</span>
<a name="l00345"></a>00345 <span class="comment">     */</span>
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     notlay= ~notlay;
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>) {
<a name="l00350"></a>00350         <span class="keywordflow">if</span> ((obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a8da800880351742b93b2935dda003e32">lay</a> &amp; notlay)==0) {
<a name="l00351"></a>00351             <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00352"></a>00352                 <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00353"></a>00353                 <span class="keywordflow">else</span> vlr++;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>;
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357         }
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="../../da/dd4/envmap_8c.html#a8eeb96611f30dde6ade19b55eccb3893">00361</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a8eeb96611f30dde6ade19b55eccb3893">env_hideobject</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00364"></a>00364     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00365"></a>00365     <span class="keywordtype">int</span> a;
<a name="l00366"></a>00366     
<a name="l00367"></a>00367     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>) {
<a name="l00368"></a>00368         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00369"></a>00369             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00370"></a>00370             <span class="keywordflow">else</span> vlr++;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372             <span class="keywordflow">if</span> (obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a> == ob)
<a name="l00373"></a>00373                 vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> |= <a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a><a class="code" href="../../da/dd4/envmap_8c.html#a3cceb377d8254200c9c019995e835a85">00378</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a3cceb377d8254200c9c019995e835a85">env_showobjects</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380     <a class="code" href="../../d2/d24/structObjectRen.html">ObjectRen</a> *obr;
<a name="l00381"></a>00381     <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00382"></a>00382     <span class="keywordtype">int</span> a;
<a name="l00383"></a>00383     
<a name="l00384"></a>00384     <span class="keywordflow">for</span> (obr=re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ae10898dfc318ed1eb116b9f8b0291d81">objecttable</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; obr; obr=obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#aad093864899f70ed28b734f34cdb219f">next</a>) {
<a name="l00385"></a>00385         <span class="keywordflow">for</span> (a=0; a&lt;obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#af557bb4aa2da4a0b82092fadd9642bc0">totvlak</a>; a++) {
<a name="l00386"></a>00386             <span class="keywordflow">if</span> ((a &amp; 255)==0) vlr= obr-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a645f0230dbec2b67e64da67749668a49">vlaknodes</a>[a&gt;&gt;8].<a class="code" href="../../da/d46/structVlakTableNode.html#ae1d18dca78c6e332691128d74e3a7942">vlak</a>;
<a name="l00387"></a>00387             <span class="keywordflow">else</span> vlr++;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389             vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a219484d9d7348a4e9d8b7368eb05efdc">flag</a> &amp;= ~<a class="code" href="../../db/d00/render__types_8h.html#add911b0701a3238ed7dfbfc364a79adc">R_HIDDEN</a>;
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="../../da/dd4/envmap_8c.html#a7878aea2d80edb9b626d3efe24ae48a5">00396</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a7878aea2d80edb9b626d3efe24ae48a5">env_set_imats</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <a class="code" href="../../d3/da9/structBase.html">Base</a> *base;
<a name="l00399"></a>00399     <span class="keywordtype">float</span> mat[4][4];
<a name="l00400"></a>00400     
<a name="l00401"></a>00401     base= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#a21ace55307d1ca141e265b3f55fa37d9">base</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00402"></a>00402     <span class="keywordflow">while</span> (base) {
<a name="l00403"></a>00403         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00404"></a>00404         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(base-&gt;<a class="code" href="../../d3/da9/structBase.html#a74bed66e64803246e406c1ed2dd7f1ab">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, mat);
<a name="l00405"></a>00405         
<a name="l00406"></a>00406         base= base-&gt;<a class="code" href="../../d3/da9/structBase.html#a25befa992d0ce8876b7d62176212be68">next</a>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 }   
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00412"></a>00412 
<a name="l00413"></a><a class="code" href="../../da/dd4/envmap_8c.html#a9822ce0ce4ca40d8efcbf0e520a0af2f">00413</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#a9822ce0ce4ca40d8efcbf0e520a0af2f">render_envmap</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415     <span class="comment">/* only the cubemap and planar map is implemented */</span>
<a name="l00416"></a>00416     <a class="code" href="../../d6/d7a/structRender.html">Render</a> *envre;
<a name="l00417"></a>00417     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00418"></a>00418     <span class="keywordtype">float</span> orthmat[4][4];
<a name="l00419"></a>00419     <span class="keywordtype">float</span> oldviewinv[4][4], mat[4][4], tmat[4][4];
<a name="l00420"></a>00420     <span class="keywordtype">short</span> part;
<a name="l00421"></a>00421     
<a name="l00422"></a>00422     <span class="comment">/* need a recalc: ortho-render has no correct viewinv */</span>
<a name="l00423"></a>00423     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(oldviewinv, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     envre= <a class="code" href="../../da/dd4/envmap_8c.html#a4925a894e3fc645bca4903ca97144aea">envmap_render_copy</a>(re, env);
<a name="l00426"></a>00426     
<a name="l00427"></a>00427     <span class="comment">/* precalc orthmat for object */</span>
<a name="l00428"></a>00428     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(orthmat, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00429"></a>00429     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(orthmat);
<a name="l00430"></a>00430     
<a name="l00431"></a>00431     <span class="comment">/* need imat later for texture imat */</span>
<a name="l00432"></a>00432     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, orthmat);
<a name="l00433"></a>00433     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(tmat, mat);
<a name="l00434"></a>00434     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a9628da2b5ae9d952b82d5397bb085994">obimat</a>, tmat);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     <span class="keywordflow">for</span> (part=0; part&lt;6; part++) {
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af7153b716c4378b1fa073540f7d6350d">ENV_PLANE</a> &amp;&amp; part!=1)
<a name="l00438"></a>00438             <span class="keywordflow">continue</span>;
<a name="l00439"></a>00439         
<a name="l00440"></a>00440         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#afb5075a54bb33a3a7311ea3139b67be7">display_clear</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a072e8f1cd52294f70672828770db4e9f">dch</a>, envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>);
<a name="l00441"></a>00441         
<a name="l00442"></a>00442         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(tmat, orthmat);
<a name="l00443"></a>00443         <a class="code" href="../../da/dd4/envmap_8c.html#a64c6990d1a0d1d9dd2a61d414f04499a">envmap_transmatrix</a>(tmat, part);
<a name="l00444"></a>00444         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(mat, tmat);
<a name="l00445"></a>00445         <span class="comment">/* mat now is the camera &#39;viewmat&#39; */</span>
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, mat);
<a name="l00448"></a>00448         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, tmat);
<a name="l00449"></a>00449         
<a name="l00450"></a>00450         <span class="comment">/* we have to correct for the already rotated vertexcoords */</span>
<a name="l00451"></a>00451         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(tmat, envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, oldviewinv);
<a name="l00452"></a>00452         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a0fd3edfd93e6300f188dbd7db24b0a3f">imat</a>, tmat);
<a name="l00453"></a>00453         
<a name="l00454"></a>00454         <a class="code" href="../../da/dd4/envmap_8c.html#a82e4fdbffd63dc5eb807a1d3053efafc">env_rotate_scene</a>(envre, tmat, 1);
<a name="l00455"></a>00455         <a class="code" href="../../d0/db6/renderdatabase_8h.html#a60a634e8ea9b98602b0e207691ab6bb4">init_render_world</a>(envre);
<a name="l00456"></a>00456         <a class="code" href="../../d0/db6/renderdatabase_8h.html#a6cf4b70d1aee8e6d407276721137556b">project_renderdata</a>(envre, <a class="code" href="../../df/d9d/zbuf_8h.html#abf3d79427f1e7f2d64555e030d10a400">projectverto</a>, 0, 0, 1);
<a name="l00457"></a>00457         <a class="code" href="../../da/dd4/envmap_8c.html#a6f940d03cc2985459a93d356c04f4bd8">env_layerflags</a>(envre, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a70c1e8301b39869ba92c4fabd6407b68">notlay</a>);
<a name="l00458"></a>00458         <a class="code" href="../../da/dd4/envmap_8c.html#a8eeb96611f30dde6ade19b55eccb3893">env_hideobject</a>(envre, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>);
<a name="l00459"></a>00459         <a class="code" href="../../da/dd4/envmap_8c.html#a7878aea2d80edb9b626d3efe24ae48a5">env_set_imats</a>(envre);
<a name="l00460"></a>00460                 
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)==0) {
<a name="l00462"></a>00462             <a class="code" href="../../d8/dfd/RE__pipeline_8h.html#ad85da6df05e03bb57c364a0ecd19ffe2">RE_TileProcessor</a>(envre);
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464         
<a name="l00465"></a>00465         <span class="comment">/* rotate back */</span>
<a name="l00466"></a>00466         <a class="code" href="../../da/dd4/envmap_8c.html#a3cceb377d8254200c9c019995e835a85">env_showobjects</a>(envre);
<a name="l00467"></a>00467         <a class="code" href="../../da/dd4/envmap_8c.html#a82e4fdbffd63dc5eb807a1d3053efafc">env_rotate_scene</a>(envre, tmat, 0);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)==0) {
<a name="l00470"></a>00470             <a class="code" href="../../da/d90/structRenderLayer.html">RenderLayer</a> *rl= envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>-&gt;<a class="code" href="../../d5/d29/structRenderResult.html#a56f453254756e82da4cec4ddc516b167">layers</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00471"></a>00471             <span class="keywordtype">int</span> y;
<a name="l00472"></a>00472             <span class="keywordtype">float</span> *alpha;
<a name="l00473"></a>00473             
<a name="l00474"></a>00474             ibuf= <a class="code" href="../../db/d49/IMB__imbuf_8h.html#a439680f7777db0973e76f25001cff0cd">IMB_allocImBuf</a>(envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a84ed1ea81877dc384f3c51f32d2eb3f6">rectx</a>, envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a06a0fd06a8b3c26341be0e4650e6f22e">recty</a>, 24, <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#aa49c3338a20e388ce6ade7af88a93d40" title="Flag defining the components of the ImBuf struct.">IB_rect</a>|<a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#acfab05c5428143166a6fdab0aba64ea0" title="Flag defining the components of the ImBuf struct.">IB_rectfloat</a>);
<a name="l00475"></a>00475             memcpy(ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>, rl-&gt;<a class="code" href="../../da/d90/structRenderLayer.html#ae9845cbf757bcf086f09c543d535bdda">rectf</a>, ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a6be7accc39275e1b7c48794361e024dc">channels</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a> * ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00476"></a>00476             
<a name="l00477"></a>00477             <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#aa9a0521ac4e22707d09ddeac4bf104b2">color_mgt_flag</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#aea9753cc8aec8bc51c69f789cd188848">R_COLOR_MANAGEMENT</a>)
<a name="l00478"></a>00478                 ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a0aa104fffb1090d64f06da549681e81c">profile</a> = <a class="code" href="../../d7/dc9/IMB__imbuf__types_8h.html#ac9d7d77e52c7153b987c86cccfb8ad4c">IB_PROFILE_LINEAR_RGB</a>;
<a name="l00479"></a>00479             
<a name="l00480"></a>00480             <span class="comment">/* envmap renders without alpha */</span>
<a name="l00481"></a>00481             alpha= ((<span class="keywordtype">float</span> *)ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a45bb91c70233262497998fcada3b752e">rect_float</a>)+3;
<a name="l00482"></a>00482             <span class="keywordflow">for</span> (y= ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#ae7734bc51f5e3e75be66e6f6a26f4f4e">x</a>*ibuf-&gt;<a class="code" href="../../d3/dd9/structImBuf.html#a9b88fc1c373dd2aa0d4c174c87913050">y</a> - 1; y&gt;=0; y--, alpha+=4)
<a name="l00483"></a>00483                 *alpha= 1.0;
<a name="l00484"></a>00484             
<a name="l00485"></a>00485             env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[part]= ibuf;
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487         
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <span class="keywordflow">break</span>;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491     
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ab86f35f41d2f2e98875f925fa081dc0f">test_break</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac752aa18cebf2c4da2093ff9ceb24bc8">tbh</a>)) <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(env);
<a name="l00493"></a>00493     <span class="keywordflow">else</span> {
<a name="l00494"></a>00494         <span class="keywordflow">if</span> (envre-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2711a7abdf812fa0f1b16da25a7d6343">R_OSA</a>) env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a91c1a681090be4a118bf3461bc8125dd">ENV_OSA</a>;
<a name="l00495"></a>00495         <span class="keywordflow">else</span> env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= <a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac9dcd65646809df82805f6bffeb3b1cb">ENV_NORMAL</a>;
<a name="l00496"></a>00496         env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a5ddbf23f486423daa0603982533c83c7">lastframe</a>= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a83305b24171e554748c07314d2988d12">scene</a>-&gt;<a class="code" href="../../d9/d27/structScene.html#aa182df8e0e4fae140d73ddde81ae7385">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad385a7555d5d36145f4ea1b27b0ceca8">cfra</a>;
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498     
<a name="l00499"></a>00499     <span class="comment">/* restore */</span>
<a name="l00500"></a>00500     <a class="code" href="../../da/dd4/envmap_8c.html#a6fc2fe2fa5354a458084daa3971a8b3a">envmap_free_render_copy</a>(envre);
<a name="l00501"></a>00501     <a class="code" href="../../da/dd4/envmap_8c.html#a7878aea2d80edb9b626d3efe24ae48a5">env_set_imats</a>(re);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00506"></a>00506 
<a name="l00507"></a><a class="code" href="../../da/dd4/envmap_8c.html#ad12cd2dac387d6f190e6242cabfcf6c2">00507</a> <span class="keywordtype">void</span> <a class="code" href="../../d7/d3f/envmap_8h.html#ae923be36bc2a94151e8597158da3b2eb">make_envmaps</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex;
<a name="l00510"></a>00510     <span class="keywordtype">int</span> do_init= 0, depth= 0, <a class="code" href="../../d5/d8e/Value_8h.html#a6de19da2ce2b0236858a617a31873b7f">trace</a>;
<a name="l00511"></a>00511     
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (!(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#af38446c2dfb68ef620bd015cd68aebd2">R_ENVMAP</a>)) <span class="keywordflow">return</span>;
<a name="l00513"></a>00513     
<a name="l00514"></a>00514     <span class="comment">/* we don&#39;t raytrace, disabling the flag will cause ray_transp render solid */</span>
<a name="l00515"></a>00515     <a class="code" href="../../d5/d8e/Value_8h.html#a6de19da2ce2b0236858a617a31873b7f">trace</a>= (re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>);
<a name="l00516"></a>00516     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp;= ~<a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a9ed65b3c82ee562a544923e6b9c8b41a">R_RAYTRACE</a>;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>.<a class="code" href="../../d3/d01/structRenderStats.html#ae8bbeeec2b4c2ddd78da9d0504dcf193">infostr</a>= <span class="stringliteral">&quot;Creating Environment maps&quot;</span>;
<a name="l00519"></a>00519     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a20fa60b052aabdedafff99850139f7ed">stats_draw</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a135a3088a5977d8cc224c83ef98d0299">sdh</a>, &amp;re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ac324c2b6c40c16740bb19b73dbd1ae92">i</a>);
<a name="l00520"></a>00520     
<a name="l00521"></a>00521     <span class="comment">/* 5 = hardcoded max recursion level */</span>
<a name="l00522"></a>00522     <span class="keywordflow">while</span> (depth&lt;5) {
<a name="l00523"></a>00523         tex= re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a4501de31e2583ce5359ac6991f72ff26">main</a>-&gt;<a class="code" href="../../d0/dc0/structMain.html#abd9c8128d38727f789af5a4c990fe20b">tex</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00524"></a>00524         <span class="keywordflow">while</span> (tex) {
<a name="l00525"></a>00525             <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad88374dc626795552b5c3f5b77fab1ab">us</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#aa7daf61fa1146d430403e81db6acb7cb">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a268a78c388efb693b879d6d21d3f60c7">TEX_ENVMAP</a>) {
<a name="l00526"></a>00526                 <span class="keywordflow">if</span> (tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a> &amp;&amp; tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>) {
<a name="l00527"></a>00527                     <a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>;
<a name="l00528"></a>00528                     
<a name="l00529"></a>00529                     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa9cfa964651e1e2f3044c9c79cf004b3">lay</a> &amp; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a208504caadf991d9f6c96b2709fcb8fd">lay</a>) {
<a name="l00530"></a>00530                         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#aba1cb887824b438b9754bd605877cdf4">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5cc75635fa3e668d8974bcc898f3f97b">ENV_LOAD</a>) {
<a name="l00531"></a>00531                             <span class="keywordtype">float</span> orthmat[4][4], mat[4][4], tmat[4][4];
<a name="l00532"></a>00532                             
<a name="l00533"></a>00533                             <span class="comment">/* precalc orthmat for object */</span>
<a name="l00534"></a>00534                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a54d4323b3d706eb2ad167e9551ba4414">copy_m4_m4</a>(orthmat, env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00535"></a>00535                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a927af9664e9476288c23d0f5e59c4edc">normalize_m4</a>(orthmat);
<a name="l00536"></a>00536                             
<a name="l00537"></a>00537                             <span class="comment">/* need imat later for texture imat */</span>
<a name="l00538"></a>00538                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#ad1a2e3dffa696248f9dd65fa9fc4c38f">viewmat</a>, orthmat);
<a name="l00539"></a>00539                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(tmat, mat);
<a name="l00540"></a>00540                             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a9628da2b5ae9d952b82d5397bb085994">obimat</a>, tmat);
<a name="l00541"></a>00541                         }
<a name="l00542"></a>00542                         <span class="keywordflow">else</span> {
<a name="l00543"></a>00543                             
<a name="l00544"></a>00544                             <span class="comment">/* decide if to render an envmap (again) */</span>
<a name="l00545"></a>00545                             <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a844054e4680fd1aced70a238fd9db7c8">depth</a> &gt;= depth) {
<a name="l00546"></a>00546                                 
<a name="l00547"></a>00547                                 <span class="comment">/* set &#39;recalc&#39; to make sure it does an entire loop of recalcs */</span>
<a name="l00548"></a>00548                                 
<a name="l00549"></a>00549                                 <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>) {
<a name="l00550"></a>00550                                         <span class="comment">/* free when OSA, and old one isn&#39;t OSA */</span>
<a name="l00551"></a>00551                                     <span class="keywordflow">if</span> ((re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> &amp; <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a2711a7abdf812fa0f1b16da25a7d6343">R_OSA</a>) &amp;&amp; env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#ac9dcd65646809df82805f6bffeb3b1cb">ENV_NORMAL</a>)
<a name="l00552"></a>00552                                         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(env);
<a name="l00553"></a>00553                                         <span class="comment">/* free when size larger */</span>
<a name="l00554"></a>00554                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac498a020e3facf763c53e7adb6fc83e6">lastsize</a> &lt; re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#a11d240aa637c806a992d75d43d4aded8">size</a>)
<a name="l00555"></a>00555                                         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(env);
<a name="l00556"></a>00556                                         <span class="comment">/* free when env is in recalcmode */</span>
<a name="l00557"></a>00557                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a4ac219f5dc8bd2f38b1ad990247d488c">recalc</a>)
<a name="l00558"></a>00558                                         <a class="code" href="../../d2/d66/BKE__texture_8h.html#a61a1173c3e99f4b2fba9a8ceb8065166">BKE_free_envmapdata</a>(env);
<a name="l00559"></a>00559                                 }
<a name="l00560"></a>00560                                 
<a name="l00561"></a>00561                                 <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>==0 &amp;&amp; depth==0) env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a4ac219f5dc8bd2f38b1ad990247d488c">recalc</a>= 1;
<a name="l00562"></a>00562                                 
<a name="l00563"></a>00563                                 <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>==0) {
<a name="l00564"></a>00564                                     do_init= 1;
<a name="l00565"></a>00565                                     <a class="code" href="../../da/dd4/envmap_8c.html#a9822ce0ce4ca40d8efcbf0e520a0af2f">render_envmap</a>(re, env);
<a name="l00566"></a>00566                                     
<a name="l00567"></a>00567                                     <span class="keywordflow">if</span> (depth==env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a844054e4680fd1aced70a238fd9db7c8">depth</a>) env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a4ac219f5dc8bd2f38b1ad990247d488c">recalc</a>= 0;
<a name="l00568"></a>00568                                 }
<a name="l00569"></a>00569                             }
<a name="l00570"></a>00570                         }
<a name="l00571"></a>00571                     }
<a name="l00572"></a>00572                 }
<a name="l00573"></a>00573             }
<a name="l00574"></a>00574             tex= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a8319488bcdfe2de879476bd0f7c27aa2">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576         depth++;
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (do_init) {
<a name="l00580"></a>00580         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#aa153cc9c5c45a7a0f4fa8c54bacf3a65">display_init</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a450a775fa11adfbd9085f369fd025cbd">dih</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>);
<a name="l00581"></a>00581         re-&gt;<a class="code" href="../../d6/d7a/structRender.html#afb5075a54bb33a3a7311ea3139b67be7">display_clear</a>(re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a072e8f1cd52294f70672828770db4e9f">dch</a>, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a1a45aa430762f99a66a0dd0ce0fda2de">result</a>);
<a name="l00582"></a>00582         <span class="comment">// re-&gt;flag |= R_REDRAW_PRV;</span>
<a name="l00583"></a>00583     }   
<a name="l00584"></a>00584     <span class="comment">// restore</span>
<a name="l00585"></a>00585     re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a35faf7fc71caeef77f03549010f1a08d">r</a>.<a class="code" href="../../d3/d27/structRenderData.html#ad4b607d22d4e5f4c2f92dda62358d664">mode</a> |= <a class="code" href="../../d5/d8e/Value_8h.html#a6de19da2ce2b0236858a617a31873b7f">trace</a>;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="../../da/dd4/envmap_8c.html#a6520a67b558021e423563aa2d2632c7a">00591</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/dd4/envmap_8c.html#a6520a67b558021e423563aa2d2632c7a">envcube_isect</a>(<a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env, <span class="keywordtype">float</span> *vec, <span class="keywordtype">float</span> *answ)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593     <span class="keywordtype">float</span> labda;
<a name="l00594"></a>00594     <span class="keywordtype">int</span> face;
<a name="l00595"></a>00595     
<a name="l00596"></a>00596     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a3bafe9d195a2d364d58b8612ed46c6fd">type</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#af7153b716c4378b1fa073540f7d6350d">ENV_PLANE</a>) {
<a name="l00597"></a>00597         face= 1;
<a name="l00598"></a>00598         
<a name="l00599"></a>00599         labda= 1.0f/vec[2];
<a name="l00600"></a>00600         answ[0]= env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ad779e991bd439bb9c4b571371e774a11">viewscale</a>*labda*vec[0];
<a name="l00601"></a>00601         answ[1]= -env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ad779e991bd439bb9c4b571371e774a11">viewscale</a>*labda*vec[1];
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     <span class="keywordflow">else</span> {
<a name="l00604"></a>00604         <span class="comment">/* which face */</span>
<a name="l00605"></a>00605         <span class="keywordflow">if</span> ( vec[2] &lt;= -<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[0]) &amp;&amp; vec[2] &lt;= -<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[1]) ) {
<a name="l00606"></a>00606             face= 0;
<a name="l00607"></a>00607             labda= -1.0f/vec[2];
<a name="l00608"></a>00608             answ[0]= labda*vec[0];
<a name="l00609"></a>00609             answ[1]= labda*vec[1];
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vec[2] &gt;= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[0]) &amp;&amp; vec[2] &gt;= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[1])) {
<a name="l00612"></a>00612             face= 1;
<a name="l00613"></a>00613             labda= 1.0f/vec[2];
<a name="l00614"></a>00614             answ[0]= labda*vec[0];
<a name="l00615"></a>00615             answ[1]= -labda*vec[1];
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vec[1] &gt;= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[0])) {
<a name="l00618"></a>00618             face= 2;
<a name="l00619"></a>00619             labda= 1.0f/vec[1];
<a name="l00620"></a>00620             answ[0]= labda*vec[0];
<a name="l00621"></a>00621             answ[1]= labda*vec[2];
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vec[0] &lt;= -<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[1])) {
<a name="l00624"></a>00624             face= 3;
<a name="l00625"></a>00625             labda= -1.0f/vec[0];
<a name="l00626"></a>00626             answ[0]= labda*vec[1];
<a name="l00627"></a>00627             answ[1]= labda*vec[2];
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vec[1] &lt;= -<a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(vec[0])) {
<a name="l00630"></a>00630             face= 4;
<a name="l00631"></a>00631             labda= -1.0f/vec[1];
<a name="l00632"></a>00632             answ[0]= -labda*vec[0];
<a name="l00633"></a>00633             answ[1]= labda*vec[2];
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635         <span class="keywordflow">else</span> {
<a name="l00636"></a>00636             face= 5;
<a name="l00637"></a>00637             labda= 1.0f/vec[0];
<a name="l00638"></a>00638             answ[0]= -labda*vec[1];
<a name="l00639"></a>00639             answ[1]= labda*vec[2];
<a name="l00640"></a>00640         }
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642     
<a name="l00643"></a>00643     answ[0]= 0.5f+0.5f*answ[0];
<a name="l00644"></a>00644     answ[1]= 0.5f+0.5f*answ[1];
<a name="l00645"></a>00645     <span class="keywordflow">return</span> face;
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00649"></a>00649 
<a name="l00650"></a><a class="code" href="../../da/dd4/envmap_8c.html#ae8389619c3579c150644af9c9d91c292">00650</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/dd4/envmap_8c.html#ae8389619c3579c150644af9c9d91c292">set_dxtdyt</a>(<span class="keywordtype">float</span> *dxts, <span class="keywordtype">float</span> *dyts, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> face)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (face==2 || face==4) {
<a name="l00653"></a>00653         dxts[0]= dxt[0];
<a name="l00654"></a>00654         dyts[0]= dyt[0];
<a name="l00655"></a>00655         dxts[1]= dxt[2];
<a name="l00656"></a>00656         dyts[1]= dyt[2];
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (face==3 || face==5) {
<a name="l00659"></a>00659         dxts[0]= dxt[1];
<a name="l00660"></a>00660         dxts[1]= dxt[2];
<a name="l00661"></a>00661         dyts[0]= dyt[1];
<a name="l00662"></a>00662         dyts[1]= dyt[2];
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664     <span class="keywordflow">else</span> {
<a name="l00665"></a>00665         dxts[0]= dxt[0];
<a name="l00666"></a>00666         dyts[0]= dyt[0];
<a name="l00667"></a>00667         dxts[1]= dxt[1];
<a name="l00668"></a>00668         dyts[1]= dyt[1];
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00673"></a>00673 
<a name="l00674"></a><a class="code" href="../../da/dd4/envmap_8c.html#a0d4396420a092318e969e44f097ac886">00674</a> <span class="keywordtype">int</span> <a class="code" href="../../d7/d3f/envmap_8h.html#a7c7f8bb586f73faea7680bf6acf3364d">envmaptex</a>(<a class="code" href="../../df/d2d/structTex.html">Tex</a> *tex, <span class="keywordtype">float</span> *texvec, <span class="keywordtype">float</span> *dxt, <span class="keywordtype">float</span> *dyt, <span class="keywordtype">int</span> osatex, <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> *texres)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676     <span class="keyword">extern</span> <a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;                <span class="comment">/* only in this call */</span>
<a name="l00677"></a>00677     <span class="comment">/* texvec should be the already reflected normal */</span>
<a name="l00678"></a>00678     <a class="code" href="../../d2/d48/structEnvMap.html">EnvMap</a> *env;
<a name="l00679"></a>00679     <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf;
<a name="l00680"></a>00680     <span class="keywordtype">float</span> fac, vec[3], sco[3], dxts[3], dyts[3];
<a name="l00681"></a>00681     <span class="keywordtype">int</span> face, face1;
<a name="l00682"></a>00682     
<a name="l00683"></a>00683     env= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#a38f85ab225d5634cf434ae45e7eed004">env</a>;
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (env==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#aba1cb887824b438b9754bd605877cdf4">stype</a>!=<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5cc75635fa3e668d8974bcc898f3f97b">ENV_LOAD</a> &amp;&amp; env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l00685"></a>00685         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0;
<a name="l00686"></a>00686         <span class="keywordflow">return</span> 0;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688     
<a name="l00689"></a>00689     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#aba1cb887824b438b9754bd605877cdf4">stype</a>==<a class="code" href="../../da/ddf/DNA__texture__types_8h.html#a5cc75635fa3e668d8974bcc898f3f97b">ENV_LOAD</a>) {
<a name="l00690"></a>00690         env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8aa958f7d9894d2941bf32c82625a50a">ima</a>= tex-&gt;<a class="code" href="../../df/d2d/structTex.html#ad2c2c4a8437672ea77fc9cfded61ffaf">ima</a>;
<a name="l00691"></a>00691         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8aa958f7d9894d2941bf32c82625a50a">ima</a> &amp;&amp; env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8aa958f7d9894d2941bf32c82625a50a">ima</a>-&gt;<a class="code" href="../../d8/d00/classImage.html#af6746e8e3008f22431dae19d0c2fb914">ok</a>) {
<a name="l00692"></a>00692             <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[1]==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00693"></a>00693                 <a class="code" href="../../d3/dd9/structImBuf.html">ImBuf</a> *ibuf_ima= <a class="code" href="../../d2/d77/BKE__image_8h.html#a82acf4ed18d05029e80437a655baf008">BKE_image_get_ibuf</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8aa958f7d9894d2941bf32c82625a50a">ima</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00694"></a>00694                 <span class="keywordflow">if</span> (ibuf_ima)
<a name="l00695"></a>00695                     <a class="code" href="../../da/dd4/envmap_8c.html#a03376d68f1811f46e34f42b1b51784d1">envmap_split_ima</a>(env, ibuf_ima);
<a name="l00696"></a>00696                 <span class="keywordflow">else</span>
<a name="l00697"></a>00697                     env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>= 0;
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699         }
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ae6e40ac1dab8eb5009658f68148d1e30">ok</a>==0) {
<a name="l00703"></a>00703         texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a71a093242845c4eefe0455b2dd925d1e">tin</a>= 0.0;
<a name="l00704"></a>00704         <span class="keywordflow">return</span> 0;
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     
<a name="l00707"></a>00707     <span class="comment">/* rotate to envmap space, if object is set */</span>
<a name="l00708"></a>00708     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, texvec);
<a name="l00709"></a>00709     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>) <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a9628da2b5ae9d952b82d5397bb085994">obimat</a>, vec);
<a name="l00710"></a>00710     <span class="keywordflow">else</span> <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(R.<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, vec);
<a name="l00711"></a>00711     
<a name="l00712"></a>00712     face= <a class="code" href="../../da/dd4/envmap_8c.html#a6520a67b558021e423563aa2d2632c7a">envcube_isect</a>(env, vec, sco);
<a name="l00713"></a>00713     ibuf= env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[face];
<a name="l00714"></a>00714     
<a name="l00715"></a>00715     <span class="keywordflow">if</span> (osatex) {
<a name="l00716"></a>00716         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a8c98836b697fec0fbaddfd2fc4e0fd09">object</a>) {
<a name="l00717"></a>00717             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a9628da2b5ae9d952b82d5397bb085994">obimat</a>, dxt);
<a name="l00718"></a>00718             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#a9628da2b5ae9d952b82d5397bb085994">obimat</a>, dyt);
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720         <span class="keywordflow">else</span> {
<a name="l00721"></a>00721             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(R.<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, dxt);
<a name="l00722"></a>00722             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad5cae73de10c30273f8c0fdc00fa648c">mul_mat3_m4_v3</a>(R.<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, dyt);
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         <a class="code" href="../../da/dd4/envmap_8c.html#ae8389619c3579c150644af9c9d91c292">set_dxtdyt</a>(dxts, dyts, dxt, dyt, face);
<a name="l00725"></a>00725         <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(tex, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ibuf, sco, dxts, dyts, texres);
<a name="l00726"></a>00726         
<a name="l00727"></a>00727         <span class="comment">/* edges? */</span>
<a name="l00728"></a>00728         
<a name="l00729"></a>00729         <span class="keywordflow">if</span> (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>&lt;1.0f) {
<a name="l00730"></a>00730             <a class="code" href="../../db/da2/structTexResult.html">TexResult</a> texr1, texr2;
<a name="l00731"></a>00731     
<a name="l00732"></a>00732             texr1.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= texr2.<a class="code" href="../../db/da2/structTexResult.html#a558eee24ea7940a9af7a55e7ab33b33d">nor</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00733"></a>00733             texr1.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= texr2.<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>= texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a426ae92822e99787d6b8fda7675108a1">talpha</a>; <span class="comment">/* boxclip expects this initialized */</span>
<a name="l00734"></a>00734 
<a name="l00735"></a>00735             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, dxt);
<a name="l00736"></a>00736             face1= <a class="code" href="../../da/dd4/envmap_8c.html#a6520a67b558021e423563aa2d2632c7a">envcube_isect</a>(env, vec, sco);
<a name="l00737"></a>00737             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vec, dxt);
<a name="l00738"></a>00738             
<a name="l00739"></a>00739             <span class="keywordflow">if</span> (face!=face1) {
<a name="l00740"></a>00740                 ibuf= env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[face1];
<a name="l00741"></a>00741                 <a class="code" href="../../da/dd4/envmap_8c.html#ae8389619c3579c150644af9c9d91c292">set_dxtdyt</a>(dxts, dyts, dxt, dyt, face1);
<a name="l00742"></a>00742                 <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(tex, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ibuf, sco, dxts, dyts, &amp;texr1);
<a name="l00743"></a>00743             }
<a name="l00744"></a>00744             <span class="keywordflow">else</span> texr1.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texr1.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texr1.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texr1.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00745"></a>00745             
<a name="l00746"></a>00746             <span class="comment">/* here was the nasty bug! results were not zero-ed. FPE! */</span>
<a name="l00747"></a>00747             
<a name="l00748"></a>00748             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(vec, dyt);
<a name="l00749"></a>00749             face1= <a class="code" href="../../da/dd4/envmap_8c.html#a6520a67b558021e423563aa2d2632c7a">envcube_isect</a>(env, vec, sco);
<a name="l00750"></a>00750             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(vec, dyt);
<a name="l00751"></a>00751             
<a name="l00752"></a>00752             <span class="keywordflow">if</span> (face!=face1) {
<a name="l00753"></a>00753                 ibuf= env-&gt;<a class="code" href="../../d2/d48/structEnvMap.html#ac7f5cdc3723c068a8fc59ec0cf59e346">cube</a>[face1];
<a name="l00754"></a>00754                 <a class="code" href="../../da/dd4/envmap_8c.html#ae8389619c3579c150644af9c9d91c292">set_dxtdyt</a>(dxts, dyts, dxt, dyt, face1);
<a name="l00755"></a>00755                 <a class="code" href="../../df/dba/texture_8h.html#aa6fda775e0b23d097ef8cc6f0198771f">imagewraposa</a>(tex, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ibuf, sco, dxts, dyts, &amp;texr2);
<a name="l00756"></a>00756             }
<a name="l00757"></a>00757             <span class="keywordflow">else</span> texr2.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= texr2.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= texr2.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= texr2.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 0.0;
<a name="l00758"></a>00758             
<a name="l00759"></a>00759             fac= (texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+texr1.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>+texr2.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>);
<a name="l00760"></a>00760             <span class="keywordflow">if</span> (fac!=0.0f) {
<a name="l00761"></a>00761                 fac= 1.0f/fac;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a>= fac*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr1.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr1.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> + texr2.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr2.<a class="code" href="../../db/da2/structTexResult.html#ad58d0c2536547365929a7dfd3bf67e32">tr</a> );
<a name="l00764"></a>00764                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a>= fac*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr1.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr1.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> + texr2.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr2.<a class="code" href="../../db/da2/structTexResult.html#ad602785f0747bcb3532949d661d8f472">tg</a> );
<a name="l00765"></a>00765                 texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a>= fac*(texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> + texr1.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr1.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> + texr2.<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>*texr2.<a class="code" href="../../db/da2/structTexResult.html#a557b38c1d19e8e7a780657ed75b9f975">tb</a> );
<a name="l00766"></a>00766             }
<a name="l00767"></a>00767             texres-&gt;<a class="code" href="../../db/da2/structTexResult.html#a8d3ddb7530f146ec16e04f8a31bd9a47">ta</a>= 1.0;
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     <span class="keywordflow">else</span> {
<a name="l00771"></a>00771         <a class="code" href="../../df/dba/texture_8h.html#a7762aab857b2d37f53a4504f8e529d83">imagewrap</a>(tex, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, ibuf, sco, texres);
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773     
<a name="l00774"></a>00774     <span class="keywordflow">return</span> 1;
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="comment">/* ------------------------------------------------------------------------- */</span>
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="comment">/* eof */</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:17 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
