<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: font.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">font.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/d8c/font_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): none yet.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;wchar.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;wctype.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d4a/BLI__vfontdata_8h.html" title="A structure to represent vector fonts, and to load them from PostScript fonts.">BLI_vfontdata.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d4d/DNA__packedFile__types_8h.html">DNA_packedFile_types.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/d88/DNA__curve__types_8h.html">DNA_curve_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html">DNA_vfont_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/dde/BKE__utildefines_8h.html" title="blender format specific macros">BKE_utildefines.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4a/BKE__packedFile_8h.html">BKE_packedFile.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/db1/BKE__library_8h.html">BKE_library.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d06/BKE__font_8h.html">BKE_font.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9a/BKE__main_8h.html">BKE_main.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dd0/BKE__anim_8h.html">BKE_anim.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dfc/BKE__curve_8h.html">BKE_curve.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d12/BKE__displist_8h.html" title="display list (or rather multi purpose list) stuff.">BKE_displist.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="../../da/d8c/font_8c.html#a115ba200a593e40ac985238af724c474">00063</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../da/d8c/font_8c.html#a115ba200a593e40ac985238af724c474">ttfdata</a>= {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* The vfont code */</span>
<a name="l00066"></a><a class="code" href="../../da/d8c/font_8c.html#ae8e6486daea17b09d87c6e4ceccb1ad3">00066</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d06/BKE__font_8h.html#aa0d2594d74f08349926e63509942c1ba">free_vfont</a>(<span class="keyword">struct</span> <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *vf)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068     <span class="keywordflow">if</span> (vf == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>) {
<a name="l00071"></a>00071         <span class="keywordflow">while</span> (vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#a0acbd1097660ebd724b5f1082901292c">characters</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l00072"></a>00072         {
<a name="l00073"></a>00073             <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *che = vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#a0acbd1097660ebd724b5f1082901292c">characters</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00074"></a>00074             
<a name="l00075"></a>00075             <span class="keywordflow">while</span> (che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a64796784138d243b6a747b0336ca404b">nurbsbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>) {
<a name="l00076"></a>00076                 <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu = che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a64796784138d243b6a747b0336ca404b">nurbsbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00077"></a>00077                 <span class="keywordflow">if</span> (nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nu-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>);
<a name="l00078"></a>00078                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a64796784138d243b6a747b0336ca404b">nurbsbase</a>, nu);
<a name="l00079"></a>00079             }
<a name="l00080"></a>00080     
<a name="l00081"></a>00081             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a2bb7ce226f8b42d21eb35100f0bb4580">BLI_freelinkN</a>(&amp;vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#a0acbd1097660ebd724b5f1082901292c">characters</a>, che);
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>);
<a name="l00085"></a>00085         vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a>) {
<a name="l00089"></a>00089         <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a>);
<a name="l00090"></a>00090         vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00091"></a>00091     }
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a><a class="code" href="../../da/d8c/font_8c.html#ae4ae94c2ee5ff280d5ea250779fa35a4">00094</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="../../da/d8c/font_8c.html#ae4ae94c2ee5ff280d5ea250779fa35a4">builtin_font_data</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00095"></a><a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">00095</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">builtin_font_size</a>= 0;
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../da/d8c/font_8c.html#a72ad98bbc6ac4e12f8f6c86b27c350ca">00097</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d06/BKE__font_8h.html#a72ad98bbc6ac4e12f8f6c86b27c350ca">BKE_font_register_builtin</a>(<span class="keywordtype">void</span> *mem, <span class="keywordtype">int</span> <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <a class="code" href="../../da/d8c/font_8c.html#ae4ae94c2ee5ff280d5ea250779fa35a4">builtin_font_data</a>= mem;
<a name="l00100"></a>00100     <a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">builtin_font_size</a>= <a class="code" href="../../d8/d40/btDbvt_8cpp.html#a0dbff19ad8155e43555569d371ad95a1">size</a>;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="../../da/d8c/font_8c.html#a20cd5a6ec5d7f56c31375206de310e81">00103</a> <span class="keyword">static</span> <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *<a class="code" href="../../da/d8c/font_8c.html#a20cd5a6ec5d7f56c31375206de310e81">get_builtin_packedfile</a>(<span class="keywordtype">void</span>)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (!<a class="code" href="../../da/d8c/font_8c.html#ae4ae94c2ee5ff280d5ea250779fa35a4">builtin_font_data</a>) {
<a name="l00106"></a>00106         printf(<span class="stringliteral">&quot;Internal error, builtin font not loaded\n&quot;</span>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keywordflow">else</span> {
<a name="l00111"></a>00111         <span class="keywordtype">void</span> *mem= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">builtin_font_size</a>, <span class="stringliteral">&quot;vfd_builtin&quot;</span>);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         memcpy(mem, <a class="code" href="../../da/d8c/font_8c.html#ae4ae94c2ee5ff280d5ea250779fa35a4">builtin_font_data</a>, <a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">builtin_font_size</a>);
<a name="l00114"></a>00114     
<a name="l00115"></a>00115         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#ab43e9e4f7fddc1d9d988f0539c9314f9">newPackedFileMemory</a>(mem, <a class="code" href="../../da/d8c/font_8c.html#a3642916b57bc90138349a5c0c62e321a">builtin_font_size</a>);
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="../../da/d8c/font_8c.html#ae88c5a6fe4cb4759df7abf49fa2a3354">00119</a> <span class="keywordtype">void</span> <a class="code" href="../../d0/d06/BKE__font_8h.html#ae88c5a6fe4cb4759df7abf49fa2a3354">free_ttfont</a>(<span class="keywordtype">void</span>)
<a name="l00120"></a>00120 {
<a name="l00121"></a>00121     <span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *tf;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <span class="keywordflow">for</span> (tf= ttfdata.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; tf; tf= tf-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#af0aff9c32dd210f41b85a5b522d6d968">next</a>) {
<a name="l00124"></a>00124         <span class="keywordflow">if</span> (tf-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>) <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(tf-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>); <span class="comment">/* NULL when the font file can&#39;t be found on disk */</span>
<a name="l00125"></a>00125         tf-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00126"></a>00126         tf-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#af94280dc0a245719304fdff91327b1e0">BLI_freelistN</a>(&amp;ttfdata);
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a><a class="code" href="../../da/d8c/font_8c.html#a84caa49e64b6c9b231fa31f44d847787">00131</a> <span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *<a class="code" href="../../d0/d06/BKE__font_8h.html#a56ffdf977fd15493dcb37d7118a5228b">vfont_find_tmpfont</a>(<a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *tmpfnt = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00134"></a>00134     
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (vfont==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00136"></a>00136     
<a name="l00137"></a>00137     <span class="comment">// Try finding the font from font list</span>
<a name="l00138"></a>00138     tmpfnt = ttfdata.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00139"></a>00139     <span class="keywordflow">while</span> (tmpfnt)
<a name="l00140"></a>00140     {
<a name="l00141"></a>00141         <span class="keywordflow">if</span> (tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a> == vfont)
<a name="l00142"></a>00142             <span class="keywordflow">break</span>;
<a name="l00143"></a>00143         tmpfnt = tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#af0aff9c32dd210f41b85a5b522d6d968">next</a>;
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145     <span class="keywordflow">return</span> tmpfnt;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="../../da/d8c/font_8c.html#aacd0d8ca362bbace3265c257d5cfb306">00148</a> <span class="keyword">static</span> <a class="code" href="../../d6/d0a/structVFontData.html">VFontData</a> *<a class="code" href="../../da/d8c/font_8c.html#aacd0d8ca362bbace3265c257d5cfb306">vfont_get_data</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *tmpfnt = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00151"></a>00151     <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *tpf;
<a name="l00152"></a>00152     
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (vfont==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00154"></a>00154     
<a name="l00155"></a>00155     <span class="comment">// Try finding the font from font list</span>
<a name="l00156"></a>00156     tmpfnt = <a class="code" href="../../d0/d06/BKE__font_8h.html#a56ffdf977fd15493dcb37d7118a5228b">vfont_find_tmpfont</a>(vfont);
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     <span class="comment">// And then set the data    </span>
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (!vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>) {
<a name="l00160"></a>00160         <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l00161"></a>00161         
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (strcmp(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>)==0) {
<a name="l00163"></a>00163             pf= <a class="code" href="../../da/d8c/font_8c.html#a20cd5a6ec5d7f56c31375206de310e81">get_builtin_packedfile</a>();
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165         <span class="keywordflow">else</span> {
<a name="l00166"></a>00166             <span class="keywordflow">if</span> (vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a>) {
<a name="l00167"></a>00167                 pf= vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a>;
<a name="l00168"></a>00168                 
<a name="l00169"></a>00169                 <span class="comment">// We need to copy a tmp font to memory unless it is already there</span>
<a name="l00170"></a>00170                 <span class="keywordflow">if</span> (!tmpfnt) {
<a name="l00171"></a>00171                     tpf= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(*tpf), <span class="stringliteral">&quot;PackedFile&quot;</span>);
<a name="l00172"></a>00172                     tpf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab26282078abf88909ab32213a4290f8e">data</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a>, <span class="stringliteral">&quot;packFile&quot;</span>);
<a name="l00173"></a>00173                     tpf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a>= pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a>;
<a name="l00174"></a>00174                     memcpy(tpf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab26282078abf88909ab32213a4290f8e">data</a>, pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab26282078abf88909ab32213a4290f8e">data</a>, pf-&gt;<a class="code" href="../../dd/d77/structPackedFile.html#ab46e545f88274c5c348303a84fd735d6">size</a>);
<a name="l00175"></a>00175                     
<a name="l00176"></a>00176                     <span class="comment">// Add temporary packed file to globals</span>
<a name="l00177"></a>00177                     tmpfnt= (<span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *) <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a>), <span class="stringliteral">&quot;temp_font&quot;</span>);
<a name="l00178"></a>00178                     tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>= tpf;
<a name="l00179"></a>00179                     tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>= <a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>;
<a name="l00180"></a>00180                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;ttfdata, tmpfnt);
<a name="l00181"></a>00181                 }
<a name="l00182"></a>00182             }
<a name="l00183"></a>00183             <span class="keywordflow">else</span> {
<a name="l00184"></a>00184                 pf= <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(bmain, &amp;vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#aa6ee47902f7fe209564d555dd4d8969d">id</a>));
<a name="l00185"></a>00185 
<a name="l00186"></a>00186                 <span class="keywordflow">if</span> (!tmpfnt) {
<a name="l00187"></a>00187                     tpf= <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a8a52d8cb8dde5bcf01c0f20254860d71">ID_BLEND_PATH</a>(bmain, &amp;vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#aa6ee47902f7fe209564d555dd4d8969d">id</a>));
<a name="l00188"></a>00188                     
<a name="l00189"></a>00189                     <span class="comment">// Add temporary packed file to globals</span>
<a name="l00190"></a>00190                     tmpfnt= (<span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *) <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a>), <span class="stringliteral">&quot;temp_font&quot;</span>);
<a name="l00191"></a>00191                     tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>= tpf;
<a name="l00192"></a>00192                     tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>= <a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>;
<a name="l00193"></a>00193                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;ttfdata, tmpfnt);
<a name="l00194"></a>00194                 }
<a name="l00195"></a>00195             }
<a name="l00196"></a>00196             <span class="keywordflow">if</span> (!pf) {
<a name="l00197"></a>00197                 printf(<span class="stringliteral">&quot;Font file doesn&#39;t exist: %s\n&quot;</span>, vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>);
<a name="l00198"></a>00198 
<a name="l00199"></a>00199                 strcpy(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>);
<a name="l00200"></a>00200                 pf= <a class="code" href="../../da/d8c/font_8c.html#a20cd5a6ec5d7f56c31375206de310e81">get_builtin_packedfile</a>();
<a name="l00201"></a>00201             }
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203         
<a name="l00204"></a>00204         <span class="keywordflow">if</span> (pf) {
<a name="l00205"></a>00205             vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>= <a class="code" href="../../d0/d4a/BLI__vfontdata_8h.html#a03b5fa725942aeb56582175a36902b32">BLI_vfontdata_from_freetypefont</a>(pf);
<a name="l00206"></a>00206             <span class="keywordflow">if</span> (pf != vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a>) {
<a name="l00207"></a>00207                 <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(pf);
<a name="l00208"></a>00208             }
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     
<a name="l00212"></a>00212     <span class="keywordflow">return</span> vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a>; 
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="../../da/d8c/font_8c.html#a3d432b6d318d0c575c7e7c1a08d9e0d8">00215</a> <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../d0/d06/BKE__font_8h.html#a9da41c072e90b83fc43dc1561145337c">load_vfont</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <span class="keywordtype">char</span> filename[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#a40b3bb1f7d7c8c9bbf4e0ed92564e73e">FILE_MAXFILE</a>];
<a name="l00218"></a>00218     <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00219"></a>00219     <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *<a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l00220"></a>00220     <a class="code" href="../../dd/d77/structPackedFile.html">PackedFile</a> *tpf = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>; 
<a name="l00221"></a>00221     <span class="keywordtype">int</span> is_builtin;
<a name="l00222"></a>00222     <span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *tmpfnt;
<a name="l00223"></a>00223     
<a name="l00224"></a>00224     <span class="keywordflow">if</span> (strcmp(name, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>)==0) {
<a name="l00225"></a>00225         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(filename, name, <span class="keyword">sizeof</span>(filename));
<a name="l00226"></a>00226         
<a name="l00227"></a>00227         pf= <a class="code" href="../../da/d8c/font_8c.html#a20cd5a6ec5d7f56c31375206de310e81">get_builtin_packedfile</a>();
<a name="l00228"></a>00228         is_builtin= 1;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="keywordflow">else</span> {
<a name="l00231"></a>00231         <span class="keywordtype">char</span> dir[<a class="code" href="../../d3/dde/BKE__utildefines_8h.html#af231ebb113f3f085906d83d6424abefb">FILE_MAXDIR</a>];
<a name="l00232"></a>00232         
<a name="l00233"></a>00233         <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(dir, name, <span class="keyword">sizeof</span>(dir));
<a name="l00234"></a>00234         <a class="code" href="../../d2/dd9/BLI__path__util_8h.html#a9587680f8895016dd21016fcecb476b0">BLI_splitdirstring</a>(dir, filename);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         pf= <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, name, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>);
<a name="l00237"></a>00237         tpf= <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a43b20c7de46371e8683efbe3fdf13b85">newPackedFile</a>(<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, name, bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#a8cf7ece1c27b22c05a1198b28d42ebdf">name</a>);
<a name="l00238"></a>00238         
<a name="l00239"></a>00239         is_builtin= 0;
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordflow">if</span> (pf) {
<a name="l00243"></a>00243         <a class="code" href="../../d6/d0a/structVFontData.html">VFontData</a> *vfd;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         vfd= <a class="code" href="../../d0/d4a/BLI__vfontdata_8h.html#a03b5fa725942aeb56582175a36902b32">BLI_vfontdata_from_freetypefont</a>(pf);
<a name="l00246"></a>00246         <span class="keywordflow">if</span> (vfd) {
<a name="l00247"></a>00247             vfont = <a class="code" href="../../d8/db1/BKE__library_8h.html#a0856c5e10e28cbe0b45eb00363bf8fb5">alloc_libblock</a>(&amp;bmain-&gt;<a class="code" href="../../d0/dc0/structMain.html#abef2da7d5c3a1975eb74128e4d70c682">vfont</a>, <a class="code" href="../../d3/dfb/DNA__ID_8h.html#a00dc71b465cb83f24230f213cb0d79c1">ID_VF</a>, filename);
<a name="l00248"></a>00248             vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#a0dc791926203e1e24184a4a13ac35857">data</a> = vfd;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250             <span class="comment">/* if there&#39;s a font name, use it for the ID name */</span>
<a name="l00251"></a>00251             <span class="keywordflow">if</span> (vfd-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#ad02054c77755f32900eca841e97976f0">name</a>[0] != <span class="charliteral">&#39;\0&#39;</span>) {
<a name="l00252"></a>00252                 <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#aa6ee47902f7fe209564d555dd4d8969d">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>+2, vfd-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#ad02054c77755f32900eca841e97976f0">name</a>, <span class="keyword">sizeof</span>(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#aa6ee47902f7fe209564d555dd4d8969d">id</a>.<a class="code" href="../../d8/d7e/structID.html#ad43a3d119e40a8479518fd876781e692">name</a>)-2);
<a name="l00253"></a>00253             }
<a name="l00254"></a>00254             <a class="code" href="../../d3/db3/BLI__string_8h.html#a98d7c9cb4a81dbe506d1972b306300ce">BLI_strncpy</a>(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, name, <span class="keyword">sizeof</span>(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>));
<a name="l00255"></a>00255 
<a name="l00256"></a>00256             <span class="comment">// if autopack is on store the packedfile in de font structure</span>
<a name="l00257"></a>00257             <span class="keywordflow">if</span> (!is_builtin &amp;&amp; (<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.fileflags &amp; <a class="code" href="../../d1/d8c/BKE__global_8h.html#a7238d448ec1e56e3b370fc5345a30ab8">G_AUTOPACK</a>)) {
<a name="l00258"></a>00258                 vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a> = <a class="code" href="../../d8/d9d/gim__memory_8h.html#aa7421a08567e946189db67fbebfb88e0" title="Prefetch 64.">pf</a>;
<a name="l00259"></a>00259             }
<a name="l00260"></a>00260             
<a name="l00261"></a>00261             <span class="comment">// Do not add FO_BUILTIN_NAME to temporary listbase</span>
<a name="l00262"></a>00262             <span class="keywordflow">if</span> (strcmp(filename, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>)) {
<a name="l00263"></a>00263                 tmpfnt= (<span class="keyword">struct </span><a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a> *) <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d6/d6b/structTmpFont.html">TmpFont</a>), <span class="stringliteral">&quot;temp_font&quot;</span>);
<a name="l00264"></a>00264                 tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a70768b47e78ae56aea82e45e01020d94">pf</a>= tpf;
<a name="l00265"></a>00265                 tmpfnt-&gt;<a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>= <a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>;
<a name="l00266"></a>00266                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;ttfdata, tmpfnt);
<a name="l00267"></a>00267             }           
<a name="l00268"></a>00268         }
<a name="l00269"></a>00269         
<a name="l00270"></a>00270         <span class="comment">// Free the packed file</span>
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (!vfont || vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#afed9353561fc055c04cd4dda674c4aa5">packedfile</a> != pf) {
<a name="l00272"></a>00272             <a class="code" href="../../d2/d4a/BKE__packedFile_8h.html#a142b7102572dddf111e310a73e54635e">freePackedFile</a>(pf);
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274     
<a name="l00275"></a>00275         <span class="comment">//XXX waitcursor(0);</span>
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     <span class="keywordflow">return</span> <a class="code" href="../../d6/d6b/structTmpFont.html#a83e59c9b308042afb7196a0ec7b8fed7">vfont</a>;
<a name="l00279"></a>00279 }
<a name="l00280"></a>00280 
<a name="l00281"></a><a class="code" href="../../da/d8c/font_8c.html#a89ce1aeed7e860c6bc4e7c9bf2ce1c75">00281</a> <span class="keyword">static</span> <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../da/d8c/font_8c.html#a89ce1aeed7e860c6bc4e7c9bf2ce1c75">which_vfont</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../dc/d38/structCharInfo.html">CharInfo</a> *info)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283     <span class="keywordflow">switch</span>(info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> &amp; (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ae53440110ab6da99125050145248a839">CU_CHINFO_BOLD</a>|<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a42bbac28b3393ff396efdf6119ef07ae">CU_CHINFO_ITALIC</a>)) {
<a name="l00284"></a>00284         <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ae53440110ab6da99125050145248a839">CU_CHINFO_BOLD</a>:
<a name="l00285"></a>00285             <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a97e02bc14fc71f7a56cf4dfb92c6cc4e">vfontb</a>) <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a97e02bc14fc71f7a56cf4dfb92c6cc4e">vfontb</a>); <span class="keywordflow">else</span> <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1735002958cbeb8aaf88094ef6596e78">vfont</a>);
<a name="l00286"></a>00286         <span class="keywordflow">case</span> <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a42bbac28b3393ff396efdf6119ef07ae">CU_CHINFO_ITALIC</a>:
<a name="l00287"></a>00287             <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abb6c8efed809e4d4d0a9a8cf6ffe08e0">vfonti</a>) <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#abb6c8efed809e4d4d0a9a8cf6ffe08e0">vfonti</a>); <span class="keywordflow">else</span> <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1735002958cbeb8aaf88094ef6596e78">vfont</a>);
<a name="l00288"></a>00288         <span class="keywordflow">case</span> (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ae53440110ab6da99125050145248a839">CU_CHINFO_BOLD</a>|<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a42bbac28b3393ff396efdf6119ef07ae">CU_CHINFO_ITALIC</a>):
<a name="l00289"></a>00289             <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad2b3c8b2a7e3439d1257ad170329902f">vfontbi</a>) <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad2b3c8b2a7e3439d1257ad170329902f">vfontbi</a>); <span class="keywordflow">else</span> <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1735002958cbeb8aaf88094ef6596e78">vfont</a>);
<a name="l00290"></a>00290         <span class="keywordflow">default</span>:
<a name="l00291"></a>00291             <span class="keywordflow">return</span>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1735002958cbeb8aaf88094ef6596e78">vfont</a>);
<a name="l00292"></a>00292     }           
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a><a class="code" href="../../da/d8c/font_8c.html#adab6eb767dbcefad5122e469d78b542f">00295</a> <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *<a class="code" href="../../d0/d06/BKE__font_8h.html#a6948084f7d8dc1d7a5e4f64db5c88dbe">get_builtin_font</a>(<span class="keywordtype">void</span>)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297     <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *vf;
<a name="l00298"></a>00298     
<a name="l00299"></a>00299     <span class="keywordflow">for</span> (vf= <a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main-&gt;vfont.first; vf; vf= vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#aa6ee47902f7fe209564d555dd4d8969d">id</a>.<a class="code" href="../../d8/d7e/structID.html#acaa676f1c6169b19d5c23a4f6ea5186c">next</a>)
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (strcmp(vf-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>)==0)
<a name="l00301"></a>00301             <span class="keywordflow">return</span> vf;
<a name="l00302"></a>00302     
<a name="l00303"></a>00303     <span class="keywordflow">return</span> <a class="code" href="../../d0/d06/BKE__font_8h.html#a9da41c072e90b83fc43dc1561145337c">load_vfont</a>(<a class="code" href="../../dc/dc8/util__md5_8cpp.html#ad96b7cf3182ce2ba85e5a7a93b12c441">G</a>.main, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>);
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">00306</a> <span class="keyword">static</span> <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *<a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(<a class="code" href="../../d6/d0a/structVFontData.html">VFontData</a> *vfd, intptr_t character)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308     <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *che= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310     <span class="keywordflow">for</span> (che = vfd-&gt;<a class="code" href="../../d6/d0a/structVFontData.html#a0acbd1097660ebd724b5f1082901292c">characters</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; che; che = che-&gt;<a class="code" href="../../db/d7d/structVChar.html#ace183cddcd18a100ecd63dba020a8ddc">next</a>) {
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a3193a70a6f14f94323f6098ee010cc53">index</a> == character)
<a name="l00312"></a>00312             <span class="keywordflow">break</span>;
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314     <span class="keywordflow">return</span> che; <span class="comment">/* NULL if not found */</span>
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316         
<a name="l00317"></a><a class="code" href="../../da/d8c/font_8c.html#a2ebc8f750f8a1bb225ebac95ba7d14b1">00317</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d8c/font_8c.html#a2ebc8f750f8a1bb225ebac95ba7d14b1">build_underline</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <span class="keywordtype">float</span> x1, <span class="keywordtype">float</span> y1, <span class="keywordtype">float</span> x2, <span class="keywordtype">float</span> y2, <span class="keywordtype">int</span> charidx, <span class="keywordtype">short</span> mat_nr)
<a name="l00318"></a>00318 {
<a name="l00319"></a>00319     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu2;
<a name="l00320"></a>00320     <a class="code" href="../../d9/d51/structBPoint.html">BPoint</a> *bp;
<a name="l00321"></a>00321     
<a name="l00322"></a>00322     nu2 =(<a class="code" href="../../d5/d47/structNurb.html">Nurb</a>*) <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d47/structNurb.html">Nurb</a>),<span class="stringliteral">&quot;underline_nurb&quot;</span>);
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (nu2 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span>;
<a name="l00324"></a>00324     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#aa4d5f2ef5e32e94dcbe14a1a7d946a30">resolu</a>= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a69ba1bcc92e21490b438c065ec972cf6">resolu</a>;
<a name="l00325"></a>00325     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00326"></a>00326     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a35b4a7a3cd387bfb655fc5776ac71e14">knotsu</a> = nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a685aeb6811a4102b617366961f933087">knotsv</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00327"></a>00327     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a3cf1c2dec47235e64740549f9bb2b5ff">flag</a>= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#aaff7c75290c54fa64f73a97718c2faf8">CU_2D</a>;
<a name="l00328"></a>00328     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a3c5ced990e505c6408917ae50489759f">charidx</a> = charidx+1000;
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (mat_nr &gt; 0) nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#aec3c171f54634d9a772bbf8000bc2bb6">mat_nr</a>= mat_nr-1;
<a name="l00330"></a>00330     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a18914e4626a3fa51b6cbfa0964d5f747">pntsu</a> = 4;
<a name="l00331"></a>00331     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a42c8a657d9a11f9601bdf062c5f466b0">pntsv</a> = 1;
<a name="l00332"></a>00332     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2465eeb3c7bf3d9af99d604cb97fabb2">orderu</a> = 4;
<a name="l00333"></a>00333     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2c2a371fce1c6a69220da1c685fc5969">orderv</a> = 1;
<a name="l00334"></a>00334     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a1eb264d76d62b930aa6759c19934df16">flagu</a> = <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a4ec4fe43f3bdfd868e6c620d8df80c88">CU_NURB_CYCLIC</a>;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     bp = (<a class="code" href="../../d9/d51/structBPoint.html">BPoint</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d51/structBPoint.html">BPoint</a>),<span class="stringliteral">&quot;underline_bp&quot;</span>); 
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (bp == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00338"></a>00338         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nu2);
<a name="l00339"></a>00339         <span class="keywordflow">return</span>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a> = bp;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[0].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] = x1;
<a name="l00344"></a>00344     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[0].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] = y1; 
<a name="l00345"></a>00345     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[0].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] = 0;
<a name="l00346"></a>00346     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[0].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[3] = 1.0f;
<a name="l00347"></a>00347     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[1].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] = x2;
<a name="l00348"></a>00348     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[1].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] = y1;
<a name="l00349"></a>00349     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[1].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] = 0;  
<a name="l00350"></a>00350     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[1].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[3] = 1.0f;
<a name="l00351"></a>00351     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[2].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] = x2;
<a name="l00352"></a>00352     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[2].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] = y2; 
<a name="l00353"></a>00353     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[2].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] = 0;
<a name="l00354"></a>00354     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[2].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[3] = 1.0f;
<a name="l00355"></a>00355     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[3].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[0] = x1;
<a name="l00356"></a>00356     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[3].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[1] = y2;
<a name="l00357"></a>00357     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[3].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[2] = 0;  
<a name="l00358"></a>00358     nu2-&gt;<a class="code" href="../../d5/d47/structNurb.html#a96edaa87395fe64773afc328f50c41aa">bp</a>[3].<a class="code" href="../../d9/d51/structBPoint.html#a87a41cbc4756dd60184d0d32153931e5">vec</a>[3] = 1.0f;
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>), nu2);  
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="../../da/d8c/font_8c.html#a5fe63817563785a9cd6db4ae059272d6">00364</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d8c/font_8c.html#a5fe63817563785a9cd6db4ae059272d6">buildchar</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> character, <a class="code" href="../../dc/d38/structCharInfo.html">CharInfo</a> *info, <span class="keywordtype">float</span> ofsx, <span class="keywordtype">float</span> ofsy, <span class="keywordtype">float</span> rot, <span class="keywordtype">int</span> charidx)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a> *bezt1, *bezt2;
<a name="l00367"></a>00367     <a class="code" href="../../d5/d47/structNurb.html">Nurb</a> *nu1 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *nu2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00368"></a>00368     <span class="keywordtype">float</span> *fp, fsize, shear, x, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00369"></a>00369     <a class="code" href="../../d6/d0a/structVFontData.html">VFontData</a> *vfd = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00370"></a>00370     <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *che = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00371"></a>00371     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     vfd= <a class="code" href="../../da/d8c/font_8c.html#aacd0d8ca362bbace3265c257d5cfb306">vfont_get_data</a>(bmain, <a class="code" href="../../da/d8c/font_8c.html#a89ce1aeed7e860c6bc4e7c9bf2ce1c75">which_vfont</a>(cu, info));
<a name="l00374"></a>00374     <span class="keywordflow">if</span> (!vfd) <span class="keywordflow">return</span>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="preprocessor">#if 0</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a> &lt; cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a>) {
<a name="l00378"></a>00378         <span class="keywordflow">if</span> ((charidx &gt;= (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a>)) &amp;&amp; (charidx &lt;= (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a>-2)))
<a name="l00379"></a>00379             sel= 1;
<a name="l00380"></a>00380     }
<a name="l00381"></a>00381     <span class="keywordflow">else</span> {
<a name="l00382"></a>00382         <span class="keywordflow">if</span> ((charidx &gt;= (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a>-1)) &amp;&amp; (charidx &lt;= (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a>-1)))
<a name="l00383"></a>00383             sel= 1;
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385 <span class="preprocessor">#endif</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span>
<a name="l00387"></a>00387     <span class="comment">/* make a copy at distance ofsx,ofsy with shear*/</span>
<a name="l00388"></a>00388     fsize= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00389"></a>00389     shear= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aac04bddd4b1292b6bb749e7762131165">shear</a>;
<a name="l00390"></a>00390     si= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(rot);
<a name="l00391"></a>00391     co= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(rot);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     che= <a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(vfd, character);
<a name="l00394"></a>00394     
<a name="l00395"></a>00395     <span class="comment">// Select the glyph data</span>
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (che)
<a name="l00397"></a>00397         nu1 = che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a64796784138d243b6a747b0336ca404b">nurbsbase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">// Create the character</span>
<a name="l00400"></a>00400     <span class="keywordflow">while</span> (nu1)
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402         bezt1 = nu1-&gt;<a class="code" href="../../d5/d47/structNurb.html#a6d49e0f8d687346a35555e97c0e5e5a0">bezt</a>;
<a name="l00403"></a>00403         <span class="keywordflow">if</span> (bezt1) {
<a name="l00404"></a>00404             nu2 =(<a class="code" href="../../d5/d47/structNurb.html">Nurb</a>*) <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d47/structNurb.html">Nurb</a>),<span class="stringliteral">&quot;duplichar_nurb&quot;</span>);
<a name="l00405"></a>00405             <span class="keywordflow">if</span> (nu2 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">break</span>;
<a name="l00406"></a>00406             memcpy(nu2, nu1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d5/d47/structNurb.html">Nurb</a>));
<a name="l00407"></a>00407             nu2-&gt;resolu= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a69ba1bcc92e21490b438c065ec972cf6">resolu</a>;
<a name="l00408"></a>00408             nu2-&gt;bp = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00409"></a>00409             nu2-&gt;knotsu = nu2-&gt;knotsv = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00410"></a>00410             nu2-&gt;flag= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a52776b893e7d78f3276b98e0b9f56cc1">CU_SMOOTH</a>;
<a name="l00411"></a>00411             nu2-&gt;charidx = charidx;
<a name="l00412"></a>00412             <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#a7a213df43c06c6c62a579e47cc771353">mat_nr</a> &gt; 0) {
<a name="l00413"></a>00413                 nu2-&gt;mat_nr= info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#a7a213df43c06c6c62a579e47cc771353">mat_nr</a>-1;
<a name="l00414"></a>00414             }
<a name="l00415"></a>00415             <span class="keywordflow">else</span> {
<a name="l00416"></a>00416                 nu2-&gt;mat_nr= 0;
<a name="l00417"></a>00417             }
<a name="l00418"></a>00418             <span class="comment">/* nu2-&gt;trim.first = 0; */</span>
<a name="l00419"></a>00419             <span class="comment">/* nu2-&gt;trim.last = 0; */</span>
<a name="l00420"></a>00420             i = nu2-&gt;pntsu;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422             bezt2 = (<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(i * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>),<span class="stringliteral">&quot;duplichar_bezt2&quot;</span>); 
<a name="l00423"></a>00423             <span class="keywordflow">if</span> (bezt2 == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00424"></a>00424                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(nu2);
<a name="l00425"></a>00425                 <span class="keywordflow">break</span>;
<a name="l00426"></a>00426             }
<a name="l00427"></a>00427             memcpy(bezt2, bezt1, i * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../d5/dd9/structBezTriple.html">BezTriple</a>));
<a name="l00428"></a>00428             nu2-&gt;bezt = bezt2;
<a name="l00429"></a>00429             
<a name="l00430"></a>00430             <span class="keywordflow">if</span> (shear != 0.0f) {
<a name="l00431"></a>00431                 bezt2 = nu2-&gt;bezt;
<a name="l00432"></a>00432                 
<a name="l00433"></a>00433                 <span class="keywordflow">for</span> (i= nu2-&gt;pntsu; i &gt; 0; i--) {
<a name="l00434"></a>00434                     bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][0] += shear * bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0][1];
<a name="l00435"></a>00435                     bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][0] += shear * bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[1][1];
<a name="l00436"></a>00436                     bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][0] += shear * bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[2][1];
<a name="l00437"></a>00437                     bezt2++;
<a name="l00438"></a>00438                 }
<a name="l00439"></a>00439             }
<a name="l00440"></a>00440             <span class="keywordflow">if</span> (rot != 0.0f) {
<a name="l00441"></a>00441                 bezt2= nu2-&gt;bezt;
<a name="l00442"></a>00442                 <span class="keywordflow">for</span> (i=nu2-&gt;pntsu; i &gt; 0; i--) {
<a name="l00443"></a>00443                     fp= bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0];
<a name="l00444"></a>00444                     
<a name="l00445"></a>00445                     x= fp[0];
<a name="l00446"></a>00446                     fp[0]= co*x + si*fp[1];
<a name="l00447"></a>00447                     fp[1]= -si*x + co*fp[1];
<a name="l00448"></a>00448                     x= fp[3];
<a name="l00449"></a>00449                     fp[3]= co*x + si*fp[4];
<a name="l00450"></a>00450                     fp[4]= -si*x + co*fp[4];
<a name="l00451"></a>00451                     x= fp[6];
<a name="l00452"></a>00452                     fp[6]= co*x + si*fp[7];
<a name="l00453"></a>00453                     fp[7]= -si*x + co*fp[7];
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                     bezt2++;
<a name="l00456"></a>00456                 }
<a name="l00457"></a>00457             }
<a name="l00458"></a>00458             bezt2 = nu2-&gt;bezt;
<a name="l00459"></a>00459 
<a name="l00460"></a>00460             <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a728acc1cdb211ead38b3cabc1d435645">CU_CHINFO_SMALLCAPS_CHECK</a>) {
<a name="l00461"></a>00461                 <span class="keyword">const</span> <span class="keywordtype">float</span> sca= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac5addf9f547e56142edf1936e78608ef">smallcaps_scale</a>;
<a name="l00462"></a>00462                 <span class="keywordflow">for</span> (i= nu2-&gt;pntsu; i &gt; 0; i--) {
<a name="l00463"></a>00463                     fp= bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0];
<a name="l00464"></a>00464                     fp[0] *= sca;
<a name="l00465"></a>00465                     fp[1] *= sca;
<a name="l00466"></a>00466                     fp[3] *= sca;
<a name="l00467"></a>00467                     fp[4] *= sca;
<a name="l00468"></a>00468                     fp[6] *= sca;
<a name="l00469"></a>00469                     fp[7] *= sca;
<a name="l00470"></a>00470                     bezt2++;
<a name="l00471"></a>00471                 }
<a name="l00472"></a>00472             }
<a name="l00473"></a>00473             bezt2 = nu2-&gt;bezt;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475             <span class="keywordflow">for</span> (i= nu2-&gt;pntsu; i &gt; 0; i--) {
<a name="l00476"></a>00476                 fp= bezt2-&gt;<a class="code" href="../../d5/dd9/structBezTriple.html#a65c1569ddc02a36e6d245fa1cdd0f87e">vec</a>[0];
<a name="l00477"></a>00477                 fp[0]= (fp[0]+ofsx)*fsize;
<a name="l00478"></a>00478                 fp[1]= (fp[1]+ofsy)*fsize;
<a name="l00479"></a>00479                 fp[3]= (fp[3]+ofsx)*fsize;
<a name="l00480"></a>00480                 fp[4]= (fp[4]+ofsy)*fsize;
<a name="l00481"></a>00481                 fp[6]= (fp[6]+ofsx)*fsize;
<a name="l00482"></a>00482                 fp[7]= (fp[7]+ofsy)*fsize;
<a name="l00483"></a>00483                 bezt2++;
<a name="l00484"></a>00484             }
<a name="l00485"></a>00485             
<a name="l00486"></a>00486             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>), nu2);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488         
<a name="l00489"></a>00489         nu1 = nu1-&gt;<a class="code" href="../../d5/d47/structNurb.html#a2a65b45cf9d2eb81b3b92d872e777aaa">next</a>;
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491 }
<a name="l00492"></a>00492 
<a name="l00493"></a><a class="code" href="../../da/d8c/font_8c.html#ab100ab55c0593606c1e7c60b359152e4">00493</a> <span class="keywordtype">int</span> <a class="code" href="../../d0/d06/BKE__font_8h.html#abb4a02f496f77aefaeefcbd81c1410d8">BKE_font_getselection</a>(<a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> *start, <span class="keywordtype">int</span> *end)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu= ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a5cea9d9cf980788715e190c6261cd0a3">editfont</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1a94162b6fc469957966a01d41ff71d6">OB_FONT</a>) <span class="keywordflow">return</span> 0;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a> == 0) <span class="keywordflow">return</span> 0;
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a> &lt;= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a>) {
<a name="l00501"></a>00501         *start = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a>-1;
<a name="l00502"></a>00502         *end = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a>-1;
<a name="l00503"></a>00503         <span class="keywordflow">return</span> 1;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505     <span class="keywordflow">else</span> {
<a name="l00506"></a>00506         *start = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a271cb484b1d919b602298536ae53d001">selend</a>;
<a name="l00507"></a>00507         *end = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a364609740189d711bb135467cc7b0829">selstart</a>-2;
<a name="l00508"></a>00508         <span class="keywordflow">return</span> -1;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a><a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">00512</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">char_width</a>(<a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu, <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *che, <a class="code" href="../../dc/d38/structCharInfo.html">CharInfo</a> *info)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     <span class="comment">// The character wasn&#39;t found, propably ascii = 0, then the width shall be 0 as well</span>
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (che == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00516"></a>00516         <span class="keywordflow">return</span> 0.0f;
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a728acc1cdb211ead38b3cabc1d435645">CU_CHINFO_SMALLCAPS_CHECK</a>) {
<a name="l00519"></a>00519         <span class="keywordflow">return</span> che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a10891613cb95444ed9d68fc43bf8c72c">width</a> * cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac5addf9f547e56142edf1936e78608ef">smallcaps_scale</a>;
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     <span class="keywordflow">else</span> {
<a name="l00522"></a>00522         <span class="keywordflow">return</span> che-&gt;<a class="code" href="../../db/d7d/structVChar.html#a10891613cb95444ed9d68fc43bf8c72c">width</a>;
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a><a class="code" href="../../da/d8c/font_8c.html#a47ae80eb978c75aae8870b96e39dbebc">00526</a> <span class="keyword">struct </span><a class="code" href="../../de/d65/structchartrans.html">chartrans</a> *<a class="code" href="../../d0/d06/BKE__font_8h.html#a34e015d65829050ac2c576349bdac8b2">BKE_text_to_curve</a>(<a class="code" href="../../d0/dc0/structMain.html">Main</a> *bmain, <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene, <a class="code" href="../../de/de7/structObject.html">Object</a> *ob, <span class="keywordtype">int</span> mode)
<a name="l00527"></a>00527 {
<a name="l00528"></a>00528     <a class="code" href="../../dc/dbe/structVFont.html">VFont</a> *vfont, *oldvfont;
<a name="l00529"></a>00529     <a class="code" href="../../d6/d0a/structVFontData.html">VFontData</a> *vfd= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00530"></a>00530     <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cu;
<a name="l00531"></a>00531     <a class="code" href="../../dc/d38/structCharInfo.html">CharInfo</a> *info = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *custrinfo;
<a name="l00532"></a>00532     <a class="code" href="../../de/d25/structTextBox.html">TextBox</a> *tb;
<a name="l00533"></a>00533     <a class="code" href="../../db/d7d/structVChar.html">VChar</a> *che;
<a name="l00534"></a>00534     <span class="keyword">struct </span><a class="code" href="../../de/d65/structchartrans.html">chartrans</a> *chartransdata=<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *ct;
<a name="l00535"></a>00535     <span class="keywordtype">float</span> *f, <a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>, <a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>, xtrax, linedist, *linedata, *linedata2, *linedata3, *linedata4;
<a name="l00536"></a>00536     <span class="keywordtype">float</span> twidth, maxlen= 0;
<a name="l00537"></a>00537     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, slen, j;
<a name="l00538"></a>00538     <span class="keywordtype">int</span> curbox;
<a name="l00539"></a>00539     <span class="keywordtype">int</span> selstart, selend;
<a name="l00540"></a>00540     <span class="keywordtype">int</span> utf8len;
<a name="l00541"></a>00541     <span class="keywordtype">short</span> cnr=0, lnr=0, wsnr= 0;
<a name="l00542"></a>00542     <span class="keywordtype">wchar_t</span> *mem, *tmp, ascii;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">/* renark: do calculations including the trailing &#39;\0&#39; of a string</span>
<a name="l00545"></a>00545 <span class="comment">     * because the cursor can be at that location */</span>
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="keywordflow">if</span> (ob-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>!=<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a1a94162b6fc469957966a01d41ff71d6">OB_FONT</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549     <span class="comment">// Set font data</span>
<a name="l00550"></a>00550     cu= (<a class="code" href="../../da/d10/structCurve.html">Curve</a> *) ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00551"></a>00551     vfont= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1735002958cbeb8aaf88094ef6596e78">vfont</a>;
<a name="l00552"></a>00552     
<a name="l00553"></a>00553     <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ab0b4dc5959c529381dbc6a954a8a39b6">str</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (vfont == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="comment">// Create unicode string</span>
<a name="l00557"></a>00557     utf8len = <a class="code" href="../../dd/d83/BLI__string__utf8_8h.html#a4a874c76b35394d08d76587fb6e6f4ef">BLI_strlen_utf8</a>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ab0b4dc5959c529381dbc6a954a8a39b6">str</a>);
<a name="l00558"></a>00558     mem = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(((utf8len + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)), <span class="stringliteral">&quot;convertedmem&quot;</span>);
<a name="l00559"></a>00559     
<a name="l00560"></a>00560     <a class="code" href="../../dd/d83/BLI__string__utf8_8h.html#a75ee1c80fc7d1e45c804bd10e6782b7c">BLI_strncpy_wchar_from_utf8</a>(mem, cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ab0b4dc5959c529381dbc6a954a8a39b6">str</a>, utf8len + 1);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="comment">// Count the wchar_t string length</span>
<a name="l00563"></a>00563     slen = wcslen(mem);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4e0212cf92e3b7f1d2c355632c566905">ulheight</a> == 0.0f)
<a name="l00566"></a>00566         cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4e0212cf92e3b7f1d2c355632c566905">ulheight</a> = 0.05f;
<a name="l00567"></a>00567     
<a name="l00568"></a>00568     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a95ab12824ad734ab8bc052cd7fdcc22d">strinfo</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)  <span class="comment">/* old file */</span>
<a name="l00569"></a>00569         cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a95ab12824ad734ab8bc052cd7fdcc22d">strinfo</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((slen+4) * <span class="keyword">sizeof</span>(<a class="code" href="../../dc/d38/structCharInfo.html">CharInfo</a>), <span class="stringliteral">&quot;strinfo compat&quot;</span>);
<a name="l00570"></a>00570     
<a name="l00571"></a>00571     custrinfo= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a95ab12824ad734ab8bc052cd7fdcc22d">strinfo</a>;
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a5cea9d9cf980788715e190c6261cd0a3">editfont</a>)
<a name="l00573"></a>00573         custrinfo= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a5cea9d9cf980788715e190c6261cd0a3">editfont</a>-&gt;<a class="code" href="../../d7/d68/structEditFont.html#ae82ed115de0ddf3db8797d8d87465552">textbufinfo</a>;
<a name="l00574"></a>00574     
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00576"></a>00576         cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a2781f12837323bb5b150f82d0f0ff70e">MAXTEXTBOX</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../de/d25/structTextBox.html">TextBox</a>), <span class="stringliteral">&quot;TextBox compat&quot;</span>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     vfd= <a class="code" href="../../da/d8c/font_8c.html#aacd0d8ca362bbace3265c257d5cfb306">vfont_get_data</a>(bmain, vfont);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">/* The VFont Data can not be found */</span>
<a name="l00581"></a>00581     <span class="keywordflow">if</span> (!vfd) {
<a name="l00582"></a>00582         <span class="keywordflow">if</span> (mem)
<a name="l00583"></a>00583             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem); 
<a name="l00584"></a>00584         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="comment">/* calc offset and rotation of each char */</span>
<a name="l00588"></a>00588     ct = chartransdata =
<a name="l00589"></a>00589         (<span class="keyword">struct </span><a class="code" href="../../de/d65/structchartrans.html">chartrans</a>*)<a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((slen+1)* <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../de/d65/structchartrans.html">chartrans</a>),&quot;buildtext&quot;);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     <span class="comment">/* We assume the worst case: 1 character per line (is freed at end anyway) */</span>
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     linedata= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(slen*2 + 1),<span class="stringliteral">&quot;buildtext2&quot;</span>);
<a name="l00594"></a>00594     linedata2= <a class="code" href="../../da/d2b/mallocn_8c.html#a2bfff00be1f0c49f1945b5d6f66af243">MEM_mallocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(slen*2 + 1),<span class="stringliteral">&quot;buildtext3&quot;</span>);
<a name="l00595"></a>00595     linedata3= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(slen*2 + 1),<span class="stringliteral">&quot;buildtext4&quot;</span>);    
<a name="l00596"></a>00596     linedata4= <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*(slen*2 + 1),<span class="stringliteral">&quot;buildtext5&quot;</span>);        
<a name="l00597"></a>00597     
<a name="l00598"></a>00598     linedist= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#acbb034dac5b4158a67bcf9150c9fa630">linedist</a>;
<a name="l00599"></a>00599     
<a name="l00600"></a>00600     xof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a> + (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>[0].<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>);
<a name="l00601"></a>00601     yof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad28126b68b497a6f89737747072cd928">yof</a> + (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>[0].<a class="code" href="../../de/d25/structTextBox.html#a2f77f6a8c084e2bcb50b9d758ac4c3ef">y</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>);
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     xtrax= 0.5f*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a0de9e46069c2ade3242130d71cbf8b8a">spacing</a>-0.5f;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     oldvfont = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">for</span> (i=0; i&lt;slen; i++) custrinfo[i].flag &amp;= ~(<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a079fbf7c8c722c0cb699ff099db79c2d">CU_CHINFO_WRAP</a>|<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a728acc1cdb211ead38b3cabc1d435645">CU_CHINFO_SMALLCAPS_CHECK</a>);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>) <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>);
<a name="l00610"></a>00610     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d06/BKE__font_8h.html#abb4a02f496f77aefaeefcbd81c1410d8">BKE_font_getselection</a>(ob, &amp;selstart, &amp;selend))
<a name="l00612"></a>00612         cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>((selend-selstart+1)*<span class="keyword">sizeof</span>(<a class="code" href="../../db/db5/structSelBox.html">SelBox</a>), <span class="stringliteral">&quot;font selboxes&quot;</span>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     tb = &amp;(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>[0]);
<a name="l00615"></a>00615     curbox= 0;
<a name="l00616"></a>00616     <span class="keywordflow">for</span> (i = 0 ; i&lt;=slen ; i++) {
<a name="l00617"></a>00617     makebreak:
<a name="l00618"></a>00618         <span class="comment">// Characters in the list</span>
<a name="l00619"></a>00619         info = &amp;(custrinfo[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l00620"></a>00620         ascii = mem[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00621"></a>00621         <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#af939c842790863531da104c4205a53b0">CU_CHINFO_SMALLCAPS</a>) {
<a name="l00622"></a>00622             ascii = towupper(ascii);
<a name="l00623"></a>00623             <span class="keywordflow">if</span> (mem[i] != ascii) {
<a name="l00624"></a>00624                 mem[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= ascii;
<a name="l00625"></a>00625                 info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> |= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a728acc1cdb211ead38b3cabc1d435645">CU_CHINFO_SMALLCAPS_CHECK</a>;
<a name="l00626"></a>00626             }
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         vfont = <a class="code" href="../../da/d8c/font_8c.html#a89ce1aeed7e860c6bc4e7c9bf2ce1c75">which_vfont</a>(cu, info);
<a name="l00630"></a>00630         
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (vfont==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">break</span>;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         che= <a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(vfd, ascii);
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         <span class="comment">/*</span>
<a name="l00636"></a>00636 <span class="comment">         * The character wasn&#39;t in the current curve base so load it</span>
<a name="l00637"></a>00637 <span class="comment">         * But if the font is FO_BUILTIN_NAME then do not try loading since</span>
<a name="l00638"></a>00638 <span class="comment">         * whole font is in the memory already</span>
<a name="l00639"></a>00639 <span class="comment">         */</span>
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (che == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; strcmp(vfont-&gt;<a class="code" href="../../dc/dbe/structVFont.html#abd754d2a8b6a2241d7b7464d0a98d339">name</a>, <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a6c156185941e8d7776c0536b0f392201">FO_BUILTIN_NAME</a>))    {
<a name="l00641"></a>00641             <a class="code" href="../../d0/d4a/BLI__vfontdata_8h.html#ab5c17057ae2cdc2ee767dc0ef0d3e93f">BLI_vfontchar_from_freetypefont</a>(vfont, ascii);
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644         <span class="comment">/* Try getting the character again from the list */</span>
<a name="l00645"></a>00645         che= <a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(vfd, ascii);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         <span class="comment">/* No VFont found */</span>
<a name="l00648"></a>00648         <span class="keywordflow">if</span> (vfont==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00649"></a>00649             <span class="keywordflow">if</span> (mem)
<a name="l00650"></a>00650                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem);
<a name="l00651"></a>00651             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(chartransdata);
<a name="l00652"></a>00652             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (vfont != oldvfont) {
<a name="l00656"></a>00656             vfd= <a class="code" href="../../da/d8c/font_8c.html#aacd0d8ca362bbace3265c257d5cfb306">vfont_get_data</a>(bmain, vfont);
<a name="l00657"></a>00657             oldvfont = vfont;
<a name="l00658"></a>00658         }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         <span class="comment">/* VFont Data for VFont couldn&#39;t be found */</span>
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (!vfd) {
<a name="l00662"></a>00662             <span class="keywordflow">if</span> (mem)
<a name="l00663"></a>00663                 <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem);
<a name="l00664"></a>00664             <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(chartransdata);
<a name="l00665"></a>00665             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         twidth = <a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">char_width</a>(cu, che, info);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         <span class="comment">// Calculate positions</span>
<a name="l00671"></a>00671         <span class="keywordflow">if</span> ((tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a3cc521cc3bd6b4ba5592e898e0eaa863">w</a> != 0.0f) &amp;&amp; (ct-&gt;dobreak==0) &amp;&amp; ((xof-(tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>)+twidth)*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>) &gt; tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a3cc521cc3bd6b4ba5592e898e0eaa863">w</a> + cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>) {
<a name="l00672"></a>00672     <span class="comment">//      fprintf(stderr, &quot;linewidth exceeded: %c%c%c...\n&quot;, mem[i], mem[i+1], mem[i+2]);</span>
<a name="l00673"></a>00673             <span class="keywordflow">for</span> (j=i; j &amp;&amp; (mem[j] != <span class="charliteral">&#39;\n&#39;</span>) &amp;&amp; (mem[j] != <span class="charliteral">&#39;\r&#39;</span>) &amp;&amp; (chartransdata[j].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a>==0); j--) {
<a name="l00674"></a>00674                 <span class="keywordflow">if</span> (mem[j]==<span class="charliteral">&#39; &#39;</span> || mem[j]==<span class="charliteral">&#39;-&#39;</span>) {
<a name="l00675"></a>00675                     ct -= (i-(j-1));
<a name="l00676"></a>00676                     cnr -= (i-(j-1));
<a name="l00677"></a>00677                     <span class="keywordflow">if</span> (mem[j] == <span class="charliteral">&#39; &#39;</span>) wsnr--;
<a name="l00678"></a>00678                     <span class="keywordflow">if</span> (mem[j] == <span class="charliteral">&#39;-&#39;</span>) wsnr++;
<a name="l00679"></a>00679                     i = j-1;
<a name="l00680"></a>00680                     xof = ct-&gt;xof;
<a name="l00681"></a>00681                     ct[1].dobreak = 1;
<a name="l00682"></a>00682                     custrinfo[i+1].flag |= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a079fbf7c8c722c0cb699ff099db79c2d">CU_CHINFO_WRAP</a>;
<a name="l00683"></a>00683                     <span class="keywordflow">goto</span> makebreak;
<a name="l00684"></a>00684                 }
<a name="l00685"></a>00685                 <span class="keywordflow">if</span> (chartransdata[j].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a>) {
<a name="l00686"></a>00686     <span class="comment">//              fprintf(stderr, &quot;word too long: %c%c%c...\n&quot;, mem[j], mem[j+1], mem[j+2]);</span>
<a name="l00687"></a>00687                     ct-&gt;dobreak= 1;
<a name="l00688"></a>00688                     custrinfo[i+1].flag |= <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a079fbf7c8c722c0cb699ff099db79c2d">CU_CHINFO_WRAP</a>;
<a name="l00689"></a>00689                     ct -= 1;
<a name="l00690"></a>00690                     cnr -= 1;
<a name="l00691"></a>00691                     i--;
<a name="l00692"></a>00692                     xof = ct-&gt;xof;
<a name="l00693"></a>00693                     <span class="keywordflow">goto</span> makebreak;
<a name="l00694"></a>00694                 }
<a name="l00695"></a>00695             }
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697         <span class="keywordflow">if</span> (ascii== <span class="charliteral">&#39;\n&#39;</span> || ascii== <span class="charliteral">&#39;\r&#39;</span> || ascii==0 || ct-&gt;dobreak) {
<a name="l00698"></a>00698             ct-&gt;xof= <a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>;
<a name="l00699"></a>00699             ct-&gt;yof= <a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>;
<a name="l00700"></a>00700             ct-&gt;linenr= lnr;
<a name="l00701"></a>00701             ct-&gt;charnr= cnr;
<a name="l00702"></a>00702             
<a name="l00703"></a>00703             yof-= linedist;
<a name="l00704"></a>00704             
<a name="l00705"></a>00705             maxlen= <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(maxlen, (xof-tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>));
<a name="l00706"></a>00706             linedata[lnr]= xof-tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00707"></a>00707             linedata2[lnr]= cnr;
<a name="l00708"></a>00708             linedata3[lnr]= tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a3cc521cc3bd6b4ba5592e898e0eaa863">w</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00709"></a>00709             linedata4[lnr]= wsnr;
<a name="l00710"></a>00710             
<a name="l00711"></a>00711             <span class="keywordflow">if</span> ( (tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a1fd41eef9b87497341c61d9e89e5da43">h</a> != 0.0f) &amp;&amp;
<a name="l00712"></a>00712                  ((-(yof-(tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a2f77f6a8c084e2bcb50b9d758ac4c3ef">y</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>))) &gt; ((tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a1fd41eef9b87497341c61d9e89e5da43">h</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>)-(linedist*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>)) - cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad28126b68b497a6f89737747072cd928">yof</a>) &amp;&amp;
<a name="l00713"></a>00713                  (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a653d6829b5c84d43744c7939f32b0c3b">totbox</a> &gt; (curbox+1)) ) {
<a name="l00714"></a>00714                 maxlen= 0;
<a name="l00715"></a>00715                 tb++;
<a name="l00716"></a>00716                 curbox++;
<a name="l00717"></a>00717                 yof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad28126b68b497a6f89737747072cd928">yof</a> + tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#a2f77f6a8c084e2bcb50b9d758ac4c3ef">y</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00718"></a>00718             }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720             <span class="comment">/* XXX, has been unused for years, need to check if this is useful, r4613 r5282 - campbell */</span>
<a name="l00721"></a>00721 <span class="preprocessor">#if 0</span>
<a name="l00722"></a>00722 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ascii == <span class="charliteral">&#39;\n&#39;</span> || ascii == <span class="charliteral">&#39;\r&#39;</span>)
<a name="l00723"></a>00723                 xof = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>;
<a name="l00724"></a>00724             <span class="keywordflow">else</span>
<a name="l00725"></a>00725                 xof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a> + (tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>);
<a name="l00726"></a>00726 <span class="preprocessor">#else</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span>            xof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a> + (tb-&gt;<a class="code" href="../../de/d25/structTextBox.html#aec6aed2bbe57bc20e43917b72a4da610">x</a>/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>);
<a name="l00728"></a>00728 <span class="preprocessor">#endif</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span>            lnr++;
<a name="l00730"></a>00730             cnr= 0;
<a name="l00731"></a>00731             wsnr= 0;
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ascii==9) {    <span class="comment">/* TAB */</span>
<a name="l00734"></a>00734             <span class="keywordtype">float</span> tabfac;
<a name="l00735"></a>00735             
<a name="l00736"></a>00736             ct-&gt;xof= <a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>;
<a name="l00737"></a>00737             ct-&gt;yof= <a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>;
<a name="l00738"></a>00738             ct-&gt;linenr= lnr;
<a name="l00739"></a>00739             ct-&gt;charnr= cnr++;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741             tabfac= (xof-cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>+0.01f);
<a name="l00742"></a>00742             tabfac= 2.0f*<a class="code" href="../../dd/d06/BLI__math__base_8h.html#af4de395f6b07e09d3d5fc1a66af3d1b1">ceilf</a>(tabfac/2.0f);
<a name="l00743"></a>00743             xof= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>+tabfac;
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745         <span class="keywordflow">else</span> {
<a name="l00746"></a>00746             <a class="code" href="../../db/db5/structSelBox.html">SelBox</a> *sb= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00747"></a>00747             <span class="keywordtype">float</span> wsfac;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749             ct-&gt;xof= <a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>;
<a name="l00750"></a>00750             ct-&gt;yof= <a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>;
<a name="l00751"></a>00751             ct-&gt;linenr= lnr;
<a name="l00752"></a>00752             ct-&gt;charnr= cnr++;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754             <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a> &amp;&amp; (i&gt;=selstart) &amp;&amp; (i&lt;=selend)) {
<a name="l00755"></a>00755                 sb = &amp;(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>[i-selstart]);
<a name="l00756"></a>00756                 sb-&gt;<a class="code" href="../../db/db5/structSelBox.html#af41d6b651d97d472ae70ca6c12a8e0cd">y</a> = yof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>-linedist*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*0.1f;
<a name="l00757"></a>00757                 sb-&gt;<a class="code" href="../../db/db5/structSelBox.html#ade443e4ce605b9737453efe9b25f8e0f">h</a> = linedist*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00758"></a>00758                 sb-&gt;<a class="code" href="../../db/db5/structSelBox.html#a96ee047f9bb8d6d4b6648677f78fbe75">w</a> = xof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00759"></a>00759             }
<a name="l00760"></a>00760     
<a name="l00761"></a>00761             <span class="keywordflow">if</span> (ascii==32) {
<a name="l00762"></a>00762                 wsfac = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a7aaf33141afe2cd8eb03e34256fd09db">wordspace</a>; 
<a name="l00763"></a>00763                 wsnr++;
<a name="l00764"></a>00764             } 
<a name="l00765"></a>00765             <span class="keywordflow">else</span> wsfac = 1.0f;
<a name="l00766"></a>00766             
<a name="l00767"></a>00767             <span class="comment">// Set the width of the character</span>
<a name="l00768"></a>00768             twidth = <a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">char_width</a>(cu, che, info);
<a name="l00769"></a>00769 
<a name="l00770"></a>00770             xof += (twidth*wsfac*(1.0f+(info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#acf44b35ebdf823280f74ed5328210a6c">kern</a>/40.0f)) ) + xtrax;
<a name="l00771"></a>00771             
<a name="l00772"></a>00772             <span class="keywordflow">if</span> (sb) 
<a name="l00773"></a>00773                 sb-&gt;<a class="code" href="../../db/db5/structSelBox.html#a96ee047f9bb8d6d4b6648677f78fbe75">w</a> = (xof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>) - sb-&gt;<a class="code" href="../../db/db5/structSelBox.html#a96ee047f9bb8d6d4b6648677f78fbe75">w</a>;
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         ct++;
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777     
<a name="l00778"></a>00778     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a6ac9bb68bd8b19384d36c5f4617ede0e">lines</a>= 1;
<a name="l00779"></a>00779     ct= chartransdata;
<a name="l00780"></a>00780     tmp = mem;
<a name="l00781"></a>00781     <span class="keywordflow">for</span> (i= 0; i&lt;=slen; i++, tmp++, ct++) {
<a name="l00782"></a>00782         ascii = *tmp;
<a name="l00783"></a>00783         <span class="keywordflow">if</span> (ascii== <span class="charliteral">&#39;\n&#39;</span> || ascii== <span class="charliteral">&#39;\r&#39;</span> || ct-&gt;dobreak) cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a6ac9bb68bd8b19384d36c5f4617ede0e">lines</a>++;
<a name="l00784"></a>00784     }   
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     <span class="comment">// linedata is now: width of line</span>
<a name="l00787"></a>00787     <span class="comment">// linedata2 is now: number of characters</span>
<a name="l00788"></a>00788     <span class="comment">// linedata3 is now: maxlen of that line</span>
<a name="l00789"></a>00789     <span class="comment">// linedata4 is now: number of whitespaces of line</span>
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>!=<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a4604df3e6f06cccde4712d6c398a4b77">CU_LEFT</a>) {
<a name="l00792"></a>00792         ct= chartransdata;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a23abf1f01b0c2a4a5e4c4d7b8b44b50d">CU_RIGHT</a>) {
<a name="l00795"></a>00795             <span class="keywordflow">for</span> (i=0;i&lt;lnr;i++) linedata[i]= linedata3[i]-linedata[i];
<a name="l00796"></a>00796             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++) {
<a name="l00797"></a>00797                 ct-&gt;<a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>+= linedata[ct-&gt;linenr];
<a name="l00798"></a>00798                 ct++;
<a name="l00799"></a>00799             }
<a name="l00800"></a>00800         }
<a name="l00801"></a>00801         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad25131c0b8d4f2a4f6daabae5e134e5f">CU_MIDDLE</a>) {
<a name="l00802"></a>00802             <span class="keywordflow">for</span> (i=0;i&lt;lnr;i++) linedata[i]= (linedata3[i]-linedata[i])/2;
<a name="l00803"></a>00803             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++) {
<a name="l00804"></a>00804                 ct-&gt;xof+= linedata[ct-&gt;linenr];
<a name="l00805"></a>00805                 ct++;
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a7106e671a1b9a7cac7f107fd1340775b">CU_FLUSH</a>) &amp;&amp;
<a name="l00809"></a>00809                   (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>[0].<a class="code" href="../../de/d25/structTextBox.html#a3cc521cc3bd6b4ba5592e898e0eaa863">w</a> != 0.0f)) {
<a name="l00810"></a>00810             <span class="keywordflow">for</span> (i=0;i&lt;lnr;i++)
<a name="l00811"></a>00811                 <span class="keywordflow">if</span> (linedata2[i]&gt;1)
<a name="l00812"></a>00812                     linedata[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]= (linedata3[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-linedata[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>])/(linedata2[i]-1);
<a name="l00813"></a>00813             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++) {
<a name="l00814"></a>00814                 <span class="keywordflow">for</span> (j=i; (!<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(mem[j], <span class="charliteral">&#39;\0&#39;</span>, <span class="charliteral">&#39;\n&#39;</span>, <span class="charliteral">&#39;\r&#39;</span>)) &amp;&amp; (chartransdata[j].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a> == 0) &amp;&amp; (j &lt; slen); j++) {
<a name="l00815"></a>00815                     <span class="comment">/* do nothing */</span>
<a name="l00816"></a>00816                 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <span class="comment">//              if ((mem[j]!=&#39;\r&#39;) &amp;&amp; (mem[j]!=&#39;\n&#39;) &amp;&amp; (mem[j])) {</span>
<a name="l00819"></a>00819                     ct-&gt;xof+= ct-&gt;charnr*linedata[ct-&gt;linenr];
<a name="l00820"></a>00820 <span class="comment">//              }</span>
<a name="l00821"></a>00821                 ct++;
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823         } 
<a name="l00824"></a>00824         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a0798c9bc9962109fd48bae62762c4673">CU_JUSTIFY</a>) &amp;&amp; (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a2d8913e7de716473cc851148c2d2db19">tb</a>[0].<a class="code" href="../../de/d25/structTextBox.html#a3cc521cc3bd6b4ba5592e898e0eaa863">w</a> != 0.0f)) {
<a name="l00825"></a>00825             <span class="keywordtype">float</span> curofs= 0.0f;
<a name="l00826"></a>00826             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++) {
<a name="l00827"></a>00827                 <span class="keywordflow">for</span> (j=i; (mem[j]) &amp;&amp; (mem[j]!=<span class="charliteral">&#39;\n&#39;</span>) &amp;&amp; 
<a name="l00828"></a>00828                           (mem[j]!=<span class="charliteral">&#39;\r&#39;</span>) &amp;&amp; (chartransdata[j].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a>==0) &amp;&amp; (j&lt;slen); j++);
<a name="l00829"></a>00829                 <span class="keywordflow">if</span> ((mem[j]!=<span class="charliteral">&#39;\r&#39;</span>) &amp;&amp; (mem[j]!=<span class="charliteral">&#39;\n&#39;</span>) &amp;&amp;
<a name="l00830"></a>00830                     ((chartransdata[j].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a>!=0))) {
<a name="l00831"></a>00831                     <span class="keywordflow">if</span> (mem[i]==<span class="charliteral">&#39; &#39;</span>) curofs += (linedata3[ct-&gt;linenr]-linedata[ct-&gt;linenr])/linedata4[ct-&gt;linenr];
<a name="l00832"></a>00832                     ct-&gt;xof+= curofs;
<a name="l00833"></a>00833                 }
<a name="l00834"></a>00834                 <span class="keywordflow">if</span> (mem[i]==<span class="charliteral">&#39;\n&#39;</span> || mem[i]==<span class="charliteral">&#39;\r&#39;</span> || chartransdata[i].<a class="code" href="../../de/d65/structchartrans.html#a75e94d2adfa504c4e196fbf99e9b31a4">dobreak</a>) curofs= 0;
<a name="l00835"></a>00835                 ct++;
<a name="l00836"></a>00836             }           
<a name="l00837"></a>00837         }
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     
<a name="l00840"></a>00840     <span class="comment">/* TEXT ON CURVE */</span>
<a name="l00841"></a>00841     <span class="comment">/* Note: Only OB_CURVE objects could have a path  */</span>
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a> &amp;&amp; cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a>==<a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a885d669104f0c596dabb147f9371ffc3">OB_CURVE</a>) {
<a name="l00843"></a>00843         <a class="code" href="../../da/d10/structCurve.html">Curve</a> *cucu= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00844"></a>00844         <span class="keywordtype">int</span> oldflag= cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a>;
<a name="l00845"></a>00845         
<a name="l00846"></a>00846         cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a> |= (<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ae59d98d3a2c7e6fddf4aa7fff72bcf88">CU_PATH</a>+<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a6e46f4b6302135168dd7630f1bfe6d2a">CU_FOLLOW</a>);
<a name="l00847"></a>00847         
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>==<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <a class="code" href="../../d9/d12/BKE__displist_8h.html#a5ca43234b8f9db71b0318b29716b5487">makeDispListCurveTypes</a>(scene, cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>, 0);
<a name="l00849"></a>00849         <span class="keywordflow">if</span> (cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>) {
<a name="l00850"></a>00850             <span class="keywordtype">float</span> distfac, imat[4][4], imat3[3][3], cmat[3][3];
<a name="l00851"></a>00851             <span class="keywordtype">float</span> minx, maxx, miny, maxy;
<a name="l00852"></a>00852             <span class="keywordtype">float</span> timeofs, sizefac;
<a name="l00853"></a>00853             
<a name="l00854"></a>00854             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(imat, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00855"></a>00855             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat3, imat);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(cmat, cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00858"></a>00858             <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a6879ca084fea564be44fbdd816781f74">mul_m3_m3m3</a>(cmat, cmat, imat3);
<a name="l00859"></a>00859             sizefac= <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(cmat[0])/cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00860"></a>00860             
<a name="l00861"></a>00861             minx=miny= 1.0e20f;
<a name="l00862"></a>00862             maxx=maxy= -1.0e20f;
<a name="l00863"></a>00863             ct= chartransdata;
<a name="l00864"></a>00864             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++, ct++) {
<a name="l00865"></a>00865                 <span class="keywordflow">if</span> (minx&gt;ct-&gt;xof) minx= ct-&gt;<a class="code" href="../../de/d65/structchartrans.html#a5dc47b9cb83394c3e1e20485d7e5163c">xof</a>;
<a name="l00866"></a>00866                 <span class="keywordflow">if</span> (maxx&lt;ct-&gt;xof) maxx= ct-&gt;xof;
<a name="l00867"></a>00867                 <span class="keywordflow">if</span> (miny&gt;ct-&gt;yof) miny= ct-&gt;yof;
<a name="l00868"></a>00868                 <span class="keywordflow">if</span> (maxy&lt;ct-&gt;yof) maxy= ct-&gt;yof;
<a name="l00869"></a>00869             }
<a name="l00870"></a>00870             
<a name="l00871"></a>00871             <span class="comment">/* we put the x-coordinaat exact at the curve, the y is rotated */</span>
<a name="l00872"></a>00872             
<a name="l00873"></a>00873             <span class="comment">/* length correction */</span>
<a name="l00874"></a>00874             distfac= sizefac*cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#a946ca944a39e912802a59396578e5a1f">path</a>-&gt;<a class="code" href="../../d3/d20/structPath.html#ac0bc2bd2f6fe492858b63a74005543af">totdist</a>/(maxx-minx);
<a name="l00875"></a>00875             timeofs= 0.0f;
<a name="l00876"></a>00876             
<a name="l00877"></a>00877             <span class="keywordflow">if</span> (distfac &gt; 1.0f) {
<a name="l00878"></a>00878                 <span class="comment">/* path longer than text: spacemode involves */</span>
<a name="l00879"></a>00879                 distfac= 1.0f/distfac;
<a name="l00880"></a>00880                 
<a name="l00881"></a>00881                 <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a23abf1f01b0c2a4a5e4c4d7b8b44b50d">CU_RIGHT</a>) {
<a name="l00882"></a>00882                     timeofs= 1.0f-distfac;
<a name="l00883"></a>00883                 }
<a name="l00884"></a>00884                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#ad25131c0b8d4f2a4f6daabae5e134e5f">CU_MIDDLE</a>) {
<a name="l00885"></a>00885                     timeofs= (1.0f-distfac)/2.0f;
<a name="l00886"></a>00886                 }
<a name="l00887"></a>00887                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aca1e05d7dbab07c38afbf4e56474c1ae">spacemode</a>==<a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a7106e671a1b9a7cac7f107fd1340775b">CU_FLUSH</a>) distfac= 1.0f;
<a name="l00888"></a>00888                 
<a name="l00889"></a>00889             }
<a name="l00890"></a>00890             <span class="keywordflow">else</span> distfac= 1.0;
<a name="l00891"></a>00891             
<a name="l00892"></a>00892             distfac/= (maxx-minx);
<a name="l00893"></a>00893             
<a name="l00894"></a>00894             timeofs+= distfac*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>;  <span class="comment">/* not cyclic */</span>
<a name="l00895"></a>00895             
<a name="l00896"></a>00896             ct= chartransdata;
<a name="l00897"></a>00897             <span class="keywordflow">for</span> (i=0; i&lt;=slen; i++, ct++) {
<a name="l00898"></a>00898                 <span class="keywordtype">float</span> ctime, dtime, vec[4], tvec[4], rotvec[3];
<a name="l00899"></a>00899                 <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00900"></a>00900                 
<a name="l00901"></a>00901                 <span class="comment">/* rotate around center character */</span>
<a name="l00902"></a>00902                 ascii = mem[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l00903"></a>00903 
<a name="l00904"></a>00904                 che= <a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(vfd, ascii);
<a name="l00905"></a>00905     
<a name="l00906"></a>00906                 twidth = <a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">char_width</a>(cu, che, info);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908                 dtime= distfac*0.5f*twidth;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910                 ctime= timeofs + distfac*( ct-&gt;xof - minx);
<a name="l00911"></a>00911                 <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(ctime, 0.0f, 1.0f);
<a name="l00912"></a>00912 
<a name="l00913"></a>00913                 <span class="comment">/* calc the right loc AND the right rot separately */</span>
<a name="l00914"></a>00914                 <span class="comment">/* vec, tvec need 4 items */</span>
<a name="l00915"></a>00915                 <a class="code" href="../../df/dd0/BKE__anim_8h.html#a36e926e41221928bb037b16aa04becc0">where_on_path</a>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>, ctime, vec, tvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00916"></a>00916                 <a class="code" href="../../df/dd0/BKE__anim_8h.html#a36e926e41221928bb037b16aa04becc0">where_on_path</a>(cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a>, ctime+dtime, tvec, rotvec, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00917"></a>00917                 
<a name="l00918"></a>00918                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(vec, sizefac);
<a name="l00919"></a>00919                 
<a name="l00920"></a>00920                 ct-&gt;rot= (float)(<a class="code" href="../../d6/ddc/constraint_8c.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>-<a class="code" href="../../d0/dbc/namespaceKDL.html#adedc70818d20a954bd4dec554150d250">atan2</a>(rotvec[1], rotvec[0]));
<a name="l00921"></a>00921 
<a name="l00922"></a>00922                 si= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(ct-&gt;rot);
<a name="l00923"></a>00923                 co= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(ct-&gt;rot);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925                 yof= ct-&gt;yof;
<a name="l00926"></a>00926                 
<a name="l00927"></a>00927                 ct-&gt;xof= vec[0] + si*<a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>;
<a name="l00928"></a>00928                 ct-&gt;yof= vec[1] + co*<a class="code" href="../../de/d65/structchartrans.html#a07807917dfb422851400a1e6b43ed650">yof</a>;
<a name="l00929"></a>00929                 
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931             cucu-&gt;<a class="code" href="../../da/d10/structCurve.html#abd5b5dcd85b78434895b347aea37d841">flag</a>= oldflag;
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>) {
<a name="l00936"></a>00936         ct= chartransdata;
<a name="l00937"></a>00937         <span class="keywordflow">for</span> (i=0; i&lt;=selend; i++, ct++) {
<a name="l00938"></a>00938             <span class="keywordflow">if</span> (i&gt;=selstart) {
<a name="l00939"></a>00939                 cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>[i-selstart].<a class="code" href="../../db/db5/structSelBox.html#accc1e84e6f2b465f22a1f35ffad82d1d">x</a> = ct-&gt;xof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;
<a name="l00940"></a>00940                 cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad215e7da46b3f909ff9d9542030f6111">selboxes</a>[i-selstart].<a class="code" href="../../db/db5/structSelBox.html#af41d6b651d97d472ae70ca6c12a8e0cd">y</a> = ct-&gt;yof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>;             
<a name="l00941"></a>00941             }
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a57bfdb5947abf68eb5ae84e1011e839e">FO_CURSUP</a> || mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a515dc9e303f5380ea18cd1980e71ee9f">FO_CURSDOWN</a> || mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a61a20d5997711e0abac5df8a0722b814">FO_PAGEUP</a> || mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#aa4aaa68dbd9253eaa39e80a60d9ed1e6">FO_PAGEDOWN</a>) {
<a name="l00946"></a>00946         <span class="comment">/* 2: curs up</span>
<a name="l00947"></a>00947 <span class="comment">         * 3: curs down */</span>
<a name="l00948"></a>00948         ct= chartransdata+cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4ad18a3ab608a6d776e63e4717553a6d">pos</a>;
<a name="l00949"></a>00949         
<a name="l00950"></a>00950         <span class="keywordflow">if</span> ((mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a57bfdb5947abf68eb5ae84e1011e839e">FO_CURSUP</a> || mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a61a20d5997711e0abac5df8a0722b814">FO_PAGEUP</a>) &amp;&amp; ct-&gt;linenr==0);
<a name="l00951"></a>00951         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a515dc9e303f5380ea18cd1980e71ee9f">FO_CURSDOWN</a> || mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#aa4aaa68dbd9253eaa39e80a60d9ed1e6">FO_PAGEDOWN</a>) &amp;&amp; ct-&gt;linenr==lnr);
<a name="l00952"></a>00952         <span class="keywordflow">else</span> {
<a name="l00953"></a>00953             <span class="keywordflow">switch</span>(mode) {
<a name="l00954"></a>00954                 <span class="keywordflow">case</span> <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a57bfdb5947abf68eb5ae84e1011e839e">FO_CURSUP</a>:     lnr= ct-&gt;linenr-1; <span class="keywordflow">break</span>;
<a name="l00955"></a>00955                 <span class="keywordflow">case</span> <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a515dc9e303f5380ea18cd1980e71ee9f">FO_CURSDOWN</a>:   lnr= ct-&gt;linenr+1; <span class="keywordflow">break</span>;
<a name="l00956"></a>00956                 <span class="keywordflow">case</span> <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a61a20d5997711e0abac5df8a0722b814">FO_PAGEUP</a>:     lnr= ct-&gt;linenr-10; <span class="keywordflow">break</span>;
<a name="l00957"></a>00957                 <span class="keywordflow">case</span> <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#aa4aaa68dbd9253eaa39e80a60d9ed1e6">FO_PAGEDOWN</a>:   lnr= ct-&gt;linenr+10; <span class="keywordflow">break</span>;
<a name="l00958"></a>00958             }
<a name="l00959"></a>00959             cnr= ct-&gt;charnr;
<a name="l00960"></a>00960             <span class="comment">/* seek for char with lnr en cnr */</span>
<a name="l00961"></a>00961             cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4ad18a3ab608a6d776e63e4717553a6d">pos</a>= 0;
<a name="l00962"></a>00962             ct= chartransdata;
<a name="l00963"></a>00963             <span class="keywordflow">for</span> (i= 0; i&lt;slen; i++) {
<a name="l00964"></a>00964                 <span class="keywordflow">if</span> (ct-&gt;linenr==lnr) {
<a name="l00965"></a>00965                     <span class="keywordflow">if</span> (ct-&gt;charnr==cnr) <span class="keywordflow">break</span>;
<a name="l00966"></a>00966                     <span class="keywordflow">if</span> ( (ct+1)-&gt;charnr==0) <span class="keywordflow">break</span>;
<a name="l00967"></a>00967                 }
<a name="l00968"></a>00968                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ct-&gt;linenr&gt;lnr) <span class="keywordflow">break</span>;
<a name="l00969"></a>00969                 cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4ad18a3ab608a6d776e63e4717553a6d">pos</a>++;
<a name="l00970"></a>00970                 ct++;
<a name="l00971"></a>00971             }
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973     }
<a name="l00974"></a>00974     
<a name="l00975"></a>00975     <span class="comment">/* cursor first */</span>
<a name="l00976"></a>00976     <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a5cea9d9cf980788715e190c6261cd0a3">editfont</a>) {
<a name="l00977"></a>00977         <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a888fe8f555278142e1b388ec6592dc0d">si</a>, <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>;
<a name="l00978"></a>00978         
<a name="l00979"></a>00979         ct= chartransdata+cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4ad18a3ab608a6d776e63e4717553a6d">pos</a>;
<a name="l00980"></a>00980         si= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a4f15dff8a58e8abe0c0cf2c249ffa842">sin</a>(ct-&gt;rot);
<a name="l00981"></a>00981         co= (float)<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>(ct-&gt;rot);
<a name="l00982"></a>00982                 
<a name="l00983"></a>00983         f= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a5cea9d9cf980788715e190c6261cd0a3">editfont</a>-&gt;<a class="code" href="../../d7/d68/structEditFont.html#a15f5f5f86ca00452bde65c58102d81f2">textcurs</a>[0];
<a name="l00984"></a>00984         
<a name="l00985"></a>00985         f[0]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(-0.1f*co + ct-&gt;xof);
<a name="l00986"></a>00986         f[1]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(0.1f*si + ct-&gt;yof);
<a name="l00987"></a>00987         
<a name="l00988"></a>00988         f[2]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(0.1f*co + ct-&gt;xof);
<a name="l00989"></a>00989         f[3]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(-0.1f*si + ct-&gt;yof);
<a name="l00990"></a>00990         
<a name="l00991"></a>00991         f[4]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*( 0.1f*co + 0.8f*si + ct-&gt;xof);
<a name="l00992"></a>00992         f[5]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(-0.1f*si + 0.8f*co + ct-&gt;yof);
<a name="l00993"></a>00993         
<a name="l00994"></a>00994         f[6]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*(-0.1f*co + 0.8f*si + ct-&gt;xof);
<a name="l00995"></a>00995         f[7]= cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>*( 0.1f*si + 0.8f*co + ct-&gt;yof);
<a name="l00996"></a>00996         
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(linedata);
<a name="l01000"></a>01000     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(linedata2);       
<a name="l01001"></a>01001     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(linedata3);
<a name="l01002"></a>01002     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(linedata4);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (mode == <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#ae8589f1bd61e4dbb7426ed4bb410e1d8">FO_SELCHANGE</a>) {
<a name="l01005"></a>01005         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(chartransdata);
<a name="l01006"></a>01006         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem);
<a name="l01007"></a>01007         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01008"></a>01008     }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="keywordflow">if</span> (mode == <a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a92e8a41d766e601ba777354690e61760">FO_EDIT</a>) {
<a name="l01011"></a>01011         <span class="comment">/* make nurbdata */</span>
<a name="l01012"></a>01012         <a class="code" href="../../d7/dfc/BKE__curve_8h.html#aa7e3a2bafad6c23e082515885ae5294a">freeNurblist</a>(&amp;cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ac93326a4cc67ccb5d9725bf0ed3432d1">nurb</a>);
<a name="l01013"></a>01013         
<a name="l01014"></a>01014         ct= chartransdata;
<a name="l01015"></a>01015         <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aeb41fa39337293e0baea49fe1693378a">sepchar</a>==0) {
<a name="l01016"></a>01016             <span class="keywordflow">for</span> (i= 0; i&lt;slen; i++) {
<a name="l01017"></a>01017                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> cha = (uintptr_t) mem[i];
<a name="l01018"></a>01018                 info = &amp;(custrinfo[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l01019"></a>01019                 <span class="keywordflow">if</span> (info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#a7a213df43c06c6c62a579e47cc771353">mat_nr</a> &gt; (ob-&gt;<a class="code" href="../../de/de7/structObject.html#ad3bbabfca98cb47923254dd04d6961ac">totcol</a>)) {
<a name="l01020"></a>01020                     <span class="comment">/* printf(&quot;Error: Illegal material index (%d) in text object, setting to 0\n&quot;, info-&gt;mat_nr); */</span>
<a name="l01021"></a>01021                     info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#a7a213df43c06c6c62a579e47cc771353">mat_nr</a> = 0;
<a name="l01022"></a>01022                 }
<a name="l01023"></a>01023                 <span class="comment">// We do not want to see any character for \n or \r</span>
<a name="l01024"></a>01024                 <span class="keywordflow">if</span> (cha != <span class="charliteral">&#39;\n&#39;</span> &amp;&amp; cha != <span class="charliteral">&#39;\r&#39;</span>)
<a name="l01025"></a>01025                     <a class="code" href="../../da/d8c/font_8c.html#a5fe63817563785a9cd6db4ae059272d6">buildchar</a>(bmain, cu, cha, info, ct-&gt;xof, ct-&gt;yof, ct-&gt;rot, i);
<a name="l01026"></a>01026                 
<a name="l01027"></a>01027                 <span class="keywordflow">if</span> ((info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#ab9a90eb1f58d2161ee94d445d325a116">flag</a> &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#adaba8ff47360b76d21a6e62e87485cde">CU_CHINFO_UNDERLINE</a>) &amp;&amp; (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aab9f61871625a95c78c288429b4b6d74">textoncurve</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) &amp;&amp; (cha != <span class="charliteral">&#39;\n&#39;</span>) &amp;&amp; (cha != <span class="charliteral">&#39;\r&#39;</span>)) {
<a name="l01028"></a>01028                     <span class="keywordtype">float</span> ulwidth, uloverlap= 0.0f;
<a name="l01029"></a>01029                     
<a name="l01030"></a>01030                     <span class="keywordflow">if</span> ( (i&lt;(slen-1)) &amp;&amp; (mem[i+1] != <span class="charliteral">&#39;\n&#39;</span>) &amp;&amp; (mem[i+1] != <span class="charliteral">&#39;\r&#39;</span>) &amp;&amp;
<a name="l01031"></a>01031                          ((mem[i+1] != <span class="charliteral">&#39; &#39;</span>) || (custrinfo[i+1].flag &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#adaba8ff47360b76d21a6e62e87485cde">CU_CHINFO_UNDERLINE</a>)) &amp;&amp; ((custrinfo[i+1].flag &amp; <a class="code" href="../../d6/d88/DNA__curve__types_8h.html#a079fbf7c8c722c0cb699ff099db79c2d">CU_CHINFO_WRAP</a>)==0)
<a name="l01032"></a>01032                          ) {
<a name="l01033"></a>01033                         uloverlap = xtrax + 0.1f;
<a name="l01034"></a>01034                     }
<a name="l01035"></a>01035                     <span class="comment">// Find the character, the characters has to be in the memory already </span>
<a name="l01036"></a>01036                     <span class="comment">// since character checking has been done earlier already.</span>
<a name="l01037"></a>01037                     che= <a class="code" href="../../da/d8c/font_8c.html#a7f87c472e7cf085dd615c97fad5b535f">find_vfont_char</a>(vfd, cha);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039                     twidth = <a class="code" href="../../da/d8c/font_8c.html#a26a6685e8617a0c50bce71df499ccb87">char_width</a>(cu, che, info);
<a name="l01040"></a>01040                     ulwidth = cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a> * ((twidth* (1.0f+(info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#acf44b35ebdf823280f74ed5328210a6c">kern</a>/40.0f)))+uloverlap);
<a name="l01041"></a>01041                     <a class="code" href="../../da/d8c/font_8c.html#a2ebc8f750f8a1bb225ebac95ba7d14b1">build_underline</a>(cu, ct-&gt;<a class="code" href="../../da/d10/structCurve.html#a1d0112868c4d31b067bf662f81c83790">xof</a>*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>, ct-&gt;yof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a> + (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4efca514209248eed86bc4f38dd3ba67">ulpos</a>-0.05f)*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>,
<a name="l01042"></a>01042                                     ct-&gt;xof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a> + ulwidth, 
<a name="l01043"></a>01043                                     ct-&gt;yof*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a> + (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4efca514209248eed86bc4f38dd3ba67">ulpos</a>-0.05f)*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a> - cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4e0212cf92e3b7f1d2c355632c566905">ulheight</a>*cu-&gt;<a class="code" href="../../da/d10/structCurve.html#ad0e4ea215dcd01147ad06b76e581eb9c">fsize</a>,
<a name="l01044"></a>01044                                     i, info-&gt;<a class="code" href="../../dc/d38/structCharInfo.html#a7a213df43c06c6c62a579e47cc771353">mat_nr</a>);
<a name="l01045"></a>01045                 }
<a name="l01046"></a>01046                 ct++;
<a name="l01047"></a>01047             }
<a name="l01048"></a>01048         }
<a name="l01049"></a>01049         <span class="keywordflow">else</span> {
<a name="l01050"></a>01050             <span class="keywordtype">int</span> outta = 0;
<a name="l01051"></a>01051             <span class="keywordflow">for</span> (i= 0; (i&lt;slen) &amp;&amp; (outta==0); i++) {
<a name="l01052"></a>01052                 ascii = mem[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01053"></a>01053                 info = &amp;(custrinfo[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]);
<a name="l01054"></a>01054                 <span class="keywordflow">if</span> (cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aeb41fa39337293e0baea49fe1693378a">sepchar</a> == (i+1)) {
<a name="l01055"></a>01055                     <span class="keywordtype">float</span> vecyo[3];
<a name="l01056"></a>01056 
<a name="l01057"></a>01057                     vecyo[0]= ct-&gt;xof;
<a name="l01058"></a>01058                     vecyo[1]= ct-&gt;yof;
<a name="l01059"></a>01059                     vecyo[2]= 0.0f;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061                     mem[0] = ascii;
<a name="l01062"></a>01062                     mem[1] = 0;
<a name="l01063"></a>01063                     custrinfo[0]= *info;
<a name="l01064"></a>01064                     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#a4ad18a3ab608a6d776e63e4717553a6d">pos</a> = 1;
<a name="l01065"></a>01065                     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#adace7d1722758b9ffec9b98f9cf688b2">len</a> = 1;
<a name="l01066"></a>01066                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(ob-&gt;<a class="code" href="../../de/de7/structObject.html#a56283253ed00c7461cae7602135fbba9">loc</a>, ob-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vecyo);
<a name="l01067"></a>01067                     outta = 1;
<a name="l01068"></a>01068                     cu-&gt;<a class="code" href="../../da/d10/structCurve.html#aeb41fa39337293e0baea49fe1693378a">sepchar</a> = 0;
<a name="l01069"></a>01069                 }
<a name="l01070"></a>01070                 ct++;
<a name="l01071"></a>01071             }
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073     }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (mode==<a class="code" href="../../de/dcc/DNA__vfont__types_8h.html#a1f1bffcec40ad92015bd7ab077cec712">FO_DUPLI</a>) {
<a name="l01076"></a>01076         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem);
<a name="l01077"></a>01077         <span class="keywordflow">return</span> chartransdata;
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <span class="keywordflow">if</span> (mem)
<a name="l01081"></a>01081         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(mem);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(chartransdata);
<a name="l01084"></a>01084     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01085"></a>01085 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:21 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
