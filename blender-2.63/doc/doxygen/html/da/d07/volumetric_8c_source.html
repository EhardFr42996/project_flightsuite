<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: volumetric.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">volumetric.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/d07/volumetric_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2001-2002 by NaN Holding BV.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * The Original Code is: all of this file.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * Contributor(s): Matt Ebb, Raul Fernandez Hernandez (Farsthary)</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;float.h&gt;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/d53/BLI__voxel_8h.html">BLI_voxel.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d7d/BLI__utildefines_8h.html">BLI_utildefines.h</a>&quot;</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d49/RE__shader__ext_8h.html">RE_shader_ext.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../de/db2/DNA__material__types_8h.html">DNA_material_types.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d75/DNA__group__types_8h.html">DNA_group_types.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html">DNA_lamp_types.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d40/DNA__meta__types_8h.html">DNA_meta_types.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d8c/BKE__global_8h.html">BKE_global.h</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d00/render__types_8h.html">render_types.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d05/pixelshading_8h.html">pixelshading.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d1b/rayintersection_8h.html">rayintersection.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d42/rayobject_8h.html">rayobject.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d3d/shading_8h.html">shading.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d30/shadbuf_8h.html">shadbuf.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../df/dba/texture_8h.html">texture.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d25/volumetric_8h.html">volumetric.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d62/volume__precache_8h.html">volume_precache.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00066"></a>00066 <span class="comment">/* defined in pipeline.c, is hardcopy of active dynamic allocated Render */</span>
<a name="l00067"></a>00067 <span class="comment">/* only to be used here in this file, it&#39;s for speed */</span>
<a name="l00068"></a>00068 <span class="keyword">extern</span> <span class="keyword">struct </span><a class="code" href="../../d6/d7a/structRender.html">Render</a> <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>;
<a name="l00069"></a>00069 <span class="comment">/* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* luminance rec. 709 */</span>
<a name="l00072"></a><a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">00072</a> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a8dc6b090e83d9a9851b90fc5a6452c56">BLI_INLINE</a> <span class="keywordtype">float</span> <a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> col[3])
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074     <span class="keywordflow">return</span> (0.212671f*col[0] + 0.71516f*col[1] + 0.072169f*col[2]);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/* tracing */</span>
<a name="l00078"></a><a class="code" href="../../da/d07/volumetric_8c.html#a3d78d91104323f9a58ccadee8daaf4ab">00078</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d07/volumetric_8c.html#a3d78d91104323f9a58ccadee8daaf4ab">vol_get_shadow</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <span class="keywordtype">float</span> visibility = 1.f;
<a name="l00081"></a>00081     
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>) {
<a name="l00083"></a>00083         <span class="keywordtype">float</span> dxco[3]={0.f, 0.f, 0.f}, dyco[3]={0.f, 0.f, 0.f};
<a name="l00084"></a>00084         
<a name="l00085"></a>00085         visibility = <a class="code" href="../../d9/d30/shadbuf_8h.html#a90bba8ef1567f3b648d21a39493a85a7">testshadowbuf</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a3ac6e99607dd6c4843dba45153486d27">shb</a>, co, dxco, dyco, 1.0, 0.0);     
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a19442e8ee945704d7977da073a206e8f">LA_SHAD_RAY</a>) {
<a name="l00088"></a>00088         <span class="comment">/* trace shadow manually, no good lamp api atm */</span>
<a name="l00089"></a>00089         <a class="code" href="../../d8/d95/structIsect.html">Isect</a> is;
<a name="l00090"></a>00090         
<a name="l00091"></a>00091         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(is.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, co);
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a> || lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>==<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>) {
<a name="l00093"></a>00093             is.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0] = -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[0];
<a name="l00094"></a>00094             is.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1] = -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[1];
<a name="l00095"></a>00095             is.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2] = -lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>[2];
<a name="l00096"></a>00096             is.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.maxdist;
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098         <span class="keywordflow">else</span> {
<a name="l00099"></a>00099             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(is.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>, is.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>);
<a name="l00100"></a>00100             is.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>( is.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a> );
<a name="l00101"></a>00101         }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         is.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#acb514bfd8ddb54e2e79a06ea36f9a5e5">RE_RAY_MIRROR</a>;
<a name="l00104"></a>00104         is.<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a1156926d2730a1018c3bd3cda8d539b6">RE_CHECK_VLR_NON_SOLID_MATERIAL</a>;
<a name="l00105"></a>00105         is.<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = 0;
<a name="l00106"></a>00106         
<a name="l00107"></a>00107         <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; (<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>|<a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a1337605158cc594cf324bdbe8b1818ce">LA_LAYER_SHADOW</a>))
<a name="l00108"></a>00108             is.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a>;   
<a name="l00109"></a>00109         <span class="keywordflow">else</span>
<a name="l00110"></a>00110             is.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l00111"></a>00111             
<a name="l00112"></a>00112         is.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00113"></a>00113         is.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00114"></a>00114         is.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7f3f1fcbd851592cb40930eb02b11ec6">last_hit</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>];
<a name="l00115"></a>00115         
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree,&amp;is)) {
<a name="l00117"></a>00117             visibility = 0.f;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         
<a name="l00120"></a>00120         lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a7f3f1fcbd851592cb40930eb02b11ec6">last_hit</a>[shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>]= is.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a>;
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122     <span class="keywordflow">return</span> visibility;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="../../da/d07/volumetric_8c.html#a8964f773f6a09bc00edfe3ae0dbd2628">00125</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d07/volumetric_8c.html#a8964f773f6a09bc00edfe3ae0dbd2628">vol_get_bounds</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> vec[3], <span class="keywordtype">float</span> hitco[3], <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *isect, <span class="keywordtype">int</span> intersect_type)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     
<a name="l00128"></a>00128     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, co);
<a name="l00129"></a>00129     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, vec);
<a name="l00130"></a>00130     isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00131"></a>00131     isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#acb514bfd8ddb54e2e79a06ea36f9a5e5">RE_RAY_MIRROR</a>;
<a name="l00132"></a>00132     isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00133"></a>00133     isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l00134"></a>00134     isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#ab1375158e70673cd04bdc03c369f4a49">RE_CHECK_VLR_NONE</a>;
<a name="l00135"></a>00135     
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (intersect_type == <a class="code" href="../../df/d25/volumetric_8h.html#a917efaf85684af1b05386a56a6f4ab0f">VOL_BOUNDS_DEPTH</a>) {
<a name="l00137"></a>00137         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l00138"></a>00138         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = (<span class="keywordtype">void</span>*)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>;
<a name="l00139"></a>00139         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a> = (<span class="keywordtype">void</span>*)shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141     <span class="keywordflow">else</span> { <span class="comment">// if (intersect_type == VOL_BOUNDS_SS) {</span>
<a name="l00142"></a>00142         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a>= 0;
<a name="l00143"></a>00143         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>= <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00144"></a>00144         isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146     
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, isect)) {
<a name="l00148"></a>00148         hitco[0] = isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[0] + isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[0];
<a name="l00149"></a>00149         hitco[1] = isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[1] + isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[1];
<a name="l00150"></a>00150         hitco[2] = isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>[2] + isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>*isect-&gt;<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>[2];
<a name="l00151"></a>00151         <span class="keywordflow">return</span> 1;
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     <span class="keywordflow">else</span> {
<a name="l00154"></a>00154         <span class="keywordflow">return</span> 0;
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a><a class="code" href="../../da/d07/volumetric_8c.html#a4af2ae8d75283204d9ef6c652c4b3a20">00158</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a4af2ae8d75283204d9ef6c652c4b3a20">shade_intersection</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> col_r[4], <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *is)
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160     <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> shi_new;
<a name="l00161"></a>00161     <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> shr_new;
<a name="l00162"></a>00162     
<a name="l00163"></a>00163     memset(&amp;shi_new, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a>)); 
<a name="l00164"></a>00164     
<a name="l00165"></a>00165     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a4c0ab82dc714b145f797a00fe898c341">mask</a>;
<a name="l00166"></a>00166     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>;
<a name="l00167"></a>00167     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>;
<a name="l00168"></a>00168     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a> + 1;
<a name="l00169"></a>00169     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a8efc677eeb02c1f42b70c0bcf0027baf">volume_depth</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8efc677eeb02c1f42b70c0bcf0027baf">volume_depth</a> + 1;
<a name="l00170"></a>00170     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a25ab88756153550c764e1bc6b5a09cbb">xs</a>;
<a name="l00171"></a>00171     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a7d3ea05ace41e7cca57d5a5e7e8b14cd">ys</a>;
<a name="l00172"></a>00172     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>;
<a name="l00173"></a>00173     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#ad6ecae6c8cde96264e32d975d7063f0b">passflag</a>= <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a4e038919a7298d42281bcef6eef0840d">SCE_PASS_COMBINED</a>; <span class="comment">/* result of tracing needs no pass info */</span>
<a name="l00174"></a>00174     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a6f98c0f99aa93bd4f5f80247623a6f4c">combinedflag</a>= 0xFFFFFF;      <span class="comment">/* ray trace does all options */</span>
<a name="l00175"></a>00175     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a2aa780ac66e60d253b3a6af93766192f">light_override</a>;
<a name="l00176"></a>00176     shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#af03094325957f5a1521bfb7e7c36ae4e">mat_override</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af03094325957f5a1521bfb7e7c36ae4e">mat_override</a>;
<a name="l00177"></a>00177     
<a name="l00178"></a>00178     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi_new.<a class="code" href="../../d8/db3/structShadeInput.html#af1230c7e13f94d5d5054d8563ea47eb0">camera_co</a>, is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>);
<a name="l00179"></a>00179     
<a name="l00180"></a>00180     memset(&amp;shr_new, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>));
<a name="l00181"></a>00181     
<a name="l00182"></a>00182     <span class="comment">/* hardcoded limit of 100 for now - prevents problems in weird geometry */</span>
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a8efc677eeb02c1f42b70c0bcf0027baf">volume_depth</a> &lt; 100) {
<a name="l00184"></a>00184         <a class="code" href="../../da/d3d/shading_8h.html#ab59a098c8396fbdc601f63c8efa206db">shade_ray</a>(is, &amp;shi_new, &amp;shr_new);
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     
<a name="l00187"></a>00187     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(col_r, shr_new.<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00188"></a>00188     col_r[3] = shr_new.<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="../../da/d07/volumetric_8c.html#a8a6bd666ffa9959e96da79057527897c">00191</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a8a6bd666ffa9959e96da79057527897c">vol_trace_behind</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> col_r[4])
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> isect;
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isect.<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>, co);
<a name="l00196"></a>00196     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(isect.<a class="code" href="../../d8/d95/structIsect.html#a8b9991c88aa299d1fa62a0870ae867ed">dir</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00197"></a>00197     isect.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l00198"></a>00198     
<a name="l00199"></a>00199     isect.<a class="code" href="../../d8/d95/structIsect.html#aafb5b78d6ceeb852039d6efaca33b00f">mode</a>= <a class="code" href="../../d1/d1b/rayintersection_8h.html#acb514bfd8ddb54e2e79a06ea36f9a5e5">RE_RAY_MIRROR</a>;
<a name="l00200"></a>00200     isect.<a class="code" href="../../d8/d95/structIsect.html#a512145db8ec6b167b4c82d1c736c10c3">check</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#ab1375158e70673cd04bdc03c369f4a49">RE_CHECK_VLR_NONE</a>;
<a name="l00201"></a>00201     isect.<a class="code" href="../../d8/d95/structIsect.html#ad42eefac9a854dcdd239f0bf2de73ae3">skip</a> = <a class="code" href="../../d1/d1b/rayintersection_8h.html#a85bab024ca87d0e8d0693fb2c67bf716">RE_SKIP_VLR_NEIGHBOUR</a>;
<a name="l00202"></a>00202     isect.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a> = (<span class="keywordtype">void</span>*) shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l00203"></a>00203     isect.<a class="code" href="../../d8/d95/structIsect.html#a95090a47baf9c8cfae81d93c0c00496d">orig</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a> = (<span class="keywordtype">void</span>*)vlr;
<a name="l00204"></a>00204     isect.<a class="code" href="../../d8/d95/structIsect.html#ab0cb44ae24599f4300980a1f59ad2e8e">last_hit</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00205"></a>00205     isect.<a class="code" href="../../d8/d95/structIsect.html#a49ff3e5756e5101ce4d2e6ffea128707">lay</a>= -1;
<a name="l00206"></a>00206     
<a name="l00207"></a>00207     <span class="comment">/* check to see if there&#39;s anything behind the volume, otherwise shade the sky */</span>
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d42/rayobject_8h.html#ac587698542b72b0bf642becde81dd883">RE_rayobject_raycast</a>(<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.raytree, &amp;isect)) {
<a name="l00209"></a>00209         <a class="code" href="../../da/d07/volumetric_8c.html#a4af2ae8d75283204d9ef6c652c4b3a20">shade_intersection</a>(shi, col_r, &amp;isect);
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     <span class="keywordflow">else</span> {
<a name="l00212"></a>00212         <a class="code" href="../../d4/d05/pixelshading_8h.html#a3350a4efc0f19f5c99c5127c6544adbf">shadeSkyView</a>(col_r, co, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>);
<a name="l00213"></a>00213         <a class="code" href="../../d4/d05/pixelshading_8h.html#a18941dec954f5f0c240f0caa0206ee41">shadeSunView</a>(col_r, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00214"></a>00214     } 
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="comment">/* trilinear interpolation */</span>
<a name="l00219"></a><a class="code" href="../../da/d07/volumetric_8c.html#a26eb03e8a8f21cc47ae22a256e893f34">00219</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a26eb03e8a8f21cc47ae22a256e893f34">vol_get_precached_scattering</a>(<a class="code" href="../../d6/d7a/structRender.html">Render</a> *re, <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> scatter_col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <a class="code" href="../../de/dc3/structVolumePrecache.html">VolumePrecache</a> *vp = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5ac318b8218d8ae1db8c4ea4fbfe7055">volume_precache</a>;
<a name="l00222"></a>00222     <span class="keywordtype">float</span> bbmin[3], bbmax[3], dim[3];
<a name="l00223"></a>00223     <span class="keywordtype">float</span> world_co[3], sample_co[3];
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (!vp) <span class="keywordflow">return</span>;
<a name="l00226"></a>00226     
<a name="l00227"></a>00227     <span class="comment">/* find sample point in global space bounding box 0.0-1.0 */</span>
<a name="l00228"></a>00228     <a class="code" href="../../dd/d62/volume__precache_8h.html#a7a3f68606252a495b190102de72256a9">global_bounds_obi</a>(re, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>, bbmin, bbmax);
<a name="l00229"></a>00229     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(dim, bbmax, bbmin);
<a name="l00230"></a>00230     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad7be0179ee8a128512e2c7f0ad11c8d8">mul_v3_m4v3</a>(world_co, re-&gt;<a class="code" href="../../d6/d7a/structRender.html#a50d38d08b94a7cde881a1cbaf2bfb523">viewinv</a>, co); 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="comment">/* sample_co in 0.0-1.0 */</span>
<a name="l00233"></a>00233     sample_co[0] = (world_co[0] - bbmin[0]) / dim[0];
<a name="l00234"></a>00234     sample_co[1] = (world_co[1] - bbmin[1]) / dim[1];
<a name="l00235"></a>00235     sample_co[2] = (world_co[2] - bbmin[2]) / dim[2];
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     scatter_col[0] = <a class="code" href="../../dc/d53/BLI__voxel_8h.html#a16179d6358606ed8c21f1105a7ce523f">voxel_sample_triquadratic</a>(vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#a39c6045c5b38d5a8b22a64ee9ac2c705">data_r</a>, vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#a6f8ccf47a3792334d0f11d8f5ba828d2">res</a>, sample_co);
<a name="l00238"></a>00238     scatter_col[1] = <a class="code" href="../../dc/d53/BLI__voxel_8h.html#a16179d6358606ed8c21f1105a7ce523f">voxel_sample_triquadratic</a>(vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#abcbcde122e1936ff5401b9e74b5fb23f">data_g</a>, vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#a6f8ccf47a3792334d0f11d8f5ba828d2">res</a>, sample_co);
<a name="l00239"></a>00239     scatter_col[2] = <a class="code" href="../../dc/d53/BLI__voxel_8h.html#a16179d6358606ed8c21f1105a7ce523f">voxel_sample_triquadratic</a>(vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#a66830bc9a22a427b8a7f3ebfe69c2bf6">data_b</a>, vp-&gt;<a class="code" href="../../de/dc3/structVolumePrecache.html#a6f8ccf47a3792334d0f11d8f5ba828d2">res</a>, sample_co);
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">/* Meta object density, brute force for now </span>
<a name="l00243"></a>00243 <span class="comment"> * (might be good enough anyway, don&#39;t need huge number of metaobs to model volumetric objects */</span>
<a name="l00244"></a><a class="code" href="../../da/d07/volumetric_8c.html#a05710f1b5938d51a03793f0f729abc7c">00244</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d07/volumetric_8c.html#a05710f1b5938d51a03793f0f729abc7c">metadensity</a>(<a class="code" href="../../de/de7/structObject.html">Object</a>* ob, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246     <span class="keywordtype">float</span> mat[4][4], <a class="code" href="../../d6/d7a/structRender.html#ace3a2e645f5e2444ade24b8b562dbace">imat</a>[4][4], dens = 0.f;
<a name="l00247"></a>00247     <a class="code" href="../../d3/d6c/structMetaBall.html">MetaBall</a>* mb = (<a class="code" href="../../d3/d6c/structMetaBall.html">MetaBall</a>*)ob-&gt;<a class="code" href="../../de/de7/structObject.html#af121d9ecf1402708a17302a8a615cbfe">data</a>;
<a name="l00248"></a>00248     <a class="code" href="../../de/d87/structMetaElem.html">MetaElem</a>* ml;
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <span class="comment">/* transform co to meta-element */</span>
<a name="l00251"></a>00251     <span class="keywordtype">float</span> tco[3] = {co[0], co[1], co[2]};
<a name="l00252"></a>00252     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ae41a59d6db4a10a85f8fbf1e3842ba81">mult_m4_m4m4</a>(mat, <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.viewmat, ob-&gt;obmat);
<a name="l00253"></a>00253     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(<a class="code" href="../../d6/d7a/structRender.html#ace3a2e645f5e2444ade24b8b562dbace">imat</a>, mat);
<a name="l00254"></a>00254     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(<a class="code" href="../../d6/d7a/structRender.html#ace3a2e645f5e2444ade24b8b562dbace">imat</a>, tco);
<a name="l00255"></a>00255     
<a name="l00256"></a>00256     <span class="keywordflow">for</span> (ml = mb-&gt;elems.first; ml; ml=ml-&gt;next) {
<a name="l00257"></a>00257         <span class="keywordtype">float</span> bmat[3][3], dist2;
<a name="l00258"></a>00258         
<a name="l00259"></a>00259         <span class="comment">/* element rotation transform */</span>
<a name="l00260"></a>00260         <span class="keywordtype">float</span> tp[3] = {ml-&gt;x - tco[0], ml-&gt;y - tco[1], ml-&gt;z - tco[2]};
<a name="l00261"></a>00261         <a class="code" href="../../d4/d90/BLI__math__rotation_8h.html#ae0343d0ff2af81f054d3916277409507">quat_to_mat3</a>( bmat,ml-&gt;quat);
<a name="l00262"></a>00262         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#ad34fc69317ce2354d58d80147b753408">transpose_m3</a>(bmat); <span class="comment">// rot.only, so inverse == transpose</span>
<a name="l00263"></a>00263         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(bmat, tp);
<a name="l00264"></a>00264         
<a name="l00265"></a>00265         <span class="comment">/* MB_BALL default */</span>
<a name="l00266"></a>00266         <span class="keywordflow">switch</span> (ml-&gt;type) {
<a name="l00267"></a>00267             <span class="keywordflow">case</span> <a class="code" href="../../d0/d40/DNA__meta__types_8h.html#a66e16e57a590239af16fdaf958cc476a">MB_ELIPSOID</a>:
<a name="l00268"></a>00268                 tp[0] /= ml-&gt;expx, tp[1] /= ml-&gt;expy, tp[2] /= ml-&gt;expz;
<a name="l00269"></a>00269                 <span class="keywordflow">break</span>;
<a name="l00270"></a>00270             <span class="keywordflow">case</span> <a class="code" href="../../d0/d40/DNA__meta__types_8h.html#af61a277733578a6e4e42e11ca6b30835">MB_CUBE</a>:
<a name="l00271"></a>00271                 tp[2] = (tp[2] &gt; ml-&gt;expz) ? (tp[2] - ml-&gt;expz) : ((tp[2] &lt; -ml-&gt;expz) ? (tp[2] + ml-&gt;expz) : 0.f);
<a name="l00272"></a>00272                 <span class="comment">// no break, xy as plane</span>
<a name="l00273"></a>00273             <span class="keywordflow">case</span> <a class="code" href="../../d0/d40/DNA__meta__types_8h.html#ac3b41055b5fa6e2ac4556241255a70de">MB_PLANE</a>:
<a name="l00274"></a>00274                 tp[1] = (tp[1] &gt; ml-&gt;expy) ? (tp[1] - ml-&gt;expy) : ((tp[1] &lt; -ml-&gt;expy) ? (tp[1] + ml-&gt;expy) : 0.f);
<a name="l00275"></a>00275                 <span class="comment">// no break, x as tube</span>
<a name="l00276"></a>00276             <span class="keywordflow">case</span> <a class="code" href="../../d0/d40/DNA__meta__types_8h.html#a24efce3a8a3a16764fcc1f5638e884a3">MB_TUBE</a>:
<a name="l00277"></a>00277                 tp[0] = (tp[0] &gt; ml-&gt;expx) ? (tp[0] - ml-&gt;expx) : ((tp[0] &lt; -ml-&gt;expx) ? (tp[0] + ml-&gt;expx) : 0.f);
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279         
<a name="l00280"></a>00280         <span class="comment">/* ml-&gt;rad2 is not set */</span>
<a name="l00281"></a>00281         dist2 = 1.0f - (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(tp, tp) / (ml-&gt;rad * ml-&gt;rad));
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (dist2 &gt; 0.f)
<a name="l00283"></a>00283             dens += (ml-&gt;flag &amp; <a class="code" href="../../d0/d40/DNA__meta__types_8h.html#a7cbd8ff38c4022078d47cee819de0639">MB_NEGATIVE</a>) ? -ml-&gt;s*dist2*dist2*dist2 : ml-&gt;s*dist2*dist2*dist2;
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285     
<a name="l00286"></a>00286     dens -= mb-&gt;thresh;
<a name="l00287"></a>00287     <span class="keywordflow">return</span> (dens &lt; 0.f) ? 0.f : dens;
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="../../da/d07/volumetric_8c.html#aee7b356f1ce499a980db83e4e2f0ecbc">00290</a> <span class="keywordtype">float</span> <a class="code" href="../../df/d25/volumetric_8h.html#aee7b356f1ce499a980db83e4e2f0ecbc">vol_get_density</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00291"></a>00291 {
<a name="l00292"></a>00292     <span class="keywordtype">float</span> density = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#af8e1903e47e2379a39a8fdcf5eb68182">density</a>;
<a name="l00293"></a>00293     <span class="keywordtype">float</span> density_scale = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a59bcd9bd36a42d2996b5ca285b96241b">density_scale</a>;
<a name="l00294"></a>00294         
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>)
<a name="l00296"></a>00296         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(shi, co, <a class="code" href="../../de/db2/DNA__material__types_8h.html#addeb88fa5c86525e00917eb2009b5440">MAP_DENSITY</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;density, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00297"></a>00297     
<a name="l00298"></a>00298     <span class="comment">// if meta-object, modulate by metadensity without increasing it</span>
<a name="l00299"></a>00299     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> == <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a046d883c32490b5c5ca4c5e7b6504e35">OB_MBALL</a>) {
<a name="l00300"></a>00300         <span class="keyword">const</span> <span class="keywordtype">float</span> md = <a class="code" href="../../da/d07/volumetric_8c.html#a05710f1b5938d51a03793f0f729abc7c">metadensity</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>-&gt;<a class="code" href="../../d2/d24/structObjectRen.html#a5f57bfcc678111ef224f8438829d21ff">ob</a>, co);
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (md &lt; 1.f) density *= md;
<a name="l00302"></a>00302      }
<a name="l00303"></a>00303     
<a name="l00304"></a>00304     <span class="keywordflow">return</span> density * density_scale;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/* Color of light that gets scattered out by the volume */</span>
<a name="l00309"></a>00309 <span class="comment">/* Uses same physically based scattering parameter as in transmission calculations, </span>
<a name="l00310"></a>00310 <span class="comment"> * along with artificial reflection scale/reflection color tint */</span>
<a name="l00311"></a><a class="code" href="../../da/d07/volumetric_8c.html#ad4c6222805b90c2afb71cf2440ff108d">00311</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#ad4c6222805b90c2afb71cf2440ff108d">vol_get_reflection_color</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> ref_col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00312"></a>00312 {
<a name="l00313"></a>00313     <span class="keywordtype">float</span> scatter = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a9c78af11a10b6261ca4803ddeb8b91d2">scattering</a>;
<a name="l00314"></a>00314     <span class="keywordtype">float</span> <a class="code" href="../../d6/d95/rayshade_8c.html#abca23b66848b50aeac1c568646dda72a">reflection</a>= shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a3e0dbc4fec9bb227cc1b773762f60052">reflection</a>;
<a name="l00315"></a>00315     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(ref_col, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a570c152bc25f58beb1e037c729ac07a4">reflection_col</a>);
<a name="l00316"></a>00316     
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>))
<a name="l00318"></a>00318         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(shi, co, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a9ce59cf530f1929de5d9dc171bb35b7d">MAP_REFLECTION_COL</a>, ref_col, &amp;scatter, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00319"></a>00319     
<a name="l00320"></a>00320     <span class="comment">/* only one single float parameter at a time... :s */</span>
<a name="l00321"></a>00321     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a30f1fd2b082cfd91b07340e3afbee2d7">MAP_REFLECTION</a>))
<a name="l00322"></a>00322         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(shi, co, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a30f1fd2b082cfd91b07340e3afbee2d7">MAP_REFLECTION</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;reflection, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00323"></a>00323     
<a name="l00324"></a>00324     ref_col[0] = reflection * ref_col[0] * scatter;
<a name="l00325"></a>00325     ref_col[1] = reflection * ref_col[1] * scatter;
<a name="l00326"></a>00326     ref_col[2] = reflection * ref_col[2] * scatter;
<a name="l00327"></a>00327 }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="comment">/* compute emission component, amount of radiance to add per segment</span>
<a name="l00330"></a>00330 <span class="comment"> * can be textured with &#39;emit&#39; */</span>
<a name="l00331"></a><a class="code" href="../../da/d07/volumetric_8c.html#a7a0090dc01704d54956b7f477c0c2d74">00331</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a7a0090dc01704d54956b7f477c0c2d74">vol_get_emission</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> emission_col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a2c3710b3d1c11810ba8e635db570b34e">emission</a> = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a68432dca33de524f132d6b8243a1f39a">emission</a>;
<a name="l00334"></a>00334     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(emission_col, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a47e63af793faca1e9dbbc1c979bf4146">emission_col</a>);
<a name="l00335"></a>00335     
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>))
<a name="l00337"></a>00337         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(shi, co, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a2038106051782e140a65b35c1599cc88">MAP_EMISSION</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#ad8f2c2b60c1a96aef92b3394bc612f95">MAP_EMISSION_COL</a>, emission_col, &amp;emission, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00338"></a>00338     
<a name="l00339"></a>00339     emission_col[0] = emission_col[0] * <a class="code" href="../../d1/d22/stdosl_8h.html#a2c3710b3d1c11810ba8e635db570b34e">emission</a>;
<a name="l00340"></a>00340     emission_col[1] = emission_col[1] * <a class="code" href="../../d1/d22/stdosl_8h.html#a2c3710b3d1c11810ba8e635db570b34e">emission</a>;
<a name="l00341"></a>00341     emission_col[2] = emission_col[2] * <a class="code" href="../../d1/d22/stdosl_8h.html#a2c3710b3d1c11810ba8e635db570b34e">emission</a>;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 <span class="comment">/* A combination of scattering and absorption -&gt; known as sigma T.</span>
<a name="l00346"></a>00346 <span class="comment"> * This can possibly use a specific scattering color, </span>
<a name="l00347"></a>00347 <span class="comment"> * and absorption multiplier factor too, but these parameters are left out for simplicity.</span>
<a name="l00348"></a>00348 <span class="comment"> * It&#39;s easy enough to get a good wide range of results with just these two parameters. */</span>
<a name="l00349"></a><a class="code" href="../../da/d07/volumetric_8c.html#a25fe49766ed41f62894ed41721d69ffb">00349</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a25fe49766ed41f62894ed41721d69ffb">vol_get_sigma_t</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> sigma_t[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3])
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351     <span class="comment">/* technically absorption, but named transmission color </span>
<a name="l00352"></a>00352 <span class="comment">     * since it describes the effect of the coloring *after* absorption */</span>
<a name="l00353"></a>00353     <span class="keywordtype">float</span> transmission_col[3] = {shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a283e4eb614410dc5961964959288f9ec">transmission_col</a>[0], shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a283e4eb614410dc5961964959288f9ec">transmission_col</a>[1], shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a283e4eb614410dc5961964959288f9ec">transmission_col</a>[2]};
<a name="l00354"></a>00354     <span class="keywordtype">float</span> scattering = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a9c78af11a10b6261ca4803ddeb8b91d2">scattering</a>;
<a name="l00355"></a>00355     
<a name="l00356"></a>00356     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a90700e77116862a4e194521de1ecc941">mapto_textured</a> &amp; (<a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>))
<a name="l00357"></a>00357         <a class="code" href="../../df/dba/texture_8h.html#aee3ec862e63ede6971828217c419b9dc">do_volume_tex</a>(shi, co, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0e244d20118aa3de08ad4f074c33b8f8">MAP_SCATTERING</a>+<a class="code" href="../../de/db2/DNA__material__types_8h.html#a77d05d29cffe87b4f964827b2d58bc37">MAP_TRANSMISSION_COL</a>, transmission_col, &amp;scattering, &amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>);
<a name="l00358"></a>00358     
<a name="l00359"></a>00359     sigma_t[0] = (1.0f - transmission_col[0]) + scattering;
<a name="l00360"></a>00360     sigma_t[1] = (1.0f - transmission_col[1]) + scattering;
<a name="l00361"></a>00361     sigma_t[2] = (1.0f - transmission_col[2]) + scattering;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">/* phase function - determines in which directions the light </span>
<a name="l00365"></a>00365 <span class="comment"> * is scattered in the volume relative to incoming direction </span>
<a name="l00366"></a>00366 <span class="comment"> * and view direction */</span>
<a name="l00367"></a><a class="code" href="../../da/d07/volumetric_8c.html#a3d7ec930fa6a4eff8c44c92208aa91f8">00367</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d07/volumetric_8c.html#a3d7ec930fa6a4eff8c44c92208aa91f8">vol_get_phasefunc</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(shi), <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>, <span class="keyword">const</span> <span class="keywordtype">float</span> w[3], <span class="keyword">const</span> <span class="keywordtype">float</span> wp[3])
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d1/d22/stdosl_8h.html#a03960008c09030a58b2c79672320cb3f">normalize</a> = 0.25f; <span class="comment">// = 1.f/4.f = M_PI/(4.f*M_PI)</span>
<a name="l00370"></a>00370     
<a name="l00371"></a>00371     <span class="comment">/* normalization constant is 1/4 rather than 1/4pi, since</span>
<a name="l00372"></a>00372 <span class="comment">     * Blender&#39;s shading system doesn&#39;t normalize for</span>
<a name="l00373"></a>00373 <span class="comment">     * energy conservation - eg. multiplying by pdf ( 1/pi for a lambert brdf ).</span>
<a name="l00374"></a>00374 <span class="comment">     * This means that lambert surfaces in Blender are pi times brighter than they &#39;should be&#39;</span>
<a name="l00375"></a>00375 <span class="comment">     * and therefore, with correct energy conservation, volumes will darker than other solid objects,</span>
<a name="l00376"></a>00376 <span class="comment">     * for the same lighting intensity.</span>
<a name="l00377"></a>00377 <span class="comment">     * To correct this, scale up the phase function values by pi</span>
<a name="l00378"></a>00378 <span class="comment">     * until Blender&#39;s shading system supports this better. --matt</span>
<a name="l00379"></a>00379 <span class="comment">     */</span>
<a name="l00380"></a>00380     
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (g == 0.f) { <span class="comment">/* isotropic */</span>
<a name="l00382"></a>00382         <span class="keywordflow">return</span> normalize * 1.f;
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384     <span class="keywordflow">else</span> {      <span class="comment">/* schlick */</span>
<a name="l00385"></a>00385         <span class="keyword">const</span> <span class="keywordtype">float</span> k = 1.55f * g - .55f * g * g * <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>;
<a name="l00386"></a>00386         <span class="keyword">const</span> <span class="keywordtype">float</span> kcostheta = k * <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(w, wp);
<a name="l00387"></a>00387         <span class="keywordflow">return</span> normalize * (1.f - k*k) / ((1.f - kcostheta) * (1.f - kcostheta));
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389     
<a name="l00390"></a>00390     <span class="comment">/* not used, but here for reference: */</span>
<a name="l00391"></a>00391 <span class="preprocessor">#if 0</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>    <span class="keywordflow">switch</span> (phasefunc_type) {
<a name="l00393"></a>00393         <span class="keywordflow">case</span> MA_VOL_PH_MIEHAZY:
<a name="l00394"></a>00394             <span class="keywordflow">return</span> normalize * (0.5f + 4.5f * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(0.5 * (1.f + costheta), 8.f));
<a name="l00395"></a>00395         <span class="keywordflow">case</span> MA_VOL_PH_MIEMURKY:
<a name="l00396"></a>00396             <span class="keywordflow">return</span> normalize * (0.5f + 16.5f * <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(0.5 * (1.f + costheta), 32.f));
<a name="l00397"></a>00397         <span class="keywordflow">case</span> MA_VOL_PH_RAYLEIGH:
<a name="l00398"></a>00398             <span class="keywordflow">return</span> normalize * 3.f/4.f * (1 + costheta * costheta);
<a name="l00399"></a>00399         <span class="keywordflow">case</span> MA_VOL_PH_HG:
<a name="l00400"></a>00400             <span class="keywordflow">return</span> normalize * (1.f - g * <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>) / <a class="code" href="../../dd/d06/BLI__math__base_8h.html#acc9eed6743d69a0f62071dc0c7dd6ae8">powf</a>(1.f + g * g - 2.f * g * costheta, 1.5f);
<a name="l00401"></a>00401         <span class="keywordflow">case</span> MA_VOL_PH_SCHLICK:
<a name="l00402"></a>00402         {
<a name="l00403"></a>00403             <span class="keyword">const</span> <span class="keywordtype">float</span> k = 1.55f * g - .55f * g * g * <a class="code" href="../../dd/d05/noise_8c.html#aff056b2f79b1fecd20667df6d20f81d6">g</a>;
<a name="l00404"></a>00404             <span class="keyword">const</span> <span class="keywordtype">float</span> kcostheta = k * costheta;
<a name="l00405"></a>00405             <span class="keywordflow">return</span> normalize * (1.f - k*k) / ((1.f - kcostheta) * (1.f - kcostheta));
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407         <span class="keywordflow">case</span> MA_VOL_PH_ISOTROPIC:
<a name="l00408"></a>00408         <span class="keywordflow">default</span>:
<a name="l00409"></a>00409             <span class="keywordflow">return</span> normalize * 1.f;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 <span class="preprocessor">#endif</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>}
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="comment">/* Compute transmittance = e^(-attenuation) */</span>
<a name="l00415"></a><a class="code" href="../../da/d07/volumetric_8c.html#ab67ed90cf53942421dc5fddfb28b9dbf">00415</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#ab67ed90cf53942421dc5fddfb28b9dbf">vol_get_transmittance_seg</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> tr[3], <span class="keywordtype">float</span> stepsize, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> density)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <span class="comment">/* input density = density at co */</span>
<a name="l00418"></a>00418     <span class="keywordtype">float</span> tau[3] = {0.f, 0.f, 0.f};
<a name="l00419"></a>00419     <span class="keyword">const</span> <span class="keywordtype">float</span> stepd = density * stepsize;
<a name="l00420"></a>00420     <span class="keywordtype">float</span> sigma_t[3];
<a name="l00421"></a>00421     
<a name="l00422"></a>00422     <a class="code" href="../../da/d07/volumetric_8c.html#a25fe49766ed41f62894ed41721d69ffb">vol_get_sigma_t</a>(shi, sigma_t, co);
<a name="l00423"></a>00423     
<a name="l00424"></a>00424     <span class="comment">/* homogenous volume within the sampled distance */</span>
<a name="l00425"></a>00425     tau[0] += stepd * sigma_t[0];
<a name="l00426"></a>00426     tau[1] += stepd * sigma_t[1];
<a name="l00427"></a>00427     tau[2] += stepd * sigma_t[2];
<a name="l00428"></a>00428     
<a name="l00429"></a>00429     tr[0] *= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[0]);
<a name="l00430"></a>00430     tr[1] *= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[1]);
<a name="l00431"></a>00431     tr[2] *= <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[2]);
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="comment">/* Compute transmittance = e^(-attenuation) */</span>
<a name="l00435"></a><a class="code" href="../../da/d07/volumetric_8c.html#ae117c42461729591f68ba6d1685a3c82">00435</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#ae117c42461729591f68ba6d1685a3c82">vol_get_transmittance</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> tr[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> endco[3])
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3] = {co[0], co[1], co[2]};
<a name="l00438"></a>00438     <span class="keywordtype">float</span> step_vec[3] = {endco[0] - co[0], endco[1] - co[1], endco[2] - co[2]};
<a name="l00439"></a>00439     <span class="keywordtype">float</span> tau[3] = {0.f, 0.f, 0.f};
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordtype">float</span> t0 = 0.f;
<a name="l00442"></a>00442     <span class="keywordtype">float</span> t1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(step_vec);
<a name="l00443"></a>00443     <span class="keywordtype">float</span> pt0 = t0;
<a name="l00444"></a>00444     
<a name="l00445"></a>00445     t0 += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a98b5b7c925b13d8f1439b4d30e7c7698">stepsize</a> * ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#aecb1400b13076a4a24fa1776f7a89d8b">stepsize_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a23161bb3b37281771b9705d0335b522e">MA_VOL_STEP_CONSTANT</a>) ? 0.5f : <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>));
<a name="l00446"></a>00446     p[0] += t0 * step_vec[0];
<a name="l00447"></a>00447     p[1] += t0 * step_vec[1];
<a name="l00448"></a>00448     p[2] += t0 * step_vec[2];
<a name="l00449"></a>00449     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(step_vec, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a98b5b7c925b13d8f1439b4d30e7c7698">stepsize</a>);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keywordflow">for</span> (; t0 &lt; t1; pt0 = t0, t0 += shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a98b5b7c925b13d8f1439b4d30e7c7698">stepsize</a>) {
<a name="l00452"></a>00452         <span class="keyword">const</span> <span class="keywordtype">float</span> d = <a class="code" href="../../df/d25/volumetric_8h.html#aee7b356f1ce499a980db83e4e2f0ecbc">vol_get_density</a>(shi, p);
<a name="l00453"></a>00453         <span class="keyword">const</span> <span class="keywordtype">float</span> stepd = (t0 - pt0) * d;
<a name="l00454"></a>00454         <span class="keywordtype">float</span> sigma_t[3];
<a name="l00455"></a>00455         
<a name="l00456"></a>00456         <a class="code" href="../../da/d07/volumetric_8c.html#a25fe49766ed41f62894ed41721d69ffb">vol_get_sigma_t</a>(shi, sigma_t, p);
<a name="l00457"></a>00457         
<a name="l00458"></a>00458         tau[0] += stepd * sigma_t[0];
<a name="l00459"></a>00459         tau[1] += stepd * sigma_t[1];
<a name="l00460"></a>00460         tau[2] += stepd * sigma_t[2];
<a name="l00461"></a>00461         
<a name="l00462"></a>00462         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(p, step_vec);
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464     
<a name="l00465"></a>00465     <span class="comment">/* return transmittance */</span>
<a name="l00466"></a>00466     tr[0] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[0]);
<a name="l00467"></a>00467     tr[1] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[1]);
<a name="l00468"></a>00468     tr[2] = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#a74e69ce0b646f9188ada8ca358cf0c32">expf</a>(-tau[2]);
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 
<a name="l00471"></a><a class="code" href="../../da/d07/volumetric_8c.html#a6e95ac0a835bdb38c038b24efc87c4f0">00471</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a6e95ac0a835bdb38c038b24efc87c4f0">vol_shade_one_lamp</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3], <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar, <span class="keywordtype">float</span> lacol[3])
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473     <span class="keywordtype">float</span> visifac, lv[3], lampdist;
<a name="l00474"></a>00474     <span class="keywordtype">float</span> tr[3]={1.0,1.0,1.0};
<a name="l00475"></a>00475     <span class="keywordtype">float</span> hitco[3], *atten_co;
<a name="l00476"></a>00476     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>, ref_col[3];
<a name="l00477"></a>00477     
<a name="l00478"></a>00478     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a5125b7d24325116f2305e758b26803bc">LA_LAYER</a>) <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5967e8ad343eccf6daa1f05ab9b33ae9">lay</a>)==0) <span class="keywordflow">return</span>;
<a name="l00479"></a>00479     <span class="keywordflow">if</span> ((lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#ae95f3c64ab786d8338cad2aad0bd3cc3">lay</a> &amp; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#afddd7ec275d686f6d3b48bf9b7d2b8c0">lay</a>)==0) <span class="keywordflow">return</span>;
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a41058c07b0f4d1f741d45410407fbe7f">energy</a> == 0.0f) <span class="keywordflow">return</span>;
<a name="l00481"></a>00481     
<a name="l00482"></a>00482     <span class="keywordflow">if</span> ((visifac= <a class="code" href="../../d8/d7c/gpu__material_8c.html#afb2bdd1c02f7db58b253ea0d265f499d">lamp_get_visibility</a>(lar, co, lv, &amp;lampdist)) == 0.f) <span class="keywordflow">return</span>;
<a name="l00483"></a>00483     
<a name="l00484"></a>00484     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lacol, &amp;lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a24af6921991ed6ba82b11e28c5553bf9">r</a>);
<a name="l00485"></a>00485     
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a528449b026cfdde4679c5c07f9ed9653">mode</a> &amp; <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>) {
<a name="l00487"></a>00487         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a570a7dbc14c1ad4254aa08d8705667d6">osatex</a>= 0;
<a name="l00488"></a>00488         <a class="code" href="../../df/dba/texture_8h.html#a2d34292e93e416e64d0017ed4429c6c0">do_lamp_tex</a>(lar, lv, shi, lacol, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a72ababbfa957bed6db88b003795b4a0d">LA_TEXTURE</a>);
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(lacol, visifac);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>))
<a name="l00494"></a>00494         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lv, lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a8b6c3c14fa2e89e889ced41a6dd8908e">vec</a>);
<a name="l00495"></a>00495     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9ac9a5dd319bfe481c973431de10a815">negate_v3</a>(lv);
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a3679735c1c227c148e73fc3f142c4860">shade_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a956a44a546dc8b957f6ad8836c3af00c">MA_VOL_SHADE_SHADOWED</a>) {
<a name="l00498"></a>00498         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(lacol, <a class="code" href="../../da/d07/volumetric_8c.html#a3d78d91104323f9a58ccadee8daaf4ab">vol_get_shadow</a>(shi, lar, co));
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#ad3568ab74428f47aea1c855024e467f0">ELEM3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a3679735c1c227c148e73fc3f142c4860">shade_type</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a36f2a22a5d7cc4e012fe3edf790c114b">MA_VOL_SHADE_SHADED</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#a5161992bacdf4669959b152dc13bcc07">MA_VOL_SHADE_MULTIPLE</a>, <a class="code" href="../../de/db2/DNA__material__types_8h.html#aab485a57a47007532d00923c6663cf77">MA_VOL_SHADE_SHADEDPLUSMULTIPLE</a>)) {
<a name="l00501"></a>00501         <a class="code" href="../../d8/d95/structIsect.html">Isect</a> is;
<a name="l00502"></a>00502         
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a1a564cb47c8f9495decc040c354b041a">shadeflag</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a0edd6e93ce0190695ca751eb04f542c8">MA_VOL_RECV_EXT_SHADOW</a>) {
<a name="l00504"></a>00504             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(lacol, <a class="code" href="../../da/d07/volumetric_8c.html#a3d78d91104323f9a58ccadee8daaf4ab">vol_get_shadow</a>(shi, lar, co));
<a name="l00505"></a>00505             <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(lacol) &lt; 0.001f) <span class="keywordflow">return</span>;
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507         
<a name="l00508"></a>00508         <span class="comment">/* find minimum of volume bounds, or lamp coord */</span>
<a name="l00509"></a>00509         <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a8964f773f6a09bc00edfe3ae0dbd2628">vol_get_bounds</a>(shi, co, lv, hitco, &amp;is, <a class="code" href="../../df/d25/volumetric_8h.html#ac21a2e47d93e23bf37a17503c07a1886">VOL_BOUNDS_SS</a>)) {
<a name="l00510"></a>00510             <span class="keywordtype">float</span> dist = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(co, hitco);
<a name="l00511"></a>00511             <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = (<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *)is.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>;
<a name="l00512"></a>00512             
<a name="l00513"></a>00513             <span class="comment">/* simple internal shadowing */</span>
<a name="l00514"></a>00514             <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ab2181c8ca6ce7ebdb8858702b9dd044c">material_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a09a77831b74012f8cfd878618eed207d">MA_TYPE_SURFACE</a>) {
<a name="l00515"></a>00515                 lacol[0] = lacol[1] = lacol[2] = 0.0f;
<a name="l00516"></a>00516                 <span class="keywordflow">return</span>;
<a name="l00517"></a>00517             }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519             <span class="keywordflow">if</span> (<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a0b02ecc2161884c6587b77fd39150632">ELEM</a>(lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#aabbde472f3d1d9e65807a1bf21a67b75">type</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#a863bf336582eacc01aec51ebf0a5f412">LA_SUN</a>, <a class="code" href="../../d0/d16/DNA__lamp__types_8h.html#acf32ec4edbecc1bb275c15d7b7c3496f">LA_HEMI</a>))
<a name="l00520"></a>00520                 <span class="comment">/* infinite lights, can never be inside volume */</span>
<a name="l00521"></a>00521                 atten_co = hitco;
<a name="l00522"></a>00522             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( lampdist &lt; dist ) {
<a name="l00523"></a>00523                 atten_co = lar-&gt;<a class="code" href="../../d4/d7c/structLampRen.html#a4d25bac6186fe6cab58c4041e8e0fd36">co</a>;
<a name="l00524"></a>00524             }
<a name="l00525"></a>00525             <span class="keywordflow">else</span>
<a name="l00526"></a>00526                 atten_co = hitco;
<a name="l00527"></a>00527             
<a name="l00528"></a>00528             <a class="code" href="../../da/d07/volumetric_8c.html#ae117c42461729591f68ba6d1685a3c82">vol_get_transmittance</a>(shi, tr, co, atten_co);
<a name="l00529"></a>00529             
<a name="l00530"></a>00530             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(lacol, lacol, tr);
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532         <span class="keywordflow">else</span> {
<a name="l00533"></a>00533             <span class="comment">/* Point is on the outside edge of the volume,</span>
<a name="l00534"></a>00534 <span class="comment">             * therefore no attenuation, full transmission.</span>
<a name="l00535"></a>00535 <span class="comment">             * Radiance from lamp remains unchanged */</span>
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(lacol) &lt; 0.001f) <span class="keywordflow">return</span>;
<a name="l00540"></a>00540     
<a name="l00541"></a>00541     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(lv);
<a name="l00542"></a>00542     p = <a class="code" href="../../da/d07/volumetric_8c.html#a3d7ec930fa6a4eff8c44c92208aa91f8">vol_get_phasefunc</a>(shi, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a98279651827e08f46c331a8f498a5fa6">asymmetry</a>, view, lv);
<a name="l00543"></a>00543     
<a name="l00544"></a>00544     <span class="comment">/* physically based scattering with non-physically based RGB gain */</span>
<a name="l00545"></a>00545     <a class="code" href="../../da/d07/volumetric_8c.html#ad4c6222805b90c2afb71cf2440ff108d">vol_get_reflection_color</a>(shi, ref_col, co);
<a name="l00546"></a>00546     
<a name="l00547"></a>00547     lacol[0] *= p * ref_col[0];
<a name="l00548"></a>00548     lacol[1] *= p * ref_col[1];
<a name="l00549"></a>00549     lacol[2] *= p * ref_col[2];
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="comment">/* single scattering only for now */</span>
<a name="l00553"></a><a class="code" href="../../da/d07/volumetric_8c.html#a967bb444b81d3bd9e0ca117e57350a54">00553</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d25/volumetric_8h.html#a967bb444b81d3bd9e0ca117e57350a54">vol_get_scattering</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> scatter_col[3], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> view[3])
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../d6/d7a/structRender.html#a7e18fb2c6e8e67bec1b49d0269428aeb">lights</a>;
<a name="l00556"></a>00556     <a class="code" href="../../d3/d3b/structGroupObject.html">GroupObject</a> *go;
<a name="l00557"></a>00557     <a class="code" href="../../d4/d7c/structLampRen.html">LampRen</a> *lar;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(scatter_col);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     lights= <a class="code" href="../../da/d3d/shading_8h.html#a46ae421aea9ade2d89bbc79729d11438">get_lights</a>(shi);
<a name="l00562"></a>00562     <span class="keywordflow">for</span> (go=lights-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; go; go= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#a81e7437ba90ec95c5fbb96e17e6a203d">next</a>)
<a name="l00563"></a>00563     {
<a name="l00564"></a>00564         <span class="keywordtype">float</span> lacol[3] = {0.f, 0.f, 0.f};
<a name="l00565"></a>00565         lar= go-&gt;<a class="code" href="../../d3/d3b/structGroupObject.html#ae9d282b509700cee2b48aaeec071f790">lampren</a>;
<a name="l00566"></a>00566         
<a name="l00567"></a>00567         <span class="keywordflow">if</span> (lar) {
<a name="l00568"></a>00568             <a class="code" href="../../da/d07/volumetric_8c.html#a6e95ac0a835bdb38c038b24efc87c4f0">vol_shade_one_lamp</a>(shi, co, view, lar, lacol);
<a name="l00569"></a>00569             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(scatter_col, lacol);
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     
<a name="l00575"></a>00575 <span class="comment">/*</span>
<a name="l00576"></a>00576 <span class="comment"> * The main volumetric integrator, using an emission/absorption/scattering model.</span>
<a name="l00577"></a>00577 <span class="comment"> *</span>
<a name="l00578"></a>00578 <span class="comment"> * Incoming radiance =</span>
<a name="l00579"></a>00579 <span class="comment"> *</span>
<a name="l00580"></a>00580 <span class="comment"> * outgoing radiance from behind surface * beam transmittance/attenuation</span>
<a name="l00581"></a>00581 <span class="comment"> * + added radiance from all points along the ray due to participating media</span>
<a name="l00582"></a>00582 <span class="comment"> *     --&gt; radiance for each segment =</span>
<a name="l00583"></a>00583 <span class="comment"> *         (radiance added by scattering + radiance added by emission) * beam transmittance/attenuation</span>
<a name="l00584"></a>00584 <span class="comment"> */</span>
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="comment">/* For ease of use, I&#39;ve also introduced a &#39;reflection&#39; and &#39;reflection color&#39; parameter, which isn&#39;t </span>
<a name="l00587"></a>00587 <span class="comment"> * physically correct. This works as an RGB tint/gain on out-scattered light, but doesn&#39;t affect the light </span>
<a name="l00588"></a>00588 <span class="comment"> * that is transmitted through the volume. While having wavelength dependent absorption/scattering is more correct,</span>
<a name="l00589"></a>00589 <span class="comment"> * it also makes it harder to control the overall look of the volume since coloring the outscattered light results</span>
<a name="l00590"></a>00590 <span class="comment"> * in the inverse color being transmitted through the rest of the volume.</span>
<a name="l00591"></a>00591 <span class="comment"> */</span>
<a name="l00592"></a><a class="code" href="../../da/d07/volumetric_8c.html#ae1104bbdd710d5d70f75afd721afa546">00592</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#ae1104bbdd710d5d70f75afd721afa546">volumeintegrate</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keywordtype">float</span> col[4], <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keyword">const</span> <span class="keywordtype">float</span> endco[3])
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <span class="keywordtype">float</span> radiance[3] = {0.f, 0.f, 0.f};
<a name="l00595"></a>00595     <span class="keywordtype">float</span> tr[3] = {1.f, 1.f, 1.f};
<a name="l00596"></a>00596     <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3] = {co[0], co[1], co[2]};
<a name="l00597"></a>00597     <span class="keywordtype">float</span> step_vec[3] = {endco[0] - co[0], endco[1] - co[1], endco[2] - co[2]};
<a name="l00598"></a>00598     <span class="keyword">const</span> <span class="keywordtype">float</span> stepsize = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a98b5b7c925b13d8f1439b4d30e7c7698">stepsize</a>;
<a name="l00599"></a>00599     
<a name="l00600"></a>00600     <span class="keywordtype">float</span> t0 = 0.f;
<a name="l00601"></a>00601     <span class="keywordtype">float</span> pt0 = t0;
<a name="l00602"></a>00602     <span class="keywordtype">float</span> t1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(step_vec);  <span class="comment">/* returns vector length */</span>
<a name="l00603"></a>00603     
<a name="l00604"></a>00604     t0 += stepsize * ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#aecb1400b13076a4a24fa1776f7a89d8b">stepsize_type</a> == <a class="code" href="../../de/db2/DNA__material__types_8h.html#a23161bb3b37281771b9705d0335b522e">MA_VOL_STEP_CONSTANT</a>) ? 0.5f : <a class="code" href="../../d3/d88/BLI__rand_8h.html#a2ef44df5c43efabcad6c0d004a3d1c65">BLI_thread_frand</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac8bd4733613dcbb81da5e2901e7ffa5f">thread</a>));
<a name="l00605"></a>00605     p[0] += t0 * step_vec[0];
<a name="l00606"></a>00606     p[1] += t0 * step_vec[1];
<a name="l00607"></a>00607     p[2] += t0 * step_vec[2];
<a name="l00608"></a>00608     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(step_vec, stepsize);
<a name="l00609"></a>00609     
<a name="l00610"></a>00610     <span class="keywordflow">for</span> (; t0 &lt; t1; pt0 = t0, t0 += stepsize) {
<a name="l00611"></a>00611         <span class="keyword">const</span> <span class="keywordtype">float</span> density = <a class="code" href="../../df/d25/volumetric_8h.html#aee7b356f1ce499a980db83e4e2f0ecbc">vol_get_density</a>(shi, p);
<a name="l00612"></a>00612         
<a name="l00613"></a>00613         <span class="keywordflow">if</span> (density &gt; 0.00001f) {
<a name="l00614"></a>00614             <span class="keywordtype">float</span> scatter_col[3] = {0.f, 0.f, 0.f}, emit_col[3];
<a name="l00615"></a>00615             <span class="keyword">const</span> <span class="keywordtype">float</span> stepd = (t0 - pt0) * density;
<a name="l00616"></a>00616             
<a name="l00617"></a>00617             <span class="comment">/* transmittance component (alpha) */</span>
<a name="l00618"></a>00618             <a class="code" href="../../da/d07/volumetric_8c.html#ab67ed90cf53942421dc5fddfb28b9dbf">vol_get_transmittance_seg</a>(shi, tr, stepsize, co, density);
<a name="l00619"></a>00619             
<a name="l00620"></a>00620             <span class="keywordflow">if</span> (t0 &gt; t1 * 0.25f) {
<a name="l00621"></a>00621                 <span class="comment">/* only use depth cutoff after we&#39;ve traced a little way into the volume */</span>
<a name="l00622"></a>00622                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(tr) &lt; shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#a26599dc117dcc1cd6e228e74864a39f7">vol</a>.<a class="code" href="../../d5/d16/structVolumeSettings.html#a0bbbcd4074e66b84f0040160be9438d9">depth_cutoff</a>) <span class="keywordflow">break</span>;
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624             
<a name="l00625"></a>00625             <a class="code" href="../../da/d07/volumetric_8c.html#a7a0090dc01704d54956b7f477c0c2d74">vol_get_emission</a>(shi, emit_col, p);
<a name="l00626"></a>00626             
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5ac318b8218d8ae1db8c4ea4fbfe7055">volume_precache</a>) {
<a name="l00628"></a>00628                 <span class="keywordtype">float</span> p2[3];
<a name="l00629"></a>00629                 
<a name="l00630"></a>00630                 p2[0] = p[0] + (step_vec[0] * 0.5f);
<a name="l00631"></a>00631                 p2[1] = p[1] + (step_vec[1] * 0.5f);
<a name="l00632"></a>00632                 p2[2] = p[2] + (step_vec[2] * 0.5f);
<a name="l00633"></a>00633                 
<a name="l00634"></a>00634                 <a class="code" href="../../da/d07/volumetric_8c.html#a26eb03e8a8f21cc47ae22a256e893f34">vol_get_precached_scattering</a>(&amp;<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>, shi, scatter_col, p2);
<a name="l00635"></a>00635             }
<a name="l00636"></a>00636             <span class="keywordflow">else</span>
<a name="l00637"></a>00637                 <a class="code" href="../../df/d25/volumetric_8h.html#a967bb444b81d3bd9e0ca117e57350a54">vol_get_scattering</a>(shi, scatter_col, p, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>);
<a name="l00638"></a>00638             
<a name="l00639"></a>00639             radiance[0] += stepd * tr[0] * (emit_col[0] + scatter_col[0]);
<a name="l00640"></a>00640             radiance[1] += stepd * tr[1] * (emit_col[1] + scatter_col[1]);
<a name="l00641"></a>00641             radiance[2] += stepd * tr[2] * (emit_col[2] + scatter_col[2]);
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(p, step_vec);
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645     
<a name="l00646"></a>00646     <span class="comment">/* multiply original color (from behind volume) with transmittance over entire distance */</span>
<a name="l00647"></a>00647     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3717fdaf34420f0c2a8d99d3062e188a">mul_v3_v3v3</a>(col, tr, col);
<a name="l00648"></a>00648     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(col, radiance);
<a name="l00649"></a>00649     
<a name="l00650"></a>00650     <span class="comment">/* alpha &lt;-- transmission luminance */</span>
<a name="l00651"></a>00651     col[3] = 1.0f - <a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(tr);
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="comment">/* the main entry point for volume shading */</span>
<a name="l00655"></a><a class="code" href="../../da/d07/volumetric_8c.html#a4d73900ed632e6ad049f4ecbd6d99f02">00655</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d07/volumetric_8c.html#a4d73900ed632e6ad049f4ecbd6d99f02">volume_trace</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">struct</span> <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keywordtype">int</span> inside_volume)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657     <span class="keywordtype">float</span> hitco[3], col[4] = {0.f,0.f,0.f,0.f};
<a name="l00658"></a>00658     <span class="keywordtype">float</span> *startco, *endco;
<a name="l00659"></a>00659     <span class="keywordtype">int</span> trace_behind = 1;
<a name="l00660"></a>00660     <span class="keyword">const</span> <span class="keywordtype">int</span> ztransp= ((shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a74417d5eddc8893b28a430d777df9120">depth</a>==0) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#ab93c6e013760ce505229d6c6686b1478">MA_TRANSP</a>) &amp;&amp; (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>-&gt;<a class="code" href="../../d2/d10/structMaterial.html#ad4773378c42a4167bdd615d67997535e">mode</a> &amp; <a class="code" href="../../de/db2/DNA__material__types_8h.html#a582c0fe9d451f1c0ede8929648f9dd52">MA_ZTRANSP</a>));
<a name="l00661"></a>00661     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> is;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="comment">/* check for shading an internal face a volume object directly */</span>
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (inside_volume == <a class="code" href="../../df/d25/volumetric_8h.html#a29eafa9d6ad7dda38f2d471a5ab2b289">VOL_SHADE_INSIDE</a>)
<a name="l00665"></a>00665         trace_behind = 0;
<a name="l00666"></a>00666     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (inside_volume == <a class="code" href="../../df/d25/volumetric_8h.html#a2dc29fd70c09b6fff961c78cd9026b77">VOL_SHADE_OUTSIDE</a>) {
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac7c88ebbd25cdabe29be8fb909195f84">flippednor</a>)
<a name="l00668"></a>00668             inside_volume = <a class="code" href="../../df/d25/volumetric_8h.html#a29eafa9d6ad7dda38f2d471a5ab2b289">VOL_SHADE_INSIDE</a>;
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670     
<a name="l00671"></a>00671     <span class="keywordflow">if</span> (ztransp &amp;&amp; inside_volume == <a class="code" href="../../df/d25/volumetric_8h.html#a29eafa9d6ad7dda38f2d471a5ab2b289">VOL_SHADE_INSIDE</a>) {
<a name="l00672"></a>00672         <a class="code" href="../../d8/db1/structMatInside.html">MatInside</a> *mi;
<a name="l00673"></a>00673         <span class="keywordtype">int</span> render_this=0;
<a name="l00674"></a>00674         
<a name="l00675"></a>00675         <span class="comment">/* don&#39;t render the backfaces of ztransp volume materials.</span>
<a name="l00676"></a>00676 <span class="comment">         *</span>
<a name="l00677"></a>00677 <span class="comment">         * volume shading renders the internal volume from between the</span>
<a name="l00678"></a>00678 <span class="comment">         * &#39; view intersection of the solid volume to the</span>
<a name="l00679"></a>00679 <span class="comment">         * intersection on the other side, as part of the shading of</span>
<a name="l00680"></a>00680 <span class="comment">         * the front face.</span>
<a name="l00681"></a>00681 <span class="comment">         *</span>
<a name="l00682"></a>00682 <span class="comment">         * Because ztransp renders both front and back faces independently</span>
<a name="l00683"></a>00683 <span class="comment">         * this will double up, so here we prevent rendering the backface as well, </span>
<a name="l00684"></a>00684 <span class="comment">         * which would otherwise render the volume in between the camera and the backface</span>
<a name="l00685"></a>00685 <span class="comment">         * --matt */</span>
<a name="l00686"></a>00686         
<a name="l00687"></a>00687         <span class="keywordflow">for</span> (mi=<a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.render_volumes_inside.first; mi; mi=mi-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a142d88bfeb826edb2479ba99bead455a">next</a>) {
<a name="l00688"></a>00688             <span class="comment">/* weak... */</span>
<a name="l00689"></a>00689             <span class="keywordflow">if</span> (mi-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a28ab970c778d8554c0d18d03982b38bf">ma</a> == shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>) render_this=1;
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691         <span class="keywordflow">if</span> (!render_this) <span class="keywordflow">return</span>;
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693     
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (inside_volume == <a class="code" href="../../df/d25/volumetric_8h.html#a29eafa9d6ad7dda38f2d471a5ab2b289">VOL_SHADE_INSIDE</a>) {
<a name="l00696"></a>00696         startco = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#af1230c7e13f94d5d5054d8563ea47eb0">camera_co</a>;
<a name="l00697"></a>00697         endco = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l00698"></a>00698         
<a name="l00699"></a>00699         <span class="keywordflow">if</span> (trace_behind) {
<a name="l00700"></a>00700             <span class="keywordflow">if</span> (!ztransp)
<a name="l00701"></a>00701                 <span class="comment">/* trace behind the volume object */</span>
<a name="l00702"></a>00702                 <a class="code" href="../../da/d07/volumetric_8c.html#a8a6bd666ffa9959e96da79057527897c">vol_trace_behind</a>(shi, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a>, endco, col);
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         <span class="keywordflow">else</span> {
<a name="l00705"></a>00705             <span class="comment">/* we&#39;re tracing through the volume between the camera </span>
<a name="l00706"></a>00706 <span class="comment">             * and a solid surface, so use that pre-shaded radiance */</span>
<a name="l00707"></a>00707             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a097c602b13da72154b19976046f63ef3">copy_v4_v4</a>(col, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         
<a name="l00710"></a>00710         <span class="comment">/* shade volume from &#39;camera&#39; to 1st hit point */</span>
<a name="l00711"></a>00711         <a class="code" href="../../da/d07/volumetric_8c.html#ae1104bbdd710d5d70f75afd721afa546">volumeintegrate</a>(shi, col, startco, endco);
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713     <span class="comment">/* trace to find a backface, the other side bounds of the volume */</span>
<a name="l00714"></a>00714     <span class="comment">/* (ray intersect ignores front faces here) */</span>
<a name="l00715"></a>00715     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a8964f773f6a09bc00edfe3ae0dbd2628">vol_get_bounds</a>(shi, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, hitco, &amp;is, <a class="code" href="../../df/d25/volumetric_8h.html#a917efaf85684af1b05386a56a6f4ab0f">VOL_BOUNDS_DEPTH</a>)) {
<a name="l00716"></a>00716         <a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *vlr = (<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *)is.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>;
<a name="l00717"></a>00717         
<a name="l00718"></a>00718         startco = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l00719"></a>00719         endco = hitco;
<a name="l00720"></a>00720         
<a name="l00721"></a>00721         <a class="code" href="../../dd/db6/paraloopend_8h.html#a65986f23fef03474a87b62a14beafe42">if</a> (!ztransp) {
<a name="l00722"></a>00722             <span class="comment">/* if it&#39;s another face in the same material */</span>
<a name="l00723"></a>00723             <span class="keywordflow">if</span> (vlr-&gt;<a class="code" href="../../da/da0/structVlakRen.html#a78b2a38b4bda0548ffc7a140bd5824ca">mat</a> == shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>) {
<a name="l00724"></a>00724                 <span class="comment">/* trace behind the 2nd (raytrace) hit point */</span>
<a name="l00725"></a>00725                 <a class="code" href="../../da/d07/volumetric_8c.html#a8a6bd666ffa9959e96da79057527897c">vol_trace_behind</a>(shi, (<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *)is.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>, endco, col);
<a name="l00726"></a>00726             }
<a name="l00727"></a>00727             <span class="keywordflow">else</span> {
<a name="l00728"></a>00728                 <a class="code" href="../../da/d07/volumetric_8c.html#a4af2ae8d75283204d9ef6c652c4b3a20">shade_intersection</a>(shi, col, &amp;is);
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731         
<a name="l00732"></a>00732         <span class="comment">/* shade volume from 1st hit point to 2nd hit point */</span>
<a name="l00733"></a>00733         <a class="code" href="../../da/d07/volumetric_8c.html#ae1104bbdd710d5d70f75afd721afa546">volumeintegrate</a>(shi, col, startco, endco);
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735     
<a name="l00736"></a>00736     <span class="keywordflow">if</span> (ztransp)
<a name="l00737"></a>00737         col[3] = col[3]&gt;1.f?1.f:col[3];
<a name="l00738"></a>00738     <span class="keywordflow">else</span>
<a name="l00739"></a>00739         col[3] = 1.f;
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, col);
<a name="l00742"></a>00742     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> = col[3];
<a name="l00743"></a>00743     
<a name="l00744"></a>00744     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#ac248ee9a527adbecbef050543bf8f348">diff</a>, shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>);
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 <span class="comment">/* Traces a shadow through the object, </span>
<a name="l00748"></a>00748 <span class="comment"> * pretty much gets the transmission over a ray path */</span>
<a name="l00749"></a><a class="code" href="../../da/d07/volumetric_8c.html#adbf3df18c582ff1311b784b5912546a3">00749</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d25/volumetric_8h.html#adbf3df18c582ff1311b784b5912546a3">shade_volume_shadow</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <span class="keyword">struct</span> <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr, <span class="keyword">struct</span> <a class="code" href="../../d8/d95/structIsect.html">Isect</a> *last_is)
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751     <span class="keywordtype">float</span> hitco[3];
<a name="l00752"></a>00752     <span class="keywordtype">float</span> tr[3] = {1.0,1.0,1.0};
<a name="l00753"></a>00753     <a class="code" href="../../d8/d95/structIsect.html">Isect</a> is= {{0}};
<a name="l00754"></a>00754     <span class="keywordtype">float</span> *startco, *endco;
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     memset(shr, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>));
<a name="l00757"></a>00757     
<a name="l00758"></a>00758     <span class="comment">/* if 1st hit normal is facing away from the camera, </span>
<a name="l00759"></a>00759 <span class="comment">     * then we&#39;re inside the volume already. */</span>
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ac7c88ebbd25cdabe29be8fb909195f84">flippednor</a>) {
<a name="l00761"></a>00761         startco = last_is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a45530d3cd35832f49f760fd29110a960">start</a>;
<a name="l00762"></a>00762         endco = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764     
<a name="l00765"></a>00765     <span class="comment">/* trace to find a backface, the other side bounds of the volume */</span>
<a name="l00766"></a>00766     <span class="comment">/* (ray intersect ignores front faces here) */</span>
<a name="l00767"></a>00767     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d07/volumetric_8c.html#a8964f773f6a09bc00edfe3ae0dbd2628">vol_get_bounds</a>(shi, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3299049ec2c0e180baa5e0f095a9efa7">view</a>, hitco, &amp;is, <a class="code" href="../../df/d25/volumetric_8h.html#a917efaf85684af1b05386a56a6f4ab0f">VOL_BOUNDS_DEPTH</a>)) {
<a name="l00768"></a>00768         startco = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>;
<a name="l00769"></a>00769         endco = hitco;
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="keywordflow">else</span> {
<a name="l00772"></a>00772         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[0] = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[1] = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[2] = 0.f;
<a name="l00773"></a>00773         shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3] = 1.f;
<a name="l00774"></a>00774         <span class="keywordflow">return</span>;
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <a class="code" href="../../da/d07/volumetric_8c.html#ae117c42461729591f68ba6d1685a3c82">vol_get_transmittance</a>(shi, tr, startco, endco);
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     
<a name="l00780"></a>00780     <span class="comment">/* if we hit another face in the same volume bounds */</span>
<a name="l00781"></a>00781     <span class="comment">/* shift raytrace coordinates to the hit point, to avoid shading volume twice */</span>
<a name="l00782"></a>00782     <span class="comment">/* due to idiosyncracy in ray_trace_shadow_tra() */</span>
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (is.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a10754fec745de036f768ad08aa2ecf0b">ob</a> == shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>) {
<a name="l00784"></a>00784         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#ab9652bad6ed6f84bb7705e4d6a568413">co</a>, hitco);
<a name="l00785"></a>00785         last_is-&gt;<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a> -= is.<a class="code" href="../../d8/d95/structIsect.html#a7e2ebcd892f602b918637b2bb6995a71">dist</a>;
<a name="l00786"></a>00786         shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#abb3f13bb9540f6eae8dbd55ae5574410">vlr</a> = (<a class="code" href="../../da/da0/structVlakRen.html">VlakRen</a> *)is.<a class="code" href="../../d8/d95/structIsect.html#a764d54daa7eb9890e4e77c70a7b0e12f">hit</a>.<a class="code" href="../../d8/d95/structIsect.html#a4039183fbf64f9c7064bf551e0aa5463">face</a>;
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     
<a name="l00790"></a>00790     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>, tr);
<a name="l00791"></a>00791     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3] = 1.0f - <a class="code" href="../../da/d07/volumetric_8c.html#a06b98b0d14f4731275e27a8088b473c9">luminance</a>(tr);
<a name="l00792"></a>00792     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#a90bbe96202822d7c3af20ef2ed3acfe9">combined</a>[3];
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="comment">/* delivers a fully filled in ShadeResult, for all passes */</span>
<a name="l00797"></a><a class="code" href="../../da/d07/volumetric_8c.html#aea85cc79d9cca983bc4e631c88ed052a">00797</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d25/volumetric_8h.html#aea85cc79d9cca983bc4e631c88ed052a">shade_volume_outside</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799     memset(shr, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a>));
<a name="l00800"></a>00800     <a class="code" href="../../da/d07/volumetric_8c.html#a4d73900ed632e6ad049f4ecbd6d99f02">volume_trace</a>(shi, shr, <a class="code" href="../../df/d25/volumetric_8h.html#a2dc29fd70c09b6fff961c78cd9026b77">VOL_SHADE_OUTSIDE</a>);
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 
<a name="l00804"></a><a class="code" href="../../da/d07/volumetric_8c.html#a0b48376ead181a360b27cda0758c3b6e">00804</a> <span class="keywordtype">void</span> <a class="code" href="../../df/d25/volumetric_8h.html#a0b48376ead181a360b27cda0758c3b6e">shade_volume_inside</a>(<a class="code" href="../../d8/db3/structShadeInput.html">ShadeInput</a> *shi, <a class="code" href="../../da/db2/structShadeResult.html">ShadeResult</a> *shr)
<a name="l00805"></a>00805 {
<a name="l00806"></a>00806     <a class="code" href="../../d8/db1/structMatInside.html">MatInside</a> *m;
<a name="l00807"></a>00807     <a class="code" href="../../d2/d10/structMaterial.html">Material</a> *mat_backup;
<a name="l00808"></a>00808     <a class="code" href="../../da/d94/structObjectInstanceRen.html">ObjectInstanceRen</a> *obi_backup;
<a name="l00809"></a>00809     <span class="keywordtype">float</span> prev_alpha = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     <span class="comment">/* XXX: extend to multiple volumes perhaps later */</span>
<a name="l00812"></a>00812     mat_backup = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a>;
<a name="l00813"></a>00813     obi_backup = shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a>;
<a name="l00814"></a>00814     
<a name="l00815"></a>00815     m = <a class="code" href="../../d2/d6c/mball_8c.html#a5c71a5e59a53413cd6c270266d63b031">R</a>.render_volumes_inside.first;
<a name="l00816"></a>00816     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a> = m-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a28ab970c778d8554c0d18d03982b38bf">ma</a>;
<a name="l00817"></a>00817     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> = m-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a9e7b1dfcf879010389704c0a7b8926a7">obi</a>;
<a name="l00818"></a>00818     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> = m-&gt;<a class="code" href="../../d8/db1/structMatInside.html#a9e7b1dfcf879010389704c0a7b8926a7">obi</a>-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00819"></a>00819     
<a name="l00820"></a>00820     <a class="code" href="../../da/d07/volumetric_8c.html#a4d73900ed632e6ad049f4ecbd6d99f02">volume_trace</a>(shi, shr, <a class="code" href="../../df/d25/volumetric_8h.html#a29eafa9d6ad7dda38f2d471a5ab2b289">VOL_SHADE_INSIDE</a>);
<a name="l00821"></a>00821     
<a name="l00822"></a>00822     shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> = shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a> + prev_alpha;
<a name="l00823"></a>00823     <a class="code" href="../../dd/d46/IMAGE_8h.html#a7abc68f3eacc2822738f41c9f08feca6">CLAMP</a>(shr-&gt;<a class="code" href="../../da/db2/structShadeResult.html#abaffd894ff69c1f668c26a4e34e2112e">alpha</a>, 0.0f, 1.0f);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a3868d4e278d09d36e5b226b0827833c9">mat</a> = mat_backup;
<a name="l00826"></a>00826     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a922b7156784d335ed0f3e8ba2d0726b9">obi</a> = obi_backup;
<a name="l00827"></a>00827     shi-&gt;<a class="code" href="../../d8/db3/structShadeInput.html#a1fe0d1bad68c6f1deba6c3e1d4eacb4c">obr</a> = obi_backup-&gt;<a class="code" href="../../da/d94/structObjectInstanceRen.html#a5fff117b9a9f28a20b0e3fc4bee69d18">obr</a>;
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:55:03 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
