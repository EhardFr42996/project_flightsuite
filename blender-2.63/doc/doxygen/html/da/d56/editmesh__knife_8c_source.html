<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Blender: editmesh_knife.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../blender.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Blender&#160;<span id="projectnumber">V2.6x</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">editmesh_knife.c</div>  </div>
</div>
<div class="contents">
<a href="../../da/d56/editmesh__knife_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * ***** BEGIN GPL LICENSE BLOCK *****</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment"> * modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment"> * as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment"> * of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with this program; if not, write to the Free Software Foundation,</span>
<a name="l00016"></a>00016 <span class="comment"> * Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * The Original Code is Copyright (C) 2007 Blender Foundation.</span>
<a name="l00019"></a>00019 <span class="comment"> * All rights reserved.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * </span>
<a name="l00022"></a>00022 <span class="comment"> * Contributor(s): Joseph Eagar, Joshua Leung, Howard Trickey,</span>
<a name="l00023"></a>00023 <span class="comment"> *                 Campbell Barton</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * ***** END GPL LICENSE BLOCK *****</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027 
<a name="l00032"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a525335710b53cb064ca56b936120431e">00032</a> <span class="preprocessor">#define _USE_MATH_DEFINES</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/dd0/MEM__guardedalloc_8h.html" title="Read Guarded memory(de)allocation.">MEM_guardedalloc.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="../../de/df4/BLI__blenlib_8h.html">BLI_blenlib.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d6c/BLI__array_8h.html">BLI_array.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d4b/BLI__math_8h.html">BLI_math.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d88/BLI__rand_8h.html" title="Random number functions.">BLI_rand.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../db/d1a/BLI__smallhash_8h.html">BLI_smallhash.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/de9/BLI__scanfill_8h.html" title="Filling meshes.">BLI_scanfill.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="../../da/db3/BLI__memarena_8h.html" title="Memory arena ADT.">BLI_memarena.h</a>&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html">BKE_DerivedMesh.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d01/BKE__context_8h.html">BKE_context.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/da0/BKE__depsgraph_8h.html">BKE_depsgraph.h</a>&quot;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d44/BIF__gl_8h.html">BIF_gl.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d71/BIF__glutil_8h.html">BIF_glutil.h</a>&quot;</span> <span class="comment">/* for paint cursor */</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/d12/ED__screen_8h.html">ED_screen.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/d5f/ED__space__api_8h.html">ED_space_api.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d6a/ED__view3d_8h.html">ED_view3d.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dd6/ED__mesh_8h.html">ED_mesh.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/d7f/WM__api_8h.html">WM_api.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/ddc/WM__types_8h.html">WM_types.h</a>&quot;</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="../../d4/db3/DNA__scene__types_8h.html">DNA_scene_types.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d96/DNA__mesh__types_8h.html">DNA_mesh_types.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/dd9/DNA__object__types_8h.html" title="Object is a sort of wrapper for general info.">DNA_object_types.h</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html">BKE_tessmesh.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d96/UI__resources_8h.html">UI_resources.h</a>&quot;</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="../../de/ddf/RNA__access_8h.html">RNA_access.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d68/RNA__define_8h.html">RNA_define.h</a>&quot;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d5c/mesh__intern_8h.html">mesh_intern.h</a>&quot;</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="comment">/* this code here is kindof messy. . .I might need to eventually rework it - joeedh */</span>
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#acedd74fd65317c2f1d8e5e614b8a61bd">00072</a> <span class="preprocessor">#define KMAXDIST    10  </span><span class="comment">/* max mouse distance from edge before not detecting it */</span>
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="../../d6/d53/structKnifeColors.html">00074</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d53/structKnifeColors.html">KnifeColors</a> {
<a name="l00075"></a><a class="code" href="../../d6/d53/structKnifeColors.html#aace95cd7e1616675e5cebaa4c2a0a9a0">00075</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d53/structKnifeColors.html#aace95cd7e1616675e5cebaa4c2a0a9a0">line</a>[3];
<a name="l00076"></a><a class="code" href="../../d6/d53/structKnifeColors.html#a5447a0753771771acb975bac07c73c33">00076</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d53/structKnifeColors.html#a5447a0753771771acb975bac07c73c33">edge</a>[3];
<a name="l00077"></a><a class="code" href="../../d6/d53/structKnifeColors.html#a32cecc033ced020b94c801a0ec7559af">00077</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d53/structKnifeColors.html#a32cecc033ced020b94c801a0ec7559af">curpoint</a>[3];
<a name="l00078"></a><a class="code" href="../../d6/d53/structKnifeColors.html#a9d8b619fa2f28d3032ec18900c6f8e8c">00078</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d53/structKnifeColors.html#a9d8b619fa2f28d3032ec18900c6f8e8c">curpoint_a</a>[4];
<a name="l00079"></a><a class="code" href="../../d6/d53/structKnifeColors.html#a5dabe96a0e031241b20b0a8cc3778c49">00079</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d8/dae/structpoint.html">point</a>[3];
<a name="l00080"></a><a class="code" href="../../d6/d53/structKnifeColors.html#a5bb259b0e275143d0c741a41977bd468">00080</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/d53/structKnifeColors.html#a5bb259b0e275143d0c741a41977bd468">point_a</a>[4];
<a name="l00081"></a>00081 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#a88e65e3de7e613f1fd26b49a9989c009">KnifeColors</a>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="comment">/* knifetool operator */</span>
<a name="l00084"></a><a class="code" href="../../dd/d00/structKnifeVert.html">00084</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> {
<a name="l00085"></a><a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">00085</a>     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>; <span class="comment">/* non-NULL if this is an original vert */</span>
<a name="l00086"></a><a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">00086</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">00088</a>     <span class="keywordtype">float</span> <a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>[3], <a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[3], <a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>[3]; <span class="comment">/* sco is screen coordinates for cageco */</span>
<a name="l00089"></a><a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">00089</a>     <span class="keywordtype">short</span> <a class="code" href="../../dd/d00/structKnifeVert.html#ae9beb529fd0ec4a20645901227a9212c">flag</a>, <a class="code" href="../../dd/d00/structKnifeVert.html#a93ef1015aed11b197d723fe189f48a8c">draw</a>, <a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a>, <a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a>;
<a name="l00090"></a>00090 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#aa2587ca5fc383cae6b0bf22f3ffca650">KnifeVert</a>;
<a name="l00091"></a>00091 
<a name="l00092"></a><a class="code" href="../../d0/d6a/structRef.html">00092</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d6a/structRef.html">Ref</a> {
<a name="l00093"></a><a class="code" href="../../d0/d6a/structRef.html#a8d5d6c996e0e63c4a6c4a80b2009d0b2">00093</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d6a/structRef.html">Ref</a> *<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>, *<a class="code" href="../../d0/d6a/structRef.html#a8d5d6c996e0e63c4a6c4a80b2009d0b2">prev</a>;
<a name="l00094"></a><a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">00094</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00095"></a>00095 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5b3bab34f90ba3bb0695a332b730b386">Ref</a>;
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../dd/da6/structKnifeEdge.html">00097</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> {
<a name="l00098"></a><a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">00098</a>     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>, *<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00099"></a><a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">00099</a>     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>; <span class="comment">/* face to restrict face fill to */</span>
<a name="l00100"></a><a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">00100</a>     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> <a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>;
<a name="l00101"></a><a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">00101</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a>;
<a name="l00102"></a>00102 
<a name="l00103"></a><a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">00103</a>     <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, *<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a>; <span class="comment">/* non-NULL if this is an original edge */</span>
<a name="l00104"></a>00104 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#a95504a010577656f67a04e8181ca8e67">KnifeEdge</a>;
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html">00106</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> {
<a name="l00107"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">00107</a>     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00108"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">00108</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>[3], <a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>[3];
<a name="l00109"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a4a0b94037a451307ad6fcabd41c2b8bd">00109</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html#a4a0b94037a451307ad6fcabd41c2b8bd">realhit</a>[3]; <span class="comment">/* used in midpoint mode */</span>
<a name="l00110"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">00110</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>[3];
<a name="l00111"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#aa4f38be10d6ffbfb35a21b8967f8b644">00111</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html#aa4f38be10d6ffbfb35a21b8967f8b644">l</a>; <span class="comment">/* lambda along cut line */</span>
<a name="l00112"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a1057894b9a49680e1de702da54a26eaa">00112</a>     <span class="keywordtype">float</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html#a1057894b9a49680e1de702da54a26eaa">perc</a>; <span class="comment">/* lambda along hit line */</span>
<a name="l00113"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">00113</a>     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a>; <span class="comment">/* set if snapped to a vert */</span>
<a name="l00114"></a><a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">00114</a>     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">f</a>;
<a name="l00115"></a>00115 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#af2f5e18573deeb3e6e574b37824d5fe2">BMEdgeHit</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="../../d9/d8d/structKnifePosData.html">00117</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d8d/structKnifePosData.html">KnifePosData</a> {
<a name="l00118"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">00118</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>[3];
<a name="l00119"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">00119</a>     <span class="keywordtype">float</span> <a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>[3];
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="comment">/* At most one of vert, edge, or bmface should be non-NULL,</span>
<a name="l00122"></a>00122 <span class="comment">     * saying whether the point is snapped to a vertex, edge, or in a face.</span>
<a name="l00123"></a>00123 <span class="comment">     * If none are set, this point is in space and is_space should be true. */</span>
<a name="l00124"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">00124</a>     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>;
<a name="l00125"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">00125</a>     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>;
<a name="l00126"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">00126</a>     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>;
<a name="l00127"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">00127</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">00129</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[2]; <span class="comment">/* mouse screen position */</span>
<a name="l00130"></a>00130 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#a875075effd8c51acfc18c0195ad15bf8">KnifePosData</a>;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="comment">/* struct for properties used while drawing */</span>
<a name="l00133"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html">00133</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> {
<a name="l00134"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">00134</a>     <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>;        <span class="comment">/* region that knifetool was activated in */</span>
<a name="l00135"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc7f2ceec86376f5901fc9e6e9b24d6d">00135</a>     <span class="keywordtype">void</span> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc7f2ceec86376f5901fc9e6e9b24d6d">draw_handle</a>;  <span class="comment">/* for drawing preview loop */</span>
<a name="l00136"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">00136</a>     <a class="code" href="../../d8/d30/structViewContext.html">ViewContext</a> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>;
<a name="l00137"></a>00137     <span class="comment">//bContext *C;</span>
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">00139</a>     <a class="code" href="../../de/de7/structObject.html">Object</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>;
<a name="l00140"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">00140</a>     <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>;
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">00142</a>     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">00144</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">origvertmap</a>;
<a name="l00145"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">00145</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">origedgemap</a>;
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">00147</a>     <a class="code" href="../../df/da0/structGHash.html">GHash</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">kedgefacemap</a>;
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">00149</a>     <a class="code" href="../../d4/df5/structBMBVHTree.html">BMBVHTree</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a>;
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">00151</a>     <a class="code" href="../../dd/d70/structBLI__mempool.html">BLI_mempool</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>;
<a name="l00152"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">00152</a>     <a class="code" href="../../dd/d70/structBLI__mempool.html">BLI_mempool</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>;
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">00154</a>     <span class="keywordtype">float</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">vthresh</a>;
<a name="l00155"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab8c0ee33c70b2f6cd790d9e1cd1bff82">00155</a>     <span class="keywordtype">float</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab8c0ee33c70b2f6cd790d9e1cd1bff82">ethresh</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="comment">/* used for drag-cutting */</span>
<a name="l00158"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">00158</a>     <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>;
<a name="l00159"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">00159</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="comment">/* Data for mouse-position-derived data (cur) and previous click (prev) */</span>
<a name="l00162"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">00162</a>     <a class="code" href="../../d9/d8d/structKnifePosData.html">KnifePosData</a> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>;
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad465da9a82847ed72cbcc1e19cdf0bd0">00164</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a950e383072f2d0b77555da6abc0420d9">totkedge</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad465da9a82847ed72cbcc1e19cdf0bd0">totkvert</a>;
<a name="l00165"></a>00165 
<a name="l00166"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a438b9dd84adc21b3abfb42d523047209">00166</a>     <a class="code" href="../../dd/d70/structBLI__mempool.html">BLI_mempool</a> *<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a438b9dd84adc21b3abfb42d523047209">refs</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a370e64b78642a37ea23a8a79f5ae6afa">00168</a>     <span class="keywordtype">float</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a370e64b78642a37ea23a8a79f5ae6afa">projmat</a>[4][4];
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">00170</a>     <a class="code" href="../../d6/d53/structKnifeColors.html">KnifeColors</a> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="comment">/* operatpr options */</span>
<a name="l00173"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">00173</a>     <span class="keywordtype">char</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a>;    <span class="comment">/* preference, can be modified at runtime (that feature may go) */</span>
<a name="l00174"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#af411809755bcad679cd42ea90ba40e7e">00174</a>     <span class="keywordtype">char</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#af411809755bcad679cd42ea90ba40e7e">only_select</a>;    <span class="comment">/* set on initialization */</span>
<a name="l00175"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#acb69316f3ce3496cc1032ee14236c9cd">00175</a>     <span class="keywordtype">char</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#acb69316f3ce3496cc1032ee14236c9cd">select_result</a>;  <span class="comment">/* set on initialization */</span>
<a name="l00176"></a>00176 
<a name="l00177"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#af2bccd7313ce663b9c7bcffa309009ab">00177</a>     <span class="keywordtype">short</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#af2bccd7313ce663b9c7bcffa309009ab">is_ortho</a>;
<a name="l00178"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc1aef5a999723dfd69a1257fa565cc2">00178</a>     <span class="keywordtype">float</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc1aef5a999723dfd69a1257fa565cc2">clipsta</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a26539ec6c0d5b6227f0146c839f09089">clipend</a>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="keyword">enum</span> {
<a name="l00181"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a8245b8c9a55e5ad6cf501ee778b80815">00181</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a8245b8c9a55e5ad6cf501ee778b80815">MODE_IDLE</a>,
<a name="l00182"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a8f63d997fc7007c4ed89ac5c032511b8">00182</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a8f63d997fc7007c4ed89ac5c032511b8">MODE_DRAGGING</a>,
<a name="l00183"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a75009f3d4f6f004a38fd7e74e701a136">00183</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a75009f3d4f6f004a38fd7e74e701a136">MODE_CONNECT</a>,
<a name="l00184"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a73ecba40eb3e6f02b2c1d7492724a168">00184</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8650d9c02906471322d62d9da1bc2466a73ecba40eb3e6f02b2c1d7492724a168">MODE_PANNING</a>
<a name="l00185"></a>00185     } <a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a>;
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">00187</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a2b421c67f552a005e6cc2a8f2420ba19">prevmode</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a99343aed49fc475df5f59f67b370d351">extend</a>;
<a name="l00188"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">00188</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac3d324d6aa52e21b1456af76da178883">ignore_edge_snapping</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keyword">enum</span> {
<a name="l00191"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a9e0f271b0bec4d3e259fcbf8063074b1">00191</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a9e0f271b0bec4d3e259fcbf8063074b1">ANGLE_FREE</a>,
<a name="l00192"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a1e62d1e6674985463c762af2fa93caf6">00192</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a1e62d1e6674985463c762af2fa93caf6">ANGLE_0</a>,
<a name="l00193"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a10a31c8aa70168114f0dac8a70f1a7bf">00193</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479a10a31c8aa70168114f0dac8a70f1a7bf">ANGLE_45</a>,
<a name="l00194"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479aade987ee134f85be40e187841f13b99a">00194</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479aade987ee134f85be40e187841f13b99a">ANGLE_90</a>,
<a name="l00195"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479aa00ccad3e847862f7436a3badd09d2cc">00195</a>         <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a235ee06f62e729fb4761820227df7479aa00ccad3e847862f7436a3badd09d2cc">ANGLE_135</a>
<a name="l00196"></a>00196     } <a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a>;
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">00198</a>     float (*<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a>)[3];
<a name="l00199"></a>00199 } <a class="code" href="../../da/d56/editmesh__knife_8c.html#a64a37d6fedeedb390ed793581f274c7b">KnifeTool_OpData</a>;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">knife_input_ray_cast</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keyword">const</span> <span class="keywordtype">int</span> mval_i[2],
<a name="l00204"></a>00204                                  <span class="keywordtype">float</span> r_origin[3], <span class="keywordtype">float</span> r_ray[3]);
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">00206</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208 <span class="preprocessor">    #define HEADER_LENGTH 190</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span>    <span class="keywordtype">char</span> header[<a class="code" href="../../da/d56/editmesh__knife_8c.html#acaf400df9a74b3295697ca29cc9261cb">HEADER_LENGTH</a>];
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <a class="code" href="../../d3/db3/BLI__string_8h.html#a150551c0e3b1dc65b4c9021461f468a9">BLI_snprintf</a>(header, <a class="code" href="../../da/d56/editmesh__knife_8c.html#acaf400df9a74b3295697ca29cc9261cb">HEADER_LENGTH</a>, <span class="stringliteral">&quot;LMB: define cut lines, Return/Spacebar: confirm, Esc or RMB: cancel, E: new cut, Ctrl: midpoint snap (%s), &quot;</span>
<a name="l00212"></a>00212                  <span class="stringliteral">&quot;Shift: ignore snap (%s), C: angle constrain (%s), Z: cut through (%s)&quot;</span>,
<a name="l00213"></a>00213                  kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a> ? <span class="stringliteral">&quot;On&quot;</span> : <span class="stringliteral">&quot;Off&quot;</span>,
<a name="l00214"></a>00214                  kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac3d324d6aa52e21b1456af76da178883">ignore_edge_snapping</a> ?  <span class="stringliteral">&quot;On&quot;</span> : <span class="stringliteral">&quot;Off&quot;</span>,
<a name="l00215"></a>00215                  kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> ? <span class="stringliteral">&quot;On&quot;</span> : <span class="stringliteral">&quot;Off&quot;</span>,
<a name="l00216"></a>00216                  kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a> ? <span class="stringliteral">&quot;On&quot;</span> : <span class="stringliteral">&quot;Off&quot;</span>);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C), header);
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">00222</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> sco[3])
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a256cdf9578ebe9cce1a87158bb8ba39d">ED_view3d_project_float_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>, co, sco, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a370e64b78642a37ea23a8a79f5ae6afa">projmat</a>);
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a95dafbb5e2844f0b86fbc8e39ba8fcc7">00227</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a95dafbb5e2844f0b86fbc8e39ba8fcc7">knife_pos_data_clear</a>(<a class="code" href="../../d9/d8d/structKnifePosData.html">KnifePosData</a> *kpd)
<a name="l00228"></a>00228 {
<a name="l00229"></a>00229     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>);
<a name="l00230"></a>00230     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#acd4d89007c860a4c74d459ac72593065">zero_v3</a>(kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00231"></a>00231     kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00232"></a>00232     kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00233"></a>00233     kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00234"></a>00234     kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[0] = 0;
<a name="l00235"></a>00235     kpd-&gt;<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1] = 0;
<a name="l00236"></a>00236 }
<a name="l00237"></a>00237 
<a name="l00238"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">00238</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     lst = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>));
<a name="l00243"></a>00243     lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00244"></a>00244     <span class="keywordflow">return</span> lst;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">00247</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst, <span class="keywordtype">void</span> *elem)
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     ref = <a class="code" href="../../db/d06/BLI__mempool_8h.html#a6f96bbdb22a2597e77add7d22af3dc07">BLI_mempool_calloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a438b9dd84adc21b3abfb42d523047209">refs</a>);
<a name="l00252"></a>00252     ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> = elem;
<a name="l00253"></a>00253     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(lst, ref);
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">00256</a> <span class="keyword">static</span> <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lb, <span class="keywordtype">void</span> *ref)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref1;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="keywordflow">for</span> (ref1 = lb-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref1; ref1 = ref1-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (ref1-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == ref)
<a name="l00262"></a>00262             <span class="keywordflow">return</span> ref1;
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">00268</a> <span class="keyword">static</span> <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a950e383072f2d0b77555da6abc0420d9">totkedge</a>++;
<a name="l00271"></a>00271     <span class="keywordflow">return</span> <a class="code" href="../../db/d06/BLI__mempool_8h.html#a6f96bbdb22a2597e77add7d22af3dc07">BLI_mempool_calloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>);
<a name="l00272"></a>00272 }
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">00274</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">knife_add_to_vert_edges</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, &amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>, kfe);
<a name="l00277"></a>00277     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, &amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>, kfe);
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">00280</a> <span class="keyword">static</span> <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">new_knife_vert</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> *<a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>, <span class="keywordtype">float</span> *cageco)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#a6f96bbdb22a2597e77add7d22af3dc07">BLI_mempool_calloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad465da9a82847ed72cbcc1e19cdf0bd0">totkvert</a>++;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, co);
<a name="l00287"></a>00287     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, cageco);
<a name="l00288"></a>00288     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>, co);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">return</span> kfv;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">/* get a KnifeVert wrapper for an existing BMVert */</span>
<a name="l00296"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">00296</a> <span class="keyword">static</span> <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">get_bm_knife_vert</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">origvertmap</a>, v);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (!kfv) {
<a name="l00301"></a>00301         kfv = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">new_knife_vert</a>(kcd, v-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a>[<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(v)]);
<a name="l00302"></a>00302         kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> = v;
<a name="l00303"></a>00303         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">origvertmap</a>, v, kfv);
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">return</span> kfv;
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00312"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a9c73286b370baba374deac2e7f25802b">00312</a> <span class="keyword">static</span> <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a9c73286b370baba374deac2e7f25802b">get_bm_knife_edge</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *e)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">origedgemap</a>, e);
<a name="l00315"></a>00315     <span class="keywordflow">if</span> (!kfe) {
<a name="l00316"></a>00316         <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l_iter, *l_first;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         kfe = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd);
<a name="l00319"></a>00319         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a> = e;
<a name="l00320"></a>00320         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">get_bm_knife_vert</a>(kcd, e-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab6378c5ea7e85917c389a1dfdff790ea">v1</a>);
<a name="l00321"></a>00321         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">get_bm_knife_vert</a>(kcd, e-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#a00090f09abd0ef12bcf279cb0c41c0ca">v2</a>);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">knife_add_to_vert_edges</a>(kcd, kfe);
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">origedgemap</a>, e, kfe);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <span class="comment">/* avoid BM_ITER because of stack memory usage</span>
<a name="l00328"></a>00328 <span class="comment">         * otherwise we could use BM_FACES_OF_EDGE */</span>
<a name="l00329"></a>00329         l_iter = l_first = e-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab9029150e1f571daf0c3e21c0bf6f797">l</a>;
<a name="l00330"></a>00330         <span class="keywordflow">do</span> {
<a name="l00331"></a>00331             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, &amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a91ef300365e03d63842c7b694626bbb7">f</a>);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333             <span class="comment">/* ensures the kedges lst for this f is initialized,</span>
<a name="l00334"></a>00334 <span class="comment">             * it automatically adds kfe by itself */</span>
<a name="l00335"></a>00335             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a91ef300365e03d63842c7b694626bbb7">f</a>);
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         } <span class="keywordflow">while</span> ((l_iter = l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a4dc79205ddd30671e16a96fefca84d3c">radial_next</a>) != l_first);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="keywordflow">return</span> kfe;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="comment">/* User has just clicked for first time or first time after a restart (E key).</span>
<a name="l00344"></a>00344 <span class="comment"> * Copy the current position data into prev. */</span>
<a name="l00345"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#abde42a881bb00ad96a4ca3b8e13682c2">00345</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#abde42a881bb00ad96a4ca3b8e13682c2">knife_start_cut</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00346"></a>00346 {
<a name="l00347"></a>00347     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>;
<a name="l00348"></a>00348     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a> = 0; <span class="comment">/*TODO: why do we do this? */</span>
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a212d65c08323cdf9e10d72e1775e94c2">is_zero_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>)) {
<a name="l00351"></a>00351         <span class="comment">/* Make prevcage a point on the view ray to mouse closest to a point on model: choose vertex 0 */</span>
<a name="l00352"></a>00352         <span class="keywordtype">float</span> origin[3], ray[3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];
<a name="l00353"></a>00353         <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v0;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">knife_input_ray_cast</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>, origin, ray);
<a name="l00356"></a>00356         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, origin, ray);
<a name="l00357"></a>00357         v0 = <a class="code" href="../../d5/db9/bmesh__mesh_8c.html#a9bdd7b1a71b94c74954a0b1f76fc3d74">BM_vert_at_index</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, 0);
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (v0) {
<a name="l00359"></a>00359             <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, v0-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>, co, origin);
<a name="l00360"></a>00360             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>); <span class="comment">/*TODO: do we need this? */</span>
<a name="l00361"></a>00361             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00362"></a>00362             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>);
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00369"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">00369</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ac3bdece51152c2b9d4deff6771958b69">BLI_ghash_lookup</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">kedgefacemap</a>, f);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (!lst) {
<a name="l00374"></a>00374         <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l_iter, *l_first;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="comment">/* avoid BM_ITER because of stack memory usage</span>
<a name="l00379"></a>00379 <span class="comment">         * otherwise we could use BM_EDGES_OF_FACE */</span>
<a name="l00380"></a>00380         l_iter = l_first = <a class="code" href="../../d1/d77/bmesh__class_8h.html#a9eb772ebcdb9e516e91c3d56572cddec">BM_FACE_FIRST_LOOP</a>(f);
<a name="l00381"></a>00381         <span class="keywordflow">do</span> {
<a name="l00382"></a>00382             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9c73286b370baba374deac2e7f25802b">get_bm_knife_edge</a>(kcd, l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a37f32bdf99c1763a272342a3c83b5f51">e</a>));
<a name="l00383"></a>00383         } <span class="keywordflow">while</span> ((l_iter = l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#af78d4a4546e654c1dcc6ebe6476ff0b0">next</a>) != l_first);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#ad72f3a6d9b88bc494c6a279d1b7b9165">BLI_ghash_insert</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">kedgefacemap</a>, f, lst);
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="keywordflow">return</span> lst;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="comment">/* finds the proper face to restrict face fill to */</span>
<a name="l00392"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a82328bad04ec81a1b77e5f56416141ea">00392</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a82328bad04ec81a1b77e5f56416141ea">knife_find_basef</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     <span class="keywordflow">if</span> (!kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>) {
<a name="l00395"></a>00395         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r1, *r2, *r3, *r4;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a>) {
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a>)
<a name="l00399"></a>00399                 kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>;
<a name="l00400"></a>00400             <span class="keywordflow">else</span>
<a name="l00401"></a>00401                 kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="keywordflow">else</span> {
<a name="l00404"></a>00404             <span class="keywordflow">for</span> (r1 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r1 &amp;&amp; !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>; r1 = r1-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00405"></a>00405                 <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *ke1 = r1-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00406"></a>00406                 <span class="keywordflow">for</span> (r2 = ke1-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r2 &amp;&amp; !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>; r2 = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00407"></a>00407                     <span class="keywordflow">for</span> (r3 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r3 &amp;&amp; !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>; r3 = r3-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00408"></a>00408                         <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *ke2 = r3-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00409"></a>00409 
<a name="l00410"></a>00410                         <span class="keywordflow">for</span> (r4 = ke2-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r4 &amp;&amp; !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>; r4 = r4-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00411"></a>00411                             <span class="keywordflow">if</span> (r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == r4-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>) {
<a name="l00412"></a>00412                                 kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00413"></a>00413                             }
<a name="l00414"></a>00414                         }
<a name="l00415"></a>00415                     }
<a name="l00416"></a>00416                 }
<a name="l00417"></a>00417             }
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419         <span class="comment">/* ok, at this point kfe-&gt;basef should be set if any valid possibility exists */</span>
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00423"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">00423</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f)
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, f), kfe);
<a name="l00426"></a>00426     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, &amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, f);
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">00429</a> <span class="keyword">static</span> <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> **newkfe_out)
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *newkfe = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd);
<a name="l00432"></a>00432     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l00433"></a>00433     <span class="keywordtype">float</span> perc, cageco[3], l12;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     l12 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (l12 &lt; FLT_EPSILON * 80) {
<a name="l00437"></a>00437         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cageco, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     <span class="keywordflow">else</span> {
<a name="l00440"></a>00440         perc = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(co, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>) / l12;
<a name="l00441"></a>00441         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(cageco, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, perc);
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l00445"></a>00445     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">new_knife_vert</a>(kcd, co, cageco);
<a name="l00446"></a>00446     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a93ef1015aed11b197d723fe189f48a8c">draw</a> = 1;
<a name="l00447"></a>00447     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     ref = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>, kfe);
<a name="l00450"></a>00450     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>, ref);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00453"></a>00453     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>, ref);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="keywordflow">for</span> (ref = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>)
<a name="l00456"></a>00456         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(kcd, newkfe, ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">knife_add_to_vert_edges</a>(kcd, newkfe);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a>;
<a name="l00461"></a>00461     newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     *newkfe_out = newkfe;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="keywordflow">return</span> newkfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 <span class="comment">/* Make a single KnifeEdge for cut from kcd-&gt;prev to kcd-&gt;cur.</span>
<a name="l00469"></a>00469 <span class="comment"> * and move cur data to prev. */</span>
<a name="l00470"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">00470</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">knife_add_single_cut</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd), *kfe2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *kfe3 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> == kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>)
<a name="l00475"></a>00475         <span class="keywordflow">return</span>;
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> == kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>)
<a name="l00477"></a>00477         <span class="keywordflow">return</span>;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = 1;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l00482"></a>00482         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>;
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>) {
<a name="l00485"></a>00485         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, &amp;kfe2);
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487     <span class="keywordflow">else</span> {
<a name="l00488"></a>00488         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">new_knife_vert</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>);
<a name="l00489"></a>00489         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a93ef1015aed11b197d723fe189f48a8c">draw</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = !kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00490"></a>00490         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00491"></a>00491         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = !kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00492"></a>00492         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a> = 1;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l00496"></a>00496         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>;
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>) {
<a name="l00499"></a>00499         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, &amp;kfe3);
<a name="l00500"></a>00500         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     <span class="keywordflow">else</span> {
<a name="l00503"></a>00503         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0c2e99ef806dcbab50da8a0002e634ec">new_knife_vert</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>);
<a name="l00504"></a>00504         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a93ef1015aed11b197d723fe189f48a8c">draw</a> = !kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00505"></a>00505         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a> = 1;
<a name="l00506"></a>00506         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>)
<a name="l00509"></a>00509             kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = 0;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00512"></a>00512     }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a82328bad04ec81a1b77e5f56416141ea">knife_find_basef</a>(kcd, kfe);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">knife_add_to_vert_edges</a>(kcd, kfe);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> &amp;&amp; !<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>))
<a name="l00519"></a>00519         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(kcd, kfe, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="comment">/* sanity check to make sure we&#39;re in the right edge/face lists */</span>
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>) {
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (!<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>)) {
<a name="l00524"></a>00524             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(kcd, kfe, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>);
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> != kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>) {
<a name="l00528"></a>00528             <span class="keywordflow">if</span> (!<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(&amp;kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>)) {
<a name="l00529"></a>00529                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(kcd, kfe, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>);
<a name="l00530"></a>00530             }
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <span class="comment">/* set up for next cut */</span>
<a name="l00535"></a>00535     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a2bc2a7a8076b07dc0c45942c0e8930fc">00538</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a2bc2a7a8076b07dc0c45942c0e8930fc">verge_linehit</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *vlh1, <span class="keyword">const</span> <span class="keywordtype">void</span> *vlh2)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <span class="keyword">const</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *lh1 = vlh1, *lh2 = vlh2;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span>      (lh1-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#aa4f38be10d6ffbfb35a21b8967f8b644">l</a> &lt; lh2-&gt;l) <span class="keywordflow">return</span> -1;
<a name="l00543"></a>00543     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lh1-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#aa4f38be10d6ffbfb35a21b8967f8b644">l</a> &gt; lh2-&gt;l) <span class="keywordflow">return</span> 1;
<a name="l00544"></a>00544     <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">00547</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">knife_add_single_cut_through</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *v1, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *v2, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f)
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfenew;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     kfenew = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd);
<a name="l00552"></a>00552     kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = 1;
<a name="l00553"></a>00553     kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = f;
<a name="l00554"></a>00554     kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = v1;
<a name="l00555"></a>00555     kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = v2;
<a name="l00556"></a>00556     kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a> = 1;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7df1a845356af62c9724472bc3137b00">knife_add_to_vert_edges</a>(kcd, kfenew);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="keywordflow">if</span> (!<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(&amp;kfenew-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>, f))
<a name="l00561"></a>00561         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0516614212c4cecb28c2b8b14aadd4fc">knife_edge_append_face</a>(kcd, kfenew, f);
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a68c7b9f0cdf5466887b8c7dde1f6355e">00564</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a68c7b9f0cdf5466887b8c7dde1f6355e">knife_get_vert_faces</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *facef, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> bmiter;
<a name="l00567"></a>00567     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae711f0376c0ee3b43b0a734683b7bb8a">isface</a> &amp;&amp; facef) {
<a name="l00570"></a>00570         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, facef);
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>) {
<a name="l00573"></a>00573         <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (f, &amp;bmiter, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa37651dfdb90919510896eeccfbcc9cf4">BM_FACES_OF_VERT</a>) {
<a name="l00574"></a>00574             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, f);
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ac1a40b8639ebfa586d927f028c8252da">00579</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac1a40b8639ebfa586d927f028c8252da">knife_get_edge_faces</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst)
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> bmiter;
<a name="l00582"></a>00582     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>) {
<a name="l00585"></a>00585         <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (f, &amp;bmiter, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa3027c8bb018a25ce0260593cb6d02ef3">BM_FACES_OF_EDGE</a>) {
<a name="l00586"></a>00586             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, f);
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="comment">/* BMESH_TODO: add more functionality to cut-through:</span>
<a name="l00592"></a>00592 <span class="comment"> *    - cutting &quot;in face&quot; (e.g., holes) should cut in all faces, not just visible one</span>
<a name="l00593"></a>00593 <span class="comment"> *    - perhaps improve O(n^2) algorithm used here */</span>
<a name="l00594"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a0137d89819d71f210ee031a624e10eeb">00594</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0137d89819d71f210ee031a624e10eeb">knife_cut_through</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596     <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *lh, *lh2;
<a name="l00597"></a>00597     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l00598"></a>00598     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, *kfe2, *kfe3;
<a name="l00599"></a>00599     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *v1, *v2, *firstv = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *lastv = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00600"></a>00600     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> firstfaces = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>}, lastfaces = {<a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>};
<a name="l00601"></a>00601     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r, *r2;
<a name="l00602"></a>00602     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> **splitkfe;
<a name="l00603"></a>00603     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, found;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (!kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>) {
<a name="l00606"></a>00606         <span class="comment">/* if no linehits then no interesting back face stuff to do */</span>
<a name="l00607"></a>00607         <a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">knife_add_single_cut</a>(kcd);
<a name="l00608"></a>00608         <span class="keywordflow">return</span>;
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     qsort(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a>), <a class="code" href="../../da/d56/editmesh__knife_8c.html#a2bc2a7a8076b07dc0c45942c0e8930fc">verge_linehit</a>);
<a name="l00612"></a>00612     splitkfe = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *), <span class="stringliteral">&quot;knife_cut_through&quot;</span>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l00615"></a>00615         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> == kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>)
<a name="l00616"></a>00616             <span class="keywordflow">return</span>;
<a name="l00617"></a>00617         firstv = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>;
<a name="l00618"></a>00618         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a68c7b9f0cdf5466887b8c7dde1f6355e">knife_get_vert_faces</a>(kcd, firstv, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>, &amp;firstfaces);
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>) {
<a name="l00621"></a>00621         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> == kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>)
<a name="l00622"></a>00622             <span class="keywordflow">return</span>;
<a name="l00623"></a>00623         firstv = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, &amp;kfe3);
<a name="l00624"></a>00624         <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac1a40b8639ebfa586d927f028c8252da">knife_get_edge_faces</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, &amp;firstfaces);
<a name="l00625"></a>00625     }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l00628"></a>00628         lastv = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>;
<a name="l00629"></a>00629         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a68c7b9f0cdf5466887b8c7dde1f6355e">knife_get_vert_faces</a>(kcd, lastv, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>, &amp;lastfaces);
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>) {
<a name="l00632"></a>00632         lastv = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, &amp;kfe3);
<a name="l00633"></a>00633         <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac1a40b8639ebfa586d927f028c8252da">knife_get_edge_faces</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>, &amp;lastfaces);
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (firstv) {
<a name="l00637"></a>00637         <span class="comment">/* For each face incident to firstv,</span>
<a name="l00638"></a>00638 <span class="comment">         * find the first following linehit (if any) sharing that face and connect */</span>
<a name="l00639"></a>00639         <span class="keywordflow">for</span> (r = firstfaces.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00640"></a>00640             f = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00641"></a>00641             found = 0;
<a name="l00642"></a>00642             <span class="keywordflow">for</span> (j = 0, lh2 = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>; j &lt; kcd-&gt;totlinehit; j++, lh2++) {
<a name="l00643"></a>00643                 kfe2 = lh2-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00644"></a>00644                 <span class="keywordflow">for</span> (r2 = kfe2-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r2; r2 = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00645"></a>00645                     <span class="keywordflow">if</span> (r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == f) {
<a name="l00646"></a>00646                         v2 = splitkfe[j] ? kfe2-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> : <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kfe2, lh2-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, &amp;splitkfe[j]);
<a name="l00647"></a>00647                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">knife_add_single_cut_through</a>(kcd, firstv, v2, f);
<a name="l00648"></a>00648                         found = 1;
<a name="l00649"></a>00649                         <span class="keywordflow">break</span>;
<a name="l00650"></a>00650                     }
<a name="l00651"></a>00651                 }
<a name="l00652"></a>00652             }
<a name="l00653"></a>00653             <span class="keywordflow">if</span> (!found &amp;&amp; lastv) {
<a name="l00654"></a>00654                 <span class="keywordflow">for</span> (r2 = lastfaces.first; r2; r2 = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00655"></a>00655                     <span class="keywordflow">if</span> (r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == f) {
<a name="l00656"></a>00656                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">knife_add_single_cut_through</a>(kcd, firstv, lastv, f);
<a name="l00657"></a>00657                         <span class="keywordflow">break</span>;
<a name="l00658"></a>00658                     }
<a name="l00659"></a>00659                 }
<a name="l00660"></a>00660             }
<a name="l00661"></a>00661         }
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="keywordflow">for</span> (i = 0, lh = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>; i &lt; kcd-&gt;totlinehit; i++, lh++) {
<a name="l00665"></a>00665         kfe = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="comment">/* For each face attached to edge for this linehit,</span>
<a name="l00668"></a>00668 <span class="comment">         * find the first following linehit (if any) sharing that face and connect */</span>
<a name="l00669"></a>00669         <span class="keywordflow">for</span> (r = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00670"></a>00670             f = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l00671"></a>00671             found = 0;
<a name="l00672"></a>00672             <span class="keywordflow">for</span> (j = i + 1, lh2 = lh + 1; j &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>; j++, lh2++) {
<a name="l00673"></a>00673                 kfe2 = lh2-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00674"></a>00674                 <span class="keywordflow">for</span> (r2 = kfe2-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r2; r2 = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00675"></a>00675                     <span class="keywordflow">if</span> (r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == f) {
<a name="l00676"></a>00676                         v1 = splitkfe[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> : <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kfe, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, &amp;splitkfe[i]);
<a name="l00677"></a>00677                         v2 = splitkfe[j] ? kfe2-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> : <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kfe2, lh2-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, &amp;splitkfe[j]);
<a name="l00678"></a>00678                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">knife_add_single_cut_through</a>(kcd, v1, v2, f);
<a name="l00679"></a>00679                         found = 1;
<a name="l00680"></a>00680                         <span class="keywordflow">break</span>;
<a name="l00681"></a>00681                     }
<a name="l00682"></a>00682                 }
<a name="l00683"></a>00683             }
<a name="l00684"></a>00684             <span class="keywordflow">if</span> (!found &amp;&amp; lastv) {
<a name="l00685"></a>00685                 <span class="keywordflow">for</span> (r2 = lastfaces.first; r2; r2 = r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l00686"></a>00686                     <span class="keywordflow">if</span> (r2-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a> == f) {
<a name="l00687"></a>00687                         v1 = splitkfe[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> : <a class="code" href="../../da/d56/editmesh__knife_8c.html#a731578d114dad536db92f8be94bf0d74">knife_split_edge</a>(kcd, kfe, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, &amp;splitkfe[i]);
<a name="l00688"></a>00688                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9f7c2eaa8d5dab8c845d74a8dbb48489">knife_add_single_cut_through</a>(kcd, v1, lastv, f);
<a name="l00689"></a>00689                         <span class="keywordflow">break</span>;
<a name="l00690"></a>00690                     }
<a name="l00691"></a>00691                 }
<a name="l00692"></a>00692             }
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(splitkfe);
<a name="l00697"></a>00697     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>);
<a name="l00698"></a>00698     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00699"></a>00699     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> = 0;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="comment">/* set up for next cut */</span>
<a name="l00702"></a>00702     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>;
<a name="l00703"></a>00703 }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705 <span class="comment">/* User has just left-clicked after the first time.</span>
<a name="l00706"></a>00706 <span class="comment"> * Add all knife cuts implied by line from prev to cur.</span>
<a name="l00707"></a>00707 <span class="comment"> * If that line crossed edges then kcd-&gt;linehits will be non-NULL. */</span>
<a name="l00708"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#acfe89167b2afbef5fd0f388dd2ad7ccb">00708</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#acfe89167b2afbef5fd0f388dd2ad7ccb">knife_add_cut</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710     <a class="code" href="../../d9/d8d/structKnifePosData.html">KnifePosData</a> savcur = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a>) {
<a name="l00713"></a>00713         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0137d89819d71f210ee031a624e10eeb">knife_cut_through</a>(kcd);
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>) {
<a name="l00716"></a>00716         <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *lh, *lastlh, *firstlh;
<a name="l00717"></a>00717         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719         qsort(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a>), <a class="code" href="../../da/d56/editmesh__knife_8c.html#a2bc2a7a8076b07dc0c45942c0e8930fc">verge_linehit</a>);
<a name="l00720"></a>00720 
<a name="l00721"></a>00721         lh = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>;
<a name="l00722"></a>00722         lastlh = firstlh = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00723"></a>00723         <span class="keywordflow">for</span> (i = 0; i &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>; i++, (lastlh = lh), lh++) {
<a name="l00724"></a>00724             <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f = lastlh ? lastlh-&gt;f : lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">f</a>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726             <span class="keywordflow">if</span> (lastlh &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(lastlh-&gt;hit, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>) == 0.0f) {
<a name="l00727"></a>00727                 <span class="keywordflow">if</span> (!firstlh)
<a name="l00728"></a>00728                     firstlh = lastlh;
<a name="l00729"></a>00729                 <span class="keywordflow">continue</span>;
<a name="l00730"></a>00730             }
<a name="l00731"></a>00731             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lastlh &amp;&amp; firstlh) {
<a name="l00732"></a>00732                 <span class="keywordflow">if</span> (firstlh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> || lastlh-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>) {
<a name="l00733"></a>00733                     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv = firstlh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> ? firstlh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> : lastlh-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = kfv;
<a name="l00736"></a>00736                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, firstlh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>);
<a name="l00737"></a>00737                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, firstlh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l00738"></a>00738                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00739"></a>00739                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = f;
<a name="l00740"></a>00740                     <span class="comment">/* TODO: should we set prev.in_space = 0 ? */</span>
<a name="l00741"></a>00741                 }
<a name="l00742"></a>00742                 lastlh = firstlh = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00743"></a>00743             }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a4a0b94037a451307ad6fcabd41c2b8bd">realhit</a>) &lt; FLT_EPSILON * 80)
<a name="l00746"></a>00746                 <span class="keywordflow">continue</span>;
<a name="l00747"></a>00747             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a4a0b94037a451307ad6fcabd41c2b8bd">realhit</a>) &lt; FLT_EPSILON * 80)
<a name="l00748"></a>00748                 <span class="keywordflow">continue</span>;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750             <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>) {
<a name="l00751"></a>00751                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a> = 0;
<a name="l00752"></a>00752                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>);
<a name="l00753"></a>00753                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l00754"></a>00754                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00755"></a>00755                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00756"></a>00756                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">f</a>;
<a name="l00757"></a>00757                 <span class="keywordflow">continue</span>;
<a name="l00758"></a>00758             }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a> = 0;
<a name="l00761"></a>00761             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>;
<a name="l00762"></a>00762             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">f</a>;
<a name="l00763"></a>00763             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a>;
<a name="l00764"></a>00764             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>);
<a name="l00765"></a>00765             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767             <a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">knife_add_single_cut</a>(kcd);
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (savcur.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>) {
<a name="l00771"></a>00771             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a> = savcur;
<a name="l00772"></a>00772         }
<a name="l00773"></a>00773         <span class="keywordflow">else</span> {
<a name="l00774"></a>00774             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a> = savcur;
<a name="l00775"></a>00775             <a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">knife_add_single_cut</a>(kcd);
<a name="l00776"></a>00776         }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>);
<a name="l00779"></a>00779         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00780"></a>00780         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> = 0;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     <span class="keywordflow">else</span> {
<a name="l00783"></a>00783         <a class="code" href="../../da/d56/editmesh__knife_8c.html#afe77294f4cad286bc681b6eab1c7a7e1">knife_add_single_cut</a>(kcd);
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a6c88da7a03d2b9586504aa028219f264">00787</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6c88da7a03d2b9586504aa028219f264">knife_finish_cut</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(kcd))
<a name="l00788"></a>00788 {
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ad3ecdfe64ed1ca35dff541a98c6483b1">00792</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad3ecdfe64ed1ca35dff541a98c6483b1">knifetool_draw_angle_snapping</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l00793"></a>00793 {
<a name="l00794"></a>00794     <a class="code" href="../../d4/d07/structbglMats.html">bglMats</a> mats;
<a name="l00795"></a>00795     <span class="keywordtype">double</span> u[3], u1[2], u2[2], v1[3], v2[3], dx, dy;
<a name="l00796"></a>00796     <span class="keywordtype">double</span> wminx, wminy, wmaxx, wmaxy;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="comment">/* make u the window coords of prevcage */</span>
<a name="l00799"></a>00799     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#afccb9d1a5f8b3698dfa1b3bdd3ec4955">view3d_get_transformation</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>, &amp;mats);
<a name="l00800"></a>00800     gluProject(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>[0], kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>[1], kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>[2],
<a name="l00801"></a>00801                mats.<a class="code" href="../../d4/d07/structbglMats.html#a0d177557f13d0bfad9e691c9ed47fbbf">modelview</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#a6879ea7b7a7aa876f044916bc22c93f6">projection</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#afa9aa1f59767b29f1981ae96ceaccbdd">viewport</a>,
<a name="l00802"></a>00802                &amp;u[0], &amp;u[1], &amp;u[2]);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <span class="comment">/* make u1, u2 the points on window going through u at snap angle */</span>
<a name="l00805"></a>00805     wminx = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a>;
<a name="l00806"></a>00806     wmaxx = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#acdf13419de6bc3f4944a981589bc3a03">xmin</a> + kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a32e37003215c0dc7f77e12e4fc9db3f4">winx</a>;
<a name="l00807"></a>00807     wminy = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a>;
<a name="l00808"></a>00808     wmaxy = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ac2944792e9f57effa923f02b3a40ac62">winrct</a>.<a class="code" href="../../d0/d28/structrcti.html#a1d1838135b30932a8ce557885d924518">ymin</a> + kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a908d20a23657ef143d2de1496be69f42">winy</a>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="keywordflow">switch</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a>) {
<a name="l00811"></a>00811         <span class="keywordflow">case</span> ANGLE_0:
<a name="l00812"></a>00812             u1[0] = wminx;
<a name="l00813"></a>00813             u2[0] = wmaxx;
<a name="l00814"></a>00814             u1[1] = u2[1] = u[1];
<a name="l00815"></a>00815             <span class="keywordflow">break</span>;
<a name="l00816"></a>00816         <span class="keywordflow">case</span> ANGLE_90:
<a name="l00817"></a>00817             u1[0] = u2[0] = u[0];
<a name="l00818"></a>00818             u1[1] = wminy;
<a name="l00819"></a>00819             u2[1] = wmaxy;
<a name="l00820"></a>00820             <span class="keywordflow">break</span>;
<a name="l00821"></a>00821         <span class="keywordflow">case</span> ANGLE_45:
<a name="l00822"></a>00822             <span class="comment">/* clip against left or bottom */</span>
<a name="l00823"></a>00823             dx = u[0] - wminx;
<a name="l00824"></a>00824             dy = u[1] - wminy;
<a name="l00825"></a>00825             <span class="keywordflow">if</span> (dy &gt; dx) {
<a name="l00826"></a>00826                 u1[0] = wminx;
<a name="l00827"></a>00827                 u1[1] = u[1] - dx;
<a name="l00828"></a>00828             }
<a name="l00829"></a>00829             <span class="keywordflow">else</span> {
<a name="l00830"></a>00830                 u1[0] = u[0] - dy;
<a name="l00831"></a>00831                 u1[1] = wminy;
<a name="l00832"></a>00832             }
<a name="l00833"></a>00833             <span class="comment">/* clip against right or top */</span>
<a name="l00834"></a>00834             dx = wmaxx - u[0];
<a name="l00835"></a>00835             dy = wmaxy - u[1];
<a name="l00836"></a>00836             <span class="keywordflow">if</span> (dy &gt; dx) {
<a name="l00837"></a>00837                 u2[0] = wmaxx;
<a name="l00838"></a>00838                 u2[1] = u[1] + dx;
<a name="l00839"></a>00839             }
<a name="l00840"></a>00840             <span class="keywordflow">else</span> {
<a name="l00841"></a>00841                 u2[0] = u[0] + dy;
<a name="l00842"></a>00842                 u2[1] = wmaxy;
<a name="l00843"></a>00843             }
<a name="l00844"></a>00844             <span class="keywordflow">break</span>;
<a name="l00845"></a>00845         <span class="keywordflow">case</span> ANGLE_135:
<a name="l00846"></a>00846             <span class="comment">/* clip against right or bottom */</span>
<a name="l00847"></a>00847             dx = wmaxx - u[0];
<a name="l00848"></a>00848             dy = u[1] - wminy;
<a name="l00849"></a>00849             <span class="keywordflow">if</span> (dy &gt; dx) {
<a name="l00850"></a>00850                 u1[0] = wmaxx;
<a name="l00851"></a>00851                 u1[1] = u[1] - dx;
<a name="l00852"></a>00852             }
<a name="l00853"></a>00853             <span class="keywordflow">else</span> {
<a name="l00854"></a>00854                 u1[0] = u[0] + dy;
<a name="l00855"></a>00855                 u1[1] = wminy;
<a name="l00856"></a>00856             }
<a name="l00857"></a>00857             <span class="comment">/* clip against left or top */</span>
<a name="l00858"></a>00858             dx = u[0] - wminx;
<a name="l00859"></a>00859             dy = wmaxy - u[1];
<a name="l00860"></a>00860             <span class="keywordflow">if</span> (dy &gt; dx) {
<a name="l00861"></a>00861                 u2[0] = wminx;
<a name="l00862"></a>00862                 u2[1] = u[1] + dx;
<a name="l00863"></a>00863             }
<a name="l00864"></a>00864             <span class="keywordflow">else</span> {
<a name="l00865"></a>00865                 u2[0] = u[0] - dy;
<a name="l00866"></a>00866                 u2[1] = wmaxy;
<a name="l00867"></a>00867             }
<a name="l00868"></a>00868             <span class="keywordflow">break</span>;
<a name="l00869"></a>00869         <span class="keywordflow">default</span>:
<a name="l00870"></a>00870             <span class="keywordflow">return</span>;
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="comment">/* unproject u1 and u2 back into object space */</span>
<a name="l00874"></a>00874     gluUnProject(u1[0], u1[1], 0.0,
<a name="l00875"></a>00875                  mats.<a class="code" href="../../d4/d07/structbglMats.html#a0d177557f13d0bfad9e691c9ed47fbbf">modelview</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#a6879ea7b7a7aa876f044916bc22c93f6">projection</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#afa9aa1f59767b29f1981ae96ceaccbdd">viewport</a>,
<a name="l00876"></a>00876                  &amp;v1[0], &amp;v1[1], &amp;v1[2]);
<a name="l00877"></a>00877     gluUnProject(u2[0], u2[1], 0.0,
<a name="l00878"></a>00878                  mats.<a class="code" href="../../d4/d07/structbglMats.html#a0d177557f13d0bfad9e691c9ed47fbbf">modelview</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#a6879ea7b7a7aa876f044916bc22c93f6">projection</a>, mats.<a class="code" href="../../d4/d07/structbglMats.html#afa9aa1f59767b29f1981ae96ceaccbdd">viewport</a>,
<a name="l00879"></a>00879                  &amp;v2[0], &amp;v2[1], &amp;v2[2]);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <a class="code" href="../../de/d96/UI__resources_8h.html#af31db5d1a7c8b15e6e8a008482426f3a">UI_ThemeColor</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a56cb220b76a5a0ace472c22380906297">TH_TRANSFORM</a>);
<a name="l00882"></a>00882     glLineWidth(2.0);
<a name="l00883"></a>00883     glBegin(GL_LINES);
<a name="l00884"></a>00884     glVertex3dv(v1);
<a name="l00885"></a>00885     glVertex3dv(v2);
<a name="l00886"></a>00886     glEnd();
<a name="l00887"></a>00887 }
<a name="l00888"></a>00888 
<a name="l00889"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#afb9b4e7f90c57d4163f685d143829654">00889</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#afb9b4e7f90c57d4163f685d143829654">knife_init_colors</a>(<a class="code" href="../../d6/d53/structKnifeColors.html">KnifeColors</a> *colors)
<a name="l00890"></a>00890 {
<a name="l00891"></a>00891     <span class="comment">/* possible BMESH_TODO: add explicit themes or calculate these by</span>
<a name="l00892"></a>00892 <span class="comment">     * figuring out constrasting colors with grid / edges / verts</span>
<a name="l00893"></a>00893 <span class="comment">     * a la UI_make_axis_color */</span>
<a name="l00894"></a>00894     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a62f63eceee4bbbd2dca2a25363e178cc">TH_NURB_VLINE</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#aace95cd7e1616675e5cebaa4c2a0a9a0">line</a>);
<a name="l00895"></a>00895     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a8cd5c9f00893a228177266e839ea2bf3">TH_NURB_ULINE</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a5447a0753771771acb975bac07c73c33">edge</a>);
<a name="l00896"></a>00896     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a98e66fc5ee3039870e46e698bac928cb">TH_HANDLE_SEL_VECT</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a32cecc033ced020b94c801a0ec7559af">curpoint</a>);
<a name="l00897"></a>00897     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a98e66fc5ee3039870e46e698bac928cb">TH_HANDLE_SEL_VECT</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a9d8b619fa2f28d3032ec18900c6f8e8c">curpoint_a</a>);
<a name="l00898"></a>00898     colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a9d8b619fa2f28d3032ec18900c6f8e8c">curpoint_a</a>[3] = 102;
<a name="l00899"></a>00899     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a4a65da48d83dfff7570ba52924d0babc">TH_ACTIVE_SPLINE</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a5dabe96a0e031241b20b0a8cc3778c49">point</a>);
<a name="l00900"></a>00900     <a class="code" href="../../de/d96/UI__resources_8h.html#a7df10cffdef8a2191960e1db949d3f47">UI_GetThemeColor3ubv</a>(<a class="code" href="../../de/d96/UI__resources_8h.html#ae33c78feb670de33d2abf21ec0624531a4a65da48d83dfff7570ba52924d0babc">TH_ACTIVE_SPLINE</a>, colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a5bb259b0e275143d0c741a41977bd468">point_a</a>);
<a name="l00901"></a>00901     colors-&gt;<a class="code" href="../../d6/d53/structKnifeColors.html#a5bb259b0e275143d0c741a41977bd468">point_a</a>[3] = 102;
<a name="l00902"></a>00902 }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 <span class="comment">/* modal loop selection drawing callback */</span>
<a name="l00905"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a6bbaeb918152f722e4e0cdbbf630c48b">00905</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6bbaeb918152f722e4e0cdbbf630c48b">knifetool_draw</a>(<span class="keyword">const</span> <a class="code" href="../../d5/df1/structbContext.html">bContext</a> *<a class="code" href="../../d7/d0d/node__texture__proc_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>, <a class="code" href="../../da/d23/structARegion.html">ARegion</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(ar), <span class="keywordtype">void</span> *arg)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907     <a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d = <a class="code" href="../../df/d01/BKE__context_8h.html#a88ab4a564441708766a6b4ace3b17908">CTX_wm_view3d</a>(C);
<a name="l00908"></a>00908     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd = arg;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glDisable(GL_DEPTH_TEST);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     glPolygonOffset(1.0f, 1.0f);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     glPushMatrix();
<a name="l00915"></a>00915     <a class="code" href="../../dd/d44/BIF__gl_8h.html#a22a8b7985dcd174e9add6f20aa37a962">glMultMatrixf</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> == MODE_DRAGGING) {
<a name="l00918"></a>00918         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> != ANGLE_FREE)
<a name="l00919"></a>00919             <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad3ecdfe64ed1ca35dff541a98c6483b1">knifetool_draw_angle_snapping</a>(kcd);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921         glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#aace95cd7e1616675e5cebaa4c2a0a9a0">line</a>);
<a name="l00922"></a>00922         
<a name="l00923"></a>00923         glLineWidth(2.0);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925         glBegin(GL_LINES);
<a name="l00926"></a>00926         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00927"></a>00927         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00928"></a>00928         glEnd();
<a name="l00929"></a>00929 
<a name="l00930"></a>00930         glLineWidth(1.0);
<a name="l00931"></a>00931     }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>) {
<a name="l00934"></a>00934         glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a5447a0753771771acb975bac07c73c33">edge</a>);
<a name="l00935"></a>00935         glLineWidth(2.0);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937         glBegin(GL_LINES);
<a name="l00938"></a>00938         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l00939"></a>00939         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l00940"></a>00940         glEnd();
<a name="l00941"></a>00941 
<a name="l00942"></a>00942         glLineWidth(1.0);
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l00945"></a>00945         glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a5dabe96a0e031241b20b0a8cc3778c49">point</a>);
<a name="l00946"></a>00946         glPointSize(11);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948         glBegin(GL_POINTS);
<a name="l00949"></a>00949         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00950"></a>00950         glEnd();
<a name="l00951"></a>00951     }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>) {
<a name="l00954"></a>00954         glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a32cecc033ced020b94c801a0ec7559af">curpoint</a>);
<a name="l00955"></a>00955         glPointSize(9);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957         glBegin(GL_POINTS);
<a name="l00958"></a>00958         glVertex3fv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l00959"></a>00959         glEnd();
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> &gt; 0) {
<a name="l00963"></a>00963         <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *lh;
<a name="l00964"></a>00964         <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966         glEnable(GL_BLEND);
<a name="l00967"></a>00967         glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
<a name="l00968"></a>00968 
<a name="l00969"></a>00969         <span class="comment">/* draw any snapped verts first */</span>
<a name="l00970"></a>00970         glColor4ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a5bb259b0e275143d0c741a41977bd468">point_a</a>);
<a name="l00971"></a>00971         glPointSize(11);
<a name="l00972"></a>00972         glBegin(GL_POINTS);
<a name="l00973"></a>00973         lh = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>;
<a name="l00974"></a>00974         <span class="keywordflow">for</span> (i = 0; i &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>; i++, lh++) {
<a name="l00975"></a>00975             <span class="keywordtype">float</span> sv1[3], sv2[3];
<a name="l00976"></a>00976 
<a name="l00977"></a>00977             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, sv1);
<a name="l00978"></a>00978             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, sv2);
<a name="l00979"></a>00979             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>, sv1) &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">vthresh</a> / 4.0f) {
<a name="l00982"></a>00982                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l00983"></a>00983                 glVertex3fv(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l00984"></a>00984                 lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l00985"></a>00985             }
<a name="l00986"></a>00986             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>, sv2) &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">vthresh</a> / 4.0f) {
<a name="l00987"></a>00987                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l00988"></a>00988                 glVertex3fv(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l00989"></a>00989                 lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> = lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a>-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l00990"></a>00990             }
<a name="l00991"></a>00991         }
<a name="l00992"></a>00992         glEnd();
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         <span class="comment">/* now draw the rest */</span>
<a name="l00995"></a>00995         glColor4ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a9d8b619fa2f28d3032ec18900c6f8e8c">curpoint_a</a>);
<a name="l00996"></a>00996         glPointSize(7);
<a name="l00997"></a>00997         glBegin(GL_POINTS);
<a name="l00998"></a>00998         lh = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>;
<a name="l00999"></a>00999         <span class="keywordflow">for</span> (i = 0; i &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>; i++, lh++) {
<a name="l01000"></a>01000             glVertex3fv(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>);
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002         glEnd();
<a name="l01003"></a>01003         glDisable(GL_BLEND);
<a name="l01004"></a>01004     }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a950e383072f2d0b77555da6abc0420d9">totkedge</a> &gt; 0) {
<a name="l01007"></a>01007         <a class="code" href="../../db/d0e/structBLI__mempool__iter.html">BLI_mempool_iter</a> iter;
<a name="l01008"></a>01008         <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         glLineWidth(1.0);
<a name="l01011"></a>01011         glBegin(GL_LINES);
<a name="l01012"></a>01012 
<a name="l01013"></a>01013         <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>, &amp;iter);
<a name="l01014"></a>01014         <span class="keywordflow">for</span> (kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfe; kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l01015"></a>01015             <span class="keywordflow">if</span> (!kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a0e40234859567c10d972cc1a1c120134">draw</a>)
<a name="l01016"></a>01016                 <span class="keywordflow">continue</span>;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018             glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#aace95cd7e1616675e5cebaa4c2a0a9a0">line</a>);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020             glVertex3fv(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01021"></a>01021             glVertex3fv(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01022"></a>01022         }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         glEnd();
<a name="l01025"></a>01025         glLineWidth(1.0);
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad465da9a82847ed72cbcc1e19cdf0bd0">totkvert</a> &gt; 0) {
<a name="l01029"></a>01029         <a class="code" href="../../db/d0e/structBLI__mempool__iter.html">BLI_mempool_iter</a> iter;
<a name="l01030"></a>01030         <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         glPointSize(5.0);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034         glBegin(GL_POINTS);
<a name="l01035"></a>01035         <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>, &amp;iter);
<a name="l01036"></a>01036         <span class="keywordflow">for</span> (kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfv; kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l01037"></a>01037             <span class="keywordflow">if</span> (!kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a93ef1015aed11b197d723fe189f48a8c">draw</a>)
<a name="l01038"></a>01038                 <span class="keywordflow">continue</span>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040             glColor3ubv(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>.<a class="code" href="../../d6/d53/structKnifeColors.html#a5dabe96a0e031241b20b0a8cc3778c49">point</a>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042             glVertex3fv(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01043"></a>01043         }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045         glEnd();
<a name="l01046"></a>01046     }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     glPopMatrix();
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     <span class="keywordflow">if</span> (v3d-&gt;<a class="code" href="../../d6/deb/structView3D.html#afd443bfd0de5169661f08aa1eeb3bd69">zbuf</a>) glEnable(GL_DEPTH_TEST);
<a name="l01051"></a>01051 }
<a name="l01052"></a>01052 
<a name="l01053"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a52661519d743f8348a28e007a289182f">01053</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a52661519d743f8348a28e007a289182f">len_v3_tri_side_max</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> v1[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3])
<a name="l01054"></a>01054 {
<a name="l01055"></a>01055     <span class="keyword">const</span> <span class="keywordtype">float</span> s1 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v1, v2);
<a name="l01056"></a>01056     <span class="keyword">const</span> <span class="keywordtype">float</span> s2 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v2, v3);
<a name="l01057"></a>01057     <span class="keyword">const</span> <span class="keywordtype">float</span> s3 = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(v3, v1);
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="keywordflow">return</span> <a class="code" href="../../dd/d46/IMAGE_8h.html#a87a519a4901f827aca98fa11601a739c">MAX3</a>(s1, s2, s3);
<a name="l01060"></a>01060 }
<a name="l01061"></a>01061 
<a name="l01062"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ac17fb8886dda0e040c6aa53f7551c8d3">01062</a> <span class="keyword">static</span> <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#ac17fb8886dda0e040c6aa53f7551c8d3">knife_edge_tri_isect</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d4/df5/structBMBVHTree.html">BMBVHTree</a> *bmtree,
<a name="l01063"></a>01063                                        <span class="keyword">const</span> <span class="keywordtype">float</span> v1[3],  <span class="keyword">const</span> <span class="keywordtype">float</span> v2[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v3[3],
<a name="l01064"></a>01064                                        <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> *ehash, <a class="code" href="../../d4/d07/structbglMats.html">bglMats</a> *mats, <span class="keywordtype">int</span> *count)
<a name="l01065"></a>01065 {
<a name="l01066"></a>01066     <a class="code" href="../../dc/dad/structBVHTree.html">BVHTree</a> *tree2 = <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a606a445825afda3db873f4b585f51f5b">BLI_bvhtree_new</a>(3, FLT_EPSILON * 4, 8, 8), *tree = <a class="code" href="../../d4/d90/editmesh__bvh_8c.html#ac9a56a52cce9444591017a20cd36a8ab">BMBVH_BVHTree</a>(bmtree);
<a name="l01067"></a>01067     <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *edges = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01068"></a>01068     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae22059e2259b0ea217cfe400e698d21e">BLI_array_declare</a>(edges);
<a name="l01069"></a>01069     <a class="code" href="../../d0/d80/structBVHTreeOverlap.html">BVHTreeOverlap</a> *results, *result;
<a name="l01070"></a>01070     <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> **ls;
<a name="l01071"></a>01071     <span class="keywordtype">float</span> <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>[9], uv[3], lambda;
<a name="l01072"></a>01072     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tot = 0;
<a name="l01073"></a>01073     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075     <span class="comment">/* for comparing distances, error of intersection depends on triangle scale.</span>
<a name="l01076"></a>01076 <span class="comment">     * need to scale down before squaring for accurate comparison */</span>
<a name="l01077"></a>01077     <span class="keyword">const</span> <span class="keywordtype">float</span> depsilon = 50 * FLT_EPSILON * <a class="code" href="../../da/d56/editmesh__knife_8c.html#a52661519d743f8348a28e007a289182f">len_v3_tri_side_max</a>(v1, v2, v3);
<a name="l01078"></a>01078     <span class="keyword">const</span> <span class="keywordtype">float</span> depsilon_squared = depsilon * depsilon;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cos + 0, v1);
<a name="l01081"></a>01081     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cos + 3, v2);
<a name="l01082"></a>01082     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cos + 6, v3);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a5457bfc4e6d161a7c16366a415557f06">BLI_bvhtree_insert</a>(tree2, 0, cos, 3);
<a name="l01085"></a>01085     <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a59fe8fa2e2aa5b7c170fdbb10eb979f8">BLI_bvhtree_balance</a>(tree2);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     result = results = <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a1ddfede6a3a6017211e6a39c51c914b9">BLI_bvhtree_overlap</a>(tree, tree2, &amp;tot);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="keywordflow">for</span> (i = 0; i &lt; tot; i++, result++) {
<a name="l01090"></a>01090         <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3];
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         ls = (<a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> **)kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a569c5a14f9e26ded573dd9a6b848da93">looptris</a>[result-&gt;<a class="code" href="../../d0/d80/structBVHTreeOverlap.html#ac44bac1baa3513f687eab08a569260af">indexA</a>];
<a name="l01093"></a>01093 
<a name="l01094"></a>01094         for (j = 0; j &lt; 3; j++) {
<a name="l01095"></a>01095             <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l1 = ls[j];
<a name="l01096"></a>01096             <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *hitf;
<a name="l01097"></a>01097             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, l1-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a91ef300365e03d63842c7b694626bbb7">f</a>);
<a name="l01098"></a>01098             <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100             <span class="keywordflow">for</span> (ref = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01101"></a>01101                 <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                 <span class="comment">//if (kfe == kcd-&gt;cur.edge || kfe == kcd-&gt;prev.edge)</span>
<a name="l01104"></a>01104                 <span class="comment">//  continue;</span>
<a name="l01105"></a>01105 
<a name="l01106"></a>01106                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a69853822f1e463f7142dcc6f987043b9">isect_line_tri_v3</a>(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, v1, v2, v3, &amp;lambda, uv)) {
<a name="l01107"></a>01107                     <span class="keywordtype">float</span> no[3], view[3], sp[3];
<a name="l01108"></a>01108 
<a name="l01109"></a>01109                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(p, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, lambda);
<a name="l01110"></a>01110 
<a name="l01111"></a>01111                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, p) &lt; depsilon_squared)
<a name="l01112"></a>01112                         <span class="keywordflow">continue</span>;
<a name="l01113"></a>01113                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> &amp;&amp; <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, p) &lt; depsilon_squared)
<a name="l01114"></a>01114                         <span class="keywordflow">continue</span>;
<a name="l01115"></a>01115                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, p) &lt; depsilon_squared ||
<a name="l01116"></a>01116                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, p) &lt; depsilon_squared)
<a name="l01117"></a>01117                     {
<a name="l01118"></a>01118                         <span class="keywordflow">continue</span>;
<a name="l01119"></a>01119                     }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, p, sp);
<a name="l01122"></a>01122                     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#add193f7544650c3b94f0619b8378d93a">view3d_unproject</a>(mats, view, sp[0], sp[1], 0.0f);
<a name="l01123"></a>01123                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, view);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a>) {
<a name="l01126"></a>01126                         hitf = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01127"></a>01127                     }
<a name="l01128"></a>01128                     <span class="keywordflow">else</span> {
<a name="l01129"></a>01129                         <span class="comment">/* check if this point is visible in the viewport */</span>
<a name="l01130"></a>01130                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3d305087815afcd193f1d6e561537c34">sub_v3_v3</a>(view, p);
<a name="l01131"></a>01131                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(view);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(no, view);
<a name="l01134"></a>01134                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a614c21caf4e6d770c7a49006a7f734b4">mul_v3_fl</a>(no, 0.003);
<a name="l01135"></a>01135 
<a name="l01136"></a>01136                         <span class="comment">/* go towards view a bit */</span>
<a name="l01137"></a>01137                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ae0067c77927da3b22dec1de77ac8ba78">add_v3_v3</a>(p, no);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139                         <span class="comment">/* ray cast */</span>
<a name="l01140"></a>01140                         hitf = <a class="code" href="../../d4/d90/editmesh__bvh_8c.html#a7b262129df5e0b5c5491b5c09bdfc763">BMBVH_RayCast</a>(bmtree, p, no, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01141"></a>01141                     }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143                     <span class="comment">/* ok, if visible add the new point */</span>
<a name="l01144"></a>01144                     <span class="keywordflow">if</span> (!hitf &amp;&amp; !<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(ehash, (intptr_t)kfe)) {
<a name="l01145"></a>01145                         <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> hit;
<a name="l01146"></a>01146                         
<a name="l01147"></a>01147                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(p, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>) &lt; depsilon_squared ||
<a name="l01148"></a>01148                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a15742fea05c814f61658bcfd93923eac">len_squared_v3v3</a>(p, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>) &lt; depsilon_squared)
<a name="l01149"></a>01149                         {
<a name="l01150"></a>01150                             <span class="keywordflow">continue</span>;
<a name="l01151"></a>01151                         }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153                         hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a5f5b5719041a65feb2e44fe14731ba55">kfe</a> = kfe;
<a name="l01154"></a>01154                         hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a0d8befb43418e3dae442d2b11967b23f">v</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a82328bad04ec81a1b77e5f56416141ea">knife_find_basef</a>(kcd, kfe);
<a name="l01157"></a>01157                         hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a35b4e0b50b544c3185dc4c60b07112c2">f</a> = kfe-&gt;basef;
<a name="l01158"></a>01158                         hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a1057894b9a49680e1de702da54a26eaa">perc</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(p, kfe-&gt;v1-&gt;cageco) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(kfe-&gt;v1-&gt;cageco, kfe-&gt;v2-&gt;cageco);
<a name="l01159"></a>01159                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, p);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(p, kfe-&gt;v1-&gt;co, kfe-&gt;v2-&gt;co, hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a1057894b9a49680e1de702da54a26eaa">perc</a>);
<a name="l01162"></a>01162                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a4a0b94037a451307ad6fcabd41c2b8bd">realhit</a>, p);
<a name="l01163"></a>01163 
<a name="l01164"></a>01164                         <span class="comment">/* BMESH_TODO: should also snap to vertices */</span>
<a name="l01165"></a>01165                         <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a>) {
<a name="l01166"></a>01166                             <span class="keywordtype">float</span> perc = hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a1057894b9a49680e1de702da54a26eaa">perc</a>;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168                             <span class="comment">/* select the closest from the edge endpoints or the midpoint */</span>
<a name="l01169"></a>01169                             <span class="keywordflow">if</span> (perc &lt; 0.25f) {
<a name="l01170"></a>01170                                 perc = 0.0f;
<a name="l01171"></a>01171                             }
<a name="l01172"></a>01172                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (perc &lt; 0.75f) {
<a name="l01173"></a>01173                                 perc = 0.5f;
<a name="l01174"></a>01174                             }
<a name="l01175"></a>01175                             <span class="keywordflow">else</span> {
<a name="l01176"></a>01176                                 perc = 1.0f;
<a name="l01177"></a>01177                             }
<a name="l01178"></a>01178 
<a name="l01179"></a>01179                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, kfe-&gt;v1-&gt;co, kfe-&gt;v2-&gt;co, perc);
<a name="l01180"></a>01180                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, kfe-&gt;v1-&gt;cageco, kfe-&gt;v2-&gt;cageco, perc);
<a name="l01181"></a>01181                         }
<a name="l01182"></a>01182                         <span class="keywordflow">else</span> {
<a name="l01183"></a>01183                             <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#a6fd9cdc2917ba06775910838f1054b98">hit</a>, p);
<a name="l01184"></a>01184                         }
<a name="l01185"></a>01185                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#af82c966de2c8dd64b2a13d28dc67623b">cagehit</a>, hit.<a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>);
<a name="l01186"></a>01186 
<a name="l01187"></a>01187                         <a class="code" href="../../da/d6c/BLI__array_8h.html#a24d25d219077cae8e9c4a66ef3983c54">BLI_array_append</a>(edges, hit);
<a name="l01188"></a>01188                         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(ehash, (intptr_t)kfe, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01189"></a>01189                     }
<a name="l01190"></a>01190                 }
<a name="l01191"></a>01191             }
<a name="l01192"></a>01192         }
<a name="l01193"></a>01193     }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195     <span class="keywordflow">if</span> (results)
<a name="l01196"></a>01196         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(results);
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     <a class="code" href="../../d5/dc5/BLI__kdopbvh_8h.html#a7f17e6306b5a1a4025ea0775631461de">BLI_bvhtree_free</a>(tree2);
<a name="l01199"></a>01199     *count = <a class="code" href="../../da/d6c/BLI__array_8h.html#a89314030de8e73b10e39372d4f1e367b">BLI_array_count</a>(edges);
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="keywordflow">return</span> edges;
<a name="l01202"></a>01202 }
<a name="l01203"></a>01203 
<a name="l01204"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#aea4c029859d1c8739ffeccb6f8d0ac60">01204</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#aea4c029859d1c8739ffeccb6f8d0ac60">knife_bgl_get_mats</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(kcd), <a class="code" href="../../d4/d07/structbglMats.html">bglMats</a> *mats)
<a name="l01205"></a>01205 {
<a name="l01206"></a>01206     <a class="code" href="../../d9/d71/BIF__glutil_8h.html#abd78cd326e87fcc38d503ead5890d9d4">bgl_get_mats</a>(mats);
<a name="l01207"></a>01207     <span class="comment">//copy_m4_m4(mats-&gt;modelview, kcd-&gt;vc.rv3d-&gt;viewmat);</span>
<a name="l01208"></a>01208     <span class="comment">//copy_m4_m4(mats-&gt;projection, kcd-&gt;vc.rv3d-&gt;winmat);</span>
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="comment">/* Finds visible (or all, if cutting through) edges that intersects the current screen drag line */</span>
<a name="l01212"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a08548d38a9dc17f91e1cd353dccf365a">01212</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a08548d38a9dc17f91e1cd353dccf365a">knife_find_line_hits</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <a class="code" href="../../d4/d07/structbglMats.html">bglMats</a> mats;
<a name="l01215"></a>01215     <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *e1, *e2;
<a name="l01216"></a>01216     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> <a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>, *ehash = &amp;<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a>;
<a name="l01217"></a>01217     <span class="keywordtype">float</span> v1[3], v2[3], v3[3], v4[4], s1[3], s2[3];
<a name="l01218"></a>01218     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, c1, c2;
<a name="l01219"></a>01219 
<a name="l01220"></a>01220     <a class="code" href="../../da/d56/editmesh__knife_8c.html#aea4c029859d1c8739ffeccb6f8d0ac60">knife_bgl_get_mats</a>(kcd, &amp;mats);
<a name="l01221"></a>01221 
<a name="l01222"></a>01222     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>) {
<a name="l01223"></a>01223         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>);
<a name="l01224"></a>01224         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01225"></a>01225         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> = 0;
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v1, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l01229"></a>01229     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(v2, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231     <span class="comment">/* project screen line&#39;s 3d coordinates back into 2d */</span>
<a name="l01232"></a>01232     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, v1, s1);
<a name="l01233"></a>01233     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, v2, s2);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(s1, s2) &lt; 1)
<a name="l01236"></a>01236         <span class="keywordflow">return</span>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="comment">/* unproject screen line */</span>
<a name="l01239"></a>01239     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#af9aebaced5bcc3391caf7d62b0b6d4b3">ED_view3d_win_to_segment_clip</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a>, s1, v1, v3);
<a name="l01240"></a>01240     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#af9aebaced5bcc3391caf7d62b0b6d4b3">ED_view3d_win_to_segment_clip</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a>, s2, v2, v4);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, v1);
<a name="l01243"></a>01243     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, v2);
<a name="l01244"></a>01244     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, v3);
<a name="l01245"></a>01245     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, v4);
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <span class="comment">/* numeric error, &#39;v1&#39; -&gt; &#39;v2&#39;, &#39;v2&#39; -&gt; &#39;v4&#39; can end up being ~2000 units apart in otho mode</span>
<a name="l01248"></a>01248 <span class="comment">     * (from ED_view3d_win_to_segment_clip() above)</span>
<a name="l01249"></a>01249 <span class="comment">     * this gives precision error in &#39;knife_edge_tri_isect&#39;, rather then solving properly</span>
<a name="l01250"></a>01250 <span class="comment">     * (which may involve using doubles everywhere!),</span>
<a name="l01251"></a>01251 <span class="comment">     * limit the distance between these points */</span>
<a name="l01252"></a>01252     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#af2bccd7313ce663b9c7bcffa309009ab">is_ortho</a>) {
<a name="l01253"></a>01253         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ac21a6d5b83b222828870133f4310f89d">limit_dist_v3</a>(v1, v3, 200.0f);
<a name="l01254"></a>01254         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ac21a6d5b83b222828870133f4310f89d">limit_dist_v3</a>(v2, v4, 200.0f);
<a name="l01255"></a>01255     }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(ehash);
<a name="l01258"></a>01258 
<a name="l01259"></a>01259     <span class="comment">/* test two triangles of sceen line&#39;s plane */</span>
<a name="l01260"></a>01260     e1 = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac17fb8886dda0e040c6aa53f7551c8d3">knife_edge_tri_isect</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a>, v1, v2, v3, ehash, &amp;mats, &amp;c1);
<a name="l01261"></a>01261     e2 = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac17fb8886dda0e040c6aa53f7551c8d3">knife_edge_tri_isect</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a>, v2, v3, v4, ehash, &amp;mats, &amp;c2);
<a name="l01262"></a>01262     <span class="keywordflow">if</span> (c1 &amp;&amp; c2) {
<a name="l01263"></a>01263         e1 = <a class="code" href="../../da/d2b/mallocn_8c.html#a3b4886c28277671329fa8e541eea0f3f">MEM_reallocN</a>(e1, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a>) * (c1 + c2));
<a name="l01264"></a>01264         memcpy(e1 + c1, e2, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a>) * c2);
<a name="l01265"></a>01265         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(e2);
<a name="l01266"></a>01266     }
<a name="l01267"></a>01267     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c2) {
<a name="l01268"></a>01268         e1 = e2;
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a> = e1;
<a name="l01272"></a>01272     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a> = c1 + c2;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="comment">/* find position along screen line, used for sorting */</span>
<a name="l01275"></a>01275     <span class="keywordflow">for</span> (i = 0; i &lt; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aeba1684d3aecd71d2bf4c0534c3942b4">totlinehit</a>; i++) {
<a name="l01276"></a>01276         <a class="code" href="../../d7/ddb/structBMEdgeHit.html">BMEdgeHit</a> *lh = e1 + <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01277"></a>01277 
<a name="l01278"></a>01278         lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#aa4f38be10d6ffbfb35a21b8967f8b644">l</a> = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(lh-&gt;<a class="code" href="../../d7/ddb/structBMEdgeHit.html#ae2acbda1316a8b77eb12239de4949344">schit</a>, s1) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(s2, s1);
<a name="l01279"></a>01279     }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(ehash);
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">01284</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">knife_input_ray_cast</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keyword">const</span> <span class="keywordtype">int</span> mval_i[2],
<a name="l01285"></a>01285                                  <span class="keywordtype">float</span> r_origin[3], <span class="keywordtype">float</span> r_ray[3])
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287     <a class="code" href="../../d4/d07/structbglMats.html">bglMats</a> mats;
<a name="l01288"></a>01288     <span class="keywordtype">float</span> mval[2], imat[3][3];
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <a class="code" href="../../da/d56/editmesh__knife_8c.html#aea4c029859d1c8739ffeccb6f8d0ac60">knife_bgl_get_mats</a>(kcd, &amp;mats);
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     mval[0] = (float)mval_i[0];
<a name="l01293"></a>01293     mval[1] = (float)mval_i[1];
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     <span class="comment">/* unproject to find view ray */</span>
<a name="l01296"></a>01296     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#add193f7544650c3b94f0619b8378d93a">view3d_unproject</a>(&amp;mats, r_origin, mval[0], mval[1], 0.0f);
<a name="l01297"></a>01297 
<a name="l01298"></a>01298     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#af2bccd7313ce663b9c7bcffa309009ab">is_ortho</a>) {
<a name="l01299"></a>01299         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a728bb3f38e925644683c9ace0cee4977">negate_v3_v3</a>(r_ray, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>[2]);
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301     <span class="keywordflow">else</span> {
<a name="l01302"></a>01302         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a55cc5423278e715951545237ac71fb8b">sub_v3_v3v3</a>(r_ray, r_origin, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#aef4739e48c5265fc0185283cd9f92303">viewinv</a>[3]);
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a3b49789e4776d019ff5756b73df2f3a1">normalize_v3</a>(r_ray);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306     <span class="comment">/* transform into object space */</span>
<a name="l01307"></a>01307     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01308"></a>01308     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a36f8fd23b3f7785d0396ea7a93683d09">copy_m3_m4</a>(imat, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l01309"></a>01309     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a7b59b79361e35db48ed010151ffa14f3">invert_m3</a>(imat);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, r_origin);
<a name="l01312"></a>01312     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a8ffa2d992371e11fad87ffbb55f034c8">mul_m3_v3</a>(imat, r_ray);
<a name="l01313"></a>01313 }
<a name="l01314"></a>01314 
<a name="l01315"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a695a95fb73748eb75f99795e70bd503d">01315</a> <span class="keyword">static</span> <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a695a95fb73748eb75f99795e70bd503d">knife_find_closest_face</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> cageco[3], <span class="keywordtype">int</span> *is_space)
<a name="l01316"></a>01316 {
<a name="l01317"></a>01317     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01318"></a>01318     <span class="keywordtype">int</span> dist = <a class="code" href="../../da/d56/editmesh__knife_8c.html#acedd74fd65317c2f1d8e5e614b8a61bd">KMAXDIST</a>;
<a name="l01319"></a>01319     <span class="keywordtype">float</span> origin[3];
<a name="l01320"></a>01320     <span class="keywordtype">float</span> ray[3];
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     <span class="comment">/* unproject to find view ray */</span>
<a name="l01323"></a>01323     <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">knife_input_ray_cast</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>, origin, ray);
<a name="l01324"></a>01324     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, origin, ray);
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     f = <a class="code" href="../../d4/d90/editmesh__bvh_8c.html#a7b262129df5e0b5c5491b5c09bdfc763">BMBVH_RayCast</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a>, origin, ray, co, cageco);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     <span class="keywordflow">if</span> (is_space)
<a name="l01329"></a>01329         *is_space = !f;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     <span class="keywordflow">if</span> (!f) {
<a name="l01332"></a>01332         <span class="comment">/* try to use backbuffer selection method if ray casting failed */</span>
<a name="l01333"></a>01333         f = <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a27d44fac477f0c6a1aa26e5caee3086f">EDBM_face_find_nearest</a>(&amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>, &amp;dist);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335         <span class="comment">/* cheat for now; just put in the origin instead</span>
<a name="l01336"></a>01336 <span class="comment">         * of a true coordinate on the face.</span>
<a name="l01337"></a>01337 <span class="comment">         * This just puts a point 1.0f infront of the view. */</span>
<a name="l01338"></a>01338         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, origin, ray);
<a name="l01339"></a>01339     }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">return</span> f;
<a name="l01342"></a>01342 }
<a name="l01343"></a>01343 
<a name="l01344"></a>01344 <span class="comment">/* find the 2d screen space density of vertices within a radius.  used to scale snapping</span>
<a name="l01345"></a>01345 <span class="comment"> * distance for picking edges/verts.*/</span>
<a name="l01346"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a35951402192d88dbf192e4361de16e31">01346</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a35951402192d88dbf192e4361de16e31">knife_sample_screen_density</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> radius)
<a name="l01347"></a>01347 {
<a name="l01348"></a>01348     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01349"></a>01349     <span class="keywordtype">int</span> is_space;
<a name="l01350"></a>01350     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], cageco[3], sco[3];
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     f = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a695a95fb73748eb75f99795e70bd503d">knife_find_closest_face</a>(kcd, co, cageco, &amp;is_space);
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (f &amp;&amp; !is_space) {
<a name="l01355"></a>01355         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst;
<a name="l01356"></a>01356         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01357"></a>01357         <span class="keywordtype">float</span> dis;
<a name="l01358"></a>01358         <span class="keywordtype">int</span> c = 0;
<a name="l01359"></a>01359 
<a name="l01360"></a>01360         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, cageco, sco);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362         lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, f);
<a name="l01363"></a>01363         <span class="keywordflow">for</span> (ref = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01364"></a>01364             <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01365"></a>01365             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01366"></a>01366 
<a name="l01367"></a>01367             <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l01368"></a>01368                 <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv = i ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01371"></a>01371 
<a name="l01372"></a>01372                 dis = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>, sco);
<a name="l01373"></a>01373                 <span class="keywordflow">if</span> (dis &lt; radius) {
<a name="l01374"></a>01374                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>) {
<a name="l01375"></a>01375                         <span class="keywordtype">float</span> vec[3];
<a name="l01376"></a>01376 
<a name="l01377"></a>01377                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01378"></a>01378                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#aa802aba424149fb5c03e34795a836810">obedit</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vec);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>, vec, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == 0) {
<a name="l01381"></a>01381                             c++;
<a name="l01382"></a>01382                         }
<a name="l01383"></a>01383                     }
<a name="l01384"></a>01384                     <span class="keywordflow">else</span> {
<a name="l01385"></a>01385                         c++;
<a name="l01386"></a>01386                     }
<a name="l01387"></a>01387                 }
<a name="l01388"></a>01388             }
<a name="l01389"></a>01389         }
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         <span class="keywordflow">return</span> c;
<a name="l01392"></a>01392     }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394     <span class="keywordflow">return</span> 0;
<a name="l01395"></a>01395 }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397 <span class="comment">/* returns snapping distance for edges/verts, scaled by the density of the</span>
<a name="l01398"></a>01398 <span class="comment"> * surrounding mesh (in screen space)*/</span>
<a name="l01399"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ac7b6eb48166d4c9b97a54086d6de8705">01399</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac7b6eb48166d4c9b97a54086d6de8705">knife_snap_size</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> maxsize)
<a name="l01400"></a>01400 {
<a name="l01401"></a>01401     <span class="keywordtype">float</span> density = (float)<a class="code" href="../../da/d56/editmesh__knife_8c.html#a35951402192d88dbf192e4361de16e31">knife_sample_screen_density</a>(kcd, maxsize * 2.0f);
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     density = <a class="code" href="../../d0/dbd/bmfont_8c.html#a57562d98bd289bc7ea77ba251915d8fb">MAX2</a>(density, 1);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(maxsize / (density * 0.5f), maxsize);
<a name="l01406"></a>01406 }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 <span class="comment">/* p is closest point on edge to the mouse cursor */</span>
<a name="l01409"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a9cf378989277714bdf5da378de3d2f84">01409</a> <span class="keyword">static</span> <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a9cf378989277714bdf5da378de3d2f84">knife_find_closest_edge</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keywordtype">float</span> cagep[3], <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **fptr, <span class="keywordtype">int</span> *is_space)
<a name="l01410"></a>01410 {
<a name="l01411"></a>01411     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01412"></a>01412     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], cageco[3], sco[3], maxdist = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac7b6eb48166d4c9b97a54086d6de8705">knife_snap_size</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab8c0ee33c70b2f6cd790d9e1cd1bff82">ethresh</a>);
<a name="l01413"></a>01413 
<a name="l01414"></a>01414     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a>)
<a name="l01415"></a>01415         maxdist *= 0.5;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     f = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a695a95fb73748eb75f99795e70bd503d">knife_find_closest_face</a>(kcd, co, cageco, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01418"></a>01418     *is_space = !f;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     <span class="comment">/* set p to co, in case we don&#39;t find anything, means a face cut */</span>
<a name="l01421"></a>01421     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, co);
<a name="l01422"></a>01422     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cagep, cageco);
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = f;
<a name="l01425"></a>01425 
<a name="l01426"></a>01426     <span class="keywordflow">if</span> (f) {
<a name="l01427"></a>01427         <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *cure = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01428"></a>01428         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst;
<a name="l01429"></a>01429         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01430"></a>01430         <span class="keywordtype">float</span> dis, curdis = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, cageco, sco);
<a name="l01433"></a>01433 
<a name="l01434"></a>01434         <span class="comment">/* look through all edges associated with this face */</span>
<a name="l01435"></a>01435         lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, f);
<a name="l01436"></a>01436         <span class="keywordflow">for</span> (ref = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01437"></a>01437             <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01438"></a>01438 
<a name="l01439"></a>01439             <span class="comment">/* project edge vertices into screen space */</span>
<a name="l01440"></a>01440             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01441"></a>01441             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01442"></a>01442 
<a name="l01443"></a>01443             dis = <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#acb707a79a8f4aaebf941caec9f14725a">dist_to_line_segment_v2</a>(sco, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01444"></a>01444             <span class="keywordflow">if</span> (dis &lt; curdis &amp;&amp; dis &lt; maxdist) {
<a name="l01445"></a>01445                 <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>) {
<a name="l01446"></a>01446                     <span class="keywordtype">float</span> labda = <a class="code" href="../../d7/dc0/editmesh__select_8c.html#a95f95ff9f0f4da3401184b91d295c843">labda_PdistVL2Dfl</a>(sco, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01447"></a>01447                     <span class="keywordtype">float</span> vec[3];
<a name="l01448"></a>01448 
<a name="l01449"></a>01449                     vec[0] = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[0] + labda * (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[0] - kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[0]);
<a name="l01450"></a>01450                     vec[1] = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[1] + labda * (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[1] - kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[1]);
<a name="l01451"></a>01451                     vec[2] = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[2] + labda * (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[2] - kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>[2]);
<a name="l01452"></a>01452                     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#aa802aba424149fb5c03e34795a836810">obedit</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vec);
<a name="l01453"></a>01453 
<a name="l01454"></a>01454                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>, vec, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == 0) {
<a name="l01455"></a>01455                         cure = kfe;
<a name="l01456"></a>01456                         curdis = dis;
<a name="l01457"></a>01457                     }
<a name="l01458"></a>01458                 }
<a name="l01459"></a>01459                 <span class="keywordflow">else</span> {
<a name="l01460"></a>01460                     cure = kfe;
<a name="l01461"></a>01461                     curdis = dis;
<a name="l01462"></a>01462                 }
<a name="l01463"></a>01463             }
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465 
<a name="l01466"></a>01466         <span class="keywordflow">if</span> (fptr)
<a name="l01467"></a>01467             *fptr = f;
<a name="l01468"></a>01468 
<a name="l01469"></a>01469         <span class="keywordflow">if</span> (cure &amp;&amp; p) {
<a name="l01470"></a>01470             <span class="keywordflow">if</span> (!kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac3d324d6aa52e21b1456af76da178883">ignore_edge_snapping</a> || !(cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>)) {
<a name="l01471"></a>01471                 <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a>) {
<a name="l01472"></a>01472                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(p, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l01473"></a>01473                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(cagep, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01474"></a>01474                 }
<a name="l01475"></a>01475                 <span class="keywordflow">else</span> {
<a name="l01476"></a>01476                     <span class="keywordtype">float</span> d;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478                     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a012a9f657ae9ed58182d9cbfd00fa71e">closest_to_line_segment_v3</a>(cagep, cageco, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01479"></a>01479                     d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(cagep, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>) / <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01480"></a>01480                     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a1527309f09525ae91ed04692da13ba98">interp_v3_v3v3</a>(p, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, cure-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, d);
<a name="l01481"></a>01481                 }
<a name="l01482"></a>01482             }
<a name="l01483"></a>01483             <span class="keywordflow">else</span> {
<a name="l01484"></a>01484                 <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01485"></a>01485             }
<a name="l01486"></a>01486         }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488         <span class="keywordflow">return</span> cure;
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <span class="keywordflow">if</span> (fptr)
<a name="l01492"></a>01492         *fptr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01493"></a>01493 
<a name="l01494"></a>01494     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01495"></a>01495 }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497 <span class="comment">/* find a vertex near the mouse cursor, if it exists */</span>
<a name="l01498"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ac38936d37395453a8c07cba82919eefb">01498</a> <span class="keyword">static</span> <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#ac38936d37395453a8c07cba82919eefb">knife_find_closest_vert</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">float</span> <a class="code" href="../../dd/d05/noise_8c.html#aa5b68af6f39f968261f8942af260e938">p</a>[3], <span class="keywordtype">float</span> cagep[3], <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **fptr,
<a name="l01499"></a>01499                                           <span class="keywordtype">int</span> *is_space)
<a name="l01500"></a>01500 {
<a name="l01501"></a>01501     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01502"></a>01502     <span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], cageco[3], sco[3], maxdist = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac7b6eb48166d4c9b97a54086d6de8705">knife_snap_size</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">vthresh</a>);
<a name="l01503"></a>01503 
<a name="l01504"></a>01504     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a>)
<a name="l01505"></a>01505         maxdist *= 0.5;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     f = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a695a95fb73748eb75f99795e70bd503d">knife_find_closest_face</a>(kcd, co, cageco, is_space);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <span class="comment">/* set p to co, in case we don&#39;t find anything, means a face cut */</span>
<a name="l01510"></a>01510     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, co);
<a name="l01511"></a>01511     <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cagep, p);
<a name="l01512"></a>01512     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a> = f;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (f) {
<a name="l01515"></a>01515         <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst;
<a name="l01516"></a>01516         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01517"></a>01517         <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *curv = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01518"></a>01518         <span class="keywordtype">float</span> dis, curdis = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, cageco, sco);
<a name="l01521"></a>01521 
<a name="l01522"></a>01522         lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a22f9d3386dd49bbeca3d14c23cb5e72c">knife_get_face_kedges</a>(kcd, f);
<a name="l01523"></a>01523         <span class="keywordflow">for</span> (ref = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01524"></a>01524             <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01525"></a>01525             <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01526"></a>01526 
<a name="l01527"></a>01527             <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l01528"></a>01528                 <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv = i ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a1601d4ecced5c76764bf5655d7e85151">knife_project_v3</a>(kcd, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>);
<a name="l01531"></a>01531 
<a name="l01532"></a>01532                 dis = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ad64ff54d1edbd568345377c3d4660b78">len_v2v2</a>(kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a15e1e8c1b3beb5ae5c5d040a3a20a7e0">sco</a>, sco);
<a name="l01533"></a>01533                 <span class="keywordflow">if</span> (dis &lt; curdis &amp;&amp; dis &lt; maxdist) {
<a name="l01534"></a>01534                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>-&gt;<a class="code" href="../../d9/d00/structRegionView3D.html#a077da32c8352d8b7abb4b19919a14cf8">rflag</a> &amp; <a class="code" href="../../d4/d06/DNA__view3d__types_8h.html#a5abc2fd47b1dba7a3d7836a57f6af9a9">RV3D_CLIPPING</a>) {
<a name="l01535"></a>01535                         <span class="keywordtype">float</span> vec[3];
<a name="l01536"></a>01536 
<a name="l01537"></a>01537                         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(vec, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01538"></a>01538                         <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#a2fc1e6236f291e8cf3b62c8e0541eb00">mul_m4_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#aa802aba424149fb5c03e34795a836810">obedit</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>, vec);
<a name="l01539"></a>01539 
<a name="l01540"></a>01540                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6a/ED__view3d_8h.html#ac0ad69a1a1be9d1bc56fc2ba323c6fe4">ED_view3d_clipping_test</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>, vec, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) == 0) {
<a name="l01541"></a>01541                             curv = kfv;
<a name="l01542"></a>01542                             curdis = dis;
<a name="l01543"></a>01543                         }
<a name="l01544"></a>01544                     }
<a name="l01545"></a>01545                     <span class="keywordflow">else</span> {
<a name="l01546"></a>01546                         curv = kfv;
<a name="l01547"></a>01547                         curdis = dis;
<a name="l01548"></a>01548                     }
<a name="l01549"></a>01549                 }
<a name="l01550"></a>01550             }
<a name="l01551"></a>01551         }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         <span class="keywordflow">if</span> (!kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a> || !(curv &amp;&amp; curv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>)) {
<a name="l01554"></a>01554             <span class="keywordflow">if</span> (fptr)
<a name="l01555"></a>01555                 *fptr = f;
<a name="l01556"></a>01556 
<a name="l01557"></a>01557             <span class="keywordflow">if</span> (curv &amp;&amp; p) {
<a name="l01558"></a>01558                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(p, curv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l01559"></a>01559                 <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cagep, curv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a283fba0376181cd000dad0bb5f46ec59">cageco</a>);
<a name="l01560"></a>01560             }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562             <span class="keywordflow">return</span> curv;
<a name="l01563"></a>01563         }
<a name="l01564"></a>01564         <span class="keywordflow">else</span> {
<a name="l01565"></a>01565             <span class="keywordflow">if</span> (fptr)
<a name="l01566"></a>01566                 *fptr = f;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568             <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01569"></a>01569         }
<a name="l01570"></a>01570     }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572     <span class="keywordflow">if</span> (fptr)
<a name="l01573"></a>01573         *fptr = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01574"></a>01574 
<a name="l01575"></a>01575     <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01576"></a>01576 }
<a name="l01577"></a>01577 
<a name="l01578"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ae95cace9e38699d898b3d954c881224a">01578</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae95cace9e38699d898b3d954c881224a">knife_snap_angle</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l01579"></a>01579 {
<a name="l01580"></a>01580     <span class="keywordtype">int</span> dx, dy;
<a name="l01581"></a>01581     <span class="keywordtype">float</span> w, abs_tan;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583     dx = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[0] - kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[0];
<a name="l01584"></a>01584     dy = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1] - kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1];
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (dx == 0 || dy == 0)
<a name="l01586"></a>01586         <span class="keywordflow">return</span>;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     w = (float)dy / (<span class="keywordtype">float</span>)dx;
<a name="l01589"></a>01589     abs_tan = <a class="code" href="../../dd/d06/BLI__math__base_8h.html#aa825035ff543e2be9c11ad8acf18d480">fabsf</a>(w);
<a name="l01590"></a>01590     <span class="keywordflow">if</span> (abs_tan &lt;= 0.4142f) { <span class="comment">/* tan(22.5 degrees) = 0.4142 */</span>
<a name="l01591"></a>01591         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> = ANGLE_0;
<a name="l01592"></a>01592         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1];
<a name="l01593"></a>01593     }
<a name="l01594"></a>01594     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (abs_tan &lt; 2.4142f) { <span class="comment">/* tan(67.5 degrees) = 2.4142 */</span>
<a name="l01595"></a>01595         <span class="keywordflow">if</span> (w &gt; 0) {
<a name="l01596"></a>01596             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> = ANGLE_45;
<a name="l01597"></a>01597             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1] + dx;
<a name="l01598"></a>01598         }
<a name="l01599"></a>01599         <span class="keywordflow">else</span> {
<a name="l01600"></a>01600             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> = ANGLE_135;
<a name="l01601"></a>01601             kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1] - dx;
<a name="l01602"></a>01602         }
<a name="l01603"></a>01603     }
<a name="l01604"></a>01604     <span class="keywordflow">else</span> {
<a name="l01605"></a>01605         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> = ANGLE_90;
<a name="l01606"></a>01606         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[0] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[0];
<a name="l01607"></a>01607     }
<a name="l01608"></a>01608 }
<a name="l01609"></a>01609 
<a name="l01610"></a>01610 <span class="comment">/* update active knife edge/vert pointers */</span>
<a name="l01611"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#abf1fa25540992f57354721c19524c63f">01611</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf1fa25540992f57354721c19524c63f">knife_update_active</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l01612"></a>01612 {
<a name="l01613"></a>01613     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> != ANGLE_FREE &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> == MODE_DRAGGING)
<a name="l01614"></a>01614         <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae95cace9e38699d898b3d954c881224a">knife_snap_angle</a>(kcd);
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a95dafbb5e2844f0b86fbc8e39ba8fcc7">knife_pos_data_clear</a>(&amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>);
<a name="l01617"></a>01617     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[0] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[0];
<a name="l01618"></a>01618     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affeae4a6baad46175078404b242d6d00">mval</a>[1] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1];
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ac38936d37395453a8c07cba82919eefb">knife_find_closest_vert</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>);
<a name="l01621"></a>01621     <span class="keywordflow">if</span> (!kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a>) {
<a name="l01622"></a>01622         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a9cf378989277714bdf5da378de3d2f84">knife_find_closest_edge</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#affae2271c4eb4365f51e608ec6bfcc76">co</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#aebfa11c4855395df1feb5afa45b45e4f">bmface</a>, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af7b38b7a820a8dfd0827966214fe3136">is_space</a>);
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="comment">/* if no hits are found this would normally default to (0, 0, 0) so instead</span>
<a name="l01626"></a>01626 <span class="comment">     * get a point at the mouse ray closest to the previous point.</span>
<a name="l01627"></a>01627 <span class="comment">     * Note that drawing lines in `free-space` isn&#39;t properly supported</span>
<a name="l01628"></a>01628 <span class="comment">     * but theres no guarantee (0, 0, 0) has any geometry either - campbell */</span>
<a name="l01629"></a>01629     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#ada514cb47418e8dff7efde34b3f09eec">vert</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#af632823d08242ca27f564efaade770f2">edge</a> == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01630"></a>01630         <span class="keywordtype">float</span> origin[3], ray[3], <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3];
<a name="l01631"></a>01631 
<a name="l01632"></a>01632         <a class="code" href="../../da/d56/editmesh__knife_8c.html#ae6e6c78de7d9424facd3872670b472aa">knife_input_ray_cast</a>(kcd, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>, origin, ray);
<a name="l01633"></a>01633         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a870d4342840636e86ed7966cd883cebc">add_v3_v3v3</a>(co, origin, ray);
<a name="l01634"></a>01634 
<a name="l01635"></a>01635         <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a136fb51b387cde4f6f7eb4acd56e365d">closest_to_line_v3</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>.<a class="code" href="../../d9/d8d/structKnifePosData.html#a88e721b4add0b5f6766a3edf3ab0ccc9">cage</a>, co, origin);
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> == MODE_DRAGGING) {
<a name="l01639"></a>01639         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a08548d38a9dc17f91e1cd353dccf365a">knife_find_line_hits</a>(kcd);
<a name="l01640"></a>01640     }
<a name="l01641"></a>01641     <span class="keywordflow">return</span> 1;
<a name="l01642"></a>01642 }
<a name="l01643"></a>01643 
<a name="l01644"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#abeb214368f7f34cff98de9047aa6eb2f">01644</a> <span class="preprocessor">#define MARK            4</span>
<a name="l01645"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">01645</a> <span class="preprocessor"></span><span class="preprocessor">#define DEL             8</span>
<a name="l01646"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a2cd2798639b8c7e90b559d73d76a4cbc">01646</a> <span class="preprocessor"></span><span class="preprocessor">#define VERT_ON_EDGE    16</span>
<a name="l01647"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a0bbf4602d3c2490b8ff6c0a302f69072">01647</a> <span class="preprocessor"></span><span class="preprocessor">#define VERT_ORIG       32</span>
<a name="l01648"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ae181fd9c6b3af6d94255faa6d98ac43b">01648</a> <span class="preprocessor"></span><span class="preprocessor">#define FACE_FLIP       64</span>
<a name="l01649"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">01649</a> <span class="preprocessor"></span><span class="preprocessor">#define BOUNDARY        128</span>
<a name="l01650"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">01650</a> <span class="preprocessor"></span><span class="preprocessor">#define FACE_NEW        256</span>
<a name="l01651"></a>01651 <span class="preprocessor"></span>
<a name="l01652"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a74a63ebaca17df462eb11c10d07dcde8">01652</a> <span class="preprocessor">#define SCANFILL_CUTS 0</span>
<a name="l01653"></a>01653 <span class="preprocessor"></span><span class="preprocessor">#if SCANFILL_CUTS</span>
<a name="l01654"></a>01654 <span class="preprocessor"></span>
<a name="l01655"></a>01655 <span class="keyword">typedef</span> <span class="keyword">struct </span>facenet_entry {
<a name="l01656"></a>01656     <span class="keyword">struct </span>facenet_entry *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, *prev;
<a name="l01657"></a>01657     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l01658"></a>01658 } facenet_entry;
<a name="l01659"></a>01659 
<a name="l01660"></a>01660 <span class="keyword">static</span> <span class="keywordtype">void</span> rnd_offset_co(<span class="keywordtype">float</span> <a class="code" href="../../d4/dd4/drawarmature_8c.html#a7cadd25320d9bbcc4f8d41f1b6d0978b">co</a>[3], <span class="keywordtype">float</span> scale)
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l01663"></a>01663 
<a name="l01664"></a>01664     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l01665"></a>01665         co[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] += (<a class="code" href="../../d3/d88/BLI__rand_8h.html#a28a49a5f3f27a0875de8142fdcab7bd2">BLI_frand</a>() - 0.5) * scale;
<a name="l01666"></a>01666     }
<a name="l01667"></a>01667 }
<a name="l01668"></a>01668 
<a name="l01669"></a>01669 <span class="keyword">static</span> <span class="keywordtype">void</span> remerge_faces(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l01670"></a>01670 {
<a name="l01671"></a>01671     <a class="code" href="../../d7/d18/structBMesh.html">BMesh</a> *bm = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>;
<a name="l01672"></a>01672     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> svisit, *visit = &amp;svisit;
<a name="l01673"></a>01673     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l01674"></a>01674     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01675"></a>01675     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **<a class="code" href="../../d3/d1a/smemory_8c.html#ab8d3e2ffc5cefd244b83373a93cc692b">stack</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01676"></a>01676     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae22059e2259b0ea217cfe400e698d21e">BLI_array_declare</a>(stack);
<a name="l01677"></a>01677     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **faces = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01678"></a>01678     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae22059e2259b0ea217cfe400e698d21e">BLI_array_declare</a>(faces);
<a name="l01679"></a>01679     <a class="code" href="../../d0/d92/structBMOperator.html">BMOperator</a> bmop;
<a name="l01680"></a>01680     <span class="keywordtype">int</span> idx;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ad937005656381b377e84cf7a3f10073f">BMO_op_initf</a>(bm, &amp;bmop, <span class="stringliteral">&quot;beautify_fill faces=%ff constrain_edges=%fe&quot;</span>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a72fc55143180f21895f7ce90da0e8ca2" title="BMESH OPSTACK EXEC OP.">BMO_op_exec</a>(bm, &amp;bmop);
<a name="l01685"></a>01685     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a5f62bc113fc0f7d8467305aeb5560dbf" title="BMO_FLAG_BUFFER.">BMO_slot_buffer_flag_enable</a>(bm, &amp;bmop, <span class="stringliteral">&quot;geomout&quot;</span>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a77867ab4129f63159b37bca3b652a798a279a53b6bc9b4dd104fa2607f8439075">BM_FACE</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>);
<a name="l01686"></a>01686 
<a name="l01687"></a>01687     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ab6f764453b1419d3dfca2aec5943a381" title="BMESH OPSTACK FINISH OP.">BMO_op_finish</a>(bm, &amp;bmop);
<a name="l01688"></a>01688 
<a name="l01689"></a>01689     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(visit);
<a name="l01690"></a>01690     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (f, &amp;iter, bm, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fabe0fe60283f43cd8ce697d52d24a3c1e">BM_FACES_OF_MESH</a>) {
<a name="l01691"></a>01691         <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> eiter;
<a name="l01692"></a>01692         <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *e;
<a name="l01693"></a>01693         <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f2;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ae95647462dd30213d7930e1a0a54ef81">BMO_elem_flag_test</a>(bm, f, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>))
<a name="l01696"></a>01696             <span class="keywordflow">continue</span>;
<a name="l01697"></a>01697 
<a name="l01698"></a>01698         <span class="keywordflow">if</span> (<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(visit, (intptr_t)f))
<a name="l01699"></a>01699             <span class="keywordflow">continue</span>;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         <a class="code" href="../../da/d6c/BLI__array_8h.html#ad92d45d552a54bf2f7e4db4aba15ea8a">BLI_array_empty</a>(stack);
<a name="l01702"></a>01702         <a class="code" href="../../da/d6c/BLI__array_8h.html#ad92d45d552a54bf2f7e4db4aba15ea8a">BLI_array_empty</a>(faces);
<a name="l01703"></a>01703         <a class="code" href="../../da/d6c/BLI__array_8h.html#a24d25d219077cae8e9c4a66ef3983c54">BLI_array_append</a>(stack, f);
<a name="l01704"></a>01704         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visit, (intptr_t)f, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01705"></a>01705 
<a name="l01706"></a>01706         <span class="keywordflow">do</span> {
<a name="l01707"></a>01707             f2 = <a class="code" href="../../da/d6c/BLI__array_8h.html#aa66bab7904466516907970c137e899d7">BLI_array_pop</a>(stack);
<a name="l01708"></a>01708 
<a name="l01709"></a>01709             <a class="code" href="../../da/d6c/BLI__array_8h.html#a24d25d219077cae8e9c4a66ef3983c54">BLI_array_append</a>(faces, f2);
<a name="l01710"></a>01710 
<a name="l01711"></a>01711             <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (e, &amp;eiter, f2, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1faea7083697f3214428274bffcf37e49a7">BM_EDGES_OF_FACE</a>) {
<a name="l01712"></a>01712                 <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> fiter;
<a name="l01713"></a>01713                 <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f3;
<a name="l01714"></a>01714 
<a name="l01715"></a>01715                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ae95647462dd30213d7930e1a0a54ef81">BMO_elem_flag_test</a>(bm, e, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>))
<a name="l01716"></a>01716                     <span class="keywordflow">continue</span>;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718                 <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (f3, &amp;fiter, e, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa3027c8bb018a25ce0260593cb6d02ef3">BM_FACES_OF_EDGE</a>) {
<a name="l01719"></a>01719                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ae95647462dd30213d7930e1a0a54ef81">BMO_elem_flag_test</a>(bm, f3, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>))
<a name="l01720"></a>01720                         <span class="keywordflow">continue</span>;
<a name="l01721"></a>01721                     <span class="keywordflow">if</span> (<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(visit, (intptr_t)f3))
<a name="l01722"></a>01722                         <span class="keywordflow">continue</span>;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724                     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visit, (intptr_t)f3, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01725"></a>01725                     <a class="code" href="../../da/d6c/BLI__array_8h.html#a24d25d219077cae8e9c4a66ef3983c54">BLI_array_append</a>(stack, f3);
<a name="l01726"></a>01726                 }
<a name="l01727"></a>01727             }
<a name="l01728"></a>01728         } <span class="keywordflow">while</span> (<a class="code" href="../../da/d6c/BLI__array_8h.html#a89314030de8e73b10e39372d4f1e367b">BLI_array_count</a>(stack) &gt; 0);
<a name="l01729"></a>01729 
<a name="l01730"></a>01730         <span class="keywordflow">if</span> (<a class="code" href="../../da/d6c/BLI__array_8h.html#a89314030de8e73b10e39372d4f1e367b">BLI_array_count</a>(faces) &gt; 0) {
<a name="l01731"></a>01731             idx = <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(faces[0]);
<a name="l01732"></a>01732 
<a name="l01733"></a>01733             f2 = <a class="code" href="../../d0/de5/bmesh__core_8c.html#af123491824267a95e220d4d19c9daf04" title="Join Connected Faces.">BM_faces_join</a>(bm, faces, <a class="code" href="../../da/d6c/BLI__array_8h.html#a89314030de8e73b10e39372d4f1e367b">BLI_array_count</a>(faces), <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01734"></a>01734             <span class="keywordflow">if</span> (f2) {
<a name="l01735"></a>01735                 <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, f2, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>);
<a name="l01736"></a>01736                 <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a91b19fa9be8c69ea8efdccbf1b6938c5">BM_elem_index_set</a>(f2, idx); <span class="comment">/* set_dirty! */</span><span class="comment">/* BMESH_TODO, check if this is valid or not */</span>
<a name="l01737"></a>01737             }
<a name="l01738"></a>01738         }
<a name="l01739"></a>01739     }
<a name="l01740"></a>01740     <span class="comment">/* BMESH_TODO, check if the code above validates the indices */</span>
<a name="l01741"></a>01741     <span class="comment">/* bm-&gt;elem_index_dirty &amp;= ~BM_FACE; */</span>
<a name="l01742"></a>01742     bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a38cdf1570b76d77dcf6d4bbdbe33f753">elem_index_dirty</a> |= <a class="code" href="../../d1/d77/bmesh__class_8h.html#a77867ab4129f63159b37bca3b652a798a279a53b6bc9b4dd104fa2607f8439075">BM_FACE</a>;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(visit);
<a name="l01745"></a>01745 
<a name="l01746"></a>01746     <a class="code" href="../../da/d6c/BLI__array_8h.html#af7fa9a27c7dee77862238c7da8472b81">BLI_array_free</a>(stack);
<a name="l01747"></a>01747     <a class="code" href="../../da/d6c/BLI__array_8h.html#af7fa9a27c7dee77862238c7da8472b81">BLI_array_free</a>(faces);
<a name="l01748"></a>01748 }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750 <span class="comment">/* use edgenet to fill faces.  this is a bit annoying and convoluted.*/</span>
<a name="l01751"></a>01751 <span class="keyword">static</span> <span class="keywordtype">void</span> knifenet_fill_faces(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l01752"></a>01752 {
<a name="l01753"></a>01753     <a class="code" href="../../d7/d8b/structScanFillContext.html">ScanFillContext</a> sf_ctx;
<a name="l01754"></a>01754     <a class="code" href="../../d7/d18/structBMesh.html">BMesh</a> *bm = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>;
<a name="l01755"></a>01755     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> bmiter;
<a name="l01756"></a>01756     <a class="code" href="../../db/d0e/structBLI__mempool__iter.html">BLI_mempool_iter</a> iter;
<a name="l01757"></a>01757     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l01758"></a>01758     <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *e;
<a name="l01759"></a>01759     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv;
<a name="l01760"></a>01760     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l01761"></a>01761     facenet_entry *entry;
<a name="l01762"></a>01762     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *face_nets = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a>) * bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#ae4e0288302780574590bab5f8ff43fa4">totface</a>, <span class="stringliteral">&quot;face_nets&quot;</span>);
<a name="l01763"></a>01763     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **faces = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *) * bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#ae4e0288302780574590bab5f8ff43fa4">totface</a>, <span class="stringliteral">&quot;faces knife&quot;</span>);
<a name="l01764"></a>01764     <a class="code" href="../../dc/de5/structMemArena.html">MemArena</a> *arena = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(1 &lt;&lt; 16, <span class="stringliteral">&quot;knifenet_fill_faces&quot;</span>);
<a name="l01765"></a>01765     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> shash;
<a name="l01766"></a>01766     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k = 0, totface = bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#ae4e0288302780574590bab5f8ff43fa4">totface</a>;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a85c33b6c65734f514ba77758ee7257d2">BMO_push</a>(bm, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01769"></a>01769     <a class="code" href="../../d5/db9/bmesh__mesh_8c.html#a68746e93c455f1bab695793467cdbf84" title="BMesh Begin Edit.">bmesh_edit_begin</a>(bm, <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac038a1e8b1ad739c47df10a3bc02d465">BMO_OP_FLAG_UNTAN_MULTIRES</a>);
<a name="l01770"></a>01770 
<a name="l01771"></a>01771     <span class="comment">/* BMESH_TODO this should be valid now, leaving here until we can ensure this - campbell */</span>
<a name="l01772"></a>01772     i = 0;
<a name="l01773"></a>01773     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (f, &amp;bmiter, bm, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fabe0fe60283f43cd8ce697d52d24a3c1e">BM_FACES_OF_MESH</a>) {
<a name="l01774"></a>01774         <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a91b19fa9be8c69ea8efdccbf1b6938c5">BM_elem_index_set</a>(f, i); <span class="comment">/* set_inline */</span>
<a name="l01775"></a>01775         faces[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = f;
<a name="l01776"></a>01776         i++;
<a name="l01777"></a>01777     }
<a name="l01778"></a>01778     bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a38cdf1570b76d77dcf6d4bbdbe33f753">elem_index_dirty</a> &amp;= ~<a class="code" href="../../d1/d77/bmesh__class_8h.html#a77867ab4129f63159b37bca3b652a798a279a53b6bc9b4dd104fa2607f8439075">BM_FACE</a>;
<a name="l01779"></a>01779 
<a name="l01780"></a>01780     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (e, &amp;bmiter, bm, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa38e0ad1c62821fba188c45ddd39d6723">BM_EDGES_OF_MESH</a>) {
<a name="l01781"></a>01781         <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, e, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l01782"></a>01782     }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784     <span class="comment">/* turn knife verts into real verts, as necessary */</span>
<a name="l01785"></a>01785     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>, &amp;iter);
<a name="l01786"></a>01786     <span class="keywordflow">for</span> (kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfv; kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l01787"></a>01787         <span class="keywordflow">if</span> (!kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>) {
<a name="l01788"></a>01788             <span class="comment">/* shouldn&#39;t we be at least copying the normal? - if not some comment here should explain why - campbell */</span>
<a name="l01789"></a>01789             kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> = <a class="code" href="../../d0/de5/bmesh__core_8c.html#a65d5fc195621d50fd17a65b941149f40" title="Main function for creating a new vertex.">BM_vert_create</a>(bm, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01790"></a>01790             kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae9beb529fd0ec4a20645901227a9212c">flag</a> = 1;
<a name="l01791"></a>01791             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01792"></a>01792         }
<a name="l01793"></a>01793         <span class="keywordflow">else</span> {
<a name="l01794"></a>01794             kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#ae9beb529fd0ec4a20645901227a9212c">flag</a> = 0;
<a name="l01795"></a>01795             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a0bbf4602d3c2490b8ff6c0a302f69072">VERT_ORIG</a>);
<a name="l01796"></a>01796         }
<a name="l01797"></a>01797 
<a name="l01798"></a>01798         <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#abeb214368f7f34cff98de9047aa6eb2f">MARK</a>);
<a name="l01799"></a>01799     }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <span class="comment">/* we want to only do changed faces.  first, go over new edges and add to</span>
<a name="l01802"></a>01802 <span class="comment">     * face net lists.*/</span>
<a name="l01803"></a>01803     i = j = k = 0;
<a name="l01804"></a>01804     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>, &amp;iter);
<a name="l01805"></a>01805     <span class="keywordflow">for</span> (kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfe; kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l01806"></a>01806         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01807"></a>01807         <span class="keywordflow">if</span> (!kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> || !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a>)
<a name="l01808"></a>01808             <span class="keywordflow">continue</span>;
<a name="l01809"></a>01809 
<a name="l01810"></a>01810         i++;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a> &amp;&amp; kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab6378c5ea7e85917c389a1dfdff790ea">v1</a> &amp;&amp; kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#a00090f09abd0ef12bcf279cb0c41c0ca">v2</a>) {
<a name="l01813"></a>01813             kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>;
<a name="l01814"></a>01814             <span class="keywordflow">continue</span>;
<a name="l01815"></a>01815         }
<a name="l01816"></a>01816 
<a name="l01817"></a>01817         j++;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>) {
<a name="l01820"></a>01820             kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>;
<a name="l01821"></a>01821 
<a name="l01822"></a>01822             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01823"></a>01823             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a045007133673a18b6e8f120f533a129e">BMO_elem_flag_disable</a>(bm, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l01824"></a>01824             kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a> = <a class="code" href="../../d0/de5/bmesh__core_8c.html#a75ba3d28215494c6a507aa0d575c454e" title="Main function for creating a new edge.">BM_edge_create</a>(bm, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01828"></a>01828         <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830         <span class="keywordflow">for</span> (ref = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01831"></a>01831             f = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01832"></a>01832 
<a name="l01833"></a>01833             entry = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, <span class="keyword">sizeof</span>(*entry));
<a name="l01834"></a>01834             entry-&gt;kfe = kfe;
<a name="l01835"></a>01835             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(face_nets + <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f), entry);
<a name="l01836"></a>01836         }
<a name="l01837"></a>01837     }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     <span class="comment">/* go over original edges, and add to faces with new geometry */</span>
<a name="l01840"></a>01840     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>, &amp;iter);
<a name="l01841"></a>01841     <span class="keywordflow">for</span> (kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfe; kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l01842"></a>01842         <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844         <span class="keywordflow">if</span> (!kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> || !kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a2d5d589e274a7c0463fc9d04b022da68">inspace</a>)
<a name="l01845"></a>01845             <span class="keywordflow">continue</span>;
<a name="l01846"></a>01846         <span class="keywordflow">if</span> (!(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a> &amp;&amp; kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a>-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab6378c5ea7e85917c389a1dfdff790ea">v1</a> &amp;&amp; kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a>-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#a00090f09abd0ef12bcf279cb0c41c0ca">v2</a>))
<a name="l01847"></a>01847             <span class="keywordflow">continue</span>;
<a name="l01848"></a>01848 
<a name="l01849"></a>01849         k++;
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a985bae7b67bcb96c5565a24a5f6d4cba">BOUNDARY</a>);
<a name="l01852"></a>01852         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a4890a815428abb42cbd2346d051ae959">oe</a> = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>;
<a name="l01853"></a>01853 
<a name="l01854"></a>01854         <span class="keywordflow">for</span> (ref = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#acfa879c4622100869d80e1a8854b98b3">faces</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l01855"></a>01855             f = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l01856"></a>01856 
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (face_nets[<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f)].first) {
<a name="l01858"></a>01858                 entry = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(arena, <span class="keyword">sizeof</span>(*entry));
<a name="l01859"></a>01859                 entry-&gt;kfe = kfe;
<a name="l01860"></a>01860                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a28b9955d900264adc216d246f4057f05">BLI_addtail</a>(face_nets + <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f), entry);
<a name="l01861"></a>01861             }
<a name="l01862"></a>01862         }
<a name="l01863"></a>01863     }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <a class="code" href="../../d3/d88/BLI__rand_8h.html#a60a4a9e4b37c435f7f7a122c001f7e74">BLI_srand</a>(0);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867     <span class="keywordflow">for</span> (i = 0; i &lt; totface; i++) {
<a name="l01868"></a>01868         <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> *<a class="code" href="../../dd/d05/noise_8c.html#a3525fa37a20c01dcef02177785596cd9">hash</a> = &amp;shash;
<a name="l01869"></a>01869         <a class="code" href="../../dd/de1/structScanFillFace.html">ScanFillFace</a> *efa;
<a name="l01870"></a>01870         <a class="code" href="../../df/d03/structScanFillVert.html">ScanFillVert</a> *eve, *lasteve;
<a name="l01871"></a>01871         <span class="keywordtype">int</span> j;
<a name="l01872"></a>01872         <span class="keywordtype">float</span> rndscale = FLT_EPSILON * 25;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874         f = faces[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>];
<a name="l01875"></a>01875         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(hash);
<a name="l01876"></a>01876 
<a name="l01877"></a>01877         <span class="keywordflow">if</span> (face_nets[i].first)
<a name="l01878"></a>01878             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, f, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01879"></a>01879 
<a name="l01880"></a>01880         <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#a64c925152a9e7e42969364bb1a46c521">BLI_begin_edgefill</a>(&amp;sf_ctx);
<a name="l01881"></a>01881 
<a name="l01882"></a>01882         <span class="keywordflow">for</span> (entry = face_nets[i].first; entry; entry = entry-&gt;next) {
<a name="l01883"></a>01883             <span class="keywordflow">if</span> (!<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v1)) {
<a name="l01884"></a>01884                 eve = <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#ab364a42b3220a3b718e204469cb9cbd8">BLI_addfillvert</a>(&amp;sf_ctx, entry-&gt;kfe-&gt;v1-&gt;v-&gt;co);
<a name="l01885"></a>01885                 eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> = 0;
<a name="l01886"></a>01886                 rnd_offset_co(eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a687a7dca43c6b6a011eda8eb44b035ad">co</a>, rndscale);
<a name="l01887"></a>01887                 eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a620ec0fbee5c94829936c45ef67dd260">tmp</a>.<a class="code" href="../../df/d03/structScanFillVert.html#a1f99d17c83f3f84cbd66edd53877833a">p</a> = entry-&gt;kfe-&gt;v1-&gt;v;
<a name="l01888"></a>01888                 <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v1, eve);
<a name="l01889"></a>01889             }
<a name="l01890"></a>01890 
<a name="l01891"></a>01891             <span class="keywordflow">if</span> (!<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v2)) {
<a name="l01892"></a>01892                 eve = <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#ab364a42b3220a3b718e204469cb9cbd8">BLI_addfillvert</a>(&amp;sf_ctx, entry-&gt;kfe-&gt;v2-&gt;v-&gt;co);
<a name="l01893"></a>01893                 eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> = 0;
<a name="l01894"></a>01894                 rnd_offset_co(eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a687a7dca43c6b6a011eda8eb44b035ad">co</a>, rndscale);
<a name="l01895"></a>01895                 eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a620ec0fbee5c94829936c45ef67dd260">tmp</a>.<a class="code" href="../../df/d03/structScanFillVert.html#a1f99d17c83f3f84cbd66edd53877833a">p</a> = entry-&gt;kfe-&gt;v2-&gt;v;
<a name="l01896"></a>01896                 <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v2, eve);
<a name="l01897"></a>01897             }
<a name="l01898"></a>01898         }
<a name="l01899"></a>01899 
<a name="l01900"></a>01900         <span class="keywordflow">for</span> (j = 0, entry = face_nets[i].first; entry; entry = entry-&gt;next, j++) {
<a name="l01901"></a>01901             lasteve = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v1);
<a name="l01902"></a>01902             eve = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v2);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904             eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a>++;
<a name="l01905"></a>01905             lasteve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a>++;
<a name="l01906"></a>01906         }
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         <span class="keywordflow">for</span> (j = 0, entry = face_nets[i].first; entry; entry = entry-&gt;next, j++) {
<a name="l01909"></a>01909             lasteve = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v1);
<a name="l01910"></a>01910             eve = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(hash, (intptr_t)entry-&gt;kfe-&gt;v2);
<a name="l01911"></a>01911 
<a name="l01912"></a>01912             <span class="keywordflow">if</span> (eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> &gt; 1 &amp;&amp; lasteve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> &gt; 1) {
<a name="l01913"></a>01913                 <a class="code" href="../../da/d88/structScanFillEdge.html">ScanFillEdge</a> *eed;
<a name="l01914"></a>01914                 eed = <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#a7c332f93c7a18692fbbaec4c2d746fb7">BLI_addfilledge</a>(&amp;sf_ctx, lasteve, eve);
<a name="l01915"></a>01915                 <span class="keywordflow">if</span> (entry-&gt;kfe-&gt;oe)
<a name="l01916"></a>01916                     eed-&gt;<a class="code" href="../../da/d88/structScanFillEdge.html#a858db61d3fe6206d471e056a744e1432">f</a> = <a class="code" href="../../d6/dad/scanfill_8c.html#a0e443e20843d70df5e4534721696f601">SF_EDGE_BOUNDARY</a>;  <span class="comment">/* mark as original boundary edge */</span>
<a name="l01917"></a>01917 
<a name="l01918"></a>01918                 <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a045007133673a18b6e8f120f533a129e">BMO_elem_flag_disable</a>(bm, entry-&gt;kfe-&gt;e-&gt;v1, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01919"></a>01919                 <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a045007133673a18b6e8f120f533a129e">BMO_elem_flag_disable</a>(bm, entry-&gt;kfe-&gt;e-&gt;v2, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01920"></a>01920             }
<a name="l01921"></a>01921             <span class="keywordflow">else</span> {
<a name="l01922"></a>01922                 <span class="keywordflow">if</span> (lasteve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> &lt; 2)
<a name="l01923"></a>01923                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;sf_ctx.<a class="code" href="../../d7/d8b/structScanFillContext.html#ab0589a38cc0bd5eb5eff574659fc8716">fillvertbase</a>, lasteve);
<a name="l01924"></a>01924                 <span class="keywordflow">if</span> (eve-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#ab624747c602692bc43052815a661b13c">poly_nr</a> &lt; 2)
<a name="l01925"></a>01925                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(&amp;sf_ctx.<a class="code" href="../../d7/d8b/structScanFillContext.html#ab0589a38cc0bd5eb5eff574659fc8716">fillvertbase</a>, eve);
<a name="l01926"></a>01926             }
<a name="l01927"></a>01927         }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929         <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#a23facd70ebf31a9d28329f7d98921486">BLI_edgefill</a>(&amp;sf_ctx, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="keywordflow">for</span> (efa = sf_ctx.<a class="code" href="../../d7/d8b/structScanFillContext.html#af37dfce6ca0313ee19dca2127a220b89">fillfacebase</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; efa; efa = efa-&gt;<a class="code" href="../../dd/de1/structScanFillFace.html#a137e2d6ea8dc525ac9dddda3026b7096">next</a>) {
<a name="l01932"></a>01932             <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v1 = efa-&gt;<a class="code" href="../../dd/de1/structScanFillFace.html#a8aef6cbbee62717747057d4a0f71db2b">v3</a>-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a620ec0fbee5c94829936c45ef67dd260">tmp</a>.<a class="code" href="../../df/d03/structScanFillVert.html#a1f99d17c83f3f84cbd66edd53877833a">p</a>, *v2 = efa-&gt;<a class="code" href="../../dd/de1/structScanFillFace.html#a6a144de71d8f45e67e6358887f248b38">v2</a>-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a620ec0fbee5c94829936c45ef67dd260">tmp</a>.<a class="code" href="../../df/d03/structScanFillVert.html#a1f99d17c83f3f84cbd66edd53877833a">p</a>, *v3 = efa-&gt;<a class="code" href="../../dd/de1/structScanFillFace.html#acf303db938d2c32343c3c9bdf3455f9b">v1</a>-&gt;<a class="code" href="../../df/d03/structScanFillVert.html#a620ec0fbee5c94829936c45ef67dd260">tmp</a>.<a class="code" href="../../df/d03/structScanFillVert.html#a1f99d17c83f3f84cbd66edd53877833a">p</a>;
<a name="l01933"></a>01933             <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f2;
<a name="l01934"></a>01934             <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l_iter;
<a name="l01935"></a>01935             <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *verts[3] = {v1, v2, v3};
<a name="l01936"></a>01936 
<a name="l01937"></a>01937             <span class="keywordflow">if</span> (v1 == v2 || v2 == v3 || v1 == v3)
<a name="l01938"></a>01938                 <span class="keywordflow">continue</span>;
<a name="l01939"></a>01939             <span class="keywordflow">if</span> (<a class="code" href="../../d9/ddf/bmesh__queries_8c.html#a15cdab6280c969fb57d7da2c1646077d">BM_face_exists</a>(bm, verts, 3, &amp;f2))
<a name="l01940"></a>01940                 <span class="keywordflow">continue</span>;
<a name="l01941"></a>01941 
<a name="l01942"></a>01942             f2 = <a class="code" href="../../da/dd9/bmesh__construct_8c.html#a60e5bc4e95f1142458c98c75d0b5a7a8" title="Make Quad/Triangle.">BM_face_create_quad_tri</a>(bm,
<a name="l01943"></a>01943                                          v1, v2, v3, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l01944"></a>01944                                          <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01945"></a>01945 
<a name="l01946"></a>01946             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac8b0b897ab30ade097cd0b9b5a8817c2">BMO_elem_flag_enable</a>(bm, f2, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>);
<a name="l01947"></a>01947 
<a name="l01948"></a>01948             l_iter = <a class="code" href="../../d1/d77/bmesh__class_8h.html#a9eb772ebcdb9e516e91c3d56572cddec">BM_FACE_FIRST_LOOP</a>(f2);
<a name="l01949"></a>01949             <span class="keywordflow">do</span> {
<a name="l01950"></a>01950                 <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a045007133673a18b6e8f120f533a129e">BMO_elem_flag_disable</a>(bm, l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a37f32bdf99c1763a272342a3c83b5f51">e</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01951"></a>01951             } <span class="keywordflow">while</span> ((l_iter = l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#af78d4a4546e654c1dcc6ebe6476ff0b0">next</a>) != <a class="code" href="../../d1/d77/bmesh__class_8h.html#a9eb772ebcdb9e516e91c3d56572cddec">BM_FACE_FIRST_LOOP</a>(f2));
<a name="l01952"></a>01952 
<a name="l01953"></a>01953             <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a045007133673a18b6e8f120f533a129e">BMO_elem_flag_disable</a>(bm, f2, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>);
<a name="l01954"></a>01954             <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a91b19fa9be8c69ea8efdccbf1b6938c5">BM_elem_index_set</a>(f2, i); <span class="comment">/* set_dirty! */</span><span class="comment">/* note, not 100% sure this is dirty? need to check */</span>
<a name="l01955"></a>01955 
<a name="l01956"></a>01956             <a class="code" href="../../d5/d03/bmesh__polygon_8c.html#a904acbbd0a5bcf183d41bcbe92ae9d82" title="BMESH UPDATE FACE NORMAL.">BM_face_normal_update</a>(f2);
<a name="l01957"></a>01957             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a76629ccfe891bccda30f790ed501e959">dot_v3v3</a>(f-&gt;<a class="code" href="../../d0/d23/structBMFace.html#a9401deff8be300468964ca48850ff702">no</a>, f2-&gt;<a class="code" href="../../d0/d23/structBMFace.html#a9401deff8be300468964ca48850ff702">no</a>) &lt; 0.0f) {
<a name="l01958"></a>01958                 <a class="code" href="../../d5/d03/bmesh__polygon_8c.html#aa10d84743e24f55e798ec58fa4b78c3f" title="Face Flip Normal.">BM_face_normal_flip</a>(bm, f2);
<a name="l01959"></a>01959             }
<a name="l01960"></a>01960         }
<a name="l01961"></a>01961 
<a name="l01962"></a>01962         <a class="code" href="../../d3/de9/BLI__scanfill_8h.html#a1e46e63b4decf290c8f78dbbabd94304">BLI_end_edgefill</a>(&amp;sf_ctx);
<a name="l01963"></a>01963         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(hash);
<a name="l01964"></a>01964     }
<a name="l01965"></a>01965     bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a38cdf1570b76d77dcf6d4bbdbe33f753">elem_index_dirty</a> |= <a class="code" href="../../d1/d77/bmesh__class_8h.html#a77867ab4129f63159b37bca3b652a798a279a53b6bc9b4dd104fa2607f8439075">BM_FACE</a>;
<a name="l01966"></a>01966 
<a name="l01967"></a>01967     <span class="comment">/* interpolate customdata */</span>
<a name="l01968"></a>01968     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a79af59cc6dcf476dee88507d90e316e9">BM_ITER_MESH</a> (f, &amp;bmiter, bm, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fabe0fe60283f43cd8ce697d52d24a3c1e">BM_FACES_OF_MESH</a>) {
<a name="l01969"></a>01969         <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l1;
<a name="l01970"></a>01970         <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f2;
<a name="l01971"></a>01971         <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> liter1;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ae95647462dd30213d7930e1a0a54ef81">BMO_elem_flag_test</a>(bm, f, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3f48a256d25c353ea2409296810c0f64">FACE_NEW</a>))
<a name="l01974"></a>01974             <span class="keywordflow">continue</span>;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976         f2 = faces[<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f)];
<a name="l01977"></a>01977         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f) &lt; 0 || <a class="code" href="../../d8/d74/bmesh__inline_8h.html#a0ad5b2de8c733401a8c223f0509422c9">BM_elem_index_get</a>(f) &gt;= totface) {
<a name="l01978"></a>01978             fprintf(stderr, <span class="stringliteral">&quot;%s: face index out of range! (bmesh internal error)\n&quot;</span>, __func__);
<a name="l01979"></a>01979         }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981         <a class="code" href="../../da/dd9/bmesh__construct_8c.html#aba9609d213e7cb739f94d879a0167785">BM_elem_attrs_copy</a>(bm, bm, f2, f);
<a name="l01982"></a>01982 
<a name="l01983"></a>01983         <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (l1, &amp;liter1, f, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1faf52ecdfb30814f26ead38881b29c7375">BM_LOOPS_OF_FACE</a>) {
<a name="l01984"></a>01984             <a class="code" href="../../de/d02/bmesh__interp_8c.html#a13b3d458d0896f980ea51f7179f471e3">BM_loop_interp_from_face</a>(bm, l1, f2, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l01985"></a>01985         }
<a name="l01986"></a>01986     }
<a name="l01987"></a>01987 
<a name="l01988"></a>01988     <span class="comment">/* merge triangles back into faces */</span>
<a name="l01989"></a>01989     remerge_faces(kcd);
<a name="l01990"></a>01990 
<a name="l01991"></a>01991     <span class="comment">/* delete left over faces */</span>
<a name="l01992"></a>01992     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a5113211e19fe53429699444369f258aa">BMO_op_callf</a>(bm, <span class="stringliteral">&quot;del geom=%ff context=%i&quot;</span>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>, <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac205be2172292384dd687b5471a87edda8795e553eeb826902e3d217fc7e6fed7">DEL_ONLYFACES</a>);
<a name="l01993"></a>01993     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a5113211e19fe53429699444369f258aa">BMO_op_callf</a>(bm, <span class="stringliteral">&quot;del geom=%fe context=%i&quot;</span>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>, <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac205be2172292384dd687b5471a87edda17039e8ade216c79cb1bfa77901f6b3b">DEL_EDGES</a>);
<a name="l01994"></a>01994     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a5113211e19fe53429699444369f258aa">BMO_op_callf</a>(bm, <span class="stringliteral">&quot;del geom=%fv context=%i&quot;</span>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad1e508e805e4ddbc05119be4bb260985">DEL</a>, <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac205be2172292384dd687b5471a87eddaa0158e5b0ed23eeeb6d2c84d9f7ec21b">DEL_VERTS</a>);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996     <span class="keywordflow">if</span> (face_nets) 
<a name="l01997"></a>01997         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(face_nets);
<a name="l01998"></a>01998     <span class="keywordflow">if</span> (faces)
<a name="l01999"></a>01999         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(faces);
<a name="l02000"></a>02000     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(arena);
<a name="l02001"></a>02001 
<a name="l02002"></a>02002     <a class="code" href="../../d0/d7d/bmesh__error_8h.html#a45c90cf587d013af1d2106a7eadc74e2">BMO_error_clear</a>(bm); <span class="comment">/* remerge_faces sometimes raises errors, so make sure to clear them */</span>
<a name="l02003"></a>02003 
<a name="l02004"></a>02004     <a class="code" href="../../d5/db9/bmesh__mesh_8c.html#a6d4af0462544ffd2ce81c0ec225ae415" title="BMesh End Edit.">bmesh_edit_end</a>(bm, <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#ac038a1e8b1ad739c47df10a3bc02d465">BMO_OP_FLAG_UNTAN_MULTIRES</a>);
<a name="l02005"></a>02005     <a class="code" href="../../d5/d70/bmesh__operator__api_8h.html#a74d6b5707e96486e114bfa102ae6ed5e" title="BMESH OPSTACK POP.">BMO_pop</a>(bm);
<a name="l02006"></a>02006 }
<a name="l02007"></a>02007 
<a name="l02008"></a>02008 <span class="preprocessor">#else  </span><span class="comment">/* use direct (non-scanfill) method for cuts */</span>
<a name="l02009"></a>02009 
<a name="l02010"></a>02010 <span class="comment">/* assuming v is on line ab, what fraction of the way is v from a to b? */</span>
<a name="l02011"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a29e7bf63b7514b9318ce4d7a6512cc7d">02011</a> <span class="keyword">static</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a29e7bf63b7514b9318ce4d7a6512cc7d">frac_along</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a[3], <span class="keyword">const</span> <span class="keywordtype">float</span> b[3], <span class="keyword">const</span> <span class="keywordtype">float</span> v[3])
<a name="l02012"></a>02012 {
<a name="l02013"></a>02013     <span class="keywordtype">float</span> lab;
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     lab = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(a, b);
<a name="l02016"></a>02016     <span class="keywordflow">if</span> (lab == 0.0f) {
<a name="l02017"></a>02017         <span class="keywordflow">return</span> 0.0f;
<a name="l02018"></a>02018     }
<a name="l02019"></a>02019     <span class="keywordflow">else</span> {
<a name="l02020"></a>02020         <span class="keywordflow">return</span> <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a97ecadbef10e5cc3decc2c02c3b96824">len_v3v3</a>(a, v) / lab;
<a name="l02021"></a>02021     }
<a name="l02022"></a>02022 }
<a name="l02023"></a>02023 
<a name="l02024"></a>02024 <span class="comment">/* sort list of kverts by fraction along edge e */</span>
<a name="l02025"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a23c003017ca9cfd682e97c264b1855d8">02025</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a23c003017ca9cfd682e97c264b1855d8">sort_by_frac_along</a>(<a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst, <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *e)
<a name="l02026"></a>02026 {
<a name="l02027"></a>02027     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *vcur, *vprev;
<a name="l02028"></a>02028     <span class="keywordtype">float</span> *v1co, *v2co;
<a name="l02029"></a>02029     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *cur = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *prev = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02030"></a>02030 
<a name="l02031"></a>02031     <span class="keywordflow">if</span> (lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a> == lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>)
<a name="l02032"></a>02032         <span class="keywordflow">return</span>;
<a name="l02033"></a>02033 
<a name="l02034"></a>02034     v1co = e-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#ab6378c5ea7e85917c389a1dfdff790ea">v1</a>-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>;
<a name="l02035"></a>02035     v2co = e-&gt;<a class="code" href="../../de/d6e/structBMEdge.html#a00090f09abd0ef12bcf279cb0c41c0ca">v2</a>-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>;
<a name="l02036"></a>02036 
<a name="l02037"></a>02037     <span class="keywordflow">for</span> (cur = ((<a class="code" href="../../d0/d6a/structRef.html">Ref</a> *)lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>; cur; cur = next) {
<a name="l02038"></a>02038         next = cur-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>;
<a name="l02039"></a>02039         prev = cur-&gt;<a class="code" href="../../d0/d6a/structRef.html#a8d5d6c996e0e63c4a6c4a80b2009d0b2">prev</a>;
<a name="l02040"></a>02040 
<a name="l02041"></a>02041         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(lst, cur);
<a name="l02042"></a>02042 
<a name="l02043"></a>02043         vcur = cur-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02044"></a>02044         <span class="keywordflow">while</span> (prev) {
<a name="l02045"></a>02045             vprev = prev-&gt;ref;
<a name="l02046"></a>02046             <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#a29e7bf63b7514b9318ce4d7a6512cc7d">frac_along</a>(v1co, v2co, vprev-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>) &lt;= <a class="code" href="../../da/d56/editmesh__knife_8c.html#a29e7bf63b7514b9318ce4d7a6512cc7d">frac_along</a>(v1co, v2co, vcur-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>))
<a name="l02047"></a>02047                 <span class="keywordflow">break</span>;
<a name="l02048"></a>02048             prev = prev-&gt;prev;
<a name="l02049"></a>02049         }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051         <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a9c299678f8810312806da26e6132ccc7">BLI_insertlinkafter</a>(lst, prev, cur);
<a name="l02052"></a>02052     }
<a name="l02053"></a>02053 }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055 <span class="comment">/* The chain so far goes from an instantiated vertex to kfv (some may be reversed).</span>
<a name="l02056"></a>02056 <span class="comment"> * If possible, complete the chain to another instantiated vertex and return 1, else return 0.</span>
<a name="l02057"></a>02057 <span class="comment"> * The visited hash says which KnifeVert&#39;s have already been tried, not including kfv. */</span>
<a name="l02058"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a452c4bd5eb6f56d1e9e0b8ae20358b70">02058</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a452c4bd5eb6f56d1e9e0b8ae20358b70">find_chain_search</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fedges, <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> *visited,
<a name="l02059"></a>02059                              <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *chain)
<a name="l02060"></a>02060 {
<a name="l02061"></a>02061     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r;
<a name="l02062"></a>02062     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02063"></a>02063     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv_other;
<a name="l02064"></a>02064 
<a name="l02065"></a>02065     <span class="keywordflow">if</span> (kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>)
<a name="l02066"></a>02066         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visited, (uintptr_t)kfv, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02069"></a>02069     <span class="comment">/* Try all possible next edges. Could either go through fedges</span>
<a name="l02070"></a>02070 <span class="comment">     * (all the KnifeEdges for the face being cut) or could go through</span>
<a name="l02071"></a>02071 <span class="comment">     * kve-&gt;edges and restrict to cutting face and uninstantiated edges.</span>
<a name="l02072"></a>02072 <span class="comment">     * Not clear which is better. Let&#39;s do the first. */</span>
<a name="l02073"></a>02073     <span class="keywordflow">for</span> (r = fedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02074"></a>02074         kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02075"></a>02075         kfv_other = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02076"></a>02076         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> == kfv)
<a name="l02077"></a>02077             kfv_other = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l02078"></a>02078         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> == kfv)
<a name="l02079"></a>02079             kfv_other = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l02080"></a>02080         <span class="keywordflow">if</span> (kfv_other &amp;&amp; !<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(visited, (uintptr_t)kfv_other)) {
<a name="l02081"></a>02081             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, chain, kfe);
<a name="l02082"></a>02082             <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#a452c4bd5eb6f56d1e9e0b8ae20358b70">find_chain_search</a>(kcd, kfv_other, fedges, visited, chain))
<a name="l02083"></a>02083                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02084"></a>02084             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(chain, chain-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>);
<a name="l02085"></a>02085         }
<a name="l02086"></a>02086     }
<a name="l02087"></a>02087     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02088"></a>02088 }
<a name="l02089"></a>02089 
<a name="l02090"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#aa0c7f3e56ee026958a59feeda7aebb78">02090</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa0c7f3e56ee026958a59feeda7aebb78">find_chain_from_vertex</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fedges)
<a name="l02091"></a>02091 {
<a name="l02092"></a>02092     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> visited_, *visited = &amp;visited_;
<a name="l02093"></a>02093     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ans;
<a name="l02094"></a>02094     <span class="keywordtype">int</span> found;
<a name="l02095"></a>02095 
<a name="l02096"></a>02096     ans = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02097"></a>02097     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, ans, kfe);
<a name="l02098"></a>02098     found = 0;
<a name="l02099"></a>02099     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(visited);
<a name="l02100"></a>02100     <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == v) {
<a name="l02101"></a>02101         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visited, (uintptr_t)(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02102"></a>02102         found = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a452c4bd5eb6f56d1e9e0b8ae20358b70">find_chain_search</a>(kcd, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>, fedges, visited, ans);
<a name="l02103"></a>02103     }
<a name="l02104"></a>02104     <span class="keywordflow">else</span> {
<a name="l02105"></a>02105         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == v);
<a name="l02106"></a>02106         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visited, (uintptr_t)(kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02107"></a>02107         found = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a452c4bd5eb6f56d1e9e0b8ae20358b70">find_chain_search</a>(kcd, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>, fedges, visited, ans);
<a name="l02108"></a>02108     }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(visited);
<a name="l02111"></a>02111 
<a name="l02112"></a>02112     <span class="keywordflow">if</span> (found)
<a name="l02113"></a>02113         <span class="keywordflow">return</span> ans;
<a name="l02114"></a>02114     <span class="keywordflow">else</span>
<a name="l02115"></a>02115         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02116"></a>02116 }
<a name="l02117"></a>02117 
<a name="l02118"></a>02118 <span class="comment">/* Find a chain in fedges from one instantiated vertex to another.</span>
<a name="l02119"></a>02119 <span class="comment"> * Remove the edges in the chain from fedges and return a separate list of the chain. */</span>
<a name="l02120"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ad4d11c79492a8fe1451e316c9221175c">02120</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#ad4d11c79492a8fe1451e316c9221175c">find_chain</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fedges)
<a name="l02121"></a>02121 {
<a name="l02122"></a>02122     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r, *ref;
<a name="l02123"></a>02123     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02124"></a>02124     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v1, *v2;
<a name="l02125"></a>02125     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ans;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     ans = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     <span class="keywordflow">for</span> (r = fedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02130"></a>02130         kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02131"></a>02131         v1 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02132"></a>02132         v2 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02133"></a>02133         <span class="keywordflow">if</span> (v1 &amp;&amp; v2) {
<a name="l02134"></a>02134             ans = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02135"></a>02135             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, ans, kfe);
<a name="l02136"></a>02136             <span class="keywordflow">break</span>;
<a name="l02137"></a>02137         }
<a name="l02138"></a>02138         <span class="keywordflow">if</span> (v1)
<a name="l02139"></a>02139             ans = <a class="code" href="../../da/d56/editmesh__knife_8c.html#aa0c7f3e56ee026958a59feeda7aebb78">find_chain_from_vertex</a>(kcd, kfe, v1, fedges);
<a name="l02140"></a>02140         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v2)
<a name="l02141"></a>02141             ans = <a class="code" href="../../da/d56/editmesh__knife_8c.html#aa0c7f3e56ee026958a59feeda7aebb78">find_chain_from_vertex</a>(kcd, kfe, v2, fedges);
<a name="l02142"></a>02142         <span class="keywordflow">if</span> (ans)
<a name="l02143"></a>02143             <span class="keywordflow">break</span>;
<a name="l02144"></a>02144     }
<a name="l02145"></a>02145     <span class="keywordflow">if</span> (ans) {
<a name="l02146"></a>02146         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(<a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(ans) &gt; 0);
<a name="l02147"></a>02147         <span class="keywordflow">for</span> (r = ans-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02148"></a>02148             ref = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(fedges, r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>);
<a name="l02149"></a>02149             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(ref != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02150"></a>02150             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(fedges, ref);
<a name="l02151"></a>02151         }
<a name="l02152"></a>02152     }
<a name="l02153"></a>02153     <span class="keywordflow">return</span> ans;
<a name="l02154"></a>02154 }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156 <span class="comment">/* The hole so far goes from kfvfirst to kfv (some may be reversed).</span>
<a name="l02157"></a>02157 <span class="comment"> * If possible, complete the hole back to kfvfirst and return 1, else return 0.</span>
<a name="l02158"></a>02158 <span class="comment"> * The visited hash says which KnifeVert&#39;s have already been tried, not including kfv or kfvfirst. */</span>
<a name="l02159"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a6ca1788e93f340d6404428a890565508">02159</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6ca1788e93f340d6404428a890565508">find_hole_search</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfvfirst, <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fedges,
<a name="l02160"></a>02160                             <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> *visited, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *hole)
<a name="l02161"></a>02161 {
<a name="l02162"></a>02162     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r;
<a name="l02163"></a>02163     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, *kfelast;
<a name="l02164"></a>02164     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv_other;
<a name="l02165"></a>02165 
<a name="l02166"></a>02166     <span class="keywordflow">if</span> (kfv == kfvfirst)
<a name="l02167"></a>02167         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02168"></a>02168 
<a name="l02169"></a>02169     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(visited, (uintptr_t)kfv, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02170"></a>02170     kfelast = ((<a class="code" href="../../d0/d6a/structRef.html">Ref</a> *)hole-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>)-&gt;ref;
<a name="l02171"></a>02171     <span class="keywordflow">for</span> (r = fedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02172"></a>02172         kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02173"></a>02173         <span class="keywordflow">if</span> (kfe == kfelast)
<a name="l02174"></a>02174             <span class="keywordflow">continue</span>;
<a name="l02175"></a>02175         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>)
<a name="l02176"></a>02176             <span class="keywordflow">continue</span>;
<a name="l02177"></a>02177         kfv_other = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02178"></a>02178         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> == kfv)
<a name="l02179"></a>02179             kfv_other = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l02180"></a>02180         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> == kfv)
<a name="l02181"></a>02181             kfv_other = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l02182"></a>02182         <span class="keywordflow">if</span> (kfv_other &amp;&amp; !<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(visited, (uintptr_t)kfv_other)) {
<a name="l02183"></a>02183             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, hole, kfe);
<a name="l02184"></a>02184             <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#a6ca1788e93f340d6404428a890565508">find_hole_search</a>(kcd, kfvfirst, kfv_other, fedges, visited, hole))
<a name="l02185"></a>02185                 <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02186"></a>02186             <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(hole, hole-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>);
<a name="l02187"></a>02187         }
<a name="l02188"></a>02188     }
<a name="l02189"></a>02189     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02190"></a>02190 }
<a name="l02191"></a>02191 
<a name="l02192"></a>02192 <span class="comment">/* Find a hole (simple cycle with no instantiated vertices).</span>
<a name="l02193"></a>02193 <span class="comment"> * Remove the edges in the cycle from fedges and return a separate list of the cycle */</span>
<a name="l02194"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a31e005e931292ebeffc35ec2a5578f12">02194</a> <span class="keyword">static</span> <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a31e005e931292ebeffc35ec2a5578f12">find_hole</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fedges)
<a name="l02195"></a>02195 {
<a name="l02196"></a>02196     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *ans;
<a name="l02197"></a>02197     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r, *ref;
<a name="l02198"></a>02198     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02199"></a>02199     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> visited_, *visited = &amp;visited_;
<a name="l02200"></a>02200     <span class="keywordtype">int</span> found;
<a name="l02201"></a>02201 
<a name="l02202"></a>02202     ans = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02203"></a>02203     found = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205     <span class="keywordflow">for</span> (r = fedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r &amp;&amp; !found; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02206"></a>02206         kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02207"></a>02207         <span class="keywordflow">if</span> (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>)
<a name="l02208"></a>02208             <span class="keywordflow">continue</span>;
<a name="l02209"></a>02209 
<a name="l02210"></a>02210         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(visited);
<a name="l02211"></a>02211         ans = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02212"></a>02212         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, ans, kfe);
<a name="l02213"></a>02213 
<a name="l02214"></a>02214         found = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6ca1788e93f340d6404428a890565508">find_hole_search</a>(kcd, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>, fedges, visited, ans);
<a name="l02215"></a>02215 
<a name="l02216"></a>02216         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(visited);
<a name="l02217"></a>02217     }
<a name="l02218"></a>02218 
<a name="l02219"></a>02219     <span class="keywordflow">if</span> (found) {
<a name="l02220"></a>02220         <span class="keywordflow">for</span> (r = ans-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02221"></a>02221             kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02222"></a>02222             ref = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(fedges, r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>);
<a name="l02223"></a>02223             <span class="keywordflow">if</span> (ref)
<a name="l02224"></a>02224                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(fedges, ref);
<a name="l02225"></a>02225         }
<a name="l02226"></a>02226         <span class="keywordflow">return</span> ans;
<a name="l02227"></a>02227     }
<a name="l02228"></a>02228     <span class="keywordflow">else</span> {
<a name="l02229"></a>02229         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02230"></a>02230     }
<a name="l02231"></a>02231 }
<a name="l02232"></a>02232 
<a name="l02233"></a>02233 <span class="comment">/* Try to find &quot;nice&quot; diagonals - short, and far apart from each other.</span>
<a name="l02234"></a>02234 <span class="comment"> * If found, return TRUE and make a &#39;main chain&#39; going across f which uses</span>
<a name="l02235"></a>02235 <span class="comment"> * the two diagonals and one part of the hole, and a &#39;side chain&#39; that</span>
<a name="l02236"></a>02236 <span class="comment"> * completes the hole. */</span>
<a name="l02237"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a99e6d0c694b3b04db7e54aaf31c60818">02237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a99e6d0c694b3b04db7e54aaf31c60818">find_hole_chains</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *hole, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **mainchain,
<a name="l02238"></a>02238                             <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> **sidechain)
<a name="l02239"></a>02239 {
<a name="l02240"></a>02240     <span class="keywordtype">float</span> **fco, **hco;
<a name="l02241"></a>02241     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> **fv;
<a name="l02242"></a>02242     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> **hv;
<a name="l02243"></a>02243     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> **he;
<a name="l02244"></a>02244     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *r;
<a name="l02245"></a>02245     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv, *kfvother;
<a name="l02246"></a>02246     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02247"></a>02247     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *chain;
<a name="l02248"></a>02248     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v;
<a name="l02249"></a>02249     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l02250"></a>02250     <span class="keywordtype">int</span> nh, nf, <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>, j, k, m, ax, ay, ok, sep, bestsep;
<a name="l02251"></a>02251     <span class="keywordtype">int</span> besti[2], bestj[2];
<a name="l02252"></a>02252     <span class="keywordtype">float</span> d, bestd;
<a name="l02253"></a>02253 
<a name="l02254"></a>02254     nh = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(hole);
<a name="l02255"></a>02255     nf = f-&gt;<a class="code" href="../../d0/d23/structBMFace.html#a221be6c99989ead8ee0e1bba1eb0272e">len</a>;
<a name="l02256"></a>02256     <span class="keywordflow">if</span> (nh &lt; 2 || nf &lt; 3)
<a name="l02257"></a>02257         <span class="keywordflow">return</span> 0;
<a name="l02258"></a>02258 
<a name="l02259"></a>02259     <span class="comment">/* Gather 2d projections of hole and face vertex coordinates.</span>
<a name="l02260"></a>02260 <span class="comment">     * Use best-axis projection - not completely accurate, maybe revisit */</span>
<a name="l02261"></a>02261     <a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#a1d7ee186236c67b1591049c92c382e0d">axis_dominant_v3</a>(&amp;ax, &amp;ay, f-&gt;<a class="code" href="../../d0/d23/structBMFace.html#a9401deff8be300468964ca48850ff702">no</a>);
<a name="l02262"></a>02262     hco = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, nh * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span> *));
<a name="l02263"></a>02263     fco = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, nf * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span> *));
<a name="l02264"></a>02264     hv = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, nh * <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *));
<a name="l02265"></a>02265     fv = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, nf * <span class="keyword">sizeof</span>(<a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *));
<a name="l02266"></a>02266     he = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, nh * <span class="keyword">sizeof</span>(<a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *));
<a name="l02267"></a>02267 
<a name="l02268"></a>02268     i = 0;
<a name="l02269"></a>02269     kfv = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02270"></a>02270     kfvother = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02271"></a>02271     <span class="keywordflow">for</span> (r = hole-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; r; r = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02272"></a>02272         kfe = r-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02273"></a>02273         he[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = kfe;
<a name="l02274"></a>02274         <span class="keywordflow">if</span> (kfvother == <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02275"></a>02275             kfv = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l02276"></a>02276         }
<a name="l02277"></a>02277         <span class="keywordflow">else</span> {
<a name="l02278"></a>02278             kfv = kfvother;
<a name="l02279"></a>02279             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(kfv == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> || kfv == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>);
<a name="l02280"></a>02280         }
<a name="l02281"></a>02281         hco[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, 2 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l02282"></a>02282         hco[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][0] = kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>[ax];
<a name="l02283"></a>02283         hco[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][1] = kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>[ay];
<a name="l02284"></a>02284         hv[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = kfv;
<a name="l02285"></a>02285         kfvother = (kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> == kfv) ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l02286"></a>02286         i++;
<a name="l02287"></a>02287     }
<a name="l02288"></a>02288 
<a name="l02289"></a>02289     j = 0;
<a name="l02290"></a>02290     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (v, &amp;iter, f, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1fa8fa96ae233cbf490f7efc618e8efbffd">BM_VERTS_OF_FACE</a>) {
<a name="l02291"></a>02291         fco[j] = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a0f9a6f52847ec6e22fdacf05bd20740d">BLI_memarena_alloc</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>, 2 * <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l02292"></a>02292         fco[j][0] = v-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>[ax];
<a name="l02293"></a>02293         fco[j][1] = v-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>[ay];
<a name="l02294"></a>02294         fv[j] = v;
<a name="l02295"></a>02295         j++;
<a name="l02296"></a>02296     }
<a name="l02297"></a>02297 
<a name="l02298"></a>02298     <span class="comment">/* For first diagonal  (m == 0), want shortest length.</span>
<a name="l02299"></a>02299 <span class="comment">     * For second diagonal (m == 1), want max separation of index of hole</span>
<a name="l02300"></a>02300 <span class="comment">     * vertex from the hole vertex used in the first diagonal, and from there</span>
<a name="l02301"></a>02301 <span class="comment">     * want the one with shortest length not to the same vertex as the first diagonal. */</span>
<a name="l02302"></a>02302     <span class="keywordflow">for</span> (m = 0; m &lt; 2; m++) {
<a name="l02303"></a>02303         besti[m] = -1;
<a name="l02304"></a>02304         bestj[m] = -1;
<a name="l02305"></a>02305         bestd = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l02306"></a>02306         bestsep = 0;
<a name="l02307"></a>02307         <span class="keywordflow">for</span> (i = 0; i &lt; nh; i++) {
<a name="l02308"></a>02308             <span class="keywordflow">if</span> (m == 1) {
<a name="l02309"></a>02309                 <span class="keywordflow">if</span> (i == besti[0])
<a name="l02310"></a>02310                     <span class="keywordflow">continue</span>;
<a name="l02311"></a>02311                 sep = (i + nh - besti[0]) % nh;
<a name="l02312"></a>02312                 sep = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#af5febfb026bad0c08e7a9f7ab7c2b8f0">MIN2</a>(sep, nh - sep);
<a name="l02313"></a>02313                 <span class="keywordflow">if</span> (sep &lt; bestsep)
<a name="l02314"></a>02314                     <span class="keywordflow">continue</span>;
<a name="l02315"></a>02315                 bestd = <a class="code" href="../../d3/db4/VEC3_8h.html#a7fbf1534f9e0f0bfdb86fb928902474c">FLT_MAX</a>;
<a name="l02316"></a>02316             }
<a name="l02317"></a>02317             <span class="keywordflow">for</span> (j = 0; j &lt; nf; j++) {
<a name="l02318"></a>02318                 <span class="keywordflow">if</span> (m == 1 &amp;&amp; j == bestj[0])
<a name="l02319"></a>02319                     <span class="keywordflow">continue</span>;
<a name="l02320"></a>02320                 d = <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#aad974afda68ca9dc12b3ebc0ce297a0c">len_squared_v2v2</a>(hco[i], fco[j]);
<a name="l02321"></a>02321                 <span class="keywordflow">if</span> (d &gt; bestd)
<a name="l02322"></a>02322                     <span class="keywordflow">continue</span>;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324                 ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02325"></a>02325                 <span class="keywordflow">for</span> (k = 0; k &lt; nh &amp;&amp; ok; k++) {
<a name="l02326"></a>02326                     <span class="keywordflow">if</span> (k == i || (k + 1) % nh == i)
<a name="l02327"></a>02327                         <span class="keywordflow">continue</span>;
<a name="l02328"></a>02328                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(hco[i], fco[j], hco[k], hco[(k + 1) % nh]))
<a name="l02329"></a>02329                         ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02330"></a>02330                 }
<a name="l02331"></a>02331                 <span class="keywordflow">if</span> (!ok)
<a name="l02332"></a>02332                     <span class="keywordflow">continue</span>;
<a name="l02333"></a>02333                 <span class="keywordflow">for</span> (k = 0; k &lt; nf &amp;&amp; ok; k++) {
<a name="l02334"></a>02334                     <span class="keywordflow">if</span> (k == j || (k + 1) % nf == j)
<a name="l02335"></a>02335                         <span class="keywordflow">continue</span>;
<a name="l02336"></a>02336                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/dc3/BLI__math__geom_8h.html#ae064721a493a37d68f1d5add94201f6a">isect_line_line_v2</a>(hco[i], fco[j], fco[k], fco[(k + 1) % nf]))
<a name="l02337"></a>02337                         ok = <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02338"></a>02338                 }
<a name="l02339"></a>02339                 <span class="keywordflow">if</span> (ok) {
<a name="l02340"></a>02340                     besti[m] = <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02341"></a>02341                     bestj[m] = j;
<a name="l02342"></a>02342                     <span class="keywordflow">if</span> (m == 1)
<a name="l02343"></a>02343                         bestsep = sep;
<a name="l02344"></a>02344                     bestd = d;
<a name="l02345"></a>02345                 }
<a name="l02346"></a>02346             }
<a name="l02347"></a>02347         }
<a name="l02348"></a>02348     }
<a name="l02349"></a>02349 
<a name="l02350"></a>02350     <span class="keywordflow">if</span> (besti[0] != -1 &amp;&amp; besti[1] != -1) {
<a name="l02351"></a>02351         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(besti[0] != besti[1] &amp;&amp; bestj[0] != bestj[1]);
<a name="l02352"></a>02352         kfe = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd);
<a name="l02353"></a>02353         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">get_bm_knife_vert</a>(kcd, fv[bestj[0]]);
<a name="l02354"></a>02354         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = hv[besti[0]];
<a name="l02355"></a>02355         chain = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02356"></a>02356         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, chain, kfe);
<a name="l02357"></a>02357         <span class="keywordflow">for</span> (i = besti[0]; i != besti[1]; i = (i + 1) % nh) {
<a name="l02358"></a>02358             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, chain, he[i]);
<a name="l02359"></a>02359         }
<a name="l02360"></a>02360         kfe = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8d057a650acc964afc51b8f747b05925">new_knife_edge</a>(kcd);
<a name="l02361"></a>02361         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> = hv[besti[1]];
<a name="l02362"></a>02362         kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf21e26b28468d39b151684b4808f3da">get_bm_knife_vert</a>(kcd, fv[bestj[1]]);
<a name="l02363"></a>02363         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, chain, kfe);
<a name="l02364"></a>02364         *mainchain = chain;
<a name="l02365"></a>02365 
<a name="l02366"></a>02366         chain = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02367"></a>02367         <span class="keywordflow">for</span> (i = besti[1]; i != besti[0]; i = (i + 1) % nh) {
<a name="l02368"></a>02368             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, chain, he[i]);
<a name="l02369"></a>02369         }
<a name="l02370"></a>02370         *sidechain = chain;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02373"></a>02373     }
<a name="l02374"></a>02374     <span class="keywordflow">else</span> {
<a name="l02375"></a>02375         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02376"></a>02376     }
<a name="l02377"></a>02377 }
<a name="l02378"></a>02378 
<a name="l02379"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">02379</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *<a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(kcd), <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f)
<a name="l02380"></a>02380 {
<a name="l02381"></a>02381     <span class="comment">/* BMesh *bm = kcd-&gt;em-&gt;bm; */</span> <span class="comment">/* UNUSED */</span>
<a name="l02382"></a>02382     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v1, *v2;
<a name="l02383"></a>02383     <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *l1, *l2, *l;
<a name="l02384"></a>02384     <span class="keywordtype">float</span> mid[3];
<a name="l02385"></a>02385     <a class="code" href="../../de/d88/structBMIter.html">BMIter</a> iter;
<a name="l02386"></a>02386     <span class="keywordtype">int</span> v1inside, v2inside;
<a name="l02387"></a>02387 
<a name="l02388"></a>02388     <span class="keywordflow">if</span> (!f)
<a name="l02389"></a>02389         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02390"></a>02390 
<a name="l02391"></a>02391     v1 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02392"></a>02392     v2 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02393"></a>02393     l1 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02394"></a>02394     l2 = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02395"></a>02395 
<a name="l02396"></a>02396     <span class="comment">/* find out if v1 and v2, if set, are part of the face */</span>
<a name="l02397"></a>02397     <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a5e5c4d17117bdcca9ab959ebf43a174f">BM_ITER_ELEM</a> (l, &amp;iter, f, <a class="code" href="../../d8/d17/bmesh__iterators_8h.html#a8b86da2394e306625bbfd94190505d1faf52ecdfb30814f26ead38881b29c7375">BM_LOOPS_OF_FACE</a>) {
<a name="l02398"></a>02398         <span class="keywordflow">if</span> (v1 &amp;&amp; l-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a2da088cf339e17dafd9f5e7ee0bf3771">v</a> == v1)
<a name="l02399"></a>02399             l1 = l;
<a name="l02400"></a>02400         <span class="keywordflow">if</span> (v2 &amp;&amp; l-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a2da088cf339e17dafd9f5e7ee0bf3771">v</a> == v2)
<a name="l02401"></a>02401             l2 = l;
<a name="l02402"></a>02402     }
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="comment">/* BM_face_point_inside_test uses best-axis projection so this isn&#39;t most accurate test... */</span>
<a name="l02405"></a>02405     v1inside = l1 ? 0 : <a class="code" href="../../d5/d03/bmesh__polygon_8c.html#a61e250513a6ab4e28822ce64e4054ba4">BM_face_point_inside_test</a>(f, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l02406"></a>02406     v2inside = l2 ? 0 : <a class="code" href="../../d5/d03/bmesh__polygon_8c.html#a61e250513a6ab4e28822ce64e4054ba4">BM_face_point_inside_test</a>(f, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l02407"></a>02407     <span class="keywordflow">if</span> ((l1 &amp;&amp; v2inside) || (l2 &amp;&amp; v1inside) || (v1inside &amp;&amp; v2inside))
<a name="l02408"></a>02408         <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02409"></a>02409     <span class="keywordflow">if</span> (l1 &amp;&amp; l2) {
<a name="l02410"></a>02410         <span class="comment">/* Can have case where v1 and v2 are on shared chain between two faces.</span>
<a name="l02411"></a>02411 <span class="comment">         * BM_face_legal_splits does visibility and self-intersection tests,</span>
<a name="l02412"></a>02412 <span class="comment">         * but it is expensive and maybe a bit buggy, so use a simple</span>
<a name="l02413"></a>02413 <span class="comment">         * &quot;is the midpoint in the face&quot; test */</span>
<a name="l02414"></a>02414         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#ac3186a97188a3cf15bc5e2f8b0e97ad2">mid_v3_v3v3</a>(mid, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>, kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l02415"></a>02415         <span class="keywordflow">return</span> <a class="code" href="../../d5/d03/bmesh__polygon_8c.html#a61e250513a6ab4e28822ce64e4054ba4">BM_face_point_inside_test</a>(f, mid);
<a name="l02416"></a>02416     }
<a name="l02417"></a>02417     <span class="keywordflow">return</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02418"></a>02418 }
<a name="l02419"></a>02419 
<a name="l02420"></a>02420 <span class="comment">/* Split face f with KnifeEdges on chain.  f remains as one side, the face formed is put in *newface.</span>
<a name="l02421"></a>02421 <span class="comment"> * The new face will be on the left side of the chain as viewed from the normal-out side of f. */</span>
<a name="l02422"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">02422</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">knife_make_chain_cut</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *chain, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> **newface)
<a name="l02423"></a>02423 {
<a name="l02424"></a>02424     <a class="code" href="../../d7/d18/structBMesh.html">BMesh</a> *bm = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>;
<a name="l02425"></a>02425     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe, *kfelast;
<a name="l02426"></a>02426     <a class="code" href="../../df/d18/structBMVert.html">BMVert</a> *v1, *v2;
<a name="l02427"></a>02427     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *fnew;
<a name="l02428"></a>02428     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l02429"></a>02429     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv, *kfvprev;
<a name="l02430"></a>02430     <a class="code" href="../../dc/dd5/structBMLoop.html">BMLoop</a> *lnew, *l_iter;
<a name="l02431"></a>02431     <span class="keywordtype">int</span> <a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>;
<a name="l02432"></a>02432     <span class="keywordtype">int</span> nco = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(chain) - 1;
<a name="l02433"></a>02433     float (*<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>)[3] = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02434"></a>02434     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> **kverts;
<a name="l02435"></a>02435     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae183fbd726d868f27ba45f717e8e883e">BLI_array_fixedstack_declare</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a2ec7f0d9fdc36328119ba93b8064a560">BM_NGON_STACK_SIZE</a>, nco, __func__);
<a name="l02436"></a>02436     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae183fbd726d868f27ba45f717e8e883e">BLI_array_fixedstack_declare</a>(kverts, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a2ec7f0d9fdc36328119ba93b8064a560">BM_NGON_STACK_SIZE</a>, nco, __func__);
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     kfe = ((<a class="code" href="../../d0/d6a/structRef.html">Ref</a> *)chain-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;ref;
<a name="l02439"></a>02439     v1 = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02440"></a>02440     kfelast = ((<a class="code" href="../../d0/d6a/structRef.html">Ref</a> *)chain-&gt;<a class="code" href="../../d6/d85/structListBase.html#a46f89850aad8cd09b34b5bdc3aa8f91a">last</a>)-&gt;ref;
<a name="l02441"></a>02441     v2 = kfelast-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> ? kfelast-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> : kfelast-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>;
<a name="l02442"></a>02442     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(v1 != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; v2 != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02443"></a>02443     kfvprev = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> == v1 ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>;
<a name="l02444"></a>02444     <span class="keywordflow">for</span> (ref = chain-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>, i = 0; i &lt; nco &amp;&amp; ref != chain-&gt;last; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>, i++) {
<a name="l02445"></a>02445         kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02446"></a>02446         <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(kfvprev == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> || kfvprev == kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a>);
<a name="l02447"></a>02447         kfv = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a> == kfvprev ? kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#af050076a80f99ed844fcb3cd93c65c41">v2</a> : kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#abf92309a75c5ca18a856d17fe5e74c2f">v1</a>;
<a name="l02448"></a>02448         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>[i], kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l02449"></a>02449         kverts[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>] = kfv;
<a name="l02450"></a>02450         kfvprev = kfv;
<a name="l02451"></a>02451     }
<a name="l02452"></a>02452     <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(i == nco);
<a name="l02453"></a>02453     lnew = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02454"></a>02454     <span class="keywordflow">if</span> (nco == 0) {
<a name="l02455"></a>02455         <span class="comment">/* Want to prevent creating two-sided polygons */</span>
<a name="l02456"></a>02456         <span class="keywordflow">if</span> (<a class="code" href="../../d9/ddf/bmesh__queries_8c.html#ae70a3882045cb1cbe677e77e2762c630">BM_edge_exists</a>(v1, v2)) {
<a name="l02457"></a>02457             *newface = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02458"></a>02458         }
<a name="l02459"></a>02459         <span class="keywordflow">else</span> {
<a name="l02460"></a>02460             *newface = <a class="code" href="../../d4/dda/bmesh__mods_8c.html#a938b3244727ffea690ba0b33ed2b9c68" title="Face Split.">BM_face_split</a>(bm, f, v1, v2, &amp;lnew, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02461"></a>02461         }
<a name="l02462"></a>02462     }
<a name="l02463"></a>02463     <span class="keywordflow">else</span> {
<a name="l02464"></a>02464         fnew = <a class="code" href="../../d4/dda/bmesh__mods_8c.html#a7e91683d17d49df0fc7184efeeb97153" title="Face Split with intermediate points.">BM_face_split_n</a>(bm, f, v1, v2, <a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>, nco, &amp;lnew, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02465"></a>02465         *newface = fnew;
<a name="l02466"></a>02466 
<a name="l02467"></a>02467         <span class="keywordflow">if</span> (fnew) {
<a name="l02468"></a>02468             <span class="comment">/* Now go through lnew chain matching up chain kv&#39;s and assign real v&#39;s to them */</span>
<a name="l02469"></a>02469             <span class="keywordflow">for</span> (l_iter = lnew-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#af78d4a4546e654c1dcc6ebe6476ff0b0">next</a>, i = 0; i &lt; nco; l_iter = l_iter-&gt;<a class="code" href="../../d3/d41/mathutils__noise_8c.html#ac68daf2bcc2adb77f62b5dd17eb769b7">next</a>, i++) {
<a name="l02470"></a>02470                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(<a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a9dc4c60131bb140808b9c356ac956756">equals_v3v3</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>[i], l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a2da088cf339e17dafd9f5e7ee0bf3771">v</a>-&gt;<a class="code" href="../../df/d18/structBMVert.html#a69422c1e633b64cb13937a2e70a160a8">co</a>));
<a name="l02471"></a>02471                 <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acb69316f3ce3496cc1032ee14236c9cd">select_result</a>) {
<a name="l02472"></a>02472                     <a class="code" href="../../d5/def/bmesh__marking_8c.html#a36117bf878409d6e7a6025d5fc7d2c50" title="Select Edge.">BM_edge_select_set</a>(bm, l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a37f32bdf99c1763a272342a3c83b5f51">e</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02473"></a>02473                 }
<a name="l02474"></a>02474                 kverts[<a class="code" href="../../dd/db6/paraloopend_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> = l_iter-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a2da088cf339e17dafd9f5e7ee0bf3771">v</a>;
<a name="l02475"></a>02475             }
<a name="l02476"></a>02476         }
<a name="l02477"></a>02477     }
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     <span class="comment">/* the select chain above doesnt account for the first loop */</span>
<a name="l02480"></a>02480     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acb69316f3ce3496cc1032ee14236c9cd">select_result</a>) {
<a name="l02481"></a>02481         <span class="keywordflow">if</span> (lnew) {
<a name="l02482"></a>02482             <a class="code" href="../../d5/def/bmesh__marking_8c.html#a36117bf878409d6e7a6025d5fc7d2c50" title="Select Edge.">BM_edge_select_set</a>(bm, lnew-&gt;<a class="code" href="../../dc/dd5/structBMLoop.html#a37f32bdf99c1763a272342a3c83b5f51">e</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02483"></a>02483         }
<a name="l02484"></a>02484     }
<a name="l02485"></a>02485 
<a name="l02486"></a>02486     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae2c777546c0aae29f65f25b0ece92248">BLI_array_fixedstack_free</a>(<a class="code" href="../../d7/d47/NM__Scalar_8h.html#a684cb050006be28e36ea9a9817af4a91">cos</a>);
<a name="l02487"></a>02487     <a class="code" href="../../da/d6c/BLI__array_8h.html#ae2c777546c0aae29f65f25b0ece92248">BLI_array_fixedstack_free</a>(kverts);
<a name="l02488"></a>02488 }
<a name="l02489"></a>02489 
<a name="l02490"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">02490</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">knife_make_face_cuts</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f, <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *kfedges)
<a name="l02491"></a>02491 {
<a name="l02492"></a>02492     <a class="code" href="../../d7/d18/structBMesh.html">BMesh</a> *bm = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>;
<a name="l02493"></a>02493     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02494"></a>02494     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *fnew, *fnew2, *fhole;
<a name="l02495"></a>02495     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *chain, *hole, *sidechain;
<a name="l02496"></a>02496     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *fnew_kfedges, *fnew2_kfedges;
<a name="l02497"></a>02497     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref, *refnext;
<a name="l02498"></a>02498     <span class="keywordtype">int</span> count, oldcount;
<a name="l02499"></a>02499 
<a name="l02500"></a>02500     oldcount = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(kfedges);
<a name="l02501"></a>02501     <span class="keywordflow">while</span> ((chain = <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad4d11c79492a8fe1451e316c9221175c">find_chain</a>(kcd, kfedges)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02502"></a>02502         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">knife_make_chain_cut</a>(kcd, f, chain, &amp;fnew);
<a name="l02503"></a>02503         <span class="keywordflow">if</span> (!fnew) {
<a name="l02504"></a>02504             <span class="keywordflow">return</span>;
<a name="l02505"></a>02505         }
<a name="l02506"></a>02506 
<a name="l02507"></a>02507         <span class="comment">/* Move kfedges to fnew_kfedges if they are now in fnew.</span>
<a name="l02508"></a>02508 <span class="comment">         * The chain edges were removed already */</span>
<a name="l02509"></a>02509         fnew_kfedges = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02510"></a>02510         <span class="keywordflow">for</span> (ref = kfedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = refnext) {
<a name="l02511"></a>02511             kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02512"></a>02512             refnext = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>;
<a name="l02513"></a>02513             <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(kcd, kfe, fnew)) {
<a name="l02514"></a>02514                 <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(kfedges, ref);
<a name="l02515"></a>02515                 kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = fnew;
<a name="l02516"></a>02516                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, fnew_kfedges, kfe);
<a name="l02517"></a>02517             }
<a name="l02518"></a>02518         }
<a name="l02519"></a>02519         <span class="keywordflow">if</span> (fnew_kfedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l02520"></a>02520             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">knife_make_face_cuts</a>(kcd, fnew, fnew_kfedges);
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         <span class="comment">/* find_chain should always remove edges if it returns TRUE,</span>
<a name="l02523"></a>02523 <span class="comment">         * but guard against infinite loop anyway */</span>
<a name="l02524"></a>02524         count = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(kfedges);
<a name="l02525"></a>02525         <span class="keywordflow">if</span> (count &gt;= oldcount) {
<a name="l02526"></a>02526             <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;knife find_chain infinite loop&quot;</span>);
<a name="l02527"></a>02527             <span class="keywordflow">return</span>;
<a name="l02528"></a>02528         }
<a name="l02529"></a>02529         oldcount = count;
<a name="l02530"></a>02530     }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532     <span class="keywordflow">while</span> ((hole = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a31e005e931292ebeffc35ec2a5578f12">find_hole</a>(kcd, kfedges)) != <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02533"></a>02533         <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#a99e6d0c694b3b04db7e54aaf31c60818">find_hole_chains</a>(kcd, hole, f, &amp;chain, &amp;sidechain)) {
<a name="l02534"></a>02534             <span class="comment">/* chain goes across f and sidechain comes back</span>
<a name="l02535"></a>02535 <span class="comment">             * from the second last vertex to the second vertex.</span>
<a name="l02536"></a>02536 <span class="comment">             */</span>
<a name="l02537"></a>02537             <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">knife_make_chain_cut</a>(kcd, f, chain, &amp;fnew);
<a name="l02538"></a>02538             <span class="keywordflow">if</span> (!fnew) {
<a name="l02539"></a>02539                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;knife failed hole cut&quot;</span>);
<a name="l02540"></a>02540                 <span class="keywordflow">return</span>;
<a name="l02541"></a>02541             }
<a name="l02542"></a>02542             kfe = ((<a class="code" href="../../d0/d6a/structRef.html">Ref</a> *)sidechain-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)-&gt;ref;
<a name="l02543"></a>02543             <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(kcd, kfe, f)) {
<a name="l02544"></a>02544                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">knife_make_chain_cut</a>(kcd, f, sidechain, &amp;fnew2);
<a name="l02545"></a>02545                 fhole = f;
<a name="l02546"></a>02546             }
<a name="l02547"></a>02547             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(kcd, kfe, fnew)) {
<a name="l02548"></a>02548                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a5cbab34a73d9552996f19f235939b0c9">knife_make_chain_cut</a>(kcd, fnew, sidechain, &amp;fnew2);
<a name="l02549"></a>02549                 fhole = fnew2;
<a name="l02550"></a>02550             }
<a name="l02551"></a>02551             <span class="keywordflow">else</span> {
<a name="l02552"></a>02552                 <span class="comment">/* shouldn&#39;t happen except in funny edge cases */</span>
<a name="l02553"></a>02553                 <span class="keywordflow">return</span>;
<a name="l02554"></a>02554             }
<a name="l02555"></a>02555             <a class="code" href="../../d0/de5/bmesh__core_8c.html#a5f50f2e0641b6bd7c69f257430ff9d41">BM_face_kill</a>(bm, fhole);
<a name="l02556"></a>02556             <span class="comment">/* Move kfedges to either fnew or fnew2 if appropriate.</span>
<a name="l02557"></a>02557 <span class="comment">             * The hole edges were removed already */</span>
<a name="l02558"></a>02558             fnew_kfedges = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02559"></a>02559             fnew2_kfedges = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02560"></a>02560             <span class="keywordflow">for</span> (ref = kfedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = refnext) {
<a name="l02561"></a>02561                 kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02562"></a>02562                 refnext = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>;
<a name="l02563"></a>02563                 <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(kcd, kfe, fnew)) {
<a name="l02564"></a>02564                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(kfedges, ref);
<a name="l02565"></a>02565                     kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = fnew;
<a name="l02566"></a>02566                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, fnew_kfedges, kfe);
<a name="l02567"></a>02567                 }
<a name="l02568"></a>02568                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#aa9a529c267e86f958fda277700d2e7b2">knife_edge_in_face</a>(kcd, kfe, fnew2)) {
<a name="l02569"></a>02569                     <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#a1ff36f7c9cfb643553d599b91f08abea">BLI_remlink</a>(kfedges, ref);
<a name="l02570"></a>02570                     kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a> = fnew2;
<a name="l02571"></a>02571                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, fnew2_kfedges, kfe);
<a name="l02572"></a>02572                 }
<a name="l02573"></a>02573             }
<a name="l02574"></a>02574             <span class="comment">/* We&#39;ll skip knife edges that are in the newly formed hole.</span>
<a name="l02575"></a>02575 <span class="comment">             * (Maybe we shouldn&#39;t have made a hole in the first place?) */</span>
<a name="l02576"></a>02576             <span class="keywordflow">if</span> (fnew != fhole &amp;&amp; fnew_kfedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l02577"></a>02577                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">knife_make_face_cuts</a>(kcd, fnew, fnew_kfedges);
<a name="l02578"></a>02578             <span class="keywordflow">if</span> (fnew2 != fhole &amp;&amp; fnew2_kfedges-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>)
<a name="l02579"></a>02579                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">knife_make_face_cuts</a>(kcd, fnew2, fnew2_kfedges);
<a name="l02580"></a>02580             <span class="keywordflow">if</span> (f == fhole)
<a name="l02581"></a>02581                 <span class="keywordflow">break</span>;
<a name="l02582"></a>02582             <span class="comment">/* find_hole should always remove edges if it returns TRUE,</span>
<a name="l02583"></a>02583 <span class="comment">             * but guard against infinite loop anyway */</span>
<a name="l02584"></a>02584             count = <a class="code" href="../../d1/d3e/BLI__listbase_8h.html#aa3b37105a0793ac30946a6d220ee97d7">BLI_countlist</a>(kfedges);
<a name="l02585"></a>02585             <span class="keywordflow">if</span> (count &gt;= oldcount) {
<a name="l02586"></a>02586                 <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa0fb403a3d83d016acdc506b2d4607cb">BLI_assert</a>(!<span class="stringliteral">&quot;knife find_hole infinite loop&quot;</span>);
<a name="l02587"></a>02587                 <span class="keywordflow">return</span>;
<a name="l02588"></a>02588             }
<a name="l02589"></a>02589             oldcount = count;
<a name="l02590"></a>02590         }
<a name="l02591"></a>02591     }
<a name="l02592"></a>02592 }
<a name="l02593"></a>02593 
<a name="l02594"></a>02594 <span class="comment">/* Use the network of KnifeEdges and KnifeVerts accumulated to make real BMVerts and BMEdedges */</span>
<a name="l02595"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a171391415eecb67fc3988c328cb9575f">02595</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a171391415eecb67fc3988c328cb9575f">knife_make_cuts</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597     <a class="code" href="../../d7/d18/structBMesh.html">BMesh</a> *bm = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>;
<a name="l02598"></a>02598     <a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a> *kfe;
<a name="l02599"></a>02599     <a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a> *kfv;
<a name="l02600"></a>02600     <a class="code" href="../../d0/d23/structBMFace.html">BMFace</a> *f;
<a name="l02601"></a>02601     <a class="code" href="../../de/d6e/structBMEdge.html">BMEdge</a> *e, *enew;
<a name="l02602"></a>02602     <a class="code" href="../../d6/d85/structListBase.html">ListBase</a> *lst;
<a name="l02603"></a>02603     <a class="code" href="../../d0/d6a/structRef.html">Ref</a> *ref;
<a name="l02604"></a>02604     <span class="keywordtype">float</span> pct;
<a name="l02605"></a>02605     <a class="code" href="../../d3/dd3/structSmallHashIter.html">SmallHashIter</a> hiter;
<a name="l02606"></a>02606     <a class="code" href="../../db/d0e/structBLI__mempool__iter.html">BLI_mempool_iter</a> iter;
<a name="l02607"></a>02607     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> fhash_, *fhash = &amp;fhash_;
<a name="l02608"></a>02608     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> ehash_, *ehash = &amp;ehash_;
<a name="l02609"></a>02609 
<a name="l02610"></a>02610     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(fhash);
<a name="l02611"></a>02611     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(ehash);
<a name="l02612"></a>02612 
<a name="l02613"></a>02613     <span class="comment">/* put list of cutting edges for a face into fhash, keyed by face */</span>
<a name="l02614"></a>02614     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>, &amp;iter);
<a name="l02615"></a>02615     <span class="keywordflow">for</span> (kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfe; kfe = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l02616"></a>02616         f = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a270c1de278e70dce88738d5161da9675">basef</a>;
<a name="l02617"></a>02617         <span class="keywordflow">if</span> (!f || kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>)
<a name="l02618"></a>02618             <span class="keywordflow">continue</span>;
<a name="l02619"></a>02619         lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(fhash, (uintptr_t)f);
<a name="l02620"></a>02620         <span class="keywordflow">if</span> (!lst) {
<a name="l02621"></a>02621             lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02622"></a>02622             <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(fhash, (uintptr_t)f, lst);
<a name="l02623"></a>02623         }
<a name="l02624"></a>02624         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, kfe);
<a name="l02625"></a>02625     }
<a name="l02626"></a>02626 
<a name="l02627"></a>02627     <span class="comment">/* put list of splitting vertices for an edge into ehash, keyed by edge */</span>
<a name="l02628"></a>02628     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a704cdac564bc103136cfc924ecd010b2">BLI_mempool_iternew</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>, &amp;iter);
<a name="l02629"></a>02629     <span class="keywordflow">for</span> (kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter); kfv; kfv = <a class="code" href="../../db/d06/BLI__mempool_8h.html#ad1a175da22656ca74cc25ccc2c2456a3">BLI_mempool_iterstep</a>(&amp;iter)) {
<a name="l02630"></a>02630         <span class="keywordflow">if</span> (kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a>)
<a name="l02631"></a>02631             <span class="keywordflow">continue</span>;  <span class="comment">/* already have a BMVert */</span>
<a name="l02632"></a>02632         <span class="keywordflow">for</span> (ref = kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a9fb0e8b8a67bfe3019b7b76330bafb1f">edges</a>.<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02633"></a>02633             kfe = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02634"></a>02634             e = kfe-&gt;<a class="code" href="../../dd/da6/structKnifeEdge.html#a392b34a478ce60b8078d517a04526008">e</a>;
<a name="l02635"></a>02635             <span class="keywordflow">if</span> (!e)
<a name="l02636"></a>02636                 <span class="keywordflow">continue</span>;
<a name="l02637"></a>02637             lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1f86774d630d0120541671e054f1e1ce">BLI_smallhash_lookup</a>(ehash, (uintptr_t)e);
<a name="l02638"></a>02638             <span class="keywordflow">if</span> (!lst) {
<a name="l02639"></a>02639                 lst = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a3aa3fcbd8d396b0a8961366073895adc">knife_empty_list</a>(kcd);
<a name="l02640"></a>02640                 <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(ehash, (uintptr_t)e, lst);
<a name="l02641"></a>02641             }
<a name="l02642"></a>02642             <span class="comment">/* there can be more than one kfe in kfv&#39;s list with same e */</span>
<a name="l02643"></a>02643             <span class="keywordflow">if</span> (!<a class="code" href="../../da/d56/editmesh__knife_8c.html#a96cccdc0437f719466554d31e83e3d85">find_ref</a>(lst, kfv))
<a name="l02644"></a>02644                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a569a29f7a0771bf61a9e2e196787d3fe">knife_append_list</a>(kcd, lst, kfv);
<a name="l02645"></a>02645         }
<a name="l02646"></a>02646     }
<a name="l02647"></a>02647 
<a name="l02648"></a>02648     <span class="comment">/* split bmesh edges where needed */</span>
<a name="l02649"></a>02649     <span class="keywordflow">for</span> (lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1e138e23cb4b60a7fc8901341ef47046">BLI_smallhash_iternew</a>(ehash, &amp;hiter, (uintptr_t *)&amp;e); lst;
<a name="l02650"></a>02650          lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#af44fb53c68aba0159b2ec9e7bb72b027">BLI_smallhash_iternext</a>(&amp;hiter, (uintptr_t *)&amp;e))
<a name="l02651"></a>02651     {
<a name="l02652"></a>02652         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a23c003017ca9cfd682e97c264b1855d8">sort_by_frac_along</a>(lst, e);
<a name="l02653"></a>02653         <span class="keywordflow">for</span> (ref = lst-&gt;<a class="code" href="../../d6/d85/structListBase.html#ae4bd6a74f7798ff2cc2a83d3cfce60cf">first</a>; ref; ref = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a2954d5c6aa0a6a138f03047412d35a03">next</a>) {
<a name="l02654"></a>02654             kfv = ref-&gt;<a class="code" href="../../d0/d6a/structRef.html#a21fd0a3c0c79ab8cf85d023938d57603">ref</a>;
<a name="l02655"></a>02655             pct = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a29e7bf63b7514b9318ce4d7a6512cc7d">frac_along</a>(e-&gt;v1-&gt;co, e-&gt;v2-&gt;co, kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a1be4d7665161f7d2d83b291ef4dfff60">co</a>);
<a name="l02656"></a>02656             kfv-&gt;<a class="code" href="../../dd/d00/structKnifeVert.html#a4200c35dbc2ae2abaf9ffcea93ec1b9a">v</a> = <a class="code" href="../../d4/dda/bmesh__mods_8c.html#ae955ae757091f67acb8be4c27d3b5fd2" title="Edge Split.">BM_edge_split</a>(bm, e, e-&gt;v1, &amp;enew, pct);
<a name="l02657"></a>02657         }
<a name="l02658"></a>02658     }
<a name="l02659"></a>02659 
<a name="l02660"></a>02660     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#af411809755bcad679cd42ea90ba40e7e">only_select</a>) {
<a name="l02661"></a>02661         <a class="code" href="../../d5/dd6/ED__mesh_8h.html#ad41c90158b6c2ef698cb56722a5baf36">EDBM_flag_disable_all</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a16685eea158879e41b101ca3634de462a6afc5d1391fd30b47036817b139a85ed">BM_ELEM_SELECT</a>);
<a name="l02662"></a>02662     }
<a name="l02663"></a>02663 
<a name="l02664"></a>02664     <span class="comment">/* do cuts for each face */</span>
<a name="l02665"></a>02665     <span class="keywordflow">for</span> (lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a1e138e23cb4b60a7fc8901341ef47046">BLI_smallhash_iternew</a>(fhash, &amp;hiter, (uintptr_t *)&amp;f); lst;
<a name="l02666"></a>02666          lst = <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#af44fb53c68aba0159b2ec9e7bb72b027">BLI_smallhash_iternext</a>(&amp;hiter, (uintptr_t *)&amp;f))
<a name="l02667"></a>02667     {
<a name="l02668"></a>02668         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a46db289220613aa9a1e3d57f990e0040">knife_make_face_cuts</a>(kcd, f, lst);
<a name="l02669"></a>02669     }
<a name="l02670"></a>02670 
<a name="l02671"></a>02671     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(fhash);
<a name="l02672"></a>02672     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(ehash);
<a name="l02673"></a>02673 }
<a name="l02674"></a>02674 <span class="preprocessor">#endif</span>
<a name="l02675"></a>02675 <span class="preprocessor"></span>
<a name="l02676"></a>02676 <span class="comment">/* called on tool confirmation */</span>
<a name="l02677"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a079d38d237be47bf1e0e97f6d66a523b">02677</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a079d38d237be47bf1e0e97f6d66a523b">knifetool_finish</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02678"></a>02678 {
<a name="l02679"></a>02679     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02680"></a>02680 
<a name="l02681"></a>02681 <span class="preprocessor">#if SCANFILL_CUTS</span>
<a name="l02682"></a>02682 <span class="preprocessor"></span>    knifenet_fill_faces(kcd);
<a name="l02683"></a>02683 <span class="preprocessor">#else</span>
<a name="l02684"></a>02684 <span class="preprocessor"></span>    <a class="code" href="../../da/d56/editmesh__knife_8c.html#a171391415eecb67fc3988c328cb9575f">knife_make_cuts</a>(kcd);
<a name="l02685"></a>02685 <span class="preprocessor">#endif</span>
<a name="l02686"></a>02686 <span class="preprocessor"></span>
<a name="l02687"></a>02687     <a class="code" href="../../d5/dd6/ED__mesh_8h.html#a13d0b5662b3a6db159da122eaced50ab">EDBM_update_generic</a>(C, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02688"></a>02688 }
<a name="l02689"></a>02689 
<a name="l02690"></a>02690 <span class="comment">/* copied from paint_image.c */</span>
<a name="l02691"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a4f0b36ba828aaab9c912e1fd51a64776">02691</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a4f0b36ba828aaab9c912e1fd51a64776">project_knife_view_clip</a>(<a class="code" href="../../d6/deb/structView3D.html">View3D</a> *v3d, <a class="code" href="../../d9/d00/structRegionView3D.html">RegionView3D</a> *rv3d, <span class="keywordtype">float</span> *clipsta, <span class="keywordtype">float</span> *clipend)
<a name="l02692"></a>02692 {
<a name="l02693"></a>02693     <span class="keywordtype">int</span> <a class="code" href="../../d8/d33/btConvexHull_8cpp.html#afce09874f19dc3bb6d742f1f52fd8bb0">orth</a> = <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a1c3f804a2b06362e3a9704c9b932f011">ED_view3d_clip_range_get</a>(v3d, rv3d, clipsta, clipend);
<a name="l02694"></a>02694 
<a name="l02695"></a>02695     <span class="keywordflow">if</span> (orth) { <span class="comment">/* only needed for ortho */</span>
<a name="l02696"></a>02696         <span class="keywordtype">float</span> fac = 2.0f / ((*clipend) - (*clipsta));
<a name="l02697"></a>02697         *clipsta *= fac;
<a name="l02698"></a>02698         *clipend *= fac;
<a name="l02699"></a>02699     }
<a name="l02700"></a>02700 
<a name="l02701"></a>02701     <span class="keywordflow">return</span> <a class="code" href="../../d8/d33/btConvexHull_8cpp.html#afce09874f19dc3bb6d742f1f52fd8bb0">orth</a>;
<a name="l02702"></a>02702 }
<a name="l02703"></a>02703 
<a name="l02704"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">02704</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd)
<a name="l02705"></a>02705 {
<a name="l02706"></a>02706     <a class="code" href="../../d3/d8c/BLI__math__matrix_8h.html#aab557e66ccdc3534593b413d9b2d7fe8">invert_m4_m4</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#a65d360837f87824d49ed08caf44dccb3">imat</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>-&gt;<a class="code" href="../../de/de7/structObject.html#aa29519ce424b73cbb5a638814f1080ea">obmat</a>);
<a name="l02707"></a>02707     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#a282c83136349eb4ba6c6dfb330a14440">ED_view3d_ob_project_mat_get</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#a1b743d806cf5169fd929df96d1133ba4">regiondata</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a370e64b78642a37ea23a8a79f5ae6afa">projmat</a>);
<a name="l02708"></a>02708     <span class="comment">//mult_m4_m4m4(kcd-&gt;projmat, kcd-&gt;vc.rv3d-&gt;winmat, kcd-&gt;vc.rv3d-&gt;viewmat);</span>
<a name="l02709"></a>02709 
<a name="l02710"></a>02710     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#af2bccd7313ce663b9c7bcffa309009ab">is_ortho</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a4f0b36ba828aaab9c912e1fd51a64776">project_knife_view_clip</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ac33fdbda0e0b759a8f12a889216d6945">v3d</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#ae849219034a130d5a58b5164ab8fc960">rv3d</a>, 
<a name="l02711"></a>02711                                             &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc1aef5a999723dfd69a1257fa565cc2">clipsta</a>, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a26539ec6c0d5b6227f0146c839f09089">clipend</a>);
<a name="l02712"></a>02712 }
<a name="l02713"></a>02713 
<a name="l02714"></a>02714 <span class="comment">/* called when modal loop selection is done... */</span>
<a name="l02715"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">02715</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">knifetool_exit</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02716"></a>02716 {
<a name="l02717"></a>02717     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02718"></a>02718 
<a name="l02719"></a>02719     <span class="keywordflow">if</span> (!kcd)
<a name="l02720"></a>02720         <span class="keywordflow">return</span>;
<a name="l02721"></a>02721 
<a name="l02722"></a>02722     <a class="code" href="../../de/d3c/wm__cursors_8c.html#ab8500ccfbffb6b57f4e0645e0f9a4759">WM_cursor_restore</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C));
<a name="l02723"></a>02723 
<a name="l02724"></a>02724     <span class="comment">/* deactivate the extra drawing stuff in 3D-View */</span>
<a name="l02725"></a>02725     <a class="code" href="../../d0/d5f/ED__space__api_8h.html#af2341642ec2a46070cd7b0be6a6e716a">ED_region_draw_cb_exit</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ae957cd551d82034b24008cfb99bbc4c7">type</a>, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc7f2ceec86376f5901fc9e6e9b24d6d">draw_handle</a>);
<a name="l02726"></a>02726 
<a name="l02727"></a>02727     <span class="comment">/* free the custom data */</span>
<a name="l02728"></a>02728     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a8821edfd256d754d35f1b191dc6d7326">BLI_mempool_destroy</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a438b9dd84adc21b3abfb42d523047209">refs</a>);
<a name="l02729"></a>02729     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a8821edfd256d754d35f1b191dc6d7326">BLI_mempool_destroy</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a>);
<a name="l02730"></a>02730     <a class="code" href="../../db/d06/BLI__mempool_8h.html#a8821edfd256d754d35f1b191dc6d7326">BLI_mempool_destroy</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a>);
<a name="l02731"></a>02731 
<a name="l02732"></a>02732     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">origedgemap</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02733"></a>02733     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">origvertmap</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02734"></a>02734     <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#adc20ede3cd08276d25c11f2d02768119">BLI_ghash_free</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">kedgefacemap</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02735"></a>02735 
<a name="l02736"></a>02736     <a class="code" href="../../d4/d90/editmesh__bvh_8c.html#abd50e6411b00a38414d8401d9d0fbdde">BMBVH_FreeBVH</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a>);
<a name="l02737"></a>02737     <a class="code" href="../../da/db3/BLI__memarena_8h.html#aba9ba7aed302a78a188f9e4e69d02f07">BLI_memarena_free</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a>);
<a name="l02738"></a>02738 
<a name="l02739"></a>02739     <span class="comment">/* tag for redraw */</span>
<a name="l02740"></a>02740     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02741"></a>02741 
<a name="l02742"></a>02742     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a>)
<a name="l02743"></a>02743         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a>);
<a name="l02744"></a>02744 
<a name="l02745"></a>02745     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>)
<a name="l02746"></a>02746         <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ae8bedd9a128f8c0afcb6dcc0f3327d6d">linehits</a>);
<a name="l02747"></a>02747 
<a name="l02748"></a>02748     <span class="comment">/* destroy kcd itself */</span>
<a name="l02749"></a>02749     <a class="code" href="../../da/d2b/mallocn_8c.html#aebca1f40b6b3b5815677a99dc56670d9">MEM_freeN</a>(kcd);
<a name="l02750"></a>02750     op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02751"></a>02751 }
<a name="l02752"></a>02752 
<a name="l02753"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ab5dec2c9538ad52e5f1e0055326dff91">02753</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ab5dec2c9538ad52e5f1e0055326dff91">cage_mapped_verts_callback</a>(<span class="keywordtype">void</span> *userData, <span class="keywordtype">int</span> index, <span class="keyword">const</span> <span class="keywordtype">float</span> co[3],
<a name="l02754"></a>02754                                        <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(no_f[3]), <span class="keyword">const</span> <span class="keywordtype">short</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(no_s[3]))
<a name="l02755"></a>02755 {
<a name="l02756"></a>02756     <span class="keywordtype">void</span> **<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a> = userData;
<a name="l02757"></a>02757     <a class="code" href="../../d5/de5/structBMEditMesh.html">BMEditMesh</a> *em = data[0];
<a name="l02758"></a>02758     float (*cagecos)[3] = data[1];
<a name="l02759"></a>02759     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> *hash = data[2];
<a name="l02760"></a>02760 
<a name="l02761"></a>02761     <span class="keywordflow">if</span> (index &gt;= 0 &amp;&amp; index &lt; em-&gt;bm-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a> &amp;&amp; !<a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a2f3abe3f63e4d2bb67ca9546d2bb2b34">BLI_smallhash_haskey</a>(hash, index)) {
<a name="l02762"></a>02762         <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#a7653b1eabbbd01be256a007a7e410147">BLI_smallhash_insert</a>(hash, index, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02763"></a>02763         <a class="code" href="../../d3/d86/BLI__math__vector_8h.html#a6cf5ea9576bb2186e5c71a02480875eb">copy_v3_v3</a>(cagecos[index], co);
<a name="l02764"></a>02764     }
<a name="l02765"></a>02765 }
<a name="l02766"></a>02766 
<a name="l02767"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a02fd2e622c53102324b991dbc6991933">02767</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a02fd2e622c53102324b991dbc6991933">knifetool_update_mval</a>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd, <span class="keywordtype">int</span> mval[2])
<a name="l02768"></a>02768 {
<a name="l02769"></a>02769     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(kcd);
<a name="l02770"></a>02770     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[0] = mval[0];
<a name="l02771"></a>02771     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>.<a class="code" href="../../d8/d30/structViewContext.html#a23107ec174c1a4f792bd8127477a18ec">mval</a>[1] = mval[1];
<a name="l02772"></a>02772 
<a name="l02773"></a>02773     <span class="keywordflow">if</span> (<a class="code" href="../../da/d56/editmesh__knife_8c.html#abf1fa25540992f57354721c19524c63f">knife_update_active</a>(kcd)) {
<a name="l02774"></a>02774         <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02775"></a>02775     }
<a name="l02776"></a>02776 }
<a name="l02777"></a>02777 
<a name="l02778"></a>02778 <span class="comment">/* called when modal loop selection gets set up... */</span>
<a name="l02779"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#ad28cab0acc9fc8094e65935e2c247866">02779</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#ad28cab0acc9fc8094e65935e2c247866">knifetool_init</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <span class="keywordtype">int</span> <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#a86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(do_cut))
<a name="l02780"></a>02780 {
<a name="l02781"></a>02781     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd;
<a name="l02782"></a>02782     <a class="code" href="../../d9/d27/structScene.html">Scene</a> *scene = <a class="code" href="../../df/d01/BKE__context_8h.html#a0bcac8ad3452a040293c01084665a258">CTX_data_scene</a>(C);
<a name="l02783"></a>02783     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02784"></a>02784     <a class="code" href="../../d5/d6c/structDerivedMesh.html">DerivedMesh</a> *cage, *<span class="keyword">final</span>;
<a name="l02785"></a>02785     <a class="code" href="../../dc/d55/structSmallHash.html">SmallHash</a> shash;
<a name="l02786"></a>02786     <span class="keywordtype">void</span> *<a class="code" href="../../d2/d3a/AUD__JOSResampleReader_8cpp.html#a511ae0b1c13f95e5f08f1a0dd3da3d93">data</a>[3];
<a name="l02787"></a>02787     <span class="keyword">const</span> <span class="keywordtype">short</span> only_select = <a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;only_select&quot;</span>);
<a name="l02788"></a>02788 
<a name="l02789"></a>02789     <span class="comment">/* alloc new customdata */</span>
<a name="l02790"></a>02790     kcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a>), <span class="stringliteral">&quot;knifetool Modal Op Data&quot;</span>);
<a name="l02791"></a>02791 
<a name="l02792"></a>02792     <span class="comment">/* assign the drawing handle for drawing preview line... */</span>
<a name="l02793"></a>02793     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a> = obedit;
<a name="l02794"></a>02794     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a> = <a class="code" href="../../df/d01/BKE__context_8h.html#acfdde96de6c66805749111818756b92f">CTX_wm_region</a>(C);
<a name="l02795"></a>02795     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acc7f2ceec86376f5901fc9e6e9b24d6d">draw_handle</a> = <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a48864a13f19218cbd1ff98b7fe9eb958">ED_region_draw_cb_activate</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>-&gt;<a class="code" href="../../da/d23/structARegion.html#ae957cd551d82034b24008cfb99bbc4c7">type</a>, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6bbaeb918152f722e4e0cdbbf630c48b">knifetool_draw</a>, kcd, <a class="code" href="../../d0/d5f/ED__space__api_8h.html#a3e6b57328ed92de959be772232b63718">REGION_DRAW_POST_VIEW</a>);
<a name="l02796"></a>02796     <a class="code" href="../../d7/dc0/editmesh__select_8c.html#a23a15b03b570d870fde800400a009714">em_setup_viewcontext</a>(C, &amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ada60bf3176aba542eaebebfd03bae11f">vc</a>);
<a name="l02797"></a>02797 
<a name="l02798"></a>02798     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a> = <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#add0a42984738b12c02c4cdf141bff67e">ob</a>);
<a name="l02799"></a>02799 
<a name="l02800"></a>02800     <a class="code" href="../../d5/db9/bmesh__mesh_8c.html#af3c1d0fa5b86a3ce17293fff3d2d0fcd">BM_mesh_elem_index_ensure</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>, <a class="code" href="../../d1/d77/bmesh__class_8h.html#a77867ab4129f63159b37bca3b652a798a69729bc1555e82d32291f917fcb7350c">BM_VERT</a>);
<a name="l02801"></a>02801 
<a name="l02802"></a>02802     cage = <a class="code" href="../../d0/d7f/BKE__DerivedMesh_8h.html#a6173b8466ecd4cd5c46176550ff7867c">editbmesh_get_derived_cage_and_final</a>(scene, obedit, kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>, &amp;<span class="keyword">final</span>, <a class="code" href="../../d5/d5e/BKE__customdata_8h.html#a6dea47cb1a0bed3c19f17f357be5604c">CD_MASK_DERIVEDMESH</a>);
<a name="l02803"></a>02803     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a> = <a class="code" href="../../da/d2b/mallocn_8c.html#ab1235f6c94203e95da6076dbeb355894">MEM_callocN</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a5b91780fbab0c3a8834609b21acde933">bm</a>-&gt;<a class="code" href="../../d7/d18/structBMesh.html#a003a55069d35eec157e4dfb5a0d78165">totvert</a>, <span class="stringliteral">&quot;knife cagecos&quot;</span>);
<a name="l02804"></a>02804     data[0] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>;
<a name="l02805"></a>02805     data[1] = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab558617f5a8107bce17b0ced88104ebf">cagecos</a>;
<a name="l02806"></a>02806     data[2] = &amp;shash;
<a name="l02807"></a>02807 
<a name="l02808"></a>02808     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#adb506e86ea88d91f7aa829eebe582a21">BLI_smallhash_init</a>(&amp;shash);
<a name="l02809"></a>02809     cage-&gt;<a class="code" href="../../d5/d6c/structDerivedMesh.html#a14c8a2dc23a8af0e7aaf2190f7cf0202">foreachMappedVert</a>(cage, <a class="code" href="../../da/d56/editmesh__knife_8c.html#ab5dec2c9538ad52e5f1e0055326dff91">cage_mapped_verts_callback</a>, data);
<a name="l02810"></a>02810     <a class="code" href="../../db/d1a/BLI__smallhash_8h.html#ab728193f2b04960d5cc53bc255d59193">BLI_smallhash_release</a>(&amp;shash);
<a name="l02811"></a>02811 
<a name="l02812"></a>02812     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a322185890724132c6baf6713df3443f4">bmbvh</a> = <a class="code" href="../../d4/d90/editmesh__bvh_8c.html#a48e8437ae244ebfcff2902ddf6b4dcd4">BMBVH_NewBVH</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>,
<a name="l02813"></a>02813                               (<a class="code" href="../../df/d93/editmesh__bvh_8h.html#a84fe57ba52f8e237004a413b27ea4db8aa2784e88ac590ab6578da571dbc0ef43">BMBVH_USE_CAGE</a> | <a class="code" href="../../df/d93/editmesh__bvh_8h.html#a84fe57ba52f8e237004a413b27ea4db8a35dbc6eddce62fdb33d138d011089365">BMBVH_RETURN_ORIG</a>) |
<a name="l02814"></a>02814                               (only_select ? <a class="code" href="../../df/d93/editmesh__bvh_8h.html#a84fe57ba52f8e237004a413b27ea4db8ac347f90b335e3a1b853872d471ffffc1">BMBVH_RESPECT_SELECT</a> : <a class="code" href="../../df/d93/editmesh__bvh_8h.html#a84fe57ba52f8e237004a413b27ea4db8a8d34230e45e761ef1957dcdea475be44">BMBVH_RESPECT_HIDDEN</a>),
<a name="l02815"></a>02815                               scene, obedit);
<a name="l02816"></a>02816 
<a name="l02817"></a>02817     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a889db55ad844d4b974a08663fd3cfe3c">arena</a> = <a class="code" href="../../da/db3/BLI__memarena_8h.html#a05e313ed9d54546be2dac6a91a0d883d">BLI_memarena_new</a>(1 &lt;&lt; 15, <span class="stringliteral">&quot;knife&quot;</span>);
<a name="l02818"></a>02818     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#aa2a80cfd7974f50275a907e280db1da6">vthresh</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#acedd74fd65317c2f1d8e5e614b8a61bd">KMAXDIST</a> - 1;
<a name="l02819"></a>02819     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ab8c0ee33c70b2f6cd790d9e1cd1bff82">ethresh</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#acedd74fd65317c2f1d8e5e614b8a61bd">KMAXDIST</a>;
<a name="l02820"></a>02820 
<a name="l02821"></a>02821     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a99343aed49fc475df5f59f67b370d351">extend</a> = 1;
<a name="l02822"></a>02822 
<a name="l02823"></a>02823     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(kcd);
<a name="l02824"></a>02824 
<a name="l02825"></a>02825     <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02826"></a>02826 
<a name="l02827"></a>02827     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a438b9dd84adc21b3abfb42d523047209">refs</a> = <a class="code" href="../../db/d06/BLI__mempool_8h.html#a245232b94e98905756d49335b505f4ed">BLI_mempool_create</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6a/structRef.html">Ref</a>), 1, 2048, 0);
<a name="l02828"></a>02828     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a7be5662f01937b1e7ae9be3582da4716">kverts</a> = <a class="code" href="../../db/d06/BLI__mempool_8h.html#a245232b94e98905756d49335b505f4ed">BLI_mempool_create</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/d00/structKnifeVert.html">KnifeVert</a>), 1, 512, <a class="code" href="../../db/d06/BLI__mempool_8h.html#ab48899087cc647f0f791ed0c459adc53a1a1c2fafa50c632f2b06dfe357c8c5dc">BLI_MEMPOOL_ALLOW_ITER</a>);
<a name="l02829"></a>02829     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac045330cf0d5a92395a8aef3772c24d0">kedges</a> = <a class="code" href="../../db/d06/BLI__mempool_8h.html#a245232b94e98905756d49335b505f4ed">BLI_mempool_create</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../dd/da6/structKnifeEdge.html">KnifeEdge</a>), 1, 512, <a class="code" href="../../db/d06/BLI__mempool_8h.html#ab48899087cc647f0f791ed0c459adc53a1a1c2fafa50c632f2b06dfe357c8c5dc">BLI_MEMPOOL_ALLOW_ITER</a>);
<a name="l02830"></a>02830 
<a name="l02831"></a>02831     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ad7b454643c9bea3a82450a0745502fab">origedgemap</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;knife origedgemap&quot;</span>);
<a name="l02832"></a>02832     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a57f01d9886d0e2283b9f572ef73aa089">origvertmap</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;knife origvertmap&quot;</span>);
<a name="l02833"></a>02833     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a90e4e55728a612ad7491fbc0a89bb29a">kedgefacemap</a> = <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#af2fb34af7b99547b33a34380451a963d">BLI_ghash_new</a>(<a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a371913beecfb01de3d0a8d5f0bb598d4">BLI_ghashutil_ptrhash</a>, <a class="code" href="../../d7/dc5/BLI__ghash_8h.html#a51865a4bfcfc2502e01a9369bfb72877">BLI_ghashutil_ptrcmp</a>, <span class="stringliteral">&quot;knife origvertmap&quot;</span>);
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     <span class="comment">/* cut all the way through the mesh if use_occlude_geometry button not pushed */</span>
<a name="l02836"></a>02836     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a> = !<a class="code" href="../../d3/d10/rna__access_8c.html#a3a81efded6e2e77b384a5d7db179d4b9">RNA_boolean_get</a>(op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#ab29f54bc949a386e57fa0211637bbbbe">ptr</a>, <span class="stringliteral">&quot;use_occlude_geometry&quot;</span>);
<a name="l02837"></a>02837     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#af411809755bcad679cd42ea90ba40e7e">only_select</a> = only_select;
<a name="l02838"></a>02838 
<a name="l02839"></a>02839     <span class="comment">/* can&#39;t usefully select resulting edges in face mode */</span>
<a name="l02840"></a>02840     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#acb69316f3ce3496cc1032ee14236c9cd">select_result</a> = (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>-&gt;<a class="code" href="../../d5/de5/structBMEditMesh.html#a4ead55e843584fbde374a460c7d0cba8">selectmode</a> != <a class="code" href="../../d4/db3/DNA__scene__types_8h.html#a616adf2bfd4117c15663a28e464a5100">SCE_SELECT_FACE</a>);
<a name="l02841"></a>02841 
<a name="l02842"></a>02842     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a95dafbb5e2844f0b86fbc8e39ba8fcc7">knife_pos_data_clear</a>(&amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4fd2efd8c046ac35813516bbd6a0f2fa">cur</a>);
<a name="l02843"></a>02843     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a95dafbb5e2844f0b86fbc8e39ba8fcc7">knife_pos_data_clear</a>(&amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a50adf6517b905f72ac89f4d98c4a53ac">prev</a>);
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     <a class="code" href="../../da/d56/editmesh__knife_8c.html#afb9b4e7f90c57d4163f685d143829654">knife_init_colors</a>(&amp;kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac6a2390c4c1aaf893c01103b5052d050">colors</a>);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847     <span class="keywordflow">return</span> 1;
<a name="l02848"></a>02848 }
<a name="l02849"></a>02849 
<a name="l02850"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a7b9778c849404803114a36890a0538d1">02850</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7b9778c849404803114a36890a0538d1">knifetool_cancel</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op)
<a name="l02851"></a>02851 {
<a name="l02852"></a>02852     <span class="comment">/* this is just a wrapper around exit() */</span>
<a name="l02853"></a>02853     <a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">knifetool_exit</a>(C, op);
<a name="l02854"></a>02854     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02855"></a>02855 }
<a name="l02856"></a>02856 
<a name="l02857"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a12575ef2b9b1bea45535b7bb93aa31fb">02857</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a12575ef2b9b1bea45535b7bb93aa31fb">knifetool_invoke</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *evt)
<a name="l02858"></a>02858 {
<a name="l02859"></a>02859     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd;
<a name="l02860"></a>02860 
<a name="l02861"></a>02861     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l02862"></a>02862 
<a name="l02863"></a>02863     <span class="keywordflow">if</span> (!<a class="code" href="../../da/d56/editmesh__knife_8c.html#ad28cab0acc9fc8094e65935e2c247866">knifetool_init</a>(C, op, 0))
<a name="l02864"></a>02864         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02865"></a>02865 
<a name="l02866"></a>02866     <span class="comment">/* add a modal handler for this operator - handles loop selection */</span>
<a name="l02867"></a>02867     <a class="code" href="../../de/d3c/wm__cursors_8c.html#a04d16b0d6c38bc563f9d78f47f1ba7ed">WM_cursor_modal</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#af86d2cf919d95eaefc99c2c3e553057e">CTX_wm_window</a>(C), <a class="code" href="../../db/da6/wm__cursors_8h.html#a737c1bdca78a4eec48fa026fcca3dd9ba7f8faa1caf5643f093157898591ccb6d">BC_KNIFECURSOR</a>);
<a name="l02868"></a>02868     <a class="code" href="../../df/db0/wm__event__system_8c.html#ab89ad80681bbec4a06930903ea043251">WM_event_add_modal_handler</a>(C, op);
<a name="l02869"></a>02869 
<a name="l02870"></a>02870     kcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02871"></a>02871     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a02fd2e622c53102324b991dbc6991933">knifetool_update_mval</a>(kcd, evt-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>);
<a name="l02872"></a>02872 
<a name="l02873"></a>02873     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l02874"></a>02874 
<a name="l02875"></a>02875     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l02876"></a>02876 }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878 <span class="keyword">enum</span> {
<a name="l02879"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">02879</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">KNF_MODAL_CANCEL</a> = 1,
<a name="l02880"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">02880</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>,
<a name="l02881"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">02881</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">KNF_MODAL_MIDPOINT_ON</a>,
<a name="l02882"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">02882</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">KNF_MODAL_MIDPOINT_OFF</a>,
<a name="l02883"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a741c38b39148b2adbea92da802883afa">02883</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a741c38b39148b2adbea92da802883afa">KNF_MODAL_NEW_CUT</a>,
<a name="l02884"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">02884</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">KNF_MODEL_IGNORE_SNAP_ON</a>,
<a name="l02885"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">02885</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">KNF_MODEL_IGNORE_SNAP_OFF</a>,
<a name="l02886"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ab2f7e824b9ad6234c69fcdf61c3de9eb">02886</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ab2f7e824b9ad6234c69fcdf61c3de9eb">KNF_MODAL_ADD_CUT</a>,
<a name="l02887"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a74ed653755bb4f81ffe1f48470999578">02887</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a74ed653755bb4f81ffe1f48470999578">KNF_MODAL_ANGLE_SNAP_TOGGLE</a>,
<a name="l02888"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ae9769f948fb02cf10682e2372d60aa27">02888</a>     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ae9769f948fb02cf10682e2372d60aa27">KNF_MODAL_CUT_THROUGH_TOGGLE</a>
<a name="l02889"></a>02889 };
<a name="l02890"></a>02890 
<a name="l02891"></a><a class="code" href="../../d3/d5c/mesh__intern_8h.html#a7a04174558f3d1358bc715a317bb7403">02891</a> <a class="code" href="../../d3/d90/structwmKeyMap.html">wmKeyMap</a> *<a class="code" href="../../da/d56/editmesh__knife_8c.html#a507257e2330a4cfcf4113679878a8b58">knifetool_modal_keymap</a>(<a class="code" href="../../d3/df7/structwmKeyConfig.html">wmKeyConfig</a> *keyconf)
<a name="l02892"></a>02892 {
<a name="l02893"></a>02893     <span class="keyword">static</span> <a class="code" href="../../d1/d8a/structEnumPropertyItem.html">EnumPropertyItem</a> modal_items[] = {
<a name="l02894"></a>02894         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">KNF_MODAL_CANCEL</a>, <span class="stringliteral">&quot;CANCEL&quot;</span>, 0, <span class="stringliteral">&quot;Cancel&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02895"></a>02895         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>, <span class="stringliteral">&quot;CONFIRM&quot;</span>, 0, <span class="stringliteral">&quot;Confirm&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02896"></a>02896         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">KNF_MODAL_MIDPOINT_ON</a>, <span class="stringliteral">&quot;SNAP_MIDPOINTS_ON&quot;</span>, 0, <span class="stringliteral">&quot;Snap To Midpoints On&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02897"></a>02897         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">KNF_MODAL_MIDPOINT_OFF</a>, <span class="stringliteral">&quot;SNAP_MIDPOINTS_OFF&quot;</span>, 0, <span class="stringliteral">&quot;Snap To Midpoints Off&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02898"></a>02898         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">KNF_MODEL_IGNORE_SNAP_ON</a>, <span class="stringliteral">&quot;IGNORE_SNAP_ON&quot;</span>, 0, <span class="stringliteral">&quot;Ignore Snapping On&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02899"></a>02899         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">KNF_MODEL_IGNORE_SNAP_OFF</a>, <span class="stringliteral">&quot;IGNORE_SNAP_OFF&quot;</span>, 0, <span class="stringliteral">&quot;Ignore Snapping Off&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02900"></a>02900         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a74ed653755bb4f81ffe1f48470999578">KNF_MODAL_ANGLE_SNAP_TOGGLE</a>, <span class="stringliteral">&quot;ANGLE_SNAP_TOGGLE&quot;</span>, 0, <span class="stringliteral">&quot;Toggle Angle Snapping&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02901"></a>02901         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ae9769f948fb02cf10682e2372d60aa27">KNF_MODAL_CUT_THROUGH_TOGGLE</a>, <span class="stringliteral">&quot;CUT_THROUGH_TOGGLE&quot;</span>, 0, <span class="stringliteral">&quot;Toggle Cut Through&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02902"></a>02902         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a741c38b39148b2adbea92da802883afa">KNF_MODAL_NEW_CUT</a>, <span class="stringliteral">&quot;NEW_CUT&quot;</span>, 0, <span class="stringliteral">&quot;End Current Cut&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02903"></a>02903         {<a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ab2f7e824b9ad6234c69fcdf61c3de9eb">KNF_MODAL_ADD_CUT</a>, <span class="stringliteral">&quot;ADD_CUT&quot;</span>, 0, <span class="stringliteral">&quot;Add Cut&quot;</span>, <span class="stringliteral">&quot;&quot;</span>},
<a name="l02904"></a>02904         {0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, NULL}};
<a name="l02905"></a>02905 
<a name="l02906"></a>02906     <a class="code" href="../../d3/d90/structwmKeyMap.html">wmKeyMap</a> *keymap = <a class="code" href="../../d7/d78/wm__keymap_8c.html#a6d008f32aa2e883408e43ea060d7b87c">WM_modalkeymap_get</a>(keyconf, <span class="stringliteral">&quot;Knife Tool Modal Map&quot;</span>);
<a name="l02907"></a>02907 
<a name="l02908"></a>02908     <span class="comment">/* this function is called for each spacetype, only needs to add map once */</span>
<a name="l02909"></a>02909     <span class="keywordflow">if</span> (keymap &amp;&amp; keymap-&gt;<a class="code" href="../../d3/d90/structwmKeyMap.html#a57f97680d51c38bebb32d9dd4a546fd4">modal_items</a>)
<a name="l02910"></a>02910         <span class="keywordflow">return</span> <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02911"></a>02911 
<a name="l02912"></a>02912     keymap = <a class="code" href="../../d7/d78/wm__keymap_8c.html#aba987a8051ff9224f3793af46ad80ef0">WM_modalkeymap_add</a>(keyconf, <span class="stringliteral">&quot;Knife Tool Modal Map&quot;</span>, modal_items);
<a name="l02913"></a>02913 
<a name="l02914"></a>02914     <span class="comment">/* items for modal map */</span>
<a name="l02915"></a>02915     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#abe3de76b73fb856d283d4da41ad109e8">ESCKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">KNF_MODAL_CANCEL</a>);
<a name="l02916"></a>02916     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae726b291aecab43654d1ac45b9e4d57d">LEFTMOUSE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ab2f7e824b9ad6234c69fcdf61c3de9eb">KNF_MODAL_ADD_CUT</a>);
<a name="l02917"></a>02917     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#adc87b609a6285a24e23172a90734044c">RIGHTMOUSE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">KNF_MODAL_CANCEL</a>);
<a name="l02918"></a>02918     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a6c861c5ebabe8fe076ed84a2aaa7a1a0">RETKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>);
<a name="l02919"></a>02919     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#aafdc675e684c8485e8e27c7f2bafcbef">PADENTER</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>);
<a name="l02920"></a>02920     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a59b43db62ffa0d14bb076092d862d2cd">SPACEKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>);
<a name="l02921"></a>02921     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#ab47f5c869dbeec85e5e133760db3e0d5">EKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, 0, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a741c38b39148b2adbea92da802883afa">KNF_MODAL_NEW_CUT</a>);
<a name="l02922"></a>02922 
<a name="l02923"></a>02923     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#ad025960542c5698bad7efc649c641897">LEFTCTRLKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">KNF_MODAL_MIDPOINT_ON</a>);
<a name="l02924"></a>02924     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#ad025960542c5698bad7efc649c641897">LEFTCTRLKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">KNF_MODAL_MIDPOINT_OFF</a>);
<a name="l02925"></a>02925     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#aacc3c8c5f05ebb7eeca8e4da6dc9c969">RIGHTCTRLKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">KNF_MODAL_MIDPOINT_ON</a>);
<a name="l02926"></a>02926     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#aacc3c8c5f05ebb7eeca8e4da6dc9c969">RIGHTCTRLKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">KNF_MODAL_MIDPOINT_OFF</a>);
<a name="l02927"></a>02927 
<a name="l02928"></a>02928     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a8bb00d0e3bbc5c558edcef2b6c7d549c">LEFTSHIFTKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">KNF_MODEL_IGNORE_SNAP_ON</a>);
<a name="l02929"></a>02929     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a8bb00d0e3bbc5c558edcef2b6c7d549c">LEFTSHIFTKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">KNF_MODEL_IGNORE_SNAP_OFF</a>);
<a name="l02930"></a>02930     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a60ddce316227eaa9586286cca0e085f5">RIGHTSHIFTKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">KNF_MODEL_IGNORE_SNAP_ON</a>);
<a name="l02931"></a>02931     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a60ddce316227eaa9586286cca0e085f5">RIGHTSHIFTKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a3d6df9a8fc4231a9444e40c95043109f">KM_ANY</a>, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">KNF_MODEL_IGNORE_SNAP_OFF</a>);
<a name="l02932"></a>02932 
<a name="l02933"></a>02933     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a39f146afd78004fead59358c29028292">CKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, 0, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a74ed653755bb4f81ffe1f48470999578">KNF_MODAL_ANGLE_SNAP_TOGGLE</a>);
<a name="l02934"></a>02934     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a2f9326009327f701d94d0056c11848d7">WM_modalkeymap_add_item</a>(keymap, <a class="code" href="../../d1/d40/wm__event__types_8h.html#a5387e52eccf782cebe3b5eb2ca7655e1">ZKEY</a>, <a class="code" href="../../d4/ddc/WM__types_8h.html#a8cc410005d9d1dacfe81cdffb6388d09">KM_PRESS</a>, 0, 0, <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ae9769f948fb02cf10682e2372d60aa27">KNF_MODAL_CUT_THROUGH_TOGGLE</a>);
<a name="l02935"></a>02935 
<a name="l02936"></a>02936     <a class="code" href="../../d7/d78/wm__keymap_8c.html#a52b3b3b2eb2b660abd0cb8d58acb232b">WM_modalkeymap_assign</a>(keymap, <span class="stringliteral">&quot;MESH_OT_knife_tool&quot;</span>);
<a name="l02937"></a>02937 
<a name="l02938"></a>02938     <span class="keywordflow">return</span> keymap;
<a name="l02939"></a>02939 }
<a name="l02940"></a>02940 
<a name="l02941"></a><a class="code" href="../../da/d56/editmesh__knife_8c.html#a8e258f858ffb474203de7d267d5e23d8">02941</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8e258f858ffb474203de7d267d5e23d8">knifetool_modal</a>(<a class="code" href="../../d5/df1/structbContext.html">bContext</a> *C, <a class="code" href="../../d3/d19/structwmOperator.html">wmOperator</a> *op, <a class="code" href="../../d5/d6c/structwmEvent.html">wmEvent</a> *event)
<a name="l02942"></a>02942 {
<a name="l02943"></a>02943     <a class="code" href="../../de/de7/structObject.html">Object</a> *obedit;
<a name="l02944"></a>02944     <a class="code" href="../../da/d09/structKnifeTool__OpData.html">KnifeTool_OpData</a> *kcd = op-&gt;<a class="code" href="../../d3/d19/structwmOperator.html#a5202237a336c7d3a03fc25f4c87b26d1">customdata</a>;
<a name="l02945"></a>02945 
<a name="l02946"></a>02946     <span class="keywordflow">if</span> (!C) {
<a name="l02947"></a>02947         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02948"></a>02948     }
<a name="l02949"></a>02949 
<a name="l02950"></a>02950     obedit = <a class="code" href="../../df/d01/BKE__context_8h.html#a323e283348470c038f3dd98de298a76b">CTX_data_edit_object</a>(C);
<a name="l02951"></a>02951     <span class="keywordflow">if</span> (!obedit || obedit-&gt;<a class="code" href="../../de/de7/structObject.html#a8137cf4265bcaaf2fc7c91a9ccd8e4f4">type</a> != <a class="code" href="../../d9/dd9/DNA__object__types_8h.html#a8359f8b129e965da60eca2cbcec21bfc">OB_MESH</a> || <a class="code" href="../../d6/dc7/BKE__tessmesh_8h.html#a4d9806c4d2c9d7777ae1619839d6baed" title="Return the BMEditMesh for a given object.">BMEdit_FromObject</a>(obedit) != kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a66ce226c44e543f8d043d2c719589a25">em</a>) {
<a name="l02952"></a>02952         <a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">knifetool_exit</a>(C, op);
<a name="l02953"></a>02953         <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02954"></a>02954         <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02955"></a>02955     }
<a name="l02956"></a>02956 
<a name="l02957"></a>02957     <a class="code" href="../../d8/d6a/ED__view3d_8h.html#ad4e74149dc97fd5cdb1c124ecafd8eec">view3d_operator_needs_opengl</a>(C);
<a name="l02958"></a>02958 
<a name="l02959"></a>02959     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> == MODE_PANNING)
<a name="l02960"></a>02960         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a2b421c67f552a005e6cc2a8f2420ba19">prevmode</a>;
<a name="l02961"></a>02961 
<a name="l02962"></a>02962     <span class="comment">/* handle modal keymap */</span>
<a name="l02963"></a>02963     <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a> == <a class="code" href="../../d1/d40/wm__event__types_8h.html#a5ec351ea2051b0b75965a8ad0a7b4a6c">EVT_MODAL_MAP</a>) {
<a name="l02964"></a>02964         <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a4ce6386082cecfa0645ced2216d04172">val</a>) {
<a name="l02965"></a>02965             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a09f2d211bca7d43b9753dc09bae152a0">KNF_MODAL_CANCEL</a>:
<a name="l02966"></a>02966                 <span class="comment">/* finish */</span>
<a name="l02967"></a>02967                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02968"></a>02968 
<a name="l02969"></a>02969                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">knifetool_exit</a>(C, op);
<a name="l02970"></a>02970                 <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02971"></a>02971 
<a name="l02972"></a>02972                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a1f73d37a649632bed12f1ee51e2af55b">OPERATOR_CANCELLED</a>;
<a name="l02973"></a>02973             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ac189e407633ecd19dd6766ea0acde8c5">KNF_MODAL_CONFIRM</a>:
<a name="l02974"></a>02974                 <span class="comment">/* finish */</span>
<a name="l02975"></a>02975                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02976"></a>02976 
<a name="l02977"></a>02977                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a079d38d237be47bf1e0e97f6d66a523b">knifetool_finish</a>(C, op);
<a name="l02978"></a>02978                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#af203d78059ef46bad895b65cd534f168">knifetool_exit</a>(C, op);
<a name="l02979"></a>02979                 <a class="code" href="../../d1/d12/ED__screen_8h.html#a3899c7d0aebef9cc11992a7de3e5f397">ED_area_headerprint</a>(<a class="code" href="../../df/d01/BKE__context_8h.html#a0aa169ee48010fe8d739201a37e7b66f">CTX_wm_area</a>(C), <a class="code" href="../../df/dac/source_2blender_2blenpluginapi_2util_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02980"></a>02980 
<a name="l02981"></a>02981                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a818d2533e88d91a930488ab021d18474">OPERATOR_FINISHED</a>;
<a name="l02982"></a>02982             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aca1eb91d4a56d3876d5f7c10f675f939">KNF_MODAL_MIDPOINT_ON</a>:
<a name="l02983"></a>02983                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a> = 1;
<a name="l02984"></a>02984 
<a name="l02985"></a>02985                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(kcd);
<a name="l02986"></a>02986                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf1fa25540992f57354721c19524c63f">knife_update_active</a>(kcd);
<a name="l02987"></a>02987                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l02988"></a>02988                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02989"></a>02989                 <span class="keywordflow">break</span>;
<a name="l02990"></a>02990             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a57234962c7f66edf886579ea8cf9db67">KNF_MODAL_MIDPOINT_OFF</a>:
<a name="l02991"></a>02991                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a02e09be997582a6486a52b4c37e3c0cb">snap_midpoints</a> = 0;
<a name="l02992"></a>02992 
<a name="l02993"></a>02993                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(kcd);
<a name="l02994"></a>02994                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#abf1fa25540992f57354721c19524c63f">knife_update_active</a>(kcd);
<a name="l02995"></a>02995                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l02996"></a>02996                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l02997"></a>02997                 <span class="keywordflow">break</span>;
<a name="l02998"></a>02998             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5aa0ac638d6c4813290ff43841e2b1822b">KNF_MODEL_IGNORE_SNAP_ON</a>:
<a name="l02999"></a>02999                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l03000"></a>03000                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac3d324d6aa52e21b1456af76da178883">ignore_edge_snapping</a> = 1;
<a name="l03001"></a>03001                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l03002"></a>03002                 <span class="keywordflow">break</span>;
<a name="l03003"></a>03003             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a118b78edf99ba61d99ebc87646593200">KNF_MODEL_IGNORE_SNAP_OFF</a>:
<a name="l03004"></a>03004                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l03005"></a>03005                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a8c5ba4f7043ea77bd5b19164643b7ec1">ignore_vert_snapping</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#ac3d324d6aa52e21b1456af76da178883">ignore_edge_snapping</a> = 0;
<a name="l03006"></a>03006                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l03007"></a>03007                 <span class="keywordflow">break</span>;
<a name="l03008"></a>03008             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a74ed653755bb4f81ffe1f48470999578">KNF_MODAL_ANGLE_SNAP_TOGGLE</a>:
<a name="l03009"></a>03009                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a> = !kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a1e1c0c814ab6a19e0807b5c88e184a89">angle_snapping</a>;
<a name="l03010"></a>03010                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l03011"></a>03011                 <span class="keywordflow">break</span>;
<a name="l03012"></a>03012             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ae9769f948fb02cf10682e2372d60aa27">KNF_MODAL_CUT_THROUGH_TOGGLE</a>:
<a name="l03013"></a>03013                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a> = !kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a4dd3591000f735c2ff59a91048ead324">cut_through</a>;
<a name="l03014"></a>03014                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a17476bd8dd1fe018c54f1c6da1b31d5a">knife_update_header</a>(C, kcd);
<a name="l03015"></a>03015                 <span class="keywordflow">break</span>;
<a name="l03016"></a>03016             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5a741c38b39148b2adbea92da802883afa">KNF_MODAL_NEW_CUT</a>:
<a name="l03017"></a>03017                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l03018"></a>03018                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6c88da7a03d2b9586504aa028219f264">knife_finish_cut</a>(kcd);
<a name="l03019"></a>03019                 kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = MODE_IDLE;
<a name="l03020"></a>03020                 <span class="keywordflow">break</span>;
<a name="l03021"></a>03021             <span class="keywordflow">case</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a78372742882dccd1c13323dbd66c25c5ab2f7e824b9ad6234c69fcdf61c3de9eb">KNF_MODAL_ADD_CUT</a>:
<a name="l03022"></a>03022                 <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8fb65187f278cb585628c4b4c1704369">knife_recalc_projmat</a>(kcd);
<a name="l03023"></a>03023 
<a name="l03024"></a>03024                 <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> == MODE_DRAGGING) {
<a name="l03025"></a>03025                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#acfe89167b2afbef5fd0f388dd2ad7ccb">knife_add_cut</a>(kcd);
<a name="l03026"></a>03026                     <span class="keywordflow">if</span> (!kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a99343aed49fc475df5f59f67b370d351">extend</a>) {
<a name="l03027"></a>03027                         <a class="code" href="../../da/d56/editmesh__knife_8c.html#a6c88da7a03d2b9586504aa028219f264">knife_finish_cut</a>(kcd);
<a name="l03028"></a>03028                         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = MODE_IDLE;
<a name="l03029"></a>03029                     }
<a name="l03030"></a>03030                 }
<a name="l03031"></a>03031                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> != MODE_PANNING) {
<a name="l03032"></a>03032                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#abde42a881bb00ad96a4ca3b8e13682c2">knife_start_cut</a>(kcd);
<a name="l03033"></a>03033                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = MODE_DRAGGING;
<a name="l03034"></a>03034                 }
<a name="l03035"></a>03035 
<a name="l03036"></a>03036                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l03037"></a>03037                 <span class="keywordflow">break</span>;
<a name="l03038"></a>03038         }
<a name="l03039"></a>03039     }
<a name="l03040"></a>03040     <span class="keywordflow">else</span> { <span class="comment">/* non-modal-mapped events */</span>
<a name="l03041"></a>03041         <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#aeddd07f29c499fe2e38964ae993296ff">type</a>) {
<a name="l03042"></a>03042             <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#ae58fa49252a1cf05799ab21592491a30">WHEELUPMOUSE</a>:
<a name="l03043"></a>03043             <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a2ffb32901b9678d9b738e618330f60c0">WHEELDOWNMOUSE</a>:
<a name="l03044"></a>03044                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l03045"></a>03045             <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#a64d06d50176bcded7e70cd4ebbce0e12">MIDDLEMOUSE</a>:
<a name="l03046"></a>03046                 <span class="keywordflow">if</span> (event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a4ce6386082cecfa0645ced2216d04172">val</a> != <a class="code" href="../../d4/ddc/WM__types_8h.html#afe9c69ca34c3a8d6c0b38daf64ab24b6">KM_RELEASE</a>) {
<a name="l03047"></a>03047                     <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> != MODE_PANNING)
<a name="l03048"></a>03048                         kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a2b421c67f552a005e6cc2a8f2420ba19">prevmode</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a>;
<a name="l03049"></a>03049                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = MODE_PANNING;
<a name="l03050"></a>03050                 }
<a name="l03051"></a>03051                 <span class="keywordflow">else</span> {
<a name="l03052"></a>03052                     kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> = kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a2b421c67f552a005e6cc2a8f2420ba19">prevmode</a>;
<a name="l03053"></a>03053                 }
<a name="l03054"></a>03054 
<a name="l03055"></a>03055                 <a class="code" href="../../d1/d12/ED__screen_8h.html#ac6cfac9a218d316df5b76e7fe0f89967">ED_region_tag_redraw</a>(kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#a18a8c2fcf40921b93450a5c785aeaedb">ar</a>);
<a name="l03056"></a>03056                 <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#ac593ccb5bdf99609d37aac1dc5b03eee">OPERATOR_PASS_THROUGH</a>;
<a name="l03057"></a>03057 
<a name="l03058"></a>03058             <span class="keywordflow">case</span> <a class="code" href="../../d1/d40/wm__event__types_8h.html#aa58b8b831d49bfef312f9ae99d742aae">MOUSEMOVE</a>: <span class="comment">/* mouse moved somewhere to select another loop */</span>
<a name="l03059"></a>03059                 <span class="keywordflow">if</span> (kcd-&gt;<a class="code" href="../../da/d09/structKnifeTool__OpData.html#accb660f700dd3d62cda9ecf0fa72c923">mode</a> != MODE_PANNING) {
<a name="l03060"></a>03060                     <a class="code" href="../../da/d56/editmesh__knife_8c.html#a02fd2e622c53102324b991dbc6991933">knifetool_update_mval</a>(kcd, event-&gt;<a class="code" href="../../d5/d6c/structwmEvent.html#a7ecdf2416014628878116151dcb377f1">mval</a>);
<a name="l03061"></a>03061                 }
<a name="l03062"></a>03062 
<a name="l03063"></a>03063                 <span class="keywordflow">break</span>;
<a name="l03064"></a>03064         }
<a name="l03065"></a>03065     }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067     <span class="comment">/* keep going until the user confirms */</span>
<a name="l03068"></a>03068     <span class="keywordflow">return</span> <a class="code" href="../../de/dc1/DNA__windowmanager__types_8h.html#a3ae275907ae986c695e88547409d19bb">OPERATOR_RUNNING_MODAL</a>;
<a name="l03069"></a>03069 }
<a name="l03070"></a>03070 
<a name="l03071"></a><a class="code" href="../../d3/d5c/mesh__intern_8h.html#a69e902493cf92567e7caaafa911492e1">03071</a> <span class="keywordtype">void</span> <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7f753dfb12105db472d5239b0dc5814b">MESH_OT_knife_tool</a>(<a class="code" href="../../de/d5e/structwmOperatorType.html">wmOperatorType</a> *ot)
<a name="l03072"></a>03072 {
<a name="l03073"></a>03073     <span class="comment">/* description */</span>
<a name="l03074"></a>03074     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a04a27d629d618d3991e1825683ecbd99">name</a> = <span class="stringliteral">&quot;Knife Topology Tool&quot;</span>;
<a name="l03075"></a>03075     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a46882f447e704ec2b65bf69bf826a306">idname</a> = <span class="stringliteral">&quot;MESH_OT_knife_tool&quot;</span>;
<a name="l03076"></a>03076     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aa66ab7b95cf41f92a6da53c53e873db4">description</a> = <span class="stringliteral">&quot;Cut new topology&quot;</span>;
<a name="l03077"></a>03077 
<a name="l03078"></a>03078     <span class="comment">/* callbacks */</span>
<a name="l03079"></a>03079     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a712df4059514069aeb44df0248922812">invoke</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a12575ef2b9b1bea45535b7bb93aa31fb">knifetool_invoke</a>;
<a name="l03080"></a>03080     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a721a4a53a8435e444ec3460f327bca3b">modal</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a8e258f858ffb474203de7d267d5e23d8">knifetool_modal</a>;
<a name="l03081"></a>03081     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#ac3d8df4a62e774a42cf67a761f260c1d">cancel</a> = <a class="code" href="../../da/d56/editmesh__knife_8c.html#a7b9778c849404803114a36890a0538d1">knifetool_cancel</a>;
<a name="l03082"></a>03082     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#aecedd63f8c02cb14ac8e91014550c7d9">poll</a> = <a class="code" href="../../d1/d12/ED__screen_8h.html#a1c12c45b3e8ba8060cdeea963881947b">ED_operator_editmesh_view3d</a>;
<a name="l03083"></a>03083 
<a name="l03084"></a>03084     <span class="comment">/* flags */</span>
<a name="l03085"></a>03085     ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a0f07ac6290f51c0a39e25940bf8c9d78">flag</a> = <a class="code" href="../../d4/ddc/WM__types_8h.html#adb7cbb6b0205d00b470cbd1f158bb489">OPTYPE_REGISTER</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a0884b8bbb246819cf52a01174d687370">OPTYPE_UNDO</a> | <a class="code" href="../../d4/ddc/WM__types_8h.html#a2458c730dbcabf67cc8917d8de127bab">OPTYPE_BLOCKING</a>;
<a name="l03086"></a>03086 
<a name="l03087"></a>03087     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;use_occlude_geometry&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="stringliteral">&quot;Occlude Geometry&quot;</span>, <span class="stringliteral">&quot;Only cut the front most geometry&quot;</span>);
<a name="l03088"></a>03088     <a class="code" href="../../dc/d7e/rna__define_8c.html#a6025d606b895666e4099441c3dae79fe">RNA_def_boolean</a>(ot-&gt;<a class="code" href="../../de/d5e/structwmOperatorType.html#a7f4c35af5aa349f0e4a90a1f0710ddc6">srna</a>, <span class="stringliteral">&quot;only_select&quot;</span>, <a class="code" href="../../da/d7d/BLI__utildefines_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Only Selected&quot;</span>, <span class="stringliteral">&quot;Only cut selected geometry&quot;</span>);
<a name="l03089"></a>03089 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Nov 13 2012 11:54:16 for Blender by&#160;
<a href="http://www.doxygen.org/index.html"> 
doxygen</a> 1.7.4 </small></address> 
</body>
</html>
